webpackJsonp([0xc2ef1f5e865f],{1502:function(n,s){n.exports={data:{site:{siteMetadata:{title:"女王控的博客",description:'前端工程师，黑猫女王控，欢迎勾搭，技术相关<a href="https://github.com/towavephone" target="_blank">@towavephone</a>，QQ闲聊<a href="tencent://AddContact/?fromId=45&fromSubId=1&subcmd=all&uin=634407147&website=www.oicqzone.com">@towave</a>，bili关注<a href="https://space.bilibili.com/11507708#/" target="_blank">@towave</a>',siteUrl:"https://blog.towavephone.com"}}},pathContext:{posts:[{excerpt:"背景 在线上部署期间，或者用户长时间没有访问网页等等各种情况，有一定概率会出现以下形式的报错，导致网页白屏 原因与方案 由于现代前端工具链打包出来的，尤其是 webpack 的项目，其主入口默认不缓存，其他文件长期缓存，缓存的文件通过改变文件名（一般是 hash）来更新 所以在部署期间或者用户没有长时间打开网页，可能会请求已被删除的对应的 chunk 或者 chunk…",html:'<h1 id="背景"><a href="#%E8%83%8C%E6%99%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>背景</h1>\n<p>在线上部署期间，或者用户长时间没有访问网页等等各种情况，有一定概率会出现以下形式的报错，导致网页白屏</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="91492669752188010000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`Uncaught ChunkLoadError: Loading chunk <CHUNK_NAME> failed.\n(error: <WEBSITE_PATH>/<CHUNK_NAME>-<CHUNK_HASH>.js)`, `91492669752188010000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">Uncaught ChunkLoadError: Loading chunk <span class="token operator">&lt;</span>CHUNK_NAME<span class="token operator">></span> failed.\n<span class="token punctuation">(</span>error: <span class="token operator">&lt;</span>WEBSITE_PATH<span class="token operator">></span>/<span class="token operator">&lt;</span>CHUNK_NAME<span class="token operator">></span>-<span class="token operator">&lt;</span>CHUNK_HASH<span class="token operator">></span>.js<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<h1 id="原因与方案"><a href="#%E5%8E%9F%E5%9B%A0%E4%B8%8E%E6%96%B9%E6%A1%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>原因与方案</h1>\n<p>由于现代前端工具链打包出来的，尤其是 webpack 的项目，其主入口默认不缓存，其他文件长期缓存，缓存的文件通过改变文件名（一般是 hash）来更新</p>\n<p>所以在部署期间或者用户没有长时间打开网页，可能会请求已被删除的对应的 chunk 或者 chunk 虽然路径，文件名没变，但是内容改变导致有概率的白屏，所以针对此情况，有以下方案</p>\n<ol>\n<li>缓存所有版本的文件，但会造成空间浪费</li>\n<li>对打包出来的文件都不做缓存，但对服务器有很大压力</li>\n<li>可以通过一个 websocket 链接或者轮询来主动告知浏览器更新版本，但此方案过于繁重且需要后端支持</li>\n<li>对报错的文件重试，超过一定次数白屏，或者主动告知用户刷新页面</li>\n</ol>\n<p>综上，采用方案 4</p>\n<h1 id="技术选型"><a href="#%E6%8A%80%E6%9C%AF%E9%80%89%E5%9E%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>技术选型</h1>\n<p>对于方案 4，同样有 2 大类，编译时或运行时，选型对比如下</p>\n<table>\n  <thead>\n    <tr>\n      <th>类型</th>\n      <th>序号</th>\n      <th>选型</th>\n      <th>优点</th>\n      <th>缺点</th>\n   </tr>\n   </thead>\n  <tbody>\n   <tr>\n      <td rowspan="2">运行时</td>\n      <td>1</td>\n      <td>\n         <a href="https://github.com/Nikaple/assets-retry" target="_blank">assets-retry</a> 以及 <a href="https://github.com/Nikaple/assets-retry/blob/master/README-cn.md" target="_blank">原理</a>\n      </td>\n      <td>接入简单</td>\n      <td>重试的元素种类太多，对于白屏问题，只需要保证 js 需要重试</td>\n   </tr>\n   <tr>\n      <td>2</td>\n      <td>\n         重写 react lazy 方法，对报错进行重试\n      </td>\n      <td>实现简单</td>\n      <td>\n         <ol>\n            <li>\n               不能监听到主入口的报错，需要用 window.error 补齐\n            </li>\n            <li>\n               需要改动原始代码\n            </li>\n            <li>\n               由于 webpack 的 chunk 加载机制，失败的 chunk 不能重试，原理见上面\n            </li>\n         </ol>\n      </td>\n    </tr>\n    <tr>\n      <td rowspan="2">编译时</td>\n      <td>3</td>\n      <td>\n         <a href="https://github.com/mattlewis92/webpack-retry-chunk-load-plugin" target="_blank">webpack-retry-chunk-load-plugin</a>\n      </td>\n      <td>\n         接入简单，很方便的实现 chunk 重试\n      </td>\n      <td>\n         不能让主入口报错重试\n      </td>\n    </tr>\n    <tr>\n      <td>4</td>\n      <td>\n         <a href="https://github.com/mattlewis92/webpack-retry-chunk-load-plugin" target="_blank">webpack-retry-chunk-load-plugin</a> 以及\n         <a href="https://gist.github.com/mishani0x0ef/b15a969c016fa01b85f413b712c40fa1" target="_blank">html-tag-attributes-plugin</a>\n      </td>\n      <td>\n         接入简单\n      </td>\n      <td>\n         需要自己实现主入口报错重试逻辑\n      </td>\n    </tr>\n   </tbody>\n</table>\n<p>其他参考链接如下:</p>\n<ol>\n<li><a href="https://dev.to/igor_bykov/handle-loading-errors-fallback-with-htmlwebpackplugin-2d31" target="_blank" rel="nofollow noreferrer noopener">handle-loading-errors-fallback-with-htmlwebpackplugin</a></li>\n<li><a href="https://baijiahao.baidu.com/s?id=1776343703094638001&#x26;wfr=spider&#x26;for=pc" target="_blank" rel="nofollow noreferrer noopener">如何解决 JS 脚本加载失败的问题</a></li>\n<li><a href="https://stackoverflow.com/questions/69047420/webpack-code-splitting-chunkloaderror-loading-chunk-x-failed-but-the-chunk-e" target="_blank" rel="nofollow noreferrer noopener">webpack-code-splitting-chunkloaderror-loading-chunk-x-failed-but-the-chunk-e</a></li>\n</ol>\n<p>最终采用选型 4</p>\n<h1 id="实现过程"><a href="#%E5%AE%9E%E7%8E%B0%E8%BF%87%E7%A8%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>实现过程</h1>\n<p>预研过程包含选型 2 与 4，注意这里的重试需要有间隔时间以及需要带额外的 <code class="language-text">?</code> 参数防止缓存生效</p>\n<h2 id="重写-react-lazy-方法"><a href="#%E9%87%8D%E5%86%99-react-lazy-%E6%96%B9%E6%B3%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>重写 react lazy 方法</h2>\n<p>使用时可以直接替代 react 的 lazy 方法，但由于上面提到的缺点不采用此方案</p>\n<p>importRetry.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="62027649718883434000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import * as React from \'react\';\n\nconst noop = () => {};\nconst strategies = {\n   PARSE_ERROR_MESSAGE: (error, _) => {\n      const url = new URL(error.request);\n      return url.href;\n   }\n};\n\nconst defaultOpts = {\n   strategy: \'PARSE_ERROR_MESSAGE\',\n   importFunction: (path) => import(/* @vite-ignore */ path),\n   logger: noop\n};\n\n/**\n * Future improvements:\n * - cache successful variations to skip unnecessary lag on subsequent reloads\n */\n// https://github.com/fatso83/retry-dynamic-import/blob/main/lib/retry.ts\nfunction createDynamicImportWithRetry(maxRetries, opts = {}) {\n   const resolvedOpts = {\n      ...defaultOpts,\n      ...opts\n   };\n   const { logger, importFunction, strategy } = resolvedOpts;\n\n   return async (importer) => {\n      try {\n         return await importer();\n      } catch (error) {\n         logger(Date.now(), \\`Importing failed: \\`, error);\n\n         const modulePath = strategies[strategy](error, importer);\n         logger(\\`Parsed url using \\${strategy}:\\${modulePath}\\`);\n\n         if (!modulePath) {\n            logger(\'Unable to determine path to module when trying to reload\');\n            // nothing we can do ...\n            throw error;\n         }\n\n         // retry x times with 2 second delay base and backoff factor of 2 (1/2, 1, 2, 4, 8 seconds)\n         //\n         for (let i = -1; i < maxRetries; i++) {\n            // add a timestamp to the url to force a reload the module (and not use the cached version - cache busting)\n            let cacheBustedPath = \\`\\${modulePath}?t=\\${+new Date()}\\`;\n            logger(Date.now(), \\`Trying re-import module using cache busted path: \\${cacheBustedPath}\\`);\n\n            try {\n               return await importFunction(cacheBustedPath);\n            } catch (e) {\n               logger(\\`Import for \\${cacheBustedPath} failed\\`);\n               await new Promise((resolve) => setTimeout(resolve, 1000 * 2 ** i));\n            }\n         }\n         throw error;\n      }\n   };\n}\n\nconst MAX_RETRY_COUNT = 5;\n\nconst defaultDynamicImportWithRetry = createDynamicImportWithRetry(MAX_RETRY_COUNT, {\n   logger: console.log\n});\n\nexport function lazy(importer) {\n   return process.env.NODE_ENV === \'development\'\n      ? React.lazy\n      : React.lazy(() => defaultDynamicImportWithRetry(importer));\n}`, `62027649718883434000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> React <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">noop</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> strategies <span class="token operator">=</span> <span class="token punctuation">{</span>\n   <span class="token function-variable function">PARSE_ERROR_MESSAGE</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> _</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>error<span class="token punctuation">.</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">return</span> url<span class="token punctuation">.</span>href<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> defaultOpts <span class="token operator">=</span> <span class="token punctuation">{</span>\n   strategy<span class="token punctuation">:</span> <span class="token string">\'PARSE_ERROR_MESSAGE\'</span><span class="token punctuation">,</span>\n   <span class="token function-variable function">importFunction</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token comment">/* @vite-ignore */</span> path<span class="token punctuation">)</span><span class="token punctuation">,</span>\n   logger<span class="token punctuation">:</span> noop\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token comment">/**\n * Future improvements:\n * - cache successful variations to skip unnecessary lag on subsequent reloads\n */</span>\n<span class="token comment">// https://github.com/fatso83/retry-dynamic-import/blob/main/lib/retry.ts</span>\n<span class="token keyword">function</span> <span class="token function">createDynamicImportWithRetry</span><span class="token punctuation">(</span><span class="token parameter">maxRetries<span class="token punctuation">,</span> opts <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">const</span> resolvedOpts <span class="token operator">=</span> <span class="token punctuation">{</span>\n      <span class="token operator">...</span>defaultOpts<span class="token punctuation">,</span>\n      <span class="token operator">...</span>opts\n   <span class="token punctuation">}</span><span class="token punctuation">;</span>\n   <span class="token keyword">const</span> <span class="token punctuation">{</span> logger<span class="token punctuation">,</span> importFunction<span class="token punctuation">,</span> strategy <span class="token punctuation">}</span> <span class="token operator">=</span> resolvedOpts<span class="token punctuation">;</span>\n\n   <span class="token keyword">return</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">importer</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">try</span> <span class="token punctuation">{</span>\n         <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">importer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token function">logger</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Importing failed: </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n         <span class="token keyword">const</span> modulePath <span class="token operator">=</span> strategies<span class="token punctuation">[</span>strategy<span class="token punctuation">]</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> importer<span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token function">logger</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Parsed url using </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>strategy<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>modulePath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>modulePath<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token function">logger</span><span class="token punctuation">(</span><span class="token string">\'Unable to determine path to module when trying to reload\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token comment">// nothing we can do ...</span>\n            <span class="token keyword">throw</span> error<span class="token punctuation">;</span>\n         <span class="token punctuation">}</span>\n\n         <span class="token comment">// retry x times with 2 second delay base and backoff factor of 2 (1/2, 1, 2, 4, 8 seconds)</span>\n         <span class="token comment">//</span>\n         <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> maxRetries<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token comment">// add a timestamp to the url to force a reload the module (and not use the cached version - cache busting)</span>\n            <span class="token keyword">let</span> cacheBustedPath <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>modulePath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">?t=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token operator">+</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n            <span class="token function">logger</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Trying re-import module using cache busted path: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>cacheBustedPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n            <span class="token keyword">try</span> <span class="token punctuation">{</span>\n               <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">importFunction</span><span class="token punctuation">(</span>cacheBustedPath<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n               <span class="token function">logger</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Import for </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>cacheBustedPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> failed</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n               <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">**</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span>\n         <span class="token punctuation">}</span>\n         <span class="token keyword">throw</span> error<span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">const</span> <span class="token constant">MAX_RETRY_COUNT</span> <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> defaultDynamicImportWithRetry <span class="token operator">=</span> <span class="token function">createDynamicImportWithRetry</span><span class="token punctuation">(</span><span class="token constant">MAX_RETRY_COUNT</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>\n   logger<span class="token punctuation">:</span> console<span class="token punctuation">.</span>log\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">lazy</span><span class="token punctuation">(</span><span class="token parameter">importer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">return</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">\'development\'</span>\n      <span class="token operator">?</span> React<span class="token punctuation">.</span>lazy\n      <span class="token punctuation">:</span> React<span class="token punctuation">.</span><span class="token function">lazy</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">defaultDynamicImportWithRetry</span><span class="token punctuation">(</span>importer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="webpack-retry-chunk-load-plugin--html-tag-attributes-plugin"><a href="#webpack-retry-chunk-load-plugin--html-tag-attributes-plugin" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>webpack-retry-chunk-load-plugin + html-tag-attributes-plugin</h2>\n<p>plugins/html-tag-attributes-plugin.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="59356928024636390000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const HtmlWebpackPlugin = require(\'html-webpack-plugin\');\n\n// For more information about plugin concepts, see: https://github.com/jantimon/html-webpack-plugin#events\nclass HtmlTagAttributesPlugin {\n   static name = \'HtmlTagAttributesPlugin\';\n\n   constructor(options) {\n      const defaultOptions = {\n         script: {}\n      };\n\n      this.options = { ...defaultOptions, ...options };\n   }\n\n   apply(compiler) {\n      compiler.hooks.compilation.tap(HtmlTagAttributesPlugin.name, (compilation) =>\n         this._hookIntoHtmlAlterAssetTags(compilation)\n      );\n   }\n\n   _hookIntoHtmlAlterAssetTags(compilation) {\n      HtmlWebpackPlugin.getHooks(compilation).alterAssetTags.tapAsync(HtmlTagAttributesPlugin.name, (data, cb) =>\n         cb(null, this._extendScriptTags(data))\n      );\n   }\n\n   _extendScriptTags(data) {\n      data.assetTags.scripts = data.assetTags.scripts.map(({ attributes, ...other }) => ({\n         ...other,\n         attributes: {\n            ...attributes,\n            ...this.options.script\n         }\n      }));\n\n      return data;\n   }\n}\n\nmodule.exports = { HtmlTagAttributesPlugin };`, `59356928024636390000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> HtmlWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'html-webpack-plugin\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// For more information about plugin concepts, see: https://github.com/jantimon/html-webpack-plugin#events</span>\n<span class="token keyword">class</span> <span class="token class-name">HtmlTagAttributesPlugin</span> <span class="token punctuation">{</span>\n   <span class="token keyword">static</span> name <span class="token operator">=</span> <span class="token string">\'HtmlTagAttributesPlugin\'</span><span class="token punctuation">;</span>\n\n   <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> defaultOptions <span class="token operator">=</span> <span class="token punctuation">{</span>\n         script<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n      <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">this</span><span class="token punctuation">.</span>options <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span>defaultOptions<span class="token punctuation">,</span> <span class="token operator">...</span>options <span class="token punctuation">}</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>compilation<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span>HtmlTagAttributesPlugin<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">compilation</span><span class="token punctuation">)</span> <span class="token operator">=></span>\n         <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_hookIntoHtmlAlterAssetTags</span><span class="token punctuation">(</span>compilation<span class="token punctuation">)</span>\n      <span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token function">_hookIntoHtmlAlterAssetTags</span><span class="token punctuation">(</span><span class="token parameter">compilation</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      HtmlWebpackPlugin<span class="token punctuation">.</span><span class="token function">getHooks</span><span class="token punctuation">(</span>compilation<span class="token punctuation">)</span><span class="token punctuation">.</span>alterAssetTags<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span>HtmlTagAttributesPlugin<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span> <span class="token operator">=></span>\n         <span class="token function">cb</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_extendScriptTags</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>\n      <span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token function">_extendScriptTags</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      data<span class="token punctuation">.</span>assetTags<span class="token punctuation">.</span>scripts <span class="token operator">=</span> data<span class="token punctuation">.</span>assetTags<span class="token punctuation">.</span>scripts<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> attributes<span class="token punctuation">,</span> <span class="token operator">...</span>other <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>\n         <span class="token operator">...</span>other<span class="token punctuation">,</span>\n         attributes<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n            <span class="token operator">...</span>attributes<span class="token punctuation">,</span>\n            <span class="token operator">...</span>this<span class="token punctuation">.</span>options<span class="token punctuation">.</span>script\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">return</span> data<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\nmodule<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span> HtmlTagAttributesPlugin <span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>config-overrides.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="78286742248866510000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const { RetryChunkLoadPlugin } = require(\'webpack-retry-chunk-load-plugin\');\nconst { HtmlTagAttributesPlugin } = require(\'./plugins/html-tag-attributes-plugin\');\n\nconst lastResortScript = &quot;window.alert(\'Frontend Is Deploying, Please Wait!\'); window.location.reload(true);&quot;;\nconst retryDelay = 4000;\nconst maxRetries = 5;\n\nconst isProd = env === \'production\';\n\nconst localConfig = override(\n   isProd &&\n      addWebpackPlugin(\n         new RetryChunkLoadPlugin({\n            // optional stringified function to get the cache busting query string appended to the script src\n            // if not set will default to appending the string \\`?cache-bust=true\\`\n            cacheBust: \\`function() {\n              return Date.now();\n            }\\`,\n            // optional value to set the amount of time in milliseconds before trying to load the chunk again. Default is 0\n            // if string, value must be code to generate a delay value. Receives retryCount as argument\n            // e.g. \\`function(retryAttempt) { return retryAttempt * 1000 }\\`\n            retryDelay,\n            // optional value to set the maximum number of retries to load the chunk. Default is 1\n            maxRetries,\n            // // optional list of chunks to which retry script should be injected\n            // // if not set will add retry script to all chunks that have webpack script loading\n            // chunks: [\'chunkName\'],\n            // optional code to be executed in the browser context if after all retries chunk is not loaded.\n            // if not set - nothing will happen and error will be returned to the chunk loader.\n            lastResortScript\n         })\n      ),\n   isProd &&\n      addWebpackPlugin(\n         new HtmlTagAttributesPlugin({\n            script: {\n               onerror: \\`\n                // const isAsyncScript = event.target.defer || event.target.async\n                // 暂时不包含对同步脚本的处理\n                let retryCount = 0\n                const retryFunc = async () => {\n                  retryCount++\n                  let cacheBustedPath = event.target.src + \'?t=\' + (+new Date())\n                    const script = document.createElement(\'script\')\n                    script.src = cacheBustedPath\n                    script.onerror = async () => {\n                      await new Promise(resolve => setTimeout(resolve, \\${retryDelay}))\n                      if (retryCount === \\${maxRetries}) {\n                        \\${lastResortScript}\n                      } else {\n                        retryFunc()\n                      }\n                    }\n                    // webpack nonce for csp\n                    const originalNonce = event.target.getAttribute(\'nonce\')\n                    if (originalNonce) {\n                        script.setAttribute(\'nonce\', originalNonce)\n                    }\n                    document.getElementsByTagName(\'head\')[0].appendChild(script)\n                }\n\n                retryFunc()\n              \\`\n            }\n         })\n      )\n);`, `78286742248866510000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> <span class="token punctuation">{</span> RetryChunkLoadPlugin <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'webpack-retry-chunk-load-plugin\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> <span class="token punctuation">{</span> HtmlTagAttributesPlugin <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./plugins/html-tag-attributes-plugin\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> lastResortScript <span class="token operator">=</span> <span class="token string">"window.alert(\'Frontend Is Deploying, Please Wait!\'); window.location.reload(true);"</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> retryDelay <span class="token operator">=</span> <span class="token number">4000</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> maxRetries <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> isProd <span class="token operator">=</span> env <span class="token operator">===</span> <span class="token string">\'production\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> localConfig <span class="token operator">=</span> <span class="token function">override</span><span class="token punctuation">(</span>\n   isProd <span class="token operator">&amp;&amp;</span>\n      <span class="token function">addWebpackPlugin</span><span class="token punctuation">(</span>\n         <span class="token keyword">new</span> <span class="token class-name">RetryChunkLoadPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n            <span class="token comment">// optional stringified function to get the cache busting query string appended to the script src</span>\n            <span class="token comment">// if not set will default to appending the string `?cache-bust=true`</span>\n            cacheBust<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">function() {\n              return Date.now();\n            }</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n            <span class="token comment">// optional value to set the amount of time in milliseconds before trying to load the chunk again. Default is 0</span>\n            <span class="token comment">// if string, value must be code to generate a delay value. Receives retryCount as argument</span>\n            <span class="token comment">// e.g. `function(retryAttempt) { return retryAttempt * 1000 }`</span>\n            retryDelay<span class="token punctuation">,</span>\n            <span class="token comment">// optional value to set the maximum number of retries to load the chunk. Default is 1</span>\n            maxRetries<span class="token punctuation">,</span>\n            <span class="token comment">// // optional list of chunks to which retry script should be injected</span>\n            <span class="token comment">// // if not set will add retry script to all chunks that have webpack script loading</span>\n            <span class="token comment">// chunks: [\'chunkName\'],</span>\n            <span class="token comment">// optional code to be executed in the browser context if after all retries chunk is not loaded.</span>\n            <span class="token comment">// if not set - nothing will happen and error will be returned to the chunk loader.</span>\n            lastResortScript\n         <span class="token punctuation">}</span><span class="token punctuation">)</span>\n      <span class="token punctuation">)</span><span class="token punctuation">,</span>\n   isProd <span class="token operator">&amp;&amp;</span>\n      <span class="token function">addWebpackPlugin</span><span class="token punctuation">(</span>\n         <span class="token keyword">new</span> <span class="token class-name">HtmlTagAttributesPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n            script<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n               onerror<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">\n                // const isAsyncScript = event.target.defer || event.target.async\n                // 暂时不包含对同步脚本的处理\n                let retryCount = 0\n                const retryFunc = async () => {\n                  retryCount++\n                  let cacheBustedPath = event.target.src + \'?t=\' + (+new Date())\n                    const script = document.createElement(\'script\')\n                    script.src = cacheBustedPath\n                    script.onerror = async () => {\n                      await new Promise(resolve => setTimeout(resolve, </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>retryDelay<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">))\n                      if (retryCount === </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>maxRetries<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">) {\n                        </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>lastResortScript<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\n                      } else {\n                        retryFunc()\n                      }\n                    }\n                    // webpack nonce for csp\n                    const originalNonce = event.target.getAttribute(\'nonce\')\n                    if (originalNonce) {\n                        script.setAttribute(\'nonce\', originalNonce)\n                    }\n                    document.getElementsByTagName(\'head\')[0].appendChild(script)\n                }\n\n                retryFunc()\n              </span><span class="token template-punctuation string">`</span></span>\n            <span class="token punctuation">}</span>\n         <span class="token punctuation">}</span><span class="token punctuation">)</span>\n      <span class="token punctuation">)</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="效果展示"><a href="#%E6%95%88%E6%9E%9C%E5%B1%95%E7%A4%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>效果展示</h1>\n<p>在主入口的 js 以及分包后的 chunk 报错后都会做重试 5 次的操作，超过 5 次弹窗提示用户在部署，点击确定后刷新页面再次重试</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-12-05-11-29-43-f7fbec7ad07fe7e42ef5d3622f3019ab-a01e8.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 64.06810035842294%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsSAAALEgHS3X78AAABUklEQVQ4y6WS3U6EMBCFef/X8Fm89MobY9wNYpbfAi30n4XjdDZrNGrM4iQn0yHk6zltM601xlFCSsldTRNSndQZ97kHtpXnbdsu33uNp5ccefGGsm5wqho0neBeU8/WdeWfrzqvCXDGY+lw96C+AScTIMQAYy0rLgusdYgx8szAn0SID9BVqaxx8D7wxjEuCCHCec/yISDDL7Wy2y0RvwBn1aMoco5bkTrRo+06iH7gdfbZwV9KtTiFuiwI0vOZB3KV7sE6B2PM7cBgJSoGCnLVM2SeZ2ju+nZgdBJlAlI8qRS/jtTThSTw7UAjIU6vkAQMziLQ7Wp6apZiG73DYVASMT9gaWrEcUDUM4IcEWgddgHJYVsc0bcdpnG8iGKb+R8OTX6EJYdOCLhhYPndDieFQMDYNohDz7E5Mm0U9jwbTxB7eIarK7iuJXc0E5wdU/R3tY72ZhqkSJAAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 12 05 11 29 43" title="" data-src="/static/2023-12-05-11-29-43-f7fbec7ad07fe7e42ef5d3622f3019ab-fee1c.png" data-srcset="/static/2023-12-05-11-29-43-f7fbec7ad07fe7e42ef5d3622f3019ab-a67b7.png 200w,\n/static/2023-12-05-11-29-43-f7fbec7ad07fe7e42ef5d3622f3019ab-0b187.png 400w,\n/static/2023-12-05-11-29-43-f7fbec7ad07fe7e42ef5d3622f3019ab-fee1c.png 800w,\n/static/2023-12-05-11-29-43-f7fbec7ad07fe7e42ef5d3622f3019ab-a01e8.png 1116w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>',
id:"/home/runner/work/GatsbyBlog/GatsbyBlog/blog/缓存报错重试机制探究/index.md absPath of file >>> MarkdownRemark",timeToRead:5,frontmatter:{date:"2023-11-30 17:47:38",path:"/cache-error-retry-process/",tags:"前端, 预研, webpack, 前端构建工具",title:"缓存报错重试机制探究",draft:null}},{excerpt:"需求背景 由于公司老项目采用 cra 来构建前端项目，在 jenkins 上的平均打包时长在 10 分钟以上，需要优化线上的打包时间，同时优化本地的开发体验 一期优化 主要针对 cra + webpack3/4 进行的优化 具体功能 cra 配置优化 核心：thread-loader 加快首次编译速度，hard-source-webpack-plugin 加快二次编译速度 config-overrides.js Dockerfile 配置缓存优化 需求背景 为了充分利用缓存，采用 docker…",html:'<h1 id="需求背景"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h1>\n<p>由于公司老项目采用 cra 来构建前端项目，在 jenkins 上的平均打包时长在 10 分钟以上，需要优化线上的打包时间，同时优化本地的开发体验</p>\n<h1 id="一期优化"><a href="#%E4%B8%80%E6%9C%9F%E4%BC%98%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>一期优化</h1>\n<p>主要针对 cra + webpack3/4 进行的优化</p>\n<h2 id="具体功能"><a href="#%E5%85%B7%E4%BD%93%E5%8A%9F%E8%83%BD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>具体功能</h2>\n<h3 id="cra-配置优化"><a href="#cra-%E9%85%8D%E7%BD%AE%E4%BC%98%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>cra 配置优化</h3>\n<p>核心：thread-loader 加快首次编译速度，hard-source-webpack-plugin 加快二次编译速度</p>\n<p>config-overrides.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="85574483727758130000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const {\n   override,\n   addBabelPlugins,\n   fixBabelImports,\n   addLessLoader,\n   removeModuleScopePlugin,\n   addWebpackModuleRule,\n   setWebpackOptimizationSplitChunks,\n   addWebpackPlugin,\n   addWebpackAlias\n} = require(\'customize-cra\');\nconst fs = require(\'fs\');\nconst PreloadWebpackPlugin = require(\'preload-webpack-plugin\');\nconst path = require(\'path\');\nconst MonacoWebpackPlugin = require(\'monaco-editor-webpack-plugin\');\nconst WebpackBarPlugin = require(\'webpackbar\');\nconst { get, pick } = require(\'lodash\');\nconst threadLoader = require(\'thread-loader\');\nconst HardSourceWebpackPlugin = require(\'hard-source-webpack-plugin\');\n\nconst packageJson = require(\'./package.json\');\nconst FixHardSourceWebpackPlugin = require(\'./plugins/FixHardSourceWebpackPlugin\');\n// const SpeedMeasurePlugin = require(\'speed-measure-webpack-plugin\')\n// const smp = new SpeedMeasurePlugin()\n\n// 默认开启 hard-source-webpack-plugin 插件，可以传入这个环境变量来主动关闭\nconst { DISABLE_HARD_SOURCE_PLUGIN } = process.env;\n\nthreadLoader.warmup(\n   {\n      // pool options, like passed to loader options\n      // must match loader options to boot the correct pool\n   },\n   [\n      // modules to load\n      // can be any module, i. e.\n      \'babel-loader\'\n   ]\n);\n\n// 打印 webpack 的相关配置，便于调试\nconst craDir = path.join(process.cwd() + \'/.cra\');\n\nif (!fs.existsSync(craDir)) {\n   fs.mkdirSync(craDir);\n}\n\n// 分析打印出的 webpack 相关配置的规律，可以写出此钩子函数，函数签名参考 craco 里面的函数\nconst addBeforeLoaders = (webpackConfig, matchLoader, newLoader = []) => {\n   const matchLoaders = get(webpackConfig, \'module.rules.1.oneOf\', []).filter((item) =>\n      get(item, \'loader\', \'\').includes(matchLoader)\n   );\n   if (matchLoaders.length > 0) {\n      matchLoaders.forEach((item) => {\n         const props = [\'loader\', \'options\'];\n         item.use = [...newLoader, pick(item, props)];\n         props.forEach((item2) => {\n            delete item[item2];\n         });\n      });\n   }\n};\n\n// 这里不能单纯的使用 JSON.stringify，需要特殊处理，否则不能序列化出函数部分\nconst formatConfig = (config) =>\n   JSON.stringify(\n      config,\n      (key, value) => {\n         if (typeof value === \'function\') {\n            return value.toString();\n         }\n         return value;\n      },\n      2\n   );\n\nconst getHardSourceWebpackPlugins = (env) =>\n   !DISABLE_HARD_SOURCE_PLUGIN\n      ? [\n           addWebpackPlugin(\n              new HardSourceWebpackPlugin({\n                 // Either an absolute path or relative to webpack\'s options.context.\n                 cacheDirectory: path.resolve(process.cwd(), \\`node_modules/.cache/hard-source/\\${env}/[confighash]\\`),\n                 // Either a string of object hash function given a webpack config.\n                 configHash: (webpackConfig) => {\n                    // node-object-hash on npm can be used to build this.\n                    // 这里根据 package.json 里面的 dependencies 以及 webpack 配置来决定是否复用缓存\n                    return require(\'node-object-hash\')({ sort: false }).hash({\n                       webpackConfig,\n                       dependencies: packageJson.dependencies\n                    });\n                 },\n                 // Either false, a string, an object, or a project hashing function.\n                 environmentHash: {\n                    root: process.cwd(),\n                    directories: [],\n                    files: []\n                 },\n                 // An object.\n                 info: {\n                    // \'none\' or \'test\'.\n                    mode: \'none\',\n                    // \'debug\', \'log\', \'info\', \'warn\', or \'error\'.\n                    level: \'debug\'\n                 },\n                 // Clean up large, old caches automatically.\n                 cachePrune: {\n                    // Caches younger than \\`maxAge\\` are not considered for deletion. They must\n                    // be at least this (default: 2 days) old in milliseconds.\n                    maxAge: 2 * 24 * 60 * 60 * 1000,\n                    // All caches together must be larger than \\`sizeThreshold\\` before any\n                    // caches will be deleted. Together they must be at least this\n                    // (default: 50 MB) big in bytes.\n                    sizeThreshold: 50 * 1024 * 1024\n                 }\n              })\n           ),\n           env === \'production\' &&\n              // 修复 hard-source-webpack-plugin 插件的各种异常，后面详细说明\n              addWebpackPlugin(\n                 new FixHardSourceWebpackPlugin({\n                    cacheDirectory: path.resolve(process.cwd(), \\`node_modules/.cache/hard-source/\\${env}\\`)\n                 })\n              )\n        ]\n      : [];\n\nmodule.exports = {\n   webpack: (config, env) => {\n      const isProd = env === \'production\';\n\n      const localConfig = override(\n         addBabelPlugins(\n            [\'@babel/plugin-proposal-nullish-coalescing-operator\'],\n            [\'@babel/plugin-syntax-optional-chaining\']\n         ),\n         fixBabelImports(\'import\', {\n            libraryName: \'antd\',\n            libraryDirectory: \'es\',\n            style: true\n         }),\n         addLessLoader({\n            javascriptEnabled: true\n            // modifyVars: { \'@primary-color\': \'#1DA570\' }\n         }),\n         addWebpackAlias({\n            \'@\': path.resolve(__dirname, \'src\')\n         }),\n         removeModuleScopePlugin(),\n         addWebpackModuleRule({\n            // test: /StreamDataWorker\\.js/,\n            test: /(StreamDataWorker|MapDataWorker|FrameProcessWorker)\\.js/,\n            use: { loader: \'worker-loader\', options: { filename: \'worker.[hash].js\' } }\n         }),\n         // TODO 这里不能用 worker.js 后缀，猜测是 oneOf 导致\n         // addWebpackModuleRule({\n         //   test: /\\.worker\\.js\\$/,\n         //   use: { loader: \'worker-loader\' }\n         // }),\n         isProd &&\n            setWebpackOptimizationSplitChunks({\n               cacheGroups: {\n                  vendors: {\n                     minChunks: 2,\n                     test: /[\\\\/]node_modules[\\\\/](?!google-protobuf|@antv|highcharts|mathjs|two\\.js|konva|victory-core)/,\n                     priority: -10,\n                     reuseExistingChunk: true,\n                     name: \'vendors\'\n                  },\n                  default: {\n                     minChunks: 2,\n                     priority: -20,\n                     reuseExistingChunk: true\n                  }\n               }\n            }),\n         // TODO 以下分包策略不是最优解\n         // isProd &&\n         //   setWebpackOptimizationSplitChunks({\n         //     chunks: \'all\',\n         //     maxInitialRequests: 10,\n         //     minSize: 0,\n         //     cacheGroups: {\n         //       vendor: {\n         //         test: module => {\n         //           // 遇到 echarts 相关库时，不要抽出来，以免 echarts 抽出的包很大\n         //           if (/[\\\\/]node_modules[\\\\/](echarts|zrender)/.test(module.context)) {\n         //             return false\n         //           }\n         //           return /[\\\\/]node_modules[\\\\/]/.test(module.context)\n         //         },\n         //         name: module => {\n         //           const packageName = module.context.match(/[\\\\/]node_modules[\\\\/](.*?)([\\\\/]|\\$)/)[1]\n         //           return \\`npm.\\${packageName.replace(\'@\', \'\')}\\`\n         //         }\n         //       }\n         //     }\n         //   }),\n         isProd &&\n            addWebpackPlugin(\n               new PreloadWebpackPlugin({\n                  rel: \'prefetch\',\n                  as: \'script\',\n                  fileBlacklist: [\n                     /\\d{1,2}\\.(\\d?[a-z]?)+\\.chunk\\.js\\$/,\n                     /main\\..+\\.js\\$/,\n                     /\\.css\\$/,\n                     /\\.txt\\$/,\n                     /\\.png\\$/,\n                     /.jpeg\\$/\n                  ],\n                  include: \'allAssets\'\n               })\n            ),\n         addWebpackPlugin(\n            new MonacoWebpackPlugin({\n               languages: [\'json\']\n            })\n         ),\n         // 显示编译进度\n         addWebpackPlugin(new WebpackBarPlugin()),\n         ...getHardSourceWebpackPlugins(env)\n      )(config);\n\n      // 注入 thread-loader\n      addBeforeLoaders(localConfig, \'babel-loader\', [\'thread-loader\']);\n\n      // 限制编译范围\n      localConfig.resolve.extensions = [\'.js\'];\n      localConfig.resolve.mainFields = [\'jsnext:main\', \'main\'];\n      localConfig.resolve.modules = [\'node_modules\'];\n\n      // 本地开发采用更轻量级的 cheap-module-eval-source-map\n      if (!isProd) {\n         localConfig.devtool = \'cheap-module-eval-source-map\';\n      }\n\n      // if (isProd) {\n      //   localConfig.optimization = {\n      //     ...localConfig.optimization,\n      //     nodeEnv: \'production\',\n      //     sideEffects: true,\n      //     concatenateModules: true,\n      //     runtimeChunk: \'single\'\n      //   }\n      // }\n\n      fs.writeFileSync(path.join(craDir, \\`webpack.\\${env}.json\\`), formatConfig(localConfig));\n\n      return localConfig;\n   },\n   devServer: (configFunction) => (proxy, allowedHost) => {\n      const config = configFunction(proxy, allowedHost);\n\n      config.quiet = false;\n\n      // 显示构建耗时\n      config.stats = {\n         errors: true,\n         children: false,\n         warnings: false,\n         colors: true,\n         assets: false,\n         modules: false,\n         entrypoints: false\n      };\n\n      // 关闭 host 检测，以免非 localhost 域名访问时热更新不生效\n      config.disableHostCheck = true;\n\n      fs.writeFileSync(path.join(craDir, \'webpack-dev-server.json\'), formatConfig(config));\n\n      return config;\n   }\n};`, `85574483727758130000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> <span class="token punctuation">{</span>\n   override<span class="token punctuation">,</span>\n   addBabelPlugins<span class="token punctuation">,</span>\n   fixBabelImports<span class="token punctuation">,</span>\n   addLessLoader<span class="token punctuation">,</span>\n   removeModuleScopePlugin<span class="token punctuation">,</span>\n   addWebpackModuleRule<span class="token punctuation">,</span>\n   setWebpackOptimizationSplitChunks<span class="token punctuation">,</span>\n   addWebpackPlugin<span class="token punctuation">,</span>\n   addWebpackAlias\n<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'customize-cra\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'fs\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> PreloadWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'preload-webpack-plugin\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'path\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> MonacoWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'monaco-editor-webpack-plugin\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> WebpackBarPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'webpackbar\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">,</span> pick <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'lodash\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> threadLoader <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'thread-loader\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> HardSourceWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'hard-source-webpack-plugin\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> packageJson <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./package.json\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> FixHardSourceWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./plugins/FixHardSourceWebpackPlugin\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// const SpeedMeasurePlugin = require(\'speed-measure-webpack-plugin\')</span>\n<span class="token comment">// const smp = new SpeedMeasurePlugin()</span>\n\n<span class="token comment">// 默认开启 hard-source-webpack-plugin 插件，可以传入这个环境变量来主动关闭</span>\n<span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token constant">DISABLE_HARD_SOURCE_PLUGIN</span> <span class="token punctuation">}</span> <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">;</span>\n\nthreadLoader<span class="token punctuation">.</span><span class="token function">warmup</span><span class="token punctuation">(</span>\n   <span class="token punctuation">{</span>\n      <span class="token comment">// pool options, like passed to loader options</span>\n      <span class="token comment">// must match loader options to boot the correct pool</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span>\n   <span class="token punctuation">[</span>\n      <span class="token comment">// modules to load</span>\n      <span class="token comment">// can be any module, i. e.</span>\n      <span class="token string">\'babel-loader\'</span>\n   <span class="token punctuation">]</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 打印 webpack 的相关配置，便于调试</span>\n<span class="token keyword">const</span> craDir <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">\'/.cra\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>craDir<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   fs<span class="token punctuation">.</span><span class="token function">mkdirSync</span><span class="token punctuation">(</span>craDir<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// 分析打印出的 webpack 相关配置的规律，可以写出此钩子函数，函数签名参考 craco 里面的函数</span>\n<span class="token keyword">const</span> <span class="token function-variable function">addBeforeLoaders</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">webpackConfig<span class="token punctuation">,</span> matchLoader<span class="token punctuation">,</span> newLoader <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   <span class="token keyword">const</span> matchLoaders <span class="token operator">=</span> <span class="token keyword">get</span><span class="token punctuation">(</span>webpackConfig<span class="token punctuation">,</span> <span class="token string">\'module.rules.1.oneOf\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span>\n      <span class="token keyword">get</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token string">\'loader\'</span><span class="token punctuation">,</span> <span class="token string">\'\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>matchLoader<span class="token punctuation">)</span>\n   <span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>matchLoaders<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      matchLoaders<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n         <span class="token keyword">const</span> props <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'loader\'</span><span class="token punctuation">,</span> <span class="token string">\'options\'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n         item<span class="token punctuation">.</span>use <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span>newLoader<span class="token punctuation">,</span> <span class="token function">pick</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> props<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n         props<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item2</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            <span class="token keyword">delete</span> item<span class="token punctuation">[</span>item2<span class="token punctuation">]</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 这里不能单纯的使用 JSON.stringify，需要特殊处理，否则不能序列化出函数部分</span>\n<span class="token keyword">const</span> <span class="token function-variable function">formatConfig</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span> <span class="token operator">=></span>\n   <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>\n      config<span class="token punctuation">,</span>\n      <span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> value <span class="token operator">===</span> <span class="token string">\'function\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">return</span> value<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span>\n         <span class="token keyword">return</span> value<span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      <span class="token number">2</span>\n   <span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">getHardSourceWebpackPlugins</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">env</span><span class="token punctuation">)</span> <span class="token operator">=></span>\n   <span class="token operator">!</span><span class="token constant">DISABLE_HARD_SOURCE_PLUGIN</span>\n      <span class="token operator">?</span> <span class="token punctuation">[</span>\n           <span class="token function">addWebpackPlugin</span><span class="token punctuation">(</span>\n              <span class="token keyword">new</span> <span class="token class-name">HardSourceWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n                 <span class="token comment">// Either an absolute path or relative to webpack\'s options.context.</span>\n                 cacheDirectory<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">node_modules/.cache/hard-source/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>env<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/[confighash]</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n                 <span class="token comment">// Either a string of object hash function given a webpack config.</span>\n                 <span class="token function-variable function">configHash</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">webpackConfig</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n                    <span class="token comment">// node-object-hash on npm can be used to build this.</span>\n                    <span class="token comment">// 这里根据 package.json 里面的 dependencies 以及 webpack 配置来决定是否复用缓存</span>\n                    <span class="token keyword">return</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'node-object-hash\'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">{</span> sort<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n                       webpackConfig<span class="token punctuation">,</span>\n                       dependencies<span class="token punctuation">:</span> packageJson<span class="token punctuation">.</span>dependencies\n                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                 <span class="token punctuation">}</span><span class="token punctuation">,</span>\n                 <span class="token comment">// Either false, a string, an object, or a project hashing function.</span>\n                 environmentHash<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n                    root<span class="token punctuation">:</span> process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n                    directories<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n                    files<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n                 <span class="token punctuation">}</span><span class="token punctuation">,</span>\n                 <span class="token comment">// An object.</span>\n                 info<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n                    <span class="token comment">// \'none\' or \'test\'.</span>\n                    mode<span class="token punctuation">:</span> <span class="token string">\'none\'</span><span class="token punctuation">,</span>\n                    <span class="token comment">// \'debug\', \'log\', \'info\', \'warn\', or \'error\'.</span>\n                    level<span class="token punctuation">:</span> <span class="token string">\'debug\'</span>\n                 <span class="token punctuation">}</span><span class="token punctuation">,</span>\n                 <span class="token comment">// Clean up large, old caches automatically.</span>\n                 cachePrune<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n                    <span class="token comment">// Caches younger than `maxAge` are not considered for deletion. They must</span>\n                    <span class="token comment">// be at least this (default: 2 days) old in milliseconds.</span>\n                    maxAge<span class="token punctuation">:</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">,</span>\n                    <span class="token comment">// All caches together must be larger than `sizeThreshold` before any</span>\n                    <span class="token comment">// caches will be deleted. Together they must be at least this</span>\n                    <span class="token comment">// (default: 50 MB) big in bytes.</span>\n                    sizeThreshold<span class="token punctuation">:</span> <span class="token number">50</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span>\n                 <span class="token punctuation">}</span>\n              <span class="token punctuation">}</span><span class="token punctuation">)</span>\n           <span class="token punctuation">)</span><span class="token punctuation">,</span>\n           env <span class="token operator">===</span> <span class="token string">\'production\'</span> <span class="token operator">&amp;&amp;</span>\n              <span class="token comment">// 修复 hard-source-webpack-plugin 插件的各种异常，后面详细说明</span>\n              <span class="token function">addWebpackPlugin</span><span class="token punctuation">(</span>\n                 <span class="token keyword">new</span> <span class="token class-name">FixHardSourceWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n                    cacheDirectory<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">node_modules/.cache/hard-source/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>env<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>\n                 <span class="token punctuation">}</span><span class="token punctuation">)</span>\n              <span class="token punctuation">)</span>\n        <span class="token punctuation">]</span>\n      <span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n\nmodule<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>\n   <span class="token function-variable function">webpack</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">config<span class="token punctuation">,</span> env</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> isProd <span class="token operator">=</span> env <span class="token operator">===</span> <span class="token string">\'production\'</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">const</span> localConfig <span class="token operator">=</span> <span class="token function">override</span><span class="token punctuation">(</span>\n         <span class="token function">addBabelPlugins</span><span class="token punctuation">(</span>\n            <span class="token punctuation">[</span><span class="token string">\'@babel/plugin-proposal-nullish-coalescing-operator\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n            <span class="token punctuation">[</span><span class="token string">\'@babel/plugin-syntax-optional-chaining\'</span><span class="token punctuation">]</span>\n         <span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token function">fixBabelImports</span><span class="token punctuation">(</span><span class="token string">\'import\'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>\n            libraryName<span class="token punctuation">:</span> <span class="token string">\'antd\'</span><span class="token punctuation">,</span>\n            libraryDirectory<span class="token punctuation">:</span> <span class="token string">\'es\'</span><span class="token punctuation">,</span>\n            style<span class="token punctuation">:</span> <span class="token boolean">true</span>\n         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token function">addLessLoader</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n            javascriptEnabled<span class="token punctuation">:</span> <span class="token boolean">true</span>\n            <span class="token comment">// modifyVars: { \'@primary-color\': \'#1DA570\' }</span>\n         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token function">addWebpackAlias</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n            <span class="token string">\'@\'</span><span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">\'src\'</span><span class="token punctuation">)</span>\n         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token function">removeModuleScopePlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token function">addWebpackModuleRule</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n            <span class="token comment">// test: /StreamDataWorker\\.js/,</span>\n            test<span class="token punctuation">:</span> <span class="token regex">/(StreamDataWorker|MapDataWorker|FrameProcessWorker)\\.js/</span><span class="token punctuation">,</span>\n            use<span class="token punctuation">:</span> <span class="token punctuation">{</span> loader<span class="token punctuation">:</span> <span class="token string">\'worker-loader\'</span><span class="token punctuation">,</span> options<span class="token punctuation">:</span> <span class="token punctuation">{</span> filename<span class="token punctuation">:</span> <span class="token string">\'worker.[hash].js\'</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>\n         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token comment">// TODO 这里不能用 worker.js 后缀，猜测是 oneOf 导致</span>\n         <span class="token comment">// addWebpackModuleRule({</span>\n         <span class="token comment">//   test: /\\.worker\\.js$/,</span>\n         <span class="token comment">//   use: { loader: \'worker-loader\' }</span>\n         <span class="token comment">// }),</span>\n         isProd <span class="token operator">&amp;&amp;</span>\n            <span class="token function">setWebpackOptimizationSplitChunks</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n               cacheGroups<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n                  vendors<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n                     minChunks<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>\n                     test<span class="token punctuation">:</span> <span class="token regex">/[\\\\/]node_modules[\\\\/](?!google-protobuf|@antv|highcharts|mathjs|two\\.js|konva|victory-core)/</span><span class="token punctuation">,</span>\n                     priority<span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">,</span>\n                     reuseExistingChunk<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n                     name<span class="token punctuation">:</span> <span class="token string">\'vendors\'</span>\n                  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n                  <span class="token keyword">default</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>\n                     minChunks<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>\n                     priority<span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">20</span><span class="token punctuation">,</span>\n                     reuseExistingChunk<span class="token punctuation">:</span> <span class="token boolean">true</span>\n                  <span class="token punctuation">}</span>\n               <span class="token punctuation">}</span>\n            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token comment">// TODO 以下分包策略不是最优解</span>\n         <span class="token comment">// isProd &amp;&amp;</span>\n         <span class="token comment">//   setWebpackOptimizationSplitChunks({</span>\n         <span class="token comment">//     chunks: \'all\',</span>\n         <span class="token comment">//     maxInitialRequests: 10,</span>\n         <span class="token comment">//     minSize: 0,</span>\n         <span class="token comment">//     cacheGroups: {</span>\n         <span class="token comment">//       vendor: {</span>\n         <span class="token comment">//         test: module => {</span>\n         <span class="token comment">//           // 遇到 echarts 相关库时，不要抽出来，以免 echarts 抽出的包很大</span>\n         <span class="token comment">//           if (/[\\\\/]node_modules[\\\\/](echarts|zrender)/.test(module.context)) {</span>\n         <span class="token comment">//             return false</span>\n         <span class="token comment">//           }</span>\n         <span class="token comment">//           return /[\\\\/]node_modules[\\\\/]/.test(module.context)</span>\n         <span class="token comment">//         },</span>\n         <span class="token comment">//         name: module => {</span>\n         <span class="token comment">//           const packageName = module.context.match(/[\\\\/]node_modules[\\\\/](.*?)([\\\\/]|$)/)[1]</span>\n         <span class="token comment">//           return `npm.${packageName.replace(\'@\', \'\')}`</span>\n         <span class="token comment">//         }</span>\n         <span class="token comment">//       }</span>\n         <span class="token comment">//     }</span>\n         <span class="token comment">//   }),</span>\n         isProd <span class="token operator">&amp;&amp;</span>\n            <span class="token function">addWebpackPlugin</span><span class="token punctuation">(</span>\n               <span class="token keyword">new</span> <span class="token class-name">PreloadWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n                  rel<span class="token punctuation">:</span> <span class="token string">\'prefetch\'</span><span class="token punctuation">,</span>\n                  <span class="token keyword">as</span><span class="token punctuation">:</span> <span class="token string">\'script\'</span><span class="token punctuation">,</span>\n                  fileBlacklist<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n                     <span class="token regex">/\\d{1,2}\\.(\\d?[a-z]?)+\\.chunk\\.js$/</span><span class="token punctuation">,</span>\n                     <span class="token regex">/main\\..+\\.js$/</span><span class="token punctuation">,</span>\n                     <span class="token regex">/\\.css$/</span><span class="token punctuation">,</span>\n                     <span class="token regex">/\\.txt$/</span><span class="token punctuation">,</span>\n                     <span class="token regex">/\\.png$/</span><span class="token punctuation">,</span>\n                     <span class="token regex">/.jpeg$/</span>\n                  <span class="token punctuation">]</span><span class="token punctuation">,</span>\n                  include<span class="token punctuation">:</span> <span class="token string">\'allAssets\'</span>\n               <span class="token punctuation">}</span><span class="token punctuation">)</span>\n            <span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token function">addWebpackPlugin</span><span class="token punctuation">(</span>\n            <span class="token keyword">new</span> <span class="token class-name">MonacoWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n               languages<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'json\'</span><span class="token punctuation">]</span>\n            <span class="token punctuation">}</span><span class="token punctuation">)</span>\n         <span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token comment">// 显示编译进度</span>\n         <span class="token function">addWebpackPlugin</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WebpackBarPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token operator">...</span><span class="token function">getHardSourceWebpackPlugins</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span>\n      <span class="token punctuation">)</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token comment">// 注入 thread-loader</span>\n      <span class="token function">addBeforeLoaders</span><span class="token punctuation">(</span>localConfig<span class="token punctuation">,</span> <span class="token string">\'babel-loader\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">\'thread-loader\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token comment">// 限制编译范围</span>\n      localConfig<span class="token punctuation">.</span>resolve<span class="token punctuation">.</span>extensions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'.js\'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n      localConfig<span class="token punctuation">.</span>resolve<span class="token punctuation">.</span>mainFields <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'jsnext:main\'</span><span class="token punctuation">,</span> <span class="token string">\'main\'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n      localConfig<span class="token punctuation">.</span>resolve<span class="token punctuation">.</span>modules <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'node_modules\'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n      <span class="token comment">// 本地开发采用更轻量级的 cheap-module-eval-source-map</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isProd<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         localConfig<span class="token punctuation">.</span>devtool <span class="token operator">=</span> <span class="token string">\'cheap-module-eval-source-map\'</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token comment">// if (isProd) {</span>\n      <span class="token comment">//   localConfig.optimization = {</span>\n      <span class="token comment">//     ...localConfig.optimization,</span>\n      <span class="token comment">//     nodeEnv: \'production\',</span>\n      <span class="token comment">//     sideEffects: true,</span>\n      <span class="token comment">//     concatenateModules: true,</span>\n      <span class="token comment">//     runtimeChunk: \'single\'</span>\n      <span class="token comment">//   }</span>\n      <span class="token comment">// }</span>\n\n      fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>craDir<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">webpack.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>env<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.json</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">formatConfig</span><span class="token punctuation">(</span>localConfig<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">return</span> localConfig<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span>\n   <span class="token function-variable function">devServer</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">configFunction</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token parameter">proxy<span class="token punctuation">,</span> allowedHost</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">configFunction</span><span class="token punctuation">(</span>proxy<span class="token punctuation">,</span> allowedHost<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      config<span class="token punctuation">.</span>quiet <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>\n\n      <span class="token comment">// 显示构建耗时</span>\n      config<span class="token punctuation">.</span>stats <span class="token operator">=</span> <span class="token punctuation">{</span>\n         errors<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n         children<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n         warnings<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n         colors<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n         assets<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n         modules<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n         entrypoints<span class="token punctuation">:</span> <span class="token boolean">false</span>\n      <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n      <span class="token comment">// 关闭 host 检测，以免非 localhost 域名访问时热更新不生效</span>\n      config<span class="token punctuation">.</span>disableHostCheck <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n\n      fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>craDir<span class="token punctuation">,</span> <span class="token string">\'webpack-dev-server.json\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">formatConfig</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">return</span> config<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="dockerfile-配置缓存优化"><a href="#dockerfile-%E9%85%8D%E7%BD%AE%E7%BC%93%E5%AD%98%E4%BC%98%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Dockerfile 配置缓存优化</h3>\n<h4 id="需求背景-1"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h4>\n<p>为了充分利用缓存，采用 docker 的缓存策略</p>\n<h4 id="背景知识"><a href="#%E8%83%8C%E6%99%AF%E7%9F%A5%E8%AF%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>背景知识</h4>\n<p><a href="/docker-introduce-learning/">Docker 入门学习</a></p>\n<h4 id="第一版"><a href="#%E7%AC%AC%E4%B8%80%E7%89%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第一版</h4>\n<p>这里的主要问题在于一旦改了源码需要编译的时候，缓存失效了</p>\n<p>原因是标红行部分复制了文件，再进行构建的时候，因为已经是新的文件了，所以这里 build 的时候不能使用缓存</p>\n<p>Dockerfile-client</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="79884560008995750000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`FROM node:14-alpine as builder\n\n# 全局安装依赖，尽量写在一行防止加了新库之后还是使用原来的镜像\nRUN npm config set registry https://registry.npmmirror.com\n\nWORKDIR /home/\n\n# 缓存 package.json pnpm-lock.yaml，只有变更的时候才会重新 install\nCOPY package.json package-lock.json ./\n# 安装依赖\nRUN npm i\n\n# 复制剩余文件\nCOPY . .\n\nRUN ls && npm run build && ls\n\nFROM nginx:alpine\nCOPY --from=builder /home/build /usr/share/nginx/html/\nCOPY nginx.conf /etc/nginx/conf.d/default.conf\n\nEXPOSE 3000`, `79884560008995750000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile{14}"\n              >\n                <span class="gatsby-code-button-language">dockerfile{14}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">FROM</span> node<span class="token punctuation">:</span>14<span class="token punctuation">-</span>alpine as builder\n\n<span class="token comment"># 全局安装依赖，尽量写在一行防止加了新库之后还是使用原来的镜像</span>\n<span class="token keyword">RUN</span> npm config set registry https<span class="token punctuation">:</span>//registry.npmmirror.com\n\n<span class="token keyword">WORKDIR</span> /home/\n\n<span class="token comment"># 缓存 package.json pnpm-lock.yaml，只有变更的时候才会重新 install</span>\n<span class="token keyword">COPY</span> package.json package<span class="token punctuation">-</span>lock.json ./\n<span class="token comment"># 安装依赖</span>\n<span class="token keyword">RUN</span> npm i\n\n<span class="token comment"># 复制剩余文件</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">COPY</span> . .</span>\n<span class="token keyword">RUN</span> ls &amp;&amp; npm run build &amp;&amp; ls\n\n<span class="token keyword">FROM</span> nginx<span class="token punctuation">:</span>alpine\n<span class="token keyword">COPY</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>from=builder /home/build /usr/share/nginx/html/\n<span class="token keyword">COPY</span> nginx.conf /etc/nginx/conf.d/default.conf\n\n<span class="token keyword">EXPOSE</span> 3000</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="第二版"><a href="#%E7%AC%AC%E4%BA%8C%E7%89%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第二版</h4>\n<p>由于第一版的问题，所以需要想办法在 build 过程中也要尽可能的使用缓存</p>\n<p>这里由于缓存容易损坏（由上面提到的 hard-source-webpack-plugin 造成），需要给缓存一个版本的概念，同时也要控制是否使用缓存</p>\n<p>Dockerfile-client-buildkit</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="26549939064153350000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# syntax = docker/dockerfile:experimental\n\nFROM node:14-alpine as builder\n\nARG registry=https://registry.npmmirror.com\n\n# 全局安装依赖，尽量写在一行防止加了新库之后还是使用原来的镜像\nRUN npm config set registry \\${registry} -g && npm i -g pnpm\n\nWORKDIR /home/\n\n# 缓存 pnpm-lock.yaml\nCOPY pnpm-lock.yaml ./\n\n# 下载依赖到全局位置\nRUN pnpm fetch --prod\n\n# 复制剩余文件\nCOPY . .\n\n# 安装依赖同时读写缓存\nRUN --mount=type=cache,target=node_modules,id=frontend_node_modules,sharing=locked \\\n    --mount=type=cache,target=/root/.npm,id=npm_cache \\\n    pnpm i --ignore-scripts=true --prod --offline --registry=\\$registry\n\n# build 并读写缓存\nRUN --mount=type=cache,target=node_modules,id=frontend_node_modules,sharing=locked \\\n    pnpm build\n\n# 以下是二阶段\nFROM nginx:alpine\n\nRUN --mount=type=bind,target=/tmp/build,from=builder,source=/home/build \\\n    cp -r /tmp/build/* /usr/share/nginx/html/\n\nCOPY nginx.conf /etc/nginx/conf.d/default.conf\n\nEXPOSE 3000`, `26549939064153350000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token comment"># syntax = docker/dockerfile:experimental</span>\n\n<span class="token keyword">FROM</span> node<span class="token punctuation">:</span>14<span class="token punctuation">-</span>alpine as builder\n\n<span class="token keyword">ARG</span> registry=https<span class="token punctuation">:</span>//registry.npmmirror.com\n\n<span class="token comment"># 全局安装依赖，尽量写在一行防止加了新库之后还是使用原来的镜像</span>\n<span class="token keyword">RUN</span> npm config set registry $<span class="token punctuation">{</span>registry<span class="token punctuation">}</span> <span class="token punctuation">-</span>g &amp;&amp; npm i <span class="token punctuation">-</span>g pnpm\n\n<span class="token keyword">WORKDIR</span> /home/\n\n<span class="token comment"># 缓存 pnpm-lock.yaml</span>\n<span class="token keyword">COPY</span> pnpm<span class="token punctuation">-</span>lock.yaml ./\n\n<span class="token comment"># 下载依赖到全局位置</span>\n<span class="token keyword">RUN</span> pnpm fetch <span class="token punctuation">-</span><span class="token punctuation">-</span>prod\n\n<span class="token comment"># 复制剩余文件</span>\n<span class="token keyword">COPY</span> . .\n\n<span class="token comment"># 安装依赖同时读写缓存</span>\n<span class="token keyword">RUN</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>mount=type=cache<span class="token punctuation">,</span>target=node_modules<span class="token punctuation">,</span>id=frontend_node_modules<span class="token punctuation">,</span>sharing=locked \\\n    <span class="token punctuation">-</span><span class="token punctuation">-</span>mount=type=cache<span class="token punctuation">,</span>target=/root/.npm<span class="token punctuation">,</span>id=npm_cache \\\n    pnpm i <span class="token punctuation">-</span><span class="token punctuation">-</span>ignore<span class="token punctuation">-</span>scripts=true <span class="token punctuation">-</span><span class="token punctuation">-</span>prod <span class="token punctuation">-</span><span class="token punctuation">-</span>offline <span class="token punctuation">-</span><span class="token punctuation">-</span>registry=$registry\n\n<span class="token comment"># build 并读写缓存</span>\n<span class="token keyword">RUN</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>mount=type=cache<span class="token punctuation">,</span>target=node_modules<span class="token punctuation">,</span>id=frontend_node_modules<span class="token punctuation">,</span>sharing=locked \\\n    pnpm build\n\n<span class="token comment"># 以下是二阶段</span>\n<span class="token keyword">FROM</span> nginx<span class="token punctuation">:</span>alpine\n\n<span class="token keyword">RUN</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>mount=type=bind<span class="token punctuation">,</span>target=/tmp/build<span class="token punctuation">,</span>from=builder<span class="token punctuation">,</span>source=/home/build \\\n    cp <span class="token punctuation">-</span>r /tmp/build/* /usr/share/nginx/html/\n\n<span class="token keyword">COPY</span> nginx.conf /etc/nginx/conf.d/default.conf\n\n<span class="token keyword">EXPOSE</span> 3000</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>最终采用第二版，同时为了减少构建上下文，需要添加如下的文件</p>\n<p>.dockerignore</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="90303879157161100000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`*\n# 静态文件\n!public\n# 为了兼容老版本的 jenkins 不报错，实际上不该加\n!build\n\n# 源码\n!src\n\n# 构建相关\n!.env.production\n!config-overrides.js\n!plugins\n!scripts\n\n# 依赖库\n!package.json\n!pnpm-lock.yaml\n\n# nginx\n!nginx.conf`, `90303879157161100000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile">*\n<span class="token comment"># 静态文件</span>\n!public\n<span class="token comment"># 为了兼容老版本的 jenkins 不报错，实际上不该加</span>\n!build\n\n<span class="token comment"># 源码</span>\n!src\n\n<span class="token comment"># 构建相关</span>\n!.env.production\n!config<span class="token punctuation">-</span>overrides.js\n!plugins\n!scripts\n\n<span class="token comment"># 依赖库</span>\n!package.json\n!pnpm<span class="token punctuation">-</span>lock.yaml\n\n<span class="token comment"># nginx</span>\n!nginx.conf</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="调用"><a href="#%E8%B0%83%E7%94%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>调用</h4>\n<ol>\n<li><code class="language-text">BUILDKIT_CACHE_MOUNT_NS</code> 就类似于缓存版本的概念</li>\n<li>可以传入 <code class="language-text">--no-cache</code> 来控制不使用缓存，默认使用（这里的 docker 18 版本的 <code class="language-text">--no-cache</code> 不对 <code class="language-text">type=cache</code> 生效，20 版本的反而生效）</li>\n<li>以上 2 个参数可以配合 jenkins 来控制</li>\n</ol>\n<p>package.json</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="29030122122129785000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`{\n   &quot;scripts&quot;: {\n      &quot;build&quot;: &quot;node scripts/build.js&quot;,\n      &quot;docker:build&quot;: &quot;DOCKER_BUILDKIT=1 docker build --build-arg=BUILDKIT_CACHE_MOUNT_NS=tbtu --network=host -t frontend -f ./Dockerfile-client-buildkit .&quot;,\n      &quot;docker:run&quot;: &quot;docker run -it -p 3000:3000 --rm frontend&quot;,\n      &quot;docker:start&quot;: &quot;npm run docker:build && npm run docker:run&quot;\n   }\n}`, `29030122122129785000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="json"\n              >\n                <span class="gatsby-code-button-language">json</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="json"><pre style="counter-reset: linenumber NaN" class="language-json line-numbers"><code class="language-json"><span class="token punctuation">{</span>\n   <span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n      <span class="token property">"build"</span><span class="token operator">:</span> <span class="token string">"node scripts/build.js"</span><span class="token punctuation">,</span>\n      <span class="token property">"docker:build"</span><span class="token operator">:</span> <span class="token string">"DOCKER_BUILDKIT=1 docker build --build-arg=BUILDKIT_CACHE_MOUNT_NS=tbtu --network=host -t frontend -f ./Dockerfile-client-buildkit ."</span><span class="token punctuation">,</span>\n      <span class="token property">"docker:run"</span><span class="token operator">:</span> <span class="token string">"docker run -it -p 3000:3000 --rm frontend"</span><span class="token punctuation">,</span>\n      <span class="token property">"docker:start"</span><span class="token operator">:</span> <span class="token string">"npm run docker:build &amp;&amp; npm run docker:run"</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="npm-切换到-pnpm"><a href="#npm-%E5%88%87%E6%8D%A2%E5%88%B0-pnpm" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>npm 切换到 pnpm</h3>\n<h4 id="需求背景-2"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h4>\n<p>在公司的 jenkins 平台上打包时发现 npm install 的过程特别慢，主要是老项目的依赖库太多，故考虑转向安装速度更快的 pnpm</p>\n<h4 id="实现方式"><a href="#%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>实现方式</h4>\n<ol>\n<li>因为老项目里面已有 package-lock.json，所以通过 <code class="language-text">pnpm import</code> 可以实现一键迁移，当然有些三方库使用错误导致白屏，这些库需要特殊处理</li>\n<li>配合上面的 dockerfile 可实现深度缓存</li>\n<li>由于上面提到的是否使用缓存一部分是由 package.json 里面的 dependencies 决定，所以需要规范 dependencies 的用法</li>\n</ol>\n<h3 id="npm-install-校验命令"><a href="#npm-install-%E6%A0%A1%E9%AA%8C%E5%91%BD%E4%BB%A4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>npm install 校验命令</h3>\n<h4 id="需求背景-3"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h4>\n<p>为了统一库的安装工具，防止团队成员使用别的库安装工具</p>\n<h4 id="实现方式-1"><a href="#%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>实现方式</h4>\n<ol>\n<li>通过 volta 限制只能使用 pnpm（截止 2022-11-21 11:21:42 <a href="https://github.com/volta-cli/volta/issues/737" target="_blank" rel="nofollow noreferrer noopener">不支持 pnpm</a>）</li>\n<li>手动写 hook 脚本</li>\n</ol>\n<p>最终 2 种方式都采用</p>\n<h4 id="volta"><a href="#volta" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>volta</h4>\n<p>安装过程见 <a href="/frontend-devlopment-environment-setting/#volta">volta</a></p>\n<p>同时在 package.json 加如下几行，这样切入项目目录就会自动切换构建工具</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="37939839104317304"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`{\n   &quot;volta&quot;: {\n      &quot;node&quot;: &quot;14.20.0&quot;,\n      &quot;pnpm&quot;: &quot;7.14.1&quot;\n   }\n}`, `37939839104317304`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="json"\n              >\n                <span class="gatsby-code-button-language">json</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="json"><pre style="counter-reset: linenumber NaN" class="language-json line-numbers"><code class="language-json"><span class="token punctuation">{</span>\n   <span class="token property">"volta"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n      <span class="token property">"node"</span><span class="token operator">:</span> <span class="token string">"14.20.0"</span><span class="token punctuation">,</span>\n      <span class="token property">"pnpm"</span><span class="token operator">:</span> <span class="token string">"7.14.1"</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="hook-脚本"><a href="#hook-%E8%84%9A%E6%9C%AC" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>hook 脚本</h4>\n<p>scripts/node-check-version.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="38529352066785360000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const { exec } = require(\'child_process\');\nexec(\'node -v\', (err, stdout) => {\n   if (err) throw err;\n   if (parseInt(stdout.slice(1)) !== 14) {\n      // NOTE: This can happen if you have a dependency which lists an old version of npm in its own dependencies.\n      throw new Error(\\`[ERROR] You need node version @=14 but you have \\${stdout}\\`);\n   }\n});`, `38529352066785360000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> <span class="token punctuation">{</span> exec <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'child_process\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">\'node -v\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> stdout</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">throw</span> err<span class="token punctuation">;</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">parseInt</span><span class="token punctuation">(</span>stdout<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token number">14</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// NOTE: This can happen if you have a dependency which lists an old version of npm in its own dependencies.</span>\n      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[ERROR] You need node version @=14 but you have </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>stdout<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>scripts/only-allow.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="58002457909443120000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const pmFromUserAgent = (userAgent) => {\n   const pmSpec = userAgent.split(\' \')[0];\n   const separatorPos = pmSpec.lastIndexOf(\'/\');\n   return {\n      name: pmSpec.substr(0, separatorPos),\n      version: pmSpec.substr(separatorPos + 1)\n   };\n};\n\nif (!process.env.npm_config_user_agent) {\n   throw new Error(\'[ERROR] Please check your npm!\');\n}\n\nconst [name, version] = process.argv.slice(2);\n\nconst pm = pmFromUserAgent(process.env.npm_config_user_agent);\n\nif (name !== pm.name) {\n   const errors = [\\`[ERROR] You need \\${name}\\`];\n\n   const urlMap = {\n      pnpm: \'https://pnpm.js.org/\',\n      yarn: \'https://yarnpkg.com/\'\n   };\n\n   if (urlMap[name]) {\n      errors.push(\\`Please go to \\${urlMap[name]}\\`);\n   }\n\n   throw new Error(errors.join(\', \'));\n}\n\nif (parseFloat(pm.version) < version) {\n   throw new Error(\\`[ERROR] You need \\${name} version @>=\\${version} but you have \\${pm.version}\\`);\n}`, `58002457909443120000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">pmFromUserAgent</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">userAgent</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   <span class="token keyword">const</span> pmSpec <span class="token operator">=</span> userAgent<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">\' \'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n   <span class="token keyword">const</span> separatorPos <span class="token operator">=</span> pmSpec<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">\'/\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">return</span> <span class="token punctuation">{</span>\n      name<span class="token punctuation">:</span> pmSpec<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> separatorPos<span class="token punctuation">)</span><span class="token punctuation">,</span>\n      version<span class="token punctuation">:</span> pmSpec<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span>separatorPos <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>\n   <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>npm_config_user_agent<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">\'[ERROR] Please check your npm!\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">const</span> <span class="token punctuation">[</span>name<span class="token punctuation">,</span> version<span class="token punctuation">]</span> <span class="token operator">=</span> process<span class="token punctuation">.</span>argv<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> pm <span class="token operator">=</span> <span class="token function">pmFromUserAgent</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>npm_config_user_agent<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">!==</span> pm<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">const</span> errors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[ERROR] You need </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n   <span class="token keyword">const</span> urlMap <span class="token operator">=</span> <span class="token punctuation">{</span>\n      pnpm<span class="token punctuation">:</span> <span class="token string">\'https://pnpm.js.org/\'</span><span class="token punctuation">,</span>\n      yarn<span class="token punctuation">:</span> <span class="token string">\'https://yarnpkg.com/\'</span>\n   <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>urlMap<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      errors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Please go to </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>urlMap<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>errors<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">\', \'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">parseFloat</span><span class="token punctuation">(</span>pm<span class="token punctuation">.</span>version<span class="token punctuation">)</span> <span class="token operator">&lt;</span> version<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[ERROR] You need </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> version @>=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>version<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> but you have </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>pm<span class="token punctuation">.</span>version<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>package.json</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="42403796574959650000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`{\n   &quot;scripts&quot;: {\n      &quot;preinstall&quot;: &quot;npm run verify-version&quot;,\n      &quot;node-check-version&quot;: &quot;node scripts/node-check-version.js&quot;,\n      &quot;only-allow&quot;: &quot;node scripts/only-allow.js pnpm 7&quot;,\n      &quot;pnpm:devPreinstall&quot;: &quot;npm run verify-version&quot;,\n      &quot;verify-version&quot;: &quot;npm run node-check-version && npm run only-allow&quot;\n   }\n}`, `42403796574959650000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="json"\n              >\n                <span class="gatsby-code-button-language">json</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="json"><pre style="counter-reset: linenumber NaN" class="language-json line-numbers"><code class="language-json"><span class="token punctuation">{</span>\n   <span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n      <span class="token property">"preinstall"</span><span class="token operator">:</span> <span class="token string">"npm run verify-version"</span><span class="token punctuation">,</span>\n      <span class="token property">"node-check-version"</span><span class="token operator">:</span> <span class="token string">"node scripts/node-check-version.js"</span><span class="token punctuation">,</span>\n      <span class="token property">"only-allow"</span><span class="token operator">:</span> <span class="token string">"node scripts/only-allow.js pnpm 7"</span><span class="token punctuation">,</span>\n      <span class="token property">"pnpm:devPreinstall"</span><span class="token operator">:</span> <span class="token string">"npm run verify-version"</span><span class="token punctuation">,</span>\n      <span class="token property">"verify-version"</span><span class="token operator">:</span> <span class="token string">"npm run node-check-version &amp;&amp; npm run only-allow"</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这里要注意，由于 pnpm 下的 preinstall 是 install 后才执行的，所以增加了 <code class="language-text">pnpm:devPreinstall</code>，同时生产环境通过添加 <code class="language-text">--ignore-scripts=true</code> 参数不运行此钩子</p>\n<p>以上就可以限制只能通过 pnpm 来进行 install（以上脚本还限制了版本）</p>\n<h3 id="hard-source-webpack-plugin-的线上修复"><a href="#hard-source-webpack-plugin-%E7%9A%84%E7%BA%BF%E4%B8%8A%E4%BF%AE%E5%A4%8D" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>hard-source-webpack-plugin 的线上修复</h3>\n<h4 id="需求背景-4"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h4>\n<p>在使用了 hard-source-webpack-plugin 作缓存加速时，有以下比较明显的问题</p>\n<ol>\n<li>二次编译有时不能正常停止</li>\n<li>二次编译会出现各种编译报错，清空缓存后重新编译却正常</li>\n</ol>\n<h4 id="实现方式-2"><a href="#%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>实现方式</h4>\n<p>针对以上问题，有以下解决方式</p>\n<ol>\n<li>二次编译时识别到 done 即编译完成，此时调用 <code class="language-text">process.exit(0)</code> 手动结束</li>\n<li>二次编译时一旦编译报错则认为是缓存损坏，此时清空缓存，重启 build 命令</li>\n</ol>\n<p>scripts/const.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="83561337179396920000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const CACHE_ERROR_CODE = 10;\n\nmodule.exports = {\n   CACHE_ERROR_CODE\n};`, `83561337179396920000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> <span class="token constant">CACHE_ERROR_CODE</span> <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>\n\nmodule<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>\n   <span class="token constant">CACHE_ERROR_CODE</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>scripts/build.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="41806292735376660000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const child_process = require(\'child_process\');\n\nconst { CACHE_ERROR_CODE } = require(\'./const\');\n\nfunction spawn(mainModule) {\n   const worker = child_process.spawn(\'react-app-rewired\', mainModule, {\n      stdio: \'inherit\'\n   });\n\n   worker.on(\'exit\', function(code) {\n      // 接受到缓存损坏信号，重启命令\n      if (code === CACHE_ERROR_CODE) {\n         spawn(mainModule);\n         // 除了正常停止的 0 外，其他错误码均认为异常\n      } else if (code !== 0) {\n         process.exit(1);\n      }\n   });\n}\n\nspawn([\'--max-old-space-size=4096\', \'build\']);`, `41806292735376660000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> child_process <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'child_process\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token constant">CACHE_ERROR_CODE</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./const\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">function</span> <span class="token function">spawn</span><span class="token punctuation">(</span><span class="token parameter">mainModule</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">const</span> worker <span class="token operator">=</span> child_process<span class="token punctuation">.</span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token string">\'react-app-rewired\'</span><span class="token punctuation">,</span> mainModule<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n      stdio<span class="token punctuation">:</span> <span class="token string">\'inherit\'</span>\n   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   worker<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'exit\'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">code</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 接受到缓存损坏信号，重启命令</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>code <span class="token operator">===</span> <span class="token constant">CACHE_ERROR_CODE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token function">spawn</span><span class="token punctuation">(</span>mainModule<span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token comment">// 除了正常停止的 0 外，其他错误码均认为异常</span>\n      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>code <span class="token operator">!==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token function">spawn</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'--max-old-space-size=4096\'</span><span class="token punctuation">,</span> <span class="token string">\'build\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>plugins/FixHardSourceWebpackPlugin.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="4473536857242988000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const rimraf = require(\'rimraf\');\nconst { get } = require(\'lodash\');\nconst { CACHE_ERROR_CODE } = require(\'../scripts/const\');\n\nclass FixHardSourceWebpackPlugin {\n   constructor(options) {\n      this.options = options || {};\n      // 是否读取了上次的缓存\n      this.cacheRead = false;\n   }\n\n   apply(compiler) {\n      compiler.hooks.hardSourceLog.tap(\'hardSourceLog\', (message) => {\n         // eslint-disable-next-line no-useless-call\n         // console[message.level].call(console, message)\n\n         const id = get(message, \'data.id\');\n\n         if (id === \'confighash--reused\') {\n            this.cacheRead = true;\n         }\n      });\n\n      const handleClearCache = () => {\n         // 第一次生成缓存的时候，如果编译失败则判定缓存无效，清空缓存，退出命令\n         // 第二次读缓存的情况下，如果编译失败则判定缓存无效，清空缓存，重启命令\n         const { cacheDirectory } = this.options;\n         console.log(\'[FixHardSourceWebpackPlugin] Clearing Cache\', cacheDirectory);\n         rimraf.sync(cacheDirectory);\n         console.log(\'[FixHardSourceWebpackPlugin] Cache Cleared\');\n         if (this.cacheRead) {\n            console.log(\'[FixHardSourceWebpackPlugin] Restarting...\');\n            process.exit(CACHE_ERROR_CODE);\n         }\n      };\n\n      // 找不到具体的模块时会调用，比如随便导入一个不存在的模块\n      // import Atmp from \'./fake\'，且代码里面用到 Atmp 组件（这里的 fake 根本不存在）\n      compiler.hooks.failed.tap(\'FixHardSourceWebpack Cache Error\', () => {\n         console.log(\'[FixHardSourceWebpackPlugin] Invoke Failed\');\n         handleClearCache();\n      });\n\n      // 导出一个不存在的模块并使用时会调用\n      // import { Atmp } from \'./fake\' 且代码里面用到 Atmp 组件（实际上 Atmp 是不存在的组件）\n      compiler.hooks.done.tap(\'FixHardSourceWebpack Cache Error\', (stats) => {\n         const hasErrors = stats.hasErrors();\n         if (!hasErrors) {\n            return;\n         }\n         console.log(\'[FixHardSourceWebpackPlugin] Invoke Done\');\n         handleClearCache();\n      });\n\n      compiler.hooks.done.tap(\'FixHardSourceWebpackPlugin Force Stop\', (stats) => {\n         if (!this.cacheRead) {\n            return;\n         }\n\n         // 编译完成强制结束\n         // HACK 生产模式下因为 hard-source-webpack-plugin 插件的原因不会完全停止，暂未找到原因\n         setTimeout(() => {\n            console.log(\'[FixHardSourceWebpackPlugin] Force Stop\');\n            process.exit(0);\n         });\n      });\n   }\n}\n\nmodule.exports = FixHardSourceWebpackPlugin;`, `4473536857242988000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> rimraf <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'rimraf\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">get</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'lodash\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token constant">CACHE_ERROR_CODE</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'../scripts/const\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">class</span> <span class="token class-name">FixHardSourceWebpackPlugin</span> <span class="token punctuation">{</span>\n   <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>options <span class="token operator">=</span> options <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n      <span class="token comment">// 是否读取了上次的缓存</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>cacheRead <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>hardSourceLog<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">\'hardSourceLog\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">message</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n         <span class="token comment">// eslint-disable-next-line no-useless-call</span>\n         <span class="token comment">// console[message.level].call(console, message)</span>\n\n         <span class="token keyword">const</span> id <span class="token operator">=</span> <span class="token keyword">get</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> <span class="token string">\'data.id\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n         <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">===</span> <span class="token string">\'confighash--reused\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">this</span><span class="token punctuation">.</span>cacheRead <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">const</span> <span class="token function-variable function">handleClearCache</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n         <span class="token comment">// 第一次生成缓存的时候，如果编译失败则判定缓存无效，清空缓存，退出命令</span>\n         <span class="token comment">// 第二次读缓存的情况下，如果编译失败则判定缓存无效，清空缓存，重启命令</span>\n         <span class="token keyword">const</span> <span class="token punctuation">{</span> cacheDirectory <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">;</span>\n         console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'[FixHardSourceWebpackPlugin] Clearing Cache\'</span><span class="token punctuation">,</span> cacheDirectory<span class="token punctuation">)</span><span class="token punctuation">;</span>\n         rimraf<span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span>cacheDirectory<span class="token punctuation">)</span><span class="token punctuation">;</span>\n         console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'[FixHardSourceWebpackPlugin] Cache Cleared\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>cacheRead<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'[FixHardSourceWebpackPlugin] Restarting...\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token constant">CACHE_ERROR_CODE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n      <span class="token comment">// 找不到具体的模块时会调用，比如随便导入一个不存在的模块</span>\n      <span class="token comment">// import Atmp from \'./fake\'，且代码里面用到 Atmp 组件（这里的 fake 根本不存在）</span>\n      compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>failed<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">\'FixHardSourceWebpack Cache Error\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n         console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'[FixHardSourceWebpackPlugin] Invoke Failed\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token function">handleClearCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token comment">// 导出一个不存在的模块并使用时会调用</span>\n      <span class="token comment">// import { Atmp } from \'./fake\' 且代码里面用到 Atmp 组件（实际上 Atmp 是不存在的组件）</span>\n      compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>done<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">\'FixHardSourceWebpack Cache Error\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">stats</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n         <span class="token keyword">const</span> hasErrors <span class="token operator">=</span> stats<span class="token punctuation">.</span><span class="token function">hasErrors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hasErrors<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">return</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span>\n         console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'[FixHardSourceWebpackPlugin] Invoke Done\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token function">handleClearCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>done<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">\'FixHardSourceWebpackPlugin Force Stop\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">stats</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>cacheRead<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">return</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span>\n\n         <span class="token comment">// 编译完成强制结束</span>\n         <span class="token comment">// HACK 生产模式下因为 hard-source-webpack-plugin 插件的原因不会完全停止，暂未找到原因</span>\n         <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'[FixHardSourceWebpackPlugin] Force Stop\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\nmodule<span class="token punctuation">.</span>exports <span class="token operator">=</span> FixHardSourceWebpackPlugin<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="后续问题"><a href="#%E5%90%8E%E7%BB%AD%E9%97%AE%E9%A2%98" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>后续问题</h4>\n<p>在代码变动之后，如果通过缓存生成，查看编译后的代码还是之前的老代码，需要暂时关闭缓存待以后解决</p>\n<h3 id="preload-webpack-plugin-失效处理"><a href="#preload-webpack-plugin-%E5%A4%B1%E6%95%88%E5%A4%84%E7%90%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>preload-webpack-plugin 失效处理</h3>\n<h4 id="需求背景-5"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h4>\n<p>此插件在 pnpm 下不生效，在 npm 下反而生效</p>\n<h4 id="原因"><a href="#%E5%8E%9F%E5%9B%A0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>原因</h4>\n<p>require 指向的 html-webpack-plugin 不是同一个，导致 hook 不能被调用，具体见 <a href="https://github.com/jantimon/html-webpack-plugin/issues/1091#issuecomment-434708455" target="_blank" rel="nofollow noreferrer noopener">issue</a></p>\n<h4 id="解决方案"><a href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>解决方案</h4>\n<p>升级到 3.0.0-beta.4 即可，对比可知源码做了以上处理</p>\n<p>3.0.0-beta.3 代码：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="99904783176939160000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`if (!hook) {\n   const HtmlWebpackPlugin = require(\'html-webpack-plugin\');\n   hook = HtmlWebpackPlugin.getHooks(compilation).beforeEmit;\n}`, `99904783176939160000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hook<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">const</span> HtmlWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'html-webpack-plugin\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   hook <span class="token operator">=</span> HtmlWebpackPlugin<span class="token punctuation">.</span><span class="token function">getHooks</span><span class="token punctuation">(</span>compilation<span class="token punctuation">)</span><span class="token punctuation">.</span>beforeEmit<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>3.0.0-beta.4 代码：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="7635305969828976000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`if (!hook) {\n   const [HtmlWebpackPlugin] = compiler.options.plugins.filter(\n      (plugin) => plugin.constructor.name === \'HtmlWebpackPlugin\'\n   );\n   assert(HtmlWebpackPlugin, \'Unable to find an instance of \' + \'HtmlWebpackPlugin in the current compilation.\');\n   hook = HtmlWebpackPlugin.constructor.getHooks(compilation).beforeEmit;\n}`, `7635305969828976000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hook<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">const</span> <span class="token punctuation">[</span>HtmlWebpackPlugin<span class="token punctuation">]</span> <span class="token operator">=</span> compiler<span class="token punctuation">.</span>options<span class="token punctuation">.</span>plugins<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>\n      <span class="token punctuation">(</span><span class="token parameter">plugin</span><span class="token punctuation">)</span> <span class="token operator">=></span> plugin<span class="token punctuation">.</span>constructor<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">\'HtmlWebpackPlugin\'</span>\n   <span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token function">assert</span><span class="token punctuation">(</span>HtmlWebpackPlugin<span class="token punctuation">,</span> <span class="token string">\'Unable to find an instance of \'</span> <span class="token operator">+</span> <span class="token string">\'HtmlWebpackPlugin in the current compilation.\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   hook <span class="token operator">=</span> <span class="token class-name">HtmlWebpackPlugin</span><span class="token punctuation">.</span>constructor<span class="token punctuation">.</span><span class="token function">getHooks</span><span class="token punctuation">(</span>compilation<span class="token punctuation">)</span><span class="token punctuation">.</span>beforeEmit<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="分包失效问题"><a href="#%E5%88%86%E5%8C%85%E5%A4%B1%E6%95%88%E9%97%AE%E9%A2%98" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>分包失效问题</h3>\n<h4 id="需求背景-6"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h4>\n<p>发现分包结果和原来的不一致，比原来大很多，比如看下面的三方库</p>\n<p>原来的</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-02-10-11-51-16-bb2ff91472970fe8fa0d538f99cab0e3-a9fd5.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 67.109375%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAAAsSAAALEgHS3X78AAACzElEQVQozyWS3U/TYBjF+9fpFcEbidyYkHihRi4wYQZkJopOiLoZxAuixjgBIcBwDANMPgZzMka3dd3Wteu6dt9rN9rStesnq+8kOTl5b05+53meF2rz7TIRrjWqgiRdyp2OIvcM/VpXmgbU0zTbttuRUGnGWV1w456X9W+fClMOdOIxxPIXxXoTeNc0ZENTDV1XFE2WdUXWgcsKcMu2iz9Xo7dv4I4H2OQoPfs8eutm4s4gRDfbZJ1jOyona62u0ZZ1QVR4QRZFRRT6EgS5Y9jMr03k3hA17Ug7xxq+FXp1kV72QpVGJZsnUtkMXiA5gQdkQ1X1rnLNt0BzVe3ZNrfrz43eLbyawB33xd2tWjhUOdiDeJHNEjkYSWbwXDKDFhma51i2Vm2Uy1y9ZqndnmH0Z0aR4rKX8W9UAv7GD+/v4UH44Qh00a7ieRzNZnIE0eBYSZKuDMPS+3wTrMo0LQuMbGcZYWmPDEQqgaRIhs9pj4tZmIOENotl0vD5eSqZJAmiWqmUaJoiSapQkESxZ1m60Q9vR+qjc1nPWml2tYzGClzkqHh8CKlCmSKwDILkMQyNxxmKUjuS1pEMcDNd72mqrvVrb582nO6zue/E2y0+thaMPhpBpsYhvlnEM2g6kcihKN9sSjwvtDgTjKpplqqCbZmGCcJp+mIjiO3+YfaxS+rwGH06RrpdEM82MTQVPzsDWBLDSBwvUQVd7lyHLU29svpkisf9+fW9UuCQDZYYWIxFm7G/kCQIoDACw9lUCkujaDJBkyQg26ZxLfNKB+Gj1sFYevQ1/uJdzRMNf8WmnbBrEpBLmRRydnqKJOLJOExTxVq5fMnzWv/O4HspiqpYVi/UDD3LTs0T772tlZOtuZ2hgdXhAcgfRtb2Y0s7kZXgKZAvFPefJH1H8MZ/gcd6CN48SX0Ibo/755/4Ps7sry0sLn558eazy/0P0amGPG/S4poAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 02 10 11 51 16" title="" data-src="/static/2023-02-10-11-51-16-bb2ff91472970fe8fa0d538f99cab0e3-fee1c.png" data-srcset="/static/2023-02-10-11-51-16-bb2ff91472970fe8fa0d538f99cab0e3-a67b7.png 200w,\n/static/2023-02-10-11-51-16-bb2ff91472970fe8fa0d538f99cab0e3-0b187.png 400w,\n/static/2023-02-10-11-51-16-bb2ff91472970fe8fa0d538f99cab0e3-fee1c.png 800w,\n/static/2023-02-10-11-51-16-bb2ff91472970fe8fa0d538f99cab0e3-b1a91.png 1200w,\n/static/2023-02-10-11-51-16-bb2ff91472970fe8fa0d538f99cab0e3-a9fd5.png 1280w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>新的</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-02-10-11-52-53-077e555bd435b9e484d8fbd5fffbda67-a9fd5.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 85.9375%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAIAAABSJhvpAAAACXBIWXMAAAsSAAALEgHS3X78AAAC/klEQVQ4y02SW4+bVhDH+ez5AH1oVGkbrZRKURsp6UMeojbVpvJmk+zaqzX3A4eDuWPAcLituRiMoYOdh0o/Hc+5zMx//oYpn6uALAtf7o+ncRimcQTG0+n/nIYBgNu+7/ZV1QbbVsetbTBFvrdW73z+43a7y2nynOdFlrZVNZ1fj8fjD6B23499P01T8fiwe/+2+HbLFEkSRzQMdnkSd01zqCqga+pT2w59d2zqY9sMh3Y4HGbgcBzpzd/+1c/xh3cMjXeOsQlcp2vaoeuPhw7ogfbQd31X11Bxji807XE4pYub4LdX8fvfGdeLdMP3gyxJ63BXxrRKs4ZeKA4J3dO0umzhPKZ1UXXZ7U30+tf04ZZ5LosoCJM4oQmID9umuRg2OzednRtO02kERmCAaKp0rV4tvYwwZRYRrEiiJAoCwdh1nK3vA67r+J7ruS7EnufpOnFs27Es23HqwJuI+d3/xHT73CRYU1SiKERVkSBgRQFknscISTyvyjLwuFwiUZQ4FhOS3H3Orq8X5E/mUHiegU19Y+m6Z9uB60bbLRA4TggSbDv03NDzbMOAK9+yYkqTxT/JLy/vzY9MHnmKwCGBlzhOV9Ut5HgepPlQaF4tyAGgNFxB8jYI6ZfPyasr2bpj2n1pEg0EAzqG6aVLDCJBPBTVkAz6n1YrVZIQTIG14u7f9M31XpaYag/mwQNZQUjDWFUUnRAAAk3TYCXwo2F2vcZQEcmw2RlWpHt0dc+UaWRuCLwALMNIkyTPsiLLMkrzecnSLAfCaEdpGidpllJWyz7JvbP4yjRlBm7PVivKRpv1G4QA85YQpGqqpqtYX7MCnMhINU3jw13w4o1tIpupy4IgBBMqMCTIOv9DWJYlnoNZWE7kRQR8u18KggQlVKwuHsOf3loE+3OycW4IVkNn7dwfOmsI6RqREYa2wNOaRyqRkLrZ6It1cvUX3Sx5pioLTZkbwveAJElkWfgkQIXIcZIorqGzIHOC9PX7A8/y6zUHnt6y8R9fMvdJ+A+6oH9QRieClwAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 02 10 11 52 53" title="" data-src="/static/2023-02-10-11-52-53-077e555bd435b9e484d8fbd5fffbda67-fee1c.png" data-srcset="/static/2023-02-10-11-52-53-077e555bd435b9e484d8fbd5fffbda67-a67b7.png 200w,\n/static/2023-02-10-11-52-53-077e555bd435b9e484d8fbd5fffbda67-0b187.png 400w,\n/static/2023-02-10-11-52-53-077e555bd435b9e484d8fbd5fffbda67-fee1c.png 800w,\n/static/2023-02-10-11-52-53-077e555bd435b9e484d8fbd5fffbda67-b1a91.png 1200w,\n/static/2023-02-10-11-52-53-077e555bd435b9e484d8fbd5fffbda67-a9fd5.png 1280w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h4 id="原因-1"><a href="#%E5%8E%9F%E5%9B%A0-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>原因</h4>\n<p>经分析 treeShaking 失效，说明 main 没有识别到 es6 的语法</p>\n<h4 id="解决方案-1"><a href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>解决方案</h4>\n<p>需要注释掉 mainFields 这一行，默认 cra 已做了 es6 语法的处理</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="95139478194227350000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// localConfig.resolve.mainFields = [\'jsnext:main\', \'main\'];`, `95139478194227350000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// localConfig.resolve.mainFields = [\'jsnext:main\', \'main\'];</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h3 id="修复-fastrefresh-在-worker-报错"><a href="#%E4%BF%AE%E5%A4%8D-fastrefresh-%E5%9C%A8-worker-%E6%8A%A5%E9%94%99" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>修复 fastRefresh 在 worker 报错</h3>\n<h4 id="需求背景-7"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h4>\n<p>如果一个文件导出函数时被前端代码和 worker 同时使用时报错</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-02-10-11-58-09-c4c17a2f8efeac97e2a34ecaa69c3245-a36d1.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 604px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 26.986754966887418%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAIAAADKYVtkAAAACXBIWXMAAAsSAAALEgHS3X78AAAA9klEQVQY0yWNyXKEIBQA/f/fSg6zqUQYXHgEcMFlxBGUaGUuMUlVV9+6OrCrX8xkWNmgvA2pjNLwQuIL+TghGmVpAvhGgUBXaj/OfrKLmVczu8d0ENhlneZF905gzqOUJsAwpAmjcabKBy5qlCoKTSF0IdvDVfeUjRntPrrvv9h5Y7eBQndFFcnziBBEUYjjECdJxnjFpGZC87IDqZt+1oPtzDJMa+CO2PrBeJ2L4hxnMaWn+H4j17fz7f1KUIrvgCi/F4qyimSCq6HsnqIZK21+z7Pzzm1TP+aF4KA4V/BZ5iBB1VzWqmrduttlP3zgt9f69fr3D+qQCTlnM4VyAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 02 10 11 58 09" title="" data-src="/static/2023-02-10-11-58-09-c4c17a2f8efeac97e2a34ecaa69c3245-a36d1.png" data-srcset="/static/2023-02-10-11-58-09-c4c17a2f8efeac97e2a34ecaa69c3245-765e7.png 200w,\n/static/2023-02-10-11-58-09-c4c17a2f8efeac97e2a34ecaa69c3245-c9f48.png 400w,\n/static/2023-02-10-11-58-09-c4c17a2f8efeac97e2a34ecaa69c3245-a36d1.png 604w" data-sizes="(max-width: 604px) 100vw, 604px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h4 id="原因-2"><a href="#%E5%8E%9F%E5%9B%A0-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>原因</h4>\n<p>在 development 模式下，如果一个文件里面的 function 同时被 worker 和前端文件使用（即被前端的 <code class="language-text">babel-loader/react-refresh</code> 处理过，此时就有了 fastRefresh 的插件代码），而 fastRefresh 里面没有针对 worker 运行环境的处理，此时会报错</p>\n<h4 id="方案"><a href="#%E6%96%B9%E6%A1%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>方案</h4>\n<p>需要对 <code class="language-text">$RefreshReg$</code> 做兼容处理，即确保只在开发环境的 worker 添加以下代码（注意这里的代码必须写成单独的文件并使用 import 放在 worker 的第一行，否则会因为执行时机的问题不起作用）</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="4028316544522803000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`global.\\$RefreshReg\\$ = () => {};\nglobal.\\$RefreshSig\\$ = () => {};`, `4028316544522803000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">global<span class="token punctuation">.</span><span class="token function-variable function">$RefreshReg$</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\nglobal<span class="token punctuation">.</span><span class="token function-variable function">$RefreshSig$</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<ol>\n<li>不对 worker 文件做 babel 处理（此方案改动较大，不现实）</li>\n<li>\n<p>在 worker-loader 前插入新的 loader，此 loader 插入以上代码，注意只在 development 环境插入一行代码</p>\n<ol>\n<li>找现成的插入代码的 loader</li>\n<li>自己写 loader</li>\n</ol>\n</li>\n</ol>\n<h3 id="懒编译"><a href="#%E6%87%92%E7%BC%96%E8%AF%91" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>懒编译</h3>\n<h4 id="需求背景-8"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h4>\n<p>目前老项目在开发模式下全量编译过慢，而有时只需要开发少数几个页面</p>\n<h4 id="选型过程"><a href="#%E9%80%89%E5%9E%8B%E8%BF%87%E7%A8%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>选型过程</h4>\n<p>因老项目使用的是 webpack4，历史代码太多不好升级，所以需要通过模仿 webpack5 的懒编译实现，有以下几个选型</p>\n<ol>\n<li><a href="https://github.com/bahmutov/web-packing" target="_blank" rel="nofollow noreferrer noopener">web-packing</a> 实现了网络请求来打包对应组件，实现思路类似懒编译，但和理想中的相差较远</li>\n<li><a href="https://github.com/sysgears/webpack-virtual-modules" target="_blank" rel="nofollow noreferrer noopener">webpack-virtual-modules</a> 实现了在内存中动态创建文件，但需要重新开始写懒编译效果</li>\n<li><a href="https://github.com/lisiyizu/vue-dynamic-module-example" target="_blank" rel="nofollow noreferrer noopener">vue-dynamic-module-example</a> 实现了在 vue 中懒编译文件，但只能在命令行中指定要编译哪些模块，不能从网络请求来决定编译哪些模块</li>\n<li><a href="https://github.com/liximomo/lazy-compile-webpack-plugin" target="_blank" rel="nofollow noreferrer noopener">lazy-compile-webpack-plugin</a> 基本实现了根据请求来编译对应页面的效果，但请求一个页面会触发多次编译，且二次请求这个页面还会触发编译</li>\n<li><a href="https://github.com/devtreehouse/lazy-build-webpack-plugin" target="_blank" rel="nofollow noreferrer noopener">lazy-build-webpack-plugin</a> 修复以上问题，但在老项目里面运行会出现循环依赖的报错</li>\n<li><a href="https://github.com/towavephone/lazy-build-webpack-plugin" target="_blank" rel="nofollow noreferrer noopener">towavephone/lazy-build-webpack-plugin</a> 修复循环依赖问题</li>\n</ol>\n<h4 id="具体实现"><a href="#%E5%85%B7%E4%BD%93%E5%AE%9E%E7%8E%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>具体实现</h4>\n<p>config-overrides.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="30808426584226200000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const LazyBuildWebpackPlugin = require(\'@towavephone/lazy-build-webpack-plugin\');\n\nconst { LAZY_BUILD } = process.env;\n\n// 默认不开启懒编译\nLAZY_BUILD &&\n   addWebpackPlugin(\n      // 以下三个和热更新有关的三方库会导致页面不停刷新，造成此原因的链接如下\n      // https://github.com/towavephone/lazy-build-webpack-plugin/blob/2a2654f8ea22b015caaef7d5bc961b851f92033d/lib/loaders/entry-loader.js#L15\n      new LazyBuildWebpackPlugin({\n         ignores: [/\\b(react-dev-utils|dev-server|react-refresh-webpack-plugin)\\b/]\n      })\n   );`, `30808426584226200000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> LazyBuildWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'@towavephone/lazy-build-webpack-plugin\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token constant">LAZY_BUILD</span> <span class="token punctuation">}</span> <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">;</span>\n\n<span class="token comment">// 默认不开启懒编译</span>\n<span class="token constant">LAZY_BUILD</span> <span class="token operator">&amp;&amp;</span>\n   <span class="token function">addWebpackPlugin</span><span class="token punctuation">(</span>\n      <span class="token comment">// 以下三个和热更新有关的三方库会导致页面不停刷新，造成此原因的链接如下</span>\n      <span class="token comment">// https://github.com/towavephone/lazy-build-webpack-plugin/blob/2a2654f8ea22b015caaef7d5bc961b851f92033d/lib/loaders/entry-loader.js#L15</span>\n      <span class="token keyword">new</span> <span class="token class-name">LazyBuildWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n         ignores<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token regex">/\\b(react-dev-utils|dev-server|react-refresh-webpack-plugin)\\b/</span><span class="token punctuation">]</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span>\n   <span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>index.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="63197962861839760000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 主入口需要加这几行代码，否则懒编译完成后页面不刷新\nif (module.hot) {\n   module.hot.accept();\n}`, `63197962861839760000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 主入口需要加这几行代码，否则懒编译完成后页面不刷新</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span>module<span class="token punctuation">.</span>hot<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   module<span class="token punctuation">.</span>hot<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="编译效果"><a href="#%E7%BC%96%E8%AF%91%E6%95%88%E6%9E%9C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>编译效果</h4>\n<ol>\n<li>懒编译开启前，即全量编译．时长在 3 分钟左右</li>\n<li>懒编译开启后，即单页面编译，随机挑选一个页面，时长在 20 秒左右</li>\n</ol>\n<h4 id="源码解析"><a href="#%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>源码解析</h4>\n<p><a href="https://github.com/towavephone/lazy-build-webpack-plugin" target="_blank" rel="nofollow noreferrer noopener">lazy-build-webpack-plugin</a></p>\n<h3 id="jenkins-编译速度优化"><a href="#jenkins-%E7%BC%96%E8%AF%91%E9%80%9F%E5%BA%A6%E4%BC%98%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>jenkins 编译速度优化</h3>\n<p><a href="/jenkins-build-speed-optimize/">原文链接</a></p>\n<h2 id="效果展示"><a href="#%E6%95%88%E6%9E%9C%E5%B1%95%E7%A4%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>效果展示</h2>\n<h3 id="生产环境"><a href="#%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>生产环境</h3>\n<p>只算前端编译过程，原来的正在用的前端编译时间 9 分钟</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-12-16-19-27-36-de2a8fcc302e0ca8073efd93a1263a1f-602dc.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 39.15426781519186%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAAsSAAALEgHS3X78AAABaUlEQVQY0yVPi46kIBD0/z9tk03ubnacUQEBFQHxMTx8g8vMdTqVTndXqiqZ9Ktmzbws13Wd3h/+PEOIwxn8fzwi+nM79njyn+V+HnEOV0iuT/lYwb+0rupq3VZtjHWWUGKtNePorC0JMdZEjdgYY9nJyEq0c/00SdWpvmeSFwRyJeWoatHmGLUEYQgZArShbSdaxUXfIYobwXxUZmogjE+vad8P6vjTEry2le/QwrK5Qip/2oigMAQuDB+i3Nos/jjmQ0j0sslhdLOLNtiqno7SQ9aXwhsvlhoPAFiKewgcLTdOTkl2kc8VWXiI5MnOUbnv1bZtWDe3ERS2givLNLmNsBCPwhIgsvsAMkPjHs7NzwSBrt7Ko3GkYVxwbXSmym9+vw/wafC/Lv9qbj/V33RCaX3/w9NbDx4apyP6FumjhyFcyeRWwtrIDNdVLzLSouF3tvWduezyfESlzHNL0MqIf9v+ZG6j7V9Mj7qUsT0QQQAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 12 16 19 27 36" title="" data-src="/static/2022-12-16-19-27-36-de2a8fcc302e0ca8073efd93a1263a1f-fee1c.png" data-srcset="/static/2022-12-16-19-27-36-de2a8fcc302e0ca8073efd93a1263a1f-a67b7.png 200w,\n/static/2022-12-16-19-27-36-de2a8fcc302e0ca8073efd93a1263a1f-0b187.png 400w,\n/static/2022-12-16-19-27-36-de2a8fcc302e0ca8073efd93a1263a1f-fee1c.png 800w,\n/static/2022-12-16-19-27-36-de2a8fcc302e0ca8073efd93a1263a1f-b1a91.png 1200w,\n/static/2022-12-16-19-27-36-de2a8fcc302e0ca8073efd93a1263a1f-602dc.png 1277w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>优化缓存过后，分 2 种情况，初次编译完全无缓存的情况下编译时间 8 分钟，第二次有缓存的情况下 3 分钟</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-12-16-19-28-35-ac103b5f8619d4f07254b7bba39ea5e1-0f56a.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 34.19047619047619%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAAsSAAALEgHS3X78AAABL0lEQVQY01WQDW+DIBCG/f8/b9lWPwoCWhCpiijyUYq7dsmSXd5c7oG7lxzFsmrCqJDD88ygfObzPN/F+dYL8xt/z/8yRHH+j8MdYhAhBrNtZjMhRvB13i96meYpPqK6333wq1lHpQowSTkba7Ux23FMi/4uy1nrbbfbvgOWdb0sWipF+ttuj55zva6DHFtKCzfNinUSozshd0pvtMHXT0Yq3iPRXVtcoearpxUldd1UrK2vzQfFF94h0aMCXpjmZRA8BJ9TYpZfthYdHUuSpqF1fWkwIBSt67Drq71FtiNRkMiLydhhXvWqQ3rAx3RuLHeKHWdZsafCTjRHjz3HXiDIjteWoeMGV6AiPhNsK5X0McD+nZcXS6AbhmkeceCVpShwGGjcy6UEdDeSRpLkD4t/hoHkVqdHAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 12 16 19 28 35" title="" data-src="/static/2022-12-16-19-28-35-ac103b5f8619d4f07254b7bba39ea5e1-fee1c.png" data-srcset="/static/2022-12-16-19-28-35-ac103b5f8619d4f07254b7bba39ea5e1-a67b7.png 200w,\n/static/2022-12-16-19-28-35-ac103b5f8619d4f07254b7bba39ea5e1-0b187.png 400w,\n/static/2022-12-16-19-28-35-ac103b5f8619d4f07254b7bba39ea5e1-fee1c.png 800w,\n/static/2022-12-16-19-28-35-ac103b5f8619d4f07254b7bba39ea5e1-0f56a.png 1050w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h3 id="开发环境"><a href="#%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>开发环境</h3>\n<p>看自己电脑配置来定，目前本人电脑上前端初次编译 5 分钟，二次编译 2 分钟（不过不建议开启缓存插件，会影响热更新速度且时间长会报错，可通过上面提到的 <code class="language-text">DISABLE_HARD_SOURCE_PLUGIN</code> 关闭）</p>\n<h2 id="后期优化"><a href="#%E5%90%8E%E6%9C%9F%E4%BC%98%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>后期优化</h2>\n<p>后期优化偏向页面加载性能方面，有以下几点可以考虑：</p>\n<ol>\n<li>页面分包优化</li>\n<li>worker.js loader 优化</li>\n<li>不必要的三方库优化</li>\n</ol>\n<h1 id="二期优化"><a href="#%E4%BA%8C%E6%9C%9F%E4%BC%98%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>二期优化</h1>\n<p>主要升级 cra + webpack5 以及对其他编译工具的调研</p>\n<h2 id="具体功能-1"><a href="#%E5%85%B7%E4%BD%93%E5%8A%9F%E8%83%BD-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>具体功能</h2>\n<h3 id="cra--webpack5"><a href="#cra--webpack5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>cra + webpack5</h3>\n<h4 id="环境变量"><a href="#%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>环境变量</h4>\n<p>.env</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="40370967073695850000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`DISABLE_ESLINT_PLUGIN=true\nGENERATE_SOURCEMAP=false\nPORT=3000\nBROWSER=none\n\n# LAZY_BUILD=true\n# DISABLE_CACHE=true\n# DEBUG_CACHE=true`, `40370967073695850000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token assign-left variable">DISABLE_ESLINT_PLUGIN</span><span class="token operator">=</span>true\n<span class="token assign-left variable">GENERATE_SOURCEMAP</span><span class="token operator">=</span>false\n<span class="token assign-left variable">PORT</span><span class="token operator">=</span><span class="token number">3000</span>\n<span class="token assign-left variable">BROWSER</span><span class="token operator">=</span>none\n\n<span class="token comment"># LAZY_BUILD=true</span>\n<span class="token comment"># DISABLE_CACHE=true</span>\n<span class="token comment"># DEBUG_CACHE=true</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>.env.production</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="72228025793726005000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`DISABLE_ESLINT_PLUGIN=true\nGENERATE_SOURCEMAP=false\n\n# DISABLE_CACHE=true\nDEBUG_CACHE=true\n# BUNDLE_ANALYZER=true`, `72228025793726005000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token assign-left variable">DISABLE_ESLINT_PLUGIN</span><span class="token operator">=</span>true\n<span class="token assign-left variable">GENERATE_SOURCEMAP</span><span class="token operator">=</span>false\n\n<span class="token comment"># DISABLE_CACHE=true</span>\n<span class="token assign-left variable">DEBUG_CACHE</span><span class="token operator">=</span>true\n<span class="token comment"># BUNDLE_ANALYZER=true</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="核心配置"><a href="#%E6%A0%B8%E5%BF%83%E9%85%8D%E7%BD%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>核心配置</h4>\n<p>config-overrides.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="97845849649970140000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const {\n   override,\n   addBabelPlugins,\n   fixBabelImports,\n   addLessLoader,\n   removeModuleScopePlugin,\n   setWebpackOptimizationSplitChunks,\n   addWebpackPlugin,\n   addWebpackAlias,\n   adjustStyleLoaders\n} = require(\'customize-cra\');\nconst fs = require(\'fs\');\nconst webpack = require(\'webpack\');\nconst PreloadWebpackPlugin = require(\'preload-webpack-plugin\');\nconst path = require(\'path\');\nconst MonacoWebpackPlugin = require(\'monaco-editor-webpack-plugin\');\nconst WebpackBarPlugin = require(\'webpackbar\');\nconst { get, pick } = require(\'lodash\');\nconst threadLoader = require(\'thread-loader\');\nconst BundleAnalyzerPlugin = require(\'webpack-bundle-analyzer\').BundleAnalyzerPlugin;\n\nconst { LAZY_BUILD, DISABLE_CACHE, DEBUG_CACHE, BUNDLE_ANALYZER } = process.env;\n\nthreadLoader.warmup(\n   {\n      // pool options, like passed to loader options\n      // must match loader options to boot the correct pool\n   },\n   [\n      // modules to load\n      // can be any module, i. e.\n      \'babel-loader\'\n   ]\n);\n\nconst craDir = path.join(process.cwd() + \'/.cra\');\n\nif (!fs.existsSync(craDir)) {\n   fs.mkdirSync(craDir);\n}\n\nconst addBeforeLoaders = (webpackConfig, matchLoader, newLoader = []) => {\n   const matchLoaders = get(webpackConfig, \'module.rules.0.oneOf\', []).filter((item) =>\n      get(item, \'loader\', \'\').includes(matchLoader)\n   );\n   if (matchLoaders.length > 0) {\n      matchLoaders.forEach((item) => {\n         const props = [\'loader\', \'options\'];\n         item.use = [...newLoader, pick(item, props)];\n         props.forEach((item2) => {\n            delete item[item2];\n         });\n      });\n   }\n};\n\nconst formatConfig = (config) =>\n   JSON.stringify(\n      config,\n      (key, value) => {\n         if (typeof value === \'function\') {\n            return value.toString();\n         }\n         return value;\n      },\n      2\n   );\n\nmodule.exports = {\n   webpack: (config, env) => {\n      const isProd = env === \'production\';\n\n      const localConfig = override(\n         addBabelPlugins(\n            [\'@babel/plugin-proposal-nullish-coalescing-operator\'],\n            [\'@babel/plugin-syntax-optional-chaining\']\n         ),\n         fixBabelImports(\'import\', {\n            libraryName: \'antd\',\n            libraryDirectory: \'es\',\n            style: true\n         }),\n         addLessLoader({\n            lessOptions: { javascriptEnabled: true }\n         }),\n         // 适配 cra 下 less-loader 的兼容性问题\n         adjustStyleLoaders(({ use: [, , postcss] }) => {\n            const postcssOptions = postcss.options;\n            postcss.options = { postcssOptions };\n         }),\n         addWebpackAlias({\n            \'@\': path.resolve(__dirname, \'src\')\n         }),\n         removeModuleScopePlugin(),\n         isProd &&\n            setWebpackOptimizationSplitChunks({\n               cacheGroups: {\n                  vendors: {\n                     minChunks: 2,\n                     test: /[\\\\/]node_modules[\\\\/]\\.pnpm[\\\\/](?!google-protobuf|@antv|highcharts|mathjs|two\\.js|konva|victory-core)/,\n                     priority: -10,\n                     reuseExistingChunk: true,\n                     name: \'vendors\'\n                  },\n                  default: {\n                     minChunks: 2,\n                     priority: -20,\n                     reuseExistingChunk: true\n                  }\n               }\n            }),\n         isProd &&\n            addWebpackPlugin(\n               new PreloadWebpackPlugin({\n                  rel: \'prefetch\',\n                  as: \'script\',\n                  fileBlacklist: [\n                     /\\d{1,2}\\.(\\d?[a-z]?)+\\.chunk\\.js\\$/,\n                     /main\\..+\\.js\\$/,\n                     /\\.css\\$/,\n                     /\\.txt\\$/,\n                     /\\.png\\$/,\n                     /.jpeg\\$/,\n                     /.cjs\\$/,\n                     /.svg\\$/,\n                     /.ttf\\$/\n                  ],\n                  include: \'allAssets\'\n               })\n            ),\n         addWebpackPlugin(\n            new MonacoWebpackPlugin({\n               languages: [\'json\']\n            })\n         ),\n         addWebpackPlugin(\n            new webpack.DefinePlugin({\n               \'process.env.BUILD_TOOL\': &quot;\'webpack\'&quot;\n            })\n         ),\n         // 处理 buffer 缺失问题，因为 webpack5 现在默认不导入 nodejs 相关库，需要自行导入\n         addWebpackPlugin(\n            new webpack.ProvidePlugin({\n               Buffer: [\'buffer\', \'Buffer\']\n            })\n         ),\n         BUNDLE_ANALYZER &&\n            addWebpackPlugin(\n               new BundleAnalyzerPlugin({\n                  analyzerPort: 8080,\n                  generateStatsFile: true\n               })\n            ),\n         addWebpackPlugin(new WebpackBarPlugin())\n      )(config);\n\n      addBeforeLoaders(localConfig, \'babel-loader\', [\'thread-loader\']);\n\n      localConfig.resolve.extensions = [\'.js\'];\n      localConfig.resolve.modules = [\'node_modules\'];\n      // 兼容处理\n      localConfig.resolve.fallback = {\n         buffer: require.resolve(\'buffer\')\n      };\n\n      // 懒编译功能，默认关闭\n      if (LAZY_BUILD) {\n         localConfig.experiments = {\n            lazyCompilation: {\n               // disable lazy compilation for dynamic imports\n               imports: true,\n\n               // disable lazy compilation for entries\n               entries: false\n\n               // do not lazily compile moduleB\n               // test: module => !/moduleB/.test(module.nameForCondition())\n            }\n         };\n      } // 开启缓存调试日志，默认关闭，配合环境变量使用\n\n      if (DEBUG_CACHE) {\n         localConfig.infrastructureLogging = {\n            debug: /webpack\\.cache/\n         };\n      } // 是否关闭缓存，默认开启\n\n      if (DISABLE_CACHE) {\n         localConfig.cache = false;\n      }\n\n      if (!isProd) {\n         localConfig.stats = {\n            errors: true,\n            children: false,\n            warnings: false,\n            colors: true,\n            assets: false,\n            modules: false,\n            entrypoints: false,\n            timings: true,\n            builtAt: true,\n            hash: true\n         };\n      } else {\n         const instanceOfMiniCssExtractPlugin = localConfig.plugins.find(\n            (plugin) => plugin.constructor.name === \'MiniCssExtractPlugin\'\n         );\n\n         // 忽略样式导入顺序报错\n         // https://github.com/facebook/create-react-app/issues/5372\n         if (instanceOfMiniCssExtractPlugin) {\n            instanceOfMiniCssExtractPlugin.options.ignoreOrder = true;\n         }\n      }\n\n      fs.writeFileSync(path.join(craDir, \\`webpack.\\${env}.json\\`), formatConfig(localConfig));\n\n      return localConfig;\n   },\n   devServer: (configFunction) => (proxy, allowedHost) => {\n      const config = configFunction(proxy, allowedHost);\n\n      config.allowedHosts = \'all\';\n\n      fs.writeFileSync(path.join(craDir, \'webpack-dev-server.json\'), formatConfig(config));\n\n      return config;\n   }\n};`, `97845849649970140000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> <span class="token punctuation">{</span>\n   override<span class="token punctuation">,</span>\n   addBabelPlugins<span class="token punctuation">,</span>\n   fixBabelImports<span class="token punctuation">,</span>\n   addLessLoader<span class="token punctuation">,</span>\n   removeModuleScopePlugin<span class="token punctuation">,</span>\n   setWebpackOptimizationSplitChunks<span class="token punctuation">,</span>\n   addWebpackPlugin<span class="token punctuation">,</span>\n   addWebpackAlias<span class="token punctuation">,</span>\n   adjustStyleLoaders\n<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'customize-cra\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'fs\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> webpack <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'webpack\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> PreloadWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'preload-webpack-plugin\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'path\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> MonacoWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'monaco-editor-webpack-plugin\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> WebpackBarPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'webpackbar\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">,</span> pick <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'lodash\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> threadLoader <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'thread-loader\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> BundleAnalyzerPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'webpack-bundle-analyzer\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>BundleAnalyzerPlugin<span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token constant">LAZY_BUILD</span><span class="token punctuation">,</span> <span class="token constant">DISABLE_CACHE</span><span class="token punctuation">,</span> <span class="token constant">DEBUG_CACHE</span><span class="token punctuation">,</span> <span class="token constant">BUNDLE_ANALYZER</span> <span class="token punctuation">}</span> <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">;</span>\n\nthreadLoader<span class="token punctuation">.</span><span class="token function">warmup</span><span class="token punctuation">(</span>\n   <span class="token punctuation">{</span>\n      <span class="token comment">// pool options, like passed to loader options</span>\n      <span class="token comment">// must match loader options to boot the correct pool</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span>\n   <span class="token punctuation">[</span>\n      <span class="token comment">// modules to load</span>\n      <span class="token comment">// can be any module, i. e.</span>\n      <span class="token string">\'babel-loader\'</span>\n   <span class="token punctuation">]</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> craDir <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">\'/.cra\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>craDir<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   fs<span class="token punctuation">.</span><span class="token function">mkdirSync</span><span class="token punctuation">(</span>craDir<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">addBeforeLoaders</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">webpackConfig<span class="token punctuation">,</span> matchLoader<span class="token punctuation">,</span> newLoader <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   <span class="token keyword">const</span> matchLoaders <span class="token operator">=</span> <span class="token keyword">get</span><span class="token punctuation">(</span>webpackConfig<span class="token punctuation">,</span> <span class="token string">\'module.rules.0.oneOf\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span>\n      <span class="token keyword">get</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token string">\'loader\'</span><span class="token punctuation">,</span> <span class="token string">\'\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>matchLoader<span class="token punctuation">)</span>\n   <span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>matchLoaders<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      matchLoaders<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n         <span class="token keyword">const</span> props <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'loader\'</span><span class="token punctuation">,</span> <span class="token string">\'options\'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n         item<span class="token punctuation">.</span>use <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span>newLoader<span class="token punctuation">,</span> <span class="token function">pick</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> props<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n         props<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item2</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            <span class="token keyword">delete</span> item<span class="token punctuation">[</span>item2<span class="token punctuation">]</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">formatConfig</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span> <span class="token operator">=></span>\n   <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>\n      config<span class="token punctuation">,</span>\n      <span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> value <span class="token operator">===</span> <span class="token string">\'function\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">return</span> value<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span>\n         <span class="token keyword">return</span> value<span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      <span class="token number">2</span>\n   <span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nmodule<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>\n   <span class="token function-variable function">webpack</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">config<span class="token punctuation">,</span> env</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> isProd <span class="token operator">=</span> env <span class="token operator">===</span> <span class="token string">\'production\'</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">const</span> localConfig <span class="token operator">=</span> <span class="token function">override</span><span class="token punctuation">(</span>\n         <span class="token function">addBabelPlugins</span><span class="token punctuation">(</span>\n            <span class="token punctuation">[</span><span class="token string">\'@babel/plugin-proposal-nullish-coalescing-operator\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n            <span class="token punctuation">[</span><span class="token string">\'@babel/plugin-syntax-optional-chaining\'</span><span class="token punctuation">]</span>\n         <span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token function">fixBabelImports</span><span class="token punctuation">(</span><span class="token string">\'import\'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>\n            libraryName<span class="token punctuation">:</span> <span class="token string">\'antd\'</span><span class="token punctuation">,</span>\n            libraryDirectory<span class="token punctuation">:</span> <span class="token string">\'es\'</span><span class="token punctuation">,</span>\n            style<span class="token punctuation">:</span> <span class="token boolean">true</span>\n         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token function">addLessLoader</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n            lessOptions<span class="token punctuation">:</span> <span class="token punctuation">{</span> javascriptEnabled<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span>\n         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token comment">// 适配 cra 下 less-loader 的兼容性问题</span>\n         <span class="token function">adjustStyleLoaders</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> use<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">,</span> <span class="token punctuation">,</span> postcss<span class="token punctuation">]</span> <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            <span class="token keyword">const</span> postcssOptions <span class="token operator">=</span> postcss<span class="token punctuation">.</span>options<span class="token punctuation">;</span>\n            postcss<span class="token punctuation">.</span>options <span class="token operator">=</span> <span class="token punctuation">{</span> postcssOptions <span class="token punctuation">}</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token function">addWebpackAlias</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n            <span class="token string">\'@\'</span><span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">\'src\'</span><span class="token punctuation">)</span>\n         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token function">removeModuleScopePlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n         isProd <span class="token operator">&amp;&amp;</span>\n            <span class="token function">setWebpackOptimizationSplitChunks</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n               cacheGroups<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n                  vendors<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n                     minChunks<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>\n                     test<span class="token punctuation">:</span> <span class="token regex">/[\\\\/]node_modules[\\\\/]\\.pnpm[\\\\/](?!google-protobuf|@antv|highcharts|mathjs|two\\.js|konva|victory-core)/</span><span class="token punctuation">,</span>\n                     priority<span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">,</span>\n                     reuseExistingChunk<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n                     name<span class="token punctuation">:</span> <span class="token string">\'vendors\'</span>\n                  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n                  <span class="token keyword">default</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>\n                     minChunks<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>\n                     priority<span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">20</span><span class="token punctuation">,</span>\n                     reuseExistingChunk<span class="token punctuation">:</span> <span class="token boolean">true</span>\n                  <span class="token punctuation">}</span>\n               <span class="token punctuation">}</span>\n            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n         isProd <span class="token operator">&amp;&amp;</span>\n            <span class="token function">addWebpackPlugin</span><span class="token punctuation">(</span>\n               <span class="token keyword">new</span> <span class="token class-name">PreloadWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n                  rel<span class="token punctuation">:</span> <span class="token string">\'prefetch\'</span><span class="token punctuation">,</span>\n                  <span class="token keyword">as</span><span class="token punctuation">:</span> <span class="token string">\'script\'</span><span class="token punctuation">,</span>\n                  fileBlacklist<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n                     <span class="token regex">/\\d{1,2}\\.(\\d?[a-z]?)+\\.chunk\\.js$/</span><span class="token punctuation">,</span>\n                     <span class="token regex">/main\\..+\\.js$/</span><span class="token punctuation">,</span>\n                     <span class="token regex">/\\.css$/</span><span class="token punctuation">,</span>\n                     <span class="token regex">/\\.txt$/</span><span class="token punctuation">,</span>\n                     <span class="token regex">/\\.png$/</span><span class="token punctuation">,</span>\n                     <span class="token regex">/.jpeg$/</span><span class="token punctuation">,</span>\n                     <span class="token regex">/.cjs$/</span><span class="token punctuation">,</span>\n                     <span class="token regex">/.svg$/</span><span class="token punctuation">,</span>\n                     <span class="token regex">/.ttf$/</span>\n                  <span class="token punctuation">]</span><span class="token punctuation">,</span>\n                  include<span class="token punctuation">:</span> <span class="token string">\'allAssets\'</span>\n               <span class="token punctuation">}</span><span class="token punctuation">)</span>\n            <span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token function">addWebpackPlugin</span><span class="token punctuation">(</span>\n            <span class="token keyword">new</span> <span class="token class-name">MonacoWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n               languages<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'json\'</span><span class="token punctuation">]</span>\n            <span class="token punctuation">}</span><span class="token punctuation">)</span>\n         <span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token function">addWebpackPlugin</span><span class="token punctuation">(</span>\n            <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>DefinePlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n               <span class="token string">\'process.env.BUILD_TOOL\'</span><span class="token punctuation">:</span> <span class="token string">"\'webpack\'"</span>\n            <span class="token punctuation">}</span><span class="token punctuation">)</span>\n         <span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token comment">// 处理 buffer 缺失问题，因为 webpack5 现在默认不导入 nodejs 相关库，需要自行导入</span>\n         <span class="token function">addWebpackPlugin</span><span class="token punctuation">(</span>\n            <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>ProvidePlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n               Buffer<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'buffer\'</span><span class="token punctuation">,</span> <span class="token string">\'Buffer\'</span><span class="token punctuation">]</span>\n            <span class="token punctuation">}</span><span class="token punctuation">)</span>\n         <span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token constant">BUNDLE_ANALYZER</span> <span class="token operator">&amp;&amp;</span>\n            <span class="token function">addWebpackPlugin</span><span class="token punctuation">(</span>\n               <span class="token keyword">new</span> <span class="token class-name">BundleAnalyzerPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n                  analyzerPort<span class="token punctuation">:</span> <span class="token number">8080</span><span class="token punctuation">,</span>\n                  generateStatsFile<span class="token punctuation">:</span> <span class="token boolean">true</span>\n               <span class="token punctuation">}</span><span class="token punctuation">)</span>\n            <span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token function">addWebpackPlugin</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WebpackBarPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n      <span class="token punctuation">)</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token function">addBeforeLoaders</span><span class="token punctuation">(</span>localConfig<span class="token punctuation">,</span> <span class="token string">\'babel-loader\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">\'thread-loader\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      localConfig<span class="token punctuation">.</span>resolve<span class="token punctuation">.</span>extensions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'.js\'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n      localConfig<span class="token punctuation">.</span>resolve<span class="token punctuation">.</span>modules <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'node_modules\'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token comment">// 兼容处理</span>\n      localConfig<span class="token punctuation">.</span>resolve<span class="token punctuation">.</span>fallback <span class="token operator">=</span> <span class="token punctuation">{</span>\n         buffer<span class="token punctuation">:</span> require<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">\'buffer\'</span><span class="token punctuation">)</span>\n      <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n      <span class="token comment">// 懒编译功能，默认关闭</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">LAZY_BUILD</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         localConfig<span class="token punctuation">.</span>experiments <span class="token operator">=</span> <span class="token punctuation">{</span>\n            lazyCompilation<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n               <span class="token comment">// disable lazy compilation for dynamic imports</span>\n               imports<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n\n               <span class="token comment">// disable lazy compilation for entries</span>\n               entries<span class="token punctuation">:</span> <span class="token boolean">false</span>\n\n               <span class="token comment">// do not lazily compile moduleB</span>\n               <span class="token comment">// test: module => !/moduleB/.test(module.nameForCondition())</span>\n            <span class="token punctuation">}</span>\n         <span class="token punctuation">}</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span> <span class="token comment">// 开启缓存调试日志，默认关闭，配合环境变量使用</span>\n\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_CACHE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         localConfig<span class="token punctuation">.</span>infrastructureLogging <span class="token operator">=</span> <span class="token punctuation">{</span>\n            debug<span class="token punctuation">:</span> <span class="token regex">/webpack\\.cache/</span>\n         <span class="token punctuation">}</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span> <span class="token comment">// 是否关闭缓存，默认开启</span>\n\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DISABLE_CACHE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         localConfig<span class="token punctuation">.</span>cache <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isProd<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         localConfig<span class="token punctuation">.</span>stats <span class="token operator">=</span> <span class="token punctuation">{</span>\n            errors<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n            children<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n            warnings<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n            colors<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n            assets<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n            modules<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n            entrypoints<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n            timings<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n            builtAt<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n            hash<span class="token punctuation">:</span> <span class="token boolean">true</span>\n         <span class="token punctuation">}</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n         <span class="token keyword">const</span> instanceOfMiniCssExtractPlugin <span class="token operator">=</span> localConfig<span class="token punctuation">.</span>plugins<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>\n            <span class="token punctuation">(</span><span class="token parameter">plugin</span><span class="token punctuation">)</span> <span class="token operator">=></span> plugin<span class="token punctuation">.</span>constructor<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">\'MiniCssExtractPlugin\'</span>\n         <span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n         <span class="token comment">// 忽略样式导入顺序报错</span>\n         <span class="token comment">// https://github.com/facebook/create-react-app/issues/5372</span>\n         <span class="token keyword">if</span> <span class="token punctuation">(</span>instanceOfMiniCssExtractPlugin<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            instanceOfMiniCssExtractPlugin<span class="token punctuation">.</span>options<span class="token punctuation">.</span>ignoreOrder <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n\n      fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>craDir<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">webpack.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>env<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.json</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">formatConfig</span><span class="token punctuation">(</span>localConfig<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">return</span> localConfig<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span>\n   <span class="token function-variable function">devServer</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">configFunction</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token parameter">proxy<span class="token punctuation">,</span> allowedHost</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">configFunction</span><span class="token punctuation">(</span>proxy<span class="token punctuation">,</span> allowedHost<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      config<span class="token punctuation">.</span>allowedHosts <span class="token operator">=</span> <span class="token string">\'all\'</span><span class="token punctuation">;</span>\n\n      fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>craDir<span class="token punctuation">,</span> <span class="token string">\'webpack-dev-server.json\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">formatConfig</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">return</span> config<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>package.json 只显示增加部分</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="25990259702269624000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`{\n   &quot;dependencies&quot;: {\n      &quot;html-webpack-plugin&quot;: &quot;^5.5.0&quot;,\n      &quot;less-loader&quot;: &quot;^11.1.0&quot;,\n      &quot;react-scripts&quot;: &quot;npm:@towavephone/react-scripts@^5.0.3&quot;,\n      &quot;webpack&quot;: &quot;5.78.0&quot;,\n      &quot;webpack-bundle-analyzer&quot;: &quot;^4.7.0&quot;,\n      &quot;webpack-dev-server&quot;: &quot;4.13.2&quot;,\n      &quot;buffer&quot;: &quot;^6.0.3&quot;\n   }\n}`, `25990259702269624000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="json"\n              >\n                <span class="gatsby-code-button-language">json</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="json"><pre style="counter-reset: linenumber NaN" class="language-json line-numbers"><code class="language-json"><span class="token punctuation">{</span>\n   <span class="token property">"dependencies"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n      <span class="token property">"html-webpack-plugin"</span><span class="token operator">:</span> <span class="token string">"^5.5.0"</span><span class="token punctuation">,</span>\n      <span class="token property">"less-loader"</span><span class="token operator">:</span> <span class="token string">"^11.1.0"</span><span class="token punctuation">,</span>\n      <span class="token property">"react-scripts"</span><span class="token operator">:</span> <span class="token string">"npm:@towavephone/react-scripts@^5.0.3"</span><span class="token punctuation">,</span>\n      <span class="token property">"webpack"</span><span class="token operator">:</span> <span class="token string">"5.78.0"</span><span class="token punctuation">,</span>\n      <span class="token property">"webpack-bundle-analyzer"</span><span class="token operator">:</span> <span class="token string">"^4.7.0"</span><span class="token punctuation">,</span>\n      <span class="token property">"webpack-dev-server"</span><span class="token operator">:</span> <span class="token string">"4.13.2"</span><span class="token punctuation">,</span>\n      <span class="token property">"buffer"</span><span class="token operator">:</span> <span class="token string">"^6.0.3"</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="worker-loader-的兼容处理"><a href="#worker-loader-%E7%9A%84%E5%85%BC%E5%AE%B9%E5%A4%84%E7%90%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>worker-loader 的兼容处理</h4>\n<p>去掉 worker-loader，使用 <code class="language-text">new Worker(new URL(&#39;worker文件路径&#39;, import.meta.url))</code> 代替</p>\n<h4 id="修复-react-scripts-生产环境缓存"><a href="#%E4%BF%AE%E5%A4%8D-react-scripts-%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E7%BC%93%E5%AD%98" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>修复 react-scripts 生产环境缓存</h4>\n<p><a href="https://github.com/yicheny/create-react-app/compare/main...towavephone:create-react-app:main" target="_blank" rel="nofollow noreferrer noopener">仓库地址</a></p>\n<p>生产环境下 cra 不能正常生成文件缓存，原因是没有调用 webpack5 的 <code class="language-text">compiler.close</code>，同时需要注意 close 之后需要正常终止</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="98762617086962370000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`compiler.close((err) => {\n   if (err && err.message) {\n      console.log(err.message);\n      process.exit(1);\n   }\n\n   process.exit(0);\n});`, `98762617086962370000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">compiler<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">&amp;&amp;</span> err<span class="token punctuation">.</span>message<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="运行模板"><a href="#%E8%BF%90%E8%A1%8C%E6%A8%A1%E6%9D%BF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>运行模板</h4>\n<p><a href="https://github.com/towavephone/GatsbyBlog/tree/master/template/cra-js-template" target="_blank" rel="nofollow noreferrer noopener">仓库地址</a></p>\n<h4 id="优缺点"><a href="#%E4%BC%98%E7%BC%BA%E7%82%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>优缺点</h4>\n<p>相比于一期优化的本地和生产模式编译时间都为 2~3 分钟，优缺点如下</p>\n<ul>\n<li>优点：二次编译速度快，开发模式在 18 秒左右，生产模式在 40 秒左右</li>\n<li>缺点：首次编译速度慢，需要 3~4 分钟</li>\n</ul>\n<h3 id="rspack"><a href="#rspack" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>rspack</h3>\n<h4 id="核心配置-1"><a href="#%E6%A0%B8%E5%BF%83%E9%85%8D%E7%BD%AE-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>核心配置</h4>\n<p>rspack.config.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="39466480512984850000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const path = require(\'path\');\nconst { defineConfig } = require(\'@rspack/cli\');\nconst fs = require(\'fs\');\n// const MonacoWebpackPlugin = require(\'monaco-editor-webpack-plugin\')\n// const NodePolyfill = require(\'@rspack/plugin-node-polyfill\')\n\nconst appDirectory = fs.realpathSync(process.cwd());\nconst resolveApp = (relativePath) => path.resolve(appDirectory, relativePath);\n\nconst dotenv = resolveApp(\'.env\');\n\nconst NODE_ENV = process.env.NODE_ENV;\n// https://github.com/bkeepers/dotenv#what-other-env-files-can-i-use\nconst dotenvFiles = [\n   \\`\\${dotenv}.\\${NODE_ENV}.local\\`,\n   // Don\'t include \\`.env.local\\` for \\`test\\` environment\n   // since normally you expect tests to produce the same\n   // results for everyone\n   NODE_ENV !== \'test\' && \\`\\${dotenv}.local\\`,\n   \\`\\${dotenv}.\\${NODE_ENV}\\`,\n   dotenv\n].filter(Boolean);\n\n// Load environment variables from .env* files. Suppress warnings using silent\n// if this file is missing. dotenv will never modify any environment variables\n// that have already been set.  Variable expansion is supported in .env files.\n// https://github.com/motdotla/dotenv\n// https://github.com/motdotla/dotenv-expand\ndotenvFiles.forEach((dotenvFile) => {\n   if (fs.existsSync(dotenvFile)) {\n      require(\'dotenv-expand\')(\n         require(\'dotenv\').config({\n            path: dotenvFile\n         })\n      );\n   }\n});\n\nconst { DISABLE_OVERLAY } = process.env;\n\nmodule.exports = defineConfig({\n   mode: \'development\',\n   entry: {\n      main: \'./src/index.js\'\n   },\n   builtins: {\n      html: [\n         {\n            template: \'./public/index.html\'\n         }\n      ],\n      pluginImport: [\n         {\n            libraryName: \'antd\',\n            libraryDirectory: \'es\',\n            style: true\n         }\n      ],\n      define: {\n         // \'process.env.NODE_ENV\': &quot;\'development\'&quot;,\n         \'import.meta.env\': &quot;\'development\'&quot;,\n         \'import.meta.env.MODE\': &quot;\'development\'&quot;,\n         \'process.env.NODE_DEBUG\': false,\n         \'process.env.BUILD_TOOL\': &quot;\'rspack\'&quot;\n      }\n   },\n   module: {\n      rules: [\n         {\n            test: /\\.js\\$/,\n            include: /src/,\n            type: \'jsx\'\n         },\n         {\n            test: /\\.less\\$/,\n            exclude: /node_modules/,\n            use: [\n               {\n                  loader: \'less-loader\',\n                  options: {\n                     lessOptions: { javascriptEnabled: true }\n                  }\n               }\n            ],\n            type: \'css/module\'\n         },\n         {\n            test: /\\.less\\$/,\n            include: /node_modules/,\n            use: [\n               {\n                  loader: \'less-loader\',\n                  options: {\n                     lessOptions: { javascriptEnabled: true }\n                  }\n               }\n            ],\n            type: \'css\'\n         },\n         // {\n         //   test: /\\.css\\$/,\n         //   type: \'css\'\n         // },\n         {\n            test: /\\.(png|svg|jpg|jpeg|ttf)\\$/,\n            type: \'asset\'\n         }\n      ]\n   },\n   resolve: {\n      alias: {\n         \'@\': path.resolve(__dirname, \'./src\'),\n         \'antd/es/theme\': false // 修复因 @ant-design/pro-components 导致的编译报错问题\n      },\n      extensions: [\'.js\'],\n      mainFields: [\'main\', \'browser\', \'module\']\n   },\n   // plugins: [\n   //   new MonacoWebpackPlugin({\n   //     languages: [\'json\']\n   //   })\n   //   // new NodePolyfill()\n   // ],\n   devServer: {\n      port: 3000,\n      allowedHosts: \'all\',\n      client: {\n         overlay: !DISABLE_OVERLAY\n      }\n   },\n   devtool: \'source-map\',\n   snapshot: {\n      resolve: {\n         hash: true,\n         timestamp: false\n      },\n      module: {\n         hash: true,\n         timestamp: false\n      }\n   },\n   stats: {\n      preset: \'errors-only\',\n      reasons: true,\n      hash: true,\n      builtAt: true,\n      timings: true\n   },\n   experiments: {\n      incrementalRebuild: true\n   }\n});`, `39466480512984850000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'path\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> <span class="token punctuation">{</span> defineConfig <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'@rspack/cli\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'fs\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// const MonacoWebpackPlugin = require(\'monaco-editor-webpack-plugin\')</span>\n<span class="token comment">// const NodePolyfill = require(\'@rspack/plugin-node-polyfill\')</span>\n\n<span class="token keyword">const</span> appDirectory <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">realpathSync</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> <span class="token function-variable function">resolveApp</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">relativePath</span><span class="token punctuation">)</span> <span class="token operator">=></span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>appDirectory<span class="token punctuation">,</span> relativePath<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> dotenv <span class="token operator">=</span> <span class="token function">resolveApp</span><span class="token punctuation">(</span><span class="token string">\'.env\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token constant">NODE_ENV</span> <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span><span class="token punctuation">;</span>\n<span class="token comment">// https://github.com/bkeepers/dotenv#what-other-env-files-can-i-use</span>\n<span class="token keyword">const</span> dotenvFiles <span class="token operator">=</span> <span class="token punctuation">[</span>\n   <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>dotenv<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">NODE_ENV</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.local</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n   <span class="token comment">// Don\'t include `.env.local` for `test` environment</span>\n   <span class="token comment">// since normally you expect tests to produce the same</span>\n   <span class="token comment">// results for everyone</span>\n   <span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">\'test\'</span> <span class="token operator">&amp;&amp;</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>dotenv<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.local</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n   <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>dotenv<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">NODE_ENV</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n   dotenv\n<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>Boolean<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// Load environment variables from .env* files. Suppress warnings using silent</span>\n<span class="token comment">// if this file is missing. dotenv will never modify any environment variables</span>\n<span class="token comment">// that have already been set.  Variable expansion is supported in .env files.</span>\n<span class="token comment">// https://github.com/motdotla/dotenv</span>\n<span class="token comment">// https://github.com/motdotla/dotenv-expand</span>\ndotenvFiles<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">dotenvFile</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>dotenvFile<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'dotenv-expand\'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>\n         <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'dotenv\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n            path<span class="token punctuation">:</span> dotenvFile\n         <span class="token punctuation">}</span><span class="token punctuation">)</span>\n      <span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token constant">DISABLE_OVERLAY</span> <span class="token punctuation">}</span> <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">;</span>\n\nmodule<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">defineConfig</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n   mode<span class="token punctuation">:</span> <span class="token string">\'development\'</span><span class="token punctuation">,</span>\n   entry<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n      main<span class="token punctuation">:</span> <span class="token string">\'./src/index.js\'</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span>\n   builtins<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n      html<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n         <span class="token punctuation">{</span>\n            template<span class="token punctuation">:</span> <span class="token string">\'./public/index.html\'</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">]</span><span class="token punctuation">,</span>\n      pluginImport<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n         <span class="token punctuation">{</span>\n            libraryName<span class="token punctuation">:</span> <span class="token string">\'antd\'</span><span class="token punctuation">,</span>\n            libraryDirectory<span class="token punctuation">:</span> <span class="token string">\'es\'</span><span class="token punctuation">,</span>\n            style<span class="token punctuation">:</span> <span class="token boolean">true</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">]</span><span class="token punctuation">,</span>\n      define<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n         <span class="token comment">// \'process.env.NODE_ENV\': "\'development\'",</span>\n         <span class="token string">\'import.meta.env\'</span><span class="token punctuation">:</span> <span class="token string">"\'development\'"</span><span class="token punctuation">,</span>\n         <span class="token string">\'import.meta.env.MODE\'</span><span class="token punctuation">:</span> <span class="token string">"\'development\'"</span><span class="token punctuation">,</span>\n         <span class="token string">\'process.env.NODE_DEBUG\'</span><span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n         <span class="token string">\'process.env.BUILD_TOOL\'</span><span class="token punctuation">:</span> <span class="token string">"\'rspack\'"</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span>\n   module<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n      rules<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n         <span class="token punctuation">{</span>\n            test<span class="token punctuation">:</span> <span class="token regex">/\\.js$/</span><span class="token punctuation">,</span>\n            include<span class="token punctuation">:</span> <span class="token regex">/src/</span><span class="token punctuation">,</span>\n            type<span class="token punctuation">:</span> <span class="token string">\'jsx\'</span>\n         <span class="token punctuation">}</span><span class="token punctuation">,</span>\n         <span class="token punctuation">{</span>\n            test<span class="token punctuation">:</span> <span class="token regex">/\\.less$/</span><span class="token punctuation">,</span>\n            exclude<span class="token punctuation">:</span> <span class="token regex">/node_modules/</span><span class="token punctuation">,</span>\n            use<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n               <span class="token punctuation">{</span>\n                  loader<span class="token punctuation">:</span> <span class="token string">\'less-loader\'</span><span class="token punctuation">,</span>\n                  options<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n                     lessOptions<span class="token punctuation">:</span> <span class="token punctuation">{</span> javascriptEnabled<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span>\n                  <span class="token punctuation">}</span>\n               <span class="token punctuation">}</span>\n            <span class="token punctuation">]</span><span class="token punctuation">,</span>\n            type<span class="token punctuation">:</span> <span class="token string">\'css/module\'</span>\n         <span class="token punctuation">}</span><span class="token punctuation">,</span>\n         <span class="token punctuation">{</span>\n            test<span class="token punctuation">:</span> <span class="token regex">/\\.less$/</span><span class="token punctuation">,</span>\n            include<span class="token punctuation">:</span> <span class="token regex">/node_modules/</span><span class="token punctuation">,</span>\n            use<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n               <span class="token punctuation">{</span>\n                  loader<span class="token punctuation">:</span> <span class="token string">\'less-loader\'</span><span class="token punctuation">,</span>\n                  options<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n                     lessOptions<span class="token punctuation">:</span> <span class="token punctuation">{</span> javascriptEnabled<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span>\n                  <span class="token punctuation">}</span>\n               <span class="token punctuation">}</span>\n            <span class="token punctuation">]</span><span class="token punctuation">,</span>\n            type<span class="token punctuation">:</span> <span class="token string">\'css\'</span>\n         <span class="token punctuation">}</span><span class="token punctuation">,</span>\n         <span class="token comment">// {</span>\n         <span class="token comment">//   test: /\\.css$/,</span>\n         <span class="token comment">//   type: \'css\'</span>\n         <span class="token comment">// },</span>\n         <span class="token punctuation">{</span>\n            test<span class="token punctuation">:</span> <span class="token regex">/\\.(png|svg|jpg|jpeg|ttf)$/</span><span class="token punctuation">,</span>\n            type<span class="token punctuation">:</span> <span class="token string">\'asset\'</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">]</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span>\n   resolve<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n      alias<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n         <span class="token string">\'@\'</span><span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">\'./src\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token string">\'antd/es/theme\'</span><span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token comment">// 修复因 @ant-design/pro-components 导致的编译报错问题</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      extensions<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'.js\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n      mainFields<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'main\'</span><span class="token punctuation">,</span> <span class="token string">\'browser\'</span><span class="token punctuation">,</span> <span class="token string">\'module\'</span><span class="token punctuation">]</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span>\n   <span class="token comment">// plugins: [</span>\n   <span class="token comment">//   new MonacoWebpackPlugin({</span>\n   <span class="token comment">//     languages: [\'json\']</span>\n   <span class="token comment">//   })</span>\n   <span class="token comment">//   // new NodePolyfill()</span>\n   <span class="token comment">// ],</span>\n   devServer<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n      port<span class="token punctuation">:</span> <span class="token number">3000</span><span class="token punctuation">,</span>\n      allowedHosts<span class="token punctuation">:</span> <span class="token string">\'all\'</span><span class="token punctuation">,</span>\n      client<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n         overlay<span class="token punctuation">:</span> <span class="token operator">!</span><span class="token constant">DISABLE_OVERLAY</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span>\n   devtool<span class="token punctuation">:</span> <span class="token string">\'source-map\'</span><span class="token punctuation">,</span>\n   snapshot<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n      resolve<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n         hash<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n         timestamp<span class="token punctuation">:</span> <span class="token boolean">false</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      module<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n         hash<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n         timestamp<span class="token punctuation">:</span> <span class="token boolean">false</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span>\n   stats<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n      preset<span class="token punctuation">:</span> <span class="token string">\'errors-only\'</span><span class="token punctuation">,</span>\n      reasons<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n      hash<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n      builtAt<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n      timings<span class="token punctuation">:</span> <span class="token boolean">true</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span>\n   experiments<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n      incrementalRebuild<span class="token punctuation">:</span> <span class="token boolean">true</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="运行模板-1"><a href="#%E8%BF%90%E8%A1%8C%E6%A8%A1%E6%9D%BF-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>运行模板</h4>\n<p><a href="https://github.com/towavephone/GatsbyBlog/tree/master/template/rspack-js-template" target="_blank" rel="nofollow noreferrer noopener">仓库地址</a></p>\n<h4 id="优缺点-1"><a href="#%E4%BC%98%E7%BC%BA%E7%82%B9-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>优缺点</h4>\n<ul>\n<li>优点：首次编译，hmr 速度快</li>\n<li>缺点：目前只适用于开发环境，主要是还不支持 <code class="language-text">worker-loader</code> 的用法</li>\n</ul>\n<p>由于以上原因，暂时只在开发模式下使用</p>\n<h3 id="vite"><a href="#vite" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>vite</h3>\n<h4 id="核心配置-2"><a href="#%E6%A0%B8%E5%BF%83%E9%85%8D%E7%BD%AE-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>核心配置</h4>\n<ol>\n<li>index.html 下的 script 脚本需要改成 module 类型</li>\n<li>worker-loader 替换为 <code class="language-text">import Worker from &#39;文件路径?worker&#39;</code></li>\n<li>所有使用 require 的地方替换为 import</li>\n</ol>\n<p>package.json</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="99716133774884550000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`{\n   &quot;devDependencies&quot;: {\n      &quot;@vitejs/plugin-react&quot;: &quot;^3.1.0&quot;,\n      &quot;vite&quot;: &quot;^4.3.1&quot;,\n      &quot;vite-plugin-imp&quot;: &quot;^2.3.1&quot;\n   }\n}`, `99716133774884550000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="json"\n              >\n                <span class="gatsby-code-button-language">json</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="json"><pre style="counter-reset: linenumber NaN" class="language-json line-numbers"><code class="language-json"><span class="token punctuation">{</span>\n   <span class="token property">"devDependencies"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n      <span class="token property">"@vitejs/plugin-react"</span><span class="token operator">:</span> <span class="token string">"^3.1.0"</span><span class="token punctuation">,</span>\n      <span class="token property">"vite"</span><span class="token operator">:</span> <span class="token string">"^4.3.1"</span><span class="token punctuation">,</span>\n      <span class="token property">"vite-plugin-imp"</span><span class="token operator">:</span> <span class="token string">"^2.3.1"</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>vite.config.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="31118980105494500000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import { defineConfig } from \'vite\';\nimport react from \'@vitejs/plugin-react\';\nimport fs from \'fs/promises\';\nimport path from \'path\';\nimport vitePluginImp from \'vite-plugin-imp\';\n\nexport default defineConfig({\n   plugins: [react(), vitePluginImp()],\n   css: {\n      preprocessorOptions: {\n         less: {\n            javascriptEnabled: true\n         }\n      }\n   },\n   esbuild: {\n      loader: \'jsx\',\n      include: /src\\/.*\\.js?\\$/,\n      exclude: []\n   },\n   resolve: {\n      alias: [\n         {\n            // 处理 @import \'~antd/es/style/themes/default.less\' 报错\n            find: /^~/,\n            replacement: \'\'\n         },\n         {\n            find: \'@\',\n            replacement: path.resolve(__dirname, \'./src\')\n         }\n      ]\n   },\n   define: {\n      \'import.meta.env\': &quot;\'development\'&quot;,\n      \'process.env.NODE_DEBUG\': false,\n      \'module.hot\': false\n   },\n   server: {\n      port: 3000\n   },\n   optimizeDeps: {\n      esbuildOptions: {\n         plugins: [\n            {\n               name: \'load-js-files-as-jsx\',\n               // 把 js 文件当成 jsx 处理\n               setup(build) {\n                  build.onLoad({ filter: /src\\/.*\\.js\\$/ }, async (args) => ({\n                     loader: \'jsx\',\n                     contents: await fs.readFile(args.path, \'utf8\')\n                  }));\n               }\n            }\n         ]\n      }\n   }\n});`, `31118980105494500000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> defineConfig <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'vite\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> react <span class="token keyword">from</span> <span class="token string">\'@vitejs/plugin-react\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> fs <span class="token keyword">from</span> <span class="token string">\'fs/promises\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> path <span class="token keyword">from</span> <span class="token string">\'path\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> vitePluginImp <span class="token keyword">from</span> <span class="token string">\'vite-plugin-imp\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineConfig</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n   plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token function">react</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">vitePluginImp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n   css<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n      preprocessorOptions<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n         less<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n            javascriptEnabled<span class="token punctuation">:</span> <span class="token boolean">true</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span>\n   esbuild<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n      loader<span class="token punctuation">:</span> <span class="token string">\'jsx\'</span><span class="token punctuation">,</span>\n      include<span class="token punctuation">:</span> <span class="token regex">/src\\/.*\\.js?$/</span><span class="token punctuation">,</span>\n      exclude<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span>\n   resolve<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n      alias<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n         <span class="token punctuation">{</span>\n            <span class="token comment">// 处理 @import \'~antd/es/style/themes/default.less\' 报错</span>\n            find<span class="token punctuation">:</span> <span class="token regex">/^~/</span><span class="token punctuation">,</span>\n            replacement<span class="token punctuation">:</span> <span class="token string">\'\'</span>\n         <span class="token punctuation">}</span><span class="token punctuation">,</span>\n         <span class="token punctuation">{</span>\n            find<span class="token punctuation">:</span> <span class="token string">\'@\'</span><span class="token punctuation">,</span>\n            replacement<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">\'./src\'</span><span class="token punctuation">)</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">]</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span>\n   define<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n      <span class="token string">\'import.meta.env\'</span><span class="token punctuation">:</span> <span class="token string">"\'development\'"</span><span class="token punctuation">,</span>\n      <span class="token string">\'process.env.NODE_DEBUG\'</span><span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n      <span class="token string">\'module.hot\'</span><span class="token punctuation">:</span> <span class="token boolean">false</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span>\n   server<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n      port<span class="token punctuation">:</span> <span class="token number">3000</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span>\n   optimizeDeps<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n      esbuildOptions<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n         plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n            <span class="token punctuation">{</span>\n               name<span class="token punctuation">:</span> <span class="token string">\'load-js-files-as-jsx\'</span><span class="token punctuation">,</span>\n               <span class="token comment">// 把 js 文件当成 jsx 处理</span>\n               <span class="token function">setup</span><span class="token punctuation">(</span><span class="token parameter">build</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                  build<span class="token punctuation">.</span><span class="token function">onLoad</span><span class="token punctuation">(</span><span class="token punctuation">{</span> filter<span class="token punctuation">:</span> <span class="token regex">/src\\/.*\\.js$/</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>\n                     loader<span class="token punctuation">:</span> <span class="token string">\'jsx\'</span><span class="token punctuation">,</span>\n                     contents<span class="token punctuation">:</span> <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>path<span class="token punctuation">,</span> <span class="token string">\'utf8\'</span><span class="token punctuation">)</span>\n                  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n               <span class="token punctuation">}</span>\n            <span class="token punctuation">}</span>\n         <span class="token punctuation">]</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="优缺点-2"><a href="#%E4%BC%98%E7%BC%BA%E7%82%B9-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>优缺点</h4>\n<ul>\n<li>优点：首次编译速度快</li>\n<li>缺点：此方案初次页面跳转编译速度较慢，而且编译问题较多，同时不太适合生产环境使用</li>\n</ul>\n<p>由于以上原因，不采用此方案</p>\n<h3 id="dockerfile-pnpm-缓存不生效"><a href="#dockerfile-pnpm-%E7%BC%93%E5%AD%98%E4%B8%8D%E7%94%9F%E6%95%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>dockerfile pnpm 缓存不生效</h3>\n<h4 id="需求背景-9"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h4>\n<p>在 jenkins 下运行 docker，缓存不能被使用，因为是跨磁盘（home 目录与 root 目录不在一个磁盘上）的，即 pnpm 不支持硬连接操作，同时 pnpm@7.14.1 也没有对这种情况进行处理，详见 <a href="https://github.com/pnpm/pnpm/releases/tag/v7.14.2" target="_blank" rel="nofollow noreferrer noopener">资料</a></p>\n<h4 id="解决方案-2"><a href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>解决方案</h4>\n<ol>\n<li>升级到 pnpm@7 下的最新版本</li>\n<li>设置缓存路径</li>\n</ol>\n<p>Dockerfile-client-buildkit</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="76292042828666880000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# syntax = docker/dockerfile:experimental\n\nFROM node:14-alpine as builder\n\nARG registry=https://registry.npmmirror.com\n\n# 全局安装依赖，尽量写在一行防止加了新库之后还是使用原来的镜像\nRUN npm config set registry \\${registry} -g && npm i -g pnpm@7.32.1\n\nWORKDIR /home/\n\n# 缓存 pnpm-lock.yaml\nCOPY pnpm-lock.yaml ./\n\n# 下载依赖到全局位置\nRUN --mount=type=cache,target=/root/.local/share/pnpm/store/v3,id=pnpm_cache \\\n    pnpm fetch --prod\n\n# 复制剩余文件\nCOPY . .\n\n# 安装依赖\nRUN --mount=type=cache,target=node_modules,id=frontend_node_modules,sharing=locked \\\n    --mount=type=cache,target=/root/.local/share/pnpm/store/v3,id=pnpm_cache \\\n    pnpm i --ignore-scripts=true --prod --offline --registry=\\$registry\n\nRUN --mount=type=cache,target=node_modules,id=frontend_node_modules,sharing=locked \\\n    pnpm build\n\nFROM nginx:alpine\n\nRUN --mount=type=bind,target=/tmp/build,from=builder,source=/home/build \\\n    cp -r /tmp/build/* /usr/share/nginx/html/\n\nCOPY nginx.conf /etc/nginx/conf.d/default.conf\n\nEXPOSE 3000`, `76292042828666880000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile{8,16,24}"\n              >\n                <span class="gatsby-code-button-language">dockerfile{8,16,24}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token comment"># syntax = docker/dockerfile:experimental</span>\n\n<span class="token keyword">FROM</span> node<span class="token punctuation">:</span>14<span class="token punctuation">-</span>alpine as builder\n\n<span class="token keyword">ARG</span> registry=https<span class="token punctuation">:</span>//registry.npmmirror.com\n\n<span class="token comment"># 全局安装依赖，尽量写在一行防止加了新库之后还是使用原来的镜像</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">RUN</span> npm config set registry $<span class="token punctuation">{</span>registry<span class="token punctuation">}</span> <span class="token punctuation">-</span>g &amp;&amp; npm i <span class="token punctuation">-</span>g pnpm@7.32.1</span>\n<span class="token keyword">WORKDIR</span> /home/\n\n<span class="token comment"># 缓存 pnpm-lock.yaml</span>\n<span class="token keyword">COPY</span> pnpm<span class="token punctuation">-</span>lock.yaml ./\n\n<span class="token comment"># 下载依赖到全局位置</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">RUN</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>mount=type=cache<span class="token punctuation">,</span>target=/root/.local/share/pnpm/store/v3<span class="token punctuation">,</span>id=pnpm_cache \\</span>    pnpm fetch <span class="token punctuation">-</span><span class="token punctuation">-</span>prod\n\n<span class="token comment"># 复制剩余文件</span>\n<span class="token keyword">COPY</span> . .\n\n<span class="token comment"># 安装依赖</span>\n<span class="token keyword">RUN</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>mount=type=cache<span class="token punctuation">,</span>target=node_modules<span class="token punctuation">,</span>id=frontend_node_modules<span class="token punctuation">,</span>sharing=locked \\\n<span class="gatsby-highlight-code-line">    <span class="token punctuation">-</span><span class="token punctuation">-</span>mount=type=cache<span class="token punctuation">,</span>target=/root/.local/share/pnpm/store/v3<span class="token punctuation">,</span>id=pnpm_cache \\</span>    pnpm i <span class="token punctuation">-</span><span class="token punctuation">-</span>ignore<span class="token punctuation">-</span>scripts=true <span class="token punctuation">-</span><span class="token punctuation">-</span>prod <span class="token punctuation">-</span><span class="token punctuation">-</span>offline <span class="token punctuation">-</span><span class="token punctuation">-</span>registry=$registry\n\n<span class="token keyword">RUN</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>mount=type=cache<span class="token punctuation">,</span>target=node_modules<span class="token punctuation">,</span>id=frontend_node_modules<span class="token punctuation">,</span>sharing=locked \\\n    pnpm build\n\n<span class="token keyword">FROM</span> nginx<span class="token punctuation">:</span>alpine\n\n<span class="token keyword">RUN</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>mount=type=bind<span class="token punctuation">,</span>target=/tmp/build<span class="token punctuation">,</span>from=builder<span class="token punctuation">,</span>source=/home/build \\\n    cp <span class="token punctuation">-</span>r /tmp/build/* /usr/share/nginx/html/\n\n<span class="token keyword">COPY</span> nginx.conf /etc/nginx/conf.d/default.conf\n\n<span class="token keyword">EXPOSE</span> 3000</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="效果展示-1"><a href="#%E6%95%88%E6%9E%9C%E5%B1%95%E7%A4%BA-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>效果展示</h2>\n<p>以下都是在二次缓存下的展示，首次编译性能并没有一期优化的性能好</p>\n<h3 id="本地环境"><a href="#%E6%9C%AC%E5%9C%B0%E7%8E%AF%E5%A2%83" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>本地环境</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="12304255872320602000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`Compiled successfully!\n\nYou can now view in the browser.\n\n  Local:            http://localhost:3000\n  On Your Network:  http://ip:3000\n\nNote that the development build is not optimized.\nTo create a production build, use npm run build.\n\n2023-04-25 16:54:30: webpack 5.78.0 compiled successfully in 18559 ms (c2255578550bc936f958)`, `12304255872320602000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">Compiled successfully<span class="token operator">!</span>\n\nYou can now view <span class="token keyword">in</span> the browser.\n\n  Local:            http://localhost:3000\n  On Your Network:  http://ip:3000\n\nNote that the development build is not optimized.\nTo create a production build, use <span class="token function">npm</span> run build.\n\n<span class="token number">2023</span>-04-25 <span class="token number">16</span>:54:30: webpack <span class="token number">5.78</span>.0 compiled successfully <span class="token keyword">in</span> <span class="token number">18559</span> ms <span class="token punctuation">(</span>c2255578550bc936f958<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="生产环境-1"><a href="#%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>生产环境</h3>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-04-25-16-58-25-6846f4ecf5de0d69ad7fc8ace49a11a1-a2427.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 25.995807127882596%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAIAAADKYVtkAAAACXBIWXMAAAsSAAALEgHS3X78AAAA60lEQVQY0zWO23KEIBBE/f+/y+ayXiIgjMKAchGExN2KIQ+Z6odTNdPT3VzX9fM315GOFJP3IcborMvHUXLRqEMI1rm47xXWdQ0+IGI9MNo0MWVjjHNOagkScNNqRb4ItRltNZeg1DwTImYu/rfTzCtIoxquNmdtjYaMY+bTKUmGLhD+UOKpxgwsTlx3NNCxwPS90AKtJ/xU4sQGN1/71PJzwfEQ09dCD+g8EQ+EZ30HU+LgRrYzUoCVmWZoHRGngmoWyigpU0rDRl+3rt9Z6z5v2PaRVb3ZoTVdL14+dPtuhz7QGnvDe4UhsF8fsxH36JCIMQAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 04 25 16 58 25" title="" data-src="/static/2023-04-25-16-58-25-6846f4ecf5de0d69ad7fc8ace49a11a1-fee1c.png" data-srcset="/static/2023-04-25-16-58-25-6846f4ecf5de0d69ad7fc8ace49a11a1-a67b7.png 200w,\n/static/2023-04-25-16-58-25-6846f4ecf5de0d69ad7fc8ace49a11a1-0b187.png 400w,\n/static/2023-04-25-16-58-25-6846f4ecf5de0d69ad7fc8ace49a11a1-fee1c.png 800w,\n/static/2023-04-25-16-58-25-6846f4ecf5de0d69ad7fc8ace49a11a1-b1a91.png 1200w,\n/static/2023-04-25-16-58-25-6846f4ecf5de0d69ad7fc8ace49a11a1-a2427.png 1431w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h2 id="后期优化-1"><a href="#%E5%90%8E%E6%9C%9F%E4%BC%98%E5%8C%96-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>后期优化</h2>\n<p>待 rspack 生产环境可用且性能较好的时候考虑迁移</p>\n<h1 id="三期优化"><a href="#%E4%B8%89%E6%9C%9F%E4%BC%98%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>三期优化</h1>\n<h2 id="具体功能-2"><a href="#%E5%85%B7%E4%BD%93%E5%8A%9F%E8%83%BD-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>具体功能</h2>\n<h3 id="格式化"><a href="#%E6%A0%BC%E5%BC%8F%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>格式化</h3>\n<p>需要对老项目的 js 代码格式化，分为 eslint/prettier</p>\n<p>如下可实现 git commit 前只对暂存到 git 的代码进行格式化修复及校验</p>\n<p>package.json</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="36607336991598060000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`&quot;scripts&quot;: {\n   &quot;eslint&quot;: &quot;npm run eslint:files -- src&quot;,\n   &quot;eslint:files&quot;: &quot;eslint --cache --cache-location node_modules/.cache/.eslintcache --cache-strategy content --ext .js --max-warnings 0&quot;,\n   &quot;fix&quot;: &quot;npm run fix:js&quot;,\n   &quot;fix:js&quot;: &quot;npm run prettier -- --write&quot;,\n   &quot;fl&quot;: &quot;npm run fix && npm run lint&quot;,\n   &quot;lint&quot;: &quot;npm run lint:js&quot;,\n   &quot;lint:js&quot;: &quot;npm run prettier -- --check && npm run eslint&quot;,\n   &quot;lint:js:log2file&quot;: &quot;npm run prettier -- --check && npm run eslint -- -o .cra/eslint-error.log --no-color&quot;,\n   &quot;lint:log2file&quot;: &quot;npm run lint:js:log2file&quot;,\n   &quot;prettier&quot;: &quot;npm run prettier:files -- \'src/**/*.js\'&quot;,\n   &quot;prettier:files&quot;: &quot;prettier --cache --cache-strategy content&quot;\n},\n&quot;husky&quot;: {\n   &quot;hooks&quot;: {\n      &quot;pre-commit&quot;: &quot;node scripts/pre-commit.js&quot;\n   }\n},\n&quot;dependencies&quot;: {\n   &quot;eslint-config-prettier&quot;: &quot;^8.8.0&quot;,\n   &quot;eslint-plugin-eslint-comments&quot;: &quot;^3.2.0&quot;,\n   &quot;prettier&quot;: &quot;^2.8.8&quot;,\n   &quot;confusing-browser-globals&quot;: &quot;^1.0.11&quot;\n},\n&quot;devDependencies&quot;: {\n   &quot;husky&quot;: &quot;^1.0.0-rc.2&quot;,\n   &quot;lint-staged&quot;: &quot;^13.2.2&quot;\n}`, `36607336991598060000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="json"\n              >\n                <span class="gatsby-code-button-language">json</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="json"><pre style="counter-reset: linenumber NaN" class="language-json line-numbers"><code class="language-json"><span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n   <span class="token property">"eslint"</span><span class="token operator">:</span> <span class="token string">"npm run eslint:files -- src"</span><span class="token punctuation">,</span>\n   <span class="token property">"eslint:files"</span><span class="token operator">:</span> <span class="token string">"eslint --cache --cache-location node_modules/.cache/.eslintcache --cache-strategy content --ext .js --max-warnings 0"</span><span class="token punctuation">,</span>\n   <span class="token property">"fix"</span><span class="token operator">:</span> <span class="token string">"npm run fix:js"</span><span class="token punctuation">,</span>\n   <span class="token property">"fix:js"</span><span class="token operator">:</span> <span class="token string">"npm run prettier -- --write"</span><span class="token punctuation">,</span>\n   <span class="token property">"fl"</span><span class="token operator">:</span> <span class="token string">"npm run fix &amp;&amp; npm run lint"</span><span class="token punctuation">,</span>\n   <span class="token property">"lint"</span><span class="token operator">:</span> <span class="token string">"npm run lint:js"</span><span class="token punctuation">,</span>\n   <span class="token property">"lint:js"</span><span class="token operator">:</span> <span class="token string">"npm run prettier -- --check &amp;&amp; npm run eslint"</span><span class="token punctuation">,</span>\n   <span class="token property">"lint:js:log2file"</span><span class="token operator">:</span> <span class="token string">"npm run prettier -- --check &amp;&amp; npm run eslint -- -o .cra/eslint-error.log --no-color"</span><span class="token punctuation">,</span>\n   <span class="token property">"lint:log2file"</span><span class="token operator">:</span> <span class="token string">"npm run lint:js:log2file"</span><span class="token punctuation">,</span>\n   <span class="token property">"prettier"</span><span class="token operator">:</span> <span class="token string">"npm run prettier:files -- \'src/**/*.js\'"</span><span class="token punctuation">,</span>\n   <span class="token property">"prettier:files"</span><span class="token operator">:</span> <span class="token string">"prettier --cache --cache-strategy content"</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span>\n<span class="token property">"husky"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n   <span class="token property">"hooks"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n      <span class="token property">"pre-commit"</span><span class="token operator">:</span> <span class="token string">"node scripts/pre-commit.js"</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span>\n<span class="token property">"dependencies"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n   <span class="token property">"eslint-config-prettier"</span><span class="token operator">:</span> <span class="token string">"^8.8.0"</span><span class="token punctuation">,</span>\n   <span class="token property">"eslint-plugin-eslint-comments"</span><span class="token operator">:</span> <span class="token string">"^3.2.0"</span><span class="token punctuation">,</span>\n   <span class="token property">"prettier"</span><span class="token operator">:</span> <span class="token string">"^2.8.8"</span><span class="token punctuation">,</span>\n   <span class="token property">"confusing-browser-globals"</span><span class="token operator">:</span> <span class="token string">"^1.0.11"</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span>\n<span class="token property">"devDependencies"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n   <span class="token property">"husky"</span><span class="token operator">:</span> <span class="token string">"^1.0.0-rc.2"</span><span class="token punctuation">,</span>\n   <span class="token property">"lint-staged"</span><span class="token operator">:</span> <span class="token string">"^13.2.2"</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>scripts/pre-commit.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="10995664223901436000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const child_process = require(\'child_process\');\n\nfunction spawn(mainModule) {\n   const worker = child_process.spawn(\'lint-staged\', mainModule, {\n      stdio: \'inherit\'\n   });\n\n   worker.on(\'exit\', function(code) {\n      if (code !== 0) {\n         process.exit(1);\n      }\n   });\n}\n\nspawn([\'--no-stash\']);`, `10995664223901436000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> child_process <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'child_process\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">function</span> <span class="token function">spawn</span><span class="token punctuation">(</span><span class="token parameter">mainModule</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">const</span> worker <span class="token operator">=</span> child_process<span class="token punctuation">.</span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token string">\'lint-staged\'</span><span class="token punctuation">,</span> mainModule<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n      stdio<span class="token punctuation">:</span> <span class="token string">\'inherit\'</span>\n   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   worker<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'exit\'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">code</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>code <span class="token operator">!==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token function">spawn</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'--no-stash\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>.eslintrc.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="48408725881783530000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const restrictedGlobals = require(\'confusing-browser-globals\');\n\nconst excludeRestrictedGlobals = restrictedGlobals.filter((item) => ![\'self\'].includes(item));\n\n// console.log(\'excludeRestrictedGlobals\', excludeRestrictedGlobals)\n\nmodule.exports = {\n   extends: [\'react-app\', \'prettier\', \'plugin:eslint-comments/recommended\'],\n   // plugins: [\'prettier\'],\n   rules: {\n      // \'prettier/prettier\': 2,\n      \'no-unused-vars\': 2,\n      \'no-restricted-globals\': [\'error\'].concat(excludeRestrictedGlobals),\n      \'no-debugger\': 2,\n      \'eslint-comments/no-use\': [\'error\', { allow: [\'eslint-disable-next-line\'] }]\n   }\n};`, `48408725881783530000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> restrictedGlobals <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'confusing-browser-globals\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> excludeRestrictedGlobals <span class="token operator">=</span> restrictedGlobals<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token operator">!</span><span class="token punctuation">[</span><span class="token string">\'self\'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// console.log(\'excludeRestrictedGlobals\', excludeRestrictedGlobals)</span>\n\nmodule<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>\n   <span class="token keyword">extends</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'react-app\'</span><span class="token punctuation">,</span> <span class="token string">\'prettier\'</span><span class="token punctuation">,</span> <span class="token string">\'plugin:eslint-comments/recommended\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n   <span class="token comment">// plugins: [\'prettier\'],</span>\n   rules<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n      <span class="token comment">// \'prettier/prettier\': 2,</span>\n      <span class="token string">\'no-unused-vars\'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>\n      <span class="token string">\'no-restricted-globals\'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'error\'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>excludeRestrictedGlobals<span class="token punctuation">)</span><span class="token punctuation">,</span>\n      <span class="token string">\'no-debugger\'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>\n      <span class="token string">\'eslint-comments/no-use\'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'error\'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> allow<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'eslint-disable-next-line\'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">]</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>.prettierrc.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="20766351603547406000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`module.exports = {\n   arrowParens: \'avoid\',\n   bracketSpacing: true,\n   printWidth: 200,\n   semi: false,\n   singleQuote: true,\n   tabWidth: 2,\n   trailingComma: \'none\',\n   useTabs: false\n};`, `20766351603547406000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>\n   arrowParens<span class="token punctuation">:</span> <span class="token string">\'avoid\'</span><span class="token punctuation">,</span>\n   bracketSpacing<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n   printWidth<span class="token punctuation">:</span> <span class="token number">200</span><span class="token punctuation">,</span>\n   semi<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n   singleQuote<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n   tabWidth<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>\n   trailingComma<span class="token punctuation">:</span> <span class="token string">\'none\'</span><span class="token punctuation">,</span>\n   useTabs<span class="token punctuation">:</span> <span class="token boolean">false</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>.lintstagedrc.mjs</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="46625908786566510000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import { ESLint } from \'eslint\';\n\nconst removeIgnoredFiles = async (files) => {\n   const eslint = new ESLint();\n   const isIgnored = await Promise.all(\n      files.map((file) => {\n         return eslint.isPathIgnored(file);\n      })\n   );\n   const filteredFiles = files.filter((_, i) => !isIgnored[i]);\n   return filteredFiles;\n};\n\nexport default {\n   \'src/**/*.js\': async (files) => {\n      let filteredFiles = await removeIgnoredFiles(files);\n\n      if (filteredFiles.length === 0) {\n         return [];\n      }\n\n      // 提交文件超过 20 个的强制检测全部文件\n      if (filteredFiles.length > 20) {\n         filteredFiles = [\'src/**/*.js\'];\n      }\n\n      // console.log(\'filteredFiles\', filteredFiles)\n\n      const filesToLint = filteredFiles.join(\' \');\n      const cmds = [\n         \\`npm run prettier:files -- --write \\${filesToLint}\\`,\n         \\`npm run prettier:files -- --check \\${filesToLint}\\`,\n         \\`npm run eslint:files -- \\${filesToLint}\\`\n      ];\n      // console.log(\'cmds\', cmds)\n      return cmds;\n   }\n};`, `46625908786566510000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> ESLint <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'eslint\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">removeIgnoredFiles</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">files</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   <span class="token keyword">const</span> eslint <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ESLint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">const</span> isIgnored <span class="token operator">=</span> <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>\n      files<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">file</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n         <span class="token keyword">return</span> eslint<span class="token punctuation">.</span><span class="token function">isPathIgnored</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span>\n   <span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">const</span> filteredFiles <span class="token operator">=</span> files<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">_<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token operator">!</span>isIgnored<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">return</span> filteredFiles<span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>\n   <span class="token string">\'src/**/*.js\'</span><span class="token punctuation">:</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">files</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">let</span> filteredFiles <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">removeIgnoredFiles</span><span class="token punctuation">(</span>files<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>filteredFiles<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token comment">// 提交文件超过 20 个的强制检测全部文件</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>filteredFiles<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">20</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         filteredFiles <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'src/**/*.js\'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token comment">// console.log(\'filteredFiles\', filteredFiles)</span>\n\n      <span class="token keyword">const</span> filesToLint <span class="token operator">=</span> filteredFiles<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">\' \'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> cmds <span class="token operator">=</span> <span class="token punctuation">[</span>\n         <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">npm run prettier:files -- --write </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>filesToLint<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n         <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">npm run prettier:files -- --check </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>filesToLint<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n         <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">npm run eslint:files -- </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>filesToLint<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>\n      <span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token comment">// console.log(\'cmds\', cmds)</span>\n      <span class="token keyword">return</span> cmds<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="分包策略"><a href="#%E5%88%86%E5%8C%85%E7%AD%96%E7%95%A5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>分包策略</h3>\n<p>config-overrides.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="41272642140390730000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const {\n   override,\n   addBabelPlugins,\n   fixBabelImports,\n   addLessLoader,\n   removeModuleScopePlugin,\n   setWebpackOptimizationSplitChunks,\n   addWebpackPlugin,\n   addWebpackAlias,\n   adjustStyleLoaders\n} = require(\'customize-cra\');\nconst fs = require(\'fs\');\nconst webpack = require(\'webpack\');\nconst path = require(\'path\');\nconst MonacoWebpackPlugin = require(\'monaco-editor-webpack-plugin\');\nconst WebpackBarPlugin = require(\'webpackbar\');\nconst { get, pick } = require(\'lodash\');\nconst threadLoader = require(\'thread-loader\');\nconst BundleAnalyzerPlugin = require(\'webpack-bundle-analyzer\').BundleAnalyzerPlugin;\n\nconst { LAZY_BUILD, DISABLE_CACHE, DEBUG_CACHE, BUNDLE_ANALYZER, DISABLE_OVERLAY } = process.env;\n\nthreadLoader.warmup(\n   {\n      // pool options, like passed to loader options\n      // must match loader options to boot the correct pool\n   },\n   [\n      // modules to load\n      // can be any module, i. e.\n      \'babel-loader\'\n   ]\n);\n\nconst craDir = path.join(process.cwd() + \'/.cra\');\n\nif (!fs.existsSync(craDir)) {\n   fs.mkdirSync(craDir);\n}\n\nconst getLoaders = (webpackConfig, matcher) => {\n   const matchLoaders = get(webpackConfig, \'module.rules.0.oneOf\', []).filter((item) =>\n      get(item, \'loader\', \'\').includes(matcher)\n   );\n   return matchLoaders;\n};\n\nconst getAssetModules = (webpackConfig, matcher) => {\n   const matchLoaders = get(webpackConfig, \'module.rules.0.oneOf\', []).filter((item) =>\n      get(item, \'type\', \'\').includes(matcher)\n   );\n   return matchLoaders;\n};\n\nconst addBeforeLoaders = (webpackConfig, matcher, newLoader = []) => {\n   const matchLoaders = getLoaders(webpackConfig, matcher);\n   if (matchLoaders.length === 0) {\n      return;\n   }\n\n   matchLoaders.forEach((item) => {\n      const props = [\'loader\', \'options\'];\n      item.use = [...newLoader, pick(item, props)];\n      props.forEach((item2) => {\n         delete item[item2];\n      });\n   });\n};\n\nconst removeAssetDataUrlCondition = (webpackConfig) => {\n   const matchLoaders = getAssetModules(webpackConfig, \'asset\');\n   if (matchLoaders.length === 0) {\n      return;\n   }\n\n   matchLoaders.forEach((item) => {\n      if (!item.parser) {\n         return;\n      }\n      delete item.parser;\n   });\n};\n\nconst formatConfig = (config) =>\n   JSON.stringify(\n      config,\n      (key, value) => {\n         if (typeof value === \'function\') {\n            return value.toString();\n         }\n         return value;\n      },\n      2\n   );\n\nmodule.exports = {\n   webpack: (config, env) => {\n      const isProd = env === \'production\';\n\n      const localConfig = override(\n         addBabelPlugins(\n            [\'@babel/plugin-proposal-nullish-coalescing-operator\'],\n            [\'@babel/plugin-syntax-optional-chaining\']\n         ),\n         fixBabelImports(\'import\', {\n            libraryName: \'antd\',\n            libraryDirectory: \'es\',\n            style: true\n         }),\n         addLessLoader({\n            lessOptions: { javascriptEnabled: true }\n         }),\n         adjustStyleLoaders(({ use: [, , postcss] }) => {\n            const postcssOptions = postcss.options;\n            postcss.options = { postcssOptions };\n         }),\n         addWebpackAlias({\n            \'@\': path.resolve(__dirname, \'src\')\n         }),\n         removeModuleScopePlugin(),\n         isProd &&\n            // 分包原则：首先提取 node_modules 下的所有三方库，然后提取出 src 目录下引用超过 2 次的 chunk，对所有同步、异步包都生效\n            setWebpackOptimizationSplitChunks({\n               chunks: \'all\',\n               maxInitialRequests: 10,\n               minSize: 0,\n               cacheGroups: {\n                  defaultVendors: {\n                     // 抽取三方库\n                     test: (module) => {\n                        return /[\\\\/]node_modules[\\\\/]/.test(module.context);\n                     },\n                     name: (module) => {\n                        // 从后往前匹配 node_modules 后的包名\n                        //\n                        // /frontend/node_modules/.pnpm/@antv+g2plot@2.4.20/node_modules/@antv/g2plot/esm/plots/tiny-column/\n                        // 结果为 @antv\n                        //\n                        // /frontend/node_modules/@antv+g2plot@2.4.20/323\n                        // 结果为 @antv+g2plot@2.4.20\n                        //\n                        // /frontend/node_modules/@antv+g2plot@2.4.20\n                        // 结果为 @antv+g2plot@2.4.20\n                        const matchResult = module.context.match(/(?<=[\\\\/]node_modules[\\\\/])(.*?)(?=([\\\\/]|\\$))/g);\n                        const packageName = matchResult[matchResult.length - 1];\n                        // console.log(\\`packageName: \\${packageName}\\`, module.context)\n                        return \\`pnpm.\\${packageName.replace(/@|\\./g, \'\')}\\`;\n                     },\n                     priority: -10,\n                     reuseExistingChunk: true\n                  },\n                  default: {\n                     // 抽取页面的公共部分\n                     test: (module) => {\n                        // console.log(\'test module.context---------- \', module.context)\n                        return new RegExp(\\`\\${process.cwd()}[\\\\/](src|public)[\\\\/]\\`).test(module.context);\n                     },\n                     name: (module) => {\n                        // console.log(\'name module.context---------- \', module.resourceResolveData.relativePath)\n                        const relativePath = module.resourceResolveData.relativePath\n                           .split(\'/\')\n                           .slice(1)\n                           .join(\'~\');\n                        return relativePath;\n                     },\n                     minChunks: 2,\n                     priority: -20,\n                     reuseExistingChunk: true\n                  }\n               }\n            }),\n         addWebpackPlugin(\n            new MonacoWebpackPlugin({\n               languages: [\'json\']\n            })\n         ),\n         addWebpackPlugin(\n            new webpack.DefinePlugin({\n               \'process.env.BUILD_TOOL\': &quot;\'webpack\'&quot;\n            })\n         ),\n         addWebpackPlugin(\n            new webpack.ProvidePlugin({\n               Buffer: [\'buffer\', \'Buffer\']\n            })\n         ),\n         BUNDLE_ANALYZER &&\n            addWebpackPlugin(\n               new BundleAnalyzerPlugin({\n                  analyzerPort: 8080,\n                  generateStatsFile: true\n               })\n            ),\n         addWebpackPlugin(new WebpackBarPlugin())\n      )(config);\n\n      addBeforeLoaders(localConfig, \'babel-loader\', [\'thread-loader\']);\n      removeAssetDataUrlCondition(localConfig);\n\n      localConfig.resolve.extensions = [\'.js\'];\n      localConfig.resolve.modules = [\'node_modules\'];\n      localConfig.resolve.fallback = {\n         buffer: require.resolve(\'buffer\')\n      };\n\n      if (LAZY_BUILD) {\n         localConfig.experiments = {\n            lazyCompilation: {\n               // disable lazy compilation for dynamic imports\n               imports: true,\n\n               // disable lazy compilation for entries\n               entries: false\n\n               // do not lazily compile moduleB\n               // test: module => !/moduleB/.test(module.nameForCondition())\n            }\n         };\n      }\n\n      if (DEBUG_CACHE) {\n         localConfig.infrastructureLogging = {\n            debug: /webpack\\.cache/\n         };\n      }\n\n      if (DISABLE_CACHE) {\n         localConfig.cache = false;\n      }\n\n      if (!isProd) {\n         localConfig.stats = {\n            errors: true,\n            children: false,\n            warnings: false,\n            colors: true,\n            assets: false,\n            modules: false,\n            entrypoints: false,\n            timings: true,\n            builtAt: true,\n            hash: true\n         };\n      } else {\n         const instanceOfMiniCssExtractPlugin = localConfig.plugins.find(\n            (plugin) => plugin.constructor.name === \'MiniCssExtractPlugin\'\n         );\n\n         // 忽略样式导入顺序报错\n         // https://github.com/facebook/create-react-app/issues/5372\n         if (instanceOfMiniCssExtractPlugin) {\n            instanceOfMiniCssExtractPlugin.options.ignoreOrder = true;\n         }\n\n         localConfig.optimization = {\n            ...localConfig.optimization,\n            nodeEnv: \'production\',\n            sideEffects: true,\n            concatenateModules: true,\n            runtimeChunk: \'single\'\n         };\n      }\n\n      fs.writeFileSync(path.join(craDir, \\`webpack.\\${env}.json\\`), formatConfig(localConfig));\n\n      return localConfig;\n   },\n   devServer: (configFunction) => (proxy, allowedHost) => {\n      const config = configFunction(proxy, allowedHost);\n\n      config.allowedHosts = \'all\';\n\n      if (DISABLE_OVERLAY) {\n         config.client.overlay = false;\n      }\n\n      fs.writeFileSync(path.join(craDir, \'webpack-dev-server.json\'), formatConfig(config));\n\n      return config;\n   }\n};`, `41272642140390730000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{121-171,255-261}"\n              >\n                <span class="gatsby-code-button-language">js{121-171,255-261}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> <span class="token punctuation">{</span>\n   override<span class="token punctuation">,</span>\n   addBabelPlugins<span class="token punctuation">,</span>\n   fixBabelImports<span class="token punctuation">,</span>\n   addLessLoader<span class="token punctuation">,</span>\n   removeModuleScopePlugin<span class="token punctuation">,</span>\n   setWebpackOptimizationSplitChunks<span class="token punctuation">,</span>\n   addWebpackPlugin<span class="token punctuation">,</span>\n   addWebpackAlias<span class="token punctuation">,</span>\n   adjustStyleLoaders\n<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'customize-cra\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'fs\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> webpack <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'webpack\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'path\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> MonacoWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'monaco-editor-webpack-plugin\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> WebpackBarPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'webpackbar\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">,</span> pick <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'lodash\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> threadLoader <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'thread-loader\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> BundleAnalyzerPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'webpack-bundle-analyzer\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>BundleAnalyzerPlugin<span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token constant">LAZY_BUILD</span><span class="token punctuation">,</span> <span class="token constant">DISABLE_CACHE</span><span class="token punctuation">,</span> <span class="token constant">DEBUG_CACHE</span><span class="token punctuation">,</span> <span class="token constant">BUNDLE_ANALYZER</span><span class="token punctuation">,</span> <span class="token constant">DISABLE_OVERLAY</span> <span class="token punctuation">}</span> <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">;</span>\n\nthreadLoader<span class="token punctuation">.</span><span class="token function">warmup</span><span class="token punctuation">(</span>\n   <span class="token punctuation">{</span>\n      <span class="token comment">// pool options, like passed to loader options</span>\n      <span class="token comment">// must match loader options to boot the correct pool</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span>\n   <span class="token punctuation">[</span>\n      <span class="token comment">// modules to load</span>\n      <span class="token comment">// can be any module, i. e.</span>\n      <span class="token string">\'babel-loader\'</span>\n   <span class="token punctuation">]</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> craDir <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">\'/.cra\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>craDir<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   fs<span class="token punctuation">.</span><span class="token function">mkdirSync</span><span class="token punctuation">(</span>craDir<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">getLoaders</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">webpackConfig<span class="token punctuation">,</span> matcher</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   <span class="token keyword">const</span> matchLoaders <span class="token operator">=</span> <span class="token keyword">get</span><span class="token punctuation">(</span>webpackConfig<span class="token punctuation">,</span> <span class="token string">\'module.rules.0.oneOf\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span>\n      <span class="token keyword">get</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token string">\'loader\'</span><span class="token punctuation">,</span> <span class="token string">\'\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>matcher<span class="token punctuation">)</span>\n   <span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">return</span> matchLoaders<span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">getAssetModules</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">webpackConfig<span class="token punctuation">,</span> matcher</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   <span class="token keyword">const</span> matchLoaders <span class="token operator">=</span> <span class="token keyword">get</span><span class="token punctuation">(</span>webpackConfig<span class="token punctuation">,</span> <span class="token string">\'module.rules.0.oneOf\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span>\n      <span class="token keyword">get</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token string">\'type\'</span><span class="token punctuation">,</span> <span class="token string">\'\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>matcher<span class="token punctuation">)</span>\n   <span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">return</span> matchLoaders<span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">addBeforeLoaders</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">webpackConfig<span class="token punctuation">,</span> matcher<span class="token punctuation">,</span> newLoader <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   <span class="token keyword">const</span> matchLoaders <span class="token operator">=</span> <span class="token function">getLoaders</span><span class="token punctuation">(</span>webpackConfig<span class="token punctuation">,</span> matcher<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>matchLoaders<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   matchLoaders<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> props <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'loader\'</span><span class="token punctuation">,</span> <span class="token string">\'options\'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n      item<span class="token punctuation">.</span>use <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span>newLoader<span class="token punctuation">,</span> <span class="token function">pick</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> props<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n      props<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item2</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n         <span class="token keyword">delete</span> item<span class="token punctuation">[</span>item2<span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">removeAssetDataUrlCondition</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">webpackConfig</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   <span class="token keyword">const</span> matchLoaders <span class="token operator">=</span> <span class="token function">getAssetModules</span><span class="token punctuation">(</span>webpackConfig<span class="token punctuation">,</span> <span class="token string">\'asset\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>matchLoaders<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   matchLoaders<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>item<span class="token punctuation">.</span>parser<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token keyword">return</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      <span class="token keyword">delete</span> item<span class="token punctuation">.</span>parser<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">formatConfig</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span> <span class="token operator">=></span>\n   <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>\n      config<span class="token punctuation">,</span>\n      <span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> value <span class="token operator">===</span> <span class="token string">\'function\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">return</span> value<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span>\n         <span class="token keyword">return</span> value<span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      <span class="token number">2</span>\n   <span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nmodule<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>\n   <span class="token function-variable function">webpack</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">config<span class="token punctuation">,</span> env</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> isProd <span class="token operator">=</span> env <span class="token operator">===</span> <span class="token string">\'production\'</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">const</span> localConfig <span class="token operator">=</span> <span class="token function">override</span><span class="token punctuation">(</span>\n         <span class="token function">addBabelPlugins</span><span class="token punctuation">(</span>\n            <span class="token punctuation">[</span><span class="token string">\'@babel/plugin-proposal-nullish-coalescing-operator\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n            <span class="token punctuation">[</span><span class="token string">\'@babel/plugin-syntax-optional-chaining\'</span><span class="token punctuation">]</span>\n         <span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token function">fixBabelImports</span><span class="token punctuation">(</span><span class="token string">\'import\'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>\n            libraryName<span class="token punctuation">:</span> <span class="token string">\'antd\'</span><span class="token punctuation">,</span>\n            libraryDirectory<span class="token punctuation">:</span> <span class="token string">\'es\'</span><span class="token punctuation">,</span>\n            style<span class="token punctuation">:</span> <span class="token boolean">true</span>\n         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token function">addLessLoader</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n            lessOptions<span class="token punctuation">:</span> <span class="token punctuation">{</span> javascriptEnabled<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span>\n         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token function">adjustStyleLoaders</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> use<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">,</span> <span class="token punctuation">,</span> postcss<span class="token punctuation">]</span> <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            <span class="token keyword">const</span> postcssOptions <span class="token operator">=</span> postcss<span class="token punctuation">.</span>options<span class="token punctuation">;</span>\n            postcss<span class="token punctuation">.</span>options <span class="token operator">=</span> <span class="token punctuation">{</span> postcssOptions <span class="token punctuation">}</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token function">addWebpackAlias</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n            <span class="token string">\'@\'</span><span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">\'src\'</span><span class="token punctuation">)</span>\n         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token function">removeModuleScopePlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n<span class="gatsby-highlight-code-line">         isProd <span class="token operator">&amp;&amp;</span></span><span class="gatsby-highlight-code-line">            <span class="token comment">// 分包原则：首先提取 node_modules 下的所有三方库，然后提取出 src 目录下引用超过 2 次的 chunk，对所有同步、异步包都生效</span></span><span class="gatsby-highlight-code-line">            <span class="token function">setWebpackOptimizationSplitChunks</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">               chunks<span class="token punctuation">:</span> <span class="token string">\'all\'</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">               maxInitialRequests<span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">               minSize<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">               cacheGroups<span class="token punctuation">:</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">                  defaultVendors<span class="token punctuation">:</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">                     <span class="token comment">// 抽取三方库</span></span><span class="gatsby-highlight-code-line">                     <span class="token function-variable function">test</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">module</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">                        <span class="token keyword">return</span> <span class="token operator">/</span><span class="token punctuation">[</span>\\\\<span class="token regex">/]node_modules[\\\\/]/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">                     <span class="token punctuation">}</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">                     <span class="token function-variable function">name</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">module</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">                        <span class="token comment">// 从后往前匹配 node_modules 后的包名</span></span><span class="gatsby-highlight-code-line">                        <span class="token comment">//</span></span><span class="gatsby-highlight-code-line">                        <span class="token comment">// /frontend/node_modules/.pnpm/@antv+g2plot@2.4.20/node_modules/@antv/g2plot/esm/plots/tiny-column/</span></span><span class="gatsby-highlight-code-line">                        <span class="token comment">// 结果为 @antv</span></span><span class="gatsby-highlight-code-line">                        <span class="token comment">//</span></span><span class="gatsby-highlight-code-line">                        <span class="token comment">// /frontend/node_modules/@antv+g2plot@2.4.20/323</span></span><span class="gatsby-highlight-code-line">                        <span class="token comment">// 结果为 @antv+g2plot@2.4.20</span></span><span class="gatsby-highlight-code-line">                        <span class="token comment">//</span></span><span class="gatsby-highlight-code-line">                        <span class="token comment">// /frontend/node_modules/@antv+g2plot@2.4.20</span></span><span class="gatsby-highlight-code-line">                        <span class="token comment">// 结果为 @antv+g2plot@2.4.20</span></span><span class="gatsby-highlight-code-line">                        <span class="token keyword">const</span> matchResult <span class="token operator">=</span> module<span class="token punctuation">.</span>context<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex">/(?&lt;=[\\\\/]node_modules[\\\\/])(.*?)(?=([\\\\/]|$))/g</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">                        <span class="token keyword">const</span> packageName <span class="token operator">=</span> matchResult<span class="token punctuation">[</span>matchResult<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">                        <span class="token comment">// console.log(`packageName: ${packageName}`, module.context)</span></span><span class="gatsby-highlight-code-line">                        <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">pnpm.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>packageName<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/@|\\./g</span><span class="token punctuation">,</span> <span class="token string">\'\'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">                     <span class="token punctuation">}</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">                     priority<span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">                     reuseExistingChunk<span class="token punctuation">:</span> <span class="token boolean">true</span></span><span class="gatsby-highlight-code-line">                  <span class="token punctuation">}</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">                  <span class="token keyword">default</span><span class="token punctuation">:</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">                     <span class="token comment">// 抽取页面的公共部分</span></span><span class="gatsby-highlight-code-line">                     <span class="token function-variable function">test</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">module</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">                        <span class="token comment">// console.log(\'test module.context---------- \', module.context)</span></span><span class="gatsby-highlight-code-line">                        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">[\\\\/](src|public)[\\\\/]</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">                     <span class="token punctuation">}</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">                     <span class="token function-variable function">name</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">module</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">                        <span class="token comment">// console.log(\'name module.context---------- \', module.resourceResolveData.relativePath)</span></span><span class="gatsby-highlight-code-line">                        <span class="token keyword">const</span> relativePath <span class="token operator">=</span> module<span class="token punctuation">.</span>resourceResolveData<span class="token punctuation">.</span>relativePath</span><span class="gatsby-highlight-code-line">                           <span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">\'/\'</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line">                           <span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line">                           <span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">\'~\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">                        <span class="token keyword">return</span> relativePath<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">                     <span class="token punctuation">}</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">                     minChunks<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">                     priority<span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">20</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">                     reuseExistingChunk<span class="token punctuation">:</span> <span class="token boolean">true</span></span><span class="gatsby-highlight-code-line">                  <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">               <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>         <span class="token function">addWebpackPlugin</span><span class="token punctuation">(</span>\n            <span class="token keyword">new</span> <span class="token class-name">MonacoWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n               languages<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'json\'</span><span class="token punctuation">]</span>\n            <span class="token punctuation">}</span><span class="token punctuation">)</span>\n         <span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token function">addWebpackPlugin</span><span class="token punctuation">(</span>\n            <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>DefinePlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n               <span class="token string">\'process.env.BUILD_TOOL\'</span><span class="token punctuation">:</span> <span class="token string">"\'webpack\'"</span>\n            <span class="token punctuation">}</span><span class="token punctuation">)</span>\n         <span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token function">addWebpackPlugin</span><span class="token punctuation">(</span>\n            <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>ProvidePlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n               Buffer<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'buffer\'</span><span class="token punctuation">,</span> <span class="token string">\'Buffer\'</span><span class="token punctuation">]</span>\n            <span class="token punctuation">}</span><span class="token punctuation">)</span>\n         <span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token constant">BUNDLE_ANALYZER</span> <span class="token operator">&amp;&amp;</span>\n            <span class="token function">addWebpackPlugin</span><span class="token punctuation">(</span>\n               <span class="token keyword">new</span> <span class="token class-name">BundleAnalyzerPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n                  analyzerPort<span class="token punctuation">:</span> <span class="token number">8080</span><span class="token punctuation">,</span>\n                  generateStatsFile<span class="token punctuation">:</span> <span class="token boolean">true</span>\n               <span class="token punctuation">}</span><span class="token punctuation">)</span>\n            <span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token function">addWebpackPlugin</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WebpackBarPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n      <span class="token punctuation">)</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token function">addBeforeLoaders</span><span class="token punctuation">(</span>localConfig<span class="token punctuation">,</span> <span class="token string">\'babel-loader\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">\'thread-loader\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token function">removeAssetDataUrlCondition</span><span class="token punctuation">(</span>localConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      localConfig<span class="token punctuation">.</span>resolve<span class="token punctuation">.</span>extensions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'.js\'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n      localConfig<span class="token punctuation">.</span>resolve<span class="token punctuation">.</span>modules <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'node_modules\'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n      localConfig<span class="token punctuation">.</span>resolve<span class="token punctuation">.</span>fallback <span class="token operator">=</span> <span class="token punctuation">{</span>\n         buffer<span class="token punctuation">:</span> require<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">\'buffer\'</span><span class="token punctuation">)</span>\n      <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">LAZY_BUILD</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         localConfig<span class="token punctuation">.</span>experiments <span class="token operator">=</span> <span class="token punctuation">{</span>\n            lazyCompilation<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n               <span class="token comment">// disable lazy compilation for dynamic imports</span>\n               imports<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n\n               <span class="token comment">// disable lazy compilation for entries</span>\n               entries<span class="token punctuation">:</span> <span class="token boolean">false</span>\n\n               <span class="token comment">// do not lazily compile moduleB</span>\n               <span class="token comment">// test: module => !/moduleB/.test(module.nameForCondition())</span>\n            <span class="token punctuation">}</span>\n         <span class="token punctuation">}</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_CACHE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         localConfig<span class="token punctuation">.</span>infrastructureLogging <span class="token operator">=</span> <span class="token punctuation">{</span>\n            debug<span class="token punctuation">:</span> <span class="token regex">/webpack\\.cache/</span>\n         <span class="token punctuation">}</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DISABLE_CACHE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         localConfig<span class="token punctuation">.</span>cache <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isProd<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         localConfig<span class="token punctuation">.</span>stats <span class="token operator">=</span> <span class="token punctuation">{</span>\n            errors<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n            children<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n            warnings<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n            colors<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n            assets<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n            modules<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n            entrypoints<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n            timings<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n            builtAt<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n            hash<span class="token punctuation">:</span> <span class="token boolean">true</span>\n         <span class="token punctuation">}</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n         <span class="token keyword">const</span> instanceOfMiniCssExtractPlugin <span class="token operator">=</span> localConfig<span class="token punctuation">.</span>plugins<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>\n            <span class="token punctuation">(</span><span class="token parameter">plugin</span><span class="token punctuation">)</span> <span class="token operator">=></span> plugin<span class="token punctuation">.</span>constructor<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">\'MiniCssExtractPlugin\'</span>\n         <span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n         <span class="token comment">// 忽略样式导入顺序报错</span>\n         <span class="token comment">// https://github.com/facebook/create-react-app/issues/5372</span>\n         <span class="token keyword">if</span> <span class="token punctuation">(</span>instanceOfMiniCssExtractPlugin<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            instanceOfMiniCssExtractPlugin<span class="token punctuation">.</span>options<span class="token punctuation">.</span>ignoreOrder <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span>\n\n<span class="gatsby-highlight-code-line">         localConfig<span class="token punctuation">.</span>optimization <span class="token operator">=</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">            <span class="token operator">...</span>localConfig<span class="token punctuation">.</span>optimization<span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">            nodeEnv<span class="token punctuation">:</span> <span class="token string">\'production\'</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">            sideEffects<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">            concatenateModules<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">            runtimeChunk<span class="token punctuation">:</span> <span class="token string">\'single\'</span></span><span class="gatsby-highlight-code-line">         <span class="token punctuation">}</span><span class="token punctuation">;</span></span>      <span class="token punctuation">}</span>\n\n      fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>craDir<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">webpack.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>env<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.json</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">formatConfig</span><span class="token punctuation">(</span>localConfig<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">return</span> localConfig<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span>\n   <span class="token function-variable function">devServer</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">configFunction</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token parameter">proxy<span class="token punctuation">,</span> allowedHost</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">configFunction</span><span class="token punctuation">(</span>proxy<span class="token punctuation">,</span> allowedHost<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      config<span class="token punctuation">.</span>allowedHosts <span class="token operator">=</span> <span class="token string">\'all\'</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DISABLE_OVERLAY</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         config<span class="token punctuation">.</span>client<span class="token punctuation">.</span>overlay <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n\n      fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>craDir<span class="token punctuation">,</span> <span class="token string">\'webpack-dev-server.json\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">formatConfig</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">return</span> config<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="快速脚本启动"><a href="#%E5%BF%AB%E9%80%9F%E8%84%9A%E6%9C%AC%E5%90%AF%E5%8A%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>快速脚本启动</h3>\n<p>由于前端项目在子目录下面，所以需要在根目录执行命令，方便快速启动本地开发，使用举例：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="19341614930223837000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`pnpm r # 等价于 pnpm r start:rspack 或 cd 前端项目文件夹 && pnpm start:rspack，这里默认使用 rspack，推荐使用，相比 webpack 它的热更新速度很快\npnpm r start # 等价于 cd 前端项目文件夹 && pnpm start\npnpm r i # 等价于 cd 前端项目文件夹 && pnpm i`, `19341614930223837000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token function">pnpm</span> r <span class="token comment"># 等价于 pnpm r start:rspack 或 cd 前端项目文件夹 &amp;&amp; pnpm start:rspack，这里默认使用 rspack，推荐使用，相比 webpack 它的热更新速度很快</span>\n<span class="token function">pnpm</span> r start <span class="token comment"># 等价于 cd 前端项目文件夹 &amp;&amp; pnpm start</span>\n<span class="token function">pnpm</span> r i <span class="token comment"># 等价于 cd 前端项目文件夹 &amp;&amp; pnpm i</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>相关改动如下：</p>\n<p>package.json</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="15716745130836896000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`{\n   &quot;scripts&quot;: {\n      &quot;r&quot;: &quot;node sim_ui/scripts/run.js&quot;\n   }\n}`, `15716745130836896000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="json"\n              >\n                <span class="gatsby-code-button-language">json</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="json"><pre style="counter-reset: linenumber NaN" class="language-json line-numbers"><code class="language-json"><span class="token punctuation">{</span>\n   <span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n      <span class="token property">"r"</span><span class="token operator">:</span> <span class="token string">"node sim_ui/scripts/run.js"</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>sim_ui/scripts/run.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="33996154626605744000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const shelljs = require(\'shelljs\');\nconst child_process = require(\'child_process\');\nconst argv = require(\'yargs\').argv;\nconst SCRIPT = argv[\'_\'].length > 0 ? argv[\'_\'] : [\'start:rspack\'];\n\nshelljs.cd(\'sim_ui\');\n\nconst worker = child_process.spawn(\'pnpm\', SCRIPT, {\n   stdio: \'inherit\'\n});\n\n// 当接收到终止信号时，终止子进程\nprocess.on(\'SIGINT\', () => {\n   worker.kill(\'SIGINT\');\n});`, `33996154626605744000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> shelljs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'shelljs\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> child_process <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'child_process\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> argv <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'yargs\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>argv<span class="token punctuation">;</span>\n<span class="token keyword">const</span> <span class="token constant">SCRIPT</span> <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token string">\'_\'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">?</span> argv<span class="token punctuation">[</span><span class="token string">\'_\'</span><span class="token punctuation">]</span> <span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'start:rspack\'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n\nshelljs<span class="token punctuation">.</span><span class="token function">cd</span><span class="token punctuation">(</span><span class="token string">\'sim_ui\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> worker <span class="token operator">=</span> child_process<span class="token punctuation">.</span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token string">\'pnpm\'</span><span class="token punctuation">,</span> <span class="token constant">SCRIPT</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>\n   stdio<span class="token punctuation">:</span> <span class="token string">\'inherit\'</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 当接收到终止信号时，终止子进程</span>\nprocess<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'SIGINT\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   worker<span class="token punctuation">.</span><span class="token function">kill</span><span class="token punctuation">(</span><span class="token string">\'SIGINT\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="效果展示-2"><a href="#%E6%95%88%E6%9E%9C%E5%B1%95%E7%A4%BA-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>效果展示</h2>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-07-04-15-05-15-1aae8175e7c6797e5518e6b224256e89-0424d.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 42.67657992565056%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsSAAALEgHS3X78AAABIElEQVQoz42RW3OCMBCFea2XqiCItTqd1orKPZEQEGzr//9Pp9nVcXyp5eHMEib5ds9Z6/yuoacRKi/GcZ6hmiWo/RRHP+NaeQny/ifSpw9kvfWt/iWrWQgDjFFMdijdCGoasrQb85kkn4N/QTfgaXlA7SYM/VoVOL1K8D8zHYEJSM06A1sCGBGU7JFtmq72UhxGW8hRADHcMLCLbas0+R1nGRo/NxADNTACErx0IpayQ+SDTbcMz28aPyvFUFK7kLwQaqSvIqgYBt2A7YvA97JgiHJCnkYaq2nPPOyvWfd2H4nuWIW957zIrjLflJcwW6XNyvGW4fd2H4knVJO9yS1BM8+5kqgBbV07EdfSvtTqKnpTjHccRe2mfE8MLov7BTNQ/81VMpNzAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 07 04 15 05 15" title="" data-src="/static/2023-07-04-15-05-15-1aae8175e7c6797e5518e6b224256e89-fee1c.png" data-srcset="/static/2023-07-04-15-05-15-1aae8175e7c6797e5518e6b224256e89-a67b7.png 200w,\n/static/2023-07-04-15-05-15-1aae8175e7c6797e5518e6b224256e89-0b187.png 400w,\n/static/2023-07-04-15-05-15-1aae8175e7c6797e5518e6b224256e89-fee1c.png 800w,\n/static/2023-07-04-15-05-15-1aae8175e7c6797e5518e6b224256e89-b1a91.png 1200w,\n/static/2023-07-04-15-05-15-1aae8175e7c6797e5518e6b224256e89-0424d.png 1345w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-07-04-15-08-47-cc14aa594a380d489615e7dd7ec656b9-1f825.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 552px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 35.869565217391305%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsSAAALEgHS3X78AAABk0lEQVQoz1WP227aUBBFeWlL2qQEmhBR7ldxMcY2xgZjJwYMpIBNmgDq7an//w+rU6dC6sPWnjlztGZ2wiwbjCstRtkmS3H3rs0orWKmOqIuVlqJayvdw8ooGFdt1GRd1DhrcNFAe1+PPeG3Hoh6Jn6hx2NzyKpu8KQ6BFWdtfS7js2saMi7xaZtE1T6mB+rjFK1WONMDfOqfoYmFNk4TuWZfCphXxexUkXG6bx8LkpfiKVdlDEuSwIq4dyUsdN/QdVYbvYVfgZqWU02z1i3fLnCwy+NmVecWKGyJKi5jK67cVT9Q4vem9p/cdVk8x/sVQk9N+BgfCFSFhLZ46u2FndZ16cS2eVFZquaE8+2HZ/7zwZaUqDv5KrYq3Hdf1uhL3XCbrn8Dn9w8vf8XB44zfZ8Xzxzuo/4Nn/i+BCyGwYcvS3P7oZfqwPb4YxpYcAo02Wa07BvFLy8iXPbF2DZJdTmbPozQn3JcRqyN1fMGxMiPWCnLYiGSyIjYNWe4haHeGWTSU7FEpCbN3DuVCa3KrYs+AMFgtdNtYO+3wAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 07 04 15 08 47" title="" data-src="/static/2023-07-04-15-08-47-cc14aa594a380d489615e7dd7ec656b9-1f825.png" data-srcset="/static/2023-07-04-15-08-47-cc14aa594a380d489615e7dd7ec656b9-632a9.png 200w,\n/static/2023-07-04-15-08-47-cc14aa594a380d489615e7dd7ec656b9-cac39.png 400w,\n/static/2023-07-04-15-08-47-cc14aa594a380d489615e7dd7ec656b9-1f825.png 552w" data-sizes="(max-width: 552px) 100vw, 552px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-07-04-15-09-21-bad87ebfe810ab507ef7d63a77d61f3e-eb534.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 113.67061356297093%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAXCAYAAAALHW+jAAAACXBIWXMAAAsSAAALEgHS3X78AAADsUlEQVQ4y11Va3PbNhDkv27s2I3k/MB+60zbWJYovknw/Ral7S4gOZlo5uYo3OGwt3sgvf3bDrvdN7y+vmC/3+H79zfs6L++vOCPpye8/vlqY8/PT85/fcYL/SN//7bHN8W+fLExr0lSDP2AcZzQ0OdlhbPpEaQG57xGnBsUVW3Xy6ZD3fVoh5G5IzruscZ90zQjbyd4Bz/EOYwQxgkiFv/nxwGHU4B/3w/47/CB9+MJfhjjGKU4BcyNEsRZjpC5AffIksLwsBZF3cD766PA6XS0mwyRVAzI6razvunouxF/B0TOgipQMdb0PWPO6s7lVm0LLylKJLnMIExzRLQgyYjgYfnns43FKc60KM1c3m/5XmwaBFmJuKhQtMPdxru5Z0OfNwO9WzP3NT2X3c81ea8U4VmGjrB7tjGOI+Zpsv8v64qavFwuFzRNg2VZ7PpAUZT3WKuqCuu6MLeGV1QtttsVNwDX6w2XbcO2Xa3/1a63G/qBSCUAQVwuG37/3ZjjReEZMfmQckleoL6LIuUlkmLyUruRSCS+pSibPXiz6K/Xq0XcsUNvqEL4vg9Tlpjn2bbp2qix0tdsayIFURSz1QEZD9bMCs1yzxVatZ1wlLy+ijgOAQpTWk60WUk6QF6IdHp4L6iDtP7rb2VhcZtRC68vA/jnABnbzfLcFlCCCorolom6BcppGVPhiuQ/OJPxyR5SFAW8zgT4OB4RE64hSqEQSpEvCoRaqp5IS88rpuFWTPw9ipbLZvclSQJvrOPPlmWGd1aFNC62FRKt/1EUoZtWFJMm4fqJ7kZBNpoKFsY4hP75bFvOCbng6RoPoRVSka1ktayXQEOFR65L3XmhKBe2u90wrxtK0mQRRrHjRbwNFEDtPAZaIzKTn4h3WPyGHKeAaEMZr+B7WOAj4Tugm1DzcIvQtWwsOhVUi0KoG6ODhFCFpLZQT9NoQUgkcV+wu2WebNzNIdtRuyVPeMxWSS7lncoTAhbUf/Eq00SoQEYQVVljEwUEYsfmePKRcmCFcr0XFEJb8M6ZDtWGRzxJU4s85tvGmIr0rK5gV4YciTNywlZRoRQiFXdj01oaVPAx9PIxOXUFM1LlZlbr3kBRRLDlUMreUYg7edsy1zTQ7pq51lLeCvvaZ7GqaqyQituWJYoS7P1dHXR79TSPGmwiDDjQQiAk8zwiVctct98c2rLMTpQs5feCLZ/Ykk/idQsKCqLvi55Fuobd1w0xNd/Usgo/TglMxjj3lRSl14eLn4P/ATquv1jYwePvAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 07 04 15 09 21" title="" data-src="/static/2023-07-04-15-09-21-bad87ebfe810ab507ef7d63a77d61f3e-fee1c.png" data-srcset="/static/2023-07-04-15-09-21-bad87ebfe810ab507ef7d63a77d61f3e-a67b7.png 200w,\n/static/2023-07-04-15-09-21-bad87ebfe810ab507ef7d63a77d61f3e-0b187.png 400w,\n/static/2023-07-04-15-09-21-bad87ebfe810ab507ef7d63a77d61f3e-fee1c.png 800w,\n/static/2023-07-04-15-09-21-bad87ebfe810ab507ef7d63a77d61f3e-eb534.png 929w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>',
id:"/home/runner/work/GatsbyBlog/GatsbyBlog/blog/CRA 项目构建速度优化/index.md absPath of file >>> MarkdownRemark",timeToRead:32,frontmatter:{date:"2022-12-16 17:34:33",path:"/cra-project-build-speed-optimize/",tags:"前端, webpack, Docker, 预研, rspack, 前端构建工具",title:"CRA 项目构建速度优化",draft:null}},{excerpt:"基础 简介 entry（入口） 入口起点（entry point）即是 webpack 通过该起点找到本次项目所直接或间接依赖的资源（模块、库等），并对其进行处理，最后输出到 bundle 中。入口文件由用户自定义，可以是一个或者多个，每一个 entry 最后对应一个 bundle。 output（出口） 通过配置 output 属性可以告诉 webpack 将 bundle 命名并输出到对应的位置。 loader webpack 核心，webpack 本身只能识别 js 文件，对于非 js…",html:'<h1 id="基础"><a href="#%E5%9F%BA%E7%A1%80" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>基础</h1>\n<h2 id="简介"><a href="#%E7%AE%80%E4%BB%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>简介</h2>\n<h3 id="entry（入口）"><a href="#entry%EF%BC%88%E5%85%A5%E5%8F%A3%EF%BC%89" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>entry（入口）</h3>\n<p>入口起点（entry point）即是 webpack 通过该起点找到本次项目所直接或间接依赖的资源（模块、库等），并对其进行处理，最后输出到 bundle 中。入口文件由用户自定义，可以是一个或者多个，每一个 entry 最后对应一个 bundle。</p>\n<h3 id="output（出口）"><a href="#output%EF%BC%88%E5%87%BA%E5%8F%A3%EF%BC%89" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>output（出口）</h3>\n<p>通过配置 output 属性可以告诉 webpack 将 bundle 命名并输出到对应的位置。</p>\n<h3 id="loader"><a href="#loader" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>loader</h3>\n<p>webpack 核心，webpack 本身只能识别 js 文件，对于非 js 文件，即需要 loader 转换为 js 文件。换句话说，Loader 就是资源转换器。由于在 webpack 里，所有的资源都是模块，不同资源都最终转化成 js 去处理。针对不同形式的资源采用不同的 Loader 去编译，这就是 Loader 的意义。</p>\n<h3 id="插件（plugin）"><a href="#%E6%8F%92%E4%BB%B6%EF%BC%88plugin%EF%BC%89" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>插件（plugin）</h3>\n<p>webpack 核心，loader 处理非 js 文件，那么插件可以有更广泛的用途。整个 webpack 其实就是各类的插件形成的，插件的范围包括，从打包优化和压缩，一直到重新定义环境中的变量。插件接口功能极其强大，可以用来处理各种各样的任务。</p>\n<h3 id="chunk"><a href="#chunk" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Chunk</h3>\n<p>被 entry 所依赖的额外的代码块，同样可以包含一个或者多个文件。chunk 也就是一个个的 js 文件，在异步加载中用处很大。chunk 实际上就是 webpack 打包后的产物，如果你不想最后生成一个包含所有的 bundle，那么可以生成一个个 chunk，并通过按需加载引入。同时它还能通过插件提取公共依赖生成公共 chunk，避免多个 bundle 中有多个相同的依赖代码。</p>\n<h2 id="实践--优化"><a href="#%E5%AE%9E%E8%B7%B5--%E4%BC%98%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>实践 &#x26; 优化</h2>\n<h3 id="url-loader--image-webpack-loader"><a href="#url-loader--image-webpack-loader" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>url-loader &#x26; image-webpack-loader</h3>\n<p>url-loader 可以在文件大小（单位 byte）低于指定的限制，将文件转换为 DataURL，这在实际开发中非常有效，能够减少请求数，在 vue-cli 和 create-react-app 中也都能看到对这个 loader 的使用。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="96535371335741260000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// &quot;url&quot; loader works just like &quot;file&quot; loader but it also embeds\n// assets smaller than specified size as data URLs to avoid requests.\n{\n  test: [/\\.bmp\\$/, /\\.gif\\$/, /\\.jpe?g\\$/, /\\.png\\$/],\n  loader: require.resolve(\'url-loader\'),\n  options: {\n    limit: 10000,\n    name: \'static/media/[name].[hash:8].[ext]\',\n  },\n},`, `96535371335741260000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// "url" loader works just like "file" loader but it also embeds</span>\n<span class="token comment">// assets smaller than specified size as data URLs to avoid requests.</span>\n<span class="token punctuation">{</span>\n  test<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token regex">/\\.bmp$/</span><span class="token punctuation">,</span> <span class="token regex">/\\.gif$/</span><span class="token punctuation">,</span> <span class="token regex">/\\.jpe?g$/</span><span class="token punctuation">,</span> <span class="token regex">/\\.png$/</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n  loader<span class="token punctuation">:</span> require<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">\'url-loader\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n  options<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    limit<span class="token punctuation">:</span> <span class="token number">10000</span><span class="token punctuation">,</span>\n    name<span class="token punctuation">:</span> <span class="token string">\'static/media/[name].[hash:8].[ext]\'</span><span class="token punctuation">,</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>image-webpack-loader 这是一个可以通过设置质量参数来压缩图片的插件，但个人觉得在实际开发中并不会经常使用，图片一般是 UI 提供，一般来说，他们是不会同意改变图片的质量。</p>\n<h3 id="资源私有化"><a href="#%E8%B5%84%E6%BA%90%E7%A7%81%E6%9C%89%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>资源私有化</h3>\n<p>以这种方式加载资源，你可以以更直观的方式将模块和资源组合在一起。无需依赖于含有全部资源的 /assets 目录，而是将资源与代码组合在一起。例如，类似这样的结构会非常有用</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="81808241093605310000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`- |- /assets\n+ |– /components\n+ |  |– /my-component\n+ |  |  |– index.jsx\n+ |  |  |– index.css\n+ |  |  |– icon.svg\n+ |  |  |– img.png`, `81808241093605310000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">- |- /assets\n+ |– /components\n+ |  |– /my-component\n+ |  |  |– index.jsx\n+ |  |  |– index.css\n+ |  |  |– icon.svg\n+ |  |  |– img.png</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>当然，这种选择见仁见智</p>\n<h3 id="tree-shaking"><a href="#tree-shaking" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Tree-Shaking</h3>\n<p>前端中的 tree-shaking 就是将一些无关的代码删掉不打包。在 Webpack 项目中，我们通常会引用很多文件，但实际上我们只引用了其中的某些模块，但却需要引入整个文件进行打包，会导致我们的打包结果变得很大，通过 tree-shaking 将没有使用的模块摇掉，这样来达到删除无用代码的目的。</p>\n<p>Tree-Shaking 的原理可以参考<a href="https://juejin.cn/post/6844903544756109319" target="_blank" rel="nofollow noreferrer noopener">这篇文章</a></p>\n<p>归纳起来就是</p>\n<blockquote>\n<ol>\n<li>ES6 的模块引入是静态分析的，故而可以在编译时正确判断到底加载了什么代码。</li>\n<li>分析程序流，判断哪些变量未被使用、引用，进而删除此代码</li>\n</ol>\n</blockquote>\n<p><a href="https://segmentfault.com/a/1190000012794598" target="_blank" rel="nofollow noreferrer noopener">Tree-Shaking 不起作用，代码没有被删？</a></p>\n<p>归纳起来就是</p>\n<blockquote>\n<p>因为 Babel 的转译，使得引用包的代码有了副作用，而副作用会导致 Tree-Shaking 失效。</p>\n</blockquote>\n<p>Webpack 4 默认启用了 Tree Shaking。对副作用进行了消除，以下是在 4.19.1 的实验</p>\n<p>index.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="84430027051754930000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import { cube } from \'./math.js\';\n\nconsole.log(cube(5));`, `84430027051754930000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> cube <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'./math.js\'</span><span class="token punctuation">;</span>\n\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">cube</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>math.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="21019948249962450000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 不打包 square\nexport class square {\n  constructor() {\n    console.log(\'square\');\n  }\n}\n\nexport class cube {\n  constructor(x) {\n    return x * x * x;\n  }\n}`, `21019948249962450000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 不打包 square</span>\n<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">square</span> <span class="token punctuation">{</span>\n  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'square\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">cube</span> <span class="token punctuation">{</span>\n  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> x <span class="token operator">*</span> x <span class="token operator">*</span> x<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="25122934978108980000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// babel 编译后，同不打包\n\'use strict\';\n\nObject.defineProperty(exports, \'__esModule\', {\n  value: true\n});\nexports.cube = cube;\n\nfunction _classCallCheck(instance, Constructor) {\n  if (!(instance instanceof Constructor)) {\n    throw new TypeError(\'Cannot call a class as a function\');\n  }\n}\n\nvar square = (exports.square = function square() {\n  _classCallCheck(this, square);\n\n  console.log(\'square\');\n});\n\nfunction cube(x) {\n  console.log(\'cube\');\n  return x * x * x;\n}`, `25122934978108980000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// babel 编译后，同不打包</span>\n<span class="token string">\'use strict\'</span><span class="token punctuation">;</span>\n\nObject<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>exports<span class="token punctuation">,</span> <span class="token string">\'__esModule\'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>\n  value<span class="token punctuation">:</span> <span class="token boolean">true</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nexports<span class="token punctuation">.</span>cube <span class="token operator">=</span> cube<span class="token punctuation">;</span>\n\n<span class="token keyword">function</span> <span class="token function">_classCallCheck</span><span class="token punctuation">(</span><span class="token parameter">instance<span class="token punctuation">,</span> Constructor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>instance <span class="token keyword">instanceof</span> <span class="token class-name">Constructor</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">\'Cannot call a class as a function\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">var</span> square <span class="token operator">=</span> <span class="token punctuation">(</span>exports<span class="token punctuation">.</span><span class="token function-variable function">square</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">square</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token function">_classCallCheck</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> square<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'square\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">function</span> <span class="token function">cube</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'cube\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> x <span class="token operator">*</span> x <span class="token operator">*</span> x<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="8284137072746644000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 不打包\nexport function square(x) {\n  console.log(\'square\');\n  return x.a;\n}\n\nexport function cube(x) {\n  return x * x * x;\n}`, `8284137072746644000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 不打包</span>\n<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">square</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'square\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> x<span class="token punctuation">.</span>a<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">cube</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> x <span class="token operator">*</span> x <span class="token operator">*</span> x<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="16040293465196775000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// wow 被打包\nexport function square() {\n  console.log(\'square\');\n  return x.a;\n}\n\nsquare({ a: 1 });\n\nexport function cube() {\n  return x * x * x;\n}`, `16040293465196775000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// wow 被打包</span>\n<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">square</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'square\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> x<span class="token punctuation">.</span>a<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token function">square</span><span class="token punctuation">(</span><span class="token punctuation">{</span> a<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">cube</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> x <span class="token operator">*</span> x <span class="token operator">*</span> x<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="sourcemap"><a href="#sourcemap" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>sourcemap</h3>\n<p>简单说，Source map 就是一个信息文件，里面储存着位置信息。也就是说，转换后的代码的每一个位置，所对应的转换前的位置。</p>\n<p>有了它，出错的时候，除错工具将直接显示原始代码，而不是转换后的代码，这无疑给开发者带来了很大方便。</p>\n<p>webpack 中的 devtool 配置项可以设置 sourcemap，可以参考官方文档，然而 devtool 的许多选项都讲的不是很清楚，这里推荐该<a href="https://juejin.cn/post/6844903450644316174" target="_blank" rel="nofollow noreferrer noopener">文章</a>，讲的比较详细</p>\n<p>要注意，避免在生产中使用 <code class="language-text">inline-*</code> 和 <code class="language-text">eval-*</code>，因为它们可以增加 bundle 大小，并降低整体性能。</p>\n<h3 id="模块热替换"><a href="#%E6%A8%A1%E5%9D%97%E7%83%AD%E6%9B%BF%E6%8D%A2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>模块热替换</h3>\n<p>热替换这一块目前大多数都是用的 webpack-dev-middleware 插件配合服务器使用的，而官方提供的 watch 模式反而比较少用，当然 webpack-dev-middleware 的底层监听 watch mode</p>\n<p>至于为什么不直接使用 watch 模式，则是 webpack-dev-middleware 快速编译，走内存；只依赖 webpack 的 watch mode 来监听文件变更，自动打包、每次变更都将新文件打包到本地，就会很慢。</p>\n<h3 id="defineplugin"><a href="#defineplugin" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>DefinePlugin</h3>\n<p>webpack.DefinePlugin 定义环境变量 process.env，这在实际开发中比较常用，参考 create-react-app 中的代码如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="84308836164758600000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// Makes some environment variables available to the JS code, for example:\n// if (process.env.NODE_ENV === \'development\') { ... }. See \\`./env.js\\`.\nnew webpack.DefinePlugin(env.stringified)`, `84308836164758600000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// Makes some environment variables available to the JS code, for example:</span>\n<span class="token comment">// if (process.env.NODE_ENV === \'development\') { ... }. See `./env.js`.</span>\n<span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>DefinePlugin</span><span class="token punctuation">(</span>env<span class="token punctuation">.</span>stringified<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>不过，要注意不能在 config 中使用，因为</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="88069007420632660000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`process.env.NODE_ENV === \'production\' ? \'[name].[hash].bundle.js\' : \'[name].bundle.js\';`, `88069007420632660000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">\'production\'</span> <span class="token operator">?</span> <span class="token string">\'[name].[hash].bundle.js\'</span> <span class="token punctuation">:</span> <span class="token string">\'[name].bundle.js\'</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<blockquote>\n<p>NODE_ENV is set in the compiled code, not in the webpack.config.js file. You should not use enviroment variables in your configuration. Pass options via —env.option abc and export a function from the webpack.config.js.</p>\n</blockquote>\n<p>大致意思就是 NODE_ENV 是设置在 compiled 里面，而不是 config 文件里。</p>\n<h3 id="extracttextwebpackplugin"><a href="#extracttextwebpackplugin" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ExtractTextWebpackPlugin</h3>\n<p>ExtractTextWebpackPlugin 将 css 抽取成单独文件，可以通过这种方式配合后端对 css 文件进行缓存。</p>\n<h3 id="splitchunksplugin"><a href="#splitchunksplugin" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>SplitChunksPlugin</h3>\n<p>webpack4 的代码分割插件。</p>\n<p>webpack4 中支持了零配置的特性，同时对块打包也做了优化，CommonsChunkPlugin 已经被移除了，现在是使用 optimization.splitChunks 代替。SplitChunksPlugin 的配置有几个需要比较关注一下</p>\n<ul>\n<li>async: 默认值， 将按需引用的模块打包</li>\n<li>initial: 分开优化打包异步和非异步模块</li>\n<li>all: all 会把异步和非异步同时进行优化打包。也就是说 moduleA 在 indexA 中异步引入，indexB 中同步引入，initial 下 moduleA 会出现在两个打包块中，而 all 只会出现一个。</li>\n</ul>\n<p>使用 cacheGroups 可以自定义配置打包块。</p>\n<h3 id="动态引入"><a href="#%E5%8A%A8%E6%80%81%E5%BC%95%E5%85%A5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>动态引入</h3>\n<p>利用动态引入的文件打包成另一个包并懒加载它，其与 SplitChunksPlugin 的 cacheGroups 区别：</p>\n<ul>\n<li>Bundle splitting：实际上就是创建多个更小的文件，并行加载，以获得更好的缓存效果；主要的作用就是使浏览器并行下载，提高下载速度。并且运用浏览器缓存，只有代码被修改，文件名中的哈希值改变了才会去再次加载</li>\n<li>Code splitting：只加载用户最需要的部分，其余的代码都遵从懒加载的策略；主要的作用就是加快页面加载速度，不加载不必要加载的东西。</li>\n</ul>\n<p>参考代码：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="33306854615114090000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import _ from \'lodash\';\n\nfunction component() {\n  var element = document.createElement(\'div\');\n  var button = document.createElement(\'button\');\n  var br = document.createElement(\'br\');\n\n  button.innerHTML = \'Click me and look at the console!\';\n  element.innerHTML = _.join([\'Hello\', \'webpack\'], \' \');\n  element.appendChild(br);\n  element.appendChild(button);\n\n  // Note that because a network request is involved, some indication\n  // of loading would need to be shown in a production-level site/app.\n  button.onclick = (e) =>\n    import(/* webpackChunkName: &quot;print&quot; */ \'./print\').then((module) => {\n      var print = module.default;\n\n      print();\n    });\n\n  return element;\n}\n\ndocument.body.appendChild(component());`, `33306854615114090000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> _ <span class="token keyword">from</span> <span class="token string">\'lodash\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">function</span> <span class="token function">component</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> element <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">\'div\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> button <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">\'button\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> br <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">\'br\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  button<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">\'Click me and look at the console!\'</span><span class="token punctuation">;</span>\n  element<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'Hello\'</span><span class="token punctuation">,</span> <span class="token string">\'webpack\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">\' \'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  element<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>br<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  element<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>button<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// Note that because a network request is involved, some indication</span>\n  <span class="token comment">// of loading would need to be shown in a production-level site/app.</span>\n  button<span class="token punctuation">.</span><span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=></span>\n    <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token comment">/* webpackChunkName: "print" */</span> <span class="token string">\'./print\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">module</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">var</span> print <span class="token operator">=</span> module<span class="token punctuation">.</span>default<span class="token punctuation">;</span>\n\n      <span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">return</span> element<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\ndocument<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span><span class="token function">component</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<blockquote>\n<p>注意当调用 ES6 模块的 import() 方法（引入模块）时，必须指向模块的 .default 值，因为它才是 promise 被处理后返回的实际的 module 对象。</p>\n</blockquote>\n<h3 id="缓存-runtimechunk"><a href="#%E7%BC%93%E5%AD%98-runtimechunk" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>缓存 runtimeChunk</h3>\n<p>因为 webpack 会把运行时代码放到最后的一个 bundle 中，所以即使我们修改了其他文件的代码，最后的一个 bundle 的 hash 也会改变，runtimeChunk 是把运行时代码单独提取出来的配置。这样就有利于我们和后端配合缓存文件。</p>\n<ul>\n<li>single: 所有入口共享一个生成的 runtimeChunk</li>\n<li>true/mutiple: 每个入口生成一个单独的 runtimeChunk</li>\n</ul>\n<h3 id="模块标识符"><a href="#%E6%A8%A1%E5%9D%97%E6%A0%87%E8%AF%86%E7%AC%A6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>模块标识符</h3>\n<p>有时候我们只是添加了个文件 print.js， 并在 index 引入</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="23981110366577705000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import Print from \'./print\';`, `23981110366577705000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> Print <span class="token keyword">from</span> <span class="token string">\'./print\'</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>打包的时候，期望只有 runtime 和 main 两个 bundle 的 hash 发生改变，但是通常所有 bundle 都发生了变化，因为每个 module.id 会基于默认的解析顺序(resolve order)进行增量。也就是说，当解析顺序发生变化，ID 也会随之改变。</p>\n<p>可以使用两个插件来解决这个问题。第一个插件是 NamedModulesPlugin，将使用模块的路径，而不是数字标识符。虽然此插件有助于在开发过程中输出结果的可读性，然而执行时间会长一些。第二个选择是使用 HashedModuleIdsPlugin。</p>\n<h3 id="provideplugin"><a href="#provideplugin" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ProvidePlugin</h3>\n<p>通过 ProvidePlugin 处理全局变量，以及其他更细粒度的<a href="https://www.webpackjs.com/guides/shimming/" target="_blank" rel="nofollow noreferrer noopener">处理</a></p>\n<h3 id="polyfills-的处理"><a href="#polyfills-%E7%9A%84%E5%A4%84%E7%90%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>polyfills 的处理</h3>\n<p>首先了解一下 polyfills， 虽然在 webpack 中能够使用 es6\\es7 等的 API，但并不代表编译器支持这些 API，所以通常我们会用 polyfills 来自定义一个 API。</p>\n<p>那么在 webpack 中，一般是使用 babel-polyfill VS babel-runtime VS babel-preset-env 等来支持这些 API，而这三种怎么选择也是一个问题。</p>\n<p>在真正进入主题之前，我们先看一个 preset-env 的配置项，同时也是 package.json 中的一个配置项 browserslist</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="82306959211986220000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`{\n  &quot;browserslist&quot;: [&quot;last 1 version&quot;, &quot;> 1%&quot;, &quot;maintained node versions&quot;, &quot;not dead&quot;]\n}`, `82306959211986220000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="json"\n              >\n                <span class="gatsby-code-button-language">json</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="json"><pre style="counter-reset: linenumber NaN" class="language-json line-numbers"><code class="language-json"><span class="token punctuation">{</span>\n  <span class="token property">"browserslist"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"last 1 version"</span><span class="token punctuation">,</span> <span class="token string">"> 1%"</span><span class="token punctuation">,</span> <span class="token string">"maintained node versions"</span><span class="token punctuation">,</span> <span class="token string">"not dead"</span><span class="token punctuation">]</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>根据这个配置，preset-env 或者 postcss 等会根据你的参数支持不同的 polyfills，具体的参数配置参考该<a href="https://juejin.cn/post/6844903669524086797" target="_blank" rel="nofollow noreferrer noopener">文章</a></p>\n<ul>\n<li>babel-polyfill 只需要引入一次，但会重写一些原生的已支持的方法，而且体积很大。</li>\n<li>transform-runtime 是利用 plugin 自动识别并替换代码中的新特性，你不需要再引入，只需要装好 babel-runtime 和 配好 plugin 就可以了。好处是按需替换，检测到你需要哪个，就引入哪个 polyfill，值得注意的是，instance 上新添加的一些方法，babel-plugin-transform-runtime 是没有做处理的，比如 数组的 includes, filter, fill 等</li>\n<li>babel-preset-env 根据当前的运行环境，自动确定你需要的 plugins 和 polyfills。通过各个 es 标准 feature 在不同浏览器以及 node 版本的支持情况，再去维护一个 feature 跟 plugins 之间的映射关系，最终确定需要的 plugins。</li>\n</ul>\n<h3 id="后编译"><a href="#%E5%90%8E%E7%BC%96%E8%AF%91" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>后编译</h3>\n<p>日常我们引用的 Npm 包都是编译好的，这样带来的方便的同时也暴露了一些问题。</p>\n<p>代码冗余：一般来说，这些 NPM 包也是基于 ES2015+ 开发的，每个包都需要经过 babel 编译发布后才能被主应用使用，而这个编译过程往往会附加很多“编译代码”；每个包都会有一些相同的编译代码，这就造成大量代码的冗余，并且这部分冗余代码是不能通过 Tree Shaking 等技术去除掉的。</p>\n<p>非必要的依赖：考虑到组件库的场景，通常我们为了方便一股脑引入了所有组件；但实际情况下对于一个应用而言可能只是用到了部分组件，此时如果全部引入，也会造成代码冗余。</p>\n<p>所以我们自己的公司组件可以采用后编译的形式，即发布的是未经编译的 npm 包，在项目构建时才编译，我们公司采用的也是这种做法，因为我们的包都在一个目录下，所以不用考虑递归编译的问题。</p>\n<h3 id="设置环境变量"><a href="#%E8%AE%BE%E7%BD%AE%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>设置环境变量</h3>\n<p>这个比较简单，直接看代码或者官方文档即可</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="68058340640783040000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`webpack --env.NODE_ENV=local --env.production --progress`, `68058340640783040000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">webpack --env.NODE_ENV<span class="token operator">=</span>local --env.production --progress</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h3 id="其他插件"><a href="#%E5%85%B6%E4%BB%96%E6%8F%92%E4%BB%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>其他插件</h3>\n<ul>\n<li>CompressionWebpackPlugin 将文件压缩 文件大小减小很多 需要后端协助配置</li>\n<li>mini-css-extract-plugin 将 CSS 分离出来</li>\n<li>wbepack.IgnorePlugin 忽略匹配的模块</li>\n<li>uglifyjs-webpack-plugin 代码丑化，webpack4 的 mode（product）自动配置</li>\n<li>optimize-css-assets-webpack-plugincss 压缩</li>\n<li>webpack-md5-hash 使你的 chunk 根据内容生成 md5，用这个 md5 取代 webpack chunkhash。</li>\n<li>dllPlugin 提高构建速度</li>\n</ul>\n<h1 id="插件机制"><a href="#%E6%8F%92%E4%BB%B6%E6%9C%BA%E5%88%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>插件机制</h1>\n<h2 id="tapable"><a href="#tapable" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Tapable</h2>\n<p>Webpack 的插件机制依赖于一个核心的库 Tapable。</p>\n<h3 id="tapable-是什么"><a href="#tapable-%E6%98%AF%E4%BB%80%E4%B9%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Tapable 是什么</h3>\n<p>tapable 是一个类似于 nodejs 的 EventEmitter 的库, 主要是控制钩子函数的发布与订阅。当然，tapable 提供的 hook 机制比较全面，分为同步和异步两个大类(异步中又区分异步并行和异步串行)，而根据事件执行的终止条件的不同，由衍生出 Bail/Waterfall/Loop 类型。</p>\n<h3 id="tapable-的使用"><a href="#tapable-%E7%9A%84%E4%BD%BF%E7%94%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Tapable 的使用</h3>\n<h4 id="基本使用"><a href="#%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>基本使用</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="94734236813474050000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const { SyncHook } = require(\'tapable\');\n\n// 创建一个同步 Hook，指定参数\nconst hook = new SyncHook([\'arg1\', \'arg2\']);\n\n// 注册\nhook.tap(\'a\', function(arg1, arg2) {\n  console.log(\'a\');\n});\n\nhook.tap(\'b\', function(arg1, arg2) {\n  console.log(\'b\');\n});\n\nhook.call(1, 2);`, `94734236813474050000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> <span class="token punctuation">{</span> SyncHook <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'tapable\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 创建一个同步 Hook，指定参数</span>\n<span class="token keyword">const</span> hook <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'arg1\'</span><span class="token punctuation">,</span> <span class="token string">\'arg2\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 注册</span>\nhook<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">arg1<span class="token punctuation">,</span> arg2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'a\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nhook<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">\'b\'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">arg1<span class="token punctuation">,</span> arg2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'b\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token function">hook</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="钩子类型"><a href="#%E9%92%A9%E5%AD%90%E7%B1%BB%E5%9E%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>钩子类型</h4>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2021-09-02-11-08-07-97daa6010e75947671c8dd6a6f2953d9-5fd75.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 97.3901098901099%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAIAAAAf7rriAAAACXBIWXMAAAsSAAALEgHS3X78AAACIUlEQVQ4y2NgoAwwAjE7Pz+HmDgjExOyBBs3N7+CIhMrG26tjCDNKjKyflZWbKysyIL8vLzB9vbiAoJwEXTABBat8PS42FBnKCcHEWFiAgm6aGtda2lItLGCK8O0GUTqysrGWVnycHBAvAFRKMLHl2RrrSQmygATIeB54gSRgKSmdnL/lII5i9xzClnY2SGCnHz8QVX1hXMXR7X18ImJq1pYJU2YHtfemzZpholfECIUhOXkvXKLwqobTIPCmFmgYcbGxWUXmxhWXe+WkcslICijpQNU45aW6Z1bpG5tizMIsYULE06lLGxsEmoaisZm/OLiCA1MTCLyCkom5sKy8kAuj5AwUI24sioIqagBPQJVp2hqXr52S8uO/ZEdfaycnBBBEXnF3AXLWnfuz5i9iFtI2DwssmrTzsJla0qWr6vZtNM1Kx+qmZmFRUJFTdHAmE8U2WZGYVk5BT1DIWkZIJdbUEhMURmIxJWUxRWV+UTFGKgAhOUU/Esr41q7LEIjmVhYIILsPDzG3j6uiUn67h5snFyQUGBiBgIWlPCTUFWP7+zPnTnfJT2bGZYNOPn5baNigopKLUPDgQZB0zIzMwOWYGcEGkwwwhiB9mJJ244umhU1XuKS/BBFjOCMoWcoU13vpaEtDQ5UZizWQlzv7a/b0RMoIwfNfZBcZW6l1Dsx1MBEHuxg3A5jZWMREOJEz63MjAJCXBBXoNnHwsICDD4A+2delzfOjGkAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2021 09 02 11 08 07" title="" data-src="/static/2021-09-02-11-08-07-97daa6010e75947671c8dd6a6f2953d9-fee1c.png" data-srcset="/static/2021-09-02-11-08-07-97daa6010e75947671c8dd6a6f2953d9-a67b7.png 200w,\n/static/2021-09-02-11-08-07-97daa6010e75947671c8dd6a6f2953d9-0b187.png 400w,\n/static/2021-09-02-11-08-07-97daa6010e75947671c8dd6a6f2953d9-fee1c.png 800w,\n/static/2021-09-02-11-08-07-97daa6010e75947671c8dd6a6f2953d9-b1a91.png 1200w,\n/static/2021-09-02-11-08-07-97daa6010e75947671c8dd6a6f2953d9-5fd75.png 1456w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2021-09-02-11-08-24-67e3a49b25714423879b47b26d5e39b9-a5264.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 82.09934395501406%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsSAAALEgHS3X78AAACe0lEQVQ4y41US08aURidGWYYBaHRARGGOqC2zkB5jI80PnkKihGhgpI0rTUpBVvS1iY+i5LGLrpp0k033bar9keeXmZQRCVh8eXe3Pnm3O8753yXoigKvQUNiqZ7yaXQb7VCEN0wcFzXRKd9GKOieOecvnsJhQVFxq/qG9DNHxU/cqcX2Dq/hBSevk6sRJZwtr6m7Y0sowVzBXob8AHDYGbYph2wPA+b5IHdM9ZRsdXIwWsdQB/Zm0hVHFk9bhGRWAwPRRfsNuGqWgrKcgyLe2XYRiVIwTCm1rMIrazCH0vqFZnMyB4conB4iiGXG6vVGoqnDVR+/MTa8114HQ4CHIWBZXXAqXQGOfLDkEuEmsniw++/OPjzD8nyWw2QMRjgmlTg9gfAm83axY7xRxA8XvSZB7RqO1q+GQOCDbPZPOYKJW2v0WDk8SSeRCCRAsVykNRpKEtRKJE4XIQaE8nhObYNOF/YwfbJOQaJ0vLiMqKvXiP6Yg9TmQ0ties3IU7OSid1vKzuo0ZaLda/YPfbd4TiKS2HZw1tQHl+EXP5AsxDAiZmn2KhWMICucRHuL3dgSAIyH48RO64ju2LS/gS9wCKkzLURBIWm/1eDzbVDibTCBGu7/vOMkR1hm4Dzmw8w9ZxA87Hsi4CUYshVqJJaC2bTEiV97H5/hOCahhjig9SIAhvSMXgyAiMzG0fWliE1ZGeRjAWXUbx6AybR5+x0/iKQCzRHs1rDn1OVGoRYg+mK9BVtQaaQrr6DnkiYpNDf4vDG3Pe6+PQAiae1H04AUlWYGlZq6sP7w6/vq6s+rBdmtE5bkXX16aX8I4LhBqHDkgU1eeW7nh1mvEfJj2Z83rrNUoAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2021 09 02 11 08 24" title="" data-src="/static/2021-09-02-11-08-24-67e3a49b25714423879b47b26d5e39b9-fee1c.png" data-srcset="/static/2021-09-02-11-08-24-67e3a49b25714423879b47b26d5e39b9-a67b7.png 200w,\n/static/2021-09-02-11-08-24-67e3a49b25714423879b47b26d5e39b9-0b187.png 400w,\n/static/2021-09-02-11-08-24-67e3a49b25714423879b47b26d5e39b9-fee1c.png 800w,\n/static/2021-09-02-11-08-24-67e3a49b25714423879b47b26d5e39b9-b1a91.png 1200w,\n/static/2021-09-02-11-08-24-67e3a49b25714423879b47b26d5e39b9-95179.png 1600w,\n/static/2021-09-02-11-08-24-67e3a49b25714423879b47b26d5e39b9-a5264.png 2134w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h5 id="basichook"><a href="#basichook" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>BasicHook</h5>\n<p>执行每一个，不关心函数的返回值，有 SyncHook、AsyncParallelHook、AsyncSeriesHook。</p>\n<h5 id="bailhook"><a href="#bailhook" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>BailHook</h5>\n<p>顺序执行 Hook，遇到第一个结果 result!==undefined 则返回，不再继续执行。有：SyncBailHook、AsyncSeriseBailHook, AsyncParallelBailHook。</p>\n<p>什么样的场景下会使用到 BailHook 呢？设想如下一个例子：假设我们有一个模块 M，如果它满足 A 或者 B 或者 C 三者任何一个条件，就将其打包为一个单独的。这里的 A、B、C 不存在先后顺序，那么就可以使用 AsyncParallelBailHook 来解决:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="99068298251722180000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`x.hooks.拆分模块的Hook.tap(\'A\', () => {\n  if (A 判断条件满足) {\n    return true\n  }\n})\nx.hooks.拆分模块的Hook.tap(\'B\', () => {\n  if (B 判断条件满足) {\n    return true\n  }\n})\nx.hooks.拆分模块的Hook.tap(\'C\', () => {\n  if (C 判断条件满足) {\n    return true\n  }\n})`, `99068298251722180000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">x<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>拆分模块的Hook<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">\'A\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">A</span> 判断条件满足<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token boolean">true</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span>\nx<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>拆分模块的Hook<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">\'B\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">B</span> 判断条件满足<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token boolean">true</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span>\nx<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>拆分模块的Hook<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">\'C\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">C</span> 判断条件满足<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token boolean">true</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果 A 中返回为 true，那么就无须再去判断 B 和 C。但是当 A、B、C 的校验，需要严格遵循先后顺序时，就需要使用有顺序的 SyncBailHook(A、B、C 是同步函数时使用) 或者 AsyncSeriseBailHook(A、B、C 是异步函数时使用)。</p>\n<h5 id="waterfallhook"><a href="#waterfallhook" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>WaterfallHook</h5>\n<p>类似于 reduce，如果前一个 Hook 函数的结果 result !== undefined，则 result 会作为后一个 Hook 函数的第一个参数。既然是顺序执行，那么就只有 Sync 和 AsyncSeries 类中提供这个 Hook：SyncWaterfallHook，AsyncSeriesWaterfallHook</p>\n<p>当一个数据，需要经过 A，B，C 三个阶段的处理得到最终结果，并且 A 中如果满足条件 a 就处理，否则不处理，B 和 C 同样，那么可以使用如下</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="40441839151291140000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`x.hooks.tap(\'A\', (data) => {\n  if (满足 A 需要处理的条件) {\n    // 处理数据 data\n    return data\n  } else {\n    return\n  }\n})\nx.hooks.tap(\'B\', (data) => {\n  if (满足B需要处理的条件) {\n    // 处理数据 data\n    return data\n  } else {\n    return\n  }\n})\nx.hooks.tap(\'C\', (data) => {\n  if (满足 C 需要处理的条件) {\n    // 处理数据 data\n    return data\n  } else {\n    return\n  }\n})`, `40441839151291140000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">x<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">\'A\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>满足 <span class="token constant">A</span> 需要处理的条件<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 处理数据 data</span>\n    <span class="token keyword">return</span> data\n  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span>\nx<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">\'B\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>满足<span class="token constant">B</span>需要处理的条件<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 处理数据 data</span>\n    <span class="token keyword">return</span> data\n  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span>\nx<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">\'C\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>满足 <span class="token constant">C</span> 需要处理的条件<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 处理数据 data</span>\n    <span class="token keyword">return</span> data\n  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h5 id="loophook"><a href="#loophook" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>LoopHook</h5>\n<p>不停的循环执行 Hook，直到所有函数结果 result === undefined。同样的，由于对串行性有依赖，所以只有 SyncLoopHook 和 AsyncSeriseLoopHook</p>\n<h3 id="tapable-的源码分析"><a href="#tapable-%E7%9A%84%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Tapable 的源码分析</h3>\n<p>Tapable 基本逻辑是，先通过类实例的 tap 方法注册对应 Hook 的处理函数， 这里直接分析 sync 同步钩子的主要流程，其他的异步钩子和拦截器等就不赘述了。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="32294438893431665000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const hook = new SyncHook([\'arg1\', \'arg2\']);`, `32294438893431665000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> hook <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'arg1\'</span><span class="token punctuation">,</span> <span class="token string">\'arg2\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>从该句代码，作为源码分析的入口</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="60084708604191660000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class SyncHook extends Hook {\n  // 错误处理，防止调用者调用异步钩子\n  tapAsync() {\n    throw new Error(\'tapAsync is not supported on a SyncHook\');\n  }\n  // 错误处理，防止调用者调用 promise 钩子\n  tapPromise() {\n    throw new Error(\'tapPromise is not supported on a SyncHook\');\n  }\n  // 核心实现\n  compile(options) {\n    factory.setup(this, options);\n    return factory.create(options);\n  }\n}`, `60084708604191660000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">SyncHook</span> <span class="token keyword">extends</span> <span class="token class-name">Hook</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 错误处理，防止调用者调用异步钩子</span>\n  <span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">\'tapAsync is not supported on a SyncHook\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token comment">// 错误处理，防止调用者调用 promise 钩子</span>\n  <span class="token function">tapPromise</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">\'tapPromise is not supported on a SyncHook\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token comment">// 核心实现</span>\n  <span class="token function">compile</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    factory<span class="token punctuation">.</span><span class="token function">setup</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">return</span> factory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>从类 SyncHook 看到，他是继承于一个基类 Hook，他的核心实现 compile 等会再讲，我们先看看基类 Hook</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="25945579990878120000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 变量的初始化\nconstructor(args) {\n if (!Array.isArray(args)) args = [];\n this._args = args;\n this.taps = [];\n this.interceptors = [];\n this.call = this._call;\n this.promise = this._promise;\n this.callAsync = this._callAsync;\n this._x = undefined;\n}`, `25945579990878120000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 变量的初始化</span>\n<span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span> args <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n <span class="token keyword">this</span><span class="token punctuation">.</span>_args <span class="token operator">=</span> args<span class="token punctuation">;</span>\n <span class="token keyword">this</span><span class="token punctuation">.</span>taps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n <span class="token keyword">this</span><span class="token punctuation">.</span>interceptors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n <span class="token keyword">this</span><span class="token punctuation">.</span>call <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_call<span class="token punctuation">;</span>\n <span class="token keyword">this</span><span class="token punctuation">.</span>promise <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_promise<span class="token punctuation">;</span>\n <span class="token keyword">this</span><span class="token punctuation">.</span>callAsync <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_callAsync<span class="token punctuation">;</span>\n <span class="token keyword">this</span><span class="token punctuation">.</span>_x <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>初始化完成后，通常会注册一个事件：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="23352627254841217000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 注册\nhook.tap(\'a\', function(arg1, arg2) {\n  console.log(\'a\');\n});\n\nhook.tap(\'b\', function(arg1, arg2) {\n  console.log(\'b\');\n});`, `23352627254841217000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 注册</span>\nhook<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">arg1<span class="token punctuation">,</span> arg2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'a\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nhook<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">\'b\'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">arg1<span class="token punctuation">,</span> arg2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'b\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>很明显这两个语句都会调用基类中的 tap 方法：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="9451864991394388000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`tap(options, fn) {\n    // 参数处理\n if (typeof options === &quot;string&quot;) options = { name: options };\n if (typeof options !== &quot;object&quot; || options === null)\n  throw new Error(\n   &quot;Invalid arguments to tap(options: Object, fn: function)&quot;\n  );\n options = Object.assign({ type: &quot;sync&quot;, fn: fn }, options);\n if (typeof options.name !== &quot;string&quot; || options.name === &quot;&quot;)\n  throw new Error(&quot;Missing name for tap&quot;);\n // 执行拦截器的 register 函数， 比较简单不分析\n options = this._runRegisterInterceptors(options);\n // 处理注册事件\n this._insert(options);\n}`, `9451864991394388000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token function">tap</span><span class="token punctuation">(</span><span class="token parameter">options<span class="token punctuation">,</span> fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 参数处理</span>\n <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> options <span class="token operator">===</span> <span class="token string">"string"</span><span class="token punctuation">)</span> options <span class="token operator">=</span> <span class="token punctuation">{</span> name<span class="token punctuation">:</span> options <span class="token punctuation">}</span><span class="token punctuation">;</span>\n <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> options <span class="token operator">!==</span> <span class="token string">"object"</span> <span class="token operator">||</span> options <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span>\n  <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>\n   <span class="token string">"Invalid arguments to tap(options: Object, fn: function)"</span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n options <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">"sync"</span><span class="token punctuation">,</span> fn<span class="token punctuation">:</span> fn <span class="token punctuation">}</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>\n <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> options<span class="token punctuation">.</span>name <span class="token operator">!==</span> <span class="token string">"string"</span> <span class="token operator">||</span> options<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">""</span><span class="token punctuation">)</span>\n  <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"Missing name for tap"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n <span class="token comment">// 执行拦截器的 register 函数， 比较简单不分析</span>\n options <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_runRegisterInterceptors</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>\n <span class="token comment">// 处理注册事件</span>\n <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_insert</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>从上面的源码分析， 可以看到 _insert 方法是注册阶段的关键函数， 直接进入该方法内部</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="2380235950001275000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`_insert(item) {\n    // 重置所有的 调用 方法\n this._resetCompilation();\n // 将注册事件排序后放进taps数组\n let before;\n if (typeof item.before === &quot;string&quot;) before = new Set([item.before]);\n else if (Array.isArray(item.before)) {\n  before = new Set(item.before);\n }\n let stage = 0;\n if (typeof item.stage === &quot;number&quot;) stage = item.stage;\n let i = this.taps.length;\n while (i > 0) {\n  i--;\n  const x = this.taps[i];\n  this.taps[i + 1] = x;\n  const xStage = x.stage || 0;\n  if (before) {\n   if (before.has(x.name)) {\n    before.delete(x.name);\n    continue;\n   }\n   if (before.size > 0) {\n    continue;\n   }\n  }\n  if (xStage > stage) {\n   continue;\n  }\n  i++;\n  break;\n }\n this.taps[i] = item;\n}`, `2380235950001275000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token function">_insert</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 重置所有的 调用 方法</span>\n <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_resetCompilation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n <span class="token comment">// 将注册事件排序后放进taps数组</span>\n <span class="token keyword">let</span> before<span class="token punctuation">;</span>\n <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> item<span class="token punctuation">.</span>before <span class="token operator">===</span> <span class="token string">"string"</span><span class="token punctuation">)</span> before <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">[</span>item<span class="token punctuation">.</span>before<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>before<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  before <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>before<span class="token punctuation">)</span><span class="token punctuation">;</span>\n <span class="token punctuation">}</span>\n <span class="token keyword">let</span> stage <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> item<span class="token punctuation">.</span>stage <span class="token operator">===</span> <span class="token string">"number"</span><span class="token punctuation">)</span> stage <span class="token operator">=</span> item<span class="token punctuation">.</span>stage<span class="token punctuation">;</span>\n <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>taps<span class="token punctuation">.</span>length<span class="token punctuation">;</span>\n <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  i<span class="token operator">--</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> x <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>taps<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span>taps<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> x<span class="token punctuation">;</span>\n  <span class="token keyword">const</span> xStage <span class="token operator">=</span> x<span class="token punctuation">.</span>stage <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">;</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>before<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>before<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    before<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">continue</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>before<span class="token punctuation">.</span>size <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">continue</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>xStage <span class="token operator">></span> stage<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">continue</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  i<span class="token operator">++</span><span class="token punctuation">;</span>\n  <span class="token keyword">break</span><span class="token punctuation">;</span>\n <span class="token punctuation">}</span>\n <span class="token keyword">this</span><span class="token punctuation">.</span>taps<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> item<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>_insert 主要是排序 tap 并放入到 taps 数组里面，排序的算法并不是特别复杂，这里就不赘述了，到了这里注册阶段就已经结束了，继续看触发阶段。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="87035847371896000000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`hook.call(1, 2); // 触发函数`, `87035847371896000000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token function">hook</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 触发函数</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>在基类 hook 中有一个初始化过程</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="34086650617557045000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`this.call = this._call;\n\nObject.defineProperties(Hook.prototype, {\n  _call: {\n    value: createCompileDelegate(\'call\', \'sync\'),\n    configurable: true,\n    writable: true\n  },\n  _promise: {\n    value: createCompileDelegate(\'promise\', \'promise\'),\n    configurable: true,\n    writable: true\n  },\n  _callAsync: {\n    value: createCompileDelegate(\'callAsync\', \'async\'),\n    configurable: true,\n    writable: true\n  }\n});`, `34086650617557045000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">this</span><span class="token punctuation">.</span>call <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_call<span class="token punctuation">;</span>\n\nObject<span class="token punctuation">.</span><span class="token function">defineProperties</span><span class="token punctuation">(</span><span class="token class-name">Hook</span><span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n  _call<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    value<span class="token punctuation">:</span> <span class="token function">createCompileDelegate</span><span class="token punctuation">(</span><span class="token string">\'call\'</span><span class="token punctuation">,</span> <span class="token string">\'sync\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    configurable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n    writable<span class="token punctuation">:</span> <span class="token boolean">true</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  _promise<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    value<span class="token punctuation">:</span> <span class="token function">createCompileDelegate</span><span class="token punctuation">(</span><span class="token string">\'promise\'</span><span class="token punctuation">,</span> <span class="token string">\'promise\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    configurable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n    writable<span class="token punctuation">:</span> <span class="token boolean">true</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  _callAsync<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    value<span class="token punctuation">:</span> <span class="token function">createCompileDelegate</span><span class="token punctuation">(</span><span class="token string">\'callAsync\'</span><span class="token punctuation">,</span> <span class="token string">\'async\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    configurable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n    writable<span class="token punctuation">:</span> <span class="token boolean">true</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们可以看出 _call 是由 createCompileDelegate 生成的，往下看</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="59022207257446230000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function createCompileDelegate(name, type) {\n  return function lazyCompileHook(...args) {\n    this[name] = this._createCall(type);\n    return this[name](...args);\n  };\n}`, `59022207257446230000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">createCompileDelegate</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">lazyCompileHook</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">this</span><span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_createCall</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>createCompileDelegate 返回一个名为 lazyCompileHook 的函数，顾名思义即懒编译，直到调用 call 的时候，才会编译出正在的 call 函数。</p>\n<p>createCompileDelegate 也是调用的 _createCall， 而 _createCall 调用了 Compier 函数</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="71423251084688590000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`_createCall(type) {\n return this.compile({\n  taps: this.taps,\n  interceptors: this.interceptors,\n  args: this._args,\n  type: type\n });\n}\ncompile(options) {\n throw new Error(&quot;Abstract: should be overriden&quot;);\n}`, `71423251084688590000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token function">_createCall</span><span class="token punctuation">(</span><span class="token parameter">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n  taps<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>taps<span class="token punctuation">,</span>\n  interceptors<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>interceptors<span class="token punctuation">,</span>\n  args<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_args<span class="token punctuation">,</span>\n  type<span class="token punctuation">:</span> type\n <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token function">compile</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"Abstract: should be overriden"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以看到 compiler 必须由子类重写，返回到 syncHook 的 compile 函数，即我们一开始说的核心方法</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="80149458811497710000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class SyncHookCodeFactory extends HookCodeFactory {\n  content({ onError, onResult, onDone, rethrowIfPossible }) {\n    return this.callTapsSeries({\n      onError: (i, err) => onError(err),\n      onDone,\n      rethrowIfPossible\n    });\n  }\n}\n\nconst factory = new SyncHookCodeFactory();\n\nclass SyncHook extends Hook {\n  compile(options) {\n    factory.setup(this, options);\n    return factory.create(options);\n  }\n}`, `80149458811497710000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">SyncHookCodeFactory</span> <span class="token keyword">extends</span> <span class="token class-name">HookCodeFactory</span> <span class="token punctuation">{</span>\n  <span class="token function">content</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> onError<span class="token punctuation">,</span> onResult<span class="token punctuation">,</span> onDone<span class="token punctuation">,</span> rethrowIfPossible <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">callTapsSeries</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n      <span class="token function-variable function">onError</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">i<span class="token punctuation">,</span> err</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">onError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">,</span>\n      onDone<span class="token punctuation">,</span>\n      rethrowIfPossible\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">const</span> factory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SyncHookCodeFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">class</span> <span class="token class-name">SyncHook</span> <span class="token keyword">extends</span> <span class="token class-name">Hook</span> <span class="token punctuation">{</span>\n  <span class="token function">compile</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    factory<span class="token punctuation">.</span><span class="token function">setup</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">return</span> factory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>关键就在于 SyncHookCodeFactory 和工厂类 HookCodeFactory，先看 setup 函数</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="84731945367476390000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`setup(instance, options) {\n  // 这里的 instance 是 syncHook 实例, 其实就是把 tap 进来的钩子数组给到钩子的 _x 属性里.\n  instance._x = options.taps.map(t => t.fn);\n}`, `84731945367476390000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token function">setup</span><span class="token punctuation">(</span><span class="token parameter">instance<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 这里的 instance 是 syncHook 实例, 其实就是把 tap 进来的钩子数组给到钩子的 _x 属性里.</span>\n  instance<span class="token punctuation">.</span>_x <span class="token operator">=</span> options<span class="token punctuation">.</span>taps<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">t</span> <span class="token operator">=></span> t<span class="token punctuation">.</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后是最关键的 create 函数， 可以看到最后返回的 fn，其实是一个 new Function 动态生成的函数</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="7976043717689030000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`create(options) {\n  // 初始化参数，保存 options 到本对象 this.options，保存 new Hook([&quot;options&quot;]) 传入的参数到 this._args\n  this.init(options);\n  let fn;\n  // 动态构建钩子，这里是抽象层，分同步、异步、promise\n  switch (this.options.type) {\n    // 先看同步\n    case &quot;sync&quot;:\n      // 动态返回一个钩子函数\n      fn = new Function(\n        // 生成函数的参数 no before no after 返回参数字符串 xxx,xxx 在\n        // 注意这里 this.args 返回的是一个字符串,\n        // 在这个例子中是 options\n        this.args(),\n        \'&quot;use strict&quot;;\\n\' +\n          this.header() +\n          this.content({\n            onError: err => \\`throw \\${err};\\n\\`,\n            onResult: result => \\`return \\${result};\\n\\`,\n            onDone: () => &quot;&quot;,\n            rethrowIfPossible: true\n          })\n      );\n      break;\n    case &quot;async&quot;:\n      fn = new Function(\n        this.args({\n          after: &quot;_callback&quot;\n        }),\n        \'&quot;use strict&quot;;\\n\' +\n          this.header() +\n          // 这个 content 调用的是子类类的 content 函数,\n          // 参数由子类传,实际返回的是 this.callTapsSeries() 返回的类容\n          this.content({\n            onError: err => \\`_callback(\\${err});\\n\\`,\n            onResult: result => \\`_callback(null, \\${result});\\n\\`,\n            onDone: () => &quot;_callback();\\n&quot;\n          })\n      );\n      break;\n    case &quot;promise&quot;:\n      let code = &quot;&quot;;\n      code += \'&quot;use strict&quot;;\\n\';\n      code += &quot;return new Promise((_resolve, _reject) => {\\n&quot;;\n      code += &quot;var _sync = true;\\n&quot;;\n      code += this.header();\n      code += this.content({\n        onError: err => {\n          let code = &quot;&quot;;\n          code += &quot;if(_sync)\\n&quot;;\n          code += \\`_resolve(Promise.resolve().then(() => { throw \\${err}; }));\\n\\`;\n          code += &quot;else\\n&quot;;\n          code += \\`_reject(\\${err});\\n\\`;\n          return code;\n        },\n        onResult: result => \\`_resolve(\\${result});\\n\\`,\n        onDone: () => &quot;_resolve();\\n&quot;\n      });\n      code += &quot;_sync = false;\\n&quot;;\n      code += &quot;});\\n&quot;;\n      fn = new Function(this.args(), code);\n      break;\n  }\n  // 把刚才 init 赋的值初始化为 undefined\n  // this.options = undefined;\n  // this._args = undefined;\n  this.deinit();\n\n  return fn;\n}`, `7976043717689030000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token function">create</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 初始化参数，保存 options 到本对象 this.options，保存 new Hook(["options"]) 传入的参数到 this._args</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">let</span> fn<span class="token punctuation">;</span>\n  <span class="token comment">// 动态构建钩子，这里是抽象层，分同步、异步、promise</span>\n  <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 先看同步</span>\n    <span class="token keyword">case</span> <span class="token string">"sync"</span><span class="token punctuation">:</span>\n      <span class="token comment">// 动态返回一个钩子函数</span>\n      fn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token punctuation">(</span>\n        <span class="token comment">// 生成函数的参数 no before no after 返回参数字符串 xxx,xxx 在</span>\n        <span class="token comment">// 注意这里 this.args 返回的是一个字符串,</span>\n        <span class="token comment">// 在这个例子中是 options</span>\n        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">args</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n        <span class="token string">\'"use strict";\\n\'</span> <span class="token operator">+</span>\n          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>\n          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">content</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n            <span class="token function-variable function">onError</span><span class="token punctuation">:</span> <span class="token parameter">err</span> <span class="token operator">=></span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">throw </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>err<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">;\\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n            <span class="token function-variable function">onResult</span><span class="token punctuation">:</span> <span class="token parameter">result</span> <span class="token operator">=></span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">return </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>result<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">;\\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n            <span class="token function-variable function">onDone</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token string">""</span><span class="token punctuation">,</span>\n            rethrowIfPossible<span class="token punctuation">:</span> <span class="token boolean">true</span>\n          <span class="token punctuation">}</span><span class="token punctuation">)</span>\n      <span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">break</span><span class="token punctuation">;</span>\n    <span class="token keyword">case</span> <span class="token string">"async"</span><span class="token punctuation">:</span>\n      fn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token punctuation">(</span>\n        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">args</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n          after<span class="token punctuation">:</span> <span class="token string">"_callback"</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n        <span class="token string">\'"use strict";\\n\'</span> <span class="token operator">+</span>\n          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>\n          <span class="token comment">// 这个 content 调用的是子类类的 content 函数,</span>\n          <span class="token comment">// 参数由子类传,实际返回的是 this.callTapsSeries() 返回的类容</span>\n          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">content</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n            <span class="token function-variable function">onError</span><span class="token punctuation">:</span> <span class="token parameter">err</span> <span class="token operator">=></span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">_callback(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>err<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">);\\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n            <span class="token function-variable function">onResult</span><span class="token punctuation">:</span> <span class="token parameter">result</span> <span class="token operator">=></span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">_callback(null, </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>result<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">);\\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n            <span class="token function-variable function">onDone</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token string">"_callback();\\n"</span>\n          <span class="token punctuation">}</span><span class="token punctuation">)</span>\n      <span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">break</span><span class="token punctuation">;</span>\n    <span class="token keyword">case</span> <span class="token string">"promise"</span><span class="token punctuation">:</span>\n      <span class="token keyword">let</span> code <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>\n      code <span class="token operator">+=</span> <span class="token string">\'"use strict";\\n\'</span><span class="token punctuation">;</span>\n      code <span class="token operator">+=</span> <span class="token string">"return new Promise((_resolve, _reject) => {\\n"</span><span class="token punctuation">;</span>\n      code <span class="token operator">+=</span> <span class="token string">"var _sync = true;\\n"</span><span class="token punctuation">;</span>\n      code <span class="token operator">+=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      code <span class="token operator">+=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">content</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n        <span class="token function-variable function">onError</span><span class="token punctuation">:</span> <span class="token parameter">err</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n          <span class="token keyword">let</span> code <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>\n          code <span class="token operator">+=</span> <span class="token string">"if(_sync)\\n"</span><span class="token punctuation">;</span>\n          code <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">_resolve(Promise.resolve().then(() => { throw </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>err<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">; }));\\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n          code <span class="token operator">+=</span> <span class="token string">"else\\n"</span><span class="token punctuation">;</span>\n          code <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">_reject(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>err<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">);\\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n          <span class="token keyword">return</span> code<span class="token punctuation">;</span>\n        <span class="token punctuation">}</span><span class="token punctuation">,</span>\n        <span class="token function-variable function">onResult</span><span class="token punctuation">:</span> <span class="token parameter">result</span> <span class="token operator">=></span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">_resolve(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>result<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">);\\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n        <span class="token function-variable function">onDone</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token string">"_resolve();\\n"</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      code <span class="token operator">+=</span> <span class="token string">"_sync = false;\\n"</span><span class="token punctuation">;</span>\n      code <span class="token operator">+=</span> <span class="token string">"});\\n"</span><span class="token punctuation">;</span>\n      fn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">args</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> code<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">break</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token comment">// 把刚才 init 赋的值初始化为 undefined</span>\n  <span class="token comment">// this.options = undefined;</span>\n  <span class="token comment">// this._args = undefined;</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">deinit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">return</span> fn<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>最后生成的代码大致如下</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="44058977657292770000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`&quot;use strict&quot;;\nfunction (options) {\n  var _context;\n  var _x = this._x;\n  var _taps = this.taps;\n  var _interterceptors = this.interceptors;\n  // 我们只有一个拦截器所以下面的只会生成一个\n  _interceptors[0].call(options);\n\n  var _tap0 = _taps[0];\n  _interceptors[0].tap(_tap0);\n  var _fn0 = _x[0];\n  _fn0(options);\n  var _tap1 = _taps[1];\n  _interceptors[1].tap(_tap1);\n  var _fn1 = _x[1];\n  _fn1(options);\n  var _tap2 = _taps[2];\n  _interceptors[2].tap(_tap2);\n  var _fn2 = _x[2];\n  _fn2(options);\n  var _tap3 = _taps[3];\n  _interceptors[3].tap(_tap3);\n  var _fn3 = _x[3];\n  _fn3(options);\n}`, `44058977657292770000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token string">"use strict"</span><span class="token punctuation">;</span>\n<span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> _context<span class="token punctuation">;</span>\n  <span class="token keyword">var</span> _x <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_x<span class="token punctuation">;</span>\n  <span class="token keyword">var</span> _taps <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>taps<span class="token punctuation">;</span>\n  <span class="token keyword">var</span> _interterceptors <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>interceptors<span class="token punctuation">;</span>\n  <span class="token comment">// 我们只有一个拦截器所以下面的只会生成一个</span>\n  _interceptors<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">var</span> _tap0 <span class="token operator">=</span> _taps<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  _interceptors<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span>_tap0<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> _fn0 <span class="token operator">=</span> _x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token function">_fn0</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> _tap1 <span class="token operator">=</span> _taps<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  _interceptors<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span>_tap1<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> _fn1 <span class="token operator">=</span> _x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token function">_fn1</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> _tap2 <span class="token operator">=</span> _taps<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  _interceptors<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span>_tap2<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> _fn2 <span class="token operator">=</span> _x<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token function">_fn2</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> _tap3 <span class="token operator">=</span> _taps<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  _interceptors<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span>_tap3<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> _fn3 <span class="token operator">=</span> _x<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token function">_fn3</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>以上就是 Tapabled 的机制，然而本篇的主要对象其实是基于 tapable 实现的 compile 和 compilation 对象。不过由于他们都是基于 tapable，所以介绍的篇幅相对短一点。</p>\n<h2 id="compile"><a href="#compile" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>compile</h2>\n<h3 id="compile-是什么"><a href="#compile-%E6%98%AF%E4%BB%80%E4%B9%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>compile 是什么</h3>\n<p>compiler 对象代表了完整的 webpack 环境配置。这个对象在启动 webpack 时被一次性建立，并配置好所有可操作的设置，包括 options，loader 和 plugin。当在 webpack 环境中应用一个插件时，插件将收到此 compiler 对象的引用。可以使用 compiler 来访问 webpack 的主环境。</p>\n<p>也就是说，compile 是 webpack 的整体环境。</p>\n<h3 id="compile-的内部实现"><a href="#compile-%E7%9A%84%E5%86%85%E9%83%A8%E5%AE%9E%E7%8E%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>compile 的内部实现</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="38139640619516850000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Compiler extends Tapable {\n  constructor(context) {\n    super();\n    this.hooks = {\n      /** @type {SyncBailHook<Compilation>} */\n      shouldEmit: new SyncBailHook([\'compilation\']),\n      /** @type {AsyncSeriesHook<Stats>} */\n      done: new AsyncSeriesHook([\'stats\']),\n      /** @type {AsyncSeriesHook<>} */\n      additionalPass: new AsyncSeriesHook([])\n      /** @type {AsyncSeriesHook<Compiler>} */\n    };\n  }\n}`, `38139640619516850000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Compiler</span> <span class="token keyword">extends</span> <span class="token class-name">Tapable</span> <span class="token punctuation">{</span>\n  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks <span class="token operator">=</span> <span class="token punctuation">{</span>\n      <span class="token comment">/** @type {SyncBailHook&lt;Compilation>} */</span>\n      shouldEmit<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">SyncBailHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'compilation\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n      <span class="token comment">/** @type {AsyncSeriesHook&lt;Stats>} */</span>\n      done<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">AsyncSeriesHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'stats\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n      <span class="token comment">/** @type {AsyncSeriesHook&lt;>} */</span>\n      additionalPass<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">AsyncSeriesHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n      <span class="token comment">/** @type {AsyncSeriesHook&lt;Compiler>} */</span>\n    <span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以看到 Compier 继承了 Tapable, 并且在实例上绑定了一个 hook 对象，使得 Compier 的实例 compier 可以像这样使用</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="15922671907004537000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`compiler.hooks.compile.tapAsync(\'afterCompile\', (compilation, callback) => {\n  console.log(\'This is an example plugin!\');\n  console.log(\'Here’s the \\`compilation\\` object which represents a single build of assets:\', compilation);\n\n  // 使用 webpack 提供的 plugin API 操作构建结果\n  compilation.addModule(/* ... */);\n\n  callback();\n});`, `15922671907004537000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>compile<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token string">\'afterCompile\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">compilation<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'This is an example plugin!\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'Here’s the `compilation` object which represents a single build of assets:\'</span><span class="token punctuation">,</span> compilation<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 使用 webpack 提供的 plugin API 操作构建结果</span>\n  compilation<span class="token punctuation">.</span><span class="token function">addModule</span><span class="token punctuation">(</span><span class="token comment">/* ... */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="compilation"><a href="#compilation" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>compilation</h2>\n<h3 id="什么是-compilation"><a href="#%E4%BB%80%E4%B9%88%E6%98%AF-compilation" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>什么是 compilation</h3>\n<p>compilation 对象代表了一次资源版本构建。当运行 webpack 开发环境中间件时，每当检测到一个文件变化，就会创建一个新的 compilation，从而生成一组新的编译资源。一个 compilation 对象表现了当前的模块资源、编译生成资源、变化的文件、以及被跟踪依赖的状态信息。compilation 对象也提供了很多关键时机的回调，以供插件做自定义处理时选择使用。</p>\n<h3 id="compilation-的实现"><a href="#compilation-%E7%9A%84%E5%AE%9E%E7%8E%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>compilation 的实现</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="10828032552770028000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Compilation extends Tapable {\n  /**\n   * Creates an instance of Compilation.\n   * @param {Compiler} compiler the compiler which created the compilation\n   */\n  constructor(compiler) {\n    super();\n    this.hooks = {\n      /** @type {SyncHook<Module>} */\n      buildModule: new SyncHook([\'module\']),\n      /** @type {SyncHook<Module>} */\n      rebuildModule: new SyncHook([\'module\']),\n      /** @type {SyncHook<Module, Error>} */\n      failedModule: new SyncHook([\'module\', \'error\']),\n      /** @type {SyncHook<Module>} */\n      succeedModule: new SyncHook([\'module\']),\n\n      /** @type {SyncHook<Dependency, string>} */\n      addEntry: new SyncHook([\'entry\', \'name\'])\n      /** @type {SyncHook<Dependency, string, Error>} */\n    };\n  }\n}`, `10828032552770028000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Compilation</span> <span class="token keyword">extends</span> <span class="token class-name">Tapable</span> <span class="token punctuation">{</span>\n  <span class="token comment">/**\n   * Creates an instance of Compilation.\n   * @param {Compiler} compiler the compiler which created the compilation\n   */</span>\n  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks <span class="token operator">=</span> <span class="token punctuation">{</span>\n      <span class="token comment">/** @type {SyncHook&lt;Module>} */</span>\n      buildModule<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'module\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n      <span class="token comment">/** @type {SyncHook&lt;Module>} */</span>\n      rebuildModule<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'module\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n      <span class="token comment">/** @type {SyncHook&lt;Module, Error>} */</span>\n      failedModule<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'module\'</span><span class="token punctuation">,</span> <span class="token string">\'error\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n      <span class="token comment">/** @type {SyncHook&lt;Module>} */</span>\n      succeedModule<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'module\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n\n      <span class="token comment">/** @type {SyncHook&lt;Dependency, string>} */</span>\n      addEntry<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'entry\'</span><span class="token punctuation">,</span> <span class="token string">\'name\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n      <span class="token comment">/** @type {SyncHook&lt;Dependency, string, Error>} */</span>\n    <span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>具体参考上面提到的 compiler 实现。</p>\n<h2 id="编写一个插件"><a href="#%E7%BC%96%E5%86%99%E4%B8%80%E4%B8%AA%E6%8F%92%E4%BB%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>编写一个插件</h2>\n<p>了解到 tapable\\compiler\\compilation 之后， 再来看插件的实现就不再一头雾水了</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="19152638355826920000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class MyExampleWebpackPlugin {\n  // 定义 \\`apply\\` 方法\n  apply(compiler) {\n    // 指定要追加的事件钩子函数\n    compiler.hooks.compile.tapAsync(\'afterCompile\', (compilation, callback) => {\n      console.log(\'This is an example plugin!\');\n      console.log(\'Here’s the \\`compilation\\` object which represents a single build of assets:\', compilation);\n\n      // 使用 webpack 提供的 plugin API 操作构建结果\n      compilation.addModule(/* ... */);\n\n      callback();\n    });\n  }\n}`, `19152638355826920000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">MyExampleWebpackPlugin</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 定义 `apply` 方法</span>\n  <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 指定要追加的事件钩子函数</span>\n    compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>compile<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token string">\'afterCompile\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">compilation<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'This is an example plugin!\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'Here’s the `compilation` object which represents a single build of assets:\'</span><span class="token punctuation">,</span> compilation<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token comment">// 使用 webpack 提供的 plugin API 操作构建结果</span>\n      compilation<span class="token punctuation">.</span><span class="token function">addModule</span><span class="token punctuation">(</span><span class="token comment">/* ... */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以看到其实就是在 apply 中传入一个 Compiler 实例，然后基于该实例注册事件，compilation 同理，最后 webpack 会在各流程执行 call 方法。</p>\n<h2 id="compiler-和-compilation-一些比较重要的事件钩子"><a href="#compiler-%E5%92%8C-compilation-%E4%B8%80%E4%BA%9B%E6%AF%94%E8%BE%83%E9%87%8D%E8%A6%81%E7%9A%84%E4%BA%8B%E4%BB%B6%E9%92%A9%E5%AD%90" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>compiler 和 compilation 一些比较重要的事件钩子</h2>\n<h3 id="compier"><a href="#compier" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>compier</h3>\n<table>\n<thead>\n<tr>\n<th align="left">事件钩子</th>\n<th align="left">触发时机</th>\n<th align="left">参数</th>\n<th align="left">类型</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align="left">entry-option</td>\n<td align="left">初始化 option</td>\n<td align="left">-</td>\n<td align="left">SyncBailHook</td>\n</tr>\n<tr>\n<td align="left">run</td>\n<td align="left">开始编译</td>\n<td align="left">compiler</td>\n<td align="left">AsyncSeriesHook</td>\n</tr>\n<tr>\n<td align="left">compile</td>\n<td align="left">真正开始的编译，在创建 compilation 对象之前</td>\n<td align="left">compilation</td>\n<td align="left">SyncHook</td>\n</tr>\n<tr>\n<td align="left">compilation</td>\n<td align="left">生成好了 compilation 对象，可以操作这个对象啦</td>\n<td align="left">compilation</td>\n<td align="left">SyncHook</td>\n</tr>\n<tr>\n<td align="left">make</td>\n<td align="left">从 entry 开始递归分析依赖，准备对每个模块进行 build</td>\n<td align="left">compilation</td>\n<td align="left">AsyncParallelHook</td>\n</tr>\n<tr>\n<td align="left">after-compile</td>\n<td align="left">编译 build 过程结束</td>\n<td align="left">compilation</td>\n<td align="left">AsyncSeriesHook</td>\n</tr>\n<tr>\n<td align="left">emit</td>\n<td align="left">在将内存中 assets 内容写到磁盘文件夹之前</td>\n<td align="left">compilation</td>\n<td align="left">AsyncSeriesHook</td>\n</tr>\n<tr>\n<td align="left">after-emit</td>\n<td align="left">在将内存中 assets 内容写到磁盘文件夹之后</td>\n<td align="left">compilation</td>\n<td align="left">AsyncSeriesHook</td>\n</tr>\n<tr>\n<td align="left">done</td>\n<td align="left">完成所有的编译过程</td>\n<td align="left">stats</td>\n<td align="left">AsyncSeriesHook</td>\n</tr>\n<tr>\n<td align="left">failed</td>\n<td align="left">编译失败的时候</td>\n<td align="left">error</td>\n<td align="left">SyncHook</td>\n</tr>\n</tbody>\n</table>\n<h3 id="compilation-1"><a href="#compilation-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>compilation</h3>\n<table>\n<thead>\n<tr>\n<th align="left">事件钩子</th>\n<th align="left">触发时机</th>\n<th align="left">参数</th>\n<th align="left">类型</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align="left">normal-module-loader</td>\n<td align="left">普通模块 loader，真正（一个接一个地）加载模块图(graph)中所有模块的函数。</td>\n<td align="left">loaderContext module</td>\n<td align="left">SyncHook</td>\n</tr>\n<tr>\n<td align="left">seal</td>\n<td align="left">编译(compilation)停止接收新模块时触发。</td>\n<td align="left">-</td>\n<td align="left">SyncHook</td>\n</tr>\n<tr>\n<td align="left">optimize</td>\n<td align="left">优化阶段开始时触发。</td>\n<td align="left">-</td>\n<td align="left">SyncHook</td>\n</tr>\n<tr>\n<td align="left">optimize-modules</td>\n<td align="left">模块的优化</td>\n<td align="left">modules</td>\n<td align="left">SyncBailHook</td>\n</tr>\n<tr>\n<td align="left">optimize-chunks</td>\n<td align="left">优化 chunk</td>\n<td align="left">chunks</td>\n<td align="left">SyncBailHook</td>\n</tr>\n<tr>\n<td align="left">additional-assets</td>\n<td align="left">为编译(compilation)创建附加资源(asset)。</td>\n<td align="left">-</td>\n<td align="left">AsyncSeriesHook</td>\n</tr>\n<tr>\n<td align="left">optimize-chunk-assets</td>\n<td align="left">优化所有 chunk 资源(asset)。</td>\n<td align="left">chunks</td>\n<td align="left">AsyncSeriesHook</td>\n</tr>\n<tr>\n<td align="left">optimize-assets</td>\n<td align="left">优化存储在 compilation.assets 中的所有资源(asset)</td>\n<td align="left">assets</td>\n<td align="left">AsyncSeriesHook</td>\n</tr>\n</tbody>\n</table>\n<h1 id="流程"><a href="#%E6%B5%81%E7%A8%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>流程</h1>\n<h2 id="调试"><a href="#%E8%B0%83%E8%AF%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>调试</h2>\n<ol>\n<li>\n<p>使用以下命令运行项目，./scripts/build.js 是你想要开始调试的地方</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="73459221508001480000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`node --inspect-brk ./scripts/build.js --inline --progress`, `73459221508001480000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">node --inspect-brk ./scripts/build.js --inline --progress</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n</li>\n<li>\n<p>打开 chrome://inspect/#devices 即可调试</p>\n</li>\n</ol>\n<h2 id="流程图"><a href="#%E6%B5%81%E7%A8%8B%E5%9B%BE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>流程图</h2>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2021-09-02-11-37-01-4b67a83026d69459b48355b62550d276-fa1ac.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 110.37567084078712%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAWCAIAAABPIytRAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABlElEQVQ4y42U246CQBBE+f+fI74Q9GEFgyIXEbwBArJHenccBxa3EggzdE1XdTdYvYaHBrXU3/bvsNhK0zRJksvlcjqdgiCIoqgoCu5xHDdNo5jn81ktf8hcVVWVZdl1XV3X1+uV5/v9Xg5gU5HzPCfAJCtwMBH9FCC3bTshGw4veOBgyO0AISDh8Y43Mpoxg2dMhmF4PB5ZIl7IKO//hkVa8UzOw+EArRogrznr6xfr9drzPN/3KbDpGal6PUThfr9fLBa2bbuu6zgOZFpQ5MWLTEnJf7vd6BZHqAoDerZcLlerFS3EFOrYIexFRjNHbjab7Xa72+1U/s+eJTMJKSxWkaCXdFxtvebWfJN1C9OZBTjJssyIxmE8AMO0k3bgC3di21L2JAKdOpnjqAUcpoA7S5kIvgJTtmwZA/tBtgyjzKYslXhmRoo//h6fZEKJYGjQjDDE44eeCx+R7E8yn2SCCGWe0wEolwkVgnyec7IlDg6TPP6B/KtVMp7zjZ0mw0EwXZ0RafzqzFbJMH4kUxFkEv8NGZsHmVmE/M0AAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2021 09 02 11 37 01" title="" data-src="/static/2021-09-02-11-37-01-4b67a83026d69459b48355b62550d276-fee1c.png" data-srcset="/static/2021-09-02-11-37-01-4b67a83026d69459b48355b62550d276-a67b7.png 200w,\n/static/2021-09-02-11-37-01-4b67a83026d69459b48355b62550d276-0b187.png 400w,\n/static/2021-09-02-11-37-01-4b67a83026d69459b48355b62550d276-fee1c.png 800w,\n/static/2021-09-02-11-37-01-4b67a83026d69459b48355b62550d276-fa1ac.png 1118w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h2 id="入口"><a href="#%E5%85%A5%E5%8F%A3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>入口</h2>\n<p>入口处在 bulid.js，可以看到其中的代码是先实例化 webpack，然后调用 compiler 的 run 方法。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="90455189096026570000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function build(previousFileSizes) {\n  let compiler = webpack(config);\n  return new Promise((resolve, reject) => {\n    compiler.run((err, stats) => {\n      // ...\n    });\n  });\n}`, `90455189096026570000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token parameter">previousFileSizes</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">let</span> compiler <span class="token operator">=</span> <span class="token function">webpack</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    compiler<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> stats</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token comment">// ...</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="entry-option（compiler）"><a href="#entry-option%EF%BC%88compiler%EF%BC%89" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>entry-option（compiler）</h2>\n<h3 id="webpackjs"><a href="#webpackjs" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>webpack.js</h3>\n<p>webpack 在 node_moduls 下面的 <code class="language-text">\\webpack\\lib\\webpack.js</code>（在此前面有入口参数合并），找到该文件可以看到相关的代码如下</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="96521034391571960000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const webpack = (options, callback) => {\n  let compiler;\n  // 处理多个入口\n  if (Array.isArray(options)) {\n    compiler = new MultiCompiler(options.map((options) => webpack(options)));\n  } else if (typeof options === \'object\') {\n    // webpack 的默认参数\n    options = new WebpackOptionsDefaulter().process(options);\n    console.log(options); // 见下图\n    // 实例化 compiler\n    compiler = new Compiler(options.context);\n    compiler.options = options;\n    // 对 webpack 的运行环境处理\n    new NodeEnvironmentPlugin().apply(compiler);\n    // 根据上篇的 tabpable 可知，这里是为了注册插件\n    if (options.plugins && Array.isArray(options.plugins)) {\n      for (const plugin of options.plugins) {\n        plugin.apply(compiler);\n      }\n    }\n    // 触发两个事件点 environment/afterEnviroment\n    compiler.hooks.environment.call();\n    compiler.hooks.afterEnvironment.call();\n    // 设置 compiler 的属性并调用默认配置的插件，同时触发事件点 entry-option\n    compiler.options = new WebpackOptionsApply().process(options, compiler);\n  } else {\n    throw new Error(\'Invalid argument: options\');\n  }\n  if (callback) {\n    compiler.run(callback);\n  }\n  return compiler;\n};`, `96521034391571960000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">webpack</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">options<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">let</span> compiler<span class="token punctuation">;</span>\n  <span class="token comment">// 处理多个入口</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    compiler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MultiCompiler</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">webpack</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> options <span class="token operator">===</span> <span class="token string">\'object\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// webpack 的默认参数</span>\n    options <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebpackOptionsDefaulter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 见下图</span>\n    <span class="token comment">// 实例化 compiler</span>\n    compiler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Compiler</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    compiler<span class="token punctuation">.</span>options <span class="token operator">=</span> options<span class="token punctuation">;</span>\n    <span class="token comment">// 对 webpack 的运行环境处理</span>\n    <span class="token keyword">new</span> <span class="token class-name">NodeEnvironmentPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>compiler<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// 根据上篇的 tabpable 可知，这里是为了注册插件</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>plugins <span class="token operator">&amp;&amp;</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>plugins<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> plugin <span class="token keyword">of</span> options<span class="token punctuation">.</span>plugins<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token function">plugin</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>compiler<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n    <span class="token comment">// 触发两个事件点 environment/afterEnviroment</span>\n    compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">environment</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">afterEnvironment</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// 设置 compiler 的属性并调用默认配置的插件，同时触发事件点 entry-option</span>\n    compiler<span class="token punctuation">.</span>options <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebpackOptionsApply</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span> compiler<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">\'Invalid argument: options\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    compiler<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">return</span> compiler<span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2021-09-02-13-36-05-25c9b47ad4d9a98b1697769e0be81428-a368f.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 17.228739002932553%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAIAAAAcOLh5AAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAh0lEQVQI112OwQ6DIBBE+f8fNApaq9FELagsrl1ZoNRbO3mHmTlMRsAKsLxOAEQkRO8vz3yx9xzSn0KMv6VwGsw4gdHHvsO2IsD7OOg8w0UxcOSbbPLaMrNzKeXE8ZbYVDsX1VwWRpamrkyjtKy0LO2jtn1n+yd0bca1jWuUHfpvMw5ElC9+AAo2qugJ1ddtAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2021 09 02 13 36 05" title="" data-src="/static/2021-09-02-13-36-05-25c9b47ad4d9a98b1697769e0be81428-fee1c.png" data-srcset="/static/2021-09-02-13-36-05-25c9b47ad4d9a98b1697769e0be81428-a67b7.png 200w,\n/static/2021-09-02-13-36-05-25c9b47ad4d9a98b1697769e0be81428-0b187.png 400w,\n/static/2021-09-02-13-36-05-25c9b47ad4d9a98b1697769e0be81428-fee1c.png 800w,\n/static/2021-09-02-13-36-05-25c9b47ad4d9a98b1697769e0be81428-b1a91.png 1200w,\n/static/2021-09-02-13-36-05-25c9b47ad4d9a98b1697769e0be81428-a368f.png 1364w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>可以看出 options 保存的就是本次 webpack 的一些配置参数，而其中的 plugins 属性则是 webpack 中最重要的插件。</p>\n<h3 id="new-webpackoptionsapplyprocess"><a href="#new-webpackoptionsapplyprocess" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>new WebpackOptionsApply().process</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="53192180877429900000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function process(options, compiler) {\n  let ExternalsPlugin;\n  compiler.outputPath = options.output.path;\n  compiler.recordsInputPath = options.recordsInputPath || options.recordsPath;\n  compiler.recordsOutputPath = options.recordsOutputPath || options.recordsPath;\n  compiler.name = options.name;\n  compiler.dependencies = options.dependencies;\n  if (typeof options.target === \'string\') {\n    let JsonpTemplatePlugin;\n    let FetchCompileWasmTemplatePlugin;\n    let ReadFileCompileWasmTemplatePlugin;\n    let NodeSourcePlugin;\n    let NodeTargetPlugin;\n    let NodeTemplatePlugin;\n\n    switch (options.target) {\n      case \'web\':\n        JsonpTemplatePlugin = require(\'./web/JsonpTemplatePlugin\');\n        FetchCompileWasmTemplatePlugin = require(\'./web/FetchCompileWasmTemplatePlugin\');\n        NodeSourcePlugin = require(\'./node/NodeSourcePlugin\');\n        new JsonpTemplatePlugin().apply(compiler);\n        new FetchCompileWasmTemplatePlugin({\n          mangleImports: options.optimization.mangleWasmImports\n        }).apply(compiler);\n        new FunctionModulePlugin().apply(compiler);\n        new NodeSourcePlugin(options.node).apply(compiler);\n        new LoaderTargetPlugin(options.target).apply(compiler);\n        break;\n      case \'webworker\':\n        // ...\n        break;\n    }\n    // ...\n  }\n  new JavascriptModulesPlugin().apply(compiler);\n  new JsonModulesPlugin().apply(compiler);\n  new WebAssemblyModulesPlugin({\n    mangleImports: options.optimization.mangleWasmImports\n  }).apply(compiler);\n\n  new EntryOptionPlugin().apply(compiler);\n  // 触发事件点 entry-options 并传入参数 context 和 entry\n  compiler.hooks.entryOption.call(options.context, options.entry);\n  new CompatibilityPlugin().apply(compiler);\n  // ...\n  new ImportPlugin(options.module).apply(compiler);\n  new SystemPlugin(options.module).apply(compiler);\n}`, `53192180877429900000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token parameter">options<span class="token punctuation">,</span> compiler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">let</span> ExternalsPlugin<span class="token punctuation">;</span>\n  compiler<span class="token punctuation">.</span>outputPath <span class="token operator">=</span> options<span class="token punctuation">.</span>output<span class="token punctuation">.</span>path<span class="token punctuation">;</span>\n  compiler<span class="token punctuation">.</span>recordsInputPath <span class="token operator">=</span> options<span class="token punctuation">.</span>recordsInputPath <span class="token operator">||</span> options<span class="token punctuation">.</span>recordsPath<span class="token punctuation">;</span>\n  compiler<span class="token punctuation">.</span>recordsOutputPath <span class="token operator">=</span> options<span class="token punctuation">.</span>recordsOutputPath <span class="token operator">||</span> options<span class="token punctuation">.</span>recordsPath<span class="token punctuation">;</span>\n  compiler<span class="token punctuation">.</span>name <span class="token operator">=</span> options<span class="token punctuation">.</span>name<span class="token punctuation">;</span>\n  compiler<span class="token punctuation">.</span>dependencies <span class="token operator">=</span> options<span class="token punctuation">.</span>dependencies<span class="token punctuation">;</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> options<span class="token punctuation">.</span>target <span class="token operator">===</span> <span class="token string">\'string\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">let</span> JsonpTemplatePlugin<span class="token punctuation">;</span>\n    <span class="token keyword">let</span> FetchCompileWasmTemplatePlugin<span class="token punctuation">;</span>\n    <span class="token keyword">let</span> ReadFileCompileWasmTemplatePlugin<span class="token punctuation">;</span>\n    <span class="token keyword">let</span> NodeSourcePlugin<span class="token punctuation">;</span>\n    <span class="token keyword">let</span> NodeTargetPlugin<span class="token punctuation">;</span>\n    <span class="token keyword">let</span> NodeTemplatePlugin<span class="token punctuation">;</span>\n\n    <span class="token keyword">switch</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>target<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">case</span> <span class="token string">\'web\'</span><span class="token punctuation">:</span>\n        JsonpTemplatePlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./web/JsonpTemplatePlugin\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        FetchCompileWasmTemplatePlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./web/FetchCompileWasmTemplatePlugin\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        NodeSourcePlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./node/NodeSourcePlugin\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">new</span> <span class="token class-name">JsonpTemplatePlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>compiler<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">new</span> <span class="token class-name">FetchCompileWasmTemplatePlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n          mangleImports<span class="token punctuation">:</span> options<span class="token punctuation">.</span>optimization<span class="token punctuation">.</span>mangleWasmImports\n        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>compiler<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">new</span> <span class="token class-name">FunctionModulePlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>compiler<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">new</span> <span class="token class-name">NodeSourcePlugin</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>node<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>compiler<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">new</span> <span class="token class-name">LoaderTargetPlugin</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>target<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>compiler<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">break</span><span class="token punctuation">;</span>\n      <span class="token keyword">case</span> <span class="token string">\'webworker\'</span><span class="token punctuation">:</span>\n        <span class="token comment">// ...</span>\n        <span class="token keyword">break</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token comment">// ...</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">new</span> <span class="token class-name">JavascriptModulesPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>compiler<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">new</span> <span class="token class-name">JsonModulesPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>compiler<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">new</span> <span class="token class-name">WebAssemblyModulesPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n    mangleImports<span class="token punctuation">:</span> options<span class="token punctuation">.</span>optimization<span class="token punctuation">.</span>mangleWasmImports\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>compiler<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">new</span> <span class="token class-name">EntryOptionPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>compiler<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// 触发事件点 entry-options 并传入参数 context 和 entry</span>\n  compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">entryOption</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>context<span class="token punctuation">,</span> options<span class="token punctuation">.</span>entry<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">new</span> <span class="token class-name">CompatibilityPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>compiler<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// ...</span>\n  <span class="token keyword">new</span> <span class="token class-name">ImportPlugin</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>module<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>compiler<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">new</span> <span class="token class-name">SystemPlugin</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>module<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>compiler<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="run（compiler）"><a href="#run%EF%BC%88compiler%EF%BC%89" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>run（compiler）</h2>\n<p>调用 run 时，会先在内部触发 beforeRun 事件点，然后再在读取 <a href="https://webpack.docschina.org/configuration/other-options/#recordspath" target="_blank" rel="nofollow noreferrer noopener">records</a> 之前触发 run 事件点，这两个事件都是异步的形式，注意 run 方法是实际上整个 webpack 打包流程的入口。可以看到，最后调用的是 compile 方法，同时传入的是 onCompiled 函数</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="26504247840051320000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function run(callback) {\n  if (this.running) return callback(new ConcurrentCompilationError());\n  const finalCallback = (err, stats) => {\n    // ......\n  };\n  this.running = true;\n\n  const onCompiled = (err, compilation) => {\n    // ....\n  };\n\n  this.hooks.beforeRun.callAsync(this, (err) => {\n    if (err) return finalCallback(err);\n\n    this.hooks.run.callAsync(this, (err) => {\n      if (err) return finalCallback(err);\n\n      this.readRecords((err) => {\n        if (err) return finalCallback(err);\n\n        this.compile(onCompiled);\n      });\n    });\n  });\n}`, `26504247840051320000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>running<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ConcurrentCompilationError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> <span class="token function-variable function">finalCallback</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> stats</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token comment">// ......</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span>running <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> <span class="token function-variable function">onCompiled</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> compilation</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token comment">// ....</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>beforeRun<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">finalCallback</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>run<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">finalCallback</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">readRecords</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">finalCallback</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span>onCompiled<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="compile（compiler）"><a href="#compile%EF%BC%88compiler%EF%BC%89" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>compile（compiler）</h2>\n<p>compile 方法主要上触发 beforeCompile、compile、make 等事件点，并实例化 compilation，这里我们可以看到传给 compile 的 newCompilationParams 参数，这个参数在后面相对流程中也是比较重要，可以在这里先看一下</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="96007695304568270000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function compile(callback) {\n  const params = this.newCompilationParams();\n  // 触发事件点 beforeCompile，并传入参数 CompilationParams\n  this.hooks.beforeCompile.callAsync(params, (err) => {\n    if (err) return callback(err);\n    // 触发事件点 compile，并传入参数 CompilationParams\n    this.hooks.compile.call(params);\n    // 实例化 compilation\n    const compilation = this.newCompilation(params);\n    // 触发事件点 make\n    this.hooks.make.callAsync(compilation, (err) => {\n      // ....\n    });\n  });\n}`, `96007695304568270000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">compile</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> params <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">newCompilationParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// 触发事件点 beforeCompile，并传入参数 CompilationParams</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>beforeCompile<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span>params<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// 触发事件点 compile，并传入参数 CompilationParams</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// 实例化 compilation</span>\n    <span class="token keyword">const</span> compilation <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">newCompilation</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// 触发事件点 make</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>make<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span>compilation<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token comment">// ....</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>newCompilationParams 返回的参数分别是两个工厂函数和一个 Set 集合</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="56126464792071710000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function newCompilationParams() {\n  const params = {\n    normalModuleFactory: this.createNormalModuleFactory(),\n    contextModuleFactory: this.createContextModuleFactory(),\n    compilationDependencies: new Set()\n  };\n  return params;\n}`, `56126464792071710000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">newCompilationParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> params <span class="token operator">=</span> <span class="token punctuation">{</span>\n    normalModuleFactory<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createNormalModuleFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    contextModuleFactory<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createContextModuleFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    compilationDependencies<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> params<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="compilation（compiler）"><a href="#compilation%EF%BC%88compiler%EF%BC%89" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>compilation（compiler）</h2>\n<p>从上面的 compile 方法看， compilation 是通过 newCompilation 方法调用生成的，然后触发事件点 thisCompilation 和 compilation，可以看出 compilation 在这两个事件点中最早当成参数传入，如果你在编写插件的时候需要尽快使用该对象，则应该在该两个事件中进行。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="7655245456807091000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function createCompilation() {\n  return new Compilation(this);\n}\nfunction newCompilation(params) {\n  const compilation = this.createCompilation();\n  compilation.fileTimestamps = this.fileTimestamps;\n  compilation.contextTimestamps = this.contextTimestamps;\n  compilation.name = this.name;\n  compilation.records = this.records;\n  compilation.compilationDependencies = params.compilationDependencies;\n  // 触发事件点 thisCompilation 和 compilation， 同时传入参数 compilation 和 params\n  this.hooks.thisCompilation.call(compilation, params);\n  this.hooks.compilation.call(compilation, params);\n  return compilation;\n}`, `7655245456807091000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">createCompilation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Compilation</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token keyword">function</span> <span class="token function">newCompilation</span><span class="token punctuation">(</span><span class="token parameter">params</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> compilation <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createCompilation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  compilation<span class="token punctuation">.</span>fileTimestamps <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fileTimestamps<span class="token punctuation">;</span>\n  compilation<span class="token punctuation">.</span>contextTimestamps <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>contextTimestamps<span class="token punctuation">;</span>\n  compilation<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">;</span>\n  compilation<span class="token punctuation">.</span>records <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>records<span class="token punctuation">;</span>\n  compilation<span class="token punctuation">.</span>compilationDependencies <span class="token operator">=</span> params<span class="token punctuation">.</span>compilationDependencies<span class="token punctuation">;</span>\n  <span class="token comment">// 触发事件点 thisCompilation 和 compilation， 同时传入参数 compilation 和 params</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">thisCompilation</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>compilation<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">compilation</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>compilation<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> compilation<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>下面是打印出来的 compilation 属性</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2021-09-02-13-59-52-58f7d2541d648fff9d5585dbbd43bdc5-e3184.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 45.12551079976649%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAA/ElEQVQoz4VR0ZKDIAzk/3/xXvpQbZGKSEAFg3QBe+1Mb+Z2djIhJmFZhR0tGRdj3JkTuO8nYzxjTT6R0pErBD2INGE4hlCILejGd6DGXFmQ8/uYEqKwo9NyJufLzajnV+fxAlakgnYtN3UxoijspR9/LnN3pb6zfYfE3nq69f5+Wwe5qGHT425nXpf8BUHS6Ks0D2WUmqTUg3TT5IxZzARu1gZHwbvgPdfHH8wfw5CtDB4KYd+73+KbfubCxM0UGOb0MDlH82wBR+SJ1mWBc818LkBaxn7/BRfPkyBF+q7hcq201nNx/g/CG4/hLWzQwm0WEXs5Vev/5lbxBOytDfSYx3HfAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2021 09 02 13 59 52" title="" data-src="/static/2021-09-02-13-59-52-58f7d2541d648fff9d5585dbbd43bdc5-fee1c.png" data-srcset="/static/2021-09-02-13-59-52-58f7d2541d648fff9d5585dbbd43bdc5-a67b7.png 200w,\n/static/2021-09-02-13-59-52-58f7d2541d648fff9d5585dbbd43bdc5-0b187.png 400w,\n/static/2021-09-02-13-59-52-58f7d2541d648fff9d5585dbbd43bdc5-fee1c.png 800w,\n/static/2021-09-02-13-59-52-58f7d2541d648fff9d5585dbbd43bdc5-b1a91.png 1200w,\n/static/2021-09-02-13-59-52-58f7d2541d648fff9d5585dbbd43bdc5-95179.png 1600w,\n/static/2021-09-02-13-59-52-58f7d2541d648fff9d5585dbbd43bdc5-e3184.png 1713w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>关于这里为什么要有 thisCompilation 这个事件点和子编译器（childCompiler），可以参考该<a href="https://lxzjj.github.io/2017/11/08/%E7%8E%A9%E8%BD%ACwebpack%EF%BC%88%E4%BA%8C%EF%BC%89/" target="_blank" rel="nofollow noreferrer noopener">文章</a></p>\n<p>总结起来就是:</p>\n<p>子编译器拥有完整的模块解析和 chunk 生成阶段,但是少了某些事件点，如”make”, “compile”, “emit”, “after-emit”, “invalid”, “done”, “this-compilation”。 也就是说我们可以利用子编译器来独立（于父编译器）跑完一个核心构建流程，额外生成一些需要的模块或者 chunk。</p>\n<h2 id="make（compiler）"><a href="#make%EF%BC%88compiler%EF%BC%89" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>make（compiler）</h2>\n<p>从上面的 compile 方法知道， 实例化 Compilation 后就会触发 make 事件点了。触发了 make 时， 因为 webpack 在前面实例化 SingleEntryPlugin 或者 MultleEntryPlugin，SingleEntryPlugin 则在其 apply 方法中注册了一个 make 事件</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="88643632749615960000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function apply(compiler) {\n  compiler.hooks.compilation.tap(\'SingleEntryPlugin\', (compilation, { normalModuleFactory }) => {\n    compilation.dependencyFactories.set(\n      SingleEntryDependency,\n      normalModuleFactory // 工厂函数，存在 compilation 的 dependencyFactories 集合\n    );\n  });\n\n  compiler.hooks.make.tapAsync(\'SingleEntryPlugin\', (compilation, callback) => {\n    const { entry, name, context } = this;\n\n    const dep = SingleEntryPlugin.createDependency(entry, name);\n    // 进入到 addEntry\n    compilation.addEntry(context, dep, name, callback);\n  });\n}`, `88643632749615960000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>compilation<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">\'SingleEntryPlugin\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">compilation<span class="token punctuation">,</span> <span class="token punctuation">{</span> normalModuleFactory <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    compilation<span class="token punctuation">.</span>dependencyFactories<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>\n      SingleEntryDependency<span class="token punctuation">,</span>\n      normalModuleFactory <span class="token comment">// 工厂函数，存在 compilation 的 dependencyFactories 集合</span>\n    <span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>make<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token string">\'SingleEntryPlugin\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">compilation<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> <span class="token punctuation">{</span> entry<span class="token punctuation">,</span> name<span class="token punctuation">,</span> context <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">const</span> dep <span class="token operator">=</span> SingleEntryPlugin<span class="token punctuation">.</span><span class="token function">createDependency</span><span class="token punctuation">(</span>entry<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// 进入到 addEntry</span>\n    compilation<span class="token punctuation">.</span><span class="token function">addEntry</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> dep<span class="token punctuation">,</span> name<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>事实上 addEntry 调用的是 <code class="language-text">Comilation._addModuleChain</code>，acquire 函数比较简单，主要是处理 module 时如果任务太多，就将 moduleFactory.create 存入队列等待</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="49894509493840710000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function _addModuleChain(context, dependency, onModule, callback) {\n  // ......\n  // 取出对应的Factory\n  const Dep = /** @type {DepConstructor} */ (dependency.constructor);\n  const moduleFactory = this.dependencyFactories.get(Dep);\n  // ......\n  this.semaphore.acquire(() => {\n    moduleFactory.create(\n      {\n        contextInfo: {\n          issuer: \'\',\n          compiler: this.compiler.name\n        },\n        context: context,\n        dependencies: [dependency]\n      },\n      (err, module) => {\n        // ......\n      }\n    );\n  });\n}`, `49894509493840710000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">_addModuleChain</span><span class="token punctuation">(</span><span class="token parameter">context<span class="token punctuation">,</span> dependency<span class="token punctuation">,</span> onModule<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// ......</span>\n  <span class="token comment">// 取出对应的Factory</span>\n  <span class="token keyword">const</span> Dep <span class="token operator">=</span> <span class="token comment">/** @type {DepConstructor} */</span> <span class="token punctuation">(</span>dependency<span class="token punctuation">.</span>constructor<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> moduleFactory <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>dependencyFactories<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>Dep<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// ......</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span>semaphore<span class="token punctuation">.</span><span class="token function">acquire</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    moduleFactory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>\n      <span class="token punctuation">{</span>\n        contextInfo<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n          issuer<span class="token punctuation">:</span> <span class="token string">\'\'</span><span class="token punctuation">,</span>\n          compiler<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>compiler<span class="token punctuation">.</span>name\n        <span class="token punctuation">}</span><span class="token punctuation">,</span>\n        context<span class="token punctuation">:</span> context<span class="token punctuation">,</span>\n        dependencies<span class="token punctuation">:</span> <span class="token punctuation">[</span>dependency<span class="token punctuation">]</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> module</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token comment">// ......</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>moduleFactory.create 则是收集一系列信息然后创建一个 module 传入回调</p>\n<h2 id="buildmodule（compilation）"><a href="#buildmodule%EF%BC%88compilation%EF%BC%89" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>buildModule（compilation）</h2>\n<p>回调函数主要上执行 buildModule 方法</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="34181789081483550000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`this.buildModule(module, false, null, null, (err) => {\n  // ......\n  afterBuild();\n});`, `34181789081483550000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">buildModule</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token comment">// ......</span>\n  <span class="token function">afterBuild</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="58268717018430370000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function buildModule(module, optional, origin, dependencies, thisCallback) {\n  // 处理回调函数\n  let callbackList = this._buildingModules.get(module);\n  if (callbackList) {\n    callbackList.push(thisCallback);\n    return;\n  }\n  this._buildingModules.set(module, (callbackList = [thisCallback]));\n\n  const callback = (err) => {\n    this._buildingModules.delete(module);\n    for (const cb of callbackList) {\n      cb(err);\n    }\n  };\n  // 触发 buildModule 事件点\n  this.hooks.buildModule.call(module);\n  module.build(\n    this.options,\n    this,\n    this.resolverFactory.get(\'normal\', module.resolveOptions),\n    this.inputFileSystem,\n    (error) => {\n      // ......\n    }\n  );\n}`, `58268717018430370000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">buildModule</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> optional<span class="token punctuation">,</span> origin<span class="token punctuation">,</span> dependencies<span class="token punctuation">,</span> thisCallback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 处理回调函数</span>\n  <span class="token keyword">let</span> callbackList <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_buildingModules<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>module<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>callbackList<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    callbackList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>thisCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">return</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span>_buildingModules<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> <span class="token punctuation">(</span>callbackList <span class="token operator">=</span> <span class="token punctuation">[</span>thisCallback<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> <span class="token function-variable function">callback</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>_buildingModules<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>module<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> cb <span class="token keyword">of</span> callbackList<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token function">cb</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token comment">// 触发 buildModule 事件点</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">buildModule</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>module<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  module<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">,</span>\n    <span class="token keyword">this</span><span class="token punctuation">,</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>resolverFactory<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">\'normal\'</span><span class="token punctuation">,</span> module<span class="token punctuation">.</span>resolveOptions<span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>inputFileSystem<span class="token punctuation">,</span>\n    <span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token comment">// ......</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>build 方法中调用的是 doBuild，doBuild 又通过 runLoaders 获取 loader 相关的信息并转换成 webpack 需要的 js 文件，最后通过 doBuild 的回调函数调用 parse 方法，创建依赖 Dependency 并放入依赖数组</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="35439576089182310000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`return this.doBuild(options, compilation, resolver, fs, (err) => {\n  // 在 createLoaderContext 函数中触发事件 normal-module-loader\n  const loaderContext = this.createLoaderContext(resolver, options, compilation, fs);\n  // .....\n  const handleParseResult = (result) => {\n    this._lastSuccessfulBuildMeta = this.buildMeta;\n    this._initBuildHash(compilation);\n    return callback();\n  };\n\n  try {\n    // 调用 parser.parse\n    const result = this.parser.parse(\n      this._ast || this._source.source(),\n      {\n        current: this,\n        module: this,\n        compilation: compilation,\n        options: options\n      },\n      (err, result) => {\n        if (err) {\n          handleParseError(err);\n        } else {\n          handleParseResult(result);\n        }\n      }\n    );\n    if (result !== undefined) {\n      // parse is sync\n      handleParseResult(result);\n    }\n  } catch (e) {\n    handleParseError(e);\n  }\n});`, `35439576089182310000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">doBuild</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span> compilation<span class="token punctuation">,</span> resolver<span class="token punctuation">,</span> fs<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token comment">// 在 createLoaderContext 函数中触发事件 normal-module-loader</span>\n  <span class="token keyword">const</span> loaderContext <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createLoaderContext</span><span class="token punctuation">(</span>resolver<span class="token punctuation">,</span> options<span class="token punctuation">,</span> compilation<span class="token punctuation">,</span> fs<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// .....</span>\n  <span class="token keyword">const</span> <span class="token function-variable function">handleParseResult</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">result</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>_lastSuccessfulBuildMeta <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>buildMeta<span class="token punctuation">;</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_initBuildHash</span><span class="token punctuation">(</span>compilation<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">try</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 调用 parser.parse</span>\n    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>parser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>_ast <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_source<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n      <span class="token punctuation">{</span>\n        current<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">,</span>\n        module<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">,</span>\n        compilation<span class="token punctuation">:</span> compilation<span class="token punctuation">,</span>\n        options<span class="token punctuation">:</span> options\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> result</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          <span class="token function">handleParseError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n          <span class="token function">handleParseResult</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// parse is sync</span>\n      <span class="token function">handleParseResult</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token function">handleParseError</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在 ast 转换过程中也很容易得到了需要依赖的哪些其他模块。</p>\n<h2 id="succeedmodule（compilation）"><a href="#succeedmodule%EF%BC%88compilation%EF%BC%89" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>succeedModule（compilation）</h2>\n<p>最后执行了 module.build 的回调函数，触发了事件点 succeedModule，并回到 Compilation.buildModule 函数的回调函数</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="44013989906752980000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`module.build(\n  this.options,\n  this,\n  this.resolverFactory.get(\'normal\', module.resolveOptions),\n  this.inputFileSystem,\n  (error) => {\n    // ......\n    触发了事件点succeedModule;\n    this.hooks.succeedModule.call(module);\n    return callback();\n  }\n);\n\nthis.buildModule(module, false, null, null, (err) => {\n  // ......\n  // 执行afterBuild\n  afterBuild();\n});`, `44013989906752980000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">module<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">,</span>\n  <span class="token keyword">this</span><span class="token punctuation">,</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span>resolverFactory<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">\'normal\'</span><span class="token punctuation">,</span> module<span class="token punctuation">.</span>resolveOptions<span class="token punctuation">)</span><span class="token punctuation">,</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span>inputFileSystem<span class="token punctuation">,</span>\n  <span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token comment">// ......</span>\n    触发了事件点succeedModule<span class="token punctuation">;</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">succeedModule</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>module<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">buildModule</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token comment">// ......</span>\n  <span class="token comment">// 执行afterBuild</span>\n  <span class="token function">afterBuild</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>对于当前模块，或许存在着多个依赖模块。当前模块会开辟一个依赖模块的数组，在遍历 AST 时，将 require() 中的模块通过 addDependency() 添加到数组中。当前模块构建完成后，webpack 调用 processModuleDependencies 开始递归处理依赖的 module，接着就会重复之前的构建步骤。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="96366248988751740000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`Compilation.prototype.addModuleDependencies = function(module, dependencies, bail, cacheGroup, recursive, callback) {\n  // 根据依赖数组(dependencies)创建依赖模块对象\n  var factories = [];\n  for (var i = 0; i < dependencies.length; i++) {\n    var factory = _this.dependencyFactories.get(dependencies[i][0].constructor);\n    factories[i] = [factory, dependencies[i]];\n  }\n  // ...\n  // 与当前模块构建步骤相同\n};`, `96366248988751740000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token class-name">Compilation</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">addModuleDependencies</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> dependencies<span class="token punctuation">,</span> bail<span class="token punctuation">,</span> cacheGroup<span class="token punctuation">,</span> recursive<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 根据依赖数组(dependencies)创建依赖模块对象</span>\n  <span class="token keyword">var</span> factories <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> dependencies<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">var</span> factory <span class="token operator">=</span> _this<span class="token punctuation">.</span>dependencyFactories<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>dependencies<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>constructor<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    factories<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>factory<span class="token punctuation">,</span> dependencies<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token comment">// ...</span>\n  <span class="token comment">// 与当前模块构建步骤相同</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>最后，所有的模块都会被放入到 Compilation 的 modules 里面， 如下：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2021-09-02-14-09-58-6a4b9e1046337e17b52c08d4c9f425c5-115a3.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 27.590511860174782%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAIAAABM9SnKAAAACXBIWXMAAAsSAAALEgHS3X78AAAAkklEQVQY05WPSw7DIAwFuf8dESC+hiagBAEBKa0Fmy66aGZhzcMGGQIAIQTrLDhUsNZ6793kO8IEBYc9+HVOOOdKKsaYUgpdcIFCKZVS8smKq4tjWuvVFUIQYww+mXMeY9Rae+/XdbXWUFb9GVcluMm2vVqr7+cQ/GqAUMqzy/eElKOUo55nxp3v/0gp7fseY/wAnxVWKsneRuQAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2021 09 02 14 09 58" title="" data-src="/static/2021-09-02-14-09-58-6a4b9e1046337e17b52c08d4c9f425c5-fee1c.png" data-srcset="/static/2021-09-02-14-09-58-6a4b9e1046337e17b52c08d4c9f425c5-a67b7.png 200w,\n/static/2021-09-02-14-09-58-6a4b9e1046337e17b52c08d4c9f425c5-0b187.png 400w,\n/static/2021-09-02-14-09-58-6a4b9e1046337e17b52c08d4c9f425c5-fee1c.png 800w,\n/static/2021-09-02-14-09-58-6a4b9e1046337e17b52c08d4c9f425c5-115a3.png 801w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2021-09-02-14-10-14-118fc84aa9c24820182f01e91d8089e1-19100.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 45.19230769230769%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAAsSAAALEgHS3X78AAAA70lEQVQoz31Si27DIAzk/39z0ramaSDYYLs8sqOJ2j3anS7SQbDPNjg/hbBEzVLNriKllNZarRVfr3V7DZx0dCEOUVKyGDXSFSm+ASeeCmQnIseezKz13rdtcEc7ANH/APtwZmYXpjWcznldU1jNFLBBGS6qYH0GxIuIC6cwv0+aGERBYL3VNnq+OfQXQLzjheL5UiRX1VZKP0ZVdv3PwEYwzSScMGoYbqPxn7jv/PoF51pdnOPyMWeKRRXZ9qE9iBVaMLsHN9Uish1lez6/fXIIQpTWkINXaO9lWSCMSKdJcYsp4RWgwOI9GlTmzPwFWZAPgovjOkEAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2021 09 02 14 10 14" title="" data-src="/static/2021-09-02-14-10-14-118fc84aa9c24820182f01e91d8089e1-fee1c.png" data-srcset="/static/2021-09-02-14-10-14-118fc84aa9c24820182f01e91d8089e1-a67b7.png 200w,\n/static/2021-09-02-14-10-14-118fc84aa9c24820182f01e91d8089e1-0b187.png 400w,\n/static/2021-09-02-14-10-14-118fc84aa9c24820182f01e91d8089e1-fee1c.png 800w,\n/static/2021-09-02-14-10-14-118fc84aa9c24820182f01e91d8089e1-b1a91.png 1200w,\n/static/2021-09-02-14-10-14-118fc84aa9c24820182f01e91d8089e1-95179.png 1600w,\n/static/2021-09-02-14-10-14-118fc84aa9c24820182f01e91d8089e1-19100.png 1872w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>总结一下：</p>\n<p>module 是 webpack 构建的核心实体，也是所有 module 的 父类，它有几种不同子类：NormalModule、MultiModule、ContextModule、DelegatedModule 等，一个依赖对象（Dependency，还未被解析成模块实例的依赖对象。比如我们运行 webpack 时传入的入口模块，或者一个模块依赖的其他模块，都会先生成一个 Dependency 对象。）经过对应的工厂对象（Factory）创建之后，就能够生成对应的模块实例（Module）。</p>\n<h2 id="seal（compilation）"><a href="#seal%EF%BC%88compilation%EF%BC%89" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>seal（compilation）</h2>\n<p>构建 module 后， 就会调用 Compilation.seal， 该函数主要是触发了事件点 seal， 构建 chunk， 在所有 chunks 生成之后，webpack 会对 chunks 和 modules 进行一些优化相关的操作，比如分配 id、排序等，并且触发一系列相关的事件点</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="9678179334550774000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function seal(callback) {\n  // 触发事件点 seal\n  this.hooks.seal.call();\n  // 优化\n  // ......\n  this.hooks.afterOptimizeDependencies.call(this.modules);\n\n  this.hooks.beforeChunks.call();\n  // 生成 chunk\n  for (const preparedEntrypoint of this._preparedEntrypoints) {\n    const module = preparedEntrypoint.module;\n    const name = preparedEntrypoint.name;\n    // 整理每个 Module 和 chunk，每个 chunk 对应一个输出文件。\n    const chunk = this.addChunk(name);\n    const entrypoint = new Entrypoint(name);\n    entrypoint.setRuntimeChunk(chunk);\n    entrypoint.addOrigin(null, name, preparedEntrypoint.request);\n    this.namedChunkGroups.set(name, entrypoint);\n    this.entrypoints.set(name, entrypoint);\n    this.chunkGroups.push(entrypoint);\n\n    GraphHelpers.connectChunkGroupAndChunk(entrypoint, chunk);\n    GraphHelpers.connectChunkAndModule(chunk, module);\n\n    chunk.entryModule = module;\n    chunk.name = name;\n\n    this.assignDepth(module);\n  }\n  this.processDependenciesBlocksForChunkGroups(this.chunkGroups.slice());\n  this.sortModules(this.modules);\n  this.hooks.afterChunks.call(this.chunks);\n\n  this.hooks.optimize.call();\n\n  // ......\n  this.hooks.afterOptimizeModules.call(this.modules);\n\n  // ......\n  this.hooks.afterOptimizeChunks.call(this.chunks, this.chunkGroups);\n\n  this.hooks.optimizeTree.callAsync(this.chunks, this.modules, (err) => {\n    // ......\n    this.hooks.beforeChunkAssets.call();\n    this.createChunkAssets(); // 生成对应的 Assets\n    this.hooks.additionalAssets.callAsync(/* ... */);\n  });\n}`, `9678179334550774000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">seal</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 触发事件点 seal</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">seal</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// 优化</span>\n  <span class="token comment">// ......</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">afterOptimizeDependencies</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>modules<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">beforeChunks</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// 生成 chunk</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> preparedEntrypoint <span class="token keyword">of</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_preparedEntrypoints<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> module <span class="token operator">=</span> preparedEntrypoint<span class="token punctuation">.</span>module<span class="token punctuation">;</span>\n    <span class="token keyword">const</span> name <span class="token operator">=</span> preparedEntrypoint<span class="token punctuation">.</span>name<span class="token punctuation">;</span>\n    <span class="token comment">// 整理每个 Module 和 chunk，每个 chunk 对应一个输出文件。</span>\n    <span class="token keyword">const</span> chunk <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addChunk</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> entrypoint <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Entrypoint</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    entrypoint<span class="token punctuation">.</span><span class="token function">setRuntimeChunk</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    entrypoint<span class="token punctuation">.</span><span class="token function">addOrigin</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> preparedEntrypoint<span class="token punctuation">.</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>namedChunkGroups<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> entrypoint<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>entrypoints<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> entrypoint<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>chunkGroups<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>entrypoint<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    GraphHelpers<span class="token punctuation">.</span><span class="token function">connectChunkGroupAndChunk</span><span class="token punctuation">(</span>entrypoint<span class="token punctuation">,</span> chunk<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    GraphHelpers<span class="token punctuation">.</span><span class="token function">connectChunkAndModule</span><span class="token punctuation">(</span>chunk<span class="token punctuation">,</span> module<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    chunk<span class="token punctuation">.</span>entryModule <span class="token operator">=</span> module<span class="token punctuation">;</span>\n    chunk<span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>\n\n    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">assignDepth</span><span class="token punctuation">(</span>module<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">processDependenciesBlocksForChunkGroups</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>chunkGroups<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">sortModules</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>modules<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">afterChunks</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>chunks<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">optimize</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// ......</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">afterOptimizeModules</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>modules<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// ......</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">afterOptimizeChunks</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>chunks<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>chunkGroups<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>optimizeTree<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>chunks<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>modules<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token comment">// ......</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">beforeChunkAssets</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createChunkAssets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 生成对应的 Assets</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>additionalAssets<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span><span class="token comment">/* ... */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>每个 chunk 的生成就是找到需要包含的 modules。这里大致描述一下 chunk 的生成算法：</p>\n<ol>\n<li>webpack 先将 entry 中对应的 module 都生成一个新的 chunk</li>\n<li>遍历 module 的依赖列表，将依赖的 module 也加入到 chunk 中</li>\n<li>如果一个依赖 module 是动态引入的模块，那么就会根据这个 module 创建一个新的 chunk，继续遍历依赖</li>\n<li>重复上面的过程，直至得到所有的 chunks</li>\n</ol>\n<p>chunk 属性图</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2021-09-02-14-13-52-d82d1292b382e4d317d0ef1e4d81b4f5-446cc.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 47.86324786324786%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAy0lEQVQoz51S227DMAj1/39lVa0vjS8Y48QmhJR4irRqVafu4IcjzO0gXJwiZqy1LsvSmVW3X9DxvqluPyJcuEaYsPXGzOu68jPMI9ylNWEW433w1jaRfd9duMUUsHf7Ex1V9ayto4+erfWZH8nZw9r74B/D+YufvgJAtnIfJ+d7RixmtrB2og+YR9+O5CjRUo+gl/ijMwERkmzyH80QIYRQSgFI0x2yiUD03seYEtD+fmyEYtGmc55nKodws0o0H2gvJ7d12FHZFTwAfPFMteYZV7QAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2021 09 02 14 13 52" title="" data-src="/static/2021-09-02-14-13-52-d82d1292b382e4d317d0ef1e4d81b4f5-fee1c.png" data-srcset="/static/2021-09-02-14-13-52-d82d1292b382e4d317d0ef1e4d81b4f5-a67b7.png 200w,\n/static/2021-09-02-14-13-52-d82d1292b382e4d317d0ef1e4d81b4f5-0b187.png 400w,\n/static/2021-09-02-14-13-52-d82d1292b382e4d317d0ef1e4d81b4f5-fee1c.png 800w,\n/static/2021-09-02-14-13-52-d82d1292b382e4d317d0ef1e4d81b4f5-446cc.png 1170w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h2 id="beforechunkassets--additionalchunkassets（compilation）"><a href="#beforechunkassets--additionalchunkassets%EF%BC%88compilation%EF%BC%89" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>beforeChunkAssets &#x26;&#x26; additionalChunkAssets（Compilation）</h2>\n<p>在触发这两个事件点的中间时，会调用 Compilation.createCHunkAssets 来创建 assets</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="72737852872826840000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function createChunkAssets() {\n  // ......\n  // 遍历 chunk\n  for (let i = 0; i < this.chunks.length; i++) {\n    const chunk = this.chunks[i];\n    chunk.files = [];\n    let source;\n    let file;\n    let filenameTemplate;\n    try {\n      // 调用何种 Template\n      const template = chunk.hasRuntime() ? this.mainTemplate : this.chunkTemplate;\n      const manifest = template.getRenderManifest({\n        chunk,\n        hash: this.hash,\n        fullHash: this.fullHash,\n        outputOptions,\n        moduleTemplates: this.moduleTemplates,\n        dependencyTemplates: this.dependencyTemplates\n      }); // [{ render(), filenameTemplate, pathOptions, identifier, hash }]\n      for (const fileManifest of manifest) {\n        // .....\n      }\n      // .....\n      // 写入 assets 对象\n      this.assets[file] = source;\n      chunk.files.push(file);\n      this.hooks.chunkAsset.call(chunk, file);\n      alreadyWrittenFiles.set(file, {\n        hash: usedHash,\n        source,\n        chunk\n      });\n    } catch (err) {\n      // ......\n    }\n  }\n}`, `72737852872826840000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">createChunkAssets</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// ......</span>\n  <span class="token comment">// 遍历 chunk</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>chunks<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> chunk <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>chunks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>\n    chunk<span class="token punctuation">.</span>files <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n    <span class="token keyword">let</span> source<span class="token punctuation">;</span>\n    <span class="token keyword">let</span> file<span class="token punctuation">;</span>\n    <span class="token keyword">let</span> filenameTemplate<span class="token punctuation">;</span>\n    <span class="token keyword">try</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 调用何种 Template</span>\n      <span class="token keyword">const</span> template <span class="token operator">=</span> chunk<span class="token punctuation">.</span><span class="token function">hasRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mainTemplate <span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>chunkTemplate<span class="token punctuation">;</span>\n      <span class="token keyword">const</span> manifest <span class="token operator">=</span> template<span class="token punctuation">.</span><span class="token function">getRenderManifest</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n        chunk<span class="token punctuation">,</span>\n        hash<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>hash<span class="token punctuation">,</span>\n        fullHash<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fullHash<span class="token punctuation">,</span>\n        outputOptions<span class="token punctuation">,</span>\n        moduleTemplates<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>moduleTemplates<span class="token punctuation">,</span>\n        dependencyTemplates<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>dependencyTemplates\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [{ render(), filenameTemplate, pathOptions, identifier, hash }]</span>\n      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> fileManifest <span class="token keyword">of</span> manifest<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token comment">// .....</span>\n      <span class="token punctuation">}</span>\n      <span class="token comment">// .....</span>\n      <span class="token comment">// 写入 assets 对象</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>assets<span class="token punctuation">[</span>file<span class="token punctuation">]</span> <span class="token operator">=</span> source<span class="token punctuation">;</span>\n      chunk<span class="token punctuation">.</span>files<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">chunkAsset</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>chunk<span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      alreadyWrittenFiles<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n        hash<span class="token punctuation">:</span> usedHash<span class="token punctuation">,</span>\n        source<span class="token punctuation">,</span>\n        chunk\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// ......</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>createChunkAssets 会生成文件名和对应的文件内容，并放入 Compilation.assets 对象， 这里有四个 Template 的子类，分别是 MainTemplate.js、ChunkTemplate.js、ModuleTemplate.js、HotUpdateChunkTemplate.js</p>\n<ul>\n<li>MainTemplate.js: 对应了在 entry 配置的入口 chunk 的渲染模板</li>\n<li>ChunkTemplate: 动态引入的非入口 chunk 的渲染模板</li>\n<li>ModuleTemplate.js: chunk 中的 module 的渲染模板</li>\n<li>HotUpdateChunkTemplate.js: 对热替换模块的一个处理。</li>\n</ul>\n<p>模块在封装的时候和它在构建时一样，都是调用各模块类中的方法。封装通过调用 module.source() 来进行各操作，比如说 require() 的替换。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="62064624406739900000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`MainTemplate.prototype.requireFn = \'__webpack_require__\';\nMainTemplate.prototype.render = function(hash, chunk, moduleTemplate, dependencyTemplates) {\n  var buf = [];\n  // 每一个 module 都有一个 moduleId，在最后会替换。\n  buf.push(\'function \' + this.requireFn + \'(moduleId) {\');\n  buf.push(this.indent(this.applyPluginsWaterfall(\'require\', \'\', chunk, hash)));\n  buf.push(\'}\');\n  buf.push(\'\');\n  // ... // 其余封装操作\n};`, `62064624406739900000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token class-name">MainTemplate</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>requireFn <span class="token operator">=</span> <span class="token string">\'__webpack_require__\'</span><span class="token punctuation">;</span>\n<span class="token class-name">MainTemplate</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">render</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">hash<span class="token punctuation">,</span> chunk<span class="token punctuation">,</span> moduleTemplate<span class="token punctuation">,</span> dependencyTemplates</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> buf <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token comment">// 每一个 module 都有一个 moduleId，在最后会替换。</span>\n  buf<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">\'function \'</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>requireFn <span class="token operator">+</span> <span class="token string">\'(moduleId) {\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  buf<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">indent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">applyPluginsWaterfall</span><span class="token punctuation">(</span><span class="token string">\'require\'</span><span class="token punctuation">,</span> <span class="token string">\'\'</span><span class="token punctuation">,</span> chunk<span class="token punctuation">,</span> hash<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  buf<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">\'}\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  buf<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">\'\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// ... // 其余封装操作</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>最后看看 Compilation.assets 对象</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2021-09-02-14-19-35-d3f7efd0da5a5becf814a74bbea3ac0e-f37c3.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 47.54578754578754%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABKklEQVQoz4WR62rDMAyF8/7P118bbG3usS3JkZ34kjSdkm7Q3agQ4oD5pMNxAZ3BDrA3oA0ze0SntUdgrdloD8BKORHGyNM8+ZxzOkpEgSVSRbYh0ysk8mrwTTP1nWtqLi++bV1dua71e3eR+fZQBVQIF6SOjNYAQErFcczeR2tFJObsnMx0zDWlbzBWiCUJDFoj4hc8pYOUjpZk0Sec809YbN9hALQHvEzzTgp/MOI2ef83LJetwEoD7raDpWXysiIgCCy2A6KIyGOe519wRXgBI7Fb0sOg+14CvS7LGuM+U9pFznsvy7ZtD4GVAiOUYKpaztZty87dntV2VCFRS+uzMe9v8PpyPp0c0f58vT5dUbAiZ8bZuhCjfPzEvIRwN/kfs66rkyBC+ACrej0wpgRdPgAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2021 09 02 14 19 35" title="" data-src="/static/2021-09-02-14-19-35-d3f7efd0da5a5becf814a74bbea3ac0e-fee1c.png" data-srcset="/static/2021-09-02-14-19-35-d3f7efd0da5a5becf814a74bbea3ac0e-a67b7.png 200w,\n/static/2021-09-02-14-19-35-d3f7efd0da5a5becf814a74bbea3ac0e-0b187.png 400w,\n/static/2021-09-02-14-19-35-d3f7efd0da5a5becf814a74bbea3ac0e-fee1c.png 800w,\n/static/2021-09-02-14-19-35-d3f7efd0da5a5becf814a74bbea3ac0e-b1a91.png 1200w,\n/static/2021-09-02-14-19-35-d3f7efd0da5a5becf814a74bbea3ac0e-f37c3.png 1365w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h2 id="done（compiler）"><a href="#done%EF%BC%88compiler%EF%BC%89" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>done（Compiler）</h2>\n<p>最后一步 webpack 调用 Compiler 中的 emitAssets()，按照 output 中的配置项将文件输出到了对应的 path 中，从而 webpack 整个打包过程结束。要注意的是，若想对结果进行处理，则需要在 emit 触发后对自定义插件进行扩展。</p>',
id:"/home/runner/work/GatsbyBlog/GatsbyBlog/blog/Webpack深入学习/index.md absPath of file >>> MarkdownRemark",timeToRead:26,frontmatter:{date:"2021-09-01 18:12:15",path:"/webpack-deep-learn/",tags:"前端, webpack, 前端构建工具, 读书笔记",title:"Webpack 深入学习",draft:null}},{excerpt:"webpack 构建后代码 打包单一模块 webpack.config.js chunk1.js 打包后，main.js（webpack 生成的一些注释已经去掉） 这其实就是一个立即执行函数，简化一下就是： 看一下自运行的匿名函数里面干了什么： 整个函数里就声明了一个变量 installedModules 和函数  ，并在函数上添加了一个 m,c,p 属性，m 属性保存的是传入的模块数组，c 属性保存的是 installedModules 变量，P…",html:'<h1 id="webpack-构建后代码"><a href="#webpack-%E6%9E%84%E5%BB%BA%E5%90%8E%E4%BB%A3%E7%A0%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>webpack 构建后代码</h1>\n<h2 id="打包单一模块"><a href="#%E6%89%93%E5%8C%85%E5%8D%95%E4%B8%80%E6%A8%A1%E5%9D%97" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>打包单一模块</h2>\n<p>webpack.config.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="86347248210736560000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`module.exports = {\n  entry: \'./chunk1.js\',\n  output: {\n    path: __dirname + \'/dist\',\n    filename: \'[name].js\'\n  }\n};`, `86347248210736560000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>\n  entry<span class="token punctuation">:</span> <span class="token string">\'./chunk1.js\'</span><span class="token punctuation">,</span>\n  output<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    path<span class="token punctuation">:</span> __dirname <span class="token operator">+</span> <span class="token string">\'/dist\'</span><span class="token punctuation">,</span>\n    filename<span class="token punctuation">:</span> <span class="token string">\'[name].js\'</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>chunk1.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="91725849508934450000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var chunk1 = 1;\nexports.chunk1 = chunk1;`, `91725849508934450000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> chunk1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>\nexports<span class="token punctuation">.</span>chunk1 <span class="token operator">=</span> chunk1<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>打包后，main.js（webpack 生成的一些注释已经去掉）</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="98094921232414020000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(function(modules) {\n  // webpackBootstrap\n  // The module cache\n  var installedModules = {};\n  // The require function\n  function __webpack_require__(moduleId) {\n    // Check if module is in cache\n    if (installedModules[moduleId]) return installedModules[moduleId].exports;\n    // Create a new module (and put it into the cache)\n    var module = (installedModules[moduleId] = {\n      exports: {},\n      id: moduleId,\n      loaded: false\n    });\n    // Execute the module function\n    modules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n    // Flag the module as loaded\n    module.loaded = true;\n    // Return the exports of the module\n    return module.exports;\n  }\n\n  // expose the modules object (__webpack_modules__)\n  __webpack_require__.m = modules;\n  // expose the module cache\n  __webpack_require__.c = installedModules;\n  // __webpack_public_path__\n  __webpack_require__.p = \'\';\n  // Load entry module and return exports\n  return __webpack_require__(0);\n})([\n  function(module, exports) {\n    var chunk1 = 1;\n    exports.chunk1 = chunk1;\n  }\n]);`, `98094921232414020000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">modules</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// webpackBootstrap</span>\n  <span class="token comment">// The module cache</span>\n  <span class="token keyword">var</span> installedModules <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token comment">// The require function</span>\n  <span class="token keyword">function</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token parameter">moduleId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// Check if module is in cache</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">return</span> installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">.</span>exports<span class="token punctuation">;</span>\n    <span class="token comment">// Create a new module (and put it into the cache)</span>\n    <span class="token keyword">var</span> module <span class="token operator">=</span> <span class="token punctuation">(</span>installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>\n      exports<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>\n      id<span class="token punctuation">:</span> moduleId<span class="token punctuation">,</span>\n      loaded<span class="token punctuation">:</span> <span class="token boolean">false</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// Execute the module function</span>\n    modules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> module<span class="token punctuation">,</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> __webpack_require__<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// Flag the module as loaded</span>\n    module<span class="token punctuation">.</span>loaded <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n    <span class="token comment">// Return the exports of the module</span>\n    <span class="token keyword">return</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token comment">// expose the modules object (__webpack_modules__)</span>\n  __webpack_require__<span class="token punctuation">.</span>m <span class="token operator">=</span> modules<span class="token punctuation">;</span>\n  <span class="token comment">// expose the module cache</span>\n  __webpack_require__<span class="token punctuation">.</span>c <span class="token operator">=</span> installedModules<span class="token punctuation">;</span>\n  <span class="token comment">// __webpack_public_path__</span>\n  __webpack_require__<span class="token punctuation">.</span>p <span class="token operator">=</span> <span class="token string">\'\'</span><span class="token punctuation">;</span>\n  <span class="token comment">// Load entry module and return exports</span>\n  <span class="token keyword">return</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">[</span>\n  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">var</span> chunk1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>\n    exports<span class="token punctuation">.</span>chunk1 <span class="token operator">=</span> chunk1<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这其实就是一个立即执行函数，简化一下就是：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="60326964193678975000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(function(module) {})([function() {}, function() {}]);`, `60326964193678975000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>看一下自运行的匿名函数里面干了什么：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="18245054298746700000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function(modules) { // webpackBootstrap\n  // modules 就是一个数组，元素就是一个个函数体，就是我们声明的模块\n  var installedModules = {};\n  // The require function\n  function __webpack_require__(moduleId) {\n      ...\n  }\n  // expose the modules object (__webpack_modules__)\n  __webpack_require__.m = modules;\n  // expose the module cache\n  __webpack_require__.c = installedModules;\n  // __webpack_public_path__\n  __webpack_require__.p = &quot;&quot;;\n  // Load entry module and return exports\n  return __webpack_require__(0);\n}`, `18245054298746700000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">modules</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// webpackBootstrap</span>\n  <span class="token comment">// modules 就是一个数组，元素就是一个个函数体，就是我们声明的模块</span>\n  <span class="token keyword">var</span> installedModules <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token comment">// The require function</span>\n  <span class="token keyword">function</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token parameter">moduleId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token operator">...</span>\n  <span class="token punctuation">}</span>\n  <span class="token comment">// expose the modules object (__webpack_modules__)</span>\n  __webpack_require__<span class="token punctuation">.</span>m <span class="token operator">=</span> modules<span class="token punctuation">;</span>\n  <span class="token comment">// expose the module cache</span>\n  __webpack_require__<span class="token punctuation">.</span>c <span class="token operator">=</span> installedModules<span class="token punctuation">;</span>\n  <span class="token comment">// __webpack_public_path__</span>\n  __webpack_require__<span class="token punctuation">.</span>p <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>\n  <span class="token comment">// Load entry module and return exports</span>\n  <span class="token keyword">return</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>整个函数里就声明了一个变量 installedModules 和函数 <code class="language-text">__webpack_require__</code>，并在函数上添加了一个 m,c,p 属性，m 属性保存的是传入的模块数组，c 属性保存的是 installedModules 变量，P 是一个空字符串。最后执行<code class="language-text">__webpack_require__</code>函数，参数为零，并将其执行结果返回。下面看一下 <code class="language-text">__webpack_require__</code> 干了什么</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="68590972201689220000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function __webpack_require__(moduleId) {\n  // moduleId 就是调用是传入的 0\n  // installedModules[0] 是 undefined，继续往下\n  if (installedModules[moduleId]) return installedModules[moduleId].exports;\n  // module 就是 {exports: {},id: 0,loaded: false}\n  var module = (installedModules[moduleId] = {\n    exports: {},\n    id: moduleId,\n    loaded: false\n  });\n  // 下面接着分析这个\n  modules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n  // 表明模块已经载入\n  module.loaded = true;\n  // 返回 module.exports(注意 modules[moduleId].call 的时候 module.exports 会被修改)\n  return module.exports;\n}`, `68590972201689220000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token parameter">moduleId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// moduleId 就是调用是传入的 0</span>\n  <span class="token comment">// installedModules[0] 是 undefined，继续往下</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">return</span> installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">.</span>exports<span class="token punctuation">;</span>\n  <span class="token comment">// module 就是 {exports: {},id: 0,loaded: false}</span>\n  <span class="token keyword">var</span> module <span class="token operator">=</span> <span class="token punctuation">(</span>installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>\n    exports<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>\n    id<span class="token punctuation">:</span> moduleId<span class="token punctuation">,</span>\n    loaded<span class="token punctuation">:</span> <span class="token boolean">false</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// 下面接着分析这个</span>\n  modules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> module<span class="token punctuation">,</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> __webpack_require__<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// 表明模块已经载入</span>\n  module<span class="token punctuation">.</span>loaded <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n  <span class="token comment">// 返回 module.exports(注意 modules[moduleId].call 的时候 module.exports 会被修改)</span>\n  <span class="token keyword">return</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>接着看一下 <code class="language-text">modules[moduleId].call(module.exports, module, module.exports, __webpack_require__)</code>，其实就是</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="71300436882453420000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`modules[moduleId].call({}, module, module.exports, __webpack_require__);`, `71300436882453420000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">modules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> module<span class="token punctuation">,</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> __webpack_require__<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>对 call 不了解当然也可以认为是这样（但是并不是等价，call 能确保当模块中使用 this 的时候，this 是指向 module.exports 的）</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="4910651181146220000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function a(module, exports) {\n  var chunk1 = 1;\n  exports.chunk1 = chunk1;\n}\na(module, exports, __webpack_require__);`, `4910651181146220000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">a</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> chunk1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>\n  exports<span class="token punctuation">.</span>chunk1 <span class="token operator">=</span> chunk1<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token function">a</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> __webpack_require__<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>传入的 module 就是 <code class="language-text">{exports: {},id: 0,loaded: false}</code>，exports 就是<code class="language-text">{}</code>，<code class="language-text">__webpack_require__</code>就是声明的<code class="language-text">__webpack_require__</code>函数(传入这个函数有什么用呢，第二节将会介绍)；运行后 module.exports 就是<code class="language-text">{chunk1:1}</code>。所以当我们使用 chunk1 这个模块的时候（比如<code class="language-text">var chunk1=require(&quot;chunk1&quot;)</code>,得到的就是一个对象<code class="language-text">{chunk1:1}</code>）。如果模块里没有<code class="language-text">exports.chunk1=chunk1</code>或者<code class="language-text">module.exports=chunk1</code>得到的就是一个空对象<code class="language-text">{}</code></p>\n<h2 id="使用模块"><a href="#%E4%BD%BF%E7%94%A8%E6%A8%A1%E5%9D%97" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用模块</h2>\n<p>上面我们已经分析了 webpack 是怎么打包一个模块的（入口文件就是一个模块），现在我们来看一下使用一个模块，然后使用模块的文件作为入口文件</p>\n<p>webpack.config.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="26288246214851617000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`module.exports = {\n  entry: \'./main.js\',\n  output: {\n    path: __dirname + \'/dist\',\n    filename: \'[name].js\'\n  }\n};`, `26288246214851617000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>\n  entry<span class="token punctuation">:</span> <span class="token string">\'./main.js\'</span><span class="token punctuation">,</span>\n  output<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    path<span class="token punctuation">:</span> __dirname <span class="token operator">+</span> <span class="token string">\'/dist\'</span><span class="token punctuation">,</span>\n    filename<span class="token punctuation">:</span> <span class="token string">\'[name].js\'</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>main.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="80800891848993440000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var chunk1 = require(\'./chunk1\');\nconsole.log(chunk1);`, `80800891848993440000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> chunk1 <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./chunk1\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>chunk1<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>打包后</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="82336727797312930000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(function(modules) {\n  // webpackBootstrap\n  // The module cache\n  var installedModules = {};\n  // The require function\n  function __webpack_require__(moduleId) {\n    // Check if module is in cache\n    if (installedModules[moduleId]) return installedModules[moduleId].exports;\n    // Create a new module (and put it into the cache)\n    var module = (installedModules[moduleId] = {\n      exports: {},\n      id: moduleId,\n      loaded: false\n    });\n    // Execute the module function\n    modules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n    // Flag the module as loaded\n    module.loaded = true;\n    // Return the exports of the module\n    return module.exports;\n  }\n  // expose the modules object (__webpack_modules__)\n  __webpack_require__.m = modules;\n  // expose the module cache\n  __webpack_require__.c = installedModules;\n  // __webpack_public_path__\n  __webpack_require__.p = \'\';\n  // Load entry module and return exports\n  return __webpack_require__(0);\n})([\n  function(module, exports, __webpack_require__) {\n    var chunk1 = __webpack_require__(1);\n    console.log(chunk1);\n  },\n  function(module, exports) {\n    var chunk1 = 1;\n    exports.chunk1 = chunk1;\n  }\n]);`, `82336727797312930000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">modules</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// webpackBootstrap</span>\n  <span class="token comment">// The module cache</span>\n  <span class="token keyword">var</span> installedModules <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token comment">// The require function</span>\n  <span class="token keyword">function</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token parameter">moduleId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// Check if module is in cache</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">return</span> installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">.</span>exports<span class="token punctuation">;</span>\n    <span class="token comment">// Create a new module (and put it into the cache)</span>\n    <span class="token keyword">var</span> module <span class="token operator">=</span> <span class="token punctuation">(</span>installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>\n      exports<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>\n      id<span class="token punctuation">:</span> moduleId<span class="token punctuation">,</span>\n      loaded<span class="token punctuation">:</span> <span class="token boolean">false</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// Execute the module function</span>\n    modules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> module<span class="token punctuation">,</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> __webpack_require__<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// Flag the module as loaded</span>\n    module<span class="token punctuation">.</span>loaded <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n    <span class="token comment">// Return the exports of the module</span>\n    <span class="token keyword">return</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token comment">// expose the modules object (__webpack_modules__)</span>\n  __webpack_require__<span class="token punctuation">.</span>m <span class="token operator">=</span> modules<span class="token punctuation">;</span>\n  <span class="token comment">// expose the module cache</span>\n  __webpack_require__<span class="token punctuation">.</span>c <span class="token operator">=</span> installedModules<span class="token punctuation">;</span>\n  <span class="token comment">// __webpack_public_path__</span>\n  __webpack_require__<span class="token punctuation">.</span>p <span class="token operator">=</span> <span class="token string">\'\'</span><span class="token punctuation">;</span>\n  <span class="token comment">// Load entry module and return exports</span>\n  <span class="token keyword">return</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">[</span>\n  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">var</span> chunk1 <span class="token operator">=</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>chunk1<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">var</span> chunk1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>\n    exports<span class="token punctuation">.</span>chunk1 <span class="token operator">=</span> chunk1<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>不一样的地方就是自执行函数的参数由</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="64257539640607875000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`[\n  function(module, exports) {\n    var chunk1 = 1;\n    exports.chunk1 = chunk1;\n  }\n];`, `64257539640607875000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token punctuation">[</span>\n  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">var</span> chunk1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>\n    exports<span class="token punctuation">.</span>chunk1 <span class="token operator">=</span> chunk1<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">]</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>变为</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="61681088117511676000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`[\n  function(module, exports, __webpack_require__) {\n    var chunk1 = __webpack_require__(1);\n    console.log(chunk1);\n  },\n  function(module, exports) {\n    var chunk1 = 1;\n    exports.chunk1 = chunk1;\n  }\n];`, `61681088117511676000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token punctuation">[</span>\n  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">var</span> chunk1 <span class="token operator">=</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>chunk1<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">var</span> chunk1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>\n    exports<span class="token punctuation">.</span>chunk1 <span class="token operator">=</span> chunk1<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">]</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>其实就是多了一个 main 模块，不过这个模块没有导出项，而且这个模块依赖于 chunk1 模块。所以当运行<code class="language-text">__webpack_require__(0)</code>的时候，main 模块缓存到<code class="language-text">installedModules[0]</code>上，<code class="language-text">modules[0].call</code>(也就是调用 main 模块)的时候，chunk1 被缓存到<code class="language-text">installedModules[1]</code>上，并且导出对象<code class="language-text">{chunk1：1}</code>给模块 main 使用</p>\n<h2 id="重复使用模块"><a href="#%E9%87%8D%E5%A4%8D%E4%BD%BF%E7%94%A8%E6%A8%A1%E5%9D%97" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>重复使用模块</h2>\n<p>webpack.config.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="23951074373521730000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`module.exports = {\n  entry: \'./main.js\',\n  output: {\n    path: __dirname + \'/dist\',\n    filename: \'[name].js\'\n  }\n};`, `23951074373521730000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>\n  entry<span class="token punctuation">:</span> <span class="token string">\'./main.js\'</span><span class="token punctuation">,</span>\n  output<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    path<span class="token punctuation">:</span> __dirname <span class="token operator">+</span> <span class="token string">\'/dist\'</span><span class="token punctuation">,</span>\n    filename<span class="token punctuation">:</span> <span class="token string">\'[name].js\'</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>main.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="35500707777545703000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var chunk1 = require(\'./chunk1\');\nvar chunk2 = require(\'./chunk2\');\nconsole.log(chunk1);\nconsole.log(chunk2);`, `35500707777545703000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> chunk1 <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./chunk1\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> chunk2 <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./chunk2\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>chunk1<span class="token punctuation">)</span><span class="token punctuation">;</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>chunk2<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>chunk1.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="55857851134815400000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var chunk2 = require(\'./chunk2\');\nvar chunk1 = 1;\nexports.chunk1 = chunk1;`, `55857851134815400000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> chunk2 <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./chunk2\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> chunk1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>\nexports<span class="token punctuation">.</span>chunk1 <span class="token operator">=</span> chunk1<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>chunk2.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="16693844448281926000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var chunk2 = 1;\nexports.chunk2 = chunk2;`, `16693844448281926000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> chunk2 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>\nexports<span class="token punctuation">.</span>chunk2 <span class="token operator">=</span> chunk2<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>打包后</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="36077182269870445000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(function(modules) {\n  // webpackBootstrap\n  // The module cache\n  var installedModules = {};\n  // The require function\n  function __webpack_require__(moduleId) {\n    // Check if module is in cache\n    if (installedModules[moduleId]) return installedModules[moduleId].exports;\n    // Create a new module (and put it into the cache)\n    var module = (installedModules[moduleId] = {\n      exports: {},\n      id: moduleId,\n      loaded: false\n    });\n    // Execute the module function\n    modules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n    // Flag the module as loaded\n    module.loaded = true;\n    // Return the exports of the module\n    return module.exports;\n  }\n  // expose the modules object (__webpack_modules__)\n  __webpack_require__.m = modules;\n  // expose the module cache\n  __webpack_require__.c = installedModules;\n  // __webpack_public_path__\n  __webpack_require__.p = \'\';\n  // Load entry module and return exports\n  return __webpack_require__(0);\n})([\n  function(module, exports, __webpack_require__) {\n    var chunk1 = __webpack_require__(1);\n    var chunk2 = __webpack_require__(2);\n    console.log(chunk1);\n    console.log(chunk2);\n  },\n  function(module, exports, __webpack_require__) {\n    __webpack_require__(2);\n    var chunk1 = 1;\n    exports.chunk1 = chunk1;\n  },\n  function(module, exports) {\n    var chunk2 = 1;\n    exports.chunk2 = chunk2;\n  }\n]);`, `36077182269870445000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">modules</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// webpackBootstrap</span>\n  <span class="token comment">// The module cache</span>\n  <span class="token keyword">var</span> installedModules <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token comment">// The require function</span>\n  <span class="token keyword">function</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token parameter">moduleId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// Check if module is in cache</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">return</span> installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">.</span>exports<span class="token punctuation">;</span>\n    <span class="token comment">// Create a new module (and put it into the cache)</span>\n    <span class="token keyword">var</span> module <span class="token operator">=</span> <span class="token punctuation">(</span>installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>\n      exports<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>\n      id<span class="token punctuation">:</span> moduleId<span class="token punctuation">,</span>\n      loaded<span class="token punctuation">:</span> <span class="token boolean">false</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// Execute the module function</span>\n    modules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> module<span class="token punctuation">,</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> __webpack_require__<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// Flag the module as loaded</span>\n    module<span class="token punctuation">.</span>loaded <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n    <span class="token comment">// Return the exports of the module</span>\n    <span class="token keyword">return</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token comment">// expose the modules object (__webpack_modules__)</span>\n  __webpack_require__<span class="token punctuation">.</span>m <span class="token operator">=</span> modules<span class="token punctuation">;</span>\n  <span class="token comment">// expose the module cache</span>\n  __webpack_require__<span class="token punctuation">.</span>c <span class="token operator">=</span> installedModules<span class="token punctuation">;</span>\n  <span class="token comment">// __webpack_public_path__</span>\n  __webpack_require__<span class="token punctuation">.</span>p <span class="token operator">=</span> <span class="token string">\'\'</span><span class="token punctuation">;</span>\n  <span class="token comment">// Load entry module and return exports</span>\n  <span class="token keyword">return</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">[</span>\n  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">var</span> chunk1 <span class="token operator">=</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">var</span> chunk2 <span class="token operator">=</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>chunk1<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>chunk2<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">var</span> chunk1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>\n    exports<span class="token punctuation">.</span>chunk1 <span class="token operator">=</span> chunk1<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">var</span> chunk2 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>\n    exports<span class="token punctuation">.</span>chunk2 <span class="token operator">=</span> chunk2<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>不难发现，当需要重复使用模块的时候，缓存变量 installedModules 就起作用了</p>\n<h2 id="多个打包入口"><a href="#%E5%A4%9A%E4%B8%AA%E6%89%93%E5%8C%85%E5%85%A5%E5%8F%A3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>多个打包入口</h2>\n<p>不管是单一模块还是重复模块，和以上两种一样</p>\n<h2 id="入口参数为数组"><a href="#%E5%85%A5%E5%8F%A3%E5%8F%82%E6%95%B0%E4%B8%BA%E6%95%B0%E7%BB%84" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>入口参数为数组</h2>\n<p>chunk1.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="44491477840879034000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var chunk1 = 1;\nexports.chunk1 = chunk1;`, `44491477840879034000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> chunk1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>\nexports<span class="token punctuation">.</span>chunk1 <span class="token operator">=</span> chunk1<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>main.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="43358914894647890000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var chunk1 = require(\'./chunk1\');\nconsole.log(chunk1);`, `43358914894647890000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> chunk1 <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./chunk1\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>chunk1<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>main1.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="11900640935411898000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var chunk1 = require(\'./chunk1\');`, `11900640935411898000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> chunk1 <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./chunk1\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>webpack.config.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="86066270693406490000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`module.exports = {\n  entry: [\'./main.js\', \'./main1.js\'],\n  output: {\n    path: __dirname + \'/dist\',\n    filename: \'[name].js\'\n  }\n};`, `86066270693406490000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>\n  entry<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'./main.js\'</span><span class="token punctuation">,</span> <span class="token string">\'./main1.js\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n  output<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    path<span class="token punctuation">:</span> __dirname <span class="token operator">+</span> <span class="token string">\'/dist\'</span><span class="token punctuation">,</span>\n    filename<span class="token punctuation">:</span> <span class="token string">\'[name].js\'</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>打包后</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="73553800533265830000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`[\n  /* 0：运行模块 main，main1 */\n  function(module, exports, __webpack_require__) {\n    __webpack_require__(1);\n    module.exports = __webpack_require__(3);\n  },\n  /* 1：main 模块 */\n  function(module, exports, __webpack_require__) {\n    var chunk1 = __webpack_require__(2);\n    console.log(chunk1);\n  },\n  /* 2：chunk1 模块 */\n  function(module, exports) {\n    var chunk1 = 1;\n    exports.chunk1 = chunk1;\n  },\n  /* 3：main1 模块 */\n  function(module, exports, __webpack_require__) {\n    var chunk1 = __webpack_require__(2);\n  }\n];`, `73553800533265830000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token punctuation">[</span>\n  <span class="token comment">/* 0：运行模块 main，main1 */</span>\n  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token comment">/* 1：main 模块 */</span>\n  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">var</span> chunk1 <span class="token operator">=</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>chunk1<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token comment">/* 2：chunk1 模块 */</span>\n  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">var</span> chunk1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>\n    exports<span class="token punctuation">.</span>chunk1 <span class="token operator">=</span> chunk1<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token comment">/* 3：main1 模块 */</span>\n  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">var</span> chunk1 <span class="token operator">=</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">]</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这里只截取自执行匿名函数的参数，因为其他代码与之前一样。可以看到 1 就是 main 模块，2 就是 chunk1 模块，3 就是 main1 模块，0 的作用就是运行模块 main、main1，然后将 main1 模块导出（main1 中没有导出项，所以到导出 <code class="language-text">{}</code>），总结一下：入口参数是字符串不管是多入口还是单入口，最后都会将入口模块的导出项导出，没有导出项就导出 <code class="language-text">{}</code>，而入口参数是数组，就会将最后一个模块导出（webpack 官网有说明）</p>\n<h2 id="使用-commonschunkplugin-插件"><a href="#%E4%BD%BF%E7%94%A8-commonschunkplugin-%E6%8F%92%E4%BB%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用 CommonsChunkPlugin 插件</h2>\n<p>chunk1.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="70831532930187650000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var chunk1 = 1;\nexports.chunk1 = chunk1;`, `70831532930187650000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> chunk1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>\nexports<span class="token punctuation">.</span>chunk1 <span class="token operator">=</span> chunk1<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>main.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="82765681872328070000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var chunk1 = require(\'./chunk1\');\nconsole.log(chunk1);`, `82765681872328070000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> chunk1 <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./chunk1\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>chunk1<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>main1.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="78840418882971420000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var chunk1 = require(\'./chunk1\');\nconsole.log(chunk1);`, `78840418882971420000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> chunk1 <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./chunk1\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>chunk1<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>webpack.config.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="97547328092412080000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var CommonsChunkPlugin = require(\'webpack/lib/optimize/CommonsChunkPlugin\');\nmodule.exports = {\n  entry: {\n    main: \'./main.js\',\n    main1: \'./main1.js\'\n  },\n  output: {\n    path: __dirname + \'/dist\',\n    filename: \'[name].js\'\n  },\n  plugins: [\n    new CommonsChunkPlugin({\n      name: \'common\'\n    })\n  ]\n};`, `97547328092412080000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> CommonsChunkPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'webpack/lib/optimize/CommonsChunkPlugin\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nmodule<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>\n  entry<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    main<span class="token punctuation">:</span> <span class="token string">\'./main.js\'</span><span class="token punctuation">,</span>\n    main1<span class="token punctuation">:</span> <span class="token string">\'./main1.js\'</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  output<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    path<span class="token punctuation">:</span> __dirname <span class="token operator">+</span> <span class="token string">\'/dist\'</span><span class="token punctuation">,</span>\n    filename<span class="token punctuation">:</span> <span class="token string">\'[name].js\'</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n    <span class="token keyword">new</span> <span class="token class-name">CommonsChunkPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n      name<span class="token punctuation">:</span> <span class="token string">\'common\'</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  <span class="token punctuation">]</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>main、main1 都 require 了 chunk1，所以 chunk1 会被打包到 common。</p>\n<p>common.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="72114925603733650000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(function(modules) {\n  // webpackBootstrap\n  // install a JSONP callback for chunk loading\n  var parentJsonpFunction = window[\'webpackJsonp\'];\n  window[\'webpackJsonp\'] = function webpackJsonpCallback(chunkIds, moreModules) {\n    // add &quot;moreModules&quot; to the modules object,\n    // then flag all &quot;chunkIds&quot; as loaded and fire callback\n    var moduleId,\n      chunkId,\n      i = 0,\n      callbacks = [];\n    for (; i < chunkIds.length; i++) {\n      chunkId = chunkIds[i];\n      if (installedChunks[chunkId]) callbacks.push.apply(callbacks, installedChunks[chunkId]);\n      installedChunks[chunkId] = 0;\n    }\n    for (moduleId in moreModules) {\n      modules[moduleId] = moreModules[moduleId];\n    }\n    if (parentJsonpFunction) parentJsonpFunction(chunkIds, moreModules);\n    while (callbacks.length) callbacks.shift().call(null, __webpack_require__);\n    if (moreModules[0]) {\n      installedModules[0] = 0;\n      return __webpack_require__(0);\n    }\n  };\n  // The module cache\n  var installedModules = {};\n  // object to store loaded and loading chunks\n  // &quot;0&quot; means &quot;already loaded&quot;\n  // Array means &quot;loading&quot;, array contains callbacks\n  var installedChunks = {\n    2: 0\n  };\n  // The require function\n  function __webpack_require__(moduleId) {\n    // Check if module is in cache\n    if (installedModules[moduleId]) return installedModules[moduleId].exports;\n    // Create a new module (and put it into the cache)\n    var module = (installedModules[moduleId] = {\n      exports: {},\n      id: moduleId,\n      loaded: false\n    });\n    // Execute the module function\n    modules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n    // Flag the module as loaded\n    module.loaded = true;\n    // Return the exports of the module\n    return module.exports;\n  }\n  // This file contains only the entry chunk.\n  // The chunk loading function for additional chunks\n  __webpack_require__.e = function requireEnsure(chunkId, callback) {\n    // &quot;0&quot; is the signal for &quot;already loaded&quot;\n    if (installedChunks[chunkId] === 0) return callback.call(null, __webpack_require__);\n    // an array means &quot;currently loading&quot;.\n    if (installedChunks[chunkId] !== undefined) {\n      installedChunks[chunkId].push(callback);\n    } else {\n      // start chunk loading\n      installedChunks[chunkId] = [callback];\n      var head = document.getElementsByTagName(\'head\')[0];\n      var script = document.createElement(\'script\');\n      script.type = \'text/javascript\';\n      script.charset = \'utf-8\';\n      script.async = true;\n      script.src =\n        __webpack_require__.p + \'\' + chunkId + \'.\' + ({ \'0\': \'main\', \'1\': \'main1\' }[chunkId] || chunkId) + \'.js\';\n      head.appendChild(script);\n    }\n  };\n  // expose the modules object (__webpack_modules__)\n  __webpack_require__.m = modules;\n  // expose the module cache\n  __webpack_require__.c = installedModules;\n  // __webpack_public_path__\n  __webpack_require__.p = \'\';\n})([\n  ,\n  function(module, exports) {\n    var chunk1 = 1;\n    exports.chunk1 = chunk1;\n  }\n]);`, `72114925603733650000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">modules</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// webpackBootstrap</span>\n  <span class="token comment">// install a JSONP callback for chunk loading</span>\n  <span class="token keyword">var</span> parentJsonpFunction <span class="token operator">=</span> window<span class="token punctuation">[</span><span class="token string">\'webpackJsonp\'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  window<span class="token punctuation">[</span><span class="token string">\'webpackJsonp\'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">webpackJsonpCallback</span><span class="token punctuation">(</span><span class="token parameter">chunkIds<span class="token punctuation">,</span> moreModules</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// add "moreModules" to the modules object,</span>\n    <span class="token comment">// then flag all "chunkIds" as loaded and fire callback</span>\n    <span class="token keyword">var</span> moduleId<span class="token punctuation">,</span>\n      chunkId<span class="token punctuation">,</span>\n      i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>\n      callbacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> chunkIds<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      chunkId <span class="token operator">=</span> chunkIds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span><span class="token punctuation">)</span> callbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>callbacks<span class="token punctuation">,</span> installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">for</span> <span class="token punctuation">(</span>moduleId <span class="token keyword">in</span> moreModules<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      modules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span> <span class="token operator">=</span> moreModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>parentJsonpFunction<span class="token punctuation">)</span> <span class="token function">parentJsonpFunction</span><span class="token punctuation">(</span>chunkIds<span class="token punctuation">,</span> moreModules<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">while</span> <span class="token punctuation">(</span>callbacks<span class="token punctuation">.</span>length<span class="token punctuation">)</span> callbacks<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> __webpack_require__<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>moreModules<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      installedModules<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n      <span class="token keyword">return</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token comment">// The module cache</span>\n  <span class="token keyword">var</span> installedModules <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token comment">// object to store loaded and loading chunks</span>\n  <span class="token comment">// "0" means "already loaded"</span>\n  <span class="token comment">// Array means "loading", array contains callbacks</span>\n  <span class="token keyword">var</span> installedChunks <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token number">2</span><span class="token punctuation">:</span> <span class="token number">0</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token comment">// The require function</span>\n  <span class="token keyword">function</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token parameter">moduleId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// Check if module is in cache</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">return</span> installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">.</span>exports<span class="token punctuation">;</span>\n    <span class="token comment">// Create a new module (and put it into the cache)</span>\n    <span class="token keyword">var</span> module <span class="token operator">=</span> <span class="token punctuation">(</span>installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>\n      exports<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>\n      id<span class="token punctuation">:</span> moduleId<span class="token punctuation">,</span>\n      loaded<span class="token punctuation">:</span> <span class="token boolean">false</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// Execute the module function</span>\n    modules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> module<span class="token punctuation">,</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> __webpack_require__<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// Flag the module as loaded</span>\n    module<span class="token punctuation">.</span>loaded <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n    <span class="token comment">// Return the exports of the module</span>\n    <span class="token keyword">return</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token comment">// This file contains only the entry chunk.</span>\n  <span class="token comment">// The chunk loading function for additional chunks</span>\n  __webpack_require__<span class="token punctuation">.</span><span class="token function-variable function">e</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">requireEnsure</span><span class="token punctuation">(</span><span class="token parameter">chunkId<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// "0" is the signal for "already loaded"</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> __webpack_require__<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// an array means "currently loading".</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n      <span class="token comment">// start chunk loading</span>\n      installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>callback<span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token keyword">var</span> head <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">\'head\'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token keyword">var</span> script <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">\'script\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      script<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">\'text/javascript\'</span><span class="token punctuation">;</span>\n      script<span class="token punctuation">.</span>charset <span class="token operator">=</span> <span class="token string">\'utf-8\'</span><span class="token punctuation">;</span>\n      script<span class="token punctuation">.</span>async <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n      script<span class="token punctuation">.</span>src <span class="token operator">=</span>\n        __webpack_require__<span class="token punctuation">.</span>p <span class="token operator">+</span> <span class="token string">\'\'</span> <span class="token operator">+</span> chunkId <span class="token operator">+</span> <span class="token string">\'.\'</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token string">\'0\'</span><span class="token punctuation">:</span> <span class="token string">\'main\'</span><span class="token punctuation">,</span> <span class="token string">\'1\'</span><span class="token punctuation">:</span> <span class="token string">\'main1\'</span> <span class="token punctuation">}</span><span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span> <span class="token operator">||</span> chunkId<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">\'.js\'</span><span class="token punctuation">;</span>\n      head<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>script<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token comment">// expose the modules object (__webpack_modules__)</span>\n  __webpack_require__<span class="token punctuation">.</span>m <span class="token operator">=</span> modules<span class="token punctuation">;</span>\n  <span class="token comment">// expose the module cache</span>\n  __webpack_require__<span class="token punctuation">.</span>c <span class="token operator">=</span> installedModules<span class="token punctuation">;</span>\n  <span class="token comment">// __webpack_public_path__</span>\n  __webpack_require__<span class="token punctuation">.</span>p <span class="token operator">=</span> <span class="token string">\'\'</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">[</span>\n  <span class="token punctuation">,</span>\n  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">var</span> chunk1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>\n    exports<span class="token punctuation">.</span>chunk1 <span class="token operator">=</span> chunk1<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>main.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="71920538126611640000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`webpackJsonp(\n  [0],\n  [\n    function(module, exports, __webpack_require__) {\n      var chunk1 = __webpack_require__(1);\n      console.log(chunk1);\n    }\n  ]\n);`, `71920538126611640000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token function">webpackJsonp</span><span class="token punctuation">(</span>\n  <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n  <span class="token punctuation">[</span>\n    <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">var</span> chunk1 <span class="token operator">=</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>chunk1<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">]</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>main1.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="87494291806722880000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`webpackJsonp(\n  [1],\n  [\n    function(module, exports, __webpack_require__) {\n      var chunk1 = __webpack_require__(1);\n      console.log(chunk1);\n    }\n  ]\n);`, `87494291806722880000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token function">webpackJsonp</span><span class="token punctuation">(</span>\n  <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n  <span class="token punctuation">[</span>\n    <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">var</span> chunk1 <span class="token operator">=</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>chunk1<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">]</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>与之前相比，多了 webpackJsonp 函数，立即执行的匿名函数没有立即调用<code class="language-text">__webpack_require__(0)</code>，看一下 webpackJsonp</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="96031980892149920000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var parentJsonpFunction = window[\'webpackJsonp\'];\nwindow[\'webpackJsonp\'] = function webpackJsonpCallback(chunkIds, moreModules) {\n  // moreModules 为独立 chunk 代码，chunkIds 标记独立 chunk 唯一性避免按需加载时重复加载\n  // 以 main.js 中代码为例，chunkIds 为 [0]，moreModules 为\n  // [function(module, exports, __webpack_require__) {\n  //     var chunk1=__webpack_require__(1);\n  //    console.log(chunk1);\n  // }]\n  var moduleId,\n    chunkId,\n    i = 0,\n    callbacks = [];\n  for (; i < chunkIds.length; i++) {\n    chunkId = chunkIds[i]; // chunkId = 0\n    if (installedChunks[chunkId]) callbacks.push.apply(callbacks, installedChunks[chunkId]); // 0 push 入 callbacks(使用 requireEnsure 不再是 0)\n    // 赋值为 0 表明 chunk 已经 loaded\n    installedChunks[chunkId] = 0;\n  }\n  for (moduleId in moreModules) {\n    // modules[0] 会被覆盖\n    modules[moduleId] = moreModules[moduleId];\n  }\n  // 按当前情况 parentJsonpFunction 一直未 undefined\n  if (parentJsonpFunction) parentJsonpFunction(chunkIds, moreModules);\n  // 按当前情况 callbacks = []\n  while (callbacks.length) callbacks.shift().call(null, __webpack_require__);\n  if (moreModules[0]) {\n    installedModules[0] = 0;\n    return __webpack_require__(0);\n  }\n};\n// 缓存模块，通过闭包引用(window[&quot;webpackJsonp&quot;] 可以访问到)\nvar installedModules = {};\n// 2 为公共 chunk 唯一 ID，0 表示已经 loaded\nvar installedChunks = {\n  2: 0\n};\n// The require function\nfunction __webpack_require__(moduleId) {\n  // Check if module is in cache\n  if (installedModules[moduleId]) return installedModules[moduleId].exports;\n  // Create a new module (and put it into the cache)\n  var module = (installedModules[moduleId] = {\n    exports: {},\n    id: moduleId,\n    loaded: false\n  });\n  // Execute the module function\n  modules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n  // Flag the module as loaded\n  module.loaded = true;\n  // Return the exports of the module\n  return module.exports;\n}\n// 按需加载\n__webpack_require__.e = function requireEnsure(chunkId, callback) {\n  // &quot;0&quot; is the signal for &quot;already loaded&quot;\n  if (installedChunks[chunkId] === 0) return callback.call(null, __webpack_require__);\n  // an array means &quot;currently loading&quot;.\n  if (installedChunks[chunkId] !== undefined) {\n    installedChunks[chunkId].push(callback);\n  } else {\n    // start chunk loading\n    installedChunks[chunkId] = [callback];\n    var head = document.getElementsByTagName(\'head\')[0];\n    var script = document.createElement(\'script\');\n    script.type = \'text/javascript\';\n    script.charset = \'utf-8\';\n    script.async = true;\n    script.src =\n      __webpack_require__.p + \'\' + chunkId + \'.\' + ({ \'0\': \'main\', \'1\': \'main1\' }[chunkId] || chunkId) + \'.js\';\n    head.appendChild(script);\n  }\n};`, `96031980892149920000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> parentJsonpFunction <span class="token operator">=</span> window<span class="token punctuation">[</span><span class="token string">\'webpackJsonp\'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\nwindow<span class="token punctuation">[</span><span class="token string">\'webpackJsonp\'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">webpackJsonpCallback</span><span class="token punctuation">(</span><span class="token parameter">chunkIds<span class="token punctuation">,</span> moreModules</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// moreModules 为独立 chunk 代码，chunkIds 标记独立 chunk 唯一性避免按需加载时重复加载</span>\n  <span class="token comment">// 以 main.js 中代码为例，chunkIds 为 [0]，moreModules 为</span>\n  <span class="token comment">// [function(module, exports, __webpack_require__) {</span>\n  <span class="token comment">//     var chunk1=__webpack_require__(1);</span>\n  <span class="token comment">//    console.log(chunk1);</span>\n  <span class="token comment">// }]</span>\n  <span class="token keyword">var</span> moduleId<span class="token punctuation">,</span>\n    chunkId<span class="token punctuation">,</span>\n    i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>\n    callbacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> chunkIds<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    chunkId <span class="token operator">=</span> chunkIds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// chunkId = 0</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span><span class="token punctuation">)</span> callbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>callbacks<span class="token punctuation">,</span> installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 0 push 入 callbacks(使用 requireEnsure 不再是 0)</span>\n    <span class="token comment">// 赋值为 0 表明 chunk 已经 loaded</span>\n    installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span>moduleId <span class="token keyword">in</span> moreModules<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// modules[0] 会被覆盖</span>\n    modules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span> <span class="token operator">=</span> moreModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token comment">// 按当前情况 parentJsonpFunction 一直未 undefined</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>parentJsonpFunction<span class="token punctuation">)</span> <span class="token function">parentJsonpFunction</span><span class="token punctuation">(</span>chunkIds<span class="token punctuation">,</span> moreModules<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// 按当前情况 callbacks = []</span>\n  <span class="token keyword">while</span> <span class="token punctuation">(</span>callbacks<span class="token punctuation">.</span>length<span class="token punctuation">)</span> callbacks<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> __webpack_require__<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>moreModules<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    installedModules<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n    <span class="token keyword">return</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token comment">// 缓存模块，通过闭包引用(window["webpackJsonp"] 可以访问到)</span>\n<span class="token keyword">var</span> installedModules <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token comment">// 2 为公共 chunk 唯一 ID，0 表示已经 loaded</span>\n<span class="token keyword">var</span> installedChunks <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token number">2</span><span class="token punctuation">:</span> <span class="token number">0</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token comment">// The require function</span>\n<span class="token keyword">function</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token parameter">moduleId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// Check if module is in cache</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">return</span> installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">.</span>exports<span class="token punctuation">;</span>\n  <span class="token comment">// Create a new module (and put it into the cache)</span>\n  <span class="token keyword">var</span> module <span class="token operator">=</span> <span class="token punctuation">(</span>installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>\n    exports<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>\n    id<span class="token punctuation">:</span> moduleId<span class="token punctuation">,</span>\n    loaded<span class="token punctuation">:</span> <span class="token boolean">false</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// Execute the module function</span>\n  modules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> module<span class="token punctuation">,</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> __webpack_require__<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// Flag the module as loaded</span>\n  module<span class="token punctuation">.</span>loaded <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n  <span class="token comment">// Return the exports of the module</span>\n  <span class="token keyword">return</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token comment">// 按需加载</span>\n__webpack_require__<span class="token punctuation">.</span><span class="token function-variable function">e</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">requireEnsure</span><span class="token punctuation">(</span><span class="token parameter">chunkId<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// "0" is the signal for "already loaded"</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> __webpack_require__<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// an array means "currently loading".</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n    <span class="token comment">// start chunk loading</span>\n    installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>callback<span class="token punctuation">]</span><span class="token punctuation">;</span>\n    <span class="token keyword">var</span> head <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">\'head\'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n    <span class="token keyword">var</span> script <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">\'script\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    script<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">\'text/javascript\'</span><span class="token punctuation">;</span>\n    script<span class="token punctuation">.</span>charset <span class="token operator">=</span> <span class="token string">\'utf-8\'</span><span class="token punctuation">;</span>\n    script<span class="token punctuation">.</span>async <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n    script<span class="token punctuation">.</span>src <span class="token operator">=</span>\n      __webpack_require__<span class="token punctuation">.</span>p <span class="token operator">+</span> <span class="token string">\'\'</span> <span class="token operator">+</span> chunkId <span class="token operator">+</span> <span class="token string">\'.\'</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token string">\'0\'</span><span class="token punctuation">:</span> <span class="token string">\'main\'</span><span class="token punctuation">,</span> <span class="token string">\'1\'</span><span class="token punctuation">:</span> <span class="token string">\'main1\'</span> <span class="token punctuation">}</span><span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span> <span class="token operator">||</span> chunkId<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">\'.js\'</span><span class="token punctuation">;</span>\n    head<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>script<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>好像看不出什么。。。，修改一下</p>\n<p>webpack.config.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="75129191727256470000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var CommonsChunkPlugin = require(\'webpack/lib/optimize/CommonsChunkPlugin\');\nmodule.exports = {\n  entry: {\n    main: \'./main.js\',\n    main1: \'./main1.js\',\n    chunk1: [\'./chunk1\']\n  },\n  output: {\n    path: __dirname + \'/dist2\',\n    filename: \'[name].js\'\n  },\n  plugins: [\n    new CommonsChunkPlugin({\n      name: [\'chunk1\'],\n      filename: \'common.js\',\n      minChunks: 3\n    })\n  ]\n};`, `75129191727256470000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> CommonsChunkPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'webpack/lib/optimize/CommonsChunkPlugin\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nmodule<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>\n  entry<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    main<span class="token punctuation">:</span> <span class="token string">\'./main.js\'</span><span class="token punctuation">,</span>\n    main1<span class="token punctuation">:</span> <span class="token string">\'./main1.js\'</span><span class="token punctuation">,</span>\n    chunk1<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'./chunk1\'</span><span class="token punctuation">]</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  output<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    path<span class="token punctuation">:</span> __dirname <span class="token operator">+</span> <span class="token string">\'/dist2\'</span><span class="token punctuation">,</span>\n    filename<span class="token punctuation">:</span> <span class="token string">\'[name].js\'</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n    <span class="token keyword">new</span> <span class="token class-name">CommonsChunkPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n      name<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'chunk1\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n      filename<span class="token punctuation">:</span> <span class="token string">\'common.js\'</span><span class="token punctuation">,</span>\n      minChunks<span class="token punctuation">:</span> <span class="token number">3</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  <span class="token punctuation">]</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>main、main1 都分别 require chunk1、chunk2，然后将 chunk1 打包到公共模块（minChunks:3，chunk2 不会被打包到公共模块），自运行匿名函数最后多了</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="55208453216372064000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`return __webpack_require__(0);`, `55208453216372064000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">return</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>则 <code class="language-text">installedModules[0]</code> 为已经 loaded，看 common.js，<code class="language-text">installedModules[1]</code> 也会 loaded。</p>\n<p>main.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="1983137773304721700"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`webpackJsonp(\n  [1],\n  [\n    function(module, exports, __webpack_require__) {\n      var chunk1 = __webpack_require__(1);\n      var chunk2 = __webpack_require__(2);\n      exports.a = 1;\n      console.log(chunk1);\n    },\n    ,\n    function(module, exports) {\n      var chunk2 = 1;\n      exports.chunk2 = chunk2;\n    }\n  ]\n);`, `1983137773304721700`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token function">webpackJsonp</span><span class="token punctuation">(</span>\n  <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n  <span class="token punctuation">[</span>\n    <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">var</span> chunk1 <span class="token operator">=</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">var</span> chunk2 <span class="token operator">=</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      exports<span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>\n      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>chunk1<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token punctuation">,</span>\n    <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">var</span> chunk2 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>\n      exports<span class="token punctuation">.</span>chunk2 <span class="token operator">=</span> chunk2<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">]</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>main1.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="29773820451673915000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`webpackJsonp(\n  [2],\n  [\n    function(module, exports, __webpack_require__) {\n      var chunk1 = __webpack_require__(1);\n      var chunk2 = __webpack_require__(2);\n      exports.a = 1;\n      console.log(chunk1);\n    },\n    ,\n    function(module, exports) {\n      var chunk2 = 1;\n      exports.chunk2 = chunk2;\n    }\n  ]\n);`, `29773820451673915000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token function">webpackJsonp</span><span class="token punctuation">(</span>\n  <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n  <span class="token punctuation">[</span>\n    <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">var</span> chunk1 <span class="token operator">=</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">var</span> chunk2 <span class="token operator">=</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      exports<span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>\n      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>chunk1<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token punctuation">,</span>\n    <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">var</span> chunk2 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>\n      exports<span class="token punctuation">.</span>chunk2 <span class="token operator">=</span> chunk2<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">]</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>common.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="19638531556783677000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`[\n  function(module, exports, __webpack_require__) {\n    module.exports = __webpack_require__(1);\n  },\n  function(module, exports) {\n    var chunk1 = 1;\n    exports.chunk1 = chunk1;\n  }\n];`, `19638531556783677000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token punctuation">[</span>\n  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">var</span> chunk1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>\n    exports<span class="token punctuation">.</span>chunk1 <span class="token operator">=</span> chunk1<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">]</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>以 main.js 的代码为例，调用 webpackJsonp，传入的参数 chunkIds 为 <code class="language-text">[1]</code>, moreModules 为</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="47961627868243165000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`[\n  function(module, exports, __webpack_require__) {\n    var chunk1 = __webpack_require__(1);\n    var chunk2 = __webpack_require__(2);\n    exports.a = 1;\n    console.log(chunk1);\n  },\n  ,\n  function(module, exports) {\n    var chunk2 = 1;\n    exports.chunk2 = chunk2;\n  }\n];`, `47961627868243165000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token punctuation">[</span>\n  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">var</span> chunk1 <span class="token operator">=</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">var</span> chunk2 <span class="token operator">=</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    exports<span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>chunk1<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token punctuation">,</span>\n  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">var</span> chunk2 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>\n    exports<span class="token punctuation">.</span>chunk2 <span class="token operator">=</span> chunk2<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">]</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="87323682186656070000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var moduleId,\n  chunkId,\n  i = 0,\n  callbacks = [];\nfor (; i < chunkIds.length; i++) {\n  chunkId = chunkIds[i]; // 1\n  // false, 赋值为 0 后还是 false\n  if (installedChunks[chunkId]) callbacks.push.apply(callbacks, installedChunks[chunkId]);\n  installedChunks[chunkId] = 0;\n}\n// 三个模块\nfor (moduleId in moreModules) {\n  // moduleId: 0,1,2\n  // moreModules[1] 为空模块，自执行函数的参数(公共模块)会被覆盖，但是参数中的相应模块已经 loaded 并且缓存\n  modules[moduleId] = moreModules[moduleId];\n}\nif (parentJsonpFunction) parentJsonpFunction(chunkIds, moreModules);\nwhile (callbacks.length) callbacks.shift().call(null, __webpack_require__);\nif (moreModules[0]) {\n  // installedModules[0] 会重新 load，但是 load 的是 moreModules[0]，因为 modules[0] 已经被覆盖，moreModules[0] 依赖于\n  // modules[1]、modules[2]，modules[1] 已经 loaded\n  installedModules[0] = 0;\n  return __webpack_require__(0);\n}`, `87323682186656070000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> moduleId<span class="token punctuation">,</span>\n  chunkId<span class="token punctuation">,</span>\n  i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>\n  callbacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> chunkIds<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  chunkId <span class="token operator">=</span> chunkIds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 1</span>\n  <span class="token comment">// false, 赋值为 0 后还是 false</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span><span class="token punctuation">)</span> callbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>callbacks<span class="token punctuation">,</span> installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token comment">// 三个模块</span>\n<span class="token keyword">for</span> <span class="token punctuation">(</span>moduleId <span class="token keyword">in</span> moreModules<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// moduleId: 0,1,2</span>\n  <span class="token comment">// moreModules[1] 为空模块，自执行函数的参数(公共模块)会被覆盖，但是参数中的相应模块已经 loaded 并且缓存</span>\n  modules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span> <span class="token operator">=</span> moreModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span>parentJsonpFunction<span class="token punctuation">)</span> <span class="token function">parentJsonpFunction</span><span class="token punctuation">(</span>chunkIds<span class="token punctuation">,</span> moreModules<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">while</span> <span class="token punctuation">(</span>callbacks<span class="token punctuation">.</span>length<span class="token punctuation">)</span> callbacks<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> __webpack_require__<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span>moreModules<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// installedModules[0] 会重新 load，但是 load 的是 moreModules[0]，因为 modules[0] 已经被覆盖，moreModules[0] 依赖于</span>\n  <span class="token comment">// modules[1]、modules[2]，modules[1] 已经 loaded</span>\n  installedModules<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>再看下面的情况：common.js 自执行函数参数（公共模块）（没有 return <code class="language-text">__webpack_require__(0)</code>）</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="36744868527833250000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`[\n  ,\n  function(module, exports, __webpack_require__) {\n    var chunk1 = 1;\n    var chunk2 = __webpack_require__(2);\n    exports.chunk1 = chunk1;\n  },\n  function(module, exports) {\n    var chunk2 = 1;\n    exports.chunk2 = chunk2;\n  }\n];`, `36744868527833250000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token punctuation">[</span>\n  <span class="token punctuation">,</span>\n  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">var</span> chunk1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>\n    <span class="token keyword">var</span> chunk2 <span class="token operator">=</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    exports<span class="token punctuation">.</span>chunk1 <span class="token operator">=</span> chunk1<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">var</span> chunk2 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>\n    exports<span class="token punctuation">.</span>chunk2 <span class="token operator">=</span> chunk2<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">]</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>main.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="18373588367040305000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`webpackJsonp(\n  [0],\n  [\n    /* 0 */\n    function(module, exports, __webpack_require__) {\n      var chunk1 = __webpack_require__(1);\n      var chunk2 = __webpack_require__(2);\n      exports.a = 1;\n      console.log(chunk1);\n      // main\n    }\n  ]\n);`, `18373588367040305000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token function">webpackJsonp</span><span class="token punctuation">(</span>\n  <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n  <span class="token punctuation">[</span>\n    <span class="token comment">/* 0 */</span>\n    <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">var</span> chunk1 <span class="token operator">=</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">var</span> chunk2 <span class="token operator">=</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      exports<span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>\n      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>chunk1<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token comment">// main</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">]</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>以 main 调用分析</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="37480325365824864000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var moduleId,\n  chunkId,\n  i = 0,\n  callbacks = [];\nfor (; i < chunkIds.length; i++) {\n  chunkId = chunkIds[i]; // 0\n  if (installedChunks[chunkId]) callbacks.push.apply(callbacks, installedChunks[chunkId]);\n  installedChunks[chunkId] = 0; // 表明唯一索引为 0 的 chunk 已经 loaded\n}\nfor (moduleId in moreModules) {\n  // moreModules 只有一个元素，所以 modules[1]、modules[2] 不会被覆盖\n  modules[moduleId] = moreModules[moduleId];\n}\nif (parentJsonpFunction) parentJsonpFunction(chunkIds, moreModules);\nwhile (callbacks.length) callbacks.shift().call(null, __webpack_require__);\nif (moreModules[0]) {\n  installedModules[0] = 0;\n  // moreModules[0] 即 modules[0] 依赖 modules[1]、即 modules[2]（没有被覆盖很关键）\n  return __webpack_require__(0);\n}`, `37480325365824864000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> moduleId<span class="token punctuation">,</span>\n  chunkId<span class="token punctuation">,</span>\n  i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>\n  callbacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> chunkIds<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  chunkId <span class="token operator">=</span> chunkIds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 0</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span><span class="token punctuation">)</span> callbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>callbacks<span class="token punctuation">,</span> installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 表明唯一索引为 0 的 chunk 已经 loaded</span>\n<span class="token punctuation">}</span>\n<span class="token keyword">for</span> <span class="token punctuation">(</span>moduleId <span class="token keyword">in</span> moreModules<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// moreModules 只有一个元素，所以 modules[1]、modules[2] 不会被覆盖</span>\n  modules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span> <span class="token operator">=</span> moreModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span>parentJsonpFunction<span class="token punctuation">)</span> <span class="token function">parentJsonpFunction</span><span class="token punctuation">(</span>chunkIds<span class="token punctuation">,</span> moreModules<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">while</span> <span class="token punctuation">(</span>callbacks<span class="token punctuation">.</span>length<span class="token punctuation">)</span> callbacks<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> __webpack_require__<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span>moreModules<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  installedModules<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n  <span class="token comment">// moreModules[0] 即 modules[0] 依赖 modules[1]、即 modules[2]（没有被覆盖很关键）</span>\n  <span class="token keyword">return</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>还有这种打包情况：common.js 不包含公共模块，即自执行函数参数为 <code class="language-text">[]</code>。</p>\n<p>main.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="41341176791689980000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`webpackJsonp(\n  [0, 1],\n  [\n    function(module, exports, __webpack_require__) {\n      var chunk1 = __webpack_require__(1);\n      var chunk2 = __webpack_require__(2);\n      exports.a = 1;\n      console.log(chunk1);\n    },\n    function(module, exports) {\n      var chunk1 = 1;\n      exports.chunk1 = chunk1;\n    },\n    function(module, exports) {\n      var chunk2 = 1;\n      exports.chunk2 = chunk2;\n    }\n  ]\n);`, `41341176791689980000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token function">webpackJsonp</span><span class="token punctuation">(</span>\n  <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n  <span class="token punctuation">[</span>\n    <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">var</span> chunk1 <span class="token operator">=</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">var</span> chunk2 <span class="token operator">=</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      exports<span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>\n      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>chunk1<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">var</span> chunk1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>\n      exports<span class="token punctuation">.</span>chunk1 <span class="token operator">=</span> chunk1<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">var</span> chunk2 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>\n      exports<span class="token punctuation">.</span>chunk2 <span class="token operator">=</span> chunk2<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">]</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>以 main 调用分析</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="39593665712550250000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var moduleId,\n  chunkId,\n  i = 0,\n  callbacks = [];\nfor (; i < chunkIds.length; i++) {\n  chunkId = chunkIds[i]; // 0,1\n  if (installedChunks[chunkId]) callbacks.push.apply(callbacks, installedChunks[chunkId]);\n  installedChunks[chunkId] = 0;\n}\nfor (moduleId in moreModules) {\n  // moreModules 全部转移到 modules\n  modules[moduleId] = moreModules[moduleId];\n}\nif (parentJsonpFunction) parentJsonpFunction(chunkIds, moreModules);\nwhile (callbacks.length) callbacks.shift().call(null, __webpack_require__);\nif (moreModules[0]) {\n  // modules[0] 是 chunk 文件运行代码\n  installedModules[0] = 0;\n  return __webpack_require__(0);\n}`, `39593665712550250000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> moduleId<span class="token punctuation">,</span>\n  chunkId<span class="token punctuation">,</span>\n  i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>\n  callbacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> chunkIds<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  chunkId <span class="token operator">=</span> chunkIds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 0,1</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span><span class="token punctuation">)</span> callbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>callbacks<span class="token punctuation">,</span> installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token keyword">for</span> <span class="token punctuation">(</span>moduleId <span class="token keyword">in</span> moreModules<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// moreModules 全部转移到 modules</span>\n  modules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span> <span class="token operator">=</span> moreModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span>parentJsonpFunction<span class="token punctuation">)</span> <span class="token function">parentJsonpFunction</span><span class="token punctuation">(</span>chunkIds<span class="token punctuation">,</span> moreModules<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">while</span> <span class="token punctuation">(</span>callbacks<span class="token punctuation">.</span>length<span class="token punctuation">)</span> callbacks<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> __webpack_require__<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span>moreModules<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// modules[0] 是 chunk 文件运行代码</span>\n  installedModules<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="按需加载"><a href="#%E6%8C%89%E9%9C%80%E5%8A%A0%E8%BD%BD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>按需加载</h2>\n<p>webpack.config.json</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="37756340633932670000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`module.exports = {\n  entry: \'./main.js\',\n  output: {\n    filename: \'bundle.js\'\n  }\n};`, `37756340633932670000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>\n  entry<span class="token punctuation">:</span> <span class="token string">\'./main.js\'</span><span class="token punctuation">,</span>\n  output<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    filename<span class="token punctuation">:</span> <span class="token string">\'bundle.js\'</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>main.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="51257008164428490000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`require.ensure([\'./a\'], function(require) {\n  var content = require(\'./a\');\n  document.open();\n  document.write(\'<h1>\' + content + \'</h1>\');\n  document.close();\n});`, `51257008164428490000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">require<span class="token punctuation">.</span><span class="token function">ensure</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'./a\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">require</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> content <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./a\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  document<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  document<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">\'&lt;h1>\'</span> <span class="token operator">+</span> content <span class="token operator">+</span> <span class="token string">\'&lt;/h1>\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  document<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>a.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="43883832560952490000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`module.exports = \'Hello World\';`, `43883832560952490000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token string">\'Hello World\'</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>打包后</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="63310517660428410000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`1.bundle.js\na.js\nbundle.js\nindex.html\nmain.js\nwebpack.config.js`, `63310517660428410000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">1.bundle.js\na.js\nbundle.js\nindex.html\nmain.js\nwebpack.config.js</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>bundle.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="84775097602721990000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(function(modules) {\n  var parentJsonpFunction = window[\'webpackJsonp\']; // 全局变量可访问，可通过 webpack 配置的 output 下的 jsonpFunction 进行自定义配置，默认 webpackJsonp\n  window[\'webpackJsonp\'] = function webpackJsonpCallback(chunkIds, moreModules) {\n    var moduleId,\n      chunkId,\n      i = 0,\n      callbacks = []; // 存放从 __webpack_require__.e 传过来的 callback 数组，实际上就是其回调函数，见下文的代码注释“回调函数”处\n    for (; i < chunkIds.length; i++) {\n      chunkId = chunkIds[i];\n      if (installedChunks[chunkId]) callbacks.push.apply(callbacks, installedChunks[chunkId]); // 存放数组函数回调\n      installedChunks[chunkId] = 0; // 标记此 chunk 加载完成\n    }\n    for (moduleId in moreModules) {\n      // 这步很重要，将 chunk 传过来的 moreModules 去替换掉现有的 modules\n      // 以供下面的“回调函数”调用 __webpack_require__ 时，去调用 chunk 里面的代码\n      modules[moduleId] = moreModules[moduleId];\n    }\n    if (parentJsonpFunction) parentJsonpFunction(chunkIds, moreModules);\n    // 依次执行数组函数回调\n    while (callbacks.length) callbacks.shift().call(null, __webpack_require__);\n  };\n\n  var installedModules = {};\n\n  // 已加载的 chunkId，0 代表已加载\n  var installedChunks = {\n    0: 0\n  };\n\n  function __webpack_require__(moduleId) {\n    // 缓存\n    if (installedModules[moduleId]) return installedModules[moduleId].exports;\n\n    var module = (installedModules[moduleId] = {\n      exports: {},\n      id: moduleId,\n      loaded: false\n    });\n\n    modules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n    module.loaded = true;\n\n    return module.exports;\n  }\n\n  __webpack_require__.e = function requireEnsure(chunkId, callback) {\n    // 已加载完成直接调用\n    if (installedChunks[chunkId] === 0) return callback.call(null, __webpack_require__);\n\n    if (installedChunks[chunkId] !== undefined) {\n      installedChunks[chunkId].push(callback);\n    } else {\n      // chunk 没有加载，直接塞入“回调函数”\n      installedChunks[chunkId] = [callback];\n      var head = document.getElementsByTagName(\'head\')[0];\n      var script = document.createElement(\'script\');\n      script.type = \'text/javascript\';\n      script.charset = \'utf-8\';\n      script.async = true;\n      // 加载对应的 chunk\n      script.src = __webpack_require__.p + \'\' + chunkId + \'.bundle.js\';\n      head.appendChild(script);\n    }\n  };\n\n  // 存放 modules\n  __webpack_require__.m = modules;\n  // 存放已安装的 modules\n  __webpack_require__.c = installedModules;\n  // 存放 publicPath\n  __webpack_require__.p = \'\';\n  // 第一步执行的地方\n  return __webpack_require__(0);\n})([\n  function(module, exports, __webpack_require__) {\n    // 加载 chunk\n    __webpack_require__.e(1, function(require) {\n      // 回调函数\n      var content = __webpack_require__(1); // 下标是 1\n      document.open();\n      document.write(\'<h1>\' + content + \'</h1>\');\n      document.close();\n    });\n  }\n]);`, `84775097602721990000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">modules</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> parentJsonpFunction <span class="token operator">=</span> window<span class="token punctuation">[</span><span class="token string">\'webpackJsonp\'</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 全局变量可访问，可通过 webpack 配置的 output 下的 jsonpFunction 进行自定义配置，默认 webpackJsonp</span>\n  window<span class="token punctuation">[</span><span class="token string">\'webpackJsonp\'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">webpackJsonpCallback</span><span class="token punctuation">(</span><span class="token parameter">chunkIds<span class="token punctuation">,</span> moreModules</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">var</span> moduleId<span class="token punctuation">,</span>\n      chunkId<span class="token punctuation">,</span>\n      i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>\n      callbacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 存放从 __webpack_require__.e 传过来的 callback 数组，实际上就是其回调函数，见下文的代码注释“回调函数”处</span>\n    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> chunkIds<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      chunkId <span class="token operator">=</span> chunkIds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span><span class="token punctuation">)</span> callbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>callbacks<span class="token punctuation">,</span> installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 存放数组函数回调</span>\n      installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 标记此 chunk 加载完成</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">for</span> <span class="token punctuation">(</span>moduleId <span class="token keyword">in</span> moreModules<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 这步很重要，将 chunk 传过来的 moreModules 去替换掉现有的 modules</span>\n      <span class="token comment">// 以供下面的“回调函数”调用 __webpack_require__ 时，去调用 chunk 里面的代码</span>\n      modules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span> <span class="token operator">=</span> moreModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>parentJsonpFunction<span class="token punctuation">)</span> <span class="token function">parentJsonpFunction</span><span class="token punctuation">(</span>chunkIds<span class="token punctuation">,</span> moreModules<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// 依次执行数组函数回调</span>\n    <span class="token keyword">while</span> <span class="token punctuation">(</span>callbacks<span class="token punctuation">.</span>length<span class="token punctuation">)</span> callbacks<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> __webpack_require__<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">var</span> installedModules <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 已加载的 chunkId，0 代表已加载</span>\n  <span class="token keyword">var</span> installedChunks <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token number">0</span><span class="token punctuation">:</span> <span class="token number">0</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">function</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token parameter">moduleId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 缓存</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">return</span> installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">.</span>exports<span class="token punctuation">;</span>\n\n    <span class="token keyword">var</span> module <span class="token operator">=</span> <span class="token punctuation">(</span>installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>\n      exports<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>\n      id<span class="token punctuation">:</span> moduleId<span class="token punctuation">,</span>\n      loaded<span class="token punctuation">:</span> <span class="token boolean">false</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    modules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> module<span class="token punctuation">,</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> __webpack_require__<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    module<span class="token punctuation">.</span>loaded <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">return</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  __webpack_require__<span class="token punctuation">.</span><span class="token function-variable function">e</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">requireEnsure</span><span class="token punctuation">(</span><span class="token parameter">chunkId<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 已加载完成直接调用</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> __webpack_require__<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n      <span class="token comment">// chunk 没有加载，直接塞入“回调函数”</span>\n      installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>callback<span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token keyword">var</span> head <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">\'head\'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token keyword">var</span> script <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">\'script\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      script<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">\'text/javascript\'</span><span class="token punctuation">;</span>\n      script<span class="token punctuation">.</span>charset <span class="token operator">=</span> <span class="token string">\'utf-8\'</span><span class="token punctuation">;</span>\n      script<span class="token punctuation">.</span>async <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n      <span class="token comment">// 加载对应的 chunk</span>\n      script<span class="token punctuation">.</span>src <span class="token operator">=</span> __webpack_require__<span class="token punctuation">.</span>p <span class="token operator">+</span> <span class="token string">\'\'</span> <span class="token operator">+</span> chunkId <span class="token operator">+</span> <span class="token string">\'.bundle.js\'</span><span class="token punctuation">;</span>\n      head<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>script<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 存放 modules</span>\n  __webpack_require__<span class="token punctuation">.</span>m <span class="token operator">=</span> modules<span class="token punctuation">;</span>\n  <span class="token comment">// 存放已安装的 modules</span>\n  __webpack_require__<span class="token punctuation">.</span>c <span class="token operator">=</span> installedModules<span class="token punctuation">;</span>\n  <span class="token comment">// 存放 publicPath</span>\n  __webpack_require__<span class="token punctuation">.</span>p <span class="token operator">=</span> <span class="token string">\'\'</span><span class="token punctuation">;</span>\n  <span class="token comment">// 第一步执行的地方</span>\n  <span class="token keyword">return</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">[</span>\n  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 加载 chunk</span>\n    __webpack_require__<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">require</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 回调函数</span>\n      <span class="token keyword">var</span> content <span class="token operator">=</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 下标是 1</span>\n      document<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      document<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">\'&lt;h1>\'</span> <span class="token operator">+</span> content <span class="token operator">+</span> <span class="token string">\'&lt;/h1>\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      document<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>1.bundle.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="52374038574800740000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`webpackJsonp(\n  [1],\n  [\n    ,\n    // 这里的下标是 1，对应着上面的“下标是 1”\n    // 注意这里由 __webpack_require__.e 加载后会自动执行 webpackJsonp，然后回调函数就被执行\n    function(module, exports) {\n      module.exports = \'Hello World\';\n    }\n  ]\n);`, `52374038574800740000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token function">webpackJsonp</span><span class="token punctuation">(</span>\n  <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n  <span class="token punctuation">[</span>\n    <span class="token punctuation">,</span>\n    <span class="token comment">// 这里的下标是 1，对应着上面的“下标是 1”</span>\n    <span class="token comment">// 注意这里由 __webpack_require__.e 加载后会自动执行 webpackJsonp，然后回调函数就被执行</span>\n    <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token string">\'Hello World\'</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">]</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>和使用 CommonsChunkPlugin 打包的差异在于</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="85124836096339720000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// This file contains only the entry chunk.\n// The chunk loading function for additional chunks\n__webpack_require__.e = function requireEnsure(chunkId, callback) {\n  // &quot;0&quot; is the signal for &quot;already loaded&quot;\n  if (installedChunks[chunkId] === 0) return callback.call(null, __webpack_require__); // an array means &quot;currently loading&quot;.\n\n  if (installedChunks[chunkId] !== undefined) {\n    installedChunks[chunkId].push(callback);\n  } else {\n    // start chunk loading\n    installedChunks[chunkId] = [callback];\n    var head = document.getElementsByTagName(\'head\')[0];\n    var script = document.createElement(\'script\');\n    script.type = \'text/javascript\';\n    script.charset = \'utf-8\';\n    script.async = true;\n\n    script.src = __webpack_require__.p + \'\' + chunkId + \'.bundle.js\';\n    head.appendChild(script);\n  }\n};`, `85124836096339720000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// This file contains only the entry chunk.</span>\n<span class="token comment">// The chunk loading function for additional chunks</span>\n__webpack_require__<span class="token punctuation">.</span><span class="token function-variable function">e</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">requireEnsure</span><span class="token punctuation">(</span><span class="token parameter">chunkId<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// "0" is the signal for "already loaded"</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> __webpack_require__<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// an array means "currently loading".</span>\n\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n    <span class="token comment">// start chunk loading</span>\n    installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>callback<span class="token punctuation">]</span><span class="token punctuation">;</span>\n    <span class="token keyword">var</span> head <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">\'head\'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n    <span class="token keyword">var</span> script <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">\'script\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    script<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">\'text/javascript\'</span><span class="token punctuation">;</span>\n    script<span class="token punctuation">.</span>charset <span class="token operator">=</span> <span class="token string">\'utf-8\'</span><span class="token punctuation">;</span>\n    script<span class="token punctuation">.</span>async <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n\n    script<span class="token punctuation">.</span>src <span class="token operator">=</span> __webpack_require__<span class="token punctuation">.</span>p <span class="token operator">+</span> <span class="token string">\'\'</span> <span class="token operator">+</span> chunkId <span class="token operator">+</span> <span class="token string">\'.bundle.js\'</span><span class="token punctuation">;</span>\n    head<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>script<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>模块 main 的 id 为 0，模块 a 的 id 为 1。<code class="language-text">return __webpack_require__(0)</code>，则加载 main 模块， <code class="language-text">modules[0].call(module.exports, module, module.exports, __webpack_require__)</code>则调用函数</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="34811616102627463000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function(module, exports, __webpack_require__) {\n  __webpack_require__.e/* nsure */(1, function(require) {\n    var content = __webpack_require__(1);\n    document.open();\n    document.write(\'<h1>\' + content + \'</h1>\');\n    document.close();\n  }\n}`, `34811616102627463000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  __webpack_require__<span class="token punctuation">.</span>e<span class="token comment">/* nsure */</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">require</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">var</span> content <span class="token operator">=</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    document<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    document<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">\'&lt;h1>\'</span> <span class="token operator">+</span> content <span class="token operator">+</span> <span class="token string">\'&lt;/h1>\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    document<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="9743995592905552000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// This file contains only the entry chunk.\n// The chunk loading function for additional chunks\n__webpack_require__.e = function requireEnsure(chunkId, callback) {\n  // installedChunks[1] 为 undefined\n  // &quot;0&quot; is the signal for &quot;already loaded&quot;\n  if (installedChunks[chunkId] === 0) return callback.call(null, __webpack_require__); // an array means &quot;currently loading&quot;.\n\n  if (installedChunks[chunkId] !== undefined) {\n    installedChunks[chunkId].push(callback);\n  } else {\n    // start chunk loading\n    installedChunks[chunkId] = [callback]; // installedChunks[1] 为数组，表明 currently loading\n    var head = document.getElementsByTagName(\'head\')[0];\n    var script = document.createElement(\'script\');\n    script.type = \'text/javascript\';\n    script.charset = \'utf-8\';\n    script.async = true;\n\n    script.src = __webpack_require__.p + \'\' + chunkId + \'.bundle.js\';\n    head.appendChild(script);\n    // 加载完后直接调用\n    webpackJsonp(\n      [1],\n      [\n        ,\n        /* 1 */\n        function(module, exports) {\n          module.exports = \'Hello World\';\n        }\n      ]\n    );\n  }\n};\n// installedChunks[1] 在 webpackJsonp 得到调用`, `9743995592905552000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// This file contains only the entry chunk.</span>\n<span class="token comment">// The chunk loading function for additional chunks</span>\n__webpack_require__<span class="token punctuation">.</span><span class="token function-variable function">e</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">requireEnsure</span><span class="token punctuation">(</span><span class="token parameter">chunkId<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// installedChunks[1] 为 undefined</span>\n  <span class="token comment">// "0" is the signal for "already loaded"</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> __webpack_require__<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// an array means "currently loading".</span>\n\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n    <span class="token comment">// start chunk loading</span>\n    installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>callback<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// installedChunks[1] 为数组，表明 currently loading</span>\n    <span class="token keyword">var</span> head <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">\'head\'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n    <span class="token keyword">var</span> script <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">\'script\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    script<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">\'text/javascript\'</span><span class="token punctuation">;</span>\n    script<span class="token punctuation">.</span>charset <span class="token operator">=</span> <span class="token string">\'utf-8\'</span><span class="token punctuation">;</span>\n    script<span class="token punctuation">.</span>async <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n\n    script<span class="token punctuation">.</span>src <span class="token operator">=</span> __webpack_require__<span class="token punctuation">.</span>p <span class="token operator">+</span> <span class="token string">\'\'</span> <span class="token operator">+</span> chunkId <span class="token operator">+</span> <span class="token string">\'.bundle.js\'</span><span class="token punctuation">;</span>\n    head<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>script<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// 加载完后直接调用</span>\n    <span class="token function">webpackJsonp</span><span class="token punctuation">(</span>\n      <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n      <span class="token punctuation">[</span>\n        <span class="token punctuation">,</span>\n        <span class="token comment">/* 1 */</span>\n        <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token string">\'Hello World\'</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">]</span>\n    <span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token comment">// installedChunks[1] 在 webpackJsonp 得到调用</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><code class="language-text">installedChunks[1]</code> 为数组，元素为 main 模块的执行代码</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="28754432796839780000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`window[\'webpackJsonp\'] = function webpackJsonpCallback(chunkIds, moreModules) {\n  // moreModules 为模块 a 的代码\n  // add &quot;moreModules&quot; to the modules object,\n  // then flag all &quot;chunkIds&quot; as loaded and fire callback\n  var moduleId,\n    chunkId,\n    i = 0,\n    callbacks = [];\n  for (; i < chunkIds.length; i++) {\n    chunkId = chunkIds[i];\n    if (installedChunks[chunkId])\n      // installedChunks[0]==0，installedChunks[1] 为数组\n      callbacks.push.apply(callbacks, installedChunks[chunkId]); // callbacks 为模块 main 执行代码，不为数组\n    installedChunks[chunkId] = 0; // installedChunks[1] 不为数组，表明已经加载\n  }\n  for (moduleId in moreModules) {\n    modules[moduleId] = moreModules[moduleId];\n  }\n  if (parentJsonpFunction) parentJsonpFunction(chunkIds, moreModules);\n  while (callbacks.length) callbacks.shift().call(null, __webpack_require__);\n};`, `28754432796839780000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">window<span class="token punctuation">[</span><span class="token string">\'webpackJsonp\'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">webpackJsonpCallback</span><span class="token punctuation">(</span><span class="token parameter">chunkIds<span class="token punctuation">,</span> moreModules</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// moreModules 为模块 a 的代码</span>\n  <span class="token comment">// add "moreModules" to the modules object,</span>\n  <span class="token comment">// then flag all "chunkIds" as loaded and fire callback</span>\n  <span class="token keyword">var</span> moduleId<span class="token punctuation">,</span>\n    chunkId<span class="token punctuation">,</span>\n    i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>\n    callbacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> chunkIds<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    chunkId <span class="token operator">=</span> chunkIds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span><span class="token punctuation">)</span>\n      <span class="token comment">// installedChunks[0]==0，installedChunks[1] 为数组</span>\n      callbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>callbacks<span class="token punctuation">,</span> installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// callbacks 为模块 main 执行代码，不为数组</span>\n    installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// installedChunks[1] 不为数组，表明已经加载</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span>moduleId <span class="token keyword">in</span> moreModules<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    modules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span> <span class="token operator">=</span> moreModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>parentJsonpFunction<span class="token punctuation">)</span> <span class="token function">parentJsonpFunction</span><span class="token punctuation">(</span>chunkIds<span class="token punctuation">,</span> moreModules<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">while</span> <span class="token punctuation">(</span>callbacks<span class="token punctuation">.</span>length<span class="token punctuation">)</span> callbacks<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> __webpack_require__<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="实现一个简单的-webpack"><a href="#%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84-webpack" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>实现一个简单的 webpack</h1>\n<h2 id="目标"><a href="#%E7%9B%AE%E6%A0%87" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>目标</h2>\n<p>现在的 webpack 是一个庞然大物，我们不可能实现其所有功能。那么，应该将目光聚焦在哪儿呢？从 webpack 的 <a href="https://github.com/webpack/webpack/tree/2e1460036c5349951da86c582006c7787c56c543" target="_blank" rel="nofollow noreferrer noopener">第一个 commit</a> 可以看出，其当初最主要的目的是在浏览器端复用符合 CommonJS 规范的代码模块。这个目标不是很难，我们努力一把还是可以实现的。</p>\n<p>注意：在此我们不考虑插件、loaders、多文件打包等等复杂的问题，仅仅考虑最基本的问题：如何将多个符合 CommonJS 规范的模块打包成一个 JS 文件，以供浏览器执行。</p>\n<h2 id="bundlejs"><a href="#bundlejs" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>bundle.js</h2>\n<p>显然，浏览器没法直接执行 CommonJS 规范的模块，怎么办呢？</p>\n<p>将其转换成一个自执行表达式</p>\n<h2 id="例子"><a href="#%E4%BE%8B%E5%AD%90" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>例子</h2>\n<p>我们实际要处理的例子是 <a href="https://github.com/towavephone/fake-webpack/tree/1bfcd0edf10f1a2ff3bfd7c418e7490a735b9823/examples/simple" target="_blank" rel="nofollow noreferrer noopener">这个</a>：example 依赖于 a、b 和 c，而且 c 位于 node_modules 文件夹中，我们要将所有模块构建成一个 JS 文件，就是这里的 <a href="https://github.com/towavephone/fake-webpack/blob/1bfcd0edf10f1a2ff3bfd7c418e7490a735b9823/examples/simple/output.js" target="_blank" rel="nofollow noreferrer noopener">output.js</a></p>\n<h2 id="思路"><a href="#%E6%80%9D%E8%B7%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>思路</h2>\n<p>仔细观察 <a href="https://github.com/towavephone/fake-webpack/blob/1bfcd0edf10f1a2ff3bfd7c418e7490a735b9823/examples/simple/output.js" target="_blank" rel="nofollow noreferrer noopener">output.js</a>，我们能够发现：</p>\n<ol>\n<li>\n<p>不管有多少个模块，头部那一块都是一样的，所以可以写成一个模板，也就是 templateSingle.js。</p>\n</li>\n<li>\n<p>需要分析出各个模块间的依赖关系。也就是说，需要知道 example 依赖于 a、b 和 c。</p>\n</li>\n<li>\n<p>c 模块位于 node_modules 文件夹当中，但是我们调用的时候却可以直接 <code class="language-text">require(&#39;c&#39;)</code>，这里肯定是存在某种自动查找的功能。</p>\n</li>\n<li>\n<p>在生成的 output.js 中，每个模块的唯一标识是模块的 ID，所以在拼接 output.js 的时候，需要将每个模块的名字替换成模块的 ID。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="30277300785404514000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 转换前\nlet a = require(\'a\');\nlet b = require(\'b\');\nlet c = require(\'c\');\n\n// 转换后\nlet a = require(/* a */ 1);\nlet b = require(/* b */ 2);\nlet c = require(/* c */ 3);`, `30277300785404514000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 转换前</span>\n<span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'a\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">let</span> b <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'b\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">let</span> c <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'c\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 转换后</span>\n<span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token comment">/* a */</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">let</span> b <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token comment">/* b */</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">let</span> c <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token comment">/* c */</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n</ol>\n<p>ok，下面我们来逐一看看这些问题</p>\n<h3 id="分析模块依赖关系"><a href="#%E5%88%86%E6%9E%90%E6%A8%A1%E5%9D%97%E4%BE%9D%E8%B5%96%E5%85%B3%E7%B3%BB" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>分析模块依赖关系</h3>\n<p>CommonJS 不同于 AMD，是不会在一开始声明所有依赖的。CommonJS 最显著的特征就是用到的时候再 require，所以我们得在整个文件的范围内查找到底有多少个 require。怎么办呢？最先蹦入脑海的思路是正则。然而，用正则来匹配 require，有以下两个缺点：</p>\n<ol>\n<li>如果 require 是写在注释中，也会匹配到。</li>\n<li>如果后期要支持 require 的参数是表达式的情况，如 <code class="language-text">require(&#39;a&#39;+&#39;b&#39;)</code>，正则很难处理。</li>\n</ol>\n<p>因此，正则行不通。</p>\n<p>一种正确的思路是：使用 JS 代码解析工具（如 esprima 或者 acorn），将 JS 代码转换成抽象语法树（AST），再对 AST 进行遍历。这部分的核心代码是 <a href="https://github.com/towavephone/fake-webpack/blob/1bfcd0edf1/lib/parse.js" target="_blank" rel="nofollow noreferrer noopener">parse.js</a>。</p>\n<p>在处理好了 require 的匹配之后，还有一个问题需要解决。那就是匹配到 require 之后需要干什么呢？举个例子：</p>\n<p>举个例子：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="14332021580663690000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// example.js\nlet a = require(\'a\');\nlet b = require(\'b\');\nlet c = require(\'c\');`, `14332021580663690000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// example.js</span>\n<span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'a\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">let</span> b <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'b\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">let</span> c <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'c\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这里有三个 require，按照 CommonJS 的规范，在检测到第一个 require 的时候，根据 require 即执行的原则，程序应该立马去读取解析模块 a。如果模块 a 中又 require 了其他模块，那么继续解析。也就是说，总体上遵循深度优先遍历算法。这部分的控制逻辑写在 <a href="https://github.com/towavephone/fake-webpack/blob/1bfcd0edf1/lib/buildDeps.js" target="_blank" rel="nofollow noreferrer noopener">buildDeps.js</a> 中。</p>\n<h3 id="找到模块"><a href="#%E6%89%BE%E5%88%B0%E6%A8%A1%E5%9D%97" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>找到模块</h3>\n<p>在完成依赖分析的同时，我们需要解决另外一个问题，那就是如何找到模块？也就是模块的寻址问题，举个例子：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="13469230563325985000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// example.js\nlet a = require(\'a\');\nlet b = require(\'b\');\nlet c = require(\'c\');`, `13469230563325985000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// example.js</span>\n<span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'a\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">let</span> b <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'b\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">let</span> c <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'c\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在模块 example.js 中，调用模块 a、b、c 的方式都是一样的。但是，实际上他们所在的绝对路径层级并不一致：a 和 b 跟 example 同级，而 c 位于与 example 同级的 node_modules 中。所以，程序需要有一个查找模块的算法，这部分的逻辑在 <a href="https://github.com/towavephone/fake-webpack/blob/1bfcd0edf1/lib/resolve.js" target="_blank" rel="nofollow noreferrer noopener">resolve.js</a> 中。</p>\n<p>目前实现的查找逻辑是：</p>\n<ol>\n<li>如果给出的是绝对路径/相对路径，只查找一次。找到？返回绝对路径。找不到？返回 false。</li>\n<li>如果给出的是模块的名字，先在入口 js（example.js）文件所在目录下寻找同名 JS 文件（可省略扩展名）。找到？返回绝对路径。找不到？走第 3 步。</li>\n<li>在入口 js（example.js）同级的 node_modules 文件夹（如果存在的话）查找。找到？返回绝对路径。找不到？返回 false。</li>\n</ol>\n<p>当然，此处实现的算法还比较简陋，之后有时间可以再考虑实现逐层往上的查找，就像 nodejs 默认的模块查找算法那样。</p>\n<h3 id="拼接-outputjs"><a href="#%E6%8B%BC%E6%8E%A5-outputjs" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>拼接 output.js</h3>\n<p>这是最后一步了。</p>\n<p>在解决了模块依赖和模块查找的问题之后，我们将会得到一个依赖关系对象 depTree，此对象完整地描述了以下信息：都有哪些模块，各个模块的内容是什么，他们之间的依赖关系又是如何等等。具体的结构如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="42839712562183020000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`{\n    &quot;modules&quot;: {\n        &quot;/Users/towavephone/www/fake-webpack/examples/simple/example.js&quot;: {\n            &quot;id&quot;: 0,\n            &quot;filename&quot;: &quot;/Users/towavephone/www/fake-webpack/examples/simple/example.js&quot;,\n            &quot;name&quot;: &quot;/Users/towavephone/www/fake-webpack/examples/simple/example.js&quot;,\n            &quot;requires&quot;: [\n                {\n                    &quot;name&quot;: &quot;a&quot;,\n                    &quot;nameRange&quot;: [\n                        16,\n                        19\n                    ],\n                    &quot;id&quot;: 1\n                },\n                {\n                    &quot;name&quot;: &quot;b&quot;,\n                    &quot;nameRange&quot;: [\n                        38,\n                        41\n                    ],\n                    &quot;id&quot;: 2\n                },\n                {\n                    &quot;name&quot;: &quot;c&quot;,\n                    &quot;nameRange&quot;: [\n                        60,\n                        63\n                    ],\n                    &quot;id&quot;: 3\n                }\n            ],\n            &quot;source&quot;: &quot;let a = require(\'a\');\\nlet b = require(\'b\');\\nlet c = require(\'c\');\\na();\\nb();\\nc();\\n&quot;\n        },\n        &quot;/Users/towavephone/www/fake-webpack/examples/simple/a.js&quot;: {\n            &quot;id&quot;: 1,\n            &quot;filename&quot;: &quot;/Users/towavephone/www/fake-webpack/examples/simple/a.js&quot;,\n            &quot;name&quot;: &quot;a&quot;,\n            &quot;requires&quot;: [],\n            &quot;source&quot;: &quot;// module a\\n\\nmodule.exports = function () {\\n    console.log(\'a\')\\n};&quot;\n        },\n        &quot;/Users/towavephone/www/fake-webpack/examples/simple/b.js&quot;: {\n            &quot;id&quot;: 2,\n            &quot;filename&quot;: &quot;/Users/towavephone/www/fake-webpack/examples/simple/b.js&quot;,\n            &quot;name&quot;: &quot;b&quot;,\n            &quot;requires&quot;: [],\n            &quot;source&quot;: &quot;// module b\\n\\nmodule.exports = function () {\\n    console.log(\'b\')\\n};&quot;\n        },\n        &quot;/Users/towavephone/www/fake-webpack/examples/simple/node_modules/c.js&quot;: {\n            &quot;id&quot;: 3,\n            &quot;filename&quot;: &quot;/Users/towavephone/www/fake-webpack/examples/simple/node_modules/c.js&quot;,\n            &quot;name&quot;: &quot;c&quot;,\n            &quot;requires&quot;: [],\n            &quot;source&quot;: &quot;module.exports = function () {\\n    console.log(\'c\')\\n}&quot;\n        }\n    },\n    &quot;mapModuleNameToId&quot;: {\n        &quot;/Users/towavephone/www/fake-webpack/examples/simple/example.js&quot;: 0,\n        &quot;a&quot;: 1,\n        &quot;b&quot;: 2,\n        &quot;c&quot;: 3\n    }\n}`, `42839712562183020000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token punctuation">{</span>\n    <span class="token string">"modules"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>\n        <span class="token string">"/Users/towavephone/www/fake-webpack/examples/simple/example.js"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>\n            <span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>\n            <span class="token string">"filename"</span><span class="token punctuation">:</span> <span class="token string">"/Users/towavephone/www/fake-webpack/examples/simple/example.js"</span><span class="token punctuation">,</span>\n            <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"/Users/towavephone/www/fake-webpack/examples/simple/example.js"</span><span class="token punctuation">,</span>\n            <span class="token string">"requires"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>\n                <span class="token punctuation">{</span>\n                    <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"a"</span><span class="token punctuation">,</span>\n                    <span class="token string">"nameRange"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>\n                        <span class="token number">16</span><span class="token punctuation">,</span>\n                        <span class="token number">19</span>\n                    <span class="token punctuation">]</span><span class="token punctuation">,</span>\n                    <span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token number">1</span>\n                <span class="token punctuation">}</span><span class="token punctuation">,</span>\n                <span class="token punctuation">{</span>\n                    <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"b"</span><span class="token punctuation">,</span>\n                    <span class="token string">"nameRange"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>\n                        <span class="token number">38</span><span class="token punctuation">,</span>\n                        <span class="token number">41</span>\n                    <span class="token punctuation">]</span><span class="token punctuation">,</span>\n                    <span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token number">2</span>\n                <span class="token punctuation">}</span><span class="token punctuation">,</span>\n                <span class="token punctuation">{</span>\n                    <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"c"</span><span class="token punctuation">,</span>\n                    <span class="token string">"nameRange"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>\n                        <span class="token number">60</span><span class="token punctuation">,</span>\n                        <span class="token number">63</span>\n                    <span class="token punctuation">]</span><span class="token punctuation">,</span>\n                    <span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token number">3</span>\n                <span class="token punctuation">}</span>\n            <span class="token punctuation">]</span><span class="token punctuation">,</span>\n            <span class="token string">"source"</span><span class="token punctuation">:</span> <span class="token string">"let a = require(\'a\');\\nlet b = require(\'b\');\\nlet c = require(\'c\');\\na();\\nb();\\nc();\\n"</span>\n        <span class="token punctuation">}</span><span class="token punctuation">,</span>\n        <span class="token string">"/Users/towavephone/www/fake-webpack/examples/simple/a.js"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>\n            <span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>\n            <span class="token string">"filename"</span><span class="token punctuation">:</span> <span class="token string">"/Users/towavephone/www/fake-webpack/examples/simple/a.js"</span><span class="token punctuation">,</span>\n            <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"a"</span><span class="token punctuation">,</span>\n            <span class="token string">"requires"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n            <span class="token string">"source"</span><span class="token punctuation">:</span> <span class="token string">"// module a\\n\\nmodule.exports = function () {\\n    console.log(\'a\')\\n};"</span>\n        <span class="token punctuation">}</span><span class="token punctuation">,</span>\n        <span class="token string">"/Users/towavephone/www/fake-webpack/examples/simple/b.js"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>\n            <span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>\n            <span class="token string">"filename"</span><span class="token punctuation">:</span> <span class="token string">"/Users/towavephone/www/fake-webpack/examples/simple/b.js"</span><span class="token punctuation">,</span>\n            <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"b"</span><span class="token punctuation">,</span>\n            <span class="token string">"requires"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n            <span class="token string">"source"</span><span class="token punctuation">:</span> <span class="token string">"// module b\\n\\nmodule.exports = function () {\\n    console.log(\'b\')\\n};"</span>\n        <span class="token punctuation">}</span><span class="token punctuation">,</span>\n        <span class="token string">"/Users/towavephone/www/fake-webpack/examples/simple/node_modules/c.js"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>\n            <span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span>\n            <span class="token string">"filename"</span><span class="token punctuation">:</span> <span class="token string">"/Users/towavephone/www/fake-webpack/examples/simple/node_modules/c.js"</span><span class="token punctuation">,</span>\n            <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"c"</span><span class="token punctuation">,</span>\n            <span class="token string">"requires"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n            <span class="token string">"source"</span><span class="token punctuation">:</span> <span class="token string">"module.exports = function () {\\n    console.log(\'c\')\\n}"</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token string">"mapModuleNameToId"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>\n        <span class="token string">"/Users/towavephone/www/fake-webpack/examples/simple/example.js"</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>\n        <span class="token string">"a"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>\n        <span class="token string">"b"</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>\n        <span class="token string">"c"</span><span class="token punctuation">:</span> <span class="token number">3</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>根据这个 depTree 对象，我们便能完成这最后的一步：<code class="language-text">output.js 文件的拼接</code>。其控制逻辑无非是一层循环，写在 <a href="https://github.com/towavephone/fake-webpack/blob/1bfcd0edf1/lib/writeChunk.js" target="_blank" rel="nofollow noreferrer noopener">writeChunk.js</a> 中。但是这里有一个需要注意的地方，那就是本文思路章节提到的第 4 点：要把模块名转换成模块 ID，这是 <a href="https://github.com/towavephone/fake-webpack/blob/1bfcd0edf1/lib/writeSource.js" target="_blank" rel="nofollow noreferrer noopener">writeSource.js</a> 所要完成的功能。</p>\n<p>至此，我们就实现了一个非常简单的 webpack 了。</p>\n<h2 id="遗留问题"><a href="#%E9%81%97%E7%95%99%E9%97%AE%E9%A2%98" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>遗留问题</h2>\n<ol>\n<li>尚未支持 <code class="language-text">require(&#39;a&#39; + &#39;b&#39;)</code> 这种情况。</li>\n<li>如何实现自动 watch 的功能？</li>\n<li>其 loader 或者插件机制又是怎样的？</li>\n</ol>\n<h1 id="code-splitting"><a href="#code-splitting" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>code-splitting</h1>\n<p>我们今天来看看如何实现 webpack 的代码切割（code-splitting）功能，最后实现的代码版本请参考<a href="https://github.com/towavephone/fake-webpack/tree/d6589263f90752ef8222749208694df654b631e3" target="_blank" rel="nofollow noreferrer noopener">这里</a>。</p>\n<h2 id="目标-1"><a href="#%E7%9B%AE%E6%A0%87-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>目标</h2>\n<p>一般说来，code-splitting 有两种含义：</p>\n<ol>\n<li>将第三方类库单独打包成 vendor.js ，以提高缓存命中率（这一点我们不作考虑）</li>\n<li>将项目本身的代码分成多个 js 文件，分别进行加载（我们只研究这一点）</li>\n</ol>\n<p>换句话说，我们的目标是：将原先集中到一个 output.js 中的代码，切割成若干个 js 文件，然后分别进行加载。也就是说：原先只加载 output.js，现在把代码分割到 3 个文件中，先加载 output.js，然后 output.js 又会自动加载 1.output.js 和 2.output.js。</p>\n<h2 id="切割点的选择"><a href="#%E5%88%87%E5%89%B2%E7%82%B9%E7%9A%84%E9%80%89%E6%8B%A9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>切割点的选择</h2>\n<p>既然要将一份代码切割成若干份代码，总得有个切割点的标志吧，从哪儿开始切呢？</p>\n<p>webpack 使用 require.ensure 作为切割点。</p>\n<p>然而，我用 nodeJS 也挺长时间了，怎么不知道还有 require.ensure 这种用法？而事实上 nodeJS 也是不支持的，这个问题我在 CommonJS 的标准中找到了答案：虽然 CommonJS 通俗地讲是一个同步模块加载规范，但是其中是包含异步加载相关内容的。只不过这条内容只停留在 PROPOSAL（建议）阶段，并未最终进入标准，所以 nodeJS 没有实现它也就不奇怪了。只不过 webpack 恰好利用了这个作为代码的切割点。</p>\n<p>ok，现在我们已经明白了为什么要选择 require.ensure 作为切割点了。接下来的问题是：如何根据切割点对代码进行切割？ 下面举个例子。</p>\n<h2 id="例子-1"><a href="#%E4%BE%8B%E5%AD%90-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>例子</h2>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="11074403798587951000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// example.js\nvar a = require(\'a\');\nvar b = require(\'b\');\na();\nrequire.ensure([\'c\'], function(require) {\n  require(\'b\')();\n  var d = require(\'d\');\n  var c = require(\'c\');\n  c();\n  d();\n});\n\nrequire.ensure([\'e\'], function(require) {\n  require(\'f\')();\n});`, `11074403798587951000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// example.js</span>\n<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'a\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'b\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nrequire<span class="token punctuation">.</span><span class="token function">ensure</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'c\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">require</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'b\'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> d <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'d\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> c <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'c\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token function">c</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token function">d</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nrequire<span class="token punctuation">.</span><span class="token function">ensure</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'e\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">require</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'f\'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>假设这个 example.js 就是项目的主入口文件，模块 a ~ f 是简简单单的模块（既没有进一步的依赖，也不包含 require.ensure）。那么，这里一共有 2 个切割点，这份代码将被切割为 3 部分。也就说，到时候会产生 3 个文件：output.js，1.output.js，2.output.js</p>\n<h2 id="识别与处理切割点"><a href="#%E8%AF%86%E5%88%AB%E4%B8%8E%E5%A4%84%E7%90%86%E5%88%87%E5%89%B2%E7%82%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>识别与处理切割点</h2>\n<p>程序如何识别 require.ensure 呢？答案自然是继续使用强大的 esprima。关键代码如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="70731821274518940000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// parse.js\nif (\n  expression.callee &&\n  expression.callee.type === \'MemberExpression\' &&\n  expression.callee.object.type === \'Identifier\' &&\n  expression.callee.object.name === \'require\' &&\n  expression.callee.property.type === \'Identifier\' &&\n  expression.callee.property.name === \'ensure\' &&\n  expression.arguments &&\n  expression.arguments.length >= 1\n) {\n  // 处理 require.ensure 的依赖参数部分\n  let param = parseStringArray(expression.arguments[0]);\n  let newModule = {\n    requires: [],\n    namesRange: expression.arguments[0].range\n  };\n  param.forEach((module) => {\n    newModule.requires.push({\n      name: module\n    });\n  });\n\n  module.asyncs = module.asyncs || [];\n  module.asyncs.push(newModule);\n\n  module = newModule;\n\n  // 处理 require.ensure 的函数体部分\n  if (expression.arguments.length > 1) {\n    walkExpression(module, expression.arguments[1]);\n  }\n}`, `70731821274518940000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// parse.js</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span>\n  expression<span class="token punctuation">.</span>callee <span class="token operator">&amp;&amp;</span>\n  expression<span class="token punctuation">.</span>callee<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">\'MemberExpression\'</span> <span class="token operator">&amp;&amp;</span>\n  expression<span class="token punctuation">.</span>callee<span class="token punctuation">.</span>object<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">\'Identifier\'</span> <span class="token operator">&amp;&amp;</span>\n  expression<span class="token punctuation">.</span>callee<span class="token punctuation">.</span>object<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">\'require\'</span> <span class="token operator">&amp;&amp;</span>\n  expression<span class="token punctuation">.</span>callee<span class="token punctuation">.</span>property<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">\'Identifier\'</span> <span class="token operator">&amp;&amp;</span>\n  expression<span class="token punctuation">.</span>callee<span class="token punctuation">.</span>property<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">\'ensure\'</span> <span class="token operator">&amp;&amp;</span>\n  expression<span class="token punctuation">.</span>arguments <span class="token operator">&amp;&amp;</span>\n  expression<span class="token punctuation">.</span>arguments<span class="token punctuation">.</span>length <span class="token operator">>=</span> <span class="token number">1</span>\n<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 处理 require.ensure 的依赖参数部分</span>\n  <span class="token keyword">let</span> param <span class="token operator">=</span> <span class="token function">parseStringArray</span><span class="token punctuation">(</span>expression<span class="token punctuation">.</span>arguments<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">let</span> newModule <span class="token operator">=</span> <span class="token punctuation">{</span>\n    requires<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n    namesRange<span class="token punctuation">:</span> expression<span class="token punctuation">.</span>arguments<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>range\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n  param<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">module</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    newModule<span class="token punctuation">.</span>requires<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n      name<span class="token punctuation">:</span> module\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  module<span class="token punctuation">.</span>asyncs <span class="token operator">=</span> module<span class="token punctuation">.</span>asyncs <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  module<span class="token punctuation">.</span>asyncs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>newModule<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  module <span class="token operator">=</span> newModule<span class="token punctuation">;</span>\n\n  <span class="token comment">// 处理 require.ensure 的函数体部分</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>expression<span class="token punctuation">.</span>arguments<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token function">walkExpression</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> expression<span class="token punctuation">.</span>arguments<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>观察上面的代码可以看出，识别出 require.ensure 之后，会将其存储到 asyncs 数组中，且继续遍历其中所包含的其他依赖。举个例子，example.js 模块最终解析出来的数据结构如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2021-08-03-01-22-45-509b26f4cb39687260c796013ca69ec4-76b75.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 699px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 126.60944206008584%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAZCAIAAAC+dZmEAAAACXBIWXMAAAsSAAALEgHS3X78AAACqElEQVQ4y5WU6XLbIBSF8/6v0l99jazO1saWHS3YFgi0sgkEl6LUSVO3M1UZjQfP6OPcc+5FF9baoWZdRSelgrXBmGDG4H1YsC5839WbdZWsOUK+Zb6tQ9sAoyFAmKb5LGvCOM5PPPoMhoYFNwk9rh6etlk6SOEBZr6pwxFBtoXtGh5u4HkVivQcju9ZMS8phBm1i2oR7tpASSBloDjk6Sw7L/hDuY7Kjkt1c3u32SUDH2ZlVr3ZhvnXufm4mYXT88uz4O3rTu73oWkcpY5RTym0zentv673Iy68c+n1LVo9NUnap4VCR70v5R5PjJ1KFUMY+jDqIHjgfZDik2djLKl7YZMky/KS1QMXoxB2IiQGCVrB+imsn2MEkLyE3QY232de6xOsSipNGLiljB+OrI+wD/b60nz94qWcQ063kO0AZUBKyF7h8Taku6DkCRYjdJ2idCjLuo3tipPy9OhRHtOCA5p7lrxAheFQxH2oyrAvIH99Vx4DF7Yo8M3t42abMSYMJn/rzlmfTzC0rWRswLjpuOJymj2D/y3h8LlP8/4XLOUUla+uVi9JympuMP73bH+U3TRi4EYqp0YvlZ9ItRiehx8KhC8v73YpYrVYpAzGaMy48tFt9FzRPtYc22YJWaBsjTxWhPHd6367RYR0wzC+lb0ItmKPWSvT7HDETfSsNQjlFnk+la09IW1MO8uO7aCEdP8XWNerfhi7Xgs1Se2najEcx1PICSFy//C9OMRBURaTRbCMcLwYg2lamSMc70bb6Z9pv48VfIzVOWwxi4ZX1w+P99+OiHQxAelcWS74ejqHv23qXd7mqMtRkxV1lvXFXtPKOmsmK0eprX7bm9GO8GngL7z3SbHNcVGLWHVHe9qpXlmtJ6OMiptOdFzziMW/Mt70T/AP2yShptabAZkAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2021 08 03 01 22 45" title="" data-src="/static/2021-08-03-01-22-45-509b26f4cb39687260c796013ca69ec4-76b75.png" data-srcset="/static/2021-08-03-01-22-45-509b26f4cb39687260c796013ca69ec4-83eb3.png 200w,\n/static/2021-08-03-01-22-45-509b26f4cb39687260c796013ca69ec4-7600b.png 400w,\n/static/2021-08-03-01-22-45-509b26f4cb39687260c796013ca69ec4-76b75.png 699w" data-sizes="(max-width: 699px) 100vw, 699px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h2 id="module-与-chunk"><a href="#module-%E4%B8%8E-chunk" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>module 与 chunk</h2>\n<p>我在刚刚使用 webpack 的时候，是分不清这两个概念的。现在我可以说：“在上面的例子中，有 3 个 chunk，分别对应 output.js、1.output.js 、2.output.js；有 7 个 module，分别是 example 和 a ~ f。</p>\n<p>所以，module 和 chunk 之间的关系是：1 个 chunk 可以包含若干个 module。</p>\n<p>观察上面的例子，得出以下结论：</p>\n<ul>\n<li>chunk0（也就是主 chunk，也就是 output.js）应该包含 example 本身和 a、b 三个模块。</li>\n<li>chunk1（1.output.js）是从 chunk0 中切割出来的，所以 chunk0 是 chunk1 的 parent。</li>\n<li>本来 chunk1 应该是包含模块 c、b 和 d 的，但是由于 b 已经被其 parent-chunk（也就是 chunk1）包含，所以，必须将 b 从 chunk1 中移除，这样方能避免代码的冗余。</li>\n<li>chunk2（2.output.js）是从 chunk0 中切割出来的，所以 chunk0 也是 chunk2 的 parent。</li>\n<li>chunk2 包含 e 和 f 两个模块。</li>\n</ul>\n<p>好了，下面进入重头戏。</p>\n<h2 id="构建-chunks"><a href="#%E6%9E%84%E5%BB%BA-chunks" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>构建 chunks</h2>\n<p>在对各个模块进行解析之后，我们能大概得到以下这样结构的 depTree。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2021-08-03-01-24-12-dfde79ab8edc2556cd8e4dcc435f6085-3df96.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 778px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 119.79434447300773%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAYCAIAAAB1KUohAAAACXBIWXMAAAsSAAALEgHS3X78AAADdklEQVQ4y4VUiZKjOAzN/3/V1ux2TzohByEknTvclw3GBoMx2COSdO1ubW+NUBlZ8KxnWfJEyq7I80oIubfE1pR13aO0j/w+8PvrqT8fensz3M5DxQalhgGGUfRDJn3fJ3FyvF7PMyPY7eMkScIw8rzQdcPbFTS932LXydIkjuMgCMqSQDylFSwzeS4T3K6b1SaKgzBxvPDqhGcnuTvYd5F/R66DPCdz3Mz3EWjgZrCYW1TFZISKNtva+/na+zwWYZQHIYtjEXpCiqZrQHnHwW5l23YNKBdNI5p+GCYj94b3rKbNYBjWenvMcNUCryLXw2tv/ycvcFeUmPAso7QUlLa8kbrAGnY09Lokmpaa5JpRXbPRT4lCqZbdA9w2bU4g4Of+cro4GaKVGNTpID7eVRar6Z/qYCtrqfYbZS7U9Ifab/X1pFv+iixLVlbdbnc5nnyEGauExkh1nea1jsMxeFmMmkY6jUcKT9rPhJEgCiLUtL3sdc1lI/oX7W9l3M7wtee2qdMkQ4gUBWWs6zo4wzFhTzCM/9V/JkzXleyH6/m8tWyMkOjE3+DfZltVjLcthbiPyHCGD/DI7RnrX6y/PA8wZKVichiup/N2a+cYSyl1jp/g30WWXXU559eLRMmQpzzxWeiI2IfakkNXixoUKuxRcPw5fXpGMLQKIvktvGclivPYy/yUoJwRwkjbthWvQFvR8IbXDWc1g+mjPPsRLETn3O+3mxsEYQAtFUXQPZ7ve/AEPkzDMIyTKAj9MArBmaYpoWXXy1dXxVFkWVtMci44axjllDUVa1nVVoQTMEhNwIZPdVvDWPKyrMsXOAyC5XKJc9yIFjIJlAY1yEGOtur7R0k8ncPXEbwSJjsJTFzXo4wmOEUFSosswUmEopKRrMhwiVlF0zwFG0YGnISAqCO4KIi5NkEWc2O9Wm9Mc71cr0AXy6Vh2JYNX/f2zlyZm41lGIvD4RiFMTTACIYX/DdfLD9W6/lsvlitPuaL6Ww+/fiYzmZrazufG9ZmY8zmxsJ4f/9p2zvfCyilE7jT4HKCyk6Px+THHznKivsVHz7zIMCeg48Hcj7gOC4py0cpMMYA45xDIU0azt/+elub1sU0o59vXV3p405/WnpvadvU1lKbhg7c7ysMKpmWFJasG7g+9JhOSlVJVIEVzlSOVY4UJd+CfwGkw0bGIJhTbAAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2021 08 03 01 24 12" title="" data-src="/static/2021-08-03-01-24-12-dfde79ab8edc2556cd8e4dcc435f6085-3df96.png" data-srcset="/static/2021-08-03-01-24-12-dfde79ab8edc2556cd8e4dcc435f6085-4346f.png 200w,\n/static/2021-08-03-01-24-12-dfde79ab8edc2556cd8e4dcc435f6085-9c269.png 400w,\n/static/2021-08-03-01-24-12-dfde79ab8edc2556cd8e4dcc435f6085-3df96.png 778w" data-sizes="(max-width: 778px) 100vw, 778px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>下面我们要做的就是：如何从 8 个 module 中构建出 3 个 chunk 出来。 这里的代码较长，我就不贴出来了，想看的到这里的 <a href="https://github.com/towavephone/fake-webpack/commit/d6589263f90752ef8222749208694df654b631e3#diff-92c5d90abece48343aa1cdb71978f37b" target="_blank" rel="nofollow noreferrer noopener">buildDep.js</a>。</p>\n<p>其中要重点注意是：前文说到，为了避免代码的冗余，需要将模块 b 从 chunk1 中移除，具体发挥作用的就是函数 removeParentsModules，本质上无非就是改变一下标志位。最终生成的 chunks 的结构如下：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2021-08-03-01-25-11-6afcbc3be20463b65a0b0e3e5b52dcc2-7a334.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 673px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 99.25705794947994%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAIAAAAC64paAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACwElEQVQ4y5VU227cNhDd//+EvBR5CPLQ9wJ5qGMkqAs7vuz6lrX3rl3dqOtKK5EUxZkeyuumbYAEFQiClHiGM+ec0UhKmRVF3TTKmN5a/j/PqNNq8vFkfnFhRGQzQVlis4RTwWXhvh9qDna0nLFsuT3wdk2bBYuQ68qBWWsTBUksvOW6KQ/c94T7u45F7MDVntcLh9ltGEG9FY2/0PiCEe5QA6xwibF2Nl+sPC8s47TOiYiz1IGzhB4n5K0xeL3kJOY85XRIrTm4m22e4ZjpuqIq18naz4IjGHNz4CjgOOQiczOSdw8da3bgLDVEABvTSS07ox0Msfv+J4Rxp3Ucp0XRSEV/vwYYlGhNdUWrGd1d8/SBRYTiXSJYTO9B5IiU4n1Rter89M/Z1V268cXKq/PK/PpOvX/b1zXPn3izdLBg6xbIyHSsJPIaCMtT5Bd83Tx/Oht/Phmf/p7eP9nJtd2XLosX8QEwhv9thBEBXORKdotFNF+Lx83uWexrBYWro85x5EgGcxjYgm1UhLhKjQiSxqFczZ8vx9HjlERiPvwmf3mjz8/6Mufdhr7e0fMjKoTIbgvOoQ7KlnKEfGzoW99zfsDpyLepsMHOhoFzS5E7b4S+M1yCFMR/2O50FOYisW3LuuPeHL9A2J9Zfai5BNvt9fXtzo+U0R24gVSoDYGwwOy4NU5251yNat0brR3bNDisqWuRidXgMGchJAyGRETeksaXR7Xg7ZsLur2i+zH73iBVkWtjojCq9pUxMJsdbs6cGdEAD2O6uxlcsXXpwC0vDUfk7ImNJgqitKzabw4DeW2DZnL9CGNUJc2nvHhyvEKw15q18bc99q5jG6chBk5AElSI0Q/eQDjb8wsd9NoYsm0nZ39ML788nJ/PJjf51pNpAku/NtAP2VZKhWG0C8JIJI2UBj+Df7bH94O/3fwXPQh1Xipk5JYAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2021 08 03 01 25 11" title="" data-src="/static/2021-08-03-01-25-11-6afcbc3be20463b65a0b0e3e5b52dcc2-7a334.png" data-srcset="/static/2021-08-03-01-25-11-6afcbc3be20463b65a0b0e3e5b52dcc2-6eafe.png 200w,\n/static/2021-08-03-01-25-11-6afcbc3be20463b65a0b0e3e5b52dcc2-632fc.png 400w,\n/static/2021-08-03-01-25-11-6afcbc3be20463b65a0b0e3e5b52dcc2-7a334.png 673w" data-sizes="(max-width: 673px) 100vw, 673px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h2 id="拼接-outputjs-1"><a href="#%E6%8B%BC%E6%8E%A5-outputjs-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>拼接 output.js</h2>\n<p>经历重重难关，我们终于来到了最后一步：如何根据构建出来的 chunks 拼接出若干个 output.js 呢？</p>\n<p>此处的拼接与上一篇最后提到的拼接大同小异，主要不同点有以下 2 个：</p>\n<ol>\n<li>模板的不同。原先是一个 output.js 的时候，用的模板是 templateSingle 。现在是多个 chunks 了，所以要使用模板 templateAsync。其中不同点主要是 templateAsync 会发起 jsonp 的请求，以加载后续的 x.output.js，此处就不加多阐述了。仔细 debug 生成的 output.js 应该就能看懂这一点。</li>\n<li>模块名字替换为模块 id 的算法有所改进。原先我直接使用正则进行匹配替换，但是如果存在重复的模块名的话，比如此例子中 example.js 出现了 2 次模块 b，那么简单的匹配就会出现错乱。因为 repalces 是从后往前匹配，而正则本身是从前往后匹配的。webpack 原作者提供了一种非常巧妙的方式，具体的代码可以参考<a href="https://github.com/towavephone/fake-webpack/commit/d6589263f90752ef8222749208694df654b631e3#diff-62f46802ba4c21e21b2dfedcce5fa86dR60" target="_blank" rel="nofollow noreferrer noopener">这里</a>。</li>\n</ol>\n<h2 id="后话"><a href="#%E5%90%8E%E8%AF%9D" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>后话</h2>\n<p>其实关于 webpack 的代码切割还有很多值得研究的地方。比如本文我们实现的例子仅仅是将 1 个文件切割成 3 个，并未就其加载时机进行控制。比如说，如何支持在单页面应用切换 router 的时候再加载特定的 x.output.js？</p>\n<h1 id="loader"><a href="#loader" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>loader</h1>\n<h2 id="前言"><a href="#%E5%89%8D%E8%A8%80" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>前言</h2>\n<p>我们来探索 loader 机制，最终实现的代码版本参考<a href="https://github.com/towavephone/fake-webpack/tree/96eae479379ca83dc7121f4afaef0b3453668081" target="_blank" rel="nofollow noreferrer noopener">这里</a>（参考的 webpack 版本是<a href="https://github.com/webpack/webpack/tree/356ab65ea0c097fdb2d3d70f9ba8593f325dc92e" target="_blank" rel="nofollow noreferrer noopener">这个</a>）</p>\n<h2 id="问题"><a href="#%E9%97%AE%E9%A2%98" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>问题</h2>\n<p>以加载 less 为例</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="46768738378186850000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// example.js\nrequire(\'./style.less\');`, `46768738378186850000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// example.js</span>\n<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./style.less\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="13783653155701004000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// style.less\n@color: #000fff;\n.content {\n  width: 50px;\n  height: 50px;\n  background-color: @color;\n}`, `13783653155701004000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="less"\n              >\n                <span class="gatsby-code-button-language">less</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="less"><pre style="counter-reset: linenumber NaN" class="language-less line-numbers"><code class="language-less"><span class="token comment">// style.less</span>\n<span class="token variable">@color<span class="token punctuation">:</span></span> #000fff<span class="token punctuation">;</span>\n<span class="token selector">.content</span> <span class="token punctuation">{</span>\n  <span class="token property">width</span><span class="token punctuation">:</span> 50px<span class="token punctuation">;</span>\n  <span class="token property">height</span><span class="token punctuation">:</span> 50px<span class="token punctuation">;</span>\n  <span class="token property">background-color</span><span class="token punctuation">:</span> <span class="token variable">@color</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>按照官方文档，想要加载 less 文件，我们需要配置三个 loader：<code class="language-text">style-loader!css-loader!less-loader</code>。</p>\n<p>该从什么地方着手研究呢？仔细观察最终生成的 output.js，如下图所示。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2021-08-03-01-31-30-662987309788d9773b0ceeeaa3e91968-64da1.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 93.85593220338984%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAIAAAAf7rriAAAACXBIWXMAAAsSAAALEgHS3X78AAAChklEQVQ4y4VTyXLbMAz1/39ODz10pumhxx4yibPUiRfZsi3LtixSJLgTKOisbTMTDIaWKQF4eHgY5ZytMb2QHowzVrsAPlkf9KlLztIgaRgoeOLnnAmxONv5HOWcjA/gvHfOAIAPTin39Yud3CetaFvTpqZTR4c9eU/vDXGUYowpp5TwKSUbVwBN6yUuHjkYDy02a/w9JtFjs8HNCvlVs6bTcZRSBq2FFCmmp0QxI2cK1TzfXOHtFW1WtFrQ/IHEieqq+HJegDBsrgnWK2OtBiWVUCC1GZQWAPrim10uIlHgtDkHTp2zj8kmjIj8b5RLsBs0FOzMHn92xpBjDDGEnKP3gT2UM5afaDlBLFYqM09iGKJlxhyzbVywIYKxmT6xESfwnNJxTu+s44YLpBCCUnk+pe6I1Qynk3JWM9L6r2DGWlCBTYySCe8O+ecFgiIDdHNJd9c0e8DFFC9/Ub2k14m8BCdwQWmnlSmw6/Vx8jAwFKV9vYo8Z5627KltSroXebwFs3X7Y1UtN03b9qo+SKGMDoVVj5/1zPIwSm+328OxO+zb437PFAZn4bnDsyRftYnnm/fB3lrR91qDNGGwvtd2MOUU2g0ArN+PK/NQeazKBgGOv+6UPQ5GquK9soxfLqv+5jrstmVJGIuSJEVRu/el51DGFBA/6o9vp5N8P0aWZFNjNcXJLY4v6X5MKfFWZa31qRfJBW8dq8eGxIJiyeRdg0zyuqLdpsibn3kfmPnHu1K59MxismEAA0oBQ5WgwYkBeqnlj+9yNudLs2tVvTHbRm93g+T1jU8gS2XD2lYa8xtspGde2fma/WnViudiz4Tx8pxOXdvuGbz5xwAsFOOJlOb/sz9fV0iqzvh1TgAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2021 08 03 01 31 30" title="" data-src="/static/2021-08-03-01-31-30-662987309788d9773b0ceeeaa3e91968-fee1c.png" data-srcset="/static/2021-08-03-01-31-30-662987309788d9773b0ceeeaa3e91968-a67b7.png 200w,\n/static/2021-08-03-01-31-30-662987309788d9773b0ceeeaa3e91968-0b187.png 400w,\n/static/2021-08-03-01-31-30-662987309788d9773b0ceeeaa3e91968-fee1c.png 800w,\n/static/2021-08-03-01-31-30-662987309788d9773b0ceeeaa3e91968-64da1.png 944w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>由此我们进行以下思考：</p>\n<ol>\n<li>\n<p>既然最终 css 代码会被插入到 head 标签中，那么一定是模块 2 在起作用。但是，项目中并不包含这部分代码，经过排查，发现源自于 node-modules/style-loader/addStyle.js ，也就是说，是由 style-loader 引入的。（后面我们再考察是如何引入的）</p>\n</li>\n<li>\n<p>观察模块 3，那应该是 less 代码经过 less-loader 的转换之后，再包装一层 module.exports，成为一个 JS module。</p>\n</li>\n<li>\n<p>style-loader 和 less-loader 的作用已经明了，但是，css-loader 发挥什么作用呢？虽然我一直按照官方文档配置三个 loader，但我从未真正理解为什么需要 css-loader。后来我在 css-loader 的文档中找到了答案。</p>\n<blockquote>\n<p>@import and url() are interpreted like import and will be resolved by the css-loader</p>\n</blockquote>\n<p>既然如此，为了降低实现的难度，我们暂时不予考虑 import 和 url 的情况，也就无需实现 css-loader 了。</p>\n</li>\n<li>\n<p>观察模块 1，<code class="language-text">require(2)(require(3))</code>，很显然：”模块 3 的导出作为模块 2 的输入参数，执行模块 2“，也就是说：“将模块 3 中的 css 代码插入到 head 标签中“。理解这个逻辑不难，难点在于：webpack 如何知道应该拼接成 <code class="language-text">require(2)(require(3))</code>，而不是别的什么。也就说，如何控制拼接出 <code class="language-text">require(2)(require(3))</code>？</p>\n</li>\n</ol>\n<h2 id="思路-1"><a href="#%E6%80%9D%E8%B7%AF-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>思路</h2>\n<p>思路进行到这儿，似乎走不下去了。看来只分析 output.js 还不足以理清，那么，让我们更进一步，观察 depTree，如下图所示。（图片较大，请点击放大查看）</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2021-08-03-01-33-55-0f638153c7c7c3ccfc0a3902917f0fee-f840e.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 52.04460966542751%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAAsSAAALEgHS3X78AAABgklEQVQozzVRybLjIAz0/3/fHOaSl8UxmH0zi7CBEckbVVslXEjdLRal1PP1pHLf9jehK5XMRFevc8zooyPazK2Nb2A98NRr7UvvXQgZUmwlXTtp6WiH68GNnGaz0YNug5FB34PTsT7Gvg3Jv7OWUgqSxxRzyQBQc0ZAKeBdoRvQdyVrxaxV1bIqCVafMVwXcvclxnR7/LzFRjjRThtvJ4Izh3dWW++c4p6sXuxughlGAqNZqbPWBdmlUi64fOZSSzkLnDCL562XMk3m1MnaUTkK3taxvYZRI/gpGz/vwnEcZ7/qVX9xQk1H/vsnr4/CCEgORjbvRjzGEQaU7+4W9Mkld9H56NF2mXaRHHfZAHL1FjgFsYPitST8A5CgJJSGrtFzvN1vu6Ib34iku2a72oUVCdLnlcYXF6K3Dy7MreO++pJTem0vbjj2YBaGs08/lZRrzhQXWkgrfXQ4LkIMOSDtr2zvw8/9jlR4VZh5D+sPJNMcx82JVthgoUJFO7iQ//EPDfk6vX/25U4AAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2021 08 03 01 33 55" title="" data-src="/static/2021-08-03-01-33-55-0f638153c7c7c3ccfc0a3902917f0fee-fee1c.png" data-srcset="/static/2021-08-03-01-33-55-0f638153c7c7c3ccfc0a3902917f0fee-a67b7.png 200w,\n/static/2021-08-03-01-33-55-0f638153c7c7c3ccfc0a3902917f0fee-0b187.png 400w,\n/static/2021-08-03-01-33-55-0f638153c7c7c3ccfc0a3902917f0fee-fee1c.png 800w,\n/static/2021-08-03-01-33-55-0f638153c7c7c3ccfc0a3902917f0fee-b1a91.png 1200w,\n/static/2021-08-03-01-33-55-0f638153c7c7c3ccfc0a3902917f0fee-95179.png 1600w,\n/static/2021-08-03-01-33-55-0f638153c7c7c3ccfc0a3902917f0fee-f840e.png 1883w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>问题在于：为什么凭空多出来 2 个模块？到底是哪里起了作用呢？我在 style-loader 的源码中找到了答案。</p>\n<h2 id="style-loader-的再-require"><a href="#style-loader-%E7%9A%84%E5%86%8D-require" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>style-loader 的再 require</h2>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="99246411498160850000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// style-loader/index.js\nconst path = require(\'path\');\nmodule.exports = function(content) {\n  // content 的值为：/Users/youngwind/www/fake-webpack/node_modules/style-loader-fake/index.js!/Users/youngwind/www/fake-webpack/node_modules/less-loader-fake/index.js!/Users/youngwind/www/fake-webpack/examples/loader/style.less\n  let loaderSign = this.request.indexOf(\'!\');\n  let rawCss = this.request.substr(loaderSign);\n  // rawCss 的值为：/Users/youngwind/www/fake-webpack/node_modules/less-loader-fake/index.js!/Users/youngwind/www/fake-webpack/examples/loader/style.less\n  return (\n    \'require(\' + JSON.stringify(path.join(__dirname, \'addStyle\')) + \')\' + \'(require(\' + JSON.stringify(rawCss) + \'))\'\n  );\n};`, `99246411498160850000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// style-loader/index.js</span>\n<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'path\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nmodule<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">content</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// content 的值为：/Users/youngwind/www/fake-webpack/node_modules/style-loader-fake/index.js!/Users/youngwind/www/fake-webpack/node_modules/less-loader-fake/index.js!/Users/youngwind/www/fake-webpack/examples/loader/style.less</span>\n  <span class="token keyword">let</span> loaderSign <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>request<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">\'!\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">let</span> rawCss <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>request<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span>loaderSign<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// rawCss 的值为：/Users/youngwind/www/fake-webpack/node_modules/less-loader-fake/index.js!/Users/youngwind/www/fake-webpack/examples/loader/style.less</span>\n  <span class="token keyword">return</span> <span class="token punctuation">(</span>\n    <span class="token string">\'require(\'</span> <span class="token operator">+</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">\'addStyle\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">\')\'</span> <span class="token operator">+</span> <span class="token string">\'(require(\'</span> <span class="token operator">+</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>rawCss<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">\'))\'</span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>观察源码，我们发现：style-loader 返回的字符串里面又包含了 2 个 require，分别 require 了 addStyle 和 less-loader!style.less，由此，我们终于找到了突破口。loader 本质上是一个函数，输入参数是一个字符串，输出参数也是一个字符串。当然，输出的参数会被当成是 JS 代码，从而被 esprima 解析成 AST，触发进一步的依赖解析。这就是多引入 2 个模块的原因。</p>\n<h2 id="loaders-的拆解与运行"><a href="#loaders-%E7%9A%84%E6%8B%86%E8%A7%A3%E4%B8%8E%E8%BF%90%E8%A1%8C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>loaders 的拆解与运行</h2>\n<p>loaders 就像首尾相接的管道那样，从右到左地被依次运行。对应的代码如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="46362464795239090000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// buildDep.js\n/**\n * 运算文件类型对应的 loaders，比如: less 文件对应 style-loader 和 less-loader\n * 这些 loaders 本质上是一些处理字符串的函数，输入是一个字符串，输出是另一个字符串，从右到左串行执行\n * @param {string} request 相当于 filenamesWithLoader，比如 /Users/youngwind/www/fake-webpack/node_modules/fake-style-loader/index.js!/Users/youngwind/www/fake-webpack/node_modules/fake-less-loader/index.js!/Users/youngwind/www/fake-webpack/examples/loader/style.less\n * @param {array} loaders 此类型文件对应的 loaders\n * @param {string} content 文件内容\n * @param {object} options 选项\n * @returns {Promise}\n */\nfunction execLoaders(request, loaders, content, options) {\n  return new Promise((resolve, reject) => {\n    // 当所有 loader 都执行完了，输出最终的字符串\n    if (!loaders.length) {\n      resolve(content);\n      return;\n    }\n\n    let loaderFunctions = [];\n    loaders.forEach((loaderName) => {\n      let loader = require(loaderName);\n      // 每个 loader 本质上是一个函数\n      loaderFunctions.push(loader);\n    });\n\n    nextLoader(content);\n\n    /***\n     * 调用下一个 loader\n     * @param {string} content 上一个 loader 的输出字符串\n     */\n    function nextLoader(content) {\n      if (!loaderFunctions.length) {\n        resolve(content);\n        return;\n      }\n      // 请注意: loader 有同步和异步两种类型。对于异步 loader，如 less-loader\n      // 需要执行 async() 和 callback()，以修改标志位和回传字符串\n      let async = false;\n      let context = {\n        request,\n        async: () => {\n          async = true;\n        },\n        callback: (content) => {\n          nextLoader(content);\n        }\n      };\n\n      // 就是在这儿逐个调用 loader\n      let ret = loaderFunctions.pop().call(context, content);\n      if (!async) {\n        // 递归调用下一个 loader\n        nextLoader(ret);\n      }\n    }\n  });\n}`, `46362464795239090000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// buildDep.js</span>\n<span class="token comment">/**\n * 运算文件类型对应的 loaders，比如: less 文件对应 style-loader 和 less-loader\n * 这些 loaders 本质上是一些处理字符串的函数，输入是一个字符串，输出是另一个字符串，从右到左串行执行\n * @param {string} request 相当于 filenamesWithLoader，比如 /Users/youngwind/www/fake-webpack/node_modules/fake-style-loader/index.js!/Users/youngwind/www/fake-webpack/node_modules/fake-less-loader/index.js!/Users/youngwind/www/fake-webpack/examples/loader/style.less\n * @param {array} loaders 此类型文件对应的 loaders\n * @param {string} content 文件内容\n * @param {object} options 选项\n * @returns {Promise}\n */</span>\n<span class="token keyword">function</span> <span class="token function">execLoaders</span><span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> loaders<span class="token punctuation">,</span> content<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token comment">// 当所有 loader 都执行完了，输出最终的字符串</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>loaders<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token function">resolve</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">return</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">let</span> loaderFunctions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n    loaders<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">loaderName</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">let</span> loader <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span>loaderName<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token comment">// 每个 loader 本质上是一个函数</span>\n      loaderFunctions<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>loader<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token function">nextLoader</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">/***\n     * 调用下一个 loader\n     * @param {string} content 上一个 loader 的输出字符串\n     */</span>\n    <span class="token keyword">function</span> <span class="token function">nextLoader</span><span class="token punctuation">(</span><span class="token parameter">content</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>loaderFunctions<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token function">resolve</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">return</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      <span class="token comment">// 请注意: loader 有同步和异步两种类型。对于异步 loader，如 less-loader</span>\n      <span class="token comment">// 需要执行 async() 和 callback()，以修改标志位和回传字符串</span>\n      <span class="token keyword">let</span> async <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>\n      <span class="token keyword">let</span> context <span class="token operator">=</span> <span class="token punctuation">{</span>\n        request<span class="token punctuation">,</span>\n        <span class="token function-variable function">async</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n          async <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span><span class="token punctuation">,</span>\n        <span class="token function-variable function">callback</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">content</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n          <span class="token function">nextLoader</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n      <span class="token comment">// 就是在这儿逐个调用 loader</span>\n      <span class="token keyword">let</span> ret <span class="token operator">=</span> loaderFunctions<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>async<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token comment">// 递归调用下一个 loader</span>\n        <span class="token function">nextLoader</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>请注意：loader 也是分为同步和异步两种的，比如 style-loader 是同步的（看源码就知道，直接 return）；而 less-loader 却是异步的，为什么呢？</p>\n<h2 id="异步的-less-loader"><a href="#%E5%BC%82%E6%AD%A5%E7%9A%84-less-loader" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>异步的 less-loader</h2>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="52317881044545580000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// less-loader\nconst less = require(\'less\');\n\nmodule.exports = function(source) {\n  // 声明此 loader 是异步的\n  this.async();\n  let resultCb = this.callback;\n  less.render(source, (e, output) => {\n    if (e) {\n      throw \\`less解析出现错误: \\${e}, \\${e.stack}\\`;\n    }\n    resultCb(\'module.exports = \' + JSON.stringify(output.css));\n  });\n};`, `52317881044545580000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// less-loader</span>\n<span class="token keyword">const</span> less <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'less\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nmodule<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 声明此 loader 是异步的</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">async</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">let</span> resultCb <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>callback<span class="token punctuation">;</span>\n  less<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">e<span class="token punctuation">,</span> output</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">throw</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">less解析出现错误: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>e<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>e<span class="token punctuation">.</span>stack<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token function">resultCb</span><span class="token punctuation">(</span><span class="token string">\'module.exports = \'</span> <span class="token operator">+</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>output<span class="token punctuation">.</span>css<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>由代码我们可以看出：less-loader 本质上只是调用了 less 本身的 render 方法，由于 less.render 是异步的，less-loader 肯定也得异步，所以需要通过回调函数来获取其解析之后的 css 代码。</p>\n<h2 id="node-modules-的逐级查找"><a href="#node-modules-%E7%9A%84%E9%80%90%E7%BA%A7%E6%9F%A5%E6%89%BE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>node-modules 的逐级查找</h2>\n<p>还差最后一点，我们就能完成 loader 机制了。试想以下情景：webpack 检测到当前为 less 文件，需要找到 style-loader 和 less-loader 运行。但是，webpack 怎么知道这两个 loader 藏在哪个目录下面呢？他们可能藏在 example.js 所在目录的任意上层文件夹的 node-modules 中。说到底，我们还是得实现之前提到过的 node-modules 的逐级查找功能。核心代码如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="45097773140205860000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// resolve.js\n/**\n * 根据 loaders / 模块名,生成待查找的路径集合\n * @param {string} context 入口文件所在目录\n * @param {array} identifiers 可能是 loader 的集合,也可能是模块名\n * @returns {Array}\n */\nfunction generateDirs(context, identifiers) {\n  let dirs = [];\n  for (let identifier of identifiers) {\n    if (path.isAbsolute(identifier)) {\n      // 绝对路径\n      if (!path.extname(identifier)) {\n        identifier += \'.js\';\n      }\n      dirs.push(identifier);\n    } else if (identifier.startsWith(\'./\') || identifier.startsWith(\'../\')) {\n      // 相对路径\n      dirs.push(path.resolve(context, identifier));\n    } else {\n      // 模块名，需要逐级生成目录\n      let ext = path.extname(identifier);\n      if (!ext) {\n        ext = \'.js\';\n      }\n      let paths = context.split(path.sep);\n      let tempPaths = paths.slice();\n      for (let folder of tempPaths) {\n        let newContext = paths.join(path.sep);\n        dirs.push(path.resolve(newContext, \'./node_modules\', \\`./\\${identifier}-loader-fake\\`, \\`index\\${ext}\\`));\n        paths.pop();\n      }\n    }\n  }\n  return dirs;\n}`, `45097773140205860000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// resolve.js</span>\n<span class="token comment">/**\n * 根据 loaders / 模块名,生成待查找的路径集合\n * @param {string} context 入口文件所在目录\n * @param {array} identifiers 可能是 loader 的集合,也可能是模块名\n * @returns {Array}\n */</span>\n<span class="token keyword">function</span> <span class="token function">generateDirs</span><span class="token punctuation">(</span><span class="token parameter">context<span class="token punctuation">,</span> identifiers</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">let</span> dirs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> identifier <span class="token keyword">of</span> identifiers<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">isAbsolute</span><span class="token punctuation">(</span>identifier<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 绝对路径</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>path<span class="token punctuation">.</span><span class="token function">extname</span><span class="token punctuation">(</span>identifier<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        identifier <span class="token operator">+=</span> <span class="token string">\'.js\'</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      dirs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>identifier<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>identifier<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">\'./\'</span><span class="token punctuation">)</span> <span class="token operator">||</span> identifier<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">\'../\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 相对路径</span>\n      dirs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> identifier<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 模块名，需要逐级生成目录</span>\n      <span class="token keyword">let</span> ext <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">extname</span><span class="token punctuation">(</span>identifier<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ext<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        ext <span class="token operator">=</span> <span class="token string">\'.js\'</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      <span class="token keyword">let</span> paths <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span>sep<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">let</span> tempPaths <span class="token operator">=</span> paths<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> folder <span class="token keyword">of</span> tempPaths<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">let</span> newContext <span class="token operator">=</span> paths<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span>sep<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        dirs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>newContext<span class="token punctuation">,</span> <span class="token string">\'./node_modules\'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">./</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>identifier<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-loader-fake</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">index</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ext<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        paths<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">return</span> dirs<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>举个例子，对于 style-loader 来说，生成的查找路径集合如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="79414059261911740000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`[\n  \'/Users/youngwind/www/fake-webpack/examples/loader/node_modules/style-loader-fake/index.js\',\n  \'/Users/youngwind/www/fake-webpack/examples/node_modules/style-loader-fake/index.js\',\n  \'/Users/youngwind/www/fake-webpack/node_modules/style-loader-fake/index.js\',\n  \'/Users/youngwind/www/node_modules/style-loader-fake/index.js\',\n  \'/Users/youngwind/node_modules/style-loader-fake/index.js\',\n  \'/Users/node_modules/style-loader-fake/index.js\'\n];`, `79414059261911740000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token punctuation">[</span>\n  <span class="token string">\'/Users/youngwind/www/fake-webpack/examples/loader/node_modules/style-loader-fake/index.js\'</span><span class="token punctuation">,</span>\n  <span class="token string">\'/Users/youngwind/www/fake-webpack/examples/node_modules/style-loader-fake/index.js\'</span><span class="token punctuation">,</span>\n  <span class="token string">\'/Users/youngwind/www/fake-webpack/node_modules/style-loader-fake/index.js\'</span><span class="token punctuation">,</span>\n  <span class="token string">\'/Users/youngwind/www/node_modules/style-loader-fake/index.js\'</span><span class="token punctuation">,</span>\n  <span class="token string">\'/Users/youngwind/node_modules/style-loader-fake/index.js\'</span><span class="token punctuation">,</span>\n  <span class="token string">\'/Users/node_modules/style-loader-fake/index.js\'</span>\n<span class="token punctuation">]</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>程序按照这个顺序依次查找，直到找到为止或者最终找不到抛出错误。</p>\n<h2 id="后话-1"><a href="#%E5%90%8E%E8%AF%9D-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>后话</h2>\n<p>至此，我们就完成了一个非常简单的 loader 机制，可以通过 style-loader 和 less-loader 处理加载 less 文件。当然，还有很多可以完善的地方，比如：</p>\n<ul>\n<li>css-loader，以处理 import 和 url 的情况</li>\n<li>给 loader 传递选项参数，以控制是否压缩代码等等特性</li>\n</ul>',
id:"/home/runner/work/GatsbyBlog/GatsbyBlog/blog/深入理解 Webpack 源码/index.md absPath of file >>> MarkdownRemark",timeToRead:29,frontmatter:{date:"2021-07-29 10:56:23",path:"/deep-learn-webpack-source-code/",tags:"前端, webpack, 前端构建工具",title:"深入理解 Webpack 源码",draft:null}},{excerpt:"概括 Webpack 以其使用简单著称，在使用它的过程中，使用者只需把它当作一个黑盒，需要关心的只有它暴露出来的配置。 本节将带你走进这个黑盒，看看 Webpack 是如何运行的。 基本概念 在了解 Webpack 原理前，需要掌握以下几个核心概念，以方便后面的理解： Entry：入口，Webpack 执行构建的第一步将从 Entry 开始，可抽象成输入。 Module：模块，在 Webpack 里一切皆模块，一个模块对应着一个文件。Webpack 会从配置的 Entry…",html:'<h1 id="概括"><a href="#%E6%A6%82%E6%8B%AC" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>概括</h1>\n<p>Webpack 以其使用简单著称，在使用它的过程中，使用者只需把它当作一个黑盒，需要关心的只有它暴露出来的配置。 本节将带你走进这个黑盒，看看 Webpack 是如何运行的。</p>\n<h2 id="基本概念"><a href="#%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>基本概念</h2>\n<p>在了解 Webpack 原理前，需要掌握以下几个核心概念，以方便后面的理解：</p>\n<ul>\n<li>Entry：入口，Webpack 执行构建的第一步将从 Entry 开始，可抽象成输入。</li>\n<li>Module：模块，在 Webpack 里一切皆模块，一个模块对应着一个文件。Webpack 会从配置的 Entry 开始递归找出所有依赖的模块。</li>\n<li>Chunk：代码块，一个 Chunk 由多个模块组合而成，用于代码合并与分割。</li>\n<li>Loader：模块转换器，用于把模块原内容按照需求转换成新内容。</li>\n<li>Plugin：扩展插件，在 Webpack 构建流程中的特定时机会广播出对应的事件，插件可以监听这些事件的发生，在特定时机做对应的事情。</li>\n</ul>\n<h2 id="流程概括"><a href="#%E6%B5%81%E7%A8%8B%E6%A6%82%E6%8B%AC" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>流程概括</h2>\n<p>Webpack 的运行流程是一个串行的过程，从启动到结束会依次执行以下流程：</p>\n<ol>\n<li>初始化参数：从配置文件和 Shell 语句中读取与合并参数，得出最终的参数；</li>\n<li>开始编译：用上一步得到的参数初始化 Compiler 对象，加载所有配置的插件，执行对象的 run 方法开始执行编译；</li>\n<li>确定入口：根据配置中的 entry 找出所有的入口文件；</li>\n<li>编译模块：从入口文件出发，调用所有配置的 Loader 对模块进行翻译，再找出该模块依赖的模块，再递归本步骤直到所有入口依赖的文件都经过了本步骤的处理；</li>\n<li>完成模块编译：在经过第 4 步使用 Loader 翻译完所有模块后，得到了每个模块被翻译后的最终内容以及它们之间的依赖关系；</li>\n<li>输出资源：根据入口和模块之间的依赖关系，组装成一个个包含多个模块的 Chunk，再把每个 Chunk 转换成一个单独的文件加入到输出列表，这步是可以修改输出内容的最后机会；</li>\n<li>输出完成：在确定好输出内容后，根据配置确定输出的路径和文件名，把文件内容写入到文件系统。</li>\n</ol>\n<p>在以上过程中，Webpack 会在特定的时间点广播出特定的事件，插件在监听到感兴趣的事件后会执行特定的逻辑，并且插件可以调用 Webpack 提供的 API 改变 Webpack 的运行结果。</p>\n<h2 id="流程细节"><a href="#%E6%B5%81%E7%A8%8B%E7%BB%86%E8%8A%82" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>流程细节</h2>\n<p>Webpack 的构建流程可以分为以下三大阶段：</p>\n<ol>\n<li>初始化：启动构建，读取与合并配置参数，加载 Plugin，实例化 Compiler。</li>\n<li>编译：从 Entry 发出，针对每个 Module 串行调用对应的 Loader 去翻译文件内容，再找到该 Module 依赖的 Module，递归地进行编译处理。</li>\n<li>输出：对编译后的 Module 组合成 Chunk，把 Chunk 转换成文件，输出到文件系统。</li>\n</ol>\n<p>如果只执行一次构建，以上阶段将会按照顺序各执行一次。但在开启监听模式下，流程将变为如下：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2020-11-17-11-55-09-c7f1268f7c8c09615cbcff76cf43b386-aa752.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 339px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 122.4188790560472%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAYCAIAAAB1KUohAAAACXBIWXMAAAsSAAALEgHS3X78AAACOklEQVQ4y6VUSYoiQRR1th1KRbfiGRS8ge60wQnbe+gRRMQZhxMI7twozrpRQXCniPOEE+KAwwn6EdlVZVeZVQ39Fp8f8eNlZP73fjIYf4PJZCJqtVqHw2GxWKxWq91u/0Vgs9mwxCZylUrF+AwWi4Xo9/uPx+NkMpnNZq1Wq9lsIvZ6veVyic3D4WA2m2nJPp9vv9+PRqPxeJzJZJLJZCqVqtfri8ViOByi9BXZ6XTiaC6XKxaLlUqlVqtVq9VSqYRlPp9HSafTMejA5XIFAsEPAuQikejl5QW5gEAoFLLZ7PcmCQlQ5vF4fD4fBJQRkWNfLpcjp71HKpVyOBwkiKDxCMCkbkMVCb6I/QpKlD9kvBiDHhyC5zVcQpGZBEggaSgUcrvdHo/H6/XGYrFIJOIhwGYwGNRoNE/IVLfBvF6vEGa323U6HeiEPkPzzWYDqS+XC9xCSw4EAufzeTqdrtfrbrebTqfhE5DBRDydTvAZ7WvDm/F4HFbBU/CSiUQiGo0GCLCJEvz7kUwHFsE3DXs8/aYKckqw51J9e/M/SfU4mKxXIIdJqAOPm7TddrlcaC9mgBoGxHK5XCIoFAqNRkOv19OSYQwo3O/35/M5ngKTZLNZzDOGeTAYoGQymWjJ4XD4fr+vViucA7/dbkNtLLfbLeLtdoMFn3wz9TFqtRrjbjQafxLgvwNXGAkMBgOuVSqV72SxWPxFt9/M81wJmUyGuRW9QiKRSB+gUCgwec91/uCKz6C11//gNyZCGYbNevPtAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2020 11 17 11 55 09" title="" data-src="/static/2020-11-17-11-55-09-c7f1268f7c8c09615cbcff76cf43b386-aa752.png" data-srcset="/static/2020-11-17-11-55-09-c7f1268f7c8c09615cbcff76cf43b386-bb04d.png 200w,\n/static/2020-11-17-11-55-09-c7f1268f7c8c09615cbcff76cf43b386-aa752.png 339w" data-sizes="(max-width: 339px) 100vw, 339px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>在每个大阶段中又会发生很多事件，Webpack 会把这些事件广播出来供给 Plugin 使用，下面来一一介绍。</p>\n<h2 id="初始化阶段"><a href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E9%98%B6%E6%AE%B5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>初始化阶段</h2>\n<table>\n<thead>\n<tr>\n<th align="center">事件名</th>\n<th align="center">解释</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align="center">初始化参数</td>\n<td align="center">从配置文件和 Shell 语句中读取与合并参数，得出最终的参数。 这个过程中还会执行配置文件中的插件实例化语句 new Plugin()。</td>\n</tr>\n<tr>\n<td align="center">实例化 Compiler</td>\n<td align="center">用上一步得到的参数初始化 Compiler 实例，Compiler 负责文件监听和启动编译。Compiler 实例中包含了完整的 Webpack 配置，全局只有一个 Compiler 实例。</td>\n</tr>\n<tr>\n<td align="center">加载插件</td>\n<td align="center">依次调用插件的 apply 方法，让插件可以监听后续的所有事件节点。同时给插件传入 compiler 实例的引用，以方便插件通过 compiler 调用 Webpack 提供的 API。</td>\n</tr>\n<tr>\n<td align="center">environment</td>\n<td align="center">开始应用 Node.js 风格的文件系统到 compiler 对象，以方便后续的文件寻找和读取。</td>\n</tr>\n<tr>\n<td align="center">entry-option</td>\n<td align="center">读取配置的 Entrys，为每个 Entry 实例化一个对应的 EntryPlugin，为后面该 Entry 的递归解析工作做准备。</td>\n</tr>\n<tr>\n<td align="center">after-plugins</td>\n<td align="center">调用完所有内置的和配置的插件的 apply 方法。</td>\n</tr>\n<tr>\n<td align="center">after-resolvers</td>\n<td align="center">根据配置初始化完 resolver，resolver 负责在文件系统中寻找指定路径的文件。</td>\n</tr>\n</tbody>\n</table>\n<h2 id="编译阶段"><a href="#%E7%BC%96%E8%AF%91%E9%98%B6%E6%AE%B5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>编译阶段</h2>\n<table>\n<thead>\n<tr>\n<th align="center">事件名</th>\n<th align="center">解释</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align="center">run</td>\n<td align="center">启动一次新的编译。</td>\n</tr>\n<tr>\n<td align="center">watch-run</td>\n<td align="center">和 run 类似，区别在于它是在监听模式下启动的编译，在这个事件中可以获取到是哪些文件发生了变化导致重新启动一次新的编译。</td>\n</tr>\n<tr>\n<td align="center">compile</td>\n<td align="center">该事件是为了告诉插件一次新的编译将要启动，同时会给插件带上 compiler 对象。</td>\n</tr>\n<tr>\n<td align="center">compilation</td>\n<td align="center">当 Webpack 以开发模式运行时，每当检测到文件变化，一次新的 Compilation 将被创建。一个 Compilation 对象包含了当前的模块资源、编译生成资源、变化的文件等。Compilation 对象也提供了很多事件回调供插件做扩展。</td>\n</tr>\n<tr>\n<td align="center">make</td>\n<td align="center">一个新的 Compilation 创建完毕，即将从 Entry 开始读取文件，根据文件类型和配置的 Loader 对文件进行编译，编译完后再找出该文件依赖的文件，递归的编译和解析。</td>\n</tr>\n<tr>\n<td align="center">after-compile</td>\n<td align="center">一次 Compilation 执行完成。</td>\n</tr>\n<tr>\n<td align="center">invalid</td>\n<td align="center">当遇到文件不存在、文件编译错误等异常时会触发该事件，该事件不会导致 Webpack 退出。</td>\n</tr>\n</tbody>\n</table>\n<p>在编译阶段中，最重要的要数 compilation 事件了，因为在 compilation 阶段调用了 Loader 完成了每个模块的转换操作，在 compilation 阶段又包括很多小的事件，它们分别是：</p>\n<table>\n<thead>\n<tr>\n<th align="center">事件名</th>\n<th align="center">解释</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align="center">build-module</td>\n<td align="center">使用对应的 Loader 去转换一个模块。</td>\n</tr>\n<tr>\n<td align="center">normal-module-loader</td>\n<td align="center">在用 Loader 对一个模块转换完后，使用 acorn 解析转换后的内容，输出对应的抽象语法树（AST），以方便 Webpack 后面对代码的分析。</td>\n</tr>\n<tr>\n<td align="center">program</td>\n<td align="center">从配置的入口模块开始，分析其 AST，当遇到 require 等导入其它模块语句时，便将其加入到依赖的模块列表，同时对新找出的依赖模块递归分析，最终搞清所有模块的依赖关系。</td>\n</tr>\n<tr>\n<td align="center">seal</td>\n<td align="center">所有模块及其依赖的模块都通过 Loader 转换完成后，根据依赖关系开始生成 Chunk。</td>\n</tr>\n</tbody>\n</table>\n<h2 id="输出阶段"><a href="#%E8%BE%93%E5%87%BA%E9%98%B6%E6%AE%B5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>输出阶段</h2>\n<table>\n<thead>\n<tr>\n<th align="center">事件名</th>\n<th align="center">解释</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align="center">should-emit</td>\n<td align="center">所有需要输出的文件已经生成好，询问插件哪些文件需要输出，哪些不需要。</td>\n</tr>\n<tr>\n<td align="center">emit</td>\n<td align="center">确定好要输出哪些文件后，执行文件输出，可以在这里获取和修改输出内容。</td>\n</tr>\n<tr>\n<td align="center">after-emit</td>\n<td align="center">文件输出完毕。</td>\n</tr>\n<tr>\n<td align="center">done</td>\n<td align="center">成功完成一次完成的编译和输出流程。</td>\n</tr>\n<tr>\n<td align="center">failed</td>\n<td align="center">如果在编译和输出流程中遇到异常导致 Webpack 退出时，就会直接跳转到本步骤，插件可以在本事件中获取到具体的错误原因。</td>\n</tr>\n</tbody>\n</table>\n<p>在输出阶段已经得到了各个模块经过转换后的结果和其依赖关系，并且把相关模块组合在一起形成一个个 Chunk。 在输出阶段会根据 Chunk 的类型，使用对应的模版生成最终要要输出的文件内容。</p>\n<p>至于如何把 Chunk 输出为具体的文件，详情可以阅读 5-2 输出文件分析。</p>\n<h1 id="输出文件分析"><a href="#%E8%BE%93%E5%87%BA%E6%96%87%E4%BB%B6%E5%88%86%E6%9E%90" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>输出文件分析</h1>\n<p>虽然在前面的章节中你学会了如何使用 Webpack ，也大致知道其工作原理，可是你想过 Webpack 输出的 bundle.js 是什么样子的吗？ 为什么原来一个个的模块文件被合并成了一个单独的文件？为什么 bundle.js 能直接运行在浏览器中？ 本节将解释清楚以上问题。</p>\n<p>最简单的项目构建出的 bundle.js 文件内容，代码如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="13747740736686920000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// webpackBootstrap 启动函数\n// modules 即为存放所有模块的数组，数组中的每一个元素都是一个函数\n(function(modules) {\n  // 安装过的模块都存放在这里面\n  // 作用是把已经加载过的模块缓存在内存中，提升性能\n  var installedModules = {};\n\n  // 去数组中加载一个模块，moduleId 为要加载模块在数组中的 index\n  // 作用和 Node.js 中 require 语句相似\n  function __webpack_require__(moduleId) {\n    // 如果需要加载的模块已经被加载过，就直接从内存缓存中返回\n    if (installedModules[moduleId]) {\n      return installedModules[moduleId].exports;\n    }\n\n    // 如果缓存中不存在需要加载的模块，就新建一个模块，并把它存在缓存中\n    var module = (installedModules[moduleId] = {\n      // 模块在数组中的 index\n      i: moduleId,\n      // 该模块是否已经加载完毕\n      l: false,\n      // 该模块的导出值\n      exports: {}\n    });\n\n    // 从 modules 中获取 index 为 moduleId 的模块对应的函数\n    // 再调用这个函数，同时把函数需要的参数传入\n    modules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n    // 把这个模块标记为已加载\n    module.l = true;\n    // 返回这个模块的导出值\n    return module.exports;\n  }\n\n  // Webpack 配置中的 publicPath，用于加载被分割出去的异步代码\n  __webpack_require__.p = \'\';\n\n  // 使用 __webpack_require__ 去加载 index 为 0 的模块，并且返回该模块导出的内容\n  // index 为 0 的模块就是 main.js 对应的文件，也就是执行入口模块\n  // __webpack_require__.s 的含义是启动模块对应的 index\n  return __webpack_require__((__webpack_require__.s = 0));\n})(\n  // 所有的模块都存放在了一个数组里，根据每个模块在数组的 index 来区分和定位模块\n  [\n    /* 0 */\n    function(module, exports, __webpack_require__) {\n      // 通过 __webpack_require__ 规范导入 show 函数，show.js 对应的模块 index 为 1\n      const show = __webpack_require__(1);\n      // 执行 show 函数\n      show(\'Webpack\');\n    },\n    /* 1 */\n    function(module, exports) {\n      function show(content) {\n        window.document.getElementById(\'app\').innerText = \'Hello,\' + content;\n      }\n      // 通过 CommonJS 规范导出 show 函数\n      module.exports = show;\n    }\n  ]\n);`, `13747740736686920000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// webpackBootstrap 启动函数</span>\n<span class="token comment">// modules 即为存放所有模块的数组，数组中的每一个元素都是一个函数</span>\n<span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">modules</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 安装过的模块都存放在这里面</span>\n  <span class="token comment">// 作用是把已经加载过的模块缓存在内存中，提升性能</span>\n  <span class="token keyword">var</span> installedModules <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 去数组中加载一个模块，moduleId 为要加载模块在数组中的 index</span>\n  <span class="token comment">// 作用和 Node.js 中 require 语句相似</span>\n  <span class="token keyword">function</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token parameter">moduleId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 如果需要加载的模块已经被加载过，就直接从内存缓存中返回</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span> installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">.</span>exports<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token comment">// 如果缓存中不存在需要加载的模块，就新建一个模块，并把它存在缓存中</span>\n    <span class="token keyword">var</span> module <span class="token operator">=</span> <span class="token punctuation">(</span>installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 模块在数组中的 index</span>\n      i<span class="token punctuation">:</span> moduleId<span class="token punctuation">,</span>\n      <span class="token comment">// 该模块是否已经加载完毕</span>\n      l<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n      <span class="token comment">// 该模块的导出值</span>\n      exports<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// 从 modules 中获取 index 为 moduleId 的模块对应的函数</span>\n    <span class="token comment">// 再调用这个函数，同时把函数需要的参数传入</span>\n    modules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> module<span class="token punctuation">,</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> __webpack_require__<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// 把这个模块标记为已加载</span>\n    module<span class="token punctuation">.</span>l <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n    <span class="token comment">// 返回这个模块的导出值</span>\n    <span class="token keyword">return</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token comment">// Webpack 配置中的 publicPath，用于加载被分割出去的异步代码</span>\n  __webpack_require__<span class="token punctuation">.</span>p <span class="token operator">=</span> <span class="token string">\'\'</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 使用 __webpack_require__ 去加载 index 为 0 的模块，并且返回该模块导出的内容</span>\n  <span class="token comment">// index 为 0 的模块就是 main.js 对应的文件，也就是执行入口模块</span>\n  <span class="token comment">// __webpack_require__.s 的含义是启动模块对应的 index</span>\n  <span class="token keyword">return</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token punctuation">(</span>__webpack_require__<span class="token punctuation">.</span>s <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>\n  <span class="token comment">// 所有的模块都存放在了一个数组里，根据每个模块在数组的 index 来区分和定位模块</span>\n  <span class="token punctuation">[</span>\n    <span class="token comment">/* 0 */</span>\n    <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 通过 __webpack_require__ 规范导入 show 函数，show.js 对应的模块 index 为 1</span>\n      <span class="token keyword">const</span> show <span class="token operator">=</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token comment">// 执行 show 函数</span>\n      <span class="token function">show</span><span class="token punctuation">(</span><span class="token string">\'Webpack\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token comment">/* 1 */</span>\n    <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">function</span> <span class="token function">show</span><span class="token punctuation">(</span><span class="token parameter">content</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        window<span class="token punctuation">.</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">\'app\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText <span class="token operator">=</span> <span class="token string">\'Hello,\'</span> <span class="token operator">+</span> content<span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      <span class="token comment">// 通过 CommonJS 规范导出 show 函数</span>\n      module<span class="token punctuation">.</span>exports <span class="token operator">=</span> show<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">]</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>以上看上去复杂的代码其实是一个立即执行函数，可以简写为如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="69728733418923385000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(function(modules) {\n  // 模拟 require 语句\n  function __webpack_require__() {}\n\n  // 执行存放所有模块数组中的第0个模块\n  __webpack_require__(0);\n})([\n  /*存放所有模块的数组*/\n]);`, `69728733418923385000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">modules</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 模拟 require 语句</span>\n  <span class="token keyword">function</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n\n  <span class="token comment">// 执行存放所有模块数组中的第0个模块</span>\n  <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">[</span>\n  <span class="token comment">/*存放所有模块的数组*/</span>\n<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>bundle.js 能直接运行在浏览器中的原因在于输出的文件中通过 <code class="language-text">__webpack_require__</code> 函数定义了一个可以在浏览器中执行的加载函数来模拟 Node.js 中的 require 语句。</p>\n<p>原来一个个独立的模块文件被合并到了一个单独的 bundle.js 的原因在于浏览器不能像 Node.js 那样快速地去本地加载一个个模块文件，而必须通过网络请求去加载还未得到的文件。 如果模块数量很多，加载时间会很长，因此把所有模块都存放在了数组中，执行一次网络加载。</p>\n<p>如果仔细分析 <code class="language-text">__webpack_require__</code> 函数的实现，你还有发现 Webpack 做了缓存优化： 执行加载过的模块不会再执行第二次，执行结果会缓存在内存中，当某个模块第二次被访问时会直接去内存中读取被缓存的返回值。</p>\n<h2 id="分割代码时的输出"><a href="#%E5%88%86%E5%89%B2%E4%BB%A3%E7%A0%81%E6%97%B6%E7%9A%84%E8%BE%93%E5%87%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>分割代码时的输出</h2>\n<p>在采用了 4-12 按需加载 中介绍过的优化方法时，Webpack 的输出文件会发生变化。</p>\n<p>例如把源码中的 main.js 修改为如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="42155851620450940000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 异步加载 show.js\nimport(\'./show\').then((show) => {\n  // 执行 show 函数\n  show(\'Webpack\');\n});`, `42155851620450940000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 异步加载 show.js</span>\n<span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">\'./show\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">show</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token comment">// 执行 show 函数</span>\n  <span class="token function">show</span><span class="token punctuation">(</span><span class="token string">\'Webpack\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>重新构建后会输出两个文件，分别是执行入口文件 bundle.js 和 异步加载文件 0.bundle.js。</p>\n<p>其中 0.bundle.js 内容如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="61909261173034590000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 加载在本文件(0.bundle.js)中包含的模块\nwebpackJsonp(\n  // 在其它文件中存放着的模块的 ID\n  [0],\n  // 本文件所包含的模块\n  [\n    // show.js 所对应的模块\n    function(module, exports) {\n      function show(content) {\n        window.document.getElementById(\'app\').innerText = \'Hello,\' + content;\n      }\n\n      module.exports = show;\n    }\n  ]\n);`, `61909261173034590000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 加载在本文件(0.bundle.js)中包含的模块</span>\n<span class="token function">webpackJsonp</span><span class="token punctuation">(</span>\n  <span class="token comment">// 在其它文件中存放着的模块的 ID</span>\n  <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n  <span class="token comment">// 本文件所包含的模块</span>\n  <span class="token punctuation">[</span>\n    <span class="token comment">// show.js 所对应的模块</span>\n    <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">function</span> <span class="token function">show</span><span class="token punctuation">(</span><span class="token parameter">content</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        window<span class="token punctuation">.</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">\'app\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText <span class="token operator">=</span> <span class="token string">\'Hello,\'</span> <span class="token operator">+</span> content<span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n\n      module<span class="token punctuation">.</span>exports <span class="token operator">=</span> show<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">]</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>bundle.js 内容如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="80016060364650230000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(function(modules) {\n  /***\n   * webpackJsonp 用于从异步加载的文件中安装模块。\n   * 把 webpackJsonp 挂载到全局是为了方便在其它文件中调用。\n   *\n   * @param chunkIds 异步加载的文件中存放的需要安装的模块对应的 Chunk ID\n   * @param moreModules 异步加载的文件中存放的需要安装的模块列表\n   * @param executeModules 在异步加载的文件中存放的需要安装的模块都安装成功后，需要执行的模块对应的 index\n   */\n  window[\'webpackJsonp\'] = function webpackJsonpCallback(chunkIds, moreModules, executeModules) {\n    // 把 moreModules 添加到 modules 对象中\n    // 把所有 chunkIds 对应的模块都标记成已经加载成功\n    var moduleId,\n      chunkId,\n      i = 0,\n      resolves = [],\n      result;\n    for (; i < chunkIds.length; i++) {\n      chunkId = chunkIds[i];\n      if (installedChunks[chunkId]) {\n        resolves.push(installedChunks[chunkId][0]);\n      }\n      installedChunks[chunkId] = 0;\n    }\n    for (moduleId in moreModules) {\n      if (Object.prototype.hasOwnProperty.call(moreModules, moduleId)) {\n        modules[moduleId] = moreModules[moduleId];\n      }\n    }\n    while (resolves.length) {\n      resolves.shift()();\n    }\n  };\n\n  // 缓存已经安装的模块\n  var installedModules = {};\n\n  // 存储每个 Chunk 的加载状态；\n  // 键为 Chunk 的 ID，值为0代表已经加载成功\n  var installedChunks = {\n    1: 0\n  };\n\n  // 模拟 require 语句，和上面介绍的一致\n  function __webpack_require__(moduleId) {\n    // ... 省略和上面一样的内容\n  }\n\n  /**\n   * 用于加载被分割出去的，需要异步加载的 Chunk 对应的文件\n   * @param chunkId 需要异步加载的 Chunk 对应的 ID\n   * @returns {Promise}\n   */\n  __webpack_require__.e = function requireEnsure(chunkId) {\n    // 从上面定义的 installedChunks 中获取 chunkId 对应的 Chunk 的加载状态\n    var installedChunkData = installedChunks[chunkId];\n    // 如果加载状态为0表示该 Chunk 已经加载成功了，直接返回 resolve Promise\n    if (installedChunkData === 0) {\n      return new Promise(function(resolve) {\n        resolve();\n      });\n    }\n\n    // installedChunkData 不为空且不为0表示该 Chunk 正在网络加载中\n    if (installedChunkData) {\n      // 返回存放在 installedChunkData 数组中的 Promise 对象\n      return installedChunkData[2];\n    }\n\n    // installedChunkData 为空，表示该 Chunk 还没有加载过，去加载该 Chunk 对应的文件\n    var promise = new Promise(function(resolve, reject) {\n      installedChunkData = installedChunks[chunkId] = [resolve, reject];\n    });\n    installedChunkData[2] = promise;\n\n    // 通过 DOM 操作，往 HTML head 中插入一个 script 标签去异步加载 Chunk 对应的 JavaScript 文件\n    var head = document.getElementsByTagName(\'head\')[0];\n    var script = document.createElement(\'script\');\n    script.type = \'text/javascript\';\n    script.charset = \'utf-8\';\n    script.async = true;\n    script.timeout = 120000;\n\n    // 文件的路径为配置的 publicPath、chunkId 拼接而成\n    script.src = __webpack_require__.p + \'\' + chunkId + \'.bundle.js\';\n\n    // 设置异步加载的最长超时时间\n    var timeout = setTimeout(onScriptComplete, 120000);\n    script.onerror = script.onload = onScriptComplete;\n\n    // 在 script 加载和执行完成时回调\n    function onScriptComplete() {\n      // 防止内存泄露\n      script.onerror = script.onload = null;\n      clearTimeout(timeout);\n\n      // 去检查 chunkId 对应的 Chunk 是否安装成功，安装成功时才会存在于 installedChunks 中\n      var chunk = installedChunks[chunkId];\n      if (chunk !== 0) {\n        if (chunk) {\n          chunk[1](new Error(\'Loading chunk \' + chunkId + \' failed.\'));\n        }\n        installedChunks[chunkId] = undefined;\n      }\n    }\n    head.appendChild(script);\n\n    return promise;\n  };\n\n  // 加载并执行入口模块，和上面介绍的一致\n  return __webpack_require__((__webpack_require__.s = 0));\n})(\n  // 存放所有没有经过异步加载的，随着执行入口文件加载的模块\n  [\n    // main.js 对应的模块\n    function(module, exports, __webpack_require__) {\n      // 通过 __webpack_require__.e 去异步加载 show.js 对应的 Chunk\n      __webpack_require__\n        .e(0)\n        .then(__webpack_require__.bind(null, 1))\n        .then((show) => {\n          // 执行 show 函数\n          show(\'Webpack\');\n        });\n    }\n  ]\n);`, `80016060364650230000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">modules</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">/***\n   * webpackJsonp 用于从异步加载的文件中安装模块。\n   * 把 webpackJsonp 挂载到全局是为了方便在其它文件中调用。\n   *\n   * @param chunkIds 异步加载的文件中存放的需要安装的模块对应的 Chunk ID\n   * @param moreModules 异步加载的文件中存放的需要安装的模块列表\n   * @param executeModules 在异步加载的文件中存放的需要安装的模块都安装成功后，需要执行的模块对应的 index\n   */</span>\n  window<span class="token punctuation">[</span><span class="token string">\'webpackJsonp\'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">webpackJsonpCallback</span><span class="token punctuation">(</span><span class="token parameter">chunkIds<span class="token punctuation">,</span> moreModules<span class="token punctuation">,</span> executeModules</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 把 moreModules 添加到 modules 对象中</span>\n    <span class="token comment">// 把所有 chunkIds 对应的模块都标记成已经加载成功</span>\n    <span class="token keyword">var</span> moduleId<span class="token punctuation">,</span>\n      chunkId<span class="token punctuation">,</span>\n      i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>\n      resolves <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n      result<span class="token punctuation">;</span>\n    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> chunkIds<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      chunkId <span class="token operator">=</span> chunkIds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        resolves<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">for</span> <span class="token punctuation">(</span>moduleId <span class="token keyword">in</span> moreModules<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>moreModules<span class="token punctuation">,</span> moduleId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        modules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span> <span class="token operator">=</span> moreModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">while</span> <span class="token punctuation">(</span>resolves<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      resolves<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 缓存已经安装的模块</span>\n  <span class="token keyword">var</span> installedModules <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 存储每个 Chunk 的加载状态；</span>\n  <span class="token comment">// 键为 Chunk 的 ID，值为0代表已经加载成功</span>\n  <span class="token keyword">var</span> installedChunks <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token number">1</span><span class="token punctuation">:</span> <span class="token number">0</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 模拟 require 语句，和上面介绍的一致</span>\n  <span class="token keyword">function</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token parameter">moduleId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// ... 省略和上面一样的内容</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token comment">/**\n   * 用于加载被分割出去的，需要异步加载的 Chunk 对应的文件\n   * @param chunkId 需要异步加载的 Chunk 对应的 ID\n   * @returns {Promise}\n   */</span>\n  __webpack_require__<span class="token punctuation">.</span><span class="token function-variable function">e</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">requireEnsure</span><span class="token punctuation">(</span><span class="token parameter">chunkId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 从上面定义的 installedChunks 中获取 chunkId 对应的 Chunk 的加载状态</span>\n    <span class="token keyword">var</span> installedChunkData <span class="token operator">=</span> installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span><span class="token punctuation">;</span>\n    <span class="token comment">// 如果加载状态为0表示该 Chunk 已经加载成功了，直接返回 resolve Promise</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>installedChunkData <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token comment">// installedChunkData 不为空且不为0表示该 Chunk 正在网络加载中</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>installedChunkData<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 返回存放在 installedChunkData 数组中的 Promise 对象</span>\n      <span class="token keyword">return</span> installedChunkData<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token comment">// installedChunkData 为空，表示该 Chunk 还没有加载过，去加载该 Chunk 对应的文件</span>\n    <span class="token keyword">var</span> promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      installedChunkData <span class="token operator">=</span> installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">]</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    installedChunkData<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> promise<span class="token punctuation">;</span>\n\n    <span class="token comment">// 通过 DOM 操作，往 HTML head 中插入一个 script 标签去异步加载 Chunk 对应的 JavaScript 文件</span>\n    <span class="token keyword">var</span> head <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">\'head\'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n    <span class="token keyword">var</span> script <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">\'script\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    script<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">\'text/javascript\'</span><span class="token punctuation">;</span>\n    script<span class="token punctuation">.</span>charset <span class="token operator">=</span> <span class="token string">\'utf-8\'</span><span class="token punctuation">;</span>\n    script<span class="token punctuation">.</span>async <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n    script<span class="token punctuation">.</span>timeout <span class="token operator">=</span> <span class="token number">120000</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// 文件的路径为配置的 publicPath、chunkId 拼接而成</span>\n    script<span class="token punctuation">.</span>src <span class="token operator">=</span> __webpack_require__<span class="token punctuation">.</span>p <span class="token operator">+</span> <span class="token string">\'\'</span> <span class="token operator">+</span> chunkId <span class="token operator">+</span> <span class="token string">\'.bundle.js\'</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// 设置异步加载的最长超时时间</span>\n    <span class="token keyword">var</span> timeout <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>onScriptComplete<span class="token punctuation">,</span> <span class="token number">120000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    script<span class="token punctuation">.</span>onerror <span class="token operator">=</span> script<span class="token punctuation">.</span>onload <span class="token operator">=</span> onScriptComplete<span class="token punctuation">;</span>\n\n    <span class="token comment">// 在 script 加载和执行完成时回调</span>\n    <span class="token keyword">function</span> <span class="token function">onScriptComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 防止内存泄露</span>\n      script<span class="token punctuation">.</span>onerror <span class="token operator">=</span> script<span class="token punctuation">.</span>onload <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n      <span class="token function">clearTimeout</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token comment">// 去检查 chunkId 对应的 Chunk 是否安装成功，安装成功时才会存在于 installedChunks 中</span>\n      <span class="token keyword">var</span> chunk <span class="token operator">=</span> installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>chunk <span class="token operator">!==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>chunk<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          chunk<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">\'Loading chunk \'</span> <span class="token operator">+</span> chunkId <span class="token operator">+</span> <span class="token string">\' failed.\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n        installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n    head<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>script<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">return</span> promise<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 加载并执行入口模块，和上面介绍的一致</span>\n  <span class="token keyword">return</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token punctuation">(</span>__webpack_require__<span class="token punctuation">.</span>s <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>\n  <span class="token comment">// 存放所有没有经过异步加载的，随着执行入口文件加载的模块</span>\n  <span class="token punctuation">[</span>\n    <span class="token comment">// main.js 对应的模块</span>\n    <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 通过 __webpack_require__.e 去异步加载 show.js 对应的 Chunk</span>\n      __webpack_require__\n        <span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>\n        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token function">__webpack_require__</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">show</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n          <span class="token comment">// 执行 show 函数</span>\n          <span class="token function">show</span><span class="token punctuation">(</span><span class="token string">\'Webpack\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">]</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这里的 bundle.js 和上面所讲的 bundle.js 非常相似，区别在于：</p>\n<ul>\n<li>多了一个 <code class="language-text">__webpack_require__.e</code> 用于加载被分割出去的，需要异步加载的 Chunk 对应的文件;</li>\n<li>多了一个 webpackJsonp 函数用于从异步加载的文件中安装模块。</li>\n</ul>\n<p>在使用了 CommonsChunkPlugin 去提取公共代码时输出的文件和使用了异步加载时输出的文件是一样的，都会有 <code class="language-text">__webpack_require__.e</code> 和 webpackJsonp。 原因在于提取公共代码和异步加载本质上都是代码分割。</p>\n<h1 id="编写-loader"><a href="#%E7%BC%96%E5%86%99-loader" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>编写 Loader</h1>\n<p>Loader 就像是一个翻译员，能把源文件经过转化后输出新的结果，并且一个文件还可以链式的经过多个翻译员翻译。</p>\n<p>以处理 SCSS 文件为例：</p>\n<ol>\n<li>SCSS 源代码会先交给 sass-loader 把 SCSS 转换成 CSS；</li>\n<li>把 sass-loader 输出的 CSS 交给 css-loader 处理，找出 CSS 中依赖的资源、压缩 CSS 等；</li>\n<li>把 css-loader 输出的 CSS 交给 style-loader 处理，转换成通过脚本加载的 JavaScript 代码；</li>\n</ol>\n<p>可以看出以上的处理过程需要有顺序的链式执行，先 sass-loader 再 css-loader 再 style-loader。 以上处理的 Webpack 相关配置如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="35789635303362564000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`module.exports = {\n  module: {\n    rules: [\n      {\n        // 增加对 SCSS 文件的支持\n        test: /\\.scss\\$/,\n        // SCSS 文件的处理顺序为先 sass-loader 再 css-loader 再 style-loader\n        use: [\n          \'style-loader\',\n          {\n            loader: \'css-loader\',\n            // 给 css-loader 传入配置项\n            options: {\n              minimize: true\n            }\n          },\n          \'sass-loader\'\n        ]\n      }\n    ]\n  }\n};`, `35789635303362564000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>\n  module<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    rules<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n      <span class="token punctuation">{</span>\n        <span class="token comment">// 增加对 SCSS 文件的支持</span>\n        test<span class="token punctuation">:</span> <span class="token regex">/\\.scss$/</span><span class="token punctuation">,</span>\n        <span class="token comment">// SCSS 文件的处理顺序为先 sass-loader 再 css-loader 再 style-loader</span>\n        use<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n          <span class="token string">\'style-loader\'</span><span class="token punctuation">,</span>\n          <span class="token punctuation">{</span>\n            loader<span class="token punctuation">:</span> <span class="token string">\'css-loader\'</span><span class="token punctuation">,</span>\n            <span class="token comment">// 给 css-loader 传入配置项</span>\n            options<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n              minimize<span class="token punctuation">:</span> <span class="token boolean">true</span>\n            <span class="token punctuation">}</span>\n          <span class="token punctuation">}</span><span class="token punctuation">,</span>\n          <span class="token string">\'sass-loader\'</span>\n        <span class="token punctuation">]</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">]</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="loader-的职责"><a href="#loader-%E7%9A%84%E8%81%8C%E8%B4%A3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Loader 的职责</h2>\n<p>由上面的例子可以看出：一个 Loader 的职责是单一的，只需要完成一种转换。 如果一个源文件需要经历多步转换才能正常使用，就通过多个 Loader 去转换。 在调用多个 Loader 去转换一个文件时，每个 Loader 会链式的顺序执行，第一个 Loader 将会拿到需处理的原内容，上一个 Loader 处理后的结果会传给下一个接着处理，最后的 Loader 将处理后的最终结果返回给 Webpack。</p>\n<p>所以在你开发一个 Loader 时，请保持其职责的单一性，你只需关心输入和输出。</p>\n<h2 id="loader-基础"><a href="#loader-%E5%9F%BA%E7%A1%80" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Loader 基础</h2>\n<p>由于 Webpack 是运行在 Node.js 之上的，一个 Loader 其实就是一个 Node.js 模块，这个模块需要导出一个函数。 这个导出的函数的工作就是获得处理前的原内容，对原内容执行处理后，返回处理后的内容。</p>\n<p>一个最简单的 Loader 的源码如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="20228214391149390000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`module.exports = function(source) {\n  // source 为 compiler 传递给 Loader 的一个文件的原内容\n  // 该函数需要返回处理后的内容，这里简单起见，直接把原内容返回了，相当于该 Loader 没有做任何转换\n  return source;\n};`, `20228214391149390000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// source 为 compiler 传递给 Loader 的一个文件的原内容</span>\n  <span class="token comment">// 该函数需要返回处理后的内容，这里简单起见，直接把原内容返回了，相当于该 Loader 没有做任何转换</span>\n  <span class="token keyword">return</span> source<span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>由于 Loader 运行在 Node.js 中，你可以调用任何 Node.js 自带的 API，或者安装第三方模块进行调用：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="13464739152322447000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const sass = require(\'node-sass\');\nmodule.exports = function(source) {\n  return sass(source);\n};`, `13464739152322447000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> sass <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'node-sass\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nmodule<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token function">sass</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="loader-进阶"><a href="#loader-%E8%BF%9B%E9%98%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Loader 进阶</h2>\n<p>以上只是个最简单的 Loader，Webpack 还提供一些 API 供 Loader 调用，下面来一一介绍。</p>\n<h3 id="获得-loader-的-options"><a href="#%E8%8E%B7%E5%BE%97-loader-%E7%9A%84-options" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>获得 Loader 的 options</h3>\n<p>在最上面处理 SCSS 文件的 Webpack 配置中，给 css-loader 传了 options 参数，以控制 css-loader。 如何在自己编写的 Loader 中获取到用户传入的 options 呢？需要这样做：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="69301268699754480000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const loaderUtils = require(\'loader-utils\');\nmodule.exports = function(source) {\n  // 获取到用户给当前 Loader 传入的 options\n  const options = loaderUtils.getOptions(this);\n  return source;\n};`, `69301268699754480000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> loaderUtils <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'loader-utils\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nmodule<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 获取到用户给当前 Loader 传入的 options</span>\n  <span class="token keyword">const</span> options <span class="token operator">=</span> loaderUtils<span class="token punctuation">.</span><span class="token function">getOptions</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> source<span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="返回其它结果"><a href="#%E8%BF%94%E5%9B%9E%E5%85%B6%E5%AE%83%E7%BB%93%E6%9E%9C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>返回其它结果</h3>\n<p>上面的 Loader 都只是返回了原内容转换后的内容，但有些场景下还需要返回除了内容之外的东西。</p>\n<p>例如以用 babel-loader 转换 ES6 代码为例，它还需要输出转换后的 ES5 代码对应的 Source Map，以方便调试源码。 为了把 Source Map 也一起随着 ES5 代码返回给 Webpack，可以这样写：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="56598101873155700000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`module.exports = function(source) {\n  // 通过 this.callback 告诉 Webpack 返回的结果\n  this.callback(null, source, sourceMaps);\n  // 当你使用 this.callback 返回内容时，该 Loader 必须返回 undefined，\n  // 以让 Webpack 知道该 Loader 返回的结果在 this.callback 中，而不是 return 中\n  return;\n};`, `56598101873155700000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 通过 this.callback 告诉 Webpack 返回的结果</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> source<span class="token punctuation">,</span> sourceMaps<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// 当你使用 this.callback 返回内容时，该 Loader 必须返回 undefined，</span>\n  <span class="token comment">// 以让 Webpack 知道该 Loader 返回的结果在 this.callback 中，而不是 return 中</span>\n  <span class="token keyword">return</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>其中的 this.callback 是 Webpack 给 Loader 注入的 API，以方便 Loader 和 Webpack 之间通信。 this.callback 的详细使用方法如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="27933517608042148000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`this.callback(\n    // 当无法转换原内容时，给 Webpack 返回一个 Error\n    err: Error | null,\n    // 原内容转换后的内容\n    content: string | Buffer,\n    // 用于把转换后的内容得出原内容的 Source Map，方便调试\n    sourceMap?: SourceMap,\n    // 如果本次转换为原内容生成了 AST 语法树，可以把这个 AST 返回，\n    // 以方便之后需要 AST 的 Loader 复用该 AST，以避免重复生成 AST，提升性能\n    abstractSyntaxTree?: AST\n);`, `27933517608042148000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">callback</span><span class="token punctuation">(</span>\n    <span class="token comment">// 当无法转换原内容时，给 Webpack 返回一个 Error</span>\n    err<span class="token punctuation">:</span> Error <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>\n    <span class="token comment">// 原内容转换后的内容</span>\n    content<span class="token punctuation">:</span> string <span class="token operator">|</span> Buffer<span class="token punctuation">,</span>\n    <span class="token comment">// 用于把转换后的内容得出原内容的 Source Map，方便调试</span>\n    sourceMap<span class="token operator">?</span><span class="token punctuation">:</span> SourceMap<span class="token punctuation">,</span>\n    <span class="token comment">// 如果本次转换为原内容生成了 AST 语法树，可以把这个 AST 返回，</span>\n    <span class="token comment">// 以方便之后需要 AST 的 Loader 复用该 AST，以避免重复生成 AST，提升性能</span>\n    abstractSyntaxTree<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token constant">AST</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Source Map 的生成很耗时，通常在开发环境下才会生成 Source Map，其它环境下不用生成，以加速构建。 为此 Webpack 为 Loader 提供了 this.sourceMap API 去告诉 Loader 当前构建环境下用户是否需要 Source Map。 如果你编写的 Loader 会生成 Source Map，请考虑到这点。</p>\n<h3 id="同步与异步"><a href="#%E5%90%8C%E6%AD%A5%E4%B8%8E%E5%BC%82%E6%AD%A5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>同步与异步</h3>\n<p>Loader 有同步和异步之分，上面介绍的 Loader 都是同步的 Loader，因为它们的转换流程都是同步的，转换完成后再返回结果。 但在有些场景下转换的步骤只能是异步完成的，例如你需要通过网络请求才能得出结果，如果采用同步的方式网络请求就会阻塞整个构建，导致构建非常缓慢。</p>\n<p>在转换步骤是异步时，你可以这样：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="14597242523229092000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`module.exports = function(source) {\n  // 告诉 Webpack 本次转换是异步的，Loader 会在 callback 中回调结果\n  var callback = this.async();\n  someAsyncOperation(source, function(err, result, sourceMaps, ast) {\n    // 通过 callback 返回异步执行后的结果\n    callback(err, result, sourceMaps, ast);\n  });\n};`, `14597242523229092000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 告诉 Webpack 本次转换是异步的，Loader 会在 callback 中回调结果</span>\n  <span class="token keyword">var</span> callback <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">async</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token function">someAsyncOperation</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> result<span class="token punctuation">,</span> sourceMaps<span class="token punctuation">,</span> ast</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 通过 callback 返回异步执行后的结果</span>\n    <span class="token function">callback</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> result<span class="token punctuation">,</span> sourceMaps<span class="token punctuation">,</span> ast<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="处理二进制数据"><a href="#%E5%A4%84%E7%90%86%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%95%B0%E6%8D%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>处理二进制数据</h3>\n<p>在默认的情况下，Webpack 传给 Loader 的原内容都是 UTF-8 格式编码的字符串。但有些场景下 Loader 不是处理文本文件，而是处理二进制文件，例如 file-loader，就需要 Webpack 给 Loader 传入二进制格式的数据。 为此，你需要这样编写 Loader：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="96078433430256160000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`module.exports = function(source) {\n  // 在 exports.raw === true 时，Webpack 传给 Loader 的 source 是 Buffer 类型的\n  source instanceof Buffer === true;\n  // Loader 返回的类型也可以是 Buffer 类型的\n  // 在 exports.raw !== true 时，Loader 也可以返回 Buffer 类型的结果\n  return source;\n};\n// 通过 exports.raw 属性告诉 Webpack 该 Loader 是否需要二进制数据\nmodule.exports.raw = true;`, `96078433430256160000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 在 exports.raw === true 时，Webpack 传给 Loader 的 source 是 Buffer 类型的</span>\n  source <span class="token keyword">instanceof</span> <span class="token class-name">Buffer</span> <span class="token operator">===</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n  <span class="token comment">// Loader 返回的类型也可以是 Buffer 类型的</span>\n  <span class="token comment">// 在 exports.raw !== true 时，Loader 也可以返回 Buffer 类型的结果</span>\n  <span class="token keyword">return</span> source<span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token comment">// 通过 exports.raw 属性告诉 Webpack 该 Loader 是否需要二进制数据</span>\nmodule<span class="token punctuation">.</span>exports<span class="token punctuation">.</span>raw <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>以上代码中最关键的代码是最后一行 module.exports.raw = true;，没有该行 Loader 只能拿到字符串。</p>\n<h3 id="缓存加速"><a href="#%E7%BC%93%E5%AD%98%E5%8A%A0%E9%80%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>缓存加速</h3>\n<p>在有些情况下，有些转换操作需要大量计算非常耗时，如果每次构建都重新执行重复的转换操作，构建将会变得非常缓慢。 为此，Webpack 会默认缓存所有 Loader 的处理结果，也就是说在需要被处理的文件或者其依赖的文件没有发生变化时， 是不会重新调用对应的 Loader 去执行转换操作的。</p>\n<p>如果你想让 Webpack 不缓存该 Loader 的处理结果，可以这样：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="5741677060163353000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`module.exports = function(source) {\n  // 关闭该 Loader 的缓存功能\n  this.cacheable(false);\n  return source;\n};`, `5741677060163353000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 关闭该 Loader 的缓存功能</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cacheable</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> source<span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="其它-loader-api"><a href="#%E5%85%B6%E5%AE%83-loader-api" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>其它 Loader API</h2>\n<p>除了以上提到的在 Loader 中能调用的 Webpack API 外，还存在以下常用 API：</p>\n<ul>\n<li>this.context：当前处理文件的所在目录，假如当前 Loader 处理的文件是 /src/main.js，则 this.context 就等于 /src。</li>\n<li>this.resource：当前处理文件的完整请求路径，包括 querystring，例如 /src/main.js?name=1。</li>\n<li>this.resourcePath：当前处理文件的路径，例如 /src/main.js。</li>\n<li>this.resourceQuery：当前处理文件的 querystring。</li>\n<li>this.target：等于 Webpack 配置中的 Target，详情见 2-7 其它配置项-Target。</li>\n<li>this.loadModule：当 Loader 在处理一个文件时，如果依赖其它文件的处理结果才能得出当前文件的结果时， 就可以通过 this.loadModule(request: string, callback: function(err, source, sourceMap, module)) 去获得 request 对应文件的处理结果。</li>\n<li>this.resolve：像 require 语句一样获得指定文件的完整路径，使用方法为 resolve(context: string, request: string, callback: function(err, result: string))。</li>\n<li>this.addDependency：给当前处理文件添加其依赖的文件，以便再其依赖的文件发生变化时，会重新调用 Loader 处理该文件。使用方法为 addDependency(file: string)。</li>\n<li>this.addContextDependency：和 addDependency 类似，但 addContextDependency 是把整个目录加入到当前正在处理文件的依赖中。使用方法为 addContextDependency(directory: string)。</li>\n<li>this.clearDependencies：清除当前正在处理文件的所有依赖，使用方法为 clearDependencies()。</li>\n<li>this.emitFile：输出一个文件，使用方法为 emitFile(name: string, content: Buffer|string, sourceMap: {…})</li>\n</ul>\n<h2 id="加载本地-loader"><a href="#%E5%8A%A0%E8%BD%BD%E6%9C%AC%E5%9C%B0-loader" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>加载本地 Loader</h2>\n<p>在开发 Loader 的过程中，为了测试编写的 Loader 是否能正常工作，需要把它配置到 Webpack 中后，才可能会调用该 Loader。 在前面的章节中，使用的 Loader 都是通过 Npm 安装的，要使用 Loader 时会直接使用 Loader 的名称，代码如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="68961025476204310000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`module.exports = {\n  module: {\n    rules: [\n      {\n        test: /\\.css\\$/,\n        use: [\'style-loader\']\n      }\n    ]\n  }\n};`, `68961025476204310000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>\n  module<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    rules<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n      <span class="token punctuation">{</span>\n        test<span class="token punctuation">:</span> <span class="token regex">/\\.css$/</span><span class="token punctuation">,</span>\n        use<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'style-loader\'</span><span class="token punctuation">]</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">]</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果还采取以上的方法去使用本地开发的 Loader 将会很麻烦，因为你需要确保编写的 Loader 的源码是在 node_modules 目录下，为此你需要先把编写的 Loader 发布到 Npm 仓库后再安装到本地项目使用。</p>\n<p>解决以上问题的便捷方法有两种，分别如下：</p>\n<h3 id="npm-link"><a href="#npm-link" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Npm link</h3>\n<p>Npm link 专门用于开发和调试本地 Npm 模块，能做到在不发布模块的情况下，把本地的一个正在开发的模块的源码链接到项目的 node_modules 目录下，让项目可以直接使用本地的 Npm 模块。由于是通过软链接的方式实现的，编辑了本地的 Npm 模块代码，在项目中也能使用到编辑后的代码。</p>\n<p>完成 Npm link 的步骤如下：</p>\n<ol>\n<li>确保正在开发的本地 Npm 模块（也就是正在开发的 Loader）的 package.json 已经正确配置好；</li>\n<li>在本地 Npm 模块根目录下执行 npm link，把本地模块注册到全局；</li>\n<li>在项目根目录下执行 npm link loader-name，把第 2 步注册到全局的本地 Npm 模块链接到项目的 node_moduels 下，其中的 loader-name 是指在第 1 步中的 package.json 文件中配置的模块名称。链接好 Loader 到项目后你就可以像使用一个真正的 Npm 模块一样使用本地的 Loader 了。</li>\n</ol>\n<h3 id="resolveloader"><a href="#resolveloader" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ResolveLoader</h3>\n<p>假如本地的 Loader 在项目目录中的 ./loaders/loader-name 中，则需要如下配置：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="63506269497541410000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`module.exports = {\n  resolveLoader: {\n    // 去哪些目录下寻找 Loader，有先后顺序之分\n    modules: [\'node_modules\', \'./loaders/\']\n  }\n};`, `63506269497541410000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>\n  resolveLoader<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 去哪些目录下寻找 Loader，有先后顺序之分</span>\n    modules<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'node_modules\'</span><span class="token punctuation">,</span> <span class="token string">\'./loaders/\'</span><span class="token punctuation">]</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>加上以上配置后， Webpack 会先去 node_modules 项目下寻找 Loader，如果找不到，会再去 ./loaders/ 目录下寻找。</p>\n<h2 id="实战"><a href="#%E5%AE%9E%E6%88%98" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>实战</h2>\n<p>上面讲了许多理论，接下来从实际出发，来编写一个解决实际问题的 Loader。</p>\n<p>该 Loader 名叫 comment-require-loader，作用是把 JavaScript 代码中的注释语法</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="92034172783610400000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// @require \'../style/index.css\'`, `92034172783610400000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// @require \'../style/index.css\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>转换成</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="15322755447014625000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`require(\'../style/index.css\');`, `15322755447014625000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'../style/index.css\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>该 Loader 的使用场景是去正确加载针对 Fis3 编写的 JavaScript，这些 JavaScript 中存在通过注释的方式加载依赖的 CSS 文件。</p>\n<p>该 Loader 的使用方法如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="84457726942828130000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`module.exports = {\n  module: {\n    rules: [\n      {\n        test: /\\.js\\$/,\n        use: [\'comment-require-loader\'],\n        // 针对采用了 fis3 CSS 导入语法的 JavaScript 文件通过 comment-require-loader 去转换\n        include: [path.resolve(__dirname, \'node_modules/imui\')]\n      }\n    ]\n  }\n};`, `84457726942828130000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>\n  module<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    rules<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n      <span class="token punctuation">{</span>\n        test<span class="token punctuation">:</span> <span class="token regex">/\\.js$/</span><span class="token punctuation">,</span>\n        use<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'comment-require-loader\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n        <span class="token comment">// 针对采用了 fis3 CSS 导入语法的 JavaScript 文件通过 comment-require-loader 去转换</span>\n        include<span class="token punctuation">:</span> <span class="token punctuation">[</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">\'node_modules/imui\'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">]</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>该 Loader 的实现非常简单，完整代码如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="37415839263966700000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function replace(source) {\n  // 使用正则把 // @require \'../style/index.css\' 转换成 require(\'../style/index.css\');\n  return source.replace(/(\\/\\/ *@require) +((\'|&quot;).+(\'|&quot;)).*/, \'require(\\$2);\');\n}\n\nmodule.exports = function(content) {\n  return replace(content);\n};`, `37415839263966700000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">replace</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 使用正则把 // @require \'../style/index.css\' 转换成 require(\'../style/index.css\');</span>\n  <span class="token keyword">return</span> source<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/(\\/\\/ *@require) +((\'|").+(\'|")).*/</span><span class="token punctuation">,</span> <span class="token string">\'require($2);\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\nmodule<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">content</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token function">replace</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="编写-plugin"><a href="#%E7%BC%96%E5%86%99-plugin" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>编写 Plugin</h1>\n<p>Webpack 通过 Plugin 机制让其更加灵活，以适应各种应用场景。在 Webpack 运行的生命周期中会广播出许多事件，Plugin 可以监听这些事件，在合适的时机通过 Webpack 提供的 API 改变输出结果。</p>\n<p>一个最基础的 Plugin 的代码是这样的：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="7215207657896317000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class BasicPlugin {\n  // 在构造函数中获取用户给该插件传入的配置\n  constructor(options) {}\n\n  // Webpack 会调用 BasicPlugin 实例的 apply 方法给插件实例传入 compiler 对象\n  apply(compiler) {\n    compiler.plugin(\'compilation\', function(compilation) {});\n  }\n}\n\n// 导出 Plugin\nmodule.exports = BasicPlugin;`, `7215207657896317000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">BasicPlugin</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 在构造函数中获取用户给该插件传入的配置</span>\n  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n\n  <span class="token comment">// Webpack 会调用 BasicPlugin 实例的 apply 方法给插件实例传入 compiler 对象</span>\n  <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    compiler<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span><span class="token string">\'compilation\'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">compilation</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// 导出 Plugin</span>\nmodule<span class="token punctuation">.</span>exports <span class="token operator">=</span> BasicPlugin<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在使用这个 Plugin 时，相关配置代码如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="78279077010666980000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const BasicPlugin = require(\'./BasicPlugin.js\');\nmodule.export = {\n  plugins: [new BasicPlugin(options)]\n};`, `78279077010666980000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> BasicPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./BasicPlugin.js\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nmodule<span class="token punctuation">.</span>export <span class="token operator">=</span> <span class="token punctuation">{</span>\n  plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token keyword">new</span> <span class="token class-name">BasicPlugin</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">]</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Webpack 启动后，在读取配置的过程中会先执行 new BasicPlugin(options) 初始化一个 BasicPlugin 获得其实例。 在初始化 compiler 对象后，再调用 basicPlugin.apply(compiler) 给插件实例传入 compiler 对象。 插件实例在获取到 compiler 对象后，就可以通过 compiler.plugin(事件名称, 回调函数) 监听到 Webpack 广播出来的事件。 并且可以通过 compiler 对象去操作 Webpack。</p>\n<p>通过以上最简单的 Plugin 相信你大概明白了 Plugin 的工作原理，但实际开发中还有很多细节需要注意，下面来详细介绍。</p>\n<h2 id="compiler-和-compilation"><a href="#compiler-%E5%92%8C-compilation" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Compiler 和 Compilation</h2>\n<p>在开发 Plugin 时最常用的两个对象就是 Compiler 和 Compilation，它们是 Plugin 和 Webpack 之间的桥梁。 Compiler 和 Compilation 的含义如下：</p>\n<ul>\n<li>Compiler 对象包含了 Webpack 环境所有的的配置信息，包含 options，loaders，plugins 这些信息，这个对象在 Webpack 启动时候被实例化，它是全局唯一的，可以简单地把它理解为 Webpack 实例；</li>\n<li>Compilation 对象包含了当前的模块资源、编译生成资源、变化的文件等。当 Webpack 以开发模式运行时，每当检测到一个文件变化，一次新的 Compilation 将被创建。Compilation 对象也提供了很多事件回调供插件做扩展。通过 Compilation 也能读取到 Compiler 对象。</li>\n</ul>\n<p>Compiler 和 Compilation 的区别在于：Compiler 代表了整个 Webpack 从启动到关闭的生命周期，而 Compilation 只是代表了一次新的编译。</p>\n<h2 id="事件流"><a href="#%E4%BA%8B%E4%BB%B6%E6%B5%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>事件流</h2>\n<p>Webpack 就像一条生产线，要经过一系列处理流程后才能将源文件转换成输出结果。 这条生产线上的每个处理流程的职责都是单一的，多个流程之间有存在依赖关系，只有完成当前处理后才能交给下一个流程去处理。 插件就像是一个插入到生产线中的一个功能，在特定的时机对生产线上的资源做处理。</p>\n<p>Webpack 通过 Tapable 来组织这条复杂的生产线。 Webpack 在运行过程中会广播事件，插件只需要监听它所关心的事件，就能加入到这条生产线中，去改变生产线的运作。 Webpack 的事件流机制保证了插件的有序性，使得整个系统扩展性很好。</p>\n<p>Webpack 的事件流机制应用了观察者模式，和 Node.js 中的 EventEmitter 非常相似。 Compiler 和 Compilation 都继承自 Tapable，可以直接在 Compiler 和 Compilation 对象上广播和监听事件，方法如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="40652178998499130000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`/**\n * 广播出事件\n * event-name 为事件名称，注意不要和现有的事件重名\n * params 为附带的参数\n */\ncompiler.apply(\'event-name\', params);\n\n/**\n * 监听名称为 event-name 的事件，当 event-name 事件发生时，函数就会被执行。\n * 同时函数中的 params 参数为广播事件时附带的参数。\n */\ncompiler.plugin(\'event-name\', function(params) {});`, `40652178998499130000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">/**\n * 广播出事件\n * event-name 为事件名称，注意不要和现有的事件重名\n * params 为附带的参数\n */</span>\n<span class="token function">compiler</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token string">\'event-name\'</span><span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">/**\n * 监听名称为 event-name 的事件，当 event-name 事件发生时，函数就会被执行。\n * 同时函数中的 params 参数为广播事件时附带的参数。\n */</span>\ncompiler<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span><span class="token string">\'event-name\'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">params</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>同理，compilation.apply 和 compilation.plugin 使用方法和上面一致。</p>\n<p>在开发插件时，你可能会不知道该如何下手，因为你不知道该监听哪个事件才能完成任务。</p>\n<p>在开发插件时，还需要注意以下两点：</p>\n<ul>\n<li>\n<p>只要能拿到 Compiler 或 Compilation 对象，就能广播出新的事件，所以在新开发的插件中也能广播出事件，给其它插件监听使用。</p>\n</li>\n<li>\n<p>传给每个插件的 Compiler 和 Compilation 对象都是同一个引用。也就是说在一个插件中修改了 Compiler 或 Compilation 对象上的属性，会影响到后面的插件。</p>\n</li>\n<li>\n<p>有些事件是异步的，这些异步的事件会附带两个参数，第二个参数为回调函数，在插件处理完任务时需要调用回调函数通知 Webpack，才会进入下一处理流程。例如：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="75906099464775550000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`compiler.plugin(\'emit\', function(compilation, callback) {\n// 支持处理逻辑\n\n// 处理完毕后执行 callback 以通知 Webpack\n// 如果不执行 callback，运行流程将会一直卡在这不往下执行\ncallback();\n});`, `75906099464775550000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">compiler<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span><span class="token string">\'emit\'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">compilation<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n<span class="token comment">// 支持处理逻辑</span>\n\n<span class="token comment">// 处理完毕后执行 callback 以通知 Webpack</span>\n<span class="token comment">// 如果不执行 callback，运行流程将会一直卡在这不往下执行</span>\n<span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n</ul>\n<h2 id="常用-api"><a href="#%E5%B8%B8%E7%94%A8-api" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>常用 API</h2>\n<p>插件可以用来修改输出文件、增加输出文件、甚至可以提升 Webpack 性能等等，总之插件通过调用 Webpack 提供的 API 能完成很多事情。 由于 Webpack 提供的 API 非常多，有很多 API 很少用的上，又加上篇幅有限，下面来介绍一些常用的 API。</p>\n<h3 id="读取输出资源、代码块、模块及其依赖"><a href="#%E8%AF%BB%E5%8F%96%E8%BE%93%E5%87%BA%E8%B5%84%E6%BA%90%E3%80%81%E4%BB%A3%E7%A0%81%E5%9D%97%E3%80%81%E6%A8%A1%E5%9D%97%E5%8F%8A%E5%85%B6%E4%BE%9D%E8%B5%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>读取输出资源、代码块、模块及其依赖</h3>\n<p>有些插件可能需要读取 Webpack 的处理结果，例如输出资源、代码块、模块及其依赖，以便做下一步处理。</p>\n<p>在 emit 事件发生时，代表源文件的转换和组装已经完成，在这里可以读取到最终将输出的资源、代码块、模块及其依赖，并且可以修改输出资源的内容。 插件代码如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="61617508434483930000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Plugin {\n  apply(compiler) {\n    compiler.plugin(\'emit\', function(compilation, callback) {\n      // compilation.chunks 存放所有代码块，是一个数组\n      compilation.chunks.forEach(function(chunk) {\n        // chunk 代表一个代码块\n        // 代码块由多个模块组成，通过 chunk.forEachModule 能读取组成代码块的每个模块\n        chunk.forEachModule(function(module) {\n          // module 代表一个模块\n          // module.fileDependencies 存放当前模块的所有依赖的文件路径，是一个数组\n          module.fileDependencies.forEach(function(filepath) {});\n        });\n\n        // Webpack 会根据 Chunk 去生成输出的文件资源，每个 Chunk 都对应一个及其以上的输出文件\n        // 例如在 Chunk 中包含了 CSS 模块并且使用了 ExtractTextPlugin 时，\n        // 该 Chunk 就会生成 .js 和 .css 两个文件\n        chunk.files.forEach(function(filename) {\n          // compilation.assets 存放当前所有即将输出的资源\n          // 调用一个输出资源的 source() 方法能获取到输出资源的内容\n          let source = compilation.assets[filename].source();\n        });\n      });\n\n      // 这是一个异步事件，要记得调用 callback 通知 Webpack 本次事件监听处理结束。\n      // 如果忘记了调用 callback，Webpack 将一直卡在这里而不会往后执行。\n      callback();\n    });\n  }\n}`, `61617508434483930000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Plugin</span> <span class="token punctuation">{</span>\n  <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    compiler<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span><span class="token string">\'emit\'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">compilation<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// compilation.chunks 存放所有代码块，是一个数组</span>\n      compilation<span class="token punctuation">.</span>chunks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">chunk</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token comment">// chunk 代表一个代码块</span>\n        <span class="token comment">// 代码块由多个模块组成，通过 chunk.forEachModule 能读取组成代码块的每个模块</span>\n        chunk<span class="token punctuation">.</span><span class="token function">forEachModule</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          <span class="token comment">// module 代表一个模块</span>\n          <span class="token comment">// module.fileDependencies 存放当前模块的所有依赖的文件路径，是一个数组</span>\n          module<span class="token punctuation">.</span>fileDependencies<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">filepath</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        <span class="token comment">// Webpack 会根据 Chunk 去生成输出的文件资源，每个 Chunk 都对应一个及其以上的输出文件</span>\n        <span class="token comment">// 例如在 Chunk 中包含了 CSS 模块并且使用了 ExtractTextPlugin 时，</span>\n        <span class="token comment">// 该 Chunk 就会生成 .js 和 .css 两个文件</span>\n        chunk<span class="token punctuation">.</span>files<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">filename</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          <span class="token comment">// compilation.assets 存放当前所有即将输出的资源</span>\n          <span class="token comment">// 调用一个输出资源的 source() 方法能获取到输出资源的内容</span>\n          <span class="token keyword">let</span> source <span class="token operator">=</span> compilation<span class="token punctuation">.</span>assets<span class="token punctuation">[</span>filename<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token comment">// 这是一个异步事件，要记得调用 callback 通知 Webpack 本次事件监听处理结束。</span>\n      <span class="token comment">// 如果忘记了调用 callback，Webpack 将一直卡在这里而不会往后执行。</span>\n      <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="监听文件变化"><a href="#%E7%9B%91%E5%90%AC%E6%96%87%E4%BB%B6%E5%8F%98%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>监听文件变化</h3>\n<p>Webpack 会从配置的入口模块出发，依次找出所有的依赖模块，当入口模块或者其依赖的模块发生变化时， 就会触发一次新的 Compilation。</p>\n<p>在开发插件时经常需要知道是哪个文件发生变化导致了新的 Compilation，为此可以使用如下代码：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="56422556442847930000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 当依赖的文件发生变化时会触发 watch-run 事件\ncompiler.plugin(\'watch-run\', (watching, callback) => {\n  // 获取发生变化的文件列表\n  const changedFiles = watching.compiler.watchFileSystem.watcher.mtimes;\n  // changedFiles 格式为键值对，键为发生变化的文件路径。\n  if (changedFiles[filePath] !== undefined) {\n    // filePath 对应的文件发生了变化\n  }\n  callback();\n});`, `56422556442847930000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 当依赖的文件发生变化时会触发 watch-run 事件</span>\ncompiler<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span><span class="token string">\'watch-run\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">watching<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token comment">// 获取发生变化的文件列表</span>\n  <span class="token keyword">const</span> changedFiles <span class="token operator">=</span> watching<span class="token punctuation">.</span>compiler<span class="token punctuation">.</span>watchFileSystem<span class="token punctuation">.</span>watcher<span class="token punctuation">.</span>mtimes<span class="token punctuation">;</span>\n  <span class="token comment">// changedFiles 格式为键值对，键为发生变化的文件路径。</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>changedFiles<span class="token punctuation">[</span>filePath<span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// filePath 对应的文件发生了变化</span>\n  <span class="token punctuation">}</span>\n  <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>默认情况下 Webpack 只会监视入口和其依赖的模块是否发生变化，在有些情况下项目可能需要引入新的文件，例如引入一个 HTML 文件。 由于 JavaScript 文件不会去导入 HTML 文件，Webpack 就不会监听 HTML 文件的变化，编辑 HTML 文件时就不会重新触发新的 Compilation。 为了监听 HTML 文件的变化，我们需要把 HTML 文件加入到依赖列表中，为此可以使用如下代码：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="39408605566520210000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`compiler.plugin(\'after-compile\', (compilation, callback) => {\n  // 把 HTML 文件添加到文件依赖列表，好让 Webpack 去监听 HTML 模块文件，在 HTML 模版文件发生变化时重新启动一次编译\n  compilation.fileDependencies.push(filePath);\n  callback();\n});`, `39408605566520210000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">compiler<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span><span class="token string">\'after-compile\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">compilation<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token comment">// 把 HTML 文件添加到文件依赖列表，好让 Webpack 去监听 HTML 模块文件，在 HTML 模版文件发生变化时重新启动一次编译</span>\n  compilation<span class="token punctuation">.</span>fileDependencies<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="修改输出资源"><a href="#%E4%BF%AE%E6%94%B9%E8%BE%93%E5%87%BA%E8%B5%84%E6%BA%90" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>修改输出资源</h3>\n<p>有些场景下插件需要修改、增加、删除输出的资源，要做到这点需要监听 emit 事件，因为发生 emit 事件时所有模块的转换和代码块对应的文件已经生成好， 需要输出的资源即将输出，因此 emit 事件是修改 Webpack 输出资源的最后时机。</p>\n<p>所有需要输出的资源会存放在 compilation.assets 中，compilation.assets 是一个键值对，键为需要输出的文件名称，值为文件对应的内容。</p>\n<p>设置 compilation.assets 的代码如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="33816068728129010000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`compiler.plugin(\'emit\', (compilation, callback) => {\n  // 设置名称为 fileName 的输出资源\n  compilation.assets[fileName] = {\n    // 返回文件内容\n    source: () => {\n      // fileContent 既可以是代表文本文件的字符串，也可以是代表二进制文件的 Buffer\n      return fileContent;\n    },\n    // 返回文件大小\n    size: () => {\n      return Buffer.byteLength(fileContent, \'utf8\');\n    }\n  };\n  callback();\n});`, `33816068728129010000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">compiler<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span><span class="token string">\'emit\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">compilation<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token comment">// 设置名称为 fileName 的输出资源</span>\n  compilation<span class="token punctuation">.</span>assets<span class="token punctuation">[</span>fileName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 返回文件内容</span>\n    <span class="token function-variable function">source</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token comment">// fileContent 既可以是代表文本文件的字符串，也可以是代表二进制文件的 Buffer</span>\n      <span class="token keyword">return</span> fileContent<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token comment">// 返回文件大小</span>\n    <span class="token function-variable function">size</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span> Buffer<span class="token punctuation">.</span><span class="token function">byteLength</span><span class="token punctuation">(</span>fileContent<span class="token punctuation">,</span> <span class="token string">\'utf8\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>读取 compilation.assets 的代码如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="29391845696660136000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`compiler.plugin(\'emit\', (compilation, callback) => {\n  // 读取名称为 fileName 的输出资源\n  const asset = compilation.assets[fileName];\n  // 获取输出资源的内容\n  asset.source();\n  // 获取输出资源的文件大小\n  asset.size();\n  callback();\n});`, `29391845696660136000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">compiler<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span><span class="token string">\'emit\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">compilation<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token comment">// 读取名称为 fileName 的输出资源</span>\n  <span class="token keyword">const</span> asset <span class="token operator">=</span> compilation<span class="token punctuation">.</span>assets<span class="token punctuation">[</span>fileName<span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token comment">// 获取输出资源的内容</span>\n  asset<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// 获取输出资源的文件大小</span>\n  asset<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="判断-webpack-使用了哪些插件"><a href="#%E5%88%A4%E6%96%AD-webpack-%E4%BD%BF%E7%94%A8%E4%BA%86%E5%93%AA%E4%BA%9B%E6%8F%92%E4%BB%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>判断 Webpack 使用了哪些插件</h3>\n<p>在开发一个插件时可能需要根据当前配置是否使用了其它某个插件而做下一步决定，因此需要读取 Webpack 当前的插件配置情况。 以判断当前是否使用了 ExtractTextPlugin 为例，可以使用如下代码：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="5984192108606123000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 判断当前配置使用使用了 ExtractTextPlugin，\n// compiler 参数即为 Webpack 在 apply(compiler) 中传入的参数\nfunction hasExtractTextPlugin(compiler) {\n  // 当前配置所有使用的插件列表\n  const plugins = compiler.options.plugins;\n  // 去 plugins 中寻找有没有 ExtractTextPlugin 的实例\n  return plugins.find((plugin) => plugin.__proto__.constructor === ExtractTextPlugin) != null;\n}`, `5984192108606123000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 判断当前配置使用使用了 ExtractTextPlugin，</span>\n<span class="token comment">// compiler 参数即为 Webpack 在 apply(compiler) 中传入的参数</span>\n<span class="token keyword">function</span> <span class="token function">hasExtractTextPlugin</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 当前配置所有使用的插件列表</span>\n  <span class="token keyword">const</span> plugins <span class="token operator">=</span> compiler<span class="token punctuation">.</span>options<span class="token punctuation">.</span>plugins<span class="token punctuation">;</span>\n  <span class="token comment">// 去 plugins 中寻找有没有 ExtractTextPlugin 的实例</span>\n  <span class="token keyword">return</span> plugins<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">plugin</span><span class="token punctuation">)</span> <span class="token operator">=></span> plugin<span class="token punctuation">.</span><span class="token class-name">__proto__</span><span class="token punctuation">.</span>constructor <span class="token operator">===</span> ExtractTextPlugin<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="实战-1"><a href="#%E5%AE%9E%E6%88%98-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>实战</h2>\n<p>下面我们举一个实际的例子，带你一步步去实现一个插件。</p>\n<p>该插件的名称取名叫 EndWebpackPlugin，作用是在 Webpack 即将退出时再附加一些额外的操作，例如在 Webpack 成功编译和输出了文件后执行发布操作把输出的文件上传到服务器。 同时该插件还能区分 Webpack 构建是否执行成功。使用该插件时方法如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="61509312645756985000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`module.exports = {\n  plugins: [\n    // 在初始化 EndWebpackPlugin 时传入了两个参数，分别是在成功时的回调函数和失败时的回调函数；\n    new EndWebpackPlugin(\n      () => {\n        // Webpack 构建成功，并且文件输出了后会执行到这里，在这里可以做发布文件操作\n      },\n      (err) => {\n        // Webpack 构建失败，err 是导致错误的原因\n        console.error(err);\n      }\n    )\n  ]\n};`, `61509312645756985000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>\n  plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n    <span class="token comment">// 在初始化 EndWebpackPlugin 时传入了两个参数，分别是在成功时的回调函数和失败时的回调函数；</span>\n    <span class="token keyword">new</span> <span class="token class-name">EndWebpackPlugin</span><span class="token punctuation">(</span>\n      <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token comment">// Webpack 构建成功，并且文件输出了后会执行到这里，在这里可以做发布文件操作</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token comment">// Webpack 构建失败，err 是导致错误的原因</span>\n        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">)</span>\n  <span class="token punctuation">]</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>要实现该插件，需要借助两个事件：</p>\n<ul>\n<li>done：在成功构建并且输出了文件后，Webpack 即将退出时发生；</li>\n<li>failed：在构建出现异常导致构建失败，Webpack 即将退出时发生；</li>\n</ul>\n<p>实现该插件非常简单，完整代码如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="48499403282608530000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class EndWebpackPlugin {\n  constructor(doneCallback, failCallback) {\n    // 存下在构造函数中传入的回调函数\n    this.doneCallback = doneCallback;\n    this.failCallback = failCallback;\n  }\n\n  apply(compiler) {\n    compiler.plugin(\'done\', (stats) => {\n      // 在 done 事件中回调 doneCallback\n      this.doneCallback(stats);\n    });\n    compiler.plugin(\'failed\', (err) => {\n      // 在 failed 事件中回调 failCallback\n      this.failCallback(err);\n    });\n  }\n}\n// 导出插件\nmodule.exports = EndWebpackPlugin;`, `48499403282608530000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">EndWebpackPlugin</span> <span class="token punctuation">{</span>\n  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">doneCallback<span class="token punctuation">,</span> failCallback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 存下在构造函数中传入的回调函数</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>doneCallback <span class="token operator">=</span> doneCallback<span class="token punctuation">;</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>failCallback <span class="token operator">=</span> failCallback<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    compiler<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span><span class="token string">\'done\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">stats</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token comment">// 在 done 事件中回调 doneCallback</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">doneCallback</span><span class="token punctuation">(</span>stats<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    compiler<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span><span class="token string">\'failed\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token comment">// 在 failed 事件中回调 failCallback</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">failCallback</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n<span class="token comment">// 导出插件</span>\nmodule<span class="token punctuation">.</span>exports <span class="token operator">=</span> EndWebpackPlugin<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>从开发这个插件可以看出，找到合适的事件点去完成功能在开发插件时显得尤为重要。 工作原理概括中详细介绍过 Webpack 在运行过程中广播出常用事件，你可以从中找到你需要的事件。</p>',
id:"/home/runner/work/GatsbyBlog/GatsbyBlog/blog/Webpack原理入门/index.md absPath of file >>> MarkdownRemark",timeToRead:16,frontmatter:{date:"2020-11-17 11:41:47",path:"/webpack-principle-introduction/",tags:"前端, 前端构建工具, webpack",title:"Webpack原理入门",draft:null}}],length:13,tag:"webpack",pagesSum:3,page:1}}}});