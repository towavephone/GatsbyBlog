webpackJsonp([65116756252467],{1677:function(n,s){n.exports={data:{site:{siteMetadata:{title:"女王控的博客",description:'前端工程师，黑猫女王控，欢迎勾搭，技术相关<a href="https://github.com/towavephone" target="_blank">@towavephone</a>，QQ闲聊<a href="tencent://AddContact/?fromId=45&fromSubId=1&subcmd=all&uin=634407147&website=www.oicqzone.com">@towave</a>，bili关注<a href="https://space.bilibili.com/11507708#/" target="_blank">@towave</a>',siteUrl:"https://blog.towavephone.com"}}},pathContext:{posts:[{excerpt:"需求背景 完成官网 1.0 的上线，实现动效、国际化、多平台适配等功能 动效 逐行显示 需求背景 实现功能如下： x 旋转 -> 不同文字由下而上透明度从 0 到 1 实现要点如下： 进入视口执行一次 离开视口重置动画 实现如下所示动效： 选型过程 选型 优点 缺点 react-spring 使用方便，基于弹簧物理的动画库 改变 state 会导致多次执行 不能自由控制播放进度 animate.css 原生方法体积小，提供回退兼容性好 使用较为繁琐，需要同时写 css、js gsap…",html:'<h1 id="需求背景"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h1>\n<p>完成官网 1.0 的上线，实现动效、国际化、多平台适配等功能</p>\n<h1 id="动效"><a href="#%E5%8A%A8%E6%95%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>动效</h1>\n<h2 id="逐行显示"><a href="#%E9%80%90%E8%A1%8C%E6%98%BE%E7%A4%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>逐行显示</h2>\n<h3 id="需求背景-1"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h3>\n<p>实现功能如下：</p>\n<p>x 旋转 -> 不同文字由下而上透明度从 0 到 1</p>\n<p>实现要点如下：</p>\n<ol>\n<li>进入视口执行一次</li>\n<li>离开视口重置动画</li>\n</ol>\n<p>实现如下所示动效：</p>\n<p><html><head></head><body><video data-src="/examples/international-official-website-technical-difficulties/line-by-line-display.mp4" loop="" muted="" autoplay="" width="100%" class="lazy"></video></body></html></video></p>\n<h3 id="选型过程"><a href="#%E9%80%89%E5%9E%8B%E8%BF%87%E7%A8%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>选型过程</h3>\n<table>\n<thead>\n<tr>\n<th align="left">选型</th>\n<th align="left">优点</th>\n<th align="left">缺点</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align="left"><a href="https://github.com/pmndrs/react-spring" target="_blank" rel="nofollow noreferrer noopener">react-spring</a></td>\n<td align="left">使用方便，基于弹簧物理的动画库</td>\n<td align="left"><ol>\n<li>\n改变 state 会导致多次执行\n</li>\n<li>\n不能自由控制播放进度\n</li>\n</ol></td>\n</tr>\n<tr>\n<td align="left"><a href="https://animate.style/" target="_blank" rel="nofollow noreferrer noopener">animate.css</a></td>\n<td align="left">原生方法体积小，提供回退兼容性好</td>\n<td align="left">使用较为繁琐，需要同时写 css、js</td>\n</tr>\n<tr>\n<td align="left"><a href="https://github.com/greensock/GSAP" target="_blank" rel="nofollow noreferrer noopener">gsap</a></td>\n<td align="left"><ol>\n<li>\n可控制播放进度或自动播放，可配合之后提到的 react-scrollmagic 实现动效进度控制\n</li>\n<li>\n示例丰富，可实现很多动效\n</li>\n</ol></td>\n<td align="left">api 过于原始，需要封装</td>\n</tr>\n<tr>\n<td align="left"><a href="https://github.com/bitworking/react-gsap" target="_blank" rel="nofollow noreferrer noopener">react-gsap</a></td>\n<td align="left">除了以上优点，可直接在 react 中使用</td>\n<td align="left">有些 gsap 动效不能直接在 react-gsap 中使用，比如说和 react-scrollmagic 相同的效果</td>\n</tr>\n</tbody>\n</table>\n<h3 id="核心代码"><a href="#%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>核心代码</h3>\n<h4 id="react-spring"><a href="#react-spring" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>react-spring</h4>\n<p>最初采用 react-spring 版本，主要实现了如下功能</p>\n<ol>\n<li>react-spring 时间序列化（react-spring ref delay）</li>\n<li>useContext 全局控制，实现 react-spring 的反向动画</li>\n</ol>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="16907787208010007000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import React, { CSSProperties, ReactNode, Children, useRef, useEffect, useContext } from \'react\';\nimport classnames from \'classnames\';\nimport { a, useTransition, useSpringRef, useSpring } from \'@react-spring/web\';\nimport { useInViewport } from \'ahooks\';\n\nimport XIcon from \'@/components/xIcon\';\nimport ConfigContext from \'@/components/layout/configContext\';\n\nimport { delayFunc } from \'@/utils\';\n\nimport PageStyles from \'./index.module.less\';\n\nexport interface AnimationTitleProps {\n   className?: string;\n   title?: ReactNode;\n   subTitle?: ReactNode;\n   closeIcon?: ReactNode;\n   delay?: number;\n   style?: CSSProperties;\n   animation?: boolean;\n   isOnce?: boolean;\n}\n\ntype TransitionProps = Parameters<typeof useTransition>[1];\n\nconst AnimationTitle = ({\n   className,\n   title,\n   subTitle,\n   closeIcon = <XIcon name=\'title-x\' />,\n   delay = 300,\n   style,\n   animation = true,\n   isOnce = false\n}: AnimationTitleProps) => {\n   const { isRunMultiTime } = useContext(ConfigContext);\n\n   const closeIconRef = useSpringRef();\n   const closeIconStyle = useSpring({\n      ref: closeIconRef,\n      from: {\n         opacity: 0,\n         rotate: -100\n      },\n      to: {\n         rotate: 0,\n         opacity: 1\n      }\n   });\n\n   const titleRef = useSpringRef();\n   const titleStyle = useSpring({\n      ref: titleRef,\n      from: {\n         scale: 0,\n         opacity: 0\n      },\n      to: {\n         scale: 1,\n         opacity: 1\n      },\n      config: {\n         tension: 100,\n         friction: 14\n      }\n   });\n\n   const renderSubTitle: ReactNode[] = Children.map(Children.toArray(subTitle), (child, index) => {\n      if (typeof child === \'string\') {\n         return <div key={index}>{child}</div>;\n      }\n      return child;\n   });\n\n   const subTitleRef = useSpringRef();\n   const transitionProps: TransitionProps = {\n      from: {\n         opacity: 0,\n         y: 50\n      },\n      enter: (msg, i) => ({\n         delay: () => {\n            return i * 400;\n         },\n         to: {\n            opacity: 1,\n            y: 0\n         }\n      }),\n      ref: subTitleRef\n   };\n\n   if (!isRunMultiTime || isOnce) {\n      transitionProps.keys = (item: { key: any }) => item.key;\n   }\n\n   const transitions = useTransition(renderSubTitle, transitionProps);\n\n   const domRef = useRef<HTMLDivElement>(null);\n   const [inViewPort] = useInViewport(domRef);\n   useEffect(() => {\n      const startAnimation = async () => {\n         await delayFunc(delay);\n         if (closeIcon) {\n            closeIconRef.start();\n         }\n         if (title) {\n            await Promise.all(titleRef.start());\n         }\n         if (subTitle) {\n            await Promise.all(subTitleRef.start());\n         }\n      };\n\n      const reverseAnimation = () => {\n         [closeIconRef, titleRef, subTitleRef].forEach((item) => {\n            item.start({\n               reverse: true\n            });\n         });\n      };\n\n      if (inViewPort) {\n         startAnimation();\n      } else if (isRunMultiTime && !isOnce) {\n         reverseAnimation();\n      }\n      // eslint-disable-next-line react-hooks/exhaustive-deps\n   }, [inViewPort, isOnce, title, subTitle]);\n\n   const getStyle = (style: any) => (animation ? style : undefined);\n\n   return (\n      <div ref={domRef} className={classnames(PageStyles.textDisplay, \'text-display\', className)} style={style}>\n         {closeIcon && (\n            <a.div style={getStyle(closeIconStyle)} className={classnames(PageStyles.closeIcon, \'close-icon\')}>\n               {closeIcon}\n            </a.div>\n         )}\n         {title && (\n            <a.div style={getStyle(titleStyle)} className={classnames(PageStyles.title, \'text-display-title\')}>\n               {title}\n            </a.div>\n         )}\n         {subTitle && (\n            <div className={classnames(PageStyles.subTitleContainer, \'text-display-sub-title-container\')}>\n               {transitions((style, item: any) => {\n                  return (\n                     <a.div\n                        style={getStyle(style)}\n                        className={classnames(PageStyles.subTitle, \'text-display-sub-title\')}\n                     >\n                        {item}\n                     </a.div>\n                  );\n               })}\n            </div>\n         )}\n      </div>\n   );\n};\n\nexport default AnimationTitle;`, `16907787208010007000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="tsx"\n              >\n                <span class="gatsby-code-button-language">tsx</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="tsx"><pre style="counter-reset: linenumber NaN" class="language-tsx line-numbers"><code class="language-tsx"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> CSSProperties<span class="token punctuation">,</span> ReactNode<span class="token punctuation">,</span> Children<span class="token punctuation">,</span> useRef<span class="token punctuation">,</span> useEffect<span class="token punctuation">,</span> useContext <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> classnames <span class="token keyword">from</span> <span class="token string">\'classnames\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> a<span class="token punctuation">,</span> useTransition<span class="token punctuation">,</span> useSpringRef<span class="token punctuation">,</span> useSpring <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@react-spring/web\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> useInViewport <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'ahooks\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> XIcon <span class="token keyword">from</span> <span class="token string">\'@/components/xIcon\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> ConfigContext <span class="token keyword">from</span> <span class="token string">\'@/components/layout/configContext\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> <span class="token punctuation">{</span> delayFunc <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@/utils\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> PageStyles <span class="token keyword">from</span> <span class="token string">\'./index.module.less\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">AnimationTitleProps</span> <span class="token punctuation">{</span>\n   className<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>\n   title<span class="token operator">?</span><span class="token punctuation">:</span> ReactNode<span class="token punctuation">;</span>\n   subTitle<span class="token operator">?</span><span class="token punctuation">:</span> ReactNode<span class="token punctuation">;</span>\n   closeIcon<span class="token operator">?</span><span class="token punctuation">:</span> ReactNode<span class="token punctuation">;</span>\n   delay<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>\n   style<span class="token operator">?</span><span class="token punctuation">:</span> CSSProperties<span class="token punctuation">;</span>\n   animation<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>\n   isOnce<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">type</span> TransitionProps <span class="token operator">=</span> Parameters<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>typeof</span> <span class="token attr-name">useTransition</span><span class="token punctuation">></span></span><span class="token plain-text">[1];\n\nconst AnimationTitle = (</span><span class="token punctuation">{</span>\n   className<span class="token punctuation">,</span>\n   title<span class="token punctuation">,</span>\n   subTitle<span class="token punctuation">,</span>\n   closeIcon <span class="token operator">=</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">XIcon</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">\'</span>title-x<span class="token punctuation">\'</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">,</span>\n   delay <span class="token operator">=</span> <span class="token number">300</span><span class="token punctuation">,</span>\n   style<span class="token punctuation">,</span>\n   animation <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n   isOnce <span class="token operator">=</span> <span class="token boolean">false</span>\n<span class="token punctuation">}</span><span class="token plain-text">: AnimationTitleProps) => </span><span class="token punctuation">{</span>\n   <span class="token keyword">const</span> <span class="token punctuation">{</span> isRunMultiTime <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useContext</span><span class="token punctuation">(</span>ConfigContext<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token keyword">const</span> closeIconRef <span class="token operator">=</span> <span class="token function">useSpringRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">const</span> closeIconStyle <span class="token operator">=</span> <span class="token function">useSpring</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n      ref<span class="token punctuation">:</span> closeIconRef<span class="token punctuation">,</span>\n      <span class="token keyword">from</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>\n         opacity<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>\n         rotate<span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">100</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      to<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n         rotate<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>\n         opacity<span class="token punctuation">:</span> <span class="token number">1</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token keyword">const</span> titleRef <span class="token operator">=</span> <span class="token function">useSpringRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">const</span> titleStyle <span class="token operator">=</span> <span class="token function">useSpring</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n      ref<span class="token punctuation">:</span> titleRef<span class="token punctuation">,</span>\n      <span class="token keyword">from</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>\n         scale<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>\n         opacity<span class="token punctuation">:</span> <span class="token number">0</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      to<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n         scale<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>\n         opacity<span class="token punctuation">:</span> <span class="token number">1</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      config<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n         tension<span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">,</span>\n         friction<span class="token punctuation">:</span> <span class="token number">14</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token keyword">const</span> renderSubTitle<span class="token punctuation">:</span> ReactNode<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> Children<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>Children<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span>subTitle<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">child<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> child <span class="token operator">===</span> <span class="token string">\'string\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>index<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token punctuation">{</span>child<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      <span class="token keyword">return</span> child<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token keyword">const</span> subTitleRef <span class="token operator">=</span> <span class="token function">useSpringRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">const</span> transitionProps<span class="token punctuation">:</span> TransitionProps <span class="token operator">=</span> <span class="token punctuation">{</span>\n      <span class="token keyword">from</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>\n         opacity<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>\n         y<span class="token punctuation">:</span> <span class="token number">50</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      <span class="token function-variable function">enter</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">msg<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>\n         <span class="token function-variable function">delay</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            <span class="token keyword">return</span> i <span class="token operator">*</span> <span class="token number">400</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span><span class="token punctuation">,</span>\n         to<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n            opacity<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>\n            y<span class="token punctuation">:</span> <span class="token number">0</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n      ref<span class="token punctuation">:</span> subTitleRef\n   <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isRunMultiTime <span class="token operator">||</span> isOnce<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      transitionProps<span class="token punctuation">.</span><span class="token function-variable function">keys</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">:</span> <span class="token punctuation">{</span> key<span class="token punctuation">:</span> <span class="token builtin">any</span> <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> item<span class="token punctuation">.</span>key<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token keyword">const</span> transitions <span class="token operator">=</span> <span class="token function">useTransition</span><span class="token punctuation">(</span>renderSubTitle<span class="token punctuation">,</span> transitionProps<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token keyword">const</span> domRef <span class="token operator">=</span> useRef<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">HTMLDivElement</span></span><span class="token punctuation">></span></span><span class="token plain-text">(null);\n   const [inViewPort] = useInViewport(domRef);\n   useEffect(() => </span><span class="token punctuation">{</span>\n      <span class="token keyword">const</span> <span class="token function-variable function">startAnimation</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n         <span class="token keyword">await</span> <span class="token function">delayFunc</span><span class="token punctuation">(</span>delay<span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token keyword">if</span> <span class="token punctuation">(</span>closeIcon<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            closeIconRef<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span>\n         <span class="token keyword">if</span> <span class="token punctuation">(</span>title<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">await</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>titleRef<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span>\n         <span class="token keyword">if</span> <span class="token punctuation">(</span>subTitle<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">await</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>subTitleRef<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">const</span> <span class="token function-variable function">reverseAnimation</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n         <span class="token punctuation">[</span>closeIconRef<span class="token punctuation">,</span> titleRef<span class="token punctuation">,</span> subTitleRef<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            item<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n               reverse<span class="token punctuation">:</span> <span class="token boolean">true</span>\n            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>inViewPort<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token function">startAnimation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>isRunMultiTime <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>isOnce<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token function">reverseAnimation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      <span class="token comment">// eslint-disable-next-line react-hooks/exhaustive-deps</span>\n   <span class="token punctuation">}</span><span class="token plain-text">, [inViewPort, isOnce, title, subTitle]);\n\n   const getStyle = (style: any) => (animation ? style : undefined);\n\n   return (\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>domRef<span class="token punctuation">}</span></span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">classnames</span><span class="token punctuation">(</span>PageStyles<span class="token punctuation">.</span>textDisplay<span class="token punctuation">,</span> <span class="token string">\'text-display\'</span><span class="token punctuation">,</span> className<span class="token punctuation">)</span><span class="token punctuation">}</span></span> <span class="token attr-name">style</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>style<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n         </span><span class="token punctuation">{</span>closeIcon <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>\n            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a.div</span> <span class="token attr-name">style</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">getStyle</span><span class="token punctuation">(</span>closeIconStyle<span class="token punctuation">)</span><span class="token punctuation">}</span></span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">classnames</span><span class="token punctuation">(</span>PageStyles<span class="token punctuation">.</span>closeIcon<span class="token punctuation">,</span> <span class="token string">\'close-icon\'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n               </span><span class="token punctuation">{</span>closeIcon<span class="token punctuation">}</span><span class="token plain-text">\n            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a.div</span><span class="token punctuation">></span></span>\n         <span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token plain-text">\n         </span><span class="token punctuation">{</span>title <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>\n            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a.div</span> <span class="token attr-name">style</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">getStyle</span><span class="token punctuation">(</span>titleStyle<span class="token punctuation">)</span><span class="token punctuation">}</span></span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">classnames</span><span class="token punctuation">(</span>PageStyles<span class="token punctuation">.</span>title<span class="token punctuation">,</span> <span class="token string">\'text-display-title\'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n               </span><span class="token punctuation">{</span>title<span class="token punctuation">}</span><span class="token plain-text">\n            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a.div</span><span class="token punctuation">></span></span>\n         <span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token plain-text">\n         </span><span class="token punctuation">{</span>subTitle <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>\n            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">classnames</span><span class="token punctuation">(</span>PageStyles<span class="token punctuation">.</span>subTitleContainer<span class="token punctuation">,</span> <span class="token string">\'text-display-sub-title-container\'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n               </span><span class="token punctuation">{</span><span class="token function">transitions</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">style<span class="token punctuation">,</span> item<span class="token punctuation">:</span> <span class="token builtin">any</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n                  <span class="token keyword">return</span> <span class="token punctuation">(</span>\n                     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a.div</span>\n                        <span class="token attr-name">style</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">getStyle</span><span class="token punctuation">(</span>style<span class="token punctuation">)</span><span class="token punctuation">}</span></span>\n                        <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">classnames</span><span class="token punctuation">(</span>PageStyles<span class="token punctuation">.</span>subTitle<span class="token punctuation">,</span> <span class="token string">\'text-display-sub-title\'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span>\n                     <span class="token punctuation">></span></span><span class="token plain-text">\n                        </span><span class="token punctuation">{</span>item<span class="token punctuation">}</span><span class="token plain-text">\n                     </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a.div</span><span class="token punctuation">></span></span>\n                  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n               <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token plain-text">\n            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>\n         <span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">\n   );\n};\n\nexport default AnimationTitle;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="react-gsap"><a href="#react-gsap" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>react-gsap</h4>\n<p>为了解决渲染多次组件带来的多次执行动效的问题，之后采用 react-gsap 实现</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="50704743209658606000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import React, {\n  CSSProperties,\n  ReactNode,\n  Children,\n  useContext,\n  useRef,\n  useEffect\n} from \'react\'\nimport classnames from \'classnames\'\nimport { Tween, PlayState } from \'react-gsap\'\nimport { useInViewport } from \'ahooks\'\n\nimport XIcon from \'@/components/xIcon\'\nimport ConfigContext from \'@/components/layout/configContext\'\n\nimport useStoreContext, { CLIENT_TYPE } from \'@/hooks/useStoreContext\'\n\nimport { delayFunc } from \'@/utils\'\n\nimport PageStyles from \'./index.module.less\'\n\nexport interface AnimationTitleProps {\n  className?: string\n  title?: ReactNode\n  subTitle?: ReactNode\n  closeIcon?: ReactNode\n  delay?: number\n  style?: CSSProperties\n  animation?: boolean\n  isOnce?: boolean\n  titleStyle?: CSSProperties\n  closeIconStyle?: CSSProperties\n  reverseAnimationRef?: any\n  startAnimationRef?: any\n}\n\nexport const defaultCloseIcon = (<XIcon\n  name=\'title-x\'\n/>)\n\nconst AnimationTitle = (props: AnimationTitleProps) => {\n  const {\n    className,\n    title,\n    subTitle,\n    closeIcon = defaultCloseIcon,\n    delay = 300,\n    style,\n    animation = true,\n    isOnce = false,\n    closeIconStyle,\n    titleStyle,\n    reverseAnimationRef = null,\n    startAnimationRef = null\n  } = props\n\n  const { isRunMultiTime } = useContext(ConfigContext)\n  const closeIconRef = useRef(null)\n  const titleRef = useRef(null)\n  const subTitleRef = useRef(null)\n\n  const domRef = useRef<HTMLDivElement>(null)\n  const [inViewPort] = useInViewport(domRef)\n\n  const { state } = useStoreContext()\n\n  useEffect(() => {\n    if (!animation || state?.clientType === CLIENT_TYPE.H5) {\n      return\n    }\n    const startAnimation = async () => {\n      await delayFunc(delay)\n      if (closeIcon) {\n        closeIconRef.current?.getGSAP().play()\n      }\n      await delayFunc(200)\n      if (title) {\n        titleRef.current?.getGSAP().play()\n      }\n      // 等 title 动画的一半就开始运行\n      await delayFunc(500)\n      if (subTitle) {\n        await subTitleRef.current?.getGSAP().play()\n      }\n    }\n\n    const reverseAnimation = () => {\n      [closeIconRef, titleRef, subTitleRef].forEach((item) => {\n        item.current?.getGSAP().reverse()\n      })\n    }\n\n    if (reverseAnimationRef) {\n      reverseAnimationRef.current = reverseAnimation\n    }\n\n    if (startAnimationRef) {\n      startAnimationRef.current = startAnimation\n    }\n\n    if (inViewPort) {\n      startAnimation()\n    } else if (isRunMultiTime && !isOnce) {\n      reverseAnimation()\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [inViewPort, isOnce])\n\n  let playState = animation ? PlayState.stop : PlayState.stopEnd\n\n  // animation 未定义且是 h5 的情况下，去掉动效\n  if (state?.clientType === CLIENT_TYPE.H5) {\n    playState = PlayState.stopEnd\n  }\n\n  return (\n    <div\n      className={classnames(\n        PageStyles.textDisplay,\n        \'text-display\',\n        className\n      )}\n      style={style}\n      ref={domRef}\n    >\n      {\n        closeIcon && <Tween\n          ref={closeIconRef}\n          from={{\n            opacity: 0,\n            rotate: -100\n          }}\n          to={{\n            opacity: 1,\n            rotate: 0\n          }}\n          playState={playState}\n        >\n          <div\n            className={classnames(PageStyles.closeIcon, \'close-icon\')}\n            style={closeIconStyle}\n          >\n            {closeIcon}\n          </div>\n        </Tween>\n      }\n      {\n        title && <Tween\n          ref={titleRef}\n          from={{\n            scale: 0,\n            opacity: 0\n          }}\n          to={{\n            opacity: 1,\n            scale: 1\n          }}\n          playState={playState}\n        >\n          <div\n            className={classnames(\n              PageStyles.title,\n              \'text-display-title\'\n            )}\n            style={titleStyle}\n          >\n            {title}\n          </div>\n        </Tween>\n      }\n      {\n        subTitle && <div\n          className={classnames(\n            PageStyles.subTitleContainer,\n            \'text-display-sub-title-container\'\n          )}\n        >\n          <Tween\n            ref={subTitleRef}\n            from={{\n              opacity: 0,\n              y: 50\n            }}\n            to={{\n              opacity: 1,\n              y: 0\n            }}\n            stagger={0.6}\n            duration={Children.toArray(subTitle).length * 0.4}\n            playState={playState}\n          >\n            {\n              Children.toArray(subTitle).map((item: any, index: number) => {\n                return (\n                  <div\n                    className={classnames(\n                      PageStyles.subTitle,\n                      \'text-display-sub-title\'\n                    )}\n                    key={index}\n                  >\n                    {item}\n                  </div>\n                )\n              })\n            }\n          </Tween>\n        </div>\n      }\n    </div>\n  )\n}\n\nexport default AnimationTitle`, `50704743209658606000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="tsx"\n              >\n                <span class="gatsby-code-button-language">tsx</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="tsx"><pre style="counter-reset: linenumber NaN" class="language-tsx line-numbers"><code class="language-tsx"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n  CSSProperties<span class="token punctuation">,</span>\n  ReactNode<span class="token punctuation">,</span>\n  Children<span class="token punctuation">,</span>\n  useContext<span class="token punctuation">,</span>\n  useRef<span class="token punctuation">,</span>\n  useEffect\n<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react\'</span>\n<span class="token keyword">import</span> classnames <span class="token keyword">from</span> <span class="token string">\'classnames\'</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> Tween<span class="token punctuation">,</span> PlayState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react-gsap\'</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> useInViewport <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'ahooks\'</span>\n\n<span class="token keyword">import</span> XIcon <span class="token keyword">from</span> <span class="token string">\'@/components/xIcon\'</span>\n<span class="token keyword">import</span> ConfigContext <span class="token keyword">from</span> <span class="token string">\'@/components/layout/configContext\'</span>\n\n<span class="token keyword">import</span> useStoreContext<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token constant">CLIENT_TYPE</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@/hooks/useStoreContext\'</span>\n\n<span class="token keyword">import</span> <span class="token punctuation">{</span> delayFunc <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@/utils\'</span>\n\n<span class="token keyword">import</span> PageStyles <span class="token keyword">from</span> <span class="token string">\'./index.module.less\'</span>\n\n<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">AnimationTitleProps</span> <span class="token punctuation">{</span>\n  className<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">string</span>\n  title<span class="token operator">?</span><span class="token punctuation">:</span> ReactNode\n  subTitle<span class="token operator">?</span><span class="token punctuation">:</span> ReactNode\n  closeIcon<span class="token operator">?</span><span class="token punctuation">:</span> ReactNode\n  delay<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">number</span>\n  style<span class="token operator">?</span><span class="token punctuation">:</span> CSSProperties\n  animation<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">boolean</span>\n  isOnce<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">boolean</span>\n  titleStyle<span class="token operator">?</span><span class="token punctuation">:</span> CSSProperties\n  closeIconStyle<span class="token operator">?</span><span class="token punctuation">:</span> CSSProperties\n  reverseAnimationRef<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">any</span>\n  startAnimationRef<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">any</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">export</span> <span class="token keyword">const</span> defaultCloseIcon <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">XIcon</span></span>\n  <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">\'</span>title-x<span class="token punctuation">\'</span></span>\n<span class="token punctuation">/></span></span><span class="token punctuation">)</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">AnimationTitle</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">props<span class="token punctuation">:</span> AnimationTitleProps</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span>\n    className<span class="token punctuation">,</span>\n    title<span class="token punctuation">,</span>\n    subTitle<span class="token punctuation">,</span>\n    closeIcon <span class="token operator">=</span> defaultCloseIcon<span class="token punctuation">,</span>\n    delay <span class="token operator">=</span> <span class="token number">300</span><span class="token punctuation">,</span>\n    style<span class="token punctuation">,</span>\n    animation <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n    isOnce <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n    closeIconStyle<span class="token punctuation">,</span>\n    titleStyle<span class="token punctuation">,</span>\n    reverseAnimationRef <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span>\n    startAnimationRef <span class="token operator">=</span> <span class="token keyword">null</span>\n  <span class="token punctuation">}</span> <span class="token operator">=</span> props\n\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> isRunMultiTime <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useContext</span><span class="token punctuation">(</span>ConfigContext<span class="token punctuation">)</span>\n  <span class="token keyword">const</span> closeIconRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>\n  <span class="token keyword">const</span> titleRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>\n  <span class="token keyword">const</span> subTitleRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>\n\n  <span class="token keyword">const</span> domRef <span class="token operator">=</span> useRef<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">HTMLDivElement</span></span><span class="token punctuation">></span></span><span class="token plain-text">(null)\n  const [inViewPort] = useInViewport(domRef)\n\n  const </span><span class="token punctuation">{</span> state <span class="token punctuation">}</span><span class="token plain-text"> = useStoreContext()\n\n  useEffect(() => </span><span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>animation <span class="token operator">||</span> state<span class="token operator">?</span><span class="token punctuation">.</span>clientType <span class="token operator">===</span> <span class="token constant">CLIENT_TYPE</span><span class="token punctuation">.</span><span class="token constant">H5</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">const</span> <span class="token function-variable function">startAnimation</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">await</span> <span class="token function">delayFunc</span><span class="token punctuation">(</span>delay<span class="token punctuation">)</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>closeIcon<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        closeIconRef<span class="token punctuation">.</span>current<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">getGSAP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n      <span class="token punctuation">}</span>\n      <span class="token keyword">await</span> <span class="token function">delayFunc</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>title<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        titleRef<span class="token punctuation">.</span>current<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">getGSAP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n      <span class="token punctuation">}</span>\n      <span class="token comment">// 等 title 动画的一半就开始运行</span>\n      <span class="token keyword">await</span> <span class="token function">delayFunc</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>subTitle<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">await</span> subTitleRef<span class="token punctuation">.</span>current<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">getGSAP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">const</span> <span class="token function-variable function">reverseAnimation</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token punctuation">[</span>closeIconRef<span class="token punctuation">,</span> titleRef<span class="token punctuation">,</span> subTitleRef<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        item<span class="token punctuation">.</span>current<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">getGSAP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>reverseAnimationRef<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      reverseAnimationRef<span class="token punctuation">.</span>current <span class="token operator">=</span> reverseAnimation\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>startAnimationRef<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      startAnimationRef<span class="token punctuation">.</span>current <span class="token operator">=</span> startAnimation\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>inViewPort<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token function">startAnimation</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>isRunMultiTime <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>isOnce<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token function">reverseAnimation</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n    <span class="token comment">// eslint-disable-next-line react-hooks/exhaustive-deps</span>\n  <span class="token punctuation">}</span><span class="token plain-text">, [inViewPort, isOnce])\n\n  let playState = animation ? PlayState.stop : PlayState.stopEnd\n\n  // animation 未定义且是 h5 的情况下，去掉动效\n  if (state?.clientType === CLIENT_TYPE.H5) </span><span class="token punctuation">{</span>\n    playState <span class="token operator">=</span> PlayState<span class="token punctuation">.</span>stopEnd\n  <span class="token punctuation">}</span><span class="token plain-text">\n\n  return (\n    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span>\n      <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">classnames</span><span class="token punctuation">(</span>\n        PageStyles<span class="token punctuation">.</span>textDisplay<span class="token punctuation">,</span>\n        <span class="token string">\'text-display\'</span><span class="token punctuation">,</span>\n        className\n      <span class="token punctuation">)</span><span class="token punctuation">}</span></span>\n      <span class="token attr-name">style</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>style<span class="token punctuation">}</span></span>\n      <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>domRef<span class="token punctuation">}</span></span>\n    <span class="token punctuation">></span></span><span class="token plain-text">\n      </span><span class="token punctuation">{</span>\n        closeIcon <span class="token operator">&amp;&amp;</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Tween</span></span>\n          <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>closeIconRef<span class="token punctuation">}</span></span>\n          <span class="token attr-name">from</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>\n            opacity<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>\n            rotate<span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">100</span>\n          <span class="token punctuation">}</span><span class="token punctuation">}</span></span>\n          <span class="token attr-name">to</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>\n            opacity<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>\n            rotate<span class="token punctuation">:</span> <span class="token number">0</span>\n          <span class="token punctuation">}</span><span class="token punctuation">}</span></span>\n          <span class="token attr-name">playState</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>playState<span class="token punctuation">}</span></span>\n        <span class="token punctuation">></span></span><span class="token plain-text">\n          </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span>\n            <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">classnames</span><span class="token punctuation">(</span>PageStyles<span class="token punctuation">.</span>closeIcon<span class="token punctuation">,</span> <span class="token string">\'close-icon\'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span>\n            <span class="token attr-name">style</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>closeIconStyle<span class="token punctuation">}</span></span>\n          <span class="token punctuation">></span></span><span class="token plain-text">\n            </span><span class="token punctuation">{</span>closeIcon<span class="token punctuation">}</span><span class="token plain-text">\n          </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">\n        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Tween</span></span><span class="token punctuation">></span></span>\n      <span class="token punctuation">}</span><span class="token plain-text">\n      </span><span class="token punctuation">{</span>\n        title <span class="token operator">&amp;&amp;</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Tween</span></span>\n          <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>titleRef<span class="token punctuation">}</span></span>\n          <span class="token attr-name">from</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>\n            scale<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>\n            opacity<span class="token punctuation">:</span> <span class="token number">0</span>\n          <span class="token punctuation">}</span><span class="token punctuation">}</span></span>\n          <span class="token attr-name">to</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>\n            opacity<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>\n            scale<span class="token punctuation">:</span> <span class="token number">1</span>\n          <span class="token punctuation">}</span><span class="token punctuation">}</span></span>\n          <span class="token attr-name">playState</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>playState<span class="token punctuation">}</span></span>\n        <span class="token punctuation">></span></span><span class="token plain-text">\n          </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span>\n            <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">classnames</span><span class="token punctuation">(</span>\n              PageStyles<span class="token punctuation">.</span>title<span class="token punctuation">,</span>\n              <span class="token string">\'text-display-title\'</span>\n            <span class="token punctuation">)</span><span class="token punctuation">}</span></span>\n            <span class="token attr-name">style</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>titleStyle<span class="token punctuation">}</span></span>\n          <span class="token punctuation">></span></span><span class="token plain-text">\n            </span><span class="token punctuation">{</span>title<span class="token punctuation">}</span><span class="token plain-text">\n          </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">\n        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Tween</span></span><span class="token punctuation">></span></span>\n      <span class="token punctuation">}</span><span class="token plain-text">\n      </span><span class="token punctuation">{</span>\n        subTitle <span class="token operator">&amp;&amp;</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span>\n          <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">classnames</span><span class="token punctuation">(</span>\n            PageStyles<span class="token punctuation">.</span>subTitleContainer<span class="token punctuation">,</span>\n            <span class="token string">\'text-display-sub-title-container\'</span>\n          <span class="token punctuation">)</span><span class="token punctuation">}</span></span>\n        <span class="token punctuation">></span></span><span class="token plain-text">\n          </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Tween</span></span>\n            <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>subTitleRef<span class="token punctuation">}</span></span>\n            <span class="token attr-name">from</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>\n              opacity<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>\n              y<span class="token punctuation">:</span> <span class="token number">50</span>\n            <span class="token punctuation">}</span><span class="token punctuation">}</span></span>\n            <span class="token attr-name">to</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>\n              opacity<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>\n              y<span class="token punctuation">:</span> <span class="token number">0</span>\n            <span class="token punctuation">}</span><span class="token punctuation">}</span></span>\n            <span class="token attr-name">stagger</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token number">0.6</span><span class="token punctuation">}</span></span>\n            <span class="token attr-name">duration</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>Children<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span>subTitle<span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">*</span> <span class="token number">0.4</span><span class="token punctuation">}</span></span>\n            <span class="token attr-name">playState</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>playState<span class="token punctuation">}</span></span>\n          <span class="token punctuation">></span></span><span class="token plain-text">\n            </span><span class="token punctuation">{</span>\n              Children<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span>subTitle<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> index<span class="token punctuation">:</span> <span class="token builtin">number</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n                <span class="token keyword">return</span> <span class="token punctuation">(</span>\n                  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span>\n                    <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">classnames</span><span class="token punctuation">(</span>\n                      PageStyles<span class="token punctuation">.</span>subTitle<span class="token punctuation">,</span>\n                      <span class="token string">\'text-display-sub-title\'</span>\n                    <span class="token punctuation">)</span><span class="token punctuation">}</span></span>\n                    <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>index<span class="token punctuation">}</span></span>\n                  <span class="token punctuation">></span></span><span class="token plain-text">\n                    </span><span class="token punctuation">{</span>item<span class="token punctuation">}</span><span class="token plain-text">\n                  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>\n                <span class="token punctuation">)</span>\n              <span class="token punctuation">}</span><span class="token punctuation">)</span>\n            <span class="token punctuation">}</span><span class="token plain-text">\n          </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Tween</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>\n      <span class="token punctuation">}</span><span class="token plain-text">\n    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">\n  )\n}\n\nexport default AnimationTitle</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="运行效果"><a href="#%E8%BF%90%E8%A1%8C%E6%95%88%E6%9E%9C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>运行效果</h3>\n<h4 id="react-spring-1"><a href="#react-spring-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>react-spring</h4>\n<!-- <iframe data-src="https://codesandbox.io/embed/b03lty?codemirror=1&hidenavigation=1&theme=light&view=preview" class="embedded-codesandbox" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe> --><html><head></head><body></body></html>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/49vcpg?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h4 id="react-gsap-1"><a href="#react-gsap-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>react-gsap</h4>\n<!-- <iframe data-src="https://codesandbox.io/embed/yibidu?codemirror=1&hidenavigation=1&theme=light&view=preview" class="embedded-codesandbox" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe> --><html><head></head><body></body></html>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/69fcy2?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h2 id="数字滚动展示"><a href="#%E6%95%B0%E5%AD%97%E6%BB%9A%E5%8A%A8%E5%B1%95%E7%A4%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>数字滚动展示</h2>\n<h3 id="需求背景-2"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h3>\n<p>实现功能如下：</p>\n<ol>\n<li>数字有滚动效果</li>\n<li>整体有位移、透明度变化效果</li>\n</ol>\n<p>实现要点如下：</p>\n<ol>\n<li>进入视口执行一次</li>\n<li>离开视口重置动画</li>\n</ol>\n<p>实现如下所示动效：</p>\n<p><html><head></head><body><video data-src="/examples/international-official-website-technical-difficulties/number-change-display.mp4" loop="" muted="" autoplay="" width="100%" class="lazy"></video></body></html></video></p>\n<h3 id="选型过程-1"><a href="#%E9%80%89%E5%9E%8B%E8%BF%87%E7%A8%8B-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>选型过程</h3>\n<p>同 <code class="language-text">逐行显示</code> 的选型过程，这里使用的是 react-spring</p>\n<h3 id="核心代码-1"><a href="#%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>核心代码</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="21067498527411278000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import React, { ReactNode, useRef, useEffect } from \'react\';\nimport classnames from \'classnames\';\nimport { a, useTrail, useSprings, useSpringRef } from \'@react-spring/web\';\nimport { useInViewport } from \'ahooks\';\n\nimport { delayFunc } from \'@/utils\';\n\nimport PageStyles from \'./index.module.less\';\n\ninterface TitleContent {\n   title: string;\n}\n\ninterface NumberContent {\n   number: string;\n   unit: string;\n   precision?: number;\n   render?: (value: number) => string;\n}\n\ninterface CommonDataItem {\n   hint: string;\n}\n\ntype DataItem = CommonDataItem & (TitleContent | NumberContent);\n\ninterface Props {\n   data: DataItem[];\n   className?: string;\n   delay?: number;\n}\n\nconst CarConfiguration = ({ data, className, delay = 300 }: Props) => {\n   const [trails, trailsApi] = useTrail(data.length, () => ({\n      opacity: 0,\n      y: 40\n   }));\n\n   const springsRef = useSpringRef();\n   const springs = useSprings(\n      data.length,\n      data.map((item) => ({\n         ref: springsRef,\n         from: {\n            number: 0\n         },\n         to: {\n            number: Number((item as NumberContent).number)\n         }\n      }))\n   );\n\n   const domRef = useRef();\n   const [inViewPort] = useInViewport(domRef);\n   useEffect(() => {\n      const startAnimation = async () => {\n         await delayFunc(delay);\n         trailsApi.start({\n            y: 0,\n            opacity: 1\n         });\n         await delayFunc(1200);\n         springsRef.start();\n      };\n\n      const reverseAnimation = () => {\n         trailsApi.start({\n            y: 40,\n            opacity: 0\n         });\n         [springsRef].forEach((item) => {\n            item &&\n               item.start({\n                  reverse: true\n               });\n         });\n      };\n\n      if (inViewPort) {\n         startAnimation();\n      } else {\n         reverseAnimation();\n      }\n      // eslint-disable-next-line react-hooks/exhaustive-deps\n   }, [inViewPort]);\n\n   return (\n      <div ref={domRef} className={classnames(PageStyles.configuration, className, \'car-configuration\')}>\n         {trails.map((style, index) => {\n            const item = data[index];\n            let title: ReactNode = (item as TitleContent).title;\n            const titleComponent = (\n               <>\n                  <span\n                     className={PageStyles.configurationTitle}\n                     key={Math.random()}\n                     dangerouslySetInnerHTML={{ __html: (item as TitleContent).title }}\n                  />\n                  <span\n                     className={PageStyles.unit}\n                     key={Math.random()}\n                     dangerouslySetInnerHTML={{ __html: (item as any).unit }}\n                  />\n               </>\n            );\n            const numberItem = item as NumberContent;\n            if (!title && numberItem.number) {\n               const renderFunc = numberItem.render\n                  ? numberItem.render\n                  : (value: number) => value.toFixed(numberItem.precision || 0);\n               title = (\n                  <>\n                     <a.span>{springs[index].number.to(renderFunc)}</a.span>\n                     <span\n                        className={PageStyles.unit}\n                        key={Math.random()}\n                        dangerouslySetInnerHTML={{ __html: numberItem.unit }}\n                     />\n                  </>\n               );\n            }\n            return (\n               <>\n                  <a.div\n                     key={index}\n                     className={classnames(PageStyles.configurationItem, \'car-configuration-item\')}\n                     style={style}\n                  >\n                     {typeof title === \'string\' ? (\n                        titleComponent\n                     ) : (\n                        <div className={PageStyles.configurationTitle}>{title} </div>\n                     )}\n                     <div className={PageStyles.configurationHint}>{item.hint}</div>\n                  </a.div>\n                  {index < trails.length - 1 && <a.div key={index} className={PageStyles.divider} style={style} />}\n               </>\n            );\n         })}\n      </div>\n   );\n};\n\nexport default CarConfiguration;`, `21067498527411278000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="tsx"\n              >\n                <span class="gatsby-code-button-language">tsx</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="tsx"><pre style="counter-reset: linenumber NaN" class="language-tsx line-numbers"><code class="language-tsx"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> ReactNode<span class="token punctuation">,</span> useRef<span class="token punctuation">,</span> useEffect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> classnames <span class="token keyword">from</span> <span class="token string">\'classnames\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> a<span class="token punctuation">,</span> useTrail<span class="token punctuation">,</span> useSprings<span class="token punctuation">,</span> useSpringRef <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@react-spring/web\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> useInViewport <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'ahooks\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> <span class="token punctuation">{</span> delayFunc <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@/utils\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> PageStyles <span class="token keyword">from</span> <span class="token string">\'./index.module.less\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">interface</span> <span class="token class-name">TitleContent</span> <span class="token punctuation">{</span>\n   title<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">interface</span> <span class="token class-name">NumberContent</span> <span class="token punctuation">{</span>\n   <span class="token builtin">number</span><span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>\n   unit<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>\n   precision<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>\n   render<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">value<span class="token punctuation">:</span> <span class="token builtin">number</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token builtin">string</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">interface</span> <span class="token class-name">CommonDataItem</span> <span class="token punctuation">{</span>\n   hint<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">type</span> DataItem <span class="token operator">=</span> CommonDataItem <span class="token operator">&amp;</span> <span class="token punctuation">(</span>TitleContent <span class="token operator">|</span> NumberContent<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">interface</span> <span class="token class-name">Props</span> <span class="token punctuation">{</span>\n   data<span class="token punctuation">:</span> DataItem<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n   className<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>\n   delay<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">CarConfiguration</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> data<span class="token punctuation">,</span> className<span class="token punctuation">,</span> delay <span class="token operator">=</span> <span class="token number">300</span> <span class="token punctuation">}</span><span class="token punctuation">:</span> Props</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   <span class="token keyword">const</span> <span class="token punctuation">[</span>trails<span class="token punctuation">,</span> trailsApi<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useTrail</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>length<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>\n      opacity<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>\n      y<span class="token punctuation">:</span> <span class="token number">40</span>\n   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token keyword">const</span> springsRef <span class="token operator">=</span> <span class="token function">useSpringRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">const</span> springs <span class="token operator">=</span> <span class="token function">useSprings</span><span class="token punctuation">(</span>\n      data<span class="token punctuation">.</span>length<span class="token punctuation">,</span>\n      data<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>\n         ref<span class="token punctuation">:</span> springsRef<span class="token punctuation">,</span>\n         <span class="token keyword">from</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>\n            <span class="token builtin">number</span><span class="token punctuation">:</span> <span class="token number">0</span>\n         <span class="token punctuation">}</span><span class="token punctuation">,</span>\n         to<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n            <span class="token builtin">number</span><span class="token punctuation">:</span> <span class="token function">Number</span><span class="token punctuation">(</span><span class="token punctuation">(</span>item <span class="token keyword">as</span> NumberContent<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">number</span><span class="token punctuation">)</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n   <span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token keyword">const</span> domRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">const</span> <span class="token punctuation">[</span>inViewPort<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useInViewport</span><span class="token punctuation">(</span>domRef<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> <span class="token function-variable function">startAnimation</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n         <span class="token keyword">await</span> <span class="token function">delayFunc</span><span class="token punctuation">(</span>delay<span class="token punctuation">)</span><span class="token punctuation">;</span>\n         trailsApi<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n            y<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>\n            opacity<span class="token punctuation">:</span> <span class="token number">1</span>\n         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token keyword">await</span> <span class="token function">delayFunc</span><span class="token punctuation">(</span><span class="token number">1200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         springsRef<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">const</span> <span class="token function-variable function">reverseAnimation</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n         trailsApi<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n            y<span class="token punctuation">:</span> <span class="token number">40</span><span class="token punctuation">,</span>\n            opacity<span class="token punctuation">:</span> <span class="token number">0</span>\n         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token punctuation">[</span>springsRef<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            item <span class="token operator">&amp;&amp;</span>\n               item<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n                  reverse<span class="token punctuation">:</span> <span class="token boolean">true</span>\n               <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>inViewPort<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token function">startAnimation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n         <span class="token function">reverseAnimation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      <span class="token comment">// eslint-disable-next-line react-hooks/exhaustive-deps</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>inViewPort<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token keyword">return</span> <span class="token punctuation">(</span>\n      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>domRef<span class="token punctuation">}</span></span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">classnames</span><span class="token punctuation">(</span>PageStyles<span class="token punctuation">.</span>configuration<span class="token punctuation">,</span> className<span class="token punctuation">,</span> <span class="token string">\'car-configuration\'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n         </span><span class="token punctuation">{</span>trails<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">style<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            <span class="token keyword">const</span> item <span class="token operator">=</span> data<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>\n            <span class="token keyword">let</span> title<span class="token punctuation">:</span> ReactNode <span class="token operator">=</span> <span class="token punctuation">(</span>item <span class="token keyword">as</span> TitleContent<span class="token punctuation">)</span><span class="token punctuation">.</span>title<span class="token punctuation">;</span>\n            <span class="token keyword">const</span> titleComponent <span class="token operator">=</span> <span class="token punctuation">(</span>\n               <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n                  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span>\n                     <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>PageStyles<span class="token punctuation">.</span>configurationTitle<span class="token punctuation">}</span></span>\n                     <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span>\n                     <span class="token attr-name">dangerouslySetInnerHTML</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> __html<span class="token punctuation">:</span> <span class="token punctuation">(</span>item <span class="token keyword">as</span> TitleContent<span class="token punctuation">)</span><span class="token punctuation">.</span>title <span class="token punctuation">}</span><span class="token punctuation">}</span></span>\n                  <span class="token punctuation">/></span></span><span class="token plain-text">\n                  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span>\n                     <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>PageStyles<span class="token punctuation">.</span>unit<span class="token punctuation">}</span></span>\n                     <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span>\n                     <span class="token attr-name">dangerouslySetInnerHTML</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> __html<span class="token punctuation">:</span> <span class="token punctuation">(</span>item <span class="token keyword">as</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token punctuation">.</span>unit <span class="token punctuation">}</span><span class="token punctuation">}</span></span>\n                  <span class="token punctuation">/></span></span><span class="token plain-text">\n               </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span></span><span class="token punctuation">></span></span>\n            <span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token keyword">const</span> numberItem <span class="token operator">=</span> item <span class="token keyword">as</span> NumberContent<span class="token punctuation">;</span>\n            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>title <span class="token operator">&amp;&amp;</span> numberItem<span class="token punctuation">.</span><span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n               <span class="token keyword">const</span> renderFunc <span class="token operator">=</span> numberItem<span class="token punctuation">.</span>render\n                  <span class="token operator">?</span> numberItem<span class="token punctuation">.</span><span class="token function-variable function">render</span>\n                  <span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">value<span class="token punctuation">:</span> <span class="token builtin">number</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> value<span class="token punctuation">.</span><span class="token function">toFixed</span><span class="token punctuation">(</span>numberItem<span class="token punctuation">.</span>precision <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n               title <span class="token operator">=</span> <span class="token punctuation">(</span>\n                  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n                     </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a.span</span><span class="token punctuation">></span></span><span class="token punctuation">{</span>springs<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">number</span><span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span>renderFunc<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a.span</span><span class="token punctuation">></span></span><span class="token plain-text">\n                     </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span>\n                        <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>PageStyles<span class="token punctuation">.</span>unit<span class="token punctuation">}</span></span>\n                        <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span>\n                        <span class="token attr-name">dangerouslySetInnerHTML</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> __html<span class="token punctuation">:</span> numberItem<span class="token punctuation">.</span>unit <span class="token punctuation">}</span><span class="token punctuation">}</span></span>\n                     <span class="token punctuation">/></span></span><span class="token plain-text">\n                  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span></span><span class="token punctuation">></span></span>\n               <span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span>\n            <span class="token keyword">return</span> <span class="token punctuation">(</span>\n               <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n                  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a.div</span>\n                     <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>index<span class="token punctuation">}</span></span>\n                     <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">classnames</span><span class="token punctuation">(</span>PageStyles<span class="token punctuation">.</span>configurationItem<span class="token punctuation">,</span> <span class="token string">\'car-configuration-item\'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span>\n                     <span class="token attr-name">style</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>style<span class="token punctuation">}</span></span>\n                  <span class="token punctuation">></span></span><span class="token plain-text">\n                     </span><span class="token punctuation">{</span><span class="token keyword">typeof</span> title <span class="token operator">===</span> <span class="token string">\'string\'</span> <span class="token operator">?</span> <span class="token punctuation">(</span>\n                        titleComponent\n                     <span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span>\n                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>PageStyles<span class="token punctuation">.</span>configurationTitle<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token punctuation">{</span>title<span class="token punctuation">}</span><span class="token plain-text"> </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>\n                     <span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token plain-text">\n                     </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>PageStyles<span class="token punctuation">.</span>configurationHint<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token punctuation">{</span>item<span class="token punctuation">.</span>hint<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">\n                  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a.div</span><span class="token punctuation">></span></span><span class="token plain-text">\n                  </span><span class="token punctuation">{</span>index <span class="token operator">&lt;</span> trails<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a.div</span> <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>index<span class="token punctuation">}</span></span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>PageStyles<span class="token punctuation">.</span>divider<span class="token punctuation">}</span></span> <span class="token attr-name">style</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>style<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">}</span><span class="token plain-text">\n               </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span></span><span class="token punctuation">></span></span>\n            <span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>\n   <span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> CarConfiguration<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="运行效果-1"><a href="#%E8%BF%90%E8%A1%8C%E6%95%88%E6%9E%9C-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>运行效果</h3>\n<!-- <iframe data-src="https://codesandbox.io/embed/ocnfxs?codemirror=1&hidenavigation=1&theme=light&view=preview" class="embedded-codesandbox" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe> --><html><head></head><body></body></html>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/r72tf2?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h2 id="固定页面滚动控制"><a href="#%E5%9B%BA%E5%AE%9A%E9%A1%B5%E9%9D%A2%E6%BB%9A%E5%8A%A8%E6%8E%A7%E5%88%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>固定页面滚动控制</h2>\n<h3 id="需求背景-3"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h3>\n<p>实现要点：</p>\n<ol>\n<li>随着鼠标滚轮滚动而触发的动效（跟随鼠标滚动，鼠标停顿时，动效也会停顿）</li>\n<li>需要固定页面</li>\n</ol>\n<p>实现如下所示的动效：</p>\n<p><html><head></head><body><video data-src="/examples/international-official-website-technical-difficulties/fix-page-scroll-display.mp4" loop="" muted="" autoplay="" width="100%" class="lazy"></video></body></html></video></p>\n<h3 id="选型过程-2"><a href="#%E9%80%89%E5%9E%8B%E8%BF%87%E7%A8%8B-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>选型过程</h3>\n<table>\n<thead>\n<tr>\n<th align="left">选型</th>\n<th align="left">优点</th>\n<th align="left">缺点</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align="left"><a href="https://github.com/janpaepke/ScrollMagic" target="_blank" rel="nofollow noreferrer noopener">ScrollMagic</a></td>\n<td align="left">官网例子满足需求</td>\n<td align="left">需要封装成 react</td>\n</tr>\n<tr>\n<td align="left"><a href="https://github.com/bitworking/react-scrollmagic" target="_blank" rel="nofollow noreferrer noopener">react-scrollmagic</a></td>\n<td align="left"><ol>\n<li>\n可在 react 中直接使用\n</li>\n<li>\n提供固定页面的百分比可完美用于 react-gsap 动效\n</li>\n</ol></td>\n<td align="left"><ol>\n<li>\n滑动过快会出现“抖动”\n</li>\n<li>\n不能实现切屏 + 固定页面同时存在的效果\n</li>\n</ol></td>\n</tr>\n<tr>\n<td align="left"><a href="https://github.com/bitworking/react-gsap" target="_blank" rel="nofollow noreferrer noopener">react-gsap</a>\n + scrollTrigger</td>\n<td align="left">解决了“抖动”问题</td>\n<td align="left">react-gsap 暴露的 api 不够底层，实现切屏 + 固定页面较困难</td>\n</tr>\n<tr>\n<td align="left"><a href="https://github.com/greensock/GSAP" target="_blank" rel="nofollow noreferrer noopener">gsap</a>\n + scrollTrigger</td>\n<td align="left">解决了以上的所有缺点</td>\n<td align="left">代码量过多，react 下需要考虑情况较多</td>\n</tr>\n</tbody>\n</table>\n<h3 id="核心代码-2"><a href="#%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>核心代码</h3>\n<h4 id="react-scrollmagic"><a href="#react-scrollmagic" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>react-scrollmagic</h4>\n<p>web/components/reactScrollMagic/index.tsx</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="46368755893692785000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import React, { Children, cloneElement, ReactElement } from \'react\'\nimport { Controller as XPController, Scene, SceneProps as XPSceneProps } from \'xp-react-scrollmagic\'\n\nimport useStoreContext, { CLIENT_TYPE } from \'@/hooks/useStoreContext\'\n\nimport { getWindowHeight } from \'@/utils\'\n\nconst defaultControllerProps = {\n  // container: getDocument()?.querySelector(\'h\')\n}\n\nconst defaultSceneProps = {\n  indicators: false,\n  triggerHook: 0,\n  duration: getWindowHeight()\n}\n\ninterface ProgressEventsParams {\n  progress: number\n  event: {\n    state: string\n    type: string\n  }\n}\n\nexport interface SceneProps {\n  sceneProps?: (Partial<XPSceneProps> & { enableParams: boolean }) | null\n  sceneParams?: ProgressEventsParams\n}\n\ninterface ControllerProps {\n  children: Array<ReactElement<SceneProps>> | ReactElement<SceneProps>\n}\n\nconst ReactScrollMagic = ({\n  children\n}: ControllerProps) => {\n  const { state } = useStoreContext()\n\n  const renderChildren = Children.map(children, (item, index) => {\n    const sceneProps = {\n      ...defaultSceneProps,\n      pin: state?.clientType === CLIENT_TYPE.PC,\n      ...item.props.sceneProps\n    }\n    if (sceneProps.enableParams) {\n      const {\n        enableParams,\n        ...rest\n      } = sceneProps\n      return (\n        <Scene\n          {...rest}\n        >\n          {\n            (progress: number, event: { state: string }) => {\n              return <div>\n                {\n                  cloneElement(item, {\n                    ...item.props,\n                    sceneParams: {\n                      progress,\n                      event\n                    }\n                  })\n                }\n              </div>\n            }\n          }\n        </Scene>\n      )\n    }\n    return (\n      <Scene\n        {...sceneProps}\n      >\n        <div>\n          {item}\n        </div>\n      </Scene>\n    )\n  })\n\n  return (\n    <XPController {...defaultControllerProps}>\n      <div>\n        {renderChildren}\n      </div>\n    </XPController>\n  )\n}\n\nexport default ReactScrollMagic`, `46368755893692785000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="tsx"\n              >\n                <span class="gatsby-code-button-language">tsx</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="tsx"><pre style="counter-reset: linenumber NaN" class="language-tsx line-numbers"><code class="language-tsx"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> Children<span class="token punctuation">,</span> cloneElement<span class="token punctuation">,</span> ReactElement <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react\'</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> Controller <span class="token keyword">as</span> XPController<span class="token punctuation">,</span> Scene<span class="token punctuation">,</span> SceneProps <span class="token keyword">as</span> XPSceneProps <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'xp-react-scrollmagic\'</span>\n\n<span class="token keyword">import</span> useStoreContext<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token constant">CLIENT_TYPE</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@/hooks/useStoreContext\'</span>\n\n<span class="token keyword">import</span> <span class="token punctuation">{</span> getWindowHeight <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@/utils\'</span>\n\n<span class="token keyword">const</span> defaultControllerProps <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token comment">// container: getDocument()?.querySelector(\'h\')</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">const</span> defaultSceneProps <span class="token operator">=</span> <span class="token punctuation">{</span>\n  indicators<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n  triggerHook<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>\n  duration<span class="token punctuation">:</span> <span class="token function">getWindowHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">interface</span> <span class="token class-name">ProgressEventsParams</span> <span class="token punctuation">{</span>\n  progress<span class="token punctuation">:</span> <span class="token builtin">number</span>\n  event<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    state<span class="token punctuation">:</span> <span class="token builtin">string</span>\n    <span class="token keyword">type</span><span class="token punctuation">:</span> <span class="token builtin">string</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">SceneProps</span> <span class="token punctuation">{</span>\n  sceneProps<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token punctuation">(</span>Partial<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">XPSceneProps</span></span><span class="token punctuation">></span></span><span class="token plain-text"> &amp; </span><span class="token punctuation">{</span> enableParams<span class="token punctuation">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">}</span><span class="token plain-text">) | null\n  sceneParams?: ProgressEventsParams\n}\n\ninterface ControllerProps </span><span class="token punctuation">{</span>\n  children<span class="token punctuation">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span>ReactElement<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">SceneProps</span></span><span class="token punctuation">></span></span><span class="token plain-text">> | ReactElement</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">SceneProps</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n}\n\nconst ReactScrollMagic = ({\n  children\n}: ControllerProps) => </span><span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> state <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useStoreContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n  <span class="token keyword">const</span> renderChildren <span class="token operator">=</span> Children<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>children<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> sceneProps <span class="token operator">=</span> <span class="token punctuation">{</span>\n      <span class="token operator">...</span>defaultSceneProps<span class="token punctuation">,</span>\n      pin<span class="token punctuation">:</span> state<span class="token operator">?</span><span class="token punctuation">.</span>clientType <span class="token operator">===</span> <span class="token constant">CLIENT_TYPE</span><span class="token punctuation">.</span><span class="token constant">PC</span><span class="token punctuation">,</span>\n      <span class="token operator">...</span>item<span class="token punctuation">.</span>props<span class="token punctuation">.</span>sceneProps\n    <span class="token punctuation">}</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>sceneProps<span class="token punctuation">.</span>enableParams<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> <span class="token punctuation">{</span>\n        enableParams<span class="token punctuation">,</span>\n        <span class="token operator">...</span>rest\n      <span class="token punctuation">}</span> <span class="token operator">=</span> sceneProps\n      <span class="token keyword">return</span> <span class="token punctuation">(</span>\n        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Scene</span></span>\n          <span class="token spread"><span class="token punctuation">{</span><span class="token punctuation">...</span><span class="token attr-value">rest</span><span class="token punctuation">}</span></span>\n        <span class="token punctuation">></span></span><span class="token plain-text">\n          </span><span class="token punctuation">{</span>\n            <span class="token punctuation">(</span><span class="token parameter">progress<span class="token punctuation">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> event<span class="token punctuation">:</span> <span class="token punctuation">{</span> state<span class="token punctuation">:</span> <span class="token builtin">string</span> <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n              <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">\n                </span><span class="token punctuation">{</span>\n                  <span class="token function">cloneElement</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n                    <span class="token operator">...</span>item<span class="token punctuation">.</span>props<span class="token punctuation">,</span>\n                    sceneParams<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n                      progress<span class="token punctuation">,</span>\n                      event\n                    <span class="token punctuation">}</span>\n                  <span class="token punctuation">}</span><span class="token punctuation">)</span>\n                <span class="token punctuation">}</span><span class="token plain-text">\n              </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>\n            <span class="token punctuation">}</span>\n          <span class="token punctuation">}</span><span class="token plain-text">\n        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Scene</span></span><span class="token punctuation">></span></span>\n      <span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">return</span> <span class="token punctuation">(</span>\n      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Scene</span></span>\n        <span class="token spread"><span class="token punctuation">{</span><span class="token punctuation">...</span><span class="token attr-value">sceneProps</span><span class="token punctuation">}</span></span>\n      <span class="token punctuation">></span></span><span class="token plain-text">\n        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">\n          </span><span class="token punctuation">{</span>item<span class="token punctuation">}</span><span class="token plain-text">\n        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Scene</span></span><span class="token punctuation">></span></span>\n    <span class="token punctuation">)</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span>\n\n  <span class="token keyword">return</span> <span class="token punctuation">(</span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">XPController</span></span> <span class="token spread"><span class="token punctuation">{</span><span class="token punctuation">...</span><span class="token attr-value">defaultControllerProps</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">\n        </span><span class="token punctuation">{</span>renderChildren<span class="token punctuation">}</span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">\n    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">XPController</span></span><span class="token punctuation">></span></span>\n  <span class="token punctuation">)</span>\n<span class="token punctuation">}</span><span class="token plain-text">\n\nexport default ReactScrollMagic</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>使用时：</p>\n<p>web/pages/p7/render.tsx</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="43005023150186710000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import ReactScrollMagic from \'@/components/reactScrollMagic\';\nimport { getWindowHeight } from \'@/utils\';\n\n<ReactScrollMagic>\n   <Sepa\n      sceneProps={{\n         enableParams: true,\n         duration: getWindowHeight() * 2 // 总共停 2 屏高度\n      }}\n   />\n</ReactScrollMagic>;`, `43005023150186710000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="tsx"\n              >\n                <span class="gatsby-code-button-language">tsx</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="tsx"><pre style="counter-reset: linenumber NaN" class="language-tsx line-numbers"><code class="language-tsx"><span class="token keyword">import</span> ReactScrollMagic <span class="token keyword">from</span> <span class="token string">\'@/components/reactScrollMagic\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> getWindowHeight <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@/utils\'</span><span class="token punctuation">;</span>\n\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">ReactScrollMagic</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n   </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Sepa</span></span>\n      <span class="token attr-name">sceneProps</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>\n         enableParams<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n         duration<span class="token punctuation">:</span> <span class="token function">getWindowHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span> <span class="token comment">// 总共停 2 屏高度</span>\n      <span class="token punctuation">}</span><span class="token punctuation">}</span></span>\n   <span class="token punctuation">/></span></span><span class="token plain-text">\n</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">ReactScrollMagic</span></span><span class="token punctuation">></span></span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>web/pages/p7/components/sepa/index.tsx</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="1071418499841092500"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import React from \'react\'\nimport { useTranslation } from \'react-i18next\'\nimport classNames from \'classnames\'\nimport { Tween, PlayState } from \'react-gsap\'\n\nimport { l } from \'@/components/lazyLoader\'\nimport ModelLeftText from \'@/components/modelLeftText\'\nimport { SceneProps } from \'@/components/reactScrollMagic\'\nimport AnimationBg from \'@/components/animationBg\'\n\nimport useTmpComponent from \'@/hooks/useTmpComponent\'\n\nimport { getAnimateProgresses } from \'@/utils/animate\'\n\nimport styles from \'./index.module.less\'\n\nconst Index = ({\n  sceneParams\n}: SceneProps) => {\n  const {\n    progress = 0\n  } = sceneParams || {}\n  const { t } = useTranslation()\n  const getValue = (param: string) => t(\\`p7.sepa.\\${param}\\`)\n\n  const { api, Slot } = useTmpComponent()\n\n  const [animationTextProgress] = getAnimateProgresses(progress, [\n    {\n      start: 1 / 2, // 滚动到一半的时候才开始动效\n      duration: 1 / 2 // 动效的持续百分比\n    }\n  ])\n\n  return (\n    <l.div\n      src=&quot;/public/p7/sepa/p7-p4-1.jpg&quot;\n      minSrcSet=&quot;/public/p7/sepa/p7-p4-1@mini.jpg&quot;\n      srcSet=&quot;/public/p7/sepa/p7-p4-1@2x.jpg&quot;\n      className={classNames(\'global-full-page-with-top-menu\', styles.container)}\n    >\n      <Slot\n        modelType=\'P7\'\n        pageType=\'SEPA\'\n        buttonType=\'Arrow\'\n        itemList={[{\n          imgList: [{\n            src: \'/public/p7/d3/P7-d3-1.png\',\n            srcSet: \'/public/p7/d3/P7-d3-1@2x.jpg\'\n          }],\n          background: \'linear-gradient(133deg, #343538 0%, #000102 100%)\',\n          textData: {\n            topSubTitle: t(\'p7.d3.topSubTitle1\'),\n            title: t(\'p7.d3.title1\'),\n            subTitle: t(\'p7.d3.subTitle1\')\n          }\n        }, {\n          imgList: [{\n            src: \'/public/p7/d3/P7-d3-2.jpg\',\n            srcSet: \'/public/p7/d3/P7-d3-2@2x.jpg\'\n          }],\n          background: \'linear-gradient(133deg, #343538 0%, #000102 100%)\',\n          textData: {\n            topSubTitle: t(\'p7.d3.topSubTitle2\'),\n            title: t(\'p7.d3.title2\'),\n            subTitle: t(\'p7.d3.subTitle2\')\n          }\n        }]}\n      />\n      <div ref={trackRef} className={classNames(\'body\', styles.body)}>\n        <ModelLeftText\n          topSubTitle={getValue(\'topSubTitle\')}\n          title={getValue(\'title\')}\n          subTitle={getValue(\'subTitle\')}\n          shortDesc={getValue(\'shortDesc\')}\n          buttonProps={{\n            onClick: () => {\n              api.current?.open()\n            },\n            type: \'ghost\'\n          }}\n        />\n      </div>\n      {\n        animationTextProgress > 0 && <AnimationBg type={2} className={styles.animationBg}>\n          <Tween\n            from={{\n              scale: 40\n            }}\n            totalProgress={animationTextProgress}\n            playState={PlayState.pause}\n          >\n            <div className={styles.animationText}>\n              {/* 这里所有国家都是这个，不需要国际化 */}\n              XPILOT\n            </div>\n          </Tween>\n        </AnimationBg>\n      }\n    </l.div>\n  )\n}\n\nexport default Index`, `1071418499841092500`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="tsx"\n              >\n                <span class="gatsby-code-button-language">tsx</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="tsx"><pre style="counter-reset: linenumber NaN" class="language-tsx line-numbers"><code class="language-tsx"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">\'react\'</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> useTranslation <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react-i18next\'</span>\n<span class="token keyword">import</span> classNames <span class="token keyword">from</span> <span class="token string">\'classnames\'</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> Tween<span class="token punctuation">,</span> PlayState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react-gsap\'</span>\n\n<span class="token keyword">import</span> <span class="token punctuation">{</span> l <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@/components/lazyLoader\'</span>\n<span class="token keyword">import</span> ModelLeftText <span class="token keyword">from</span> <span class="token string">\'@/components/modelLeftText\'</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> SceneProps <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@/components/reactScrollMagic\'</span>\n<span class="token keyword">import</span> AnimationBg <span class="token keyword">from</span> <span class="token string">\'@/components/animationBg\'</span>\n\n<span class="token keyword">import</span> useTmpComponent <span class="token keyword">from</span> <span class="token string">\'@/hooks/useTmpComponent\'</span>\n\n<span class="token keyword">import</span> <span class="token punctuation">{</span> getAnimateProgresses <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@/utils/animate\'</span>\n\n<span class="token keyword">import</span> styles <span class="token keyword">from</span> <span class="token string">\'./index.module.less\'</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">Index</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>\n  sceneParams\n<span class="token punctuation">}</span><span class="token punctuation">:</span> SceneProps</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span>\n    progress <span class="token operator">=</span> <span class="token number">0</span>\n  <span class="token punctuation">}</span> <span class="token operator">=</span> sceneParams <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> t <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useTranslation</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n  <span class="token keyword">const</span> <span class="token function-variable function">getValue</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">param<span class="token punctuation">:</span> <span class="token builtin">string</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">p7.sepa.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>param<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>\n\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> api<span class="token punctuation">,</span> Slot <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useTmpComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n  <span class="token keyword">const</span> <span class="token punctuation">[</span>animationTextProgress<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">getAnimateProgresses</span><span class="token punctuation">(</span>progress<span class="token punctuation">,</span> <span class="token punctuation">[</span>\n    <span class="token punctuation">{</span>\n      start<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token comment">// 滚动到一半的时候才开始动效</span>\n      duration<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token operator">/</span> <span class="token number">2</span> <span class="token comment">// 动效的持续百分比</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">]</span><span class="token punctuation">)</span>\n\n  <span class="token keyword">return</span> <span class="token punctuation">(</span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>l.div</span>\n      <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/public/p7/sepa/p7-p4-1.jpg<span class="token punctuation">"</span></span>\n      <span class="token attr-name">minSrcSet</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/public/p7/sepa/p7-p4-1@mini.jpg<span class="token punctuation">"</span></span>\n      <span class="token attr-name">srcSet</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/public/p7/sepa/p7-p4-1@2x.jpg<span class="token punctuation">"</span></span>\n      <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">classNames</span><span class="token punctuation">(</span><span class="token string">\'global-full-page-with-top-menu\'</span><span class="token punctuation">,</span> styles<span class="token punctuation">.</span>container<span class="token punctuation">)</span><span class="token punctuation">}</span></span>\n    <span class="token punctuation">></span></span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Slot</span></span>\n        <span class="token attr-name">modelType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">\'</span>P7<span class="token punctuation">\'</span></span>\n        <span class="token attr-name">pageType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">\'</span>SEPA<span class="token punctuation">\'</span></span>\n        <span class="token attr-name">buttonType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">\'</span>Arrow<span class="token punctuation">\'</span></span>\n        <span class="token attr-name">itemList</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">[</span><span class="token punctuation">{</span>\n          imgList<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>\n            src<span class="token punctuation">:</span> <span class="token string">\'/public/p7/d3/P7-d3-1.png\'</span><span class="token punctuation">,</span>\n            srcSet<span class="token punctuation">:</span> <span class="token string">\'/public/p7/d3/P7-d3-1@2x.jpg\'</span>\n          <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n          background<span class="token punctuation">:</span> <span class="token string">\'linear-gradient(133deg, #343538 0%, #000102 100%)\'</span><span class="token punctuation">,</span>\n          textData<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n            topSubTitle<span class="token punctuation">:</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token string">\'p7.d3.topSubTitle1\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n            title<span class="token punctuation">:</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token string">\'p7.d3.title1\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n            subTitle<span class="token punctuation">:</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token string">\'p7.d3.subTitle1\'</span><span class="token punctuation">)</span>\n          <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>\n          imgList<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>\n            src<span class="token punctuation">:</span> <span class="token string">\'/public/p7/d3/P7-d3-2.jpg\'</span><span class="token punctuation">,</span>\n            srcSet<span class="token punctuation">:</span> <span class="token string">\'/public/p7/d3/P7-d3-2@2x.jpg\'</span>\n          <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n          background<span class="token punctuation">:</span> <span class="token string">\'linear-gradient(133deg, #343538 0%, #000102 100%)\'</span><span class="token punctuation">,</span>\n          textData<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n            topSubTitle<span class="token punctuation">:</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token string">\'p7.d3.topSubTitle2\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n            title<span class="token punctuation">:</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token string">\'p7.d3.title2\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n            subTitle<span class="token punctuation">:</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token string">\'p7.d3.subTitle2\'</span><span class="token punctuation">)</span>\n          <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span>\n      <span class="token punctuation">/></span></span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>trackRef<span class="token punctuation">}</span></span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">classNames</span><span class="token punctuation">(</span><span class="token string">\'body\'</span><span class="token punctuation">,</span> styles<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">ModelLeftText</span></span>\n          <span class="token attr-name">topSubTitle</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token string">\'topSubTitle\'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span>\n          <span class="token attr-name">title</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token string">\'title\'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span>\n          <span class="token attr-name">subTitle</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token string">\'subTitle\'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span>\n          <span class="token attr-name">shortDesc</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token string">\'shortDesc\'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span>\n          <span class="token attr-name">buttonProps</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>\n            <span class="token function-variable function">onClick</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n              api<span class="token punctuation">.</span>current<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n            <span class="token punctuation">}</span><span class="token punctuation">,</span>\n            <span class="token keyword">type</span><span class="token punctuation">:</span> <span class="token string">\'ghost\'</span>\n          <span class="token punctuation">}</span><span class="token punctuation">}</span></span>\n        <span class="token punctuation">/></span></span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">\n      </span><span class="token punctuation">{</span>\n        animationTextProgress <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">AnimationBg</span></span> <span class="token attr-name">type</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token number">2</span><span class="token punctuation">}</span></span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>animationBg<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n          </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Tween</span></span>\n            <span class="token attr-name">from</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>\n              scale<span class="token punctuation">:</span> <span class="token number">40</span>\n            <span class="token punctuation">}</span><span class="token punctuation">}</span></span>\n            <span class="token attr-name">totalProgress</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>animationTextProgress<span class="token punctuation">}</span></span>\n            <span class="token attr-name">playState</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>PlayState<span class="token punctuation">.</span>pause<span class="token punctuation">}</span></span>\n          <span class="token punctuation">></span></span><span class="token plain-text">\n            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>animationText<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n              </span><span class="token punctuation">{</span><span class="token comment">/* 这里所有国家都是这个，不需要国际化 */</span><span class="token punctuation">}</span><span class="token plain-text">\n              XPILOT\n            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">\n          </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Tween</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">AnimationBg</span></span><span class="token punctuation">></span></span>\n      <span class="token punctuation">}</span><span class="token plain-text">\n    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>l.div</span><span class="token punctuation">></span></span>\n  <span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> Index</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="react-gsap-2"><a href="#react-gsap-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>react-gsap</h4>\n<p>后期需要实现 <code class="language-text">切屏 + 固定页面</code> 的效果，暂未实现</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="29072526676195287000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import React, { Children, cloneElement, useRef, useEffect, useState } from \'react\';\nimport { gsap } from \'gsap\';\nimport produce from \'immer\';\n\nimport { getDocument } from \'@/utils\';\n\nif (getDocument()) {\n   import(\'gsap/ScrollTrigger\').then((component) => {\n      const ScrollTrigger = component.default;\n      gsap.registerPlugin(ScrollTrigger);\n   });\n}\nconst ReactScrollMagic = ({ children }) => {\n   const revealRefs = useRef([]);\n   const [updateParams, setUpdateParams] = useState([]);\n   revealRefs.current = [];\n\n   useEffect(() => {\n      revealRefs.current.forEach((el, index) => {\n         gsap.from(el, {\n            scrollTrigger: {\n               trigger: el,\n               pin: true,\n               start: \'top top\',\n               end: \'+=300%\',\n               markers: true,\n               anticipatePin: 2, // 滑动过快时的“防抖”参数\n               onUpdate: (self) => {\n                  console.log(\n                     self,\n                     \'progress:\',\n                     self.isActive,\n                     self.progress.toFixed(3),\n                     \'direction:\',\n                     self.direction,\n                     \'velocity\',\n                     self.getVelocity()\n                  );\n                  const { progress, isActive } = self;\n                  setUpdateParams(\n                     produce((draftState) => {\n                        draftState[index] = {\n                           progress,\n                           isActive\n                        };\n                     })\n                  );\n               }\n            }\n         });\n      });\n   }, []);\n\n   const addToRefs = (el, index) => {\n      if (el && !revealRefs.current.includes(el)) {\n         revealRefs.current[index] = el;\n      }\n      console.log(revealRefs.current);\n   };\n\n   return Children.map(children, (item, index) => {\n      // const sceneProps = {\n      //   ...defaultSceneProps,\n      //   ...item.props.sceneProps\n      // }\n      return (\n         <div ref={(el) => addToRefs(el, index)}>\n            {cloneElement(item, {\n               ...item.props,\n               sceneParams: updateParams[index] || {}\n            })}\n         </div>\n      );\n   });\n};\n\nexport default ReactScrollMagic;`, `29072526676195287000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="tsx"\n              >\n                <span class="gatsby-code-button-language">tsx</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="tsx"><pre style="counter-reset: linenumber NaN" class="language-tsx line-numbers"><code class="language-tsx"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> Children<span class="token punctuation">,</span> cloneElement<span class="token punctuation">,</span> useRef<span class="token punctuation">,</span> useEffect<span class="token punctuation">,</span> useState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> gsap <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'gsap\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> produce <span class="token keyword">from</span> <span class="token string">\'immer\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> <span class="token punctuation">{</span> getDocument <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@/utils\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">\'gsap/ScrollTrigger\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">component</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> ScrollTrigger <span class="token operator">=</span> component<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">;</span>\n      gsap<span class="token punctuation">.</span><span class="token function">registerPlugin</span><span class="token punctuation">(</span>ScrollTrigger<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token keyword">const</span> <span class="token function-variable function">ReactScrollMagic</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> children <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   <span class="token keyword">const</span> revealRefs <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">const</span> <span class="token punctuation">[</span>updateParams<span class="token punctuation">,</span> setUpdateParams<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   revealRefs<span class="token punctuation">.</span>current <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n   <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      revealRefs<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n         gsap<span class="token punctuation">.</span><span class="token keyword">from</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n            scrollTrigger<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n               trigger<span class="token punctuation">:</span> el<span class="token punctuation">,</span>\n               pin<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n               start<span class="token punctuation">:</span> <span class="token string">\'top top\'</span><span class="token punctuation">,</span>\n               end<span class="token punctuation">:</span> <span class="token string">\'+=300%\'</span><span class="token punctuation">,</span>\n               markers<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n               anticipatePin<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token comment">// 滑动过快时的“防抖”参数</span>\n               <span class="token function-variable function">onUpdate</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">self</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n                  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>\n                     self<span class="token punctuation">,</span>\n                     <span class="token string">\'progress:\'</span><span class="token punctuation">,</span>\n                     self<span class="token punctuation">.</span>isActive<span class="token punctuation">,</span>\n                     self<span class="token punctuation">.</span>progress<span class="token punctuation">.</span><span class="token function">toFixed</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n                     <span class="token string">\'direction:\'</span><span class="token punctuation">,</span>\n                     self<span class="token punctuation">.</span>direction<span class="token punctuation">,</span>\n                     <span class="token string">\'velocity\'</span><span class="token punctuation">,</span>\n                     self<span class="token punctuation">.</span><span class="token function">getVelocity</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n                  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n                  <span class="token keyword">const</span> <span class="token punctuation">{</span> progress<span class="token punctuation">,</span> isActive <span class="token punctuation">}</span> <span class="token operator">=</span> self<span class="token punctuation">;</span>\n                  <span class="token function">setUpdateParams</span><span class="token punctuation">(</span>\n                     <span class="token function">produce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">draftState</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n                        draftState<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>\n                           progress<span class="token punctuation">,</span>\n                           isActive\n                        <span class="token punctuation">}</span><span class="token punctuation">;</span>\n                     <span class="token punctuation">}</span><span class="token punctuation">)</span>\n                  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n               <span class="token punctuation">}</span>\n            <span class="token punctuation">}</span>\n         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token keyword">const</span> <span class="token function-variable function">addToRefs</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>el <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>revealRefs<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         revealRefs<span class="token punctuation">.</span>current<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> el<span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>revealRefs<span class="token punctuation">.</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n   <span class="token keyword">return</span> Children<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>children<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token comment">// const sceneProps = {</span>\n      <span class="token comment">//   ...defaultSceneProps,</span>\n      <span class="token comment">//   ...item.props.sceneProps</span>\n      <span class="token comment">// }</span>\n      <span class="token keyword">return</span> <span class="token punctuation">(</span>\n         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token parameter">el</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">addToRefs</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n            </span><span class="token punctuation">{</span><span class="token function">cloneElement</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n               <span class="token operator">...</span>item<span class="token punctuation">.</span>props<span class="token punctuation">,</span>\n               sceneParams<span class="token punctuation">:</span> updateParams<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token plain-text">\n         </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>\n      <span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> ReactScrollMagic<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="运行效果-2"><a href="#%E8%BF%90%E8%A1%8C%E6%95%88%E6%9E%9C-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>运行效果</h3>\n<h4 id="react-scrollmagic-1"><a href="#react-scrollmagic-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>react-scrollmagic</h4>\n<!-- <iframe data-src="https://codesandbox.io/embed/6t81il?codemirror=1&hidenavigation=1&theme=light&view=preview" class="embedded-codesandbox" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe> --><html><head></head><body></body></html>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/nxqttn?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h4 id="react-gsap-3"><a href="#react-gsap-3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>react-gsap</h4>\n<!-- <iframe data-src="https://codesandbox.io/embed/jhqw77?codemirror=1&hidenavigation=1&theme=light&view=preview" class="embedded-codesandbox" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe> --><html><head></head><body></body></html>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/wjdr88?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h2 id="视频进度同步--缩放动效"><a href="#%E8%A7%86%E9%A2%91%E8%BF%9B%E5%BA%A6%E5%90%8C%E6%AD%A5--%E7%BC%A9%E6%94%BE%E5%8A%A8%E6%95%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>视频进度同步 / 缩放动效</h2>\n<h3 id="需求背景-4"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h3>\n<p>实现功能如下：</p>\n<ol>\n<li>页面往下完全滚动到第二屏时，视频开始播放，鼠标的滚动一段距离后，触发视频缩小到右下角视频的动效</li>\n<li>文字、图片有缩放效果</li>\n</ol>\n<p>实现要点如下：</p>\n<ol>\n<li>视频在视口范围内只会播放一次，完全离开视口重置播放进度，完全进入视口播放视频</li>\n<li>由 2 个视频拼接而成，触发缩放的瞬间进度需要同步（在视频未播放完成的情况下需要同步）</li>\n<li>过渡时需要使用 visibility 来控制显隐</li>\n</ol>\n<p>实现如下所示的动效：</p>\n<p><html><head></head><body><video data-src="/examples/international-official-website-technical-difficulties/video-sync-scale-play.mp4" loop="" muted="" autoplay="" width="100%" class="lazy"></video></body></html></video></p>\n<h3 id="选型过程-3"><a href="#%E9%80%89%E5%9E%8B%E8%BF%87%E7%A8%8B-3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>选型过程</h3>\n<p>同 <code class="language-text">逐行显示</code>、<code class="language-text">固定页面滚动控制</code> 的选型过程</p>\n<h3 id="核心代码-3"><a href="#%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81-3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>核心代码</h3>\n<p>web/pages/p7/components/learnMore/index.tsx</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="5718073810710811000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import React, { useState, useRef, useEffect } from \'react\'\nimport { useTranslation } from \'react-i18next\'\nimport classNames from \'classnames\'\nimport { useInViewport } from \'ahooks\'\nimport { isNumber } from \'lodash\'\n\nimport { SceneProps } from \'@/components/reactScrollMagic\'\nimport { l, VideoRef } from \'@/components/lazyLoader\'\n\nimport { getAnimateProgresses } from \'@/utils/animate\'\n\nimport useStoreContext, { CLIENT_TYPE } from \'@/hooks/useStoreContext\'\n\nimport ModelLearnMore from \'../modelLearnMore\'\n\nimport styles from \'./index.module.less\'\n\nexport type VisibleComponent = \'JsmpegPlayer\' | \'ModelLearnMore\'\n\nconst MAX_THRESHOLD = 0.99\nconst MIN_THRESHOLD = 0.01\nconst THRESHOLD = [MIN_THRESHOLD, MAX_THRESHOLD]\n\nconst Index = ({\n  sceneParams\n}: SceneProps) => {\n  const { t } = useTranslation()\n  const getValue = (param: string) => t(\\`p7.learnMore.\\${param}\\`)\n\n  const {\n    progress = 0\n  } = sceneParams || {}\n\n  const [modelLearnMoreProgress] = getAnimateProgresses(progress, [\n    {\n      start: 1 / 2,\n      duration: 1 / 2\n    }\n  ])\n\n  // 设置哪个组件可见\n  const [visibleComponent, setVisibleComponent] = useState<VisibleComponent>(\'JsmpegPlayer\')\n\n  const { state } = useStoreContext()\n\n  const videoRef = useRef<VideoRef>(null)\n  const miniVideoRef = useRef<VideoRef>(null)\n\n  const containerRef = useRef(null)\n  const [_, ratio] = useInViewport(containerRef, {\n    threshold: THRESHOLD\n  })\n\n  const [isPlayed, setIsPlayed] = useState(false)\n\n  useEffect(() => {\n    if (state?.clientType === CLIENT_TYPE.H5) {\n      return\n    }\n\n    const videoDom = videoRef.current?.getVideoElement()\n    const miniVideoDom = miniVideoRef.current?.getVideoElement()\n    if (!isNumber(ratio) || !videoDom || !miniVideoDom) {\n      return\n    }\n\n    if (ratio > MAX_THRESHOLD && !isPlayed && visibleComponent === \'JsmpegPlayer\') {\n      videoDom.play()\n      setIsPlayed(true)\n    }\n\n    if (ratio > MAX_THRESHOLD && !isPlayed && visibleComponent === \'ModelLearnMore\') {\n      miniVideoDom.play()\n      setIsPlayed(true)\n    }\n\n    if (ratio < MIN_THRESHOLD) {\n      videoDom.currentTime = 0\n      videoDom.pause()\n\n      miniVideoDom.currentTime = 0\n      miniVideoDom.pause()\n      setIsPlayed(false)\n    }\n  }, [ratio, visibleComponent, isPlayed])\n\n  useEffect(() => {\n    if (state?.clientType === CLIENT_TYPE.H5) {\n      return\n    }\n\n    const videoDom = videoRef.current?.getVideoElement()\n    const miniVideoDom = miniVideoRef.current?.getVideoElement()\n    if (!videoDom || !miniVideoDom) {\n      return\n    }\n\n    if (visibleComponent === \'ModelLearnMore\') {\n      miniVideoDom.currentTime = videoDom.currentTime\n      if (miniVideoDom.currentTime < miniVideoDom.duration) {\n        miniVideoDom.play()\n      }\n    } else {\n      videoDom.currentTime = miniVideoDom.currentTime\n      if (videoDom.currentTime < videoDom.duration) {\n        videoDom.play()\n      }\n    }\n  }, [visibleComponent])\n\n  let miniVideoProps = {\n    type: \'video\',\n    srcPoster: \'/public/p7/learn-more/p7-wing@mini.jpg\',\n    src: \'/public/p7/learn-more/p7-wing-origin-fast.mp4\'\n  }\n\n  if (state?.clientType === CLIENT_TYPE.PC) {\n    miniVideoProps = {\n      ...miniVideoProps,\n      loop: false,\n      autoPlay: false,\n      ref: miniVideoRef,\n      isNeedScale: true\n    }\n  }\n\n  return (\n    <div\n      ref={containerRef}\n      className={styles.container}\n    >\n      {\n        state?.clientType === CLIENT_TYPE.PC && <l.video\n          ref={videoRef}\n          loop={false}\n          autoPlay={false}\n          src=&quot;/public/p7/learn-more/p7-wing-origin-fast.mp4&quot;\n          className={classNames(styles.player, visibleComponent !== \'JsmpegPlayer\' ? styles.hidden : \'\')}\n        />\n      }\n      <ModelLearnMore\n        className={state?.clientType === CLIENT_TYPE.PC && visibleComponent !== \'ModelLearnMore\' ? styles.hidden : \'\'}\n        progress={state?.clientType === CLIENT_TYPE.PC ? modelLearnMoreProgress : 100}\n        modelCenterTextProps={{\n          topSubTitle: getValue(\'topSubTitle\'),\n          title: getValue(\'title\'),\n          subTitle: getValue(\'subTitle\'),\n          shortDesc: getValue(\'shortDesc\'),\n          buttonText: getValue(\'button\'),\n          animation: state?.clientType === CLIENT_TYPE.H5\n        }}\n        onSetVisibleComponent={setVisibleComponent}\n        displayersProps={[\n          {\n            src: \'/public/p7/learn-more/p7-p2-1.jpg\',\n            srcSet: \'/public/p7/learn-more/p7-p2-1@2x.jpg\'\n          },\n          {\n            src: \'/public/p7/learn-more/p7-p2-2.jpg\',\n            srcSet: \'/public/p7/learn-more/p7-p2-2@2x.jpg\',\n            minSrcSet: \'/public/p7/learn-more/p7-p2-2@mini.jpg\'\n          },\n          miniVideoProps\n        ]}\n        itemList={[\n          {\n            imgList: [{\n              src: \'/public/p7/d1/P7-d1-1-3.jpg\',\n              srcSet: \'/public/p7/d1/P7-d1-1-3@2x.jpg\'\n            }, {\n              src: \'/public/p7/d1/P7-d1-1-1.jpg\',\n              srcSet: \'/public/p7/d1/P7-d1-1-1@2x.jpg\'\n            }, {\n              src: \'/public/p7/d1/P7-d1-1-2.jpg\',\n              srcSet: \'/public/p7/d1/P7-d1-1-2@2x.jpg\'\n            }],\n            background: \'linear-gradient(133deg, #343538 0%, #000102 100%)\',\n            textData: {\n              topSubTitle: t(\'p7.d1.topSubTitle1\'),\n              title: t(\'p7.d1.title1\'),\n              subTitle: t(\'p7.d1.subTitle1\')\n            }\n          },\n          {\n            imgList: [{\n              src: \'/public/p7/d1/P7-d1-2-3.jpg\',\n              srcSet: \'/public/p7/d1/P7-d1-2-3@2x.jpg\'\n            }, {\n              src: \'/public/p7/d1/P7-d1-2-1.jpg\',\n              srcSet: \'/public/p7/d1/P7-d1-2-1@2x.jpg\'\n            }, {\n              src: \'/public/p7/d1/P7-d1-2-2.jpg\',\n              srcSet: \'/public/p7/d1/P7-d1-2-2@2x.jpg\'\n            }],\n            background: \'linear-gradient(133deg, #B6CBDA 0%, #7A97AF 100%)\',\n            textData: {\n              topSubTitle: t(\'p7.d1.topSubTitle2\'),\n              title: t(\'p7.d1.title2\'),\n              subTitle: t(\'p7.d1.subTitle2\')\n            }\n          },\n          {\n            imgList: [{\n              src: \'/public/p7/d1/P7-d1-3-1.mp4\'\n            }, {\n              src: \'/public/p7/d1/P7-d1-3-2.jpg\',\n              srcSet: \'/public/p7/d1/P7-d1-3-2@2x.jpg\'\n            }],\n            background: \'linear-gradient(133deg, #343538 0%, #000102 100%)\',\n            textData: {\n              topSubTitle: t(\'p7.d1.topSubTitle3\'),\n              title: t(\'p7.d1.title3\'),\n              subTitle: t(\'p7.d1.subTitle3\')\n            }\n          }\n        ]}\n      />\n    </div>\n  )\n}\n\nexport default Index`, `5718073810710811000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="tsx"\n              >\n                <span class="gatsby-code-button-language">tsx</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="tsx"><pre style="counter-reset: linenumber NaN" class="language-tsx line-numbers"><code class="language-tsx"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useState<span class="token punctuation">,</span> useRef<span class="token punctuation">,</span> useEffect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react\'</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> useTranslation <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react-i18next\'</span>\n<span class="token keyword">import</span> classNames <span class="token keyword">from</span> <span class="token string">\'classnames\'</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> useInViewport <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'ahooks\'</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> isNumber <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'lodash\'</span>\n\n<span class="token keyword">import</span> <span class="token punctuation">{</span> SceneProps <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@/components/reactScrollMagic\'</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> l<span class="token punctuation">,</span> VideoRef <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@/components/lazyLoader\'</span>\n\n<span class="token keyword">import</span> <span class="token punctuation">{</span> getAnimateProgresses <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@/utils/animate\'</span>\n\n<span class="token keyword">import</span> useStoreContext<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token constant">CLIENT_TYPE</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@/hooks/useStoreContext\'</span>\n\n<span class="token keyword">import</span> ModelLearnMore <span class="token keyword">from</span> <span class="token string">\'../modelLearnMore\'</span>\n\n<span class="token keyword">import</span> styles <span class="token keyword">from</span> <span class="token string">\'./index.module.less\'</span>\n\n<span class="token keyword">export</span> <span class="token keyword">type</span> VisibleComponent <span class="token operator">=</span> <span class="token string">\'JsmpegPlayer\'</span> <span class="token operator">|</span> <span class="token string">\'ModelLearnMore\'</span>\n\n<span class="token keyword">const</span> <span class="token constant">MAX_THRESHOLD</span> <span class="token operator">=</span> <span class="token number">0.99</span>\n<span class="token keyword">const</span> <span class="token constant">MIN_THRESHOLD</span> <span class="token operator">=</span> <span class="token number">0.01</span>\n<span class="token keyword">const</span> <span class="token constant">THRESHOLD</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token constant">MIN_THRESHOLD</span><span class="token punctuation">,</span> <span class="token constant">MAX_THRESHOLD</span><span class="token punctuation">]</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">Index</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>\n  sceneParams\n<span class="token punctuation">}</span><span class="token punctuation">:</span> SceneProps</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> t <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useTranslation</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n  <span class="token keyword">const</span> <span class="token function-variable function">getValue</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">param<span class="token punctuation">:</span> <span class="token builtin">string</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">p7.learnMore.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>param<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>\n\n  <span class="token keyword">const</span> <span class="token punctuation">{</span>\n    progress <span class="token operator">=</span> <span class="token number">0</span>\n  <span class="token punctuation">}</span> <span class="token operator">=</span> sceneParams <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n\n  <span class="token keyword">const</span> <span class="token punctuation">[</span>modelLearnMoreProgress<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">getAnimateProgresses</span><span class="token punctuation">(</span>progress<span class="token punctuation">,</span> <span class="token punctuation">[</span>\n    <span class="token punctuation">{</span>\n      start<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span>\n      duration<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token operator">/</span> <span class="token number">2</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">]</span><span class="token punctuation">)</span>\n\n  <span class="token comment">// 设置哪个组件可见</span>\n  <span class="token keyword">const</span> <span class="token punctuation">[</span>visibleComponent<span class="token punctuation">,</span> setVisibleComponent<span class="token punctuation">]</span> <span class="token operator">=</span> useState<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">VisibleComponent</span></span><span class="token punctuation">></span></span><span class="token plain-text">(\'JsmpegPlayer\')\n\n  const </span><span class="token punctuation">{</span> state <span class="token punctuation">}</span><span class="token plain-text"> = useStoreContext()\n\n  const videoRef = useRef</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">VideoRef</span></span><span class="token punctuation">></span></span><span class="token plain-text">(null)\n  const miniVideoRef = useRef</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">VideoRef</span></span><span class="token punctuation">></span></span><span class="token plain-text">(null)\n\n  const containerRef = useRef(null)\n  const [_, ratio] = useInViewport(containerRef, </span><span class="token punctuation">{</span>\n    threshold<span class="token punctuation">:</span> <span class="token constant">THRESHOLD</span>\n  <span class="token punctuation">}</span><span class="token plain-text">)\n\n  const [isPlayed, setIsPlayed] = useState(false)\n\n  useEffect(() => </span><span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>state<span class="token operator">?</span><span class="token punctuation">.</span>clientType <span class="token operator">===</span> <span class="token constant">CLIENT_TYPE</span><span class="token punctuation">.</span><span class="token constant">H5</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">const</span> videoDom <span class="token operator">=</span> videoRef<span class="token punctuation">.</span>current<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">getVideoElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token keyword">const</span> miniVideoDom <span class="token operator">=</span> miniVideoRef<span class="token punctuation">.</span>current<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">getVideoElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isNumber</span><span class="token punctuation">(</span>ratio<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span>videoDom <span class="token operator">||</span> <span class="token operator">!</span>miniVideoDom<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>ratio <span class="token operator">></span> <span class="token constant">MAX_THRESHOLD</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>isPlayed <span class="token operator">&amp;&amp;</span> visibleComponent <span class="token operator">===</span> <span class="token string">\'JsmpegPlayer\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      videoDom<span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n      <span class="token function">setIsPlayed</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>ratio <span class="token operator">></span> <span class="token constant">MAX_THRESHOLD</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>isPlayed <span class="token operator">&amp;&amp;</span> visibleComponent <span class="token operator">===</span> <span class="token string">\'ModelLearnMore\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      miniVideoDom<span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n      <span class="token function">setIsPlayed</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>ratio <span class="token operator">&lt;</span> <span class="token constant">MIN_THRESHOLD</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      videoDom<span class="token punctuation">.</span>currentTime <span class="token operator">=</span> <span class="token number">0</span>\n      videoDom<span class="token punctuation">.</span><span class="token function">pause</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n      miniVideoDom<span class="token punctuation">.</span>currentTime <span class="token operator">=</span> <span class="token number">0</span>\n      miniVideoDom<span class="token punctuation">.</span><span class="token function">pause</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n      <span class="token function">setIsPlayed</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token plain-text">, [ratio, visibleComponent, isPlayed])\n\n  useEffect(() => </span><span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>state<span class="token operator">?</span><span class="token punctuation">.</span>clientType <span class="token operator">===</span> <span class="token constant">CLIENT_TYPE</span><span class="token punctuation">.</span><span class="token constant">H5</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">const</span> videoDom <span class="token operator">=</span> videoRef<span class="token punctuation">.</span>current<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">getVideoElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token keyword">const</span> miniVideoDom <span class="token operator">=</span> miniVideoRef<span class="token punctuation">.</span>current<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">getVideoElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>videoDom <span class="token operator">||</span> <span class="token operator">!</span>miniVideoDom<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>visibleComponent <span class="token operator">===</span> <span class="token string">\'ModelLearnMore\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      miniVideoDom<span class="token punctuation">.</span>currentTime <span class="token operator">=</span> videoDom<span class="token punctuation">.</span>currentTime\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>miniVideoDom<span class="token punctuation">.</span>currentTime <span class="token operator">&lt;</span> miniVideoDom<span class="token punctuation">.</span>duration<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        miniVideoDom<span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n      videoDom<span class="token punctuation">.</span>currentTime <span class="token operator">=</span> miniVideoDom<span class="token punctuation">.</span>currentTime\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>videoDom<span class="token punctuation">.</span>currentTime <span class="token operator">&lt;</span> videoDom<span class="token punctuation">.</span>duration<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        videoDom<span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token plain-text">, [visibleComponent])\n\n  let miniVideoProps = </span><span class="token punctuation">{</span>\n    <span class="token keyword">type</span><span class="token punctuation">:</span> <span class="token string">\'video\'</span><span class="token punctuation">,</span>\n    srcPoster<span class="token punctuation">:</span> <span class="token string">\'/public/p7/learn-more/p7-wing@mini.jpg\'</span><span class="token punctuation">,</span>\n    src<span class="token punctuation">:</span> <span class="token string">\'/public/p7/learn-more/p7-wing-origin-fast.mp4\'</span>\n  <span class="token punctuation">}</span><span class="token plain-text">\n\n  if (state?.clientType === CLIENT_TYPE.PC) </span><span class="token punctuation">{</span>\n    miniVideoProps <span class="token operator">=</span> <span class="token punctuation">{</span>\n      <span class="token operator">...</span>miniVideoProps<span class="token punctuation">,</span>\n      loop<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n      autoPlay<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n      ref<span class="token punctuation">:</span> miniVideoRef<span class="token punctuation">,</span>\n      isNeedScale<span class="token punctuation">:</span> <span class="token boolean">true</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token plain-text">\n\n  return (\n    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span>\n      <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>containerRef<span class="token punctuation">}</span></span>\n      <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>container<span class="token punctuation">}</span></span>\n    <span class="token punctuation">></span></span><span class="token plain-text">\n      </span><span class="token punctuation">{</span>\n        state<span class="token operator">?</span><span class="token punctuation">.</span>clientType <span class="token operator">===</span> <span class="token constant">CLIENT_TYPE</span><span class="token punctuation">.</span><span class="token constant">PC</span> <span class="token operator">&amp;&amp;</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>l.video</span>\n          <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>videoRef<span class="token punctuation">}</span></span>\n          <span class="token attr-name">loop</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token boolean">false</span><span class="token punctuation">}</span></span>\n          <span class="token attr-name">autoPlay</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token boolean">false</span><span class="token punctuation">}</span></span>\n          <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/public/p7/learn-more/p7-wing-origin-fast.mp4<span class="token punctuation">"</span></span>\n          <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">classNames</span><span class="token punctuation">(</span>styles<span class="token punctuation">.</span>player<span class="token punctuation">,</span> visibleComponent <span class="token operator">!==</span> <span class="token string">\'JsmpegPlayer\'</span> <span class="token operator">?</span> styles<span class="token punctuation">.</span>hidden <span class="token punctuation">:</span> <span class="token string">\'\'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span>\n        <span class="token punctuation">/></span></span>\n      <span class="token punctuation">}</span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">ModelLearnMore</span></span>\n        <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>state<span class="token operator">?</span><span class="token punctuation">.</span>clientType <span class="token operator">===</span> <span class="token constant">CLIENT_TYPE</span><span class="token punctuation">.</span><span class="token constant">PC</span> <span class="token operator">&amp;&amp;</span> visibleComponent <span class="token operator">!==</span> <span class="token string">\'ModelLearnMore\'</span> <span class="token operator">?</span> styles<span class="token punctuation">.</span>hidden <span class="token punctuation">:</span> <span class="token string">\'\'</span><span class="token punctuation">}</span></span>\n        <span class="token attr-name">progress</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>state<span class="token operator">?</span><span class="token punctuation">.</span>clientType <span class="token operator">===</span> <span class="token constant">CLIENT_TYPE</span><span class="token punctuation">.</span><span class="token constant">PC</span> <span class="token operator">?</span> modelLearnMoreProgress <span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">}</span></span>\n        <span class="token attr-name">modelCenterTextProps</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>\n          topSubTitle<span class="token punctuation">:</span> <span class="token function">getValue</span><span class="token punctuation">(</span><span class="token string">\'topSubTitle\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n          title<span class="token punctuation">:</span> <span class="token function">getValue</span><span class="token punctuation">(</span><span class="token string">\'title\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n          subTitle<span class="token punctuation">:</span> <span class="token function">getValue</span><span class="token punctuation">(</span><span class="token string">\'subTitle\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n          shortDesc<span class="token punctuation">:</span> <span class="token function">getValue</span><span class="token punctuation">(</span><span class="token string">\'shortDesc\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n          buttonText<span class="token punctuation">:</span> <span class="token function">getValue</span><span class="token punctuation">(</span><span class="token string">\'button\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n          animation<span class="token punctuation">:</span> state<span class="token operator">?</span><span class="token punctuation">.</span>clientType <span class="token operator">===</span> <span class="token constant">CLIENT_TYPE</span><span class="token punctuation">.</span><span class="token constant">H5</span>\n        <span class="token punctuation">}</span><span class="token punctuation">}</span></span>\n        <span class="token attr-name">onSetVisibleComponent</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>setVisibleComponent<span class="token punctuation">}</span></span>\n        <span class="token attr-name">displayersProps</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">[</span>\n          <span class="token punctuation">{</span>\n            src<span class="token punctuation">:</span> <span class="token string">\'/public/p7/learn-more/p7-p2-1.jpg\'</span><span class="token punctuation">,</span>\n            srcSet<span class="token punctuation">:</span> <span class="token string">\'/public/p7/learn-more/p7-p2-1@2x.jpg\'</span>\n          <span class="token punctuation">}</span><span class="token punctuation">,</span>\n          <span class="token punctuation">{</span>\n            src<span class="token punctuation">:</span> <span class="token string">\'/public/p7/learn-more/p7-p2-2.jpg\'</span><span class="token punctuation">,</span>\n            srcSet<span class="token punctuation">:</span> <span class="token string">\'/public/p7/learn-more/p7-p2-2@2x.jpg\'</span><span class="token punctuation">,</span>\n            minSrcSet<span class="token punctuation">:</span> <span class="token string">\'/public/p7/learn-more/p7-p2-2@mini.jpg\'</span>\n          <span class="token punctuation">}</span><span class="token punctuation">,</span>\n          miniVideoProps\n        <span class="token punctuation">]</span><span class="token punctuation">}</span></span>\n        <span class="token attr-name">itemList</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">[</span>\n          <span class="token punctuation">{</span>\n            imgList<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>\n              src<span class="token punctuation">:</span> <span class="token string">\'/public/p7/d1/P7-d1-1-3.jpg\'</span><span class="token punctuation">,</span>\n              srcSet<span class="token punctuation">:</span> <span class="token string">\'/public/p7/d1/P7-d1-1-3@2x.jpg\'</span>\n            <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>\n              src<span class="token punctuation">:</span> <span class="token string">\'/public/p7/d1/P7-d1-1-1.jpg\'</span><span class="token punctuation">,</span>\n              srcSet<span class="token punctuation">:</span> <span class="token string">\'/public/p7/d1/P7-d1-1-1@2x.jpg\'</span>\n            <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>\n              src<span class="token punctuation">:</span> <span class="token string">\'/public/p7/d1/P7-d1-1-2.jpg\'</span><span class="token punctuation">,</span>\n              srcSet<span class="token punctuation">:</span> <span class="token string">\'/public/p7/d1/P7-d1-1-2@2x.jpg\'</span>\n            <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n            background<span class="token punctuation">:</span> <span class="token string">\'linear-gradient(133deg, #343538 0%, #000102 100%)\'</span><span class="token punctuation">,</span>\n            textData<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n              topSubTitle<span class="token punctuation">:</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token string">\'p7.d1.topSubTitle1\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n              title<span class="token punctuation">:</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token string">\'p7.d1.title1\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n              subTitle<span class="token punctuation">:</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token string">\'p7.d1.subTitle1\'</span><span class="token punctuation">)</span>\n            <span class="token punctuation">}</span>\n          <span class="token punctuation">}</span><span class="token punctuation">,</span>\n          <span class="token punctuation">{</span>\n            imgList<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>\n              src<span class="token punctuation">:</span> <span class="token string">\'/public/p7/d1/P7-d1-2-3.jpg\'</span><span class="token punctuation">,</span>\n              srcSet<span class="token punctuation">:</span> <span class="token string">\'/public/p7/d1/P7-d1-2-3@2x.jpg\'</span>\n            <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>\n              src<span class="token punctuation">:</span> <span class="token string">\'/public/p7/d1/P7-d1-2-1.jpg\'</span><span class="token punctuation">,</span>\n              srcSet<span class="token punctuation">:</span> <span class="token string">\'/public/p7/d1/P7-d1-2-1@2x.jpg\'</span>\n            <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>\n              src<span class="token punctuation">:</span> <span class="token string">\'/public/p7/d1/P7-d1-2-2.jpg\'</span><span class="token punctuation">,</span>\n              srcSet<span class="token punctuation">:</span> <span class="token string">\'/public/p7/d1/P7-d1-2-2@2x.jpg\'</span>\n            <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n            background<span class="token punctuation">:</span> <span class="token string">\'linear-gradient(133deg, #B6CBDA 0%, #7A97AF 100%)\'</span><span class="token punctuation">,</span>\n            textData<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n              topSubTitle<span class="token punctuation">:</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token string">\'p7.d1.topSubTitle2\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n              title<span class="token punctuation">:</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token string">\'p7.d1.title2\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n              subTitle<span class="token punctuation">:</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token string">\'p7.d1.subTitle2\'</span><span class="token punctuation">)</span>\n            <span class="token punctuation">}</span>\n          <span class="token punctuation">}</span><span class="token punctuation">,</span>\n          <span class="token punctuation">{</span>\n            imgList<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>\n              src<span class="token punctuation">:</span> <span class="token string">\'/public/p7/d1/P7-d1-3-1.mp4\'</span>\n            <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>\n              src<span class="token punctuation">:</span> <span class="token string">\'/public/p7/d1/P7-d1-3-2.jpg\'</span><span class="token punctuation">,</span>\n              srcSet<span class="token punctuation">:</span> <span class="token string">\'/public/p7/d1/P7-d1-3-2@2x.jpg\'</span>\n            <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n            background<span class="token punctuation">:</span> <span class="token string">\'linear-gradient(133deg, #343538 0%, #000102 100%)\'</span><span class="token punctuation">,</span>\n            textData<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n              topSubTitle<span class="token punctuation">:</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token string">\'p7.d1.topSubTitle3\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n              title<span class="token punctuation">:</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token string">\'p7.d1.title3\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n              subTitle<span class="token punctuation">:</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token string">\'p7.d1.subTitle3\'</span><span class="token punctuation">)</span>\n            <span class="token punctuation">}</span>\n          <span class="token punctuation">}</span>\n        <span class="token punctuation">]</span><span class="token punctuation">}</span></span>\n      <span class="token punctuation">/></span></span><span class="token plain-text">\n    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">\n  )\n}\n\nexport default Index</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>web/pages/p7/components/modelLearnMore/index.tsx</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="73413563154175480000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import React, { useEffect, useState, Dispatch, SetStateAction, useRef } from \'react\'\nimport classNames from \'classnames\'\nimport { Tween, PlayState, Timeline } from \'react-gsap\'\nimport { useSize } from \'ahooks\'\n\nimport { l, ImgProps, VideoProps } from \'@/components/lazyLoader\'\nimport XButton from \'@/components/xButton\'\nimport ModelCenterText, { ModelCenterTextProps } from \'@/components/modelCenterText\'\nimport AnimationBg from \'@/components/animationBg\'\n\nimport useTmpComponent, { ImgAndTextSwiperProps } from \'@/hooks/useTmpComponent\'\n\nimport { evaluateCalc, getDocument } from \'@/utils\'\n\nimport { VisibleComponent } from \'../../components/learnMore\'\n\nimport styles from \'./index.module.less\'\n\ntype Repeat<T, C extends number, U extends any[] = []> =\n  U[\'length\'] extends C ? U : Repeat<T, C, [...U, T]>\n\ntype DisplayerProps = ((ImgProps & { type?: \'img\'}) | (VideoProps & { type?: \'video\' })) & {\n  isNeedScale?: boolean\n}\n\ninterface ModelLearnMoreProps {\n  modelCenterTextProps: ModelCenterTextProps\n  displayersProps: Repeat<DisplayerProps, 3>\n  progress?: number\n  className?: string\n  onSetVisibleComponent?: Dispatch<SetStateAction<VisibleComponent>>\n}\n\nconst ModelLearnMore = ({\n  modelCenterTextProps,\n  displayersProps,\n  itemList = [],\n  progress = 0,\n  className,\n  onSetVisibleComponent\n}: ModelLearnMoreProps & ImgAndTextSwiperProps) => {\n  const { api, Slot } = useTmpComponent()\n\n  const getFromProps = () => {\n    const startBottom = \'calc((100vh - var(--top-menu-height) - 35.72916667rem) / 2 / 2)\'\n    const startRight = \'calc((100vw - 71.875rem - 0.520833rem) / 2 / 2)\'\n\n    return {\n      // 满屏高度减去顶部菜单减去外部容器高度，然后除以 2，得到下边距高度，最后还要由于外层放大，还要除以 2\n      // bottom: \'calc(0px - (100vh - var(--top-menu-height) - 35.72916667rem) / 2 / 2)\',\n      // right: \'calc(0px - (100vw - 71.875rem) / 2 / 2)\',\n      bottom: \\`-\\${evaluateCalc(startBottom)}px\\`,\n      right: \\`-\\${evaluateCalc(startRight)}px\\`,\n      width: \'calc(100vw - 0.520833rem)\',\n      height: \'100vh\',\n      scale: 0.5\n    }\n  }\n\n  const tweenRef = useRef(null)\n  const size = useSize(getDocument()?.documentElement)\n  useEffect(() => {\n    if (!tweenRef.current) {\n      return\n    }\n\n    tweenRef.current.getGSAP().vars = {\n      ...tweenRef.current.getGSAP().vars,\n      startAt: getFromProps()\n    }\n  }, [size])\n\n  const timerRef = useRef<NodeJS.Timeout>()\n  // 触发型动画，需要延迟控制组件的可见性，否则动画播放不全\n  useEffect(() => {\n    if (progress >= 0) {\n      onSetVisibleComponent && onSetVisibleComponent(\'ModelLearnMore\')\n    } else {\n      timerRef.current = setTimeout(() => {\n        onSetVisibleComponent && onSetVisibleComponent(\'JsmpegPlayer\')\n      }, 800)\n    }\n    return () => {\n      timerRef.current && clearTimeout(timerRef.current)\n    }\n  }, [progress])\n\n  const { buttonText, ...rest } = modelCenterTextProps\n  return (\n    <AnimationBg type={1} className={className}>\n      <Slot\n        itemList={itemList}\n        pageType = \'P7Wing\'\n        modelType=\'P7\'\n        buttonType=\'LearnMore\'\n      />\n      <div ref={ref} className={classNames(\'full-page-with-top-menu\', styles.container)}>\n        <Tween\n          from={{\n            scale: 2\n          }}\n          duration={0.8}\n          playState={progress > 0 ? PlayState.play : PlayState.reverse}\n        >\n          <div className={classNames(\'body\', styles.body)}>\n            <ModelCenterText\n              className={styles.titleContainer}\n              {...rest}\n            />\n            <div className={styles.displayerContainer}>\n              {\n                displayersProps.map((item, index) => {\n                  const {\n                    type = \'img\',\n                    isNeedScale,\n                    ...rest\n                  } = item\n                  const Component = l[type]\n                  if (isNeedScale) {\n                    return (\n                      <Timeline\n                        playState={progress > 0 ? PlayState.play : PlayState.reverse}\n                        target={\n                          <>\n                            <div className={styles[\\`displayerContainer\\${index + 1}\\`]}>\n                              <Component\n                                className={styles.displayer}\n                                {...rest}\n                              />\n                            </div>\n                          </>\n                        }\n                      >\n                        <Tween\n                          ref={tweenRef}\n                          from={getFromProps()}\n                          to={{\n                            width: \'23.65rem\',\n                            height: \'13.33rem\',\n                            bottom: 0,\n                            right: 0,\n                            scale: 1\n                          }}\n                          target={0}\n                        />\n                      </Timeline>\n                    )\n                  }\n                  return (<div className={styles[\\`displayerContainer\\${index + 1}\\`]}>\n                    <Component\n                      className={styles.displayer}\n                      {...rest}\n                    />\n                  </div>)\n                })\n              }\n            </div>\n            <XButton\n              type=&quot;primary&quot;\n              className={styles.button}\n              onClick={() => {\n                api.current?.open()\n              }\n              }\n            >\n              {buttonText}\n            </XButton>\n          </div>\n        </Tween>\n      </div>\n    </AnimationBg>\n  )\n}\n\nexport default ModelLearnMore`, `73413563154175480000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="tsx"\n              >\n                <span class="gatsby-code-button-language">tsx</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="tsx"><pre style="counter-reset: linenumber NaN" class="language-tsx line-numbers"><code class="language-tsx"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useEffect<span class="token punctuation">,</span> useState<span class="token punctuation">,</span> Dispatch<span class="token punctuation">,</span> SetStateAction<span class="token punctuation">,</span> useRef <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react\'</span>\n<span class="token keyword">import</span> classNames <span class="token keyword">from</span> <span class="token string">\'classnames\'</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> Tween<span class="token punctuation">,</span> PlayState<span class="token punctuation">,</span> Timeline <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react-gsap\'</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> useSize <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'ahooks\'</span>\n\n<span class="token keyword">import</span> <span class="token punctuation">{</span> l<span class="token punctuation">,</span> ImgProps<span class="token punctuation">,</span> VideoProps <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@/components/lazyLoader\'</span>\n<span class="token keyword">import</span> XButton <span class="token keyword">from</span> <span class="token string">\'@/components/xButton\'</span>\n<span class="token keyword">import</span> ModelCenterText<span class="token punctuation">,</span> <span class="token punctuation">{</span> ModelCenterTextProps <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@/components/modelCenterText\'</span>\n<span class="token keyword">import</span> AnimationBg <span class="token keyword">from</span> <span class="token string">\'@/components/animationBg\'</span>\n\n<span class="token keyword">import</span> useTmpComponent<span class="token punctuation">,</span> <span class="token punctuation">{</span> ImgAndTextSwiperProps <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@/hooks/useTmpComponent\'</span>\n\n<span class="token keyword">import</span> <span class="token punctuation">{</span> evaluateCalc<span class="token punctuation">,</span> getDocument <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@/utils\'</span>\n\n<span class="token keyword">import</span> <span class="token punctuation">{</span> VisibleComponent <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'../../components/learnMore\'</span>\n\n<span class="token keyword">import</span> styles <span class="token keyword">from</span> <span class="token string">\'./index.module.less\'</span>\n\n<span class="token keyword">type</span> Repeat<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token punctuation">,</span> <span class="token constant">C</span> <span class="token keyword">extends</span> <span class="token class-name">number</span><span class="token punctuation">,</span> <span class="token constant">U</span> <span class="token keyword">extends</span> <span class="token class-name">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span> <span class="token operator">=</span>\n  <span class="token constant">U</span><span class="token punctuation">[</span><span class="token string">\'length\'</span><span class="token punctuation">]</span> <span class="token keyword">extends</span> <span class="token class-name">C</span> <span class="token operator">?</span> <span class="token constant">U</span> <span class="token punctuation">:</span> Repeat<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token punctuation">,</span> <span class="token constant">C</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token operator">...</span><span class="token constant">U</span><span class="token punctuation">,</span> <span class="token constant">T</span><span class="token punctuation">]</span><span class="token operator">></span>\n\n<span class="token keyword">type</span> DisplayerProps <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ImgProps <span class="token operator">&amp;</span> <span class="token punctuation">{</span> <span class="token keyword">type</span><span class="token operator">?</span><span class="token punctuation">:</span> <span class="token string">\'img\'</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>VideoProps <span class="token operator">&amp;</span> <span class="token punctuation">{</span> <span class="token keyword">type</span><span class="token operator">?</span><span class="token punctuation">:</span> <span class="token string">\'video\'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">{</span>\n  isNeedScale<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">boolean</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">interface</span> <span class="token class-name">ModelLearnMoreProps</span> <span class="token punctuation">{</span>\n  modelCenterTextProps<span class="token punctuation">:</span> ModelCenterTextProps\n  displayersProps<span class="token punctuation">:</span> Repeat<span class="token operator">&lt;</span>DisplayerProps<span class="token punctuation">,</span> <span class="token number">3</span><span class="token operator">></span>\n  progress<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">number</span>\n  className<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">string</span>\n  onSetVisibleComponent<span class="token operator">?</span><span class="token punctuation">:</span> Dispatch<span class="token operator">&lt;</span>SetStateAction<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">VisibleComponent</span></span><span class="token punctuation">></span></span><span class="token plain-text">>\n}\n\nconst ModelLearnMore = ({\n  modelCenterTextProps,\n  displayersProps,\n  itemList = [],\n  progress = 0,\n  className,\n  onSetVisibleComponent\n}: ModelLearnMoreProps &amp; ImgAndTextSwiperProps) => </span><span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> api<span class="token punctuation">,</span> Slot <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useTmpComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n  <span class="token keyword">const</span> <span class="token function-variable function">getFromProps</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> startBottom <span class="token operator">=</span> <span class="token string">\'calc((100vh - var(--top-menu-height) - 35.72916667rem) / 2 / 2)\'</span>\n    <span class="token keyword">const</span> startRight <span class="token operator">=</span> <span class="token string">\'calc((100vw - 71.875rem - 0.520833rem) / 2 / 2)\'</span>\n\n    <span class="token keyword">return</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 满屏高度减去顶部菜单减去外部容器高度，然后除以 2，得到下边距高度，最后还要由于外层放大，还要除以 2</span>\n      <span class="token comment">// bottom: \'calc(0px - (100vh - var(--top-menu-height) - 35.72916667rem) / 2 / 2)\',</span>\n      <span class="token comment">// right: \'calc(0px - (100vw - 71.875rem) / 2 / 2)\',</span>\n      bottom<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">evaluateCalc</span><span class="token punctuation">(</span>startBottom<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n      right<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">evaluateCalc</span><span class="token punctuation">(</span>startRight<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n      width<span class="token punctuation">:</span> <span class="token string">\'calc(100vw - 0.520833rem)\'</span><span class="token punctuation">,</span>\n      height<span class="token punctuation">:</span> <span class="token string">\'100vh\'</span><span class="token punctuation">,</span>\n      scale<span class="token punctuation">:</span> <span class="token number">0.5</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">const</span> tweenRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>\n  <span class="token keyword">const</span> size <span class="token operator">=</span> <span class="token function">useSize</span><span class="token punctuation">(</span><span class="token function">getDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span>documentElement<span class="token punctuation">)</span>\n  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tweenRef<span class="token punctuation">.</span>current<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span>\n    <span class="token punctuation">}</span>\n\n    tweenRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">getGSAP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>vars <span class="token operator">=</span> <span class="token punctuation">{</span>\n      <span class="token operator">...</span>tweenRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">getGSAP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>vars<span class="token punctuation">,</span>\n      startAt<span class="token punctuation">:</span> <span class="token function">getFromProps</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>size<span class="token punctuation">]</span><span class="token punctuation">)</span>\n\n  <span class="token keyword">const</span> timerRef <span class="token operator">=</span> useRef<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">NodeJS.Timeout</span></span><span class="token punctuation">></span></span><span class="token plain-text">()\n  // 触发型动画，需要延迟控制组件的可见性，否则动画播放不全\n  useEffect(() => </span><span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>progress <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      onSetVisibleComponent <span class="token operator">&amp;&amp;</span> <span class="token function">onSetVisibleComponent</span><span class="token punctuation">(</span><span class="token string">\'ModelLearnMore\'</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n      timerRef<span class="token punctuation">.</span>current <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        onSetVisibleComponent <span class="token operator">&amp;&amp;</span> <span class="token function">onSetVisibleComponent</span><span class="token punctuation">(</span><span class="token string">\'JsmpegPlayer\'</span><span class="token punctuation">)</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">800</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      timerRef<span class="token punctuation">.</span>current <span class="token operator">&amp;&amp;</span> <span class="token function">clearTimeout</span><span class="token punctuation">(</span>timerRef<span class="token punctuation">.</span>current<span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token plain-text">, [progress])\n\n  const </span><span class="token punctuation">{</span> buttonText<span class="token punctuation">,</span> <span class="token operator">...</span>rest <span class="token punctuation">}</span><span class="token plain-text"> = modelCenterTextProps\n  return (\n    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">AnimationBg</span></span> <span class="token attr-name">type</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">}</span></span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>className<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n      &lt;Slot\n        itemList=</span><span class="token punctuation">{</span>itemList<span class="token punctuation">}</span><span class="token plain-text">\n        pageType = \'P7Wing\'\n        modelType=\'P7\'\n        buttonType=\'LearnMore\'\n      />\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>ref<span class="token punctuation">}</span></span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">classNames</span><span class="token punctuation">(</span><span class="token string">\'full-page-with-top-menu\'</span><span class="token punctuation">,</span> styles<span class="token punctuation">.</span>container<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Tween</span></span>\n          <span class="token attr-name">from</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>\n            scale<span class="token punctuation">:</span> <span class="token number">2</span>\n          <span class="token punctuation">}</span><span class="token punctuation">}</span></span>\n          <span class="token attr-name">duration</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token number">0.8</span><span class="token punctuation">}</span></span>\n          <span class="token attr-name">playState</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>progress <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">?</span> PlayState<span class="token punctuation">.</span>play <span class="token punctuation">:</span> PlayState<span class="token punctuation">.</span>reverse<span class="token punctuation">}</span></span>\n        <span class="token punctuation">></span></span><span class="token plain-text">\n          </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">classNames</span><span class="token punctuation">(</span><span class="token string">\'body\'</span><span class="token punctuation">,</span> styles<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">ModelCenterText</span></span>\n              <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>titleContainer<span class="token punctuation">}</span></span>\n              <span class="token spread"><span class="token punctuation">{</span><span class="token punctuation">...</span><span class="token attr-value">rest</span><span class="token punctuation">}</span></span>\n            <span class="token punctuation">/></span></span><span class="token plain-text">\n            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>displayerContainer<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n              </span><span class="token punctuation">{</span>\n                displayersProps<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n                  <span class="token keyword">const</span> <span class="token punctuation">{</span>\n                    <span class="token keyword">type</span> <span class="token operator">=</span> <span class="token string">\'img\'</span><span class="token punctuation">,</span>\n                    isNeedScale<span class="token punctuation">,</span>\n                    <span class="token operator">...</span>rest\n                  <span class="token punctuation">}</span> <span class="token operator">=</span> item\n                  <span class="token keyword">const</span> Component <span class="token operator">=</span> l<span class="token punctuation">[</span><span class="token keyword">type</span><span class="token punctuation">]</span>\n                  <span class="token keyword">if</span> <span class="token punctuation">(</span>isNeedScale<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                    <span class="token keyword">return</span> <span class="token punctuation">(</span>\n                      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Timeline</span></span>\n                        <span class="token attr-name">playState</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>progress <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">?</span> PlayState<span class="token punctuation">.</span>play <span class="token punctuation">:</span> PlayState<span class="token punctuation">.</span>reverse<span class="token punctuation">}</span></span>\n                        <span class="token attr-name">target</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>\n                          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n                            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">displayerContainer</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>index <span class="token operator">+</span> <span class="token number">1</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n                              </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Component</span></span>\n                                <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>displayer<span class="token punctuation">}</span></span>\n                                <span class="token spread"><span class="token punctuation">{</span><span class="token punctuation">...</span><span class="token attr-value">rest</span><span class="token punctuation">}</span></span>\n                              <span class="token punctuation">/></span></span><span class="token plain-text">\n                            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">\n                          </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span></span><span class="token punctuation">></span></span>\n                        <span class="token punctuation">}</span></span>\n                      <span class="token punctuation">></span></span><span class="token plain-text">\n                        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Tween</span></span>\n                          <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>tweenRef<span class="token punctuation">}</span></span>\n                          <span class="token attr-name">from</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">getFromProps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span>\n                          <span class="token attr-name">to</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>\n                            width<span class="token punctuation">:</span> <span class="token string">\'23.65rem\'</span><span class="token punctuation">,</span>\n                            height<span class="token punctuation">:</span> <span class="token string">\'13.33rem\'</span><span class="token punctuation">,</span>\n                            bottom<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>\n                            right<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>\n                            scale<span class="token punctuation">:</span> <span class="token number">1</span>\n                          <span class="token punctuation">}</span><span class="token punctuation">}</span></span>\n                          <span class="token attr-name">target</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span></span>\n                        <span class="token punctuation">/></span></span><span class="token plain-text">\n                      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Timeline</span></span><span class="token punctuation">></span></span>\n                    <span class="token punctuation">)</span>\n                  <span class="token punctuation">}</span>\n                  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">displayerContainer</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>index <span class="token operator">+</span> <span class="token number">1</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n                    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Component</span></span>\n                      <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>displayer<span class="token punctuation">}</span></span>\n                      <span class="token spread"><span class="token punctuation">{</span><span class="token punctuation">...</span><span class="token attr-value">rest</span><span class="token punctuation">}</span></span>\n                    <span class="token punctuation">/></span></span><span class="token plain-text">\n                  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token punctuation">)</span>\n                <span class="token punctuation">}</span><span class="token punctuation">)</span>\n              <span class="token punctuation">}</span><span class="token plain-text">\n            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">\n            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">XButton</span></span>\n              <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>primary<span class="token punctuation">"</span></span>\n              <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>button<span class="token punctuation">}</span></span>\n              <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n                api<span class="token punctuation">.</span>current<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n              <span class="token punctuation">}</span>\n              <span class="token punctuation">}</span></span>\n            <span class="token punctuation">></span></span><span class="token plain-text">\n              </span><span class="token punctuation">{</span>buttonText<span class="token punctuation">}</span><span class="token plain-text">\n            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">XButton</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n          </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">\n        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Tween</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">\n    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">AnimationBg</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n  )\n}\n\nexport default ModelLearnMore</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="优化"><a href="#%E4%BC%98%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>优化</h3>\n<h4 id="计算-calc-的实际-px-值"><a href="#%E8%AE%A1%E7%AE%97-calc-%E7%9A%84%E5%AE%9E%E9%99%85-px-%E5%80%BC" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>计算 calc 的实际 px 值</h4>\n<p>web/utils/index.ts</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="95890834291499530000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 只支持计算值为正值\nexport const evaluateCalc = (expression: string, container = getDocument()?.body) => {\n  // 不能加以下代码，影响动效\n  // if (!container || !Object.keys(container).length) {\n  //   return 0\n  // }\n  if (!__isBrowser__) {\n    return 0\n  }\n  const el = document.createElement(\'div\')\n  el.style.position = \'absolute\'\n  el.style.visibility = \'hidden\'\n  el.innerHTML = \\`<div style=&quot;width: \\${expression}&quot;></div>\\`\n  container.insertBefore(el, container.firstChild)\n  const calcPx = el.clientWidth\n  container.removeChild(el)\n  return calcPx\n}`, `95890834291499530000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="ts"\n              >\n                <span class="gatsby-code-button-language">ts</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="ts"><pre style="counter-reset: linenumber NaN" class="language-ts line-numbers"><code class="language-ts"><span class="token comment">// 只支持计算值为正值</span>\n<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">evaluateCalc</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">expression<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> container <span class="token operator">=</span> <span class="token function">getDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span>body</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token comment">// 不能加以下代码，影响动效</span>\n  <span class="token comment">// if (!container || !Object.keys(container).length) {</span>\n  <span class="token comment">//   return 0</span>\n  <span class="token comment">// }</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>__isBrowser__<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token number">0</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">const</span> el <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">\'div\'</span><span class="token punctuation">)</span>\n  el<span class="token punctuation">.</span>style<span class="token punctuation">.</span>position <span class="token operator">=</span> <span class="token string">\'absolute\'</span>\n  el<span class="token punctuation">.</span>style<span class="token punctuation">.</span>visibility <span class="token operator">=</span> <span class="token string">\'hidden\'</span>\n  el<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;div style="width: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>expression<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">">&lt;/div></span><span class="token template-punctuation string">`</span></span>\n  container<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> container<span class="token punctuation">.</span>firstChild<span class="token punctuation">)</span>\n  <span class="token keyword">const</span> calcPx <span class="token operator">=</span> el<span class="token punctuation">.</span>clientWidth\n  container<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span>\n  <span class="token keyword">return</span> calcPx\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="p7-resize-后动画定位不准的-bug"><a href="#p7-resize-%E5%90%8E%E5%8A%A8%E7%94%BB%E5%AE%9A%E4%BD%8D%E4%B8%8D%E5%87%86%E7%9A%84-bug" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>p7 resize 后动画定位不准的 bug</h4>\n<p>需要全部使用 rem 单位，否则 resize 后定位不准</p>\n<h3 id="运行效果-3"><a href="#%E8%BF%90%E8%A1%8C%E6%95%88%E6%9E%9C-3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>运行效果</h3>\n<!-- <iframe data-src="https://codesandbox.io/embed/2h37rw?codemirror=1&hidenavigation=1&theme=light&view=preview" class="embedded-codesandbox" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe> --><html><head></head><body></body></html>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/66xh38?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h2 id="序列帧滚动控制"><a href="#%E5%BA%8F%E5%88%97%E5%B8%A7%E6%BB%9A%E5%8A%A8%E6%8E%A7%E5%88%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>序列帧滚动控制</h2>\n<h3 id="需求背景-5"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h3>\n<p>实现如下所示动效，随着鼠标滚轮滚动播放视频或图片</p>\n<p><html><head></head><body><video data-src="/examples/international-official-website-technical-difficulties/video-frame-scroll-control.mp4" loop="" muted="" autoplay="" width="100%" class="lazy"></video></body></html></video></p>\n<h3 id="选型过程-4"><a href="#%E9%80%89%E5%9E%8B%E8%BF%87%E7%A8%8B-4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>选型过程</h3>\n<h4 id="视频方向"><a href="#%E8%A7%86%E9%A2%91%E6%96%B9%E5%90%91" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>视频方向</h4>\n<ol>\n<li>\n<p>video + av01、vp9、h264 编码的 mp4 视频（av01、vp9、h264 编码一一尝试，随着文件体积的增加，解码性能逐渐增加，但以 UI 给的视频素材测试 h264 在某些电脑比如苹果电脑上还是卡顿；在此过程中一旦使用 ffmpeg 压缩 UI 给的视频素材会导致卡顿，暂时未知是解码性能的原因还是使用了 currentTime 无法跳转到指定帧，只能跳转到关键帧，而关键帧之间并不是连续的流畅画面，fps 不平均的原因）</p>\n</li>\n<li>\n<p>ogv.js + vp9 编码的 webm 视频（解码速度较慢导致卡顿、随机跳转会报错且视频会卡住）</p>\n</li>\n<li>\n<p>提前将 video 的每一帧预渲染，可能效率较低，导致浏览器卡住，相关库：<a href="https://github.com/rnicholus/frame-grab.js" target="_blank" rel="nofollow noreferrer noopener">frame-grab</a>、<a href="https://github.com/wch1n/video-frame-previewer" target="_blank" rel="nofollow noreferrer noopener">video-frame-previewer</a>、<a href="https://github.com/feross/capture-frame" target="_blank" rel="nofollow noreferrer noopener">capture-frame</a></p>\n</li>\n<li>\n<p>jsmpeg + mpeg1 编码的 mpeg 视频（最新版本得不到总帧数、无法实现帧寻址、采用 ts 流导致不能立马跳转成功、实际使用 currentTime 无法跳成功等等缺点，故使用 v0.2 实现。缺点：同等画质下体积较大；颜色范围有限制 16~235，即不能纯白纯黑。优点：解码速度满足要求）</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="5539467434266587000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# ts 压缩\nffmpeg -i demo.mp4 -f mpegts -codec:v mpeg1video -b:v 1024k -bf 0 -r 20 -an demo@1024.ts\n\nffmpeg -i demo.mp4 -f mpeg1video -codec:v mpeg1video -b:v 1200k -bf 0 -r 20 -an demo.mpeg\n\n# mpeg 压缩\nffmpeg -i demo.mp4 -f mpeg1video -codec:v mpeg1video -b:v 2048k -bf 0 -r 30 -an demo@2048.mpeg\n\nffmpeg -i demo.mp4 -f mpeg1video -codec:v mpeg1video -b:v 2048k -maxrate:v 2048k -minrate:v 2048k -r 30 -an demo@2048.mpeg\n\n# mp4 压缩\nffmpeg -i p7-p3-1.mp4 -b:v 2048k -bf 0 -r 25 -an p7-p3-1@2048.mp4\n\nffmpeg -i p7-p3-1.mp4 -b:v 2048k -maxrate:v 2048k -minrate:v 2048k -r 25 -an p7-p3-1@2048.mp4\n\nffmpeg -i p7-p3-1.mp4 -b:v 2048k -maxrate:v 2048k -minrate:v 2048k -r 25 -an -movflags faststart p7-p3-1@2048.mp4\n\n# 批量压缩\n#!/bin/bash\nfor i in *.mp4\ndo\n  echo &quot;File \\$i selected&quot;\n  # ffmpeg -i &quot;\\$i&quot; &quot;\\$i.mp3&quot;\n  ffmpeg -i &quot;\\$i&quot; -b:v 2048k -maxrate:v 2048k -minrate:v 2048k -r 25 -an -movflags faststart &quot;\\$i.mp4&quot;\ndone`, `5539467434266587000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token comment"># ts 压缩</span>\nffmpeg -i demo.mp4 -f mpegts -codec:v mpeg1video -b:v 1024k -bf <span class="token number">0</span> -r <span class="token number">20</span> -an demo@1024.ts\n\nffmpeg -i demo.mp4 -f mpeg1video -codec:v mpeg1video -b:v 1200k -bf <span class="token number">0</span> -r <span class="token number">20</span> -an demo.mpeg\n\n<span class="token comment"># mpeg 压缩</span>\nffmpeg -i demo.mp4 -f mpeg1video -codec:v mpeg1video -b:v 2048k -bf <span class="token number">0</span> -r <span class="token number">30</span> -an demo@2048.mpeg\n\nffmpeg -i demo.mp4 -f mpeg1video -codec:v mpeg1video -b:v 2048k -maxrate:v 2048k -minrate:v 2048k -r <span class="token number">30</span> -an demo@2048.mpeg\n\n<span class="token comment"># mp4 压缩</span>\nffmpeg -i p7-p3-1.mp4 -b:v 2048k -bf <span class="token number">0</span> -r <span class="token number">25</span> -an p7-p3-1@2048.mp4\n\nffmpeg -i p7-p3-1.mp4 -b:v 2048k -maxrate:v 2048k -minrate:v 2048k -r <span class="token number">25</span> -an p7-p3-1@2048.mp4\n\nffmpeg -i p7-p3-1.mp4 -b:v 2048k -maxrate:v 2048k -minrate:v 2048k -r <span class="token number">25</span> -an -movflags faststart p7-p3-1@2048.mp4\n\n<span class="token comment"># 批量压缩</span>\n<span class="token comment">#!/bin/bash</span>\n<span class="token keyword">for</span> <span class="token for-or-select variable">i</span> <span class="token keyword">in</span> *.mp4\n<span class="token keyword">do</span>\n  <span class="token builtin class-name">echo</span> <span class="token string">"File <span class="token variable">$i</span> selected"</span>\n  <span class="token comment"># ffmpeg -i "$i" "$i.mp3"</span>\n  ffmpeg -i <span class="token string">"<span class="token variable">$i</span>"</span> -b:v 2048k -maxrate:v 2048k -minrate:v 2048k -r <span class="token number">25</span> -an -movflags faststart <span class="token string">"<span class="token variable">$i</span>.mp4"</span>\n<span class="token keyword">done</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n</ol>\n<h4 id="图片方向"><a href="#%E5%9B%BE%E7%89%87%E6%96%B9%E5%90%91" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>图片方向</h4>\n<ol>\n<li>预加载所有图片 + 图片序列帧（参考张博客，体积较大）</li>\n<li>pixi-apngAndGif，使用 apng 控制播放进度（体积太大）</li>\n<li>针对方案 1，使用 avif + avif.js，暂时未知解码性能如何，猜测同样都是 av1 解码，可能解码性能不行；</li>\n<li>针对方案 1，使用 webp，解码性能同样可能不行</li>\n<li>针对方案 1，使用 jpg</li>\n</ol>\n<h3 id="核心代码-4"><a href="#%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81-4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>核心代码</h3>\n<h4 id="pixi-apngandgif"><a href="#pixi-apngandgif" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>pixi-apngAndGif</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="68033712090898964000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import React, { useEffect, useRef, useState } from \'react\'\nimport { InputNumber } from \'antd\'\n\nimport XButton from \'@/components/xButton\'\n\nconst Index = () => {\n  const domRef = useRef(null)\n  const [apngApi, setApngApi] = useState()\n  const [value, setValue] = useState(0)\n\n  useEffect(() => {\n    import(\'@/lib/pixi-apng\').then((pixiApng) => {\n      const PixiApng = pixiApng.default\n      const { PIXI } = pixiApng\n      const app = new PIXI.Application({\n        width: domRef.current?.width,\n        height: domRef.current?.height,\n        view: domRef.current,\n        transparent: true,\n        antialias: true\n      })\n      const loader = PIXI.Loader.shared\n      const loadOption = {\n        loadType: PIXI.LoaderResource.LOAD_TYPE.XHR,\n        xhrType: PIXI.LoaderResource.XHR_RESPONSE_TYPE.BUFFER,\n        crossOrigin: \'\'\n      }\n      const imgs = {\n        apng: \'/public/demo/demo.png\'\n      }\n      loader.add(imgs.apng, loadOption)\n\n      loader.load((progress, resources) => {\n        const apngApi = new PixiApng(imgs.apng, resources)\n        setApngApi(apngApi)\n        const apngSprite = apngApi.sprite\n\n        apngSprite.x = 0\n        apngSprite.y = 0\n\n        apngSprite.width = 1000\n        apngSprite.height = 500\n\n        app.stage.addChild(apngSprite)\n      })\n    })\n  }, [])\n\n  return (\n    <div style={{ marginTop: 100, width: 1920, height: 1080 }}>\n      <XButton onClick={() => {\n        apngApi.play()\n      }}>\n        开始\n      </XButton>\n      <XButton onClick={() => {\n        apngApi.pause()\n      }}>\n        停止\n      </XButton>\n      <XButton onClick={() => {\n        apngApi.stop()\n      }}>\n        终止\n      </XButton>\n      <InputNumber value={value} onChange={setValue} precision={0} />\n      <XButton onClick={() => {\n        apngApi.jumpToFrame(value)\n      }}>\n        停到第几帧\n      </XButton>\n      <XButton onClick={() => {\n        window.alert(apngApi.getDuration())\n      }}>\n        时长\n      </XButton>\n      <XButton onClick={() => {\n        window.alert(apngApi.getFramesLength())\n      }}>\n        帧数\n      </XButton>\n      <canvas ref={domRef} width=&quot;1920&quot; height=&quot;1080&quot;></canvas>\n    </div>\n  )\n}\n\nexport default Index`, `68033712090898964000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="tsx"\n              >\n                <span class="gatsby-code-button-language">tsx</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="tsx"><pre style="counter-reset: linenumber NaN" class="language-tsx line-numbers"><code class="language-tsx"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useEffect<span class="token punctuation">,</span> useRef<span class="token punctuation">,</span> useState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react\'</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> InputNumber <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'antd\'</span>\n\n<span class="token keyword">import</span> XButton <span class="token keyword">from</span> <span class="token string">\'@/components/xButton\'</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">Index</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> domRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>\n  <span class="token keyword">const</span> <span class="token punctuation">[</span>apngApi<span class="token punctuation">,</span> setApngApi<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n  <span class="token keyword">const</span> <span class="token punctuation">[</span>value<span class="token punctuation">,</span> setValue<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>\n\n  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">\'@/lib/pixi-apng\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">pixiApng</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> PixiApng <span class="token operator">=</span> pixiApng<span class="token punctuation">.</span><span class="token keyword">default</span>\n      <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token constant">PIXI</span> <span class="token punctuation">}</span> <span class="token operator">=</span> pixiApng\n      <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PIXI<span class="token punctuation">.</span>Application</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n        width<span class="token punctuation">:</span> domRef<span class="token punctuation">.</span>current<span class="token operator">?</span><span class="token punctuation">.</span>width<span class="token punctuation">,</span>\n        height<span class="token punctuation">:</span> domRef<span class="token punctuation">.</span>current<span class="token operator">?</span><span class="token punctuation">.</span>height<span class="token punctuation">,</span>\n        view<span class="token punctuation">:</span> domRef<span class="token punctuation">.</span>current<span class="token punctuation">,</span>\n        transparent<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n        antialias<span class="token punctuation">:</span> <span class="token boolean">true</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span>\n      <span class="token keyword">const</span> loader <span class="token operator">=</span> <span class="token constant">PIXI</span><span class="token punctuation">.</span>Loader<span class="token punctuation">.</span>shared\n      <span class="token keyword">const</span> loadOption <span class="token operator">=</span> <span class="token punctuation">{</span>\n        loadType<span class="token punctuation">:</span> <span class="token constant">PIXI</span><span class="token punctuation">.</span>LoaderResource<span class="token punctuation">.</span><span class="token constant">LOAD_TYPE</span><span class="token punctuation">.</span><span class="token constant">XHR</span><span class="token punctuation">,</span>\n        xhrType<span class="token punctuation">:</span> <span class="token constant">PIXI</span><span class="token punctuation">.</span>LoaderResource<span class="token punctuation">.</span><span class="token constant">XHR_RESPONSE_TYPE</span><span class="token punctuation">.</span><span class="token constant">BUFFER</span><span class="token punctuation">,</span>\n        crossOrigin<span class="token punctuation">:</span> <span class="token string">\'\'</span>\n      <span class="token punctuation">}</span>\n      <span class="token keyword">const</span> imgs <span class="token operator">=</span> <span class="token punctuation">{</span>\n        apng<span class="token punctuation">:</span> <span class="token string">\'/public/demo/demo.png\'</span>\n      <span class="token punctuation">}</span>\n      loader<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>imgs<span class="token punctuation">.</span>apng<span class="token punctuation">,</span> loadOption<span class="token punctuation">)</span>\n\n      loader<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">progress<span class="token punctuation">,</span> resources</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token keyword">const</span> apngApi <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PixiApng</span><span class="token punctuation">(</span>imgs<span class="token punctuation">.</span>apng<span class="token punctuation">,</span> resources<span class="token punctuation">)</span>\n        <span class="token function">setApngApi</span><span class="token punctuation">(</span>apngApi<span class="token punctuation">)</span>\n        <span class="token keyword">const</span> apngSprite <span class="token operator">=</span> apngApi<span class="token punctuation">.</span>sprite\n\n        apngSprite<span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token number">0</span>\n        apngSprite<span class="token punctuation">.</span>y <span class="token operator">=</span> <span class="token number">0</span>\n\n        apngSprite<span class="token punctuation">.</span>width <span class="token operator">=</span> <span class="token number">1000</span>\n        apngSprite<span class="token punctuation">.</span>height <span class="token operator">=</span> <span class="token number">500</span>\n\n        app<span class="token punctuation">.</span>stage<span class="token punctuation">.</span><span class="token function">addChild</span><span class="token punctuation">(</span>apngSprite<span class="token punctuation">)</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n\n  <span class="token keyword">return</span> <span class="token punctuation">(</span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">style</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> marginTop<span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">,</span> width<span class="token punctuation">:</span> <span class="token number">1920</span><span class="token punctuation">,</span> height<span class="token punctuation">:</span> <span class="token number">1080</span> <span class="token punctuation">}</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">XButton</span></span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        apngApi<span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n      <span class="token punctuation">}</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n        开始\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">XButton</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">XButton</span></span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        apngApi<span class="token punctuation">.</span><span class="token function">pause</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n      <span class="token punctuation">}</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n        停止\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">XButton</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">XButton</span></span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        apngApi<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n      <span class="token punctuation">}</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n        终止\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">XButton</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">InputNumber</span></span> <span class="token attr-name">value</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>value<span class="token punctuation">}</span></span> <span class="token attr-name">onChange</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>setValue<span class="token punctuation">}</span></span> <span class="token attr-name">precision</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">XButton</span></span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        apngApi<span class="token punctuation">.</span><span class="token function">jumpToFrame</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>\n      <span class="token punctuation">}</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n        停到第几帧\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">XButton</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">XButton</span></span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        window<span class="token punctuation">.</span><span class="token function">alert</span><span class="token punctuation">(</span>apngApi<span class="token punctuation">.</span><span class="token function">getDuration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n      <span class="token punctuation">}</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n        时长\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">XButton</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">XButton</span></span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        window<span class="token punctuation">.</span><span class="token function">alert</span><span class="token punctuation">(</span>apngApi<span class="token punctuation">.</span><span class="token function">getFramesLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n      <span class="token punctuation">}</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n        帧数\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">XButton</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>canvas</span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>domRef<span class="token punctuation">}</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>1920<span class="token punctuation">"</span></span> <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>1080<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>canvas</span><span class="token punctuation">></span></span><span class="token plain-text">\n    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>\n  <span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> Index</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="ogvjs"><a href="#ogvjs" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ogv.js</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="33550432816205156000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import React, { useRef, useEffect, useState } from \'react\';\nimport classNames from \'classnames\';\nimport { useInViewport, useAsyncEffect } from \'ahooks\';\n\nimport { loadScript } from \'@/utils\';\n\nimport styles from \'./index.module.less\';\n\ninterface JsmpegPlayerProps {\n   src: string;\n   progress?: number; // 播放进度，0~1\n   className?: string;\n   autoplay?: boolean;\n   loop?: boolean;\n   seekable?: boolean;\n   preserveDrawingBuffer?: boolean;\n}\n\n// https://github.com/phoboslab/jsmpeg/tree/v0.2\nconst JsmpegPlayer = ({ src, progress, className, ...rest }: JsmpegPlayerProps) => {\n   const [isLoad, setIsLoad] = useState(true);\n   const [isLoadJsmpeg, setIsLoadJsmpeg] = useState(true);\n   const playerRef = useRef();\n   const domRef = useRef(null);\n\n   useAsyncEffect(async () => {\n      await loadScript(\'/public/lib/ogvjs-1.8.6/ogv.js\');\n      setIsLoadJsmpeg(false);\n   }, []);\n\n   const [inViewPort] = useInViewport(domRef);\n   useEffect(() => {\n      if (!inViewPort || isLoadJsmpeg || !isLoad) {\n         return;\n      }\n      // eslint-disable-next-line new-cap\n      playerRef.current = new window.OGVPlayer({\n         wasm: true, // force,\n         simd: true // experimental\n         // threading: true\n      });\n      domRef.current.appendChild(playerRef.current);\n      playerRef.current.muted = true;\n      playerRef.current.src = src;\n      playerRef.current.addEventListener(\'loadedmetadata\', () => {\n         setIsLoad(false);\n      });\n   }, [inViewPort, isLoadJsmpeg]);\n\n   useEffect(() => {\n      if (isLoad || typeof progress !== \'number\') {\n         return;\n      }\n      const calcProgress = progress < 0 ? 0 : progress > 1 ? 1 : progress;\n      console.log(\'calcProgress\', calcProgress);\n      playerRef.current.currentTime = calcProgress * playerRef.current.duration;\n   }, [progress, isLoad]);\n\n   return <div ref={domRef}></div>;\n};\n\nexport default JsmpegPlayer;`, `33550432816205156000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="tsx"\n              >\n                <span class="gatsby-code-button-language">tsx</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="tsx"><pre style="counter-reset: linenumber NaN" class="language-tsx line-numbers"><code class="language-tsx"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useRef<span class="token punctuation">,</span> useEffect<span class="token punctuation">,</span> useState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> classNames <span class="token keyword">from</span> <span class="token string">\'classnames\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> useInViewport<span class="token punctuation">,</span> useAsyncEffect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'ahooks\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> <span class="token punctuation">{</span> loadScript <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@/utils\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> styles <span class="token keyword">from</span> <span class="token string">\'./index.module.less\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">interface</span> <span class="token class-name">JsmpegPlayerProps</span> <span class="token punctuation">{</span>\n   src<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>\n   progress<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span> <span class="token comment">// 播放进度，0~1</span>\n   className<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>\n   autoplay<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>\n   loop<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>\n   seekable<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>\n   preserveDrawingBuffer<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// https://github.com/phoboslab/jsmpeg/tree/v0.2</span>\n<span class="token keyword">const</span> <span class="token function-variable function">JsmpegPlayer</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> src<span class="token punctuation">,</span> progress<span class="token punctuation">,</span> className<span class="token punctuation">,</span> <span class="token operator">...</span>rest <span class="token punctuation">}</span><span class="token punctuation">:</span> JsmpegPlayerProps</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   <span class="token keyword">const</span> <span class="token punctuation">[</span>isLoad<span class="token punctuation">,</span> setIsLoad<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">const</span> <span class="token punctuation">[</span>isLoadJsmpeg<span class="token punctuation">,</span> setIsLoadJsmpeg<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">const</span> playerRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">const</span> domRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token function">useAsyncEffect</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">await</span> <span class="token function">loadScript</span><span class="token punctuation">(</span><span class="token string">\'/public/lib/ogvjs-1.8.6/ogv.js\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token function">setIsLoadJsmpeg</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token keyword">const</span> <span class="token punctuation">[</span>inViewPort<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useInViewport</span><span class="token punctuation">(</span>domRef<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>inViewPort <span class="token operator">||</span> isLoadJsmpeg <span class="token operator">||</span> <span class="token operator">!</span>isLoad<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token keyword">return</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      <span class="token comment">// eslint-disable-next-line new-cap</span>\n      playerRef<span class="token punctuation">.</span>current <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">window<span class="token punctuation">.</span>OGVPlayer</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n         wasm<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// force,</span>\n         simd<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token comment">// experimental</span>\n         <span class="token comment">// threading: true</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      domRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>playerRef<span class="token punctuation">.</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      playerRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span>muted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n      playerRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span>src <span class="token operator">=</span> src<span class="token punctuation">;</span>\n      playerRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">\'loadedmetadata\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n         <span class="token function">setIsLoad</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>inViewPort<span class="token punctuation">,</span> isLoadJsmpeg<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>isLoad <span class="token operator">||</span> <span class="token keyword">typeof</span> progress <span class="token operator">!==</span> <span class="token string">\'number\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token keyword">return</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      <span class="token keyword">const</span> calcProgress <span class="token operator">=</span> progress <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token punctuation">:</span> progress <span class="token operator">></span> <span class="token number">1</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token punctuation">:</span> progress<span class="token punctuation">;</span>\n      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'calcProgress\'</span><span class="token punctuation">,</span> calcProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      playerRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span>currentTime <span class="token operator">=</span> calcProgress <span class="token operator">*</span> playerRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span>duration<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>progress<span class="token punctuation">,</span> isLoad<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>domRef<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> JsmpegPlayer<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="video"><a href="#video" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>video</h4>\n<p>web/components/lazyLoader/components/video/components/core/hooks/useProgressControl.ts</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="4306419717620091400"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import { useEffect, useState } from \'react\';\n\nimport { CommonProps } from \'../index\';\n\nexport interface UseProgressControlProps {\n   progress?: number;\n   playStrategy?: \'progressControl\';\n}\n\nconst useProgressControl = ({\n   progress,\n   playStrategy,\n   onSetVideoProps,\n   domRef\n}: UseProgressControlProps & CommonProps) => {\n   const [isLoad, setIsLoad] = useState(true);\n   const [duration, setDuration] = useState(0);\n\n   const handleLoadedMetadata = () => {\n      const { duration } = domRef.current;\n      setDuration(duration);\n      setIsLoad(false);\n   };\n\n   useEffect(() => {\n      if (isLoad || typeof progress !== \'number\' || playStrategy !== \'progressControl\') {\n         return;\n      }\n\n      const calcProgress = progress < 0 ? 0 : progress > 1 ? 1 : progress;\n      domRef.current.currentTime = calcProgress * duration;\n   }, [progress, isLoad]);\n\n   useEffect(() => {\n      if (playStrategy === \'progressControl\') {\n         onSetVideoProps({\n            muted: true,\n            playsInline: true,\n            preload: \'metadata\'\n         });\n      }\n   }, [playStrategy]);\n\n   return {\n      handleLoadedMetadata\n   };\n};\n\nexport default useProgressControl;`, `4306419717620091400`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="ts"\n              >\n                <span class="gatsby-code-button-language">ts</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="ts"><pre style="counter-reset: linenumber NaN" class="language-ts line-numbers"><code class="language-ts"><span class="token keyword">import</span> <span class="token punctuation">{</span> useEffect<span class="token punctuation">,</span> useState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> <span class="token punctuation">{</span> CommonProps <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'../index\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">UseProgressControlProps</span> <span class="token punctuation">{</span>\n   progress<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>\n   playStrategy<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token string">\'progressControl\'</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">useProgressControl</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>\n   progress<span class="token punctuation">,</span>\n   playStrategy<span class="token punctuation">,</span>\n   onSetVideoProps<span class="token punctuation">,</span>\n   domRef\n<span class="token punctuation">}</span><span class="token punctuation">:</span> UseProgressControlProps <span class="token operator">&amp;</span> CommonProps</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   <span class="token keyword">const</span> <span class="token punctuation">[</span>isLoad<span class="token punctuation">,</span> setIsLoad<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">const</span> <span class="token punctuation">[</span>duration<span class="token punctuation">,</span> setDuration<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token keyword">const</span> <span class="token function-variable function">handleLoadedMetadata</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> <span class="token punctuation">{</span> duration <span class="token punctuation">}</span> <span class="token operator">=</span> domRef<span class="token punctuation">.</span>current<span class="token punctuation">;</span>\n      <span class="token function">setDuration</span><span class="token punctuation">(</span>duration<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token function">setIsLoad</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n   <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>isLoad <span class="token operator">||</span> <span class="token keyword">typeof</span> progress <span class="token operator">!==</span> <span class="token string">\'number\'</span> <span class="token operator">||</span> playStrategy <span class="token operator">!==</span> <span class="token string">\'progressControl\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token keyword">return</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token keyword">const</span> calcProgress <span class="token operator">=</span> progress <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token punctuation">:</span> progress <span class="token operator">></span> <span class="token number">1</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token punctuation">:</span> progress<span class="token punctuation">;</span>\n      domRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span>currentTime <span class="token operator">=</span> calcProgress <span class="token operator">*</span> duration<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>progress<span class="token punctuation">,</span> isLoad<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>playStrategy <span class="token operator">===</span> <span class="token string">\'progressControl\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token function">onSetVideoProps</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n            muted<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n            playsInline<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n            preload<span class="token punctuation">:</span> <span class="token string">\'metadata\'</span>\n         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>playStrategy<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token keyword">return</span> <span class="token punctuation">{</span>\n      handleLoadedMetadata\n   <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> useProgressControl<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="jsmpeg"><a href="#jsmpeg" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>jsmpeg</h4>\n<p>现阶段采用的技术选型</p>\n<p>web/components/jsmpegPlayer/index.tsx</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="59931413920463970000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import React, { useRef, useEffect, useState } from \'react\'\nimport classNames from \'classnames\'\nimport { useInViewport, useAsyncEffect } from \'ahooks\'\n\nimport { l } from \'@/components/lazyLoader\'\n\nimport { loadScript } from \'@/utils\'\n\nimport styles from \'./index.module.less\'\n\ninterface JsmpegPlayerProps {\n  src: string\n  progress?: number // 播放进度，0~1\n  className?: string\n  poster?: string\n}\n\n// https://github.com/phoboslab/jsmpeg/tree/v0.2\nconst JsmpegPlayer = ({\n  src,\n  progress,\n  className,\n  poster,\n  ...rest\n}: JsmpegPlayerProps) => {\n  const [isLoad, setIsLoad] = useState(true)\n  const [isLoadJsmpeg, setIsLoadJsmpeg] = useState(true)\n  const playerRef = useRef()\n  const domRef = useRef(null)\n\n  useAsyncEffect(async () => {\n    await loadScript(\'/public/lib/jsmpeg.min.js\')\n    setIsLoadJsmpeg(false)\n  }, [])\n\n  const [inViewPort] = useInViewport(domRef)\n  useEffect(() => {\n    if (!inViewPort || isLoadJsmpeg || !isLoad) {\n      return\n    }\n    // eslint-disable-next-line new-cap\n    playerRef.current = new window.jsmpeg(src, {\n      ...rest,\n      canvas: domRef.current?.querySelector(\'canvas\'),\n      seekable: true,\n      onload: () => {\n        setIsLoad(false)\n        // console.log(playerRef.current?.duration, playerRef.current?.frameCount)\n      }\n    })\n  // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [inViewPort, isLoadJsmpeg])\n\n  useEffect(() => {\n    if (isLoad || typeof progress !== \'number\') {\n      return\n    }\n    const calcProgress = progress < 0 ? 0 : progress > 1 ? 1 : progress\n    const frameCount = playerRef.current?.frameCount - 1 // 最大帧需减一\n    playerRef.current?.seekToFrame(calcProgress * frameCount, true)\n  }, [progress, isLoad])\n\n  const isShowPoster = (isLoad || isLoadJsmpeg) && poster\n  return <div\n    ref={domRef}\n    className={classNames(styles.container, className)}\n  >\n    <div className={styles.body}>\n      <canvas\n        className={styles.video}\n      />\n      {\n        isShowPoster && <l.img\n          src={poster}\n          className={styles.poster}\n        />\n      }\n    </div>\n  </div>\n}\n\nexport default JsmpegPlayer`, `59931413920463970000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="tsx"\n              >\n                <span class="gatsby-code-button-language">tsx</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="tsx"><pre style="counter-reset: linenumber NaN" class="language-tsx line-numbers"><code class="language-tsx"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useRef<span class="token punctuation">,</span> useEffect<span class="token punctuation">,</span> useState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react\'</span>\n<span class="token keyword">import</span> classNames <span class="token keyword">from</span> <span class="token string">\'classnames\'</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> useInViewport<span class="token punctuation">,</span> useAsyncEffect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'ahooks\'</span>\n\n<span class="token keyword">import</span> <span class="token punctuation">{</span> l <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@/components/lazyLoader\'</span>\n\n<span class="token keyword">import</span> <span class="token punctuation">{</span> loadScript <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@/utils\'</span>\n\n<span class="token keyword">import</span> styles <span class="token keyword">from</span> <span class="token string">\'./index.module.less\'</span>\n\n<span class="token keyword">interface</span> <span class="token class-name">JsmpegPlayerProps</span> <span class="token punctuation">{</span>\n  src<span class="token punctuation">:</span> <span class="token builtin">string</span>\n  progress<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">number</span> <span class="token comment">// 播放进度，0~1</span>\n  className<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">string</span>\n  poster<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">string</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// https://github.com/phoboslab/jsmpeg/tree/v0.2</span>\n<span class="token keyword">const</span> <span class="token function-variable function">JsmpegPlayer</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>\n  src<span class="token punctuation">,</span>\n  progress<span class="token punctuation">,</span>\n  className<span class="token punctuation">,</span>\n  poster<span class="token punctuation">,</span>\n  <span class="token operator">...</span>rest\n<span class="token punctuation">}</span><span class="token punctuation">:</span> JsmpegPlayerProps</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">[</span>isLoad<span class="token punctuation">,</span> setIsLoad<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>\n  <span class="token keyword">const</span> <span class="token punctuation">[</span>isLoadJsmpeg<span class="token punctuation">,</span> setIsLoadJsmpeg<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>\n  <span class="token keyword">const</span> playerRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n  <span class="token keyword">const</span> domRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>\n\n  <span class="token function">useAsyncEffect</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">await</span> <span class="token function">loadScript</span><span class="token punctuation">(</span><span class="token string">\'/public/lib/jsmpeg.min.js\'</span><span class="token punctuation">)</span>\n    <span class="token function">setIsLoadJsmpeg</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n\n  <span class="token keyword">const</span> <span class="token punctuation">[</span>inViewPort<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useInViewport</span><span class="token punctuation">(</span>domRef<span class="token punctuation">)</span>\n  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>inViewPort <span class="token operator">||</span> isLoadJsmpeg <span class="token operator">||</span> <span class="token operator">!</span>isLoad<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span>\n    <span class="token punctuation">}</span>\n    <span class="token comment">// eslint-disable-next-line new-cap</span>\n    playerRef<span class="token punctuation">.</span>current <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">window<span class="token punctuation">.</span>jsmpeg</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n      <span class="token operator">...</span>rest<span class="token punctuation">,</span>\n      canvas<span class="token punctuation">:</span> domRef<span class="token punctuation">.</span>current<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">\'canvas\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n      seekable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n      <span class="token function-variable function">onload</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token function">setIsLoad</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>\n        <span class="token comment">// console.log(playerRef.current?.duration, playerRef.current?.frameCount)</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  <span class="token comment">// eslint-disable-next-line react-hooks/exhaustive-deps</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>inViewPort<span class="token punctuation">,</span> isLoadJsmpeg<span class="token punctuation">]</span><span class="token punctuation">)</span>\n\n  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>isLoad <span class="token operator">||</span> <span class="token keyword">typeof</span> progress <span class="token operator">!==</span> <span class="token string">\'number\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">const</span> calcProgress <span class="token operator">=</span> progress <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token punctuation">:</span> progress <span class="token operator">></span> <span class="token number">1</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token punctuation">:</span> progress\n    <span class="token keyword">const</span> frameCount <span class="token operator">=</span> playerRef<span class="token punctuation">.</span>current<span class="token operator">?</span><span class="token punctuation">.</span>frameCount <span class="token operator">-</span> <span class="token number">1</span> <span class="token comment">// 最大帧需减一</span>\n    playerRef<span class="token punctuation">.</span>current<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">seekToFrame</span><span class="token punctuation">(</span>calcProgress <span class="token operator">*</span> frameCount<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>progress<span class="token punctuation">,</span> isLoad<span class="token punctuation">]</span><span class="token punctuation">)</span>\n\n  <span class="token keyword">const</span> isShowPoster <span class="token operator">=</span> <span class="token punctuation">(</span>isLoad <span class="token operator">||</span> isLoadJsmpeg<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> poster\n  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span>\n    <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>domRef<span class="token punctuation">}</span></span>\n    <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">classNames</span><span class="token punctuation">(</span>styles<span class="token punctuation">.</span>container<span class="token punctuation">,</span> className<span class="token punctuation">)</span><span class="token punctuation">}</span></span>\n  <span class="token punctuation">></span></span><span class="token plain-text">\n    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>body<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>canvas</span>\n        <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>video<span class="token punctuation">}</span></span>\n      <span class="token punctuation">/></span></span><span class="token plain-text">\n      </span><span class="token punctuation">{</span>\n        isShowPoster <span class="token operator">&amp;&amp;</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>l.img</span>\n          <span class="token attr-name">src</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>poster<span class="token punctuation">}</span></span>\n          <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>poster<span class="token punctuation">}</span></span>\n        <span class="token punctuation">/></span></span>\n      <span class="token punctuation">}</span><span class="token plain-text">\n    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">\n  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> JsmpegPlayer</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>web/pages/p5/components/smartSpaceInternal/index.tsx</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="10165079694593792000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import React from \'react\'\nimport { useTranslation } from \'react-i18next\'\nimport classNames from \'classnames\'\n\nimport ModelCenterText from \'@/components/modelCenterText\'\nimport ModelLeftText from \'@/components/modelLeftText\'\nimport { SceneProps } from \'@/components/reactScrollMagic\'\nimport JsmpegPlayer from \'@/components/jsmpegPlayer\'\nimport { l } from \'@/components/lazyLoader\'\n\nimport useTmpComponent from \'@/hooks/useTmpComponent\'\nimport useStoreContext, { CLIENT_TYPE, DATA_ANALYSIS_TYPES } from \'@/hooks/useStoreContext\'\n\nimport { getAnimateProgresses } from \'@/utils/animate\'\n\nimport styles from \'./index.module.less\'\nimport { dataAnalysisClickTrack } from \'@/utils/dataAnalysis\'\nimport XTracker from \'@/components/xTracker\'\nimport { setDataLayer } from \'@/hooks/useSetDataLayer\'\n\nconst Index = ({\n  sceneParams\n}: SceneProps) => {\n  const {\n    progress = 0\n  } = sceneParams || {}\n  const { t } = useTranslation()\n  const trackRef = XTracker.useExposureNode({\n    type: \'P5\',\n    event: \'IntelligentSpace_Show\'\n  })\n  const getValue = (param: string) => t(\\`p5.smartSpaceInternal.\\${param}\\`)\n\n  const { api, Slot } = useTmpComponent()\n\n  const { state } = useStoreContext()\n\n  const [playerProgress] = getAnimateProgresses(progress, [\n    {\n      start: 0,\n      duration: 2 / 3\n    }\n  ])\n\n  const isShowAnimationText = playerProgress > 0.47 // 窗帘收起时文字出现\n\n  return (\n    <>\n      {\n        state?.clientType === CLIENT_TYPE.PC && <JsmpegPlayer\n          className={styles.player}\n          src=&quot;/public/p5/smart-space-internal/p5-inside.mpeg&quot;\n          poster=&quot;/public/p5/smart-space-internal/p5-inside-first-frame.jpg&quot;\n          progress={playerProgress}\n        />\n      }\n      <div\n        className={classNames(\'global-full-page-with-top-menu\', styles.container)}\n      >\n        {\n          state?.clientType === CLIENT_TYPE.H5 && <l.video\n            className={styles.player}\n            src=&quot;/public/p5/smart-space-internal/p5-inside-origin.mp4&quot;\n            srcPoster=&quot;/public/p5/smart-space-internal/p5-inside@mini.jpg&quot;\n            playIconPosition=&quot;bottom&quot;\n          />\n        }\n        <Slot\n          modelType=\'P5\'\n          pageType=\'IntelligentSpace\'\n          buttonType=\'LearnMore\'\n          itemList={[{\n            imgList: [{\n              src: \'/public/p5/d3/p5-d3-1.jpg\',\n              srcSet: \'/public/p5/d3/p5-d3-1@2x.jpg\'\n            }],\n            background: \'linear-gradient(132deg, #94A1C6 0%, #7C8DB6 100%)\',\n            textData: {\n              topSubTitle: t(\'p5.d3.topSubTitle1\'),\n              title: t(\'p5.d3.title1\'),\n              subTitle: t(\'p5.d3.subTitle1\')\n            }\n          }, {\n            imgList: [{\n              src: \'/public/p5/d3/p5-d3-2.mp4\'\n            }],\n            background: \'linear-gradient(136deg, #5F729E 0%, #3B4B76 100%)\',\n            textData: {\n              topSubTitle: t(\'p5.d3.topSubTitle2\'),\n              title: t(\'p5.d3.title2\'),\n              subTitle: t(\'p5.d3.subTitle2\')\n            }\n          }, {\n            imgList: [{\n              src: \'/public/p5/d3/p5-d3-3.jpg\',\n              srcSet: \'/public/p5/d3/p5-d3-3@2x.jpg\'\n            }],\n            background: \'linear-gradient(133deg, #B6CBDA 0%, #7A97AF 100%)\',\n            textData: {\n              topSubTitle: t(\'p5.d3.topSubTitle3\'),\n              title: t(\'p5.d3.title3\'),\n              subTitle: t(\'p5.d3.subTitle3\')\n            }\n          }]}\n        />\n        <div ref={trackRef} className={classNames(\'body\', styles.body)}>\n          {\n            isShowAnimationText && state?.clientType === CLIENT_TYPE.PC && <ModelCenterText\n              topSubTitle={getValue(\'topSubTitle\')}\n              title={getValue(\'title\')}\n              subTitle={getValue(\'subTitle\')}\n              shortDesc={getValue(\'shortDesc\')}\n              buttonText={getValue(\'button\')}\n              buttonProps={{\n                onClick: () => {\n                  dataAnalysisClickTrack(\\`\\${DATA_ANALYSIS_TYPES.P5}_IntelligentSpace_LearnMoreBtn\\`)\n                  api?.current?.open()\n                  setDataLayer({\n                    event_category: \'click_button\',\n                    car_model: \'p5\',\n                    button_group: \'learn more\',\n                    click_text: getValue(\'button\')\n                  })\n                },\n                type: \'ghost\',\n                dark: true,\n                plain: true\n              }}\n              closeIcon={null}\n            />\n          }\n          {\n            state?.clientType === CLIENT_TYPE.H5 && <ModelLeftText\n              topSubTitle={getValue(\'topSubTitle\')}\n              title={getValue(\'title\')}\n              subTitle={getValue(\'subTitle\')}\n              shortDesc={getValue(\'shortDesc\')}\n              buttonProps={{\n                onClick: () => {\n                  api?.current?.open()\n                },\n                type: \'ghost\'\n              }}\n              closeIcon={null}\n            />\n          }\n        </div>\n      </div>\n    </>\n\n  )\n}\n\nexport default Index`, `10165079694593792000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="tsx"\n              >\n                <span class="gatsby-code-button-language">tsx</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="tsx"><pre style="counter-reset: linenumber NaN" class="language-tsx line-numbers"><code class="language-tsx"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">\'react\'</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> useTranslation <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react-i18next\'</span>\n<span class="token keyword">import</span> classNames <span class="token keyword">from</span> <span class="token string">\'classnames\'</span>\n\n<span class="token keyword">import</span> ModelCenterText <span class="token keyword">from</span> <span class="token string">\'@/components/modelCenterText\'</span>\n<span class="token keyword">import</span> ModelLeftText <span class="token keyword">from</span> <span class="token string">\'@/components/modelLeftText\'</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> SceneProps <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@/components/reactScrollMagic\'</span>\n<span class="token keyword">import</span> JsmpegPlayer <span class="token keyword">from</span> <span class="token string">\'@/components/jsmpegPlayer\'</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> l <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@/components/lazyLoader\'</span>\n\n<span class="token keyword">import</span> useTmpComponent <span class="token keyword">from</span> <span class="token string">\'@/hooks/useTmpComponent\'</span>\n<span class="token keyword">import</span> useStoreContext<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token constant">CLIENT_TYPE</span><span class="token punctuation">,</span> <span class="token constant">DATA_ANALYSIS_TYPES</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@/hooks/useStoreContext\'</span>\n\n<span class="token keyword">import</span> <span class="token punctuation">{</span> getAnimateProgresses <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@/utils/animate\'</span>\n\n<span class="token keyword">import</span> styles <span class="token keyword">from</span> <span class="token string">\'./index.module.less\'</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> dataAnalysisClickTrack <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@/utils/dataAnalysis\'</span>\n<span class="token keyword">import</span> XTracker <span class="token keyword">from</span> <span class="token string">\'@/components/xTracker\'</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> setDataLayer <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@/hooks/useSetDataLayer\'</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">Index</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>\n  sceneParams\n<span class="token punctuation">}</span><span class="token punctuation">:</span> SceneProps</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span>\n    progress <span class="token operator">=</span> <span class="token number">0</span>\n  <span class="token punctuation">}</span> <span class="token operator">=</span> sceneParams <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> t <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useTranslation</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n  <span class="token keyword">const</span> trackRef <span class="token operator">=</span> XTracker<span class="token punctuation">.</span><span class="token function">useExposureNode</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n    <span class="token keyword">type</span><span class="token punctuation">:</span> <span class="token string">\'P5\'</span><span class="token punctuation">,</span>\n    event<span class="token punctuation">:</span> <span class="token string">\'IntelligentSpace_Show\'</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  <span class="token keyword">const</span> <span class="token function-variable function">getValue</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">param<span class="token punctuation">:</span> <span class="token builtin">string</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">p5.smartSpaceInternal.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>param<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>\n\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> api<span class="token punctuation">,</span> Slot <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useTmpComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> state <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useStoreContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n  <span class="token keyword">const</span> <span class="token punctuation">[</span>playerProgress<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">getAnimateProgresses</span><span class="token punctuation">(</span>progress<span class="token punctuation">,</span> <span class="token punctuation">[</span>\n    <span class="token punctuation">{</span>\n      start<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>\n      duration<span class="token punctuation">:</span> <span class="token number">2</span> <span class="token operator">/</span> <span class="token number">3</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">]</span><span class="token punctuation">)</span>\n\n  <span class="token keyword">const</span> isShowAnimationText <span class="token operator">=</span> playerProgress <span class="token operator">></span> <span class="token number">0.47</span> <span class="token comment">// 窗帘收起时文字出现</span>\n\n  <span class="token keyword">return</span> <span class="token punctuation">(</span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n      </span><span class="token punctuation">{</span>\n        state<span class="token operator">?</span><span class="token punctuation">.</span>clientType <span class="token operator">===</span> <span class="token constant">CLIENT_TYPE</span><span class="token punctuation">.</span><span class="token constant">PC</span> <span class="token operator">&amp;&amp;</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">JsmpegPlayer</span></span>\n          <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>player<span class="token punctuation">}</span></span>\n          <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/public/p5/smart-space-internal/p5-inside.mpeg<span class="token punctuation">"</span></span>\n          <span class="token attr-name">poster</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/public/p5/smart-space-internal/p5-inside-first-frame.jpg<span class="token punctuation">"</span></span>\n          <span class="token attr-name">progress</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>playerProgress<span class="token punctuation">}</span></span>\n        <span class="token punctuation">/></span></span>\n      <span class="token punctuation">}</span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span>\n        <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">classNames</span><span class="token punctuation">(</span><span class="token string">\'global-full-page-with-top-menu\'</span><span class="token punctuation">,</span> styles<span class="token punctuation">.</span>container<span class="token punctuation">)</span><span class="token punctuation">}</span></span>\n      <span class="token punctuation">></span></span><span class="token plain-text">\n        </span><span class="token punctuation">{</span>\n          state<span class="token operator">?</span><span class="token punctuation">.</span>clientType <span class="token operator">===</span> <span class="token constant">CLIENT_TYPE</span><span class="token punctuation">.</span><span class="token constant">H5</span> <span class="token operator">&amp;&amp;</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>l.video</span>\n            <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>player<span class="token punctuation">}</span></span>\n            <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/public/p5/smart-space-internal/p5-inside-origin.mp4<span class="token punctuation">"</span></span>\n            <span class="token attr-name">srcPoster</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/public/p5/smart-space-internal/p5-inside@mini.jpg<span class="token punctuation">"</span></span>\n            <span class="token attr-name">playIconPosition</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>bottom<span class="token punctuation">"</span></span>\n          <span class="token punctuation">/></span></span>\n        <span class="token punctuation">}</span><span class="token plain-text">\n        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Slot</span></span>\n          <span class="token attr-name">modelType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">\'</span>P5<span class="token punctuation">\'</span></span>\n          <span class="token attr-name">pageType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">\'</span>IntelligentSpace<span class="token punctuation">\'</span></span>\n          <span class="token attr-name">buttonType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">\'</span>LearnMore<span class="token punctuation">\'</span></span>\n          <span class="token attr-name">itemList</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">[</span><span class="token punctuation">{</span>\n            imgList<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>\n              src<span class="token punctuation">:</span> <span class="token string">\'/public/p5/d3/p5-d3-1.jpg\'</span><span class="token punctuation">,</span>\n              srcSet<span class="token punctuation">:</span> <span class="token string">\'/public/p5/d3/p5-d3-1@2x.jpg\'</span>\n            <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n            background<span class="token punctuation">:</span> <span class="token string">\'linear-gradient(132deg, #94A1C6 0%, #7C8DB6 100%)\'</span><span class="token punctuation">,</span>\n            textData<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n              topSubTitle<span class="token punctuation">:</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token string">\'p5.d3.topSubTitle1\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n              title<span class="token punctuation">:</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token string">\'p5.d3.title1\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n              subTitle<span class="token punctuation">:</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token string">\'p5.d3.subTitle1\'</span><span class="token punctuation">)</span>\n            <span class="token punctuation">}</span>\n          <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>\n            imgList<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>\n              src<span class="token punctuation">:</span> <span class="token string">\'/public/p5/d3/p5-d3-2.mp4\'</span>\n            <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n            background<span class="token punctuation">:</span> <span class="token string">\'linear-gradient(136deg, #5F729E 0%, #3B4B76 100%)\'</span><span class="token punctuation">,</span>\n            textData<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n              topSubTitle<span class="token punctuation">:</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token string">\'p5.d3.topSubTitle2\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n              title<span class="token punctuation">:</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token string">\'p5.d3.title2\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n              subTitle<span class="token punctuation">:</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token string">\'p5.d3.subTitle2\'</span><span class="token punctuation">)</span>\n            <span class="token punctuation">}</span>\n          <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>\n            imgList<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>\n              src<span class="token punctuation">:</span> <span class="token string">\'/public/p5/d3/p5-d3-3.jpg\'</span><span class="token punctuation">,</span>\n              srcSet<span class="token punctuation">:</span> <span class="token string">\'/public/p5/d3/p5-d3-3@2x.jpg\'</span>\n            <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n            background<span class="token punctuation">:</span> <span class="token string">\'linear-gradient(133deg, #B6CBDA 0%, #7A97AF 100%)\'</span><span class="token punctuation">,</span>\n            textData<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n              topSubTitle<span class="token punctuation">:</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token string">\'p5.d3.topSubTitle3\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n              title<span class="token punctuation">:</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token string">\'p5.d3.title3\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n              subTitle<span class="token punctuation">:</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token string">\'p5.d3.subTitle3\'</span><span class="token punctuation">)</span>\n            <span class="token punctuation">}</span>\n          <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span>\n        <span class="token punctuation">/></span></span><span class="token plain-text">\n        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>trackRef<span class="token punctuation">}</span></span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">classNames</span><span class="token punctuation">(</span><span class="token string">\'body\'</span><span class="token punctuation">,</span> styles<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n          </span><span class="token punctuation">{</span>\n            isShowAnimationText <span class="token operator">&amp;&amp;</span> state<span class="token operator">?</span><span class="token punctuation">.</span>clientType <span class="token operator">===</span> <span class="token constant">CLIENT_TYPE</span><span class="token punctuation">.</span><span class="token constant">PC</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">&lt;</span>ModelCenterText\n              topSubTitle<span class="token operator">=</span><span class="token punctuation">{</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token string">\'topSubTitle\'</span><span class="token punctuation">)</span><span class="token punctuation">}</span>\n              title<span class="token operator">=</span><span class="token punctuation">{</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token string">\'title\'</span><span class="token punctuation">)</span><span class="token punctuation">}</span>\n              subTitle<span class="token operator">=</span><span class="token punctuation">{</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token string">\'subTitle\'</span><span class="token punctuation">)</span><span class="token punctuation">}</span>\n              shortDesc<span class="token operator">=</span><span class="token punctuation">{</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token string">\'shortDesc\'</span><span class="token punctuation">)</span><span class="token punctuation">}</span>\n              buttonText<span class="token operator">=</span><span class="token punctuation">{</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token string">\'button\'</span><span class="token punctuation">)</span><span class="token punctuation">}</span>\n              buttonProps<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>\n                <span class="token function-variable function">onClick</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n                  <span class="token function">dataAnalysisClickTrack</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">DATA_ANALYSIS_TYPES</span><span class="token punctuation">.</span><span class="token constant">P5</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">_IntelligentSpace_LearnMoreBtn</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>\n                  api<span class="token operator">?</span><span class="token punctuation">.</span>current<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n                  <span class="token function">setDataLayer</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n                    event_category<span class="token punctuation">:</span> <span class="token string">\'click_button\'</span><span class="token punctuation">,</span>\n                    car_model<span class="token punctuation">:</span> <span class="token string">\'p5\'</span><span class="token punctuation">,</span>\n                    button_group<span class="token punctuation">:</span> <span class="token string">\'learn more\'</span><span class="token punctuation">,</span>\n                    click_text<span class="token punctuation">:</span> <span class="token function">getValue</span><span class="token punctuation">(</span><span class="token string">\'button\'</span><span class="token punctuation">)</span>\n                  <span class="token punctuation">}</span><span class="token punctuation">)</span>\n                <span class="token punctuation">}</span><span class="token punctuation">,</span>\n                <span class="token keyword">type</span><span class="token punctuation">:</span> <span class="token string">\'ghost\'</span><span class="token punctuation">,</span>\n                dark<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n                plain<span class="token punctuation">:</span> <span class="token boolean">true</span>\n              <span class="token punctuation">}</span><span class="token punctuation">}</span>\n              closeIcon<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">null</span><span class="token punctuation">}</span>\n            <span class="token operator">/</span><span class="token operator">></span>\n          <span class="token punctuation">}</span><span class="token plain-text">\n          </span><span class="token punctuation">{</span>\n            state<span class="token operator">?</span><span class="token punctuation">.</span>clientType <span class="token operator">===</span> <span class="token constant">CLIENT_TYPE</span><span class="token punctuation">.</span><span class="token constant">H5</span> <span class="token operator">&amp;&amp;</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">ModelLeftText</span></span>\n              <span class="token attr-name">topSubTitle</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token string">\'topSubTitle\'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span>\n              <span class="token attr-name">title</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token string">\'title\'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span>\n              <span class="token attr-name">subTitle</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token string">\'subTitle\'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span>\n              <span class="token attr-name">shortDesc</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token string">\'shortDesc\'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span>\n              <span class="token attr-name">buttonProps</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>\n                <span class="token function-variable function">onClick</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n                  api<span class="token operator">?</span><span class="token punctuation">.</span>current<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n                <span class="token punctuation">}</span><span class="token punctuation">,</span>\n                <span class="token keyword">type</span><span class="token punctuation">:</span> <span class="token string">\'ghost\'</span>\n              <span class="token punctuation">}</span><span class="token punctuation">}</span></span>\n              <span class="token attr-name">closeIcon</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">null</span><span class="token punctuation">}</span></span>\n            <span class="token punctuation">/></span></span>\n          <span class="token punctuation">}</span><span class="token plain-text">\n        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">\n    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span></span><span class="token punctuation">></span></span>\n\n  <span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> Index</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="运行效果-4"><a href="#%E8%BF%90%E8%A1%8C%E6%95%88%E6%9E%9C-4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>运行效果</h3>\n<h4 id="pixi-apngandgif-1"><a href="#pixi-apngandgif-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>pixi-apngAndGif</h4>\n<!-- <iframe data-src="https://codesandbox.io/embed/fzmi7s?codemirror=1&hidenavigation=1&theme=light&view=preview" class="embedded-codesandbox" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe> --><html><head></head><body></body></html>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/jtgkm7?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h4 id="ogvjs-1"><a href="#ogvjs-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ogv.js</h4>\n<!-- <iframe data-src="https://codesandbox.io/embed/dv2njm?codemirror=1&hidenavigation=1&theme=light&view=preview" class="embedded-codesandbox" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe> --><html><head></head><body></body></html>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/xz72w3?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h4 id="video-1"><a href="#video-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>video</h4>\n<p>利用 <code class="language-text">懒加载</code> 功能写出的进度控制如下：</p>\n<!-- <iframe data-src="https://codesandbox.io/embed/16i1lw?codemirror=1&hidenavigation=1&theme=light&view=preview" class="embedded-codesandbox" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe> --><html><head></head><body></body></html>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/kwrcjq?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h4 id="jsmpeg-1"><a href="#jsmpeg-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>jsmpeg</h4>\n<!-- <iframe data-src="https://codesandbox.io/embed/0ywivn?codemirror=1&hidenavigation=1&theme=light&view=preview" class="embedded-codesandbox" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe> --><html><head></head><body></body></html>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/cgtjwk?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h3 id="优化-1"><a href="#%E4%BC%98%E5%8C%96-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>优化</h3>\n<h4 id="视频压缩"><a href="#%E8%A7%86%E9%A2%91%E5%8E%8B%E7%BC%A9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>视频压缩</h4>\n<p>视频批量压缩脚本、支持单个压缩（有声音、转 mpeg 单独压缩）</p>\n<p>scripts/compress.mjs</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="69149396373556530000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`#!/usr/bin/env zx\nconst { get } = require(\'lodash\');\n\nconst compressConfig = require(\'../compress.config\');\nconst concurrentRun = require(\'./concurrentRun\');\n\n// 关闭日志输出\n\\$.verbose = false;\n\nconst FILE_SUFFIX = \'mp4\';\nconst TMP_FILE_SUFFIX = \'.bak.mp4\';\n\nconst delFiles = await globby(\\`public/**/*\\${TMP_FILE_SUFFIX}\\`);\n\nawait \\$\\`rm -rf \\${delFiles}\\`;\n\nlet files = [];\n\nconst params = argv._.slice(1);\nif (params.length > 0) {\n   files = params.filter((item) => /mp4\\$/.test(item));\n} else {\n   files = await globby(\\`public/**/*.\\${FILE_SUFFIX}\\`);\n}\n\nconsole.log(\\`开始压缩 \\${FILE_SUFFIX}\\`);\n\n// https://github.com/google/zx/issues/126\n\\$.noquote = async (...args) => {\n   const q = \\$.quote;\n   \\$.quote = (v) => v;\n   const p = \\$(...args);\n   await p;\n   \\$.quote = q;\n   return p;\n};\n\nconst transformToMpeg = async (bashFunc, file) => {\n   await \\$.noquote\\`\\${bashFunc(file, file.replace(/mp4\\$/, \'mpeg\'))}\\`;\n   // await \\$\\`rm -rf \\${file}\\`\n};\n\nconst transformToMp4 = async (bashFunc, file) => {\n   await \\$.noquote\\`\\${bashFunc(file, file + TMP_FILE_SUFFIX)}\\`;\n   await \\$\\`rm -rf \\${file}\\`;\n   await \\$\\`mv \\${file}\\${TMP_FILE_SUFFIX} \\${file}\\`;\n   await \\$\\`rm -rf \\${file}\\${TMP_FILE_SUFFIX}\\`;\n};\n\nconst funcArray = [\n   {\n      path: \'mpeg.4\',\n      func: transformToMpeg\n   },\n   {\n      path: \'mp4.hasAudio\',\n      func: transformToMp4\n   },\n   {\n      path: \'mp4\',\n      func: transformToMp4\n   }\n];\n\nawait concurrentRun(\n   files.map((file) => async () => {\n      for (let i = 0; i < funcArray.length; i++) {\n         const item = funcArray[i];\n         const { bashFunc, files } = get(compressConfig.mp4, item.path);\n         // files 未定义或者包含 file\n         if (!files || files.includes(file)) {\n            await item.func(bashFunc, file);\n            return Promise.resolve();\n         }\n      }\n      return Promise.resolve();\n   })\n);\n\nconsole.log(\\`共 \\${files.length} 个 \\${FILE_SUFFIX} 压缩完成\\`);`, `69149396373556530000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">#<span class="token operator">!</span><span class="token operator">/</span>usr<span class="token operator">/</span>bin<span class="token operator">/</span>env zx\n<span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">get</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'lodash\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> compressConfig <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'../compress.config\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> concurrentRun <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./concurrentRun\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 关闭日志输出</span>\n$<span class="token punctuation">.</span>verbose <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token constant">FILE_SUFFIX</span> <span class="token operator">=</span> <span class="token string">\'mp4\'</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> <span class="token constant">TMP_FILE_SUFFIX</span> <span class="token operator">=</span> <span class="token string">\'.bak.mp4\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> delFiles <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">globby</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">public/**/*</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">TMP_FILE_SUFFIX</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">await</span> $<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">rm -rf </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>delFiles<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n\n<span class="token keyword">let</span> files <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> params <span class="token operator">=</span> argv<span class="token punctuation">.</span>_<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   files <span class="token operator">=</span> params<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token regex">/mp4$/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n   files <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">globby</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">public/**/*.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">FILE_SUFFIX</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">开始压缩 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">FILE_SUFFIX</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// https://github.com/google/zx/issues/126</span>\n$<span class="token punctuation">.</span><span class="token function-variable function">noquote</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   <span class="token keyword">const</span> q <span class="token operator">=</span> $<span class="token punctuation">.</span>quote<span class="token punctuation">;</span>\n   $<span class="token punctuation">.</span><span class="token function-variable function">quote</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token operator">=></span> v<span class="token punctuation">;</span>\n   <span class="token keyword">const</span> p <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">await</span> p<span class="token punctuation">;</span>\n   $<span class="token punctuation">.</span>quote <span class="token operator">=</span> q<span class="token punctuation">;</span>\n   <span class="token keyword">return</span> p<span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">transformToMpeg</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">bashFunc<span class="token punctuation">,</span> file</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   <span class="token keyword">await</span> $<span class="token punctuation">.</span>noquote<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">bashFunc</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> file<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/mp4$/</span><span class="token punctuation">,</span> <span class="token string">\'mpeg\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n   <span class="token comment">// await $`rm -rf ${file}`</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">transformToMp4</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">bashFunc<span class="token punctuation">,</span> file</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   <span class="token keyword">await</span> $<span class="token punctuation">.</span>noquote<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">bashFunc</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> file <span class="token operator">+</span> <span class="token constant">TMP_FILE_SUFFIX</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n   <span class="token keyword">await</span> $<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">rm -rf </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>file<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n   <span class="token keyword">await</span> $<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">mv </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>file<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">TMP_FILE_SUFFIX</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>file<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n   <span class="token keyword">await</span> $<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">rm -rf </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>file<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">TMP_FILE_SUFFIX</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> funcArray <span class="token operator">=</span> <span class="token punctuation">[</span>\n   <span class="token punctuation">{</span>\n      path<span class="token punctuation">:</span> <span class="token string">\'mpeg.4\'</span><span class="token punctuation">,</span>\n      func<span class="token punctuation">:</span> transformToMpeg\n   <span class="token punctuation">}</span><span class="token punctuation">,</span>\n   <span class="token punctuation">{</span>\n      path<span class="token punctuation">:</span> <span class="token string">\'mp4.hasAudio\'</span><span class="token punctuation">,</span>\n      func<span class="token punctuation">:</span> transformToMp4\n   <span class="token punctuation">}</span><span class="token punctuation">,</span>\n   <span class="token punctuation">{</span>\n      path<span class="token punctuation">:</span> <span class="token string">\'mp4\'</span><span class="token punctuation">,</span>\n      func<span class="token punctuation">:</span> transformToMp4\n   <span class="token punctuation">}</span>\n<span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n<span class="token keyword">await</span> <span class="token function">concurrentRun</span><span class="token punctuation">(</span>\n   files<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">file</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> funcArray<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token keyword">const</span> item <span class="token operator">=</span> funcArray<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>\n         <span class="token keyword">const</span> <span class="token punctuation">{</span> bashFunc<span class="token punctuation">,</span> files <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">get</span><span class="token punctuation">(</span>compressConfig<span class="token punctuation">.</span>mp4<span class="token punctuation">,</span> item<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token comment">// files 未定义或者包含 file</span>\n         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>files <span class="token operator">||</span> files<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">await</span> item<span class="token punctuation">.</span><span class="token function">func</span><span class="token punctuation">(</span>bashFunc<span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n      <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span><span class="token punctuation">)</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">共 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>files<span class="token punctuation">.</span>length<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 个 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">FILE_SUFFIX</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 压缩完成</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>scripts/concurrentRun.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="45140917789626655000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const ProgressBar = require(\'progress\');\nconst os = require(\'os\');\nconst cpus = os.cpus();\n\n/**\n * 执行多个异步任务\n * @param {*} fnList 任务列表\n * @param {*} max 最大并发数限制，默认执行的是 CPU 密集性任务，线程数等于 CPU 核心数 + 1\n * @param {*} taskName 任务名称\n */\nmodule.exports = async function concurrentRun(fnList = [], max = cpus.length + 1, taskName = \'未命名\') {\n   if (!fnList.length) return;\n\n   console.log(\\`开始执行多个异步任务，最大并发数： \\${max}\\`);\n   const bar = new ProgressBar(\'执行中 [:bar] :rate/bps :percent :etas 第 :current 个 总共 :total 个\', {\n      total: fnList.length\n   });\n\n   const replyList = []; // 收集任务执行结果\n   // const count = fnList.length // 总任务数量\n   const startTime = new Date().getTime(); // 记录任务执行开始时间\n\n   // let current = 0\n   // 任务执行程序\n   const schedule = async (index) => {\n      // eslint-disable-next-line no-async-promise-executor\n      return new Promise(async (resolve) => {\n         try {\n            const fn = fnList[index];\n            if (!fn) return resolve();\n\n            // 执行当前异步任务\n            const reply = await fn();\n            replyList[index] = reply;\n         } catch (e) {\n            console.log(e);\n            // 报错了不管继续下一个\n            resolve();\n         }\n\n         bar.tick();\n         // current++\n         // console.log(\n         //   \\`\\${taskName} 事务进度，第 \\${current} 个，共 \\${count} 个，进度为 \\${((current / count) * 100).toFixed(2)}% \\`\n         // )\n\n         // 执行完当前任务后，继续执行任务池的剩余任务\n         await schedule(index + max);\n         resolve();\n      });\n   };\n\n   // 任务池执行程序\n   const scheduleList = new Array(max).fill(0).map((_, index) => schedule(index));\n   // 使用 Promise.all 批量执行\n   await Promise.all(scheduleList);\n\n   const cost = (new Date().getTime() - startTime) / 1000;\n   if (bar.complete) {\n      console.log(\\`执行完成，最大并发数： \\${max}，耗时：\\${cost}s\\`);\n   }\n   return replyList;\n};`, `45140917789626655000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> ProgressBar <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'progress\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> os <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'os\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> cpus <span class="token operator">=</span> os<span class="token punctuation">.</span><span class="token function">cpus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">/**\n * 执行多个异步任务\n * @param {*} fnList 任务列表\n * @param {*} max 最大并发数限制，默认执行的是 CPU 密集性任务，线程数等于 CPU 核心数 + 1\n * @param {*} taskName 任务名称\n */</span>\nmodule<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">concurrentRun</span><span class="token punctuation">(</span>fnList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> max <span class="token operator">=</span> cpus<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> taskName <span class="token operator">=</span> <span class="token string">\'未命名\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fnList<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>\n\n   console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">开始执行多个异步任务，最大并发数： </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>max<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">const</span> bar <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProgressBar</span><span class="token punctuation">(</span><span class="token string">\'执行中 [:bar] :rate/bps :percent :etas 第 :current 个 总共 :total 个\'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>\n      total<span class="token punctuation">:</span> fnList<span class="token punctuation">.</span>length\n   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token keyword">const</span> replyList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 收集任务执行结果</span>\n   <span class="token comment">// const count = fnList.length // 总任务数量</span>\n   <span class="token keyword">const</span> startTime <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 记录任务执行开始时间</span>\n\n   <span class="token comment">// let current = 0</span>\n   <span class="token comment">// 任务执行程序</span>\n   <span class="token keyword">const</span> <span class="token function-variable function">schedule</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">index</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token comment">// eslint-disable-next-line no-async-promise-executor</span>\n      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n         <span class="token keyword">try</span> <span class="token punctuation">{</span>\n            <span class="token keyword">const</span> fn <span class="token operator">=</span> fnList<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>\n            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fn<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n            <span class="token comment">// 执行当前异步任务</span>\n            <span class="token keyword">const</span> reply <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            replyList<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> reply<span class="token punctuation">;</span>\n         <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token comment">// 报错了不管继续下一个</span>\n            <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span>\n\n         bar<span class="token punctuation">.</span><span class="token function">tick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token comment">// current++</span>\n         <span class="token comment">// console.log(</span>\n         <span class="token comment">//   `${taskName} 事务进度，第 ${current} 个，共 ${count} 个，进度为 ${((current / count) * 100).toFixed(2)}% `</span>\n         <span class="token comment">// )</span>\n\n         <span class="token comment">// 执行完当前任务后，继续执行任务池的剩余任务</span>\n         <span class="token keyword">await</span> <span class="token function">schedule</span><span class="token punctuation">(</span>index <span class="token operator">+</span> max<span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n   <span class="token comment">// 任务池执行程序</span>\n   <span class="token keyword">const</span> scheduleList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">(</span>max<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">_<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">schedule</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token comment">// 使用 Promise.all 批量执行</span>\n   <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>scheduleList<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token keyword">const</span> cost <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startTime<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">;</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>bar<span class="token punctuation">.</span>complete<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">执行完成，最大并发数： </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>max<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">，耗时：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>cost<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">s</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n   <span class="token keyword">return</span> replyList<span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>compress.config.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="97401842779992880000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`module.exports = {\n   mp4: {\n      mp4: {\n         bashFunc: (input, output) =>\n            \\`ffmpeg -y -i \\${input} -b:v 2048k -maxrate:v 2048k -minrate:v 2048k -r 25 -an -movflags faststart -v fatal \\${output}\\`,\n         hasAudio: {\n            bashFunc: (input, output) =>\n               \\`ffmpeg -y -i \\${input} -b:v 2048k -maxrate:v 2048k -minrate:v 2048k -r 25 -movflags faststart -v fatal \\${output}\\`,\n            files: [\'public/p7/xmart-os/p7-p6-1.mp4\', \'public/no/p7/build-yours/p7-p1-1@long.mp4\']\n         }\n      },\n      mpeg: {\n         4: {\n            bashFunc: (input, output) =>\n               \\`ffmpeg -y -i \\${input} -f mpeg1video -codec:v mpeg1video -q 4 -bf 0 -r 25 -an -movflags faststart -v fatal \\${output}\\`,\n            files: [\n               \'public/p5/smart-space-internal/p5-inside.mp4\',\n               \'public/p7/extra-performance/p7-chassis.mp4\',\n               \'public/p7/learn-more/p7-wing.mp4\',\n               \'public/g3i/xmart-os/g3i-inside.mp4\'\n            ]\n         }\n      }\n   }\n};`, `97401842779992880000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>\n   mp4<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n      mp4<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n         <span class="token function-variable function">bashFunc</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">input<span class="token punctuation">,</span> output</span><span class="token punctuation">)</span> <span class="token operator">=></span>\n            <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">ffmpeg -y -i </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>input<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> -b:v 2048k -maxrate:v 2048k -minrate:v 2048k -r 25 -an -movflags faststart -v fatal </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>output<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n         hasAudio<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n            <span class="token function-variable function">bashFunc</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">input<span class="token punctuation">,</span> output</span><span class="token punctuation">)</span> <span class="token operator">=></span>\n               <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">ffmpeg -y -i </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>input<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> -b:v 2048k -maxrate:v 2048k -minrate:v 2048k -r 25 -movflags faststart -v fatal </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>output<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n            files<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'public/p7/xmart-os/p7-p6-1.mp4\'</span><span class="token punctuation">,</span> <span class="token string">\'public/no/p7/build-yours/p7-p1-1@long.mp4\'</span><span class="token punctuation">]</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      mpeg<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n         <span class="token number">4</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>\n            <span class="token function-variable function">bashFunc</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">input<span class="token punctuation">,</span> output</span><span class="token punctuation">)</span> <span class="token operator">=></span>\n               <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">ffmpeg -y -i </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>input<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> -f mpeg1video -codec:v mpeg1video -q 4 -bf 0 -r 25 -an -movflags faststart -v fatal </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>output<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n            files<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n               <span class="token string">\'public/p5/smart-space-internal/p5-inside.mp4\'</span><span class="token punctuation">,</span>\n               <span class="token string">\'public/p7/extra-performance/p7-chassis.mp4\'</span><span class="token punctuation">,</span>\n               <span class="token string">\'public/p7/learn-more/p7-wing.mp4\'</span><span class="token punctuation">,</span>\n               <span class="token string">\'public/g3i/xmart-os/g3i-inside.mp4\'</span>\n            <span class="token punctuation">]</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="国际化"><a href="#%E5%9B%BD%E9%99%85%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>国际化</h1>\n<h2 id="语言动态加载"><a href="#%E8%AF%AD%E8%A8%80%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>语言动态加载</h2>\n<p>利用 <code class="language-text">require.context</code> 动态读取目录下的文件内容，实现动态加载语言配置、自定义前缀功能</p>\n<h3 id="目录结构"><a href="#%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>目录结构</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="52203440915742650000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`.\n├── i18n.ts\n└── lang\n    ├── da-DK\n    ├── en-US\n    ├── nb-NO\n    ├── nl-NL\n    └── sv-SE`, `52203440915742650000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">.\n├── i18n.ts\n└── lang\n    ├── da-DK\n    ├── en-US\n    ├── nb-NO\n    ├── nl-NL\n    └── sv-SE</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="核心代码-5"><a href="#%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81-5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>核心代码</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="90726299235081440000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import i18n, { Resource } from \'i18next\';\nimport { initReactI18next } from \'react-i18next\';\nimport { DEFAULT_LANGUAGE } from \'@/constants\';\nimport path from \'path\';\nimport { camelCase } from \'lodash\';\n\nconst moduleFiles = require.context(\'./lang\', true, /\\.ts\\$/);\n\nconst resources: Resource = {};\n\nmoduleFiles.keys().forEach((item: string) => {\n   const dirname = path.dirname(item);\n   // 取路径里面的第一个目录\n   const keys = dirname.split(\'/\').filter((item) => item && item !== \'.\');\n   const [key, ...restKey] = keys;\n   if (key) {\n      let value = moduleFiles(item).default || moduleFiles(item);\n      const pathPrefix = [];\n      // 是否携带路径前缀\n      if (value.withPathPrefix) {\n         pathPrefix.push(...restKey);\n      }\n      // 是否携带文件前缀\n      if (value.withFilePrefix) {\n         const basename = path.basename(item, \'.ts\');\n         pathPrefix.push(basename);\n      }\n\n      if (pathPrefix.length > 0) {\n         const newValue: { [key: string]: any } = {};\n         const newPathPrefix = pathPrefix.map(camelCase).join(\'.\');\n         Object.keys(value).forEach((key2) => {\n            newValue[\\`\\${newPathPrefix}.\\${key2}\\`] = value[key2];\n         });\n         value = newValue;\n      }\n\n      if (resources[key]) {\n         resources[key].translation = {\n            ...(resources[key].translation as {}),\n            ...value\n         };\n      } else {\n         resources[key] = {\n            translation: value\n         };\n      }\n   }\n});\n\nexport const initLanguage = async function(language: string = DEFAULT_LANGUAGE) {\n   if (i18n.isInitialized) {\n      if (language !== i18n.language) {\n         await i18n.changeLanguage(language);\n      }\n      return;\n   }\n   return await i18n\n      .use(initReactI18next) // passes i18n down to react-i18next\n      .init({\n         resources,\n         debug: process.env.NODE_ENV === \'development\',\n         lng: language,\n         keySeparator: false, // we do not use keys in form messages.welcome\n         interpolation: {\n            escapeValue: false\n         }\n         // 不能使用数组或对象，因为需要用户去填字符串\n         // returnObjects: true\n      })\n      .catch((error) => {\n         console.info(\'initReactI18next error:\', error);\n      });\n};`, `90726299235081440000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="ts"\n              >\n                <span class="gatsby-code-button-language">ts</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="ts"><pre style="counter-reset: linenumber NaN" class="language-ts line-numbers"><code class="language-ts"><span class="token keyword">import</span> i18n<span class="token punctuation">,</span> <span class="token punctuation">{</span> Resource <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'i18next\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> initReactI18next <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react-i18next\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">DEFAULT_LANGUAGE</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@/constants\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> path <span class="token keyword">from</span> <span class="token string">\'path\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> camelCase <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'lodash\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> moduleFiles <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">.</span><span class="token function">context</span><span class="token punctuation">(</span><span class="token string">\'./lang\'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token regex">/\\.ts$/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> resources<span class="token punctuation">:</span> Resource <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n\nmoduleFiles<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">:</span> <span class="token builtin">string</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   <span class="token keyword">const</span> dirname <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token comment">// 取路径里面的第一个目录</span>\n   <span class="token keyword">const</span> keys <span class="token operator">=</span> dirname<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">\'/\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> item <span class="token operator">&amp;&amp;</span> item <span class="token operator">!==</span> <span class="token string">\'.\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">const</span> <span class="token punctuation">[</span>key<span class="token punctuation">,</span> <span class="token operator">...</span>restKey<span class="token punctuation">]</span> <span class="token operator">=</span> keys<span class="token punctuation">;</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">let</span> value <span class="token operator">=</span> <span class="token function">moduleFiles</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">default</span> <span class="token operator">||</span> <span class="token function">moduleFiles</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> pathPrefix <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token comment">// 是否携带路径前缀</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">.</span>withPathPrefix<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         pathPrefix<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span>restKey<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      <span class="token comment">// 是否携带文件前缀</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">.</span>withFilePrefix<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token keyword">const</span> basename <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">basename</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token string">\'.ts\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         pathPrefix<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>basename<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>pathPrefix<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token keyword">const</span> newValue<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span>key<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token builtin">any</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n         <span class="token keyword">const</span> newPathPrefix <span class="token operator">=</span> pathPrefix<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>camelCase<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">\'.\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">key2</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            newValue<span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>newPathPrefix<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key2<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">[</span>key2<span class="token punctuation">]</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         value <span class="token operator">=</span> newValue<span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>resources<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         resources<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span>translation <span class="token operator">=</span> <span class="token punctuation">{</span>\n            <span class="token operator">...</span><span class="token punctuation">(</span>resources<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span>translation <span class="token keyword">as</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n            <span class="token operator">...</span>value\n         <span class="token punctuation">}</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n         resources<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>\n            translation<span class="token punctuation">:</span> value\n         <span class="token punctuation">}</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">initLanguage</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">language<span class="token punctuation">:</span> <span class="token builtin">string</span> <span class="token operator">=</span> <span class="token constant">DEFAULT_LANGUAGE</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>i18n<span class="token punctuation">.</span>isInitialized<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>language <span class="token operator">!==</span> i18n<span class="token punctuation">.</span>language<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token keyword">await</span> i18n<span class="token punctuation">.</span><span class="token function">changeLanguage</span><span class="token punctuation">(</span>language<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      <span class="token keyword">return</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n   <span class="token keyword">return</span> <span class="token keyword">await</span> i18n\n      <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>initReactI18next<span class="token punctuation">)</span> <span class="token comment">// passes i18n down to react-i18next</span>\n      <span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n         resources<span class="token punctuation">,</span>\n         debug<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">\'development\'</span><span class="token punctuation">,</span>\n         lng<span class="token punctuation">:</span> language<span class="token punctuation">,</span>\n         keySeparator<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">// we do not use keys in form messages.welcome</span>\n         interpolation<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n            escapeValue<span class="token punctuation">:</span> <span class="token boolean">false</span>\n         <span class="token punctuation">}</span>\n         <span class="token comment">// 不能使用数组或对象，因为需要用户去填字符串</span>\n         <span class="token comment">// returnObjects: true</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n         <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">\'initReactI18next error:\'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>添加所需的字段：</p>\n<p>web/locales/lang/en-US/p7/app-download.ts</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="81210427678391090000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`export default {\n   withPathPrefix: true,\n   withFilePrefix: true,\n   title: \'123456\'\n};`, `81210427678391090000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="ts"\n              >\n                <span class="gatsby-code-button-language">ts</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="ts"><pre style="counter-reset: linenumber NaN" class="language-ts line-numbers"><code class="language-ts"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>\n   withPathPrefix<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n   withFilePrefix<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n   title<span class="token punctuation">:</span> <span class="token string">\'123456\'</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>使用时的代码：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="39670294518183910000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import { useTranslation } from \'react-i18next\';\nconst { t } = useTranslation();\nconst getValue = (param: string) => t(\\`p7.appDownload.\\${param}\\`);\n// console.log(getValue(\'title\'))`, `39670294518183910000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="tsx"\n              >\n                <span class="gatsby-code-button-language">tsx</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="tsx"><pre style="counter-reset: linenumber NaN" class="language-tsx line-numbers"><code class="language-tsx"><span class="token keyword">import</span> <span class="token punctuation">{</span> useTranslation <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react-i18next\'</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> <span class="token punctuation">{</span> t <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useTranslation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> <span class="token function-variable function">getValue</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">param<span class="token punctuation">:</span> <span class="token builtin">string</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">p7.appDownload.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>param<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// console.log(getValue(\'title\'))</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="路由复用"><a href="#%E8%B7%AF%E7%94%B1%E5%A4%8D%E7%94%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>路由复用</h2>\n<h3 id="需求背景-6"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h3>\n<p>国家站的页面和国际站大部分的页面相同，只是语言不同，可以复用路由</p>\n<h3 id="核心代码-6"><a href="#%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81-6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>核心代码</h3>\n<p>见标红部分代码：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="17241304222576615000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const { join } = require(\'path\')\nconst { getFeDir } = require(\'ssr-server-utils\')\nconst fs = require(\'fs\')\n\nconst countryList = [\'no\', \'se\', \'dk\', \'nl\'] // 挪威 NO, 瑞典 SE, 丹麦 DK, 荷兰 NL\n\n// https://github.com/zhangyuang/ssr/blob/8e9e5514d81f0db24a8c9e59bac8379f7a09a2c0/packages/server-utils/src/parse.ts#L159\nconst renderRoutes = (pageDir, pathRecord, route) => {\n  let arr = []\n  const pagesFolders = fs.readdirSync(pageDir)\n  const prefixPath = pathRecord.join(\'/\')\n  const aliasPath = \\`@/pages\\${prefixPath}\\`\n  const routeArr = []\n  const fetchExactMatch = pagesFolders.filter(p => p.includes(\'fetch\'))\n  for (const pageFiles of pagesFolders) {\n    const abFolder = join(pageDir, pageFiles)\n    const isDirectory = fs.lstatSync(abFolder).isDirectory()\n    if (isDirectory) {\n      // 如果是文件夹则递归下去, 记录路径\n      pathRecord.push(pageFiles)\n      const childArr = renderRoutes(abFolder, pathRecord, Object.assign({}, route))\n      pathRecord.pop() // 回溯\n      arr = arr.concat(childArr)\n    } else {\n      // 遍历一个文件夹下面的所有文件\n      if (!pageFiles.includes(\'render\')) {\n        continue\n      }\n      // 拿到具体的文件\n      if (pageFiles.includes(\'render\\$\')) {\n        /* /news/:id */\n        route.path = \\`\\${prefixPath}/:\\${getDynamicParam(pageFiles)}\\`\n        route.component = \\`\\${aliasPath}/\\${pageFiles}\\`\n        let webpackChunkName = pathRecord.join(\'-\')\n        if (webpackChunkName.startsWith(\'-\')) {\n          webpackChunkName = webpackChunkName.replace(\'-\', \'\')\n        }\n        route.webpackChunkName = \\`\\${webpackChunkName}-\\${getDynamicParam(pageFiles).replace(/\\/:\\??/g, \'-\').replace(\'?\', \'-optional\')}\\`\n      } else if (pageFiles.includes(\'render\')) {\n        /* /news */\n        route.path = \\`\\${prefixPath}\\`\n        route.component = \\`\\${aliasPath}/\\${pageFiles}\\`\n        let webpackChunkName = pathRecord.join(\'-\')\n        if (webpackChunkName.startsWith(\'-\')) {\n          webpackChunkName = webpackChunkName.replace(\'-\', \'\')\n        }\n        route.webpackChunkName = webpackChunkName\n      }\n\n      if (fetchExactMatch.length >= 2) {\n        // fetch 文件数量 >=2 启用完全匹配策略 render\\$id => fetch\\$id, render => fetch\n        const fetchPageFiles = \\`\\${pageFiles.replace(\'render\', \'fetch\').split(\'.\')[0]}.ts\\`\n        if (fetchExactMatch.includes(fetchPageFiles)) {\n          route.fetch = \\`\\${aliasPath}/\\${fetchPageFiles}\\`\n        }\n      } else if (fetchExactMatch.includes(\'fetch.ts\')) {\n        // 单 fetch 文件的情况 所有类型的 render 都对应该 fetch\n        route.fetch = \\`\\${aliasPath}/fetch.ts\\`\n      }\n      routeArr.push({ ...route })\n    }\n  }\n  routeArr.forEach((r) => {\n    if (r.path?.includes(\'index\')) {\n      r.path && arr.push(JSON.parse(JSON.stringify(r)))\n      // /index 映射为 /\n      if (r.path.split(\'/\').length >= 3) {\n        r.path = r.path.replace(\'/index\', \'\')\n      } else {\n        r.path = r.path.replace(\'index\', \'\')\n      }\n    }\n\n    r.path && arr.push(r)\n  })\n\n  return arr\n}\n\nconst getDynamicParam = (url) => {\n  return url.split(\'\\$\').filter(r => r !== \'render\' && r !== \'\').map(r => r.replace(/\\.[\\s\\S]+/, \'\').replace(\'#\', \'?\')).join(\'/:\')\n}\n\nconst accessFile = (file) => {\n  try {\n    fs.accessSync(file)\n  } catch (error) {\n    return false\n  }\n  return true\n}\n\nconst { dynamic = true, routerPriority, routerOptimize } = {}\nconst prefix = \'\'\n// 根据目录结构生成前端路由表\nconst pathRecord = [\'\'] // 路径记录\nconst route = {}\nlet arr = renderRoutes(join(getFeDir(), \'pages\'), pathRecord, route)\nif (routerPriority) {\n  // 路由优先级排序\n  arr.sort((a, b) => {\n    // 没有显示指定的路由优先级统一为 0\n    return (routerPriority[b.path] || 0) - (routerPriority[a.path] || 0)\n  })\n}\n\nif (routerOptimize) {\n  // 路由过滤\n  if (routerOptimize.include && routerOptimize.exclude) {\n    throw new Error(\'include and exclude cannot exist synchronal\')\n  }\n  if (routerOptimize.include) {\n    arr = arr.filter(route => routerOptimize.include.includes(route.path))\n  }\n  if (routerOptimize.exclude) {\n    arr = arr.filter(route => !routerOptimize.exclude.includes(route.path))\n  }\n}\n\nconst countryRoutes = []\ncountryList.forEach(country => {\n  arr.forEach(route => {\n    const path = \\`/\\${country}\\${route.path}\\`\n    // 注意这里需要去除掉 2 个国家的无效路径\n    if (arr.every(route => route.path !== path) && path.split(\'/\').filter((item) => countryList.includes(item)).length <= 1) {\n      countryRoutes.push({\n        ...route,\n        path\n      })\n    }\n    if (route.path === \'/\') {\n      countryRoutes.push({\n        ...route,\n        path: \\`/\\${country}\\`\n      })\n    }\n  })\n})\n\narr = arr.concat(countryRoutes)\n\nconst accessReactApp = accessFile(join(getFeDir(), \'./components/layout/App.tsx\'))\nconst layoutFetch = accessFile(join(getFeDir(), \'./components/layout/fetch.ts\'))\nconst accessStore = accessFile(join(getFeDir(), \'./store/index.ts\'))\nconst re = /&quot;webpackChunkName&quot;:(&quot;(.+?)&quot;)/g\n\nlet routes = \\`\n        // The file is provisional，don\'t depend on it\n        export const FeRoutes = \\${JSON.stringify(arr)}\n        \\${accessReactApp ? \'export { default as App } from &quot;@/components/layout/App.tsx&quot;\' : \'\'}\n        \\${layoutFetch ? \'export { default as layoutFetch } from &quot;@/components/layout/fetch.ts&quot;\' : \'\'}\n        \\${accessStore ? \'export * from &quot;@/store/index.ts&quot;\' : \'\'}\n        \\${prefix ? \\`export const PrefixRouterBase=\'\\${prefix}\'\\` : \'\'}\n      \\`\nroutes = routes.replace(/&quot;component&quot;:(&quot;(.+?)&quot;)/g, (global, m1, m2) => {\n  const currentWebpackChunkName = re.exec(routes)[2]\n  if (dynamic) {\n    return \\`&quot;component&quot;: function dynamicComponent () {\n            return import(/* webpackChunkName: &quot;\\${currentWebpackChunkName}&quot; */ \'\\${m2.replace(/\\^/g, \'&quot;\')}\')\n          }\n          \\`\n  } else {\n    return \\`&quot;component&quot;: require(\'\\${m2.replace(/\\^/g, \'&quot;\')}\').default\\`\n  }\n})\nre.lastIndex = 0\nroutes = routes.replace(/&quot;fetch&quot;:(&quot;(.+?)&quot;)/g, (global, m1, m2) => {\n  const currentWebpackChunkName = re.exec(routes)[2]\n  return \\`&quot;fetch&quot;: () => import(/* webpackChunkName: &quot;\\${currentWebpackChunkName}-fetch&quot; */ \'\\${m2.replace(/\\^/g, \'&quot;\')}\')\\`\n})\n\nfs.writeFileSync(join(getFeDir(), \'route.ts\'), routes)\n// 替换以下 console.log 内容即可在 router.json 文件找到所有的官网路径\n// console.log(arr.map((item) => item.path).join(\'\\n\'))\nfs.writeFileSync(join(__dirname, \'../src/router.json\'), JSON.stringify(arr))`, `17241304222576615000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="ts{120-140}"\n              >\n                <span class="gatsby-code-button-language">ts{120-140}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="ts"><pre style="counter-reset: linenumber NaN" class="language-ts line-numbers"><code class="language-ts"><span class="token keyword">const</span> <span class="token punctuation">{</span> join <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">\'path\'</span><span class="token punctuation">)</span>\n<span class="token keyword">const</span> <span class="token punctuation">{</span> getFeDir <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">\'ssr-server-utils\'</span><span class="token punctuation">)</span>\n<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">\'fs\'</span><span class="token punctuation">)</span>\n\n<span class="token keyword">const</span> countryList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'no\'</span><span class="token punctuation">,</span> <span class="token string">\'se\'</span><span class="token punctuation">,</span> <span class="token string">\'dk\'</span><span class="token punctuation">,</span> <span class="token string">\'nl\'</span><span class="token punctuation">]</span> <span class="token comment">// 挪威 NO, 瑞典 SE, 丹麦 DK, 荷兰 NL</span>\n\n<span class="token comment">// https://github.com/zhangyuang/ssr/blob/8e9e5514d81f0db24a8c9e59bac8379f7a09a2c0/packages/server-utils/src/parse.ts#L159</span>\n<span class="token keyword">const</span> <span class="token function-variable function">renderRoutes</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">pageDir<span class="token punctuation">,</span> pathRecord<span class="token punctuation">,</span> route</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">let</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n  <span class="token keyword">const</span> pagesFolders <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readdirSync</span><span class="token punctuation">(</span>pageDir<span class="token punctuation">)</span>\n  <span class="token keyword">const</span> prefixPath <span class="token operator">=</span> pathRecord<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">\'/\'</span><span class="token punctuation">)</span>\n  <span class="token keyword">const</span> aliasPath <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">@/pages</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>prefixPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>\n  <span class="token keyword">const</span> routeArr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n  <span class="token keyword">const</span> fetchExactMatch <span class="token operator">=</span> pagesFolders<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">p</span> <span class="token operator">=></span> p<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">\'fetch\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> pageFiles <span class="token keyword">of</span> pagesFolders<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> abFolder <span class="token operator">=</span> <span class="token function">join</span><span class="token punctuation">(</span>pageDir<span class="token punctuation">,</span> pageFiles<span class="token punctuation">)</span>\n    <span class="token keyword">const</span> isDirectory <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">lstatSync</span><span class="token punctuation">(</span>abFolder<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>isDirectory<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 如果是文件夹则递归下去, 记录路径</span>\n      pathRecord<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>pageFiles<span class="token punctuation">)</span>\n      <span class="token keyword">const</span> childArr <span class="token operator">=</span> <span class="token function">renderRoutes</span><span class="token punctuation">(</span>abFolder<span class="token punctuation">,</span> pathRecord<span class="token punctuation">,</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> route<span class="token punctuation">)</span><span class="token punctuation">)</span>\n      pathRecord<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 回溯</span>\n      arr <span class="token operator">=</span> arr<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>childArr<span class="token punctuation">)</span>\n    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 遍历一个文件夹下面的所有文件</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pageFiles<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">\'render\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">continue</span>\n      <span class="token punctuation">}</span>\n      <span class="token comment">// 拿到具体的文件</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>pageFiles<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">\'render$\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token comment">/* /news/:id */</span>\n        route<span class="token punctuation">.</span>path <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>prefixPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">getDynamicParam</span><span class="token punctuation">(</span>pageFiles<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>\n        route<span class="token punctuation">.</span>component <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>aliasPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>pageFiles<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>\n        <span class="token keyword">let</span> webpackChunkName <span class="token operator">=</span> pathRecord<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">\'-\'</span><span class="token punctuation">)</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>webpackChunkName<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">\'-\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          webpackChunkName <span class="token operator">=</span> webpackChunkName<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">\'-\'</span><span class="token punctuation">,</span> <span class="token string">\'\'</span><span class="token punctuation">)</span>\n        <span class="token punctuation">}</span>\n        route<span class="token punctuation">.</span>webpackChunkName <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>webpackChunkName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">getDynamicParam</span><span class="token punctuation">(</span>pageFiles<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\\/:\\??/g</span><span class="token punctuation">,</span> <span class="token string">\'-\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">\'?\'</span><span class="token punctuation">,</span> <span class="token string">\'-optional\'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>\n      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>pageFiles<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">\'render\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token comment">/* /news */</span>\n        route<span class="token punctuation">.</span>path <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>prefixPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>\n        route<span class="token punctuation">.</span>component <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>aliasPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>pageFiles<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>\n        <span class="token keyword">let</span> webpackChunkName <span class="token operator">=</span> pathRecord<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">\'-\'</span><span class="token punctuation">)</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>webpackChunkName<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">\'-\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          webpackChunkName <span class="token operator">=</span> webpackChunkName<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">\'-\'</span><span class="token punctuation">,</span> <span class="token string">\'\'</span><span class="token punctuation">)</span>\n        <span class="token punctuation">}</span>\n        route<span class="token punctuation">.</span>webpackChunkName <span class="token operator">=</span> webpackChunkName\n      <span class="token punctuation">}</span>\n\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>fetchExactMatch<span class="token punctuation">.</span>length <span class="token operator">>=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token comment">// fetch 文件数量 >=2 启用完全匹配策略 render$id => fetch$id, render => fetch</span>\n        <span class="token keyword">const</span> fetchPageFiles <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>pageFiles<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">\'render\'</span><span class="token punctuation">,</span> <span class="token string">\'fetch\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">\'.\'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.ts</span><span class="token template-punctuation string">`</span></span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>fetchExactMatch<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>fetchPageFiles<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          route<span class="token punctuation">.</span>fetch <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>aliasPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>fetchPageFiles<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>fetchExactMatch<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">\'fetch.ts\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token comment">// 单 fetch 文件的情况 所有类型的 render 都对应该 fetch</span>\n        route<span class="token punctuation">.</span>fetch <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>aliasPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/fetch.ts</span><span class="token template-punctuation string">`</span></span>\n      <span class="token punctuation">}</span>\n      routeArr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>route <span class="token punctuation">}</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n  routeArr<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">r</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>path<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">\'index\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      r<span class="token punctuation">.</span>path <span class="token operator">&amp;&amp;</span> arr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n      <span class="token comment">// /index 映射为 /</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>path<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">\'/\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">>=</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        r<span class="token punctuation">.</span>path <span class="token operator">=</span> r<span class="token punctuation">.</span>path<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">\'/index\'</span><span class="token punctuation">,</span> <span class="token string">\'\'</span><span class="token punctuation">)</span>\n      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n        r<span class="token punctuation">.</span>path <span class="token operator">=</span> r<span class="token punctuation">.</span>path<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">\'index\'</span><span class="token punctuation">,</span> <span class="token string">\'\'</span><span class="token punctuation">)</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n\n    r<span class="token punctuation">.</span>path <span class="token operator">&amp;&amp;</span> arr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span>\n\n  <span class="token keyword">return</span> arr\n<span class="token punctuation">}</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">getDynamicParam</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> url<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">\'$\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">r</span> <span class="token operator">=></span> r <span class="token operator">!==</span> <span class="token string">\'render\'</span> <span class="token operator">&amp;&amp;</span> r <span class="token operator">!==</span> <span class="token string">\'\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">r</span> <span class="token operator">=></span> r<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\\.[\\s\\S]+/</span><span class="token punctuation">,</span> <span class="token string">\'\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">\'#\'</span><span class="token punctuation">,</span> <span class="token string">\'?\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">\'/:\'</span><span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">accessFile</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">file</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">try</span> <span class="token punctuation">{</span>\n    fs<span class="token punctuation">.</span><span class="token function">accessSync</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span>\n  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token boolean">false</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">return</span> <span class="token boolean">true</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">const</span> <span class="token punctuation">{</span> dynamic <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> routerPriority<span class="token punctuation">,</span> routerOptimize <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n<span class="token keyword">const</span> prefix <span class="token operator">=</span> <span class="token string">\'\'</span>\n<span class="token comment">// 根据目录结构生成前端路由表</span>\n<span class="token keyword">const</span> pathRecord <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'\'</span><span class="token punctuation">]</span> <span class="token comment">// 路径记录</span>\n<span class="token keyword">const</span> route <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n<span class="token keyword">let</span> arr <span class="token operator">=</span> <span class="token function">renderRoutes</span><span class="token punctuation">(</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token function">getFeDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">\'pages\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pathRecord<span class="token punctuation">,</span> route<span class="token punctuation">)</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span>routerPriority<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 路由优先级排序</span>\n  arr<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token comment">// 没有显示指定的路由优先级统一为 0</span>\n    <span class="token keyword">return</span> <span class="token punctuation">(</span>routerPriority<span class="token punctuation">[</span>b<span class="token punctuation">.</span>path<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span>routerPriority<span class="token punctuation">[</span>a<span class="token punctuation">.</span>path<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">)</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">if</span> <span class="token punctuation">(</span>routerOptimize<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 路由过滤</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>routerOptimize<span class="token punctuation">.</span>include <span class="token operator">&amp;&amp;</span> routerOptimize<span class="token punctuation">.</span>exclude<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">\'include and exclude cannot exist synchronal\'</span><span class="token punctuation">)</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>routerOptimize<span class="token punctuation">.</span>include<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    arr <span class="token operator">=</span> arr<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">route</span> <span class="token operator">=></span> routerOptimize<span class="token punctuation">.</span>include<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>route<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>routerOptimize<span class="token punctuation">.</span>exclude<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    arr <span class="token operator">=</span> arr<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">route</span> <span class="token operator">=></span> <span class="token operator">!</span>routerOptimize<span class="token punctuation">.</span>exclude<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>route<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="gatsby-highlight-code-line"><span class="token keyword">const</span> countryRoutes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="gatsby-highlight-code-line">countryList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">country</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">  arr<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">route</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    <span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>country<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>route<span class="token punctuation">.</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span></span><span class="gatsby-highlight-code-line">    <span class="token comment">// 注意这里需要去除掉 2 个国家的无效路径</span></span><span class="gatsby-highlight-code-line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>arr<span class="token punctuation">.</span><span class="token function">every</span><span class="token punctuation">(</span><span class="token parameter">route</span> <span class="token operator">=></span> route<span class="token punctuation">.</span>path <span class="token operator">!==</span> path<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> path<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">\'/\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> countryList<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      countryRoutes<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">        <span class="token operator">...</span>route<span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">        path</span><span class="gatsby-highlight-code-line">      <span class="token punctuation">}</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>route<span class="token punctuation">.</span>path <span class="token operator">===</span> <span class="token string">\'/\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      countryRoutes<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">        <span class="token operator">...</span>route<span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">        path<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>country<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span></span><span class="gatsby-highlight-code-line">      <span class="token punctuation">}</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line">arr <span class="token operator">=</span> arr<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>countryRoutes<span class="token punctuation">)</span></span>\n<span class="token keyword">const</span> accessReactApp <span class="token operator">=</span> <span class="token function">accessFile</span><span class="token punctuation">(</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token function">getFeDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">\'./components/layout/App.tsx\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">const</span> layoutFetch <span class="token operator">=</span> <span class="token function">accessFile</span><span class="token punctuation">(</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token function">getFeDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">\'./components/layout/fetch.ts\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">const</span> accessStore <span class="token operator">=</span> <span class="token function">accessFile</span><span class="token punctuation">(</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token function">getFeDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">\'./store/index.ts\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">const</span> re <span class="token operator">=</span> <span class="token regex">/"webpackChunkName":("(.+?)")/g</span>\n\n<span class="token keyword">let</span> routes <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"></span>\n<span class="token string">        // The file is provisional，don\'t depend on it</span>\n<span class="token string">        export const FeRoutes = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"></span>\n<span class="token string">        </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>accessReactApp <span class="token operator">?</span> <span class="token string">\'export { default as App } from "@/components/layout/App.tsx"\'</span> <span class="token punctuation">:</span> <span class="token string">\'\'</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"></span>\n<span class="token string">        </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>layoutFetch <span class="token operator">?</span> <span class="token string">\'export { default as layoutFetch } from "@/components/layout/fetch.ts"\'</span> <span class="token punctuation">:</span> <span class="token string">\'\'</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"></span>\n<span class="token string">        </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>accessStore <span class="token operator">?</span> <span class="token string">\'export * from "@/store/index.ts"\'</span> <span class="token punctuation">:</span> <span class="token string">\'\'</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"></span>\n<span class="token string">        </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>prefix <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">export const PrefixRouterBase=\'</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>prefix<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\'</span><span class="token template-punctuation string">`</span></span> <span class="token punctuation">:</span> <span class="token string">\'\'</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"></span>\n<span class="token string">      </span><span class="token template-punctuation string">`</span></span>\nroutes <span class="token operator">=</span> routes<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/"component":("(.+?)")/g</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">global<span class="token punctuation">,</span> m1<span class="token punctuation">,</span> m2</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> currentWebpackChunkName <span class="token operator">=</span> re<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>routes<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>dynamic<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">"component": function dynamicComponent () {</span>\n<span class="token string">            return import(/* webpackChunkName: "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>currentWebpackChunkName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">" */ \'</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>m2<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\\^/g</span><span class="token punctuation">,</span> <span class="token string">\'"\'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\')</span>\n<span class="token string">          }</span>\n<span class="token string">          </span><span class="token template-punctuation string">`</span></span>\n  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">"component": require(\'</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>m2<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\\^/g</span><span class="token punctuation">,</span> <span class="token string">\'"\'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\').default</span><span class="token template-punctuation string">`</span></span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span>\nre<span class="token punctuation">.</span>lastIndex <span class="token operator">=</span> <span class="token number">0</span>\nroutes <span class="token operator">=</span> routes<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/"fetch":("(.+?)")/g</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">global<span class="token punctuation">,</span> m1<span class="token punctuation">,</span> m2</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> currentWebpackChunkName <span class="token operator">=</span> re<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>routes<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>\n  <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">"fetch": () => import(/* webpackChunkName: "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>currentWebpackChunkName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-fetch" */ \'</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>m2<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\\^/g</span><span class="token punctuation">,</span> <span class="token string">\'"\'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\')</span><span class="token template-punctuation string">`</span></span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span>\n\nfs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token function">getFeDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">\'route.ts\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> routes<span class="token punctuation">)</span>\n<span class="token comment">// 替换以下 console.log 内容即可在 router.json 文件找到所有的官网路径</span>\n<span class="token comment">// console.log(arr.map((item) => item.path).join(\'\\n\'))</span>\nfs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">\'../src/router.json\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="多平台适配"><a href="#%E5%A4%9A%E5%B9%B3%E5%8F%B0%E9%80%82%E9%85%8D" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>多平台适配</h1>\n<h2 id="需求背景-7"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h2>\n<p>需要适配 PC、H5 的样式</p>\n<h2 id="选型过程-5"><a href="#%E9%80%89%E5%9E%8B%E8%BF%87%E7%A8%8B-5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>选型过程</h2>\n<ol>\n<li>PC 使用 rem 单位，h5 使用 vw 单位（ipad 端适配有问题，需要全部使用 rem 单位，便于样式控制），使用 @our-patches/postcss-px-to-viewport 插件做转换</li>\n<li>h5 端 100vh 的高度展示有问题，需要实时计算高度，使用 postcss-viewport-height-correction 插件实现</li>\n</ol>\n<h2 id="核心代码-7"><a href="#%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81-7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>核心代码</h2>\n<p>postcss.config.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="38829429298084640000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`module.exports = {\n   plugins: [\n      [\n         \'@our-patches/postcss-px-to-viewport\',\n         {\n            // https://github.com/evrone/postcss-px-to-viewport/blob/master/README_CN.md\n            unitToConvert: \'px\', // 需要转换的单位，默认为&quot;px&quot;\n            viewportWidth: 1920, // 视窗的宽度，对应设计稿的宽度\n            unitPrecision: 8, // 指定 px 转换为视窗单位值的小数后 x 位数，转换精度尽可能的大，防止出现图片比例问题\n            viewportUnit: \'rem\', // 希望使用的视口单位\n            fontViewportUnit: \'rem\', // 字体使用的视口单位,\n            minPixelValue: 1, // 最小的转换数值\n            mediaQuery: true, // 媒体查询里的单位是否需要转换单位\n            selectorBlackList: [/^html\\$/, \'hack\'],\n            exclude: /node_modules/,\n            include: [/(\\\\|\\/)web(\\\\|\\/)/]\n         }\n      ],\n      // 此插件主要修复了移动端 100vh 的高度（即减去搜索框的高度），需要配合 script 脚本实现，详见 postcss-viewport-height-correction 文档\n      // 效果：https://codepen.io/team/css-tricks/full/vapjge\n      // https://css-tricks.com/the-trick-to-viewport-units-on-mobile/\n      \'postcss-viewport-height-correction\'\n   ]\n};`, `38829429298084640000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>\n   plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n      <span class="token punctuation">[</span>\n         <span class="token string">\'@our-patches/postcss-px-to-viewport\'</span><span class="token punctuation">,</span>\n         <span class="token punctuation">{</span>\n            <span class="token comment">// https://github.com/evrone/postcss-px-to-viewport/blob/master/README_CN.md</span>\n            unitToConvert<span class="token punctuation">:</span> <span class="token string">\'px\'</span><span class="token punctuation">,</span> <span class="token comment">// 需要转换的单位，默认为"px"</span>\n            viewportWidth<span class="token punctuation">:</span> <span class="token number">1920</span><span class="token punctuation">,</span> <span class="token comment">// 视窗的宽度，对应设计稿的宽度</span>\n            unitPrecision<span class="token punctuation">:</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token comment">// 指定 px 转换为视窗单位值的小数后 x 位数，转换精度尽可能的大，防止出现图片比例问题</span>\n            viewportUnit<span class="token punctuation">:</span> <span class="token string">\'rem\'</span><span class="token punctuation">,</span> <span class="token comment">// 希望使用的视口单位</span>\n            fontViewportUnit<span class="token punctuation">:</span> <span class="token string">\'rem\'</span><span class="token punctuation">,</span> <span class="token comment">// 字体使用的视口单位,</span>\n            minPixelValue<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// 最小的转换数值</span>\n            mediaQuery<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 媒体查询里的单位是否需要转换单位</span>\n            selectorBlackList<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token regex">/^html$/</span><span class="token punctuation">,</span> <span class="token string">\'hack\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n            exclude<span class="token punctuation">:</span> <span class="token regex">/node_modules/</span><span class="token punctuation">,</span>\n            include<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token regex">/(\\\\|\\/)web(\\\\|\\/)/</span><span class="token punctuation">]</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">]</span><span class="token punctuation">,</span>\n      <span class="token comment">// 此插件主要修复了移动端 100vh 的高度（即减去搜索框的高度），需要配合 script 脚本实现，详见 postcss-viewport-height-correction 文档</span>\n      <span class="token comment">// 效果：https://codepen.io/team/css-tricks/full/vapjge</span>\n      <span class="token comment">// https://css-tricks.com/the-trick-to-viewport-units-on-mobile/</span>\n      <span class="token string">\'postcss-viewport-height-correction\'</span>\n   <span class="token punctuation">]</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="swiper"><a href="#swiper" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>swiper</h1>\n<h2 id="需求背景-8"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h2>\n<ol>\n<li>swiper 嵌套时的垂直滚动不会离开当前嵌套的容器，需要做到滚动到边缘会离开当前嵌套容器即边缘检测</li>\n<li>需要实现 swiper 延迟滚动、解决滚轮不够顺滑问题</li>\n</ol>\n<h2 id="核心代码-8"><a href="#%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81-8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>核心代码</h2>\n<h3 id="嵌套边缘检测"><a href="#%E5%B5%8C%E5%A5%97%E8%BE%B9%E7%BC%98%E6%A3%80%E6%B5%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>嵌套边缘检测</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="73412078577189920000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const handleContainerWheel = (element) => {\n   const scrollHeight = element.scrollHeight\n   const slideSize = element.swiperSlideSize\n   const scrollDifferenceTop = scrollHeight - slideSize\n\n   const handleWheel = (event) => {\n      const scrollDifference = scrollHeight - slideSize - element.scrollTop\n\n      // Scroll wheel browser compatibility\n      const delta = event.wheelDelta || -1 * event.deltaY\n\n      // Enable scrolling if at edges\n      const spos = delta < 0 ? 0 : scrollDifferenceTop\n      const parseScrollDifference = Number.parseInt(\\`\\${scrollDifference}\\`)\n      const parseSpos = Number.parseInt(\\`\\${spos}\\`)\n\n      console.log(scrollDifference, spos)\n      if (parseScrollDifference !== parseSpos) {\n         console.log(\'stopPropagation\')\n         event.stopPropagation()\n      } else {\n         // 边缘释放参数关闭时才生效\n         if (!swiperRef?.current?.params?.mousewheel?.releaseOnEdges) {\n            // 滑动到最后一个幻灯片的底部，继续监听事件\n            if (parseScrollDifference === 0 && parseSpos === 0 && current === swiperRef?.current?.slides?.length - 1) {\n               return\n            }\n            // 滑动到第一个幻灯片的顶部，暂不处理，暂时没有首屏有滚动条的情况\n         }\n         element.removeEventListener(\'wheel\', handleWheel)\n         element.removeEventListener(\'scroll\', handleScroll)\n      }\n   }\n\n   element.addEventListener(\'wheel\', handleWheel)\n}\n\nconst handleScrollContainerEvent = (activeSlide: ActiveSlide) => {\n   const hasVerticalScrollbar = activeSlide.scrollHeight > activeSlide.clientHeight;\n   if (!hasVerticalScrollbar) {\n      return;\n   }\n   // 进入时重置滚动条\n   activeSlide.scrollTo(0, 0);\n   activeSlide.addEventListener(\'scroll\', handleScroll);\n   handleContainerWheel(activeSlide);\n}\n\n// 监听 swiper 的 onSlideChange 事件\nreturn (\n   <Swiper\n      onSlideChange={(slide) => {\n         swiperRef.current = slide;\n         if (haveNestedScrollbar) {\n            handleScrollContainerEvent(slide.slides[slide.realIndex] as ActiveSlide);\n         }\n      }}\n   ></Swiper>\n)`, `73412078577189920000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="tsx"\n              >\n                <span class="gatsby-code-button-language">tsx</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="tsx"><pre style="counter-reset: linenumber NaN" class="language-tsx line-numbers"><code class="language-tsx"><span class="token keyword">const</span> <span class="token function-variable function">handleContainerWheel</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   <span class="token keyword">const</span> scrollHeight <span class="token operator">=</span> element<span class="token punctuation">.</span>scrollHeight\n   <span class="token keyword">const</span> slideSize <span class="token operator">=</span> element<span class="token punctuation">.</span>swiperSlideSize\n   <span class="token keyword">const</span> scrollDifferenceTop <span class="token operator">=</span> scrollHeight <span class="token operator">-</span> slideSize\n\n   <span class="token keyword">const</span> <span class="token function-variable function">handleWheel</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> scrollDifference <span class="token operator">=</span> scrollHeight <span class="token operator">-</span> slideSize <span class="token operator">-</span> element<span class="token punctuation">.</span>scrollTop\n\n      <span class="token comment">// Scroll wheel browser compatibility</span>\n      <span class="token keyword">const</span> delta <span class="token operator">=</span> event<span class="token punctuation">.</span>wheelDelta <span class="token operator">||</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">*</span> event<span class="token punctuation">.</span>deltaY\n\n      <span class="token comment">// Enable scrolling if at edges</span>\n      <span class="token keyword">const</span> spos <span class="token operator">=</span> delta <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token punctuation">:</span> scrollDifferenceTop\n      <span class="token keyword">const</span> parseScrollDifference <span class="token operator">=</span> Number<span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>scrollDifference<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>\n      <span class="token keyword">const</span> parseSpos <span class="token operator">=</span> Number<span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>spos<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>\n\n      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>scrollDifference<span class="token punctuation">,</span> spos<span class="token punctuation">)</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>parseScrollDifference <span class="token operator">!==</span> parseSpos<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'stopPropagation\'</span><span class="token punctuation">)</span>\n         event<span class="token punctuation">.</span><span class="token function">stopPropagation</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n         <span class="token comment">// 边缘释放参数关闭时才生效</span>\n         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>swiperRef<span class="token operator">?</span><span class="token punctuation">.</span>current<span class="token operator">?</span><span class="token punctuation">.</span>params<span class="token operator">?</span><span class="token punctuation">.</span>mousewheel<span class="token operator">?</span><span class="token punctuation">.</span>releaseOnEdges<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token comment">// 滑动到最后一个幻灯片的底部，继续监听事件</span>\n            <span class="token keyword">if</span> <span class="token punctuation">(</span>parseScrollDifference <span class="token operator">===</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> parseSpos <span class="token operator">===</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> current <span class="token operator">===</span> swiperRef<span class="token operator">?</span><span class="token punctuation">.</span>current<span class="token operator">?</span><span class="token punctuation">.</span>slides<span class="token operator">?</span><span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n               <span class="token keyword">return</span>\n            <span class="token punctuation">}</span>\n            <span class="token comment">// 滑动到第一个幻灯片的顶部，暂不处理，暂时没有首屏有滚动条的情况</span>\n         <span class="token punctuation">}</span>\n         element<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span><span class="token string">\'wheel\'</span><span class="token punctuation">,</span> handleWheel<span class="token punctuation">)</span>\n         element<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span><span class="token string">\'scroll\'</span><span class="token punctuation">,</span> handleScroll<span class="token punctuation">)</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span>\n\n   element<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">\'wheel\'</span><span class="token punctuation">,</span> handleWheel<span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">handleScrollContainerEvent</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">activeSlide<span class="token punctuation">:</span> ActiveSlide</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   <span class="token keyword">const</span> hasVerticalScrollbar <span class="token operator">=</span> activeSlide<span class="token punctuation">.</span>scrollHeight <span class="token operator">></span> activeSlide<span class="token punctuation">.</span>clientHeight<span class="token punctuation">;</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hasVerticalScrollbar<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n   <span class="token comment">// 进入时重置滚动条</span>\n   activeSlide<span class="token punctuation">.</span><span class="token function">scrollTo</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   activeSlide<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">\'scroll\'</span><span class="token punctuation">,</span> handleScroll<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token function">handleContainerWheel</span><span class="token punctuation">(</span>activeSlide<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// 监听 swiper 的 onSlideChange 事件</span>\n<span class="token keyword">return</span> <span class="token punctuation">(</span>\n   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Swiper</span></span>\n      <span class="token attr-name">onSlideChange</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token parameter">slide</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n         swiperRef<span class="token punctuation">.</span>current <span class="token operator">=</span> slide<span class="token punctuation">;</span>\n         <span class="token keyword">if</span> <span class="token punctuation">(</span>haveNestedScrollbar<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token function">handleScrollContainerEvent</span><span class="token punctuation">(</span>slide<span class="token punctuation">.</span>slides<span class="token punctuation">[</span>slide<span class="token punctuation">.</span>realIndex<span class="token punctuation">]</span> <span class="token keyword">as</span> ActiveSlide<span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span><span class="token punctuation">}</span></span>\n   <span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Swiper</span></span><span class="token punctuation">></span></span>\n<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="延迟滚动"><a href="#%E5%BB%B6%E8%BF%9F%E6%BB%9A%E5%8A%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>延迟滚动</h3>\n<p>具体代码见 <a href="https://github.com/towavephone/swiper/commit/c7daf2d123e4fdda385b69c1eaa636d876562ee3" target="_blank" rel="nofollow noreferrer noopener">这里</a></p>\n<h2 id="运行效果-5"><a href="#%E8%BF%90%E8%A1%8C%E6%95%88%E6%9E%9C-5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>运行效果</h2>\n<h3 id="延迟滚动-1"><a href="#%E5%BB%B6%E8%BF%9F%E6%BB%9A%E5%8A%A8-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>延迟滚动</h3>\n<!-- <iframe data-src="https://codesandbox.io/embed/n67jtt?codemirror=1&hidenavigation=1&theme=light&view=preview" class="embedded-codesandbox" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe> --><html><head></head><body></body></html>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/x34hxw?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h1 id="懒加载"><a href="#%E6%87%92%E5%8A%A0%E8%BD%BD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>懒加载</h1>\n<h2 id="需求背景-9"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h2>\n<p>需要对图片、视频进行懒加载</p>\n<h2 id="选型过程-6"><a href="#%E9%80%89%E5%9E%8B%E8%BF%87%E7%A8%8B-6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>选型过程</h2>\n<table>\n<thead>\n<tr>\n<th align="left">选型</th>\n<th align="left">优点</th>\n<th align="left">缺点</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align="left"><a href="https://github.com/tuupola/lazyload" target="_blank" rel="nofollow noreferrer noopener">lazyload</a></td>\n<td align="left">支持 img 延迟加载</td>\n<td align="left">不支持 video 延迟加载</td>\n</tr>\n<tr>\n<td align="left"><a href="https://github.com/aFarkas/lazysizes" target="_blank" rel="nofollow noreferrer noopener">lazysizes</a></td>\n<td align="left">支持 img、iframe 延迟加载</td>\n<td align="left">不支持 video 延迟加载</td>\n</tr>\n<tr>\n<td align="left"><a href="https://github.com/verlok/vanilla-lazyload" target="_blank" rel="nofollow noreferrer noopener">vanilla-lazyload</a></td>\n<td align="left"><a href="https://github.com/verlok/vanilla-lazyload#vanilla-lazyload-vs-lazysizes" target="_blank" rel="nofollow noreferrer noopener">优点</a></td>\n<td align="left">需要手动通知 dom 变化</td>\n</tr>\n</tbody>\n</table>\n<h2 id="实现难点"><a href="#%E5%AE%9E%E7%8E%B0%E9%9A%BE%E7%82%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>实现难点</h2>\n<ol>\n<li>lazyloader 循环引用导致的报错、检测</li>\n<li>lazyloader 加载不同分辨率的图片（ahooks 的 useReponsive 封装有问题，需要自己重新封装）</li>\n<li>封装使用形式类似 react-spring 的 lazyloader</li>\n<li>动态监听 src/srcSet 实现同步</li>\n<li>需要封装各种使用形式的组件，为此需要合理组织文件结构，需要实现的功能大致如下</li>\n</ol>\n<table>\n  <thead>\n    <tr>\n      <th>UI 类型</th>\n      <th>平台</th>\n      <th>策略</th>\n      <th>详细说明</th>\n      <th>传递属性</th>\n      <th>代码示例</th>\n   </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <td rowspan="9">视频</td>\n      <td rowspan="8">pc</td>\n      <td>自动播放</td>\n      <td>默认自动循环静音播放</td>\n      <td>playStrategy = \'autoPlay\'，默认不用传</td>\n      <td></td>\n    </tr>\n    <tr>\n      <td>点击播放</td>\n      <td>点击循环静音播放、带自定义播放图标</td>\n      <td>playStrategy = \'clickPlay\'</td>\n      <td></td>\n    </tr>\n    <tr>\n      <td>按住播放</td>\n      <td>按住循环播放、带自定义播放图标、带播放进度条显示</td>\n      <td>playStrategy = \'pressHoldPlay\'</td>\n      <td></td>\n    </tr>\n    <tr>\n      <td>点击视频弹窗播放</td>\n      <td>短视频自动循环静音播放，点击短视频后弹窗自动播放长视频一次</td>\n      <td>\n         <ol>\n            <li>传递 playStrategy = \'clickVideoModalPlay\'</li>\n            <li>原有的 srcSet、minSrcSet、src 控制短视频，这 3 个属性加上 long 前缀控制长视频，即 longSrcSet、longMinSrcSet、longSrc，如果不传 long 前缀属性则取短视频属性</li>\n            <li>通过 ref 控制弹窗打开，调用 videoRef.current?.openModal()</li>\n         </ol>\n      </td>\n      <td>\n         import { l, ClickVideoModalPlayRef } from &#x27;@/components/lazyLoader&#x27;\n         <br/>\n         <br/>\n         const videoRef = useRef&lt;ClickVideoModalPlayRef&gt;(null)\n         <br/>\n         <br/>\n         // 调用示例\n         useEffect(() =&gt; {\n            setTimeout(() =&gt; {\n               videoRef.current?.openModal()\n            }, 6000)\n         }, [])\n         <br/>\n         <br/>\n         &lt;l.video\n            ref={videoRef}\n            playStrategy=&quot;clickVideoModalPlay&quot;\n            src=&quot;/public/p7/xmart-os/p7-p6-1@short.mp4&quot;\n            longSrc=&quot;/public/p7/xmart-os/p7-p6-1@long.mp4&quot; // 不传则取 src\n         /&gt;\n      </td>\n    </tr>\n    <tr>\n      <td>悬停播放</td>\n      <td>鼠标悬浮循环静音播放视频，离开时回到初始状态</td>\n      <td>playStrategy = \'mouseOverPlay\'</td>\n      <td></td>\n    </tr>\n    <tr>\n      <td>进度控制</td>\n      <td>控制视频进度</td>\n      <td>playStrategy = \'progressControl\'，传递 progress（百分比，以 1 为单位）控制视频进度</td>\n      <td></td>\n    </tr>\n    <tr>\n      <td>点击播放（带控制条，播放状态控制）</td>\n      <td>点击后播放一次视频、自带控制条、初始播放状态控制</td>\n      <td>playStrategy = \'clickPlayWithControl\'，传递 playing 控制初始播放状态</td>\n      <td></td>\n    </tr>\n    <tr>\n      <td>进入视口播放一次</td>\n      <td>完全 100% 看到视频从头开始播放一次（每次看到视频就会触发）</td>\n      <td>playStrategy = \'inViewportPlay\'</td>\n      <td></td>\n    </tr>\n    <tr>\n      <td>h5</td>\n      <td>点击图片弹窗播放</td>\n      <td>\n         <ol>\n            <li>\n               图片展示，带自定义播放图标，如无图片则取原视频第一帧\n            </li>\n            <li>\n               点击自定义播放图标弹窗自动播放一次视频\n            </li>\n         </ol>\n      </td>\n      <td>\n         <ol>\n            <li>\n               传 srcSetPoster, srcPoster, minSrcSetPoster 作为封面图片，可以只传 srcPoster\n            </li>\n            <li>\n               默认 h5 使用此策略，不需要传 playStrategy（playStrategy === \'clickImgModalPlay\'）\n            </li>\n            <li>\n               如需覆盖请直接传具体的 playStrategy\n            </li>\n            <li>\n               需要保证播放图标可以点击，全屏视频有可能点击不到，需要把视频样式的 z-index 去掉\n            </li>\n            <li>\n               传递 playIconPosition 代表播放按钮位置\n            </li>\n            <li>\n               showPlayIcon 代表是否展示播放图标\n            </li>\n            <li>\n               通过 ref 控制弹窗打开，调用 videoRef.current?.openModal()\n            </li>\n         </ol>\n      </td>\n      <td></td>\n    </tr>\n    <tr>\n      <td rowspan="2">图片</td>\n      <td>pc</td>\n      <td>正常展示</td>\n      <td></td>\n      <td></td>\n      <td></td>\n    </tr>\n    <tr>\n      <td>h5</td>\n      <td>弹窗展示</td>\n      <td>点击弹窗后展示，等比例放大，宽度自适应（弹窗图片的左右切换实现难度大，之后再做）</td>\n      <td></td>\n      <td></td>\n    </tr>\n  </tbody>\n</table>\n<h2 id="运行效果-6"><a href="#%E8%BF%90%E8%A1%8C%E6%95%88%E6%9E%9C-6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>运行效果</h2>\n<!-- <iframe data-src="https://codesandbox.io/embed/etwmhs?codemirror=1&hidenavigation=1&theme=light&view=preview" class="embedded-codesandbox" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe> --><html><head></head><body></body></html>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/nxsy6m?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h2 id="优化方向"><a href="#%E4%BC%98%E5%8C%96%E6%96%B9%E5%90%91" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>优化方向</h2>\n<ol>\n<li>编译原理相关：利用 ts-morph、ts-morpher 自动导入 lazyloader 的 lazyElement 的 div、video、img 组件</li>\n<li>img 组件没有封装，复用之前的组件</li>\n</ol>\n<h1 id="弹窗-hook-封装"><a href="#%E5%BC%B9%E7%AA%97-hook-%E5%B0%81%E8%A3%85" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>弹窗 hook 封装</h1>\n<h2 id="需求背景-10"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-10" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h2>\n<p>由于需要实现大量弹窗展示的功能，为了尽量减少代码行数，提高复用性，这里采用 hooks 的方式去实现弹窗</p>\n<h2 id="usemodal-封装"><a href="#usemodal-%E5%B0%81%E8%A3%85" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>useModal 封装</h2>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="85209268342683700000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import React, {\n   useRef,\n   forwardRef,\n   useState,\n   useImperativeHandle,\n   useCallback,\n   ComponentType,\n   PropsWithoutRef\n} from \'react\';\nimport { ModalProps, Modal } from \'antd\';\n\ntype ModalRefType<T> =\n   | {\n        open: (initProp?: Partial<T>) => void;\n        close: () => void;\n     }\n   | undefined;\n\ninterface UseModalProps<T> {\n   component: ComponentType<T>; // 子组件\n   modalProps?: Partial<ModalProps>; // 弹窗属性\n}\n\nconst useModal = function<T>({ component: Component, modalProps }: UseModalProps<T>) {\n   const modalRef = useRef<ModalRefType<T>>();\n   const [globalVisible, setGlobalVisible] = useState(false);\n\n   const ComponentModal = forwardRef<ModalRefType<T>, T>((componetProps, componentRef) => {\n      const [visible, setVisible] = useState(false);\n      const [componentInitProp, setComponentInitProp] = useState<Partial<T>>();\n\n      const handleOk = (initProps?: Partial<T>) => {\n         if (initProps) {\n            setComponentInitProp(initProps);\n         }\n         setVisible(true);\n         setGlobalVisible(true);\n      };\n\n      const handleCancel = () => {\n         setVisible(false);\n         setGlobalVisible(false);\n      };\n\n      useImperativeHandle(componentRef, () => ({\n         open: handleOk,\n         close: handleCancel\n      }));\n\n      return (\n         <Modal onCancel={handleCancel} visible={visible} {...modalProps}>\n            <Component onCancel={handleCancel} {...componetProps} {...componentInitProp} />\n         </Modal>\n      );\n   });\n\n   return {\n      Slot: useCallback((props: PropsWithoutRef<T>) => {\n         return <ComponentModal ref={modalRef} {...props} />;\n         // eslint-disable-next-line react-hooks/exhaustive-deps\n      }, []),\n      // 这里不能传 modalRef.current，因为传递的是引用\n      // 如果传的是 modalRef.current，会导致 modelRef.current 更新时不会同步更新到外部\n      api: modalRef,\n      visible: globalVisible\n   };\n};\n\nexport default useModal;`, `85209268342683700000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="tsx"\n              >\n                <span class="gatsby-code-button-language">tsx</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="tsx"><pre style="counter-reset: linenumber NaN" class="language-tsx line-numbers"><code class="language-tsx"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n   useRef<span class="token punctuation">,</span>\n   forwardRef<span class="token punctuation">,</span>\n   useState<span class="token punctuation">,</span>\n   useImperativeHandle<span class="token punctuation">,</span>\n   useCallback<span class="token punctuation">,</span>\n   ComponentType<span class="token punctuation">,</span>\n   PropsWithoutRef\n<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> ModalProps<span class="token punctuation">,</span> Modal <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'antd\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">type</span> ModalRefType<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">T</span></span><span class="token punctuation">></span></span><span class="token plain-text"> =\n   | </span><span class="token punctuation">{</span>\n        open<span class="token punctuation">:</span> <span class="token punctuation">(</span>initProp<span class="token operator">?</span><span class="token punctuation">:</span> Partial<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">T</span></span><span class="token punctuation">></span></span><span class="token plain-text">) => void;\n        close: () => void;\n     }\n   | undefined;\n\ninterface UseModalProps</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">T</span></span><span class="token punctuation">></span></span><span class="token plain-text"> </span><span class="token punctuation">{</span>\n   component<span class="token punctuation">:</span> ComponentType<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">T</span></span><span class="token punctuation">></span></span><span class="token plain-text">; // 子组件\n   modalProps?: Partial</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">ModalProps</span></span><span class="token punctuation">></span></span><span class="token plain-text">; // 弹窗属性\n}\n\nconst useModal = function</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">T</span></span><span class="token punctuation">></span></span><span class="token plain-text">(</span><span class="token punctuation">{</span> component<span class="token punctuation">:</span> Component<span class="token punctuation">,</span> modalProps <span class="token punctuation">}</span><span class="token plain-text">: UseModalProps</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">T</span></span><span class="token punctuation">></span></span><span class="token plain-text">) </span><span class="token punctuation">{</span>\n   <span class="token keyword">const</span> modalRef <span class="token operator">=</span> useRef<span class="token operator">&lt;</span>ModalRefType<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">T</span></span><span class="token punctuation">></span></span><span class="token plain-text">>();\n   const [globalVisible, setGlobalVisible] = useState(false);\n\n   const ComponentModal = forwardRef&lt;ModalRefType</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">T</span></span><span class="token punctuation">></span></span><span class="token plain-text">, T>((componetProps, componentRef) => </span><span class="token punctuation">{</span>\n      <span class="token keyword">const</span> <span class="token punctuation">[</span>visible<span class="token punctuation">,</span> setVisible<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> <span class="token punctuation">[</span>componentInitProp<span class="token punctuation">,</span> setComponentInitProp<span class="token punctuation">]</span> <span class="token operator">=</span> useState<span class="token operator">&lt;</span>Partial<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">T</span></span><span class="token punctuation">></span></span><span class="token plain-text">>();\n\n      const handleOk = (initProps?: Partial</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">T</span></span><span class="token punctuation">></span></span><span class="token plain-text">) => </span><span class="token punctuation">{</span>\n         <span class="token keyword">if</span> <span class="token punctuation">(</span>initProps<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token function">setComponentInitProp</span><span class="token punctuation">(</span>initProps<span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span>\n         <span class="token function">setVisible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token function">setGlobalVisible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token plain-text">;\n\n      const handleCancel = () => </span><span class="token punctuation">{</span>\n         <span class="token function">setVisible</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token function">setGlobalVisible</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token plain-text">;\n\n      useImperativeHandle(componentRef, () => (</span><span class="token punctuation">{</span>\n         open<span class="token punctuation">:</span> handleOk<span class="token punctuation">,</span>\n         close<span class="token punctuation">:</span> handleCancel\n      <span class="token punctuation">}</span><span class="token plain-text">));\n\n      return (\n         </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Modal</span></span> <span class="token attr-name">onCancel</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>handleCancel<span class="token punctuation">}</span></span> <span class="token attr-name">visible</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>visible<span class="token punctuation">}</span></span> <span class="token spread"><span class="token punctuation">{</span><span class="token punctuation">...</span><span class="token attr-value">modalProps</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Component</span></span> <span class="token attr-name">onCancel</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>handleCancel<span class="token punctuation">}</span></span> <span class="token spread"><span class="token punctuation">{</span><span class="token punctuation">...</span><span class="token attr-value">componetProps</span><span class="token punctuation">}</span></span> <span class="token spread"><span class="token punctuation">{</span><span class="token punctuation">...</span><span class="token attr-value">componentInitProp</span><span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token plain-text">\n         </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Modal</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n      );\n   });\n\n   return </span><span class="token punctuation">{</span>\n      Slot<span class="token punctuation">:</span> <span class="token function">useCallback</span><span class="token punctuation">(</span><span class="token punctuation">(</span>props<span class="token punctuation">:</span> PropsWithoutRef<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">T</span></span><span class="token punctuation">></span></span><span class="token plain-text">) => </span><span class="token punctuation">{</span>\n         <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">ComponentModal</span></span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>modalRef<span class="token punctuation">}</span></span> <span class="token spread"><span class="token punctuation">{</span><span class="token punctuation">...</span><span class="token attr-value">props</span><span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">;</span>\n         <span class="token comment">// eslint-disable-next-line react-hooks/exhaustive-deps</span>\n      <span class="token punctuation">}</span><span class="token plain-text">, []),\n      // 这里不能传 modalRef.current，因为传递的是引用\n      // 如果传的是 modalRef.current，会导致 modelRef.current 更新时不会同步更新到外部\n      api: modalRef,\n      visible: globalVisible\n   };\n};\n\nexport default useModal;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="usedisplayermodal-封装"><a href="#usedisplayermodal-%E5%B0%81%E8%A3%85" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>useDisplayerModal 封装</h2>\n<p>弹窗有一些公用属性，需要再次分层便于复用</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="26949110953911992000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import { ComponentType } from \'react\';\n\nimport useModal from \'@/hooks/useModal\';\n\nimport styles from \'./index.module.less\';\n\nconst useDisplayerModal = function<T>(Component: ComponentType<T>) {\n   const result = useModal({\n      component: Component,\n      modalProps: {\n         className: styles.modal,\n         wrapClassName: styles.wrapClassName,\n         closable: false,\n         footer: null,\n         // 这里 destroyOnClose 设置 true 的原因是：swiper 需要销毁，否则导致 swiper 卡住的 bug\n         destroyOnClose: true,\n         centered: false\n      }\n   });\n   return result;\n};\n\nexport default useDisplayerModal;`, `26949110953911992000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="tsx"\n              >\n                <span class="gatsby-code-button-language">tsx</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="tsx"><pre style="counter-reset: linenumber NaN" class="language-tsx line-numbers"><code class="language-tsx"><span class="token keyword">import</span> <span class="token punctuation">{</span> ComponentType <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> useModal <span class="token keyword">from</span> <span class="token string">\'@/hooks/useModal\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> styles <span class="token keyword">from</span> <span class="token string">\'./index.module.less\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">useDisplayerModal</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">T</span></span><span class="token punctuation">></span></span><span class="token plain-text">(Component: ComponentType</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">T</span></span><span class="token punctuation">></span></span><span class="token plain-text">) </span><span class="token punctuation">{</span>\n   <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">useModal</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n      component<span class="token punctuation">:</span> Component<span class="token punctuation">,</span>\n      modalProps<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n         className<span class="token punctuation">:</span> styles<span class="token punctuation">.</span>modal<span class="token punctuation">,</span>\n         wrapClassName<span class="token punctuation">:</span> styles<span class="token punctuation">.</span>wrapClassName<span class="token punctuation">,</span>\n         closable<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n         footer<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>\n         <span class="token comment">// 这里 destroyOnClose 设置 true 的原因是：swiper 需要销毁，否则导致 swiper 卡住的 bug</span>\n         destroyOnClose<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n         centered<span class="token punctuation">:</span> <span class="token boolean">false</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">return</span> result<span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token plain-text">;\n\nexport default useDisplayerModal;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="运行效果-7"><a href="#%E8%BF%90%E8%A1%8C%E6%95%88%E6%9E%9C-7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>运行效果</h2>\n<!-- <iframe data-src="https://codesandbox.io/embed/9pxwy5?codemirror=1&hidenavigation=1&theme=light&view=preview" class="embedded-codesandbox" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe> --><html><head></head><body></body></html>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/whshqm?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h1 id="其他"><a href="#%E5%85%B6%E4%BB%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>其他</h1>\n<h2 id="loadscript-优化"><a href="#loadscript-%E4%BC%98%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>loadScript 优化</h2>\n<h3 id="需求背景-11"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-11" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h3>\n<p>需要有一个方法来手动加载脚本，延迟脚本加载的时机</p>\n<h3 id="优化过程"><a href="#%E4%BC%98%E5%8C%96%E8%BF%87%E7%A8%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>优化过程</h3>\n<ol>\n<li>生成唯一性的 uuid 来判断这个脚本是否加载，以实现只加载一次脚本的功能</li>\n<li>由于 loadScript 方法会在同一个页面同一 src 多次调用，实际上判断脚本是否加载并不能完美实现（会导致同一脚本多次加载），考虑使用函数缓存实现</li>\n</ol>\n<h3 id="核心代码-9"><a href="#%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81-9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>核心代码</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="32516847763356393000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import { memoize } from \'lodash\';\n\ntype loadScriptOptions = Partial<Omit<HTMLScriptElement, \'src\' | \'async\'>> & {\n   attributesMap?: {\n      [key: string]: any;\n   };\n   [key: string]: any;\n};\n\n// 异步加载单个脚本\nasync function loadSingleScript(src: string, options: loadScriptOptions = {}) {\n   return await new Promise((resolve, reject) => {\n      // 这里未考虑到同一 src 同时发起的情况，改用缓存实现\n      // if (!id) {\n      //   const NAMESPACE = \'c2b16a16-12b3-423a-879f-6b46d1a01d60\'\n      //   const PREFIX = \'script-id-\'\n      //   id = PREFIX + uuidv5(src, NAMESPACE)\n      // }\n      // if (!src || document.querySelector(\\`#\\${id}\\`)) {\n      //   return\n      // }\n      const script: any = document.createElement(\'script\');\n      const { attributesMap = {}, ...rest } = options;\n      Object.keys(rest).forEach((key) => {\n         script[key] = rest[key];\n      });\n      Object.keys(attributesMap).forEach((key) => {\n         script.setAttribute(key, attributesMap[key]);\n      });\n      script.async = true;\n      script.src = src;\n      script.onload = resolve;\n      script.onerror = reject;\n      document.getElementsByTagName(\'head\')[0].appendChild(script);\n   });\n}\n\n// 异步加载多个脚本\n// memoize 默认情况下用第一个参数作为缓存的 key，即 src\nexport const loadScript = memoize(loadSingleScript);`, `32516847763356393000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="ts"\n              >\n                <span class="gatsby-code-button-language">ts</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="ts"><pre style="counter-reset: linenumber NaN" class="language-ts line-numbers"><code class="language-ts"><span class="token keyword">import</span> <span class="token punctuation">{</span> memoize <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'lodash\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">type</span> loadScriptOptions <span class="token operator">=</span> Partial<span class="token operator">&lt;</span>Omit<span class="token operator">&lt;</span>HTMLScriptElement<span class="token punctuation">,</span> <span class="token string">\'src\'</span> <span class="token operator">|</span> <span class="token string">\'async\'</span><span class="token operator">>></span> <span class="token operator">&amp;</span> <span class="token punctuation">{</span>\n   attributesMap<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>\n      <span class="token punctuation">[</span>key<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token builtin">any</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span><span class="token punctuation">;</span>\n   <span class="token punctuation">[</span>key<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token builtin">any</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 异步加载单个脚本</span>\n<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">loadSingleScript</span><span class="token punctuation">(</span><span class="token parameter">src<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> options<span class="token punctuation">:</span> loadScriptOptions <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token comment">// 这里未考虑到同一 src 同时发起的情况，改用缓存实现</span>\n      <span class="token comment">// if (!id) {</span>\n      <span class="token comment">//   const NAMESPACE = \'c2b16a16-12b3-423a-879f-6b46d1a01d60\'</span>\n      <span class="token comment">//   const PREFIX = \'script-id-\'</span>\n      <span class="token comment">//   id = PREFIX + uuidv5(src, NAMESPACE)</span>\n      <span class="token comment">// }</span>\n      <span class="token comment">// if (!src || document.querySelector(`#${id}`)) {</span>\n      <span class="token comment">//   return</span>\n      <span class="token comment">// }</span>\n      <span class="token keyword">const</span> script<span class="token punctuation">:</span> <span class="token builtin">any</span> <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">\'script\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> <span class="token punctuation">{</span> attributesMap <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token operator">...</span>rest <span class="token punctuation">}</span> <span class="token operator">=</span> options<span class="token punctuation">;</span>\n      Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>rest<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n         script<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> rest<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>attributesMap<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n         script<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> attributesMap<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      script<span class="token punctuation">.</span><span class="token keyword">async</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n      script<span class="token punctuation">.</span>src <span class="token operator">=</span> src<span class="token punctuation">;</span>\n      script<span class="token punctuation">.</span>onload <span class="token operator">=</span> resolve<span class="token punctuation">;</span>\n      script<span class="token punctuation">.</span>onerror <span class="token operator">=</span> reject<span class="token punctuation">;</span>\n      document<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">\'head\'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>script<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// 异步加载多个脚本</span>\n<span class="token comment">// memoize 默认情况下用第一个参数作为缓存的 key，即 src</span>\n<span class="token keyword">export</span> <span class="token keyword">const</span> loadScript <span class="token operator">=</span> <span class="token function">memoize</span><span class="token punctuation">(</span>loadSingleScript<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="视频播放进度控制失效"><a href="#%E8%A7%86%E9%A2%91%E6%92%AD%E6%94%BE%E8%BF%9B%E5%BA%A6%E6%8E%A7%E5%88%B6%E5%A4%B1%E6%95%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>视频播放进度控制失效</h2>\n<p>对于长视频，<code class="language-text">domRef.current.currentTime = 0</code> 方法失效，需要对服务器配置，具体见<a href="https://stackoverflow.com/questions/4360060/video-streaming-with-html-5-via-node-js#18241169" target="_blank" rel="nofollow noreferrer noopener">这里</a></p>\n<h2 id="usescrolldirection-封装"><a href="#usescrolldirection-%E5%B0%81%E8%A3%85" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>useScrollDirection 封装</h2>\n<h3 id="需求背景-12"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-12" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h3>\n<p>需要知道页面的向上、向下滚动来实现特定需求</p>\n<h3 id="实现要点"><a href="#%E5%AE%9E%E7%8E%B0%E8%A6%81%E7%82%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>实现要点</h3>\n<p>使用 ahooks 的 useScroll、usePrevious、useThrottle，来分别实现得到当前滚动信息、得到前一个滚动信息、性能优化的节流处理的功能</p>\n<h3 id="核心代码-10"><a href="#%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81-10" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>核心代码</h3>\n<p>web/hooks/useScrollDirection.ts</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="39390949414687510000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import { useScroll, usePrevious, useThrottle } from \'ahooks\'\nimport type { Target, ScrollListenController } from \'ahooks/lib/useScroll\'\nimport type { ThrottleOptions } from \'ahooks/lib/useThrottle/throttleOptions\'\n\ninterface UseScrollDirectionResult {\n  leftDelta: number\n  topDelta: number\n  scrollXDirection?: \'left\' | \'right\'\n  scrollYDirection?: \'up\' | \'down\'\n  left: number\n  top: number\n}\n\nconst useScrollDirection = (target: Target, shouldUpdate?: ScrollListenController, options: ThrottleOptions & { enable: boolean } = {\n  enable: false,\n  wait: 300,\n  leading: true,\n  trailing: true\n}): UseScrollDirectionResult => {\n  const position = useScroll(target, shouldUpdate)\n  const prevPosition = usePrevious(position)\n\n  const throttledPosition = useThrottle(position, options)\n  const throttledPrevPosition = useThrottle(prevPosition, options)\n\n  const newPosition = options.enable ? throttledPosition : position\n  const newPrevPosition = options.enable ? throttledPrevPosition : prevPosition\n\n  if (!newPosition || !newPrevPosition) {\n    return {\n      leftDelta: 0,\n      topDelta: 0,\n      left: 0,\n      top: 0\n    }\n  }\n\n  const leftDelta = newPosition.left - newPrevPosition.left\n  const topDelta = newPosition.top - newPrevPosition.top\n\n  const scrollXDirection = leftDelta > 0 ? \'right\' : \'left\'\n  const scrollYDirection = topDelta > 0 ? \'down\' : \'up\'\n\n  // console.log(\'throttledPosition\', newPosition, newPrevPosition)\n\n  return {\n    leftDelta,\n    topDelta,\n    scrollXDirection,\n    scrollYDirection,\n    left: newPosition.left,\n    top: newPosition.top\n  }\n}\n\nexport default useScrollDirection`, `39390949414687510000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="tsx"\n              >\n                <span class="gatsby-code-button-language">tsx</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="tsx"><pre style="counter-reset: linenumber NaN" class="language-tsx line-numbers"><code class="language-tsx"><span class="token keyword">import</span> <span class="token punctuation">{</span> useScroll<span class="token punctuation">,</span> usePrevious<span class="token punctuation">,</span> useThrottle <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'ahooks\'</span>\n<span class="token keyword">import</span> <span class="token keyword">type</span> <span class="token punctuation">{</span> Target<span class="token punctuation">,</span> ScrollListenController <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'ahooks/lib/useScroll\'</span>\n<span class="token keyword">import</span> <span class="token keyword">type</span> <span class="token punctuation">{</span> ThrottleOptions <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'ahooks/lib/useThrottle/throttleOptions\'</span>\n\n<span class="token keyword">interface</span> <span class="token class-name">UseScrollDirectionResult</span> <span class="token punctuation">{</span>\n  leftDelta<span class="token punctuation">:</span> <span class="token builtin">number</span>\n  topDelta<span class="token punctuation">:</span> <span class="token builtin">number</span>\n  scrollXDirection<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token string">\'left\'</span> <span class="token operator">|</span> <span class="token string">\'right\'</span>\n  scrollYDirection<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token string">\'up\'</span> <span class="token operator">|</span> <span class="token string">\'down\'</span>\n  left<span class="token punctuation">:</span> <span class="token builtin">number</span>\n  top<span class="token punctuation">:</span> <span class="token builtin">number</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">const</span> useScrollDirection <span class="token operator">=</span> <span class="token punctuation">(</span>target<span class="token punctuation">:</span> Target<span class="token punctuation">,</span> shouldUpdate<span class="token operator">?</span><span class="token punctuation">:</span> ScrollListenController<span class="token punctuation">,</span> options<span class="token punctuation">:</span> ThrottleOptions <span class="token operator">&amp;</span> <span class="token punctuation">{</span> enable<span class="token punctuation">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token punctuation">{</span>\n  enable<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n  wait<span class="token punctuation">:</span> <span class="token number">300</span><span class="token punctuation">,</span>\n  leading<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n  trailing<span class="token punctuation">:</span> <span class="token boolean">true</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token parameter">UseScrollDirectionResult</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> position <span class="token operator">=</span> <span class="token function">useScroll</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> shouldUpdate<span class="token punctuation">)</span>\n  <span class="token keyword">const</span> prevPosition <span class="token operator">=</span> <span class="token function">usePrevious</span><span class="token punctuation">(</span>position<span class="token punctuation">)</span>\n\n  <span class="token keyword">const</span> throttledPosition <span class="token operator">=</span> <span class="token function">useThrottle</span><span class="token punctuation">(</span>position<span class="token punctuation">,</span> options<span class="token punctuation">)</span>\n  <span class="token keyword">const</span> throttledPrevPosition <span class="token operator">=</span> <span class="token function">useThrottle</span><span class="token punctuation">(</span>prevPosition<span class="token punctuation">,</span> options<span class="token punctuation">)</span>\n\n  <span class="token keyword">const</span> newPosition <span class="token operator">=</span> options<span class="token punctuation">.</span>enable <span class="token operator">?</span> throttledPosition <span class="token punctuation">:</span> position\n  <span class="token keyword">const</span> newPrevPosition <span class="token operator">=</span> options<span class="token punctuation">.</span>enable <span class="token operator">?</span> throttledPrevPosition <span class="token punctuation">:</span> prevPosition\n\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>newPosition <span class="token operator">||</span> <span class="token operator">!</span>newPrevPosition<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token punctuation">{</span>\n      leftDelta<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>\n      topDelta<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>\n      left<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>\n      top<span class="token punctuation">:</span> <span class="token number">0</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">const</span> leftDelta <span class="token operator">=</span> newPosition<span class="token punctuation">.</span>left <span class="token operator">-</span> newPrevPosition<span class="token punctuation">.</span>left\n  <span class="token keyword">const</span> topDelta <span class="token operator">=</span> newPosition<span class="token punctuation">.</span>top <span class="token operator">-</span> newPrevPosition<span class="token punctuation">.</span>top\n\n  <span class="token keyword">const</span> scrollXDirection <span class="token operator">=</span> leftDelta <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token string">\'right\'</span> <span class="token punctuation">:</span> <span class="token string">\'left\'</span>\n  <span class="token keyword">const</span> scrollYDirection <span class="token operator">=</span> topDelta <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token string">\'down\'</span> <span class="token punctuation">:</span> <span class="token string">\'up\'</span>\n\n  <span class="token comment">// console.log(\'throttledPosition\', newPosition, newPrevPosition)</span>\n\n  <span class="token keyword">return</span> <span class="token punctuation">{</span>\n    leftDelta<span class="token punctuation">,</span>\n    topDelta<span class="token punctuation">,</span>\n    scrollXDirection<span class="token punctuation">,</span>\n    scrollYDirection<span class="token punctuation">,</span>\n    left<span class="token punctuation">:</span> newPosition<span class="token punctuation">.</span>left<span class="token punctuation">,</span>\n    top<span class="token punctuation">:</span> newPosition<span class="token punctuation">.</span>top\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> useScrollDirection</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="运行效果-8"><a href="#%E8%BF%90%E8%A1%8C%E6%95%88%E6%9E%9C-8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>运行效果</h3>\n<!-- <iframe data-src="https://codesandbox.io/embed/sb4gnr?codemirror=1&hidenavigation=1&theme=light&view=preview" class="embedded-codesandbox" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe> --><html><head></head><body></body></html>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/shsntv?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h2 id="set-cookie-失效"><a href="#set-cookie-%E5%A4%B1%E6%95%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>set-cookie 失效</h2>\n<p>UC 浏览器下服务器端设置 set-cookie 失效即 csrf token 设置失败，进而接口请求失败，原因未知</p>\n<p>// TODO set-cookie 失效待解决</p>\n<h2 id="子级滚动、父级不滚动"><a href="#%E5%AD%90%E7%BA%A7%E6%BB%9A%E5%8A%A8%E3%80%81%E7%88%B6%E7%BA%A7%E4%B8%8D%E6%BB%9A%E5%8A%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>子级滚动、父级不滚动</h2>\n<h3 id="需求背景-13"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-13" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h3>\n<p>打开弹窗时此时有半透明遮罩，弹窗内是有滚动条的，此时弹窗的滚动条的滚动会牵连外面滚动条的滚动</p>\n<h3 id="解决过程"><a href="#%E8%A7%A3%E5%86%B3%E8%BF%87%E7%A8%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>解决过程</h3>\n<ol>\n<li>css：<code class="language-text">overscroll-behavior: contain</code>，但是在移动端 safari 不支持</li>\n<li>js：在不支持 css 的方法时，降级处理</li>\n</ol>\n<h3 id="核心代码-11"><a href="#%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81-11" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>核心代码</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="22766568186429125000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`export function enableBodyScroll() {\n   if (document.readyState === \'complete\') {\n      document.body.style.position = \'\';\n      document.body.style.overflowY = \'\';\n\n      if (document.body.style.marginTop) {\n         const scrollTop = -parseInt(document.body.style.marginTop, 10);\n         document.body.style.marginTop = \'\';\n         window.scrollTo({\n            left: window.pageXOffset,\n            top: scrollTop,\n            behavior: \'instant\' // 关闭动画\n         });\n      }\n   } else {\n      window.addEventListener(\'load\', enableBodyScroll);\n   }\n}\n\nexport function disableBodyScroll({ savePosition = false } = {}) {\n   if (document.readyState === \'complete\') {\n      if (document.body.scrollHeight > window.innerHeight) {\n         if (savePosition) document.body.style.marginTop = \\`-\\${window.pageYOffset}px\\`;\n         document.body.style.position = \'fixed\';\n         document.body.style.overflowY = \'scroll\';\n      }\n   } else {\n      window.addEventListener(\'load\', () => disableBodyScroll({ savePosition }));\n   }\n}`, `22766568186429125000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="ts"\n              >\n                <span class="gatsby-code-button-language">ts</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="ts"><pre style="counter-reset: linenumber NaN" class="language-ts line-numbers"><code class="language-ts"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">enableBodyScroll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>document<span class="token punctuation">.</span>readyState <span class="token operator">===</span> <span class="token string">\'complete\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>style<span class="token punctuation">.</span>position <span class="token operator">=</span> <span class="token string">\'\'</span><span class="token punctuation">;</span>\n      document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>style<span class="token punctuation">.</span>overflowY <span class="token operator">=</span> <span class="token string">\'\'</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>style<span class="token punctuation">.</span>marginTop<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token keyword">const</span> scrollTop <span class="token operator">=</span> <span class="token operator">-</span><span class="token function">parseInt</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>style<span class="token punctuation">.</span>marginTop<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>style<span class="token punctuation">.</span>marginTop <span class="token operator">=</span> <span class="token string">\'\'</span><span class="token punctuation">;</span>\n         window<span class="token punctuation">.</span><span class="token function">scrollTo</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n            left<span class="token punctuation">:</span> window<span class="token punctuation">.</span>pageXOffset<span class="token punctuation">,</span>\n            top<span class="token punctuation">:</span> scrollTop<span class="token punctuation">,</span>\n            behavior<span class="token punctuation">:</span> <span class="token string">\'instant\'</span> <span class="token comment">// 关闭动画</span>\n         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n      window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">\'load\'</span><span class="token punctuation">,</span> enableBodyScroll<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">disableBodyScroll</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> savePosition <span class="token operator">=</span> <span class="token boolean">false</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>document<span class="token punctuation">.</span>readyState <span class="token operator">===</span> <span class="token string">\'complete\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>scrollHeight <span class="token operator">></span> window<span class="token punctuation">.</span>innerHeight<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token keyword">if</span> <span class="token punctuation">(</span>savePosition<span class="token punctuation">)</span> document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>style<span class="token punctuation">.</span>marginTop <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>window<span class="token punctuation">.</span>pageYOffset<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n         document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>style<span class="token punctuation">.</span>position <span class="token operator">=</span> <span class="token string">\'fixed\'</span><span class="token punctuation">;</span>\n         document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>style<span class="token punctuation">.</span>overflowY <span class="token operator">=</span> <span class="token string">\'scroll\'</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n      window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">\'load\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">disableBodyScroll</span><span class="token punctuation">(</span><span class="token punctuation">{</span> savePosition <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="进度转换函数"><a href="#%E8%BF%9B%E5%BA%A6%E8%BD%AC%E6%8D%A2%E5%87%BD%E6%95%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>进度转换函数</h2>\n<h3 id="需求背景-14"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-14" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h3>\n<ol>\n<li>页面固定动效多次用到百分比转换，需要封装函数便于使用、理解</li>\n<li>后期可能会实现缓动函数，需要提前封装便于修改</li>\n</ol>\n<h3 id="核心代码-12"><a href="#%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81-12" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>核心代码</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="97582921794470610000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`interface GetAnimateProgressProps {\n   progress: number;\n   start: number;\n   duration: number;\n}\n\n// 获取单个进度\nexport const getAnimateProgress = ({ progress, start, duration }: GetAnimateProgressProps) =>\n   (progress - start) / duration;\n\ntype GetAnimateProgressesOptions = Omit<GetAnimateProgressProps, \'progress\'>;\n\n// 获取多个进度\nexport const getAnimateProgresses = (progress: number, options: GetAnimateProgressesOptions[]) =>\n   options.map(({ start, duration }) =>\n      getAnimateProgress({\n         progress,\n         start,\n         duration\n      })\n   );`, `97582921794470610000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="ts"\n              >\n                <span class="gatsby-code-button-language">ts</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="ts"><pre style="counter-reset: linenumber NaN" class="language-ts line-numbers"><code class="language-ts"><span class="token keyword">interface</span> <span class="token class-name">GetAnimateProgressProps</span> <span class="token punctuation">{</span>\n   progress<span class="token punctuation">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>\n   start<span class="token punctuation">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>\n   duration<span class="token punctuation">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// 获取单个进度</span>\n<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">getAnimateProgress</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> progress<span class="token punctuation">,</span> start<span class="token punctuation">,</span> duration <span class="token punctuation">}</span><span class="token punctuation">:</span> GetAnimateProgressProps</span><span class="token punctuation">)</span> <span class="token operator">=></span>\n   <span class="token punctuation">(</span>progress <span class="token operator">-</span> start<span class="token punctuation">)</span> <span class="token operator">/</span> duration<span class="token punctuation">;</span>\n\n<span class="token keyword">type</span> GetAnimateProgressesOptions <span class="token operator">=</span> Omit<span class="token operator">&lt;</span>GetAnimateProgressProps<span class="token punctuation">,</span> <span class="token string">\'progress\'</span><span class="token operator">></span><span class="token punctuation">;</span>\n\n<span class="token comment">// 获取多个进度</span>\n<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">getAnimateProgresses</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">progress<span class="token punctuation">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> options<span class="token punctuation">:</span> GetAnimateProgressesOptions<span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=></span>\n   options<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> start<span class="token punctuation">,</span> duration <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span>\n      <span class="token function">getAnimateProgress</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n         progress<span class="token punctuation">,</span>\n         start<span class="token punctuation">,</span>\n         duration\n      <span class="token punctuation">}</span><span class="token punctuation">)</span>\n   <span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="cdn-链接替换"><a href="#cdn-%E9%93%BE%E6%8E%A5%E6%9B%BF%E6%8D%A2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>cdn 链接替换</h2>\n<h3 id="需求背景-15"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-15" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h3>\n<p>public 下的所有文件都需要放到 cdn，减少服务器的压力同时访问速度更快，即要对所有前缀为 /public 的资源路径做替换</p>\n<h3 id="选型过程-7"><a href="#%E9%80%89%E5%9E%8B%E8%BF%87%E7%A8%8B-7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>选型过程</h3>\n<ol>\n<li>动态变量：在 midway 后端设置可读变量然后注入到前端 window 变量中，但是不能解决 midway、css 的前缀问题</li>\n<li>静态替换：在 build 阶段对所有的 /public 替换，但是目前运维不支持，运维只在 dev 环境中才能 build，需要运维解决</li>\n<li>静态资源 hash 处理：需要由 webpack 接管去处理</li>\n</ol>\n<h3 id="核心代码-13"><a href="#%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81-13" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>核心代码</h3>\n<p>以下是 <code class="language-text">静态替换</code> 的核心代码，见标红部分的核心代码</p>\n<p>scripts/build.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="78476785381596870000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const shelljs = require(\'shelljs\');\nconst fsExtra = require(\'fs-extra\');\nconst path = require(\'path\');\nconst fs = require(\'fs\');\nconst packageJson = require(\'../package.json\');\nconst glob = require(\'glob\');\nconst { merge } = require(\'lodash\');\n\nlet config = require(\'../dist/config/config.default\');\nconst ENV = process.env.EGG_SERVER_ENV || \'prod\';\nconst fakeConfigParams = {\n   name: \'\',\n   appDir: \'\'\n};\nconst configPath = \\`../dist/config/config.\\${ENV}.js\\`;\n// console.log(\'ENV\', ENV)\nif (fs.existsSync(path.resolve(__dirname, configPath))) {\n   config = merge(config.default(fakeConfigParams), require(configPath).default(fakeConfigParams));\n}\n\nconsole.log(\'Start handle source...\');\n\nfsExtra.mkdirpSync(path.resolve(__dirname, \'../deploy\'), { overwrite: true });\nfsExtra.copySync(path.resolve(__dirname, \'../public\'), path.resolve(__dirname, \'../deploy/public\'), {\n   overwrite: true\n});\n\ndelete packageJson.devDependencies;\ndelete packageJson.scripts.preinstall;\n\nfs.writeFileSync(path.resolve(__dirname, \'../deploy/package.json\'), JSON.stringify(packageJson));\n\n// 暂时不需要处理异步加载的资源\n// const assetManifest = require(\'../build/client/asset-manifest.json\')\n// const runtimePagePath = path.resolve(\n//   __dirname,\n//   \'../build\' + assetManifest[\'runtime~Page.js\'].replace(\'/public\', \'\')\n// )\n\n// const runtimePage = fs.readFileSync(runtimePagePath).toString()\n\n// // 替换 webpack 打包的资源路径前缀\n// fs.writeFileSync(\n//   runtimePagePath,\n//   runtimePage.replace(/&quot;\\/public\\//g, \'window.__publicPath+&quot;/public/\')\n// )\n\nconst assetManifest = require(\'../build/client/asset-manifest.json\');\nconst runtimePagePath = assetManifest[\'runtime~Page.js\'].replace(\'/public\', \'build\');\n// console.log(\'runtimePagePath\', runtimePagePath)\n\nconst replacePrefixFiles = [\n   ...glob.sync(\'build/{client,server}/**/*.{js,css}\'),\n   ...glob.sync(\'dist/config/{menu,site}/**/*.js\')\n].filter((item) => item !== runtimePagePath);\nconst newPublicPath = config.publicPath || \'\';\nconst publicPath = newPublicPath.endsWith(\'/\') ? newPublicPath + \'public/\' : newPublicPath + \'/public/\';\n// console.log(\'publicPath\', publicPath)\nreplacePrefixFiles.forEach(function(file) {\n   const fileContent = fs.readFileSync(file).toString();\n   if (config.publicPath) {\n      fs.writeFileSync(file, fileContent.replace(/\\/public\\//g, publicPath));\n   }\n});\n\nfsExtra.moveSync(path.resolve(__dirname, \'../build\'), path.resolve(__dirname, \'../deploy/build\'), { overwrite: true });\n\nif (fs.existsSync(path.resolve(__dirname, \'../dist\'))) {\n   fsExtra.moveSync(path.resolve(__dirname, \'../dist\'), path.resolve(__dirname, \'../deploy/dist\'), { overwrite: true });\n}\n\nfsExtra.moveSync(path.resolve(__dirname, \'../deploy\'), path.resolve(__dirname, \'../dist\'), { overwrite: true });\n\nglob.sync(path.resolve(__dirname, \'../dist/**/*.map\')).forEach(function(file) {\n   fs.unlinkSync(file);\n});\n\nfsExtra.mkdirpSync(path.resolve(__dirname, \'../dist/node_modules\'), {\n   overwrite: true\n});\n\nshelljs.exec(\'cp -r node_modules/xp-react-scrollmagic dist/node_modules/xp-react-scrollmagic\');`, `78476785381596870000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="ts{48-64}"\n              >\n                <span class="gatsby-code-button-language">ts{48-64}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="ts"><pre style="counter-reset: linenumber NaN" class="language-ts line-numbers"><code class="language-ts"><span class="token keyword">const</span> shelljs <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">\'shelljs\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> fsExtra <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">\'fs-extra\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">\'path\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">\'fs\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> packageJson <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">\'../package.json\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> glob <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">\'glob\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> <span class="token punctuation">{</span> merge <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">\'lodash\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">let</span> config <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">\'../dist/config/config.default\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> <span class="token constant">ENV</span> <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">EGG_SERVER_ENV</span> <span class="token operator">||</span> <span class="token string">\'prod\'</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> fakeConfigParams <span class="token operator">=</span> <span class="token punctuation">{</span>\n   name<span class="token punctuation">:</span> <span class="token string">\'\'</span><span class="token punctuation">,</span>\n   appDir<span class="token punctuation">:</span> <span class="token string">\'\'</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> configPath <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">../dist/config/config.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">ENV</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.js</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n<span class="token comment">// console.log(\'ENV\', ENV)</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> configPath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   config <span class="token operator">=</span> <span class="token function">merge</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">(</span>fakeConfigParams<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">require</span><span class="token punctuation">(</span>configPath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">(</span>fakeConfigParams<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'Start handle source...\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nfsExtra<span class="token punctuation">.</span><span class="token function">mkdirpSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">\'../deploy\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> overwrite<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nfsExtra<span class="token punctuation">.</span><span class="token function">copySync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">\'../public\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">\'../deploy/public\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>\n   overwrite<span class="token punctuation">:</span> <span class="token boolean">true</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">delete</span> packageJson<span class="token punctuation">.</span>devDependencies<span class="token punctuation">;</span>\n<span class="token keyword">delete</span> packageJson<span class="token punctuation">.</span>scripts<span class="token punctuation">.</span>preinstall<span class="token punctuation">;</span>\n\nfs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">\'../deploy/package.json\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>packageJson<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 暂时不需要处理异步加载的资源</span>\n<span class="token comment">// const assetManifest = require(\'../build/client/asset-manifest.json\')</span>\n<span class="token comment">// const runtimePagePath = path.resolve(</span>\n<span class="token comment">//   __dirname,</span>\n<span class="token comment">//   \'../build\' + assetManifest[\'runtime~Page.js\'].replace(\'/public\', \'\')</span>\n<span class="token comment">// )</span>\n\n<span class="token comment">// const runtimePage = fs.readFileSync(runtimePagePath).toString()</span>\n\n<span class="token comment">// // 替换 webpack 打包的资源路径前缀</span>\n<span class="token comment">// fs.writeFileSync(</span>\n<span class="token comment">//   runtimePagePath,</span>\n<span class="token comment">//   runtimePage.replace(/"\\/public\\//g, \'window.__publicPath+"/public/\')</span>\n<span class="token comment">// )</span>\n\n<span class="gatsby-highlight-code-line"><span class="token keyword">const</span> assetManifest <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">\'../build/client/asset-manifest.json\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">const</span> runtimePagePath <span class="token operator">=</span> assetManifest<span class="token punctuation">[</span><span class="token string">\'runtime~Page.js\'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">\'/public\'</span><span class="token punctuation">,</span> <span class="token string">\'build\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"><span class="token comment">// console.log(\'runtimePagePath\', runtimePagePath)</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line"><span class="token keyword">const</span> replacePrefixFiles <span class="token operator">=</span> <span class="token punctuation">[</span></span><span class="gatsby-highlight-code-line">   <span class="token operator">...</span>glob<span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token string">\'build/{client,server}/**/*.{js,css}\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">   <span class="token operator">...</span>glob<span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token string">\'dist/config/{menu,site}/**/*.js\'</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line"><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> item <span class="token operator">!==</span> runtimePagePath<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">const</span> newPublicPath <span class="token operator">=</span> config<span class="token punctuation">.</span>publicPath <span class="token operator">||</span> <span class="token string">\'\'</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">const</span> publicPath <span class="token operator">=</span> newPublicPath<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">\'/\'</span><span class="token punctuation">)</span> <span class="token operator">?</span> newPublicPath <span class="token operator">+</span> <span class="token string">\'public/\'</span> <span class="token punctuation">:</span> newPublicPath <span class="token operator">+</span> <span class="token string">\'/public/\'</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"><span class="token comment">// console.log(\'publicPath\', publicPath)</span></span><span class="gatsby-highlight-code-line">replacePrefixFiles<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">file</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">   <span class="token keyword">const</span> fileContent <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">   <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span>publicPath<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> fileContent<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\\/public\\//g</span><span class="token punctuation">,</span> publicPath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">   <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\nfsExtra<span class="token punctuation">.</span><span class="token function">moveSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">\'../build\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">\'../deploy/build\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> overwrite<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">if</span> <span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">\'../dist\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   fsExtra<span class="token punctuation">.</span><span class="token function">moveSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">\'../dist\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">\'../deploy/dist\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> overwrite<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\nfsExtra<span class="token punctuation">.</span><span class="token function">moveSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">\'../deploy\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">\'../dist\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> overwrite<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nglob<span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">\'../dist/**/*.map\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">file</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   fs<span class="token punctuation">.</span><span class="token function">unlinkSync</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nfsExtra<span class="token punctuation">.</span><span class="token function">mkdirpSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">\'../dist/node_modules\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>\n   overwrite<span class="token punctuation">:</span> <span class="token boolean">true</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nshelljs<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">\'cp -r node_modules/xp-react-scrollmagic dist/node_modules/xp-react-scrollmagic\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="dangerouslysetinnerhtml-编译更新失效"><a href="#dangerouslysetinnerhtml-%E7%BC%96%E8%AF%91%E6%9B%B4%E6%96%B0%E5%A4%B1%E6%95%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>dangerouslySetInnerHTML 编译更新失效</h2>\n<h3 id="需求背景-16"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-16" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h3>\n<p>使用了 dangerouslySetInnerHTML 渲染的富文本组件，在编译之后不生效</p>\n<h3 id="核心代码-14"><a href="#%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81-14" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>核心代码</h3>\n<p>web/components/htmlComponent/index.tsx</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="60948252769545870000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import React, { ReactNode } from \'react\';\n\ninterface HtmlComponentProps {\n   children: ReactNode;\n   className?: string;\n}\n\nconst HtmlComponent = ({ children, className }: HtmlComponentProps) =>\n   typeof children === \'string\' ? (\n      // key={Math.random()} 必须设置，否则 props 不会更新，导致热更新失败\n      <div className={className} key={Math.random()} dangerouslySetInnerHTML={{ __html: children }} />\n   ) : (\n      <div className={className}>{children}</div>\n   );\n\nexport default HtmlComponent;`, `60948252769545870000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="tsx"\n              >\n                <span class="gatsby-code-button-language">tsx</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="tsx"><pre style="counter-reset: linenumber NaN" class="language-tsx line-numbers"><code class="language-tsx"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> ReactNode <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">interface</span> <span class="token class-name">HtmlComponentProps</span> <span class="token punctuation">{</span>\n   children<span class="token punctuation">:</span> ReactNode<span class="token punctuation">;</span>\n   className<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">HtmlComponent</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> children<span class="token punctuation">,</span> className <span class="token punctuation">}</span><span class="token punctuation">:</span> HtmlComponentProps</span><span class="token punctuation">)</span> <span class="token operator">=></span>\n   <span class="token keyword">typeof</span> children <span class="token operator">===</span> <span class="token string">\'string\'</span> <span class="token operator">?</span> <span class="token punctuation">(</span>\n      <span class="token comment">// key={Math.random()} 必须设置，否则 props 不会更新，导致热更新失败</span>\n      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>className<span class="token punctuation">}</span></span> <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span> <span class="token attr-name">dangerouslySetInnerHTML</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> __html<span class="token punctuation">:</span> children <span class="token punctuation">}</span><span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span>\n   <span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span>\n      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>className<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token punctuation">{</span>children<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>\n   <span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> HtmlComponent<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>',
id:"/home/runner/work/GatsbyBlog/GatsbyBlog/blog/国际官网技术难点攻关/index.md absPath of file >>> MarkdownRemark",timeToRead:56,frontmatter:{date:"2022-12-16 17:26:58",path:"/international-official-website-technical-difficulties/",tags:"前端, 国际官网, 预研",title:"国际官网技术难点攻关",draft:null}},{excerpt:"架构 选型背景 搭建一个便于 SEO 的官网 技术栈团队成员熟悉，开发方便 提到 SEO，主流的渲染方式都是 SSR 框架选型 详见  http://doc.ssr-fc.com/docs/features$technology 支持常见的流行前端框架 React/Vue2/Vue3，这里只列举 React 的 特性 前端框架: React v17, 实时跟进 React17 的新特性 开发语言: TypeScript 代码风格(可选): 默认 eslint-config-standard…",html:'<h1 id="架构"><a href="#%E6%9E%B6%E6%9E%84" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>架构</h1>\n<h2 id="选型背景"><a href="#%E9%80%89%E5%9E%8B%E8%83%8C%E6%99%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>选型背景</h2>\n<ol>\n<li>搭建一个便于 SEO 的官网</li>\n<li>技术栈团队成员熟悉，开发方便</li>\n</ol>\n<p>提到 SEO，主流的渲染方式都是 SSR</p>\n<h2 id="框架选型"><a href="#%E6%A1%86%E6%9E%B6%E9%80%89%E5%9E%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>框架选型</h2>\n<p>详见 <a href="http://doc.ssr-fc.com/docs/features$technology" target="_blank" rel="nofollow noreferrer noopener">http://doc.ssr-fc.com/docs/features$technology</a></p>\n<p>支持常见的流行前端框架 React/Vue2/Vue3，这里只列举 React 的</p>\n<h3 id="特性"><a href="#%E7%89%B9%E6%80%A7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>特性</h3>\n<ul>\n<li>前端框架: React v17, 实时跟进 React17 的新特性</li>\n<li>开发语言: TypeScript</li>\n<li>代码风格(可选): 默认 eslint-config-standard-react-ts</li>\n<li>样式处理: less + css modules(根据后缀名自动识别 .module.less 文件使用 css-modules)</li>\n<li>UI 组件: 默认已对 antd 的使用做打包配置无需额外配置</li>\n<li>前端路由: 约定式路由/声明式路由</li>\n<li>数据管理: 使用 Hooks 提供的 useContext 实现极简的跨组件通信方案, 摒弃传统的 redux/dva 等数据管理方案</li>\n<li>构建工具: Webpack/Vite</li>\n</ul>\n<h3 id="优点"><a href="#%E4%BC%98%E7%82%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>优点</h3>\n<ol>\n<li>\n<p>支持三种渲染模式</p>\n<p>支持服务端渲染与客户端渲染两种模式任意切换。随时安全降级。同时支持生成 html 文件独立部署也是同类型框架中唯一同时实现了三种功能的方案</p>\n</li>\n<li>\n<p>同时支持 Vite/Webpack</p>\n</li>\n<li>\n<p>轻量的数据管理方案（userContext + useReducer）</p>\n</li>\n<li>\n<p>支持约定式路由和声明式路由</p>\n</li>\n<li>\n<p>支持 antd 等流行框架（兼容 ssr）</p>\n</li>\n<li>\n<p>支持 midway，接口开发方便</p>\n</li>\n</ol>\n<h3 id="缺点"><a href="#%E7%BC%BA%E7%82%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>缺点</h3>\n<ol>\n<li>有些三方库并不支持 ssr，大多数时候需要改源码</li>\n<li>开发模式下采用 webpack 多次编译后会内存溢出</li>\n<li>文件较多时 webpack 编译速度较慢</li>\n</ol>\n<h3 id="优化方向"><a href="#%E4%BC%98%E5%8C%96%E6%96%B9%E5%90%91" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>优化方向</h3>\n<ol>\n<li>astro 孤岛架构，每个部分都可以延迟加载</li>\n<li>remix 的并行加载、预加载</li>\n<li><a href="https://github.com/ascoders/weekly/blob/master/%E5%89%8D%E6%B2%BF%E6%8A%80%E6%9C%AF/54.%E7%B2%BE%E8%AF%BB%E3%80%8A%E5%9C%A8%E6%B5%8F%E8%A7%88%E5%99%A8%E8%BF%90%E8%A1%8C%20serverRender%E3%80%8B.md" target="_blank" rel="nofollow noreferrer noopener">前端 ssr</a>，预渲染，设置合理缓存，减少服务器压力</li>\n<li>service worker 缓存</li>\n</ol>\n<h2 id="目录介绍"><a href="#%E7%9B%AE%E5%BD%95%E4%BB%8B%E7%BB%8D" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>目录介绍</h2>\n<p>详见 <a href="http://doc.ssr-fc.com/docs/features$structure" target="_blank" rel="nofollow noreferrer noopener">http://doc.ssr-fc.com/docs/features$structure</a></p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="98770558912187330000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`.\n├── build # web 目录构建产物，与 public 文件夹一样会设置为静态资源文件夹，非应用构建产物静态资源文件如图片/字体等资源建议放在 public 文件夹前端代码通过绝对路径引入\n│   ├── client # 存放前端静态资源文件\n│   └── server # 存放 external 后的服务端 bundle\n├── public # 作为静态资源目录存放静态资源文件\n├── config.js # 定义应用的配置 (框架层面使用，生产环境需要)\n├── config.prod.js # (可选) 若存在则视为生产环境的应用配置\n├── f.yml # (可选)，仅在 Serverless 场景下使用，若调用 ssr deploy 检测到无此文件会自动创建\n├── package.json\n├── src # 存放服务端 Node.js 相关代码\n│   └── index.ts\n├── tsconfig.json # 服务端 Node.js 编译配置文件\n├── typings # 存放前后端公共类型文件\n├── web # 存放前端组件相关代码\n│   ├── components # 存放公共组件\n│   │   └── header # 公共头部\n│   │   │   ├── index.less\n│   │   │   └── index.tsx\n│   │   └── layout # 页面 html 布局\n│   │       └── index.tsx # 页面 html 布局，仅在服务端被渲染\n│   │       └── App.tsx # 页面具体的组件内容，用于初始化公共配置\n│   │       └── fetch.ts # layout 级别的 fetch，用于获取所有页面的公共数据，将会在每一个页面级别的 fetch 调用之前调用\n│   ├── pages # pages 目录下的文件夹会映射为前端路由表，存放页面级别的组件\n│   │   ├── index # index文件夹映射为根路由 /index => /\n│   │   │   ├── fetch.ts # 定义 fetch 文件用来统一服务端/客户端获取数据的方式，通过 __isBrowser__ 变量区分环境，会在首页服务端渲染以及前端路由切换时被调用\n│   │   │   ├── index.less\n│   │   │   └── render.tsx # 定义 render 文件用来定义页面渲染逻辑\n│   │   └── detail\n│   │   │   ├── fetch.ts\n│   │   │   ├── index.less\n│   │   │   └── render\\$id.tsx # 映射为 /detail/:id\n│   │   │   └── user\n│   │   │        ├── fetch.ts\n│   │   │        └── render\\$id.tsx # 多级路由按照规则映射为 /detail/user/:id\n│   │   │        └── render\\$user\\$id.tsx # 多参数路由映射为 /detail/user/:user/:id\n│   │   ├── bar\n│   │   │   ├── fetch.ts\n│   │   │   └── render.tsx\n│   │   │   ├── fetch\\$id.ts\n│   │   │   └── render\\$id.tsx # 当存在多个 render 类型的文件时，每个 render 文件对应与其同名的 fetch 文件，例如 render\\$id 对应 fetch\\$id\n│   ├── tsconfig.json # web 目录下的 tsconfig 仅用于编辑器 ts 语法检测`, `98770558912187330000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">.\n├── build # web 目录构建产物，与 public 文件夹一样会设置为静态资源文件夹，非应用构建产物静态资源文件如图片/字体等资源建议放在 public 文件夹前端代码通过绝对路径引入\n│   ├── client # 存放前端静态资源文件\n│   └── server # 存放 external 后的服务端 bundle\n├── public # 作为静态资源目录存放静态资源文件\n├── config.js # 定义应用的配置 (框架层面使用，生产环境需要)\n├── config.prod.js # (可选) 若存在则视为生产环境的应用配置\n├── f.yml # (可选)，仅在 Serverless 场景下使用，若调用 ssr deploy 检测到无此文件会自动创建\n├── package.json\n├── src # 存放服务端 Node.js 相关代码\n│   └── index.ts\n├── tsconfig.json # 服务端 Node.js 编译配置文件\n├── typings # 存放前后端公共类型文件\n├── web # 存放前端组件相关代码\n│   ├── components # 存放公共组件\n│   │   └── header # 公共头部\n│   │   │   ├── index.less\n│   │   │   └── index.tsx\n│   │   └── layout # 页面 html 布局\n│   │       └── index.tsx # 页面 html 布局，仅在服务端被渲染\n│   │       └── App.tsx # 页面具体的组件内容，用于初始化公共配置\n│   │       └── fetch.ts # layout 级别的 fetch，用于获取所有页面的公共数据，将会在每一个页面级别的 fetch 调用之前调用\n│   ├── pages # pages 目录下的文件夹会映射为前端路由表，存放页面级别的组件\n│   │   ├── index # index文件夹映射为根路由 /index =&gt; /\n│   │   │   ├── fetch.ts # 定义 fetch 文件用来统一服务端/客户端获取数据的方式，通过 __isBrowser__ 变量区分环境，会在首页服务端渲染以及前端路由切换时被调用\n│   │   │   ├── index.less\n│   │   │   └── render.tsx # 定义 render 文件用来定义页面渲染逻辑\n│   │   └── detail\n│   │   │   ├── fetch.ts\n│   │   │   ├── index.less\n│   │   │   └── render$id.tsx # 映射为 /detail/:id\n│   │   │   └── user\n│   │   │        ├── fetch.ts\n│   │   │        └── render$id.tsx # 多级路由按照规则映射为 /detail/user/:id\n│   │   │        └── render$user$id.tsx # 多参数路由映射为 /detail/user/:user/:id\n│   │   ├── bar\n│   │   │   ├── fetch.ts\n│   │   │   └── render.tsx\n│   │   │   ├── fetch$id.ts\n│   │   │   └── render$id.tsx # 当存在多个 render 类型的文件时，每个 render 文件对应与其同名的 fetch 文件，例如 render$id 对应 fetch$id\n│   ├── tsconfig.json # web 目录下的 tsconfig 仅用于编辑器 ts 语法检测</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="核心"><a href="#%E6%A0%B8%E5%BF%83" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>核心</h1>\n<h2 id="多语言"><a href="#%E5%A4%9A%E8%AF%AD%E8%A8%80" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>多语言</h2>\n<p>采用 react-i18next 适配多语言，支持解析多文件夹，携带路径前缀等特性</p>\n<h3 id="文件目录"><a href="#%E6%96%87%E4%BB%B6%E7%9B%AE%E5%BD%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>文件目录</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="44042991842897215000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`locales\n   lang\n      da-DK\n      en-US\n      nb-NO\n      nl-NL\n      sv-SE\ni18n.ts`, `44042991842897215000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">locales\n   lang\n      da-DK\n      en-US\n      nb-NO\n      nl-NL\n      sv-SE\ni18n.ts</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="使用方式"><a href="#%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用方式</h3>\n<p>比如 locales/lang/da-DK/g3i/car-text.ts 下配置：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="28861902061330080000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`export default {\n   withPathPrefix: true,\n   withFilePrefix: true,\n   title: \'123456\'\n};`, `28861902061330080000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>\n   withPathPrefix<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n   withFilePrefix<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n   title<span class="token punctuation">:</span> <span class="token string">\'123456\'</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>此时拿到的 title 的 key 为 <code class="language-text">g3I.carText.title</code>, 是哪个国家根据后端拿到的 language 字符判断</p>\n<p>使用时代码如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="108442195363611660"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const { t } = useTranslation();\nconst getValue = (param: string) => t(\\`g3I.carText.\\${param}\\`);`, `108442195363611660`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="ts"\n              >\n                <span class="gatsby-code-button-language">ts</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="ts"><pre style="counter-reset: linenumber NaN" class="language-ts line-numbers"><code class="language-ts"><span class="token keyword">const</span> <span class="token punctuation">{</span> t <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useTranslation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> <span class="token function-variable function">getValue</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">param<span class="token punctuation">:</span> <span class="token builtin">string</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">g3I.carText.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>param<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<h3 id="核心代码"><a href="#%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>核心代码</h3>\n<p>进入通用组件，切换语言</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="78612481455308620000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`initLanguage(state?.language).catch()\nconst { i18n } = useTranslation()\nuseEffect(() => {\n   state?.language && i18n.changeLanguage(state.language)\n   // eslint-disable-next-line react-hooks/exhaustive-deps\n}, [state?.language])`, `78612481455308620000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="ts"\n              >\n                <span class="gatsby-code-button-language">ts</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="ts"><pre style="counter-reset: linenumber NaN" class="language-ts line-numbers"><code class="language-ts"><span class="token function">initLanguage</span><span class="token punctuation">(</span>state<span class="token operator">?</span><span class="token punctuation">.</span>language<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">const</span> <span class="token punctuation">{</span> i18n <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useTranslation</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   state<span class="token operator">?</span><span class="token punctuation">.</span>language <span class="token operator">&amp;&amp;</span> i18n<span class="token punctuation">.</span><span class="token function">changeLanguage</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>language<span class="token punctuation">)</span>\n   <span class="token comment">// eslint-disable-next-line react-hooks/exhaustive-deps</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>state<span class="token operator">?</span><span class="token punctuation">.</span>language<span class="token punctuation">]</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>读取文件夹下语言配置</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="94472996321546300000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import i18n, { Resource } from \'i18next\';\nimport { initReactI18next } from \'react-i18next\';\nimport { DEFAULT_LANGUAGE } from \'@/constants\';\nimport path from \'path\';\nimport { camelCase } from \'lodash\';\n\nconst moduleFiles = require.context(\'./lang\', true, /\\.ts\\$/);\n\nconst resources: Resource = {};\n\nmoduleFiles.keys().forEach((item: string) => {\n   const dirname = path.dirname(item);\n   // 取路径里面的第一个目录\n   const keys = dirname.split(\'/\').filter((item) => item && item !== \'.\');\n   const [key, ...restKey] = keys;\n   if (key) {\n      let value = moduleFiles(item).default || moduleFiles(item);\n      const pathPrefix = [];\n      // 是否携带路径前缀\n      if (value.withPathPrefix) {\n         pathPrefix.push(...restKey);\n      }\n\n      // 是否携带文件前缀\n      if (value.withFilePrefix) {\n         const basename = path.basename(item, \'.ts\');\n         pathPrefix.push(basename);\n      }\n\n      if (pathPrefix.length > 0) {\n         const newValue: { [key: string]: any } = {};\n         const newPathPrefix = pathPrefix.map(camelCase).join(\'.\');\n         Object.keys(value).forEach((key2) => {\n            newValue[\\`\\${newPathPrefix}.\\${key2}\\`] = value[key2];\n         });\n         value = newValue;\n      }\n\n      if (resources[key]) {\n         resources[key].translation = {\n            ...(resources[key].translation as {}),\n            ...value\n         };\n      } else {\n         resources[key] = {\n            translation: value\n         };\n      }\n   }\n});\n\nexport const initLanguage = async function(language: string = DEFAULT_LANGUAGE) {\n   if (i18n.isInitialized) {\n      if (language !== i18n.language) {\n         await i18n.changeLanguage(language);\n      }\n      return;\n   }\n   return await i18n\n      .use(initReactI18next) // passes i18n down to react-i18next\n      .init({\n         resources,\n         debug: process.env.NODE_ENV === \'development\',\n         lng: language,\n         keySeparator: false, // we do not use keys in form messages.welcome\n         interpolation: {\n            escapeValue: false\n         }\n         // 不能使用数组或对象，因为需要用户去填字符串\n         // returnObjects: true\n      })\n      .catch((error) => {\n         console.info(\'initReactI18next error:\', error);\n      });\n};`, `94472996321546300000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="ts"\n              >\n                <span class="gatsby-code-button-language">ts</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="ts"><pre style="counter-reset: linenumber NaN" class="language-ts line-numbers"><code class="language-ts"><span class="token keyword">import</span> i18n<span class="token punctuation">,</span> <span class="token punctuation">{</span> Resource <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'i18next\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> initReactI18next <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react-i18next\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">DEFAULT_LANGUAGE</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@/constants\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> path <span class="token keyword">from</span> <span class="token string">\'path\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> camelCase <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'lodash\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> moduleFiles <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">.</span><span class="token function">context</span><span class="token punctuation">(</span><span class="token string">\'./lang\'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token regex">/\\.ts$/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> resources<span class="token punctuation">:</span> Resource <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n\nmoduleFiles<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">:</span> <span class="token builtin">string</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   <span class="token keyword">const</span> dirname <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token comment">// 取路径里面的第一个目录</span>\n   <span class="token keyword">const</span> keys <span class="token operator">=</span> dirname<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">\'/\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> item <span class="token operator">&amp;&amp;</span> item <span class="token operator">!==</span> <span class="token string">\'.\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">const</span> <span class="token punctuation">[</span>key<span class="token punctuation">,</span> <span class="token operator">...</span>restKey<span class="token punctuation">]</span> <span class="token operator">=</span> keys<span class="token punctuation">;</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">let</span> value <span class="token operator">=</span> <span class="token function">moduleFiles</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">default</span> <span class="token operator">||</span> <span class="token function">moduleFiles</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> pathPrefix <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token comment">// 是否携带路径前缀</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">.</span>withPathPrefix<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         pathPrefix<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span>restKey<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token comment">// 是否携带文件前缀</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">.</span>withFilePrefix<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token keyword">const</span> basename <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">basename</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token string">\'.ts\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         pathPrefix<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>basename<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>pathPrefix<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token keyword">const</span> newValue<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span>key<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token builtin">any</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n         <span class="token keyword">const</span> newPathPrefix <span class="token operator">=</span> pathPrefix<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>camelCase<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">\'.\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">key2</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            newValue<span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>newPathPrefix<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key2<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">[</span>key2<span class="token punctuation">]</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         value <span class="token operator">=</span> newValue<span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>resources<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         resources<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span>translation <span class="token operator">=</span> <span class="token punctuation">{</span>\n            <span class="token operator">...</span><span class="token punctuation">(</span>resources<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span>translation <span class="token keyword">as</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n            <span class="token operator">...</span>value\n         <span class="token punctuation">}</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n         resources<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>\n            translation<span class="token punctuation">:</span> value\n         <span class="token punctuation">}</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">initLanguage</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">language<span class="token punctuation">:</span> <span class="token builtin">string</span> <span class="token operator">=</span> <span class="token constant">DEFAULT_LANGUAGE</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>i18n<span class="token punctuation">.</span>isInitialized<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>language <span class="token operator">!==</span> i18n<span class="token punctuation">.</span>language<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token keyword">await</span> i18n<span class="token punctuation">.</span><span class="token function">changeLanguage</span><span class="token punctuation">(</span>language<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      <span class="token keyword">return</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n   <span class="token keyword">return</span> <span class="token keyword">await</span> i18n\n      <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>initReactI18next<span class="token punctuation">)</span> <span class="token comment">// passes i18n down to react-i18next</span>\n      <span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n         resources<span class="token punctuation">,</span>\n         debug<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">\'development\'</span><span class="token punctuation">,</span>\n         lng<span class="token punctuation">:</span> language<span class="token punctuation">,</span>\n         keySeparator<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">// we do not use keys in form messages.welcome</span>\n         interpolation<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n            escapeValue<span class="token punctuation">:</span> <span class="token boolean">false</span>\n         <span class="token punctuation">}</span>\n         <span class="token comment">// 不能使用数组或对象，因为需要用户去填字符串</span>\n         <span class="token comment">// returnObjects: true</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n         <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">\'initReactI18next error:\'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="优化方向-1"><a href="#%E4%BC%98%E5%8C%96%E6%96%B9%E5%90%91-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>优化方向</h3>\n<ol>\n<li>改造成 history.push 的跳转时切换多语言未生效</li>\n<li>不支持热加载，需重新刷新后才会生效</li>\n<li>多语言配置到后台，直接从后台读</li>\n</ol>\n<h2 id="动效"><a href="#%E5%8A%A8%E6%95%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>动效</h2>\n<p><a href="https://lgst5rvnj2.feishu.cn/sheets/shtcnqVzHsbC1nnHIWrmlmssiVc?table=tblUDHlEq3ZXvNm4&#x26;view=vewUNrsVAJ&#x26;sheet=q7FBB0" target="_blank" rel="nofollow noreferrer noopener">动效一览</a></p>\n<ol>\n<li>react-spring（触发型动效）</li>\n<li>react-gsap（触发型动效，受控型动效）</li>\n<li>react-scrollmagic（页面停留组件）</li>\n<li>图片序列帧</li>\n</ol>\n<h3 id="触发型动效"><a href="#%E8%A7%A6%E5%8F%91%E5%9E%8B%E5%8A%A8%E6%95%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>触发型动效</h3>\n<ol>\n<li>位移 + 数字跳动（react-spring）</li>\n<li>文字从上到下逐渐显示、p7-wing 鹏翼门的放大缩小（react-gsap）</li>\n</ol>\n<p>示例页面：<a href="https://www.heyxpeng.com/p7" target="_blank" rel="nofollow noreferrer noopener">https://www.heyxpeng.com/p7</a></p>\n<h3 id="受控型动效"><a href="#%E5%8F%97%E6%8E%A7%E5%9E%8B%E5%8A%A8%E6%95%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>受控型动效</h3>\n<ol>\n<li>受控的图片序列帧的播放（canvas 实现的视频播放器，jsmpeg，react-gsap + jsmpeg）</li>\n<li>播放镂空文字（react-gsap + mix-blend-mode）</li>\n</ol>\n<p>示例页面：<a href="https://www.heyxpeng.com/p7" target="_blank" rel="nofollow noreferrer noopener">https://www.heyxpeng.com/p7</a></p>\n<h3 id="优化方向-2"><a href="#%E4%BC%98%E5%8C%96%E6%96%B9%E5%90%91-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>优化方向</h3>\n<ol>\n<li>图片序列帧的性能优化，目前方案在有些机器上帧率过低（采用图片序列帧 + avif）</li>\n<li>在页面滚动过快时，react-gsap 执行不完全</li>\n</ol>\n<h2 id="多端适配"><a href="#%E5%A4%9A%E7%AB%AF%E9%80%82%E9%85%8D" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>多端适配</h2>\n<h3 id="方案"><a href="#%E6%96%B9%E6%A1%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>方案</h3>\n<p>采用 @our-patches/postcss-px-to-viewport 插件</p>\n<ol>\n<li>PC 端根据 1920 px 的设计稿宽度直接转换成 rem 单位，再由 css 多媒体查询去控制</li>\n<li>h5 端直接使用 vw 单位</li>\n</ol>\n<h3 id="核心代码-1"><a href="#%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>核心代码</h3>\n<p>配置代码：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="92404655045164580000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`module.exports = {\n   plugins: [\n      [\n         \'@our-patches/postcss-px-to-viewport\',\n         {\n            // https://github.com/evrone/postcss-px-to-viewport/blob/master/README_CN.md\n            unitToConvert: \'px\', // 需要转换的单位，默认为&quot;px&quot;\n            viewportWidth: 1920, // 视窗的宽度，对应设计稿的宽度\n            unitPrecision: 8, // 指定 px 转换为视窗单位值的小数后 x 位数，转换精度尽可能的大，防止出现图片比例问题\n            viewportUnit: \'rem\', // 希望使用的视口单位\n            fontViewportUnit: \'rem\', // 字体使用的视口单位,\n            minPixelValue: 1, // 最小的转换数值\n            mediaQuery: true, // 媒体查询里的单位是否需要转换单位\n            selectorBlackList: [/^html\\$/, \'hack\'],\n            exclude: /node_modules/,\n            include: [/(\\\\|\\/)web(\\\\|\\/)/]\n         }\n      ],\n      // 此插件主要修复了移动端 100vh 的高度（即减去搜索框的高度）\n      // 效果：https://codepen.io/team/css-tricks/full/vapjge\n      // https://css-tricks.com/the-trick-to-viewport-units-on-mobile/\n      \'postcss-viewport-height-correction\'\n   ]\n};`, `92404655045164580000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>\n   plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n      <span class="token punctuation">[</span>\n         <span class="token string">\'@our-patches/postcss-px-to-viewport\'</span><span class="token punctuation">,</span>\n         <span class="token punctuation">{</span>\n            <span class="token comment">// https://github.com/evrone/postcss-px-to-viewport/blob/master/README_CN.md</span>\n            unitToConvert<span class="token punctuation">:</span> <span class="token string">\'px\'</span><span class="token punctuation">,</span> <span class="token comment">// 需要转换的单位，默认为"px"</span>\n            viewportWidth<span class="token punctuation">:</span> <span class="token number">1920</span><span class="token punctuation">,</span> <span class="token comment">// 视窗的宽度，对应设计稿的宽度</span>\n            unitPrecision<span class="token punctuation">:</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token comment">// 指定 px 转换为视窗单位值的小数后 x 位数，转换精度尽可能的大，防止出现图片比例问题</span>\n            viewportUnit<span class="token punctuation">:</span> <span class="token string">\'rem\'</span><span class="token punctuation">,</span> <span class="token comment">// 希望使用的视口单位</span>\n            fontViewportUnit<span class="token punctuation">:</span> <span class="token string">\'rem\'</span><span class="token punctuation">,</span> <span class="token comment">// 字体使用的视口单位,</span>\n            minPixelValue<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// 最小的转换数值</span>\n            mediaQuery<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 媒体查询里的单位是否需要转换单位</span>\n            selectorBlackList<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token regex">/^html$/</span><span class="token punctuation">,</span> <span class="token string">\'hack\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n            exclude<span class="token punctuation">:</span> <span class="token regex">/node_modules/</span><span class="token punctuation">,</span>\n            include<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token regex">/(\\\\|\\/)web(\\\\|\\/)/</span><span class="token punctuation">]</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">]</span><span class="token punctuation">,</span>\n      <span class="token comment">// 此插件主要修复了移动端 100vh 的高度（即减去搜索框的高度）</span>\n      <span class="token comment">// 效果：https://codepen.io/team/css-tricks/full/vapjge</span>\n      <span class="token comment">// https://css-tricks.com/the-trick-to-viewport-units-on-mobile/</span>\n      <span class="token string">\'postcss-viewport-height-correction\'</span>\n   <span class="token punctuation">]</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="93793510579637080000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`@media screen and (min-width: 2560px) and (max-width: 5119px) {\n   html {\n      font-size: 22.26px;\n   }\n}\n\n@media screen and (min-width: 2388px) and (max-width: 2559px) {\n   html {\n      font-size: 21.15px;\n   }\n}\n\n/* ... */`, `93793510579637080000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="css"\n              >\n                <span class="gatsby-code-button-language">css</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="css"><pre style="counter-reset: linenumber NaN" class="language-css line-numbers"><code class="language-css"><span class="token atrule"><span class="token rule">@media</span> screen and <span class="token punctuation">(</span><span class="token property">min-width</span><span class="token punctuation">:</span> 2560px<span class="token punctuation">)</span> and <span class="token punctuation">(</span><span class="token property">max-width</span><span class="token punctuation">:</span> 5119px<span class="token punctuation">)</span></span> <span class="token punctuation">{</span>\n   <span class="token selector">html</span> <span class="token punctuation">{</span>\n      <span class="token property">font-size</span><span class="token punctuation">:</span> 22.26px<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token atrule"><span class="token rule">@media</span> screen and <span class="token punctuation">(</span><span class="token property">min-width</span><span class="token punctuation">:</span> 2388px<span class="token punctuation">)</span> and <span class="token punctuation">(</span><span class="token property">max-width</span><span class="token punctuation">:</span> 2559px<span class="token punctuation">)</span></span> <span class="token punctuation">{</span>\n   <span class="token selector">html</span> <span class="token punctuation">{</span>\n      <span class="token property">font-size</span><span class="token punctuation">:</span> 21.15px<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">/* ... */</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="优化方向-3"><a href="#%E4%BC%98%E5%8C%96%E6%96%B9%E5%90%91-3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>优化方向</h3>\n<ol>\n<li>\n<p>所有端都使用 rem 单位，便于控制</p>\n</li>\n<li>\n<p>适配 ipad 端</p>\n</li>\n<li>\n<p>使用以下语法，保证适配的合理性</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="87729583696455660000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`@media screen and (min-width: 375px) {\n  html {\n     /* 375 宽度使用 16px 的基准尺寸，414 宽度时字号大小为 18px */\n     font-size: calc(16px + 2 * (100vw - 375px) / 39);\n  }\n}`, `87729583696455660000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="css"\n              >\n                <span class="gatsby-code-button-language">css</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="css"><pre style="counter-reset: linenumber NaN" class="language-css line-numbers"><code class="language-css"><span class="token atrule"><span class="token rule">@media</span> screen and <span class="token punctuation">(</span><span class="token property">min-width</span><span class="token punctuation">:</span> 375px<span class="token punctuation">)</span></span> <span class="token punctuation">{</span>\n  <span class="token selector">html</span> <span class="token punctuation">{</span>\n     <span class="token comment">/* 375 宽度使用 16px 的基准尺寸，414 宽度时字号大小为 18px */</span>\n     <span class="token property">font-size</span><span class="token punctuation">:</span> <span class="token function">calc</span><span class="token punctuation">(</span>16px + 2 * <span class="token punctuation">(</span>100vw - 375px<span class="token punctuation">)</span> / 39<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n</ol>\n<h2 id="懒加载"><a href="#%E6%87%92%E5%8A%A0%E8%BD%BD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>懒加载</h2>\n<p>lazyLoader 通用组件使用 vanilla-lazyload，对 video、img、div 的懒加载封装</p>\n<p><a href="https://lgst5rvnj2.feishu.cn/sheets/shtcnqVzHsbC1nnHIWrmlmssiVc?table=tbldGkkqr5yse2oT&#x26;view=vew1FvZJiF&#x26;sheet=j9pMmo" target="_blank" rel="nofollow noreferrer noopener">文档</a></p>\n<h3 id="优化方向-4"><a href="#%E4%BC%98%E5%8C%96%E6%96%B9%E5%90%91-4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>优化方向</h3>\n<ol>\n<li>预加载</li>\n<li>组件级别的懒加载、预加载</li>\n</ol>\n<h2 id="视频压缩"><a href="#%E8%A7%86%E9%A2%91%E5%8E%8B%E7%BC%A9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>视频压缩</h2>\n<h3 id="背景"><a href="#%E8%83%8C%E6%99%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>背景</h3>\n<p>需要对视频进行压缩，图片序列帧进行格式转换，支持多文件、并行压缩</p>\n<h3 id="核心代码-2"><a href="#%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>核心代码</h3>\n<p>scripts/compress.mjs</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="22210010499937650000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`#!/usr/bin/env zx\nconst { get } = require(\'lodash\');\n\nconst compressConfig = require(\'../compress.config\');\nconst concurrentRun = require(\'./concurrentRun\');\n\n// 关闭日志输出\n\\$.verbose = false;\n\nconst FILE_SUFFIX = \'mp4\';\nconst TMP_FILE_SUFFIX = \'.bak.mp4\';\n\nconst delFiles = await globby(\\`public/**/*\\${TMP_FILE_SUFFIX}\\`);\n\nawait \\$\\`rm -rf \\${delFiles}\\`;\n\nlet files = [];\n\nconst params = argv._.slice(1);\nif (params.length > 0) {\n   files = params.filter((item) => /mp4\\$/.test(item));\n} else {\n   files = await globby(\\`public/**/*.\\${FILE_SUFFIX}\\`);\n}\n\nconsole.log(\\`开始压缩 \\${FILE_SUFFIX}\\`);\n\n// https://github.com/google/zx/issues/126\n\\$.noquote = async (...args) => {\n   const q = \\$.quote;\n   \\$.quote = (v) => v;\n   const p = \\$(...args);\n   await p;\n   \\$.quote = q;\n   return p;\n};\n\nconst transformToMpeg = async (bashFunc, file) => {\n   await \\$.noquote\\`\\${bashFunc(file, file.replace(/mp4\\$/, \'mpeg\'))}\\`;\n   // await \\$\\`rm -rf \\${file}\\`\n};\n\nconst transformToMp4 = async (bashFunc, file) => {\n   await \\$.noquote\\`\\${bashFunc(file, file + TMP_FILE_SUFFIX)}\\`;\n   await \\$\\`rm -rf \\${file}\\`;\n   await \\$\\`mv \\${file}\\${TMP_FILE_SUFFIX} \\${file}\\`;\n   await \\$\\`rm -rf \\${file}\\${TMP_FILE_SUFFIX}\\`;\n};\n\nconst funcArray = [\n   {\n      path: \'mpeg.4\',\n      func: transformToMpeg\n   },\n   {\n      path: \'mp4.hasAudio\',\n      func: transformToMp4\n   },\n   {\n      path: \'mp4\',\n      func: transformToMp4\n   }\n];\n\nawait concurrentRun(\n   files.map((file) => async () => {\n      for (let i = 0; i < funcArray.length; i++) {\n         const item = funcArray[i];\n         const { bashFunc, files } = get(compressConfig.mp4, item.path);\n         // files 未定义或者包含 file\n         if (!files || files.includes(file)) {\n            await item.func(bashFunc, file);\n            return Promise.resolve();\n         }\n      }\n      return Promise.resolve();\n   })\n);\n\nconsole.log(\\`共 \\${files.length} 个 \\${FILE_SUFFIX} 压缩完成\\`);`, `22210010499937650000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">#<span class="token operator">!</span><span class="token operator">/</span>usr<span class="token operator">/</span>bin<span class="token operator">/</span>env zx\n<span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">get</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'lodash\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> compressConfig <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'../compress.config\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> concurrentRun <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./concurrentRun\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 关闭日志输出</span>\n$<span class="token punctuation">.</span>verbose <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token constant">FILE_SUFFIX</span> <span class="token operator">=</span> <span class="token string">\'mp4\'</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> <span class="token constant">TMP_FILE_SUFFIX</span> <span class="token operator">=</span> <span class="token string">\'.bak.mp4\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> delFiles <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">globby</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">public/**/*</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">TMP_FILE_SUFFIX</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">await</span> $<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">rm -rf </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>delFiles<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n\n<span class="token keyword">let</span> files <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> params <span class="token operator">=</span> argv<span class="token punctuation">.</span>_<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   files <span class="token operator">=</span> params<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token regex">/mp4$/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n   files <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">globby</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">public/**/*.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">FILE_SUFFIX</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">开始压缩 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">FILE_SUFFIX</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// https://github.com/google/zx/issues/126</span>\n$<span class="token punctuation">.</span><span class="token function-variable function">noquote</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   <span class="token keyword">const</span> q <span class="token operator">=</span> $<span class="token punctuation">.</span>quote<span class="token punctuation">;</span>\n   $<span class="token punctuation">.</span><span class="token function-variable function">quote</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token operator">=></span> v<span class="token punctuation">;</span>\n   <span class="token keyword">const</span> p <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">await</span> p<span class="token punctuation">;</span>\n   $<span class="token punctuation">.</span>quote <span class="token operator">=</span> q<span class="token punctuation">;</span>\n   <span class="token keyword">return</span> p<span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">transformToMpeg</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">bashFunc<span class="token punctuation">,</span> file</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   <span class="token keyword">await</span> $<span class="token punctuation">.</span>noquote<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">bashFunc</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> file<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/mp4$/</span><span class="token punctuation">,</span> <span class="token string">\'mpeg\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n   <span class="token comment">// await $`rm -rf ${file}`</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">transformToMp4</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">bashFunc<span class="token punctuation">,</span> file</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   <span class="token keyword">await</span> $<span class="token punctuation">.</span>noquote<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">bashFunc</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> file <span class="token operator">+</span> <span class="token constant">TMP_FILE_SUFFIX</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n   <span class="token keyword">await</span> $<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">rm -rf </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>file<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n   <span class="token keyword">await</span> $<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">mv </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>file<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">TMP_FILE_SUFFIX</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>file<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n   <span class="token keyword">await</span> $<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">rm -rf </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>file<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">TMP_FILE_SUFFIX</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> funcArray <span class="token operator">=</span> <span class="token punctuation">[</span>\n   <span class="token punctuation">{</span>\n      path<span class="token punctuation">:</span> <span class="token string">\'mpeg.4\'</span><span class="token punctuation">,</span>\n      func<span class="token punctuation">:</span> transformToMpeg\n   <span class="token punctuation">}</span><span class="token punctuation">,</span>\n   <span class="token punctuation">{</span>\n      path<span class="token punctuation">:</span> <span class="token string">\'mp4.hasAudio\'</span><span class="token punctuation">,</span>\n      func<span class="token punctuation">:</span> transformToMp4\n   <span class="token punctuation">}</span><span class="token punctuation">,</span>\n   <span class="token punctuation">{</span>\n      path<span class="token punctuation">:</span> <span class="token string">\'mp4\'</span><span class="token punctuation">,</span>\n      func<span class="token punctuation">:</span> transformToMp4\n   <span class="token punctuation">}</span>\n<span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n<span class="token keyword">await</span> <span class="token function">concurrentRun</span><span class="token punctuation">(</span>\n   files<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">file</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> funcArray<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token keyword">const</span> item <span class="token operator">=</span> funcArray<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>\n         <span class="token keyword">const</span> <span class="token punctuation">{</span> bashFunc<span class="token punctuation">,</span> files <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">get</span><span class="token punctuation">(</span>compressConfig<span class="token punctuation">.</span>mp4<span class="token punctuation">,</span> item<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token comment">// files 未定义或者包含 file</span>\n         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>files <span class="token operator">||</span> files<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">await</span> item<span class="token punctuation">.</span><span class="token function">func</span><span class="token punctuation">(</span>bashFunc<span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n      <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span><span class="token punctuation">)</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">共 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>files<span class="token punctuation">.</span>length<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 个 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">FILE_SUFFIX</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 压缩完成</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>compress.config.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="84399455818248210000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`module.exports = {\n   mp4: {\n      mp4: {\n         bashFunc: (input, output) =>\n            \\`ffmpeg -y -i \\${input} -b:v 2048k -maxrate:v 2048k -minrate:v 2048k -r 25 -an -movflags faststart -v fatal \\${output}\\`,\n         hasAudio: {\n            bashFunc: (input, output) =>\n               \\`ffmpeg -y -i \\${input} -b:v 2048k -maxrate:v 2048k -minrate:v 2048k -r 25 -movflags faststart -v fatal \\${output}\\`,\n            files: [\'public/p7/xmart-os/p7-p6-1.mp4\', \'public/no/p7/build-yours/p7-p1-1@long.mp4\']\n         }\n      },\n      mpeg: {\n         4: {\n            bashFunc: (input, output) =>\n               \\`ffmpeg -y -i \\${input} -f mpeg1video -codec:v mpeg1video -q 4 -bf 0 -r 25 -an -movflags faststart -v fatal \\${output}\\`,\n            files: [\n               \'public/p5/smart-space-internal/p5-inside.mp4\',\n               \'public/p7/extra-performance/p7-chassis.mp4\',\n               \'public/p7/learn-more/p7-wing.mp4\',\n               \'public/g3i/xmart-os/g3i-inside.mp4\'\n            ]\n         }\n      }\n   }\n};`, `84399455818248210000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>\n   mp4<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n      mp4<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n         <span class="token function-variable function">bashFunc</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">input<span class="token punctuation">,</span> output</span><span class="token punctuation">)</span> <span class="token operator">=></span>\n            <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">ffmpeg -y -i </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>input<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> -b:v 2048k -maxrate:v 2048k -minrate:v 2048k -r 25 -an -movflags faststart -v fatal </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>output<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n         hasAudio<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n            <span class="token function-variable function">bashFunc</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">input<span class="token punctuation">,</span> output</span><span class="token punctuation">)</span> <span class="token operator">=></span>\n               <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">ffmpeg -y -i </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>input<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> -b:v 2048k -maxrate:v 2048k -minrate:v 2048k -r 25 -movflags faststart -v fatal </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>output<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n            files<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'public/p7/xmart-os/p7-p6-1.mp4\'</span><span class="token punctuation">,</span> <span class="token string">\'public/no/p7/build-yours/p7-p1-1@long.mp4\'</span><span class="token punctuation">]</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      mpeg<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n         <span class="token number">4</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>\n            <span class="token function-variable function">bashFunc</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">input<span class="token punctuation">,</span> output</span><span class="token punctuation">)</span> <span class="token operator">=></span>\n               <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">ffmpeg -y -i </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>input<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> -f mpeg1video -codec:v mpeg1video -q 4 -bf 0 -r 25 -an -movflags faststart -v fatal </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>output<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n            files<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n               <span class="token string">\'public/p5/smart-space-internal/p5-inside.mp4\'</span><span class="token punctuation">,</span>\n               <span class="token string">\'public/p7/extra-performance/p7-chassis.mp4\'</span><span class="token punctuation">,</span>\n               <span class="token string">\'public/p7/learn-more/p7-wing.mp4\'</span><span class="token punctuation">,</span>\n               <span class="token string">\'public/g3i/xmart-os/g3i-inside.mp4\'</span>\n            <span class="token punctuation">]</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="使用方式-1"><a href="#%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用方式</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="41236399304981150000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`yarn compress # 压缩全部视频文件\nyarn public/g9/1.mp4 public/g9/2.mp4 public/g9/3.mp4 # 部分压缩`, `41236399304981150000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token function">yarn</span> compress <span class="token comment"># 压缩全部视频文件</span>\n<span class="token function">yarn</span> public/g9/1.mp4 public/g9/2.mp4 public/g9/3.mp4 <span class="token comment"># 部分压缩</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<h3 id="优化方向-5"><a href="#%E4%BC%98%E5%8C%96%E6%96%B9%E5%90%91-5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>优化方向</h3>\n<ol>\n<li>支持图片压缩</li>\n<li>压缩脚本工具化</li>\n<li>图片、视频的 cdn、格式优化（av1, avif）</li>\n</ol>\n<h1 id="痛点"><a href="#%E7%97%9B%E7%82%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>痛点</h1>\n<ol>\n<li>国际站与国家站，pc 与 h5 代码相互影响</li>\n<li>复用样式太多，导致需要重置的样式也很多（尽量少写或不写复用样式，除非非常确定。pc 端与 h5 端样式利用媒体查询分开写）</li>\n<li>antd 组件的适配方式有问题，未转化为 rem 单位</li>\n<li>h5 下应该使用 antd-mobile 组件</li>\n<li>国家站车型部分重复代码过多</li>\n<li>生成路由含有 2 个国家及以上的（已解决）</li>\n<li>官网内的链接跳转未使用 history.push（解决中）</li>\n</ol>',
id:"/home/runner/work/GatsbyBlog/GatsbyBlog/blog/国际官网核心原理/index.md absPath of file >>> MarkdownRemark",timeToRead:10,frontmatter:{date:"2022-12-16 17:26:23",path:"/international-official-website-core-principle/",tags:"前端, 国际官网, 预研",title:"国际官网核心原理",draft:null}},{excerpt:"需求背景 由于 PMS 项目需要开发如下图所示的甘特图，需要选择合适的组件来实现此功能 技术选型 选型 优点 缺点 gantt-schedule-timeline-calendar 功能丰富 与 UI 相差较大，定制化代码较多 react-timeline-gantt 功能丰富 与 UI 相差较大，定制化代码较多 gantt 与 UI 相差不大 在 react 使用需要封装；缺失左侧文字描述功能 gantt-for-react 与 UI 相差不大，可直接在 react…",html:'<h1 id="需求背景"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h1>\n<p>由于 PMS 项目需要开发如下图所示的甘特图，需要选择合适的组件来实现此功能</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2021-11-16-17-43-29-3a19f19f610438d817f4d830953d71b5-9c1be.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 26.041666666666668%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAIAAADKYVtkAAAACXBIWXMAAAsSAAALEgHS3X78AAAAuUlEQVQY001PW2rDQAz0/S/WG7QkDU0/TAiunZel3dW7sh1ChtEyCM2O1DHLOE0PbMSaujYyC/NgESISkXjBAxCrsKi6ezY6M38UhiJNIjkXHK9/9/lW2ArHXB3IMdkMSQt7Xbn91mUxMQBqJkaM98vnz2GYTqlbg2n4FkbX6ktwbuTJbfJplnVDXxFvyJyPff913BH0tQGWi9pyxWtsMatq+jezrFryya5Z5ShkA8S+P+9+D1DLu/kf+6kjyh20r2EAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="pms-example" title="" data-src="/static/2021-11-16-17-43-29-3a19f19f610438d817f4d830953d71b5-fee1c.png" data-srcset="/static/2021-11-16-17-43-29-3a19f19f610438d817f4d830953d71b5-a67b7.png 200w,\n/static/2021-11-16-17-43-29-3a19f19f610438d817f4d830953d71b5-0b187.png 400w,\n/static/2021-11-16-17-43-29-3a19f19f610438d817f4d830953d71b5-fee1c.png 800w,\n/static/2021-11-16-17-43-29-3a19f19f610438d817f4d830953d71b5-b1a91.png 1200w,\n/static/2021-11-16-17-43-29-3a19f19f610438d817f4d830953d71b5-9c1be.png 1440w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h1 id="技术选型"><a href="#%E6%8A%80%E6%9C%AF%E9%80%89%E5%9E%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>技术选型</h1>\n<table>\n<thead>\n<tr>\n<th align="left">选型</th>\n<th align="left">优点</th>\n<th align="left">缺点</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align="left"><a href="https://github.com/neuronetio/gantt-schedule-timeline-calendar" target="_blank" rel="nofollow noreferrer noopener">gantt-schedule-timeline-calendar</a></td>\n<td align="left">功能丰富</td>\n<td align="left">与 UI 相差较大，定制化代码较多</td>\n</tr>\n<tr>\n<td align="left"><a href="https://github.com/guiqui/react-timeline-gantt" target="_blank" rel="nofollow noreferrer noopener">react-timeline-gantt</a></td>\n<td align="left">功能丰富</td>\n<td align="left">与 UI 相差较大，定制化代码较多</td>\n</tr>\n<tr>\n<td align="left"><a href="https://github.com/frappe/gantt" target="_blank" rel="nofollow noreferrer noopener">gantt</a></td>\n<td align="left">与 UI 相差不大</td>\n<td align="left">在 react 使用需要封装；缺失左侧文字描述功能</td>\n</tr>\n<tr>\n<td align="left"><a href="https://github.com/hustcc/gantt-for-react" target="_blank" rel="nofollow noreferrer noopener">gantt-for-react</a></td>\n<td align="left">与 UI 相差不大，可直接在 react 中使用</td>\n<td align="left">缺失左侧文字描述功能</td>\n</tr>\n<tr>\n<td align="left"><a href="https://github.com/MaTeMaTuK/gantt-task-react" target="_blank" rel="nofollow noreferrer noopener">gantt-task-react</a></td>\n<td align="left">与 UI 最为接近</td>\n<td align="left">左侧文字展示功能较弱，只能展示固定的几个字段；关键样式没有暴露，不好做定制化</td>\n</tr>\n</tbody>\n</table>\n<h1 id="技术难点"><a href="#%E6%8A%80%E6%9C%AF%E9%9A%BE%E7%82%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>技术难点</h1>\n<p>需要针对 gantt-task-react 的源码做功能的增强：</p>\n<ol>\n<li>左侧文字展示功能增强</li>\n<li>样式属性暴露</li>\n</ol>\n<h1 id="核心逻辑"><a href="#%E6%A0%B8%E5%BF%83%E9%80%BB%E8%BE%91" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>核心逻辑</h1>\n<p>所有代码在<a href="https://github.com/towavephone/gantt-task-react/commit/01ef13b7623e2f1bc2fe0b483093d4b84f5edb2f" target="_blank" rel="nofollow noreferrer noopener">这里</a>，这里只展示核心逻辑</p>\n<h2 id="左侧文字展示功能"><a href="#%E5%B7%A6%E4%BE%A7%E6%96%87%E5%AD%97%E5%B1%95%E7%A4%BA%E5%8A%9F%E8%83%BD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>左侧文字展示功能</h2>\n<p>左侧文字展示的功能和 antd 的列表渲染 API 一致</p>\n<h3 id="表头渲染"><a href="#%E8%A1%A8%E5%A4%B4%E6%B8%B2%E6%9F%93" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>表头渲染</h3>\n<p>主要功能如下：</p>\n<ol>\n<li>表头的宽度</li>\n<li>标题渲染</li>\n</ol>\n<p>src/components/task-list/task-list-header.tsx</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="81772271383141140000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import React from &quot;react&quot;;\n+ import { ListColumn } from &quot;../../types/public-types&quot;;\nimport styles from &quot;./task-list-header.module.css&quot;;\n\nexport const TaskListHeaderDefault: React.FC<{\n  headerHeight: number;\n  rowWidth: string;\n  fontFamily: string;\n  fontSize: string;\n- }> = ({ headerHeight, fontFamily, fontSize, rowWidth }) => {\n+ listColumns: ListColumn[];\n+ }> = ({ headerHeight, fontFamily, fontSize, listColumns, rowWidth }) => {\n  return (\n    <div\n      className={styles.ganttTable}\n      style={{\n        fontFamily: fontFamily,\n        fontSize: fontSize,\n+       width: rowWidth,\n      }}\n    >\n      <div\n@@ -21,44 +24,17 @@ export const TaskListHeaderDefault: React.FC<{\n          height: headerHeight - 2,\n        }}\n      >\n-       <div\n-         className={styles.ganttTable_HeaderItem}\n-         style={{\n-           minWidth: rowWidth,\n-         }}\n-       >\n-         &nbsp;Name\n-       </div>\n-       <div\n-         className={styles.ganttTable_HeaderSeparator}\n-         style={{\n-           height: headerHeight * 0.5,\n-           marginTop: headerHeight * 0.2,\n-         }}\n-       />\n-       <div\n-         className={styles.ganttTable_HeaderItem}\n-         style={{\n-           minWidth: rowWidth,\n-         }}\n-       >\n-         &nbsp;From\n-       </div>\n-       <div\n-         className={styles.ganttTable_HeaderSeparator}\n-         style={{\n-           height: headerHeight * 0.5,\n-           marginTop: headerHeight * 0.25,\n-         }}\n-       />\n-       <div\n-         className={styles.ganttTable_HeaderItem}\n-         style={{\n-           minWidth: rowWidth,\n-         }}\n-       >\n-         &nbsp;To\n-       </div>\n+       {listColumns.map(item => (\n+         <div\n+           key={item.key || item.dataIndex}\n+           className={styles.ganttTable_HeaderItem}\n+           style={{\n+             width: item.width || &quot;auto&quot;,\n+           }}\n+         >\n+           {item.title}\n+         </div>\n+       ))}\n      </div>\n    </div>\n  );`, `81772271383141140000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="diff"\n              >\n                <span class="gatsby-code-button-language">diff</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="diff"><pre style="counter-reset: linenumber NaN" class="language-diff line-numbers"><code class="language-diff">import React from "react";\n<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span> import { ListColumn } from "../../types/public-types";\n</span>import styles from "./task-list-header.module.css";\n\nexport const TaskListHeaderDefault: React.FC&lt;{\n<span class="token unchanged"><span class="token prefix unchanged"> </span> headerHeight: number;\n<span class="token prefix unchanged"> </span> rowWidth: string;\n<span class="token prefix unchanged"> </span> fontFamily: string;\n<span class="token prefix unchanged"> </span> fontSize: string;\n</span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span> }> = ({ headerHeight, fontFamily, fontSize, rowWidth }) => {\n</span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span> listColumns: ListColumn[];\n<span class="token prefix inserted">+</span> }> = ({ headerHeight, fontFamily, fontSize, listColumns, rowWidth }) => {\n</span><span class="token unchanged"><span class="token prefix unchanged"> </span> return (\n<span class="token prefix unchanged"> </span>   &lt;div\n<span class="token prefix unchanged"> </span>     className={styles.ganttTable}\n<span class="token prefix unchanged"> </span>     style={{\n<span class="token prefix unchanged"> </span>       fontFamily: fontFamily,\n<span class="token prefix unchanged"> </span>       fontSize: fontSize,\n</span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span>       width: rowWidth,\n</span><span class="token unchanged"><span class="token prefix unchanged"> </span>     }}\n<span class="token prefix unchanged"> </span>   >\n<span class="token prefix unchanged"> </span>     &lt;div\n</span>@@ -21,44 +24,17 @@ export const TaskListHeaderDefault: React.FC&lt;{\n<span class="token unchanged"><span class="token prefix unchanged"> </span>         height: headerHeight - 2,\n<span class="token prefix unchanged"> </span>       }}\n<span class="token prefix unchanged"> </span>     >\n</span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span>       &lt;div\n<span class="token prefix deleted">-</span>         className={styles.ganttTable_HeaderItem}\n<span class="token prefix deleted">-</span>         style={{\n<span class="token prefix deleted">-</span>           minWidth: rowWidth,\n<span class="token prefix deleted">-</span>         }}\n<span class="token prefix deleted">-</span>       >\n<span class="token prefix deleted">-</span>         &amp;nbsp;Name\n<span class="token prefix deleted">-</span>       &lt;/div>\n<span class="token prefix deleted">-</span>       &lt;div\n<span class="token prefix deleted">-</span>         className={styles.ganttTable_HeaderSeparator}\n<span class="token prefix deleted">-</span>         style={{\n<span class="token prefix deleted">-</span>           height: headerHeight * 0.5,\n<span class="token prefix deleted">-</span>           marginTop: headerHeight * 0.2,\n<span class="token prefix deleted">-</span>         }}\n<span class="token prefix deleted">-</span>       />\n<span class="token prefix deleted">-</span>       &lt;div\n<span class="token prefix deleted">-</span>         className={styles.ganttTable_HeaderItem}\n<span class="token prefix deleted">-</span>         style={{\n<span class="token prefix deleted">-</span>           minWidth: rowWidth,\n<span class="token prefix deleted">-</span>         }}\n<span class="token prefix deleted">-</span>       >\n<span class="token prefix deleted">-</span>         &amp;nbsp;From\n<span class="token prefix deleted">-</span>       &lt;/div>\n<span class="token prefix deleted">-</span>       &lt;div\n<span class="token prefix deleted">-</span>         className={styles.ganttTable_HeaderSeparator}\n<span class="token prefix deleted">-</span>         style={{\n<span class="token prefix deleted">-</span>           height: headerHeight * 0.5,\n<span class="token prefix deleted">-</span>           marginTop: headerHeight * 0.25,\n<span class="token prefix deleted">-</span>         }}\n<span class="token prefix deleted">-</span>       />\n<span class="token prefix deleted">-</span>       &lt;div\n<span class="token prefix deleted">-</span>         className={styles.ganttTable_HeaderItem}\n<span class="token prefix deleted">-</span>         style={{\n<span class="token prefix deleted">-</span>           minWidth: rowWidth,\n<span class="token prefix deleted">-</span>         }}\n<span class="token prefix deleted">-</span>       >\n<span class="token prefix deleted">-</span>         &amp;nbsp;To\n<span class="token prefix deleted">-</span>       &lt;/div>\n</span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span>       {listColumns.map(item => (\n<span class="token prefix inserted">+</span>         &lt;div\n<span class="token prefix inserted">+</span>           key={item.key || item.dataIndex}\n<span class="token prefix inserted">+</span>           className={styles.ganttTable_HeaderItem}\n<span class="token prefix inserted">+</span>           style={{\n<span class="token prefix inserted">+</span>             width: item.width || "auto",\n<span class="token prefix inserted">+</span>           }}\n<span class="token prefix inserted">+</span>         >\n<span class="token prefix inserted">+</span>           {item.title}\n<span class="token prefix inserted">+</span>         &lt;/div>\n<span class="token prefix inserted">+</span>       ))}\n</span><span class="token unchanged"><span class="token prefix unchanged"> </span>     &lt;/div>\n<span class="token prefix unchanged"> </span>   &lt;/div>\n<span class="token prefix unchanged"> </span> );</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="列表内容渲染"><a href="#%E5%88%97%E8%A1%A8%E5%86%85%E5%AE%B9%E6%B8%B2%E6%9F%93" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>列表内容渲染</h3>\n<p>主要功能如下：</p>\n<ol>\n<li>表格宽度</li>\n<li>列表内容渲染</li>\n<li>表格行、列单元格合并</li>\n<li>表格长标题过长时省略</li>\n</ol>\n<p>src/components/task-list/task-list-table.tsx</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="40369091727152930000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`- import React, { useMemo } from &quot;react&quot;;\n+ import React from &quot;react&quot;;\n+ import classnames from &quot;classnames&quot;;\n+\nimport styles from &quot;./task-list-table.module.css&quot;;\n- import { Task } from &quot;../../types/public-types&quot;;\n+ import { Task, ListColumn } from &quot;../../types/public-types&quot;;\n+ import { getPathValue } from &quot;../../helpers/other-helper&quot;;\n\n- const localeDateStringCache = {};\n- const toLocaleDateStringFactory = (locale: string) => (\n-   date: Date,\n-   dateTimeOptions: Intl.DateTimeFormatOptions\n- ) => {\n-   const key = date.toString();\n-   let lds = localeDateStringCache[key];\n-   if (!lds) {\n-     lds = date.toLocaleDateString(locale, dateTimeOptions);\n-     localeDateStringCache[key] = lds;\n-   }\n-   return lds;\n- };\n- const dateTimeOptions: Intl.DateTimeFormatOptions = {\n-   weekday: &quot;short&quot;,\n-   year: &quot;numeric&quot;,\n-   month: &quot;long&quot;,\n-   day: &quot;numeric&quot;,\n- };\n\n+ function isRenderCell(data: any) {\n+   return (\n+     data &&\n+     typeof data === &quot;object&quot; &&\n+     !Array.isArray(data) &&\n+     !React.isValidElement(data)\n+   );\n+ }\n\nexport const TaskListTableDefault: React.FC<{\n  rowHeight: number;\n@@ -32,84 +44,153 @@ export const TaskListTableDefault: React.FC<{\n  selectedTaskId: string;\n  setSelectedTask: (taskId: string) => void;\n  onExpanderClick: (task: Task) => void;\n+ listColumns: ListColumn[];\n}> = ({\n  rowHeight,\n  rowWidth,\n  tasks,\n  fontFamily,\n  fontSize,\n- locale,\n  onExpanderClick,\n+ listColumns,\n}) => {\n- const toLocaleDateString = useMemo(() => toLocaleDateStringFactory(locale), [\n-   locale,\n- ]);\n\n  return (\n-   <div\n+   <table\n      className={styles.taskListWrapper}\n      style={{\n        fontFamily: fontFamily,\n        fontSize: fontSize,\n+       width: rowWidth,\n      }}\n    >\n-     {tasks.map(t => {\n-       let expanderSymbol = &quot;&quot;;\n-       if (t.hideChildren === false) {\n-         expanderSymbol = &quot;▼&quot;;\n-       } else if (t.hideChildren === true) {\n-         expanderSymbol = &quot;▶&quot;;\n-       }\n+     <tbody>\n+       {tasks.map((t, index) => {\n+         let expanderSymbol = &quot;&quot;;\n+         if (t.hideChildren === false) {\n+           expanderSymbol = &quot;▼&quot;;\n+         } else if (t.hideChildren === true) {\n+           expanderSymbol = &quot;▶&quot;;\n+         }\n\n-       return (\n-         <div\n-           className={styles.taskListTableRow}\n-           style={{ height: rowHeight }}\n-           key={\\`\\${t.id}row\\`}\n-         >\n-           <div\n-             className={styles.taskListCell}\n-             style={{\n-               minWidth: rowWidth,\n-               maxWidth: rowWidth,\n-             }}\n-             title={t.name}\n+         return (\n+           <tr\n+             className={styles.taskListTableRow}\n+             style={{ height: rowHeight }}\n+             key={\\`\\${t.id}row\\`}\n            >\n-             <div className={styles.taskListNameWrapper}>\n-               <div\n-                 className={\n-                   expanderSymbol\n-                     ? styles.taskListExpander\n-                     : styles.taskListEmptyExpander\n+             {listColumns.map(item => {\n+               let childNode: any;\n+               let cellProps;\n+               if (item.children) {\n+                 childNode = item.children;\n+               } else {\n+                 const value = getPathValue(t, item.dataIndex);\n+                 childNode = value;\n+                 if (item.render) {\n+                   const renderData = item.render(value, t, index);\n+                   if (isRenderCell(renderData)) {\n+                     childNode = renderData.children;\n+                     cellProps = renderData.props;\n+                   } else {\n+                     childNode = renderData;\n+                   }\n                  }\n-                 onClick={() => onExpanderClick(t)}\n-               >\n-                 {expanderSymbol}\n-               </div>\n-               <div>{t.name}</div>\n-             </div>\n-           </div>\n-           <div\n-             className={styles.taskListCell}\n-             style={{\n-               minWidth: rowWidth,\n-               maxWidth: rowWidth,\n-             }}\n-           >\n-             &nbsp;{toLocaleDateString(t.start, dateTimeOptions)}\n-           </div>\n-           <div\n-             className={styles.taskListCell}\n-             style={{\n-               minWidth: rowWidth,\n-               maxWidth: rowWidth,\n-             }}\n-           >\n-             &nbsp;{toLocaleDateString(t.end, dateTimeOptions)}\n-           </div>\n-         </div>\n-       );\n-     })}\n-   </div>\n+               }\n+               if (\n+                 typeof childNode === &quot;object&quot; &&\n+                 !Array.isArray(childNode) &&\n+                 !React.isValidElement(childNode)\n+               ) {\n+                 childNode = null;\n+               }\n+               const { colSpan: cellColSpan, rowSpan: cellRowSpan } =\n+                 cellProps || {};\n+               const mergedColSpan =\n+                 cellColSpan !== undefined ? cellColSpan : item.colSpan;\n+               const mergedRowSpan =\n+                 cellRowSpan !== undefined ? cellRowSpan : item.rowSpan;\n+               if (mergedColSpan === 0 || mergedRowSpan === 0) {\n+                 return null;\n+               }\n+               let title;\n+               const ellipsisConfig =\n+                 item.ellipsis === true\n+                   ? {\n+                       showTitle: true,\n+                     }\n+                   : item.ellipsis;\n+               if (ellipsisConfig && ellipsisConfig.showTitle) {\n+                 if (\n+                   typeof childNode === &quot;string&quot; ||\n+                   typeof childNode === &quot;number&quot;\n+                 ) {\n+                   title = childNode.toString();\n+                 } else if (\n+                   React.isValidElement(childNode) &&\n+                   // @ts-ignore\n+                   typeof childNode.props.children === &quot;string&quot;\n+                 ) {\n+                   // @ts-ignore\n+                   title = childNode.props.children;\n+                 }\n+               }\n+               return (\n+                 <td\n+                   key={item.key || item.dataIndex}\n+                   className={classnames(\n+                     styles.taskListCell,\n+                     item.ellipsis ? styles.ellipsis : &quot;&quot;\n+                   )}\n+                   style={{\n+                     width: item.width || &quot;auto&quot;,\n+                   }}\n+                   colSpan={\n+                     mergedColSpan && mergedColSpan !== 1\n+                       ? mergedColSpan\n+                       : null\n+                   }\n+                   rowSpan={\n+                     mergedRowSpan && mergedRowSpan !== 1\n+                       ? mergedRowSpan\n+                       : null\n+                   }\n+                 >\n+                   <div className={styles.taskListNameWrapper}>\n+                     <div\n+                       className={\n+                         expanderSymbol\n+                           ? styles.taskListExpander\n+                           : styles.taskListEmptyExpander\n+                       }\n+                       onClick={() => onExpanderClick(t)}\n+                     >\n+                       {expanderSymbol}\n+                     </div>\n+                     <div title={title} className={styles.ellipsis}>\n+                       {childNode}\n+                     </div>\n+                   </div>\n+                 </td>\n+               );\n+             })}\n+           </tr>\n+         );\n+       })}\n+     </tbody>\n+   </table>\n  );\n};`, `40369091727152930000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="diff"\n              >\n                <span class="gatsby-code-button-language">diff</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="diff"><pre style="counter-reset: linenumber NaN" class="language-diff line-numbers"><code class="language-diff"><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span> import React, { useMemo } from "react";\n</span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span> import React from "react";\n<span class="token prefix inserted">+</span> import classnames from "classnames";\n<span class="token prefix inserted">+</span>\n</span>import styles from "./task-list-table.module.css";\n<span class="token deleted-sign deleted"><span class="token prefix deleted">-</span> import { Task } from "../../types/public-types";\n</span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span> import { Task, ListColumn } from "../../types/public-types";\n<span class="token prefix inserted">+</span> import { getPathValue } from "../../helpers/other-helper";\n</span>\n<span class="token deleted-sign deleted"><span class="token prefix deleted">-</span> const localeDateStringCache = {};\n<span class="token prefix deleted">-</span> const toLocaleDateStringFactory = (locale: string) => (\n<span class="token prefix deleted">-</span>   date: Date,\n<span class="token prefix deleted">-</span>   dateTimeOptions: Intl.DateTimeFormatOptions\n<span class="token prefix deleted">-</span> ) => {\n<span class="token prefix deleted">-</span>   const key = date.toString();\n<span class="token prefix deleted">-</span>   let lds = localeDateStringCache[key];\n<span class="token prefix deleted">-</span>   if (!lds) {\n<span class="token prefix deleted">-</span>     lds = date.toLocaleDateString(locale, dateTimeOptions);\n<span class="token prefix deleted">-</span>     localeDateStringCache[key] = lds;\n<span class="token prefix deleted">-</span>   }\n<span class="token prefix deleted">-</span>   return lds;\n<span class="token prefix deleted">-</span> };\n<span class="token prefix deleted">-</span> const dateTimeOptions: Intl.DateTimeFormatOptions = {\n<span class="token prefix deleted">-</span>   weekday: "short",\n<span class="token prefix deleted">-</span>   year: "numeric",\n<span class="token prefix deleted">-</span>   month: "long",\n<span class="token prefix deleted">-</span>   day: "numeric",\n<span class="token prefix deleted">-</span> };\n</span>\n<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span> function isRenderCell(data: any) {\n<span class="token prefix inserted">+</span>   return (\n<span class="token prefix inserted">+</span>     data &amp;&amp;\n<span class="token prefix inserted">+</span>     typeof data === "object" &amp;&amp;\n<span class="token prefix inserted">+</span>     !Array.isArray(data) &amp;&amp;\n<span class="token prefix inserted">+</span>     !React.isValidElement(data)\n<span class="token prefix inserted">+</span>   );\n<span class="token prefix inserted">+</span> }\n</span>\nexport const TaskListTableDefault: React.FC&lt;{\n<span class="token unchanged"><span class="token prefix unchanged"> </span> rowHeight: number;\n</span>@@ -32,84 +44,153 @@ export const TaskListTableDefault: React.FC&lt;{\n<span class="token unchanged"><span class="token prefix unchanged"> </span> selectedTaskId: string;\n<span class="token prefix unchanged"> </span> setSelectedTask: (taskId: string) => void;\n<span class="token prefix unchanged"> </span> onExpanderClick: (task: Task) => void;\n</span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span> listColumns: ListColumn[];\n</span>}> = ({\n<span class="token unchanged"><span class="token prefix unchanged"> </span> rowHeight,\n<span class="token prefix unchanged"> </span> rowWidth,\n<span class="token prefix unchanged"> </span> tasks,\n<span class="token prefix unchanged"> </span> fontFamily,\n<span class="token prefix unchanged"> </span> fontSize,\n</span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span> locale,\n</span><span class="token unchanged"><span class="token prefix unchanged"> </span> onExpanderClick,\n</span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span> listColumns,\n</span>}) => {\n<span class="token deleted-sign deleted"><span class="token prefix deleted">-</span> const toLocaleDateString = useMemo(() => toLocaleDateStringFactory(locale), [\n<span class="token prefix deleted">-</span>   locale,\n<span class="token prefix deleted">-</span> ]);\n</span>\n<span class="token unchanged"><span class="token prefix unchanged"> </span> return (\n</span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span>   &lt;div\n</span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span>   &lt;table\n</span><span class="token unchanged"><span class="token prefix unchanged"> </span>     className={styles.taskListWrapper}\n<span class="token prefix unchanged"> </span>     style={{\n<span class="token prefix unchanged"> </span>       fontFamily: fontFamily,\n<span class="token prefix unchanged"> </span>       fontSize: fontSize,\n</span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span>       width: rowWidth,\n</span><span class="token unchanged"><span class="token prefix unchanged"> </span>     }}\n<span class="token prefix unchanged"> </span>   >\n</span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span>     {tasks.map(t => {\n<span class="token prefix deleted">-</span>       let expanderSymbol = "";\n<span class="token prefix deleted">-</span>       if (t.hideChildren === false) {\n<span class="token prefix deleted">-</span>         expanderSymbol = "▼";\n<span class="token prefix deleted">-</span>       } else if (t.hideChildren === true) {\n<span class="token prefix deleted">-</span>         expanderSymbol = "▶";\n<span class="token prefix deleted">-</span>       }\n</span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span>     &lt;tbody>\n<span class="token prefix inserted">+</span>       {tasks.map((t, index) => {\n<span class="token prefix inserted">+</span>         let expanderSymbol = "";\n<span class="token prefix inserted">+</span>         if (t.hideChildren === false) {\n<span class="token prefix inserted">+</span>           expanderSymbol = "▼";\n<span class="token prefix inserted">+</span>         } else if (t.hideChildren === true) {\n<span class="token prefix inserted">+</span>           expanderSymbol = "▶";\n<span class="token prefix inserted">+</span>         }\n</span>\n<span class="token deleted-sign deleted"><span class="token prefix deleted">-</span>       return (\n<span class="token prefix deleted">-</span>         &lt;div\n<span class="token prefix deleted">-</span>           className={styles.taskListTableRow}\n<span class="token prefix deleted">-</span>           style={{ height: rowHeight }}\n<span class="token prefix deleted">-</span>           key={`${t.id}row`}\n<span class="token prefix deleted">-</span>         >\n<span class="token prefix deleted">-</span>           &lt;div\n<span class="token prefix deleted">-</span>             className={styles.taskListCell}\n<span class="token prefix deleted">-</span>             style={{\n<span class="token prefix deleted">-</span>               minWidth: rowWidth,\n<span class="token prefix deleted">-</span>               maxWidth: rowWidth,\n<span class="token prefix deleted">-</span>             }}\n<span class="token prefix deleted">-</span>             title={t.name}\n</span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span>         return (\n<span class="token prefix inserted">+</span>           &lt;tr\n<span class="token prefix inserted">+</span>             className={styles.taskListTableRow}\n<span class="token prefix inserted">+</span>             style={{ height: rowHeight }}\n<span class="token prefix inserted">+</span>             key={`${t.id}row`}\n</span><span class="token unchanged"><span class="token prefix unchanged"> </span>           >\n</span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span>             &lt;div className={styles.taskListNameWrapper}>\n<span class="token prefix deleted">-</span>               &lt;div\n<span class="token prefix deleted">-</span>                 className={\n<span class="token prefix deleted">-</span>                   expanderSymbol\n<span class="token prefix deleted">-</span>                     ? styles.taskListExpander\n<span class="token prefix deleted">-</span>                     : styles.taskListEmptyExpander\n</span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span>             {listColumns.map(item => {\n<span class="token prefix inserted">+</span>               let childNode: any;\n<span class="token prefix inserted">+</span>               let cellProps;\n<span class="token prefix inserted">+</span>               if (item.children) {\n<span class="token prefix inserted">+</span>                 childNode = item.children;\n<span class="token prefix inserted">+</span>               } else {\n<span class="token prefix inserted">+</span>                 const value = getPathValue(t, item.dataIndex);\n<span class="token prefix inserted">+</span>                 childNode = value;\n<span class="token prefix inserted">+</span>                 if (item.render) {\n<span class="token prefix inserted">+</span>                   const renderData = item.render(value, t, index);\n<span class="token prefix inserted">+</span>                   if (isRenderCell(renderData)) {\n<span class="token prefix inserted">+</span>                     childNode = renderData.children;\n<span class="token prefix inserted">+</span>                     cellProps = renderData.props;\n<span class="token prefix inserted">+</span>                   } else {\n<span class="token prefix inserted">+</span>                     childNode = renderData;\n<span class="token prefix inserted">+</span>                   }\n</span><span class="token unchanged"><span class="token prefix unchanged"> </span>                 }\n</span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span>                 onClick={() => onExpanderClick(t)}\n<span class="token prefix deleted">-</span>               >\n<span class="token prefix deleted">-</span>                 {expanderSymbol}\n<span class="token prefix deleted">-</span>               &lt;/div>\n<span class="token prefix deleted">-</span>               &lt;div>{t.name}&lt;/div>\n<span class="token prefix deleted">-</span>             &lt;/div>\n<span class="token prefix deleted">-</span>           &lt;/div>\n<span class="token prefix deleted">-</span>           &lt;div\n<span class="token prefix deleted">-</span>             className={styles.taskListCell}\n<span class="token prefix deleted">-</span>             style={{\n<span class="token prefix deleted">-</span>               minWidth: rowWidth,\n<span class="token prefix deleted">-</span>               maxWidth: rowWidth,\n<span class="token prefix deleted">-</span>             }}\n<span class="token prefix deleted">-</span>           >\n<span class="token prefix deleted">-</span>             &amp;nbsp;{toLocaleDateString(t.start, dateTimeOptions)}\n<span class="token prefix deleted">-</span>           &lt;/div>\n<span class="token prefix deleted">-</span>           &lt;div\n<span class="token prefix deleted">-</span>             className={styles.taskListCell}\n<span class="token prefix deleted">-</span>             style={{\n<span class="token prefix deleted">-</span>               minWidth: rowWidth,\n<span class="token prefix deleted">-</span>               maxWidth: rowWidth,\n<span class="token prefix deleted">-</span>             }}\n<span class="token prefix deleted">-</span>           >\n<span class="token prefix deleted">-</span>             &amp;nbsp;{toLocaleDateString(t.end, dateTimeOptions)}\n<span class="token prefix deleted">-</span>           &lt;/div>\n<span class="token prefix deleted">-</span>         &lt;/div>\n<span class="token prefix deleted">-</span>       );\n<span class="token prefix deleted">-</span>     })}\n<span class="token prefix deleted">-</span>   &lt;/div>\n</span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span>               }\n<span class="token prefix inserted">+</span>               if (\n<span class="token prefix inserted">+</span>                 typeof childNode === "object" &amp;&amp;\n<span class="token prefix inserted">+</span>                 !Array.isArray(childNode) &amp;&amp;\n<span class="token prefix inserted">+</span>                 !React.isValidElement(childNode)\n<span class="token prefix inserted">+</span>               ) {\n<span class="token prefix inserted">+</span>                 childNode = null;\n<span class="token prefix inserted">+</span>               }\n<span class="token prefix inserted">+</span>               const { colSpan: cellColSpan, rowSpan: cellRowSpan } =\n<span class="token prefix inserted">+</span>                 cellProps || {};\n<span class="token prefix inserted">+</span>               const mergedColSpan =\n<span class="token prefix inserted">+</span>                 cellColSpan !== undefined ? cellColSpan : item.colSpan;\n<span class="token prefix inserted">+</span>               const mergedRowSpan =\n<span class="token prefix inserted">+</span>                 cellRowSpan !== undefined ? cellRowSpan : item.rowSpan;\n<span class="token prefix inserted">+</span>               if (mergedColSpan === 0 || mergedRowSpan === 0) {\n<span class="token prefix inserted">+</span>                 return null;\n<span class="token prefix inserted">+</span>               }\n<span class="token prefix inserted">+</span>               let title;\n<span class="token prefix inserted">+</span>               const ellipsisConfig =\n<span class="token prefix inserted">+</span>                 item.ellipsis === true\n<span class="token prefix inserted">+</span>                   ? {\n<span class="token prefix inserted">+</span>                       showTitle: true,\n<span class="token prefix inserted">+</span>                     }\n<span class="token prefix inserted">+</span>                   : item.ellipsis;\n<span class="token prefix inserted">+</span>               if (ellipsisConfig &amp;&amp; ellipsisConfig.showTitle) {\n<span class="token prefix inserted">+</span>                 if (\n<span class="token prefix inserted">+</span>                   typeof childNode === "string" ||\n<span class="token prefix inserted">+</span>                   typeof childNode === "number"\n<span class="token prefix inserted">+</span>                 ) {\n<span class="token prefix inserted">+</span>                   title = childNode.toString();\n<span class="token prefix inserted">+</span>                 } else if (\n<span class="token prefix inserted">+</span>                   React.isValidElement(childNode) &amp;&amp;\n<span class="token prefix inserted">+</span>                   // @ts-ignore\n<span class="token prefix inserted">+</span>                   typeof childNode.props.children === "string"\n<span class="token prefix inserted">+</span>                 ) {\n<span class="token prefix inserted">+</span>                   // @ts-ignore\n<span class="token prefix inserted">+</span>                   title = childNode.props.children;\n<span class="token prefix inserted">+</span>                 }\n<span class="token prefix inserted">+</span>               }\n<span class="token prefix inserted">+</span>               return (\n<span class="token prefix inserted">+</span>                 &lt;td\n<span class="token prefix inserted">+</span>                   key={item.key || item.dataIndex}\n<span class="token prefix inserted">+</span>                   className={classnames(\n<span class="token prefix inserted">+</span>                     styles.taskListCell,\n<span class="token prefix inserted">+</span>                     item.ellipsis ? styles.ellipsis : ""\n<span class="token prefix inserted">+</span>                   )}\n<span class="token prefix inserted">+</span>                   style={{\n<span class="token prefix inserted">+</span>                     width: item.width || "auto",\n<span class="token prefix inserted">+</span>                   }}\n<span class="token prefix inserted">+</span>                   colSpan={\n<span class="token prefix inserted">+</span>                     mergedColSpan &amp;&amp; mergedColSpan !== 1\n<span class="token prefix inserted">+</span>                       ? mergedColSpan\n<span class="token prefix inserted">+</span>                       : null\n<span class="token prefix inserted">+</span>                   }\n<span class="token prefix inserted">+</span>                   rowSpan={\n<span class="token prefix inserted">+</span>                     mergedRowSpan &amp;&amp; mergedRowSpan !== 1\n<span class="token prefix inserted">+</span>                       ? mergedRowSpan\n<span class="token prefix inserted">+</span>                       : null\n<span class="token prefix inserted">+</span>                   }\n<span class="token prefix inserted">+</span>                 >\n<span class="token prefix inserted">+</span>                   &lt;div className={styles.taskListNameWrapper}>\n<span class="token prefix inserted">+</span>                     &lt;div\n<span class="token prefix inserted">+</span>                       className={\n<span class="token prefix inserted">+</span>                         expanderSymbol\n<span class="token prefix inserted">+</span>                           ? styles.taskListExpander\n<span class="token prefix inserted">+</span>                           : styles.taskListEmptyExpander\n<span class="token prefix inserted">+</span>                       }\n<span class="token prefix inserted">+</span>                       onClick={() => onExpanderClick(t)}\n<span class="token prefix inserted">+</span>                     >\n<span class="token prefix inserted">+</span>                       {expanderSymbol}\n<span class="token prefix inserted">+</span>                     &lt;/div>\n<span class="token prefix inserted">+</span>                     &lt;div title={title} className={styles.ellipsis}>\n<span class="token prefix inserted">+</span>                       {childNode}\n<span class="token prefix inserted">+</span>                     &lt;/div>\n<span class="token prefix inserted">+</span>                   &lt;/div>\n<span class="token prefix inserted">+</span>                 &lt;/td>\n<span class="token prefix inserted">+</span>               );\n<span class="token prefix inserted">+</span>             })}\n<span class="token prefix inserted">+</span>           &lt;/tr>\n<span class="token prefix inserted">+</span>         );\n<span class="token prefix inserted">+</span>       })}\n<span class="token prefix inserted">+</span>     &lt;/tbody>\n<span class="token prefix inserted">+</span>   &lt;/table>\n</span><span class="token unchanged"><span class="token prefix unchanged"> </span> );\n</span>};</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="样式属性暴露"><a href="#%E6%A0%B7%E5%BC%8F%E5%B1%9E%E6%80%A7%E6%9A%B4%E9%9C%B2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>样式属性暴露</h2>\n<p>主要功能如下：</p>\n<ol>\n<li>行级斑马线显示</li>\n<li>日期分隔线显示</li>\n<li>行级分隔线显示</li>\n</ol>\n<p>src/components/grid/grid-body.tsx</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="36982283537878780000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`  columnWidth: number;\n  todayColor: string;\n  rtl: boolean;\n+  hasCrosswalk: boolean;\n+  hasDateLine: boolean;\n+  renderRowLines: (index: number) => boolean;\n};\n+\nexport const GridBody: React.FC<GridBodyProps> = ({\n  tasks,\n  dates,\n@@ -20,6 +24,9 @@ export const GridBody: React.FC<GridBodyProps> = ({\n  columnWidth,\n  todayColor,\n  rtl,\n+ hasCrosswalk,\n+ hasDateLine,\n+ renderRowLines,\n}) => {\n  let y = 0;\n  const gridRows: ReactChild[] = [];\n@@ -33,27 +40,33 @@ export const GridBody: React.FC<GridBodyProps> = ({\n      className={styles.gridRowLine}\n    />,\n  ];\n- for (const task of tasks) {\n-   gridRows.push(\n-     <rect\n-       key={&quot;Row&quot; + task.id}\n-       x=&quot;0&quot;\n-       y={y}\n-       width={svgWidth}\n-       height={rowHeight}\n-       className={styles.gridRow}\n-     />\n-   );\n-   rowLines.push(\n-     <line\n-       key={&quot;RowLine&quot; + task.id}\n-       x=&quot;0&quot;\n-       y1={y + rowHeight}\n-       x2={svgWidth}\n-       y2={y + rowHeight}\n-       className={styles.gridRowLine}\n-     />\n-   );\n+ for (let i = 0; i < tasks.length; i++) {\n+   const task = tasks[i];\n+   if (hasCrosswalk) {\n+     gridRows.push(\n+       <rect\n+         key={&quot;Row&quot; + task.id}\n+         x=&quot;0&quot;\n+         y={y}\n+         width={svgWidth}\n+         height={rowHeight}\n+         className={styles.gridRow}\n+       />\n+     );\n+   }\n+   const isRenderRowLines = renderRowLines(i);\n+   if (isRenderRowLines) {\n+     rowLines.push(\n+       <line\n+         key={&quot;RowLine&quot; + task.id}\n+         x=&quot;0&quot;\n+         y1={y + rowHeight}\n+         x2={svgWidth}\n+         y2={y + rowHeight}\n+         className={styles.gridRowLine}\n+       />\n+     );\n+   }\n    y += rowHeight;\n  }\n\n@@ -63,16 +76,18 @@ export const GridBody: React.FC<GridBodyProps> = ({\n  let today: ReactChild = <rect />;\n  for (let i = 0; i < dates.length; i++) {\n    const date = dates[i];\n-   ticks.push(\n-     <line\n-       key={date.getTime()}\n-       x1={tickX}\n-       y1={0}\n-       x2={tickX}\n-       y2={y}\n-       className={styles.gridTick}\n-     />\n-   );\n+   if (hasDateLine) {\n+     ticks.push(\n+       <line\n+         key={date.getTime()}\n+         x1={tickX}\n+         y1={0}\n+         x2={tickX}\n+         y2={y}\n+         className={styles.gridTick}\n+       />\n+     );\n+   }\n    if (\n      (i + 1 !== dates.length &&\n        date.getTime() < now.getTime() &&`, `36982283537878780000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="diff"\n              >\n                <span class="gatsby-code-button-language">diff</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="diff"><pre style="counter-reset: linenumber NaN" class="language-diff line-numbers"><code class="language-diff"><span class="token unchanged"><span class="token prefix unchanged"> </span> columnWidth: number;\n<span class="token prefix unchanged"> </span> todayColor: string;\n<span class="token prefix unchanged"> </span> rtl: boolean;\n</span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span>  hasCrosswalk: boolean;\n<span class="token prefix inserted">+</span>  hasDateLine: boolean;\n<span class="token prefix inserted">+</span>  renderRowLines: (index: number) => boolean;\n</span>};\n<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span>\n</span>export const GridBody: React.FC&lt;GridBodyProps> = ({\n<span class="token unchanged"><span class="token prefix unchanged"> </span> tasks,\n<span class="token prefix unchanged"> </span> dates,\n</span>@@ -20,6 +24,9 @@ export const GridBody: React.FC&lt;GridBodyProps> = ({\n<span class="token unchanged"><span class="token prefix unchanged"> </span> columnWidth,\n<span class="token prefix unchanged"> </span> todayColor,\n<span class="token prefix unchanged"> </span> rtl,\n</span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span> hasCrosswalk,\n<span class="token prefix inserted">+</span> hasDateLine,\n<span class="token prefix inserted">+</span> renderRowLines,\n</span>}) => {\n<span class="token unchanged"><span class="token prefix unchanged"> </span> let y = 0;\n<span class="token prefix unchanged"> </span> const gridRows: ReactChild[] = [];\n</span>@@ -33,27 +40,33 @@ export const GridBody: React.FC&lt;GridBodyProps> = ({\n<span class="token unchanged"><span class="token prefix unchanged"> </span>     className={styles.gridRowLine}\n<span class="token prefix unchanged"> </span>   />,\n<span class="token prefix unchanged"> </span> ];\n</span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span> for (const task of tasks) {\n<span class="token prefix deleted">-</span>   gridRows.push(\n<span class="token prefix deleted">-</span>     &lt;rect\n<span class="token prefix deleted">-</span>       key={"Row" + task.id}\n<span class="token prefix deleted">-</span>       x="0"\n<span class="token prefix deleted">-</span>       y={y}\n<span class="token prefix deleted">-</span>       width={svgWidth}\n<span class="token prefix deleted">-</span>       height={rowHeight}\n<span class="token prefix deleted">-</span>       className={styles.gridRow}\n<span class="token prefix deleted">-</span>     />\n<span class="token prefix deleted">-</span>   );\n<span class="token prefix deleted">-</span>   rowLines.push(\n<span class="token prefix deleted">-</span>     &lt;line\n<span class="token prefix deleted">-</span>       key={"RowLine" + task.id}\n<span class="token prefix deleted">-</span>       x="0"\n<span class="token prefix deleted">-</span>       y1={y + rowHeight}\n<span class="token prefix deleted">-</span>       x2={svgWidth}\n<span class="token prefix deleted">-</span>       y2={y + rowHeight}\n<span class="token prefix deleted">-</span>       className={styles.gridRowLine}\n<span class="token prefix deleted">-</span>     />\n<span class="token prefix deleted">-</span>   );\n</span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span> for (let i = 0; i &lt; tasks.length; i++) {\n<span class="token prefix inserted">+</span>   const task = tasks[i];\n<span class="token prefix inserted">+</span>   if (hasCrosswalk) {\n<span class="token prefix inserted">+</span>     gridRows.push(\n<span class="token prefix inserted">+</span>       &lt;rect\n<span class="token prefix inserted">+</span>         key={"Row" + task.id}\n<span class="token prefix inserted">+</span>         x="0"\n<span class="token prefix inserted">+</span>         y={y}\n<span class="token prefix inserted">+</span>         width={svgWidth}\n<span class="token prefix inserted">+</span>         height={rowHeight}\n<span class="token prefix inserted">+</span>         className={styles.gridRow}\n<span class="token prefix inserted">+</span>       />\n<span class="token prefix inserted">+</span>     );\n<span class="token prefix inserted">+</span>   }\n<span class="token prefix inserted">+</span>   const isRenderRowLines = renderRowLines(i);\n<span class="token prefix inserted">+</span>   if (isRenderRowLines) {\n<span class="token prefix inserted">+</span>     rowLines.push(\n<span class="token prefix inserted">+</span>       &lt;line\n<span class="token prefix inserted">+</span>         key={"RowLine" + task.id}\n<span class="token prefix inserted">+</span>         x="0"\n<span class="token prefix inserted">+</span>         y1={y + rowHeight}\n<span class="token prefix inserted">+</span>         x2={svgWidth}\n<span class="token prefix inserted">+</span>         y2={y + rowHeight}\n<span class="token prefix inserted">+</span>         className={styles.gridRowLine}\n<span class="token prefix inserted">+</span>       />\n<span class="token prefix inserted">+</span>     );\n<span class="token prefix inserted">+</span>   }\n</span><span class="token unchanged"><span class="token prefix unchanged"> </span>   y += rowHeight;\n<span class="token prefix unchanged"> </span> }\n</span>\n@@ -63,16 +76,18 @@ export const GridBody: React.FC&lt;GridBodyProps> = ({\n<span class="token unchanged"><span class="token prefix unchanged"> </span> let today: ReactChild = &lt;rect />;\n<span class="token prefix unchanged"> </span> for (let i = 0; i &lt; dates.length; i++) {\n<span class="token prefix unchanged"> </span>   const date = dates[i];\n</span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span>   ticks.push(\n<span class="token prefix deleted">-</span>     &lt;line\n<span class="token prefix deleted">-</span>       key={date.getTime()}\n<span class="token prefix deleted">-</span>       x1={tickX}\n<span class="token prefix deleted">-</span>       y1={0}\n<span class="token prefix deleted">-</span>       x2={tickX}\n<span class="token prefix deleted">-</span>       y2={y}\n<span class="token prefix deleted">-</span>       className={styles.gridTick}\n<span class="token prefix deleted">-</span>     />\n<span class="token prefix deleted">-</span>   );\n</span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span>   if (hasDateLine) {\n<span class="token prefix inserted">+</span>     ticks.push(\n<span class="token prefix inserted">+</span>       &lt;line\n<span class="token prefix inserted">+</span>         key={date.getTime()}\n<span class="token prefix inserted">+</span>         x1={tickX}\n<span class="token prefix inserted">+</span>         y1={0}\n<span class="token prefix inserted">+</span>         x2={tickX}\n<span class="token prefix inserted">+</span>         y2={y}\n<span class="token prefix inserted">+</span>         className={styles.gridTick}\n<span class="token prefix inserted">+</span>       />\n<span class="token prefix inserted">+</span>     );\n<span class="token prefix inserted">+</span>   }\n</span><span class="token unchanged"><span class="token prefix unchanged"> </span>   if (\n<span class="token prefix unchanged"> </span>     (i + 1 !== dates.length &amp;&amp;\n<span class="token prefix unchanged"> </span>       date.getTime() &lt; now.getTime() &amp;&amp;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="实现效果"><a href="#%E5%AE%9E%E7%8E%B0%E6%95%88%E6%9E%9C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>实现效果</h1>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/vtuj8t?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=split" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h1 id="总结"><a href="#%E6%80%BB%E7%BB%93" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h1>\n<ol>\n<li>ts 写的不够熟练且精简，需要加强</li>\n<li>对于样式属性暴露应该用固定类名去控制，原作者包含很多的 className 属性，非常冗余</li>\n<li>本地源码优化很少涉及到 svg 的优化，需要加强 svg 的学习</li>\n</ol>',
id:"/home/runner/work/GatsbyBlog/GatsbyBlog/blog/甘特图组件源码优化/index.md absPath of file >>> MarkdownRemark",timeToRead:8,frontmatter:{date:"2021-11-15 11:48:33",path:"/gantt-component-optimization/",tags:"前端, 源码优化, 预研",title:"甘特图组件源码优化",draft:null}},{excerpt:"需求背景 由于 C 端营销线新建项目需要模板化，需要代码模板的生成功能，以便统一技术栈 一期 一期代码生成需要在 lerna 工程下去做改造，除了带有代码模板的功能，还封装了执行脚本的入口 参考链接： react-boilerplate 这里的代码模板包含项目级别的代码模板、页面级别的代码模板，目前只完成了项目的代码模板生成 目录结构 脚本主入口 package.json 模板代码生成 模板代码执行主入口 internals/generators/index.js 检测 packages…",html:'<h1 id="需求背景"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h1>\n<p>由于 C 端营销线新建项目需要模板化，需要代码模板的生成功能，以便统一技术栈</p>\n<h1 id="一期"><a href="#%E4%B8%80%E6%9C%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>一期</h1>\n<p>一期代码生成需要在 lerna 工程下去做改造，除了带有代码模板的功能，还封装了执行脚本的入口</p>\n<p>参考链接：<a href="https://github.com/react-boilerplate/react-boilerplate" target="_blank" rel="nofollow noreferrer noopener">react-boilerplate</a></p>\n<blockquote>\n<p>这里的代码模板包含项目级别的代码模板、页面级别的代码模板，目前只完成了项目的代码模板生成</p>\n</blockquote>\n<h2 id="目录结构"><a href="#%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>目录结构</h2>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="25864269169136534000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`.\n├── index.html\n├── internals\n│   ├── generators\n│   │   ├── index.js // 模板代码执行主入口\n│   │   ├── package // 模板文件夹，带有模板变量的文件后缀名为 hbs\n│   │   │   ├── config.js.hbs\n│   │   │   ├── index.js // 项目级别的代码模板命令执行入口\n│   │   │   ├── package-lock.json.hbs\n│   │   │   ├── package.json.hbs // 带模板变量的模板文件\n│   │   │   └── template // 不带模板变量的模板文件\n│   │   ├── page\n│   │   │   └── index.js // 页面级别的代码模板命令执行入口\n│   │   └── utils\n│   │       ├── directoryExists.js // 检测 packages 文件夹存在性\n│   │       └── fileKeyExists.js // 检测 packages 下面文件里面某种属性是否存在，主要为了实现端口占用检测功能\n│   └── scripts\n│       ├── helpers\n│       │   └── argv.js // 命令行参数封装\n│       └── run.js // 脚本执行主入口\n├── packages // 项目源代码，即代码模板生成后的结果文件夹\n|   ├── demo1\n│   └── demo2\n├── lerna.json\n├── package-lock.json\n├── package.json // 命令主入口\n└── readme.md`, `25864269169136534000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token punctuation">.</span>\n├── index<span class="token punctuation">.</span>html\n├── internals\n│   ├── generators\n│   │   ├── index<span class="token punctuation">.</span>js <span class="token comment">// 模板代码执行主入口</span>\n│   │   ├── <span class="token keyword">package</span> <span class="token comment">// 模板文件夹，带有模板变量的文件后缀名为 hbs</span>\n│   │   │   ├── config<span class="token punctuation">.</span>js<span class="token punctuation">.</span>hbs\n│   │   │   ├── index<span class="token punctuation">.</span>js <span class="token comment">// 项目级别的代码模板命令执行入口</span>\n│   │   │   ├── <span class="token keyword">package</span><span class="token operator">-</span>lock<span class="token punctuation">.</span>json<span class="token punctuation">.</span>hbs\n│   │   │   ├── <span class="token keyword">package</span><span class="token punctuation">.</span>json<span class="token punctuation">.</span>hbs <span class="token comment">// 带模板变量的模板文件</span>\n│   │   │   └── template <span class="token comment">// 不带模板变量的模板文件</span>\n│   │   ├── page\n│   │   │   └── index<span class="token punctuation">.</span>js <span class="token comment">// 页面级别的代码模板命令执行入口</span>\n│   │   └── utils\n│   │       ├── directoryExists<span class="token punctuation">.</span>js <span class="token comment">// 检测 packages 文件夹存在性</span>\n│   │       └── fileKeyExists<span class="token punctuation">.</span>js <span class="token comment">// 检测 packages 下面文件里面某种属性是否存在，主要为了实现端口占用检测功能</span>\n│   └── scripts\n│       ├── helpers\n│       │   └── argv<span class="token punctuation">.</span>js <span class="token comment">// 命令行参数封装</span>\n│       └── run<span class="token punctuation">.</span>js <span class="token comment">// 脚本执行主入口</span>\n├── packages <span class="token comment">// 项目源代码，即代码模板生成后的结果文件夹</span>\n<span class="token operator">|</span>   ├── demo1\n│   └── demo2\n├── lerna<span class="token punctuation">.</span>json\n├── <span class="token keyword">package</span><span class="token operator">-</span>lock<span class="token punctuation">.</span>json\n├── <span class="token keyword">package</span><span class="token punctuation">.</span>json <span class="token comment">// 命令主入口</span>\n└── readme<span class="token punctuation">.</span>md</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="脚本主入口"><a href="#%E8%84%9A%E6%9C%AC%E4%B8%BB%E5%85%A5%E5%8F%A3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>脚本主入口</h2>\n<p>package.json</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="6190682537055570000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`{\n   &quot;name&quot;: &quot;root&quot;,\n   &quot;private&quot;: true,\n   &quot;devDependencies&quot;: {\n      &quot;cross-env&quot;: &quot;^7.0.3&quot;,\n      &quot;lerna&quot;: &quot;^4.0.0&quot;,\n      &quot;minimist&quot;: &quot;^1.2.5&quot;,\n      &quot;plop&quot;: &quot;^2.7.4&quot;,\n      &quot;shelljs&quot;: &quot;^0.8.4&quot;\n   },\n   &quot;scripts&quot;: {\n      &quot;postinstall&quot;: &quot;lerna bootstrap&quot;,\n      &quot;start&quot;: &quot;node internals/scripts/run --cmd=start&quot;,\n      &quot;build&quot;: &quot;node internals/scripts/run --cmd=build&quot;,\n      &quot;generate&quot;: &quot;plop --plopfile internals/generators/index.js&quot;\n   }\n}`, `6190682537055570000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="json"\n              >\n                <span class="gatsby-code-button-language">json</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="json"><pre style="counter-reset: linenumber NaN" class="language-json line-numbers"><code class="language-json"><span class="token punctuation">{</span>\n   <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"root"</span><span class="token punctuation">,</span>\n   <span class="token property">"private"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n   <span class="token property">"devDependencies"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n      <span class="token property">"cross-env"</span><span class="token operator">:</span> <span class="token string">"^7.0.3"</span><span class="token punctuation">,</span>\n      <span class="token property">"lerna"</span><span class="token operator">:</span> <span class="token string">"^4.0.0"</span><span class="token punctuation">,</span>\n      <span class="token property">"minimist"</span><span class="token operator">:</span> <span class="token string">"^1.2.5"</span><span class="token punctuation">,</span>\n      <span class="token property">"plop"</span><span class="token operator">:</span> <span class="token string">"^2.7.4"</span><span class="token punctuation">,</span>\n      <span class="token property">"shelljs"</span><span class="token operator">:</span> <span class="token string">"^0.8.4"</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span>\n   <span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n      <span class="token property">"postinstall"</span><span class="token operator">:</span> <span class="token string">"lerna bootstrap"</span><span class="token punctuation">,</span>\n      <span class="token property">"start"</span><span class="token operator">:</span> <span class="token string">"node internals/scripts/run --cmd=start"</span><span class="token punctuation">,</span>\n      <span class="token property">"build"</span><span class="token operator">:</span> <span class="token string">"node internals/scripts/run --cmd=build"</span><span class="token punctuation">,</span>\n      <span class="token property">"generate"</span><span class="token operator">:</span> <span class="token string">"plop --plopfile internals/generators/index.js"</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="模板代码生成"><a href="#%E6%A8%A1%E6%9D%BF%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>模板代码生成</h2>\n<h3 id="模板代码执行主入口"><a href="#%E6%A8%A1%E6%9D%BF%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E4%B8%BB%E5%85%A5%E5%8F%A3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>模板代码执行主入口</h3>\n<p>internals/generators/index.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="42649312537709220000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const shell = require(\'shelljs\');\n\nconst packageGenerator = require(\'./package/index.js\');\n\nmodule.exports = (plop) => {\n   plop.setGenerator(\'package\', packageGenerator); // 注册 package 下的命令\n   // plop.setGenerator(&quot;page&quot;, containerGenerator);\n   plop.setDefaultInclude({ actionTypes: true });\n   // 拓展 plop 复制功能\n   plop.setActionType(\'copy\', (answers, config, plop) => {\n      const src = plop.renderString(config.src, answers);\n      const dest = plop.renderString(config.dest, answers);\n      shell.cp(\'-r\', src, dest);\n   });\n};`, `42649312537709220000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> shell <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'shelljs\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> packageGenerator <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./package/index.js\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nmodule<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">plop</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   plop<span class="token punctuation">.</span><span class="token function">setGenerator</span><span class="token punctuation">(</span><span class="token string">\'package\'</span><span class="token punctuation">,</span> packageGenerator<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 注册 package 下的命令</span>\n   <span class="token comment">// plop.setGenerator("page", containerGenerator);</span>\n   plop<span class="token punctuation">.</span><span class="token function">setDefaultInclude</span><span class="token punctuation">(</span><span class="token punctuation">{</span> actionTypes<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token comment">// 拓展 plop 复制功能</span>\n   plop<span class="token punctuation">.</span><span class="token function">setActionType</span><span class="token punctuation">(</span><span class="token string">\'copy\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">answers<span class="token punctuation">,</span> config<span class="token punctuation">,</span> plop</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> src <span class="token operator">=</span> plop<span class="token punctuation">.</span><span class="token function">renderString</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>src<span class="token punctuation">,</span> answers<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> dest <span class="token operator">=</span> plop<span class="token punctuation">.</span><span class="token function">renderString</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>dest<span class="token punctuation">,</span> answers<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      shell<span class="token punctuation">.</span><span class="token function">cp</span><span class="token punctuation">(</span><span class="token string">\'-r\'</span><span class="token punctuation">,</span> src<span class="token punctuation">,</span> dest<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="检测-packages-文件夹存在性"><a href="#%E6%A3%80%E6%B5%8B-packages-%E6%96%87%E4%BB%B6%E5%A4%B9%E5%AD%98%E5%9C%A8%E6%80%A7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>检测 packages 文件夹存在性</h3>\n<p>internals/generators/utils/directoryExists.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="41089699663127350000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const fs = require(\'fs\');\nconst path = require(\'path\');\n\n/**\n *\n * @param {*} directoryPath 文件夹路径\n * @param {*} value 输入的值\n * @returns\n */\nfunction directoryExists(directoryPath, value) {\n   const directoryFullPath = path.join(\n      process.cwd(),\n      ...(Array.isArray(directoryPath) ? directoryPath : [directoryPath])\n   );\n   if (fs.existsSync(directoryFullPath) && fs.statSync(directoryFullPath).isDirectory()) {\n      const packages = fs.readdirSync(directoryFullPath);\n      return packages.indexOf(value) >= 0;\n   }\n   return false;\n}\n\nmodule.exports = directoryExists;`, `41089699663127350000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'fs\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'path\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">/**\n *\n * @param {*} directoryPath 文件夹路径\n * @param {*} value 输入的值\n * @returns\n */</span>\n<span class="token keyword">function</span> <span class="token function">directoryExists</span><span class="token punctuation">(</span><span class="token parameter">directoryPath<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">const</span> directoryFullPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>\n      process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n      <span class="token operator">...</span><span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>directoryPath<span class="token punctuation">)</span> <span class="token operator">?</span> directoryPath <span class="token punctuation">:</span> <span class="token punctuation">[</span>directoryPath<span class="token punctuation">]</span><span class="token punctuation">)</span>\n   <span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>directoryFullPath<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> fs<span class="token punctuation">.</span><span class="token function">statSync</span><span class="token punctuation">(</span>directoryFullPath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> packages <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readdirSync</span><span class="token punctuation">(</span>directoryFullPath<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">return</span> packages<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n   <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\nmodule<span class="token punctuation">.</span>exports <span class="token operator">=</span> directoryExists<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="检测-packages-下面文件里面某种属性是否存在"><a href="#%E6%A3%80%E6%B5%8B-packages-%E4%B8%8B%E9%9D%A2%E6%96%87%E4%BB%B6%E9%87%8C%E9%9D%A2%E6%9F%90%E7%A7%8D%E5%B1%9E%E6%80%A7%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>检测 packages 下面文件里面某种属性是否存在</h3>\n<p>主要为了实现端口占用检测功能</p>\n<p>internals/generators/utils/fileKeyExists.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="72733631321048750000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const fs = require(\'fs\');\nconst path = require(\'path\');\nconst packagesPath = path.join(process.cwd(), \'packages\');\nconst packages = fs.readdirSync(packagesPath);\nconst lodash = require(\'lodash\');\n\n/**\n * 检测 packages 下面文件里面某种属性是否存在\n * @param {*} filePath 文件路径\n * @param {*} key 文件的属性\n * @param {*} defaultValue 属性不存在时的默认值\n * @param {*} value 输入的值\n * @returns\n */\nfunction fileKeyExists(filePath, key, defaultValue, value) {\n   const values = [];\n   packages.forEach((item) => {\n      if (item !== \'js-bridge\') {\n         const fileFullPath = path.join(packagesPath, item, ...(Array.isArray(filePath) ? filePath : [filePath]));\n         if (fs.existsSync(fileFullPath) && fs.statSync(fileFullPath).isFile()) {\n            const fileResult = require(fileFullPath);\n            const fileKeyValue = lodash.get(fileResult, key);\n            if (fileKeyValue) {\n               values.push(fileKeyValue);\n            } else {\n               values.push(defaultValue);\n            }\n         } else {\n            values.push(defaultValue);\n         }\n      }\n   });\n   return values.map((item) => \\`\\${item}\\`).indexOf(value) >= 0;\n}\n\nmodule.exports = fileKeyExists;`, `72733631321048750000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'fs\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'path\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> packagesPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">\'packages\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> packages <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readdirSync</span><span class="token punctuation">(</span>packagesPath<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> lodash <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'lodash\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">/**\n * 检测 packages 下面文件里面某种属性是否存在\n * @param {*} filePath 文件路径\n * @param {*} key 文件的属性\n * @param {*} defaultValue 属性不存在时的默认值\n * @param {*} value 输入的值\n * @returns\n */</span>\n<span class="token keyword">function</span> <span class="token function">fileKeyExists</span><span class="token punctuation">(</span><span class="token parameter">filePath<span class="token punctuation">,</span> key<span class="token punctuation">,</span> defaultValue<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">const</span> values <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n   packages<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>item <span class="token operator">!==</span> <span class="token string">\'js-bridge\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token keyword">const</span> fileFullPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>packagesPath<span class="token punctuation">,</span> item<span class="token punctuation">,</span> <span class="token operator">...</span><span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span> <span class="token operator">?</span> filePath <span class="token punctuation">:</span> <span class="token punctuation">[</span>filePath<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token keyword">if</span> <span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>fileFullPath<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> fs<span class="token punctuation">.</span><span class="token function">statSync</span><span class="token punctuation">(</span>fileFullPath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">const</span> fileResult <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span>fileFullPath<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token keyword">const</span> fileKeyValue <span class="token operator">=</span> lodash<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>fileResult<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token keyword">if</span> <span class="token punctuation">(</span>fileKeyValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n               values<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>fileKeyValue<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n               values<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>defaultValue<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span>\n         <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n            values<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>defaultValue<span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">return</span> values<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>item<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\nmodule<span class="token punctuation">.</span>exports <span class="token operator">=</span> fileKeyExists<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="项目级别的代码模板命令执行入口"><a href="#%E9%A1%B9%E7%9B%AE%E7%BA%A7%E5%88%AB%E7%9A%84%E4%BB%A3%E7%A0%81%E6%A8%A1%E6%9D%BF%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%85%A5%E5%8F%A3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>项目级别的代码模板命令执行入口</h3>\n<p>internals/generators/package/index.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="38010202280611275000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const directoryExists = require(\'../utils/directoryExists\');\nconst fileKeyExists = require(\'../utils/fileKeyExists\');\n\nconst portExists = (value) =>\n   fileKeyExists(\'config.js\', \'serverPort\', 3000, value) || fileKeyExists(\'config.js\', \'fePort\', 8888, value);\n\nmodule.exports = {\n   description: \'生成 package\',\n   prompts: [\n      {\n         type: \'input\',\n         name: \'name\',\n         message: \'package 叫什么名字？\',\n         default: \'demo\',\n         validate: (value) => {\n            if (/.+/.test(value)) {\n               return directoryExists(\'packages\', value) ? \'package 名字已存在\' : true;\n            }\n\n            return \'package 名字必填\';\n         }\n      },\n      {\n         type: \'input\',\n         name: \'serverPort\',\n         message: \'package 的 Node.js 服务端口？\',\n         default: \'8001\',\n         validate: (value) => {\n            if (/.+/.test(value)) {\n               return portExists(value) ? \'要设置 package 的 Node.js 服务端口已被占用\' : true;\n            }\n\n            return \'package 名字必填\';\n         }\n      },\n      {\n         type: \'input\',\n         name: \'fePort\',\n         message: \'package 的 webpack-dev-server 端口？\',\n         default: \'8002\',\n         validate: (value) => {\n            if (/.+/.test(value)) {\n               return portExists(value) ? \'要设置 package 的 webpack-dev-server 端口已被占用\' : true;\n            }\n\n            return \'package 名字必填\';\n         }\n      }\n   ],\n   actions: (data) => {\n      const actions = [\n         {\n            type: \'copy\',\n            src: \'internals/generators/package/template\',\n            dest: \'packages/{{ dashCase name }}\'\n         },\n         {\n            type: \'addMany\',\n            templateFiles: \'package/*.hbs\',\n            destination: \'../../packages/{{ dashCase name }}/\'\n         }\n      ];\n\n      return actions;\n   }\n};`, `38010202280611275000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> directoryExists <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'../utils/directoryExists\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> fileKeyExists <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'../utils/fileKeyExists\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">portExists</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=></span>\n   <span class="token function">fileKeyExists</span><span class="token punctuation">(</span><span class="token string">\'config.js\'</span><span class="token punctuation">,</span> <span class="token string">\'serverPort\'</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">fileKeyExists</span><span class="token punctuation">(</span><span class="token string">\'config.js\'</span><span class="token punctuation">,</span> <span class="token string">\'fePort\'</span><span class="token punctuation">,</span> <span class="token number">8888</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nmodule<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>\n   description<span class="token punctuation">:</span> <span class="token string">\'生成 package\'</span><span class="token punctuation">,</span>\n   prompts<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n      <span class="token punctuation">{</span>\n         type<span class="token punctuation">:</span> <span class="token string">\'input\'</span><span class="token punctuation">,</span>\n         name<span class="token punctuation">:</span> <span class="token string">\'name\'</span><span class="token punctuation">,</span>\n         message<span class="token punctuation">:</span> <span class="token string">\'package 叫什么名字？\'</span><span class="token punctuation">,</span>\n         <span class="token keyword">default</span><span class="token punctuation">:</span> <span class="token string">\'demo\'</span><span class="token punctuation">,</span>\n         <span class="token function-variable function">validate</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex">/.+/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n               <span class="token keyword">return</span> <span class="token function">directoryExists</span><span class="token punctuation">(</span><span class="token string">\'packages\'</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">\'package 名字已存在\'</span> <span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span>\n\n            <span class="token keyword">return</span> <span class="token string">\'package 名字必填\'</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      <span class="token punctuation">{</span>\n         type<span class="token punctuation">:</span> <span class="token string">\'input\'</span><span class="token punctuation">,</span>\n         name<span class="token punctuation">:</span> <span class="token string">\'serverPort\'</span><span class="token punctuation">,</span>\n         message<span class="token punctuation">:</span> <span class="token string">\'package 的 Node.js 服务端口？\'</span><span class="token punctuation">,</span>\n         <span class="token keyword">default</span><span class="token punctuation">:</span> <span class="token string">\'8001\'</span><span class="token punctuation">,</span>\n         <span class="token function-variable function">validate</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex">/.+/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n               <span class="token keyword">return</span> <span class="token function">portExists</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">\'要设置 package 的 Node.js 服务端口已被占用\'</span> <span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span>\n\n            <span class="token keyword">return</span> <span class="token string">\'package 名字必填\'</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      <span class="token punctuation">{</span>\n         type<span class="token punctuation">:</span> <span class="token string">\'input\'</span><span class="token punctuation">,</span>\n         name<span class="token punctuation">:</span> <span class="token string">\'fePort\'</span><span class="token punctuation">,</span>\n         message<span class="token punctuation">:</span> <span class="token string">\'package 的 webpack-dev-server 端口？\'</span><span class="token punctuation">,</span>\n         <span class="token keyword">default</span><span class="token punctuation">:</span> <span class="token string">\'8002\'</span><span class="token punctuation">,</span>\n         <span class="token function-variable function">validate</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex">/.+/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n               <span class="token keyword">return</span> <span class="token function">portExists</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">\'要设置 package 的 webpack-dev-server 端口已被占用\'</span> <span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span>\n\n            <span class="token keyword">return</span> <span class="token string">\'package 名字必填\'</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">]</span><span class="token punctuation">,</span>\n   <span class="token function-variable function">actions</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> actions <span class="token operator">=</span> <span class="token punctuation">[</span>\n         <span class="token punctuation">{</span>\n            type<span class="token punctuation">:</span> <span class="token string">\'copy\'</span><span class="token punctuation">,</span>\n            src<span class="token punctuation">:</span> <span class="token string">\'internals/generators/package/template\'</span><span class="token punctuation">,</span>\n            dest<span class="token punctuation">:</span> <span class="token string">\'packages/{{ dashCase name }}\'</span>\n         <span class="token punctuation">}</span><span class="token punctuation">,</span>\n         <span class="token punctuation">{</span>\n            type<span class="token punctuation">:</span> <span class="token string">\'addMany\'</span><span class="token punctuation">,</span>\n            templateFiles<span class="token punctuation">:</span> <span class="token string">\'package/*.hbs\'</span><span class="token punctuation">,</span>\n            destination<span class="token punctuation">:</span> <span class="token string">\'../../packages/{{ dashCase name }}/\'</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">return</span> actions<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="带模板变量的模板文件"><a href="#%E5%B8%A6%E6%A8%A1%E6%9D%BF%E5%8F%98%E9%87%8F%E7%9A%84%E6%A8%A1%E6%9D%BF%E6%96%87%E4%BB%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>带模板变量的模板文件</h3>\n<p>hbs 文件为模板文件，所有需要替换的地方用 <code class="language-text">{{}}</code> 模板变量，详情请查看 <a href="https://github.com/plopjs/plop" target="_blank" rel="nofollow noreferrer noopener">plop</a>，其他模板文件不再举例</p>\n<p>internals/generators/package/config.js.hbs</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="90403045892518080000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`module.exports = {\n  prefix: \'page\',\n  serverPort: {{ serverPort }},\n  fePort: {{ fePort }}\n}`, `90403045892518080000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="hbs"\n              >\n                <span class="gatsby-code-button-language">hbs</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="hbs"><pre style="counter-reset: linenumber NaN" class="language-hbs line-numbers"><code class="language-hbs">module.exports = {\n  prefix: &#39;page&#39;,\n  serverPort: {{ serverPort }},\n  fePort: {{ fePort }}\n}</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="运行结果"><a href="#%E8%BF%90%E8%A1%8C%E7%BB%93%E6%9E%9C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>运行结果</h3>\n<p>以下是检测存在冲突的情况</p>\n<p><img src="/static/code-generation-addfae6d6b5126e00ca2c25e4c38dd96.gif" alt="代码生成冲突检测"></p>\n<h2 id="脚本执行封装"><a href="#%E8%84%9A%E6%9C%AC%E6%89%A7%E8%A1%8C%E5%B0%81%E8%A3%85" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>脚本执行封装</h2>\n<p>封装 lerna 脚本，以实现脚本的并行执行</p>\n<p>internals/scripts/helpers/argv.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="41336701926294530000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`module.exports = require(\'minimist\')(process.argv.slice(2));`, `41336701926294530000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'minimist\'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>argv<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>internals/scripts/run.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="61115606225936370000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`#!/usr/bin/env node\n\nconst shelljs = require(\'shelljs\');\nconst argv = require(\'./helpers/argv\');\n\nlet scopeParams = [];\nconst arguments = argv._;\n\nif (arguments && arguments.length > 0) {\n   scopeParams = arguments.map((item) => \\`--scope=\\${item}\\`);\n}\n\nshelljs.exec(\\`\n  cross-env FORCE_COLOR=1 lerna run \\${argv.cmd} --stream --parallel \\${scopeParams.join(\' \')}\n\\`);`, `61115606225936370000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">#<span class="token operator">!</span><span class="token operator">/</span>usr<span class="token operator">/</span>bin<span class="token operator">/</span>env node\n\n<span class="token keyword">const</span> shelljs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'shelljs\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> argv <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./helpers/argv\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">let</span> scopeParams <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> arguments <span class="token operator">=</span> argv<span class="token punctuation">.</span>_<span class="token punctuation">;</span>\n\n<span class="token keyword">if</span> <span class="token punctuation">(</span>arguments <span class="token operator">&amp;&amp;</span> arguments<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   scopeParams <span class="token operator">=</span> arguments<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">--scope=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>item<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\nshelljs<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">\n  cross-env FORCE_COLOR=1 lerna run </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>argv<span class="token punctuation">.</span>cmd<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> --stream --parallel </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>scopeParams<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">\' \'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="使用说明"><a href="#%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用说明</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="72380202898400680000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`npm i # 安装依赖\n\n# 启动\nnpm start # 并行启动所有 package\nnpm start website # 启动 website 项目\nnpm start website demo # 并行启动 website,demo 项目\n\n# 编译\nnpm run build # 并行编译所有 package\nnpm run build website # 编译 package 项目\nnpm run build website demo # 并行编译 website,demo 项目\n\n# 模板代码生成\nnpm run generate`, `72380202898400680000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token function">npm</span> i <span class="token comment"># 安装依赖</span>\n\n<span class="token comment"># 启动</span>\n<span class="token function">npm</span> start <span class="token comment"># 并行启动所有 package</span>\n<span class="token function">npm</span> start website <span class="token comment"># 启动 website 项目</span>\n<span class="token function">npm</span> start website demo <span class="token comment"># 并行启动 website,demo 项目</span>\n\n<span class="token comment"># 编译</span>\n<span class="token function">npm</span> run build <span class="token comment"># 并行编译所有 package</span>\n<span class="token function">npm</span> run build website <span class="token comment"># 编译 package 项目</span>\n<span class="token function">npm</span> run build website demo <span class="token comment"># 并行编译 website,demo 项目</span>\n\n<span class="token comment"># 模板代码生成</span>\n<span class="token function">npm</span> run generate</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="二期"><a href="#%E4%BA%8C%E6%9C%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>二期</h1>\n<p>由于项目代码需要分离，不再使用 lerna 管理各个产品线的包，所以二期主要工作在于封装成可用的命令行，以便直接使用它来新建项目</p>\n<p>参考链接：<a href="https://juejin.cn/post/6919308174151385096" target="_blank" rel="nofollow noreferrer noopener">从 0-1 搭建 react，ts 脚手架</a></p>\n<h2 id="目录结构-1"><a href="#%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>目录结构</h2>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="25817648666062910000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`.\n├── bin\n│   └── cli.js // 脚本主入口\n├── internals\n│   ├── generators\n│   │   ├── index.js // 模板代码生成\n│   │   ├── package\n│   │   │   ├── config.js.hbs\n│   │   │   ├── index.js\n│   │   │   ├── package-lock.json.hbs\n│   │   │   ├── package.json.hbs\n│   │   │   └── template\n│   │   ├── page\n│   │   │   └── index.js\n│   │   └── utils\n│   │       ├── directoryExists.js\n│   │       └── fileKeyExists.js\n│   └── scripts\n│       ├── helpers\n│       │   └── argv.js\n│       └── run.js\n├── package-lock.json\n├── package.json\n├── src\n│   ├── create.js // 模板代码生成主入口\n│   └── start.js\n└── utils\n    └── index.js`, `25817648666062910000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token punctuation">.</span>\n├── bin\n│   └── cli<span class="token punctuation">.</span>js <span class="token comment">// 脚本主入口</span>\n├── internals\n│   ├── generators\n│   │   ├── index<span class="token punctuation">.</span>js <span class="token comment">// 模板代码生成</span>\n│   │   ├── <span class="token keyword">package</span>\n│   │   │   ├── config<span class="token punctuation">.</span>js<span class="token punctuation">.</span>hbs\n│   │   │   ├── index<span class="token punctuation">.</span>js\n│   │   │   ├── <span class="token keyword">package</span><span class="token operator">-</span>lock<span class="token punctuation">.</span>json<span class="token punctuation">.</span>hbs\n│   │   │   ├── <span class="token keyword">package</span><span class="token punctuation">.</span>json<span class="token punctuation">.</span>hbs\n│   │   │   └── template\n│   │   ├── page\n│   │   │   └── index<span class="token punctuation">.</span>js\n│   │   └── utils\n│   │       ├── directoryExists<span class="token punctuation">.</span>js\n│   │       └── fileKeyExists<span class="token punctuation">.</span>js\n│   └── scripts\n│       ├── helpers\n│       │   └── argv<span class="token punctuation">.</span>js\n│       └── run<span class="token punctuation">.</span>js\n├── <span class="token keyword">package</span><span class="token operator">-</span>lock<span class="token punctuation">.</span>json\n├── <span class="token keyword">package</span><span class="token punctuation">.</span>json\n├── src\n│   ├── create<span class="token punctuation">.</span>js <span class="token comment">// 模板代码生成主入口</span>\n│   └── start<span class="token punctuation">.</span>js\n└── utils\n    └── index<span class="token punctuation">.</span>js</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="脚本主入口-1"><a href="#%E8%84%9A%E6%9C%AC%E4%B8%BB%E5%85%A5%E5%8F%A3-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>脚本主入口</h2>\n<p>package.json</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="96233778157084850000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`{\n   &quot;name&quot;: &quot;cli&quot;,\n   &quot;version&quot;: &quot;1.0.0&quot;,\n   &quot;description&quot;: &quot;销服C端脚手架&quot;,\n   &quot;main&quot;: &quot;index.js&quot;,\n   &quot;scripts&quot;: {\n      &quot;test&quot;: &quot;echo \\&quot;Error: no test specified\\&quot; && exit 1&quot;,\n      &quot;start&quot;: &quot;node internals/scripts/run --cmd=start&quot;,\n      &quot;build&quot;: &quot;node internals/scripts/run --cmd=build&quot;\n   },\n   &quot;bin&quot;: {\n      &quot;cli&quot;: &quot;./bin/cli.js&quot;\n   },\n   &quot;author&quot;: &quot;&quot;,\n   &quot;license&quot;: &quot;ISC&quot;,\n   &quot;dependencies&quot;: {\n      &quot;commander&quot;: &quot;^8.2.0&quot;,\n      &quot;cross-env&quot;: &quot;^7.0.3&quot;,\n      &quot;minimist&quot;: &quot;^1.2.5&quot;,\n      &quot;plop&quot;: &quot;^2.7.4&quot;,\n      &quot;shelljs&quot;: &quot;^0.8.4&quot;\n   }\n}`, `96233778157084850000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="json"\n              >\n                <span class="gatsby-code-button-language">json</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="json"><pre style="counter-reset: linenumber NaN" class="language-json line-numbers"><code class="language-json"><span class="token punctuation">{</span>\n   <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"cli"</span><span class="token punctuation">,</span>\n   <span class="token property">"version"</span><span class="token operator">:</span> <span class="token string">"1.0.0"</span><span class="token punctuation">,</span>\n   <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"销服C端脚手架"</span><span class="token punctuation">,</span>\n   <span class="token property">"main"</span><span class="token operator">:</span> <span class="token string">"index.js"</span><span class="token punctuation">,</span>\n   <span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n      <span class="token property">"test"</span><span class="token operator">:</span> <span class="token string">"echo \\"Error: no test specified\\" &amp;&amp; exit 1"</span><span class="token punctuation">,</span>\n      <span class="token property">"start"</span><span class="token operator">:</span> <span class="token string">"node internals/scripts/run --cmd=start"</span><span class="token punctuation">,</span>\n      <span class="token property">"build"</span><span class="token operator">:</span> <span class="token string">"node internals/scripts/run --cmd=build"</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span>\n   <span class="token property">"bin"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n      <span class="token property">"cli"</span><span class="token operator">:</span> <span class="token string">"./bin/cli.js"</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span>\n   <span class="token property">"author"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>\n   <span class="token property">"license"</span><span class="token operator">:</span> <span class="token string">"ISC"</span><span class="token punctuation">,</span>\n   <span class="token property">"dependencies"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n      <span class="token property">"commander"</span><span class="token operator">:</span> <span class="token string">"^8.2.0"</span><span class="token punctuation">,</span>\n      <span class="token property">"cross-env"</span><span class="token operator">:</span> <span class="token string">"^7.0.3"</span><span class="token punctuation">,</span>\n      <span class="token property">"minimist"</span><span class="token operator">:</span> <span class="token string">"^1.2.5"</span><span class="token punctuation">,</span>\n      <span class="token property">"plop"</span><span class="token operator">:</span> <span class="token string">"^2.7.4"</span><span class="token punctuation">,</span>\n      <span class="token property">"shelljs"</span><span class="token operator">:</span> <span class="token string">"^0.8.4"</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="模板代码生成-1"><a href="#%E6%A8%A1%E6%9D%BF%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>模板代码生成</h2>\n<p>以下仅列出和一期的不同点</p>\n<h3 id="模板代码执行主入口-1"><a href="#%E6%A8%A1%E6%9D%BF%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E4%B8%BB%E5%85%A5%E5%8F%A3-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>模板代码执行主入口</h3>\n<p>相比一期主要多了新建项目后 <code class="language-text">npm install</code> 的功能</p>\n<p>bin/cli.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="25308232686517430000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`#!/usr/bin/env node\nconst program = require(\'commander\');\nconst create = require(\'../src/create\');\n// const start = require(&quot;../src/start&quot;);\n\nconst { green } = require(\'../utils\');\n\nprogram.version(\'1.0.0\');\n\n/* create a project */\nprogram\n   .command(\'create\')\n   .description(\'create a project \')\n   .action(function() {\n      green(\'👽 👽 👽 \' + \'欢迎使用 rux, 轻松构建 react ts 项目～🎉🎉🎉\');\n      create();\n   });\n\n/* start project */\nprogram\n   .command(\'start\')\n   .description(\'start a project\')\n   .action(function() {\n      green(\'--------运行项目-------\');\n      start(\'start\').then(() => {\n         green(\'-------✅  ✅运行完成-------\');\n      });\n   });\n\nprogram.parse(process.argv);`, `25308232686517430000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">#<span class="token operator">!</span><span class="token operator">/</span>usr<span class="token operator">/</span>bin<span class="token operator">/</span>env node\n<span class="token keyword">const</span> program <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'commander\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> create <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'../src/create\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// const start = require("../src/start");</span>\n\n<span class="token keyword">const</span> <span class="token punctuation">{</span> green <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'../utils\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nprogram<span class="token punctuation">.</span><span class="token function">version</span><span class="token punctuation">(</span><span class="token string">\'1.0.0\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">/* create a project */</span>\nprogram\n   <span class="token punctuation">.</span><span class="token function">command</span><span class="token punctuation">(</span><span class="token string">\'create\'</span><span class="token punctuation">)</span>\n   <span class="token punctuation">.</span><span class="token function">description</span><span class="token punctuation">(</span><span class="token string">\'create a project \'</span><span class="token punctuation">)</span>\n   <span class="token punctuation">.</span><span class="token function">action</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token function">green</span><span class="token punctuation">(</span><span class="token string">\'👽 👽 👽 \'</span> <span class="token operator">+</span> <span class="token string">\'欢迎使用 rux, 轻松构建 react ts 项目～🎉🎉🎉\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">/* start project */</span>\nprogram\n   <span class="token punctuation">.</span><span class="token function">command</span><span class="token punctuation">(</span><span class="token string">\'start\'</span><span class="token punctuation">)</span>\n   <span class="token punctuation">.</span><span class="token function">description</span><span class="token punctuation">(</span><span class="token string">\'start a project\'</span><span class="token punctuation">)</span>\n   <span class="token punctuation">.</span><span class="token function">action</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token function">green</span><span class="token punctuation">(</span><span class="token string">\'--------运行项目-------\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token function">start</span><span class="token punctuation">(</span><span class="token string">\'start\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n         <span class="token function">green</span><span class="token punctuation">(</span><span class="token string">\'-------✅  ✅运行完成-------\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nprogram<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>argv<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>internals/generators/index.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="79654472665107840000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const shell = require(\'shelljs\');\nconst { spawn } = require(\'child_process\');\n\nconst packageGenerator = require(\'./package/index.js\');\n\nconst didSucceed = (code) => \\`\\${code}\\` === \'0\';\n\nfunction npmInstall(answers, config, plop) {\n   const path = plop.renderString(config.path, answers);\n   const spawnOptions = config.verbose\n      ? {\n           cwd: path,\n           shell: true,\n           stdio: \'inherit\'\n        }\n      : {\n           cwd: path\n        };\n\n   return new Promise((resolve, reject) => {\n      const npmI = spawn(\'npm\', [\'install\'], spawnOptions);\n\n      npmI.on(\'close\', (code) => {\n         if (didSucceed(code)) {\n            resolve(\\`npm install ran correctly\\`);\n         } else {\n            reject(\\`npm install exited with \\${code}\\`);\n         }\n      });\n   });\n}\n\nmodule.exports = (plop) => {\n   plop.setGenerator(\'package\', packageGenerator);\n   // plop.setGenerator(&quot;page&quot;, containerGenerator);\n   plop.setDefaultInclude({ actionTypes: true });\n   plop.setActionType(\'copy\', (answers, config, plop) => {\n      const src = plop.renderString(config.src, answers);\n      const dest = plop.renderString(config.dest, answers);\n      shell.cp(\'-r\', src, dest);\n   });\n   plop.setActionType(\'npmInstall\', npmInstall);\n};`, `79654472665107840000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> shell <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'shelljs\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> <span class="token punctuation">{</span> spawn <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'child_process\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> packageGenerator <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./package/index.js\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">didSucceed</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">code</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>code<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span> <span class="token operator">===</span> <span class="token string">\'0\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">function</span> <span class="token function">npmInstall</span><span class="token punctuation">(</span><span class="token parameter">answers<span class="token punctuation">,</span> config<span class="token punctuation">,</span> plop</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">const</span> path <span class="token operator">=</span> plop<span class="token punctuation">.</span><span class="token function">renderString</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>path<span class="token punctuation">,</span> answers<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">const</span> spawnOptions <span class="token operator">=</span> config<span class="token punctuation">.</span>verbose\n      <span class="token operator">?</span> <span class="token punctuation">{</span>\n           cwd<span class="token punctuation">:</span> path<span class="token punctuation">,</span>\n           shell<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n           stdio<span class="token punctuation">:</span> <span class="token string">\'inherit\'</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">:</span> <span class="token punctuation">{</span>\n           cwd<span class="token punctuation">:</span> path\n        <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n   <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> npmI <span class="token operator">=</span> <span class="token function">spawn</span><span class="token punctuation">(</span><span class="token string">\'npm\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">\'install\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> spawnOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      npmI<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'close\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">code</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">didSucceed</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">npm install ran correctly</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n            <span class="token function">reject</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">npm install exited with </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>code<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\nmodule<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">plop</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   plop<span class="token punctuation">.</span><span class="token function">setGenerator</span><span class="token punctuation">(</span><span class="token string">\'package\'</span><span class="token punctuation">,</span> packageGenerator<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token comment">// plop.setGenerator("page", containerGenerator);</span>\n   plop<span class="token punctuation">.</span><span class="token function">setDefaultInclude</span><span class="token punctuation">(</span><span class="token punctuation">{</span> actionTypes<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   plop<span class="token punctuation">.</span><span class="token function">setActionType</span><span class="token punctuation">(</span><span class="token string">\'copy\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">answers<span class="token punctuation">,</span> config<span class="token punctuation">,</span> plop</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> src <span class="token operator">=</span> plop<span class="token punctuation">.</span><span class="token function">renderString</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>src<span class="token punctuation">,</span> answers<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> dest <span class="token operator">=</span> plop<span class="token punctuation">.</span><span class="token function">renderString</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>dest<span class="token punctuation">,</span> answers<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      shell<span class="token punctuation">.</span><span class="token function">cp</span><span class="token punctuation">(</span><span class="token string">\'-r\'</span><span class="token punctuation">,</span> src<span class="token punctuation">,</span> dest<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   plop<span class="token punctuation">.</span><span class="token function">setActionType</span><span class="token punctuation">(</span><span class="token string">\'npmInstall\'</span><span class="token punctuation">,</span> npmInstall<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="项目级别的代码模板命令执行入口-1"><a href="#%E9%A1%B9%E7%9B%AE%E7%BA%A7%E5%88%AB%E7%9A%84%E4%BB%A3%E7%A0%81%E6%A8%A1%E6%9D%BF%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%85%A5%E5%8F%A3-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>项目级别的代码模板命令执行入口</h3>\n<p>相比一期增加 <code class="language-text">npm install</code> 逻辑</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="19400092607536300000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const directoryExists = require(\'../utils/directoryExists\');\nconst fileKeyExists = require(\'../utils/fileKeyExists\');\n\nconst portExists = (value) =>\n   fileKeyExists(\'config.js\', \'serverPort\', 3000, value) || fileKeyExists(\'config.js\', \'fePort\', 8888, value);\n\nmodule.exports = {\n   description: \'生成 package\',\n   prompts: [\n      {\n         type: \'input\',\n         name: \'name\',\n         message: \'package 叫什么名字？\',\n         default: \'demo\',\n         validate: (value) => {\n            if (/.+/.test(value)) {\n               return directoryExists(\'packages\', value) ? \'package 名字已存在\' : true;\n            }\n\n            return \'package 名字必填\';\n         }\n      },\n      {\n         type: \'input\',\n         name: \'serverPort\',\n         message: \'package 的 Node.js 服务端口？\',\n         default: \'8001\',\n         validate: (value) => {\n            if (/.+/.test(value)) {\n               return portExists(value) ? \'要设置 package 的 Node.js 服务端口已被占用\' : true;\n            }\n\n            return \'package 名字必填\';\n         }\n      },\n      {\n         type: \'input\',\n         name: \'fePort\',\n         message: \'package 的 webpack-dev-server 端口？\',\n         default: \'8002\',\n         validate: (value) => {\n            if (/.+/.test(value)) {\n               return portExists(value) ? \'要设置 package 的 webpack-dev-server 端口已被占用\' : true;\n            }\n\n            return \'package 名字必填\';\n         }\n      }\n   ],\n   actions: (data) => {\n      const actions = [\n         {\n            type: \'copy\',\n            src: \'internals/generators/package/template\',\n            dest: \'packages/{{ dashCase name }}\'\n         },\n         {\n            type: \'addMany\',\n            templateFiles: \'package/*.hbs\',\n            destination: \'../../packages/{{ dashCase name }}/\'\n         },\n         {\n            type: \'npmInstall\',\n            path: \\`packages/{{ dashCase name }}/\\`\n         }\n      ];\n\n      return actions;\n   }\n};`, `19400092607536300000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> directoryExists <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'../utils/directoryExists\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> fileKeyExists <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'../utils/fileKeyExists\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">portExists</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=></span>\n   <span class="token function">fileKeyExists</span><span class="token punctuation">(</span><span class="token string">\'config.js\'</span><span class="token punctuation">,</span> <span class="token string">\'serverPort\'</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">fileKeyExists</span><span class="token punctuation">(</span><span class="token string">\'config.js\'</span><span class="token punctuation">,</span> <span class="token string">\'fePort\'</span><span class="token punctuation">,</span> <span class="token number">8888</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nmodule<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>\n   description<span class="token punctuation">:</span> <span class="token string">\'生成 package\'</span><span class="token punctuation">,</span>\n   prompts<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n      <span class="token punctuation">{</span>\n         type<span class="token punctuation">:</span> <span class="token string">\'input\'</span><span class="token punctuation">,</span>\n         name<span class="token punctuation">:</span> <span class="token string">\'name\'</span><span class="token punctuation">,</span>\n         message<span class="token punctuation">:</span> <span class="token string">\'package 叫什么名字？\'</span><span class="token punctuation">,</span>\n         <span class="token keyword">default</span><span class="token punctuation">:</span> <span class="token string">\'demo\'</span><span class="token punctuation">,</span>\n         <span class="token function-variable function">validate</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex">/.+/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n               <span class="token keyword">return</span> <span class="token function">directoryExists</span><span class="token punctuation">(</span><span class="token string">\'packages\'</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">\'package 名字已存在\'</span> <span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span>\n\n            <span class="token keyword">return</span> <span class="token string">\'package 名字必填\'</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      <span class="token punctuation">{</span>\n         type<span class="token punctuation">:</span> <span class="token string">\'input\'</span><span class="token punctuation">,</span>\n         name<span class="token punctuation">:</span> <span class="token string">\'serverPort\'</span><span class="token punctuation">,</span>\n         message<span class="token punctuation">:</span> <span class="token string">\'package 的 Node.js 服务端口？\'</span><span class="token punctuation">,</span>\n         <span class="token keyword">default</span><span class="token punctuation">:</span> <span class="token string">\'8001\'</span><span class="token punctuation">,</span>\n         <span class="token function-variable function">validate</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex">/.+/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n               <span class="token keyword">return</span> <span class="token function">portExists</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">\'要设置 package 的 Node.js 服务端口已被占用\'</span> <span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span>\n\n            <span class="token keyword">return</span> <span class="token string">\'package 名字必填\'</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      <span class="token punctuation">{</span>\n         type<span class="token punctuation">:</span> <span class="token string">\'input\'</span><span class="token punctuation">,</span>\n         name<span class="token punctuation">:</span> <span class="token string">\'fePort\'</span><span class="token punctuation">,</span>\n         message<span class="token punctuation">:</span> <span class="token string">\'package 的 webpack-dev-server 端口？\'</span><span class="token punctuation">,</span>\n         <span class="token keyword">default</span><span class="token punctuation">:</span> <span class="token string">\'8002\'</span><span class="token punctuation">,</span>\n         <span class="token function-variable function">validate</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex">/.+/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n               <span class="token keyword">return</span> <span class="token function">portExists</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">\'要设置 package 的 webpack-dev-server 端口已被占用\'</span> <span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span>\n\n            <span class="token keyword">return</span> <span class="token string">\'package 名字必填\'</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">]</span><span class="token punctuation">,</span>\n   <span class="token function-variable function">actions</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> actions <span class="token operator">=</span> <span class="token punctuation">[</span>\n         <span class="token punctuation">{</span>\n            type<span class="token punctuation">:</span> <span class="token string">\'copy\'</span><span class="token punctuation">,</span>\n            src<span class="token punctuation">:</span> <span class="token string">\'internals/generators/package/template\'</span><span class="token punctuation">,</span>\n            dest<span class="token punctuation">:</span> <span class="token string">\'packages/{{ dashCase name }}\'</span>\n         <span class="token punctuation">}</span><span class="token punctuation">,</span>\n         <span class="token punctuation">{</span>\n            type<span class="token punctuation">:</span> <span class="token string">\'addMany\'</span><span class="token punctuation">,</span>\n            templateFiles<span class="token punctuation">:</span> <span class="token string">\'package/*.hbs\'</span><span class="token punctuation">,</span>\n            destination<span class="token punctuation">:</span> <span class="token string">\'../../packages/{{ dashCase name }}/\'</span>\n         <span class="token punctuation">}</span><span class="token punctuation">,</span>\n         <span class="token punctuation">{</span>\n            type<span class="token punctuation">:</span> <span class="token string">\'npmInstall\'</span><span class="token punctuation">,</span>\n            path<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">packages/{{ dashCase name }}/</span><span class="token template-punctuation string">`</span></span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">return</span> actions<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="运行结果-1"><a href="#%E8%BF%90%E8%A1%8C%E7%BB%93%E6%9E%9C-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>运行结果</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="74048772354843970000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ cli create\n👽 👽 👽 欢迎使用 rux, 轻松构建 react ts 项目～🎉🎉🎉\n? package 叫什么名字？ (demo) 项目路径/packages\n? package 叫什么名字？ demo\n? package 的 Node.js 服务端口？ 8001\n? package 的 webpack-dev-server 端口？ 8002\n✔  copy\n✔  +! 3 files added\n -> 项目路径/packages/demo/config.js\n -> 项目路径/packages/demo/package-lock.json\n -> 项目路径/packages/demo/package.json\n✔  npmInstall npm install ran correctly`, `74048772354843970000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ cli create\n👽 👽 👽 欢迎使用 rux, 轻松构建 react ts 项目～🎉🎉🎉\n? package 叫什么名字？ <span class="token punctuation">(</span>demo<span class="token punctuation">)</span> 项目路径/packages\n? package 叫什么名字？ demo\n? package 的 Node.js 服务端口？ <span class="token number">8001</span>\n? package 的 webpack-dev-server 端口？ <span class="token number">8002</span>\n✔  copy\n✔  +<span class="token operator">!</span> <span class="token number">3</span> files added\n -<span class="token operator">></span> 项目路径/packages/demo/config.js\n -<span class="token operator">></span> 项目路径/packages/demo/package-lock.json\n -<span class="token operator">></span> 项目路径/packages/demo/package.json\n✔  npmInstall <span class="token function">npm</span> <span class="token function">install</span> ran correctly</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>// TODO 代码生成脚手架还在完成中</p>',
id:"/home/runner/work/GatsbyBlog/GatsbyBlog/blog/代码生成脚手架搭建/index.md absPath of file >>> MarkdownRemark",timeToRead:10,frontmatter:{date:"2021-11-15 11:43:19",path:"/code-generation-scaffolding/",tags:"前端, 前端工程化, 预研",title:"代码生成脚手架搭建",draft:null}},{excerpt:"需求背景 基于公司的要求，需要对地图组件做出选型，以支持在地图上展示线路轨迹 技术选型 选型 优点 缺点 百度地图 大厂支持、UI 比较美观、API 文档较为清楚 内网搭建访问较为困难 高德地图 大厂支持、UI 比较美观、API 文档较为清楚 内网搭建访问较为困难 echarts 地图 UI 美观、API 文档较为清楚 内网搭建访问较为困难、功能较弱 天地图 支持离线访问、是专用地图 UI 不够美观、文档不够清楚 arcgis 支持离线访问、UI…",html:'<h1 id="需求背景"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h1>\n<p>基于公司的要求，需要对地图组件做出选型，以支持在地图上展示线路轨迹</p>\n<h1 id="技术选型"><a href="#%E6%8A%80%E6%9C%AF%E9%80%89%E5%9E%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>技术选型</h1>\n<table>\n<thead>\n<tr>\n<th align="center">选型</th>\n<th align="center">优点</th>\n<th align="center">缺点</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align="center">百度地图</td>\n<td align="center">大厂支持、UI 比较美观、API 文档较为清楚</td>\n<td align="center">内网搭建访问较为困难</td>\n</tr>\n<tr>\n<td align="center">高德地图</td>\n<td align="center">大厂支持、UI 比较美观、API 文档较为清楚</td>\n<td align="center">内网搭建访问较为困难</td>\n</tr>\n<tr>\n<td align="center">echarts 地图</td>\n<td align="center">UI 美观、API 文档较为清楚</td>\n<td align="center">内网搭建访问较为困难、功能较弱</td>\n</tr>\n<tr>\n<td align="center">天地图</td>\n<td align="center">支持离线访问、是专用地图</td>\n<td align="center">UI 不够美观、文档不够清楚</td>\n</tr>\n<tr>\n<td align="center">arcgis</td>\n<td align="center">支持离线访问、UI 上可做到切换不同图层</td>\n<td align="center">文档不够清楚</td>\n</tr>\n</tbody>\n</table>\n<p>最终由于是内网相关的项目，需要支持离线访问，同时那边所采用的地图组件也是 arcgis，所以最终采用 arcgis</p>\n<h1 id="前期准备"><a href="#%E5%89%8D%E6%9C%9F%E5%87%86%E5%A4%87" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>前期准备</h1>\n<h2 id="三方库本地化"><a href="#%E4%B8%89%E6%96%B9%E5%BA%93%E6%9C%AC%E5%9C%B0%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>三方库本地化</h2>\n<p>考虑到在内网离线运行，所以要对 arcgis 的 js 库进行本地化，大致经历了以下过程：</p>\n<h3 id="配合内网验证-demo-静态文件服务器"><a href="#%E9%85%8D%E5%90%88%E5%86%85%E7%BD%91%E9%AA%8C%E8%AF%81-demo-%E9%9D%99%E6%80%81%E6%96%87%E4%BB%B6%E6%9C%8D%E5%8A%A1%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>配合内网验证 demo 静态文件服务器</h3>\n<p>直接使用 nginx 或者 http-server 静态服务器，将 arcgis 脚本地址改为本地</p>\n<h3 id="静态文件服务器托管"><a href="#%E9%9D%99%E6%80%81%E6%96%87%E4%BB%B6%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%89%98%E7%AE%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>静态文件服务器托管</h3>\n<p>将 arcgis 三方库托管在静态文件服务器上，同时反代相关路径，这里的后端采用 koa 技术栈</p>\n<p>src\\server\\controllers\\stat-multi.controller.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="3427344901888584700"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 访问地址的 css 路径：/stat-multi/arcgis/esri/themes/light/main.css\n// 访问地址的 url 路径：/stat-multi/arcgis/init.js\nconst config = require(\'config\'); // 全局配置\nconst proxy = require(\'http-proxy-middleware\');\nconst c2k = require(\'koa2-connect\');\n\nfunction proxyArcgis(ctx, next) {\n  const proxyMiddleware = c2k(\n    proxy({\n      target: config.arcgisMapHost,\n      // 对 /stat-multi/arcgis 开头的 url 进行反代\n      pathRewrite: (path) => path.replace(\'/stat-multi/arcgis\', \'\'),\n      onProxyRes: (proxyRes) => {\n        console.log(\'proxyRes\', proxyRes);\n        // proxyRes.headers[\'Cache-Control\'] = \'private,max-stale=0,max-age=0\'\n      },\n      onProxyReq: (proxyReq) => {\n        console.log(\'proxyReq\', proxyReq);\n      }\n    })\n  );\n  return proxyMiddleware(ctx, next);\n}\n\nproxyArcgis();`, `3427344901888584700`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 访问地址的 css 路径：/stat-multi/arcgis/esri/themes/light/main.css</span>\n<span class="token comment">// 访问地址的 url 路径：/stat-multi/arcgis/init.js</span>\n<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'config\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 全局配置</span>\n<span class="token keyword">const</span> proxy <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'http-proxy-middleware\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> c2k <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'koa2-connect\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">function</span> <span class="token function">proxyArcgis</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> proxyMiddleware <span class="token operator">=</span> <span class="token function">c2k</span><span class="token punctuation">(</span>\n    <span class="token function">proxy</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n      target<span class="token punctuation">:</span> config<span class="token punctuation">.</span>arcgisMapHost<span class="token punctuation">,</span>\n      <span class="token comment">// 对 /stat-multi/arcgis 开头的 url 进行反代</span>\n      <span class="token function-variable function">pathRewrite</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token operator">=></span> path<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">\'/stat-multi/arcgis\'</span><span class="token punctuation">,</span> <span class="token string">\'\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n      <span class="token function-variable function">onProxyRes</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">proxyRes</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'proxyRes\'</span><span class="token punctuation">,</span> proxyRes<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token comment">// proxyRes.headers[\'Cache-Control\'] = \'private,max-stale=0,max-age=0\'</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      <span class="token function-variable function">onProxyReq</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">proxyReq</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'proxyReq\'</span><span class="token punctuation">,</span> proxyReq<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> <span class="token function">proxyMiddleware</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token function">proxyArcgis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="npm-私有库托管"><a href="#npm-%E7%A7%81%E6%9C%89%E5%BA%93%E6%89%98%E7%AE%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>npm 私有库托管</h3>\n<p>由于此三方库的静态文件服务器需要单独进行配置，略显繁琐，于是决定上传到公司 npm 私有库上，安装到后端对应的项目，并在后端以静态文件服务器的形式提供访问，这里后端采用 midway 技术栈</p>\n<p>server\\src\\config\\config.default.ts</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="57628001788098410000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 访问地址的 css 路径：/static-apps/mut/arcgis/esri/themes/light/main.css\n// 访问地址的 url 路径：/static-apps/mut/arcgis/init.js\n\nconfig.static = {\n  prefix: \'/static-apps/mut\',\n  dir: [\n    path.join(appInfo.baseDir, \'app/public\'),\n    {\n      prefix: \'/static-apps/mut/arcgis\',\n      dir: path.join(process.cwd(), \'node_modules/上传到 npm 私有库的三方库/dist\'),\n      maxAge: 60 * 10 // 缓存 10 分钟\n    }\n  ]\n};`, `57628001788098410000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 访问地址的 css 路径：/static-apps/mut/arcgis/esri/themes/light/main.css</span>\n<span class="token comment">// 访问地址的 url 路径：/static-apps/mut/arcgis/init.js</span>\n\nconfig<span class="token punctuation">.</span>static <span class="token operator">=</span> <span class="token punctuation">{</span>\n  prefix<span class="token punctuation">:</span> <span class="token string">\'/static-apps/mut\'</span><span class="token punctuation">,</span>\n  dir<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n    path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>appInfo<span class="token punctuation">.</span>baseDir<span class="token punctuation">,</span> <span class="token string">\'app/public\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token punctuation">{</span>\n      prefix<span class="token punctuation">:</span> <span class="token string">\'/static-apps/mut/arcgis\'</span><span class="token punctuation">,</span>\n      dir<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">\'node_modules/上传到 npm 私有库的三方库/dist\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n      maxAge<span class="token punctuation">:</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">10</span> <span class="token comment">// 缓存 10 分钟</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">]</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="内网图层验证"><a href="#%E5%86%85%E7%BD%91%E5%9B%BE%E5%B1%82%E9%AA%8C%E8%AF%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>内网图层验证</h2>\n<p>由于需要在内网离线运行，验证在内网 demo 是否能正常加载图层</p>\n<h3 id="react-arcgis"><a href="#react-arcgis" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>react-arcgis</h3>\n<p>首先确保没有多余的外网请求，在采用 <a href="https://github.com/Esri/react-arcgis" target="_blank" rel="nofollow noreferrer noopener">react-arcgis</a> 的过程中，发现无论采用什么图层也会加载 arcgis 的默认图层（在内网的情况下会阻塞内网图层的加载，同时也会对地图的加载速度造成影响），所以直接使用 <a href="https://github.com/Esri/esri-loader" target="_blank" rel="nofollow noreferrer noopener">esri-loader</a> 加载图层</p>\n<h3 id="esri-loader"><a href="#esri-loader" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>esri-loader</h3>\n<p>写出一个基本的 demo，在外网的情况下以天地图的图层进行访问，在内网以内部服务器返回的图层进行访问，在内网验证成功，未发现多余请求，主要验证代码如下：</p>\n<div>\n          <div\n            class="gatsby-resp-iframe-wrapper"\n            style="padding-bottom: 25%; position: relative; height: 0; overflow: hidden;margin-bottom: 2em"\n          >\n            <iframe src="/examples/arcgis-map-component-build-deploy/load-map-demo.html" style="\n            position: absolute;\n            top: 0;\n            left: 0;\n            width: 100%;\n            height: 100%;\n          "></iframe>\n          </div>\n          </div>\n<p><div class="gatsby-highlight">\n        <pre class="language-html"><code><span class="token doctype">&lt;!DOCTYPE html></span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span>\n  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>utf-8<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span>\n      <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span>\n      <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>initial-scale=1,maximum-scale=1,user-scalable=no<span class="token punctuation">"</span></span>\n    <span class="token punctuation">/></span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>\n      Intro to MapView - Create a 2D map | Sample | ArcGIS API for JavaScript\n      4.18\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">></span></span><span class="token style"><span class="token language-css">\n      <span class="token selector">html,\n      body,\n      #viewDiv</span> <span class="token punctuation">{</span>\n        <span class="token property">padding</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>\n        <span class="token property">margin</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>\n        <span class="token property">height</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>\n        <span class="token property">width</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span>\n\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://js.arcgis.com/4.16/<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>\n\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">\n      <span class="token function">require</span><span class="token punctuation">(</span><span class="token punctuation">[</span>\n        <span class="token string">"esri/Map"</span><span class="token punctuation">,</span>\n        <span class="token string">"esri/views/MapView"</span><span class="token punctuation">,</span>\n        <span class="token string">"esri/layers/WebTileLayer"</span>\n      <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">Map<span class="token punctuation">,</span> MapView<span class="token punctuation">,</span> WebTileLayer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token comment">// 天地图加载图层，这里可以替换为内网服务器的图层</span>\n        <span class="token comment">// mapLayerUrlTemplate: 矢量底图经纬度投影</span>\n        <span class="token comment">// markerLayerUrlTemplate: 矢量注记经纬度投影</span>\n        <span class="token comment">// subDomains: 占位符</span>\n        <span class="token keyword">const</span> mapLayerUrlTemplate <span class="token operator">=</span> <span class="token string">\'http://{subDomain}.tianditu.gov.cn/vec_w/wmts?SERVICE=WMTS&amp;REQUEST=GetTile&amp;VERSION=1.0.0&amp;LAYER=vec&amp;STYLE=default&amp;TILEMATRIXSET=w&amp;FORMAT=tiles&amp;TILEMATRIX={level}&amp;TILEROW={row}&amp;TILECOL={col}&amp;tk=f73eace6fbf7a640861984ea1b3ffa07\'</span>\n        <span class="token keyword">const</span> markerLayerUrlTemplate <span class="token operator">=</span> <span class="token string">\'http://{subDomain}.tianditu.gov.cn/cva_w/wmts?SERVICE=WMTS&amp;REQUEST=GetTile&amp;VERSION=1.0.0&amp;LAYER=cva&amp;STYLE=default&amp;TILEMATRIXSET=w&amp;FORMAT=tiles&amp;TILEMATRIX={level}&amp;TILEROW={row}&amp;TILECOL={col}&amp;tk=f73eace6fbf7a640861984ea1b3ffa07\'</span>\n        <span class="token keyword">const</span> subDomains <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'t0\'</span><span class="token punctuation">,</span> <span class="token string">\'t1\'</span><span class="token punctuation">,</span> <span class="token string">\'t2\'</span><span class="token punctuation">,</span> <span class="token string">\'t3\'</span><span class="token punctuation">,</span> <span class="token string">\'t4\'</span><span class="token punctuation">,</span> <span class="token string">\'t5\'</span><span class="token punctuation">,</span> <span class="token string">\'t6\'</span><span class="token punctuation">,</span> <span class="token string">\'t7\'</span><span class="token punctuation">]</span>\n\n        <span class="token keyword">const</span> mapLayer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebTileLayer</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n          urlTemplate<span class="token punctuation">:</span> mapLayerUrlTemplate<span class="token punctuation">,</span>\n          subDomains\n        <span class="token punctuation">}</span><span class="token punctuation">)</span>\n        <span class="token keyword">const</span> markerLayer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebTileLayer</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n          urlTemplate<span class="token punctuation">:</span> markerLayerUrlTemplate<span class="token punctuation">,</span>\n          subDomains\n        <span class="token punctuation">}</span><span class="token punctuation">)</span>\n\n        <span class="token keyword">const</span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n          layers<span class="token punctuation">:</span> <span class="token punctuation">[</span>mapLayer<span class="token punctuation">,</span> markerLayer<span class="token punctuation">]</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        <span class="token keyword">const</span> view <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MapView</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n          container<span class="token punctuation">:</span> <span class="token string">"viewDiv"</span><span class="token punctuation">,</span>\n          map<span class="token punctuation">,</span>\n          zoom<span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>\n          center<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">110</span><span class="token punctuation">,</span> <span class="token number">38</span><span class="token punctuation">]</span> <span class="token comment">// longitude, latitude</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        view<span class="token punctuation">.</span><span class="token function">when</span><span class="token punctuation">(</span>\n          <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'地图加载完成\'</span><span class="token punctuation">)</span>\n          <span class="token punctuation">}</span><span class="token punctuation">,</span>\n          <span class="token parameter">error</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'地图加载失败\'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span>\n          <span class="token punctuation">}</span>\n        <span class="token punctuation">)</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>\n  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>\n\n  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>viewDiv<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>\n  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre>\n        </div></p>\n<h2 id="经纬度修复"><a href="#%E7%BB%8F%E7%BA%AC%E5%BA%A6%E4%BF%AE%E5%A4%8D" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>经纬度修复</h2>\n<p>在地图上加载公司数据组给的数据时，发现有很多地点对应的经纬度有偏差，需要对数据组的经纬度数据修复</p>\n<h3 id="外网天地图修复脚本"><a href="#%E5%A4%96%E7%BD%91%E5%A4%A9%E5%9C%B0%E5%9B%BE%E4%BF%AE%E5%A4%8D%E8%84%9A%E6%9C%AC" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>外网天地图修复脚本</h3>\n<p>核心逻辑：</p>\n<ol>\n<li>申请天地图服务器端的 key，确保根据地点获取地点详情接口请求成功</li>\n<li>考虑到天地图开放 API 可能有频率限制，采用串行逻辑请求接口</li>\n<li>更新数据库时采用增量更新的方式，即需要判断写入的 lat 或 lon 字段是否已写入，每次查出未写入的再进行更新</li>\n</ol>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="90921495347539640000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const request = require(\'request\');\nconst lodash = require(\'lodash\');\nconst ProgressBar = require(\'progress\');\n\nconst { sequelize } = require(\'./sequelize.js\');\nconst { targetTable } = require(\'./config.js\');\n\n// curl --connect-timeout 999999 -m 999999 \'http://localhost:8000/stat-multi/train-analysis/get-all-station-info?isUseTianDiTuApi=1&isUpdateDatabase=1&pageSize=1000\'\n// http://api.tianditu.gov.cn/geocoder?ds={&quot;keyWord&quot;:&quot;弯坵火车站&quot;}&tk=f73eace6fbf7a640861984ea1b3ffa07\nasync function updateGps(params = {}) {\n  const { isUseTianDiTuApi, isUpdateDatabase, pageSize = 10, current = 1 } = params;\n  const offset = (current - 1) * pageSize;\n  const sql = \\`select * from \\${targetTable} where lat is null or lon is null order by zmdm limit \\${pageSize} offset \\${offset}\\`;\n  const rsp = await sequelize.query(sql, {\n    type: sequelize.QueryTypes.SELECT\n  });\n  function getTianDiTuInfo(keyword) {\n    const tianDiTuApiUrl = \'http://api.tianditu.gov.cn\';\n    const token = \'ab61c4d11eab1728b7f6ff48639bc73e\';\n    return new Promise((resolve, reject) => {\n      request(\n        {\n          method: \'GET\',\n          url: encodeURI(\\`\\${tianDiTuApiUrl}/geocoder?ds={&quot;keyWord&quot;:&quot;\\${keyword}&quot;}&tk=\\${token}\\`),\n          timeout: 10000\n        },\n        (error, response) => {\n          if (error) {\n            reject(error);\n          } else {\n            resolve(response.body);\n          }\n        }\n      );\n    });\n  }\n\n  async function getListByKeyword() {\n    const list = [];\n    const bar = new ProgressBar(\'更新中 [:bar] :rate/bps :percent :etas\', { total: rsp.length });\n    for (const item of rsp) {\n      const rsp2 = await getTianDiTuInfo(\\`\\${item.zm}火车站\\`);\n      const response = JSON.parse(rsp2);\n      const lon = lodash.get(response, \'location.lon\');\n      const lat = lodash.get(response, \'location.lat\');\n      if (isUpdateDatabase) {\n        const sql = \\`update \\${targetTable} set lat=\'\\${lat}\', lon=\'\\${lon}\' where zmdm=\'\\${item.zmdm}\'\\`;\n        const rsp3 = await sequelize.query(sql, {\n          type: sequelize.QueryTypes.UPDATE\n        });\n        bar.tick();\n        // console.log(rsp3)\n      }\n      list.push({\n        ...item,\n        lon,\n        lat\n      });\n    }\n    if (bar.complete) {\n      console.log(\'\\n刷新数据库完成\\n\');\n    }\n    return list;\n  }\n\n  if (isUseTianDiTuApi) {\n    return getListByKeyword();\n  }\n  return rsp;\n}\n\nupdateGps({\n  isUseTianDiTuApi: true, // 是否使用天地图 API 获取经纬度\n  isUpdateDatabase: true, // 是否更新数据库\n  current: 1, // 当前页\n  pageSize: 100 // 第几页\n}).then((rsp) => {\n  console.log(\\`\\${rsp.length} 个数据更新成功\\`);\n  process.exit(0);\n});`, `90921495347539640000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> request <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'request\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> lodash <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'lodash\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> ProgressBar <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'progress\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token punctuation">{</span> sequelize <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./sequelize.js\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> <span class="token punctuation">{</span> targetTable <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./config.js\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// curl --connect-timeout 999999 -m 999999 \'http://localhost:8000/stat-multi/train-analysis/get-all-station-info?isUseTianDiTuApi=1&amp;isUpdateDatabase=1&amp;pageSize=1000\'</span>\n<span class="token comment">// http://api.tianditu.gov.cn/geocoder?ds={"keyWord":"弯坵火车站"}&amp;tk=f73eace6fbf7a640861984ea1b3ffa07</span>\n<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">updateGps</span><span class="token punctuation">(</span><span class="token parameter">params <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> isUseTianDiTuApi<span class="token punctuation">,</span> isUpdateDatabase<span class="token punctuation">,</span> pageSize <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">,</span> current <span class="token operator">=</span> <span class="token number">1</span> <span class="token punctuation">}</span> <span class="token operator">=</span> params<span class="token punctuation">;</span>\n  <span class="token keyword">const</span> offset <span class="token operator">=</span> <span class="token punctuation">(</span>current <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> pageSize<span class="token punctuation">;</span>\n  <span class="token keyword">const</span> sql <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">select * from </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>targetTable<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> where lat is null or lon is null order by zmdm limit </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>pageSize<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> offset </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>offset<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> rsp <span class="token operator">=</span> <span class="token keyword">await</span> sequelize<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n    type<span class="token punctuation">:</span> sequelize<span class="token punctuation">.</span>QueryTypes<span class="token punctuation">.</span><span class="token constant">SELECT</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">function</span> <span class="token function">getTianDiTuInfo</span><span class="token punctuation">(</span><span class="token parameter">keyword</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> tianDiTuApiUrl <span class="token operator">=</span> <span class="token string">\'http://api.tianditu.gov.cn\'</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> token <span class="token operator">=</span> <span class="token string">\'ab61c4d11eab1728b7f6ff48639bc73e\'</span><span class="token punctuation">;</span>\n    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token function">request</span><span class="token punctuation">(</span>\n        <span class="token punctuation">{</span>\n          method<span class="token punctuation">:</span> <span class="token string">\'GET\'</span><span class="token punctuation">,</span>\n          url<span class="token punctuation">:</span> <span class="token function">encodeURI</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>tianDiTuApiUrl<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/geocoder?ds={"keyWord":"</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>keyword<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"}&amp;tk=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>token<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n          timeout<span class="token punctuation">:</span> <span class="token number">10000</span>\n        <span class="token punctuation">}</span><span class="token punctuation">,</span>\n        <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n          <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n            <span class="token function">resolve</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getListByKeyword</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> bar <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProgressBar</span><span class="token punctuation">(</span><span class="token string">\'更新中 [:bar] :rate/bps :percent :etas\'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> total<span class="token punctuation">:</span> rsp<span class="token punctuation">.</span>length <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> item <span class="token keyword">of</span> rsp<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> rsp2 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getTianDiTuInfo</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>item<span class="token punctuation">.</span>zm<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">火车站</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>rsp2<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> lon <span class="token operator">=</span> lodash<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> <span class="token string">\'location.lon\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> lat <span class="token operator">=</span> lodash<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> <span class="token string">\'location.lat\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>isUpdateDatabase<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">const</span> sql <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">update </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>targetTable<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> set lat=\'</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>lat<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\', lon=\'</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>lon<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\' where zmdm=\'</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>item<span class="token punctuation">.</span>zmdm<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\'</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n        <span class="token keyword">const</span> rsp3 <span class="token operator">=</span> <span class="token keyword">await</span> sequelize<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n          type<span class="token punctuation">:</span> sequelize<span class="token punctuation">.</span>QueryTypes<span class="token punctuation">.</span><span class="token constant">UPDATE</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        bar<span class="token punctuation">.</span><span class="token function">tick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token comment">// console.log(rsp3)</span>\n      <span class="token punctuation">}</span>\n      list<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n        <span class="token operator">...</span>item<span class="token punctuation">,</span>\n        lon<span class="token punctuation">,</span>\n        lat\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>bar<span class="token punctuation">.</span>complete<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'\\n刷新数据库完成\\n\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">return</span> list<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>isUseTianDiTuApi<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token function">getListByKeyword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">return</span> rsp<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token function">updateGps</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n  isUseTianDiTuApi<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 是否使用天地图 API 获取经纬度</span>\n  isUpdateDatabase<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 是否更新数据库</span>\n  current<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// 当前页</span>\n  pageSize<span class="token punctuation">:</span> <span class="token number">100</span> <span class="token comment">// 第几页</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">rsp</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>rsp<span class="token punctuation">.</span>length<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 个数据更新成功</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="内网修复脚本"><a href="#%E5%86%85%E7%BD%91%E4%BF%AE%E5%A4%8D%E8%84%9A%E6%9C%AC" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>内网修复脚本</h3>\n<p>在以上的版本上，核心逻辑多了以下功能：</p>\n<ol>\n<li>内网接口返回的经纬度单位是转换墨卡托投影单位，需要用 gcoord 三方库做转换</li>\n<li>get 参数处理</li>\n<li>增加成功、失败总数统计</li>\n</ol>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="98246331836733330000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const request = require(\'request\');\nconst lodash = require(\'lodash\');\nconst ProgressBar = require(\'progress\');\nconst gcoord = require(\'gcoord\');\n\n// const result = gcoord.transform(\n//   [12580093.358100001, 3273944.1777000017],    // 经纬度坐标\n//   gcoord.WebMercator,               // 当前坐标系\n//   gcoord.WGS84                 // 目标坐标系\n// );\n\n// console.log(result)\n\nconst { sequelize } = require(\'./sequelize.js\');\nconst { targetTable } = require(\'./config.js\');\nconst { withExtraQuery } = require(\'./utils\');\n\nfunction getInfoByZm(searchText) {\n  // const apiUrl = \'http://api.tianditu.gov.cn/geocoder\'\n  // const token = \'ab61c4d11eab1728b7f6ff48639bc73e\'\n  // const url = encodeURI(\\`\\${apiUrl}/geocoder?ds={&quot;keyWord&quot;:&quot;\\${searchText}&quot;}&tk=\\${token}\\`)\n\n  const apiUrl = \'http://10.160.9.49:8080/OneMapServer/rest/services/SEARCH_QGCZ/Transfer/find\';\n  const params = {\n    f: \'json\',\n    searchText,\n    contains: false,\n    layers: \'0\',\n    searchFields: \'name,label\'\n  };\n  const url = withExtraQuery(apiUrl, params);\n  // console.log(url)\n  return new Promise((resolve, reject) => {\n    request(\n      {\n        method: \'GET\',\n        url,\n        timeout: 10000\n      },\n      (error, response) => {\n        if (error) {\n          reject(error);\n        } else {\n          resolve(response.body);\n        }\n      }\n    );\n  });\n}\n\nasync function updateList(rsp, isUpdate) {\n  const list = [];\n  const bar = new ProgressBar(\'更新中 [:bar] :rate/bps :percent :etas 第 :current 个 总共 :total 个\', {\n    total: rsp.length\n  });\n  let successTotal = 0;\n  let failTotal = 0;\n  for (const item of rsp) {\n    try {\n      const rsp2 = await getInfoByZm(item.zm.trim());\n\n      const response = JSON.parse(rsp2);\n      // 墨卡托投影单位，需要做转换\n      const x = lodash.get(response, \'results[0].geometry.x\');\n      const y = lodash.get(response, \'results[0].geometry.y\');\n\n      let lon = x;\n      let lat = y;\n      if (x && y) {\n        const result = gcoord.transform(\n          [x, y], // 坐标\n          gcoord.WebMercator, // 当前坐标系\n          gcoord.WGS84 // 目标坐标系\n        );\n        lon = result[0];\n        lat = result[1];\n      }\n\n      // const lon = lodash.get(response, \'location.lon\')\n      // const lat = lodash.get(response, \'location.lat\')\n\n      if (isUpdate) {\n        const sql = \\`update \\${targetTable} set lat=\'\\${lat}\', lon=\'\\${lon}\' where zmdm=\'\\${item.zmdm}\'\\`;\n        const rsp3 = await sequelize.query(sql, {\n          type: sequelize.QueryTypes.UPDATE\n        });\n        successTotal += 1;\n        bar.tick();\n      }\n      list.push({\n        ...item,\n        lon,\n        lat\n      });\n    } catch (error) {\n      console.log(error);\n      if (isUpdate) {\n        bar.tick();\n        failTotal += 1;\n      }\n    }\n  }\n  if (bar.complete) {\n    console.log(\\`\\${successTotal} 个数据更新成功，\\${failTotal} 个数据更新失败\\`);\n  }\n  return list;\n}\n\n// isUseApi: 是否使用 api 查询地理坐标\n// isUpdate: 是否同步到数据库\nasync function getGps(params = {}) {\n  const { isUseApi, isUpdate, pageSize, current } = params;\n  const offset = (current - 1) * pageSize;\n  const sql = \\`select * from \\${targetTable} where lat is null or lon is null order by zmdm limit \\${pageSize} offset \\${offset}\\`;\n  const rsp = await sequelize.query(sql, {\n    type: sequelize.QueryTypes.SELECT\n  });\n\n  if (isUseApi) {\n    return updateList(rsp, isUpdate);\n  }\n  return rsp;\n}\n\ngetGps({\n  isUseApi: true,\n  isUpdate: true,\n  current: 1,\n  pageSize: 1000\n}).then((rsp) => {\n  // console.log(rsp)\n  process.exit(0);\n});`, `98246331836733330000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> request <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'request\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> lodash <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'lodash\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> ProgressBar <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'progress\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> gcoord <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'gcoord\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// const result = gcoord.transform(</span>\n<span class="token comment">//   [12580093.358100001, 3273944.1777000017],    // 经纬度坐标</span>\n<span class="token comment">//   gcoord.WebMercator,               // 当前坐标系</span>\n<span class="token comment">//   gcoord.WGS84                 // 目标坐标系</span>\n<span class="token comment">// );</span>\n\n<span class="token comment">// console.log(result)</span>\n\n<span class="token keyword">const</span> <span class="token punctuation">{</span> sequelize <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./sequelize.js\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> <span class="token punctuation">{</span> targetTable <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./config.js\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> <span class="token punctuation">{</span> withExtraQuery <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./utils\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">function</span> <span class="token function">getInfoByZm</span><span class="token punctuation">(</span><span class="token parameter">searchText</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// const apiUrl = \'http://api.tianditu.gov.cn/geocoder\'</span>\n  <span class="token comment">// const token = \'ab61c4d11eab1728b7f6ff48639bc73e\'</span>\n  <span class="token comment">// const url = encodeURI(`${apiUrl}/geocoder?ds={"keyWord":"${searchText}"}&amp;tk=${token}`)</span>\n\n  <span class="token keyword">const</span> apiUrl <span class="token operator">=</span> <span class="token string">\'http://10.160.9.49:8080/OneMapServer/rest/services/SEARCH_QGCZ/Transfer/find\'</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> params <span class="token operator">=</span> <span class="token punctuation">{</span>\n    f<span class="token punctuation">:</span> <span class="token string">\'json\'</span><span class="token punctuation">,</span>\n    searchText<span class="token punctuation">,</span>\n    contains<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n    layers<span class="token punctuation">:</span> <span class="token string">\'0\'</span><span class="token punctuation">,</span>\n    searchFields<span class="token punctuation">:</span> <span class="token string">\'name,label\'</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token function">withExtraQuery</span><span class="token punctuation">(</span>apiUrl<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// console.log(url)</span>\n  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token function">request</span><span class="token punctuation">(</span>\n      <span class="token punctuation">{</span>\n        method<span class="token punctuation">:</span> <span class="token string">\'GET\'</span><span class="token punctuation">,</span>\n        url<span class="token punctuation">,</span>\n        timeout<span class="token punctuation">:</span> <span class="token number">10000</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n          <span class="token function">resolve</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">updateList</span><span class="token punctuation">(</span><span class="token parameter">rsp<span class="token punctuation">,</span> isUpdate</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> bar <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProgressBar</span><span class="token punctuation">(</span><span class="token string">\'更新中 [:bar] :rate/bps :percent :etas 第 :current 个 总共 :total 个\'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>\n    total<span class="token punctuation">:</span> rsp<span class="token punctuation">.</span>length\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">let</span> successTotal <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n  <span class="token keyword">let</span> failTotal <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> item <span class="token keyword">of</span> rsp<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">try</span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> rsp2 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getInfoByZm</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>zm<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>rsp2<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token comment">// 墨卡托投影单位，需要做转换</span>\n      <span class="token keyword">const</span> x <span class="token operator">=</span> lodash<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> <span class="token string">\'results[0].geometry.x\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> y <span class="token operator">=</span> lodash<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> <span class="token string">\'results[0].geometry.y\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">let</span> lon <span class="token operator">=</span> x<span class="token punctuation">;</span>\n      <span class="token keyword">let</span> lat <span class="token operator">=</span> y<span class="token punctuation">;</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">&amp;&amp;</span> y<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">const</span> result <span class="token operator">=</span> gcoord<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>\n          <span class="token punctuation">[</span>x<span class="token punctuation">,</span> y<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 坐标</span>\n          gcoord<span class="token punctuation">.</span>WebMercator<span class="token punctuation">,</span> <span class="token comment">// 当前坐标系</span>\n          gcoord<span class="token punctuation">.</span><span class="token constant">WGS84</span> <span class="token comment">// 目标坐标系</span>\n        <span class="token punctuation">)</span><span class="token punctuation">;</span>\n        lon <span class="token operator">=</span> result<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n        lat <span class="token operator">=</span> result<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token comment">// const lon = lodash.get(response, \'location.lon\')</span>\n      <span class="token comment">// const lat = lodash.get(response, \'location.lat\')</span>\n\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>isUpdate<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">const</span> sql <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">update </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>targetTable<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> set lat=\'</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>lat<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\', lon=\'</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>lon<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\' where zmdm=\'</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>item<span class="token punctuation">.</span>zmdm<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\'</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n        <span class="token keyword">const</span> rsp3 <span class="token operator">=</span> <span class="token keyword">await</span> sequelize<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n          type<span class="token punctuation">:</span> sequelize<span class="token punctuation">.</span>QueryTypes<span class="token punctuation">.</span><span class="token constant">UPDATE</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        successTotal <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>\n        bar<span class="token punctuation">.</span><span class="token function">tick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      list<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n        <span class="token operator">...</span>item<span class="token punctuation">,</span>\n        lon<span class="token punctuation">,</span>\n        lat\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>isUpdate<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        bar<span class="token punctuation">.</span><span class="token function">tick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        failTotal <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>bar<span class="token punctuation">.</span>complete<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>successTotal<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 个数据更新成功，</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>failTotal<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 个数据更新失败</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">return</span> list<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// isUseApi: 是否使用 api 查询地理坐标</span>\n<span class="token comment">// isUpdate: 是否同步到数据库</span>\n<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getGps</span><span class="token punctuation">(</span><span class="token parameter">params <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> isUseApi<span class="token punctuation">,</span> isUpdate<span class="token punctuation">,</span> pageSize<span class="token punctuation">,</span> current <span class="token punctuation">}</span> <span class="token operator">=</span> params<span class="token punctuation">;</span>\n  <span class="token keyword">const</span> offset <span class="token operator">=</span> <span class="token punctuation">(</span>current <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> pageSize<span class="token punctuation">;</span>\n  <span class="token keyword">const</span> sql <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">select * from </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>targetTable<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> where lat is null or lon is null order by zmdm limit </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>pageSize<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> offset </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>offset<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> rsp <span class="token operator">=</span> <span class="token keyword">await</span> sequelize<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n    type<span class="token punctuation">:</span> sequelize<span class="token punctuation">.</span>QueryTypes<span class="token punctuation">.</span><span class="token constant">SELECT</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>isUseApi<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token function">updateList</span><span class="token punctuation">(</span>rsp<span class="token punctuation">,</span> isUpdate<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">return</span> rsp<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token function">getGps</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n  isUseApi<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n  isUpdate<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n  current<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>\n  pageSize<span class="token punctuation">:</span> <span class="token number">1000</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">rsp</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token comment">// console.log(rsp)</span>\n  process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>内网执行脚本刷新结果：共 <code class="language-text">8493</code> 条数据，<code class="language-text">2038</code> 条查不出结果(部分原因是命名不规范或者不存在这个站)，<code class="language-text">6455</code> 条查出经纬度并完成入库</p>\n<h3 id="脚本执行线程池化"><a href="#%E8%84%9A%E6%9C%AC%E6%89%A7%E8%A1%8C%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>脚本执行线程池化</h3>\n<p>在以上的版本上，利用线程池的概念优化取数逻辑</p>\n<ol>\n<li>请求接口线程池化</li>\n<li>数据库数据更新线程池化</li>\n<li>数据库批量更新数据</li>\n</ol>\n<h4 id="带有并发数限制的异步任务"><a href="#%E5%B8%A6%E6%9C%89%E5%B9%B6%E5%8F%91%E6%95%B0%E9%99%90%E5%88%B6%E7%9A%84%E5%BC%82%E6%AD%A5%E4%BB%BB%E5%8A%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>带有并发数限制的异步任务</h4>\n<p>concurrentRun.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="20948514835409072000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`/**\n * 执行多个异步任务\n * @param {*} fnList 任务列表\n * @param {*} max 最大并发数限制\n * @param {*} taskName 任务名称\n */\nmodule.exports = async function concurrentRun(fnList = [], max = 5, taskName = \'未命名\') {\n  if (!fnList.length) return;\n\n  console.log(\\`开始执行多个异步任务，最大并发数： \\${max}\\`);\n  const replyList = []; // 收集任务执行结果\n  const count = fnList.length; // 总任务数量\n  const startTime = new Date().getTime(); // 记录任务执行开始时间\n\n  let current = 0;\n  // 任务执行程序\n  const schedule = async (index) => {\n    return new Promise(async (resolve) => {\n      try {\n        const fn = fnList[index];\n        if (!fn) return resolve();\n\n        // 执行当前异步任务\n        const reply = await fn();\n        replyList[index] = reply;\n      } catch (e) {\n        console.log(e);\n        // 报错了不管继续下一个\n        resolve();\n      }\n\n      current++;\n      console.log(\n        \\`\\${taskName} 事务进度，第 \\${current} 个，共 \\${count} 个，进度为 \\${((current / count) * 100).toFixed(2)}% \\`\n      );\n\n      // 执行完当前任务后，继续执行任务池的剩余任务\n      await schedule(index + max);\n      resolve();\n    });\n  };\n\n  // 任务池执行程序\n  const scheduleList = new Array(max).fill(0).map((_, index) => schedule(index));\n  // 使用 Promise.all 批量执行\n  const r = await Promise.all(scheduleList);\n\n  const cost = (new Date().getTime() - startTime) / 1000;\n  console.log(\\`执行完成，最大并发数： \\${max}，耗时：\\${cost}s\\`);\n  return replyList;\n};`, `20948514835409072000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">/**\n * 执行多个异步任务\n * @param {*} fnList 任务列表\n * @param {*} max 最大并发数限制\n * @param {*} taskName 任务名称\n */</span>\nmodule<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">concurrentRun</span><span class="token punctuation">(</span>fnList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> max <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span> taskName <span class="token operator">=</span> <span class="token string">\'未命名\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fnList<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>\n\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">开始执行多个异步任务，最大并发数： </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>max<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> replyList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 收集任务执行结果</span>\n  <span class="token keyword">const</span> count <span class="token operator">=</span> fnList<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token comment">// 总任务数量</span>\n  <span class="token keyword">const</span> startTime <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 记录任务执行开始时间</span>\n\n  <span class="token keyword">let</span> current <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n  <span class="token comment">// 任务执行程序</span>\n  <span class="token keyword">const</span> <span class="token function-variable function">schedule</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">index</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">try</span> <span class="token punctuation">{</span>\n        <span class="token keyword">const</span> fn <span class="token operator">=</span> fnList<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fn<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        <span class="token comment">// 执行当前异步任务</span>\n        <span class="token keyword">const</span> reply <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        replyList<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> reply<span class="token punctuation">;</span>\n      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token comment">// 报错了不管继续下一个</span>\n        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n\n      current<span class="token operator">++</span><span class="token punctuation">;</span>\n      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>\n        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>taskName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 事务进度，第 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>current<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 个，共 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>count<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 个，进度为 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token punctuation">(</span><span class="token punctuation">(</span>current <span class="token operator">/</span> count<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toFixed</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">% </span><span class="token template-punctuation string">`</span></span>\n      <span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token comment">// 执行完当前任务后，继续执行任务池的剩余任务</span>\n      <span class="token keyword">await</span> <span class="token function">schedule</span><span class="token punctuation">(</span>index <span class="token operator">+</span> max<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 任务池执行程序</span>\n  <span class="token keyword">const</span> scheduleList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">(</span>max<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">_<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">schedule</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// 使用 Promise.all 批量执行</span>\n  <span class="token keyword">const</span> r <span class="token operator">=</span> <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>scheduleList<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> cost <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startTime<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">;</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">执行完成，最大并发数： </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>max<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">，耗时：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>cost<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">s</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> replyList<span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="请求接口并发执行数据更新并发执行"><a href="#%E8%AF%B7%E6%B1%82%E6%8E%A5%E5%8F%A3%E5%B9%B6%E5%8F%91%E6%89%A7%E8%A1%8C%E6%95%B0%E6%8D%AE%E6%9B%B4%E6%96%B0%E5%B9%B6%E5%8F%91%E6%89%A7%E8%A1%8C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>请求接口并发执行/数据更新并发执行</h4>\n<p>index.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="20642137204292490000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const request = require(\'request\');\nconst lodash = require(\'lodash\');\n\nconst { sequelize } = require(\'./sequelize.js\');\nconst { targetTable } = require(\'./config.js\');\nconst concurrentRun = require(\'./concurrentRun.js\');\n\nfunction getInfoByZm(keyword) {\n  const tianDiTuApiUrl = \'http://api.tianditu.gov.cn\';\n  const token = \'ab61c4d11eab1728b7f6ff48639bc73e\';\n  return new Promise((resolve, reject) => {\n    request(\n      {\n        method: \'GET\',\n        url: encodeURI(\\`\\${tianDiTuApiUrl}/geocoder?ds={&quot;keyWord&quot;:&quot;\\${keyword}&quot;}&tk=\\${token}\\`),\n        timeout: 10000\n      },\n      (error, response) => {\n        if (error) {\n          reject(error);\n        } else {\n          resolve(response.body);\n        }\n      }\n    );\n  });\n}\n\nasync function updateDataBase(rsp) {\n  const zmdms = [];\n  const lons = [];\n  const lats = [];\n  rsp.forEach((item) => {\n    const lon = lodash.get(item.response, \'location.lon\');\n    const lat = lodash.get(item.response, \'location.lat\');\n    zmdms.push(\\`\'\\${item.zmdm}\'\\`);\n    lons.push(\\`when \'\\${item.zmdm}\' then \'\\${lon}\'\\`);\n    lats.push(\\`when \'\\${item.zmdm}\' then \'\\${lat}\'\\`);\n  });\n\n  const sql = \\`\n    update \\${targetTable} set\n    lon = case zmdm \\${lons.join(\' \')} end,\n    lat = case zmdm \\${lats.join(\' \')} end\n    where zmdm in (\\${zmdms.join(\',\')})\n  \\`;\n\n  const rsp3 = await sequelize.query(sql, {\n    type: sequelize.QueryTypes.UPDATE\n  });\n}\n\nasync function updateList(rsp, isUpdate) {\n  const requestFnList = rsp.map((item) => () => getInfoByZm(\\`\\${item.zm.trim()}火车站\\`));\n\n  const list = await concurrentRun(requestFnList, 100, \'请求天地图\');\n\n  const result = rsp.map((item, index) => {\n    try {\n      return {\n        ...item,\n        response: JSON.parse(list[index])\n      };\n    } catch (e) {\n      return item;\n    }\n  });\n\n  if (isUpdate) {\n    // 每 100 个分隔成一组\n    const updateFnList = lodash.chunk(result, 100).map((item) => () => updateDataBase(item));\n\n    await concurrentRun(updateFnList, 5, \'保存到数据库\');\n  }\n  return list;\n}\n\n// isUseApi: 是否使用 api 查询地理坐标\n// isUpdate: 是否同步到数据库\n// pageSize:\nasync function getGps(params = {}) {\n  const { isUseApi, isUpdate, pageSize = 10, current = 1 } = params;\n  const offset = (current - 1) * pageSize;\n  const sql = \\`select * from \\${targetTable} where lat is null or lon is null order by zmdm limit \\${pageSize} offset \\${offset}\\`;\n  const rsp = await sequelize.query(sql, {\n    type: sequelize.QueryTypes.SELECT\n  });\n\n  if (isUseApi) {\n    return updateList(rsp, isUpdate);\n  }\n  return rsp;\n}\n\ngetGps({\n  isUseApi: true,\n  isUpdate: true,\n  current: 1,\n  pageSize: 9000\n}).then((rsp) => {\n  // console.log(rsp)\n  process.exit(0);\n});`, `20642137204292490000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> request <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'request\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> lodash <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'lodash\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token punctuation">{</span> sequelize <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./sequelize.js\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> <span class="token punctuation">{</span> targetTable <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./config.js\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> concurrentRun <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./concurrentRun.js\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">function</span> <span class="token function">getInfoByZm</span><span class="token punctuation">(</span><span class="token parameter">keyword</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> tianDiTuApiUrl <span class="token operator">=</span> <span class="token string">\'http://api.tianditu.gov.cn\'</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> token <span class="token operator">=</span> <span class="token string">\'ab61c4d11eab1728b7f6ff48639bc73e\'</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token function">request</span><span class="token punctuation">(</span>\n      <span class="token punctuation">{</span>\n        method<span class="token punctuation">:</span> <span class="token string">\'GET\'</span><span class="token punctuation">,</span>\n        url<span class="token punctuation">:</span> <span class="token function">encodeURI</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>tianDiTuApiUrl<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/geocoder?ds={"keyWord":"</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>keyword<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"}&amp;tk=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>token<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n        timeout<span class="token punctuation">:</span> <span class="token number">10000</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n          <span class="token function">resolve</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">updateDataBase</span><span class="token punctuation">(</span><span class="token parameter">rsp</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> zmdms <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> lons <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> lats <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  rsp<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> lon <span class="token operator">=</span> lodash<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>response<span class="token punctuation">,</span> <span class="token string">\'location.lon\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> lat <span class="token operator">=</span> lodash<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>response<span class="token punctuation">,</span> <span class="token string">\'location.lat\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    zmdms<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">\'</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>item<span class="token punctuation">.</span>zmdm<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\'</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    lons<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">when \'</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>item<span class="token punctuation">.</span>zmdm<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\' then \'</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>lon<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\'</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    lats<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">when \'</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>item<span class="token punctuation">.</span>zmdm<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\' then \'</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>lat<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\'</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> sql <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">\n    update </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>targetTable<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> set\n    lon = case zmdm </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>lons<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">\' \'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> end,\n    lat = case zmdm </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>lats<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">\' \'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> end\n    where zmdm in (</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>zmdms<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">\',\'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)\n  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> rsp3 <span class="token operator">=</span> <span class="token keyword">await</span> sequelize<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n    type<span class="token punctuation">:</span> sequelize<span class="token punctuation">.</span>QueryTypes<span class="token punctuation">.</span><span class="token constant">UPDATE</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">updateList</span><span class="token punctuation">(</span><span class="token parameter">rsp<span class="token punctuation">,</span> isUpdate</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> requestFnList <span class="token operator">=</span> rsp<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">getInfoByZm</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>item<span class="token punctuation">.</span>zm<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">火车站</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> list <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">concurrentRun</span><span class="token punctuation">(</span>requestFnList<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token string">\'请求天地图\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> result <span class="token operator">=</span> rsp<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">try</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span> <span class="token punctuation">{</span>\n        <span class="token operator">...</span>item<span class="token punctuation">,</span>\n        response<span class="token punctuation">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>list<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span>\n      <span class="token punctuation">}</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span> item<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>isUpdate<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 每 100 个分隔成一组</span>\n    <span class="token keyword">const</span> updateFnList <span class="token operator">=</span> lodash<span class="token punctuation">.</span><span class="token function">chunk</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">updateDataBase</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">await</span> <span class="token function">concurrentRun</span><span class="token punctuation">(</span>updateFnList<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">\'保存到数据库\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">return</span> list<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// isUseApi: 是否使用 api 查询地理坐标</span>\n<span class="token comment">// isUpdate: 是否同步到数据库</span>\n<span class="token comment">// pageSize:</span>\n<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getGps</span><span class="token punctuation">(</span><span class="token parameter">params <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> isUseApi<span class="token punctuation">,</span> isUpdate<span class="token punctuation">,</span> pageSize <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">,</span> current <span class="token operator">=</span> <span class="token number">1</span> <span class="token punctuation">}</span> <span class="token operator">=</span> params<span class="token punctuation">;</span>\n  <span class="token keyword">const</span> offset <span class="token operator">=</span> <span class="token punctuation">(</span>current <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> pageSize<span class="token punctuation">;</span>\n  <span class="token keyword">const</span> sql <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">select * from </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>targetTable<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> where lat is null or lon is null order by zmdm limit </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>pageSize<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> offset </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>offset<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> rsp <span class="token operator">=</span> <span class="token keyword">await</span> sequelize<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n    type<span class="token punctuation">:</span> sequelize<span class="token punctuation">.</span>QueryTypes<span class="token punctuation">.</span><span class="token constant">SELECT</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>isUseApi<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token function">updateList</span><span class="token punctuation">(</span>rsp<span class="token punctuation">,</span> isUpdate<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">return</span> rsp<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token function">getGps</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n  isUseApi<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n  isUpdate<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n  current<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>\n  pageSize<span class="token punctuation">:</span> <span class="token number">9000</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">rsp</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token comment">// console.log(rsp)</span>\n  process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="执行结果"><a href="#%E6%89%A7%E8%A1%8C%E7%BB%93%E6%9E%9C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>执行结果</h4>\n<p>以 1000 个数据为例</p>\n<p>不带并行执行情况：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="98798823340065690000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`1000 个数据更新成功，0 个数据更新失败\nDone in 168.70s.`, `98798823340065690000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">1000 个数据更新成功，0 个数据更新失败\nDone in 168.70s.</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>带并行执行情况：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="77122116109738740000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`开始执行多个异步任务，最大并发数： 100\n执行完成，最大并发数： 100，耗时：19.954s\n开始执行多个异步任务，最大并发数： 5\n执行完成，最大并发数： 5，耗时：0.289s\nDone in 21.41s.`, `77122116109738740000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">开始执行多个异步任务，最大并发数： 100\n执行完成，最大并发数： 100，耗时：19.954s\n开始执行多个异步任务，最大并发数： 5\n执行完成，最大并发数： 5，耗时：0.289s\nDone in 21.41s.</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="人工修复"><a href="#%E4%BA%BA%E5%B7%A5%E4%BF%AE%E5%A4%8D" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>人工修复</h3>\n<p>经过以上修复，还是有部分数据未查到结果，最终采用内部（另外合作商）经纬度去修复</p>\n<h1 id="组件设计"><a href="#%E7%BB%84%E4%BB%B6%E8%AE%BE%E8%AE%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>组件设计</h1>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="78414225562913010000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`.\n├── api.js # api 请求，主要用来获取地图配置\n├── components\n│   ├── map\n│   │   ├── hooks\n│   │   │   ├── use-goto-map.js # 地图导航\n│   │   │   └── use-load-map.js # 地图加载\n│   │   └── index.jsx # 地图组件主入口\n│   └── route-display-layer\n│       ├── hooks\n│       │   ├── use-add-or-del-point.js # 设置删除、添加的监听事件\n│       │   ├── use-draw-line # 画地图上的线\n│       │   │   ├── const.js\n│       │   │   └── index.js\n│       │   ├── use-draw-point # 画地图上的非选中的点\n│       │   │   └── index.js\n│       │   ├── use-draw-start-pass-end # 画地图上的选中点\n│       │   │   ├── images\n│       │   │   │   ├── 圆心.png\n│       │   │   │   ├── 定位_终点.svg\n│       │   │   │   ├── 定位_起点.svg\n│       │   │   │   └── 定位_途点.svg\n│       │   │   └── index.js\n│       │   └── use-show-hover-text.js # 设置悬浮文字\n│       ├── index.jsx # 路线组件主入口\n│       └── styles.less\n├── index.jsx # 主入口文件\n└── styles.less`, `78414225562913010000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token builtin class-name">.</span>\n├── api.js <span class="token comment"># api 请求，主要用来获取地图配置</span>\n├── components\n│   ├── map\n│   │   ├── hooks\n│   │   │   ├── use-goto-map.js <span class="token comment"># 地图导航</span>\n│   │   │   └── use-load-map.js <span class="token comment"># 地图加载</span>\n│   │   └── index.jsx <span class="token comment"># 地图组件主入口</span>\n│   └── route-display-layer\n│       ├── hooks\n│       │   ├── use-add-or-del-point.js <span class="token comment"># 设置删除、添加的监听事件</span>\n│       │   ├── use-draw-line <span class="token comment"># 画地图上的线</span>\n│       │   │   ├── const.js\n│       │   │   └── index.js\n│       │   ├── use-draw-point <span class="token comment"># 画地图上的非选中的点</span>\n│       │   │   └── index.js\n│       │   ├── use-draw-start-pass-end <span class="token comment"># 画地图上的选中点</span>\n│       │   │   ├── images\n│       │   │   │   ├── 圆心.png\n│       │   │   │   ├── 定位_终点.svg\n│       │   │   │   ├── 定位_起点.svg\n│       │   │   │   └── 定位_途点.svg\n│       │   │   └── index.js\n│       │   └── use-show-hover-text.js <span class="token comment"># 设置悬浮文字</span>\n│       ├── index.jsx <span class="token comment"># 路线组件主入口</span>\n│       └── styles.less\n├── index.jsx <span class="token comment"># 主入口文件</span>\n└── styles.less</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="具体功能"><a href="#%E5%85%B7%E4%BD%93%E5%8A%9F%E8%83%BD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>具体功能</h1>\n<h2 id="主入口文件"><a href="#%E4%B8%BB%E5%85%A5%E5%8F%A3%E6%96%87%E4%BB%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>主入口文件</h2>\n<p>核心逻辑：</p>\n<ol>\n<li>兼容地图配置从外部传入的情况</li>\n<li>path（站点数据）需要过滤掉经纬度无意义的站点</li>\n<li>route（路线信息）需要过滤掉缺失的线路，即 2 个站点间的路线有可能未知</li>\n<li>map, view 实例存在时才去渲染路线相关的组件</li>\n</ol>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="41606296982228300000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import React, { useState, useEffect } from \'react\';\nimport { setDefaultOptions } from \'esri-loader\';\n\nimport RouteDisplayLayer from \'./components/route-display-layer\';\nimport Map from \'./components/map\';\nimport { getConfig } from \'./api\';\n\nimport styles from \'./styles.less\';\n\nsetDefaultOptions({\n  css: \'/static-apps/mut/arcgis/esri/themes/light/main.css\',\n  url: \'/static-apps/mut/arcgis/init.js\'\n});\n\n/*\n  config: esri 三方库后端配置地址（外部配置）\n  height: 地图高度\n  onRef：map 的 ref 回调\n  settings： {\n    centerLon 地图中心经度\n    centerLat 地图中心纬度\n    zoom 缩放级别\n  }\n  pointInfo: 过滤条件的起点、终点、途径点渲染\n  onPointInfoChange: 过滤条件变化回调\n  goToCenter: 初次加载是否到中心点\n  showAddOrDelBtn: 是否显示添加删除按钮，\n  showLineInfo: 是否显示路线信息\n  path: 站点信息\n  route: 路线信息\n  transport: 运输信息（线路密度）\n*/\n\nexport { getConfig };\n\nexport default function RailwayMap(props) {\n  const { path, route } = props;\n  const [config, setConfig] = useState(props.config);\n\n  useEffect(() => {\n    const fetchConfig = async () => {\n      const data = await getConfig();\n      setConfig(data.result);\n    };\n    if (!config) {\n      fetchConfig();\n    }\n  }, [config]);\n\n  const { centerLon = 110, centerLat = 38, zoom = 5 } = props.settings || {};\n\n  const [map, setMap] = useState();\n  const [view, setView] = useState();\n\n  if (!config) {\n    return null;\n  }\n\n  const isFloat = (number) => /^(-?\\d+)(\\.\\d+)?\\$/.test(number);\n\n  // 过滤掉没有经纬度结点或者经纬度为 0 的结点\n  const filterPath = path.filter(\n    (item) => isFloat(item.lat) && isFloat(item.lon) && +item.lat !== 0 && +item.lon !== 0\n  );\n\n  const getPointInfoByZmdm = (zmdm) => path.find((item) => item.zmdm === zmdm) || {};\n\n  const filterRoute = [];\n  for (let i = 0; i < route.length; i++) {\n    // 补充缺失的线路，比如这种情况长沙-湘潭-武汉，长沙-湘潭段属于长湘线，湘潭到武汉属于湘武线\n    // 湘潭的经纬度为空，那么直接连起来的长沙 - 武汉叫长湘线\n    if (\n      getPointInfoByZmdm(route[i].zmdm).lon &&\n      getPointInfoByZmdm(route[i].zmdm).lat &&\n      (!getPointInfoByZmdm(route[i].next_zmdm).lon || !getPointInfoByZmdm(route[i].next_zmdm).lat)\n    ) {\n      const { zm: startZm, zmdm: startZmdm, xm } = route[i];\n\n      // 累加缺失的站点的里程数\n      let distance = 0;\n      if (route[i].czjl) {\n        distance = route[i].czjl;\n      }\n\n      let index = null;\n      for (let j = i + 1; j < route.length; j++) {\n        if (route[j].czjl) {\n          distance += route[j].czjl;\n        }\n        // 这里需要找到第一个终点站经纬度不为零的站点的下标，以此来进行缺失经纬度站点的合并\n        if (getPointInfoByZmdm(route[j].next_zmdm).lon && getPointInfoByZmdm(route[j].next_zmdm).lat) {\n          index = j;\n          break;\n        }\n      }\n      if (!index) {\n        // eslint-disable-next-line no-continue\n        continue;\n      }\n      const { next_zmdm: endZmdm, next_zm: endZm } = route[index];\n      filterRoute.push({\n        zmdm: startZmdm,\n        zm: startZm,\n        next_zmdm: endZmdm,\n        next_zm: endZm,\n        xm,\n        czjl: distance\n      });\n      i = index;\n    }\n\n    // 经纬度都有的结点直接插入\n    if (\n      getPointInfoByZmdm(route[i].zmdm).lon &&\n      getPointInfoByZmdm(route[i].zmdm).lat &&\n      getPointInfoByZmdm(route[i].next_zmdm).lon &&\n      getPointInfoByZmdm(route[i].next_zmdm).lat\n    ) {\n      filterRoute.push(route[i]);\n    }\n  }\n\n  return (\n    <div className={styles.container}>\n      <Map\n        {...props}\n        config={config}\n        viewProperties={{\n          zoom: +zoom,\n          center: [+centerLon, +centerLat]\n        }}\n        setMap={setMap}\n        setView={setView}\n        view={view}\n      />\n      {map && view && <RouteDisplayLayer {...props} path={filterPath} route={filterRoute} map={map} view={view} />}\n    </div>\n  );\n}`, `41606296982228300000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useState<span class="token punctuation">,</span> useEffect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> setDefaultOptions <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'esri-loader\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> RouteDisplayLayer <span class="token keyword">from</span> <span class="token string">\'./components/route-display-layer\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> Map <span class="token keyword">from</span> <span class="token string">\'./components/map\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> getConfig <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'./api\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> styles <span class="token keyword">from</span> <span class="token string">\'./styles.less\'</span><span class="token punctuation">;</span>\n\n<span class="token function">setDefaultOptions</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n  css<span class="token punctuation">:</span> <span class="token string">\'/static-apps/mut/arcgis/esri/themes/light/main.css\'</span><span class="token punctuation">,</span>\n  url<span class="token punctuation">:</span> <span class="token string">\'/static-apps/mut/arcgis/init.js\'</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">/*\n  config: esri 三方库后端配置地址（外部配置）\n  height: 地图高度\n  onRef：map 的 ref 回调\n  settings： {\n    centerLon 地图中心经度\n    centerLat 地图中心纬度\n    zoom 缩放级别\n  }\n  pointInfo: 过滤条件的起点、终点、途径点渲染\n  onPointInfoChange: 过滤条件变化回调\n  goToCenter: 初次加载是否到中心点\n  showAddOrDelBtn: 是否显示添加删除按钮，\n  showLineInfo: 是否显示路线信息\n  path: 站点信息\n  route: 路线信息\n  transport: 运输信息（线路密度）\n*/</span>\n\n<span class="token keyword">export</span> <span class="token punctuation">{</span> getConfig <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">RailwayMap</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> path<span class="token punctuation">,</span> route <span class="token punctuation">}</span> <span class="token operator">=</span> props<span class="token punctuation">;</span>\n  <span class="token keyword">const</span> <span class="token punctuation">[</span>config<span class="token punctuation">,</span> setConfig<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> <span class="token function-variable function">fetchConfig</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token function">setConfig</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>config<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token function">fetchConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>config<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> centerLon <span class="token operator">=</span> <span class="token number">110</span><span class="token punctuation">,</span> centerLat <span class="token operator">=</span> <span class="token number">38</span><span class="token punctuation">,</span> zoom <span class="token operator">=</span> <span class="token number">5</span> <span class="token punctuation">}</span> <span class="token operator">=</span> props<span class="token punctuation">.</span>settings <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> <span class="token punctuation">[</span>map<span class="token punctuation">,</span> setMap<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> <span class="token punctuation">[</span>view<span class="token punctuation">,</span> setView<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>config<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">const</span> <span class="token function-variable function">isFloat</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">number</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token regex">/^(-?\\d+)(\\.\\d+)?$/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 过滤掉没有经纬度结点或者经纬度为 0 的结点</span>\n  <span class="token keyword">const</span> filterPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>\n    <span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">isFloat</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>lat<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isFloat</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>lon<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">+</span>item<span class="token punctuation">.</span>lat <span class="token operator">!==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">+</span>item<span class="token punctuation">.</span>lon <span class="token operator">!==</span> <span class="token number">0</span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> <span class="token function-variable function">getPointInfoByZmdm</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">zmdm</span><span class="token punctuation">)</span> <span class="token operator">=></span> path<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> item<span class="token punctuation">.</span>zmdm <span class="token operator">===</span> zmdm<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> filterRoute <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> route<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 补充缺失的线路，比如这种情况长沙-湘潭-武汉，长沙-湘潭段属于长湘线，湘潭到武汉属于湘武线</span>\n    <span class="token comment">// 湘潭的经纬度为空，那么直接连起来的长沙 - 武汉叫长湘线</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>\n      <span class="token function">getPointInfoByZmdm</span><span class="token punctuation">(</span>route<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>zmdm<span class="token punctuation">)</span><span class="token punctuation">.</span>lon <span class="token operator">&amp;&amp;</span>\n      <span class="token function">getPointInfoByZmdm</span><span class="token punctuation">(</span>route<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>zmdm<span class="token punctuation">)</span><span class="token punctuation">.</span>lat <span class="token operator">&amp;&amp;</span>\n      <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">getPointInfoByZmdm</span><span class="token punctuation">(</span>route<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>next_zmdm<span class="token punctuation">)</span><span class="token punctuation">.</span>lon <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">getPointInfoByZmdm</span><span class="token punctuation">(</span>route<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>next_zmdm<span class="token punctuation">)</span><span class="token punctuation">.</span>lat<span class="token punctuation">)</span>\n    <span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> <span class="token punctuation">{</span> zm<span class="token punctuation">:</span> startZm<span class="token punctuation">,</span> zmdm<span class="token punctuation">:</span> startZmdm<span class="token punctuation">,</span> xm <span class="token punctuation">}</span> <span class="token operator">=</span> route<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n      <span class="token comment">// 累加缺失的站点的里程数</span>\n      <span class="token keyword">let</span> distance <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>route<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>czjl<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        distance <span class="token operator">=</span> route<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>czjl<span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> j <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> route<span class="token punctuation">.</span>length<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>route<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>czjl<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          distance <span class="token operator">+=</span> route<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>czjl<span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n        <span class="token comment">// 这里需要找到第一个终点站经纬度不为零的站点的下标，以此来进行缺失经纬度站点的合并</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getPointInfoByZmdm</span><span class="token punctuation">(</span>route<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>next_zmdm<span class="token punctuation">)</span><span class="token punctuation">.</span>lon <span class="token operator">&amp;&amp;</span> <span class="token function">getPointInfoByZmdm</span><span class="token punctuation">(</span>route<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>next_zmdm<span class="token punctuation">)</span><span class="token punctuation">.</span>lat<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          index <span class="token operator">=</span> j<span class="token punctuation">;</span>\n          <span class="token keyword">break</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>index<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token comment">// eslint-disable-next-line no-continue</span>\n        <span class="token keyword">continue</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      <span class="token keyword">const</span> <span class="token punctuation">{</span> next_zmdm<span class="token punctuation">:</span> endZmdm<span class="token punctuation">,</span> next_zm<span class="token punctuation">:</span> endZm <span class="token punctuation">}</span> <span class="token operator">=</span> route<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>\n      filterRoute<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n        zmdm<span class="token punctuation">:</span> startZmdm<span class="token punctuation">,</span>\n        zm<span class="token punctuation">:</span> startZm<span class="token punctuation">,</span>\n        next_zmdm<span class="token punctuation">:</span> endZmdm<span class="token punctuation">,</span>\n        next_zm<span class="token punctuation">:</span> endZm<span class="token punctuation">,</span>\n        xm<span class="token punctuation">,</span>\n        czjl<span class="token punctuation">:</span> distance\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      i <span class="token operator">=</span> index<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token comment">// 经纬度都有的结点直接插入</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>\n      <span class="token function">getPointInfoByZmdm</span><span class="token punctuation">(</span>route<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>zmdm<span class="token punctuation">)</span><span class="token punctuation">.</span>lon <span class="token operator">&amp;&amp;</span>\n      <span class="token function">getPointInfoByZmdm</span><span class="token punctuation">(</span>route<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>zmdm<span class="token punctuation">)</span><span class="token punctuation">.</span>lat <span class="token operator">&amp;&amp;</span>\n      <span class="token function">getPointInfoByZmdm</span><span class="token punctuation">(</span>route<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>next_zmdm<span class="token punctuation">)</span><span class="token punctuation">.</span>lon <span class="token operator">&amp;&amp;</span>\n      <span class="token function">getPointInfoByZmdm</span><span class="token punctuation">(</span>route<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>next_zmdm<span class="token punctuation">)</span><span class="token punctuation">.</span>lat\n    <span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      filterRoute<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>route<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">return</span> <span class="token punctuation">(</span>\n    <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>container<span class="token punctuation">}</span><span class="token operator">></span>\n      <span class="token operator">&lt;</span>Map\n        <span class="token punctuation">{</span><span class="token operator">...</span>props<span class="token punctuation">}</span>\n        config<span class="token operator">=</span><span class="token punctuation">{</span>config<span class="token punctuation">}</span>\n        viewProperties<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>\n          zoom<span class="token punctuation">:</span> <span class="token operator">+</span>zoom<span class="token punctuation">,</span>\n          center<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token operator">+</span>centerLon<span class="token punctuation">,</span> <span class="token operator">+</span>centerLat<span class="token punctuation">]</span>\n        <span class="token punctuation">}</span><span class="token punctuation">}</span>\n        setMap<span class="token operator">=</span><span class="token punctuation">{</span>setMap<span class="token punctuation">}</span>\n        setView<span class="token operator">=</span><span class="token punctuation">{</span>setView<span class="token punctuation">}</span>\n        view<span class="token operator">=</span><span class="token punctuation">{</span>view<span class="token punctuation">}</span>\n      <span class="token operator">/</span><span class="token operator">></span>\n      <span class="token punctuation">{</span>map <span class="token operator">&amp;&amp;</span> view <span class="token operator">&amp;&amp;</span> <span class="token operator">&lt;</span>RouteDisplayLayer <span class="token punctuation">{</span><span class="token operator">...</span>props<span class="token punctuation">}</span> path<span class="token operator">=</span><span class="token punctuation">{</span>filterPath<span class="token punctuation">}</span> route<span class="token operator">=</span><span class="token punctuation">{</span>filterRoute<span class="token punctuation">}</span> map<span class="token operator">=</span><span class="token punctuation">{</span>map<span class="token punctuation">}</span> view<span class="token operator">=</span><span class="token punctuation">{</span>view<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">}</span>\n    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="地图组件主入口"><a href="#%E5%9C%B0%E5%9B%BE%E7%BB%84%E4%BB%B6%E4%B8%BB%E5%85%A5%E5%8F%A3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>地图组件主入口</h2>\n<p>采用 hooks 方式拆分，下面的组件也是采用类似的拆分</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="42305276110918120000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import { useRef } from \'react\';\n\nimport useLoadMap from \'./hooks/use-load-map\';\nimport useGotoMap from \'./hooks/use-goto-map\';\n\nexport default function Map(props) {\n  const { height } = props;\n  const mapRef = useRef();\n  useLoadMap({\n    ...props,\n    mapRef\n  });\n  useGotoMap(props);\n\n  return (\n    <div\n      style={{\n        height\n      }}\n      ref={mapRef}\n    />\n  );\n}`, `42305276110918120000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> useRef <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> useLoadMap <span class="token keyword">from</span> <span class="token string">\'./hooks/use-load-map\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> useGotoMap <span class="token keyword">from</span> <span class="token string">\'./hooks/use-goto-map\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">Map</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> height <span class="token punctuation">}</span> <span class="token operator">=</span> props<span class="token punctuation">;</span>\n  <span class="token keyword">const</span> mapRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token function">useLoadMap</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n    <span class="token operator">...</span>props<span class="token punctuation">,</span>\n    mapRef\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token function">useGotoMap</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">return</span> <span class="token punctuation">(</span>\n    <span class="token operator">&lt;</span>div\n      style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>\n        height\n      <span class="token punctuation">}</span><span class="token punctuation">}</span>\n      ref<span class="token operator">=</span><span class="token punctuation">{</span>mapRef<span class="token punctuation">}</span>\n    <span class="token operator">/</span><span class="token operator">></span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="地图加载"><a href="#%E5%9C%B0%E5%9B%BE%E5%8A%A0%E8%BD%BD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>地图加载</h2>\n<p>需要监听地图组件图层加载完毕事件</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="97292266135206100000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import { useEffect } from \'react\';\nimport { loadModules } from \'esri-loader\';\n\n// 地图加载\nexport default function useLoadMap(props) {\n  const { setMap, setView, viewProperties, config, mapRef, onRef } = props;\n  const { mapLayerUrlTemplate, subDomains, markerLayerUrlTemplate } = config;\n\n  useEffect(() => {\n    // https://developers.arcgis.com/javascript/latest/sample-code/sandbox/index.html?sample=layers-webtile-3d\n    loadModules([\'esri/Map\', \'esri/views/MapView\', \'esri/layers/WebTileLayer\'])\n      .then(([Map, MapView, WebTileLayer]) => {\n        const mapLayer = new WebTileLayer({\n          urlTemplate: mapLayerUrlTemplate,\n          subDomains\n        });\n        const markerLayer = new WebTileLayer({\n          urlTemplate: markerLayerUrlTemplate,\n          subDomains\n        });\n\n        const map = new Map({\n          layers: [mapLayer, markerLayer]\n        });\n\n        const view = new MapView({\n          container: mapRef.current,\n          map,\n          ...viewProperties\n        });\n\n        view.ui.move(\'zoom\', \'bottom-right\');\n\n        view.when(\n          () => {\n            console.log(\'地图加载完成\');\n            setMap(map);\n            setView(view);\n            onRef &&\n              onRef({\n                map,\n                view\n              });\n          },\n          (error) => {\n            console.log(\'地图加载失败\', error);\n          }\n        );\n      })\n      .catch((err) => {\n        // handle any errors\n        console.error(err);\n      });\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [setMap, setView]);\n}`, `97292266135206100000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> useEffect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> loadModules <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'esri-loader\'</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 地图加载</span>\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">useLoadMap</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> setMap<span class="token punctuation">,</span> setView<span class="token punctuation">,</span> viewProperties<span class="token punctuation">,</span> config<span class="token punctuation">,</span> mapRef<span class="token punctuation">,</span> onRef <span class="token punctuation">}</span> <span class="token operator">=</span> props<span class="token punctuation">;</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> mapLayerUrlTemplate<span class="token punctuation">,</span> subDomains<span class="token punctuation">,</span> markerLayerUrlTemplate <span class="token punctuation">}</span> <span class="token operator">=</span> config<span class="token punctuation">;</span>\n\n  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token comment">// https://developers.arcgis.com/javascript/latest/sample-code/sandbox/index.html?sample=layers-webtile-3d</span>\n    <span class="token function">loadModules</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'esri/Map\'</span><span class="token punctuation">,</span> <span class="token string">\'esri/views/MapView\'</span><span class="token punctuation">,</span> <span class="token string">\'esri/layers/WebTileLayer\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">[</span>Map<span class="token punctuation">,</span> MapView<span class="token punctuation">,</span> WebTileLayer<span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token keyword">const</span> mapLayer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebTileLayer</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n          urlTemplate<span class="token punctuation">:</span> mapLayerUrlTemplate<span class="token punctuation">,</span>\n          subDomains\n        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">const</span> markerLayer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebTileLayer</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n          urlTemplate<span class="token punctuation">:</span> markerLayerUrlTemplate<span class="token punctuation">,</span>\n          subDomains\n        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        <span class="token keyword">const</span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n          layers<span class="token punctuation">:</span> <span class="token punctuation">[</span>mapLayer<span class="token punctuation">,</span> markerLayer<span class="token punctuation">]</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        <span class="token keyword">const</span> view <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MapView</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n          container<span class="token punctuation">:</span> mapRef<span class="token punctuation">.</span>current<span class="token punctuation">,</span>\n          map<span class="token punctuation">,</span>\n          <span class="token operator">...</span>viewProperties\n        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        view<span class="token punctuation">.</span>ui<span class="token punctuation">.</span><span class="token function">move</span><span class="token punctuation">(</span><span class="token string">\'zoom\'</span><span class="token punctuation">,</span> <span class="token string">\'bottom-right\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        view<span class="token punctuation">.</span><span class="token function">when</span><span class="token punctuation">(</span>\n          <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'地图加载完成\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token function">setMap</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token function">setView</span><span class="token punctuation">(</span>view<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            onRef <span class="token operator">&amp;&amp;</span>\n              <span class="token function">onRef</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n                map<span class="token punctuation">,</span>\n                view\n              <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token punctuation">}</span><span class="token punctuation">,</span>\n          <span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'地图加载失败\'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token punctuation">}</span>\n        <span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token comment">// handle any errors</span>\n        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// eslint-disable-next-line react-hooks/exhaustive-deps</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>setMap<span class="token punctuation">,</span> setView<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="地图导航"><a href="#%E5%9C%B0%E5%9B%BE%E5%AF%BC%E8%88%AA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>地图导航</h2>\n<p>初始化时直接导航到相应路线（暂时有 bug，因为不能确定路线组件完全加载的时机而导致的偶尔路线渲染不出来的现象）</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="82035222422307590000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import { useEffect } from \'react\';\n\n// 地图导航\nexport default function useGotoMap(props) {\n  const { view, goToCenter, path } = props;\n\n  useEffect(() => {\n    if (!view || !goToCenter || !path || !path.length) {\n      return;\n    }\n\n    // 暂时未找到 view.graphics 完全加载时的方法，会造成白屏 bug\n    if (goToCenter === true) {\n      view.goTo(\n        {\n          target: view.graphics\n        },\n        {\n          animate: false\n        }\n      );\n    } else {\n      view.goTo(goToCenter);\n    }\n  }, [path, view, goToCenter]);\n\n  // console.log(\'view\', view)\n  // const eventRef = useRef()\n  // useEffect(() => {\n  //   if (!view) {\n  //     return\n  //   }\n\n  //   eventRef.current = view.on(\'layerview-create\', () => {\n  //     console.log(\'dsads\')\n  //     console.log(get(view, \'graphics._items\', []).length)\n  //   })\n\n  //   return () => {\n  //     eventRef.current && eventRef.current.remove()\n  //   }\n  // }, [view])\n}`, `82035222422307590000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> useEffect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 地图导航</span>\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">useGotoMap</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> view<span class="token punctuation">,</span> goToCenter<span class="token punctuation">,</span> path <span class="token punctuation">}</span> <span class="token operator">=</span> props<span class="token punctuation">;</span>\n\n  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>view <span class="token operator">||</span> <span class="token operator">!</span>goToCenter <span class="token operator">||</span> <span class="token operator">!</span>path <span class="token operator">||</span> <span class="token operator">!</span>path<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token comment">// 暂时未找到 view.graphics 完全加载时的方法，会造成白屏 bug</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>goToCenter <span class="token operator">===</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      view<span class="token punctuation">.</span><span class="token function">goTo</span><span class="token punctuation">(</span>\n        <span class="token punctuation">{</span>\n          target<span class="token punctuation">:</span> view<span class="token punctuation">.</span>graphics\n        <span class="token punctuation">}</span><span class="token punctuation">,</span>\n        <span class="token punctuation">{</span>\n          animate<span class="token punctuation">:</span> <span class="token boolean">false</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n      view<span class="token punctuation">.</span><span class="token function">goTo</span><span class="token punctuation">(</span>goToCenter<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>path<span class="token punctuation">,</span> view<span class="token punctuation">,</span> goToCenter<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// console.log(\'view\', view)</span>\n  <span class="token comment">// const eventRef = useRef()</span>\n  <span class="token comment">// useEffect(() => {</span>\n  <span class="token comment">//   if (!view) {</span>\n  <span class="token comment">//     return</span>\n  <span class="token comment">//   }</span>\n\n  <span class="token comment">//   eventRef.current = view.on(\'layerview-create\', () => {</span>\n  <span class="token comment">//     console.log(\'dsads\')</span>\n  <span class="token comment">//     console.log(get(view, \'graphics._items\', []).length)</span>\n  <span class="token comment">//   })</span>\n\n  <span class="token comment">//   return () => {</span>\n  <span class="token comment">//     eventRef.current &amp;&amp; eventRef.current.remove()</span>\n  <span class="token comment">//   }</span>\n  <span class="token comment">// }, [view])</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="路线组件主入口"><a href="#%E8%B7%AF%E7%BA%BF%E7%BB%84%E4%BB%B6%E4%B8%BB%E5%85%A5%E5%8F%A3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>路线组件主入口</h2>\n<ol>\n<li>渲染路线信息组件</li>\n<li>渲染悬浮文字组件</li>\n</ol>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="48677162694383050000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import { Fragment, useRef, useState } from \'react\';\nimport { ShrinkOutlined, ArrowsAltOutlined } from \'@ant-design/icons\';\nimport classnames from \'classnames\';\nimport { Button } from \'antd\';\n\nimport useDrawLine from \'./hooks/use-draw-line\';\nimport useDrawPoint from \'./hooks/use-draw-point\';\nimport useDrawStartPassEnd from \'./hooks/use-draw-start-pass-end\';\nimport useAddOrDelPoint from \'./hooks/use-add-or-del-point\';\nimport useShowHoverText from \'./hooks/use-show-hover-text\';\n\nimport styles from \'./styles.less\';\n\nexport default function RouteDisplayLayer(props) {\n  const { showLineInfo = true } = props;\n\n  const { lineInfo } = useDrawLine(props);\n\n  const [isExpand, setIsExpand] = useState(true);\n\n  useDrawPoint(props);\n\n  useDrawStartPassEnd(props);\n\n  useAddOrDelPoint(props);\n\n  const hoverNodeRef = useRef();\n\n  useShowHoverText({\n    ...props,\n    hoverNodeRef\n  });\n\n  const totalDistance = lineInfo.reduce((pre, cur) => pre + cur.distance, 0);\n\n  const totalHint = (\n    <span>\n      全程\n      {totalDistance}\n      公里\n    </span>\n  );\n\n  return (\n    <Fragment>\n      <span className={styles.hoverNode} ref={hoverNodeRef} />\n      {showLineInfo &&\n        lineInfo &&\n        lineInfo.length > 0 &&\n        (isExpand ? (\n          <div className={classnames(styles.lineInfoContainer, styles.lineInfo)}>\n            <div className={styles.header}>\n              {totalHint}\n              <div className={styles.expandBtn}>\n                <ShrinkOutlined onClick={() => setIsExpand(false)} />\n              </div>\n            </div>\n            <div className={styles.body}>\n              {lineInfo.map((item) => (\n                <div key={item.xm} className={styles.item}>\n                  <span\n                    className={styles.color}\n                    style={{\n                      background: item.color\n                    }}\n                  />\n                  <span className={styles.xm}>{item.xm}</span>\n                </div>\n              ))}\n            </div>\n          </div>\n        ) : (\n          <div className={styles.lineInfoContainer}>\n            <Button onClick={() => setIsExpand(true)} icon={<ArrowsAltOutlined />}>\n              {totalHint}\n            </Button>\n          </div>\n        ))}\n    </Fragment>\n  );\n}`, `48677162694383050000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> Fragment<span class="token punctuation">,</span> useRef<span class="token punctuation">,</span> useState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> ShrinkOutlined<span class="token punctuation">,</span> ArrowsAltOutlined <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@ant-design/icons\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> classnames <span class="token keyword">from</span> <span class="token string">\'classnames\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> Button <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'antd\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> useDrawLine <span class="token keyword">from</span> <span class="token string">\'./hooks/use-draw-line\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> useDrawPoint <span class="token keyword">from</span> <span class="token string">\'./hooks/use-draw-point\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> useDrawStartPassEnd <span class="token keyword">from</span> <span class="token string">\'./hooks/use-draw-start-pass-end\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> useAddOrDelPoint <span class="token keyword">from</span> <span class="token string">\'./hooks/use-add-or-del-point\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> useShowHoverText <span class="token keyword">from</span> <span class="token string">\'./hooks/use-show-hover-text\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> styles <span class="token keyword">from</span> <span class="token string">\'./styles.less\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">RouteDisplayLayer</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> showLineInfo <span class="token operator">=</span> <span class="token boolean">true</span> <span class="token punctuation">}</span> <span class="token operator">=</span> props<span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> lineInfo <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useDrawLine</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> <span class="token punctuation">[</span>isExpand<span class="token punctuation">,</span> setIsExpand<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token function">useDrawPoint</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token function">useDrawStartPassEnd</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token function">useAddOrDelPoint</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> hoverNodeRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token function">useShowHoverText</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n    <span class="token operator">...</span>props<span class="token punctuation">,</span>\n    hoverNodeRef\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> totalDistance <span class="token operator">=</span> lineInfo<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">pre<span class="token punctuation">,</span> cur</span><span class="token punctuation">)</span> <span class="token operator">=></span> pre <span class="token operator">+</span> cur<span class="token punctuation">.</span>distance<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> totalHint <span class="token operator">=</span> <span class="token punctuation">(</span>\n    <span class="token operator">&lt;</span>span<span class="token operator">></span>\n      全程\n      <span class="token punctuation">{</span>totalDistance<span class="token punctuation">}</span>\n      公里\n    <span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">></span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">return</span> <span class="token punctuation">(</span>\n    <span class="token operator">&lt;</span>Fragment<span class="token operator">></span>\n      <span class="token operator">&lt;</span>span className<span class="token operator">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>hoverNode<span class="token punctuation">}</span> ref<span class="token operator">=</span><span class="token punctuation">{</span>hoverNodeRef<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>\n      <span class="token punctuation">{</span>showLineInfo <span class="token operator">&amp;&amp;</span>\n        lineInfo <span class="token operator">&amp;&amp;</span>\n        lineInfo<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>\n        <span class="token punctuation">(</span>isExpand <span class="token operator">?</span> <span class="token punctuation">(</span>\n          <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token punctuation">{</span><span class="token function">classnames</span><span class="token punctuation">(</span>styles<span class="token punctuation">.</span>lineInfoContainer<span class="token punctuation">,</span> styles<span class="token punctuation">.</span>lineInfo<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">></span>\n            <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>header<span class="token punctuation">}</span><span class="token operator">></span>\n              <span class="token punctuation">{</span>totalHint<span class="token punctuation">}</span>\n              <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>expandBtn<span class="token punctuation">}</span><span class="token operator">></span>\n                <span class="token operator">&lt;</span>ShrinkOutlined onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">setIsExpand</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>\n              <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>\n            <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>\n            <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>body<span class="token punctuation">}</span><span class="token operator">></span>\n              <span class="token punctuation">{</span>lineInfo<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span>\n                <span class="token operator">&lt;</span>div key<span class="token operator">=</span><span class="token punctuation">{</span>item<span class="token punctuation">.</span>xm<span class="token punctuation">}</span> className<span class="token operator">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>item<span class="token punctuation">}</span><span class="token operator">></span>\n                  <span class="token operator">&lt;</span>span\n                    className<span class="token operator">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>color<span class="token punctuation">}</span>\n                    style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>\n                      background<span class="token punctuation">:</span> item<span class="token punctuation">.</span>color\n                    <span class="token punctuation">}</span><span class="token punctuation">}</span>\n                  <span class="token operator">/</span><span class="token operator">></span>\n                  <span class="token operator">&lt;</span>span className<span class="token operator">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>xm<span class="token punctuation">}</span><span class="token operator">></span><span class="token punctuation">{</span>item<span class="token punctuation">.</span>xm<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">></span>\n                <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>\n              <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span>\n            <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>\n          <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>\n        <span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span>\n          <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>lineInfoContainer<span class="token punctuation">}</span><span class="token operator">></span>\n            <span class="token operator">&lt;</span>Button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">setIsExpand</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">}</span> icon<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">&lt;</span>ArrowsAltOutlined <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">}</span><span class="token operator">></span>\n              <span class="token punctuation">{</span>totalHint<span class="token punctuation">}</span>\n            <span class="token operator">&lt;</span><span class="token operator">/</span>Button<span class="token operator">></span>\n          <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>\n        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span>\n    <span class="token operator">&lt;</span><span class="token operator">/</span>Fragment<span class="token operator">></span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="画地图上的线"><a href="#%E7%94%BB%E5%9C%B0%E5%9B%BE%E4%B8%8A%E7%9A%84%E7%BA%BF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>画地图上的线</h2>\n<ol>\n<li>根据 route、path 渲染路线</li>\n<li>根据 transport 渲染路线粗细，同时弹窗显示线路密度</li>\n</ol>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="34373787872471870000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import { useEffect, useRef } from \'react\';\nimport { loadModules } from \'esri-loader\';\nimport { get, groupBy } from \'lodash\';\n\nimport { LINE_COLORS, getLineSize } from \'./const\';\n\n// 画地图上的线\nexport default function useDrawLine(props) {\n  const { path, view, route, transport } = props;\n\n  const polylineGraphicsRef = useRef();\n\n  useEffect(() => {\n    const groupMap = groupBy(route, (item) => item.xm);\n    const getPointInfoByZmdm = (zmdm) => path.find((item) => item.zmdm === zmdm);\n\n    // https://developers.arcgis.com/javascript/latest/guide/display-point-line-and-polygon-graphics/\n    // https://developers.arcgis.com/javascript/latest/sample-code/intro-graphics/index.html\n    loadModules([\'esri/Graphic\'])\n      .then(([Graphic]) => {\n        if (polylineGraphicsRef.current) {\n          polylineGraphicsRef.current.forEach((item) => {\n            view.graphics.remove(item);\n          });\n          polylineGraphicsRef.current = [];\n        }\n\n        /* 根据 path、transport 计算密度总数 */\n        // 根据经过的 path 即站点累加密度情况\n        const transportList = []; // 运输密度统计表，以 path 最小单元做计算\n        if (transport && transport.length > 0) {\n          transport.forEach((item) => {\n            // 找到上车站的下标\n            const startIndex = path.findIndex((item2) => item2.zmdm === item.zmdm_sc);\n            // 找到下车站的下标\n            const endIndex = path.findIndex((item2) => item2.zmdm === item.zmdm_xc);\n            // 遍历上车站到下车站的站点，累加所有密度\n            for (let i = startIndex; i < endIndex; i++) {\n              const startZmdm = get(path, \\`[\\${i}].zmdm\\`);\n              const endZmdm = get(path, \\`[\\${i + 1}].zmdm\\`);\n              const findTransportList = transportList.find(\n                (item2) => get(item2, \'start.zmdm\') === startZmdm && get(item2, \'end.zmdm\') === endZmdm\n              );\n              if (findTransportList) {\n                findTransportList.total += item.ysrs;\n              } else {\n                transportList.push({\n                  start: path[i],\n                  end: path[i + 1],\n                  total: item.ysrs\n                });\n              }\n            }\n          });\n        }\n        // 根据起点代码、终点代码找到密度数\n        const getPeopleNumberByStartEnd = (startZmdm, endZmdm) =>\n          get(\n            transportList.find((item) => get(item, \'start.zmdm\') === startZmdm && get(item, \'end.zmdm\') === endZmdm),\n            \'total\',\n            0\n          );\n        /* 根据 path、transport 计算密度总数 */\n\n        const polylineGraphics = [];\n\n        // 渲染线路\n        const renderLine = ({ paths, width, distance, xm, index, peopleNumber }) => {\n          const content = [];\n          if (distance) {\n            content.push(\\`里程：\\${distance} 公里\\`);\n          }\n          if (peopleNumber) {\n            content.push(\\`运输密度：\\${peopleNumber} 人\\`);\n          }\n          const polylineGraphic = new Graphic({\n            geometry: {\n              type: \'polyline\',\n              paths: paths.map((item) => [+get(item, \'lon\', 0), +get(item, \'lat\', 0)])\n            },\n            symbol: {\n              type: \'simple-line\',\n              color: LINE_COLORS[index % LINE_COLORS.length],\n              width\n            },\n            attributes: {\n              xm\n            },\n            popupTemplate: {\n              title: xm,\n              content: content.join(\'、\')\n            }\n          });\n          polylineGraphics.push(polylineGraphic);\n          view.graphics.add(polylineGraphic);\n        };\n\n        Object.keys(groupMap).forEach((key, index) => {\n          const paths = [];\n          let totalDistance = 0;\n          groupMap[key].forEach((item) => {\n            const startPointInfo = getPointInfoByZmdm(item.zmdm);\n            const endPointInfo = getPointInfoByZmdm(item.next_zmdm);\n            totalDistance += item.czjl || 0;\n            paths.push([startPointInfo, endPointInfo]);\n          });\n          if (transport && transport.length > 0) {\n            paths.forEach((item) => {\n              const [startPointInfo, endPointInfo] = item;\n              const peopleNumber = getPeopleNumberByStartEnd(get(startPointInfo, \'zmdm\'), get(endPointInfo, \'zmdm\'));\n              const width = getLineSize(peopleNumber);\n              // console.log(get(startPointInfo, \'zm\'), get(endPointInfo, \'zm\'), key, peopleNumber, width)\n              renderLine({\n                distance: totalDistance,\n                width: \\`\\${width}px\\`,\n                paths: item,\n                xm: key,\n                index,\n                peopleNumber\n              });\n            });\n          } else {\n            paths.forEach((item) => {\n              // const [startPointInfo, endPointInfo] = item\n              // console.log(get(startPointInfo, \'zm\'), get(endPointInfo, \'zm\'), key)\n              renderLine({\n                distance: totalDistance,\n                width: \'6px\',\n                paths: item,\n                xm: key,\n                index\n              });\n            });\n          }\n        });\n        polylineGraphicsRef.current = polylineGraphics;\n      })\n      .catch((err) => {\n        console.error(err);\n      });\n  }, [view, path, transport, route]);\n\n  const lineInfo = [];\n\n  const groupMap = groupBy(route, (item) => item.xm);\n  Object.keys(groupMap).forEach((key, index) => {\n    lineInfo.push({\n      xm: key,\n      color: LINE_COLORS[index % LINE_COLORS.length],\n      distance: groupMap[key].reduce((pre, cur) => pre + (cur.czjl || 0), 0)\n    });\n  });\n\n  return {\n    lineInfo\n  };\n}`, `34373787872471870000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> useEffect<span class="token punctuation">,</span> useRef <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> loadModules <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'esri-loader\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">,</span> groupBy <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'lodash\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">LINE_COLORS</span><span class="token punctuation">,</span> getLineSize <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'./const\'</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 画地图上的线</span>\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">useDrawLine</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> path<span class="token punctuation">,</span> view<span class="token punctuation">,</span> route<span class="token punctuation">,</span> transport <span class="token punctuation">}</span> <span class="token operator">=</span> props<span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> polylineGraphicsRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> groupMap <span class="token operator">=</span> <span class="token function">groupBy</span><span class="token punctuation">(</span>route<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> item<span class="token punctuation">.</span>xm<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> <span class="token function-variable function">getPointInfoByZmdm</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">zmdm</span><span class="token punctuation">)</span> <span class="token operator">=></span> path<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> item<span class="token punctuation">.</span>zmdm <span class="token operator">===</span> zmdm<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// https://developers.arcgis.com/javascript/latest/guide/display-point-line-and-polygon-graphics/</span>\n    <span class="token comment">// https://developers.arcgis.com/javascript/latest/sample-code/intro-graphics/index.html</span>\n    <span class="token function">loadModules</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'esri/Graphic\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">[</span>Graphic<span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>polylineGraphicsRef<span class="token punctuation">.</span>current<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          polylineGraphicsRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            view<span class="token punctuation">.</span>graphics<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n          polylineGraphicsRef<span class="token punctuation">.</span>current <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n\n        <span class="token comment">/* 根据 path、transport 计算密度总数 */</span>\n        <span class="token comment">// 根据经过的 path 即站点累加密度情况</span>\n        <span class="token keyword">const</span> transportList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 运输密度统计表，以 path 最小单元做计算</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>transport <span class="token operator">&amp;&amp;</span> transport<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          transport<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            <span class="token comment">// 找到上车站的下标</span>\n            <span class="token keyword">const</span> startIndex <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">findIndex</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item2</span><span class="token punctuation">)</span> <span class="token operator">=></span> item2<span class="token punctuation">.</span>zmdm <span class="token operator">===</span> item<span class="token punctuation">.</span>zmdm_sc<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token comment">// 找到下车站的下标</span>\n            <span class="token keyword">const</span> endIndex <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">findIndex</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item2</span><span class="token punctuation">)</span> <span class="token operator">=></span> item2<span class="token punctuation">.</span>zmdm <span class="token operator">===</span> item<span class="token punctuation">.</span>zmdm_xc<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token comment">// 遍历上车站到下车站的站点，累加所有密度</span>\n            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> startIndex<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> endIndex<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n              <span class="token keyword">const</span> startZmdm <span class="token operator">=</span> <span class="token keyword">get</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>i<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">].zmdm</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n              <span class="token keyword">const</span> endZmdm <span class="token operator">=</span> <span class="token keyword">get</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">].zmdm</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n              <span class="token keyword">const</span> findTransportList <span class="token operator">=</span> transportList<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>\n                <span class="token punctuation">(</span><span class="token parameter">item2</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">get</span><span class="token punctuation">(</span>item2<span class="token punctuation">,</span> <span class="token string">\'start.zmdm\'</span><span class="token punctuation">)</span> <span class="token operator">===</span> startZmdm <span class="token operator">&amp;&amp;</span> <span class="token keyword">get</span><span class="token punctuation">(</span>item2<span class="token punctuation">,</span> <span class="token string">\'end.zmdm\'</span><span class="token punctuation">)</span> <span class="token operator">===</span> endZmdm\n              <span class="token punctuation">)</span><span class="token punctuation">;</span>\n              <span class="token keyword">if</span> <span class="token punctuation">(</span>findTransportList<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                findTransportList<span class="token punctuation">.</span>total <span class="token operator">+=</span> item<span class="token punctuation">.</span>ysrs<span class="token punctuation">;</span>\n              <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n                transportList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n                  start<span class="token punctuation">:</span> path<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>\n                  end<span class="token punctuation">:</span> path<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n                  total<span class="token punctuation">:</span> item<span class="token punctuation">.</span>ysrs\n                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n              <span class="token punctuation">}</span>\n            <span class="token punctuation">}</span>\n          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n        <span class="token comment">// 根据起点代码、终点代码找到密度数</span>\n        <span class="token keyword">const</span> <span class="token function-variable function">getPeopleNumberByStartEnd</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">startZmdm<span class="token punctuation">,</span> endZmdm</span><span class="token punctuation">)</span> <span class="token operator">=></span>\n          <span class="token keyword">get</span><span class="token punctuation">(</span>\n            transportList<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">get</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token string">\'start.zmdm\'</span><span class="token punctuation">)</span> <span class="token operator">===</span> startZmdm <span class="token operator">&amp;&amp;</span> <span class="token keyword">get</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token string">\'end.zmdm\'</span><span class="token punctuation">)</span> <span class="token operator">===</span> endZmdm<span class="token punctuation">)</span><span class="token punctuation">,</span>\n            <span class="token string">\'total\'</span><span class="token punctuation">,</span>\n            <span class="token number">0</span>\n          <span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token comment">/* 根据 path、transport 计算密度总数 */</span>\n\n        <span class="token keyword">const</span> polylineGraphics <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n        <span class="token comment">// 渲染线路</span>\n        <span class="token keyword">const</span> <span class="token function-variable function">renderLine</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> paths<span class="token punctuation">,</span> width<span class="token punctuation">,</span> distance<span class="token punctuation">,</span> xm<span class="token punctuation">,</span> index<span class="token punctuation">,</span> peopleNumber <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n          <span class="token keyword">const</span> content <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n          <span class="token keyword">if</span> <span class="token punctuation">(</span>distance<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            content<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">里程：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>distance<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 公里</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token punctuation">}</span>\n          <span class="token keyword">if</span> <span class="token punctuation">(</span>peopleNumber<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            content<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">运输密度：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>peopleNumber<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 人</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token punctuation">}</span>\n          <span class="token keyword">const</span> polylineGraphic <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Graphic</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n            geometry<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n              type<span class="token punctuation">:</span> <span class="token string">\'polyline\'</span><span class="token punctuation">,</span>\n              paths<span class="token punctuation">:</span> paths<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">[</span><span class="token operator">+</span><span class="token keyword">get</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token string">\'lon\'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">+</span><span class="token keyword">get</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token string">\'lat\'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n            <span class="token punctuation">}</span><span class="token punctuation">,</span>\n            symbol<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n              type<span class="token punctuation">:</span> <span class="token string">\'simple-line\'</span><span class="token punctuation">,</span>\n              color<span class="token punctuation">:</span> <span class="token constant">LINE_COLORS</span><span class="token punctuation">[</span>index <span class="token operator">%</span> <span class="token constant">LINE_COLORS</span><span class="token punctuation">.</span>length<span class="token punctuation">]</span><span class="token punctuation">,</span>\n              width\n            <span class="token punctuation">}</span><span class="token punctuation">,</span>\n            attributes<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n              xm\n            <span class="token punctuation">}</span><span class="token punctuation">,</span>\n            popupTemplate<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n              title<span class="token punctuation">:</span> xm<span class="token punctuation">,</span>\n              content<span class="token punctuation">:</span> content<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">\'、\'</span><span class="token punctuation">)</span>\n            <span class="token punctuation">}</span>\n          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n          polylineGraphics<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>polylineGraphic<span class="token punctuation">)</span><span class="token punctuation">;</span>\n          view<span class="token punctuation">.</span>graphics<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>polylineGraphic<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n        Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>groupMap<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n          <span class="token keyword">const</span> paths <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n          <span class="token keyword">let</span> totalDistance <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n          groupMap<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            <span class="token keyword">const</span> startPointInfo <span class="token operator">=</span> <span class="token function">getPointInfoByZmdm</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>zmdm<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token keyword">const</span> endPointInfo <span class="token operator">=</span> <span class="token function">getPointInfoByZmdm</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>next_zmdm<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            totalDistance <span class="token operator">+=</span> item<span class="token punctuation">.</span>czjl <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">;</span>\n            paths<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">[</span>startPointInfo<span class="token punctuation">,</span> endPointInfo<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token keyword">if</span> <span class="token punctuation">(</span>transport <span class="token operator">&amp;&amp;</span> transport<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            paths<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n              <span class="token keyword">const</span> <span class="token punctuation">[</span>startPointInfo<span class="token punctuation">,</span> endPointInfo<span class="token punctuation">]</span> <span class="token operator">=</span> item<span class="token punctuation">;</span>\n              <span class="token keyword">const</span> peopleNumber <span class="token operator">=</span> <span class="token function">getPeopleNumberByStartEnd</span><span class="token punctuation">(</span><span class="token keyword">get</span><span class="token punctuation">(</span>startPointInfo<span class="token punctuation">,</span> <span class="token string">\'zmdm\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">get</span><span class="token punctuation">(</span>endPointInfo<span class="token punctuation">,</span> <span class="token string">\'zmdm\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n              <span class="token keyword">const</span> width <span class="token operator">=</span> <span class="token function">getLineSize</span><span class="token punctuation">(</span>peopleNumber<span class="token punctuation">)</span><span class="token punctuation">;</span>\n              <span class="token comment">// console.log(get(startPointInfo, \'zm\'), get(endPointInfo, \'zm\'), key, peopleNumber, width)</span>\n              <span class="token function">renderLine</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n                distance<span class="token punctuation">:</span> totalDistance<span class="token punctuation">,</span>\n                width<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>width<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n                paths<span class="token punctuation">:</span> item<span class="token punctuation">,</span>\n                xm<span class="token punctuation">:</span> key<span class="token punctuation">,</span>\n                index<span class="token punctuation">,</span>\n                peopleNumber\n              <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n            paths<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n              <span class="token comment">// const [startPointInfo, endPointInfo] = item</span>\n              <span class="token comment">// console.log(get(startPointInfo, \'zm\'), get(endPointInfo, \'zm\'), key)</span>\n              <span class="token function">renderLine</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n                distance<span class="token punctuation">:</span> totalDistance<span class="token punctuation">,</span>\n                width<span class="token punctuation">:</span> <span class="token string">\'6px\'</span><span class="token punctuation">,</span>\n                paths<span class="token punctuation">:</span> item<span class="token punctuation">,</span>\n                xm<span class="token punctuation">:</span> key<span class="token punctuation">,</span>\n                index\n              <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        polylineGraphicsRef<span class="token punctuation">.</span>current <span class="token operator">=</span> polylineGraphics<span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>view<span class="token punctuation">,</span> path<span class="token punctuation">,</span> transport<span class="token punctuation">,</span> route<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> lineInfo <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> groupMap <span class="token operator">=</span> <span class="token function">groupBy</span><span class="token punctuation">(</span>route<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> item<span class="token punctuation">.</span>xm<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>groupMap<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    lineInfo<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n      xm<span class="token punctuation">:</span> key<span class="token punctuation">,</span>\n      color<span class="token punctuation">:</span> <span class="token constant">LINE_COLORS</span><span class="token punctuation">[</span>index <span class="token operator">%</span> <span class="token constant">LINE_COLORS</span><span class="token punctuation">.</span>length<span class="token punctuation">]</span><span class="token punctuation">,</span>\n      distance<span class="token punctuation">:</span> groupMap<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">pre<span class="token punctuation">,</span> cur</span><span class="token punctuation">)</span> <span class="token operator">=></span> pre <span class="token operator">+</span> <span class="token punctuation">(</span>cur<span class="token punctuation">.</span>czjl <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">return</span> <span class="token punctuation">{</span>\n    lineInfo\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="画地图上的非选中的点"><a href="#%E7%94%BB%E5%9C%B0%E5%9B%BE%E4%B8%8A%E7%9A%84%E9%9D%9E%E9%80%89%E4%B8%AD%E7%9A%84%E7%82%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>画地图上的非选中的点</h2>\n<p>渲染非选中的站点，弹窗显示站点信息并显示添加按钮</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="54958767584593750000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import { useEffect, useRef } from \'react\';\nimport { loadModules } from \'esri-loader\';\nimport { get } from \'lodash\';\n\n// 画地图上的非过滤条件上的点\nexport default function useDrawPoint(props) {\n  const { path, pointInfo = [], view, showAddOrDelBtn = true } = props;\n  const routerRef = useRef({\n    // 属于路径但不在过滤条件里面的点\n    notFilterPointGraphics: []\n  });\n\n  useEffect(() => {\n    // https://developers.arcgis.com/javascript/latest/guide/display-point-line-and-polygon-graphics/\n    // https://developers.arcgis.com/javascript/latest/sample-code/intro-graphics/index.html\n    loadModules([\'esri/Graphic\'])\n      .then(([Graphic]) => {\n        /** 画点 **/\n        const notFilterPointGraphicsRef = routerRef.current.notFilterPointGraphics;\n        if (notFilterPointGraphicsRef.length) {\n          notFilterPointGraphicsRef.forEach((item) => {\n            view.graphics.remove(item);\n          });\n          routerRef.current.notFilterPointGraphics = [];\n        }\n        /* 非查询条件上的点 */\n        const notFilterPointGraphics = [];\n        const filterPath = pointInfo\n          .filter((item) => item.value)\n          .map((item) => ({\n            ...item,\n            zmdm: get(item, \'value.key\', \'\')\n          }));\n        path.forEach((item) => {\n          const filterPathIndex = filterPath.findIndex((item2) => item2.zmdm === item.zmdm);\n          if (filterPathIndex === -1) {\n            /** 不在筛选条件里面的点 **/\n            const pointGraphic = new Graphic({\n              attributes: {\n                point: item,\n                path\n              },\n              geometry: {\n                type: \'point\',\n                longitude: +item.lon,\n                latitude: +item.lat\n              },\n              symbol: {\n                type: \'simple-marker\',\n                color: \'#fff\',\n                size: \'10px\',\n                outline: {\n                  color: \'#2c42af\',\n                  width: \'2px\'\n                }\n              },\n              popupTemplate: {\n                title: \\`\\${item.zm}\\`,\n                content: \\`经度：\\${item.lon}，纬度：\\${item.lat}\\`,\n                actions: showAddOrDelBtn\n                  ? [\n                      {\n                        title: \'添加\',\n                        id: \'add\',\n                        className: \'esri-icon-add-attachment\'\n                      }\n                    ]\n                  : []\n              }\n            });\n            notFilterPointGraphics.push(pointGraphic);\n            view.graphics.add(pointGraphic);\n            /** 不在筛选条件里面的点 **/\n          }\n        });\n\n        routerRef.current.notFilterPointGraphics = notFilterPointGraphics;\n        /** 画点 **/\n      })\n      .catch((err) => {\n        console.error(err);\n      });\n  }, [view, path, pointInfo, showAddOrDelBtn]);\n}`, `54958767584593750000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> useEffect<span class="token punctuation">,</span> useRef <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> loadModules <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'esri-loader\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token keyword">get</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'lodash\'</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 画地图上的非过滤条件上的点</span>\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">useDrawPoint</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> path<span class="token punctuation">,</span> pointInfo <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> view<span class="token punctuation">,</span> showAddOrDelBtn <span class="token operator">=</span> <span class="token boolean">true</span> <span class="token punctuation">}</span> <span class="token operator">=</span> props<span class="token punctuation">;</span>\n  <span class="token keyword">const</span> routerRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n    <span class="token comment">// 属于路径但不在过滤条件里面的点</span>\n    notFilterPointGraphics<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token comment">// https://developers.arcgis.com/javascript/latest/guide/display-point-line-and-polygon-graphics/</span>\n    <span class="token comment">// https://developers.arcgis.com/javascript/latest/sample-code/intro-graphics/index.html</span>\n    <span class="token function">loadModules</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'esri/Graphic\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">[</span>Graphic<span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token comment">/** 画点 **/</span>\n        <span class="token keyword">const</span> notFilterPointGraphicsRef <span class="token operator">=</span> routerRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span>notFilterPointGraphics<span class="token punctuation">;</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>notFilterPointGraphicsRef<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          notFilterPointGraphicsRef<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            view<span class="token punctuation">.</span>graphics<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n          routerRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span>notFilterPointGraphics <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n        <span class="token comment">/* 非查询条件上的点 */</span>\n        <span class="token keyword">const</span> notFilterPointGraphics <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n        <span class="token keyword">const</span> filterPath <span class="token operator">=</span> pointInfo\n          <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> item<span class="token punctuation">.</span>value<span class="token punctuation">)</span>\n          <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>\n            <span class="token operator">...</span>item<span class="token punctuation">,</span>\n            zmdm<span class="token punctuation">:</span> <span class="token keyword">get</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token string">\'value.key\'</span><span class="token punctuation">,</span> <span class="token string">\'\'</span><span class="token punctuation">)</span>\n          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        path<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n          <span class="token keyword">const</span> filterPathIndex <span class="token operator">=</span> filterPath<span class="token punctuation">.</span><span class="token function">findIndex</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item2</span><span class="token punctuation">)</span> <span class="token operator">=></span> item2<span class="token punctuation">.</span>zmdm <span class="token operator">===</span> item<span class="token punctuation">.</span>zmdm<span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token keyword">if</span> <span class="token punctuation">(</span>filterPathIndex <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token comment">/** 不在筛选条件里面的点 **/</span>\n            <span class="token keyword">const</span> pointGraphic <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Graphic</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n              attributes<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n                point<span class="token punctuation">:</span> item<span class="token punctuation">,</span>\n                path\n              <span class="token punctuation">}</span><span class="token punctuation">,</span>\n              geometry<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n                type<span class="token punctuation">:</span> <span class="token string">\'point\'</span><span class="token punctuation">,</span>\n                longitude<span class="token punctuation">:</span> <span class="token operator">+</span>item<span class="token punctuation">.</span>lon<span class="token punctuation">,</span>\n                latitude<span class="token punctuation">:</span> <span class="token operator">+</span>item<span class="token punctuation">.</span>lat\n              <span class="token punctuation">}</span><span class="token punctuation">,</span>\n              symbol<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n                type<span class="token punctuation">:</span> <span class="token string">\'simple-marker\'</span><span class="token punctuation">,</span>\n                color<span class="token punctuation">:</span> <span class="token string">\'#fff\'</span><span class="token punctuation">,</span>\n                size<span class="token punctuation">:</span> <span class="token string">\'10px\'</span><span class="token punctuation">,</span>\n                outline<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n                  color<span class="token punctuation">:</span> <span class="token string">\'#2c42af\'</span><span class="token punctuation">,</span>\n                  width<span class="token punctuation">:</span> <span class="token string">\'2px\'</span>\n                <span class="token punctuation">}</span>\n              <span class="token punctuation">}</span><span class="token punctuation">,</span>\n              popupTemplate<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n                title<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>item<span class="token punctuation">.</span>zm<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n                content<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">经度：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>item<span class="token punctuation">.</span>lon<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">，纬度：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>item<span class="token punctuation">.</span>lat<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n                actions<span class="token punctuation">:</span> showAddOrDelBtn\n                  <span class="token operator">?</span> <span class="token punctuation">[</span>\n                      <span class="token punctuation">{</span>\n                        title<span class="token punctuation">:</span> <span class="token string">\'添加\'</span><span class="token punctuation">,</span>\n                        id<span class="token punctuation">:</span> <span class="token string">\'add\'</span><span class="token punctuation">,</span>\n                        className<span class="token punctuation">:</span> <span class="token string">\'esri-icon-add-attachment\'</span>\n                      <span class="token punctuation">}</span>\n                    <span class="token punctuation">]</span>\n                  <span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n              <span class="token punctuation">}</span>\n            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            notFilterPointGraphics<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>pointGraphic<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            view<span class="token punctuation">.</span>graphics<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>pointGraphic<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token comment">/** 不在筛选条件里面的点 **/</span>\n          <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        routerRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span>notFilterPointGraphics <span class="token operator">=</span> notFilterPointGraphics<span class="token punctuation">;</span>\n        <span class="token comment">/** 画点 **/</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>view<span class="token punctuation">,</span> path<span class="token punctuation">,</span> pointInfo<span class="token punctuation">,</span> showAddOrDelBtn<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="画地图上的选中点"><a href="#%E7%94%BB%E5%9C%B0%E5%9B%BE%E4%B8%8A%E7%9A%84%E9%80%89%E4%B8%AD%E7%82%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>画地图上的选中点</h2>\n<p>渲染选中的站点，弹窗显示站点信息并显示删除按钮</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="72149211124171380000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import { useEffect, useRef } from \'react\';\nimport { loadModules } from \'esri-loader\';\nimport { get } from \'lodash\';\n\nimport startPositionIcon from \'./images/定位_起点.svg\';\nimport byPositionIcon from \'./images/定位_途点.svg\';\nimport endPositionIcon from \'./images/定位_终点.svg\';\nimport CircleIcon from \'./images/圆心.png\';\n\n// 画地图上过滤条件上的点\nexport default function useDrawStartPassEnd(props) {\n  const { path, pointInfo = [], view, showAddOrDelBtn = true } = props;\n  const routerRef = useRef({\n    // 过滤条件上的点\n    filterPointGraphics: []\n  });\n\n  useEffect(() => {\n    // https://developers.arcgis.com/javascript/latest/guide/display-point-line-and-polygon-graphics/\n    // https://developers.arcgis.com/javascript/latest/sample-code/intro-graphics/index.html\n    loadModules([\'esri/Graphic\'])\n      .then(([Graphic]) => {\n        /** 画点 **/\n        const filterPointGraphicsRef = routerRef.current.filterPointGraphics;\n        if (filterPointGraphicsRef.length) {\n          filterPointGraphicsRef.forEach((item) => {\n            const [pointGraphic, markerGraphic] = item;\n            view.graphics.removeMany([pointGraphic, markerGraphic]);\n          });\n          routerRef.current.filterPointGraphics = [];\n        }\n        /* 查询条件上的点 */\n        const filterPointGraphics = [];\n        const filterPath = pointInfo\n          .filter((item) => item.value)\n          .map((item) => ({\n            ...item,\n            zmdm: get(item, \'value.key\', \'\')\n          }));\n        path.forEach((item) => {\n          const filterPathIndex = filterPath.findIndex((item2) => item2.zmdm === item.zmdm);\n          if (filterPathIndex !== -1) {\n            /** 画起点、终点、途点 **/\n            let positionIcon = byPositionIcon;\n            if (filterPathIndex === 0) {\n              positionIcon = startPositionIcon;\n            } else if (filterPathIndex === filterPath.length - 1) {\n              positionIcon = endPositionIcon;\n            }\n            const markerGraphic = new Graphic({\n              geometry: {\n                type: \'point\',\n                longitude: +item.lon,\n                latitude: +item.lat\n              },\n              symbol: {\n                type: \'picture-marker\',\n                url: positionIcon,\n                yoffset: \'25px\',\n                width: \'32px\',\n                height: \'37px\'\n              }\n            });\n            /** 画起点、终点、途点 **/\n\n            /** 画查询条件里面的标记点 **/\n            const pointGraphic = new Graphic({\n              attributes: {\n                point: item\n              },\n              geometry: {\n                type: \'point\',\n                longitude: +item.lon,\n                latitude: +item.lat\n              },\n              symbol: {\n                type: \'picture-marker\',\n                url: CircleIcon,\n                width: \'20px\',\n                height: \'20px\'\n              },\n              popupTemplate: {\n                title: \\`\\${item.zm}：第\\${filterPathIndex + 1}站\\`,\n                content: \\`经度：\\${item.lon}，纬度：\\${item.lat}\\`,\n                actions:\n                  showAddOrDelBtn && filterPath.length > 2\n                    ? [\n                        {\n                          title: \'删除\',\n                          id: \'delete\',\n                          className: \'esri-icon-trash\'\n                        }\n                      ]\n                    : []\n              }\n            });\n            /** 画查询条件里面的标记点 **/\n            filterPointGraphics.push([pointGraphic, markerGraphic]);\n            // routerRef.current.filterPointGraphics = filterPointGraphics\n            view.graphics.addMany([pointGraphic, markerGraphic]);\n          }\n        });\n\n        routerRef.current.filterPointGraphics = filterPointGraphics;\n        /** 画点 **/\n      })\n      .catch((err) => {\n        console.error(err);\n      });\n  }, [view, path, pointInfo, showAddOrDelBtn]);\n}`, `72149211124171380000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> useEffect<span class="token punctuation">,</span> useRef <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> loadModules <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'esri-loader\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token keyword">get</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'lodash\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> startPositionIcon <span class="token keyword">from</span> <span class="token string">\'./images/定位_起点.svg\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> byPositionIcon <span class="token keyword">from</span> <span class="token string">\'./images/定位_途点.svg\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> endPositionIcon <span class="token keyword">from</span> <span class="token string">\'./images/定位_终点.svg\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> CircleIcon <span class="token keyword">from</span> <span class="token string">\'./images/圆心.png\'</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 画地图上过滤条件上的点</span>\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">useDrawStartPassEnd</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> path<span class="token punctuation">,</span> pointInfo <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> view<span class="token punctuation">,</span> showAddOrDelBtn <span class="token operator">=</span> <span class="token boolean">true</span> <span class="token punctuation">}</span> <span class="token operator">=</span> props<span class="token punctuation">;</span>\n  <span class="token keyword">const</span> routerRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n    <span class="token comment">// 过滤条件上的点</span>\n    filterPointGraphics<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token comment">// https://developers.arcgis.com/javascript/latest/guide/display-point-line-and-polygon-graphics/</span>\n    <span class="token comment">// https://developers.arcgis.com/javascript/latest/sample-code/intro-graphics/index.html</span>\n    <span class="token function">loadModules</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'esri/Graphic\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">[</span>Graphic<span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token comment">/** 画点 **/</span>\n        <span class="token keyword">const</span> filterPointGraphicsRef <span class="token operator">=</span> routerRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span>filterPointGraphics<span class="token punctuation">;</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>filterPointGraphicsRef<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          filterPointGraphicsRef<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            <span class="token keyword">const</span> <span class="token punctuation">[</span>pointGraphic<span class="token punctuation">,</span> markerGraphic<span class="token punctuation">]</span> <span class="token operator">=</span> item<span class="token punctuation">;</span>\n            view<span class="token punctuation">.</span>graphics<span class="token punctuation">.</span><span class="token function">removeMany</span><span class="token punctuation">(</span><span class="token punctuation">[</span>pointGraphic<span class="token punctuation">,</span> markerGraphic<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n          routerRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span>filterPointGraphics <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n        <span class="token comment">/* 查询条件上的点 */</span>\n        <span class="token keyword">const</span> filterPointGraphics <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n        <span class="token keyword">const</span> filterPath <span class="token operator">=</span> pointInfo\n          <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> item<span class="token punctuation">.</span>value<span class="token punctuation">)</span>\n          <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>\n            <span class="token operator">...</span>item<span class="token punctuation">,</span>\n            zmdm<span class="token punctuation">:</span> <span class="token keyword">get</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token string">\'value.key\'</span><span class="token punctuation">,</span> <span class="token string">\'\'</span><span class="token punctuation">)</span>\n          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        path<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n          <span class="token keyword">const</span> filterPathIndex <span class="token operator">=</span> filterPath<span class="token punctuation">.</span><span class="token function">findIndex</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item2</span><span class="token punctuation">)</span> <span class="token operator">=></span> item2<span class="token punctuation">.</span>zmdm <span class="token operator">===</span> item<span class="token punctuation">.</span>zmdm<span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token keyword">if</span> <span class="token punctuation">(</span>filterPathIndex <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token comment">/** 画起点、终点、途点 **/</span>\n            <span class="token keyword">let</span> positionIcon <span class="token operator">=</span> byPositionIcon<span class="token punctuation">;</span>\n            <span class="token keyword">if</span> <span class="token punctuation">(</span>filterPathIndex <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n              positionIcon <span class="token operator">=</span> startPositionIcon<span class="token punctuation">;</span>\n            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>filterPathIndex <span class="token operator">===</span> filterPath<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n              positionIcon <span class="token operator">=</span> endPositionIcon<span class="token punctuation">;</span>\n            <span class="token punctuation">}</span>\n            <span class="token keyword">const</span> markerGraphic <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Graphic</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n              geometry<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n                type<span class="token punctuation">:</span> <span class="token string">\'point\'</span><span class="token punctuation">,</span>\n                longitude<span class="token punctuation">:</span> <span class="token operator">+</span>item<span class="token punctuation">.</span>lon<span class="token punctuation">,</span>\n                latitude<span class="token punctuation">:</span> <span class="token operator">+</span>item<span class="token punctuation">.</span>lat\n              <span class="token punctuation">}</span><span class="token punctuation">,</span>\n              symbol<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n                type<span class="token punctuation">:</span> <span class="token string">\'picture-marker\'</span><span class="token punctuation">,</span>\n                url<span class="token punctuation">:</span> positionIcon<span class="token punctuation">,</span>\n                yoffset<span class="token punctuation">:</span> <span class="token string">\'25px\'</span><span class="token punctuation">,</span>\n                width<span class="token punctuation">:</span> <span class="token string">\'32px\'</span><span class="token punctuation">,</span>\n                height<span class="token punctuation">:</span> <span class="token string">\'37px\'</span>\n              <span class="token punctuation">}</span>\n            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token comment">/** 画起点、终点、途点 **/</span>\n\n            <span class="token comment">/** 画查询条件里面的标记点 **/</span>\n            <span class="token keyword">const</span> pointGraphic <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Graphic</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n              attributes<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n                point<span class="token punctuation">:</span> item\n              <span class="token punctuation">}</span><span class="token punctuation">,</span>\n              geometry<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n                type<span class="token punctuation">:</span> <span class="token string">\'point\'</span><span class="token punctuation">,</span>\n                longitude<span class="token punctuation">:</span> <span class="token operator">+</span>item<span class="token punctuation">.</span>lon<span class="token punctuation">,</span>\n                latitude<span class="token punctuation">:</span> <span class="token operator">+</span>item<span class="token punctuation">.</span>lat\n              <span class="token punctuation">}</span><span class="token punctuation">,</span>\n              symbol<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n                type<span class="token punctuation">:</span> <span class="token string">\'picture-marker\'</span><span class="token punctuation">,</span>\n                url<span class="token punctuation">:</span> CircleIcon<span class="token punctuation">,</span>\n                width<span class="token punctuation">:</span> <span class="token string">\'20px\'</span><span class="token punctuation">,</span>\n                height<span class="token punctuation">:</span> <span class="token string">\'20px\'</span>\n              <span class="token punctuation">}</span><span class="token punctuation">,</span>\n              popupTemplate<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n                title<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>item<span class="token punctuation">.</span>zm<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">：第</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>filterPathIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">站</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n                content<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">经度：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>item<span class="token punctuation">.</span>lon<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">，纬度：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>item<span class="token punctuation">.</span>lat<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n                actions<span class="token punctuation">:</span>\n                  showAddOrDelBtn <span class="token operator">&amp;&amp;</span> filterPath<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">2</span>\n                    <span class="token operator">?</span> <span class="token punctuation">[</span>\n                        <span class="token punctuation">{</span>\n                          title<span class="token punctuation">:</span> <span class="token string">\'删除\'</span><span class="token punctuation">,</span>\n                          id<span class="token punctuation">:</span> <span class="token string">\'delete\'</span><span class="token punctuation">,</span>\n                          className<span class="token punctuation">:</span> <span class="token string">\'esri-icon-trash\'</span>\n                        <span class="token punctuation">}</span>\n                      <span class="token punctuation">]</span>\n                    <span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n              <span class="token punctuation">}</span>\n            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token comment">/** 画查询条件里面的标记点 **/</span>\n            filterPointGraphics<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">[</span>pointGraphic<span class="token punctuation">,</span> markerGraphic<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token comment">// routerRef.current.filterPointGraphics = filterPointGraphics</span>\n            view<span class="token punctuation">.</span>graphics<span class="token punctuation">.</span><span class="token function">addMany</span><span class="token punctuation">(</span><span class="token punctuation">[</span>pointGraphic<span class="token punctuation">,</span> markerGraphic<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        routerRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span>filterPointGraphics <span class="token operator">=</span> filterPointGraphics<span class="token punctuation">;</span>\n        <span class="token comment">/** 画点 **/</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>view<span class="token punctuation">,</span> path<span class="token punctuation">,</span> pointInfo<span class="token punctuation">,</span> showAddOrDelBtn<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="设置悬浮文字"><a href="#%E8%AE%BE%E7%BD%AE%E6%82%AC%E6%B5%AE%E6%96%87%E5%AD%97" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>设置悬浮文字</h2>\n<p>设置鼠标轨迹监听事件，对站点、路线做悬浮文字提示处理</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="24607742615710015000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import { useEffect, useRef } from \'react\';\nimport { get, throttle } from \'lodash\';\n\n// 添加悬浮文字监听事件\nexport default function useShowHoverText(props) {\n  const { hoverNodeRef, view } = props;\n  const removePointerMoveEventRef = useRef(() => {});\n\n  useEffect(() => {\n    const handlePointMoveEvent = throttle((event) => {\n      if (!hoverNodeRef.current) {\n        return;\n      }\n      view.hitTest(event).then((response) => {\n        const type = get(response, \'results[0].graphic.geometry.type\');\n        const attributes = get(response, \'results[0].graphic.attributes\');\n        if (type === \'polyline\' && attributes) {\n          event.native.target.style = \'cursor: pointer\';\n          const xm = get(attributes, \'xm\');\n          hoverNodeRef.current.innerText = xm;\n          hoverNodeRef.current.style.left = \\`\\${event.x}px\\`;\n          hoverNodeRef.current.style.top = \\`\\${event.y}px\\`;\n          hoverNodeRef.current.style.display = \'block\';\n        } else if (type === \'point\' && attributes) {\n          event.native.target.style = \'cursor: pointer\';\n          const zm = get(attributes, \'point.zm\');\n          hoverNodeRef.current.innerText = zm;\n          hoverNodeRef.current.style.left = \\`\\${event.x - zm.length * 9}px\\`;\n          hoverNodeRef.current.style.top = \\`\\${event.y - 40}px\\`;\n          hoverNodeRef.current.style.display = \'block\';\n        } else {\n          hoverNodeRef.current.style.display = \'none\';\n          event.native.target.style = \'cursor: default\';\n        }\n      });\n    }, 200);\n\n    removePointerMoveEventRef.current();\n    const removePointerMoveEvent = view.on(\'pointer-move\', (event) => {\n      handlePointMoveEvent(event);\n    });\n    removePointerMoveEventRef.current = removePointerMoveEvent;\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, []);\n}`, `24607742615710015000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> useEffect<span class="token punctuation">,</span> useRef <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">,</span> throttle <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'lodash\'</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 添加悬浮文字监听事件</span>\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">useShowHoverText</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> hoverNodeRef<span class="token punctuation">,</span> view <span class="token punctuation">}</span> <span class="token operator">=</span> props<span class="token punctuation">;</span>\n  <span class="token keyword">const</span> removePointerMoveEventRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> handlePointMoveEvent <span class="token operator">=</span> <span class="token function">throttle</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hoverNodeRef<span class="token punctuation">.</span>current<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">return</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      view<span class="token punctuation">.</span><span class="token function">hitTest</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token keyword">const</span> type <span class="token operator">=</span> <span class="token keyword">get</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> <span class="token string">\'results[0].graphic.geometry.type\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">const</span> attributes <span class="token operator">=</span> <span class="token keyword">get</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> <span class="token string">\'results[0].graphic.attributes\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">\'polyline\'</span> <span class="token operator">&amp;&amp;</span> attributes<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          event<span class="token punctuation">.</span>native<span class="token punctuation">.</span>target<span class="token punctuation">.</span>style <span class="token operator">=</span> <span class="token string">\'cursor: pointer\'</span><span class="token punctuation">;</span>\n          <span class="token keyword">const</span> xm <span class="token operator">=</span> <span class="token keyword">get</span><span class="token punctuation">(</span>attributes<span class="token punctuation">,</span> <span class="token string">\'xm\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n          hoverNodeRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span>innerText <span class="token operator">=</span> xm<span class="token punctuation">;</span>\n          hoverNodeRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span>style<span class="token punctuation">.</span>left <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>event<span class="token punctuation">.</span>x<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n          hoverNodeRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span>style<span class="token punctuation">.</span>top <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>event<span class="token punctuation">.</span>y<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n          hoverNodeRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span>style<span class="token punctuation">.</span>display <span class="token operator">=</span> <span class="token string">\'block\'</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">\'point\'</span> <span class="token operator">&amp;&amp;</span> attributes<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          event<span class="token punctuation">.</span>native<span class="token punctuation">.</span>target<span class="token punctuation">.</span>style <span class="token operator">=</span> <span class="token string">\'cursor: pointer\'</span><span class="token punctuation">;</span>\n          <span class="token keyword">const</span> zm <span class="token operator">=</span> <span class="token keyword">get</span><span class="token punctuation">(</span>attributes<span class="token punctuation">,</span> <span class="token string">\'point.zm\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n          hoverNodeRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span>innerText <span class="token operator">=</span> zm<span class="token punctuation">;</span>\n          hoverNodeRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span>style<span class="token punctuation">.</span>left <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>event<span class="token punctuation">.</span>x <span class="token operator">-</span> zm<span class="token punctuation">.</span>length <span class="token operator">*</span> <span class="token number">9</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n          hoverNodeRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span>style<span class="token punctuation">.</span>top <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>event<span class="token punctuation">.</span>y <span class="token operator">-</span> <span class="token number">40</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n          hoverNodeRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span>style<span class="token punctuation">.</span>display <span class="token operator">=</span> <span class="token string">\'block\'</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n          hoverNodeRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span>style<span class="token punctuation">.</span>display <span class="token operator">=</span> <span class="token string">\'none\'</span><span class="token punctuation">;</span>\n          event<span class="token punctuation">.</span>native<span class="token punctuation">.</span>target<span class="token punctuation">.</span>style <span class="token operator">=</span> <span class="token string">\'cursor: default\'</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    removePointerMoveEventRef<span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> removePointerMoveEvent <span class="token operator">=</span> view<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'pointer-move\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token function">handlePointMoveEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    removePointerMoveEventRef<span class="token punctuation">.</span>current <span class="token operator">=</span> removePointerMoveEvent<span class="token punctuation">;</span>\n    <span class="token comment">// eslint-disable-next-line react-hooks/exhaustive-deps</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="设置删除、添加的监听事件"><a href="#%E8%AE%BE%E7%BD%AE%E5%88%A0%E9%99%A4%E3%80%81%E6%B7%BB%E5%8A%A0%E7%9A%84%E7%9B%91%E5%90%AC%E4%BA%8B%E4%BB%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>设置删除、添加的监听事件</h2>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="96124260861946480000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import { useEffect, useRef } from \'react\';\nimport { get } from \'lodash\';\nimport produce from \'immer\';\n\n// 设置删除、添加的监听事件\nexport default function useAddOrDelPoint(props) {\n  const { view, onPointInfoChange, pointInfo } = props;\n  const removeTriggerActionEventRef = useRef(() => {});\n\n  useEffect(() => {\n    const getFilterPointIndex = (point) => pointInfo.findIndex((item) => get(item, \'value.key\') === point.zmdm);\n\n    const handleAddPoint = () => {\n      const { point, path } = view.popup.viewModel.selectedFeature.attributes;\n      const state = produce(pointInfo, (draftState) => {\n        const filterIndex = getFilterPointIndex(point);\n        if (filterIndex !== -1) {\n          return;\n        }\n        const maxId = Math.max(...draftState.map((item) => item.id));\n        let insertIndex = 0;\n        const index = path.findIndex((item) => item.zmdm === point.zmdm);\n        // 向前查找\n        for (let i = index - 1; i >= 0; i--) {\n          const filterPointIndex = getFilterPointIndex(path[i]);\n          if (filterPointIndex !== -1) {\n            insertIndex = filterPointIndex + 1;\n            break;\n          }\n        }\n        draftState.splice(insertIndex, 0, {\n          id: maxId + 1,\n          value: {\n            key: point.zmdm,\n            label: point.zm\n          },\n          options: []\n        });\n      });\n      onPointInfoChange && onPointInfoChange(state);\n    };\n\n    const handleDeletePoint = () => {\n      const { point } = view.popup.viewModel.selectedFeature.attributes;\n      const state = produce(pointInfo, (draftState) => {\n        const index = getFilterPointIndex(point);\n        if (index !== -1) {\n          draftState.splice(index, 1);\n        }\n      });\n      onPointInfoChange && onPointInfoChange(state);\n    };\n\n    removeTriggerActionEventRef.current();\n    const removeTriggerActionEvent = view.popup.on(\'trigger-action\', (event) => {\n      const eventMap = {\n        add: handleAddPoint,\n        delete: handleDeletePoint\n      };\n      eventMap[event.action.id] && eventMap[event.action.id](event);\n      view.popup.close();\n    }).remove;\n    removeTriggerActionEventRef.current = removeTriggerActionEvent;\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [pointInfo]);\n}`, `96124260861946480000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> useEffect<span class="token punctuation">,</span> useRef <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token keyword">get</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'lodash\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> produce <span class="token keyword">from</span> <span class="token string">\'immer\'</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 设置删除、添加的监听事件</span>\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">useAddOrDelPoint</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> view<span class="token punctuation">,</span> onPointInfoChange<span class="token punctuation">,</span> pointInfo <span class="token punctuation">}</span> <span class="token operator">=</span> props<span class="token punctuation">;</span>\n  <span class="token keyword">const</span> removeTriggerActionEventRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> <span class="token function-variable function">getFilterPointIndex</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">point</span><span class="token punctuation">)</span> <span class="token operator">=></span> pointInfo<span class="token punctuation">.</span><span class="token function">findIndex</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">get</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token string">\'value.key\'</span><span class="token punctuation">)</span> <span class="token operator">===</span> point<span class="token punctuation">.</span>zmdm<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">const</span> <span class="token function-variable function">handleAddPoint</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> <span class="token punctuation">{</span> point<span class="token punctuation">,</span> path <span class="token punctuation">}</span> <span class="token operator">=</span> view<span class="token punctuation">.</span>popup<span class="token punctuation">.</span>viewModel<span class="token punctuation">.</span>selectedFeature<span class="token punctuation">.</span>attributes<span class="token punctuation">;</span>\n      <span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token function">produce</span><span class="token punctuation">(</span>pointInfo<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">draftState</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token keyword">const</span> filterIndex <span class="token operator">=</span> <span class="token function">getFilterPointIndex</span><span class="token punctuation">(</span>point<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>filterIndex <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          <span class="token keyword">return</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n        <span class="token keyword">const</span> maxId <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token operator">...</span>draftState<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> item<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">let</span> insertIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n        <span class="token keyword">const</span> index <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">findIndex</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> item<span class="token punctuation">.</span>zmdm <span class="token operator">===</span> point<span class="token punctuation">.</span>zmdm<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token comment">// 向前查找</span>\n        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> index <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          <span class="token keyword">const</span> filterPointIndex <span class="token operator">=</span> <span class="token function">getFilterPointIndex</span><span class="token punctuation">(</span>path<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token keyword">if</span> <span class="token punctuation">(</span>filterPointIndex <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            insertIndex <span class="token operator">=</span> filterPointIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>\n            <span class="token keyword">break</span><span class="token punctuation">;</span>\n          <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span>\n        draftState<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>insertIndex<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>\n          id<span class="token punctuation">:</span> maxId <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>\n          value<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n            key<span class="token punctuation">:</span> point<span class="token punctuation">.</span>zmdm<span class="token punctuation">,</span>\n            label<span class="token punctuation">:</span> point<span class="token punctuation">.</span>zm\n          <span class="token punctuation">}</span><span class="token punctuation">,</span>\n          options<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      onPointInfoChange <span class="token operator">&amp;&amp;</span> <span class="token function">onPointInfoChange</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">const</span> <span class="token function-variable function">handleDeletePoint</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> <span class="token punctuation">{</span> point <span class="token punctuation">}</span> <span class="token operator">=</span> view<span class="token punctuation">.</span>popup<span class="token punctuation">.</span>viewModel<span class="token punctuation">.</span>selectedFeature<span class="token punctuation">.</span>attributes<span class="token punctuation">;</span>\n      <span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token function">produce</span><span class="token punctuation">(</span>pointInfo<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">draftState</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token keyword">const</span> index <span class="token operator">=</span> <span class="token function">getFilterPointIndex</span><span class="token punctuation">(</span>point<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          draftState<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      onPointInfoChange <span class="token operator">&amp;&amp;</span> <span class="token function">onPointInfoChange</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n    removeTriggerActionEventRef<span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> removeTriggerActionEvent <span class="token operator">=</span> view<span class="token punctuation">.</span>popup<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'trigger-action\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> eventMap <span class="token operator">=</span> <span class="token punctuation">{</span>\n        add<span class="token punctuation">:</span> handleAddPoint<span class="token punctuation">,</span>\n        <span class="token keyword">delete</span><span class="token punctuation">:</span> handleDeletePoint\n      <span class="token punctuation">}</span><span class="token punctuation">;</span>\n      eventMap<span class="token punctuation">[</span>event<span class="token punctuation">.</span>action<span class="token punctuation">.</span>id<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> eventMap<span class="token punctuation">[</span>event<span class="token punctuation">.</span>action<span class="token punctuation">.</span>id<span class="token punctuation">]</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      view<span class="token punctuation">.</span>popup<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>remove<span class="token punctuation">;</span>\n    removeTriggerActionEventRef<span class="token punctuation">.</span>current <span class="token operator">=</span> removeTriggerActionEvent<span class="token punctuation">;</span>\n    <span class="token comment">// eslint-disable-next-line react-hooks/exhaustive-deps</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>pointInfo<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="实现效果"><a href="#%E5%AE%9E%E7%8E%B0%E6%95%88%E6%9E%9C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>实现效果</h2>\n<p><a target="_blank" href="/basic-map-73d1bc2751b9d5d59709b58e7e9472fa.gif">基本功能</a></p>\n<p><a target="_blank" href="/basic-map-2-38ff4e55afa0347ffbdcb8f646d77589.gif">基本功能-路线的粗细</a></p>\n<h1 id="修复路线未加载"><a href="#%E4%BF%AE%E5%A4%8D%E8%B7%AF%E7%BA%BF%E6%9C%AA%E5%8A%A0%E8%BD%BD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>修复路线未加载</h1>\n<p><code class="language-text">暂时未找到 view.graphics 完全加载时的方法，会造成白屏 bug</code> 的原因是在跳转页面时发现这个组件会有一定概率渲染不出路线，经过调试打印发现，是路线多次渲染造成的，需要解决多次渲染的问题，以下是跳转页面到这个组件：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2021-01-08-09-38-58-541a236902c530792c46ce26d1f1ecab-b8364.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 15.933669790915644%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAIAAAAcOLh5AAAACXBIWXMAAAsSAAALEgHS3X78AAAAi0lEQVQI103LuwrCQBSE4bz/g4iJacU+ElMoFhYWghBYWLPnMuesyQO4IgThL6aYrxJNy2LzjJzVXXIWd2Z+sZAou/HtSdsezQmHK3bDd6xVZok5FgmQW8GqSmZcMDG9PV0esumkHbS86z/ZDqhiDCGMQFJQYTARSSyTITmmMfL+zM1x+uG1ukd3zx+OrJv3XwSUFQAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2021 01 08 09 38 58" title="" data-src="/static/2021-01-08-09-38-58-541a236902c530792c46ce26d1f1ecab-fee1c.png" data-srcset="/static/2021-01-08-09-38-58-541a236902c530792c46ce26d1f1ecab-a67b7.png 200w,\n/static/2021-01-08-09-38-58-541a236902c530792c46ce26d1f1ecab-0b187.png 400w,\n/static/2021-01-08-09-38-58-541a236902c530792c46ce26d1f1ecab-fee1c.png 800w,\n/static/2021-01-08-09-38-58-541a236902c530792c46ce26d1f1ecab-b1a91.png 1200w,\n/static/2021-01-08-09-38-58-541a236902c530792c46ce26d1f1ecab-b8364.png 1387w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2021-01-08-09-39-28-67fff2d0694aad43c53f12a0955a72d4-8b0e1.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 294px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 90.47619047619047%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAIAAADUsmlHAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABi0lEQVQ4y5VT7VKDMBDk/V/GF/CP1lHbzlh1LLXVKVAoXy0Q0EASSuICLeIfaW92bnJJ9m7vCBrjgqRpHBMgCEJCMs4FY/wEwY6h6KE+KhjXlKShbzn2yjIW5loPPEPJXKmi9bKi8vB9DCuq5GlRr3ONBVecWsQfE28CiNyI3CkJZr45osk89qY7+yENn8PNvbe+ydMFTrED0ERH5fz1ZXp3ez0Zj2ZPj/O3WSmoUqWsUDZvfFEd8s73oSmlNhtH19+Xy4/V6tMwTJJm2RctywpHUjZQNY6h+t2pyYRgVMF+vw/DMI7j3W7nOE5RFO3tvsm/sYYYhO12Cz44SNHdG7Qj2WnM933XdVEZiRhjgylqMqrZto3ikA2PMIqic8mojIJd20KIy2R7ngcyZIOcpml/QsOy24Y7Qzooz7JsmIx7bmNt25CAESAFJJwlGzQQMGcs0AISnTswVG5lJ0kCzzm/YGCtbNBa2ZTS7jFd8KnahvFasVk1NkwGx7IsKEfbyAJv4P8wTST6n/wDJhQJeQFsEdMAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2021 01 08 09 39 28" title="" data-src="/static/2021-01-08-09-39-28-67fff2d0694aad43c53f12a0955a72d4-8b0e1.png" data-srcset="/static/2021-01-08-09-39-28-67fff2d0694aad43c53f12a0955a72d4-2d2ea.png 200w,\n/static/2021-01-08-09-39-28-67fff2d0694aad43c53f12a0955a72d4-8b0e1.png 294w" data-sizes="(max-width: 294px) 100vw, 294px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>如图所示这里 hooks 多次渲染是导致路线加载不出来的原因，需要修复依赖的数据多次改变的问题，使用 useMemo 修复</p>\n<h2 id="主入口文件-1"><a href="#%E4%B8%BB%E5%85%A5%E5%8F%A3%E6%96%87%E4%BB%B6-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>主入口文件</h2>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="38370038001986930000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import React, { useState, useEffect, useMemo } from \'react\';\nimport { setDefaultOptions } from \'esri-loader\';\n\nimport RouteDisplayLayer from \'./components/route-display-layer\';\nimport Map from \'./components/map\';\nimport { getConfig } from \'./api\';\n\nimport styles from \'./styles.less\';\n\nsetDefaultOptions({\n  css: \'/static-apps/mut/arcgis/esri/themes/light/main.css\',\n  url: \'/static-apps/mut/arcgis/init.js\'\n});\n\n/*\n  config: esri 三方库后端配置地址（外部配置）\n  height: 地图高度\n  onRef：map 的 ref 回调\n  settings： {\n    centerLon 地图中心经度\n    centerLat 地图中心纬度\n    zoom 缩放级别\n  }\n  pointInfo: 过滤条件的起点、终点、途径点渲染\n  onPointInfoChange: 过滤条件变化回调\n  goToCenter: 初次加载是否到中心点\n  isAddOrEdit: 是否显示添加删除按钮\n  path: 站点信息\n  route: 路线信息\n  transport: 运输信息\n*/\n\nexport { getConfig };\n\nexport default function RailwayMap(props) {\n  const { path, route } = props;\n  const [config, setConfig] = useState(props.config);\n\n  useEffect(() => {\n    const fetchConfig = async () => {\n      const data = await getConfig();\n      setConfig(data.result);\n    };\n    if (!config) {\n      fetchConfig();\n    }\n  }, [config]);\n\n  const { centerLon = 110, centerLat = 38, zoom = 5 } = props.settings || {};\n\n  const [map, setMap] = useState();\n  const [view, setView] = useState();\n\n  const isFloat = (number) => /^(-?\\d+)(\\.\\d+)?\\$/.test(number);\n\n  // 过滤掉没有经纬度结点或者经纬度为 0 的结点\n  const filterPath = useMemo(() => {\n    return path.filter((item) => isFloat(item.lat) && isFloat(item.lon) && +item.lat !== 0 && +item.lon !== 0);\n  }, [path]);\n\n  const filterRoute = useMemo(() => {\n    const getPointInfoByZmdm = (zmdm) => path.find((item) => item.zmdm === zmdm) || {};\n    const renderFilterRoute = [];\n    for (let i = 0; i < route.length; i++) {\n      // 补充缺失的线路，比如这种情况长沙-湘潭-武汉，长沙-湘潭段属于长湘线，湘潭到武汉属于湘武线\n      // 湘潭的经纬度为空，那么直接连起来的长沙 - 武汉叫长湘线\n      if (\n        getPointInfoByZmdm(route[i].zmdm).lon &&\n        getPointInfoByZmdm(route[i].zmdm).lat &&\n        (!getPointInfoByZmdm(route[i].next_zmdm).lon || !getPointInfoByZmdm(route[i].next_zmdm).lat)\n      ) {\n        const { zm: startZm, zmdm: startZmdm, xm } = route[i];\n\n        // 累加缺失的站点的里程数\n        let distance = 0;\n        if (route[i].czjl) {\n          distance = route[i].czjl;\n        }\n\n        let index = null;\n        for (let j = i + 1; j < route.length; j++) {\n          if (route[j].czjl) {\n            distance += route[j].czjl;\n          }\n          // 这里需要找到第一个终点站经纬度不为零的站点的下标，以此来进行缺失经纬度站点的合并\n          if (getPointInfoByZmdm(route[j].next_zmdm).lon && getPointInfoByZmdm(route[j].next_zmdm).lat) {\n            index = j;\n            break;\n          }\n        }\n        if (!index) {\n          // eslint-disable-next-line no-continue\n          continue;\n        }\n        const { next_zmdm: endZmdm, next_zm: endZm } = route[index];\n        renderFilterRoute.push({\n          zmdm: startZmdm,\n          zm: startZm,\n          next_zmdm: endZmdm,\n          next_zm: endZm,\n          xm,\n          czjl: distance\n        });\n        i = index;\n      }\n\n      // 经纬度都有的结点直接插入\n      if (\n        getPointInfoByZmdm(route[i].zmdm).lon &&\n        getPointInfoByZmdm(route[i].zmdm).lat &&\n        getPointInfoByZmdm(route[i].next_zmdm).lon &&\n        getPointInfoByZmdm(route[i].next_zmdm).lat\n      ) {\n        renderFilterRoute.push(route[i]);\n      }\n    }\n    return renderFilterRoute;\n  }, [route, path]);\n\n  if (!config) {\n    return null;\n  }\n\n  return (\n    <div className={styles.container}>\n      <Map\n        {...props}\n        config={config}\n        viewProperties={{\n          zoom: +zoom,\n          center: [+centerLon, +centerLat]\n        }}\n        setMap={setMap}\n        setView={setView}\n        view={view}\n      />\n      {map && view && <RouteDisplayLayer {...props} path={filterPath} route={filterRoute} map={map} view={view} />}\n    </div>\n  );\n}`, `38370038001986930000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{54-59,61-118}"\n              >\n                <span class="gatsby-code-button-language">js{54-59,61-118}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useState<span class="token punctuation">,</span> useEffect<span class="token punctuation">,</span> useMemo <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> setDefaultOptions <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'esri-loader\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> RouteDisplayLayer <span class="token keyword">from</span> <span class="token string">\'./components/route-display-layer\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> Map <span class="token keyword">from</span> <span class="token string">\'./components/map\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> getConfig <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'./api\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> styles <span class="token keyword">from</span> <span class="token string">\'./styles.less\'</span><span class="token punctuation">;</span>\n\n<span class="token function">setDefaultOptions</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n  css<span class="token punctuation">:</span> <span class="token string">\'/static-apps/mut/arcgis/esri/themes/light/main.css\'</span><span class="token punctuation">,</span>\n  url<span class="token punctuation">:</span> <span class="token string">\'/static-apps/mut/arcgis/init.js\'</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">/*</span>\n<span class="token comment">  config: esri 三方库后端配置地址（外部配置）</span>\n<span class="token comment">  height: 地图高度</span>\n<span class="token comment">  onRef：map 的 ref 回调</span>\n<span class="token comment">  settings： {</span>\n<span class="token comment">    centerLon 地图中心经度</span>\n<span class="token comment">    centerLat 地图中心纬度</span>\n<span class="token comment">    zoom 缩放级别</span>\n<span class="token comment">  }</span>\n<span class="token comment">  pointInfo: 过滤条件的起点、终点、途径点渲染</span>\n<span class="token comment">  onPointInfoChange: 过滤条件变化回调</span>\n<span class="token comment">  goToCenter: 初次加载是否到中心点</span>\n<span class="token comment">  isAddOrEdit: 是否显示添加删除按钮</span>\n<span class="token comment">  path: 站点信息</span>\n<span class="token comment">  route: 路线信息</span>\n<span class="token comment">  transport: 运输信息</span>\n<span class="token comment">*/</span>\n\n<span class="token keyword">export</span> <span class="token punctuation">{</span> getConfig <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">RailwayMap</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> path<span class="token punctuation">,</span> route <span class="token punctuation">}</span> <span class="token operator">=</span> props<span class="token punctuation">;</span>\n  <span class="token keyword">const</span> <span class="token punctuation">[</span>config<span class="token punctuation">,</span> setConfig<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> <span class="token function-variable function">fetchConfig</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token function">setConfig</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>config<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token function">fetchConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>config<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> centerLon <span class="token operator">=</span> <span class="token number">110</span><span class="token punctuation">,</span> centerLat <span class="token operator">=</span> <span class="token number">38</span><span class="token punctuation">,</span> zoom <span class="token operator">=</span> <span class="token number">5</span> <span class="token punctuation">}</span> <span class="token operator">=</span> props<span class="token punctuation">.</span>settings <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> <span class="token punctuation">[</span>map<span class="token punctuation">,</span> setMap<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> <span class="token punctuation">[</span>view<span class="token punctuation">,</span> setView<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line">  <span class="token keyword">const</span> <span class="token function-variable function">isFloat</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">number</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token regex">/^(-?\\d+)(\\.\\d+)?$/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line">  <span class="token comment">// 过滤掉没有经纬度结点或者经纬度为 0 的结点</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">const</span> filterPath <span class="token operator">=</span> <span class="token function">useMemo</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    <span class="token keyword">return</span> path<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">isFloat</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>lat<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isFloat</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>lon<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">+</span>item<span class="token punctuation">.</span>lat <span class="token operator">!==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">+</span>item<span class="token punctuation">.</span>lon <span class="token operator">!==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>path<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="gatsby-highlight-code-line">  <span class="token keyword">const</span> filterRoute <span class="token operator">=</span> <span class="token function">useMemo</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    <span class="token keyword">const</span> <span class="token function-variable function">getPointInfoByZmdm</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">zmdm</span><span class="token punctuation">)</span> <span class="token operator">=></span> path<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> item<span class="token punctuation">.</span>zmdm <span class="token operator">===</span> zmdm<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    <span class="token keyword">const</span> renderFilterRoute <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> route<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      <span class="token comment">// 补充缺失的线路，比如这种情况长沙-湘潭-武汉，长沙-湘潭段属于长湘线，湘潭到武汉属于湘武线</span></span><span class="gatsby-highlight-code-line">      <span class="token comment">// 湘潭的经纬度为空，那么直接连起来的长沙 - 武汉叫长湘线</span></span><span class="gatsby-highlight-code-line">      <span class="token keyword">if</span> <span class="token punctuation">(</span></span><span class="gatsby-highlight-code-line">        <span class="token function">getPointInfoByZmdm</span><span class="token punctuation">(</span>route<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>zmdm<span class="token punctuation">)</span><span class="token punctuation">.</span>lon <span class="token operator">&amp;&amp;</span></span><span class="gatsby-highlight-code-line">        <span class="token function">getPointInfoByZmdm</span><span class="token punctuation">(</span>route<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>zmdm<span class="token punctuation">)</span><span class="token punctuation">.</span>lat <span class="token operator">&amp;&amp;</span></span><span class="gatsby-highlight-code-line">        <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">getPointInfoByZmdm</span><span class="token punctuation">(</span>route<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>next_zmdm<span class="token punctuation">)</span><span class="token punctuation">.</span>lon <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">getPointInfoByZmdm</span><span class="token punctuation">(</span>route<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>next_zmdm<span class="token punctuation">)</span><span class="token punctuation">.</span>lat<span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line">      <span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">        <span class="token keyword">const</span> <span class="token punctuation">{</span> zm<span class="token punctuation">:</span> startZm<span class="token punctuation">,</span> zmdm<span class="token punctuation">:</span> startZmdm<span class="token punctuation">,</span> xm <span class="token punctuation">}</span> <span class="token operator">=</span> route<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line">        <span class="token comment">// 累加缺失的站点的里程数</span></span><span class="gatsby-highlight-code-line">        <span class="token keyword">let</span> distance <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>route<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>czjl<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">          distance <span class="token operator">=</span> route<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>czjl<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">        <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line">        <span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> j <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> route<span class="token punctuation">.</span>length<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">          <span class="token keyword">if</span> <span class="token punctuation">(</span>route<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>czjl<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">            distance <span class="token operator">+=</span> route<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>czjl<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">          <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">          <span class="token comment">// 这里需要找到第一个终点站经纬度不为零的站点的下标，以此来进行缺失经纬度站点的合并</span></span><span class="gatsby-highlight-code-line">          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getPointInfoByZmdm</span><span class="token punctuation">(</span>route<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>next_zmdm<span class="token punctuation">)</span><span class="token punctuation">.</span>lon <span class="token operator">&amp;&amp;</span> <span class="token function">getPointInfoByZmdm</span><span class="token punctuation">(</span>route<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>next_zmdm<span class="token punctuation">)</span><span class="token punctuation">.</span>lat<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">            index <span class="token operator">=</span> j<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">            <span class="token keyword">break</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">          <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">        <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>index<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">          <span class="token comment">// eslint-disable-next-line no-continue</span></span><span class="gatsby-highlight-code-line">          <span class="token keyword">continue</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">        <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">        <span class="token keyword">const</span> <span class="token punctuation">{</span> next_zmdm<span class="token punctuation">:</span> endZmdm<span class="token punctuation">,</span> next_zm<span class="token punctuation">:</span> endZm <span class="token punctuation">}</span> <span class="token operator">=</span> route<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">        renderFilterRoute<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">          zmdm<span class="token punctuation">:</span> startZmdm<span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">          zm<span class="token punctuation">:</span> startZm<span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">          next_zmdm<span class="token punctuation">:</span> endZmdm<span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">          next_zm<span class="token punctuation">:</span> endZm<span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">          xm<span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">          czjl<span class="token punctuation">:</span> distance</span><span class="gatsby-highlight-code-line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">        i <span class="token operator">=</span> index<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">      <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line">      <span class="token comment">// 经纬度都有的结点直接插入</span></span><span class="gatsby-highlight-code-line">      <span class="token keyword">if</span> <span class="token punctuation">(</span></span><span class="gatsby-highlight-code-line">        <span class="token function">getPointInfoByZmdm</span><span class="token punctuation">(</span>route<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>zmdm<span class="token punctuation">)</span><span class="token punctuation">.</span>lon <span class="token operator">&amp;&amp;</span></span><span class="gatsby-highlight-code-line">        <span class="token function">getPointInfoByZmdm</span><span class="token punctuation">(</span>route<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>zmdm<span class="token punctuation">)</span><span class="token punctuation">.</span>lat <span class="token operator">&amp;&amp;</span></span><span class="gatsby-highlight-code-line">        <span class="token function">getPointInfoByZmdm</span><span class="token punctuation">(</span>route<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>next_zmdm<span class="token punctuation">)</span><span class="token punctuation">.</span>lon <span class="token operator">&amp;&amp;</span></span><span class="gatsby-highlight-code-line">        <span class="token function">getPointInfoByZmdm</span><span class="token punctuation">(</span>route<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>next_zmdm<span class="token punctuation">)</span><span class="token punctuation">.</span>lat</span><span class="gatsby-highlight-code-line">      <span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">        renderFilterRoute<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>route<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">      <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">    <span class="token keyword">return</span> renderFilterRoute<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>route<span class="token punctuation">,</span> path<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>config<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">return</span> <span class="token punctuation">(</span>\n    <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>container<span class="token punctuation">}</span><span class="token operator">></span>\n      <span class="token operator">&lt;</span>Map\n        <span class="token punctuation">{</span><span class="token operator">...</span>props<span class="token punctuation">}</span>\n        config<span class="token operator">=</span><span class="token punctuation">{</span>config<span class="token punctuation">}</span>\n        viewProperties<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>\n          zoom<span class="token punctuation">:</span> <span class="token operator">+</span>zoom<span class="token punctuation">,</span>\n          center<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token operator">+</span>centerLon<span class="token punctuation">,</span> <span class="token operator">+</span>centerLat<span class="token punctuation">]</span>\n        <span class="token punctuation">}</span><span class="token punctuation">}</span>\n        setMap<span class="token operator">=</span><span class="token punctuation">{</span>setMap<span class="token punctuation">}</span>\n        setView<span class="token operator">=</span><span class="token punctuation">{</span>setView<span class="token punctuation">}</span>\n        view<span class="token operator">=</span><span class="token punctuation">{</span>view<span class="token punctuation">}</span>\n      <span class="token operator">/</span><span class="token operator">></span>\n      <span class="token punctuation">{</span>map <span class="token operator">&amp;&amp;</span> view <span class="token operator">&amp;&amp;</span> <span class="token operator">&lt;</span>RouteDisplayLayer <span class="token punctuation">{</span><span class="token operator">...</span>props<span class="token punctuation">}</span> path<span class="token operator">=</span><span class="token punctuation">{</span>filterPath<span class="token punctuation">}</span> route<span class="token operator">=</span><span class="token punctuation">{</span>filterRoute<span class="token punctuation">}</span> map<span class="token operator">=</span><span class="token punctuation">{</span>map<span class="token punctuation">}</span> view<span class="token operator">=</span><span class="token punctuation">{</span>view<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">}</span>\n    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="传入的参数文件"><a href="#%E4%BC%A0%E5%85%A5%E7%9A%84%E5%8F%82%E6%95%B0%E6%96%87%E4%BB%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>传入的参数文件</h2>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="34608910689811403000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import React, { useMemo } from \'react\';\nimport _ from \'lodash\';\nimport RailwayMap from \'@/common/railway-map\';\n\nexport default function RailwayMapDisplay({ data, config, index }: any) {\n  const path = _.get(data, \\`[\\${index}].result.path\\`, []);\n  const pointInfo = _.get(data, \\`[\\${index}].filter.pointInfo\\`, []);\n  const filterPointInfo = useMemo(\n    () =>\n      pointInfo.map((item: any) => ({\n        value: {\n          key: item.zmdm,\n          label: item.zm\n        }\n      })),\n    [pointInfo]\n  );\n  return (\n    config && (\n      <RailwayMap\n        path={path}\n        route={_.get(data, \\`[\\${index}].result.route\\`, [])}\n        transport={_.get(data, \\`[\\${index}].result.transport\\`, [])}\n        height={240}\n        goToCenter\n        showAddOrDelBtn={false}\n        showLineInfo={false}\n        config={config}\n        pointInfo={filterPointInfo}\n      />\n    )\n  );\n}`, `34608910689811403000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{8-17}"\n              >\n                <span class="gatsby-code-button-language">js{8-17}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useMemo <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> _ <span class="token keyword">from</span> <span class="token string">\'lodash\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> RailwayMap <span class="token keyword">from</span> <span class="token string">\'@/common/railway-map\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">RailwayMapDisplay</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> data<span class="token punctuation">,</span> config<span class="token punctuation">,</span> index <span class="token punctuation">}</span><span class="token punctuation">:</span> any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> path <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>index<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">].result.path</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> pointInfo <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>index<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">].filter.pointInfo</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line">  <span class="token keyword">const</span> filterPointInfo <span class="token operator">=</span> <span class="token function">useMemo</span><span class="token punctuation">(</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span></span><span class="gatsby-highlight-code-line">      pointInfo<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">:</span> any</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">        value<span class="token punctuation">:</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">          key<span class="token punctuation">:</span> item<span class="token punctuation">.</span>zmdm<span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">          label<span class="token punctuation">:</span> item<span class="token punctuation">.</span>zm</span><span class="gatsby-highlight-code-line">        <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">[</span>pointInfo<span class="token punctuation">]</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">)</span><span class="token punctuation">;</span></span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>\n    config <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>\n      <span class="token operator">&lt;</span>RailwayMap\n        path<span class="token operator">=</span><span class="token punctuation">{</span>path<span class="token punctuation">}</span>\n        route<span class="token operator">=</span><span class="token punctuation">{</span>_<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>index<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">].result.route</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">}</span>\n        transport<span class="token operator">=</span><span class="token punctuation">{</span>_<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>index<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">].result.transport</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">}</span>\n        height<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">240</span><span class="token punctuation">}</span>\n        goToCenter\n        showAddOrDelBtn<span class="token operator">=</span><span class="token punctuation">{</span><span class="token boolean">false</span><span class="token punctuation">}</span>\n        showLineInfo<span class="token operator">=</span><span class="token punctuation">{</span><span class="token boolean">false</span><span class="token punctuation">}</span>\n        config<span class="token operator">=</span><span class="token punctuation">{</span>config<span class="token punctuation">}</span>\n        pointInfo<span class="token operator">=</span><span class="token punctuation">{</span>filterPointInfo<span class="token punctuation">}</span>\n      <span class="token operator">/</span><span class="token operator">></span>\n    <span class="token punctuation">)</span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="修复效果"><a href="#%E4%BF%AE%E5%A4%8D%E6%95%88%E6%9E%9C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>修复效果</h2>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2021-01-08-10-20-28-b27a7a497357ec134b49603a98037a97-60e1b.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 17.050359712230218%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAIAAAAcOLh5AAAACXBIWXMAAAsSAAALEgHS3X78AAAAm0lEQVQI1z3LuQrCQBRG4bz/e4hG4wIWdhbiZBMFQTTgRpQs473zz2RieqcIwlec5nisZPfVrUVjYQxbq4wmoorAWa7Ol+c2vg+FnoRYHTAOe77APNGehiQqjVEK0s2OUrK1dMzK9T7v2o/IMNhQEKmRgB/2XC9S7RXFqyrfgAQIYK2Z2LU83SRz/Sh4uaNA1LME0xjBX4T02vwAD1ya+fvb5GcAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2021 01 08 10 20 28" title="" data-src="/static/2021-01-08-10-20-28-b27a7a497357ec134b49603a98037a97-fee1c.png" data-srcset="/static/2021-01-08-10-20-28-b27a7a497357ec134b49603a98037a97-a67b7.png 200w,\n/static/2021-01-08-10-20-28-b27a7a497357ec134b49603a98037a97-0b187.png 400w,\n/static/2021-01-08-10-20-28-b27a7a497357ec134b49603a98037a97-fee1c.png 800w,\n/static/2021-01-08-10-20-28-b27a7a497357ec134b49603a98037a97-b1a91.png 1200w,\n/static/2021-01-08-10-20-28-b27a7a497357ec134b49603a98037a97-60e1b.png 1390w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2021-01-08-10-20-47-30c6439fd3893d4c388636f257861a11-ce56f.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 188px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 131.38297872340425%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAaCAIAAAA44esqAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACK0lEQVQ4y4WUyXLCQAxE8//fAEfOnPgCzoRidbGbfd9iY3bIY5oQY2xQlafksaVWtzTzdb1eL5fLbrdbr9ee5202m+VyOZ1OXddl//rWvngOh0O73a5Wq91ut1wul0qlfD6fy+U+B5+NjcdjggeDwWw2I8VisRgOh+Dzx+l0OkfYDfl4PCaTyVgsxppIJOLxeDqdTqVSlCBS75DFmRSs2+0W2qvVynEcHF5B5lMk8n6/bzab8CwUCt/GGo1GJpOxLAsJLGNkea3ihkxuNCM9apPoZExo2tE/4chSG4YgVyoVqQ04PuIVi0UcGIUg804O6Hl/5hrDIYC8P8Yo5PJid7VpjBjatk3PeAW51+t9HhL4IC+9ZcgQmfYCxQ7l8PXBMBJ5Pp9DG7TRaAQ44uOwQwp/fCDFPXgymTBerGShWo03FuhQEJmHsqkTqE6nQzApiGdgIdJqtRCcHcohO0L6U9yR+ZtSWZGqVquxEsbf/X6ffejYxhDFX8i9VXTlIRUOUAIJWIhgNJOsGkNggdLA+EfiERAynlTOGOpUAK4V/tCmBA1J5HjCqmgsm81yDQCOU6/XGUzKYWwiD4aM3IDoAOicYI+C3x1JkIGCJyAcSXoGbYT4fBnIwERzwXIqgH1zAT1xpqtiK2TxpBA003iGlvB/GWAg48MCWNFmVQz7ig9BhiQ4ugPQXBew7iYMzVnZpHNPEyadmTsOg2OMUlk5TzCnQ3zC15VAaX7wX3ZWxWMJ/MgpAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2021 01 08 10 20 47" title="" data-src="/static/2021-01-08-10-20-47-30c6439fd3893d4c388636f257861a11-ce56f.png" data-srcset="/static/2021-01-08-10-20-47-30c6439fd3893d4c388636f257861a11-ce56f.png 188w" data-sizes="(max-width: 188px) 100vw, 188px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>',
id:"/home/runner/work/GatsbyBlog/GatsbyBlog/blog/基于arcgis地图组件的搭建部署/index.md absPath of file >>> MarkdownRemark",timeToRead:30,frontmatter:{date:"2021-04-23 18:53:54",path:"/arcgis-map-component-build-deploy/",tags:"前端, arcgis, 地图, 预研",title:"基于arcgis地图组件的搭建部署",draft:null}}],length:37,tag:"预研",pagesSum:8,page:4}}}});