---
title: æ·±å…¥ç†è§£ Babel
date: 2021-7-26 23:10:50
categories:
  - å‰ç«¯
tags: å‰ç«¯, Babel, å‰ç«¯æ„å»ºå·¥å…·
path: /deep-learn-babel/
---

# å¤„ç†æµç¨‹

![](res/2021-07-26-23-11-37.png)

é¦–å…ˆä»æºç è§£æ(Parsing)å¼€å§‹ï¼Œè§£æåŒ…å«äº†ä¸¤ä¸ªæ­¥éª¤

## è¯æ³•è§£æ(Lexical Analysis)

è¯æ³•è§£æå™¨(Tokenizer)åœ¨è¿™ä¸ªé˜¶æ®µå°†å­—ç¬¦ä¸²å½¢å¼çš„ä»£ç è½¬æ¢ä¸º Tokens(ä»¤ç‰Œ)ã€‚Tokens å¯ä»¥è§†ä½œæ˜¯ä¸€äº›è¯­æ³•ç‰‡æ®µç»„æˆçš„æ•°ç»„ã€‚ä¾‹å¦‚ `for (const item of items) {}` è¯æ³•è§£æåçš„ç»“æœå¦‚ä¸‹:

![](res/2021-07-26-23-14-34.png)

ä»ä¸Šå›¾å¯ä»¥çœ‹ï¼Œæ¯ä¸ª Token ä¸­åŒ…å«äº†è¯­æ³•ç‰‡æ®µã€ä½ç½®ä¿¡æ¯ã€ä»¥åŠä¸€äº›ç±»å‹ä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯æœ‰åŠ©äºåç»­çš„è¯­æ³•åˆ†æã€‚

## è¯­æ³•è§£æ(Syntactic Analysis)

è¿™ä¸ªé˜¶æ®µè¯­æ³•è§£æå™¨(Parser)ä¼šæŠŠ Tokens è½¬æ¢ä¸ºæŠ½è±¡è¯­æ³•æ ‘(Abstract Syntax Treeï¼ŒAST)

AST å°±æ˜¯ä¸€æ£µå¯¹è±¡æ ‘ï¼Œç”¨æ¥è¡¨ç¤ºä»£ç çš„è¯­æ³•ç»“æ„ï¼Œä¾‹å¦‚ `console.log('hello world')` ä¼šè§£ææˆä¸º

![](res/2021-07-26-23-16-37.png)

Programã€CallExpressionã€Identifier è¿™äº›éƒ½æ˜¯èŠ‚ç‚¹çš„ç±»å‹ï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½æ˜¯ä¸€ä¸ªæœ‰æ„ä¹‰çš„è¯­æ³•å•å…ƒã€‚è¿™äº›èŠ‚ç‚¹ç±»å‹å®šä¹‰äº†ä¸€äº›å±æ€§æ¥æè¿°èŠ‚ç‚¹çš„ä¿¡æ¯ã€‚

JavaScript çš„è¯­æ³•è¶Šæ¥è¶Šå¤æ‚ï¼Œè€Œä¸” Babel é™¤äº†æ”¯æŒæœ€æ–°çš„ JavaScript è§„èŒƒè¯­æ³•ï¼Œè¿˜æ”¯æŒ JSXã€Flowã€ç°åœ¨è¿˜æœ‰ Typescriptã€‚æƒ³è±¡ä¸€ä¸‹ AST çš„èŠ‚ç‚¹ç±»å‹æœ‰å¤šå°‘ï¼Œå…¶å®æˆ‘ä»¬ä¸éœ€è¦å»è®°ä½è¿™ä¹ˆå¤šç±»å‹ã€ä¹Ÿè®°ä¸ä½ã€‚æ’ä»¶å¼€å‘è€…ä¼šåˆ©ç”¨ ASTExplorer æ¥å®¡æŸ¥è§£æåçš„ AST æ ‘ï¼Œéå¸¸å¼ºå¤§ã€‚

AST æ˜¯ Babel è½¬è¯‘çš„æ ¸å¿ƒæ•°æ®ç»“æ„ï¼Œåç»­çš„æ“ä½œéƒ½ä¾èµ–äº ASTã€‚

## è½¬æ¢(Transform)

è½¬æ¢é˜¶æ®µä¼šå¯¹ AST è¿›è¡Œéå†ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­å¯¹èŠ‚ç‚¹è¿›è¡Œå¢åˆ æŸ¥æ”¹ã€‚Babel æ‰€æœ‰æ’ä»¶éƒ½æ˜¯åœ¨è¿™ä¸ªé˜¶æ®µå·¥ä½œï¼Œæ¯”å¦‚è¯­æ³•è½¬æ¢ã€ä»£ç å‹ç¼©ã€‚

Javascript In Javascript Outï¼Œæœ€åé˜¶æ®µè¿˜æ˜¯è¦æŠŠ AST è½¬æ¢å›å­—ç¬¦ä¸²å½¢å¼çš„ Javascriptï¼ŒåŒæ—¶è¿™ä¸ªé˜¶æ®µè¿˜ä¼šç”Ÿæˆ Source Mapã€‚

# Babel çš„æ¶æ„

Babel å’Œ Webpack ä¸ºäº†é€‚åº”å¤æ‚çš„å®šåˆ¶éœ€æ±‚å’Œé¢‘ç¹çš„åŠŸèƒ½å˜åŒ–ï¼Œéƒ½ä½¿ç”¨äº†[å¾®å†…æ ¸](https://juejin.im/post/5d7ffad551882545ff173083#heading-10)çš„æ¶æ„é£æ ¼ã€‚ä¹Ÿå°±æ˜¯è¯´å®ƒä»¬çš„æ ¸å¿ƒéå¸¸å°ï¼Œå¤§éƒ¨åˆ†åŠŸèƒ½éƒ½æ˜¯é€šè¿‡æ’ä»¶æ‰©å±•å®ç°çš„ã€‚

æ‰€ä»¥ç®€å•åœ°äº†è§£ä¸€ä¸‹ Babel çš„æ¶æ„å’Œä¸€äº›åŸºæœ¬æ¦‚å¿µï¼Œå¯¹åç»­æ–‡ç« å†…å®¹çš„ç†è§£ï¼Œä»¥åŠ Babel çš„ä½¿ç”¨è¿˜æ˜¯æœ‰å¸®åŠ©çš„ã€‚

![](res/2021-07-26-23-23-10.png)

Babel æ˜¯ä¸€ä¸ª [MonoRepo](https://github.com/lerna/lerna) é¡¹ç›®ï¼Œä¸è¿‡ç»„ç»‡éå¸¸æ¸…æ™°ï¼Œä¸‹é¢å°±æºç ä¸Šæˆ‘ä»¬èƒ½çœ‹åˆ°çš„æ¨¡å—è¿›è¡Œä¸€ä¸‹åˆ†ç±»ï¼Œé…åˆä¸Šé¢çš„æ¶æ„å›¾è®©ä½ å¯¹ Babel æœ‰ä¸ªå¤§æ¦‚çš„è®¤è¯†:

## æ ¸å¿ƒ

@babel/core è¿™ä¹Ÿæ˜¯ä¸Šé¢è¯´çš„å¾®å†…æ ¸æ¶æ„ä¸­çš„å†…æ ¸ã€‚å¯¹äº Babel æ¥è¯´ï¼Œè¿™ä¸ªå†…æ ¸ä¸»è¦å¹²è¿™äº›äº‹æƒ…

- åŠ è½½å’Œå¤„ç†é…ç½®(config)
- åŠ è½½æ’ä»¶
- è°ƒç”¨ Parser è¿›è¡Œè¯­æ³•è§£æï¼Œç”Ÿæˆ AST
- è°ƒç”¨ Traverser éå† ASTï¼Œå¹¶ä½¿ç”¨è®¿é—®è€…æ¨¡å¼åº”ç”¨æ’ä»¶å¯¹ AST è¿›è¡Œè½¬æ¢
- ç”Ÿæˆä»£ç ï¼ŒåŒ…æ‹¬ SourceMap è½¬æ¢å’Œæºä»£ç ç”Ÿæˆ

## æ ¸å¿ƒå‘¨è¾¹æ”¯æ’‘

### Parser(@babel/parser)

å°†æºä»£ç è§£æä¸º AST å°±é å®ƒäº†ã€‚ å®ƒå·²ç»å†…ç½®æ”¯æŒå¾ˆå¤šè¯­æ³•ï¼Œä¾‹å¦‚ JSXã€Typescriptã€Flow ä»¥åŠæœ€æ–°çš„ ECMAScript è§„èŒƒã€‚ç›®å‰ä¸ºäº†æ‰§è¡Œæ•ˆç‡ï¼Œparser æ˜¯ä¸æ”¯æŒæ‰©å±•çš„ï¼Œç”±å®˜æ–¹è¿›è¡Œç»´æŠ¤ã€‚å¦‚æœä½ è¦æ”¯æŒè‡ªå®šä¹‰è¯­æ³•ï¼Œå¯ä»¥ fork å®ƒï¼Œä¸è¿‡è¿™ç§åœºæ™¯éå¸¸å°‘ã€‚

### Traverser(@babel/traverse)

å®ç°äº†è®¿é—®è€…æ¨¡å¼ï¼Œå¯¹ AST è¿›è¡Œéå†ï¼Œè½¬æ¢æ’ä»¶ä¼šé€šè¿‡å®ƒè·å–æ„Ÿå…´è¶£çš„ AST èŠ‚ç‚¹ï¼Œå¯¹èŠ‚ç‚¹ç»§ç»­æ“ä½œï¼Œä¸‹æ–‡ä¼šè¯¦ç»†ä»‹ç»è®¿é—®å™¨æ¨¡å¼ã€‚

### Generator(@babel/generator)

å°† AST è½¬æ¢ä¸ºæºä»£ç ï¼Œæ”¯æŒ SourceMap

## æ’ä»¶

æ‰“å¼€ Babel çš„æºä»£ç ï¼Œä¼šå‘ç°æœ‰å¥½å‡ ç§ç±»å‹çš„æ’ä»¶

### è¯­æ³•æ’ä»¶(@babel/plugin-syntax-\*)

ä¸Šé¢è¯´äº† @babel/parser å·²ç»æ”¯æŒäº†å¾ˆå¤š JavaScript è¯­æ³•ç‰¹æ€§ï¼ŒParser ä¹Ÿä¸æ”¯æŒæ‰©å±•ã€‚å› æ­¤ plugin-syntax-\* å®é™…ä¸Šåªæ˜¯ç”¨äºå¼€å¯æˆ–è€…é…ç½® Parser çš„æŸä¸ªåŠŸèƒ½ç‰¹æ€§ã€‚

ä¸€èˆ¬ç”¨æˆ·ä¸éœ€è¦å…³å¿ƒè¿™ä¸ªï¼ŒTransform æ’ä»¶é‡Œé¢å·²ç»åŒ…å«äº†ç›¸å…³çš„ plugin-syntax-\* æ’ä»¶äº†ï¼Œç”¨æˆ·ä¹Ÿå¯ä»¥é€šè¿‡ parserOpts é…ç½®é¡¹æ¥ç›´æ¥é…ç½® Parser

### è½¬æ¢æ’ä»¶

ç”¨äºå¯¹ AST è¿›è¡Œè½¬æ¢ï¼Œå®ç°è½¬æ¢ä¸º ES5 ä»£ç ã€å‹ç¼©ã€åŠŸèƒ½å¢å¼ºç­‰ç›®çš„ã€‚Babel ä»“åº“å°†è½¬æ¢æ’ä»¶åˆ’åˆ†ä¸ºä¸¤ç§ï¼ˆåªæ˜¯å‘½åä¸Šçš„åŒºåˆ«ï¼‰

- @babel/plugin-transform-\*ï¼šæ™®é€šçš„è½¬æ¢æ’ä»¶
- @babel/plugin-proposal-\*ï¼šè¿˜åœ¨æè®®é˜¶æ®µï¼ˆéæ­£å¼ï¼‰çš„è¯­è¨€ç‰¹æ€§, ç›®å‰æœ‰[è¿™äº›](https://babeljs.io/docs/en/next/plugins#experimental)

### é¢„å®šä¹‰é›†åˆ(@babel/presets-\*)

æ’ä»¶é›†åˆæˆ–è€…åˆ†ç»„ï¼Œä¸»è¦æ–¹ä¾¿ç”¨æˆ·å¯¹æ’ä»¶è¿›è¡Œç®¡ç†å’Œä½¿ç”¨ã€‚æ¯”å¦‚ preset-env å«æ‹¬æ‰€æœ‰çš„æ ‡å‡†çš„æœ€æ–°ç‰¹æ€§ï¼Œå†æ¯”å¦‚ preset-react å«æ‹¬æ‰€æœ‰ react ç›¸å…³çš„æ’ä»¶

## æ’ä»¶å¼€å‘è¾…åŠ©

- @babel/templateï¼šæŸäº›åœºæ™¯ç›´æ¥æ“ä½œ AST å¤ªéº»çƒ¦ï¼Œå°±æ¯”å¦‚æˆ‘ä»¬ç›´æ¥æ“ä½œ DOM ä¸€æ ·ï¼Œæ‰€ä»¥ Babel å®ç°äº†è¿™ä¹ˆä¸€ä¸ªç®€å•çš„æ¨¡æ¿å¼•æ“ï¼Œå¯ä»¥å°†å­—ç¬¦ä¸²ä»£ç è½¬æ¢ä¸º ASTï¼Œæ¯”å¦‚åœ¨ç”Ÿæˆä¸€äº›è¾…åŠ©ä»£ç ï¼ˆhelperï¼‰æ—¶ä¼šç”¨åˆ°è¿™ä¸ªåº“
- @babel/typesï¼šAST èŠ‚ç‚¹æ„é€ å™¨å’Œæ–­è¨€ï¼Œæ’ä»¶å¼€å‘æ—¶ä½¿ç”¨å¾ˆé¢‘ç¹
- @babel/helper-\*ï¼šä¸€äº›è¾…åŠ©å™¨ï¼Œç”¨äºè¾…åŠ©æ’ä»¶å¼€å‘ï¼Œä¾‹å¦‚ç®€åŒ– AST æ“ä½œ
- @babel/helperï¼šè¾…åŠ©ä»£ç ï¼Œå•çº¯çš„è¯­æ³•è½¬æ¢å¯èƒ½æ— æ³•è®©ä»£ç è¿è¡Œèµ·æ¥ï¼Œæ¯”å¦‚ä½ç‰ˆæœ¬æµè§ˆå™¨æ— æ³•è¯†åˆ« class å…³é”®å­—ï¼Œè¿™æ—¶å€™éœ€è¦æ·»åŠ è¾…åŠ©ä»£ç ï¼Œå¯¹ class è¿›è¡Œæ¨¡æ‹Ÿ

## å·¥å…·

- @babel/nodeï¼šNode.js CLIï¼Œé€šè¿‡å®ƒç›´æ¥è¿è¡Œéœ€è¦ Babel å¤„ç†çš„ JavaScript æ–‡ä»¶
- @babel/registerï¼šPatch NodeJs çš„ require æ–¹æ³•ï¼Œæ”¯æŒå¯¼å…¥éœ€è¦ Babel å¤„ç†çš„ JavaScript æ¨¡å—
- @babel/cliï¼šCLI å·¥å…·

# è®¿é—®è€…æ¨¡å¼

è½¬æ¢å™¨ä¼šéå† AST æ ‘ï¼Œæ‰¾å‡ºè‡ªå·±æ„Ÿå…´è¶£çš„èŠ‚ç‚¹ç±»å‹ï¼Œå†è¿›è¡Œè½¬æ¢æ“ä½œã€‚è¿™ä¸ªè¿‡ç¨‹å’Œæˆ‘ä»¬æ“ä½œ DOM æ ‘å·®ä¸å¤šï¼Œåªä¸è¿‡ç›®çš„ä¸å¤ªä¸€æ ·ã€‚AST éå†å’Œè½¬æ¢ä¸€èˆ¬ä¼šä½¿ç”¨è®¿é—®è€…æ¨¡å¼ã€‚

æƒ³è±¡ä¸€ä¸‹ï¼ŒBabel æœ‰é‚£ä¹ˆå¤šæ’ä»¶ï¼Œå¦‚æœæ¯ä¸ªæ’ä»¶è‡ªå·±å»éå† ASTï¼Œå¯¹ä¸åŒçš„èŠ‚ç‚¹è¿›è¡Œä¸åŒçš„æ“ä½œï¼Œç»´æŠ¤è‡ªå·±çš„çŠ¶æ€ã€‚è¿™æ ·å­ä¸ä»…ä½æ•ˆï¼Œå®ƒä»¬çš„é€»è¾‘åˆ†æ•£åœ¨å„å¤„ï¼Œä¼šè®©æ•´ä¸ªç³»ç»Ÿå˜å¾—éš¾ä»¥ç†è§£å’Œè°ƒè¯•ï¼Œæœ€åæ’ä»¶ä¹‹é—´å…³ç³»å°±çº ç¼ ä¸æ¸…ï¼Œä¹±æˆä¸€é”…ç²¥ã€‚

æ‰€ä»¥è½¬æ¢å™¨æ“ä½œ AST ä¸€èˆ¬éƒ½æ˜¯ä½¿ç”¨è®¿é—®å™¨æ¨¡å¼ï¼Œç”±è¿™ä¸ªè®¿é—®è€…(Visitor)æ¥

1. è¿›è¡Œç»Ÿä¸€çš„éå†æ“ä½œ
2. æä¾›èŠ‚ç‚¹çš„æ“ä½œæ–¹æ³•
3. å“åº”å¼ç»´æŠ¤èŠ‚ç‚¹ä¹‹é—´çš„å…³ç³»ï¼Œè€Œæ’ä»¶(è®¾è®¡æ¨¡å¼ä¸­ç§°ä¸ºå…·ä½“è®¿é—®è€…)åªéœ€è¦å®šä¹‰è‡ªå·±æ„Ÿå…´è¶£çš„èŠ‚ç‚¹ç±»å‹ï¼Œå½“è®¿é—®è€…è®¿é—®åˆ°å¯¹åº”èŠ‚ç‚¹æ—¶ï¼Œå°±è°ƒç”¨æ’ä»¶çš„è®¿é—®(visit)æ–¹æ³•ã€‚

## èŠ‚ç‚¹çš„éå†

å‡è®¾æˆ‘ä»¬çš„ä»£ç å¦‚ä¸‹:

```js
function hello(v) {
  console.log('hello' + v + '!');
}
```

è§£æåçš„ AST ç»“æ„å¦‚ä¸‹:

```
File
  Program (program)
    FunctionDeclaration (body)
      Identifier (id)  #hello
      Identifier (params[0]) #v
      BlockStatement (body)
        ExpressionStatement ([0])
          CallExpression (expression)
            MemberExpression (callee)  #console.log
              Identifier (object)  #console
              Identifier (property)  #log
            BinaryExpression (arguments[0])
              BinaryExpression (left)
                StringLiteral (left)  #'hello'
                Identifier (right)  #v
              StringLiteral (right)  #'!'
```

è®¿é—®è€…ä¼šä»¥æ·±åº¦ä¼˜å…ˆçš„é¡ºåºï¼Œæˆ–è€…è¯´é€’å½’åœ°å¯¹ AST è¿›è¡Œéå†ï¼Œå…¶è°ƒç”¨é¡ºåºå¦‚ä¸‹å›¾æ‰€ç¤º:

![](res/2021-07-26-23-41-21.png)

ä¸Šå›¾ä¸­ç»¿çº¿è¡¨ç¤ºè¿›å…¥è¯¥èŠ‚ç‚¹ï¼Œçº¢çº¿è¡¨ç¤ºç¦»å¼€è¯¥èŠ‚ç‚¹ã€‚ä¸‹é¢å†™ä¸€ä¸ªè¶…ç®€å•çš„å…·ä½“è®¿é—®è€…æ¥è¿˜åŸä¸Šé¢çš„éå†è¿‡ç¨‹:

```js
const babel = require('@babel/core');
const traverse = require('@babel/traverse').default;

const ast = babel.parseSync(code);

let depth = 0;
traverse(ast, {
  enter(path) {
    console.log(`enter ${path.type}(${path.key})`);
    depth++;
  },
  exit(path) {
    depth--;
    console.log(`  exit ${path.type}(${path.key})`);
  }
});
```

æ‰§è¡Œç»“æœ

```
enter Program(program)
  enter FunctionDeclaration(0)
    enter Identifier(id)
    exit Identifier(id)
    enter Identifier(0)
    exit Identifier(0)
    enter BlockStatement(body)
      enter ExpressionStatement(0)
        enter CallExpression(expression)
          enter MemberExpression(callee)
            enter Identifier(object)
            exit Identifier(object)
            enter Identifier(property)
            exit Identifier(property)
          exit MemberExpression(callee)
          enter BinaryExpression(0)
            enter BinaryExpression(left)
              enter StringLiteral(left)
              exit StringLiteral(left)
              enter Identifier(right)
              exit Identifier(right)
            exit BinaryExpression(left)
            enter StringLiteral(right)
            exit StringLiteral(right)
          exit BinaryExpression(0)
        exit CallExpression(expression)
      exit ExpressionStatement(0)
    exit BlockStatement(body)
  exit FunctionDeclaration(0)
exit Program(program)
```

å½“è®¿é—®è€…è¿›å…¥ä¸€ä¸ªèŠ‚ç‚¹æ—¶å°±ä¼šè°ƒç”¨ enterï¼ˆè¿›å…¥ï¼‰æ–¹æ³•ï¼Œåä¹‹ç¦»å¼€è¯¥èŠ‚ç‚¹æ—¶ä¼šè°ƒç”¨ exitï¼ˆç¦»å¼€ï¼‰æ–¹æ³•ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæ’ä»¶ä¸ä¼šç›´æ¥ä½¿ç”¨ enter æ–¹æ³•ï¼Œåªä¼šå…³æ³¨å°‘æ•°å‡ ä¸ªèŠ‚ç‚¹ç±»å‹ï¼Œæ‰€ä»¥å…·ä½“è®¿é—®è€…ä¹Ÿå¯ä»¥è¿™æ ·å£°æ˜è®¿é—®æ–¹æ³•:

```js
traverse(ast, {
  // è®¿é—®æ ‡è¯†ç¬¦
  Identifier(path) {
    console.log(`enter Identifier`);
  },
  // è®¿é—®è°ƒç”¨è¡¨è¾¾å¼
  CallExpression(path) {
    console.log(`enter CallExpression`);
  },
  // ä¸Šé¢æ˜¯ enter çš„ç®€å†™ï¼Œå¦‚æœè¦å¤„ç† exitï¼Œä¹Ÿå¯ä»¥è¿™æ ·
  // äºŒå…ƒæ“ä½œç¬¦
  BinaryExpression: {
    enter(path) {},
    exit(path) {}
  },
  // æ›´é«˜çº§çš„, ä½¿ç”¨åŒä¸€ä¸ªæ–¹æ³•è®¿é—®å¤šç§ç±»å‹çš„èŠ‚ç‚¹
  'ExportNamedDeclaration|Flow'(path) {}
});
```

é‚£ä¹ˆ Babel æ’ä»¶æ˜¯æ€ä¹ˆè¢«åº”ç”¨çš„å‘¢ï¼Ÿ

Babel ä¼šæŒ‰ç…§æ’ä»¶å®šä¹‰çš„é¡ºåºæ¥åº”ç”¨è®¿é—®æ–¹æ³•ï¼Œæ¯”å¦‚ä½ æ³¨å†Œäº†å¤šä¸ªæ’ä»¶ï¼Œbabel-core æœ€åä¼ é€’ç»™è®¿é—®å™¨çš„æ•°æ®ç»“æ„å¤§æ¦‚é•¿è¿™æ ·ï¼š

```js
{
  Identifier: {
    enter: ['plugin-xx', 'plugin-yy']; // æ•°ç»„å½¢å¼
  }
}
```

å½“è¿›å…¥ä¸€ä¸ªèŠ‚ç‚¹æ—¶ï¼Œè¿™äº›æ’ä»¶ä¼šæŒ‰ç…§æ³¨å†Œçš„é¡ºåºè¢«æ‰§è¡Œã€‚å¤§éƒ¨åˆ†æ’ä»¶æ˜¯ä¸éœ€è¦å¼€å‘è€…å…³å¿ƒå®šä¹‰çš„é¡ºåºçš„ï¼Œæœ‰å°‘æ•°çš„æƒ…å†µéœ€è¦ç¨å¾®æ³¨æ„ä»¥ä¸‹ï¼Œä¾‹å¦‚ plugin-proposal-decorators:

```js
{
  "plugins": [
    "@babel/plugin-proposal-decorators",     // å¿…é¡»åœ¨ plugin-proposal-class-properties ä¹‹å‰
    "@babel/plugin-proposal-class-properties"
  ]
}
```

æ‰€æœ‰æ’ä»¶å®šä¹‰çš„é¡ºåºï¼ŒæŒ‰ç…§æƒ¯ä¾‹ï¼Œåº”è¯¥æ˜¯æ–°çš„æˆ–è€…è¯´å®éªŒæ€§çš„æ’ä»¶åœ¨å‰é¢ï¼Œè€çš„æ’ä»¶å®šä¹‰åœ¨åé¢ã€‚å› ä¸ºå¯èƒ½éœ€è¦æ–°çš„æ’ä»¶å°† AST è½¬æ¢åï¼Œè€çš„æ’ä»¶æ‰èƒ½è¯†åˆ«è¯­æ³•ï¼ˆå‘åå…¼å®¹ï¼‰ã€‚ä¸‹é¢æ˜¯å®˜æ–¹é…ç½®ä¾‹å­, ä¸ºäº†ç¡®ä¿å…ˆåå…¼å®¹ï¼Œstage-\* é˜¶æ®µçš„æ’ä»¶å…ˆæ‰§è¡Œ:

```js
{
  "presets": ["es2015", "react", "stage-2"]
}
```

> æ³¨æ„ Preset çš„æ‰§è¡Œé¡ºåºç›¸å

## èŠ‚ç‚¹çš„ä¸Šä¸‹æ–‡

è®¿é—®è€…åœ¨è®¿é—®ä¸€ä¸ªèŠ‚ç‚¹æ—¶, ä¼šæ— å·®åˆ«åœ°è°ƒç”¨ enter æ–¹æ³•ï¼Œæˆ‘ä»¬æ€ä¹ˆçŸ¥é“è¿™ä¸ªèŠ‚ç‚¹åœ¨ä»€ä¹ˆä½ç½®ä»¥åŠå’Œå…¶ä»–èŠ‚ç‚¹çš„å…³è”å…³ç³»å‘¢ï¼Ÿ

é€šè¿‡ä¸Šé¢çš„ä»£ç ï¼Œè¯»è€…åº”è¯¥å¯ä»¥çŒœå‡ºå‡ åˆ†ï¼Œæ¯ä¸ª visit æ–¹æ³•éƒ½æ¥æ”¶ä¸€ä¸ª Path å¯¹è±¡, ä½ å¯ä»¥å°†å®ƒå½“åšä¸€ä¸ªä¸Šä¸‹æ–‡å¯¹è±¡ï¼Œç±»ä¼¼äº JQuery çš„ `JQuery(const $el = $('.el'))` å¯¹è±¡ï¼Œè¿™é‡Œé¢åŒ…å«äº†å¾ˆå¤šä¿¡æ¯ï¼š

- å½“å‰èŠ‚ç‚¹ä¿¡æ¯
- èŠ‚ç‚¹çš„å…³è”ä¿¡æ¯ã€‚çˆ¶èŠ‚ç‚¹ã€å­èŠ‚ç‚¹ã€å…„å¼ŸèŠ‚ç‚¹ç­‰ç­‰
- ä½œç”¨åŸŸä¿¡æ¯
- ä¸Šä¸‹æ–‡ä¿¡æ¯
- èŠ‚ç‚¹æ“ä½œæ–¹æ³•ã€‚èŠ‚ç‚¹å¢åˆ æŸ¥æ”¹
- æ–­è¨€æ–¹æ³•ã€‚isXXXï¼ŒassertXXX

ä¸‹é¢æ˜¯å®ƒçš„ä¸»è¦ç»“æ„:

```ts
export class NodePath<T = Node> {
  constructor(hub: Hub, parent: Node);
  parent: Node;
  hub: Hub;
  contexts: TraversalContext[];
  data: object;
  shouldSkip: boolean;
  shouldStop: boolean;
  removed: boolean;
  state: any;
  opts: object;
  skipKeys: object;
  parentPath: NodePath;
  context: TraversalContext;
  container: object | object[];
  listKey: string; // å¦‚æœèŠ‚ç‚¹åœ¨ä¸€ä¸ªæ•°ç»„ä¸­ï¼Œè¿™ä¸ªå°±æ˜¯èŠ‚ç‚¹æ•°ç»„çš„é”®
  inList: boolean;
  parentKey: string;
  key: string | number; // èŠ‚ç‚¹æ‰€åœ¨çš„é”®æˆ–ç´¢å¼•
  node: T; // ğŸ”´ å½“å‰èŠ‚ç‚¹
  scope: Scope; // ğŸ”´å½“å‰èŠ‚ç‚¹æ‰€åœ¨çš„ä½œç”¨åŸŸ
  type: T extends undefined | null ? string | null : string; // ğŸ”´èŠ‚ç‚¹ç±»å‹
  typeAnnotation: object;
  // ... è¿˜æœ‰å¾ˆå¤šæ–¹æ³•ï¼Œå®ç°å¢åˆ æŸ¥æ”¹
}
```

ä½ å¯ä»¥é€šè¿‡è¿™ä¸ªæ‰‹å†Œæ¥å­¦ä¹ æ€ä¹ˆé€šè¿‡ Path æ¥è½¬æ¢ ASTï¼Œåé¢ä¹Ÿä¼šæœ‰ä»£ç ç¤ºä¾‹ï¼Œè¿™é‡Œå°±ä¸å±•å¼€ç»†èŠ‚äº†

## å‰¯ä½œç”¨çš„å¤„ç†

å®é™…ä¸Šè®¿é—®è€…çš„å·¥ä½œæ¯”æˆ‘ä»¬æƒ³è±¡çš„è¦å¤æ‚çš„å¤šï¼Œä¸Šé¢ç¤ºèŒƒçš„æ˜¯é™æ€ AST çš„éå†è¿‡ç¨‹ã€‚è€Œ AST è½¬æ¢æœ¬èº«æ˜¯æœ‰å‰¯ä½œç”¨çš„ï¼Œæ¯”å¦‚æ’ä»¶å°†æ—§çš„èŠ‚ç‚¹æ›¿æ¢äº†ï¼Œé‚£ä¹ˆè®¿é—®è€…å°±æ²¡æœ‰å¿…è¦å†å‘ä¸‹è®¿é—®æ—§èŠ‚ç‚¹äº†ï¼Œè€Œæ˜¯ç»§ç»­è®¿é—®æ–°çš„èŠ‚ç‚¹ï¼Œä»£ç å¦‚ä¸‹ã€‚

```js
traverse(ast, {
  ExpressionStatement(path) {
    // å°† console.log('hello' + v + '!') æ›¿æ¢ä¸º return 'hello' + v
    const rtn = t.returnStatement(t.binaryExpression('+', t.stringLiteral('hello'), t.identifier('v')))
    path.replaceWith(rtn)
  },
}
```

ä¸Šé¢çš„ä»£ç , å°† `console.log('hello' + v + '!')` è¯­å¥æ›¿æ¢ä¸º`return 'hello' + v`, ä¸‹å›¾æ˜¯éå†çš„è¿‡ç¨‹ï¼š

![](res/2021-07-26-23-54-26.png)

æˆ‘ä»¬å¯ä»¥å¯¹ AST è¿›è¡Œä»»æ„çš„æ“ä½œï¼Œæ¯”å¦‚åˆ é™¤çˆ¶èŠ‚ç‚¹çš„å…„å¼ŸèŠ‚ç‚¹ã€åˆ é™¤ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹ã€æ–°å¢å…„å¼ŸèŠ‚ç‚¹ï¼Œå½“è¿™äº›æ“ä½œæ±¡æŸ“äº† AST æ ‘åï¼Œè®¿é—®è€…éœ€è¦è®°å½•è¿™äº›çŠ¶æ€ï¼Œå“åº”å¼(Reactive)æ›´æ–° Path å¯¹è±¡çš„å…³è”å…³ç³»ï¼Œä¿è¯æ­£ç¡®çš„éå†é¡ºåºï¼Œä»è€Œè·å¾—æ­£ç¡®çš„è½¬è¯‘ç»“æœã€‚

## ä½œç”¨åŸŸçš„å¤„ç†

è®¿é—®è€…å¯ä»¥ç¡®ä¿æ­£ç¡®åœ°éå†å’Œä¿®æ”¹èŠ‚ç‚¹ï¼Œä½†æ˜¯å¯¹äºè½¬æ¢å™¨æ¥è¯´ï¼Œå¦ä¸€ä¸ªæ¯”è¾ƒæ£˜æ‰‹çš„æ˜¯å¯¹ä½œç”¨åŸŸçš„å¤„ç†ï¼Œè¿™ä¸ªè´£ä»»è½åœ¨äº†æ’ä»¶å¼€å‘è€…çš„å¤´ä¸Šã€‚æ’ä»¶å¼€å‘è€…å¿…é¡»éå¸¸è°¨æ…åœ°å¤„ç†ä½œç”¨åŸŸï¼Œä¸èƒ½ç ´åç°æœ‰ä»£ç çš„æ‰§è¡Œé€»è¾‘ã€‚

```js
const a = 1,
  b = 2;
function add(foo, bar) {
  console.log(a, b);
  return foo + bar;
}
```

æ¯”å¦‚ä½ è¦å°† add å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•° foo æ ‡è¯†ç¬¦ä¿®æ”¹ä¸º aï¼Œä½ å°±éœ€è¦é€’å½’éå†å­æ ‘ï¼ŒæŸ¥å‡º foo æ ‡è¯†ç¬¦çš„æ‰€æœ‰å¼•ç”¨ï¼Œç„¶åæ›¿æ¢å®ƒ

```js
traverse(ast, {
  // å°†ç¬¬ä¸€ä¸ªå‚æ•°åè½¬æ¢ä¸º a
  FunctionDeclaration(path) {
    const firstParams = path.get('params.0');
    if (firstParams == null) {
      return;
    }

    const name = firstParams.node.name;
    // é€’å½’éå†ï¼Œè¿™æ˜¯æ’ä»¶å¸¸ç”¨çš„æ¨¡å¼ã€‚è¿™æ ·å¯ä»¥é¿å…å½±å“åˆ°å¤–éƒ¨ä½œç”¨åŸŸ
    path.traverse({
      Identifier(path) {
        if (path.node.name === name) {
          path.replaceWith(t.identifier('a'));
        }
      }
    });
  }
});

console.log(generate(ast).code);
// function add(a, bar) {
//   console.log(a, b);
//   return a + bar;
// }
```

æ›¿æ¢æˆ a ä¹‹å, `console.log(a, b)` çš„è¡Œä¸ºå°±è¢«ç ´åäº†ã€‚æ‰€ä»¥è¿™é‡Œä¸èƒ½ç”¨ aï¼Œå¾—æ¢ä¸ªæ ‡è¯†ç¬¦ï¼Œè­¬å¦‚ c

è¿™å°±æ˜¯è½¬æ¢å™¨éœ€è¦è€ƒè™‘çš„ä½œç”¨åŸŸé—®é¢˜ï¼ŒAST è½¬æ¢çš„å‰ææ˜¯ä¿è¯ç¨‹åºçš„æ­£ç¡®æ€§ã€‚æˆ‘ä»¬åœ¨æ·»åŠ å’Œä¿®æ”¹å¼•ç”¨æ—¶ï¼Œéœ€è¦ç¡®ä¿ä¸ç°æœ‰çš„æ‰€æœ‰å¼•ç”¨ä¸å†²çªã€‚Babel æœ¬èº«ä¸èƒ½æ£€æµ‹è¿™ç±»å¼‚å¸¸ï¼Œåªèƒ½ä¾é æ’ä»¶å¼€å‘è€…è°¨æ…å¤„ç†ã€‚

Javascript é‡‡ç”¨çš„æ˜¯è¯æ³•ä½œç”¨åŸŸï¼Œä¹Ÿå°±æ˜¯æ ¹æ®æºä»£ç çš„è¯æ³•ç»“æ„æ¥ç¡®å®šä½œç”¨åŸŸï¼š

![](res/2021-07-27-00-00-26.png)

åœ¨è¯æ³•åŒºå—(block)ä¸­ï¼Œç”±äºæ–°å»ºå˜é‡ã€å‡½æ•°ã€ç±»ã€å‡½æ•°å‚æ•°ç­‰åˆ›å»ºçš„æ ‡è¯†ç¬¦ï¼Œéƒ½å±äºè¿™ä¸ªåŒºå—ä½œç”¨åŸŸã€‚è¿™äº›æ ‡è¯†ç¬¦ä¹Ÿç§°ä¸ºç»‘å®š(Binding)ï¼Œè€Œå¯¹è¿™äº›ç»‘å®šçš„ä½¿ç”¨ç§°ä¸ºå¼•ç”¨(Reference)

åœ¨ Babel ä¸­ï¼Œä½¿ç”¨ Scope å¯¹è±¡æ¥è¡¨ç¤ºä½œç”¨åŸŸã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ Path å¯¹è±¡çš„ scope å­—æ®µæ¥è·å–å½“å‰èŠ‚ç‚¹çš„ Scope å¯¹è±¡ã€‚å®ƒçš„ç»“æ„å¦‚ä¸‹:

```js
{
  path: NodePath;
  block: Node;         // æ‰€å±çš„è¯æ³•åŒºå—èŠ‚ç‚¹, ä¾‹å¦‚å‡½æ•°èŠ‚ç‚¹ã€æ¡ä»¶è¯­å¥èŠ‚ç‚¹
  parentBlock: Node;   // æ‰€å±çš„çˆ¶çº§è¯æ³•åŒºå—èŠ‚ç‚¹
  parent: Scope;       // æŒ‡å‘çˆ¶ä½œç”¨åŸŸ
  bindings: { [name: string]: Binding; }; // è¯¥ä½œç”¨åŸŸä¸‹é¢çš„æ‰€æœ‰ç»‘å®š(å³è¯¥ä½œç”¨åŸŸåˆ›å»ºçš„æ ‡è¯†ç¬¦)
}
```

Scope å¯¹è±¡å’Œ Path å¯¹è±¡å·®ä¸å¤šï¼Œå®ƒåŒ…å«äº†ä½œç”¨åŸŸä¹‹é—´çš„å…³è”å…³ç³»(é€šè¿‡ parent æŒ‡å‘çˆ¶ä½œç”¨åŸŸ)ï¼Œæ”¶é›†äº†ä½œç”¨åŸŸä¸‹é¢çš„æ‰€æœ‰ç»‘å®š(bindings)ï¼Œå¦å¤–è¿˜æä¾›äº†ä¸°å¯Œçš„æ–¹æ³•æ¥æ“ä½œä½œç”¨åŸŸã€‚

æˆ‘ä»¬å¯ä»¥é€šè¿‡ bindings å±æ€§è·å–å½“å‰ä½œç”¨åŸŸä¸‹çš„æ‰€æœ‰ç»‘å®š(å³æ ‡è¯†ç¬¦)ï¼Œæ¯ä¸ªç»‘å®šç”± Binding ç±»æ¥è¡¨ç¤ºï¼š

```js
export class Binding {
  identifier: t.Identifier;
  scope: Scope;
  path: NodePath;
  kind: 'var' | 'let' | 'const' | 'module';
  referenced: boolean;
  references: number; // è¢«å¼•ç”¨çš„æ•°é‡
  referencePaths: NodePath[]; // âš›ï¸è·å–æ‰€æœ‰åº”ç”¨è¯¥æ ‡è¯†ç¬¦çš„èŠ‚ç‚¹è·¯å¾„
  constant: boolean; // æ˜¯å¦æ˜¯å¸¸é‡
  constantViolations: NodePath[];
}
```

é€šè¿‡ Binding å¯¹è±¡æˆ‘ä»¬å¯ä»¥ç¡®å®šæ ‡è¯†ç¬¦è¢«å¼•ç”¨çš„æƒ…å†µã€‚

Okï¼Œæœ‰äº† Scope å’Œ Bindingï¼Œç°åœ¨æœ‰èƒ½åŠ›å®ç°å®‰å…¨çš„å˜é‡é‡å‘½åè½¬æ¢äº†ã€‚ä¸ºäº†æ›´å¥½åœ°å±•ç¤ºä½œç”¨åŸŸäº¤äº’ï¼Œåœ¨ä¸Šé¢ä»£ç çš„åŸºç¡€ä¸Šï¼Œæˆ‘ä»¬å†å¢åŠ ä¸€ä¸‹éš¾åº¦ï¼š

```js
const a = 1;
const b = 2;
function add(foo, bar) {
  console.log(a, b);
  return () => {
    const a = '1'; // æ–°å¢äº†ä¸€ä¸ªå˜é‡å£°æ˜
    return a + (foo + bar);
  };
}
```

ç°åœ¨ä½ è¦é‡å‘½åå‡½æ•°å‚æ•° foo, ä¸ä»…è¦è€ƒè™‘å¤–éƒ¨çš„ä½œç”¨åŸŸ, ä¹Ÿè¦è€ƒè™‘ä¸‹çº§ä½œç”¨åŸŸçš„ç»‘å®šæƒ…å†µï¼Œç¡®ä¿è¿™ä¸¤è€…éƒ½ä¸å†²çªã€‚

ä¸Šé¢çš„ä»£ç ä½œç”¨åŸŸå’Œæ ‡è¯†ç¬¦å¼•ç”¨æƒ…å†µå¦‚ä¸‹å›¾æ‰€ç¤º:

![](res/2021-07-27-00-04-31.png)

è¯•ç€å°†å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°é‡æ–°å‘½åä¸ºæ›´çŸ­çš„æ ‡è¯†ç¬¦:

```js
// ç”¨äºè·å–å”¯ä¸€çš„æ ‡è¯†ç¬¦
const getUid = () => {
  let uid = 0;
  return () => `_${uid++ || ''}`;
};

const ast = babel.parseSync(code);
traverse(ast, {
  FunctionDeclaration(path) {
    // è·å–ç¬¬ä¸€ä¸ªå‚æ•°
    const firstParam = path.get('params.0');
    if (firstParam == null) {
      return;
    }

    const currentName = firstParam.node.name;
    const currentBinding = path.scope.getBinding(currentName);
    const gid = getUid();
    let sname;

    // å¾ªç¯æ‰¾å‡ºæ²¡æœ‰è¢«å ç”¨çš„å˜é‡å
    while (true) {
      sname = gid();

      // 1ï¸ã€é¦–å…ˆçœ‹ä¸€ä¸‹çˆ¶ä½œç”¨åŸŸæ˜¯å¦å·²å®šä¹‰äº†è¯¥å˜é‡
      if (path.scope.parentHasBinding(sname)) {
        continue;
      }

      // 2ã€æŸ¥å½“å‰ä½œç”¨åŸŸæ˜¯å¦å®šä¹‰äº†å˜é‡
      if (path.scope.hasOwnBinding(sname)) {
        // å·²å ç”¨
        continue;
      }

      // å†æ£€æŸ¥ç¬¬ä¸€ä¸ªå‚æ•°çš„å½“å‰çš„å¼•ç”¨æƒ…å†µ,
      // å¦‚æœå®ƒæ‰€åœ¨çš„ä½œç”¨åŸŸå®šä¹‰äº†åŒåçš„å˜é‡ï¼Œæˆ‘ä»¬ä¹Ÿå¾—æ”¾å¼ƒ
      if (currentBinding.references > 0) {
        let findIt = false;
        for (const refNode of currentBinding.referencePaths) {
          if (refNode.scope !== path.scope && refNode.scope.hasBinding(sname)) {
            findIt = true;
            break;
          }
        }
        if (findIt) {
          continue;
        }
      }
      break;
    }

    // å¼€å§‹æ›¿æ¢æ‰
    const i = t.identifier(sname);
    currentBinding.referencePaths.forEach((p) => p.replaceWith(i));
    firstParam.replaceWith(i);
  }
});

console.log(generate(ast).code);
// const a = 1,
//       b = 2;

// function add(_, bar) {
//   console.log(a, b);
//   return () => {
//     const a = '1'; // æ–°å¢äº†ä¸€ä¸ªå˜é‡å£°æ˜

//     return a + (_ + bar);
//   };
// }
```

ä¸Šé¢çš„ä¾‹å­è™½ç„¶æ²¡æœ‰ä»€ä¹ˆå®ç”¨æ€§ï¼Œè€Œä¸”è¿˜æœ‰ Bug(æ²¡è€ƒè™‘ label)ï¼Œä½†æ˜¯æ­£å¥½å¯ä»¥æ­ç¤ºäº†ä½œç”¨åŸŸå¤„ç†çš„å¤æ‚æ€§ã€‚

Babel çš„ Scope å¯¹è±¡å…¶å®æä¾›äº†ä¸€ä¸ª generateUid æ–¹æ³•æ¥ç”Ÿæˆå”¯ä¸€çš„ã€ä¸å†²çªçš„æ ‡è¯†ç¬¦ã€‚æˆ‘ä»¬åˆ©ç”¨è¿™ä¸ªæ–¹æ³•å†ç®€åŒ–ä¸€ä¸‹æˆ‘ä»¬çš„ä»£ç :

```js
traverse(ast, {
  FunctionDeclaration(path) {
    const firstParam = path.get('params.0');
    if (firstParam == null) {
      return;
    }
    let i = path.scope.generateUidIdentifier('_'); // ä¹Ÿå¯ä»¥ä½¿ç”¨ generateUid
    const currentBinding = path.scope.getBinding(firstParam.node.name);
    currentBinding.referencePaths.forEach((p) => p.replaceWith(i));
    firstParam.replaceWith(i);
  }
});
```

æˆ–

```js
traverse(ast, {
  FunctionDeclaration(path) {
    const firstParam = path.get('params.0');
    if (firstParam == null) {
      return;
    }
    let i = path.scope.generateUid('_'); // ä¹Ÿå¯ä»¥ä½¿ç”¨generateUid
    path.scope.rename(firstParam.node.name, i);
  }
});
```

generateUid çš„å®ç°ä»£ç 

```js
generateUid(name: string = "temp") {
  name = t
    .toIdentifier(name)
    .replace(/^_+/, "")
    .replace(/[0-9]+$/g, "");

  let uid;
  let i = 0;
  do {
    uid = this._generateUid(name, i);
    i++;
  } while (
    this.hasLabel(uid) ||
    this.hasBinding(uid) ||
    this.hasGlobal(uid) ||
    this.hasReference(uid)
  );

  const program = this.getProgramParent();
  program.references[uid] = true;
  program.uids[uid] = true;

  return uid;
}
```

ä½œç”¨åŸŸæ“ä½œæœ€å…¸å‹çš„åœºæ™¯æ˜¯ä»£ç å‹ç¼©ï¼Œä»£ç å‹ç¼©ä¼šå¯¹å˜é‡åã€å‡½æ•°åç­‰è¿›è¡Œå‹ç¼©ï¼Œç„¶è€Œå®é™…ä¸Šå¾ˆå°‘çš„æ’ä»¶åœºæ™¯éœ€è¦è·Ÿä½œç”¨åŸŸè¿›è¡Œå¤æ‚çš„äº¤äº’ï¼Œæ‰€ä»¥å…³äºä½œç”¨åŸŸè¿™ä¸€å—å°±å…ˆè®²åˆ°è¿™é‡Œã€‚

# å†™ä¸€ä¸ªæ’ä»¶

ç°åœ¨æ‰“ç®—æ¨¡ä»¿ babel-plugin-importï¼Œå†™ä¸€ä¸ªæç®€ç‰ˆæ’ä»¶ï¼Œæ¥å®ç°æ¨¡å—çš„æŒ‰éœ€å¯¼å…¥ã€‚åœ¨è¿™ä¸ªæ’ä»¶ä¸­ï¼Œæˆ‘ä»¬ä¼šå°†ç±»ä¼¼è¿™æ ·çš„å¯¼å…¥è¯­å¥

```js
import { A, B, C as D } from 'foo';
```

è½¬æ¢ä¸º

```js
import A from 'foo/A';
import 'foo/A/style.css';
import B from 'foo/B';
import 'foo/B/style.css';
import D from 'foo/C';
import 'foo/C/style.css';
```

é¦–å…ˆé€šè¿‡ AST Explorer çœ‹ä¸€ä¸‹å¯¼å…¥è¯­å¥çš„ AST èŠ‚ç‚¹ç»“æ„:

![](res/2021-07-27-00-15-44.png)

é€šè¿‡ä¸Šé¢å±•ç¤ºçš„ç»“æœï¼Œæˆ‘ä»¬éœ€è¦å¤„ç† ImportDeclaration èŠ‚ç‚¹ç±»å‹ï¼Œå°†å®ƒçš„ specifiers æ‹¿å‡ºæ¥éå†å¤„ç†ä¸€ä¸‹ã€‚å¦å¤–å¦‚æœç”¨æˆ·ä½¿ç”¨äº†é»˜è®¤å¯¼å…¥è¯­å¥ï¼Œæˆ‘ä»¬å°†æŠ›å‡ºé”™è¯¯ï¼Œæé†’ç”¨æˆ·ä¸èƒ½ä½¿ç”¨é»˜è®¤å¯¼å…¥

åŸºæœ¬å®ç°å¦‚ä¸‹:

```js
// è¦è¯†åˆ«çš„æ¨¡å—
const MODULE = 'foo';
traverse(ast, {
  // è®¿é—®å¯¼å…¥è¯­å¥
  ImportDeclaration(path) {
    if (path.node.source.value !== MODULE) {
      return;
    }

    // å¦‚æœæ˜¯ç©ºå¯¼å…¥åˆ™ç›´æ¥åˆ é™¤æ‰
    const specs = path.node.specifiers;
    if (specs.length === 0) {
      path.remove();
      return;
    }

    // åˆ¤æ–­æ˜¯å¦åŒ…å«äº†é»˜è®¤å¯¼å…¥å’Œå‘½åç©ºé—´å¯¼å…¥
    if (specs.some((i) => t.isImportDefaultSpecifier(i) || t.isImportNamespaceSpecifier(i))) {
      // æŠ›å‡ºé”™è¯¯ï¼ŒBabel ä¼šå±•ç¤ºå‡ºé”™çš„ä»£ç å¸§
      throw path.buildCodeFrameError('ä¸èƒ½ä½¿ç”¨é»˜è®¤å¯¼å…¥æˆ–å‘½åç©ºé—´å¯¼å…¥');
    }

    // è½¬æ¢å‘½åå¯¼å…¥
    const imports = [];
    for (const spec of specs) {
      const named = MODULE + '/' + spec.imported.name;
      const local = spec.local;
      imports.push(t.importDeclaration([t.importDefaultSpecifier(local)], t.stringLiteral(named)));
      imports.push(t.importDeclaration([], t.stringLiteral(`${named}/style.css`)));
    }

    // æ›¿æ¢åŸæœ‰çš„å¯¼å…¥è¯­å¥
    path.replaceWithMultiple(imports);
  }
});
```

é€»è¾‘è¿˜ç®—ç®€å•ï¼Œbabel-plugin-import å¯æ¯”è¿™å¤æ‚å¾—å¤šã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†å®ƒå°è£…æˆæ ‡å‡†çš„ Babel æ’ä»¶ã€‚æŒ‰ç…§è§„èŒƒï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ª babel-plugin-\* å‰ç¼€çš„åŒ…åï¼š

```bash
mkdir babel-plugin-toy-import
cd babel-plugin-toy-import
yarn init -y
touch index.js
```

> ä½ ä¹Ÿå¯ä»¥é€šè¿‡ [generator-babel-plugin](https://github.com/babel/generator-babel-plugin/tree/master/generators/app/templates) æ¥ç”Ÿæˆé¡¹ç›®æ¨¡æ¿

åœ¨ index.js æ–‡ä»¶ä¸­å¡«å…¥æˆ‘ä»¬çš„ä»£ç ã€‚index.js é»˜è®¤å¯¼å‡ºä¸€ä¸ªå‡½æ•°ï¼Œå‡½æ•°ç»“æ„å¦‚ä¸‹:

```js
// æ¥å—ä¸€ä¸ª babel-core å¯¹è±¡
export default function(babel) {
  const { types: t } = babel;
  return {
    pre(state) {
      // å‰ç½®æ“ä½œï¼Œå¯é€‰ï¼Œå¯ä»¥ç”¨äºå‡†å¤‡ä¸€äº›èµ„æº
    },
    visitor: {
      // æˆ‘ä»¬çš„è®¿é—®è€…ä»£ç å°†æ”¾åœ¨è¿™é‡Œ
      ImportDeclaration(path, state) {
        // ...
      }
    },
    post(state) {
      // åç½®æ“ä½œï¼Œå¯é€‰
    }
  };
}
```

æˆ‘ä»¬å¯ä»¥ä»è®¿é—®å™¨æ–¹æ³•çš„ç¬¬äºŒä¸ªå‚æ•° state ä¸­è·å–ç”¨æˆ·ä¼ å…¥çš„å‚æ•°ã€‚å‡è®¾ç”¨æˆ·é…ç½®ä¸º:

```js
{
  plugins: [['toy-plugin', { name: 'foo' }]];
}
```

æˆ‘ä»¬å¯ä»¥è¿™æ ·è·å–ç”¨æˆ·ä¼ å…¥çš„å‚æ•°:

```js
export default function(babel) {
  const { types: t } = babel;
  return {
    visitor: {
      ImportDeclaration(path, state) {
        const mod = state.opts && state.opts.name;
        if (mod == null) {
          return;
        }
        // ...
      }
    }
  };
}
```

æœ€å `npm publish`

# å…³äºå®

Wiki ä¸Šé¢å¯¹å®çš„å®šä¹‰æ˜¯ï¼šå®(Macro)ï¼Œæ˜¯ä¸€ç§æ‰¹å¤„ç†çš„ç§°è°“ï¼Œå®ƒæ ¹æ®ä¸€ç³»åˆ—çš„é¢„å®šä¹‰è§„åˆ™è½¬æ¢ä¸€å®šçš„æ–‡æœ¬æ¨¡å¼ã€‚è§£é‡Šå™¨æˆ–ç¼–è¯‘å™¨åœ¨é‡åˆ°å®æ—¶ä¼šè‡ªåŠ¨è¿›è¡Œè¿™ä¸€æ¨¡å¼è½¬æ¢ï¼Œè¿™ä¸ªè½¬æ¢è¿‡ç¨‹è¢«ç§°ä¸ºâ€œå®å±•å¼€(Macro Expansion)â€ã€‚å¯¹äºç¼–è¯‘è¯­è¨€ï¼Œå®å±•å¼€åœ¨ç¼–è¯‘æ—¶å‘ç”Ÿï¼Œè¿›è¡Œå®å±•å¼€çš„å·¥å…·å¸¸è¢«ç§°ä¸ºå®å±•å¼€å™¨ã€‚

ä½ å¯ä»¥è®¤ä¸ºï¼Œå®å°±æ˜¯ç”¨æ¥ç”Ÿæˆä»£ç çš„ä»£ç ï¼Œå®ƒæœ‰èƒ½åŠ›è¿›è¡Œä¸€äº›å¥æ³•è§£æå’Œä»£ç è½¬æ¢ã€‚å®å¤§è‡´å¯ä»¥åˆ†ä¸ºä¸¤ç§: æ–‡æœ¬æ›¿æ¢å’Œè¯­æ³•æ‰©å±•

## æ–‡æœ¬æ›¿æ¢å¼

å¤§å®¶æˆ–å¤šæˆ–å°‘æœ‰æ¥è§¦è¿‡å®ï¼Œå¾ˆå¤šç¨‹åºå‘˜ç¬¬ä¸€é—¨è¯­è¨€æ˜¯ C/C++(åŒ…æ‹¬ C çš„è¡ç”Ÿè¯­è¨€ Objective-C)ï¼Œåœ¨ C ä¸­å°±æœ‰å®çš„æ¦‚å¿µã€‚ä½¿ç”¨ #define æŒ‡ä»¤å®šä¹‰ä¸€ä¸ªå®:

```c
#define MIN(X, Y) ((X) < (Y) ? (X) : (Y))
```

å¦‚æœæˆ‘ä»¬çš„ç¨‹åºä½¿ç”¨äº†è¿™ä¸ªå®ï¼Œå°±ä¼šåœ¨ç¼–è¯‘é˜¶æ®µè¢«å±•å¼€ï¼Œä¾‹å¦‚ï¼š

```js
MIN(a + b, c + d);
```

ä¼šè¢«å±•å¼€ä¸º:

```js
a + b < c + d ? a + b : c + d;
```

é™¤äº†å‡½æ•°å®ï¼ŒC ä¸­è¿˜æœ‰å¯¹è±¡å®ï¼Œæˆ‘ä»¬é€šå¸¸ä½¿ç”¨å®ƒæ¥å£°æ˜ `å¸¸é‡`:

```c
#define PI 3.1214
```

![](res/2021-07-27-00-35-38.png)

å¦‚ä¸Šå›¾ï¼Œå®æœ¬è´¨ä¸Šä¸æ˜¯ C è¯­è¨€çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒç”± C é¢„å¤„ç†å™¨æä¾›ï¼Œé¢„å¤„ç†å™¨åœ¨ç¼–è¯‘ä¹‹å‰å¯¹æºä»£ç è¿›è¡Œæ–‡æœ¬æ›¿æ¢ï¼Œç”ŸæˆçœŸæ­£çš„ C ä»£ç ï¼Œå†ä¼ é€’ç»™ç¼–è¯‘å™¨ã€‚

> å½“ç„¶ C é¢„å¤„ç†å™¨ä¸ä»…ä»…ä¼šå¤„ç†å®ï¼Œå®ƒè¿˜åŒ…å«äº†å¤´æ–‡ä»¶å¼•å…¥ã€æ¡ä»¶ç¼–è¯‘ã€è¡Œæ§åˆ¶ç­‰æ“ä½œ

é™¤æ­¤ä¹‹å¤–ï¼ŒGNU m4 æ˜¯ä¸€ä¸ªæ›´ä¸“ä¸š/æ›´å¼ºå¤§/æ›´é€šç”¨çš„é¢„å¤„ç†å™¨ï¼ˆå®å±•å¼€å™¨ï¼‰ã€‚è¿™æ˜¯ä¸€ä¸ªé€šç”¨çš„å®å±•å¼€å™¨ï¼Œä¸ä»…å¯ä»¥ç”¨äº Cï¼Œä¹Ÿå¯ä»¥ç”¨äºå…¶ä»–è¯­è¨€å’Œæ–‡æœ¬æ–‡ä»¶çš„å¤„ç†(å‚è€ƒè¿™ç¯‡æœ‰è¶£çš„æ–‡ç« ï¼š[ä½¿ç”¨ GNU m4 ä¸º Markdown æ·»åŠ ç›®å½•æ”¯æŒ](https://segmentfault.com/a/1190000004342956))ï¼Œ å…³äº m4 å¯ä»¥çœ‹ [è®©è¿™ä¸–ç•Œå†å¤šä¸€ä»½ GNU m4 æ•™ç¨‹](https://segmentfault.com/a/1190000004104696) ç³»åˆ—æ–‡ç« 

æ–‡æœ¬æ›¿æ¢å¼å®å¾ˆå®¹æ˜“ç†è§£ã€å®ç°ä¹Ÿç®€å•ï¼Œå› ä¸ºå®ƒä»¬åªæ˜¯çº¯æ–‡æœ¬æ›¿æ¢, æ¢å¥è¯è¯´å®ƒå°±åƒ `æ–‡æœ¬ç¼–è¾‘å™¨`ã€‚æ‰€ä»¥ç›¸å¯¹è€Œè¨€ï¼Œè¿™ç§å½¢å¼çš„å®èƒ½åŠ›æœ‰é™ï¼Œæ¯”å¦‚å®ƒä¸ä¼šæ£€éªŒè¯­æ³•æ˜¯å¦åˆæ³•ï¼Œä½¿ç”¨å®ƒç»å¸¸ä¼šå‡ºç°é—®é¢˜ã€‚

æ‰€ä»¥éšç€ç°ä»£ç¼–ç¨‹è¯­è¨€è¡¨è¾¾èƒ½åŠ›è¶Šæ¥è¶Šå¼ºï¼Œå¾ˆå¤šè¯­è¨€éƒ½ä¸å†æ¨èä½¿ç”¨å®/ä¸æä¾›å®ï¼Œè€Œæ˜¯ä½¿ç”¨è¯­è¨€æœ¬èº«çš„æœºåˆ¶(ä¾‹å¦‚å‡½æ•°)æ¥è§£å†³é—®é¢˜ï¼Œè¿™æ ·æ›´å®‰å…¨ã€æ›´å®¹æ˜“ç†è§£å’Œè°ƒè¯•ã€‚æ²¡æœ‰å®æœºåˆ¶ï¼Œç°ä»£è¯­è¨€å¯ä»¥é€šè¿‡æä¾›å¼ºå¤§çš„åå°„æœºåˆ¶æˆ–è€…åŠ¨æ€ç¼–ç¨‹ç‰¹æ€§(å¦‚ Javascript çš„ Proxyã€Python çš„è£…é¥°å™¨)æ¥å¼¥è¡¥ç¼ºå¤±å®å¯¼è‡´çš„å…ƒç¼–ç¨‹çŸ­æ¿ã€‚æ‰€ä»¥åè¿‡æ¥æ¨å¯¼ï¼Œä¹‹æ‰€ä»¥ C è¯­è¨€éœ€è¦å®ï¼Œæ­£æ˜¯å› ä¸º C è¯­è¨€çš„è¡¨è¾¾èƒ½åŠ›å¤ªå¼±äº†ã€‚

## è¯­æ³•æ‰©å±•å¼

çœŸæ­£çš„å®èµ·æºäº Lispï¼Œè¿™ä¸ªå¾—ç›Šäº Lisp è¯­è¨€æœ¬èº«çš„ä¸€äº›ç‰¹æ€§ï¼š

![](res/2021-07-27-11-29-06.png)

- å®ƒçš„è¯­æ³•éå¸¸ç®€å•ï¼Œåªæœ‰ S-è¡¨è¾¾å¼(s-expression)ï¼ˆç‰¹å¾ä¸ºæ‹¬å·åŒ–çš„å‰ç¼€è¡¨ç¤ºæ³•, å¯ä»¥è®¤ä¸º S-è¡¨è¾¾å¼å°±æ˜¯è¿‘ä¼¼çš„ Lisp çš„æŠ½è±¡è¯­æ³•æ ‘(AST)ï¼‰
- æ•°æ®å³ä»£ç ï¼ŒS-è¡¨è¾¾å¼æœ¬èº«å°±æ˜¯æ ‘å½¢æ•°æ®ç»“æ„ï¼Œå¦å¤– Lisp æ”¯æŒæ•°æ®å’Œä»£ç ä¹‹é—´çš„è½¬æ¢

ç”±äº Lisp è¿™ç§ç®€å•çš„è¯­æ³•ç»“æ„ï¼Œä½¿å¾—æ•°æ®å’Œç¨‹åºä¹‹é—´åªæœ‰ä¸€çº¿ä¹‹éš”(quote ä¿®é¥°å°±æ˜¯æ•°æ®ï¼Œæ²¡æœ‰ quote å°±æ˜¯ç¨‹åº)ï¼Œæ¢å¥è¯è¯´å°±æ˜¯ç¨‹åºå’Œæ•°æ®ä¹‹é—´å¯ä»¥çµæ´»åœ°è½¬æ¢ã€‚è¿™ç§æ•°æ®å³ç¨‹åºã€ç¨‹åºå³æ•°æ®çš„æ¦‚å¿µï¼Œä½¿å¾— Lisp å¯ä»¥è½»æ¾åœ°è‡ªå®šä¹‰å®ã€‚ä¸å¦¨æ¥çœ‹ä¸€ä¸‹ Lisp å®šä¹‰å®çš„ç¤ºä¾‹ï¼š

```lisp
; ä½¿ç”¨defmacroå®šä¹‰ä¸€ä¸ªnonsenseå®, æ¥æ”¶ä¸€ä¸ªfunction-nameå‚æ•°. å®éœ€è¦è¿”å›ä¸€ä¸ªquoted
; ` è¿™æ˜¯quoteå‡½æ•°çš„ç®€å†™ï¼Œè¡¨ç¤ºquoteï¼Œå³è¿™æ®µâ€˜ç¨‹åºâ€™æ˜¯ä¸€æ®µâ€˜æ•°æ®â€™, æˆ–è€…è¯´å°†â€˜ç¨‹åºâ€™è½¬æ¢ä¸ºâ€˜æ•°æ®â€™. quoteä¸ä¼šè¢«â€˜æ±‚å€¼â€™
; defun å®šä¹‰ä¸€ä¸ªå‡½æ•°
; , è¿™æ˜¯unquoteå‡½æ•°çš„ç®€å†™ï¼Œ è¡¨ç¤ºunquoteï¼Œå³å°†â€˜æ•°æ®â€™è½¬æ¢ä¸ºâ€˜ç¨‹åºâ€™. unquoteä¼šè¿›è¡Œæ±‚å€¼
; intern å°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºsymbolï¼Œå³æ ‡è¯†ç¬¦

(defmacro nonsense (function-name)
  `(defun ,(intern (concat "nonsense-" function-name)) (input) ; å®šä¹‰ä¸€ä¸ªnonsense-${function-name} æ–¹æ³•
     (print (concat ,function-name input))))                   ; è¾“å…¥`${function-name}${input}`
```

å¦‚æœä½ ä¸ç†è§£ä¸Šé¢ç¨‹åºçš„å«ä¹‰ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ª Javascript çš„å®ç°

æ³¨æ„ï¼š`å®` ä¸€èˆ¬åœ¨ç¼–è¯‘é˜¶æ®µè¢«å±•å¼€, ä¸‹é¢ä»£ç åªæ˜¯ä¸ºäº†åä½œä½ ç†è§£ä¸Šè¿°çš„ Lisp ä»£ç 

```js
function nonsense(name) {
  let rtn;
  eval(`rtn = function nonsense${name}(input) {
    console.log('${name}', input)
  }`);
  return rtn;
}
```

åº”ç”¨å®å±•å¼€ï¼š

```lisp
(nonsense "apple")           ; å±•å¼€å®ï¼Œè¿™é‡Œä¼šåˆ›å»ºä¸€ä¸ªnonsense-appleå‡½æ•°
(nonsense-apple " is good")  ; è°ƒç”¨åˆšåˆšåˆ›å»ºçš„å®
                             ; => "apple is good"
```

å¯¹äº Lisp è€Œè¨€ï¼Œå®æœ‰ç‚¹åƒä¸€ä¸ªå‡½æ•°ï¼Œåªä¸è¿‡è¿™ä¸ªå‡½æ•°å¿…é¡»è¿”å›ä¸€ä¸ª quoted æ•°æ®ï¼›å½“è°ƒç”¨è¿™ä¸ªå®æ—¶ï¼ŒLisp ä¼šä½¿ç”¨ unquote å‡½æ•°å°†å®è¿”å›çš„ quoted æ•°æ®è½¬æ¢ä¸ºç¨‹åºã€‚

![](res/2021-07-29-09-27-34.png)

é€šè¿‡ä¸Šé¢çš„ç¤ºä¾‹ï¼Œä½ ä¼šæ„Ÿå¹ Lisp çš„å®å®ç°ç«Ÿç„¶å¦‚æ­¤æ¸…å¥‡ï¼Œå¦‚æ­¤ç®€å•ã€‚

Lisp å®çš„çµæ´»æ€§å¾—ç›Šäºç®€å•çš„è¯­æ³•(S-è¡¨è¾¾å¼å¯ä»¥ç­‰ä»·äºå®ƒçš„ AST)ï¼Œå¯¹äºå¤æ‚è¯­æ³•çš„è¯­è¨€(ä¾‹å¦‚ Javascript)ï¼Œè¦å®ç°ç±»ä¼¼ Lisp çš„å®å°±éš¾å¾—å¤š. å› æ­¤å¾ˆå°‘æœ‰ç°ä»£è¯­è¨€æä¾›å®æœºåˆ¶å¯èƒ½ä¹Ÿæ˜¯è¿™ä¸ªåŸå› ã€‚

å°½ç®¡å¦‚æ­¤ï¼Œç°åœ¨å¾ˆå¤šæŠ€æœ¯éš¾ç‚¹æ…¢æ…¢è¢«è§£å†³ï¼Œå¾ˆå¤šç°ä»£è¯­è¨€ä¹Ÿå¼•å…¥ç±» Lisp çš„å®æœºåˆ¶ï¼Œå¦‚ Rustã€Juliaï¼Œè¿˜æœ‰ Javascript çš„ Sweet.js

## Sweet.js

Sweet.js å’Œ Rust å¸ˆå‡ºåŒé—¨ï¼Œæ‰€ä»¥ä¸¤ä¸ªçš„å®è¯­æ³•å’Œéå¸¸æ¥è¿‘(åˆæœŸ)ã€‚ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯: å®˜æ–¹è®¤ä¸º Sweet.js ç›®å‰ä»å¤„äºå®éªŒé˜¶æ®µï¼Œè€Œä¸” Github æœ€åæäº¤æ—¶é—´åœç•™åœ¨ 2 å¹´å‰ï¼Œç¤¾åŒºä¸Šä¹Ÿæœªè§å¤§è§„æ¨¡çš„ä½¿ç”¨ã€‚æ‰€ä»¥ä¸è¦åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨å®ƒï¼Œä½†æ˜¯ä¸å¦¨ç¢æˆ‘ä»¬å»å­¦ä¹ ä¸€ä¸ªç°ä»£ç¼–ç¨‹è¯­è¨€çš„å®æœºåˆ¶ã€‚

æˆ‘ä»¬å…ˆä½¿ç”¨ Sweet.js æ¥å®ç°ä¸Šé¢æˆ‘ä»¬é€šè¿‡ Lisp å®ç°çš„ nosense å®, å¯¹æ¯”èµ·æ¥æ›´å®¹æ˜“ç†è§£

```js
import { unwrap, fromIdentifier, fromStringLiteral } from '@sweet-js/helpers' for syntax;

syntax nosense = function (ctx) {
  let name = ctx.next().value;
  let funcName = 'nonsense' + unwrap(name).value

  return #`function ${fromIdentifier(name, funcName)} () {
    console.log(${fromStringLiteral(name, unwrap(name).value)} + input)
  }`;
};

nosense Apple
nosenseApple(" is Good") // Apple is Good
```

é¦–å…ˆï¼ŒSweet.js ä½¿ç”¨ syntax å…³é”®å­—æ¥å®šä¹‰ä¸€ä¸ªå®ï¼Œå…¶è¯­æ³•ç±»ä¼¼äº const æˆ–è€… letã€‚

æœ¬è´¨ä¸Šä¸€ä¸ªå®å°±æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œåªä¸è¿‡åœ¨ç¼–è¯‘é˜¶æ®µè¢«æ‰§è¡Œã€‚è¿™ä¸ªå‡½æ•°æ¥æ”¶ä¸€ä¸ª TransformerContext å¯¹è±¡ï¼Œä½ ä¹Ÿé€šè¿‡è¿™ä¸ªå¯¹è±¡è·å–å®åº”ç”¨ä¼ å…¥çš„è¯­æ³•å¯¹è±¡ï¼ˆSyntax Objectï¼‰æ•°ç»„ï¼Œæœ€ç»ˆè¿™ä¸ªå®ä¹Ÿè¦è¿”å›è¯­æ³•å¯¹è±¡æ•°ç»„ã€‚

ä»€ä¹ˆæ˜¯è¯­æ³•å¯¹è±¡ï¼Ÿè¯­æ³•å¯¹è±¡æ˜¯ Sweet.js å…³äºè¯­æ³•çš„å†…éƒ¨è¡¨ç¤ºï¼Œä½ å¯ä»¥ç±»æ¯”ä¸Šæ–‡ Lisp çš„ quoted æ•°æ®ã€‚åœ¨å¤æ‚è¯­æ³•çš„è¯­è¨€ä¸­ï¼Œæ²¡åŠæ³•ä½¿ç”¨ quoted è¿™ä¹ˆç®€å•çš„åºåˆ—æ¥è¡¨ç¤ºè¯­æ³•ï¼Œè€Œä½¿ç”¨ AST åˆ™æ›´å¤æ‚ï¼Œå¼€å‘è€…æ›´éš¾ä»¥é©¾é©­ã€‚æ‰€ä»¥å¤§éƒ¨åˆ†å®å®ç°ä¼šå‚è€ƒ Lisp çš„ S-è¡¨è¾¾å¼ï¼Œå–æŠ˜ä¸­æ–¹æ¡ˆï¼Œå°†ä¼ å…¥çš„ç¨‹åºè½¬æ¢ä¸º Tokensï¼Œå†ç»„è£…æˆç±»ä¼¼ quoted çš„æ•°æ®ç»“æ„ã€‚

ä¸¾ä¸ªä¾‹å­ï¼ŒSweet.js ä¼šå°† `foo,bar('baz', 1)` è½¬æ¢æˆè¿™æ ·çš„æ•°æ®ç»“æ„:

![](res/2021-07-29-09-30-55.png)

ä»ä¸Šå›¾å¯çŸ¥ï¼ŒSweet.js ä¼šå°†ä¼ å…¥çš„ç¨‹åºè§£ææˆåµŒå¥—çš„ Token åºåˆ—ï¼Œè¿™ä¸ªç»“æ„å’Œ Lisp çš„ S-è¡¨è¾¾å¼éå¸¸ç›¸ä¼¼ã€‚ä¹Ÿå°±æ˜¯, è¯´å¯¹äºé—­åˆçš„è¯æ³•å•å…ƒä¼šè¢«åµŒå¥—å­˜å‚¨ï¼Œä¾‹å¦‚ä¸Šä¾‹çš„ `('baz', 1)`

> Elixir ä¹Ÿé‡‡ç”¨äº†ç±»ä¼¼çš„ [quote/unquote](https://elixir-lang.org/getting-started/meta/quote-and-unquote.html) æœºåˆ¶ï¼Œå¯ä»¥ç»“åˆç€ä¸€èµ·ç†è§£

TransformerContext å®ç°äº†è¿­ä»£å™¨æ–¹æ³•ï¼Œæ‰€ä»¥æˆ‘ä»¬é€šè¿‡è°ƒç”¨å®ƒçš„ `next()` æ¥éå†è·å–è¯­æ³•å¯¹è±¡ã€‚æœ€åå®å¿…é¡»è¿”å›ä¸€ä¸ªè¯­æ³•å¯¹è±¡æ•°ç»„ï¼ŒSweet.js ä½¿ç”¨äº†ç±»ä¼¼å­—ç¬¦ä¸²æ¨¡æ¿çš„è¯­æ³•(ç§°ä¸ºè¯­æ³•æ¨¡æ¿)æ¥ç®€åŒ–å¼€å‘ï¼Œè¿™ä¸ªæ¨¡æ¿æœ€ç»ˆè½¬æ¢ä¸ºè¯­æ³•å¯¹è±¡æ•°ç»„ã€‚

> éœ€è¦æ³¨æ„çš„æ˜¯è¯­æ³•æ¨¡æ¿çš„å†…åµŒå€¼åªèƒ½æ˜¯è¯­æ³•å¯¹è±¡ã€è¯­æ³•å¯¹è±¡åºåˆ—æˆ–è€… TransformerContext

æ—§ç‰ˆæœ¬ä½¿ç”¨äº†æ¨¡å¼åŒ¹é…ï¼Œå’Œ Rust è¯­æ³•ç±»ä¼¼

```js
macro define {
  rule { $x } => {
    var $x
  }

  rule { $x = $expr } => {
    var $x = $expr
  }
}

define y;
define y = 5;
```

è¯´äº†è¿™ä¹ˆå¤šï¼Œç±»ä¼¼ Sweet.js è¯­æ³•å¯¹è±¡çš„è®¾è®¡æ˜¯ç°ä»£ç¼–ç¨‹è¯­è¨€ä¸ºäº†è´´è¿‘ Lisp å®çš„ä¸€ä¸ªå…³é”®æŠ€æœ¯ç‚¹ã€‚æˆ‘å‘ç° Elixirã€Rust ç­‰è¯­è¨€ä¹Ÿä½¿ç”¨äº†ç±»ä¼¼çš„è®¾è®¡ã€‚é™¤äº†æ•°æ®ç»“æ„çš„è®¾è®¡ï¼Œç°ä»£ç¼–ç¨‹è¯­è¨€çš„å®æœºåˆ¶è¿˜åŒ…å«ä»¥ä¸‹ç‰¹æ€§ï¼š

### å«ç”Ÿå®(Hygiene)

å«ç”Ÿå®æŒ‡çš„æ˜¯åœ¨å®å†…ç”Ÿæˆçš„å˜é‡ä¸ä¼šæ±¡æŸ“å¤–éƒ¨ä½œç”¨åŸŸï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨å®å±•å¼€æ—¶ï¼ŒSweet.js ä¼šé¿å…å®å†…å®šä¹‰çš„å˜é‡å’Œå¤–éƒ¨å†²çª

ä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ª swap å®ï¼Œäº¤æ¢å˜é‡çš„å€¼

```js
syntax swap = (ctx) => {
 const a = ctx.next().value
 ctx.next() // åƒæ‰','
 const b = ctx.next().value
 return #`
 let temp = ${a}
 ${a} = ${b}
 ${b} = temp
 `;
}

swap foo,bar
```

å±•å¼€ä¼šè¾“å‡ºä¸º

```js
let temp_10 = foo; // temp å˜é‡è¢«é‡å‘½åä¸º temp_10
foo = bar;
bar = temp_10;
```

å¦‚æœä½ æƒ³å¼•ç”¨å¤–éƒ¨çš„å˜é‡ä¹Ÿå¯ä»¥ï¼Œä¸è¿‡ä¸å»ºè®®è¿™ä¹ˆåšï¼Œå®ä¸åº”è¯¥å‡å®šå…¶è¢«å±•å¼€çš„ä¸Šä¸‹æ–‡:

```js
syntax swap = (ctx) => {
  // ...
  return #`
  temp = ${a} // ä¸ä½¿ç”¨ let å£°æ˜
  ${a} = ${b}
  ${b} = temp
  `;
}
```

### æ¨¡å—åŒ–

Sweet.js çš„å®æ˜¯æ¨¡å—åŒ–çš„ï¼š

```js
'lang sweet.js';
// å¯¼å‡ºå®
export syntax class = function (ctx) {
  // ...
};
```

å¯¼å…¥

```js
import { class } from './es2015-macros';

class Droid {
  constructor(name, color) {
    this.name = name;
    this.color = color;
  }

  rollWithIt(it) {
    return this.name + " is rolling with " + it;
  }
}
```

ç›¸å¯¹ Babelï¼ˆç¼–è¯‘å™¨ï¼‰æ¥è¯´ï¼ŒSweet.js çš„å®æ˜¯æ¨¡å—åŒ–/æ˜¾å¼çš„ã€‚Babel éœ€è¦åœ¨é…ç½®æ–‡ä»¶ä¸­é…ç½®å„ç§æ’ä»¶å’Œé€‰é¡¹ï¼Œå°¤å…¶æ˜¯å›¢é˜Ÿé¡¹ç›®æ„å»ºæœ‰ç»Ÿä¸€è§„èŒƒå’Œç¯å¢ƒæ—¶ï¼Œé¡¹ç›®æ„å»ºè„šæœ¬ä¿®æ”¹å¯èƒ½æœ‰é™åˆ¶ã€‚è€Œæ¨¡å—åŒ–çš„å®æ˜¯æºä»£ç çš„ä¸€éƒ¨åˆ†ï¼Œè€Œä¸æ˜¯æ„å»ºè„šæœ¬çš„ä¸€éƒ¨åˆ†ï¼Œè¿™ä½¿å¾—å®ƒä»¬å¯ä»¥è¢«çµæ´»åœ°ä½¿ç”¨ã€é‡æ„ä»¥åŠåºŸå¼ƒã€‚

ä¸‹æ–‡ä»‹ç»çš„ babel-plugin-macros æœ€å¤§çš„ä¼˜åŠ¿å°±åœ¨è¿™é‡Œï¼Œé€šå¸¸æˆ‘ä»¬å¸Œæœ›æ„å»ºç¯å¢ƒæ˜¯ç»Ÿä¸€çš„ã€ç¨³å®šçš„ã€å¼€å‘äººå‘˜åº”è¯¥ä¸“æ³¨äºä»£ç çš„å¼€å‘ï¼Œè€Œä¸æ˜¯å¦‚ä½•å»æ„å»ºç¨‹åºï¼Œæ­£æ˜¯å› ä¸ºä»£ç å¤šå˜æ€§ï¼Œæ‰å‚¬ç”Ÿå‡ºäº†è¿™äº›æ–¹æ¡ˆã€‚

éœ€è¦æ³¨æ„çš„æ˜¯å®æ˜¯åœ¨ç¼–è¯‘é˜¶æ®µå±•å¼€çš„ï¼Œæ‰€ä»¥æ— æ³•è¿è¡Œç”¨æˆ·ä»£ç ï¼Œä¾‹å¦‚

```js
let log = msg => console.log(msg); // ç”¨æˆ·ä»£ç , è¿è¡Œæ—¶è¢«æ±‚å€¼ï¼Œæ‰€ä»¥æ— æ³•è¢«è®¿é—®

syntax m = ctx => {
  // å®å‡½æ•°åœ¨ç¼–è¯‘é˜¶æ®µè¢«æ‰§è¡Œ
  log('doing some Sweet things'); // ERROR: æœªæ‰¾åˆ°å˜é‡ log
  // ...
};
```

Sweet.js å’Œå…¶ä»–è¯­è¨€çš„å®ä¸€æ ·ï¼Œæœ‰äº†å®ƒä½ å¯ä»¥:

- æ–°å¢è¯­æ³•ç³–(å’Œ Sweet.js ä¸€æ ·ç”œ)ï¼Œå®ç°è‡ªå·±çš„è¯­æ³•æˆ–è€…æŸäº›å®éªŒæ€§çš„è¯­è¨€ç‰¹æ€§
- è‡ªå®šä¹‰[æ“ä½œç¬¦](https://www.sweetjs.org/doc/tutorial#sweet-operators)ï¼Œå¾ˆå¼ºå¤§
- æ¶ˆç­é‡å¤çš„ä»£ç ï¼Œæå‡è¯­è¨€çš„è¡¨è¾¾èƒ½åŠ›ã€‚

å¾ˆé—æ†¾ï¼Sweet.js åŸºæœ¬æ­»äº†ã€‚æ‰€ä»¥ç°åœ¨å½“ä¸ªç©å…·ç©ç©å°šå¯ï¼Œåˆ‡å‹¿ç”¨äºç”Ÿäº§ç¯å¢ƒã€‚å³ä½¿æ²¡æœ‰æ­»ï¼ŒSweet.js è¿™ç§éæ ‡å‡†çš„è¯­æ³•ï¼Œå’Œç°æœ‰çš„ Javascript å·¥å…·é“¾ç”Ÿæ€æ ¼æ ¼ä¸å…¥ï¼Œå¼€å‘å’Œè°ƒè¯•éƒ½ä¼šæ¯”è¾ƒéº»çƒ¦(æ¯”å¦‚ Typescript)

å½’æ ¹åˆ°åº•ï¼ŒSweet.js çš„å¤±è´¥ï¼Œæ˜¯ç¤¾åŒºæŠ›å¼ƒäº†å®ƒã€‚Javascript è¯­è¨€è¡¨è¾¾èƒ½åŠ›è¶Šæ¥è¶Šå¼ºï¼Œç‰ˆæœ¬è¿­ä»£å¿«é€Ÿï¼ŒåŠ ä¸Šæœ‰äº† Babel å’Œ Typescript è¿™äº›è§£å†³æ–¹æ¡ˆï¼Œå®åœ¨æ‹¿ä¸å‡ºä»€ä¹ˆç†ç”±æ¥ä½¿ç”¨ Sweet.js

## å°ç»“

è¿™ä¸€èŠ‚æ‰¯å¾—æœ‰ç‚¹å¤šï¼Œå°†å®çš„å†å²å’Œåˆ†ç±»è®²äº†ä¸ªéã€‚æœ€åçš„æ€»ç»“æ˜¯ Elixir å®˜æ–¹æ•™ç¨‹é‡Œé¢çš„ä¸€å¥è¯ï¼šæ˜¾å¼å¥½äºéšå¼ï¼Œæ¸…æ™°çš„ä»£ç ä¼˜äºç®€æ´çš„ä»£ç (Clear code is better than concise code)

èƒ½åŠ›è¶Šå¤§ã€è´£ä»»è¶Šå¤§ã€‚å®å¼ºå¤§ï¼Œæ¯”æ­£å¸¸ç¨‹åºè¦æ›´éš¾ä»¥é©¾é©­ï¼Œä½ å¯èƒ½éœ€è¦ä¸€å®šçš„æˆæœ¬å»å­¦ä¹ å’Œç†è§£å®ƒï¼Œæ‰€ä»¥èƒ½ä¸ç”¨å®å°±ä¸ç”¨å®ï¼Œå®åº”è¯¥æ˜¯æœ€åçš„æ³•å®

# æ—¢ç”Ÿ Plugin ä½•ç”Ÿ Macro

æ—¢ç„¶ Babel æœ‰äº† Plugin ä¸ºä»€ä¹ˆåˆå†’å‡ºäº†ä¸ª babel-plugin-macros?

> å¦‚æœä½ å°šä¸äº†è§£ Babel Macroï¼Œå¯ä»¥å…ˆè¯»ä¸€ä¸‹å®˜æ–¹æ–‡æ¡£ï¼Œå¦å¤– Creact-React-APP å·²ç»å†…ç½®

è¿™ä¸ªå¾—ä» Create-React-Appï¼ˆCRAï¼‰ è¯´èµ·ï¼ŒCRA å°†æ‰€æœ‰çš„é¡¹ç›®æ„å»ºé€»è¾‘éƒ½å°è£…åœ¨ react-scripts æœåŠ¡ä¸­ã€‚è¿™æ ·çš„å¥½å¤„æ˜¯ï¼Œå¼€å‘è€…ä¸éœ€è¦å†å…³å¿ƒæ„å»ºçš„ç»†èŠ‚ï¼Œå¦å¤–æ„å»ºå·¥å…·çš„å‡çº§ä¹Ÿå˜å¾—éå¸¸æ–¹ä¾¿ï¼Œç›´æ¥å‡çº§ react-scripts å³å¯ã€‚

å¦‚æœè‡ªå·±ç»´æŠ¤æ„å»ºè„šæœ¬çš„è¯ï¼Œå‡ä¸€æ¬¡çº§ä½ éœ€è¦å‡çº§ä¸€å¤§å †çš„ä¾èµ–ï¼Œå¦‚æœä½ è¦ç»´æŠ¤è·¨é¡¹ç›®çš„æ„å»ºè„šæœ¬ï¼Œé‚£å°±æ›´è›‹ç–¼äº†ã€‚

CRA æ˜¯å¼ºçº¦å®šçš„ï¼Œå®ƒæ˜¯æŒ‰ç…§ React ç¤¾åŒºçš„æœ€ä½³å®è·µç»™ä½ å‡†å¤‡çš„ï¼Œä¸ºäº†ä¿æŠ¤å°è£…å¸¦æ¥çš„çº¢åˆ©ï¼Œå®ƒä¸æ¨èä½ å»æ‰‹åŠ¨é…ç½® Webpackã€Babelâ€¦ æ‰€ä»¥æ‰å‚¬ç”Ÿäº† babel-plugin-macrosï¼Œå¤§å®¶å¯ä»¥çœ‹è¿™ä¸ª [Issue: RFC - babel-macros](https://github.com/facebook/create-react-app/issues/2730)

æ‰€ä»¥ä¸º Babel å¯»æ±‚ä¸€ä¸ªé›¶é…ç½®çš„æœºåˆ¶æ˜¯ babel-plugin-macros è¯ç”Ÿçš„ä¸»è¦åŠ¨æœºã€‚

è¿™ç¯‡æ–‡ç« æ­£å¥½è¯å®äº†è¿™ä¸ªåŠ¨æœºï¼š[Zero-config code transformation with babel-plugin-macros](https://babeljs.io/blog/2017/09/11/zero-config-with-babel-macros)ï¼Œè¿™ç¯‡æ–‡ç« å¼•è¿°äº†ä¸€ä¸ªé‡è¦çš„è§‚ç‚¹ï¼š`Compilers are the New Frameworks`

Babel åœ¨ç°ä»£çš„å‰ç«¯å¼€å‘ä¸­æ‰®æ¼”ç€ä¸€ä¸ªå¾ˆé‡è¦çš„è§’è‰²ï¼Œè¶Šæ¥è¶Šå¤šçš„æ¡†æ¶æˆ–åº“ä¼šåˆ›å»ºè‡ªå·±çš„ Babel æ’ä»¶ï¼Œå®ƒä»¬ä¼šåœ¨ç¼–è¯‘é˜¶æ®µåšä¸€äº›ä¼˜åŒ–ï¼Œæ¥æé«˜ç”¨æˆ·ä½“éªŒã€å¼€å‘ä½“éªŒä»¥åŠè¿è¡Œæ—¶çš„æ€§èƒ½ã€‚æ¯”å¦‚:

- babel-plugin-lodashï¼šå°† lodash å¯¼å…¥è½¬æ¢ä¸ºæŒ‰éœ€å¯¼å…¥
- babel-plugin-importï¼šå®ç°æŒ‰éœ€å¯¼å…¥
- babel-react-optimizeï¼šé™æ€åˆ†æ React ä»£ç ï¼Œåˆ©ç”¨ä¸€å®šçš„æªæ–½ä¼˜åŒ–è¿è¡Œæ•ˆç‡ã€‚æ¯”å¦‚å°†é™æ€çš„ props æˆ–ç»„ä»¶æŠ½ç¦»ä¸ºå¸¸é‡
- root-importï¼šå°†åŸºäºæ ¹ç›®å½•çš„å¯¼å…¥è·¯å¾„é‡å†™ä¸ºç›¸å¯¹è·¯å¾„
- styled-componentsï¼šå…¸å‹çš„ CSS-in-js æ–¹æ¡ˆï¼Œåˆ©ç”¨ Babel æ’ä»¶æ¥æ”¯æŒæœåŠ¡ç«¯æ¸²æŸ“ã€é¢„ç¼–è¯‘æ¨¡æ¿ã€æ ·å¼å‹ç¼©ã€æ¸…é™¤æ­»ä»£ç ã€æå‡è°ƒè¯•ä½“éªŒ
- prevalï¼šåœ¨ç¼–è¯‘æ—¶é¢„æ‰§è¡Œä»£ç 
- babel-plugin-graphql-tagï¼šé¢„ç¼–è¯‘ GraphQL æŸ¥è¯¢

ä¸Šé¢åˆ—ä¸¾çš„æ’ä»¶åœºæ™¯ä¸­ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰æ’ä»¶éƒ½æ˜¯é€šç”¨çš„ï¼Œå®ƒä»¬è¦ä¹ˆæ˜¯è·ŸæŸä¸€ç‰¹å®šçš„æ¡†æ¶ç»‘å®šã€è¦ä¹ˆç”¨äºå¤„ç†ç‰¹å®šçš„æ–‡ä»¶ç±»å‹æˆ–æ•°æ®ï¼Œè¿™äº›éé€šç”¨çš„æ’ä»¶æ˜¯æœ€é€‚åˆä½¿ç”¨ macro å–ä»£çš„ã€‚

ç”¨ preval ä¸¾ä¸ªä¾‹å­ï¼Œä½¿ç”¨æ’ä»¶å½¢å¼ï¼Œä½ é¦–å…ˆè¦é…ç½®æ’ä»¶

```js
{
  "plugins": ["preval"]
}
```

ä»£ç 

```js
// ä¼ é€’ç»™ preval çš„å­—ç¬¦ä¸²ä¼šåœ¨ç¼–è¯‘é˜¶æ®µè¢«æ‰§è¡Œ
// preval æ’ä»¶ä¼šæŸ¥æ‰¾ preval æ ‡è¯†ç¬¦ï¼Œå°†å­—ç¬¦ä¸²æå–å‡ºæ¥æ‰§è¡Œï¼Œåœ¨å°†æ‰§è¡Œçš„ç»“æœèµ‹å€¼ç»™ greeting
const greeting = preval`
  const fs = require('fs')
  module.exports = fs.readFileSync(require.resolve('./greeting.txt'), 'utf8')
`;
```

ä½¿ç”¨ Macro æ–¹å¼

```js
// é¦–å…ˆä½ è¦æ˜¾å¼å¯¼å…¥
import preval from 'preval.macro';

// å’Œä¸Šé¢ä¸€æ ·
const greeting = preval`
  const fs = require('fs')
  module.exports = fs.readFileSync(require.resolve('./greeting.txt'), 'utf8')
`;
```

è¿™ä¸¤è€…è¾¾åˆ°çš„æ•ˆæœæ˜¯ä¸€æ ·çš„ï¼Œä½†æ„ä¹‰å´ä¸å¤ªä¸€æ ·ã€‚æœ‰å“ªäº›åŒºåˆ«ï¼Ÿ

1. å¾ˆæ˜¾ç„¶ï¼ŒMacro ä¸éœ€è¦é…ç½® `.babelrc`ï¼ˆå½“ç„¶ babel-plugin-macros è¿™ä¸ªåŸºåº§éœ€è¦è£…å¥½ï¼‰ï¼Œè¿™ä¸ªå¯¹äº CRA è¿™ç§ä¸æ¨èé…ç½®æ„å»ºè„šæœ¬çš„å·¥å…·æ¥è¯´å¾ˆæœ‰å¸®åŠ©
2. ç”±éšå¼è½¬æ¢ä¸ºäº†æ˜¾å¼ã€‚ä¸Šä¸€èŠ‚å°±è¯´äº†æ˜¾å¼å¥½äºéšå¼ã€‚ä½ å¿…é¡»åœ¨æºä»£ç ä¸­é€šè¿‡å¯¼å…¥è¯­å¥å£°æ˜ä½ ä½¿ç”¨äº† Macroï¼›è€ŒåŸºäºæ’ä»¶çš„æ–¹å¼ï¼Œä½ å¯èƒ½ä¸çŸ¥é“ preval è¿™ä¸ªæ ‡è¯†ç¬¦å“ªé‡Œæ¥çš„? å¦‚ä½•è¢«åº”ç”¨ï¼Ÿä½•æ—¶è¢«åº”ç”¨ï¼Ÿè€Œä¸”é€šå¸¸ä½ è¿˜éœ€è¦å’Œå…¶ä»–å·¥å…·é“¾çš„é…åˆï¼Œä¾‹å¦‚ ESlintã€Typescript å£°æ˜ç­‰

   Macro ç”±ä»£ç æ˜¾å¼åœ°å¼•ç”¨ï¼Œæˆ‘ä»¬æ›´æ˜ç¡®å®ƒè¢«åº”ç”¨çš„ç›®çš„å’Œæ—¶æœºï¼Œå¯¹æºä»£ç çš„ä¾µå…¥æ€§æœ€å°ã€‚å› ä¸ºä¸­é—´å¤šäº† `babel-plugin-macro` è¿™ä¸€å±‚ï¼Œæˆ‘ä»¬é™ä½äº†å¯¹æ„å»ºç¯å¢ƒçš„è€¦åˆï¼Œè®©æˆ‘ä»¬çš„ä»£ç æ›´æ–¹ä¾¿è¢«è¿ç§»

3. Macro ç›¸æ¯” Plugin æ›´å®¹æ˜“è¢«å®ç°ã€‚å› ä¸ºå®ƒä¸“æ³¨äºå…·ä½“çš„ AST èŠ‚ç‚¹ï¼Œè§ä¸‹æ–‡
4. å¦å¤–ï¼Œå½“é…ç½®å‡ºé”™æ—¶ï¼ŒMacro å¯ä»¥å¾—åˆ°æ›´å¥½çš„é”™è¯¯æç¤º

æœ‰åˆ©æœ‰å¼Šï¼ŒBabel Macro è‚¯å®šä¹Ÿæœ‰äº›ç¼ºé™·ï¼Œä¾‹å¦‚ç›¸å¯¹äºæ’ä»¶æ¥è¯´åªèƒ½æ˜¾å¼è½¬æ¢ï¼Œè¿™æ ·ä»£ç å¯èƒ½ä¼šæ¯”è¾ƒå•°å—¦ï¼Œä¸è¿‡ä¸ªäººè§‰å¾—åœ¨æŸäº›åœºæ™¯åˆ©å¤§äºå¼Šï¼Œèƒ½æ˜¾å¼çš„å°±æ˜¾å¼ã€‚

é‚£ä¹ˆ Babel Macro ä¹Ÿæ˜¯å®ï¼Ÿç›¸å¯¹äº Sweet.js è¿™äº›æ­£ç»Ÿçš„å®æœºåˆ¶æœ‰å“ªäº›ä¸è¶³ï¼Ÿ

- é¦–å…ˆ Babel Macro å¿…é¡»æ˜¯åˆæ³•çš„ Javascript è¯­æ³•ã€‚ä¸æ”¯æŒè‡ªå®šä¹‰è¯­æ³•ï¼Œä¹Ÿè¦åˆ†ä¸¤é¢è®¨è®ºï¼Œåˆæ³•çš„ Javascript è¯­æ³•ä¸è‡³äºæ‰“ç ´ç°æœ‰çš„å·¥å…·åä½œé“¾ï¼Œå¦‚æœå…è®¸ç”¨æˆ·æ¯«æ— é™åˆ¶åœ°åˆ›å»ºæ–°çš„è¯­æ³•ï¼Œå°†æ¥æŒ‡ä¸å®šä¼šå’Œæ ‡å‡†çš„è¯­æ³•å‘ç”Ÿæ­§ä¹‰ã€‚åè¿‡æ¥ä¸èƒ½è‡ªå®šä¹‰è¯­æ³•çš„å®ï¼Œæ˜¯å¦æ˜¾å¾—ä¸å¤ªåœ°é“ï¼Œä¸å¤Ÿå¼ºå¤§?
- å› ä¸ºå¿…é¡»æ˜¯åˆæ³•çš„ Javascript è¯­æ³•ï¼ŒBabel Macro å®ç° DSLï¼ˆDomain-specific languagesï¼‰èƒ½åŠ›å°±å¼±åŒ–äº†
- å†è€…ï¼ŒBabel Macro å’Œ Babel Plugin æ²¡æœ‰æœ¬è´¨çš„åŒºåˆ«ï¼Œç›¸æ¯” Sweet.js æä¾›äº†æ˜¾å¼å®šä¹‰å’Œåº”ç”¨å®çš„è¯­æ³•ï¼ŒBabel Macro ç›´æ¥æ“ä½œ AST åˆ™è¦å¤æ‚å¾—å¤šï¼Œä½ è¿˜æ˜¯éœ€è¦äº†è§£ä¸€äº›ç¼–è¯‘åŸç†ï¼Œè¿™æŠŠä¸€èˆ¬çš„å¼€å‘è€…æŒ¡åœ¨äº†é—¨å¤–ã€‚

> Babel å¯ä»¥å®ç°è‡ªå®šä¹‰è¯­æ³•ï¼Œåªä¸è¿‡ä½ éœ€è¦ Fork `@babel/parser`ï¼Œå¯¹å®ƒè¿›è¡Œæ”¹é€ (å¯ä»¥çœ‹è¿™ç¯‡æ–‡ç« [ç”¨ Babel åˆ›é€ è‡ªå®šä¹‰ JS è¯­æ³•](https://juejin.im/post/5d9be731f265da5bbc3e879b))ã€‚è¿™ä¸ªæœ‰ç‚¹æŠ˜è…¾ï¼Œä¸å¤ªæ¨è

æ€»ä¹‹ï¼ŒBabel Macro æœ¬è´¨ä¸Šå’Œ Babel Plugin æ²¡æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Œå®ƒåªæ˜¯åœ¨ Plugin ä¹‹ä¸Šå°è£…äº†ä¸€å±‚(åˆ†å±‚æ¶æ„æ¨¡å¼çš„å¼ºå¤§)ï¼Œåˆ›å»ºäº†ä¸€ä¸ªæ–°çš„å¹³å°ï¼Œè®©å¼€å‘è€…å¯ä»¥åœ¨æºä»£ç å±‚é¢æ˜¾å¼åœ°åº”ç”¨ä»£ç è½¬æ¢ã€‚æ‰€ä»¥ï¼Œä»»ä½•é€‚åˆæ˜¾å¼å»è½¬æ¢çš„åœºæ™¯éƒ½é€‚åˆç”¨ Babel Macro æ¥åšï¼š

- ç‰¹å®šæ¡†æ¶ã€åº“çš„ä»£ç è½¬æ¢ï¼Œå¦‚ styled-components
- åŠ¨æ€ç”Ÿæˆä»£ç ï¼Œå¦‚ preval
- ç‰¹å®šæ–‡ä»¶ã€è¯­è¨€çš„å¤„ç†ï¼Œå¦‚ `graphql-tag.macro`ã€`yaml.macro`ã€`svgr.macro`

# å¦‚ä½•å†™ä¸€ä¸ª Babel Macro

æ‰€ä»¥ Babel Macro æ˜¯å¦‚ä½•è¿ä½œçš„å‘¢ï¼Ÿ babel-plugin-macros è¦æ±‚å¼€å‘è€…å¿…é¡»æ˜¾å¼åœ°å¯¼å…¥ Macroï¼Œå®ƒä¼šéå†åŒ¹é…æ‰€æœ‰å¯¼å…¥è¯­å¥ï¼Œå¦‚æœå¯¼å…¥æºåŒ¹é… `/[./]macro(\.js)?$/` æ­£åˆ™ï¼Œå°±ä¼šè®¤ä¸ºä½ åœ¨å¯ç”¨ Macroã€‚ä¾‹å¦‚ä¸‹é¢è¿™äº›å¯¼å…¥è¯­å¥éƒ½åŒ¹é…æ­£åˆ™ï¼š

```js
import foo from 'my.macro';
import { bar } from './bar/macro';
import { baz as _baz } from 'baz/macro.js';
// ä¸æ”¯æŒå‘½åç©ºé—´å¯¼å…¥
```

å½“åŒ¹é…åˆ°å¯¼å…¥è¯­å¥åï¼Œbabel-plugin-macros å°±ä¼šå»å¯¼å…¥ä½ æŒ‡å®šçš„ macro æ¨¡å—æˆ–è€… npm åŒ…(Macro å³å¯ä»¥æ˜¯æœ¬åœ°æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥æ˜¯å…¬å¼€çš„ npm åŒ…ï¼Œ æˆ–è€…æ˜¯ npm åŒ…ä¸­çš„å­è·¯å¾„)ã€‚

é‚£ä¹ˆ macro æ–‡ä»¶é‡Œé¢è¦åŒ…å«ä»€ä¹ˆå†…å®¹å‘¢ï¼Ÿå¦‚ä¸‹:

```js
const { createMacro } = require('babel-plugin-macros');

module.exports = createMacro(({ references, state, babel }) => {
  // ... macro é€»è¾‘
});
```

macro æ–‡ä»¶å¿…é¡»é»˜è®¤å¯¼å‡ºä¸€ä¸ªç”± createMacro åˆ›å»ºçš„å®ä¾‹ï¼Œåœ¨å…¶å›è°ƒä¸­å¯ä»¥è·å–åˆ°ä¸€äº›å…³é”®å¯¹è±¡

- babel å’Œæ™®é€šçš„ Babel æ’ä»¶ä¸€æ ·ï¼ŒMacro å¯ä»¥è·å–åˆ°ä¸€ä¸ª babel-core å¯¹è±¡
- state è¿™ä¸ªæˆ‘ä»¬ä¹Ÿæ¯”è¾ƒç†Ÿæ‚‰ï¼ŒBabel æ’ä»¶çš„ visitor æ–¹æ³•çš„ç¬¬äºŒä¸ªå‚æ•°å°±æ˜¯å®ƒï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å®ƒè·å–ä¸€äº›é…ç½®ä¿¡æ¯ä»¥åŠä¿å­˜ä¸€äº›è‡ªå®šä¹‰çŠ¶æ€
- references è·å– Macro å¯¼å‡ºæ ‡è¯†ç¬¦çš„æ‰€æœ‰å¼•ç”¨

å‡è®¾ç”¨æˆ·è¿™æ ·å­ä½¿ç”¨ä½ çš„ Macro

```js
import foo, { bar, baz as Baz } from './my.macro'; // åˆ›å»ºä¸‰ä¸ªç»‘å®š

// ä¸‹é¢å¼€å§‹å¼•ç”¨è¿™äº›ç»‘å®š
foo(1);
foo(2);

bar`by tagged Template`;
<Baz>by JSX</Baz>;
```

é‚£ä¹ˆä½ å°†æ‹¿åˆ° references ç»“æ„æ˜¯è¿™æ ·çš„

```js
{
  // key ä¸º'ç»‘å®š', value ä¸º'å¼•ç”¨æ•°ç»„'
  default: [NodePath/*Identifier(foo)*/, NodePath/*Identifier(foo)*/], // é»˜è®¤å¯¼å‡ºï¼Œå³foo
  bar: [NodePath/*Identifier(bar)*/],
  baz: [NodePath/*JSXIdentifier(Baz)*/], // æ³¨æ„keyä¸ºbazï¼Œä¸æ˜¯Baz
}
```

æ¥ä¸‹æ¥ä½ å°±å¯ä»¥éå† referencesï¼Œå¯¹è¿™äº›èŠ‚ç‚¹è¿›è¡Œè½¬æ¢ï¼Œå®ç°ä½ æƒ³è¦çš„å®åŠŸèƒ½

## å®æˆ˜

è¿™ä¸€æ¬¡æˆ‘ä»¬æ¨¡èŒƒ preval åˆ›å»ºä¸€ä¸ª `eval.macro`, åˆ©ç”¨å®ƒåœ¨ç¼–è¯‘é˜¶æ®µæ‰§è¡Œï¼ˆevalï¼‰ä¸€äº›ä»£ç ï¼Œä¾‹å¦‚

```js
import evalm from 'eval.macro';
const x = evalm`
function fib(n) {
  const SQRT_FIVE = Math.sqrt(5);
  return Math.round(1/SQRT_FIVE * (Math.pow(0.5 + SQRT_FIVE/2, n) - Math.pow(0.5 - SQRT_FIVE/2, n)));
}

fib(20)
`;

const x = 6765;
```

åˆ›å»º Macro æ–‡ä»¶ï¼ŒæŒ‰ç…§ä¸Šä¸€èŠ‚çš„ä»‹ç»

1. æˆ‘ä»¬ä½¿ç”¨ createMacro æ¥åˆ›å»ºä¸€ä¸ª Macro å®ä¾‹
2. å¹¶ä» references ä¸­æ‹¿å‡ºæ‰€æœ‰å¯¼å‡ºæ ‡è¯†ç¬¦çš„å¼•ç”¨è·¯å¾„
3. æ¥ç€å°±æ˜¯å¯¹è¿™äº›å¼•ç”¨è·¯å¾„è¿›è¡Œ AST è½¬æ¢

```js
const { createMacro, MacroError } = require('babel-plugin-macros');

function myMacro({ references, state, babel }) {
  // è·å–é»˜è®¤å¯¼å‡ºçš„æ‰€æœ‰å¼•ç”¨
  const { default: defaultImport = [] } = references;

  // éå†å¼•ç”¨å¹¶è¿›è¡Œæ±‚å€¼
  defaultImport.forEach((referencePath) => {
    if (referencePath.parentPath.type === 'TaggedTemplateExpression') {
      const val = referencePath.parentPath.get('quasi').evaluate().value;
      const res = eval(val);
      const ast = objToAst(res);
      referencePath.parentPath.replaceWith(ast);
    } else {
      // è¾“å‡ºå‹å¥½çš„æŠ¥é”™ä¿¡æ¯
      throw new MacroError('åªæ”¯æŒæ ‡ç­¾æ¨¡æ¿å­—ç¬¦ä¸², ä¾‹å¦‚ï¼ševalm`1`');
    }
  });
}

module.exports = createMacro(myMacro);
```

ä¸ºäº†è¡Œæ–‡ç®€æ´ï¼Œæœ¬æ¡ˆä¾‹ä¸­åªæ”¯æŒ [æ ‡ç­¾æ¨¡æ¿å­—ç¬¦ä¸²](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/template_strings) å½¢å¼è°ƒç”¨ï¼Œä½†æ˜¯æ ‡ç­¾æ¨¡æ¿å­—ç¬¦ä¸²ä¸­å¯èƒ½åŒ…å«å†…æ’çš„å­—ç¬¦ä¸²ï¼Œä¾‹å¦‚

```js
hello`
hello world ${foo} + ${bar + baz}
`;
```

å…¶ AST ç»“æ„å¦‚ä¸‹

![](res/2021-07-29-10-02-19.png)

æˆ‘ä»¬éœ€è¦å°† TaggedTemplateExpression èŠ‚ç‚¹è½¬æ¢ä¸ºå­—ç¬¦ä¸²ã€‚æ‰‹åŠ¨å»æ‹¼æ¥ä¼šå¾ˆéº»çƒ¦ï¼Œå¥½åœ¨æ¯ä¸ª AST èŠ‚ç‚¹çš„ Path å¯¹è±¡éƒ½æœ‰ä¸€ä¸ª evaluate æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å¯ä»¥å¯¹èŠ‚ç‚¹è¿›è¡Œé™æ€æ±‚å€¼

```js
t.evaluate(parse('5 + 5')); // { confident: true, value: 10 }
t.evaluate(parse('!true')); // { confident: true, value: false }
// âŒä¸¤ä¸ªå˜é‡ç›¸åŠ æ— æ³•æ±‚å€¼ï¼Œå› ä¸ºå˜é‡å€¼åœ¨è¿è¡Œæ—¶æ‰å­˜åœ¨ï¼Œè¿™é‡Œconfidentä¸ºfalseï¼š
t.evaluate(parse('foo + foo')); // { confident: false, value: undefined }
```

å› æ­¤è¿™æ ·å­çš„æ ‡ç­¾æ¨¡æ¿å­—ç¬¦ä¸²æ˜¯æ— æ³•æ±‚å€¼çš„

```js
evalm`1 + ${foo}`; // åŒ…å«å˜é‡
evalm`1 + ${bar(1)}`; // åŒ…å«å‡½æ•°è°ƒ
```

è¿™ä¸ªå’Œ Typescript çš„ enumï¼Œè¿˜æœ‰ä¸€äº›ç¼–è¯‘è¯­è¨€çš„å¸¸é‡æ˜¯ä¸€æ ·çš„ï¼Œå®ƒä»¬åœ¨ç¼–è¯‘é˜¶æ®µè¢«æ±‚å€¼ï¼Œåªæœ‰ä¸€äº›åŸå§‹å€¼ä»¥åŠä¸€äº›åŸå§‹å€¼çš„è¡¨è¾¾å¼æ‰æ”¯æŒåœ¨ç¼–è¯‘é˜¶æ®µè¢«æ±‚å€¼

Soï¼Œä¸Šé¢çš„ä»£ç è¿˜ä¸å¤Ÿå¥å£®ï¼Œæˆ‘ä»¬å†ä¼˜åŒ–ä¸€ä¸‹ï¼Œåœ¨æ±‚å€¼å¤±è´¥æ—¶ç»™ç”¨æˆ·æ›´å¥½çš„æç¤º:

```js
defaultImport.forEach((referencePath) => {
  if (referencePath.parentPath.type === 'TaggedTemplateExpression') {
    const evaluated = referencePath.parentPath.get('quasi').evaluate();
    // è½¬æ¢æ ‡ç­¾æ¨¡æ¿å­—ç¬¦ä¸²å¤±è´¥
    if (!evaluated.confident) {
      throw new MacroError('æ ‡ç­¾æ¨¡æ¿å­—ç¬¦ä¸²å†…æ’å€¼åªæ”¯æŒåŸå§‹å€¼å’ŒåŸå§‹å€¼è¡¨è¾¾å¼');
    }

    try {
      const res = eval(evaluated.value);
      const ast = objToAst(res);
      // æ›¿æ¢æ‰è°ƒç”¨èŠ‚ç‚¹
      referencePath.parentPath.replaceWith(ast);
    } catch (err) {
      throw new MacroError(`æ±‚å€¼å¤±è´¥: ${err.message}`);
    }
  } else {
    throw new MacroError('åªæ”¯æŒæ ‡ç­¾æ¨¡æ¿å­—ç¬¦ä¸², ä¾‹å¦‚ï¼ševalm`1 + 1`');
  }
});
```

æ¥ä¸‹æ¥å°†æ‰§è¡Œåçš„å€¼è½¬æ¢ä¸º ASTï¼Œç„¶åæ›¿æ¢æ‰ TaggedTemplateExpression

```js
function objToAst(res) {
  let str = JSON.stringify(res);
  if (str == null) {
    str = 'undefined';
  }
  const variableDeclarationNode = babel.template(`var x = ${str}`, {})();
  // å–å‡ºåˆå§‹åŒ–è¡¨è¾¾å¼çš„ AST
  return variableDeclarationNode.declarations[0].init;
}
```

è¿™é‡Œ `@babel/template` å°±æ´¾ä¸Šç”¨åœºäº†ï¼Œå®ƒå¯ä»¥å°†å­—ç¬¦ä¸²ä»£ç è§£ææˆ ASTï¼Œå½“ç„¶ç›´æ¥ä½¿ç”¨ parse æ–¹æ³•è§£æä¹Ÿæ˜¯å¯ä»¥çš„ã€‚

Babel Macro æœ¬è´¨ä¸Šè¿˜æ˜¯ Babel æ’ä»¶ï¼Œåªä¸è¿‡å®ƒæ˜¯æ¨¡å—åŒ–çš„ï¼Œä½ è¦ä½¿ç”¨å®ƒå¿…é¡»æ˜¾å¼åœ°å¯¼å…¥ã€‚å’Œæ­£ç»Ÿå®ç›¸æ¯”ï¼ŒBabel Macro ç›´æ¥æ“ä½œ ASTï¼Œéœ€è¦ä½ æŒæ¡ç¼–è¯‘åŸç†ï¼Œæ­£ç»Ÿå®å¯ä»¥å®ç°çš„ä¸œè¥¿ï¼ŒBabel Macro ä¹Ÿå¯ä»¥å®ç°(ä¾‹å¦‚å«ç”Ÿå®)ã€‚è™½ç„¶ç›¸æ¯” Babel æ’ä»¶ç•¥æœ‰ç®€åŒ–ï¼Œè¿˜æ˜¯æ¯”è¾ƒå•°å—¦ã€‚å¦å¤– Babel Macro ä¸èƒ½åˆ›å»ºæ–°çš„è¯­æ³•ï¼Œè¿™ä½¿å¾—å®ƒå¯ä»¥å’Œç°æœ‰çš„å·¥å…·ç”Ÿæ€ä¿æŒå…¼å®¹ã€‚
