webpackJsonp([0xbc0b0b31708d],{1306:function(n,a){n.exports={data:{file:{childImageSharp:{sizes:{base64:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAeCAYAAAAsEj5rAAAACXBIWXMAAAsSAAALEgHS3X78AAAHlElEQVRIx12We2xT5xXAbcI2Vmn7o1I1uhVYRxL8tuPn9bXv0+/4/YgdOyYkkATCCEEYsqVNC2wCIYQWShmUBFh4hMAWECot0BUtlI4yAS1oKqJQXimsDBgTU8codnLO7r0uUPpJn87Rp+/8vvOdc75zr8xmZmTieI1NykU5yxOfxDncz3NUjAlyDXMjXGMhys+cG+FzGQ8VU4t7XuV8z8m+GUkrJclSqVReYJ0ZWQ8Tl2AdTPhnq9ns2QKd+crDZiHha8NsYCE21HZiXphpb3sxxTf99Tdsw51ldHqFaLOXXyzvYqOyZ0YPk5soylfouuUbvHOxh56JbiqJfi4/FnE1lxKetrGUZ954nbcdU/752ORpxWVsc6mZjPxctFtApeVtra1lmIPwTxClgeCqvGTsX/WWOEbtyTGWSoGbToOPzUHQ1QghVxOEhRniZ5U8XB4TzvTdgj1ZJdq2OOrkGhVRBnrYFum6TiK0l2fr0emMlVxcBhlnEniqDjlBuqg0CnD0MPWiDrwzhR4u+5B3x3WiLUNHJjxzZYvR8ZKTCP+Xo1JoM/nBYvSB1egHuyUIrCOBPj4LtD0KlD2K4h7SGip62aygxzaK9rHA3Aqt2vw0MRYjnyJtYaQdsXG9hgWFwgmVlXZUKUjUqmm0CgfwhA80Kgr1Wg40Sue4SuFEnZq+YjMbJ0kh0zmfemjQ0j2EJYh2a23RVOODIBvHmCsBUaoWLDoWKIsP50bTApxC5QwH1Ghp0Gk4MBk8aDLQEslooCc88VClsK+zGANI2mqLer0XFuea8PSuN+DM7o3QWyhAR7IBfj+vDbyOICS9aSjkZo8nvSlUKuxXLDUOKdN6LSl/AlRUE+vNAnD50l8XeTIEPiYEzXYG5mlNeGz7BvjPpY/g5snDcHxwE+zs7oCh1zvHCrNm48u/ML8j2muVQblBZ3t6ZY2KXKtQcDiwdk1xx9rV0BlqghEuD4fNUTy1Zwhw7Cbioxu461fdsOgFDa5pbh3zu6NifE9f+XCPlGHS5nuaFI3K8brJ4EUHES4WFiyEP2/dCPc2vYH/3NIHePcywP1LWLp3Ec4tWQa3FvbAu7294yqVA801rju5utYfiQyKDD4DnC8GWEhMafJPtBALxuHjo3+C8bufIn59DfHBFcDiDcQvzyF+/iEsbWuDadNMaDW5H7nY6Iyyh165zfLNtdUqIqLTsEJSQqBVUTD1JQPqdRT8sf9NuH7kMHy0fRg+O3EUzp96H/Zs2SBklxFKxwFmowtdTCIoPQx7oKLzl32PPTRPVSudDwQgCrUGL0+twdzsDjjSdwD2J1fh/q7N0N+1EtykB178qVY4lAahRktWkw95JrG4DAxPvHU3Wwb+rlcsHfK0WNxCoMdUCgdUaxnMBPKw7dVe2LyhDw4MboORA4NQOd2CaiUFaqWjZJGAyQGRUeubP8FqElqZspquEBeUM2zrnEQUa3R8USVcp2qGDZV6ErqXL4PfrlwFhSU9cPL4MejfshOsZq90sCg5KvHZ5MnPfa+cmFrxukRFuRZNcYqIoNngHheeFmiF11ClIDBdPwfqG9qhc1E3rF25GnrX90M204JqBfWItPrP8lTqa7vFpSw3GJ9cZjI4pW5TXaWezpKxh4Q5gEY9LwApVOtZMApxVWhd2DKvC7K5FjTUsFCj45Ah4yXaHuz1MBlgyHCb1HXISIXMTcekOJqN1h/72Mx92h5DwuwHjeChWseBQsNgJJ6H944eB5oNgaLajnaL/07E24wuKr7Cz+XuuenUsMioCxYmyHhnSPLQTYVVYVfjI46Mo80WBLMgLY4E1FhCOENBAsfHQG/0juuNPqGguU8ywXas5XNbg6783wJ8w781GtUPJc+irkap/Ufdje0JXytStnDJbA2D1Z4EKxEHsyUMRmsIdcZaNFpCYBYqwWQLPhD3Btn6t2Pe5uF0cD7Sdr/xmSab8racFaDooOvuk0wDEs40EFQGbVQGbEKXJoTPgZ3JoJGIgULvR6M1jE67rzvpae5ojC7GEJ9rfgILc7lC3NV0T6flTtjoPLK+VuD8rcD65gDtaQInPxOtzoxQRrXgD8/BdW/+YezYByfxvfdHvnxl+ZLKCDfzUMIze60Ey+brJukrqcjA1u3tBw8dfZiZuRQFaNFory/WEPUlE5kFK5WDQKRtbFPfUOnChUvFL27cwKuj/8CBHXv2iQw/k/KGuNwyCYiIkhw+sO/569eu7b1+ffR/H5z4BAcG38X1m/biyjX9ODR8GC9dHsXLV0fx5KlzePDIyFd7ht9ZJZhJrcvLhV/wMuUPljQWtC6Z+FjfuWPHlPMXLq64Onpz3d8/Pf9WX//OW2vWbITBof3n3tqya9fbh/7SvW1gZ9Xj/V1dr8kf614qIZONjBwrezi8Ty54K5d9ZzTmF+xe1LnioaD+4Nvrn4/ermif3yHp8UCDLMCky7Z+n192+/YdST9z5mPZ7t1D8ouXv6gQ4S9WTplks7mut8xZijxbKz2vvi2D39/cPyB/HC5xOm2czPvd35F8rkGCS0+I4WXV1QbJaMq06XqbNXCQJIILpH8hOic3GghZMpl62qG/Nf4PRzaQ862MzO4AAAAASUVORK5CYII=",aspectRatio:.6666666666666666,src:"/static/avatar-dc7bc85837bf005ae32d2a37dfdfa8a2-25c91.png",srcSet:"/static/avatar-dc7bc85837bf005ae32d2a37dfdfa8a2-8a97b.png 200w,\n/static/avatar-dc7bc85837bf005ae32d2a37dfdfa8a2-0fdf3.png 400w,\n/static/avatar-dc7bc85837bf005ae32d2a37dfdfa8a2-25c91.png 600w",srcWebp:"/static/avatar-dc7bc85837bf005ae32d2a37dfdfa8a2-216f6.webp",srcSetWebp:"/static/avatar-dc7bc85837bf005ae32d2a37dfdfa8a2-5d70e.webp 200w,\n/static/avatar-dc7bc85837bf005ae32d2a37dfdfa8a2-d1677.webp 400w,\n/static/avatar-dc7bc85837bf005ae32d2a37dfdfa8a2-216f6.webp 600w",sizes:"(max-width: 600px) 100vw, 600px"}}},site:{siteMetadata:{title:"女王控的博客",description:'前端工程师，黑猫女王控，欢迎勾搭，技术相关<a href="https://github.com/towavephone" target="_blank">@towavephone</a>，QQ闲聊<a href="tencent://AddContact/?fromId=45&fromSubId=1&subcmd=all&uin=634407147&website=www.oicqzone.com">@towave</a>，bili关注<a href="https://space.bilibili.com/11507708#/" target="_blank">@towave</a>',siteUrl:"https://blog.towavephone.com"}},mainPost:{html:'<h1 id="一个站点配置多个域名"><a href="#%E4%B8%80%E4%B8%AA%E7%AB%99%E7%82%B9%E9%85%8D%E7%BD%AE%E5%A4%9A%E4%B8%AA%E5%9F%9F%E5%90%8D" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>一个站点配置多个域名</h1>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="30486592483215036000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`server {\n    listen       80;\n    server_name  ops-coffee.cn b.ops-coffee.cn;\n}`, `30486592483215036000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">server {\n    listen       80;\n    server_name  ops-coffee.cn b.ops-coffee.cn;\n}</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>server_name 后跟多个域名即可，多个域名之间用空格分隔</p>\n<h1 id="一个服务配置多个站点"><a href="#%E4%B8%80%E4%B8%AA%E6%9C%8D%E5%8A%A1%E9%85%8D%E7%BD%AE%E5%A4%9A%E4%B8%AA%E7%AB%99%E7%82%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>一个服务配置多个站点</h1>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="45447780058798520000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`server {\n    listen       80;\n    server_name  a.ops-coffee.cn;\n\n    location / {\n        root /home/project/pa;\n        index index.html;\n    }\n}\n\nserver {\n    listen       80;\n    server_name  ops-coffee.cn b.ops-coffee.cn;\n\n    location / {\n        root /home/project/pb;\n        index index.html;\n    }\n}\n\nserver {\n    listen       80;\n    server_name  c.ops-coffee.cn;\n\n    location / {\n        root /home/project/pc;\n        index index.html;\n    }\n}`, `45447780058798520000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">server {\n    listen       80;\n    server_name  a.ops-coffee.cn;\n\n    location / {\n        root /home/project/pa;\n        index index.html;\n    }\n}\n\nserver {\n    listen       80;\n    server_name  ops-coffee.cn b.ops-coffee.cn;\n\n    location / {\n        root /home/project/pb;\n        index index.html;\n    }\n}\n\nserver {\n    listen       80;\n    server_name  c.ops-coffee.cn;\n\n    location / {\n        root /home/project/pc;\n        index index.html;\n    }\n}</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>基于 nginx 虚拟主机配置实现，nginx 有三种类型的虚拟主机</p>\n<p>基于 ip 的虚拟主机：需要你的服务器上有多个地址，每个站点对应不同的地址，这种方式使用的比较少</p>\n<p>基于端口的虚拟主机：每个站点对应不同的端口，访问的时候使用 ip:port 的方式访问，可以修改 listen 的端口来使用</p>\n<p>基于域名的虚拟主机：使用最广的方式，上边例子中就是用了基于域名的虚拟主机，前提条件是你有多个域名分别对应每个站点，server_name 填写不同的域名即可</p>\n<h1 id="nginx-添加账号密码验证"><a href="#nginx-%E6%B7%BB%E5%8A%A0%E8%B4%A6%E5%8F%B7%E5%AF%86%E7%A0%81%E9%AA%8C%E8%AF%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>nginx 添加账号密码验证</h1>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="11809241179937513000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`server {\n    location / {\n        auth_basic &quot;please input user&passwd&quot;;\n        auth_basic_user_file key/auth.key;\n    }\n}`, `11809241179937513000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">server {\n    location / {\n        auth_basic &quot;please input user&amp;passwd&quot;;\n        auth_basic_user_file key/auth.key;\n    }\n}</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>有很多服务通过 nginx 访问，但本身没有提供账号认证的功能，就可以通过 nginx 提供的 authbase 账号密码认证来实现，可以用以下脚本来生成账号的密码</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="36470967567936864000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# cat pwd.pl\n#!/usr/bin/perl\nuse strict;\n\nmy \\$pw=\\$ARGV[0] ;\nprint crypt(\\$pw,\\$pw).&quot;\\n&quot;;`, `36470967567936864000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token comment"># cat pwd.pl</span>\n<span class="token comment">#!/usr/bin/perl</span>\nuse strict<span class="token punctuation">;</span>\n\nmy <span class="token variable">$pw</span><span class="token operator">=</span><span class="token variable">$ARGV</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token punctuation">;</span>\nprint crypt<span class="token punctuation">(</span><span class="token variable">$pw</span>,<span class="token variable">$pw</span><span class="token punctuation">)</span>.<span class="token string">"<span class="token entity" title="\\n">\\n</span>"</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>使用方法：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="96265971769938000000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# perl pwd.pl ops-coffee.cn\nopf8BImqCAXww\n# echo &quot;admin:opf8BImqCAXww&quot; > key/auth.key`, `96265971769938000000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token comment"># perl pwd.pl ops-coffee.cn</span>\nopf8BImqCAXww\n<span class="token comment"># echo "admin:opf8BImqCAXww" > key/auth.key</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<h1 id="nginx-开启列目录"><a href="#nginx-%E5%BC%80%E5%90%AF%E5%88%97%E7%9B%AE%E5%BD%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>nginx 开启列目录</h1>\n<p>当你想让 nginx 作为文件下载服务器存在时，需要开启 nginx 列目录</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="55392431592076270000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`server {\n    location download {\n        autoindex on;\n\n        autoindex_exact_size off;\n        autoindex_localtime on;\n    }\n}`, `55392431592076270000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">server {\n    location download {\n        autoindex on;\n\n        autoindex_exact_size off;\n        autoindex_localtime on;\n    }\n}</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><code class="language-text">autoindex_exact_size</code>：为 on（默认）时显示文件的确切大小，单位是 byte；改为 off 显示文件大概大小，单位 KB 或 MB 或 GB</p>\n<p><code class="language-text">autoindex_localtime</code>：为 off（默认）时显示的文件时间为 GMT 时间；改为 on 后，显示的文件时间为服务器时间</p>\n<p>默认当访问列出的 txt 等文件时会在浏览器上显示文件的内容，如果你想让浏览器直接下载，加上下边的配置</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="64681518509818030000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`if (\\$request_filename ~* ^.*?\\.(txt|pdf|jpg|png)\\$) {\n    add_header Content-Disposition \'attachment\';\n}`, `64681518509818030000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">if ($request_filename ~* ^.*?\\.(txt|pdf|jpg|png)$) {\n    add_header Content-Disposition &#39;attachment&#39;;\n}</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<h1 id="配置默认站点"><a href="#%E9%85%8D%E7%BD%AE%E9%BB%98%E8%AE%A4%E7%AB%99%E7%82%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>配置默认站点</h1>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="81742300909219500000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`server {\n    listen 80 default;\n}`, `81742300909219500000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">server {\n    listen 80 default;\n}</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>当一个 nginx 服务上创建了多个虚拟主机时默认会从上到下查找，如果匹配不到虚拟主机则会返回第一个虚拟主机的内容，如果你想指定一个默认站点时，可以将这个站点的虚拟主机放在配置文件中第一个虚拟主机的位置，或者在这个站点的虚拟主机上配置 listen default</p>\n<h1 id="不允许通过-ip-访问"><a href="#%E4%B8%8D%E5%85%81%E8%AE%B8%E9%80%9A%E8%BF%87-ip-%E8%AE%BF%E9%97%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>不允许通过 IP 访问</h1>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="33057128389695390000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`server {\n    listen       80 default;\n    server_name  _;\n\n    return      404;\n}`, `33057128389695390000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">server {\n    listen       80 default;\n    server_name  _;\n\n    return      404;\n}</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可能有一些未备案的域名或者你不希望的域名将服务器地址指向了你的服务器，这时候就会对你的站点造成一定的影响，需要禁止 IP 或未配置的域名访问，我们利用上边所说的 default 规则，将默认流量都转到 404 去</p>\n<p>上边这个方法比较粗暴，当然你也可以配置下所有未配置的地址访问时直接 301 重定向到你的网站去，也能为你的网站带来一定的流量</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="66244827400132690000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`server {\n    rewrite ^/(.*)\\$ https://ops-coffee.cn/\\$1    permanent;\n}`, `66244827400132690000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">server {\n    rewrite ^/(.*)$ https://ops-coffee.cn/$1    permanent;\n}</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<h1 id="直接返回验证文件"><a href="#%E7%9B%B4%E6%8E%A5%E8%BF%94%E5%9B%9E%E9%AA%8C%E8%AF%81%E6%96%87%E4%BB%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>直接返回验证文件</h1>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="11227169317434282000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`location = /XDFyle6tNA.txt {\n    default_type text/plain;\n    return 200 \'d6296a84657eb275c05c31b10924f6ea\';\n}`, `11227169317434282000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">location = /XDFyle6tNA.txt {\n    default_type text/plain;\n    return 200 &#39;d6296a84657eb275c05c31b10924f6ea&#39;;\n}</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>很多时候微信等程序都需要我们放一个 txt 的文件到项目里以验证项目归属，我们可以直接通过上边这种方式修改 nginx 即可，无需真正的把文件给放到服务器上</p>\n<h1 id="nginx-配置-upstream-反向代理"><a href="#nginx-%E9%85%8D%E7%BD%AE-upstream-%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>nginx 配置 upstream 反向代理</h1>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="1956396321518116900"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`http {\n    ...\n    upstream tomcats {\n        server 192.168.106.176 weight=1;\n        server 192.168.106.177 weight=1;\n    }\n\n    server {\n        location /ops-coffee/ {\n            proxy_pass http://tomcats;\n\n            proxy_set_header Host \\$host;\n            proxy_set_header X-Real-IP \\$remote_addr;\n            proxy_set_header X-Forwarded-For \\$proxy_add_x_forwarded_for;\n            proxy_set_header X-Forwarded-Proto \\$scheme;\n        }\n    }\n\n}`, `1956396321518116900`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">http {\n    ...\n    upstream tomcats {\n        server 192.168.106.176 weight=1;\n        server 192.168.106.177 weight=1;\n    }\n\n    server {\n        location /ops-coffee/ {\n            proxy_pass http://tomcats;\n\n            proxy_set_header Host $host;\n            proxy_set_header X-Real-IP $remote_addr;\n            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n            proxy_set_header X-Forwarded-Proto $scheme;\n        }\n    }\n\n}</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>稍不注意可能会落入一个 <code class="language-text">proxy_pass</code> 加杠不加杠的陷阱，这里详细说下 <code class="language-text">proxy_pass</code> <code class="language-text">http://tomcats</code> 与 <code class="language-text">proxy_pass</code> <code class="language-text">http://tomcats/</code> 的区别：</p>\n<p>虽然只是一个 / 的区别但结果确千差万别。分为以下两种情况：</p>\n<ol>\n<li>\n<p>目标地址中不带 uri(<code class="language-text">proxy_pass</code> <code class="language-text">http://tomcats</code>)。此时新的目标 url 中，匹配的 uri 部分不做修改，原来是什么就是什么。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="49718729782984200000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`location /ops-coffee/ {\n   proxy_pass  http://192.168.106.135:8181;\n}\n\nhttp://domain/ops-coffee/   -->     http://192.168.106.135:8181/ops-coffee/\nhttp://domain/ops-coffee/action/abc   -->     http://192.168.106.135:8181/ops-coffee/action/abc`, `49718729782984200000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">location /ops-coffee/ {\n   proxy_pass  http://192.168.106.135:8181;\n}\n\nhttp://domain/ops-coffee/   --&gt;     http://192.168.106.135:8181/ops-coffee/\nhttp://domain/ops-coffee/action/abc   --&gt;     http://192.168.106.135:8181/ops-coffee/action/abc</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n<li>\n<p>目标地址中带 uri (<code class="language-text">proxy_pass</code> <code class="language-text">http://tomcats/</code>，/也是 uri) ,此时新的目标 url 中，匹配的 uri 部分将会被修改为该参数中的 uri。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="7568435861555089000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`location /ops-coffee/ {\n   proxy_pass  http://192.168.106.135:8181/;\n}\n\nhttp://domain/ops-coffee/   -->     http://192.168.106.135:8181\nhttp://domain/ops-coffee/action/abc   -->     http://192.168.106.135:8181/action/abc`, `7568435861555089000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">location /ops-coffee/ {\n   proxy_pass  http://192.168.106.135:8181/;\n}\n\nhttp://domain/ops-coffee/   --&gt;     http://192.168.106.135:8181\nhttp://domain/ops-coffee/action/abc   --&gt;     http://192.168.106.135:8181/action/abc</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n</ol>\n<h1 id="nginx-upstream-开启-keepalive"><a href="#nginx-upstream-%E5%BC%80%E5%90%AF-keepalive" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>nginx upstream 开启 keepalive</h1>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="50926064743121870000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`upstream tomcat {\n    server ops-coffee.cn:8080;\n    keepalive 1024;\n}\n\nserver {\n    location / {\n        proxy_http_version 1.1;\n        proxy_set_header Connection &quot;&quot;;\n\n        proxy_pass http://tomcat;\n    }\n}`, `50926064743121870000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">upstream tomcat {\n    server ops-coffee.cn:8080;\n    keepalive 1024;\n}\n\nserver {\n    location / {\n        proxy_http_version 1.1;\n        proxy_set_header Connection &quot;&quot;;\n\n        proxy_pass http://tomcat;\n    }\n}</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>nginx 在项目中大多数情况下会作为反向代理使用，例如 nginx 后接 tomcat，nginx 后接 php 等，这时我们开启 nginx 和后端服务之间的 keepalive 能够减少频繁创建 TCP 连接造成的资源消耗，配置如上</p>\n<p>keepalive: 指定每个 nginxworker 可以保持的最大连接数量为 1024，默认不设置，即 nginx 作为 client 时 keepalive 未生效</p>\n<p><code class="language-text">proxy_http_version 1.1</code>: 开启 keepalive 要求 HTTP 协议版本为 HTTP 1.1</p>\n<p><code class="language-text">proxy_set_header Connection &quot;&quot;</code>: 为了兼容老的协议以及防止 http 头中有 Connection close 导致的 keepalive 失效，这里需要及时清掉 HTTP 头部的 Connection</p>\n<h1 id="404-自动跳转到首页"><a href="#404-%E8%87%AA%E5%8A%A8%E8%B7%B3%E8%BD%AC%E5%88%B0%E9%A6%96%E9%A1%B5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>404 自动跳转到首页</h1>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="74238356167913470000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`server {\n    location / {\n       error_page 404 =  @ops-coffee;\n    }\n\n    location @ops-coffee {\n       rewrite  .*  / permanent;\n    }\n}`, `74238356167913470000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">server {\n    location / {\n       error_page 404 =  @ops-coffee;\n    }\n\n    location @ops-coffee {\n       rewrite  .*  / permanent;\n    }\n}</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>网站出现 404 页面不是特别友好，我们可以通过上边的配置在出现 404 之后给自动跳转到首页去</p>',
excerpt:"一个站点配置多个域名 server_name 后跟多个域名即可，多个域名之间用空格分隔 一个服务配置多个站点 基于 nginx 虚拟主机配置实现，nginx 有三种类型的虚拟主机 基于 ip…",timeToRead:5,tableOfContents:'<ul>\n<li><a href="/nginx-common-configurations-techniques/#%E4%B8%80%E4%B8%AA%E7%AB%99%E7%82%B9%E9%85%8D%E7%BD%AE%E5%A4%9A%E4%B8%AA%E5%9F%9F%E5%90%8D">一个站点配置多个域名</a></li>\n<li><a href="/nginx-common-configurations-techniques/#%E4%B8%80%E4%B8%AA%E6%9C%8D%E5%8A%A1%E9%85%8D%E7%BD%AE%E5%A4%9A%E4%B8%AA%E7%AB%99%E7%82%B9">一个服务配置多个站点</a></li>\n<li><a href="/nginx-common-configurations-techniques/#nginx-%E6%B7%BB%E5%8A%A0%E8%B4%A6%E5%8F%B7%E5%AF%86%E7%A0%81%E9%AA%8C%E8%AF%81">nginx 添加账号密码验证</a></li>\n<li><a href="/nginx-common-configurations-techniques/#nginx-%E5%BC%80%E5%90%AF%E5%88%97%E7%9B%AE%E5%BD%95">nginx 开启列目录</a></li>\n<li><a href="/nginx-common-configurations-techniques/#%E9%85%8D%E7%BD%AE%E9%BB%98%E8%AE%A4%E7%AB%99%E7%82%B9">配置默认站点</a></li>\n<li><a href="/nginx-common-configurations-techniques/#%E4%B8%8D%E5%85%81%E8%AE%B8%E9%80%9A%E8%BF%87-ip-%E8%AE%BF%E9%97%AE">不允许通过 IP 访问</a></li>\n<li><a href="/nginx-common-configurations-techniques/#%E7%9B%B4%E6%8E%A5%E8%BF%94%E5%9B%9E%E9%AA%8C%E8%AF%81%E6%96%87%E4%BB%B6">直接返回验证文件</a></li>\n<li><a href="/nginx-common-configurations-techniques/#nginx-%E9%85%8D%E7%BD%AE-upstream-%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86">nginx 配置 upstream 反向代理</a></li>\n<li><a href="/nginx-common-configurations-techniques/#nginx-upstream-%E5%BC%80%E5%90%AF-keepalive">nginx upstream 开启 keepalive</a></li>\n<li><a href="/nginx-common-configurations-techniques/#404-%E8%87%AA%E5%8A%A8%E8%B7%B3%E8%BD%AC%E5%88%B0%E9%A6%96%E9%A1%B5">404 自动跳转到首页</a></li>\n</ul>',wordCount:{words:222},frontmatter:{date:"2019-06-06 15:03:49",path:"/nginx-common-configurations-techniques/",tags:"后端, nginx",title:"nginx常用配置和技巧",draft:null,catalog_number:null}},nextPost:{html:'<h1 id="概述"><a href="#%E6%A6%82%E8%BF%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>概述</h1>\n<p>相比代码的 Lint 或者 Prettier，或许我们更应该关注代码是否具有弹性。</p>\n<p><a href="https://mobile.twitter.com/dan_abramov" target="_blank" rel="nofollow noreferrer noopener">Dan</a> 总结了弹性组件具有的四个特征：</p>\n<ol>\n<li><strong>不要阻塞数据流。</strong></li>\n<li><strong>时刻准备好渲染。</strong></li>\n<li><strong>不要有单例组件。</strong></li>\n<li><strong>隔离本地状态。</strong></li>\n</ol>\n<p>以上规则不仅适用于 React，它适用于所有 UI 组件。</p>\n<h2 id="不要阻塞渲染的数据流"><a href="#%E4%B8%8D%E8%A6%81%E9%98%BB%E5%A1%9E%E6%B8%B2%E6%9F%93%E7%9A%84%E6%95%B0%E6%8D%AE%E6%B5%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>不要阻塞渲染的数据流</h2>\n<p>不阻塞数据流的意思，就是 <strong>不要将接收到的参数本地化，</strong> 或者 <strong>使组件完全受控</strong>。</p>\n<p>在 Class Component 语法下，<strong>由于有生命周期的概念，在某个生命周期将 <code class="language-text">props</code> 存储到 <code class="language-text">state</code> 的方式屡见不鲜。</strong> 然而一旦将 <code class="language-text">props</code> 固化到 <code class="language-text">state</code>，组件就不受控了：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="47918167884143830000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Button extends React.Component {\n  state = {\n    color: this.props.color\n  };\n  render() {\n    const { color } = this.state; // 🔴 \\`color\\` is stale!\n    return <button className={\'Button-\' + color}>{this.props.children}</button>;\n  }\n}`, `47918167884143830000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="jsx"\n              >\n                <span class="gatsby-code-button-language">jsx</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">class</span> <span class="token class-name">Button</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>\n  state <span class="token operator">=</span> <span class="token punctuation">{</span>\n    color<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>color\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> <span class="token punctuation">{</span> color <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">;</span> <span class="token comment">// 🔴 `color` is stale!</span>\n    <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token string">\'Button-\'</span> <span class="token operator">+</span> color<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>当组件再次刷新时，<code class="language-text">props.color</code> 变化了，但 <code class="language-text">state.color</code> 不会变，这种情况就阻塞了数据流，小伙伴们可能会吐槽组件有 BUG。这时候如果你尝试通过其他生命周期（<code class="language-text">componentWillReceiveProps</code> 或 <code class="language-text">componentDidUpdate</code>）去修复，代码会变得难以管理。</p>\n<p>然而 Function Component 没有生命周期的概念，<strong>所以没有必须要将 <code class="language-text">props</code> 存储到 <code class="language-text">state</code></strong>，直接渲染即可：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="93461785548312640000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function Button({ color, children }) {\n  return (\n    // ✅ \\`color\\` is always fresh!\n    <button className={\'Button-\' + color}>{children}</button>\n  );\n}`, `93461785548312640000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="jsx"\n              >\n                <span class="gatsby-code-button-language">jsx</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">Button</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> color<span class="token punctuation">,</span> children <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token punctuation">(</span>\n    <span class="token comment">// ✅ `color` is always fresh!</span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token string">\'Button-\'</span> <span class="token operator">+</span> color<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token punctuation">{</span>children<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果需要对 <code class="language-text">props</code> 进行加工，可以利用 <code class="language-text">useMemo</code> 对加工过程进行缓存，仅当依赖变化时才重新执行：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="85988936857426770000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const textColor = useMemo(\n  () => slowlyCalculateTextColor(color),\n  [color] // ✅ Don’t recalculate until \\`color\\` changes\n);`, `85988936857426770000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="jsx"\n              >\n                <span class="gatsby-code-button-language">jsx</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">const</span> textColor <span class="token operator">=</span> <span class="token function">useMemo</span><span class="token punctuation">(</span>\n  <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">slowlyCalculateTextColor</span><span class="token punctuation">(</span>color<span class="token punctuation">)</span><span class="token punctuation">,</span>\n  <span class="token punctuation">[</span>color<span class="token punctuation">]</span> <span class="token comment">// ✅ Don’t recalculate until `color` changes</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="不要阻塞副作用的数据流"><a href="#%E4%B8%8D%E8%A6%81%E9%98%BB%E5%A1%9E%E5%89%AF%E4%BD%9C%E7%94%A8%E7%9A%84%E6%95%B0%E6%8D%AE%E6%B5%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>不要阻塞副作用的数据流</h2>\n<p>发请求就是一种副作用，如果在一个组件内发请求，那么在取数参数变化时，最好能重新取数。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="44660169303590200000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class SearchResults extends React.Component {\n  state = {\n    data: null\n  };\n  componentDidMount() {\n    this.fetchResults();\n  }\n  componentDidUpdate(prevProps) {\n    if (prevProps.query !== this.props.query) {\n      // ✅ Refetch on change\n      this.fetchResults();\n    }\n  }\n  fetchResults() {\n    const url = this.getFetchUrl();\n    // Do the fetching...\n  }\n  getFetchUrl() {\n    return \'http://myapi/results?query\' + this.props.query; // ✅ Updates are handled\n  }\n  render() {\n    // ...\n  }\n}`, `44660169303590200000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="jsx"\n              >\n                <span class="gatsby-code-button-language">jsx</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">class</span> <span class="token class-name">SearchResults</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>\n  state <span class="token operator">=</span> <span class="token punctuation">{</span>\n    data<span class="token punctuation">:</span> <span class="token keyword">null</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fetchResults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token function">componentDidUpdate</span><span class="token punctuation">(</span><span class="token parameter">prevProps</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>prevProps<span class="token punctuation">.</span>query <span class="token operator">!==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>query<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// ✅ Refetch on change</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fetchResults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n  <span class="token function">fetchResults</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getFetchUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// Do the fetching...</span>\n  <span class="token punctuation">}</span>\n  <span class="token function">getFetchUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token string">\'http://myapi/results?query\'</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>query<span class="token punctuation">;</span> <span class="token comment">// ✅ Updates are handled</span>\n  <span class="token punctuation">}</span>\n  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// ...</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果用 Class Component 的方式实现，我们需要将请求函数 <code class="language-text">getFetchUrl</code> 抽出来，并且在 <code class="language-text">componentDidMount</code> 与 <code class="language-text">componentDidUpdate</code> 时同时调用它，还要注意 <code class="language-text">componentDidUpdate</code> 时如果取数参数 <code class="language-text">state.query</code> 没有变化则不执行 <code class="language-text">getFetchUrl</code>。</p>\n<p>这样的维护体验很糟糕，如果取数参数增加了 <code class="language-text">state.currentPage</code>，你很可能在 <code class="language-text">componentDidUpdate</code> 中漏掉对 <code class="language-text">state.currentPage</code> 的判断。</p>\n<p>如果使用 Function Component，可以通过 <code class="language-text">useCallback</code> 将整个取数过程作为一个整体：</p>\n<blockquote>\n<p>原文没有使用 <code class="language-text">useCallback</code>，笔者进行了加工。</p>\n</blockquote>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="30429538041773994000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function SearchResults({ query }) {\n  const [data, setData] = useState(null);\n  const [currentPage, setCurrentPage] = useState(0);\n\n  const getFetchUrl = useCallback(() => {\n    return \'http://myapi/results?query=\' + query + \'&page=\' + currentPage;\n  }, [currentPage, query]);\n\n  useEffect(() => {\n    const url = getFetchUrl();\n    // Do the fetching...\n  }, [getFetchUrl]); // ✅ Refetch on change\n\n  // ...\n}`, `30429538041773994000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="jsx"\n              >\n                <span class="gatsby-code-button-language">jsx</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">SearchResults</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> query <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">[</span>data<span class="token punctuation">,</span> setData<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> <span class="token punctuation">[</span>currentPage<span class="token punctuation">,</span> setCurrentPage<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> getFetchUrl <span class="token operator">=</span> <span class="token function">useCallback</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token string">\'http://myapi/results?query=\'</span> <span class="token operator">+</span> query <span class="token operator">+</span> <span class="token string">\'&amp;page=\'</span> <span class="token operator">+</span> currentPage<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>currentPage<span class="token punctuation">,</span> query<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token function">getFetchUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// Do the fetching...</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>getFetchUrl<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ✅ Refetch on change</span>\n\n  <span class="token comment">// ...</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Function Component 对 <code class="language-text">props</code> 与 <code class="language-text">state</code> 的数据都一视同仁，且可以将取数逻辑与 “更新判断” 通过 <code class="language-text">useCallback</code> 完全封装在一个函数内，再将这个函数作为整体依赖项添加到 <code class="language-text">useEffect</code>，如果未来再新增一个参数，只要修改 <code class="language-text">getFetchUrl</code> 这个函数即可，而且还可以通过 <code class="language-text">eslint-plugin-react-hooks</code> 插件静态分析是否遗漏了依赖项。</p>\n<p>Function Component 不但将依赖项聚合起来，还解决了 Class Component 分散在多处生命周期的函数判断，引发的无法静态分析依赖的问题。</p>\n<h2 id="不要因为性能优化而阻塞数据流"><a href="#%E4%B8%8D%E8%A6%81%E5%9B%A0%E4%B8%BA%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E8%80%8C%E9%98%BB%E5%A1%9E%E6%95%B0%E6%8D%AE%E6%B5%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>不要因为性能优化而阻塞数据流</h2>\n<p>相比 <code class="language-text">PureComponent</code> 与 <code class="language-text">React.memo</code>，手动进行比较优化是不太安全的，比如你可能会忘记对函数进行对比：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="12618497001075380000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Button extends React.Component {\n  shouldComponentUpdate(prevProps) {\n    // 🔴 Doesn\'t compare this.props.onClick\n    return this.props.color !== prevProps.color;\n  }\n  render() {\n    const onClick = this.props.onClick; // 🔴 Doesn\'t reflect updates\n    const textColor = slowlyCalculateTextColor(this.props.color);\n    return (\n      <button onClick={onClick} className={\'Button-\' + this.props.color + \' Button-text-\' + textColor}>\n        {this.props.children}\n      </button>\n    );\n  }\n}`, `12618497001075380000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="jsx"\n              >\n                <span class="gatsby-code-button-language">jsx</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">class</span> <span class="token class-name">Button</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>\n  <span class="token function">shouldComponentUpdate</span><span class="token punctuation">(</span><span class="token parameter">prevProps</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 🔴 Doesn\'t compare this.props.onClick</span>\n    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>color <span class="token operator">!==</span> prevProps<span class="token punctuation">.</span>color<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> onClick <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>onClick<span class="token punctuation">;</span> <span class="token comment">// 🔴 Doesn\'t reflect updates</span>\n    <span class="token keyword">const</span> textColor <span class="token operator">=</span> <span class="token function">slowlyCalculateTextColor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>color<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">return</span> <span class="token punctuation">(</span>\n      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>onClick<span class="token punctuation">}</span></span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token string">\'Button-\'</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>color <span class="token operator">+</span> <span class="token string">\' Button-text-\'</span> <span class="token operator">+</span> textColor<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n        </span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">}</span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>\n    <span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>上面的代码手动进行了 <code class="language-text">shouldComponentUpdate</code> 对比优化，但是忽略了对函数参数 <code class="language-text">onClick</code> 的对比，因此虽然大部分时间 <code class="language-text">onClick</code> 确实没有变化，因此代码也不会有什么 bug：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="43754465882387630000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class MyForm extends React.Component {\n  handleClick = () => {\n    // ✅ Always the same function\n    // Do something\n  };\n  render() {\n    return (\n      <>\n        <h1>Hello!</h1>\n        <Button color=\'green\' onClick={this.handleClick}>\n          Press me\n        </Button>\n      </>\n    );\n  }\n}`, `43754465882387630000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="jsx"\n              >\n                <span class="gatsby-code-button-language">jsx</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">class</span> <span class="token class-name">MyForm</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>\n  <span class="token function-variable function">handleClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token comment">// ✅ Always the same function</span>\n    <span class="token comment">// Do something</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token punctuation">(</span>\n      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span><span class="token plain-text">Hello!</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span><span class="token plain-text">\n        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Button</span></span> <span class="token attr-name">color</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">\'</span>green<span class="token punctuation">\'</span></span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleClick<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n          Press me\n        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Button</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span></span><span class="token punctuation">></span></span>\n    <span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>但是一旦换一种方式实现 <code class="language-text">onClick</code>，情况就不一样了，比如下面两种情况：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="4797342253412884000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class MyForm extends React.Component {\n  state = {\n    isEnabled: true\n  };\n  handleClick = () => {\n    this.setState({ isEnabled: false });\n    // Do something\n  };\n  render() {\n    return (\n      <>\n        <h1>Hello!</h1>\n        <Button\n          color=\'green\'\n          onClick={\n            // 🔴 Button ignores updates to the onClick prop\n            this.state.isEnabled ? this.handleClick : null\n          }\n        >\n          Press me\n        </Button>\n      </>\n    );\n  }\n}`, `4797342253412884000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="jsx"\n              >\n                <span class="gatsby-code-button-language">jsx</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">class</span> <span class="token class-name">MyForm</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>\n  state <span class="token operator">=</span> <span class="token punctuation">{</span>\n    isEnabled<span class="token punctuation">:</span> <span class="token boolean">true</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token function-variable function">handleClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> isEnabled<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// Do something</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token punctuation">(</span>\n      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span><span class="token plain-text">Hello!</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span><span class="token plain-text">\n        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Button</span></span>\n          <span class="token attr-name">color</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">\'</span>green<span class="token punctuation">\'</span></span>\n          <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>\n            <span class="token comment">// 🔴 Button ignores updates to the onClick prop</span>\n            <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>isEnabled <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handleClick <span class="token punctuation">:</span> <span class="token keyword">null</span>\n          <span class="token punctuation">}</span></span>\n        <span class="token punctuation">></span></span><span class="token plain-text">\n          Press me\n        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Button</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span></span><span class="token punctuation">></span></span>\n    <span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><code class="language-text">onClick</code> 随机在 <code class="language-text">null</code> 与 <code class="language-text">this.handleClick</code> 之间切换。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="36965967837473740000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`drafts.map((draft) => (\n  <Button\n    color=\'blue\'\n    key={draft.id}\n    onClick={\n      // 🔴 Button ignores updates to the onClick prop\n      this.handlePublish.bind(this, draft.content)\n    }\n  >\n    Publish\n  </Button>\n));`, `36965967837473740000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="jsx"\n              >\n                <span class="gatsby-code-button-language">jsx</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx">drafts<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">draft</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span>\n  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Button</span></span>\n    <span class="token attr-name">color</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">\'</span>blue<span class="token punctuation">\'</span></span>\n    <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>draft<span class="token punctuation">.</span>id<span class="token punctuation">}</span></span>\n    <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>\n      <span class="token comment">// 🔴 Button ignores updates to the onClick prop</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handlePublish</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> draft<span class="token punctuation">.</span>content<span class="token punctuation">)</span>\n    <span class="token punctuation">}</span></span>\n  <span class="token punctuation">></span></span><span class="token plain-text">\n    Publish\n  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Button</span></span><span class="token punctuation">></span></span>\n<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果 <code class="language-text">draft.content</code> 变化了，则 <code class="language-text">onClick</code> 函数变化。</p>\n<p>也就是如果子组件进行手动优化时，如果漏了对函数的对比，很有可能执行到旧的函数导致错误的逻辑。</p>\n<p>所以尽量不要自己进行优化，同时在 Function Component 环境下，在内部申明的函数每次都有不同的引用，因此便于发现逻辑 BUG，同时利用 <code class="language-text">useCallback</code> 与 <code class="language-text">useContext</code> 有助于解决这个问题。</p>\n<h2 id="时刻准备渲染"><a href="#%E6%97%B6%E5%88%BB%E5%87%86%E5%A4%87%E6%B8%B2%E6%9F%93" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>时刻准备渲染</h2>\n<p>确保你的组件可以随时重渲染，且不会导致内部状态管理出现 BUG。</p>\n<p>要做到这一点其实挺难的，比如一个复杂组件，如果接收了一个状态作为起点，之后的代码基于这个起点派生了许多内部状态，某个时刻改变了这个起始值，组件还能正常运行吗？</p>\n<p>比如下面的代码：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="10763078297401330000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 🤔 Should prevent unnecessary re-renders... right?\nclass TextInput extends React.PureComponent {\n  state = {\n    value: \'\'\n  };\n  // 🔴 Resets local state on every parent render\n  componentWillReceiveProps(nextProps) {\n    this.setState({ value: nextProps.value });\n  }\n  handleChange = (e) => {\n    this.setState({ value: e.target.value });\n  };\n  render() {\n    return <input value={this.state.value} onChange={this.handleChange} />;\n  }\n}`, `10763078297401330000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="jsx"\n              >\n                <span class="gatsby-code-button-language">jsx</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token comment">// 🤔 Should prevent unnecessary re-renders... right?</span>\n<span class="token keyword">class</span> <span class="token class-name">TextInput</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>PureComponent</span> <span class="token punctuation">{</span>\n  state <span class="token operator">=</span> <span class="token punctuation">{</span>\n    value<span class="token punctuation">:</span> <span class="token string">\'\'</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token comment">// 🔴 Resets local state on every parent render</span>\n  <span class="token function">componentWillReceiveProps</span><span class="token punctuation">(</span><span class="token parameter">nextProps</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> value<span class="token punctuation">:</span> nextProps<span class="token punctuation">.</span>value <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token function-variable function">handleChange</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> value<span class="token punctuation">:</span> e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">value</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>value<span class="token punctuation">}</span></span> <span class="token attr-name">onChange</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleChange<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><code class="language-text">componentWillReceiveProps</code> 标识了每次组件接收到新的 <code class="language-text">props</code>，都会将 <code class="language-text">props.value</code> 同步到 <code class="language-text">state.value</code>。这就是一种派生 <code class="language-text">state</code>，虽然看上去可以做到优雅承接 <code class="language-text">props</code> 的变化，但 <strong>父元素因为其他原因的 rerender 就会导致 <code class="language-text">state.value</code> 非正常重置，比如父元素的 <code class="language-text">forceUpdate</code>。</strong></p>\n<p>当然可以通过 <strong>不要阻塞渲染的数据流</strong> 一节所说的方式，比如 <code class="language-text">PureComponent</code>, <code class="language-text">shouldComponentUpdate</code>, <code class="language-text">React.memo</code> 来做性能优化（当 <code class="language-text">props.value</code> 没有变化时就不会重置 <code class="language-text">state.value</code>），但这样的代码依然是脆弱的。</p>\n<p>健壮的代码不会因为删除了某项优化就出现 BUG，不要使用派生 <code class="language-text">state</code> 就能避免此问题。</p>\n<blockquote>\n<p>解决这个问题的方式是</p>\n<ol>\n<li>如果组件依赖了 <code class="language-text">props.value</code>，就不需要使用 <code class="language-text">state.value</code>，完全做成 <strong>受控组件</strong>。</li>\n<li>如果必须有 <code class="language-text">state.value</code>，那就做成内部状态，也就是不要从外部接收 <code class="language-text">props.value</code>。总之避免写 “介于受控与非受控之间的组件”。</li>\n</ol>\n</blockquote>\n<p>补充一下，如果做成了非受控组件，却想重置初始值，那么在父级调用处加上 <code class="language-text">key</code> 来解决：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="85810877330085230000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<EmailInput defaultEmail={this.props.user.email} key={this.props.user.id} />`, `85810877330085230000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="jsx"\n              >\n                <span class="gatsby-code-button-language">jsx</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">EmailInput</span></span> <span class="token attr-name">defaultEmail</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>user<span class="token punctuation">.</span>email<span class="token punctuation">}</span></span> <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>user<span class="token punctuation">.</span>id<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>另外也可以通过 <code class="language-text">ref</code> 解决，让子元素提供一个 <code class="language-text">reset</code> 函数，不过不推荐使用 <code class="language-text">ref</code>。</p>\n<h2 id="不要有单例组件"><a href="#%E4%B8%8D%E8%A6%81%E6%9C%89%E5%8D%95%E4%BE%8B%E7%BB%84%E4%BB%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>不要有单例组件</h2>\n<p>一个有弹性的应用，应该能通过下面考验：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="39748503227269350000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`ReactDOM.render(\n  <>\n    <MyApp />\n    <MyApp />\n  </>,\n  document.getElementById(\'root\')\n);`, `39748503227269350000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="jsx"\n              >\n                <span class="gatsby-code-button-language">jsx</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx">ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>\n  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">MyApp</span></span> <span class="token punctuation">/></span></span><span class="token plain-text">\n    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">MyApp</span></span> <span class="token punctuation">/></span></span><span class="token plain-text">\n  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span></span><span class="token punctuation">></span></span><span class="token punctuation">,</span>\n  document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">\'root\'</span><span class="token punctuation">)</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>将整个应用渲染两遍，看看是否能各自正确运作？</p>\n<p>除了组件本地状态由本地维护外，具有弹性的组件不应该因为其他实例调用了某些函数，而 “永远错过了某些状态或功能”。</p>\n<p>笔者补充：一个危险的组件一般是这么思考的：没有人会随意破坏数据流，因此只要在 <code class="language-text">didMount</code> 与 <code class="language-text">unMount</code> 时做好数据初始化和销毁就行了。</p>\n<p>那么当另一个实例进行销毁操作时，可能会破坏这个实例的中间状态。一个具有弹性的组件应该能 <strong>随时响应</strong> 状态的变化，没有生命周期概念的 Function Component 处理起来显然更得心应手。</p>\n<h2 id="隔离本地状态"><a href="#%E9%9A%94%E7%A6%BB%E6%9C%AC%E5%9C%B0%E7%8A%B6%E6%80%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>隔离本地状态</h2>\n<p><strong>很多时候难以判断数据属于组件的本地状态还是全局状态。</strong></p>\n<p>文章提供了一个判断方法：<strong>“想象这个组件同时渲染了两个实例，这个数据会同时影响这两个实例吗？如果答案是 不会，那这个数据就适合作为本地状态”。</strong></p>\n<p>尤其在写业务组件时，容易将业务数据与组件本身状态数据混淆。</p>\n<p>根据笔者的经验，<strong>从上层业务到底层通用组件之间，本地状态数量是递增的：</strong></p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="10594337476526873000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`业务\n  -> 全局数据流\n    -> 页面（完全依赖全局数据流，几乎没有自己的状态）\n      -> 业务组件（从页面或全局数据流继承数据，很少有自己状态）\n        -> 通用组件（完全受控，比如 input；或大量内聚状态的复杂通用逻辑，比如 monaco-editor）`, `10594337476526873000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">业务\n  -&gt; 全局数据流\n    -&gt; 页面（完全依赖全局数据流，几乎没有自己的状态）\n      -&gt; 业务组件（从页面或全局数据流继承数据，很少有自己状态）\n        -&gt; 通用组件（完全受控，比如 input；或大量内聚状态的复杂通用逻辑，比如 monaco-editor）</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="精读"><a href="#%E7%B2%BE%E8%AF%BB" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>精读</h1>\n<p>再次强调，一个有弹性的组件需要同时满足下面 4 个原则：</p>\n<ol>\n<li><strong>不要阻塞数据流。</strong></li>\n<li><strong>时刻准备好渲染。</strong></li>\n<li><strong>不要有单例组件。</strong></li>\n<li><strong>隔离本地状态。</strong></li>\n</ol>\n<p>想要遵循这些规则看上去也不难，但实践过程中会遇到不少问题，笔者举几个例子。</p>\n<h2 id="频繁传递回调函数"><a href="#%E9%A2%91%E7%B9%81%E4%BC%A0%E9%80%92%E5%9B%9E%E8%B0%83%E5%87%BD%E6%95%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>频繁传递回调函数</h2>\n<p>Function Component 会导致组件粒度拆分的比较细，在提高可维护性同时，也会导致全局 <code class="language-text">state</code> 成为过去，下面的代码可能让你觉得别扭：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="61902474138653660000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const App = memo(function App() {\n  const [count, setCount] = useState(0);\n  const [name, setName] = useState(&quot;nick&quot;);\n\n  return (\n    <>\n      <Count count={count} setCount={setCount}/>\n      <Name name={name} setName={setName}/>\n    </>\n  );\n});\n\nconst Count = memo(function Count(props) {\n  return (\n      <input value={props.count} onChange={pipeEvent(props.setCount)}>\n  );\n});\n\nconst Name = memo(function Name(props) {\n  return (\n  <input value={props.name} onChange={pipeEvent(props.setName)}>\n  );\n});`, `61902474138653660000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="jsx"\n              >\n                <span class="gatsby-code-button-language">jsx</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">const</span> App <span class="token operator">=</span> <span class="token function">memo</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> setCount<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> <span class="token punctuation">[</span>name<span class="token punctuation">,</span> setName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">"nick"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">return</span> <span class="token punctuation">(</span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Count</span></span> <span class="token attr-name">count</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>count<span class="token punctuation">}</span></span> <span class="token attr-name">setCount</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>setCount<span class="token punctuation">}</span></span><span class="token punctuation">/></span></span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Name</span></span> <span class="token attr-name">name</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>name<span class="token punctuation">}</span></span> <span class="token attr-name">setName</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>setName<span class="token punctuation">}</span></span><span class="token punctuation">/></span></span><span class="token plain-text">\n    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span></span><span class="token punctuation">></span></span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> Count <span class="token operator">=</span> <span class="token function">memo</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">Count</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token punctuation">(</span>\n      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">value</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>props<span class="token punctuation">.</span>count<span class="token punctuation">}</span></span> <span class="token attr-name">onChange</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">pipeEvent</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span>setCount<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n  );\n});\n\nconst Name = memo(function Name(props) </span><span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token punctuation">(</span>\n  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">value</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>props<span class="token punctuation">.</span>name<span class="token punctuation">}</span></span> <span class="token attr-name">onChange</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">pipeEvent</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span>setName<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n  );\n});</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>虽然将子组件 <code class="language-text">Count</code> 与 <code class="language-text">Name</code> 拆分出来，逻辑更加解耦，但子组件需要更新父组件的状态就变得麻烦，我们不希望将函数作为参数透传给子组件。</p>\n<p>一种办法是将函数通过 <code class="language-text">Context</code> 传给子组件：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="3530055418569211400"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const SetCount = createContext(null)\nconst SetName = createContext(null)\n\nconst App = memo(function App() {\n  const [count, setCount] = useState(0);\n  const [name, setName] = useState(&quot;nick&quot;);\n\n  return (\n    <SetCount.Provider value={setCount}>\n      <SetName.Provider value={setName}>\n        <Count count={count}/>\n        <Name name={name}/>\n      </SetName.Provider>\n    </SetCount.Provider>\n  );\n});\n\nconst Count = memo(function Count(props) {\n  const setCount = useContext(SetCount)\n  return (\n      <input value={props.count} onChange={pipeEvent(setCount)}>\n  );\n});\n\nconst Name = memo(function Name(props) {\n  const setName = useContext(SetName)\n  return (\n  <input value={props.name} onChange={pipeEvent(setName)}>\n  );\n});`, `3530055418569211400`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="jsx"\n              >\n                <span class="gatsby-code-button-language">jsx</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">const</span> SetCount <span class="token operator">=</span> <span class="token function">createContext</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>\n<span class="token keyword">const</span> SetName <span class="token operator">=</span> <span class="token function">createContext</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>\n\n<span class="token keyword">const</span> App <span class="token operator">=</span> <span class="token function">memo</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> setCount<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> <span class="token punctuation">[</span>name<span class="token punctuation">,</span> setName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">"nick"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">return</span> <span class="token punctuation">(</span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">SetCount.Provider</span></span> <span class="token attr-name">value</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>setCount<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">SetName.Provider</span></span> <span class="token attr-name">value</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>setName<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Count</span></span> <span class="token attr-name">count</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>count<span class="token punctuation">}</span></span><span class="token punctuation">/></span></span><span class="token plain-text">\n        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Name</span></span> <span class="token attr-name">name</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>name<span class="token punctuation">}</span></span><span class="token punctuation">/></span></span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">SetName.Provider</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">SetCount.Provider</span></span><span class="token punctuation">></span></span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> Count <span class="token operator">=</span> <span class="token function">memo</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">Count</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> setCount <span class="token operator">=</span> <span class="token function">useContext</span><span class="token punctuation">(</span>SetCount<span class="token punctuation">)</span>\n  <span class="token keyword">return</span> <span class="token punctuation">(</span>\n      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">value</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>props<span class="token punctuation">.</span>count<span class="token punctuation">}</span></span> <span class="token attr-name">onChange</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">pipeEvent</span><span class="token punctuation">(</span>setCount<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n  );\n});\n\nconst Name = memo(function Name(props) </span><span class="token punctuation">{</span>\n  <span class="token keyword">const</span> setName <span class="token operator">=</span> <span class="token function">useContext</span><span class="token punctuation">(</span>SetName<span class="token punctuation">)</span>\n  <span class="token keyword">return</span> <span class="token punctuation">(</span>\n  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">value</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>props<span class="token punctuation">.</span>name<span class="token punctuation">}</span></span> <span class="token attr-name">onChange</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">pipeEvent</span><span class="token punctuation">(</span>setName<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n  );\n});</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>但这样会导致 <code class="language-text">Provider</code> 过于臃肿，因此建议部分组件使用 <code class="language-text">useReducer</code> 替代 <code class="language-text">useState</code>，将函数合并到 <code class="language-text">dispatch</code>：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="67183980581897990000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const AppDispatch = createContext(null)\n\nclass State = {\n  count = 0\n  name = \'nick\'\n}\n\nfunction appReducer(state, action) {\n  switch(action.type) {\n    case \'setCount\':\n      return {\n        ...state,\n        count: action.value\n      }\n    case \'setName\':\n      return {\n        ...state,\n        name: action.value\n      }\n    default:\n      return state\n  }\n}\n\nconst App = memo(function App() {\n  const [state, dispatch] = useReducer(appReducer, new State())\n\n  return (\n    <AppDispatch.Provider value={dispatch}>\n      <Count count={count}/>\n      <Name name={name}/>\n    </AppDispatch.Provider>\n  );\n});\n\nconst Count = memo(function Count(props) {\n  const dispatch = useContext(AppDispatch)\n  return (\n      <input value={props.count} onChange={pipeEvent(value => dispatch({type: \'setCount\', value}))}>\n  );\n});\n\nconst Name = memo(function Name(props) {\n  const dispatch = useContext(AppDispatch)\n  return (\n  <input value={props.name} onChange={pipeEvent(pipeEvent(value => dispatch({type: \'setName\', value})))}>\n  );\n});`, `67183980581897990000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="jsx"\n              >\n                <span class="gatsby-code-button-language">jsx</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">const</span> AppDispatch <span class="token operator">=</span> <span class="token function">createContext</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>\n\n<span class="token keyword">class</span> <span class="token class-name">State</span> <span class="token operator">=</span> <span class="token punctuation">{</span>\n  count <span class="token operator">=</span> <span class="token number">0</span>\n  name <span class="token operator">=</span> <span class="token string">\'nick\'</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">appReducer</span><span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">switch</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">case</span> <span class="token string">\'setCount\'</span><span class="token punctuation">:</span>\n      <span class="token keyword">return</span> <span class="token punctuation">{</span>\n        <span class="token operator">...</span>state<span class="token punctuation">,</span>\n        count<span class="token punctuation">:</span> action<span class="token punctuation">.</span>value\n      <span class="token punctuation">}</span>\n    <span class="token keyword">case</span> <span class="token string">\'setName\'</span><span class="token punctuation">:</span>\n      <span class="token keyword">return</span> <span class="token punctuation">{</span>\n        <span class="token operator">...</span>state<span class="token punctuation">,</span>\n        name<span class="token punctuation">:</span> action<span class="token punctuation">.</span>value\n      <span class="token punctuation">}</span>\n    <span class="token keyword">default</span><span class="token punctuation">:</span>\n      <span class="token keyword">return</span> state\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">const</span> App <span class="token operator">=</span> <span class="token function">memo</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">[</span>state<span class="token punctuation">,</span> dispatch<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useReducer</span><span class="token punctuation">(</span>appReducer<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">State</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n  <span class="token keyword">return</span> <span class="token punctuation">(</span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">AppDispatch.Provider</span></span> <span class="token attr-name">value</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>dispatch<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Count</span></span> <span class="token attr-name">count</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>count<span class="token punctuation">}</span></span><span class="token punctuation">/></span></span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Name</span></span> <span class="token attr-name">name</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>name<span class="token punctuation">}</span></span><span class="token punctuation">/></span></span><span class="token plain-text">\n    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">AppDispatch.Provider</span></span><span class="token punctuation">></span></span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> Count <span class="token operator">=</span> <span class="token function">memo</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">Count</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> dispatch <span class="token operator">=</span> <span class="token function">useContext</span><span class="token punctuation">(</span>AppDispatch<span class="token punctuation">)</span>\n  <span class="token keyword">return</span> <span class="token punctuation">(</span>\n      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">value</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>props<span class="token punctuation">.</span>count<span class="token punctuation">}</span></span> <span class="token attr-name">onChange</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">pipeEvent</span><span class="token punctuation">(</span><span class="token parameter">value</span> <span class="token operator">=></span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span>type<span class="token punctuation">:</span> <span class="token string">\'setCount\'</span><span class="token punctuation">,</span> value<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n  );\n});\n\nconst Name = memo(function Name(props) </span><span class="token punctuation">{</span>\n  <span class="token keyword">const</span> dispatch <span class="token operator">=</span> <span class="token function">useContext</span><span class="token punctuation">(</span>AppDispatch<span class="token punctuation">)</span>\n  <span class="token keyword">return</span> <span class="token punctuation">(</span>\n  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">value</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>props<span class="token punctuation">.</span>name<span class="token punctuation">}</span></span> <span class="token attr-name">onChange</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">pipeEvent</span><span class="token punctuation">(</span><span class="token function">pipeEvent</span><span class="token punctuation">(</span><span class="token parameter">value</span> <span class="token operator">=></span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span>type<span class="token punctuation">:</span> <span class="token string">\'setName\'</span><span class="token punctuation">,</span> value<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n  );\n});</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>将状态聚合到 <code class="language-text">reducer</code> 中，这样一个 <code class="language-text">ContextProvider</code> 就能解决所有数据处理问题了。</p>\n<blockquote>\n<p>memo 包裹的组件类似 PureComponent 效果。</p>\n</blockquote>\n<h2 id="usecallback-参数变化频繁"><a href="#usecallback-%E5%8F%82%E6%95%B0%E5%8F%98%E5%8C%96%E9%A2%91%E7%B9%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>useCallback 参数变化频繁</h2>\n<p>在 <a href="https://github.com/dt-fe/weekly/blob/master/96.%E7%B2%BE%E8%AF%BB%E3%80%8AuseEffect%20%E5%AE%8C%E5%85%A8%E6%8C%87%E5%8D%97%E3%80%8B.md#%E5%A6%82%E6%9E%9C%E9%9D%9E%E8%A6%81%E6%8A%8A-function-%E5%86%99%E5%9C%A8-effect-%E5%A4%96%E9%9D%A2%E5%91%A2" target="_blank" rel="nofollow noreferrer noopener">精读《useEffect 完全指南》</a> 我们介绍了利用 <code class="language-text">useCallback</code> 创建一个 Immutable 的函数：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="90676808714873100000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function Form() {\n  const [text, updateText] = useState(\'\');\n\n  const handleSubmit = useCallback(() => {\n    const currentText = text;\n    alert(currentText);\n  }, [text]);\n\n  return (\n    <>\n      <input value={text} onChange={(e) => updateText(e.target.value)} />\n      <ExpensiveTree onSubmit={handleSubmit} />\n    </>\n  );\n}`, `90676808714873100000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="jsx"\n              >\n                <span class="gatsby-code-button-language">jsx</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">Form</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">[</span>text<span class="token punctuation">,</span> updateText<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">\'\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> handleSubmit <span class="token operator">=</span> <span class="token function">useCallback</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> currentText <span class="token operator">=</span> text<span class="token punctuation">;</span>\n    <span class="token function">alert</span><span class="token punctuation">(</span>currentText<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>text<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">return</span> <span class="token punctuation">(</span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">value</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>text<span class="token punctuation">}</span></span> <span class="token attr-name">onChange</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">updateText</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">ExpensiveTree</span></span> <span class="token attr-name">onSubmit</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>handleSubmit<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token plain-text">\n    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span></span><span class="token punctuation">></span></span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>但这个函数的依赖 <code class="language-text">[text]</code> 变化过于频繁，以至于在每个 <code class="language-text">render</code> 都会重新生成 <code class="language-text">handleSubmit</code> 函数，对性能有一定影响。一种解决办法是利用 <code class="language-text">Ref</code> 规避这个问题：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="14934622098508931000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function Form() {\n  const [text, updateText] = useState(\'\');\n  const textRef = useRef();\n\n  useEffect(() => {\n    textRef.current = text; // Write it to the ref\n  });\n\n  const handleSubmit = useCallback(() => {\n    const currentText = textRef.current; // Read it from the ref\n    alert(currentText);\n  }, [textRef]); // Don\'t recreate handleSubmit like [text] would do\n\n  return (\n    <>\n      <input value={text} onChange={(e) => updateText(e.target.value)} />\n      <ExpensiveTree onSubmit={handleSubmit} />\n    </>\n  );\n}`, `14934622098508931000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="jsx"\n              >\n                <span class="gatsby-code-button-language">jsx</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">Form</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">[</span>text<span class="token punctuation">,</span> updateText<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">\'\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> textRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    textRef<span class="token punctuation">.</span>current <span class="token operator">=</span> text<span class="token punctuation">;</span> <span class="token comment">// Write it to the ref</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> handleSubmit <span class="token operator">=</span> <span class="token function">useCallback</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> currentText <span class="token operator">=</span> textRef<span class="token punctuation">.</span>current<span class="token punctuation">;</span> <span class="token comment">// Read it from the ref</span>\n    <span class="token function">alert</span><span class="token punctuation">(</span>currentText<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>textRef<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Don\'t recreate handleSubmit like [text] would do</span>\n\n  <span class="token keyword">return</span> <span class="token punctuation">(</span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">value</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>text<span class="token punctuation">}</span></span> <span class="token attr-name">onChange</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">updateText</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">ExpensiveTree</span></span> <span class="token attr-name">onSubmit</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>handleSubmit<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token plain-text">\n    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span></span><span class="token punctuation">></span></span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>当然，也可以将这个过程封装为一个自定义 Hooks，让代码稍微好看些：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="57625204985360520000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function Form() {\n  const [text, updateText] = useState(\'\');\n  // Will be memoized even if \\`text\\` changes:\n  const handleSubmit = useEventCallback(() => {\n    alert(text);\n  }, [text]);\n\n  return (\n    <>\n      <input value={text} onChange={(e) => updateText(e.target.value)} />\n      <ExpensiveTree onSubmit={handleSubmit} />\n    </>\n  );\n}\n\nfunction useEventCallback(fn, dependencies) {\n  const ref = useRef(() => {\n    throw new Error(\'Cannot call an event handler while rendering.\');\n  });\n\n  useEffect(() => {\n    ref.current = fn;\n  }, [fn, ...dependencies]);\n\n  return useCallback(() => {\n    const fn = ref.current;\n    return fn();\n  }, [ref]);\n}`, `57625204985360520000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="jsx"\n              >\n                <span class="gatsby-code-button-language">jsx</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">Form</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">[</span>text<span class="token punctuation">,</span> updateText<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">\'\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// Will be memoized even if `text` changes:</span>\n  <span class="token keyword">const</span> handleSubmit <span class="token operator">=</span> <span class="token function">useEventCallback</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token function">alert</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>text<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">return</span> <span class="token punctuation">(</span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">value</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>text<span class="token punctuation">}</span></span> <span class="token attr-name">onChange</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">updateText</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">ExpensiveTree</span></span> <span class="token attr-name">onSubmit</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>handleSubmit<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token plain-text">\n    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span></span><span class="token punctuation">></span></span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">useEventCallback</span><span class="token punctuation">(</span><span class="token parameter">fn<span class="token punctuation">,</span> dependencies</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> ref <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">\'Cannot call an event handler while rendering.\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    ref<span class="token punctuation">.</span>current <span class="token operator">=</span> fn<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>fn<span class="token punctuation">,</span> <span class="token operator">...</span>dependencies<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">return</span> <span class="token function">useCallback</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> fn <span class="token operator">=</span> ref<span class="token punctuation">.</span>current<span class="token punctuation">;</span>\n    <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>ref<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<blockquote>\n<p>不过这种方案并不优雅，<a href="https://reactjs.org/docs/hooks-faq.html#how-to-read-an-often-changing-value-from-usecallback" target="_blank" rel="nofollow noreferrer noopener">React 考虑提供一个更优雅的方案</a>。</p>\n</blockquote>\n<h2 id="有可能被滥用的-usereducer"><a href="#%E6%9C%89%E5%8F%AF%E8%83%BD%E8%A2%AB%E6%BB%A5%E7%94%A8%E7%9A%84-usereducer" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>有可能被滥用的 useReducer</h2>\n<p>在 <a href="https://github.com/dt-fe/weekly/blob/master/96.%E7%B2%BE%E8%AF%BB%E3%80%8AuseEffect%20%E5%AE%8C%E5%85%A8%E6%8C%87%E5%8D%97%E3%80%8B.md#%E5%B0%86%E6%9B%B4%E6%96%B0%E4%B8%8E%E5%8A%A8%E4%BD%9C%E8%A7%A3%E8%80%A6" target="_blank" rel="nofollow noreferrer noopener">精读《useEffect 完全指南》</a> “将更新与动作解耦” 一节里提到了，利用 <code class="language-text">useReducer</code> 解决 “函数同时依赖多个外部变量的问题”。</p>\n<p>一般情况下，我们会这么使用 <code class="language-text">useReducer</code>:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="15149840864117060000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const reducer = (state, action) => {\n  switch (action.type) {\n    case \'increment\':\n      return { value: state.value + 1 };\n    case \'decrement\':\n      return { value: state.value - 1 };\n    case \'incrementAmount\':\n      return { value: state.value + action.amount };\n    default:\n      throw new Error();\n  }\n};\n\nconst [state, dispatch] = useReducer(reducer, { value: 0 });`, `15149840864117060000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="tsx"\n              >\n                <span class="gatsby-code-button-language">tsx</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="tsx"><pre style="counter-reset: linenumber NaN" class="language-tsx line-numbers"><code class="language-tsx"><span class="token keyword">const</span> <span class="token function-variable function">reducer</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">switch</span> <span class="token punctuation">(</span>action<span class="token punctuation">.</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">case</span> <span class="token string">\'increment\'</span><span class="token punctuation">:</span>\n      <span class="token keyword">return</span> <span class="token punctuation">{</span> value<span class="token punctuation">:</span> state<span class="token punctuation">.</span>value <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>\n    <span class="token keyword">case</span> <span class="token string">\'decrement\'</span><span class="token punctuation">:</span>\n      <span class="token keyword">return</span> <span class="token punctuation">{</span> value<span class="token punctuation">:</span> state<span class="token punctuation">.</span>value <span class="token operator">-</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>\n    <span class="token keyword">case</span> <span class="token string">\'incrementAmount\'</span><span class="token punctuation">:</span>\n      <span class="token keyword">return</span> <span class="token punctuation">{</span> value<span class="token punctuation">:</span> state<span class="token punctuation">.</span>value <span class="token operator">+</span> action<span class="token punctuation">.</span>amount <span class="token punctuation">}</span><span class="token punctuation">;</span>\n    <span class="token keyword">default</span><span class="token punctuation">:</span>\n      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token punctuation">[</span>state<span class="token punctuation">,</span> dispatch<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useReducer</span><span class="token punctuation">(</span>reducer<span class="token punctuation">,</span> <span class="token punctuation">{</span> value<span class="token punctuation">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>但其实 <code class="language-text">useReducer</code> 对 <code class="language-text">state</code> 与 <code class="language-text">action</code> 的定义可以很随意，因此我们可以利用 <code class="language-text">useReducer</code> 打造一个 <code class="language-text">useState</code>。</p>\n<p>比如我们创建一个拥有复数 key 的 <code class="language-text">useState</code>:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="62909164172016110000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const [state, setState] = useState({ count: 0, name: \'nick\' });\n\n// 修改 count\nsetState((state) => ({ ...state, count: 1 }));\n\n// 修改 name\nsetState((state) => ({ ...state, name: \'jack\' }));`, `62909164172016110000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="jsx"\n              >\n                <span class="gatsby-code-button-language">jsx</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">const</span> <span class="token punctuation">[</span>state<span class="token punctuation">,</span> setState<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> count<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string">\'nick\'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 修改 count</span>\n<span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">,</span> count<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 修改 name</span>\n<span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string">\'jack\'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>利用 <code class="language-text">useReducer</code> 实现相似的功能：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="54334118283262470000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function reducer(state, action) {\n  return action(state);\n}\n\nconst [state, dispatch] = useReducer(reducer, { count: 0, name: \'nick\' });\n\n// 修改 count\ndispatch((state) => ({ ...state, count: 1 }));\n\n// 修改 name\ndispatch((state) => ({ ...state, name: \'jack\' }));`, `54334118283262470000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="jsx"\n              >\n                <span class="gatsby-code-button-language">jsx</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">reducer</span><span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token function">action</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">const</span> <span class="token punctuation">[</span>state<span class="token punctuation">,</span> dispatch<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useReducer</span><span class="token punctuation">(</span>reducer<span class="token punctuation">,</span> <span class="token punctuation">{</span> count<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string">\'nick\'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 修改 count</span>\n<span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">,</span> count<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 修改 name</span>\n<span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string">\'jack\'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>因此针对如上情况，我们可能滥用了 <code class="language-text">useReducer</code>，建议直接用 <code class="language-text">useState</code> 代替。</p>\n<h1 id="总结"><a href="#%E6%80%BB%E7%BB%93" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h1>\n<p>本文总结了具有弹性的组件的四个特性：不要阻塞数据流、时刻准备好渲染、不要有单例组件、隔离本地状态。</p>\n<p>这个约定对代码质量很重要，而且难以通过 lint 规则或简单肉眼观察加以识别，因此推广起来还是有不小难度。</p>\n<p>总的来说，Function Component 带来了更优雅的代码体验，但是对团队协作的要求也更高了。</p>',
excerpt:"概述 相比代码的 Lint 或者 Prettier，或许我们更应该关注代码是否具有弹性。 Dan  总结了弹性组件具有的四个特征： 不要阻塞数据流。 时刻准备好渲染。 不要有单例组件。 隔离本地状态。 以上规则不仅适用于 React，它适用于所有 UI…",frontmatter:{date:"2019-06-06 14:35:51",path:"/write-resilient-components/",tags:"前端, 组件",title:"编写有弹性的组件",draft:null}},prePost:{html:'<p>会话发起协议（SIP）是 VoIP 技术中最常用的协议之一。它是一种应用层协议，与其他应用层协议协同工作，通过 Internet 控制多媒体通信会话。</p>\n<h1 id="概述"><a href="#%E6%A6%82%E8%BF%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>概述</h1>\n<ul>\n<li>SIP 是用于通过因特网协议创建，修改和终止多媒体会话的信令协议。会话只不过是两个端点之间的简单调用。端点可以是智能电话，笔记本电脑或可以通过因特网接收和发送多媒体内容的任何设备。</li>\n<li>SIP 是由 IETF（Internet Engineering Task Force） 标准定义的应用层协议。它在 RFC 3261 中定义。</li>\n<li>SIP 体现了客户端 - 服务器体系结构，以及使用 HTTP 和 URL 的 URL 和 URI 以及 SMTP 的文本编码方案和头样式。</li>\n<li>SIP 采用 SDP（会话描述协议） 的帮助，它描述了用于通过 IP 网络传送语音和视频的会话和 RTP（实时传输协议）。</li>\n<li>SIP 可用于双方（单播）或多方（多播）会话。</li>\n<li>其他 SIP 应用包括文件传输，即时通讯，视频会议，网络游戏，以及流多媒体分发。</li>\n</ul>\n<p>下图说明了 SIP 在一般方案中的适用性：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2019-06-10-11-59-57-514e7696b1300e07d312f20f411c5d24-ae33f.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 391px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 138.3631713554987%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAcCAIAAADuuAg3AAAACXBIWXMAAAsSAAALEgHS3X78AAAD1ElEQVQ4y02VWS+kURCGv98gbkhc2GMLiQSJ3+BO3BIJ3bR1dNO2Qbdd26fHlpluS+y7MZZphLYNZkxCuHYj3EgkfsA83yndM+/FSXWdqvetqnO+09rz87PD4WhtbbXb7Tabzb+KIXZLS0tzc7Pdh/b29qamJo/Hoy0vLwcGBoaEhKSlpSUlJcXGxqampsbHx0dHR6ekpCQmJsbFxWHjiYmJYTchISE0NDQgICAzM1NbWVlhOzk5uaSkBMqamprCwsLS0lKz2VxeXm61WsvKyjIyMvCwVVdXZzKZ0tPT4crJydGWlpaCgoIiIyMjIiJwQRQeHh4VFSUe1rCwMDyII4s4sviDg4OzsrI0ekZQemtSwG5sbGT9qCDd2nyQEVDC7u6u9vj46Ha7vyq4XC7Wqamp2dnZ+fn58fHxsbGxLwouBX/Y6Ojo0dGRtr+/bzAY6PCDAp0jC93AwACaTqdzeHgYis7OznIFYioqKoqLi9HXTk5OGAm/8ZoVqqurqc2q0KoAC3XKrmjA0tfXpx0fHxuNRjnAoqIivAxWRKgCBaFmyHjghQg6PEzqPbmtra2jo4M9WElg5cCIIBM1Dgkn+Q0NDYR1dXVZLBZS9GQECwoK6BzDpEAmNqT4Mfjp9xsUMLq7u9+VaQlZ6NFBUFYp3qKAp7KyEqO2tra+vp7WKEFPhonrDZP0yQYiQpSfn09OVVWVUQGbyP7+fjx0ridTgwwQ0CTJZMoqI4QROmx25bTYguU9uVSBCOkcyITomd3/uaQ0jH/JPT09nBuVs8E2CqTJUVEh1VI/P7me1Mz9Yf76tA8PD7Ozs80+UJXQSwlwQeSvSC4SXPzkXmhPT09c3U//wakwNDSEAjrYnxUw/DGDg4Ner1d7fX3d3t7+7sPm5ibrxsYG6+rq6traGsY3H7C3traIX19fv7u70w4ODnJzc6mTzvkkkOLe8RlwjHye3H5+0h5ri4LMkrK5pxrqdMK5c/okO3wgXz5gLiPJTBQPyYRxo/hment79U8yLy9PThhWvMycIFbUYEGfNH5yBZmcf4S6Mi/JxMSEW4EPnQdAHoPFxcWZmZnJycm5uTneOX5i8wwQJo8EZ6y9vb39Vri+vr65ufmjIJ6fChi/FAiQLYzLy8uHhweNBF4jngSelenpaYbJVH8o7OzsMHYMxru3t0cYtlcBWf3dvr+/J+3q6goyxkO3IyMjrPTJOXO2lI0tfwwLCwuUQDnE62/Y7e0tfGdnZyKOAofnUcDg/uFBmRLwoHl6ekokq6788vKCdaZwfn4Oq6xi+O2LiwvxSCRlU/JfMSqBLu9O3AUAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2019 06 10 11 59 57" title="" data-src="/static/2019-06-10-11-59-57-514e7696b1300e07d312f20f411c5d24-ae33f.png" data-srcset="/static/2019-06-10-11-59-57-514e7696b1300e07d312f20f411c5d24-12493.png 200w,\n/static/2019-06-10-11-59-57-514e7696b1300e07d312f20f411c5d24-ae33f.png 391w" data-sizes="(max-width: 391px) 100vw, 391px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>通常，SIP 协议用于两个或多个端点之间的互联网电话和多媒体分发。例如，一个人可以使用 SIP 发起对另一个人的电话呼叫，或者有人可以与许多参与者建立电话会议。</p>\n<p>SIP 协议的设计非常简单，配置有限的命令。它也是基于文本的，所以任何人都可以读取 SIP 会话中的端点之间传递的 SIP 消息。</p>\n<p>有一些实体帮助 SIP 创建其网络。在 SIP 中，每个网元由 SIP URI（统一资源标识符） 来标识，它像一个地址。以下是网络元素：</p>\n<ul>\n<li>用户代理</li>\n<li>代理服务器</li>\n<li>注册服务器</li>\n<li>重定向服务器</li>\n<li>位置服务器</li>\n</ul>\n<h2 id="用户代理"><a href="#%E7%94%A8%E6%88%B7%E4%BB%A3%E7%90%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>用户代理</h2>\n<p>它是 SIP 网络的端点和最重要的网络元素之一。端点可以启动，修改或终止会话。用户代理是 SIP 网络中最智能的设备或网络元件。它可以是软电话，手机或笔记本电脑。</p>\n<p>用户代理在逻辑上分为两部分：</p>\n<ul>\n<li>用户代理客户端（UAC） - 发送请求并接收响应的实体。</li>\n<li>用户代理服务器（UAS） - 接收请求并发送响应的实体。</li>\n</ul>\n<p>SIP 基于客户机 - 服务器架构，其中呼叫者的电话充当发起呼叫的客户端，被叫方的电话充当响应呼叫的服务器。</p>\n<h2 id="代理服务器"><a href="#%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>代理服务器</h2>\n<p>网络元素接收来自用户代理的请求并将其转发给另一个用户。</p>\n<ul>\n<li>基本上代理服务器的作用就像一个路由器。</li>\n<li>它有一些智慧来了解 SIP 请求，并在 URI 的帮助下发送它。</li>\n<li>代理服务器位于两个用户代理之间。</li>\n<li>源和目的地之间最多可以有 70 个代理服务器。</li>\n</ul>\n<p>有两种类型的代理服务器：</p>\n<ul>\n<li>无状态代理服务器 - 它只是转发收到的消息。这种类型的服务器不存储任何呼叫或交易的信息。</li>\n<li>有状态代理服务器 - 这种类型的代理服务器可以跟踪收到的每个请求和响应，并且如果需要，可以将来使用它。如果对方没有响应，它可以重新发送请求。</li>\n</ul>\n<h2 id="注册服务器"><a href="#%E6%B3%A8%E5%86%8C%E6%9C%8D%E5%8A%A1%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>注册服务器</h2>\n<p>注册服务器接受用户代理的注册请求。它可以帮助用户在网络中进行身份验证。它将 URI 和用户的位置存储在数据库中，以帮助同一域内的其他 SIP 服务器。</p>\n<p>看看下面的示例，显示 SIP 注册的过程：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2019-06-10-14-04-44-91eda7151b50ca646842814cf1b14b11-16a51.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 324px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 62.96296296296296%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABo0lEQVQoz5VSW3OaUBDm/7/4H9InX9q0zUMzEy6lIBqIXI8F5Zo2oHNUxhF7rKMkX+IIJm0fug/L7rf77e3A/bjPNFVjbPv4/8LdGQZ/I6RZxhj7a0Zd19BJGMiy4ti2rt+KgqzfDuaLFcff8B4ZOZZF6aJJhXr5trJljNL5HEmLRV5MKaW/2G9us9kURYHw4ST1iVe/yDm4rqplWTY9ONQghDSpMOIovPp89VWUJFEk34PzUJ7nk8nk2OmZvF6vO52OruuWZQ1N07asXk+9/nLN87wkSYqiAjdNczgcOo4DMAzDtnNZlqqq7na77UlgHzDs/rDf7xsc54SbZVkURS15uVye++fbvkGgsWOSJK86G4axWq1wRhSCO6ezi3cXHy/ff7j8hMMCAY5oVVXI9H2/JYMmCAIgnM3zvKPGng7e1LZhjwg5gnEcd7td13Xbg6FkEARvxv7XrzKdTl8djD2/PoV1n6WmZWKENE3DcBxFiR8EcRw9FMV47P98yJGDTrPZrCU3FvHcb4o86PexqyyLPW0gCKLW11ziqYrseqM/p3sCoy7NG/C5ws4AAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2019 06 10 14 04 44" title="" data-src="/static/2019-06-10-14-04-44-91eda7151b50ca646842814cf1b14b11-16a51.png" data-srcset="/static/2019-06-10-14-04-44-91eda7151b50ca646842814cf1b14b11-6752f.png 200w,\n/static/2019-06-10-14-04-44-91eda7151b50ca646842814cf1b14b11-16a51.png 324w" data-sizes="(max-width: 324px) 100vw, 324px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>这里呼叫者想要向 TMC 域注册。因此，它向 TMC 的 Registrar 服务器发送 REGISTER 请求，并且服务器在授权客户端时返回 200 OK 响应。</p>\n<h2 id="重定向服务器"><a href="#%E9%87%8D%E5%AE%9A%E5%90%91%E6%9C%8D%E5%8A%A1%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>重定向服务器</h2>\n<p>重定向服务器接收请求，并在注册器创建的位置数据库中查找请求的预期收件人。</p>\n<p>重定向服务器使用数据库获取位置信息，并以 3xx（重定向响应） 响应给用户。我们将在本教程的后面讨论响应代码。</p>\n<h2 id="位置服务器"><a href="#%E4%BD%8D%E7%BD%AE%E6%9C%8D%E5%8A%A1%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>位置服务器</h2>\n<p>位置服务器提供有关呼叫者可能的位置到重定向和代理服务器的信息。</p>\n<p>只有代理服务器或重定向服务器可以联系位置服务器。</p>\n<p>下图描绘了每个网络元素在建立会话中所扮演的角色：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2019-06-10-14-06-20-13440bdd0d351c261f85053275b31948-28759.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 500px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 63.6%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAB20lEQVQoz4VSz2/TMBTO37sTNw5oQhwQ4gKckLjsgpC4DgmBEAfQmBgrLVvXrmu6po27JG1+2E4cx3bsJDjJGrYdxpMd+f343vf0vRjVvcYgxDNTYFyWpWpMP7qsUZVloY++VRNtcs7aA44jOU/X3vz4yB8NsxUArjM1TcZZU1U24M5qeBOT4vNg8v7XRCW4FCKMY5qmJct6F/Mv/THlQtfkShVlZUQbZ//wdP8ESMErpRiCaHRqL+Zg7bKV7f/pR+cjOL0QNN0EAZjPfM9zIUYZZ1IaL188f/Tm7c6rPQQWm4WFA19zF3kuKNW984wmV4Aj2A4nwNId9PwwbCc3Hu7uPnv65NunD9q3Bv21vayrpAwj5IZxdUOeJpwTHPGMXgtmef5gtjQDgvQclCoh6q6FihLmYJ5Lpb2apekSQHRwcna5cq7BXBX6QMpZLju1cxjlKOrcql1EShxw9fF4eGaBNmT8y3Wa67KlRVa2YEylpI4pqdnpbEKARQiiJN7u+Qa6pUmoeH2AH3wV339OK9vMRE4pFVzI4rYAt/a8XT2M6eN3w529cc/caFdvZRHFK5h4mMii+A/Ycd3e0Y/z4W9zOtmKLHGclHeJ74CbL8zEZZSO/cRG9P4//y+u7uAR2J+vYAAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2019 06 10 14 06 20" title="" data-src="/static/2019-06-10-14-06-20-13440bdd0d351c261f85053275b31948-28759.png" data-srcset="/static/2019-06-10-14-06-20-13440bdd0d351c261f85053275b31948-6ac48.png 200w,\n/static/2019-06-10-14-06-20-13440bdd0d351c261f85053275b31948-4b8bf.png 400w,\n/static/2019-06-10-14-06-20-13440bdd0d351c261f85053275b31948-28759.png 500w" data-sizes="(max-width: 500px) 100vw, 500px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h1 id="系统架构"><a href="#%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>系统架构</h1>\n<p>SIP 被构造为分层协议，这意味着其行为根据一组相当独立的处理阶段来描述，只有每个阶段之间的松散耦合。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2019-06-10-19-31-14-5e7501d7e92f7c43e4dca4328bd0686b-b50a0.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 202px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 216.83168316831686%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAArCAIAAAD3xz8iAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAFw0lEQVRIx32Wh1NaWRSH+Xt3ZyeWKCoaTbKr0bHEhgiPIogFEESKBQSlCPJAMJb0mbRJZtJ7V/d7XPYF0eyZ4XHfu+fc037nnKs5OTl58eJFIBCYm52TJGlqasrn84ZCoWCZ+B4Mhfx+v9M5bTSapqenPR7PgwcPkDo+PtbcunVrZGRkYWHBYJjw+nz+xcVgMORfWlpaXHS53J6FBZbhUGDaOcPT7XHPu1z68fHNzU3kNRaLxev13rlzRzJLlzvb/vrzj/bOq3X1jU2Njd3Xepu1zS2tbQb9WEtbW1NDHS+R2Ob2dra7u1sRfvz48fDwsMPhCIfDmUxmu0wsstksC+WZy4kFtLq6Ojc3NzAwUCwWFWF+nz9/TiQS+DM5OTk2NoYtMzMzOLK4uOjz+ebn5202m16vNxgM6FheXn716lXFZ34n/9GnT5/evHlz+/btUqlEqAYHBzc2NlB7eHj4/Pnzjx8/Hh0dCU4hpREvfFVPEQtOSafT6qtKqvwv4bPb5C8SibD4+fNntUA1aVRtMAklqmYCUaNZ5akIH5VJvHz//v3Zs2dggBRkMxnJZNrd3SWLDx8+fPToET5Xa6po/vbt28HBAeElzkaTkcCOjo6azRbblM1qtY6DCb2egywWM2EnEO/evatEG/PIkHFy0u32xOIbe3t7+/t7h4cHLPJyfqdYPDw4LBQKO8WdXC4HsHxeL1lgV9FM6kjmzZs3R0eGenr+btU26Tq6Ll5sudzZ2dHZ1drW1tHRYZKkznZdW3tne7uur78fBF2/fh10aIgK2Caf6+uRYNDvsNsdjukJg9FqtTlnZmyK4dZAYMlRXlms9nnX/JTdDqIqPsuyDHpw2O12g41UMlko5Atlysm5vCwnk8mVlVWvd8HlcplMJqrty5cvirAaeuIJE+hzOp0owbErV65SpByKa1Ql1u3v7xPdUwirwYDYuH//fjQaFfk7C7JT8FSzp24IQ9Sj1d1zECaYxLbgACc1woLhFMLUjRqzcQ/YfPjw4e3btwJP55h9XCZWAHNra4taJ54myWQ0GsfHx4kcSWZtNpvpR8T//fv3qjmKZoqbHExMTBBnKmlzcyORTNBMcjlZ6SrZDMAi1IFgkCOA4/r6uoi5BqCSFZpGNpsJLAXCy8sr5HR1dW1tjT/a59KSPxJVKB6Lx2OxzUQCvIATRRgmGmCxWErE13v7enU63YUL9T3XuhsaG5qatS2tLaPDQyNjo/X1jY11dXxwe/2Af8JgIB1KA+zv74/H4/m8vJXZQgO6I2trC14vSIpGorFYjDauGBUOoTsny5gJIn/8+KH4TD0qMZIkmJKplOKtLO/s7BAeOZ+nmMAvH1OpFDjDZ4AtemAFngSAusd+9ogweGR0EB4KGFZeRcCJBchTM6qp6X4i+Hfv3r1x44ap3EkYKQiobUSInYLnWfTxSnpwrFqmumf9tnvC9/XrV3LGU8jU1MZvhQURBTysLsD/E67uvhAG15h9TuutmQPiCBQ+efKE5DFoAIIYNNUj5VfAxIoCIpnlQW1g3JEYSTLZaWnTDhYUCTWDLS9fvlTlNcIY6oFeTW5BD6hw2MxN2tZrfX2tWm1zU0tv/0A6vSU6FOfS6tBU0QwMaFR0c5DEEGYRja5ZzJLdOev1uCWTec7lBl4ULOfCwNDFEOpcwycgxbCmB1N6iTLxXyoVr3ZdstqdjFt4kpXvCgFbDAR2GnotkMZb9ug7PNOpNJcCObc9ONBndTgBObYo8mWCAc+xsaenR/P06VPqGauoeyEfWVudslqoqnB4GfdANR2bK46wCzX5fJ6JgQuKzwweriXwsVcq7a6shHTa+n+6e3Udl7TaFq4yXR26Cw0XC2UTaEZDQ0OiK1eq6vXr15SbMhNJyexcsHwP41pFIwmFwryROaYnpULDYuL+qio16dxJGM4cT7ZnZ2dFMZJet8eDn/fu3SPC59xJzhbm76i6qv4FndI1TKRREB4AAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2019 06 10 19 31 14" title="" data-src="/static/2019-06-10-19-31-14-5e7501d7e92f7c43e4dca4328bd0686b-b50a0.png" data-srcset="/static/2019-06-10-19-31-14-5e7501d7e92f7c43e4dca4328bd0686b-0e5e0.png 200w,\n/static/2019-06-10-19-31-14-5e7501d7e92f7c43e4dca4328bd0686b-b50a0.png 202w" data-sizes="(max-width: 202px) 100vw, 202px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<ul>\n<li>SIP 的最低层是其语法和编码。其编码使用增强的 Backus-Naur 表格语法（BNF）来指定。</li>\n<li>第二层是传输层。它定义客户端如何发送请求并接收响应，以及服务器如何接收请求并通过网络发送响应，所有 SIP 元素都包含传输层。</li>\n<li>接下来是事务层。事务是由客户端事务（使用传输层）发送到服务器事务的请求，以及从服务器事务发送回客户端的对该请求的所有响应。用户代理客户端（UAC）完成的任何任务都将使用一系列事务进行。无状态代理不包含事务层。</li>\n<li>事务层上面的层称为事务用户。除了无状态代理之外，每个 SIP 实体都是一个事务用户。</li>\n</ul>\n<p>下图显示了 SIP 会话的基本呼叫流程：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2019-06-10-19-32-44-f8ef215a624bdd21f854652eb7df10f3-81a6c.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 600px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 61.33333333333334%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAAsSAAALEgHS3X78AAABYUlEQVQoz22RzY6CUAyFff+XGnfqYkxcCEEJIKCCClwE5Z+ZT2pEJ9NFU3rPOT0tk6IofoaguN1ufd8fg2OSJHSu12tVVV3X5XlOQed+v7/jJ3xTgYAZx/HhcFgsFqvVKgiC/X5PZ7n8nk6/5vMZWmEYIlSWpQiN5DRNgZIdx/E873w+K6VAW5blui5aIHltmobMJJWqiTwDzbIMt/B1XV+vNfhpqqIo2m63u90O2wyERgbJsIdt5CFghgc8kzVNE7Tv++BkQ9CcAybz67qmk+XZaFsmo0JGkU9js7lcLkJgDnIYlDF1XZ1O4QeZaNsWYYZAMwzDNE3WY0+YPOFRxv5zMLkKEmRODVMsSKBCkwz4g4wqfqgxiUPkOZXvP6ByKoImtilQxAuAcTK/kTcQsh6jOLtt2yInTdyBRxEKw55klkSMGgvNEKiQX59SI0EB+Gmb6fEQcuTkLV79PyF9bP4CKGOpcZAD1HMAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2019 06 10 19 32 44" title="" data-src="/static/2019-06-10-19-32-44-f8ef215a624bdd21f854652eb7df10f3-81a6c.png" data-srcset="/static/2019-06-10-19-32-44-f8ef215a624bdd21f854652eb7df10f3-468c3.png 200w,\n/static/2019-06-10-19-32-44-f8ef215a624bdd21f854652eb7df10f3-3ff2b.png 400w,\n/static/2019-06-10-19-32-44-f8ef215a624bdd21f854652eb7df10f3-81a6c.png 600w" data-sizes="(max-width: 600px) 100vw, 600px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>以下是对上述呼叫流程的逐步说明：</p>\n<ul>\n<li>发送到代理服务器的 INVITE 请求负责启动会话。</li>\n<li>代理服务器发送 100 尝试立即响应呼叫者（Alice）以停止 INVITE 请求的重新发送。</li>\n<li>代理服务器在位置服务器中搜索 Bob 的地址。获取地址后，进一步转发 INVITE 请求。</li>\n<li>此后，Bob 手机生成的 180 振铃（临时响应）返回给爱丽丝。</li>\n<li>鲍勃拿起手机后一个 200 OK 响应很快产生。</li>\n<li>一旦 200 OK 到达 Alice，Bob 从 Alice 收到一个 ACK。</li>\n<li>同时，会话建立，RTP 数据包（会话）从两端开始流动。</li>\n<li>会话结束后，任何参与者（Alice 或 Bob）都可以发送一个 BYE 请求来终止会话。</li>\n<li>BYE 直接从 Alice 到 Bob 绕过代理服务器。</li>\n<li>最后，Bob 发送 200 OK 响应来确认 BYE，会话终止。</li>\n<li>在上述基本呼叫流程中，可以使用三个事务（标记为 1，2，3）。</li>\n</ul>\n<p>完整的呼叫（从 INVITE 到 200 OK）称为对话 Dialog。</p>\n<h1 id="sip-梯形"><a href="#sip-%E6%A2%AF%E5%BD%A2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>SIP 梯形</h1>\n<p>代理如何帮助一个用户与另一个用户连接？让我们在下图的帮助下找出。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2019-06-10-19-41-07-626e78b214093282713cb4538e1b4946-068c2.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 422px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 62.085308056872044%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAAsSAAALEgHS3X78AAABTElEQVQoz3WSS66CUBBE7/53YAxODHtwihNQh+gIlETED2gUQUUB9Ui/EJ9iDfg0Xd1VdVGr1SpN02OFJEmCIJjP5/v9nlfqVOI4pofiZrM5/ofi86PC/X7n6jiOZVk8lGWZZdntdpPnfr+/WCzqNoFigJSkahhGt9u9Xq/smUwmnue5rmvbtqZp4/FYBjWQpcoGXdfzPEezbI6iCM2dTodZQq6X/5GF6VRYr9fv2mQ0Enzf/5TN4O12ezqdiqIYDocSwXtH7SgMQzppI06kvci8Hw6H8/lMzlj9cFVDimxCwm63k07FSXBDam3+8QPyiWW1L4Xgy+VC6ZtZVvjm445oXuTRaESSvV6PKYhhECFzJWdMknNWgQpuscYa0zRbrRa/gyJDzmYwGMjZRj/AIHLiwJfL5Ww2a7fbEBVp8euQQaPJxgigTKdT5DwBp/ykSH3SIScAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2019 06 10 19 41 07" title="" data-src="/static/2019-06-10-19-41-07-626e78b214093282713cb4538e1b4946-068c2.png" data-srcset="/static/2019-06-10-19-41-07-626e78b214093282713cb4538e1b4946-2e5ea.png 200w,\n/static/2019-06-10-19-41-07-626e78b214093282713cb4538e1b4946-68ec0.png 400w,\n/static/2019-06-10-19-41-07-626e78b214093282713cb4538e1b4946-068c2.png 422w" data-sizes="(max-width: 422px) 100vw, 422px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>图中所示的拓扑结构称为 SIP 梯形图。该过程发生如下：</p>\n<ul>\n<li>当呼叫方发起呼叫时，将向代理服务器发送 INVITE 消息。代理服务器收到 INVITE 后，尝试借助 DNS 服务器解析受理者的地址。</li>\n<li>在获得下一个路由之后，呼叫者的代理服务器（代理 1，也称为出站代理服务器）将 INVITE 请求转发给作为被呼叫者的入站代理服务器（代理服务器 2）的被呼叫者的代理服务器。</li>\n<li>入站代理服务器联系位置服务器以获取用户注册的被叫方地址信息。</li>\n<li>从位置服务器获取信息后，将呼叫转发到其目的地。</li>\n<li>一旦用户代理知道他们的地址，他们可以绕过呼叫，即直接通话。</li>\n</ul>\n<p>以上更新于<code class="language-text">2019-6-10 20:24:54</code></p>\n<hr>',excerpt:"会话发起协议（SIP）是 VoIP 技术中最常用的协议之一。它是一种应用层协议，与其他应用层协议协同工作，通过 Internet 控制多媒体通信会话。 概述 SIP…",frontmatter:{date:"2019-06-10 11:43:51",path:"/sip-protocol-introduction-learning/",tags:"前端, SIP",title:"SIP协议入门学习",draft:null}}},pathContext:{mainPostPath:"/nginx-common-configurations-techniques/",nextPostPath:"/write-resilient-components/",prePostPath:"/sip-protocol-introduction-learning/"}}}});