webpackJsonp([0x7eeb019129cb],{1613:function(n,a){n.exports={data:{site:{siteMetadata:{title:"女王控的博客",description:'前端工程师，黑猫女王控，欢迎勾搭，技术相关<a href="https://github.com/towavephone" target="_blank">@towavephone</a>，QQ闲聊<a href="tencent://AddContact/?fromId=45&fromSubId=1&subcmd=all&uin=634407147&website=www.oicqzone.com">@towave</a>，bili关注<a href="https://space.bilibili.com/11507708#/" target="_blank">@towave</a>',siteUrl:"https://blog.towavephone.com"}}},pathContext:{posts:[{excerpt:"需求背景 由于客服聊天组件需要支持以新窗口的形式打开，也就是以 window.open 的新窗口打开，同时需要支持嵌入公司自己的产品端，在技术攻关的过程中遇到很多问题，特此记录 问题及解决方案 标记为横线的为完成需求后发现现阶段不需要做的 跨域窗口间的通信： 编写底层通信库 、通过 url 传递 嵌入公司产品端：独立客服聊天组件的运行环境 设置新窗口位置：需要注意兼容分屏情况 监听新窗口打开情况： 通过底层库发消息 、获取 window.open 的 closed…",html:'<h1 id="需求背景"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h1>\n<p>由于客服聊天组件需要支持以新窗口的形式打开，也就是以 window.open 的新窗口打开，同时需要支持嵌入公司自己的产品端，在技术攻关的过程中遇到很多问题，特此记录</p>\n<h1 id="问题及解决方案"><a href="#%E9%97%AE%E9%A2%98%E5%8F%8A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>问题及解决方案</h1>\n<p>标记为横线的为完成需求后发现现阶段不需要做的</p>\n<ol>\n<li>跨域窗口间的通信：<s>编写底层通信库</s>、通过 url 传递</li>\n<li>嵌入公司产品端：独立客服聊天组件的运行环境</li>\n<li>设置新窗口位置：需要注意兼容分屏情况</li>\n<li>监听新窗口打开情况：<s>通过底层库发消息</s>、获取 window.open 的 closed 属性</li>\n<li><s>监听新窗口是否加载完成</s>：<s>通过底层库发消息</s></li>\n<li>聊天消息输入类 html 字符：匹配特定字符进行 html 渲染，其他字符按文本渲染</li>\n</ol>\n<h1 id="具体解决"><a href="#%E5%85%B7%E4%BD%93%E8%A7%A3%E5%86%B3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>具体解决</h1>\n<h2 id="跨域窗口间通信"><a href="#%E8%B7%A8%E5%9F%9F%E7%AA%97%E5%8F%A3%E9%97%B4%E9%80%9A%E4%BF%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>跨域窗口间通信</h2>\n<h3 id="底层库编写"><a href="#%E5%BA%95%E5%B1%82%E5%BA%93%E7%BC%96%E5%86%99" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>底层库编写</h3>\n<p>因为需要知道打开的是哪个技能组（相当于群），需要传递技能组的相关信息，首先需要编写底层库，核心代码如下</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="4741400460003508000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`export default class Bus {\n    private syncFns: Array<SyncFn> = []\n\n    constructor(public origin: string, syncFn: SyncFn | Array<SyncFn>) {\n        this.init()\n        this.syncFns = Array.isArray(syncFn) ? syncFn : [syncFn]\n    }\n\n    private init(): void {\n        window.addEventListener(&quot;message&quot;, this.receiveMsg.bind(this), false)\n    }\n\n    // 获取跨域消息\n    private receiveMsg(e) {\n        const { origin } = e\n        if (this.origin !== \'*\' && origin !== this.origin) return\n        const { name, data } = e.data\n        this.syncFns.forEach(item => {\n            if (item.name === name) {\n                item.fn(data, e)\n            }\n        })\n    }\n\n    // 发送跨域消息\n    postMessage(windowInstance: object, swMessage: SWMessage, targetOrigin: string) {\n        windowInstance && windowInstance.postMessage(swMessage, targetOrigin)\n    }\n}`, `4741400460003508000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Bus</span> <span class="token punctuation">{</span>\n    <span class="token keyword">private</span> syncFns<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>SyncFn<span class="token operator">></span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n\n    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">public</span> origin<span class="token punctuation">:</span> string<span class="token punctuation">,</span> syncFn<span class="token punctuation">:</span> SyncFn <span class="token operator">|</span> Array<span class="token operator">&lt;</span>SyncFn<span class="token operator">></span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n        <span class="token keyword">this</span><span class="token punctuation">.</span>syncFns <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>syncFn<span class="token punctuation">)</span> <span class="token operator">?</span> syncFn <span class="token punctuation">:</span> <span class="token punctuation">[</span>syncFn<span class="token punctuation">]</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">private</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>\n        window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">"message"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">receiveMsg</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token comment">// 获取跨域消息</span>\n    <span class="token keyword">private</span> <span class="token function">receiveMsg</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">const</span> <span class="token punctuation">{</span> origin <span class="token punctuation">}</span> <span class="token operator">=</span> e\n        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>origin <span class="token operator">!==</span> <span class="token string">\'*\'</span> <span class="token operator">&amp;&amp;</span> origin <span class="token operator">!==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>origin<span class="token punctuation">)</span> <span class="token keyword">return</span>\n        <span class="token keyword">const</span> <span class="token punctuation">{</span> name<span class="token punctuation">,</span> data <span class="token punctuation">}</span> <span class="token operator">=</span> e<span class="token punctuation">.</span>data\n        <span class="token keyword">this</span><span class="token punctuation">.</span>syncFns<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span>name <span class="token operator">===</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                item<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> e<span class="token punctuation">)</span>\n            <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token comment">// 发送跨域消息</span>\n    <span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token parameter">windowInstance<span class="token punctuation">:</span> object<span class="token punctuation">,</span> swMessage<span class="token punctuation">:</span> SWMessage<span class="token punctuation">,</span> targetOrigin<span class="token punctuation">:</span> string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        windowInstance <span class="token operator">&amp;&amp;</span> windowInstance<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span>swMessage<span class="token punctuation">,</span> targetOrigin<span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="传递数据"><a href="#%E4%BC%A0%E9%80%92%E6%95%B0%E6%8D%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>传递数据</h3>\n<p>注意加重部分，由于以上代码不知道什么时候新窗口加载完毕，提前发送消息会没效果，所以设置了延时</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="61026114555127210000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 主页面 index.html，访问域名为 http://localhost:10001\nvar caller = new Bus(\'http://127.0.0.1:10001\', [\n  {\n    name: \'message\',\n    fn: (data) => {\n      console.log(\'收到新窗口的消息\', data);\n    }\n  }\n]);\n\ndocument.querySelector(\'#button\').addEventListener(\'click\', function() {\n  var popup = window.open(\'http://127.0.0.1:10001/popup.html\', \'\', \'width=300,height=300,top=100,left=200\');\n  setTimeout(() => {\n    caller.postMessage(\n      popup,\n      {\n        name: \'nickname\',\n        data: {\n          name: \'towavephone\'\n        }\n      },\n      \'http://127.0.0.1:10001\'\n    );\n  }, 2000);\n});`, `61026114555127210000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{13-24}"\n              >\n                <span class="gatsby-code-button-language">js{13-24}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 主页面 index.html，访问域名为 http://localhost:10001</span>\n<span class="token keyword">var</span> caller <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Bus</span><span class="token punctuation">(</span><span class="token string">\'http://127.0.0.1:10001\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>\n  <span class="token punctuation">{</span>\n    name<span class="token punctuation">:</span> <span class="token string">\'message\'</span><span class="token punctuation">,</span>\n    <span class="token function-variable function">fn</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'收到新窗口的消息\'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\ndocument<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">\'#button\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">\'click\'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> popup <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">\'http://127.0.0.1:10001/popup.html\'</span><span class="token punctuation">,</span> <span class="token string">\'\'</span><span class="token punctuation">,</span> <span class="token string">\'width=300,height=300,top=100,left=200\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line">  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    caller<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span></span><span class="gatsby-highlight-code-line">      popup<span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">      <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">        name<span class="token punctuation">:</span> <span class="token string">\'nickname\'</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">        data<span class="token punctuation">:</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">          name<span class="token punctuation">:</span> <span class="token string">\'towavephone\'</span></span><span class="gatsby-highlight-code-line">        <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">      <span class="token punctuation">}</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">      <span class="token string">\'http://127.0.0.1:10001\'</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="73528276728445680000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 新窗口页面 popup.html，访问域名为 http://127.0.0.1:10001/popup.html\nvar caller = new Bus(\'http://localhost:10001\', [\n  {\n    name: \'nickname\',\n    fn: (data, e) => {\n      console.log(\'收到主页面的消息\', data);\n      caller.postMessage(\n        e.source,\n        {\n          name: \'message\',\n          data: {\n            name: \\`hello \\${data.name}\\`\n          }\n        },\n        \'http://localhost:10001\'\n      );\n    }\n  }\n]);`, `73528276728445680000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 新窗口页面 popup.html，访问域名为 http://127.0.0.1:10001/popup.html</span>\n<span class="token keyword">var</span> caller <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Bus</span><span class="token punctuation">(</span><span class="token string">\'http://localhost:10001\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>\n  <span class="token punctuation">{</span>\n    name<span class="token punctuation">:</span> <span class="token string">\'nickname\'</span><span class="token punctuation">,</span>\n    <span class="token function-variable function">fn</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> e</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'收到主页面的消息\'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      caller<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span>\n        e<span class="token punctuation">.</span>source<span class="token punctuation">,</span>\n        <span class="token punctuation">{</span>\n          name<span class="token punctuation">:</span> <span class="token string">\'message\'</span><span class="token punctuation">,</span>\n          data<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n            name<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">hello </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>data<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>\n          <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span><span class="token punctuation">,</span>\n        <span class="token string">\'http://localhost:10001\'</span>\n      <span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>执行效果：</p>\n<p><img src="/static/cross-origin-1-12fef4bc58b79e2c34b6982487f764b8.gif" alt="跨域传输"></p>\n<h3 id="监听新窗口是否加载完成"><a href="#%E7%9B%91%E5%90%AC%E6%96%B0%E7%AA%97%E5%8F%A3%E6%98%AF%E5%90%A6%E5%8A%A0%E8%BD%BD%E5%AE%8C%E6%88%90" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>监听新窗口是否加载完成</h3>\n<p>setTimeout 设置的延时不够准确，需要采用以下方案</p>\n<h4 id="监听-windowopen-的-onload-事件（跨域下失效）"><a href="#%E7%9B%91%E5%90%AC-windowopen-%E7%9A%84-onload-%E4%BA%8B%E4%BB%B6%EF%BC%88%E8%B7%A8%E5%9F%9F%E4%B8%8B%E5%A4%B1%E6%95%88%EF%BC%89" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>监听 window.open 的 onload 事件（跨域下失效）</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="73232038083556800000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 主页面 index.html，访问域名为 http://localhost:10001\nvar caller = new Bus(\'http://127.0.0.1:10001\', [\n  {\n    name: \'message\',\n    fn: (data) => {\n      console.log(\'收到新窗口的消息\', data);\n    }\n  }\n]);\n\ndocument.querySelector(\'#button\').addEventListener(\'click\', function() {\n  var popup = window.open(\'http://127.0.0.1:10001/popup.html\', \'\', \'width=300,height=300,top=100,left=200\');\n  popup.onload = function() {\n    caller.postMessage(\n      popup,\n      {\n        name: \'nickname\',\n        data: {\n          name: \'towavephone\'\n        }\n      },\n      \'http://127.0.0.1:10001\'\n    );\n  };\n});`, `73232038083556800000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{13-24}"\n              >\n                <span class="gatsby-code-button-language">js{13-24}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 主页面 index.html，访问域名为 http://localhost:10001</span>\n<span class="token keyword">var</span> caller <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Bus</span><span class="token punctuation">(</span><span class="token string">\'http://127.0.0.1:10001\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>\n  <span class="token punctuation">{</span>\n    name<span class="token punctuation">:</span> <span class="token string">\'message\'</span><span class="token punctuation">,</span>\n    <span class="token function-variable function">fn</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'收到新窗口的消息\'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\ndocument<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">\'#button\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">\'click\'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> popup <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">\'http://127.0.0.1:10001/popup.html\'</span><span class="token punctuation">,</span> <span class="token string">\'\'</span><span class="token punctuation">,</span> <span class="token string">\'width=300,height=300,top=100,left=200\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line">  popup<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    caller<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span></span><span class="gatsby-highlight-code-line">      popup<span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">      <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">        name<span class="token punctuation">:</span> <span class="token string">\'nickname\'</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">        data<span class="token punctuation">:</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">          name<span class="token punctuation">:</span> <span class="token string">\'towavephone\'</span></span><span class="gatsby-highlight-code-line">        <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">      <span class="token punctuation">}</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">      <span class="token string">\'http://127.0.0.1:10001\'</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span><span class="token punctuation">;</span></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>刚开始打算监听 window.open 的 onload 事件，但是在不同域名下会报错</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2020-07-01-21-58-38-f11fc49b7805e0841c4e04dd7be37162-63438.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 13.785790031813361%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAIAAAAcOLh5AAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAlklEQVQI1zXGyw6CMBBAUf7/43zgwhhoQUqhVWFmaC0dkFRcmJzc3MzachgbIg2gEFvCFkERKEeayNRaWSONrbpePJ53wB6wg1EjdLtsljmLU5R5kPlcX3yVU3kYxNHI86u5or6xrRZdLL3gnS7YSB7bOCjQRZZ8SDglcmnyO/YhTj6Q8+Sie2+8JF7Tr/9ZPmnddhuvX7vrptWmlNHPAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2020 07 01 21 58 38" title="" data-src="/static/2020-07-01-21-58-38-f11fc49b7805e0841c4e04dd7be37162-fee1c.png" data-srcset="/static/2020-07-01-21-58-38-f11fc49b7805e0841c4e04dd7be37162-a67b7.png 200w,\n/static/2020-07-01-21-58-38-f11fc49b7805e0841c4e04dd7be37162-0b187.png 400w,\n/static/2020-07-01-21-58-38-f11fc49b7805e0841c4e04dd7be37162-fee1c.png 800w,\n/static/2020-07-01-21-58-38-f11fc49b7805e0841c4e04dd7be37162-63438.png 943w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h4 id="跨域发送消息检测加载完成"><a href="#%E8%B7%A8%E5%9F%9F%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF%E6%A3%80%E6%B5%8B%E5%8A%A0%E8%BD%BD%E5%AE%8C%E6%88%90" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>跨域发送消息检测加载完成</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="78620854587132280000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 主页面 index.html，访问域名为 http://localhost:10001\nvar isLoaded = false;\nvar caller = new Bus(\'http://127.0.0.1:10001\', [\n  {\n    name: \'message\',\n    fn: (data) => {\n      console.log(\'收到新窗口的消息\', data);\n    }\n  },\n  {\n    name: \'newWindowLoad\',\n    fn: () => {\n      isLoaded = true;\n      console.log(\'新窗口加载完成\');\n    }\n  }\n]);\n\ndocument.querySelector(\'#button\').addEventListener(\'click\', function() {\n  var popup = window.open(\'http://127.0.0.1:10001/popup.html\', \'\', \'width=300,height=300,top=100,left=200\');\n  isLoaded = false;\n  var timer = setInterval(() => {\n    if (!isLoaded) {\n      return;\n    }\n    timer && clearInterval(timer);\n    caller.postMessage(\n      popup,\n      {\n        name: \'nickname\',\n        data: {\n          name: \'towavephone\'\n        }\n      },\n      \'http://127.0.0.1:10001\'\n    );\n  }, 0);\n});`, `78620854587132280000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{2,10-16,21-37}"\n              >\n                <span class="gatsby-code-button-language">js{2,10-16,21-37}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 主页面 index.html，访问域名为 http://localhost:10001</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">var</span> isLoaded <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></span><span class="token keyword">var</span> caller <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Bus</span><span class="token punctuation">(</span><span class="token string">\'http://127.0.0.1:10001\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>\n  <span class="token punctuation">{</span>\n    name<span class="token punctuation">:</span> <span class="token string">\'message\'</span><span class="token punctuation">,</span>\n    <span class="token function-variable function">fn</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'收到新窗口的消息\'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n<span class="gatsby-highlight-code-line">  <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    name<span class="token punctuation">:</span> <span class="token string">\'newWindowLoad\'</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token function-variable function">fn</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      isLoaded <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'新窗口加载完成\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span></span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\ndocument<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">\'#button\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">\'click\'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> popup <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">\'http://127.0.0.1:10001/popup.html\'</span><span class="token punctuation">,</span> <span class="token string">\'\'</span><span class="token punctuation">,</span> <span class="token string">\'width=300,height=300,top=100,left=200\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line">  isLoaded <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">var</span> timer <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isLoaded<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      <span class="token keyword">return</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">    timer <span class="token operator">&amp;&amp;</span> <span class="token function">clearInterval</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    caller<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span></span><span class="gatsby-highlight-code-line">      popup<span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">      <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">        name<span class="token punctuation">:</span> <span class="token string">\'nickname\'</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">        data<span class="token punctuation">:</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">          name<span class="token punctuation">:</span> <span class="token string">\'towavephone\'</span></span><span class="gatsby-highlight-code-line">        <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">      <span class="token punctuation">}</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">      <span class="token string">\'http://127.0.0.1:10001\'</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="4663987188571106000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 新窗口页面 popup.html，访问域名为 http://127.0.0.1:10001/popup.html\nvar caller = new Bus(\'http://localhost:10001\', [\n  {\n    name: \'nickname\',\n    fn: (data, e) => {\n      console.log(\'收到主页面的消息\', data);\n      caller.postMessage(\n        e.source,\n        {\n          name: \'message\',\n          data: {\n            name: \\`hello \\${data.name}\\`\n          }\n        },\n        \'http://localhost:10001\'\n      );\n    }\n  }\n]);\n\ncaller.postMessage(\n  window.opener,\n  {\n    name: \'newWindowLoad\'\n  },\n  \'http://localhost:10001\'\n);`, `4663987188571106000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{21-27}"\n              >\n                <span class="gatsby-code-button-language">js{21-27}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 新窗口页面 popup.html，访问域名为 http://127.0.0.1:10001/popup.html</span>\n<span class="token keyword">var</span> caller <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Bus</span><span class="token punctuation">(</span><span class="token string">\'http://localhost:10001\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>\n  <span class="token punctuation">{</span>\n    name<span class="token punctuation">:</span> <span class="token string">\'nickname\'</span><span class="token punctuation">,</span>\n    <span class="token function-variable function">fn</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> e</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'收到主页面的消息\'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      caller<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span>\n        e<span class="token punctuation">.</span>source<span class="token punctuation">,</span>\n        <span class="token punctuation">{</span>\n          name<span class="token punctuation">:</span> <span class="token string">\'message\'</span><span class="token punctuation">,</span>\n          data<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n            name<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">hello </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>data<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>\n          <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span><span class="token punctuation">,</span>\n        <span class="token string">\'http://localhost:10001\'</span>\n      <span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line">caller<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span></span><span class="gatsby-highlight-code-line">  window<span class="token punctuation">.</span>opener<span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    name<span class="token punctuation">:</span> <span class="token string">\'newWindowLoad\'</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">  <span class="token string">\'http://localhost:10001\'</span></span><span class="gatsby-highlight-code-line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>当新窗口的页面加载完毕时会发出 <code class="language-text">newWindowLoad</code> 消息，主页面接收后，标志变量 <code class="language-text">isLoaded</code> 置为 <code class="language-text">true</code>，此时尚在轮询的消息就可以发出。</p>\n<p><img src="/static/cross-origin-2-4340a95c494c85d0372f941fff11e3c5.gif" alt="跨域传输"></p>\n<h3 id="通过-url-传递数据"><a href="#%E9%80%9A%E8%BF%87-url-%E4%BC%A0%E9%80%92%E6%95%B0%E6%8D%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>通过 url 传递数据</h3>\n<p>之后由于新窗口需要刷新后也要保持当前技能组的打开，以上方案在刷新新窗口后数据会丢失，所以通过 url 来传递数据</p>\n<h2 id="独立客服组件运行环境"><a href="#%E7%8B%AC%E7%AB%8B%E5%AE%A2%E6%9C%8D%E7%BB%84%E4%BB%B6%E8%BF%90%E8%A1%8C%E7%8E%AF%E5%A2%83" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>独立客服组件运行环境</h2>\n<p>由于客服组件需要嵌入公司产品端，因为采用的技术栈和公司产品端的技术栈一致，这时会遇到很多问题：</p>\n<ol>\n<li>react 和 react-lite 的冲突，react 16 与 react 15 不能同时引入到一个页面，具体见 <a href="https://github.com/facebook/react/issues/16029" target="_blank" rel="nofollow noreferrer noopener">https://github.com/facebook/react/issues/16029</a> <html><head></head><body><a class="gatsby-resp-image-link" href="/static/2020-07-01-22-25-58-a3e4eb3adf3faf8ea62ecb0296ad950e-50858.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 6.893106893106893%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAABCAIAAABR8BlyAAAACXBIWXMAAAsSAAALEgHS3X78AAAAOElEQVQI1x2K2wkAIAwD3X9GH622I6jph2AUjsAdSWG+c0W3GMSflkZFU1ThskP600/o4A1qZ64LhWw20TUfTUwAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2020 07 01 22 25 58" title="" data-src="/static/2020-07-01-22-25-58-a3e4eb3adf3faf8ea62ecb0296ad950e-fee1c.png" data-srcset="/static/2020-07-01-22-25-58-a3e4eb3adf3faf8ea62ecb0296ad950e-a67b7.png 200w,\n/static/2020-07-01-22-25-58-a3e4eb3adf3faf8ea62ecb0296ad950e-0b187.png 400w,\n/static/2020-07-01-22-25-58-a3e4eb3adf3faf8ea62ecb0296ad950e-fee1c.png 800w,\n/static/2020-07-01-22-25-58-a3e4eb3adf3faf8ea62ecb0296ad950e-50858.png 1001w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></li>\n<li>babel-polyfill 引入 2 次导致不能正常加载 <html><head></head><body><a class="gatsby-resp-image-link" href="/static/2020-07-01-22-30-23-ebb5dabc1657307efd7b0eca866b3a61-8f59e.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 6.003937007874017%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAABCAIAAABR8BlyAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAASElEQVQI1wE9AML/AObk5OrMxOrJwenIwOrLw+rLw+vKwurGv/ji2v/x5v3s4v7w5v727P727PDo3+nh2eni2ebe1u/n3tbPxzB/NIUC3lvwAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2020 07 01 22 30 23" title="" data-src="/static/2020-07-01-22-30-23-ebb5dabc1657307efd7b0eca866b3a61-fee1c.png" data-srcset="/static/2020-07-01-22-30-23-ebb5dabc1657307efd7b0eca866b3a61-a67b7.png 200w,\n/static/2020-07-01-22-30-23-ebb5dabc1657307efd7b0eca866b3a61-0b187.png 400w,\n/static/2020-07-01-22-30-23-ebb5dabc1657307efd7b0eca866b3a61-fee1c.png 800w,\n/static/2020-07-01-22-30-23-ebb5dabc1657307efd7b0eca866b3a61-8f59e.png 1016w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></li>\n</ol>\n<h3 id="独立运行环境"><a href="#%E7%8B%AC%E7%AB%8B%E8%BF%90%E8%A1%8C%E7%8E%AF%E5%A2%83" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>独立运行环境</h3>\n<p>由于在开发服本地是正常的，编译为生产版本后冲突，首先想到了是不是生成文件 js 编号的冲突，于是做出以下修改</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="36282431535984628000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`optimization: {\n  // 以模块文件路径作为要加载模块的 key，不设置时默认以递增数字为 key\n  namedModules: true,\n  // 分包文件同理\n  namedChunks: true,\n}`, `36282431535984628000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">optimization<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 以模块文件路径作为要加载模块的 key，不设置时默认以递增数字为 key</span>\n  namedModules<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n  <span class="token comment">// 分包文件同理</span>\n  namedChunks<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后发现 react 和 react-lite 的共存时还是会报错，除非能保证客服组件的脚本能先于公司产品端去加载，这样的话就需要动到各个产品端的 index.html 文件，然而这样的话改动影响面会比较大，也不好在 index.html 中去读取到环境变量</p>\n<p>最后理了下思路，发现应该是产品端所有加载文件默认都在 webpackJsonp 变量下，需要将客服组件项目加载到不同的变量下才能做到环境上的隔绝</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="37737432808648230000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`output: {\n  filename: \'[name].js\',\n  chunkFilename: \'[name].[chunkhash].chunk.js\',\n  // 关键的一步，使同一网页上的多个 webpack 运行，互不影响\n  jsonpFunction: \'ponyWebpackJsonp\',\n},`, `37737432808648230000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{5}"\n              >\n                <span class="gatsby-code-button-language">js{5}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">output<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n  filename<span class="token punctuation">:</span> <span class="token string">\'[name].js\'</span><span class="token punctuation">,</span>\n  chunkFilename<span class="token punctuation">:</span> <span class="token string">\'[name].[chunkhash].chunk.js\'</span><span class="token punctuation">,</span>\n  <span class="token comment">// 关键的一步，使同一网页上的多个 webpack 运行，互不影响</span>\n<span class="gatsby-highlight-code-line">  jsonpFunction<span class="token punctuation">:</span> <span class="token string">\'ponyWebpackJsonp\'</span><span class="token punctuation">,</span></span><span class="token punctuation">}</span><span class="token punctuation">,</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>具体的原理可参考：<a href="/module-federation-principle-research/">Module federation 原理研究</a></p>\n<h3 id="babel-polyfill-引入-2-次"><a href="#babel-polyfill-%E5%BC%95%E5%85%A5-2-%E6%AC%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>babel-polyfill 引入 2 次</h3>\n<p>这里的话因为引入了 babel-polyfil，所以需要将客服组件项目中的 <code class="language-text">global._babelPolyfill = true;</code> 这一行屏蔽掉，防止公司产品端报错，暂时未想到更好的办法</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="35580798426899964000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// global._babelPolyfill = true;`, `35580798426899964000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// global._babelPolyfill = true;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h2 id="设置新窗口位置"><a href="#%E8%AE%BE%E7%BD%AE%E6%96%B0%E7%AA%97%E5%8F%A3%E4%BD%8D%E7%BD%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>设置新窗口位置</h2>\n<p>需要注意下分屏的情况，新窗口在副屏的定位是错的，需要做特殊处理，主屏上没问题</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="25063547929153730000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 兼容左右分屏情况\nconst { availTop, availLeft } = window.screen;\nif (availLeft) {\n  left += availLeft;\n}\nif (availTop) {\n  top += availTop;\n}`, `25063547929153730000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 兼容左右分屏情况</span>\n<span class="token keyword">const</span> <span class="token punctuation">{</span> availTop<span class="token punctuation">,</span> availLeft <span class="token punctuation">}</span> <span class="token operator">=</span> window<span class="token punctuation">.</span>screen<span class="token punctuation">;</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span>availLeft<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  left <span class="token operator">+=</span> availLeft<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span>availTop<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  top <span class="token operator">+=</span> availTop<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><a href="https://segmentfault.com/a/1190000017989734" target="_blank" rel="nofollow noreferrer noopener">chrome 弹窗在双屏情况下 left 居中定位异常分析</a></p>\n<h2 id="监听新窗口打开情况"><a href="#%E7%9B%91%E5%90%AC%E6%96%B0%E7%AA%97%E5%8F%A3%E6%89%93%E5%BC%80%E6%83%85%E5%86%B5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>监听新窗口打开情况</h2>\n<p>通过监听 window.open 的 closed 属性，因为有多个新窗口打开，需要遍历 window.open 数组</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="86975848860146480000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`this.popups = [];\nconst popup = window.open(url, \'\');\nthis.popups.push(popup);\n\n// 得到打开的新窗口\nthis.popups.filter((item) => !item.closed);`, `86975848860146480000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">this</span><span class="token punctuation">.</span>popups <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> popup <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token string">\'\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">this</span><span class="token punctuation">.</span>popups<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>popup<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 得到打开的新窗口</span>\n<span class="token keyword">this</span><span class="token punctuation">.</span>popups<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token operator">!</span>item<span class="token punctuation">.</span>closed<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="解决聊天框代码注入"><a href="#%E8%A7%A3%E5%86%B3%E8%81%8A%E5%A4%A9%E6%A1%86%E4%BB%A3%E7%A0%81%E6%B3%A8%E5%85%A5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>解决聊天框代码注入</h2>\n<p>由于聊天表情是由有限的几个字符组成的，格式为 <code class="language-text">[高兴]</code>, 所以只要匹配这几个字符，然后以 dangerouslySetInnerHTML 渲染，其他字符以普通文本字符渲染就可以</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="68609081687140860000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// EmojiList：表情字符列表，symbolToHTML：特定字符转为 html 方法\nrenderText = (text) => {\n  const renderContent = [];\n  text.replace(/\\[([^[\\]]+?)\\]|./g, (symbol) => {\n    if (/\\[([^[\\]]+?)\\]/.test(symbol) && EmojiList.find((item) => item.symbol === symbol)) {\n      renderContent.push(<span dangerouslySetInnerHTML={{ __html: symbolToHTML(symbol) }} />);\n    } else {\n      renderContent.push(symbol);\n    }\n  });\n  return <div>{renderContent}</div>;\n};`, `68609081687140860000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// EmojiList：表情字符列表，symbolToHTML：特定字符转为 html 方法</span>\n<span class="token function-variable function">renderText</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> renderContent <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  text<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\\[([^[\\]]+?)\\]|./g</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">symbol</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex">/\\[([^[\\]]+?)\\]/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>symbol<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> EmojiList<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> item<span class="token punctuation">.</span>symbol <span class="token operator">===</span> symbol<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      renderContent<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>span dangerouslySetInnerHTML<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> __html<span class="token punctuation">:</span> <span class="token function">symbolToHTML</span><span class="token punctuation">(</span>symbol<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n      renderContent<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>symbol<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> <span class="token operator">&lt;</span>div<span class="token operator">></span><span class="token punctuation">{</span>renderContent<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="效果截图"><a href="#%E6%95%88%E6%9E%9C%E6%88%AA%E5%9B%BE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>效果截图</h1>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2020-07-01-23-11-11-b4db819bc8afb7c48299e354bdb8de77-83c29.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 722px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 89.75069252077562%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAIAAADUsmlHAAAACXBIWXMAAAsSAAALEgHS3X78AAACDElEQVQ4y5VTTWvUQBjO3/NQ/QVitx4EoQexemhRPPiBvXj25LF+rKIogvQgStW1Cv3YunRpNxHdNmnYZpPJzOx8j+8k7Lo1QfHJwzAJ88z7PO9MvIywTzv+2sa3j5udz+1ua7vbajuu7+y9Xd9a+7LJGLPWGgODFVLGcZxlWfHFeO1ef/7u/cU7y1duLc9fv9lYWJpdWJq7eu3C4g2YX759D6G8XAqjFCI+ihFCY3E/u/Qiuvg8Of8kPrdyOPf4aPZh2HgUwWujefxqI9ScKG2U0kCpFBRXuphL7X39Qc++VGee2ZmmPf3UzowJ81NN++BdwEnGleFSVelRSrVkVgO5NRxyuVEzYzR4+x74GBNbB2c7J0RIBYnAmwYaRzc3FlL2/ACT32KwjDFWSrnmCeERQjnnZT/MSdiKGKKC01IMANsjlKaE0lqxH5wQT0Nr7WFCGXeA/f5ZeRqFbUoxQoPBoFa83/PzHNeKYb0TszHASaUydLte7DKDqzTNyqVV/CWzE0O34RGciyK5noKz7fvJMBNSMy7/IBfKNWxwnLg7Z6zU7oQnnM5sKhBKuspiRKwR0PyqsTCKaHGKk1tVHLK7QAlPXeZWgF530OpuvtrFE77ZxR98chBG5S85Ph6ZJGBTGqu3kvceZDtMSC/KD4ajfkIn/JnQcAhVaW0v4fruZx2vNAOb2f8EZfYX0Ub034bAPIMAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2020 07 01 23 11 11" title="" data-src="/static/2020-07-01-23-11-11-b4db819bc8afb7c48299e354bdb8de77-83c29.png" data-srcset="/static/2020-07-01-23-11-11-b4db819bc8afb7c48299e354bdb8de77-5b578.png 200w,\n/static/2020-07-01-23-11-11-b4db819bc8afb7c48299e354bdb8de77-4dff0.png 400w,\n/static/2020-07-01-23-11-11-b4db819bc8afb7c48299e354bdb8de77-83c29.png 722w" data-sizes="(max-width: 722px) 100vw, 722px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2020-07-01-23-14-38-bddade5a03e1b0993bfb530b93119978-a2194.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 750px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 84.39999999999999%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAIAAABSJhvpAAAACXBIWXMAAAsSAAALEgHS3X78AAACMUlEQVQ4y31STWsUQRBtvfh3/A3eJQcPnlQEUUGQiEtEUBMXExD06kfOoh70pEtQTwY8KyQXzW52N9mdzM5Md093T3/OlzWbzbC7iT5qimGmX9WrfoUuN9cvNR5caTy8uvTo4u2l89cXF27euXCrsXBj8e7ac855eYSiKOoMyPMcvfw+fLXpPf3mrbT6zdbe8qfe8ud+c2N/ZcNb3xyI/5PPvbHXvpRnnpWnVkv0pESrVZxeK9Dj8uwLwRmVUhJCrLXlLNIsRx+3ktaf9P2WezcT9u12/uFn5HkeKGcszrKs7g/veYUMWcnL3BZOidDno4EIhhIHRaqgdEyjdqczHA4ojWvB1jlGyRCz1x2DQsqFsjzRIZW/PbnryyiWLNGJdn5Idto77XYnjHBRTz7O1JX3f2WIxFxpK5VJlA2YjTi8Wym1Ni6ISISx1hoGBpVHsqtMTHnvxxQZAhgQVSGpjU0PRuHe/kBrNfJ9pfR0Z5OVX7uz5DomZD/o9vpJklBKrTXThk2swrVsOR0V2fPD3W4vCEZCiPIYKqso4yAJhjTG1TEeM8UkZpynYxwng1+IcZEkQspk5keaQjDGCaFznBnZUqmqcpbVa1CfgKrs3+sJ5xEMN7c60PPQGGDGjIlE4Ag75+YkRIagCJOIwArFkMBVTCpvq4+YHPgjMgasdzHGdGeXOWSti4WE+4Ha8NgKkwzTwNHDfPKF5UVh0xyOQzsg1JdhjIEMJhd5ceLMXGV/AVIJsfFk9b2VAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2020 07 01 23 14 38" title="" data-src="/static/2020-07-01-23-14-38-bddade5a03e1b0993bfb530b93119978-a2194.png" data-srcset="/static/2020-07-01-23-14-38-bddade5a03e1b0993bfb530b93119978-2e341.png 200w,\n/static/2020-07-01-23-14-38-bddade5a03e1b0993bfb530b93119978-e3a06.png 400w,\n/static/2020-07-01-23-14-38-bddade5a03e1b0993bfb530b93119978-a2194.png 750w" data-sizes="(max-width: 750px) 100vw, 750px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h1 id="总结"><a href="#%E6%80%BB%E7%BB%93" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h1>\n<ol>\n<li>传递到新窗口的 url 过长需要编码</li>\n<li>独立运行环境部分的 react 冲突可能是作用域提升导致的冲突，待具体研究</li>\n<li>babel-polyfill 引入 2 次，如何复用 ployfill 的代码待研究</li>\n</ol>',
id:"/home/runner/work/GatsbyBlog/GatsbyBlog/blog/客服新窗口技术探索/index.md absPath of file >>> MarkdownRemark",timeToRead:7,frontmatter:{date:"2020-07-01 20:15:50",path:"/new-window-technology-research/",tags:"前端, 跨域通信, webpack, 预研",title:"客服新窗口技术探索",draft:null}},{excerpt:"需求背景 由于每个周末放假前都要给出代码量的统计，如果是手动统计的话需要到各个开发过的项目下运行相应的脚本，太过繁琐。故写出以下第一版统计代码量的脚本 代码展示 以下是统计 G:/project/tungee/ 目录下的代码量，其中标红部分需要修改为自己的项目路径和 git 邮箱 第一版 按项目统计 运行效果 以上更新于 第二版 增加按日期统计和 shell 参数输入 运行效果 第三版 增加按分支统计的功能，去掉 shell…",html:'<h1 id="需求背景"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h1>\n<p>由于每个周末放假前都要给出代码量的统计，如果是手动统计的话需要到各个开发过的项目下运行相应的脚本，太过繁琐。故写出以下第一版统计代码量的脚本</p>\n<h1 id="代码展示"><a href="#%E4%BB%A3%E7%A0%81%E5%B1%95%E7%A4%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>代码展示</h1>\n<p>以下是统计 G:/project/tungee/ 目录下的代码量，其中标红部分需要修改为自己的项目路径和 git 邮箱</p>\n<h2 id="第一版"><a href="#%E7%AC%AC%E4%B8%80%E7%89%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第一版</h2>\n<h3 id="按项目统计"><a href="#%E6%8C%89%E9%A1%B9%E7%9B%AE%E7%BB%9F%E8%AE%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>按项目统计</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="56615819323280040000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`#!/bin/sh\n# 能够检测一些错误，并在错误发生时中断程序并输出信息\n# 使用 set -e 令脚本在发生错误时退出而不是继续运行；使用 set -u 来检查是否使用了未赋值的变量；试试 set -o pipefail，它可以监测管道中的错误。\nset -euo pipefail\ntrap &quot;echo \'error: Script failed: see failed command above\'&quot; ERR\n# {} 防止下载不完全代码被执行\n{\n  function to_array(){\n    x=\\$1\n    OLD_IFS=&quot;\\$IFS&quot;\n    IFS=&quot;,&quot;\n    array=(\\$x)\n    IFS=&quot;\\$OLD_IFS&quot;\n    for each in \\${array[*]}\n    do\n    echo \\$each\n    done\n  }\n  echo &quot;输入项目名，以英文逗号分隔，不能有空格&quot;\n  read input\n  files=(\\$(to_array \\$input))\n  echo -e &quot;\\n&quot;\n  for file in \\${files[@]}\n  do\n    if [ ! -d &quot;G:/project/tungee/\\$file&quot; ]; then\n      echo -e &quot;\\$file 目录不存在。&quot;\n      continue;\n    fi\n    if [ ! -d &quot;G:/project/tungee/\\$file/.git&quot; ]; then\n      echo -e &quot;\\$file 不是git仓库。&quot;\n      continue;\n    fi\n    cd &quot;G:/project/tungee/\\$file&quot;\n    echo &quot;\\$file 代码量统计：&quot;\n    i=\\`date +%w\\`\n    while [ \\$i -ge 1 ]\n    do\n      sinceDate=\\`date -d &quot;-\\$i day&quot; +%Y-%m-%d\\`\n      untilDate=\\`date -d &quot;-\\$((\\$i-1)) day&quot; +%Y-%m-%d\\`\n      git log --author=&quot;634407147@qq.com&quot; --since=\\$sinceDate --until=\\$untilDate --pretty=tformat: --numstat | gawk \'{ add += \\$1 ; subs += \\$2 ; loc += \\$1 - \\$2 } END { printf &quot;\'\\$untilDate\' 增加行总数：%s，删除行总数：%s，总代码行：%s\\n&quot;, add, subs, loc }\'\n      i=\\$((\\$i-1))\n    done\n    echo -e &quot;\\n&quot;\n  done\n}`, `56615819323280040000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash{25,29,33,40}"\n              >\n                <span class="gatsby-code-button-language">bash{25,29,33,40}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token shebang important">#!/bin/sh</span>\n<span class="token comment"># 能够检测一些错误，并在错误发生时中断程序并输出信息</span>\n<span class="token comment"># 使用 set -e 令脚本在发生错误时退出而不是继续运行；使用 set -u 来检查是否使用了未赋值的变量；试试 set -o pipefail，它可以监测管道中的错误。</span>\n<span class="token builtin class-name">set</span> -euo pipefail\n<span class="token builtin class-name">trap</span> <span class="token string">"echo \'error: Script failed: see failed command above\'"</span> ERR\n<span class="token comment"># {} 防止下载不完全代码被执行</span>\n<span class="token punctuation">{</span>\n  <span class="token keyword">function</span> <span class="token function-name function">to_array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>\n    <span class="token assign-left variable">x</span><span class="token operator">=</span><span class="token variable">$1</span>\n    <span class="token assign-left variable">OLD_IFS</span><span class="token operator">=</span><span class="token string">"<span class="token environment constant">$IFS</span>"</span>\n    <span class="token assign-left variable"><span class="token environment constant">IFS</span></span><span class="token operator">=</span><span class="token string">","</span>\n    <span class="token assign-left variable">array</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token variable">$x</span><span class="token punctuation">)</span>\n    <span class="token assign-left variable"><span class="token environment constant">IFS</span></span><span class="token operator">=</span><span class="token string">"<span class="token variable">$OLD_IFS</span>"</span>\n    <span class="token keyword">for</span> <span class="token for-or-select variable">each</span> <span class="token keyword">in</span> <span class="token variable">${array<span class="token punctuation">[</span>*<span class="token punctuation">]</span>}</span>\n    <span class="token keyword">do</span>\n    <span class="token builtin class-name">echo</span> <span class="token variable">$each</span>\n    <span class="token keyword">done</span>\n  <span class="token punctuation">}</span>\n  <span class="token builtin class-name">echo</span> <span class="token string">"输入项目名，以英文逗号分隔，不能有空格"</span>\n  <span class="token builtin class-name">read</span> input\n  <span class="token assign-left variable">files</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token variable"><span class="token variable">$(</span>to_array $input<span class="token variable">)</span></span><span class="token punctuation">)</span>\n  <span class="token builtin class-name">echo</span> -e <span class="token string">"<span class="token entity" title="\\n">\\n</span>"</span>\n  <span class="token keyword">for</span> <span class="token for-or-select variable">file</span> <span class="token keyword">in</span> <span class="token variable">${files<span class="token punctuation">[</span>@<span class="token punctuation">]</span>}</span>\n  <span class="token keyword">do</span>\n<span class="gatsby-highlight-code-line">    <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">!</span> -d <span class="token string">"G:/project/tungee/<span class="token variable">$file</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span></span>      <span class="token builtin class-name">echo</span> -e <span class="token string">"<span class="token variable">$file</span> 目录不存在。"</span>\n      <span class="token builtin class-name">continue</span><span class="token punctuation">;</span>\n    <span class="token keyword">fi</span>\n<span class="gatsby-highlight-code-line">    <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">!</span> -d <span class="token string">"G:/project/tungee/<span class="token variable">$file</span>/.git"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span></span>      <span class="token builtin class-name">echo</span> -e <span class="token string">"<span class="token variable">$file</span> 不是git仓库。"</span>\n      <span class="token builtin class-name">continue</span><span class="token punctuation">;</span>\n    <span class="token keyword">fi</span>\n<span class="gatsby-highlight-code-line">    <span class="token builtin class-name">cd</span> <span class="token string">"G:/project/tungee/<span class="token variable">$file</span>"</span></span>    <span class="token builtin class-name">echo</span> <span class="token string">"<span class="token variable">$file</span> 代码量统计："</span>\n    <span class="token assign-left variable">i</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">date</span> +%w<span class="token variable">`</span></span>\n    <span class="token keyword">while</span> <span class="token punctuation">[</span> <span class="token variable">$i</span> -ge <span class="token number">1</span> <span class="token punctuation">]</span>\n    <span class="token keyword">do</span>\n      <span class="token assign-left variable">sinceDate</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">date</span> -d <span class="token string">"-<span class="token variable">$i</span> day"</span> +%Y-%m-%d<span class="token variable">`</span></span>\n      <span class="token assign-left variable">untilDate</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">date</span> -d <span class="token string">"-<span class="token variable"><span class="token variable">$((</span>$i<span class="token operator">-</span><span class="token number">1</span><span class="token variable">))</span></span> day"</span> +%Y-%m-%d<span class="token variable">`</span></span>\n<span class="gatsby-highlight-code-line">      <span class="token function">git</span> log --author<span class="token operator">=</span><span class="token string">"634407147@qq.com"</span> --since<span class="token operator">=</span><span class="token variable">$sinceDate</span> --until<span class="token operator">=</span><span class="token variable">$untilDate</span> --pretty<span class="token operator">=</span>tformat: --numstat <span class="token operator">|</span> <span class="token function">gawk</span> <span class="token string">\'{ add += <span class="token variable">$1</span> ; subs += <span class="token variable">$2</span> ; loc += <span class="token variable">$1</span> - <span class="token variable">$2</span> } END { printf "\'</span><span class="token variable">$untilDate</span><span class="token string">\' 增加行总数：%s，删除行总数：%s，总代码行：%s<span class="token entity" title="\\n">\\n</span>", add, subs, loc }\'</span></span>      <span class="token assign-left variable">i</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$((</span>$i<span class="token operator">-</span><span class="token number">1</span><span class="token variable">))</span></span>\n    <span class="token keyword">done</span>\n    <span class="token builtin class-name">echo</span> -e <span class="token string">"<span class="token entity" title="\\n">\\n</span>"</span>\n  <span class="token keyword">done</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="运行效果"><a href="#%E8%BF%90%E8%A1%8C%E6%95%88%E6%9E%9C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>运行效果</h3>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2019-05-22-22-18-59-7b23c5da6b5c37ccfc10c0e8456e4915-d5813.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 443px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 68.62302483069978%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAIAAACgpqunAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABq0lEQVQoz5WS647bIBCFiQ34khobbIPBxJf4nsSVmo227/9mnTjVatNmpXZ+IBg4o28Ogxzr0COlledrD3GEMrR39hbZGCXhN6QU4hztduh1TN3UN8MyLaYwRmlrrK1sYYtYJEpC6qB1San3WixlluZZnudxHKdCpGmWQSLPH5sgCHzfdxxnt8ULPWQf167rEkq/pvwruq5tj8e6ro3Ryzxfrz+6rqeEAAWwCCE86hGCk4RzwR3Xfe55mpqm0UXRd926rvM8T/NECX57u47TdLvd7qIkPp8v6/rdD4InMec8ihg0liQJtAqNggHAXxQKrrTW0HYYBmkKKAJj/CQGJEyw5/kg+NLVD3f+OJemrKsDIJ1PC/Cj/4r22JZl2Tb1z/f3fhhYzIDTdTGlhDEWhnsIoIUj5MFC+A5CyO9vG8exqmolFegvl8tm2ByG4Tj0y+kELh0OFReibdu+H7TRUG6rvtmulAKPYsbAK2sBwhRaR1EEE2JLawxkyogxKe9TpJSEx+A5QN3FGLswIBvYJ55/jDRLoQx8iZQSVt8PHjP3WD+m8nNm29y1vwBcbSf6ZBrDjAAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2019 05 22 22 18 59" title="" data-src="/static/2019-05-22-22-18-59-7b23c5da6b5c37ccfc10c0e8456e4915-d5813.png" data-srcset="/static/2019-05-22-22-18-59-7b23c5da6b5c37ccfc10c0e8456e4915-bf07a.png 200w,\n/static/2019-05-22-22-18-59-7b23c5da6b5c37ccfc10c0e8456e4915-250cd.png 400w,\n/static/2019-05-22-22-18-59-7b23c5da6b5c37ccfc10c0e8456e4915-d5813.png 443w" data-sizes="(max-width: 443px) 100vw, 443px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>以上更新于<code class="language-text">2019-5-22 22:17:24</code></p>\n<hr>\n<h2 id="第二版"><a href="#%E7%AC%AC%E4%BA%8C%E7%89%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第二版</h2>\n<h3 id="增加按日期统计和-shell-参数输入"><a href="#%E5%A2%9E%E5%8A%A0%E6%8C%89%E6%97%A5%E6%9C%9F%E7%BB%9F%E8%AE%A1%E5%92%8C-shell-%E5%8F%82%E6%95%B0%E8%BE%93%E5%85%A5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>增加按日期统计和 shell 参数输入</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="68738425247985390000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`#!/bin/sh\n# 周一到今天的代码量统计，使用方式：./git.bash mockingbird robin koala 或 执行 ./git.bash 后自行输入\n# 能够检测一些错误，并在错误发生时中断程序并输出信息\n# 使用 set -e 令脚本在发生错误时退出而不是继续运行；使用 set -u 来检查是否使用了未赋值的变量；试试 set -o pipefail，它可以监测管道中的错误。\nset -euo pipefail\ntrap &quot;echo \'error: Script failed: see failed command above\'&quot; ERR\n# {} 防止下载不完全代码被执行\n{\n  function to_array() {\n    x=\\$1\n    OLD_IFS=&quot;\\$IFS&quot;\n    IFS=&quot;,&quot;\n    array=(\\$x)\n    IFS=&quot;\\$OLD_IFS&quot;\n    for each in \\${array[*]}\n    do\n    echo \\$each\n    done\n  }\n\n  file_path=&quot;G:/project/tungee&quot;\n  git_email=&quot;634407147@qq.com&quot;\n  date_stat=&quot;date +%w&quot; # 今天是一周的第几天，可换成具体数字 date_stat=&quot;echo 5&quot; 以实现统计几天前代码的功能\n\n  if [ \\$# -lt 1 ]; then\n    echo &quot;输入项目名，以英文逗号分隔，不能有空格&quot;\n    read input\n    files=(\\$(to_array \\$input))\n  else\n    files=\\$*\n  fi\n\n  echo -e &quot;按日期统计：&quot;\n  i=\\$(\\$date_stat)\n  while [ \\$i -ge 1 ]\n  do\n    add_sum=0\n    subs_sum=0\n    loc_sum=0\n    for file in \\${files[@]}\n    do\n      if [ ! -d &quot;\\$file_path/\\$file&quot; ]; then\n        echo -e &quot;\\$file 目录不存在。&quot;\n        continue;\n      fi\n      if [ ! -d &quot;\\$file_path/\\$file/.git&quot; ]; then\n        echo -e &quot;\\$file 不是git仓库。&quot;\n        continue;\n      fi\n      cd &quot;\\$file_path/\\$file&quot;\n      since_date=\\`date -d &quot;-\\$i day&quot; +%Y-%m-%d\\`\n      until_date=\\`date -d &quot;-\\$((\\$i-1)) day&quot; +%Y-%m-%d\\`\n      eval \\$(git log --author=\\$git_email --since=\\$since_date --until=\\$until_date --pretty=tformat: --numstat | awk -v add=0 -v subs=0 -v loc=0 \'{ add += \\$1 ; subs += \\$2 ; loc += \\$1 - \\$2 } END { printf &quot;add=%s; subs=%s; loc=%s;&quot;, add, subs, loc }\')\n      add_sum=\\$((\\$add_sum + \\$add))\n      subs_sum=\\$((\\$subs_sum + \\$subs))\n      loc_sum=\\$((\\$loc_sum + \\$loc))\n    done\n    printf &quot;\\$until_date 增加行总数：\\$add_sum，删除行总数：\\$subs_sum，总代码行：\\$loc_sum\\n&quot;\n    i=\\$((\\$i-1))\n  done\n\n  echo -e &quot;\\n按项目统计：&quot;\n  for file in \\${files[@]}\n  do\n    if [ ! -d &quot;\\$file_path/\\$file&quot; ]; then\n      echo -e &quot;\\$file 目录不存在。&quot;\n      continue;\n    fi\n    if [ ! -d &quot;\\$file_path/\\$file/.git&quot; ]; then\n      echo -e &quot;\\$file 不是git仓库。&quot;\n      continue;\n    fi\n    cd &quot;\\$file_path/\\$file&quot;\n    echo &quot;\\$file 代码量统计：&quot;\n    i=\\$(\\$date_stat)\n    while [ \\$i -ge 1 ]\n    do\n      since_date=\\`date -d &quot;-\\$i day&quot; +%Y-%m-%d\\`\n      until_date=\\`date -d &quot;-\\$((\\$i-1)) day&quot; +%Y-%m-%d\\`\n      git log --author=\\$git_email --since=\\$since_date --until=\\$until_date --pretty=tformat: --numstat | awk -v add=0 -v subs=0 -v loc=0 \'{ add += \\$1 ; subs += \\$2 ; loc += \\$1 - \\$2 } END { printf &quot;\'\\$until_date\' 增加行总数：%s，删除行总数：%s，总代码行：%s\\n&quot;, add, subs, loc }\'\n      i=\\$((\\$i-1))\n    done\n  done\n}`, `68738425247985390000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash{21-22}"\n              >\n                <span class="gatsby-code-button-language">bash{21-22}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token shebang important">#!/bin/sh</span>\n<span class="token comment"># 周一到今天的代码量统计，使用方式：./git.bash mockingbird robin koala 或 执行 ./git.bash 后自行输入</span>\n<span class="token comment"># 能够检测一些错误，并在错误发生时中断程序并输出信息</span>\n<span class="token comment"># 使用 set -e 令脚本在发生错误时退出而不是继续运行；使用 set -u 来检查是否使用了未赋值的变量；试试 set -o pipefail，它可以监测管道中的错误。</span>\n<span class="token builtin class-name">set</span> -euo pipefail\n<span class="token builtin class-name">trap</span> <span class="token string">"echo \'error: Script failed: see failed command above\'"</span> ERR\n<span class="token comment"># {} 防止下载不完全代码被执行</span>\n<span class="token punctuation">{</span>\n  <span class="token keyword">function</span> <span class="token function-name function">to_array</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token assign-left variable">x</span><span class="token operator">=</span><span class="token variable">$1</span>\n    <span class="token assign-left variable">OLD_IFS</span><span class="token operator">=</span><span class="token string">"<span class="token environment constant">$IFS</span>"</span>\n    <span class="token assign-left variable"><span class="token environment constant">IFS</span></span><span class="token operator">=</span><span class="token string">","</span>\n    <span class="token assign-left variable">array</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token variable">$x</span><span class="token punctuation">)</span>\n    <span class="token assign-left variable"><span class="token environment constant">IFS</span></span><span class="token operator">=</span><span class="token string">"<span class="token variable">$OLD_IFS</span>"</span>\n    <span class="token keyword">for</span> <span class="token for-or-select variable">each</span> <span class="token keyword">in</span> <span class="token variable">${array<span class="token punctuation">[</span>*<span class="token punctuation">]</span>}</span>\n    <span class="token keyword">do</span>\n    <span class="token builtin class-name">echo</span> <span class="token variable">$each</span>\n    <span class="token keyword">done</span>\n  <span class="token punctuation">}</span>\n\n<span class="gatsby-highlight-code-line">  <span class="token assign-left variable">file_path</span><span class="token operator">=</span><span class="token string">"G:/project/tungee"</span></span><span class="gatsby-highlight-code-line">  <span class="token assign-left variable">git_email</span><span class="token operator">=</span><span class="token string">"634407147@qq.com"</span></span>  <span class="token assign-left variable">date_stat</span><span class="token operator">=</span><span class="token string">"date +%w"</span> <span class="token comment"># 今天是一周的第几天，可换成具体数字 date_stat="echo 5" 以实现统计几天前代码的功能</span>\n\n  <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$#</span> -lt <span class="token number">1</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>\n    <span class="token builtin class-name">echo</span> <span class="token string">"输入项目名，以英文逗号分隔，不能有空格"</span>\n    <span class="token builtin class-name">read</span> input\n    <span class="token assign-left variable">files</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token variable"><span class="token variable">$(</span>to_array $input<span class="token variable">)</span></span><span class="token punctuation">)</span>\n  <span class="token keyword">else</span>\n    <span class="token assign-left variable">files</span><span class="token operator">=</span><span class="token variable">$*</span>\n  <span class="token keyword">fi</span>\n\n  <span class="token builtin class-name">echo</span> -e <span class="token string">"按日期统计："</span>\n  <span class="token assign-left variable">i</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>$date_stat<span class="token variable">)</span></span>\n  <span class="token keyword">while</span> <span class="token punctuation">[</span> <span class="token variable">$i</span> -ge <span class="token number">1</span> <span class="token punctuation">]</span>\n  <span class="token keyword">do</span>\n    <span class="token assign-left variable">add_sum</span><span class="token operator">=</span><span class="token number">0</span>\n    <span class="token assign-left variable">subs_sum</span><span class="token operator">=</span><span class="token number">0</span>\n    <span class="token assign-left variable">loc_sum</span><span class="token operator">=</span><span class="token number">0</span>\n    <span class="token keyword">for</span> <span class="token for-or-select variable">file</span> <span class="token keyword">in</span> <span class="token variable">${files<span class="token punctuation">[</span>@<span class="token punctuation">]</span>}</span>\n    <span class="token keyword">do</span>\n      <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">!</span> -d <span class="token string">"<span class="token variable">$file_path</span>/<span class="token variable">$file</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>\n        <span class="token builtin class-name">echo</span> -e <span class="token string">"<span class="token variable">$file</span> 目录不存在。"</span>\n        <span class="token builtin class-name">continue</span><span class="token punctuation">;</span>\n      <span class="token keyword">fi</span>\n      <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">!</span> -d <span class="token string">"<span class="token variable">$file_path</span>/<span class="token variable">$file</span>/.git"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>\n        <span class="token builtin class-name">echo</span> -e <span class="token string">"<span class="token variable">$file</span> 不是git仓库。"</span>\n        <span class="token builtin class-name">continue</span><span class="token punctuation">;</span>\n      <span class="token keyword">fi</span>\n      <span class="token builtin class-name">cd</span> <span class="token string">"<span class="token variable">$file_path</span>/<span class="token variable">$file</span>"</span>\n      <span class="token assign-left variable">since_date</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">date</span> -d <span class="token string">"-<span class="token variable">$i</span> day"</span> +%Y-%m-%d<span class="token variable">`</span></span>\n      <span class="token assign-left variable">until_date</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">date</span> -d <span class="token string">"-<span class="token variable"><span class="token variable">$((</span>$i<span class="token operator">-</span><span class="token number">1</span><span class="token variable">))</span></span> day"</span> +%Y-%m-%d<span class="token variable">`</span></span>\n      <span class="token builtin class-name">eval</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">git</span> log --author<span class="token operator">=</span>$git_email --since<span class="token operator">=</span>$since_date --until<span class="token operator">=</span>$until_date --pretty<span class="token operator">=</span>tformat: --numstat <span class="token operator">|</span> <span class="token function">awk</span> -v <span class="token assign-left variable">add</span><span class="token operator">=</span><span class="token number">0</span> -v <span class="token assign-left variable">subs</span><span class="token operator">=</span><span class="token number">0</span> -v <span class="token assign-left variable">loc</span><span class="token operator">=</span><span class="token number">0</span> <span class="token string">\'{ add += <span class="token variable">$1</span> ; subs += <span class="token variable">$2</span> ; loc += <span class="token variable">$1</span> - <span class="token variable">$2</span> } END { printf "add=%s; subs=%s; loc=%s;", add, subs, loc }\'</span><span class="token variable">)</span></span>\n      <span class="token assign-left variable">add_sum</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$((</span>$add_sum <span class="token operator">+</span> $add<span class="token variable">))</span></span>\n      <span class="token assign-left variable">subs_sum</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$((</span>$subs_sum <span class="token operator">+</span> $subs<span class="token variable">))</span></span>\n      <span class="token assign-left variable">loc_sum</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$((</span>$loc_sum <span class="token operator">+</span> $loc<span class="token variable">))</span></span>\n    <span class="token keyword">done</span>\n    <span class="token builtin class-name">printf</span> <span class="token string">"<span class="token variable">$until_date</span> 增加行总数：<span class="token variable">$add_sum</span>，删除行总数：<span class="token variable">$subs_sum</span>，总代码行：<span class="token variable">$loc_sum</span><span class="token entity" title="\\n">\\n</span>"</span>\n    <span class="token assign-left variable">i</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$((</span>$i<span class="token operator">-</span><span class="token number">1</span><span class="token variable">))</span></span>\n  <span class="token keyword">done</span>\n\n  <span class="token builtin class-name">echo</span> -e <span class="token string">"<span class="token entity" title="\\n">\\n</span>按项目统计："</span>\n  <span class="token keyword">for</span> <span class="token for-or-select variable">file</span> <span class="token keyword">in</span> <span class="token variable">${files<span class="token punctuation">[</span>@<span class="token punctuation">]</span>}</span>\n  <span class="token keyword">do</span>\n    <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">!</span> -d <span class="token string">"<span class="token variable">$file_path</span>/<span class="token variable">$file</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>\n      <span class="token builtin class-name">echo</span> -e <span class="token string">"<span class="token variable">$file</span> 目录不存在。"</span>\n      <span class="token builtin class-name">continue</span><span class="token punctuation">;</span>\n    <span class="token keyword">fi</span>\n    <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">!</span> -d <span class="token string">"<span class="token variable">$file_path</span>/<span class="token variable">$file</span>/.git"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>\n      <span class="token builtin class-name">echo</span> -e <span class="token string">"<span class="token variable">$file</span> 不是git仓库。"</span>\n      <span class="token builtin class-name">continue</span><span class="token punctuation">;</span>\n    <span class="token keyword">fi</span>\n    <span class="token builtin class-name">cd</span> <span class="token string">"<span class="token variable">$file_path</span>/<span class="token variable">$file</span>"</span>\n    <span class="token builtin class-name">echo</span> <span class="token string">"<span class="token variable">$file</span> 代码量统计："</span>\n    <span class="token assign-left variable">i</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>$date_stat<span class="token variable">)</span></span>\n    <span class="token keyword">while</span> <span class="token punctuation">[</span> <span class="token variable">$i</span> -ge <span class="token number">1</span> <span class="token punctuation">]</span>\n    <span class="token keyword">do</span>\n      <span class="token assign-left variable">since_date</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">date</span> -d <span class="token string">"-<span class="token variable">$i</span> day"</span> +%Y-%m-%d<span class="token variable">`</span></span>\n      <span class="token assign-left variable">until_date</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">date</span> -d <span class="token string">"-<span class="token variable"><span class="token variable">$((</span>$i<span class="token operator">-</span><span class="token number">1</span><span class="token variable">))</span></span> day"</span> +%Y-%m-%d<span class="token variable">`</span></span>\n      <span class="token function">git</span> log --author<span class="token operator">=</span><span class="token variable">$git_email</span> --since<span class="token operator">=</span><span class="token variable">$since_date</span> --until<span class="token operator">=</span><span class="token variable">$until_date</span> --pretty<span class="token operator">=</span>tformat: --numstat <span class="token operator">|</span> <span class="token function">awk</span> -v <span class="token assign-left variable">add</span><span class="token operator">=</span><span class="token number">0</span> -v <span class="token assign-left variable">subs</span><span class="token operator">=</span><span class="token number">0</span> -v <span class="token assign-left variable">loc</span><span class="token operator">=</span><span class="token number">0</span> <span class="token string">\'{ add += <span class="token variable">$1</span> ; subs += <span class="token variable">$2</span> ; loc += <span class="token variable">$1</span> - <span class="token variable">$2</span> } END { printf "\'</span><span class="token variable">$until_date</span><span class="token string">\' 增加行总数：%s，删除行总数：%s，总代码行：%s<span class="token entity" title="\\n">\\n</span>", add, subs, loc }\'</span>\n      <span class="token assign-left variable">i</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$((</span>$i<span class="token operator">-</span><span class="token number">1</span><span class="token variable">))</span></span>\n    <span class="token keyword">done</span>\n  <span class="token keyword">done</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="运行效果-1"><a href="#%E8%BF%90%E8%A1%8C%E6%95%88%E6%9E%9C-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>运行效果</h3>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2019-05-27-17-41-19-7891bb91d13645249dcfef1fe14463ca-5032e.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 438px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 92.46575342465754%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAIAAADUsmlHAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACrElEQVQ4y3VT13KjMBR1sClGoohmRBUSotvOTv7/3/bITrJPe2eY4SLdcgqnpq2VVnrRSZHSgLCMJUkaB3EUREFIGQuD4Ho6nT4+rNMrLMtCgjDJpKdRqaZum6oexNA0bVVVPqFRFCol67oVYojimMWsKHIpZVmWNAiI75viYRjqqsqzfBD9vu/TNI2jjhkrsuw4dq3HfdvjJCnLW9u24zjicoCVKDHFWk8YWFW1VvL5fGzbNs0zJqHX5+fnuqzrukVRVFd8nqd5WbI0o5Tatm2KcRAAlnf1fYIXQnycOY7r+1fMxyl2dhzH81xsi5m2jXfvjf8kRA8kGE4oxdcsy3zgefPx//ghbJoBu+/7oe/ux/H19YU9CSG8LEFVXdclr1zXzdJUSpUXBd6t39bDIJu6LvJCCrEsixpHXIpZ0nXd/X7M84xeYRC2bSOEkEoVRQGM6G6KlVKgschvou/2fZvnBfdfhAkUY69l3QC1bRo0EoOEZi4ocd03Zgn20fjP87luGxozxsAQYzH0S2EYxmz7AtnTNA3C0LGdj9+1DbDKhJm4rl3XcygZhsYkUjZNA0bCKI7CKE0S8Mo5xyl9rw3du7a93W4Q9tj32cQCTbDn4/mYpwlrQ7ya8+O490IAguPY35OBuWub260E28Yh2jgM2hrDHTCcHvWEXlXF9TQNUlIKU/zo3MNenIMz+GlZ1izPsbLreZT40JyZSAw/rhvHUZIkOHJ/i1+TW9h9ho33HTghHiEUUoEFJP0gPe8KwYGH88q/Xi3rhzDYC/BAct+1IExrrdTIkhR7btsKCOu6QDle8qapcQTCIDJY+Cas7wU+qUEch3EFsIVhiJn3+x0/GVLiE1Tux2EIo8H5fP5W63K5mMSyLueLa8CZB3+8Y8J95/DjK3X+lb3iLxdnWiZOBA7KAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2019 05 27 17 41 19" title="" data-src="/static/2019-05-27-17-41-19-7891bb91d13645249dcfef1fe14463ca-5032e.png" data-srcset="/static/2019-05-27-17-41-19-7891bb91d13645249dcfef1fe14463ca-86481.png 200w,\n/static/2019-05-27-17-41-19-7891bb91d13645249dcfef1fe14463ca-1ca59.png 400w,\n/static/2019-05-27-17-41-19-7891bb91d13645249dcfef1fe14463ca-5032e.png 438w" data-sizes="(max-width: 438px) 100vw, 438px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h2 id="第三版"><a href="#%E7%AC%AC%E4%B8%89%E7%89%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第三版</h2>\n<h3 id="增加按分支统计的功能，去掉-shell-参数输入（暂时不支持）"><a href="#%E5%A2%9E%E5%8A%A0%E6%8C%89%E5%88%86%E6%94%AF%E7%BB%9F%E8%AE%A1%E7%9A%84%E5%8A%9F%E8%83%BD%EF%BC%8C%E5%8E%BB%E6%8E%89-shell-%E5%8F%82%E6%95%B0%E8%BE%93%E5%85%A5%EF%BC%88%E6%9A%82%E6%97%B6%E4%B8%8D%E6%94%AF%E6%8C%81%EF%BC%89" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>增加按分支统计的功能，去掉 shell 参数输入（暂时不支持）</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="61228245667123530000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`#!/bin/sh\n# 周一到今天的代码量统计，使用方式：./git.bash mockingbird robin koala 或 执行 ./git.bash 后自行输入\n# 能够检测一些错误，并在错误发生时中断程序并输出信息\n# 使用 set -e 令脚本在发生错误时退出而不是继续运行；使用 set -u 来检查是否使用了未赋值的变量；试试 set -o pipefail，它可以监测管道中的错误。\n# set -euo pipefail\n# trap &quot;echo \'error: Script failed: see failed command above\'&quot; ERR\n# {} 防止下载不完全代码被执行\n{\n  function to_array() {\n    x=\\$1\n    OLD_IFS=&quot;\\$IFS&quot;\n    IFS=&quot;,&quot;\n    array=(\\$x)\n    IFS=&quot;\\$OLD_IFS&quot;\n    for each in \\${array[*]}\n    do\n    echo \\$each\n    done\n  }\n\n  file_path=&quot;G:/project/tungee&quot;\n  git_email=&quot;634407147@qq.com&quot;\n  date_stat=&quot;date +%w&quot; # 今天是一周的第几天，可换成具体数字如 date_stat=&quot;echo 5&quot; 以实现统计几天前代码的功能\n\n  echo &quot;输入项目名，以英文逗号分隔，不能有空格&quot;\n  read input\n  projects=(\\$(to_array \\$input))\n  echo &quot;输入分支名，以英文逗号分隔，不能有空格&quot;\n  read input\n  branches=(\\$(to_array \\$input))\n\n  for branch in \\${branches[@]}\n  do\n    exist_branch_projects=()\n    for file in \\${projects[@]}\n    do\n      if [ ! -d &quot;\\$file_path/\\$file&quot; ]; then\n        echo -e &quot;\\$file 目录不存在。&quot;\n        continue;\n      fi\n      if [ ! -d &quot;\\$file_path/\\$file/.git&quot; ]; then\n        echo -e &quot;\\$file 不是git仓库。&quot;\n        continue;\n      fi\n      cd &quot;\\$file_path/\\$file&quot;\n      git checkout \\$branch -q >/dev/null 2>&1 # 重定向错误信息，即屏蔽错误信息\n      if [ \\$? -ne 0 ]; then\n        echo -e &quot;\\n\\$file 切换分支到 \\$branch 失败，可能不存在此分支&quot;\n      else\n        exist_branch_projects+=(\\$file)\n        git pull origin \\$branch -q\n      fi\n    done\n    echo -e &quot;\\n分支 \\$branch 上的代码统计：&quot;\n    {\n      echo -e &quot;按日期统计：&quot;\n      i=\\$(\\$date_stat)\n      while [ \\$i -ge 1 ]\n      do\n        add_sum=0\n        subs_sum=0\n        loc_sum=0\n        for file in \\${exist_branch_projects[@]}\n        do\n          if [ ! -d &quot;\\$file_path/\\$file&quot; ]; then\n            echo -e &quot;\\$file 目录不存在。&quot;\n            continue;\n          fi\n          if [ ! -d &quot;\\$file_path/\\$file/.git&quot; ]; then\n            echo -e &quot;\\$file 不是git仓库。&quot;\n            continue;\n          fi\n          cd &quot;\\$file_path/\\$file&quot;\n          # git checkout master\n          since_date=\\`date -d &quot;-\\$i day&quot; +%Y-%m-%d\\`\n          until_date=\\`date -d &quot;-\\$((\\$i-1)) day&quot; +%Y-%m-%d\\`\n          eval \\$(git log --author=\\$git_email --since=\\$since_date --until=\\$until_date --pretty=tformat: --numstat | awk -v add=0 -v subs=0 -v loc=0 \'{ add += \\$1 ; subs += \\$2 ; loc += \\$1 - \\$2 } END { printf &quot;add=%s; subs=%s; loc=%s;&quot;, add, subs, loc }\')\n          add_sum=\\$((\\$add_sum + \\$add))\n          subs_sum=\\$((\\$subs_sum + \\$subs))\n          loc_sum=\\$((\\$loc_sum + \\$loc))\n        done\n        printf &quot;\\$until_date 增加行总数：\\$add_sum，删除行总数：\\$subs_sum，总代码行：\\$loc_sum\\n&quot;\n        i=\\$((\\$i-1))\n      done\n\n      echo -e &quot;按项目统计：&quot;\n      for file in \\${exist_branch_projects[@]}\n      do\n        if [ ! -d &quot;\\$file_path/\\$file&quot; ]; then\n          echo -e &quot;\\$file 目录不存在。&quot;\n          continue;\n        fi\n        if [ ! -d &quot;\\$file_path/\\$file/.git&quot; ]; then\n          echo -e &quot;\\$file 不是git仓库。&quot;\n          continue;\n        fi\n        cd &quot;\\$file_path/\\$file&quot;\n        # git checkout master\n        echo &quot;\\$file 代码量统计：&quot;\n        i=\\$(\\$date_stat)\n        while [ \\$i -ge 1 ]\n        do\n          since_date=\\`date -d &quot;-\\$i day&quot; +%Y-%m-%d\\`\n          until_date=\\`date -d &quot;-\\$((\\$i-1)) day&quot; +%Y-%m-%d\\`\n          git log --author=\\$git_email --since=\\$since_date --until=\\$until_date --pretty=tformat: --numstat | awk -v add=0 -v subs=0 -v loc=0 \'{ add += \\$1 ; subs += \\$2 ; loc += \\$1 - \\$2 } END { printf &quot;\'\\$until_date\' 增加行总数：%s，删除行总数：%s，总代码行：%s\\n&quot;, add, subs, loc }\'\n          i=\\$((\\$i-1))\n        done\n      done\n    }\n  done\n}`, `61228245667123530000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token shebang important">#!/bin/sh</span>\n<span class="token comment"># 周一到今天的代码量统计，使用方式：./git.bash mockingbird robin koala 或 执行 ./git.bash 后自行输入</span>\n<span class="token comment"># 能够检测一些错误，并在错误发生时中断程序并输出信息</span>\n<span class="token comment"># 使用 set -e 令脚本在发生错误时退出而不是继续运行；使用 set -u 来检查是否使用了未赋值的变量；试试 set -o pipefail，它可以监测管道中的错误。</span>\n<span class="token comment"># set -euo pipefail</span>\n<span class="token comment"># trap "echo \'error: Script failed: see failed command above\'" ERR</span>\n<span class="token comment"># {} 防止下载不完全代码被执行</span>\n<span class="token punctuation">{</span>\n  <span class="token keyword">function</span> <span class="token function-name function">to_array</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token assign-left variable">x</span><span class="token operator">=</span><span class="token variable">$1</span>\n    <span class="token assign-left variable">OLD_IFS</span><span class="token operator">=</span><span class="token string">"<span class="token environment constant">$IFS</span>"</span>\n    <span class="token assign-left variable"><span class="token environment constant">IFS</span></span><span class="token operator">=</span><span class="token string">","</span>\n    <span class="token assign-left variable">array</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token variable">$x</span><span class="token punctuation">)</span>\n    <span class="token assign-left variable"><span class="token environment constant">IFS</span></span><span class="token operator">=</span><span class="token string">"<span class="token variable">$OLD_IFS</span>"</span>\n    <span class="token keyword">for</span> <span class="token for-or-select variable">each</span> <span class="token keyword">in</span> <span class="token variable">${array<span class="token punctuation">[</span>*<span class="token punctuation">]</span>}</span>\n    <span class="token keyword">do</span>\n    <span class="token builtin class-name">echo</span> <span class="token variable">$each</span>\n    <span class="token keyword">done</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token assign-left variable">file_path</span><span class="token operator">=</span><span class="token string">"G:/project/tungee"</span>\n  <span class="token assign-left variable">git_email</span><span class="token operator">=</span><span class="token string">"634407147@qq.com"</span>\n  <span class="token assign-left variable">date_stat</span><span class="token operator">=</span><span class="token string">"date +%w"</span> <span class="token comment"># 今天是一周的第几天，可换成具体数字如 date_stat="echo 5" 以实现统计几天前代码的功能</span>\n\n  <span class="token builtin class-name">echo</span> <span class="token string">"输入项目名，以英文逗号分隔，不能有空格"</span>\n  <span class="token builtin class-name">read</span> input\n  <span class="token assign-left variable">projects</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token variable"><span class="token variable">$(</span>to_array $input<span class="token variable">)</span></span><span class="token punctuation">)</span>\n  <span class="token builtin class-name">echo</span> <span class="token string">"输入分支名，以英文逗号分隔，不能有空格"</span>\n  <span class="token builtin class-name">read</span> input\n  <span class="token assign-left variable">branches</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token variable"><span class="token variable">$(</span>to_array $input<span class="token variable">)</span></span><span class="token punctuation">)</span>\n\n  <span class="token keyword">for</span> <span class="token for-or-select variable">branch</span> <span class="token keyword">in</span> <span class="token variable">${branches<span class="token punctuation">[</span>@<span class="token punctuation">]</span>}</span>\n  <span class="token keyword">do</span>\n    <span class="token assign-left variable">exist_branch_projects</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token keyword">for</span> <span class="token for-or-select variable">file</span> <span class="token keyword">in</span> <span class="token variable">${projects<span class="token punctuation">[</span>@<span class="token punctuation">]</span>}</span>\n    <span class="token keyword">do</span>\n      <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">!</span> -d <span class="token string">"<span class="token variable">$file_path</span>/<span class="token variable">$file</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>\n        <span class="token builtin class-name">echo</span> -e <span class="token string">"<span class="token variable">$file</span> 目录不存在。"</span>\n        <span class="token builtin class-name">continue</span><span class="token punctuation">;</span>\n      <span class="token keyword">fi</span>\n      <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">!</span> -d <span class="token string">"<span class="token variable">$file_path</span>/<span class="token variable">$file</span>/.git"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>\n        <span class="token builtin class-name">echo</span> -e <span class="token string">"<span class="token variable">$file</span> 不是git仓库。"</span>\n        <span class="token builtin class-name">continue</span><span class="token punctuation">;</span>\n      <span class="token keyword">fi</span>\n      <span class="token builtin class-name">cd</span> <span class="token string">"<span class="token variable">$file_path</span>/<span class="token variable">$file</span>"</span>\n      <span class="token function">git</span> checkout <span class="token variable">$branch</span> -q <span class="token operator">></span>/dev/null <span class="token operator"><span class="token file-descriptor important">2</span>></span><span class="token file-descriptor important">&amp;1</span> <span class="token comment"># 重定向错误信息，即屏蔽错误信息</span>\n      <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$?</span> -ne <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>\n        <span class="token builtin class-name">echo</span> -e <span class="token string">"<span class="token entity" title="\\n">\\n</span><span class="token variable">$file</span> 切换分支到 <span class="token variable">$branch</span> 失败，可能不存在此分支"</span>\n      <span class="token keyword">else</span>\n        <span class="token assign-left variable">exist_branch_projects</span><span class="token operator">+=</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span>\n        <span class="token function">git</span> pull origin <span class="token variable">$branch</span> -q\n      <span class="token keyword">fi</span>\n    <span class="token keyword">done</span>\n    <span class="token builtin class-name">echo</span> -e <span class="token string">"<span class="token entity" title="\\n">\\n</span>分支 <span class="token variable">$branch</span> 上的代码统计："</span>\n    <span class="token punctuation">{</span>\n      <span class="token builtin class-name">echo</span> -e <span class="token string">"按日期统计："</span>\n      <span class="token assign-left variable">i</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>$date_stat<span class="token variable">)</span></span>\n      <span class="token keyword">while</span> <span class="token punctuation">[</span> <span class="token variable">$i</span> -ge <span class="token number">1</span> <span class="token punctuation">]</span>\n      <span class="token keyword">do</span>\n        <span class="token assign-left variable">add_sum</span><span class="token operator">=</span><span class="token number">0</span>\n        <span class="token assign-left variable">subs_sum</span><span class="token operator">=</span><span class="token number">0</span>\n        <span class="token assign-left variable">loc_sum</span><span class="token operator">=</span><span class="token number">0</span>\n        <span class="token keyword">for</span> <span class="token for-or-select variable">file</span> <span class="token keyword">in</span> <span class="token variable">${exist_branch_projects<span class="token punctuation">[</span>@<span class="token punctuation">]</span>}</span>\n        <span class="token keyword">do</span>\n          <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">!</span> -d <span class="token string">"<span class="token variable">$file_path</span>/<span class="token variable">$file</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>\n            <span class="token builtin class-name">echo</span> -e <span class="token string">"<span class="token variable">$file</span> 目录不存在。"</span>\n            <span class="token builtin class-name">continue</span><span class="token punctuation">;</span>\n          <span class="token keyword">fi</span>\n          <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">!</span> -d <span class="token string">"<span class="token variable">$file_path</span>/<span class="token variable">$file</span>/.git"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>\n            <span class="token builtin class-name">echo</span> -e <span class="token string">"<span class="token variable">$file</span> 不是git仓库。"</span>\n            <span class="token builtin class-name">continue</span><span class="token punctuation">;</span>\n          <span class="token keyword">fi</span>\n          <span class="token builtin class-name">cd</span> <span class="token string">"<span class="token variable">$file_path</span>/<span class="token variable">$file</span>"</span>\n          <span class="token comment"># git checkout master</span>\n          <span class="token assign-left variable">since_date</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">date</span> -d <span class="token string">"-<span class="token variable">$i</span> day"</span> +%Y-%m-%d<span class="token variable">`</span></span>\n          <span class="token assign-left variable">until_date</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">date</span> -d <span class="token string">"-<span class="token variable"><span class="token variable">$((</span>$i<span class="token operator">-</span><span class="token number">1</span><span class="token variable">))</span></span> day"</span> +%Y-%m-%d<span class="token variable">`</span></span>\n          <span class="token builtin class-name">eval</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">git</span> log --author<span class="token operator">=</span>$git_email --since<span class="token operator">=</span>$since_date --until<span class="token operator">=</span>$until_date --pretty<span class="token operator">=</span>tformat: --numstat <span class="token operator">|</span> <span class="token function">awk</span> -v <span class="token assign-left variable">add</span><span class="token operator">=</span><span class="token number">0</span> -v <span class="token assign-left variable">subs</span><span class="token operator">=</span><span class="token number">0</span> -v <span class="token assign-left variable">loc</span><span class="token operator">=</span><span class="token number">0</span> <span class="token string">\'{ add += <span class="token variable">$1</span> ; subs += <span class="token variable">$2</span> ; loc += <span class="token variable">$1</span> - <span class="token variable">$2</span> } END { printf "add=%s; subs=%s; loc=%s;", add, subs, loc }\'</span><span class="token variable">)</span></span>\n          <span class="token assign-left variable">add_sum</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$((</span>$add_sum <span class="token operator">+</span> $add<span class="token variable">))</span></span>\n          <span class="token assign-left variable">subs_sum</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$((</span>$subs_sum <span class="token operator">+</span> $subs<span class="token variable">))</span></span>\n          <span class="token assign-left variable">loc_sum</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$((</span>$loc_sum <span class="token operator">+</span> $loc<span class="token variable">))</span></span>\n        <span class="token keyword">done</span>\n        <span class="token builtin class-name">printf</span> <span class="token string">"<span class="token variable">$until_date</span> 增加行总数：<span class="token variable">$add_sum</span>，删除行总数：<span class="token variable">$subs_sum</span>，总代码行：<span class="token variable">$loc_sum</span><span class="token entity" title="\\n">\\n</span>"</span>\n        <span class="token assign-left variable">i</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$((</span>$i<span class="token operator">-</span><span class="token number">1</span><span class="token variable">))</span></span>\n      <span class="token keyword">done</span>\n\n      <span class="token builtin class-name">echo</span> -e <span class="token string">"按项目统计："</span>\n      <span class="token keyword">for</span> <span class="token for-or-select variable">file</span> <span class="token keyword">in</span> <span class="token variable">${exist_branch_projects<span class="token punctuation">[</span>@<span class="token punctuation">]</span>}</span>\n      <span class="token keyword">do</span>\n        <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">!</span> -d <span class="token string">"<span class="token variable">$file_path</span>/<span class="token variable">$file</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>\n          <span class="token builtin class-name">echo</span> -e <span class="token string">"<span class="token variable">$file</span> 目录不存在。"</span>\n          <span class="token builtin class-name">continue</span><span class="token punctuation">;</span>\n        <span class="token keyword">fi</span>\n        <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">!</span> -d <span class="token string">"<span class="token variable">$file_path</span>/<span class="token variable">$file</span>/.git"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>\n          <span class="token builtin class-name">echo</span> -e <span class="token string">"<span class="token variable">$file</span> 不是git仓库。"</span>\n          <span class="token builtin class-name">continue</span><span class="token punctuation">;</span>\n        <span class="token keyword">fi</span>\n        <span class="token builtin class-name">cd</span> <span class="token string">"<span class="token variable">$file_path</span>/<span class="token variable">$file</span>"</span>\n        <span class="token comment"># git checkout master</span>\n        <span class="token builtin class-name">echo</span> <span class="token string">"<span class="token variable">$file</span> 代码量统计："</span>\n        <span class="token assign-left variable">i</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>$date_stat<span class="token variable">)</span></span>\n        <span class="token keyword">while</span> <span class="token punctuation">[</span> <span class="token variable">$i</span> -ge <span class="token number">1</span> <span class="token punctuation">]</span>\n        <span class="token keyword">do</span>\n          <span class="token assign-left variable">since_date</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">date</span> -d <span class="token string">"-<span class="token variable">$i</span> day"</span> +%Y-%m-%d<span class="token variable">`</span></span>\n          <span class="token assign-left variable">until_date</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">date</span> -d <span class="token string">"-<span class="token variable"><span class="token variable">$((</span>$i<span class="token operator">-</span><span class="token number">1</span><span class="token variable">))</span></span> day"</span> +%Y-%m-%d<span class="token variable">`</span></span>\n          <span class="token function">git</span> log --author<span class="token operator">=</span><span class="token variable">$git_email</span> --since<span class="token operator">=</span><span class="token variable">$since_date</span> --until<span class="token operator">=</span><span class="token variable">$until_date</span> --pretty<span class="token operator">=</span>tformat: --numstat <span class="token operator">|</span> <span class="token function">awk</span> -v <span class="token assign-left variable">add</span><span class="token operator">=</span><span class="token number">0</span> -v <span class="token assign-left variable">subs</span><span class="token operator">=</span><span class="token number">0</span> -v <span class="token assign-left variable">loc</span><span class="token operator">=</span><span class="token number">0</span> <span class="token string">\'{ add += <span class="token variable">$1</span> ; subs += <span class="token variable">$2</span> ; loc += <span class="token variable">$1</span> - <span class="token variable">$2</span> } END { printf "\'</span><span class="token variable">$until_date</span><span class="token string">\' 增加行总数：%s，删除行总数：%s，总代码行：%s<span class="token entity" title="\\n">\\n</span>", add, subs, loc }\'</span>\n          <span class="token assign-left variable">i</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$((</span>$i<span class="token operator">-</span><span class="token number">1</span><span class="token variable">))</span></span>\n        <span class="token keyword">done</span>\n      <span class="token keyword">done</span>\n    <span class="token punctuation">}</span>\n  <span class="token keyword">done</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="运行效果-2"><a href="#%E8%BF%90%E8%A1%8C%E6%95%88%E6%9E%9C-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>运行效果</h3>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2019-08-13-17-03-10-868d6a826e31d1f2d54182909111bc96-aee79.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 563px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 74.06749555950266%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAIAAABr+ngCAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABjklEQVQoz41T2ZKkIBBsbW9OARXQ9r7m/39ws3si9klnpp4qCJI8qnjELsl8llVZoIJABCY05aNkLDBVmCbB4+fq+2EcR+d99SlTGS54KWVTN4TSX8DneY7j0Pf96/UygBojpNSqbNuWcY4LQXDP/7ktyrIsiiLPC0JoGIaPP9b59XUeh3WurirnnNYar3DOCSFJkmRZxhhP0+yaf993qAYMyt9SGQMeRtBTypRSXdvCyLWcdV3neUZUrffHcXAukiSmlMJDFEVxHH9LuJb96ntnm2VZj/MAuRTSfDN3UME1mLvulnlZltY7cCJ27z0AkIrsrbVFQaQQUHQLxlX5SdtaV9c1ZxzM3jt4xiFmAUd5nl8HJlFCvAcmQADNhlEKqwAQAuP5M4p+WpJ92xprtVZ1XZVKfWAEQ3o+n+/AiiJN02vmdd2wX3A4DAOywaiM0fM8YeHegWmFRt553vZ9nqamabxz27YxLjChPM/+M6OJ7pR33cs2UG2xLdu2KqXxEDr8Fi4kfso0jUrrS+Z/BRAp/jUC8aQAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2019 08 13 17 03 10" title="" data-src="/static/2019-08-13-17-03-10-868d6a826e31d1f2d54182909111bc96-aee79.png" data-srcset="/static/2019-08-13-17-03-10-868d6a826e31d1f2d54182909111bc96-b3674.png 200w,\n/static/2019-08-13-17-03-10-868d6a826e31d1f2d54182909111bc96-2063d.png 400w,\n/static/2019-08-13-17-03-10-868d6a826e31d1f2d54182909111bc96-aee79.png 563w" data-sizes="(max-width: 563px) 100vw, 563px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>以上更新于<code class="language-text">2019-8-15 20:49:40</code></p>\n<hr>\n<h2 id="第四版"><a href="#%E7%AC%AC%E5%9B%9B%E7%89%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第四版</h2>\n<p>第三版的统计代码的数量对不上对应的时间，把昨天写的代码统计到今天了，做以下修复</p>\n<p>同时增加星期几的优化提示</p>\n<h3 id="修复代码统计对应不上错误的时间以及添加星期几的提示"><a href="#%E4%BF%AE%E5%A4%8D%E4%BB%A3%E7%A0%81%E7%BB%9F%E8%AE%A1%E5%AF%B9%E5%BA%94%E4%B8%8D%E4%B8%8A%E9%94%99%E8%AF%AF%E7%9A%84%E6%97%B6%E9%97%B4%E4%BB%A5%E5%8F%8A%E6%B7%BB%E5%8A%A0%E6%98%9F%E6%9C%9F%E5%87%A0%E7%9A%84%E6%8F%90%E7%A4%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>修复代码统计对应不上错误的时间以及添加星期几的提示</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="10483373559945220000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`#!/bin/sh\n# 周一到今天的代码量统计，使用方式：./git.bash mockingbird robin koala 或 执行 ./git.bash 后自行输入\n# 能够检测一些错误，并在错误发生时中断程序并输出信息\n# 使用 set -e 令脚本在发生错误时退出而不是继续运行；使用 set -u 来检查是否使用了未赋值的变量；试试 set -o pipefail，它可以监测管道中的错误。\n# set -euo pipefail\n# trap &quot;echo \'error: Script failed: see failed command above\'&quot; ERR\n# {} 防止下载不完全代码被执行\n{\n  function to_array() {\n    x=\\$1\n    OLD_IFS=&quot;\\$IFS&quot;\n    IFS=&quot;,&quot;\n    array=(\\$x)\n    IFS=&quot;\\$OLD_IFS&quot;\n    for each in \\${array[*]}\n    do\n    echo \\$each\n    done\n  }\n\n  file_path=&quot;G:/project/tungee&quot;\n  git_email=&quot;634407147@qq.com&quot;\n  date_stat=&quot;date +%w&quot; # 今天是一周的第几天，可换成具体数字如 date_stat=&quot;echo 5&quot; 以实现统计几天前代码的功能\n\n  # if [ \\$date_stat -eq 0 ]; then\n  #   date_stat=7\n  # fi\n\n  echo &quot;输入项目名，以英文逗号分隔，不能有空格&quot;\n  read input\n  projects=(\\$(to_array \\$input))\n  echo &quot;输入分支名，以英文逗号分隔，不能有空格&quot;\n  read input\n  branches=(\\$(to_array \\$input))\n\n  for branch in \\${branches[@]}\n  do\n    exist_branch_projects=()\n    for file in \\${projects[@]}\n    do\n      if [ ! -d &quot;\\$file_path/\\$file&quot; ]; then\n        echo -e &quot;\\$file 目录不存在。&quot;\n        continue;\n      fi\n      if [ ! -d &quot;\\$file_path/\\$file/.git&quot; ]; then\n        echo -e &quot;\\$file 不是git仓库。&quot;\n        continue;\n      fi\n      cd &quot;\\$file_path/\\$file&quot;\n      git checkout \\$branch -q >/dev/null 2>&1 # 重定向错误信息，即屏蔽错误信息\n      if [ \\$? -eq 0 ]; then\n        exist_branch_projects+=(\\$file)\n        git pull origin \\$branch -q\n      # else\n      #   # echo -e &quot;\\n\\$file 切换分支到 \\$branch 失败，可能不存在此分支&quot;\n      fi\n    done\n    echo -e &quot;\\n分支 \\$branch 上的代码统计：&quot;\n    {\n      echo -e &quot;按日期统计：&quot;\n      # 或 i=\\$((\\$(\\$date_stat)-1))\n      # \\$((\\$a+\\$b)) 用于整数运算，相当于 \\`expr \\$a + \\$b\\`\n      # \\$() 与 \\`\\` 相当于命令替换，执行结果替换\n      i=\\`expr \\$(\\$date_stat) - 1\\`\n      while [ \\$i -ge 0 ]\n      do\n        add_sum=0\n        subs_sum=0\n        loc_sum=0\n        for file in \\${exist_branch_projects[@]}\n        do\n          if [ ! -d &quot;\\$file_path/\\$file&quot; ]; then\n            echo -e &quot;\\$file 目录不存在。&quot;\n            continue;\n          fi\n          if [ ! -d &quot;\\$file_path/\\$file/.git&quot; ]; then\n            echo -e &quot;\\$file 不是git仓库。&quot;\n            continue;\n          fi\n          cd &quot;\\$file_path/\\$file&quot;\n          # git checkout \\$branch\n          since_date=\\`date -d &quot;-\\$i day&quot; +%Y-%m-%d\\`\n          since_week=\\`date -d &quot;-\\$i day&quot; +%A\\`\n          until_date=\\`date -d &quot;-\\$((\\$i-1)) day&quot; +%Y-%m-%d\\`\n          eval \\$(git log --author=\\$git_email --since=\\$since_date --until=\\$until_date --pretty=tformat: --numstat | awk -v add=0 -v subs=0 -v loc=0 \'{ add += \\$1 ; subs += \\$2 ; loc += \\$1 - \\$2 } END { printf &quot;add=%s; subs=%s; loc=%s;&quot;, add, subs, loc }\')\n          add_sum=\\$((\\$add_sum + \\$add))\n          subs_sum=\\$((\\$subs_sum + \\$subs))\n          loc_sum=\\$((\\$loc_sum + \\$loc))\n        done\n        printf &quot;\\$since_date（\\$since_week） 增加行总数：\\$add_sum，删除行总数：\\$subs_sum，总代码行：\\$loc_sum\\n&quot;\n        i=\\$((\\$i-1))\n      done\n\n      # echo -e &quot;按项目统计：&quot;\n      # for file in \\${exist_branch_projects[@]}\n      # do\n      #   if [ ! -d &quot;\\$file_path/\\$file&quot; ]; then\n      #     echo -e &quot;\\$file 目录不存在。&quot;\n      #     continue;\n      #   fi\n      #   if [ ! -d &quot;\\$file_path/\\$file/.git&quot; ]; then\n      #     echo -e &quot;\\$file 不是git仓库。&quot;\n      #     continue;\n      #   fi\n      #   cd &quot;\\$file_path/\\$file&quot;\n      #   # git checkout \\$branch\n      #   echo &quot;\\$file 代码量统计：&quot;\n      #   i=\\$(\\$date_stat)\n      #   while [ \\$i -ge 1 ]\n      #   do\n      #     since_date=\\`date -d &quot;-\\$i day&quot; +%Y-%m-%d\\`\n      #     until_date=\\`date -d &quot;-\\$((\\$i-1)) day&quot; +%Y-%m-%d\\`\n      #     git log --author=\\$git_email --since=\\$since_date --until=\\$until_date --pretty=tformat: --numstat | awk -v add=0 -v subs=0 -v loc=0 \'{ add += \\$1 ; subs += \\$2 ; loc += \\$1 - \\$2 } END { printf &quot;\'\\$until_date\' 增加行总数：%s，删除行总数：%s，总代码行：%s\\n&quot;, add, subs, loc }\'\n      #     i=\\$((\\$i-1))\n      #   done\n      # done\n    }\n  done\n}`, `10483373559945220000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash{61-65,83,90}"\n              >\n                <span class="gatsby-code-button-language">bash{61-65,83,90}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token shebang important">#!/bin/sh</span>\n<span class="token comment"># 周一到今天的代码量统计，使用方式：./git.bash mockingbird robin koala 或 执行 ./git.bash 后自行输入</span>\n<span class="token comment"># 能够检测一些错误，并在错误发生时中断程序并输出信息</span>\n<span class="token comment"># 使用 set -e 令脚本在发生错误时退出而不是继续运行；使用 set -u 来检查是否使用了未赋值的变量；试试 set -o pipefail，它可以监测管道中的错误。</span>\n<span class="token comment"># set -euo pipefail</span>\n<span class="token comment"># trap "echo \'error: Script failed: see failed command above\'" ERR</span>\n<span class="token comment"># {} 防止下载不完全代码被执行</span>\n<span class="token punctuation">{</span>\n  <span class="token keyword">function</span> <span class="token function-name function">to_array</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token assign-left variable">x</span><span class="token operator">=</span><span class="token variable">$1</span>\n    <span class="token assign-left variable">OLD_IFS</span><span class="token operator">=</span><span class="token string">"<span class="token environment constant">$IFS</span>"</span>\n    <span class="token assign-left variable"><span class="token environment constant">IFS</span></span><span class="token operator">=</span><span class="token string">","</span>\n    <span class="token assign-left variable">array</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token variable">$x</span><span class="token punctuation">)</span>\n    <span class="token assign-left variable"><span class="token environment constant">IFS</span></span><span class="token operator">=</span><span class="token string">"<span class="token variable">$OLD_IFS</span>"</span>\n    <span class="token keyword">for</span> <span class="token for-or-select variable">each</span> <span class="token keyword">in</span> <span class="token variable">${array<span class="token punctuation">[</span>*<span class="token punctuation">]</span>}</span>\n    <span class="token keyword">do</span>\n    <span class="token builtin class-name">echo</span> <span class="token variable">$each</span>\n    <span class="token keyword">done</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token assign-left variable">file_path</span><span class="token operator">=</span><span class="token string">"G:/project/tungee"</span>\n  <span class="token assign-left variable">git_email</span><span class="token operator">=</span><span class="token string">"634407147@qq.com"</span>\n  <span class="token assign-left variable">date_stat</span><span class="token operator">=</span><span class="token string">"date +%w"</span> <span class="token comment"># 今天是一周的第几天，可换成具体数字如 date_stat="echo 5" 以实现统计几天前代码的功能</span>\n\n  <span class="token comment"># if [ $date_stat -eq 0 ]; then</span>\n  <span class="token comment">#   date_stat=7</span>\n  <span class="token comment"># fi</span>\n\n  <span class="token builtin class-name">echo</span> <span class="token string">"输入项目名，以英文逗号分隔，不能有空格"</span>\n  <span class="token builtin class-name">read</span> input\n  <span class="token assign-left variable">projects</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token variable"><span class="token variable">$(</span>to_array $input<span class="token variable">)</span></span><span class="token punctuation">)</span>\n  <span class="token builtin class-name">echo</span> <span class="token string">"输入分支名，以英文逗号分隔，不能有空格"</span>\n  <span class="token builtin class-name">read</span> input\n  <span class="token assign-left variable">branches</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token variable"><span class="token variable">$(</span>to_array $input<span class="token variable">)</span></span><span class="token punctuation">)</span>\n\n  <span class="token keyword">for</span> <span class="token for-or-select variable">branch</span> <span class="token keyword">in</span> <span class="token variable">${branches<span class="token punctuation">[</span>@<span class="token punctuation">]</span>}</span>\n  <span class="token keyword">do</span>\n    <span class="token assign-left variable">exist_branch_projects</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token keyword">for</span> <span class="token for-or-select variable">file</span> <span class="token keyword">in</span> <span class="token variable">${projects<span class="token punctuation">[</span>@<span class="token punctuation">]</span>}</span>\n    <span class="token keyword">do</span>\n      <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">!</span> -d <span class="token string">"<span class="token variable">$file_path</span>/<span class="token variable">$file</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>\n        <span class="token builtin class-name">echo</span> -e <span class="token string">"<span class="token variable">$file</span> 目录不存在。"</span>\n        <span class="token builtin class-name">continue</span><span class="token punctuation">;</span>\n      <span class="token keyword">fi</span>\n      <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">!</span> -d <span class="token string">"<span class="token variable">$file_path</span>/<span class="token variable">$file</span>/.git"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>\n        <span class="token builtin class-name">echo</span> -e <span class="token string">"<span class="token variable">$file</span> 不是git仓库。"</span>\n        <span class="token builtin class-name">continue</span><span class="token punctuation">;</span>\n      <span class="token keyword">fi</span>\n      <span class="token builtin class-name">cd</span> <span class="token string">"<span class="token variable">$file_path</span>/<span class="token variable">$file</span>"</span>\n      <span class="token function">git</span> checkout <span class="token variable">$branch</span> -q <span class="token operator">></span>/dev/null <span class="token operator"><span class="token file-descriptor important">2</span>></span><span class="token file-descriptor important">&amp;1</span> <span class="token comment"># 重定向错误信息，即屏蔽错误信息</span>\n      <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$?</span> -eq <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>\n        <span class="token assign-left variable">exist_branch_projects</span><span class="token operator">+=</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span>\n        <span class="token function">git</span> pull origin <span class="token variable">$branch</span> -q\n      <span class="token comment"># else</span>\n      <span class="token comment">#   # echo -e "\\n$file 切换分支到 $branch 失败，可能不存在此分支"</span>\n      <span class="token keyword">fi</span>\n    <span class="token keyword">done</span>\n    <span class="token builtin class-name">echo</span> -e <span class="token string">"<span class="token entity" title="\\n">\\n</span>分支 <span class="token variable">$branch</span> 上的代码统计："</span>\n    <span class="token punctuation">{</span>\n      <span class="token builtin class-name">echo</span> -e <span class="token string">"按日期统计："</span>\n<span class="gatsby-highlight-code-line">      <span class="token comment"># 或 i=$(($($date_stat)-1))</span></span><span class="gatsby-highlight-code-line">      <span class="token comment"># $(($a+$b)) 用于整数运算，相当于 `expr $a + $b`</span></span><span class="gatsby-highlight-code-line">      <span class="token comment"># $() 与 `` 相当于命令替换，执行结果替换</span></span><span class="gatsby-highlight-code-line">      <span class="token assign-left variable">i</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">expr</span> <span class="token punctuation">$(</span>$date_stat<span class="token punctuation">)</span> - <span class="token number">1</span><span class="token variable">`</span></span></span><span class="gatsby-highlight-code-line">      <span class="token keyword">while</span> <span class="token punctuation">[</span> <span class="token variable">$i</span> -ge <span class="token number">0</span> <span class="token punctuation">]</span></span>      <span class="token keyword">do</span>\n        <span class="token assign-left variable">add_sum</span><span class="token operator">=</span><span class="token number">0</span>\n        <span class="token assign-left variable">subs_sum</span><span class="token operator">=</span><span class="token number">0</span>\n        <span class="token assign-left variable">loc_sum</span><span class="token operator">=</span><span class="token number">0</span>\n        <span class="token keyword">for</span> <span class="token for-or-select variable">file</span> <span class="token keyword">in</span> <span class="token variable">${exist_branch_projects<span class="token punctuation">[</span>@<span class="token punctuation">]</span>}</span>\n        <span class="token keyword">do</span>\n          <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">!</span> -d <span class="token string">"<span class="token variable">$file_path</span>/<span class="token variable">$file</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>\n            <span class="token builtin class-name">echo</span> -e <span class="token string">"<span class="token variable">$file</span> 目录不存在。"</span>\n            <span class="token builtin class-name">continue</span><span class="token punctuation">;</span>\n          <span class="token keyword">fi</span>\n          <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">!</span> -d <span class="token string">"<span class="token variable">$file_path</span>/<span class="token variable">$file</span>/.git"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>\n            <span class="token builtin class-name">echo</span> -e <span class="token string">"<span class="token variable">$file</span> 不是git仓库。"</span>\n            <span class="token builtin class-name">continue</span><span class="token punctuation">;</span>\n          <span class="token keyword">fi</span>\n          <span class="token builtin class-name">cd</span> <span class="token string">"<span class="token variable">$file_path</span>/<span class="token variable">$file</span>"</span>\n          <span class="token comment"># git checkout $branch</span>\n          <span class="token assign-left variable">since_date</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">date</span> -d <span class="token string">"-<span class="token variable">$i</span> day"</span> +%Y-%m-%d<span class="token variable">`</span></span>\n<span class="gatsby-highlight-code-line">          <span class="token assign-left variable">since_week</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">date</span> -d <span class="token string">"-<span class="token variable">$i</span> day"</span> +%A<span class="token variable">`</span></span></span>          <span class="token assign-left variable">until_date</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">date</span> -d <span class="token string">"-<span class="token variable"><span class="token variable">$((</span>$i<span class="token operator">-</span><span class="token number">1</span><span class="token variable">))</span></span> day"</span> +%Y-%m-%d<span class="token variable">`</span></span>\n          <span class="token builtin class-name">eval</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">git</span> log --author<span class="token operator">=</span>$git_email --since<span class="token operator">=</span>$since_date --until<span class="token operator">=</span>$until_date --pretty<span class="token operator">=</span>tformat: --numstat <span class="token operator">|</span> <span class="token function">awk</span> -v <span class="token assign-left variable">add</span><span class="token operator">=</span><span class="token number">0</span> -v <span class="token assign-left variable">subs</span><span class="token operator">=</span><span class="token number">0</span> -v <span class="token assign-left variable">loc</span><span class="token operator">=</span><span class="token number">0</span> <span class="token string">\'{ add += <span class="token variable">$1</span> ; subs += <span class="token variable">$2</span> ; loc += <span class="token variable">$1</span> - <span class="token variable">$2</span> } END { printf "add=%s; subs=%s; loc=%s;", add, subs, loc }\'</span><span class="token variable">)</span></span>\n          <span class="token assign-left variable">add_sum</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$((</span>$add_sum <span class="token operator">+</span> $add<span class="token variable">))</span></span>\n          <span class="token assign-left variable">subs_sum</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$((</span>$subs_sum <span class="token operator">+</span> $subs<span class="token variable">))</span></span>\n          <span class="token assign-left variable">loc_sum</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$((</span>$loc_sum <span class="token operator">+</span> $loc<span class="token variable">))</span></span>\n        <span class="token keyword">done</span>\n<span class="gatsby-highlight-code-line">        <span class="token builtin class-name">printf</span> <span class="token string">"<span class="token variable">$since_date</span>（<span class="token variable">$since_week</span>） 增加行总数：<span class="token variable">$add_sum</span>，删除行总数：<span class="token variable">$subs_sum</span>，总代码行：<span class="token variable">$loc_sum</span><span class="token entity" title="\\n">\\n</span>"</span></span>        <span class="token assign-left variable">i</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$((</span>$i<span class="token operator">-</span><span class="token number">1</span><span class="token variable">))</span></span>\n      <span class="token keyword">done</span>\n\n      <span class="token comment"># echo -e "按项目统计："</span>\n      <span class="token comment"># for file in ${exist_branch_projects[@]}</span>\n      <span class="token comment"># do</span>\n      <span class="token comment">#   if [ ! -d "$file_path/$file" ]; then</span>\n      <span class="token comment">#     echo -e "$file 目录不存在。"</span>\n      <span class="token comment">#     continue;</span>\n      <span class="token comment">#   fi</span>\n      <span class="token comment">#   if [ ! -d "$file_path/$file/.git" ]; then</span>\n      <span class="token comment">#     echo -e "$file 不是git仓库。"</span>\n      <span class="token comment">#     continue;</span>\n      <span class="token comment">#   fi</span>\n      <span class="token comment">#   cd "$file_path/$file"</span>\n      <span class="token comment">#   # git checkout $branch</span>\n      <span class="token comment">#   echo "$file 代码量统计："</span>\n      <span class="token comment">#   i=$($date_stat)</span>\n      <span class="token comment">#   while [ $i -ge 1 ]</span>\n      <span class="token comment">#   do</span>\n      <span class="token comment">#     since_date=`date -d "-$i day" +%Y-%m-%d`</span>\n      <span class="token comment">#     until_date=`date -d "-$(($i-1)) day" +%Y-%m-%d`</span>\n      <span class="token comment">#     git log --author=$git_email --since=$since_date --until=$until_date --pretty=tformat: --numstat | awk -v add=0 -v subs=0 -v loc=0 \'{ add += $1 ; subs += $2 ; loc += $1 - $2 } END { printf "\'$until_date\' 增加行总数：%s，删除行总数：%s，总代码行：%s\\n", add, subs, loc }\'</span>\n      <span class="token comment">#     i=$(($i-1))</span>\n      <span class="token comment">#   done</span>\n      <span class="token comment"># done</span>\n    <span class="token punctuation">}</span>\n  <span class="token keyword">done</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="运行效果-3"><a href="#%E8%BF%90%E8%A1%8C%E6%95%88%E6%9E%9C-3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>运行效果</h3>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2020-03-07-12-12-03-992b721bfa4f855f5abde72b8584f70d-72de5.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 648px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 65.74074074074075%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAAAsSAAALEgHS3X78AAABh0lEQVQoz4WS23KjMBBEuScYvAJJgC6AJSQRA/H//17azlO8rvI8gKpET8+cJjrJE5lJycuYJOSjYQn7R1LK8iRNorflrXPGaantbC7m0vC264ZRT5+f5Xtx33eUUd7xfui10nVV53l+Kss0Td+LRz1O03y+V900TZZncRzFcZwkSfqoOIpwzrIs+b+d90FKta6rc34Y+hDCsiyMsa9HMcrQ21pLCCmK/Fm8hqD1eBzHsjit1b7v0A+DOPb9dvvWuBsnYwzemOtUVX/Ezjk4b9t23bZxHK/XK8Sc8+A9xPM8MZydsxgHGeR/zcUgCGkgw3iM0mma4AUTyGCIaTnvlFJ1XT8rUVIIpRW+xnVVVXhSys71GbziR4EZgL2mjSWNseudkxNCgBYMKaVAaB6cMAvGKj6KV1GNE2Pcez/PFzEMv7Qh3rc7uaZp0Wue56J4JQYYrLSB0/qllEQ8i3OI6vZ9wLxtW2sN2r3+4ayxUsgQPHykFOj1mzP4hzVQhpxH5AwW2P9J+wMBHDBe9cJk8AAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2020 03 07 12 12 03" title="" data-src="/static/2020-03-07-12-12-03-992b721bfa4f855f5abde72b8584f70d-72de5.png" data-srcset="/static/2020-03-07-12-12-03-992b721bfa4f855f5abde72b8584f70d-bb436.png 200w,\n/static/2020-03-07-12-12-03-992b721bfa4f855f5abde72b8584f70d-c5634.png 400w,\n/static/2020-03-07-12-12-03-992b721bfa4f855f5abde72b8584f70d-72de5.png 648w" data-sizes="(max-width: 648px) 100vw, 648px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>以上更新于<code class="language-text">2020-3-7 11:57:55</code></p>\n<hr>\n<h2 id="第五版"><a href="#%E7%AC%AC%E4%BA%94%E7%89%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第五版</h2>\n<p>第四版的代码统计今天的代码有 2 个问题：</p>\n<ol>\n<li>当 i 循环到 0 时，<code class="language-text">-$(($i-1))</code> 这一行代码有问题，统计到的 <code class="language-text">until_date</code> 比 <code class="language-text">since_date</code> 反而早了一天，造成脚本统计错误</li>\n<li>统计今天的代码时，只传年月日会默认带上当前时分秒的时间导致统计不上，即还要加上时分秒，否则不能统计到今天的代码</li>\n</ol>\n<h3 id="修复统计今天代码"><a href="#%E4%BF%AE%E5%A4%8D%E7%BB%9F%E8%AE%A1%E4%BB%8A%E5%A4%A9%E4%BB%A3%E7%A0%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>修复统计今天代码</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="92399070453717980000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`#!/bin/sh\n# 周一到今天的代码量统计，使用方式：./git.bash mockingbird robin koala 或 执行 ./git.bash 后自行输入\n# 能够检测一些错误，并在错误发生时中断程序并输出信息\n# 使用 set -e 令脚本在发生错误时退出而不是继续运行；使用 set -u 来检查是否使用了未赋值的变量；试试 set -o pipefail，它可以监测管道中的错误。\n# set -euo pipefail\n# trap &quot;echo \'error: Script failed: see failed command above\'&quot; ERR\n# {} 防止下载不完全代码被执行\n{\n  function to_array() {\n    x=\\$1\n    OLD_IFS=&quot;\\$IFS&quot;\n    IFS=&quot;,&quot;\n    array=(\\$x)\n    IFS=&quot;\\$OLD_IFS&quot;\n    for each in \\${array[*]}\n    do\n    echo \\$each\n    done\n  }\n\n  file_path=&quot;G:/project/tungee&quot;\n  git_email=&quot;634407147@qq.com&quot;\n  date_stat=&quot;echo 9&quot; # 今天是一周的第几天，可换成具体数字如 date_stat=&quot;echo 5&quot; 以实现统计几天前代码的功能\n\n  # if [ \\$date_stat -eq 0 ]; then\n  #   date_stat=7\n  # fi\n\n  echo &quot;输入项目名，以英文逗号分隔，不能有空格&quot;\n  read input\n  projects=(\\$(to_array \\$input))\n  echo &quot;输入分支名，以英文逗号分隔，不能有空格&quot;\n  read input\n  branches=(\\$(to_array \\$input))\n\n  for branch in \\${branches[@]}\n  do\n    exist_branch_projects=()\n    for file in \\${projects[@]}\n    do\n      if [ ! -d &quot;\\$file_path/\\$file&quot; ]; then\n        echo -e &quot;\\$file 目录不存在。&quot;\n        continue;\n      fi\n      if [ ! -d &quot;\\$file_path/\\$file/.git&quot; ]; then\n        echo -e &quot;\\$file 不是git仓库。&quot;\n        continue;\n      fi\n      cd &quot;\\$file_path/\\$file&quot;\n      git checkout \\$branch -q >/dev/null 2>&1 # 重定向错误信息，即屏蔽错误信息\n      if [ \\$? -eq 0 ]; then\n        exist_branch_projects+=(\\$file)\n        # git pull origin \\$branch -q\n      # else\n      #   # echo -e &quot;\\n\\$file 切换分支到 \\$branch 失败，可能不存在此分支&quot;\n      fi\n    done\n    echo -e &quot;\\n分支 \\$branch 上的代码统计：&quot;\n    {\n      echo -e &quot;按日期统计：&quot;\n      # 或 i=\\$((\\$(\\$date_stat)-1))\n      # \\$((\\$a+\\$b)) 用于整数运算，相当于 \\`expr \\$a + \\$b\\`\n      # \\$() 与 \\`\\` 相当于命令替换，执行结果替换\n      i=\\`expr \\$(\\$date_stat) - 1\\`\n      while [ \\$i -ge 0 ]\n      do\n        add_sum=0\n        subs_sum=0\n        loc_sum=0\n        for file in \\${exist_branch_projects[@]}\n        do\n          if [ ! -d &quot;\\$file_path/\\$file&quot; ]; then\n            echo -e &quot;\\$file 目录不存在。&quot;\n            continue;\n          fi\n          if [ ! -d &quot;\\$file_path/\\$file/.git&quot; ]; then\n            echo -e &quot;\\$file 不是git仓库。&quot;\n            continue;\n          fi\n          cd &quot;\\$file_path/\\$file&quot;\n          # git checkout \\$branch\n          since_date=\\`date -d &quot;-\\$i day&quot; +%Y-%m-%d\\`\n          if [ \\$i -ge 1 ]; then\n            until_date=\\`date -d &quot;-\\$((\\$i-1)) day&quot; +%Y-%m-%d\\`\n          else\n            until_date=\\`date -d &quot;+\\$((0-\\$i+1)) day&quot; +%Y-%m-%d\\`\n          fi\n          eval \\$(git log --author=\\$git_email --since=&quot;\\$since_date 00:00:00&quot; --until=&quot;\\$until_date 00:00:00&quot; --pretty=tformat: --numstat | awk -v add=0 -v subs=0 -v loc=0 \'{ add += \\$1 ; subs += \\$2 ; loc += \\$1 - \\$2 } END { printf &quot;add=%s; subs=%s; loc=%s;&quot;, add, subs, loc }\')\n          add_sum=\\$((\\$add_sum + \\$add))\n          subs_sum=\\$((\\$subs_sum + \\$subs))\n          loc_sum=\\$((\\$loc_sum + \\$loc))\n        done\n        since_week=\\`date -d &quot;-\\$i day&quot; +%A\\`\n        printf &quot;\\$since_date（\\$since_week） 增加行总数：\\$add_sum，删除行总数：\\$subs_sum，总代码行：\\$loc_sum\\n&quot;\n        i=\\$((\\$i-1))\n      done\n\n      # echo -e &quot;按项目统计：&quot;\n      # for file in \\${exist_branch_projects[@]}\n      # do\n      #   if [ ! -d &quot;\\$file_path/\\$file&quot; ]; then\n      #     echo -e &quot;\\$file 目录不存在。&quot;\n      #     continue;\n      #   fi\n      #   if [ ! -d &quot;\\$file_path/\\$file/.git&quot; ]; then\n      #     echo -e &quot;\\$file 不是git仓库。&quot;\n      #     continue;\n      #   fi\n      #   cd &quot;\\$file_path/\\$file&quot;\n      #   # git checkout \\$branch\n      #   echo &quot;\\$file 代码量统计：&quot;\n      #   i=\\$(\\$date_stat)\n      #   while [ \\$i -ge 1 ]\n      #   do\n      #     since_date=\\`date -d &quot;-\\$i day&quot; +%Y-%m-%d\\`\n      #     until_date=\\`date -d &quot;-\\$((\\$i-1)) day&quot; +%Y-%m-%d\\`\n      #     git log --author=\\$git_email --since=\\$since_date --until=\\$until_date --pretty=tformat: --numstat | awk -v add=0 -v subs=0 -v loc=0 \'{ add += \\$1 ; subs += \\$2 ; loc += \\$1 - \\$2 } END { printf &quot;\'\\$until_date\' 增加行总数：%s，删除行总数：%s，总代码行：%s\\n&quot;, add, subs, loc }\'\n      #     i=\\$((\\$i-1))\n      #   done\n      # done\n    }\n  done\n}`, `92399070453717980000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash{83-88}"\n              >\n                <span class="gatsby-code-button-language">bash{83-88}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token shebang important">#!/bin/sh</span>\n<span class="token comment"># 周一到今天的代码量统计，使用方式：./git.bash mockingbird robin koala 或 执行 ./git.bash 后自行输入</span>\n<span class="token comment"># 能够检测一些错误，并在错误发生时中断程序并输出信息</span>\n<span class="token comment"># 使用 set -e 令脚本在发生错误时退出而不是继续运行；使用 set -u 来检查是否使用了未赋值的变量；试试 set -o pipefail，它可以监测管道中的错误。</span>\n<span class="token comment"># set -euo pipefail</span>\n<span class="token comment"># trap "echo \'error: Script failed: see failed command above\'" ERR</span>\n<span class="token comment"># {} 防止下载不完全代码被执行</span>\n<span class="token punctuation">{</span>\n  <span class="token keyword">function</span> <span class="token function-name function">to_array</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token assign-left variable">x</span><span class="token operator">=</span><span class="token variable">$1</span>\n    <span class="token assign-left variable">OLD_IFS</span><span class="token operator">=</span><span class="token string">"<span class="token environment constant">$IFS</span>"</span>\n    <span class="token assign-left variable"><span class="token environment constant">IFS</span></span><span class="token operator">=</span><span class="token string">","</span>\n    <span class="token assign-left variable">array</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token variable">$x</span><span class="token punctuation">)</span>\n    <span class="token assign-left variable"><span class="token environment constant">IFS</span></span><span class="token operator">=</span><span class="token string">"<span class="token variable">$OLD_IFS</span>"</span>\n    <span class="token keyword">for</span> <span class="token for-or-select variable">each</span> <span class="token keyword">in</span> <span class="token variable">${array<span class="token punctuation">[</span>*<span class="token punctuation">]</span>}</span>\n    <span class="token keyword">do</span>\n    <span class="token builtin class-name">echo</span> <span class="token variable">$each</span>\n    <span class="token keyword">done</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token assign-left variable">file_path</span><span class="token operator">=</span><span class="token string">"G:/project/tungee"</span>\n  <span class="token assign-left variable">git_email</span><span class="token operator">=</span><span class="token string">"634407147@qq.com"</span>\n  <span class="token assign-left variable">date_stat</span><span class="token operator">=</span><span class="token string">"echo 9"</span> <span class="token comment"># 今天是一周的第几天，可换成具体数字如 date_stat="echo 5" 以实现统计几天前代码的功能</span>\n\n  <span class="token comment"># if [ $date_stat -eq 0 ]; then</span>\n  <span class="token comment">#   date_stat=7</span>\n  <span class="token comment"># fi</span>\n\n  <span class="token builtin class-name">echo</span> <span class="token string">"输入项目名，以英文逗号分隔，不能有空格"</span>\n  <span class="token builtin class-name">read</span> input\n  <span class="token assign-left variable">projects</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token variable"><span class="token variable">$(</span>to_array $input<span class="token variable">)</span></span><span class="token punctuation">)</span>\n  <span class="token builtin class-name">echo</span> <span class="token string">"输入分支名，以英文逗号分隔，不能有空格"</span>\n  <span class="token builtin class-name">read</span> input\n  <span class="token assign-left variable">branches</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token variable"><span class="token variable">$(</span>to_array $input<span class="token variable">)</span></span><span class="token punctuation">)</span>\n\n  <span class="token keyword">for</span> <span class="token for-or-select variable">branch</span> <span class="token keyword">in</span> <span class="token variable">${branches<span class="token punctuation">[</span>@<span class="token punctuation">]</span>}</span>\n  <span class="token keyword">do</span>\n    <span class="token assign-left variable">exist_branch_projects</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token keyword">for</span> <span class="token for-or-select variable">file</span> <span class="token keyword">in</span> <span class="token variable">${projects<span class="token punctuation">[</span>@<span class="token punctuation">]</span>}</span>\n    <span class="token keyword">do</span>\n      <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">!</span> -d <span class="token string">"<span class="token variable">$file_path</span>/<span class="token variable">$file</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>\n        <span class="token builtin class-name">echo</span> -e <span class="token string">"<span class="token variable">$file</span> 目录不存在。"</span>\n        <span class="token builtin class-name">continue</span><span class="token punctuation">;</span>\n      <span class="token keyword">fi</span>\n      <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">!</span> -d <span class="token string">"<span class="token variable">$file_path</span>/<span class="token variable">$file</span>/.git"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>\n        <span class="token builtin class-name">echo</span> -e <span class="token string">"<span class="token variable">$file</span> 不是git仓库。"</span>\n        <span class="token builtin class-name">continue</span><span class="token punctuation">;</span>\n      <span class="token keyword">fi</span>\n      <span class="token builtin class-name">cd</span> <span class="token string">"<span class="token variable">$file_path</span>/<span class="token variable">$file</span>"</span>\n      <span class="token function">git</span> checkout <span class="token variable">$branch</span> -q <span class="token operator">></span>/dev/null <span class="token operator"><span class="token file-descriptor important">2</span>></span><span class="token file-descriptor important">&amp;1</span> <span class="token comment"># 重定向错误信息，即屏蔽错误信息</span>\n      <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$?</span> -eq <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>\n        <span class="token assign-left variable">exist_branch_projects</span><span class="token operator">+=</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span>\n        <span class="token comment"># git pull origin $branch -q</span>\n      <span class="token comment"># else</span>\n      <span class="token comment">#   # echo -e "\\n$file 切换分支到 $branch 失败，可能不存在此分支"</span>\n      <span class="token keyword">fi</span>\n    <span class="token keyword">done</span>\n    <span class="token builtin class-name">echo</span> -e <span class="token string">"<span class="token entity" title="\\n">\\n</span>分支 <span class="token variable">$branch</span> 上的代码统计："</span>\n    <span class="token punctuation">{</span>\n      <span class="token builtin class-name">echo</span> -e <span class="token string">"按日期统计："</span>\n      <span class="token comment"># 或 i=$(($($date_stat)-1))</span>\n      <span class="token comment"># $(($a+$b)) 用于整数运算，相当于 `expr $a + $b`</span>\n      <span class="token comment"># $() 与 `` 相当于命令替换，执行结果替换</span>\n      <span class="token assign-left variable">i</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">expr</span> <span class="token punctuation">$(</span>$date_stat<span class="token punctuation">)</span> - <span class="token number">1</span><span class="token variable">`</span></span>\n      <span class="token keyword">while</span> <span class="token punctuation">[</span> <span class="token variable">$i</span> -ge <span class="token number">0</span> <span class="token punctuation">]</span>\n      <span class="token keyword">do</span>\n        <span class="token assign-left variable">add_sum</span><span class="token operator">=</span><span class="token number">0</span>\n        <span class="token assign-left variable">subs_sum</span><span class="token operator">=</span><span class="token number">0</span>\n        <span class="token assign-left variable">loc_sum</span><span class="token operator">=</span><span class="token number">0</span>\n        <span class="token keyword">for</span> <span class="token for-or-select variable">file</span> <span class="token keyword">in</span> <span class="token variable">${exist_branch_projects<span class="token punctuation">[</span>@<span class="token punctuation">]</span>}</span>\n        <span class="token keyword">do</span>\n          <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">!</span> -d <span class="token string">"<span class="token variable">$file_path</span>/<span class="token variable">$file</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>\n            <span class="token builtin class-name">echo</span> -e <span class="token string">"<span class="token variable">$file</span> 目录不存在。"</span>\n            <span class="token builtin class-name">continue</span><span class="token punctuation">;</span>\n          <span class="token keyword">fi</span>\n          <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">!</span> -d <span class="token string">"<span class="token variable">$file_path</span>/<span class="token variable">$file</span>/.git"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>\n            <span class="token builtin class-name">echo</span> -e <span class="token string">"<span class="token variable">$file</span> 不是git仓库。"</span>\n            <span class="token builtin class-name">continue</span><span class="token punctuation">;</span>\n          <span class="token keyword">fi</span>\n          <span class="token builtin class-name">cd</span> <span class="token string">"<span class="token variable">$file_path</span>/<span class="token variable">$file</span>"</span>\n          <span class="token comment"># git checkout $branch</span>\n          <span class="token assign-left variable">since_date</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">date</span> -d <span class="token string">"-<span class="token variable">$i</span> day"</span> +%Y-%m-%d<span class="token variable">`</span></span>\n<span class="gatsby-highlight-code-line">          <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$i</span> -ge <span class="token number">1</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span></span><span class="gatsby-highlight-code-line">            <span class="token assign-left variable">until_date</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">date</span> -d <span class="token string">"-<span class="token variable"><span class="token variable">$((</span>$i<span class="token operator">-</span><span class="token number">1</span><span class="token variable">))</span></span> day"</span> +%Y-%m-%d<span class="token variable">`</span></span></span><span class="gatsby-highlight-code-line">          <span class="token keyword">else</span></span><span class="gatsby-highlight-code-line">            <span class="token assign-left variable">until_date</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">date</span> -d <span class="token string">"+<span class="token variable"><span class="token variable">$((</span><span class="token number">0</span><span class="token operator">-</span>$i<span class="token operator">+</span><span class="token number">1</span><span class="token variable">))</span></span> day"</span> +%Y-%m-%d<span class="token variable">`</span></span></span><span class="gatsby-highlight-code-line">          <span class="token keyword">fi</span></span><span class="gatsby-highlight-code-line">          <span class="token builtin class-name">eval</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">git</span> log --author<span class="token operator">=</span>$git_email --since<span class="token operator">=</span><span class="token string">"<span class="token variable">$since_date</span> 00:00:00"</span> --until<span class="token operator">=</span><span class="token string">"<span class="token variable">$until_date</span> 00:00:00"</span> --pretty<span class="token operator">=</span>tformat: --numstat <span class="token operator">|</span> <span class="token function">awk</span> -v <span class="token assign-left variable">add</span><span class="token operator">=</span><span class="token number">0</span> -v <span class="token assign-left variable">subs</span><span class="token operator">=</span><span class="token number">0</span> -v <span class="token assign-left variable">loc</span><span class="token operator">=</span><span class="token number">0</span> <span class="token string">\'{ add += <span class="token variable">$1</span> ; subs += <span class="token variable">$2</span> ; loc += <span class="token variable">$1</span> - <span class="token variable">$2</span> } END { printf "add=%s; subs=%s; loc=%s;", add, subs, loc }\'</span><span class="token variable">)</span></span></span>          <span class="token assign-left variable">add_sum</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$((</span>$add_sum <span class="token operator">+</span> $add<span class="token variable">))</span></span>\n          <span class="token assign-left variable">subs_sum</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$((</span>$subs_sum <span class="token operator">+</span> $subs<span class="token variable">))</span></span>\n          <span class="token assign-left variable">loc_sum</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$((</span>$loc_sum <span class="token operator">+</span> $loc<span class="token variable">))</span></span>\n        <span class="token keyword">done</span>\n        <span class="token assign-left variable">since_week</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">date</span> -d <span class="token string">"-<span class="token variable">$i</span> day"</span> +%A<span class="token variable">`</span></span>\n        <span class="token builtin class-name">printf</span> <span class="token string">"<span class="token variable">$since_date</span>（<span class="token variable">$since_week</span>） 增加行总数：<span class="token variable">$add_sum</span>，删除行总数：<span class="token variable">$subs_sum</span>，总代码行：<span class="token variable">$loc_sum</span><span class="token entity" title="\\n">\\n</span>"</span>\n        <span class="token assign-left variable">i</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$((</span>$i<span class="token operator">-</span><span class="token number">1</span><span class="token variable">))</span></span>\n      <span class="token keyword">done</span>\n\n      <span class="token comment"># echo -e "按项目统计："</span>\n      <span class="token comment"># for file in ${exist_branch_projects[@]}</span>\n      <span class="token comment"># do</span>\n      <span class="token comment">#   if [ ! -d "$file_path/$file" ]; then</span>\n      <span class="token comment">#     echo -e "$file 目录不存在。"</span>\n      <span class="token comment">#     continue;</span>\n      <span class="token comment">#   fi</span>\n      <span class="token comment">#   if [ ! -d "$file_path/$file/.git" ]; then</span>\n      <span class="token comment">#     echo -e "$file 不是git仓库。"</span>\n      <span class="token comment">#     continue;</span>\n      <span class="token comment">#   fi</span>\n      <span class="token comment">#   cd "$file_path/$file"</span>\n      <span class="token comment">#   # git checkout $branch</span>\n      <span class="token comment">#   echo "$file 代码量统计："</span>\n      <span class="token comment">#   i=$($date_stat)</span>\n      <span class="token comment">#   while [ $i -ge 1 ]</span>\n      <span class="token comment">#   do</span>\n      <span class="token comment">#     since_date=`date -d "-$i day" +%Y-%m-%d`</span>\n      <span class="token comment">#     until_date=`date -d "-$(($i-1)) day" +%Y-%m-%d`</span>\n      <span class="token comment">#     git log --author=$git_email --since=$since_date --until=$until_date --pretty=tformat: --numstat | awk -v add=0 -v subs=0 -v loc=0 \'{ add += $1 ; subs += $2 ; loc += $1 - $2 } END { printf "\'$until_date\' 增加行总数：%s，删除行总数：%s，总代码行：%s\\n", add, subs, loc }\'</span>\n      <span class="token comment">#     i=$(($i-1))</span>\n      <span class="token comment">#   done</span>\n      <span class="token comment"># done</span>\n    <span class="token punctuation">}</span>\n  <span class="token keyword">done</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="运行效果-4"><a href="#%E8%BF%90%E8%A1%8C%E6%95%88%E6%9E%9C-4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>运行效果</h3>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2020-04-24-12-11-28-d32fe7d1d01c539a83e8fbfe26b04194-ad786.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 457px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 55.57986870897156%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABpElEQVQoz3VSyXabMBQVpWDAgIQkQELMYAgeyDlOnEVynO78/5/UW9plfVcCvXcnILayd+0uaANP+0QQwgm3hCFm7/hcEiHIziNP0ded0WXbtIwykXCRCJnJOKF+EEgcc8VY8nT5dDxy8Qeet0vTVKZpURgpZRiGWquyrHD1dDnLMs55oXWaZVoXZWl0UYRhZNs26DzPc10XY5Zl/Z23NvxbljAnZVEUcUzZhjiKKKW+H/i+xygFO6Xs/8rT4TCOY1NXYRzDZxSG+/0eVinINgpkQWwQw4LrOHEM8uin4/ywbTIO4zAMW7zy8XjkCgdz+/g4n0/9MERxvF4u58vler0qrYXgy7LgBewgEWnqGlFhHs5vt3eooTVM9F1bGIPa+r4DO9yhyygK67oeh55z4TgulA+4M8ZUZfX96xtSpTHXt/fl5aXrOnBBB1zrumZZzhid53lZjqgG6UjTNFhDZ0qpr6/PJEnyPIfPcRzKst6U+2mDUhqFtE0zTTM+kOf7BL9HVVVoBeL3+11tWF9fp+nQNC3qmTccTycsJ4yhITwmnKO+32/nM82XjX3jAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2020 04 24 12 11 28" title="" data-src="/static/2020-04-24-12-11-28-d32fe7d1d01c539a83e8fbfe26b04194-ad786.png" data-srcset="/static/2020-04-24-12-11-28-d32fe7d1d01c539a83e8fbfe26b04194-aaeb0.png 200w,\n/static/2020-04-24-12-11-28-d32fe7d1d01c539a83e8fbfe26b04194-4d187.png 400w,\n/static/2020-04-24-12-11-28-d32fe7d1d01c539a83e8fbfe26b04194-ad786.png 457w" data-sizes="(max-width: 457px) 100vw, 457px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>',
id:"/home/runner/work/GatsbyBlog/GatsbyBlog/blog/git代码统计脚本/index.md absPath of file >>> MarkdownRemark",timeToRead:11,frontmatter:{date:"2020-04-24 11:17:09",path:"/git-code-statistics-script/",tags:"Git, git 代码统计, 预研",title:"git代码统计脚本",draft:null}},{excerpt:"需求背景 如下图所示，由于多个产品共存，当初设计产品架构时，侧边栏、打电话组件是存在于每个项目的子模块中的。迫于产品越来越多，需要动到侧边栏的时候越来越频繁，随着产品的不断增加导致了需要编译每个项目的工作越来越重，急需一种新的架构来分离侧边栏与各自产品端。 技术方案 基本原理类似于之前的文章  记一次组件打包为链接的实践 ，也就是主框架也就是侧边栏项目提前设定好元素的位置，再用 ReactDOM.render…",html:'<h1 id="需求背景"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h1>\n<p>如下图所示，由于多个产品共存，当初设计产品架构时，侧边栏、打电话组件是存在于每个项目的子模块中的。迫于产品越来越多，需要动到侧边栏的时候越来越频繁，随着产品的不断增加导致了需要编译每个项目的工作越来越重，急需一种新的架构来分离侧边栏与各自产品端。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2020-04-01-11-05-14-5b7b03e10126de2c72c19892be04c611-8b0e1.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 294px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 117.68707482993197%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAYCAIAAAB1KUohAAAACXBIWXMAAAsSAAALEgHS3X78AAADMklEQVQ4y5WUzU8TQRTAB7iYKDGoCSQgIhDCh6CAhZYvCRAEQQOBk5h40It4IgQvCh5Q/xkNfhCUKgWLaPBYDxhavtpC+r3tbtvd2Z3ZHd92MZGvpL68THZm9vfem/feDCoz3TB13i6ua12wf2eMUUpZ2oLGJ1/8XneNPZuetdqwmNza1GVjY2MHxO0OBAKapp0ITzx/ubG5M/Z0enbeRmS8tbUFFPCABoMhjotomnoiXFLXUmXpLKy2WJdWYK5Q1XAEI0AwgZV/FRN9pKquqPhaU2lda0Gl6c38sqCy3Sje44k7Srwx4hN09QvUUJ9Ag3HqDBM3R1RKsUKR5ebg/dHx5p6h15++8oz98FJXlNm9zLrN4CMisZC4r0GRcRJzRjQvr4dFFAVVN3ffufugpqV7xrqMGfPwNCgxUL/IwhLjsA4YCoZimO3ENF9cA1aWMSq62lRwpTGv/LptWS8VIQqlRJIk2CNUT4B2UGGJUA3+0eH69r6BkYe17b2fl5YBDgaDfCzmXHdCzv0Bv6IohzIMldNUjRKoDEYtt4ZHn0zByedt9nSaRGf/FgRdrjFXNbblV9Qv2L/BgiiKGGNBEOIggnDUFsBJESclOSFilJWZlXnqLEJobm4O9tzQVX7/L4dj3elcW1tLJBKHYHDLxRIJUcKygjJyijLL+9Dp/Nl3M+mEDXCUT+hNQglCZ3IzLlSgrOwP79/CHs/zkOpoNCqk5KitlOc4pD0Wi6KcvIJzeQXZ53OtCzY9bI8nHA67XK7t7W2v13s024ZnkjKKatv77z0ab+odti7a/yNsaG9CkKV74PHEpKmj34AjkYiYFDmOg8hDoZAsyyfBBOCSutYKc0dhtXkx1WG7u3uAQcBwkyHzULkTwlah3qjM1N7QdedSjcVmX0kzbI6PQ5tAI6LmnsGJqVddgyMfvyzCXqqrZWgQ8Hk02zBVVdXwDN+oytLVPTRSae5cSHmGJIdDYRh9Pp/H4zl0ZrBICN0/M1zJ4toWOHZ+VYNxq9LMNtEjoAiekdL6tovVZgOGNagtBJxMJrEkwfR4mFDjDTsAg0Cef66uOhwOeAahHsfCSSxjhfwBPCrGF6a/cTQAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2020 04 01 11 05 14" title="" data-src="/static/2020-04-01-11-05-14-5b7b03e10126de2c72c19892be04c611-8b0e1.png" data-srcset="/static/2020-04-01-11-05-14-5b7b03e10126de2c72c19892be04c611-2d2ea.png 200w,\n/static/2020-04-01-11-05-14-5b7b03e10126de2c72c19892be04c611-8b0e1.png 294w" data-sizes="(max-width: 294px) 100vw, 294px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h1 id="技术方案"><a href="#%E6%8A%80%E6%9C%AF%E6%96%B9%E6%A1%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>技术方案</h1>\n<p>基本原理类似于之前的文章 <a href="/components-pack-as-library/">记一次组件打包为链接的实践</a>，也就是主框架也就是侧边栏项目提前设定好元素的位置，再用 ReactDOM.render 方法去渲染结点，当然还有许多其他要注意的地方，比如链接的缓存规则、路由之间的跳转、子框架应用间的通信、样式和脚本的隔离等等。</p>\n<p>参考市面上已有的解决的方案，发现比较符合微前端框架的适用场景，于是开始用以下微前端框架来做出一个 demo 级别的应用</p>\n<ol>\n<li><a href="https://github.com/ice-lab/icestark" target="_blank" rel="nofollow noreferrer noopener">ice-stark</a></li>\n<li><a href="https://github.com/single-spa/single-spa" target="_blank" rel="nofollow noreferrer noopener">single-spa</a></li>\n<li><a href="https://github.com/umijs/qiankun" target="_blank" rel="nofollow noreferrer noopener">qiankun</a></li>\n</ol>\n<h1 id="具体实施"><a href="#%E5%85%B7%E4%BD%93%E5%AE%9E%E6%96%BD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>具体实施</h1>\n<h2 id="ice-stark"><a href="#ice-stark" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ice-stark</h2>\n<h3 id="主框架"><a href="#%E4%B8%BB%E6%A1%86%E6%9E%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>主框架</h3>\n<p>以路径作为识别子应用的方式，子应用需要配置 publicPath，否则访问不到</p>\n<p>这里假设产品 1 是采用了旧框架的子应用，产品 2 采用了新的</p>\n<p>以下是在 ice/stark 1.4.1 的版本上开始做的，需要添加代码如下：</p>\n<p>src\\platform\\layout\\index.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="7900121830325491000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import { AppRouter, AppRoute } from \'@ice/stark\';\n<AppRouter\n  NotFoundComponent={<div>未找到</div>}\n  LoadingComponent={<div>加载中</div>}\n  onRouteChange={this.handleRouteChange}\n>\n  <AppRoute path=\'/product1\' basename=\'/product1\' title=\'产品1\' entry=\'产品1的域名/index.html\' />\n  <AppRoute path=\'/product2\' basename=\'/product2\' title=\'产品2\' entry=\'产品2的域名/index.html\' />\n</AppRouter>;`, `7900121830325491000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="jsx"\n              >\n                <span class="gatsby-code-button-language">jsx</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">import</span> <span class="token punctuation">{</span> AppRouter<span class="token punctuation">,</span> AppRoute <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@ice/stark\'</span><span class="token punctuation">;</span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">AppRouter</span></span>\n  <span class="token attr-name">NotFoundComponent</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">未找到</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token punctuation">}</span></span>\n  <span class="token attr-name">LoadingComponent</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">加载中</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token punctuation">}</span></span>\n  <span class="token attr-name">onRouteChange</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleRouteChange<span class="token punctuation">}</span></span>\n<span class="token punctuation">></span></span><span class="token plain-text">\n  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">AppRoute</span></span> <span class="token attr-name">path</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">\'</span>/product1<span class="token punctuation">\'</span></span> <span class="token attr-name">basename</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">\'</span>/product1<span class="token punctuation">\'</span></span> <span class="token attr-name">title</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">\'</span>产品1<span class="token punctuation">\'</span></span> <span class="token attr-name">entry</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">\'</span>产品1的域名/index.html<span class="token punctuation">\'</span></span> <span class="token punctuation">/></span></span><span class="token plain-text">\n  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">AppRoute</span></span> <span class="token attr-name">path</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">\'</span>/product2<span class="token punctuation">\'</span></span> <span class="token attr-name">basename</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">\'</span>/product2<span class="token punctuation">\'</span></span> <span class="token attr-name">title</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">\'</span>产品2<span class="token punctuation">\'</span></span> <span class="token attr-name">entry</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">\'</span>产品2的域名/index.html<span class="token punctuation">\'</span></span> <span class="token punctuation">/></span></span><span class="token plain-text">\n</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">AppRouter</span></span><span class="token punctuation">></span></span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>结合公司实际的应用场景，不同产品对应着不同的域名，这就不能用路径的方式来识别子应用的加载，需要作出如下改动</p>\n<p>当然对应的子应用就不需要路径别名的配置了，这样实现的缺点是 onRouteChange 这个函数不再起作用，而且不能控制子应用的缓存，这些不同域名的缓存全部交给对应的 nginx 来做了</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="11002542855579510000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import { AppRouter, AppRoute } from \'@ice/stark\';\n<AppRouter\n  NotFoundComponent={<div>未找到</div>}\n  LoadingComponent={<div>加载中</div>}\n  onRouteChange={this.handleRouteChange}\n>\n  {产品1的域名 ? <AppRoute path=\'/\' basename=\'/\' title=\'产品1\' entry=\'产品1的域名/index.html\' /> : null}\n\n  {产品2的域名 ? <AppRoute path=\'/\' basename=\'/\' title=\'产品2\' entry=\'产品2的域名/index.html\' /> : null}\n</AppRouter>;`, `11002542855579510000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="jsx"\n              >\n                <span class="gatsby-code-button-language">jsx</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">import</span> <span class="token punctuation">{</span> AppRouter<span class="token punctuation">,</span> AppRoute <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@ice/stark\'</span><span class="token punctuation">;</span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">AppRouter</span></span>\n  <span class="token attr-name">NotFoundComponent</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">未找到</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token punctuation">}</span></span>\n  <span class="token attr-name">LoadingComponent</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">加载中</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token punctuation">}</span></span>\n  <span class="token attr-name">onRouteChange</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleRouteChange<span class="token punctuation">}</span></span>\n<span class="token punctuation">></span></span><span class="token plain-text">\n  </span><span class="token punctuation">{</span>产品<span class="token number">1</span>的域名 <span class="token operator">?</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">AppRoute</span></span> <span class="token attr-name">path</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">\'</span>/<span class="token punctuation">\'</span></span> <span class="token attr-name">basename</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">\'</span>/<span class="token punctuation">\'</span></span> <span class="token attr-name">title</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">\'</span>产品1<span class="token punctuation">\'</span></span> <span class="token attr-name">entry</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">\'</span>产品1的域名/index.html<span class="token punctuation">\'</span></span> <span class="token punctuation">/></span></span> <span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">}</span><span class="token plain-text">\n\n  </span><span class="token punctuation">{</span>产品<span class="token number">2</span>的域名 <span class="token operator">?</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">AppRoute</span></span> <span class="token attr-name">path</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">\'</span>/<span class="token punctuation">\'</span></span> <span class="token attr-name">basename</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">\'</span>/<span class="token punctuation">\'</span></span> <span class="token attr-name">title</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">\'</span>产品2<span class="token punctuation">\'</span></span> <span class="token attr-name">entry</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">\'</span>产品2的域名/index.html<span class="token punctuation">\'</span></span> <span class="token punctuation">/></span></span> <span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">}</span><span class="token plain-text">\n</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">AppRouter</span></span><span class="token punctuation">></span></span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="子框架"><a href="#%E5%AD%90%E6%A1%86%E6%9E%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>子框架</h3>\n<h4 id="老项目"><a href="#%E8%80%81%E9%A1%B9%E7%9B%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>老项目</h4>\n<p>老项目采用了 react-router 3.2.1，区别于新项目</p>\n<p>以下是在 ice/stark-app 1.2.0 的版本上开始做的，需要添加代码如下：</p>\n<h5 id="入口文件"><a href="#%E5%85%A5%E5%8F%A3%E6%96%87%E4%BB%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>入口文件</h5>\n<p>app\\app.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="36646015615085470000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import { applyRouterMiddleware, Router, browserHistory, useRouterHistory } from \'react-router\';\nimport { createHistory } from \'history\';\nimport { isInIcestark, getMountNode, registerAppEnter, registerAppLeave, getBasename } from \'@ice/stark-app\';\n\nconst baseHistory = useRouterHistory(createHistory)({\n  basename: getBasename()\n});\n\nconst isIE9 = utils.getBrowserInfo().msie && utils.getBrowserInfo().version === \'9.0\';\n\nconst history = syncHistoryWithStore(baseHistory, store, {\n  selectLocationState: makeSelectLocationState(),\n  adjustUrlOnReplay: isIE9 ? false : undefined\n});\n\nconst router = () => (\n  <ConfigProvider locale={zhCN}>\n    <Provider store={store}>\n      <Router\n        history={history}\n        routes={rootRoute}\n        render={\n          // Scroll to top when going to a new page, imitating default browser behaviour\n          applyRouterMiddleware(useScroll())\n        }\n      />\n    </Provider>\n  </ConfigProvider>\n);\n// 判断是否是开发环境\nif (isInIcestark()) {\n  registerAppEnter(() => {\n    ReactDOM.render(router(), getMountNode());\n  });\n  registerAppLeave(() => {\n    ReactDOM.unmountComponentAtNode(getMountNode());\n  });\n} else {\n  ReactDOM.render(router(), document.getElementById(\'app\'));\n}`, `36646015615085470000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="jsx{1-3,5-7,11,16-38}"\n              >\n                <span class="gatsby-code-button-language">jsx{1-3,5-7,11,16-38}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="gatsby-highlight-code-line"><span class="token keyword">import</span> <span class="token punctuation">{</span> applyRouterMiddleware<span class="token punctuation">,</span> Router<span class="token punctuation">,</span> browserHistory<span class="token punctuation">,</span> useRouterHistory <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react-router\'</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">import</span> <span class="token punctuation">{</span> createHistory <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'history\'</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">import</span> <span class="token punctuation">{</span> isInIcestark<span class="token punctuation">,</span> getMountNode<span class="token punctuation">,</span> registerAppEnter<span class="token punctuation">,</span> registerAppLeave<span class="token punctuation">,</span> getBasename <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@ice/stark-app\'</span><span class="token punctuation">;</span></span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">const</span> baseHistory <span class="token operator">=</span> <span class="token function">useRouterHistory</span><span class="token punctuation">(</span>createHistory<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">  basename<span class="token punctuation">:</span> <span class="token function">getBasename</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="token keyword">const</span> isIE9 <span class="token operator">=</span> utils<span class="token punctuation">.</span><span class="token function">getBrowserInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>msie <span class="token operator">&amp;&amp;</span> utils<span class="token punctuation">.</span><span class="token function">getBrowserInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>version <span class="token operator">===</span> <span class="token string">\'9.0\'</span><span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line"><span class="token keyword">const</span> history <span class="token operator">=</span> <span class="token function">syncHistoryWithStore</span><span class="token punctuation">(</span>baseHistory<span class="token punctuation">,</span> store<span class="token punctuation">,</span> <span class="token punctuation">{</span></span>  selectLocationState<span class="token punctuation">:</span> <span class="token function">makeSelectLocationState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n  adjustUrlOnReplay<span class="token punctuation">:</span> isIE9 <span class="token operator">?</span> <span class="token boolean">false</span> <span class="token punctuation">:</span> <span class="token keyword">undefined</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line"><span class="token keyword">const</span> <span class="token function-variable function">router</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span></span><span class="gatsby-highlight-code-line">  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">ConfigProvider</span></span> <span class="token attr-name">locale</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>zhCN<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text"></span></span><span class="gatsby-highlight-code-line"><span class="token plain-text">    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Provider</span></span> <span class="token attr-name">store</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>store<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text"></span></span><span class="gatsby-highlight-code-line"><span class="token plain-text">      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Router</span></span></span><span class="gatsby-highlight-code-line">        <span class="token attr-name">history</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>history<span class="token punctuation">}</span></span></span><span class="gatsby-highlight-code-line">        <span class="token attr-name">routes</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>rootRoute<span class="token punctuation">}</span></span></span><span class="gatsby-highlight-code-line">        <span class="token attr-name">render</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">          <span class="token comment">// Scroll to top when going to a new page, imitating default browser behaviour</span></span><span class="gatsby-highlight-code-line">          <span class="token function">applyRouterMiddleware</span><span class="token punctuation">(</span><span class="token function">useScroll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line">        <span class="token punctuation">}</span></span></span><span class="gatsby-highlight-code-line">      <span class="token punctuation">/></span></span><span class="token plain-text"></span></span><span class="gatsby-highlight-code-line"><span class="token plain-text">    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Provider</span></span><span class="token punctuation">></span></span><span class="token plain-text"></span></span><span class="gatsby-highlight-code-line"><span class="token plain-text">  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">ConfigProvider</span></span><span class="token punctuation">></span></span></span><span class="gatsby-highlight-code-line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"><span class="token comment">// 判断是否是开发环境</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isInIcestark</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">  <span class="token function">registerAppEnter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token function">router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getMountNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token function">registerAppLeave</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    ReactDOM<span class="token punctuation">.</span><span class="token function">unmountComponentAtNode</span><span class="token punctuation">(</span><span class="token function">getMountNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>  ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token function">router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">\'app\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h5 id="网络请求"><a href="#%E7%BD%91%E7%BB%9C%E8%AF%B7%E6%B1%82" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>网络请求</h5>\n<p>网络请求、资源都需要绝对路径，这就涉及到资源的跨域，需要处理</p>\n<p>app\\utils\\httpFetch.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="3345307803021824000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`export default function httpFetch(url, options) {\n  const newUrl = __COMMON_VARS__.robots + url;\n  // already forced sign out and has shown modal, cancel fetch\n  if (hasShownForcedSignOutModal) {\n    return new Promise((resolve, reject) => {\n      const error = new Error();\n      error.status = 401;\n      reject(error);\n    });\n  }\n  // eslint-disable-next-line no-param-reassign\n  options = {\n    ...options,\n    credentials: \'include\'\n  };\n  return runFetch(newUrl, options).then((response) => checkStatus(response, newUrl, options));\n}`, `3345307803021824000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{2,12-17}"\n              >\n                <span class="gatsby-code-button-language">js{2,12-17}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">httpFetch</span><span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n<span class="gatsby-highlight-code-line">  <span class="token keyword">const</span> newUrl <span class="token operator">=</span> __COMMON_VARS__<span class="token punctuation">.</span>robots <span class="token operator">+</span> url<span class="token punctuation">;</span></span>  <span class="token comment">// already forced sign out and has shown modal, cancel fetch</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>hasShownForcedSignOutModal<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> error <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      error<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">401</span><span class="token punctuation">;</span>\n      <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token comment">// eslint-disable-next-line no-param-reassign</span>\n<span class="gatsby-highlight-code-line">  options <span class="token operator">=</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    <span class="token operator">...</span>options<span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    credentials<span class="token punctuation">:</span> <span class="token string">\'include\'</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">return</span> <span class="token function">runFetch</span><span class="token punctuation">(</span>newUrl<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">checkStatus</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> newUrl<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"><span class="token punctuation">}</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h5 id="webpack-配置"><a href="#webpack-%E9%85%8D%E7%BD%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>webpack 配置</h5>\n<p>internals\\webpack\\webpack.base.babel.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="13520359505363898000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`output: Object.assign({ // Compile into js/build.js\n  path: path.resolve(process.cwd(), \'build\'),\n  publicPath: \\`\\${globalVars.robots}/product1/\\`,\n}, options.output), // Merge with env dependent settings`, `13520359505363898000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{3}"\n              >\n                <span class="gatsby-code-button-language">js{3}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">output<span class="token punctuation">:</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token comment">// Compile into js/build.js</span>\n  path<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">\'build\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n<span class="gatsby-highlight-code-line">  publicPath<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>globalVars<span class="token punctuation">.</span>robots<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/product1/</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span></span><span class="token punctuation">}</span><span class="token punctuation">,</span> options<span class="token punctuation">.</span>output<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// Merge with env dependent settings</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<h5 id="nodejs-服务器配置"><a href="#nodejs-%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%85%8D%E7%BD%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>nodejs 服务器配置</h5>\n<p>server\\index.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="43880699864909040000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 设置允许资源文件跨域访问该服务\napp.all(\'*\', (req, res, next) => {\n  res.header(\'Access-Control-Allow-Origin\', \'*\');\n  next();\n});\n\n// Copy proxy.config.example.json to proxy.config.json to setup proxy\nconst proxy = require(\'http-proxy-middleware\');\nconfig.proxies.forEach((item) => {\n  app.use(\n    item.match,\n    proxy({\n      target: item.host,\n      changeOrigin: true,\n      // 修改响应头信息，实现跨域并允许带cookie\n      onProxyRes(proxyRes, req, res) {\n        res.header(\'Access-Control-Allow-Origin\', req.headers.origin);\n        res.header(\'Access-Control-Allow-Credentials\', \'true\');\n        res.header(\n          \'Access-Control-Allow-Headers\',\n          \'Content-Type, Content-Length, Authorization, Accept, X-Requested-With, Pragma, Cache-Control\'\n        );\n      }\n      // 修改响应信息中的cookie域名\n      // cookieDomainRewrite: \'www.domain1.com\', // 可以为false，表示不修改\n    })\n  );\n});\n\n// In production we need to pass these values in instead of relying on webpack\nsetup(app, {\n  outputPath: resolve(process.cwd(), \'build\'),\n  publicPath: \'/product1\'\n});`, `43880699864909040000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{2-5,13-23}"\n              >\n                <span class="gatsby-code-button-language">js{2-5,13-23}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 设置允许资源文件跨域访问该服务</span>\n<span class="gatsby-highlight-code-line">app<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token string">\'*\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">  res<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">\'Access-Control-Allow-Origin\'</span><span class="token punctuation">,</span> <span class="token string">\'*\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="token comment">// Copy proxy.config.example.json to proxy.config.json to setup proxy</span>\n<span class="token keyword">const</span> proxy <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'http-proxy-middleware\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nconfig<span class="token punctuation">.</span>proxies<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>\n    item<span class="token punctuation">.</span>match<span class="token punctuation">,</span>\n    <span class="token function">proxy</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n<span class="gatsby-highlight-code-line">      target<span class="token punctuation">:</span> item<span class="token punctuation">.</span>host<span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">      changeOrigin<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">      <span class="token comment">// 修改响应头信息，实现跨域并允许带cookie</span></span><span class="gatsby-highlight-code-line">      <span class="token function">onProxyRes</span><span class="token punctuation">(</span><span class="token parameter">proxyRes<span class="token punctuation">,</span> req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">        res<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">\'Access-Control-Allow-Origin\'</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>origin<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">        res<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">\'Access-Control-Allow-Credentials\'</span><span class="token punctuation">,</span> <span class="token string">\'true\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">        res<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span></span><span class="gatsby-highlight-code-line">          <span class="token string">\'Access-Control-Allow-Headers\'</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">          <span class="token string">\'Content-Type, Content-Length, Authorization, Accept, X-Requested-With, Pragma, Cache-Control\'</span></span><span class="gatsby-highlight-code-line">        <span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">      <span class="token punctuation">}</span></span>      <span class="token comment">// 修改响应信息中的cookie域名</span>\n      <span class="token comment">// cookieDomainRewrite: \'www.domain1.com\', // 可以为false，表示不修改</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// In production we need to pass these values in instead of relying on webpack</span>\n<span class="token function">setup</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n  outputPath<span class="token punctuation">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">\'build\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n  publicPath<span class="token punctuation">:</span> <span class="token string">\'/product1\'</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="新项目"><a href="#%E6%96%B0%E9%A1%B9%E7%9B%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>新项目</h4>\n<p>新项目采用了 react-router 3.2.1，相同的部分不再阐述，只有入口文件不同于老项目</p>\n<h5 id="入口文件-1"><a href="#%E5%85%A5%E5%8F%A3%E6%96%87%E4%BB%B6-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>入口文件</h5>\n<p>src\\index.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="56210544606590890000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import { BrowserRouter, Router } from \'react-router-dom\';\nimport { isInIcestark, getMountNode, registerAppEnter, registerAppLeave, getBasename } from \'@ice/stark-app\';\n\nconst router = () => (\n  <Provider {...stores}>\n    <Router history={history}>\n      <BrowserRouter basename={getBasename()}>\n        <ConfigProvider locale={zhCN}>\n          <App />\n        </ConfigProvider>\n      </BrowserRouter>\n    </Router>\n  </Provider>\n);\n\nif (isInIcestark()) {\n  registerAppEnter(() => {\n    ReactDOM.render(router(), getMountNode());\n  });\n  registerAppLeave(() => {\n    ReactDOM.unmountComponentAtNode(getMountNode());\n  });\n} else {\n  ReactDOM.render(router(), document.getElementById(\'app\'), renderCallback);\n}`, `56210544606590890000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> BrowserRouter<span class="token punctuation">,</span> Router <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react-router-dom\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> isInIcestark<span class="token punctuation">,</span> getMountNode<span class="token punctuation">,</span> registerAppEnter<span class="token punctuation">,</span> registerAppLeave<span class="token punctuation">,</span> getBasename <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@ice/stark-app\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">router</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span>\n  <span class="token operator">&lt;</span>Provider <span class="token punctuation">{</span><span class="token operator">...</span>stores<span class="token punctuation">}</span><span class="token operator">></span>\n    <span class="token operator">&lt;</span>Router history<span class="token operator">=</span><span class="token punctuation">{</span>history<span class="token punctuation">}</span><span class="token operator">></span>\n      <span class="token operator">&lt;</span>BrowserRouter basename<span class="token operator">=</span><span class="token punctuation">{</span><span class="token function">getBasename</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">></span>\n        <span class="token operator">&lt;</span>ConfigProvider locale<span class="token operator">=</span><span class="token punctuation">{</span>zhCN<span class="token punctuation">}</span><span class="token operator">></span>\n          <span class="token operator">&lt;</span>App <span class="token operator">/</span><span class="token operator">></span>\n        <span class="token operator">&lt;</span><span class="token operator">/</span>ConfigProvider<span class="token operator">></span>\n      <span class="token operator">&lt;</span><span class="token operator">/</span>BrowserRouter<span class="token operator">></span>\n    <span class="token operator">&lt;</span><span class="token operator">/</span>Router<span class="token operator">></span>\n  <span class="token operator">&lt;</span><span class="token operator">/</span>Provider<span class="token operator">></span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isInIcestark</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token function">registerAppEnter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token function">router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getMountNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token function">registerAppLeave</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    ReactDOM<span class="token punctuation">.</span><span class="token function">unmountComponentAtNode</span><span class="token punctuation">(</span><span class="token function">getMountNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n  ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token function">router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">\'app\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> renderCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="single-spa"><a href="#single-spa" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>single-spa</h2>\n<p>待研究，不过这个框架只兼容 IE 10</p>\n<h2 id="qiankun"><a href="#qiankun" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>qiankun</h2>\n<p>待研究，不过这个框架不兼容 IE</p>\n<h1 id="实现效果"><a href="#%E5%AE%9E%E7%8E%B0%E6%95%88%E6%9E%9C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>实现效果</h1>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2020-04-01-15-21-23-50e18ed9e8a58190e1d4f5b2a5c08911-a54b5.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 590px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 64.7457627118644%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAAAsSAAALEgHS3X78AAAB00lEQVQoz5VSyW4UMRD1n3ADKRFwASkjgRAJgp/hwAUO0QSkRBOisHwCNyTEgQM/BN0zvczSbbvddns3b2YEDAocKD2VS6569iuXiVLKOaeU5ryTUs3KOi/K79ksmxZFNS+qGr6sF4tVA98yrrQRcgDkoImVnNHWm5a1VT1fGTnvWD0rF6qrWFNV1dKoBVJZXqq+xk6x2dGK1vWSHJ9dfPry1TsjpRC9jMEF76xzMTrvLYIUPQJtLFLIGGNDsGETkacvTj58/EzbdrVc0LZJ/2Pk2s2DZ+MJ92nGQyUCVaFVYSVDQY0QquuHf0OR/dHR89PLxqZvNOQ8Mp2oTs2QskYzLlre/wEGiI1fg+yNjk7O30JDL7jsRfwpSQ2G8h6tmh1Y650Pxjpj1iDX7zw4PrtEdUvROA0h7JLxVt79NswVRVrrlKINidy+/2Q8eYNqShmlV8kBHLsxBMMwcM61MSA7kG/cfTierGVzxrquizHukgdtoDPE5FxYt2AxRQ/Bm3YcuXXv8cvzd+CAyRmHzF9kvM2gLaMsz3LoQg2EAFvDSvYODrc3y14Cu7IbkI2Fomk+xbl/mfP+6NGr1+9xIBpGxZYML5XGMPCTjdFCCCnlVfIPo4/KRMQNvrAAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2020 04 01 15 21 23" title="" data-src="/static/2020-04-01-15-21-23-50e18ed9e8a58190e1d4f5b2a5c08911-a54b5.png" data-srcset="/static/2020-04-01-15-21-23-50e18ed9e8a58190e1d4f5b2a5c08911-33798.png 200w,\n/static/2020-04-01-15-21-23-50e18ed9e8a58190e1d4f5b2a5c08911-27c47.png 400w,\n/static/2020-04-01-15-21-23-50e18ed9e8a58190e1d4f5b2a5c08911-a54b5.png 590w" data-sizes="(max-width: 590px) 100vw, 590px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2020-04-01-15-20-24-b013eed670ea4a9ca82aace57e88cb55-b3c03.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 534px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 80.5243445692884%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAIAAACZeshMAAAACXBIWXMAAAsSAAALEgHS3X78AAACVElEQVQoz41SSWsUQRTuX+HFswb0Ii6JXjSBBBQhXgQvoqhgJqhgEj1E8SJ40Ls3vejBn6J4kRgNCDpbd3XPTK9VXXtXdflmJssMOejjo3nvVX/11Vu8khBdVVzILMeM80GctNrddqf7u9lqdoJuEHZ91PHDIOxFvX4Y9X3UK0jJuCBUeM4IDi5LRYm6XYRxZmWUZVm/H1ciSpMojGLFY06idjuAtGYBCkLQsAJ5L169effhU1WpSnPGuNa6NrKCWOnaKq2llMoaZSrJudAKfAE2Sgpv8+Xrt+8/+n4QotD3ffjDOVe7/zLvzPyVlbVNykRJOaFQgeRC7YNN+Ifhnbp4+e6jpzmm0C/4ZsUQo/Df8GZmF26truOS52QIcAqy6wMyDCHLCdsljP09eHNLy42NZ3CQYBkQ92Pg2oVLhRswlwi33cmSNNfG6spWxipVTcI7dvbSzZXHGESIyEQdERtTU6qaaies2/4TxGlOCf765fPW1ndjzFTDzi9du7+2Ccolg2mpPEs67RYt6ei0DhAaJKmo6jgvKS2NtVPkmdn5Ow+eQGGESohhgFrpIa8ezgsmmKXpr8J9iypJcYHJOL9Lnltcbqw/hw6PyYRg2IF9chAgeHaeY0Lo4fl7Jy8sjkYFykMOozSKojF/SEaon2QcVmcvM70kC1cbGwfKsI0FLmBJx8cIhWEvHgtCvVDTJLwjx09fv70KsoRJuB5jXOSFNfZAOc6kFM1mE+6x1tYT5h09ce7GvYewG6BsrIFugbjd6yrUPEhyePbOz51Wq2Wnu/0XEL9jDgSxE6cAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2020 04 01 15 20 24" title="" data-src="/static/2020-04-01-15-20-24-b013eed670ea4a9ca82aace57e88cb55-b3c03.png" data-srcset="/static/2020-04-01-15-20-24-b013eed670ea4a9ca82aace57e88cb55-52a8d.png 200w,\n/static/2020-04-01-15-20-24-b013eed670ea4a9ca82aace57e88cb55-3dc4b.png 400w,\n/static/2020-04-01-15-20-24-b013eed670ea4a9ca82aace57e88cb55-b3c03.png 534w" data-sizes="(max-width: 534px) 100vw, 534px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>',
id:"/home/runner/work/GatsbyBlog/GatsbyBlog/blog/微前端适配demo的实践/index.md absPath of file >>> MarkdownRemark",timeToRead:5,frontmatter:{date:"2020-04-01 09:59:12",path:"/micro-front-end-demo-practice/",tags:"前端, 微前端, 预研",title:"微前端适配demo的实践",draft:null}},{excerpt:"IOS fix 定位不准 现象 在有输入框的情况下尽量不要用 fixed 定位，用 absolute，否则在 IOS 下会出现很多问题，比如输入法收起时 fixed 定位的元素其实还在未收起的地方，会造成在输入法收起时输入框不能点击 解决方案 当然在用 absolute 的时候，需要注意 body、html 的定位（设置为 relative 或者不设），放在 body 的下面等等问题 微信下 IOS13 输入法不恢复 现象 在 IOS1…",html:'<h1 id="ios-fix-定位不准"><a href="#ios-fix-%E5%AE%9A%E4%BD%8D%E4%B8%8D%E5%87%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>IOS fix 定位不准</h1>\n<h2 id="现象"><a href="#%E7%8E%B0%E8%B1%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>现象</h2>\n<p>在有输入框的情况下尽量不要用 fixed 定位，用 absolute，否则在 IOS 下会出现很多问题，比如输入法收起时 fixed 定位的元素其实还在未收起的地方，会造成在输入法收起时输入框不能点击</p>\n<h2 id="解决方案"><a href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>解决方案</h2>\n<p>当然在用 absolute 的时候，需要注意 body、html 的定位（设置为 relative 或者不设），放在 body 的下面等等问题</p>\n<h1 id="微信下-ios13-输入法不恢复"><a href="#%E5%BE%AE%E4%BF%A1%E4%B8%8B-ios13-%E8%BE%93%E5%85%A5%E6%B3%95%E4%B8%8D%E6%81%A2%E5%A4%8D" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>微信下 IOS13 输入法不恢复</h1>\n<h2 id="现象-1"><a href="#%E7%8E%B0%E8%B1%A1-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>现象</h2>\n<p>在 IOS13 系统下，点击输入框弹出输入法，再收起输入法时会发现输入法回去了，整个页面留下输入法的空白，上下滑动一下布局恢复正常</p>\n<h2 id="解决方案-1"><a href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>解决方案</h2>\n<p>在微信端的输入法键盘收起时滑动一下页面</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="57437904575804150000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`let currentPosition;\nconst speed = 1; // 页面滚动距离\nconst timer = setInterval(() => {\n  currentPosition = document.documentElement.scrollTop || document.body.scrollTop;\n  currentPosition -= speed;\n  window.scrollTo(0, currentPosition); // 页面向上滚动\n  currentPosition += speed; // speed变量\n  window.scrollTo(0, currentPosition); // 页面向下滚动\n  clearInterval(timer);\n}, 1);`, `57437904575804150000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">let</span> currentPosition<span class="token punctuation">;</span>\n<span class="token keyword">const</span> speed <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 页面滚动距离</span>\n<span class="token keyword">const</span> timer <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  currentPosition <span class="token operator">=</span> document<span class="token punctuation">.</span>documentElement<span class="token punctuation">.</span>scrollTop <span class="token operator">||</span> document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>scrollTop<span class="token punctuation">;</span>\n  currentPosition <span class="token operator">-=</span> speed<span class="token punctuation">;</span>\n  window<span class="token punctuation">.</span><span class="token function">scrollTo</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> currentPosition<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 页面向上滚动</span>\n  currentPosition <span class="token operator">+=</span> speed<span class="token punctuation">;</span> <span class="token comment">// speed变量</span>\n  window<span class="token punctuation">.</span><span class="token function">scrollTo</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> currentPosition<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 页面向下滚动</span>\n  <span class="token function">clearInterval</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="移动端输入法收起时布局不恢复"><a href="#%E7%A7%BB%E5%8A%A8%E7%AB%AF%E8%BE%93%E5%85%A5%E6%B3%95%E6%94%B6%E8%B5%B7%E6%97%B6%E5%B8%83%E5%B1%80%E4%B8%8D%E6%81%A2%E5%A4%8D" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>移动端输入法收起时布局不恢复</h1>\n<h2 id="现象-2"><a href="#%E7%8E%B0%E8%B1%A1-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>现象</h2>\n<p>移动端网站打开输入法后再收起，此时还会保持在打开输入法时的布局</p>\n<h2 id="产生原因"><a href="#%E4%BA%A7%E7%94%9F%E5%8E%9F%E5%9B%A0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>产生原因</h2>\n<p>我们在 app 布局中会有个固定的底部，安卓一些版本中，输入弹窗出来，将挤压 absolute 和 fixed 定位的元素，导致可视区域变小，布局错乱。</p>\n<h2 id="解决方案-2"><a href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>解决方案</h2>\n<h3 id="收起时置为初始位置"><a href="#%E6%94%B6%E8%B5%B7%E6%97%B6%E7%BD%AE%E4%B8%BA%E5%88%9D%E5%A7%8B%E4%BD%8D%E7%BD%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>收起时置为初始位置</h3>\n<p>在输入法键盘收起时将窗口置为初始位置</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="91312470127724790000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`setTimeout(() => {\n  if (document.body) {\n    document.body.scrollTop = 0;\n  }\n}, 100);`, `91312470127724790000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>document<span class="token punctuation">.</span>body<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>scrollTop <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="监听页面高度变化，强制恢复成弹出前的高度"><a href="#%E7%9B%91%E5%90%AC%E9%A1%B5%E9%9D%A2%E9%AB%98%E5%BA%A6%E5%8F%98%E5%8C%96%EF%BC%8C%E5%BC%BA%E5%88%B6%E6%81%A2%E5%A4%8D%E6%88%90%E5%BC%B9%E5%87%BA%E5%89%8D%E7%9A%84%E9%AB%98%E5%BA%A6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>监听页面高度变化，强制恢复成弹出前的高度</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="1337041118792581400"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 记录原有的视口高度\nconst originalHeight = document.body.clientHeight || document.documentElement.clientHeight;\n\nwindow.onresize = function() {\n  var resizeHeight = document.documentElement.clientHeight || document.body.clientHeight;\n  if (resizeHeight < originalHeight) {\n    // 恢复内容区域高度\n    // const container = document.getElementById(&quot;container&quot;)\n    // 例如 container.style.height = originalHeight;\n  }\n};`, `1337041118792581400`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 记录原有的视口高度</span>\n<span class="token keyword">const</span> originalHeight <span class="token operator">=</span> document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>clientHeight <span class="token operator">||</span> document<span class="token punctuation">.</span>documentElement<span class="token punctuation">.</span>clientHeight<span class="token punctuation">;</span>\n\nwindow<span class="token punctuation">.</span><span class="token function-variable function">onresize</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> resizeHeight <span class="token operator">=</span> document<span class="token punctuation">.</span>documentElement<span class="token punctuation">.</span>clientHeight <span class="token operator">||</span> document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>clientHeight<span class="token punctuation">;</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>resizeHeight <span class="token operator">&lt;</span> originalHeight<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 恢复内容区域高度</span>\n    <span class="token comment">// const container = document.getElementById("container")</span>\n    <span class="token comment">// 例如 container.style.height = originalHeight;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>键盘不能回落问题出现在 iOS 12+ 和 wechat 6.7.4+ 中，而在微信 H5 开发中是比较常见的 Bug。</p>\n<p>兼容原理：</p>\n<ol>\n<li>判断版本类型</li>\n<li>更改滚动的可视区域</li>\n</ol>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="54176707696221430000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const isWechat = window.navigator.userAgent.match(/MicroMessenger\\/([\\d\\.]+)/i);\nif (!isWechat) return;\nconst wechatVersion = wechatInfo[1];\nconst version = navigator.appVersion.match(/OS (\\d+)_(\\d+)_?(\\d+)?/);\n\n// 如果设备类型为iOS 12+ 和wechat 6.7.4+，恢复成原来的视口\nif (+wechatVersion.replace(/\\./g, \'\') >= 674 && +version[1] >= 12) {\n  window.scrollTo(0, Math.max(document.body.clientHeight, document.documentElement.clientHeight));\n}`, `54176707696221430000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> isWechat <span class="token operator">=</span> window<span class="token punctuation">.</span>navigator<span class="token punctuation">.</span>userAgent<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex">/MicroMessenger\\/([\\d\\.]+)/i</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isWechat<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> wechatVersion <span class="token operator">=</span> wechatInfo<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> version <span class="token operator">=</span> navigator<span class="token punctuation">.</span>appVersion<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex">/OS (\\d+)_(\\d+)_?(\\d+)?/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 如果设备类型为iOS 12+ 和wechat 6.7.4+，恢复成原来的视口</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">+</span>wechatVersion<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\\./g</span><span class="token punctuation">,</span> <span class="token string">\'\'</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">674</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">+</span>version<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">>=</span> <span class="token number">12</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  window<span class="token punctuation">.</span><span class="token function">scrollTo</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>clientHeight<span class="token punctuation">,</span> document<span class="token punctuation">.</span>documentElement<span class="token punctuation">.</span>clientHeight<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<blockquote>\n<p>window.scrollTo(x-coord, y-coord)，其中 window.scrollTo(0, clientHeight)恢复成原来的视口</p>\n</blockquote>\n<h1 id="ios-第三方输入法会遮挡（不完美）"><a href="#ios-%E7%AC%AC%E4%B8%89%E6%96%B9%E8%BE%93%E5%85%A5%E6%B3%95%E4%BC%9A%E9%81%AE%E6%8C%A1%EF%BC%88%E4%B8%8D%E5%AE%8C%E7%BE%8E%EF%BC%89" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>IOS 第三方输入法会遮挡（不完美）</h1>\n<h2 id="现象-3"><a href="#%E7%8E%B0%E8%B1%A1-3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>现象</h2>\n<p>IOS 第三方输入法比如搜狗，打开输入法时工具栏会遮挡输入框</p>\n<h2 id="解决方案-3"><a href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>解决方案</h2>\n<p>在输入法键盘打开时，强制滚动到输入框的焦点，此方案在移动端浏览器会造成布局的错乱</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="84090372226739980000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 会造成移动端bug，暂时不用\nconst timer = setInterval(function() {\n  element.scrollIntoView(true);\n  clearInterval(timer);\n}, 100);`, `84090372226739980000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 会造成移动端bug，暂时不用</span>\n<span class="token keyword">const</span> timer <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  element<span class="token punctuation">.</span><span class="token function">scrollIntoView</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token function">clearInterval</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="ios-滑动不流畅"><a href="#ios-%E6%BB%91%E5%8A%A8%E4%B8%8D%E6%B5%81%E7%95%85" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>IOS 滑动不流畅</h1>\n<h2 id="现象-4"><a href="#%E7%8E%B0%E8%B1%A1-4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>现象</h2>\n<p>上下滑动页面会产生卡顿，手指离开页面，页面立即停止运动，整体表现就是滑动不流畅，没有滑动惯性。</p>\n<h2 id="产生原因-1"><a href="#%E4%BA%A7%E7%94%9F%E5%8E%9F%E5%9B%A0-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>产生原因</h2>\n<p>在 iOS 5.0 以及之后的版本，滑动有定义有两个值 auto 和 touch，默认值为 auto。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="85168308780053170000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`-webkit-overflow-scrolling: touch; /* 当手指从触摸屏上移开，会保持一段时间的滚动 */\n-webkit-overflow-scrolling: auto; /* 当手指从触摸屏上移开，滚动会立即停止 */`, `85168308780053170000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="css"\n              >\n                <span class="gatsby-code-button-language">css</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="css"><pre style="counter-reset: linenumber NaN" class="language-css line-numbers"><code class="language-css"><span class="token property">-webkit-overflow-scrolling</span><span class="token punctuation">:</span> touch<span class="token punctuation">;</span> <span class="token comment">/* 当手指从触摸屏上移开，会保持一段时间的滚动 */</span>\n<span class="token property">-webkit-overflow-scrolling</span><span class="token punctuation">:</span> auto<span class="token punctuation">;</span> <span class="token comment">/* 当手指从触摸屏上移开，滚动会立即停止 */</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<h2 id="解决方案-4"><a href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>解决方案</h2>\n<h3 id="在滚动容器上增加滚动-touch-方法"><a href="#%E5%9C%A8%E6%BB%9A%E5%8A%A8%E5%AE%B9%E5%99%A8%E4%B8%8A%E5%A2%9E%E5%8A%A0%E6%BB%9A%E5%8A%A8-touch-%E6%96%B9%E6%B3%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>在滚动容器上增加滚动 touch 方法</h3>\n<p>将 -webkit-overflow-scrolling 值设置为 touch，同时要设置滚动条隐藏 .container ::-webkit-scrollbar {display: none;}</p>\n<p>可能会导致使用 position:fixed; 固定定位的元素，随着页面一起滚动</p>\n<h3 id="设置-overflow"><a href="#%E8%AE%BE%E7%BD%AE-overflow" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>设置 overflow</h3>\n<p>设置外部 overflow 为 hidden,设置内容元素 overflow 为 auto。内部元素超出 body 即产生滚动，超出的部分 body 隐藏。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="38783793230261620000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`body {\n  overflow-y: hidden;\n}\n\n.wrapper {\n  overflow-y: auto;\n}`, `38783793230261620000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="css"\n              >\n                <span class="gatsby-code-button-language">css</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="css"><pre style="counter-reset: linenumber NaN" class="language-css line-numbers"><code class="language-css"><span class="token selector">body</span> <span class="token punctuation">{</span>\n  <span class="token property">overflow-y</span><span class="token punctuation">:</span> hidden<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token selector">.wrapper</span> <span class="token punctuation">{</span>\n  <span class="token property">overflow-y</span><span class="token punctuation">:</span> auto<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="ios-上拉边界下拉出现白色空白"><a href="#ios-%E4%B8%8A%E6%8B%89%E8%BE%B9%E7%95%8C%E4%B8%8B%E6%8B%89%E5%87%BA%E7%8E%B0%E7%99%BD%E8%89%B2%E7%A9%BA%E7%99%BD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>iOS 上拉边界下拉出现白色空白</h1>\n<h2 id="现象-5"><a href="#%E7%8E%B0%E8%B1%A1-5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>现象</h2>\n<p>手指按住屏幕下拉，屏幕顶部会多出一块白色区域。手指按住屏幕上拉，底部多出一块白色区域。</p>\n<h2 id="产生原因-2"><a href="#%E4%BA%A7%E7%94%9F%E5%8E%9F%E5%9B%A0-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>产生原因</h2>\n<p>在 iOS 中，手指按住屏幕上下拖动，会触发 touchmove 事件。这个事件触发的对象是整个 webview 容器，容器自然会被拖动，剩下的部分会成空白。</p>\n<h2 id="解决方案-5"><a href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>解决方案</h2>\n<h3 id="监听事件禁止滑动"><a href="#%E7%9B%91%E5%90%AC%E4%BA%8B%E4%BB%B6%E7%A6%81%E6%AD%A2%E6%BB%91%E5%8A%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>监听事件禁止滑动</h3>\n<p>移动端触摸事件有三个，分别定义为</p>\n<ol>\n<li>touchstart ：手指放在一个 DOM 元素上。</li>\n<li>touchmove ：手指拖曳一个 DOM 元素。</li>\n<li>touchend ：手指从一个 DOM 元素上移开。</li>\n</ol>\n<p>touchmove 事件的速度是可以实现定义的，取决于硬件性能和其他实现细节，同时 preventDefault 方法，阻止同一触点上所有默认行为，比如滚动。</p>\n<p>由此我们找到解决方案，通过监听 touchmove，让需要滑动的地方滑动，不需要滑动的地方禁止滑动。</p>\n<blockquote>\n<p>值得注意的是我们要过滤掉具有滚动容器的元素。</p>\n</blockquote>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="62088866064867230000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`document.body.addEventListener(\n  \'touchmove\',\n  function(e) {\n    if (e._isScroller) return;\n    // 阻止默认事件\n    e.preventDefault();\n  },\n  {\n    // 防止 treated as passive 报错\n    passive: false\n  }\n);`, `62088866064867230000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>\n  <span class="token string">\'touchmove\'</span><span class="token punctuation">,</span>\n  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>_isScroller<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>\n    <span class="token comment">// 阻止默认事件</span>\n    e<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token punctuation">{</span>\n    <span class="token comment">// 防止 treated as passive 报错</span>\n    passive<span class="token punctuation">:</span> <span class="token boolean">false</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="滚动妥协填充空白，装饰成其他功能"><a href="#%E6%BB%9A%E5%8A%A8%E5%A6%A5%E5%8D%8F%E5%A1%AB%E5%85%85%E7%A9%BA%E7%99%BD%EF%BC%8C%E8%A3%85%E9%A5%B0%E6%88%90%E5%85%B6%E4%BB%96%E5%8A%9F%E8%83%BD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>滚动妥协填充空白，装饰成其他功能</h3>\n<p>在很多时候，我们可以不去解决这个问题，换思路。根据场景，我们可以将下拉作为一个功能性的操作。</p>\n<p>比如下拉后刷新页面</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2020-01-20-12-01-46-7d5f6a4ff26e7f55cbf8635f25235b6c-dcb0e.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 614px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 31.27035830618893%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsSAAALEgHS3X78AAABHElEQVQY03XMu07DMBQGYA99A5rCRELKxMBr0CDBAi/AglA3LuVW7mKgFNgQD4ZQkbh1QG2TNoHYjuNMP3YIbQRi+PT/9tE5hFGK/1AajoThr9ko8wjlETSWo99cxHjvdNF6fMLzaxsvb23cP7TQHwTgkfiz84Mw34VGdQYeqJb1cNDDh9vBZ7+bClTXf8z3sh0v4w4R2ZhGclGGPJ9CfGZCKDqjU2uIn5jgxxbEkeqHJljKAjuwQesWqM602yBilUCsEMj1ApK9MWUCcrekGGnGOwbEtlIzEG8ZiDa1kjKOaOMbrxYQrhGE6hYJFovozRbBqjbk3TLk7RKS6zkkN44yr7oDeVVB3FQuHYi8RgWiuQBen4G/X0ZQm8QXfER+fesjNGAAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2020 01 20 12 01 46" title="" data-src="/static/2020-01-20-12-01-46-7d5f6a4ff26e7f55cbf8635f25235b6c-dcb0e.png" data-srcset="/static/2020-01-20-12-01-46-7d5f6a4ff26e7f55cbf8635f25235b6c-2d24e.png 200w,\n/static/2020-01-20-12-01-46-7d5f6a4ff26e7f55cbf8635f25235b6c-fa3d3.png 400w,\n/static/2020-01-20-12-01-46-7d5f6a4ff26e7f55cbf8635f25235b6c-dcb0e.png 614w" data-sizes="(max-width: 614px) 100vw, 614px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h1 id="页面放大或缩小不确定性行为"><a href="#%E9%A1%B5%E9%9D%A2%E6%94%BE%E5%A4%A7%E6%88%96%E7%BC%A9%E5%B0%8F%E4%B8%8D%E7%A1%AE%E5%AE%9A%E6%80%A7%E8%A1%8C%E4%B8%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>页面放大或缩小不确定性行为</h1>\n<h2 id="现象-6"><a href="#%E7%8E%B0%E8%B1%A1-6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>现象</h2>\n<p>双击或者双指张开手指页面元素，页面会放大或缩小。</p>\n<h2 id="产生原因-3"><a href="#%E4%BA%A7%E7%94%9F%E5%8E%9F%E5%9B%A0-3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>产生原因</h2>\n<p>HTML 本身会产生放大或缩小的行为，比如在 PC 浏览器上，可以自由控制页面的放大缩小。但是在移动端，我们是不需要这个行为的。所以，我们需要禁止该不确定性行为，来提升用户体验。</p>\n<h2 id="解决方案-6"><a href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>解决方案</h2>\n<p>HTML meta 元标签标准中有个 viewport 属性，用来控制页面的缩放，一般用于移动端。</p>\n<p>移动端常用写法</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="15060243765322490000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot; />`, `15060243765322490000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="html"\n              >\n                <span class="gatsby-code-button-language">html</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="html"><pre style="counter-reset: linenumber NaN" class="language-html line-numbers"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>width=device-width, initial-scale=1.0<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>因此我们可以设置 maximum-scale、minimum-scale 与 user-scalable=no 用来避免这个问题</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="62637985953252410000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<meta\n  name=&quot;viewport&quot;\n  content=&quot;width=device-width, initial-scale=1.0, minimum-scale=1.0 maximum-scale=1.0, user-scalable=no&quot;\n/>`, `62637985953252410000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="html"\n              >\n                <span class="gatsby-code-button-language">html</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="html"><pre style="counter-reset: linenumber NaN" class="language-html line-numbers"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span>\n  <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span>\n  <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>width=device-width, initial-scale=1.0, minimum-scale=1.0 maximum-scale=1.0, user-scalable=no<span class="token punctuation">"</span></span>\n<span class="token punctuation">/></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="click-点击事件延时与穿透"><a href="#click-%E7%82%B9%E5%87%BB%E4%BA%8B%E4%BB%B6%E5%BB%B6%E6%97%B6%E4%B8%8E%E7%A9%BF%E9%80%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>click 点击事件延时与穿透</h1>\n<h2 id="现象-7"><a href="#%E7%8E%B0%E8%B1%A1-7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>现象</h2>\n<p>监听元素 click 事件，点击元素触发时间延迟约 300ms。</p>\n<p>点击蒙层，蒙层消失后，下层元素点击触发。</p>\n<h2 id="产生原因-4"><a href="#%E4%BA%A7%E7%94%9F%E5%8E%9F%E5%9B%A0-4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>产生原因</h2>\n<h3 id="点击延时"><a href="#%E7%82%B9%E5%87%BB%E5%BB%B6%E6%97%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>点击延时</h3>\n<p>iOS 中的 safari，为了实现双击缩放操作，在单击 300ms 之后，如果未进行第二次点击，则执行 click 单击操作。也就是说来判断用户行为是否为双击产生的。但是，在 App 中，无论是否需要双击缩放这种行为，click 单击都会产生 300ms 延迟。</p>\n<h3 id="点击穿透"><a href="#%E7%82%B9%E5%87%BB%E7%A9%BF%E9%80%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>点击穿透</h3>\n<p>双层元素叠加时，在上层元素上绑定 touch 事件，下层元素绑定 click 事件。由于 click 发生在 touch 之后，点击上层元素，元素消失，下层元素会触发 click 事件，由此产生了点击穿透的效果。</p>\n<h2 id="解决方案-7"><a href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>解决方案</h2>\n<h3 id="使用-touchstart-替换-click"><a href="#%E4%BD%BF%E7%94%A8-touchstart-%E6%9B%BF%E6%8D%A2-click" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用 touchstart 替换 click</h3>\n<p>移动设备不仅支持点击，还支持几个触摸事件。那么我们现在基本思路就是用 touch 事件代替 click 事件。将 click 替换成 touchstart 不仅解决了 click 事件都延时问题，还解决了穿透问题。因为穿透问题是在 touch 和 click 混用时产生。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="3058882805475815400"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`el.addEventListener(\n  \'touchstart\',\n  () => {\n    console.log(\'ok\');\n  },\n  false\n);`, `3058882805475815400`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">el<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>\n  <span class="token string">\'touchstart\'</span><span class="token punctuation">,</span>\n  <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'ok\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token boolean">false</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>那么，是否可以将 click 事件全部替换成 touchstart 呢？为什么开源框架还会给出 click 事件呢？</p>\n<p>我们想象一种情景，同时需要点击和滑动的场景下。如果将 click 替换成 touchstart 会怎样？</p>\n<blockquote>\n<p>事件触发顺序: touchstart, touchmove, touchend, click。</p>\n</blockquote>\n<p>很容易想象，在我需要 touchmove 滑动时候，优先触发了 touchstart 的点击事件，是不是已经产生了冲突呢？</p>\n<p>所以呢，在具有滚动的情况下，还是建议使用 click 处理。</p>\n<p>在接下来的 fastclick 开源库中也做了如下处理。 针对 touchstart 和 touchend，截取了部分源码。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="1189275300610304000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// If the target element is a child of a scrollable layer (using -webkit-overflow-scrolling: touch) and:\n// 1) the user does a fling scroll on the scrollable layer\n// 2) the user stops the fling scroll with another tap\n// then the event.target of the last \'touchend\' event will be the element that was under the user\'s finger\n// when the fling scroll was started, causing FastClick to send a click event to that layer - unless a check\n// is made to ensure that a parent layer was not scrolled before sending a synthetic click (issue #42).\nthis.updateScrollParent(targetElement);`, `1189275300610304000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// If the target element is a child of a scrollable layer (using -webkit-overflow-scrolling: touch) and:</span>\n<span class="token comment">// 1) the user does a fling scroll on the scrollable layer</span>\n<span class="token comment">// 2) the user stops the fling scroll with another tap</span>\n<span class="token comment">// then the event.target of the last \'touchend\' event will be the element that was under the user\'s finger</span>\n<span class="token comment">// when the fling scroll was started, causing FastClick to send a click event to that layer - unless a check</span>\n<span class="token comment">// is made to ensure that a parent layer was not scrolled before sending a synthetic click (issue #42).</span>\n<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateScrollParent</span><span class="token punctuation">(</span>targetElement<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="21016862755632837000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// Don\'t send a synthetic click event if the target element is contained within a parent layer that was scrolled\n// and this tap is being used to stop the scrolling (usually initiated by a fling - issue #42).\nscrollParent = targetElement.fastClickScrollParent;\nif (scrollParent && scrollParent.fastClickLastScrollTop !== scrollParent.scrollTop) {\n  return true;\n}`, `21016862755632837000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// Don\'t send a synthetic click event if the target element is contained within a parent layer that was scrolled</span>\n<span class="token comment">// and this tap is being used to stop the scrolling (usually initiated by a fling - issue #42).</span>\nscrollParent <span class="token operator">=</span> targetElement<span class="token punctuation">.</span>fastClickScrollParent<span class="token punctuation">;</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span>scrollParent <span class="token operator">&amp;&amp;</span> scrollParent<span class="token punctuation">.</span>fastClickLastScrollTop <span class="token operator">!==</span> scrollParent<span class="token punctuation">.</span>scrollTop<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>主要目的就是，在使用 touchstart 合成 click 事件时，保证其不在滚动的父元素之下。</p>\n<h3 id="使用-fastclick-库"><a href="#%E4%BD%BF%E7%94%A8-fastclick-%E5%BA%93" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用 fastclick 库</h3>\n<p>使用 npm/yarn 安装后使用</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="61133903946502820000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import FastClick from \'fastclick\';\nFastClick.attach(document.body, options);`, `61133903946502820000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> FastClick <span class="token keyword">from</span> <span class="token string">\'fastclick\'</span><span class="token punctuation">;</span>\nFastClick<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>body<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>同样，使用 fastclick 库后，click 延时和穿透问题都没了</p>\n<h1 id="iphone-x-系列安全区域适配问题"><a href="#iphone-x-%E7%B3%BB%E5%88%97%E5%AE%89%E5%85%A8%E5%8C%BA%E5%9F%9F%E9%80%82%E9%85%8D%E9%97%AE%E9%A2%98" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>iPhone X 系列安全区域适配问题</h1>\n<h2 id="现象-8"><a href="#%E7%8E%B0%E8%B1%A1-8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>现象</h2>\n<p>头部刘海两侧区域或者底部区域，出现刘海遮挡文字，或者呈现黑底或白底空白区域。</p>\n<h2 id="产生原因-5"><a href="#%E4%BA%A7%E7%94%9F%E5%8E%9F%E5%9B%A0-5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>产生原因</h2>\n<p>iPhone X 以及它以上的系列，都采用刘海屏设计和全面屏手势。头部、底部、侧边都需要做特殊处理。才能适配 iPhone X 的特殊情况。</p>\n<h2 id="解决方案-8"><a href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>解决方案</h2>\n<h3 id="设置安全区域"><a href="#%E8%AE%BE%E7%BD%AE%E5%AE%89%E5%85%A8%E5%8C%BA%E5%9F%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>设置安全区域</h3>\n<p>设置安全区域，填充危险区域，危险区域不做操作和内容展示。</p>\n<blockquote>\n<p>危险区域指头部不规则区域，底部横条区域，左右触发区域。</p>\n</blockquote>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2020-01-20-15-07-08-28a59afa2699784aa29c868cd0c408d4-b1028.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 622px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 55.30546623794211%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsSAAALEgHS3X78AAABgElEQVQoz42SyU7DMBCG8/7vQ0uStnCBbsClvYBQE7ux431JaBsnRWLSBSEhJCZ/Rpbtz7PYUeU8mLXWGOOd+6jrtuva/1mEEZkRNS31Y6kXWEgmu+NPuOvP+q223xNtsiJBMiE6pmaccV6KI8Ch55oA36FtDuEAvvmp0MAfos1mO8JyRHRKzV3OS8K6M9y1XtsVZnMi5gVfUvl01YLK9VYYoaI8Jz1MzRkWpTx+HiFsaEOl7EPGhtTEBKTPHnIcED1F0jARIUQBHrwXg4wCzCj33tV921pYnuUsJXoCeWFx84bBT078AokLnGKZFiolapJzzgS0A4qFxGvjHjJ+S21CTFLoeCvjfpseEj3D0nJ5gb9rvjTsZE7p14KtSrmm4hkVywy/YLpmcsXUK+GS8R5OIDIkQ83kCodTt/f7fQUleFc5kFWCw/ijqkCV97vdLkI5GSOoRI2Jus8YL/l35O56q2BwWlXX4TR7veo2stpq56mANittIYL/64V1v+a/AG8FXddApeGYAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2020 01 20 15 07 08" title="" data-src="/static/2020-01-20-15-07-08-28a59afa2699784aa29c868cd0c408d4-b1028.png" data-srcset="/static/2020-01-20-15-07-08-28a59afa2699784aa29c868cd0c408d4-2de4f.png 200w,\n/static/2020-01-20-15-07-08-28a59afa2699784aa29c868cd0c408d4-73fe9.png 400w,\n/static/2020-01-20-15-07-08-28a59afa2699784aa29c868cd0c408d4-b1028.png 622w" data-sizes="(max-width: 622px) 100vw, 622px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>具体操作为：viewport-fit meta 标签设置为 cover，获取所有区域填充。 判断设备是否属于 iPhone X，给头部底部增加适配层</p>\n<p>viewport-fit 有 3 个值分别为：</p>\n<ul>\n<li>auto：此值不影响初始布局视图端口，并且整个 web 页面都是可查看的。</li>\n<li>contain：视图端口按比例缩放，以适合显示内嵌的最大矩形。</li>\n<li>cover：视图端口被缩放以填充设备显示。强烈建议使用 safe-area-inset 变量，以确保重要内容不会出现在显示之外。</li>\n</ul>\n<h4 id="设置-viewport-fit-为-cover"><a href="#%E8%AE%BE%E7%BD%AE-viewport-fit-%E4%B8%BA-cover" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>设置 viewport-fit 为 cover</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="54895506493401800000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0, user-scalable=yes, viewport-fit=cover&quot; />`, `54895506493401800000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="html"\n              >\n                <span class="gatsby-code-button-language">html</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="html"><pre style="counter-reset: linenumber NaN" class="language-html line-numbers"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>width=device-width, initial-scale=1.0, user-scalable=yes, viewport-fit=cover<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h4 id="增加适配层"><a href="#%E5%A2%9E%E5%8A%A0%E9%80%82%E9%85%8D%E5%B1%82" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>增加适配层</h4>\n<p>使用 safe-area-inset 变量</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="53955360098803974000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`/* 适配 iPhone X 顶部填充*/\n@supports (top: env(safe-area-inset-top)) {\n  body,\n  .header {\n    padding-top: constant(safe-area-inset-top, 40px);\n    padding-top: env(safe-area-inset-top, 40px);\n    padding-top: var(safe-area-inset-top, 40px);\n  }\n}\n\n/* 判断 iPhoneX 将 footer 的 padding-bottom 填充到最底部 */\n@supports (bottom: env(safe-area-inset-bottom)) {\n  body,\n  .footer {\n    padding-bottom: constant(safe-area-inset-bottom, 20px);\n    padding-bottom: env(safe-area-inset-bottom, 20px);\n    padding-top: var(safe-area-inset-bottom, 20px);\n  }\n}`, `53955360098803974000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="css"\n              >\n                <span class="gatsby-code-button-language">css</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="css"><pre style="counter-reset: linenumber NaN" class="language-css line-numbers"><code class="language-css"><span class="token comment">/* 适配 iPhone X 顶部填充*/</span>\n<span class="token atrule"><span class="token rule">@supports</span> <span class="token punctuation">(</span><span class="token property">top</span><span class="token punctuation">:</span> <span class="token function">env</span><span class="token punctuation">(</span>safe-area-inset-top<span class="token punctuation">)</span><span class="token punctuation">)</span></span> <span class="token punctuation">{</span>\n  <span class="token selector">body,\n  .header</span> <span class="token punctuation">{</span>\n    <span class="token property">padding-top</span><span class="token punctuation">:</span> <span class="token function">constant</span><span class="token punctuation">(</span>safe-area-inset-top<span class="token punctuation">,</span> 40px<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token property">padding-top</span><span class="token punctuation">:</span> <span class="token function">env</span><span class="token punctuation">(</span>safe-area-inset-top<span class="token punctuation">,</span> 40px<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token property">padding-top</span><span class="token punctuation">:</span> <span class="token function">var</span><span class="token punctuation">(</span>safe-area-inset-top<span class="token punctuation">,</span> 40px<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">/* 判断 iPhoneX 将 footer 的 padding-bottom 填充到最底部 */</span>\n<span class="token atrule"><span class="token rule">@supports</span> <span class="token punctuation">(</span><span class="token property">bottom</span><span class="token punctuation">:</span> <span class="token function">env</span><span class="token punctuation">(</span>safe-area-inset-bottom<span class="token punctuation">)</span><span class="token punctuation">)</span></span> <span class="token punctuation">{</span>\n  <span class="token selector">body,\n  .footer</span> <span class="token punctuation">{</span>\n    <span class="token property">padding-bottom</span><span class="token punctuation">:</span> <span class="token function">constant</span><span class="token punctuation">(</span>safe-area-inset-bottom<span class="token punctuation">,</span> 20px<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token property">padding-bottom</span><span class="token punctuation">:</span> <span class="token function">env</span><span class="token punctuation">(</span>safe-area-inset-bottom<span class="token punctuation">,</span> 20px<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token property">padding-top</span><span class="token punctuation">:</span> <span class="token function">var</span><span class="token punctuation">(</span>safe-area-inset-bottom<span class="token punctuation">,</span> 20px<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<blockquote>\n<p>safe-area-inset-top, safe-area-inset-right, safe-area-inset-bottom, safe-area-inset-left, safe-area-inset-*由四个定义了视口边缘内矩形的 top, right, bottom 和 left 的环境变量组成，这样可以安全地放入内容，而不会有被非矩形的显示切断的风险。对于矩形视口，例如普通的笔记本电脑显示器，其值等于零。 对于非矩形显示器（如圆形表盘，iPhoneX 屏幕），在用户代理设置的四个值形成的矩形内，所有内容均可见。</p>\n</blockquote>\n<p>其中 env() 用法为 <code class="language-text">env( &lt;custom-ident&gt; , &lt;declaration-value&gt;? )</code>，第一个参数为自定义的区域，第二个为备用值。</p>\n<p>其中 var() 用法为 <code class="language-text">var( &lt;custom-property-name&gt; , &lt;declaration-value&gt;? )</code>，作用是在 env() 不生效的情况下，给出一个备用值。</p>\n<p><code class="language-text">constant()</code> 被 css 2017-2018 年为草稿阶段，是否已被标准化未知。而其他 iOS 浏览器版本中是否有此函数未知，作为兼容处理而添加进去。</p>\n<h1 id="页面生成为图片和二维码问题"><a href="#%E9%A1%B5%E9%9D%A2%E7%94%9F%E6%88%90%E4%B8%BA%E5%9B%BE%E7%89%87%E5%92%8C%E4%BA%8C%E7%BB%B4%E7%A0%81%E9%97%AE%E9%A2%98" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>页面生成为图片和二维码问题</h1>\n<h2 id="现象-9"><a href="#%E7%8E%B0%E8%B1%A1-9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>现象</h2>\n<p>在工作中有需要将页面生成图片或者二维码的需求。可能我们第一想到的，交给后端来生成更简单。但是这样我们需要把页面代码全部传给后端，网络性能消耗太大。</p>\n<h2 id="解决方案-9"><a href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>解决方案</h2>\n<h3 id="生成二维码"><a href="#%E7%94%9F%E6%88%90%E4%BA%8C%E7%BB%B4%E7%A0%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>生成二维码</h3>\n<p>使用 QRCode 生成二维码</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="99813389872203020000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import QRCode from \'qrcode\';\n// 使用 async 生成图片\nconst options = {};\nconst url = window.location.href;\nasync (url) => {\n  try {\n    console.log(await QRCode.toDataURL(url, options));\n  } catch (err) {\n    console.error(err);\n  }\n};`, `99813389872203020000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> QRCode <span class="token keyword">from</span> <span class="token string">\'qrcode\'</span><span class="token punctuation">;</span>\n<span class="token comment">// 使用 async 生成图片</span>\n<span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> url <span class="token operator">=</span> window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href<span class="token punctuation">;</span>\n<span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">try</span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">await</span> QRCode<span class="token punctuation">.</span><span class="token function">toDataURL</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>将 await QRCode.toDataURL(url, options) 赋值给 图片 url 即可</p>\n<h3 id="生成图片"><a href="#%E7%94%9F%E6%88%90%E5%9B%BE%E7%89%87" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>生成图片</h3>\n<p>主要是使用 htmlToCanvas 生成 canvas 画布</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="96231693030821840000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import html2canvas from \'html2canvas\';\n\nhtml2canvas(document.body).then(function(canvas) {\n  document.body.appendChild(canvas);\n});`, `96231693030821840000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> html2canvas <span class="token keyword">from</span> <span class="token string">\'html2canvas\'</span><span class="token punctuation">;</span>\n\n<span class="token function">html2canvas</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">canvas</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>canvas<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>但是不单单在此处就完了，由于是 canvas 的原因。移动端生成出来的图片比较模糊。</p>\n<p>我们使用一个新的 canvas 方法多倍生成，放入一倍容器里面，达到更加清晰的效果，通过超链接下载图片</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="58824165238259880000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const scaleSize = 2;\nconst newCanvas = document.createElement(&quot;canvas&quot;);\nconst target = document.querySelector(\'div\');\nconst width = parseInt(window.getComputedStyle(target).width);\nconst height = parseInt(window.getComputedStyle(target).height);\nnewCanvas.width = width * scaleSize;\nnewCanvas.height = widthh * scaleSize;\nnewCanvas.style.width = width + &quot;px&quot;;\nnewCanvas.style.height = width + &quot;px&quot;;\nconst context = newCanvas.getContext(&quot;2d&quot;);\ncontext.scale(scaleSize, scaleSize);\nhtml2canvas(document.querySelector(\'.demo\'), { canvas: newCanvas }).then(function(canvas) {\n  // 简单的通过超链接设置下载功能\n  document.querySelector(&quot;.btn&quot;).setAttribute(\'href\', canvas.toDataURL());\n}`, `58824165238259880000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> scaleSize <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> newCanvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">"canvas"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> target <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">\'div\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> width <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span><span class="token function">getComputedStyle</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">.</span>width<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> height <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span><span class="token function">getComputedStyle</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>\nnewCanvas<span class="token punctuation">.</span>width <span class="token operator">=</span> width <span class="token operator">*</span> scaleSize<span class="token punctuation">;</span>\nnewCanvas<span class="token punctuation">.</span>height <span class="token operator">=</span> widthh <span class="token operator">*</span> scaleSize<span class="token punctuation">;</span>\nnewCanvas<span class="token punctuation">.</span>style<span class="token punctuation">.</span>width <span class="token operator">=</span> width <span class="token operator">+</span> <span class="token string">"px"</span><span class="token punctuation">;</span>\nnewCanvas<span class="token punctuation">.</span>style<span class="token punctuation">.</span>height <span class="token operator">=</span> width <span class="token operator">+</span> <span class="token string">"px"</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> context <span class="token operator">=</span> newCanvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">"2d"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ncontext<span class="token punctuation">.</span><span class="token function">scale</span><span class="token punctuation">(</span>scaleSize<span class="token punctuation">,</span> scaleSize<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token function">html2canvas</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">\'.demo\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> canvas<span class="token punctuation">:</span> newCanvas <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">canvas</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 简单的通过超链接设置下载功能</span>\n  document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">".btn"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">\'href\'</span><span class="token punctuation">,</span> canvas<span class="token punctuation">.</span><span class="token function">toDataURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<blockquote>\n<p>根据需要设置 scaleSize 大小</p>\n</blockquote>\n<h1 id="微信公众号分享问题"><a href="#%E5%BE%AE%E4%BF%A1%E5%85%AC%E4%BC%97%E5%8F%B7%E5%88%86%E4%BA%AB%E9%97%AE%E9%A2%98" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>微信公众号分享问题</h1>\n<h2 id="现象-10"><a href="#%E7%8E%B0%E8%B1%A1-10" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>现象</h2>\n<p>在微信公众号 H5 开发中，页面内部点击分享按钮调用 SDK，方法不生效。</p>\n<h2 id="解决方案-10"><a href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-10" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>解决方案</h2>\n<h3 id="添加一层蒙层做分享引导"><a href="#%E6%B7%BB%E5%8A%A0%E4%B8%80%E5%B1%82%E8%92%99%E5%B1%82%E5%81%9A%E5%88%86%E4%BA%AB%E5%BC%95%E5%AF%BC" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>添加一层蒙层做分享引导</h3>\n<p>因为页面内部点击分享按钮无法直接调用，而分享功能需要点击右上角更多来操作。</p>\n<p>然后用户可能不知道通过右上角小标里面的功能分享。又想引导用户分享，这时应该怎么做呢？</p>\n<p>技术无法实现的，从产品出发。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2020-01-20-15-30-58-974c088ad0c258bc1e783936f06b98e0-48439.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 325px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 58.46153846153847%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACtklEQVQoz2O4devWnTt3/vz5/fPHjy8w8PXrVyD5+fNnCPfVq1e3b9++efMmUPHly5eB6q9du7Z7926GT58+vf/w/tLlq/fuP/z48RMcfPn8BWTC589A9ocPHz4i5IDMDyCZT58YHj1+8vz5q0VL1/RPnj1t5qKeCbM6e6d39Ezr6p0+Zcb8Fy9f//7z7/uP399//v7+4ycY/fr58zfQ8Ddv3jE8uHvz4d0b925fvnnt/KnjB7du3jBn1qwpEyfNnTVr/+6dd29eevLgxsO71x7du/74we3H9+HoFpBkyI/TKk0zqSmNAKL6ipjG6qTmmuTm2pTmmqT6yoTqkqjKwoiqoqiKHO+SJL3yVL3yNL2yVJ2yVN3ydB2GWCejWEejBFf7ODe7aFfraCfLcAfTMHvjCEeTWDeLOC/rOC/bJD+nZD+nBDfjFC+TWHud2rTwutSIOBttBlvxWE/tdHfNVHfNFHetZHetVA/tFA+dZBflBFPuKFOuaDCKNOGMMuOONuGMNBONDLDL9TDLMFOMZHCQiPM1yvYxyPTRz/Q2zPY2yAEyfA2zPTXTzDhjzDjjzLhigaQpR2ygVpGzXJpKUJhzU6ZWdohOQQSDKWeMMVu0MVuUMWuUEUekBW+EBU+EBW+kJW+0vWiYg2QICEkAGaExVrmB2rl2Dkm6DhFyhv6KJoEM5ryx5nxx5gIxJsLR1kKRbsqBvto+bkp+7kq+0Q6exZGWBUHW+SE2xVHODSleuaExbnJJVhxRdlzh1pzRDGY8seZcsaZC0YaSMVZ84SFGsSmeMRneaZEW0Wl+ERPLQzpzgzqzA9qy/JtTHRLcXA3Yos154mz5w635wkGaQYg3yoIrxoonMkAnNtIyI94pO1A/MdoqPss/Kd0nKd03Mc03MTMg0Uc7zJQ73II71pw33kIgBgAEOVdfe6TtgQAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2020 01 20 15 30 58" title="" data-src="/static/2020-01-20-15-30-58-974c088ad0c258bc1e783936f06b98e0-48439.png" data-srcset="/static/2020-01-20-15-30-58-974c088ad0c258bc1e783936f06b98e0-39b9b.png 200w,\n/static/2020-01-20-15-30-58-974c088ad0c258bc1e783936f06b98e0-48439.png 325w" data-sizes="(max-width: 325px) 100vw, 325px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<hr>\n<p>更新于 <code class="language-text">2020-1-20 11:27:54</code></p>\n<h1 id="第三方-cookie-失效"><a href="#%E7%AC%AC%E4%B8%89%E6%96%B9-cookie-%E5%A4%B1%E6%95%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第三方 cookie 失效</h1>\n<h2 id="现象-11"><a href="#%E7%8E%B0%E8%B1%A1-11" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>现象</h2>\n<p>第三方 cookie 在苹果浏览器失效，在 windows 最新版本的 chrome（版本号：80.0.3987.132）也有这个问题</p>\n<h2 id="产生原因-6"><a href="#%E4%BA%A7%E7%94%9F%E5%8E%9F%E5%9B%A0-6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>产生原因</h2>\n<h3 id="苹果浏览器"><a href="#%E8%8B%B9%E6%9E%9C%E6%B5%8F%E8%A7%88%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>苹果浏览器</h3>\n<p>在苹果浏览器失效是由于默认开启阻止跨站跟踪导致的，具体表现为最新的 IOS 系统下的 safari，chrome 都有这个问题</p>\n<h3 id="谷歌浏览器"><a href="#%E8%B0%B7%E6%AD%8C%E6%B5%8F%E8%A7%88%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>谷歌浏览器</h3>\n<p>至于最新版本的 chrome 是由于默认开启了 SameSite: Lax</p>\n<blockquote>\n<p>Chrome 计划将 Lax 变为默认设置。这时网站可以选择显式关闭 SameSite 属性，将其设为 None。不过前提是必须同时设置 Secure 属性（Cookie 只能通过 HTTPS 协议发送），否则无效。</p>\n</blockquote>\n<p>下面的设置无效：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="12158828928514298000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`Set-Cookie: widget_session=abc123; SameSite=None`, `12158828928514298000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">Set-Cookie: widget_session=abc123; SameSite=None</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>下面的设置有效：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="44139621784250700000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`Set-Cookie: widget_session=abc123; SameSite=None; Secure`, `44139621784250700000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">Set-Cookie: widget_session=abc123; SameSite=None; Secure</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>相同二级域名的子域名下是没有 SameSite 的限制的，举例来说 www.web.dev 和 static.web.dev 之间就没有限制，注意跨站与跨域的区别</p>\n<p>具体可查看 <a href="https://juejin.im/post/5e7097b4518825496452cef9?utm_source=gold_browser_extension" target="_blank" rel="nofollow noreferrer noopener">当 CORS 遇到 SameSite</a></p>\n<p>不过经过具体实践，即使设置了也没有用，有可能是我们公司后台的 flask 版本过低，设置 SameSite 没什么效果</p>\n<p><a href="https://stackoverflow.com/questions/56828663/how-to-explicitly-set-samesite-none-on-a-flask-response" target="_blank" rel="nofollow noreferrer noopener">如何在 flask 中显式设置 samesite = None</a></p>\n<h2 id="解决方案-11"><a href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-11" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>解决方案</h2>\n<h3 id="手动关闭"><a href="#%E6%89%8B%E5%8A%A8%E5%85%B3%E9%97%AD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>手动关闭</h3>\n<p>用户手动关闭阻止跨站跟踪或者 SameSite 限制，并在产品上予以提示</p>\n<h3 id="重定向页面"><a href="#%E9%87%8D%E5%AE%9A%E5%90%91%E9%A1%B5%E9%9D%A2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>重定向页面</h3>\n<p>重定向到第三方域中托管的登录页面，授权后返回到原始页面或者直接打开新窗口展示，不过这样会造成用户体验不佳</p>\n<h3 id="存储到-localstorage"><a href="#%E5%AD%98%E5%82%A8%E5%88%B0-localstorage" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>存储到 localstorage</h3>\n<p>后端接口明确返回 token 相关信息保存到 localstorage 中，并在下次判断 localstorage 有相关 token 信息时，在全局方法中随请求发出，不过有被 xss（跨站脚本攻击）的风险</p>',
id:"/home/runner/work/GatsbyBlog/GatsbyBlog/blog/移动端适配汇总/index.md absPath of file >>> MarkdownRemark",timeToRead:15,frontmatter:{date:"2020-03-16 17:47:42",path:"/mobile-adaptation-summary/",tags:"前端, 移动端, 兼容性, 预研",title:"移动端适配汇总",draft:null}},{excerpt:"需求背景 最近在做表单分享的需求，类似于问卷调查，需要在三端（桌面端、移动端、微信端）同时兼容 技术方案 我出的方案：采用原生语法新框架写，考虑到首屏渲染的问题未采用 主管出的方案：采用后端渲染模板的方式，最大化首屏加载速度，但有以下问题： 后端渲染对服务器 CPU 的要求较高 本来打算用 oss 来减少后端渲染，但考虑到表单经常变化，且分享的链接要尽可能的保持不变，这就限制了 oss…",html:'<h1 id="需求背景"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h1>\n<p>最近在做表单分享的需求，类似于问卷调查，需要在三端（桌面端、移动端、微信端）同时兼容</p>\n<h1 id="技术方案"><a href="#%E6%8A%80%E6%9C%AF%E6%96%B9%E6%A1%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>技术方案</h1>\n<ol>\n<li>我出的方案：采用原生语法新框架写，考虑到首屏渲染的问题未采用</li>\n<li>\n<p>主管出的方案：采用后端渲染模板的方式，最大化首屏加载速度，但有以下问题：</p>\n<ol>\n<li>后端渲染对服务器 CPU 的要求较高</li>\n<li>本来打算用 oss 来减少后端渲染，但考虑到表单经常变化，且分享的链接要尽可能的保持不变，这就限制了 oss 的使用</li>\n<li>同样由于分享的链接要尽可能的保持不变，在新的表单分享模板加入后需要后端刷数据，容错性较低</li>\n</ol>\n</li>\n<li>最终讨论结果：采用前后端分离的方式，用原生语法新框架写，需要考虑到版本兼容（新的模板数据和旧的模板数据要同时兼容，在接口里面加一个版本号）、模板枚举 wiki 的命名（减少沟通成本同时缩短分享链接的长度）、loading 页（首屏加载时间可能较长）</li>\n</ol>\n<h1 id="方案调研"><a href="#%E6%96%B9%E6%A1%88%E8%B0%83%E7%A0%94" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>方案调研</h1>\n<p>刚开始考虑到用官网的框架，但是由于官网的框架构建过程有太多冗余的东西、以及只能在 node v9.11.2 里面使用的原因，决定自己在 <a href="https://github.com/yeoman/generator-webapp" target="_blank" rel="nofollow noreferrer noopener">generator-webapp</a> 生成的框架上做一下改造，以下是改造的要点：</p>\n<ol>\n<li>资源文件 hash</li>\n<li>接口代理</li>\n<li>模板功能</li>\n</ol>\n<h1 id="具体实施"><a href="#%E5%85%B7%E4%BD%93%E5%AE%9E%E6%96%BD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>具体实施</h1>\n<h2 id="构建框架搭建"><a href="#%E6%9E%84%E5%BB%BA%E6%A1%86%E6%9E%B6%E6%90%AD%E5%BB%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>构建框架搭建</h2>\n<h3 id="gulp-打包优化"><a href="#gulp-%E6%89%93%E5%8C%85%E4%BC%98%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>gulp 打包优化</h3>\n<p>gulpfile.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="1147647552958686100"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// generated on 2019-11-07 using generator-webapp 4.0.0-6\nconst { src, dest, watch, series, parallel, lastRun } = require(\'gulp\');\nconst gulpLoadPlugins = require(\'gulp-load-plugins\');\nconst browserSync = require(\'browser-sync\');\nconst del = require(\'del\');\n// const autoprefixer = require(\'autoprefixer\');\nconst cssnano = require(\'cssnano\');\nconst { argv } = require(\'yargs\');\nconst proxy = require(\'http-proxy-middleware\');\nconst postcssPresetEnv = require(\'postcss-preset-env\');\n\nconst config = require(\'./proxy.json\');\nconst globalJSON = require(\'./global.json\');\n\nconst \\$ = gulpLoadPlugins();\nconst server = browserSync.create();\n\nconst port = argv.port || config.port || 9000;\nconst buildPath = argv.buildPath || \'build\';\nconst varsEnv = argv.server || \'master\';\nconst globalVars = globalJSON.runtime[varsEnv];\nconst publicPath = argv.publicPath || \'/form\';\n\nconst isProd = process.env.NODE_ENV === \'production\';\nconst isTest = process.env.NODE_ENV === \'test\';\nconst isDev = !isProd && !isTest;\n\n// 配置反向代理\nconst middleware = config.proxies.map((item) =>\n   proxy(item.match, {\n      target: item.host,\n      changeOrigin: true\n   })\n);\n\nfunction styles() {\n   return src(\'app/styles/*.css\')\n      .pipe(\\$.if(!isProd, \\$.sourcemaps.init()))\n      .pipe(\n         \\$.postcss([\n            // autoprefixer(),\n            // 采用 postcss 最新语法\n            postcssPresetEnv({\n               stage: 0\n            })\n         ])\n      )\n      .pipe(\\$.if(!isProd, \\$.sourcemaps.write()))\n      .pipe(dest(\'.tmp/styles\'))\n      .pipe(server.reload({ stream: true }));\n}\n\nfunction scripts() {\n   return (\n      src(\'app/scripts/**/*.js\')\n         // plumber 插件防止 gulp 报错崩溃\n         .pipe(\\$.plumber())\n         .pipe(\\$.if(!isProd, \\$.sourcemaps.init()))\n         .pipe(\\$.babel())\n         .pipe(\\$.if(!isProd, \\$.sourcemaps.write(\'.\')))\n         .pipe(dest(\'.tmp/scripts\'))\n         .pipe(server.reload({ stream: true }))\n   );\n}\n\nconst lintBase = (files) => {\n   return src(files)\n      .pipe(\\$.eslint({ fix: true }))\n      .pipe(server.reload({ stream: true, once: true }))\n      .pipe(\\$.eslint.format())\n      .pipe(\\$.if(!server.active, \\$.eslint.failAfterError()));\n};\n\nfunction lint() {\n   return lintBase(\'app/scripts/**/*.js\').pipe(dest(\'app/scripts\'));\n}\n\nfunction lintTest() {\n   return lintBase(\'test/spec/**/*.js\').pipe(dest(\'test/spec\'));\n}\n\nfunction html() {\n   // 合成 js、css 过程中，要过滤掉模板编译文件夹的代码\n   // 注意这里的 useref 插件合成 js、css 有一个问题文件行尾必须为 crlf，否则此文件不能正常合成\n   // 可用 .editorconfig 来限制文件行尾符\n   return src([\'app/**/*.html\', \'.tmp/**/*.html\', \'!app/common/**/*.html\', \'!.tmp/common/**/*.html\'])\n      .pipe(\\$.useref({ searchPath: [\'.tmp\', \'app\', \'.\'] }))\n      .pipe(\\$.if(/\\.js\\$/, \\$.uglify({ compress: { drop_console: true } })))\n      .pipe(\\$.if(/\\.css\\$/, \\$.postcss([cssnano({ safe: true, autoprefixer: false })])))\n      .pipe(\n         \\$.if(\n            /\\.html\\$/,\n            \\$.htmlmin({\n               collapseWhitespace: true,\n               minifyCSS: true,\n               minifyJS: { compress: { drop_console: true } },\n               processConditionalComments: true,\n               removeComments: true,\n               removeEmptyAttributes: true,\n               removeScriptTypeAttributes: true,\n               removeStyleLinkTypeAttributes: true\n            })\n         )\n      )\n      .pipe(dest(buildPath));\n}\n\nfunction images() {\n   return src(\'app/images/**/*\', { since: lastRun(images) }).pipe(dest(\\`\\${buildPath}/images\\`));\n}\n\nfunction fonts() {\n   return src(\'app/fonts/**/*.{eot,svg,ttf,woff,woff2}\').pipe(\n      \\$.if(!isProd, dest(\'.tmp/fonts\'), dest(\\`\\${buildPath}/fonts\\`))\n   );\n}\n\nfunction extras() {\n   // 过滤掉模板编译文件夹的代码与 html 代码\n   return src([\'app/*\', \'!app/**/*.html\', \'!app/common\'], {\n      dot: true\n   }).pipe(dest(buildPath));\n}\n\nfunction clean() {\n   return del([\'.tmp\', \\`\\${buildPath}/*\\`]);\n}\n\nfunction measureSize() {\n   return src(\\`\\${buildPath}/**/*\\`).pipe(\\$.size({ title: \'build\', gzip: true }));\n}\n\nconst build = series(\n   clean,\n   parallel(lint, series(parallel(styles, scripts, fileVarInclude), html), images, fonts, extras),\n   revAll,\n   measureSize\n);\n\nfunction startAppServer() {\n   server.init({\n      notify: false,\n      port,\n      server: {\n         baseDir: [\'.tmp\', \'app\'],\n         routes: {\n            \'/node_modules\': \'node_modules\'\n         },\n         middleware\n      }\n   });\n\n   watch([\'app/**/*.html\', \'app/images/**/*\', \'.tmp/fonts/**/*\']).on(\'change\', server.reload);\n\n   watch(\'app/styles/*.css\', styles);\n   watch(\'app/scripts/**/*.js\', scripts);\n   watch(\'app/fonts/**/*\', fonts);\n   // 监控 html 编译模板改动\n   watch(\'app/**/*.html\', fileVarInclude);\n}\n\nfunction startTestServer() {\n   server.init({\n      notify: false,\n      port,\n      ui: false,\n      server: {\n         baseDir: \'test\',\n         routes: {\n            \'/scripts\': \'.tmp/scripts\',\n            \'/node_modules\': \'node_modules\'\n         }\n      }\n   });\n\n   watch(\'app/scripts/**/*.js\', scripts);\n   watch([\'test/spec/**/*.js\', \'test/index.html\']).on(\'change\', server.reload);\n   watch(\'test/spec/**/*.js\', lintTest);\n}\n\nfunction startDistServer() {\n   server.init({\n      notify: false,\n      port,\n      server: {\n         baseDir: buildPath,\n         routes: {\n            \'/node_modules\': \'node_modules\',\n            // 注意这里的别名也要配置，否则资源访问不到\n            [publicPath]: buildPath\n         },\n         middleware\n      }\n   });\n}\n\n// 资源 hash，注意要在最后一步，同时配置路径别名，注意所有的资源引用必须以 &quot;/&quot; 开头，否则别名替换不成功\nfunction revAll() {\n   return src(\\`\\${buildPath}/**\\`)\n      .pipe(\n         \\$.revAll.revision({\n            prefix: publicPath,\n            dontRenameFile: [/^\\/favicon.ico\\$/g, \'.html\', \'robots.txt\']\n         })\n      )\n      .pipe(\\$.revDeleteOriginal())\n      .pipe(dest(buildPath));\n}\n\nfunction fileVarInclude() {\n   return src(\'app/**/*.html\')\n      .pipe(\\$.plumber())\n      .pipe(\n         \\$.fileInclude({\n            prefix: \'@@\',\n            basepath: \'@root\',\n            // 环境变量注入\n            // 需要在公共的模板文件中注入此变量\n            // <script>\n            //   window.GLOBAL_VARS = @@GLOBAL_VARS;\n            // </script>\n            context: {\n               GLOBAL_VARS: JSON.stringify(globalVars)\n            }\n         })\n      )\n      .pipe(dest(\'.tmp\'))\n      .pipe(server.reload({ stream: true }));\n}\n\nlet serve;\nif (isDev) {\n   serve = series(clean, parallel(styles, scripts, fonts, fileVarInclude), startAppServer);\n} else if (isTest) {\n   serve = series(clean, scripts, startTestServer);\n} else if (isProd) {\n   serve = series(build, startDistServer);\n}\n\nexports.serve = serve;\nexports.build = build;\nexports.default = build;`, `1147647552958686100`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// generated on 2019-11-07 using generator-webapp 4.0.0-6</span>\n<span class="token keyword">const</span> <span class="token punctuation">{</span> src<span class="token punctuation">,</span> dest<span class="token punctuation">,</span> watch<span class="token punctuation">,</span> series<span class="token punctuation">,</span> parallel<span class="token punctuation">,</span> lastRun <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'gulp\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> gulpLoadPlugins <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'gulp-load-plugins\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> browserSync <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'browser-sync\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> del <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'del\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// const autoprefixer = require(\'autoprefixer\');</span>\n<span class="token keyword">const</span> cssnano <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'cssnano\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> <span class="token punctuation">{</span> argv <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'yargs\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> proxy <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'http-proxy-middleware\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> postcssPresetEnv <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'postcss-preset-env\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./proxy.json\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> globalJSON <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./global.json\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> $ <span class="token operator">=</span> <span class="token function">gulpLoadPlugins</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> server <span class="token operator">=</span> browserSync<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> port <span class="token operator">=</span> argv<span class="token punctuation">.</span>port <span class="token operator">||</span> config<span class="token punctuation">.</span>port <span class="token operator">||</span> <span class="token number">9000</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> buildPath <span class="token operator">=</span> argv<span class="token punctuation">.</span>buildPath <span class="token operator">||</span> <span class="token string">\'build\'</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> varsEnv <span class="token operator">=</span> argv<span class="token punctuation">.</span>server <span class="token operator">||</span> <span class="token string">\'master\'</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> globalVars <span class="token operator">=</span> globalJSON<span class="token punctuation">.</span>runtime<span class="token punctuation">[</span>varsEnv<span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> publicPath <span class="token operator">=</span> argv<span class="token punctuation">.</span>publicPath <span class="token operator">||</span> <span class="token string">\'/form\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> isProd <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">\'production\'</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> isTest <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">\'test\'</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> isDev <span class="token operator">=</span> <span class="token operator">!</span>isProd <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>isTest<span class="token punctuation">;</span>\n\n<span class="token comment">// 配置反向代理</span>\n<span class="token keyword">const</span> middleware <span class="token operator">=</span> config<span class="token punctuation">.</span>proxies<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span>\n   <span class="token function">proxy</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>match<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n      target<span class="token punctuation">:</span> item<span class="token punctuation">.</span>host<span class="token punctuation">,</span>\n      changeOrigin<span class="token punctuation">:</span> <span class="token boolean">true</span>\n   <span class="token punctuation">}</span><span class="token punctuation">)</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">function</span> <span class="token function">styles</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">\'app/styles/*.css\'</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>$<span class="token punctuation">.</span><span class="token function">if</span><span class="token punctuation">(</span><span class="token operator">!</span>isProd<span class="token punctuation">,</span> $<span class="token punctuation">.</span>sourcemaps<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>\n         $<span class="token punctuation">.</span><span class="token function">postcss</span><span class="token punctuation">(</span><span class="token punctuation">[</span>\n            <span class="token comment">// autoprefixer(),</span>\n            <span class="token operator">/</span><span class="token operator">/</span> 采用 postcss 最新语法\n            <span class="token function">postcssPresetEnv</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n               stage<span class="token punctuation">:</span> <span class="token number">0</span>\n            <span class="token punctuation">}</span><span class="token punctuation">)</span>\n         <span class="token punctuation">]</span><span class="token punctuation">)</span>\n      <span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>$<span class="token punctuation">.</span><span class="token function">if</span><span class="token punctuation">(</span><span class="token operator">!</span>isProd<span class="token punctuation">,</span> $<span class="token punctuation">.</span>sourcemaps<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">\'.tmp/styles\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">{</span> stream<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">scripts</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">return</span> <span class="token punctuation">(</span>\n      <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">\'app/scripts/**/*.js\'</span><span class="token punctuation">)</span>\n         <span class="token comment">// plumber 插件防止 gulp 报错崩溃</span>\n         <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>$<span class="token punctuation">.</span><span class="token function">plumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n         <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>$<span class="token punctuation">.</span><span class="token function">if</span><span class="token punctuation">(</span><span class="token operator">!</span>isProd<span class="token punctuation">,</span> $<span class="token punctuation">.</span>sourcemaps<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n         <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>$<span class="token punctuation">.</span><span class="token function">babel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n         <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>$<span class="token punctuation">.</span><span class="token function">if</span><span class="token punctuation">(</span><span class="token operator">!</span>isProd<span class="token punctuation">,</span> $<span class="token punctuation">.</span>sourcemaps<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">\'.\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n         <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">\'.tmp/scripts\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n         <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">{</span> stream<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n   <span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">lintBase</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">files</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span>files<span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>$<span class="token punctuation">.</span><span class="token function">eslint</span><span class="token punctuation">(</span><span class="token punctuation">{</span> fix<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">{</span> stream<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> once<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>$<span class="token punctuation">.</span>eslint<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>$<span class="token punctuation">.</span><span class="token function">if</span><span class="token punctuation">(</span><span class="token operator">!</span>server<span class="token punctuation">.</span>active<span class="token punctuation">,</span> $<span class="token punctuation">.</span>eslint<span class="token punctuation">.</span><span class="token function">failAfterError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">function</span> <span class="token function">lint</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">return</span> <span class="token function">lintBase</span><span class="token punctuation">(</span><span class="token string">\'app/scripts/**/*.js\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">\'app/scripts\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">lintTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">return</span> <span class="token function">lintBase</span><span class="token punctuation">(</span><span class="token string">\'test/spec/**/*.js\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">\'test/spec\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">html</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token comment">// 合成 js、css 过程中，要过滤掉模板编译文件夹的代码</span>\n   <span class="token comment">// 注意这里的 useref 插件合成 js、css 有一个问题文件行尾必须为 crlf，否则此文件不能正常合成</span>\n   <span class="token comment">// 可用 .editorconfig 来限制文件行尾符</span>\n   <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'app/**/*.html\'</span><span class="token punctuation">,</span> <span class="token string">\'.tmp/**/*.html\'</span><span class="token punctuation">,</span> <span class="token string">\'!app/common/**/*.html\'</span><span class="token punctuation">,</span> <span class="token string">\'!.tmp/common/**/*.html\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>$<span class="token punctuation">.</span><span class="token function">useref</span><span class="token punctuation">(</span><span class="token punctuation">{</span> searchPath<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'.tmp\'</span><span class="token punctuation">,</span> <span class="token string">\'app\'</span><span class="token punctuation">,</span> <span class="token string">\'.\'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>$<span class="token punctuation">.</span><span class="token function">if</span><span class="token punctuation">(</span><span class="token regex">/\\.js$/</span><span class="token punctuation">,</span> $<span class="token punctuation">.</span><span class="token function">uglify</span><span class="token punctuation">(</span><span class="token punctuation">{</span> compress<span class="token punctuation">:</span> <span class="token punctuation">{</span> drop_console<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>$<span class="token punctuation">.</span><span class="token function">if</span><span class="token punctuation">(</span><span class="token regex">/\\.css$/</span><span class="token punctuation">,</span> $<span class="token punctuation">.</span><span class="token function">postcss</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token function">cssnano</span><span class="token punctuation">(</span><span class="token punctuation">{</span> safe<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> autoprefixer<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>\n         $<span class="token punctuation">.</span><span class="token function">if</span><span class="token punctuation">(</span>\n            <span class="token regex">/\\.html$/</span><span class="token punctuation">,</span>\n            $<span class="token punctuation">.</span><span class="token function">htmlmin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n               collapseWhitespace<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n               minifyCSS<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n               minifyJS<span class="token punctuation">:</span> <span class="token punctuation">{</span> compress<span class="token punctuation">:</span> <span class="token punctuation">{</span> drop_console<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>\n               processConditionalComments<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n               removeComments<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n               removeEmptyAttributes<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n               removeScriptTypeAttributes<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n               removeStyleLinkTypeAttributes<span class="token punctuation">:</span> <span class="token boolean">true</span>\n            <span class="token punctuation">}</span><span class="token punctuation">)</span>\n         <span class="token punctuation">)</span>\n      <span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span>buildPath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">images</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">\'app/images/**/*\'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> since<span class="token punctuation">:</span> <span class="token function">lastRun</span><span class="token punctuation">(</span>images<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>buildPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/images</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">fonts</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">\'app/fonts/**/*.{eot,svg,ttf,woff,woff2}\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>\n      $<span class="token punctuation">.</span><span class="token function">if</span><span class="token punctuation">(</span><span class="token operator">!</span>isProd<span class="token punctuation">,</span> <span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">\'.tmp/fonts\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">dest</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>buildPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/fonts</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n   <span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">extras</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token comment">// 过滤掉模板编译文件夹的代码与 html 代码</span>\n   <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'app/*\'</span><span class="token punctuation">,</span> <span class="token string">\'!app/**/*.html\'</span><span class="token punctuation">,</span> <span class="token string">\'!app/common\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>\n      dot<span class="token punctuation">:</span> <span class="token boolean">true</span>\n   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span>buildPath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">clean</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">return</span> <span class="token function">del</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'.tmp\'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>buildPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/*</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">measureSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>buildPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/**/*</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>$<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">{</span> title<span class="token punctuation">:</span> <span class="token string">\'build\'</span><span class="token punctuation">,</span> gzip<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">const</span> build <span class="token operator">=</span> <span class="token function">series</span><span class="token punctuation">(</span>\n   clean<span class="token punctuation">,</span>\n   <span class="token function">parallel</span><span class="token punctuation">(</span>lint<span class="token punctuation">,</span> <span class="token function">series</span><span class="token punctuation">(</span><span class="token function">parallel</span><span class="token punctuation">(</span>styles<span class="token punctuation">,</span> scripts<span class="token punctuation">,</span> fileVarInclude<span class="token punctuation">)</span><span class="token punctuation">,</span> html<span class="token punctuation">)</span><span class="token punctuation">,</span> images<span class="token punctuation">,</span> fonts<span class="token punctuation">,</span> extras<span class="token punctuation">)</span><span class="token punctuation">,</span>\n   revAll<span class="token punctuation">,</span>\n   measureSize\n<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">function</span> <span class="token function">startAppServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   server<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n      notify<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n      port<span class="token punctuation">,</span>\n      server<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n         baseDir<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'.tmp\'</span><span class="token punctuation">,</span> <span class="token string">\'app\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n         routes<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n            <span class="token string">\'/node_modules\'</span><span class="token punctuation">:</span> <span class="token string">\'node_modules\'</span>\n         <span class="token punctuation">}</span><span class="token punctuation">,</span>\n         middleware\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token function">watch</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'app/**/*.html\'</span><span class="token punctuation">,</span> <span class="token string">\'app/images/**/*\'</span><span class="token punctuation">,</span> <span class="token string">\'.tmp/fonts/**/*\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'change\'</span><span class="token punctuation">,</span> server<span class="token punctuation">.</span>reload<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token function">watch</span><span class="token punctuation">(</span><span class="token string">\'app/styles/*.css\'</span><span class="token punctuation">,</span> styles<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token function">watch</span><span class="token punctuation">(</span><span class="token string">\'app/scripts/**/*.js\'</span><span class="token punctuation">,</span> scripts<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token function">watch</span><span class="token punctuation">(</span><span class="token string">\'app/fonts/**/*\'</span><span class="token punctuation">,</span> fonts<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token comment">// 监控 html 编译模板改动</span>\n   <span class="token function">watch</span><span class="token punctuation">(</span><span class="token string">\'app/**/*.html\'</span><span class="token punctuation">,</span> fileVarInclude<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">startTestServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   server<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n      notify<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n      port<span class="token punctuation">,</span>\n      ui<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n      server<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n         baseDir<span class="token punctuation">:</span> <span class="token string">\'test\'</span><span class="token punctuation">,</span>\n         routes<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n            <span class="token string">\'/scripts\'</span><span class="token punctuation">:</span> <span class="token string">\'.tmp/scripts\'</span><span class="token punctuation">,</span>\n            <span class="token string">\'/node_modules\'</span><span class="token punctuation">:</span> <span class="token string">\'node_modules\'</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token function">watch</span><span class="token punctuation">(</span><span class="token string">\'app/scripts/**/*.js\'</span><span class="token punctuation">,</span> scripts<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token function">watch</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'test/spec/**/*.js\'</span><span class="token punctuation">,</span> <span class="token string">\'test/index.html\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'change\'</span><span class="token punctuation">,</span> server<span class="token punctuation">.</span>reload<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token function">watch</span><span class="token punctuation">(</span><span class="token string">\'test/spec/**/*.js\'</span><span class="token punctuation">,</span> lintTest<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">startDistServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   server<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n      notify<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n      port<span class="token punctuation">,</span>\n      server<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n         baseDir<span class="token punctuation">:</span> buildPath<span class="token punctuation">,</span>\n         routes<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n            <span class="token string">\'/node_modules\'</span><span class="token punctuation">:</span> <span class="token string">\'node_modules\'</span><span class="token punctuation">,</span>\n            <span class="token comment">// 注意这里的别名也要配置，否则资源访问不到</span>\n            <span class="token punctuation">[</span>publicPath<span class="token punctuation">]</span><span class="token punctuation">:</span> buildPath\n         <span class="token punctuation">}</span><span class="token punctuation">,</span>\n         middleware\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// 资源 hash，注意要在最后一步，同时配置路径别名，注意所有的资源引用必须以 "/" 开头，否则别名替换不成功</span>\n<span class="token keyword">function</span> <span class="token function">revAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>buildPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/**</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>\n         $<span class="token punctuation">.</span>revAll<span class="token punctuation">.</span><span class="token function">revision</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n            prefix<span class="token punctuation">:</span> publicPath<span class="token punctuation">,</span>\n            dontRenameFile<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token regex">/^\\/favicon.ico$/g</span><span class="token punctuation">,</span> <span class="token string">\'.html\'</span><span class="token punctuation">,</span> <span class="token string">\'robots.txt\'</span><span class="token punctuation">]</span>\n         <span class="token punctuation">}</span><span class="token punctuation">)</span>\n      <span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>$<span class="token punctuation">.</span><span class="token function">revDeleteOriginal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span>buildPath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">fileVarInclude</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">\'app/**/*.html\'</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>$<span class="token punctuation">.</span><span class="token function">plumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>\n         $<span class="token punctuation">.</span><span class="token function">fileInclude</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n            prefix<span class="token punctuation">:</span> <span class="token string">\'@@\'</span><span class="token punctuation">,</span>\n            basepath<span class="token punctuation">:</span> <span class="token string">\'@root\'</span><span class="token punctuation">,</span>\n            <span class="token comment">// 环境变量注入</span>\n            <span class="token comment">// 需要在公共的模板文件中注入此变量</span>\n            <span class="token comment">// &lt;script></span>\n            <span class="token comment">//   window.GLOBAL_VARS = @@GLOBAL_VARS;</span>\n            <span class="token comment">// &lt;/script></span>\n            context<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n               <span class="token constant">GLOBAL_VARS</span><span class="token punctuation">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>globalVars<span class="token punctuation">)</span>\n            <span class="token punctuation">}</span>\n         <span class="token punctuation">}</span><span class="token punctuation">)</span>\n      <span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">\'.tmp\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">{</span> stream<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">let</span> serve<span class="token punctuation">;</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span>isDev<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   serve <span class="token operator">=</span> <span class="token function">series</span><span class="token punctuation">(</span>clean<span class="token punctuation">,</span> <span class="token function">parallel</span><span class="token punctuation">(</span>styles<span class="token punctuation">,</span> scripts<span class="token punctuation">,</span> fonts<span class="token punctuation">,</span> fileVarInclude<span class="token punctuation">)</span><span class="token punctuation">,</span> startAppServer<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>isTest<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   serve <span class="token operator">=</span> <span class="token function">series</span><span class="token punctuation">(</span>clean<span class="token punctuation">,</span> scripts<span class="token punctuation">,</span> startTestServer<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>isProd<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   serve <span class="token operator">=</span> <span class="token function">series</span><span class="token punctuation">(</span>build<span class="token punctuation">,</span> startDistServer<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\nexports<span class="token punctuation">.</span>serve <span class="token operator">=</span> serve<span class="token punctuation">;</span>\nexports<span class="token punctuation">.</span>build <span class="token operator">=</span> build<span class="token punctuation">;</span>\nexports<span class="token punctuation">.</span>default <span class="token operator">=</span> build<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="文件目录结构"><a href="#%E6%96%87%E4%BB%B6%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>文件目录结构</h3>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2019-11-15-15-48-13-26cb5a37003ca0d864117a124e54dbeb-0f2f0.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 455px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 154.2857142857143%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAfCAIAAABoLHqZAAAACXBIWXMAAAsSAAALEgHS3X78AAACU0lEQVQ4y5WVSW7cMBBFdRH3pJmUOFOkqHnoVntKOzECZOEL5P4XSDXgdUwDtdTHr3r1iwqiMD+cX47rMyl4jNgxxv4V5ML96tc/22u/3TA1iBrMrGcFYU6VarbHt2a82HaOMnqv3KuCY4QQN93LOxGmqntM1CFCnhUcYkyIuo2bacZ2WIV2p6TwnfmYFJTIj7YHWyrr3TH9BrAwLiKqop/vynTjckVE7cPc2znGJTfb62/jhnHeuHYwjK8YJsxLafpFVW3dzQli3xCHCc5Zrd/+GjcCM+j5O84xTrDonp66cW36tWBVklP/mYskwxcVKdNUbmz6BVNghnyBxTltuKtsB3u27eQPHMQowTJbP1Q9QOd1O/kzCx5i/KOb38YlJTLOyMMx3d+j5zfz/oSna729LmkuqDAlr5iqo4z4mAfRCSVPV3a7aVmHWQnmCaKe8Q6OIU6tlpOrTA+2wPnBO97BLkSMMSllO1xgT6BPMfcGdsqMaazt6naGVfXTxTaTr3gXFypJHEZVu8BV2mYk3PiLsc7ylpDh/NyNZ6YdbB6A+TAL9iFmFClJlR0gIXCYu1MG5ROyu5gSpDW37WKbwdSDrnsoKuyXzQNtzDmqDLwCs7SddgNXDnIC5/F/MaQw2EcYIyxLqoVx0lAqd+HXbcOzGadFsI9xnha2oIPQo9CiYAcPzvBNmpbBARJGsWjgItfh/DgsV3gJoeEvaX+2DcBMJU0zuXaCkA3zdt+ZrH2AFZxkSpSIaMKrvBSgCdPSKySHMItFk1cd5RrcmLTwx/G8qn8QqzZdVS/hMwAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2019 11 15 15 48 13" title="" data-src="/static/2019-11-15-15-48-13-26cb5a37003ca0d864117a124e54dbeb-0f2f0.png" data-srcset="/static/2019-11-15-15-48-13-26cb5a37003ca0d864117a124e54dbeb-f5c73.png 200w,\n/static/2019-11-15-15-48-13-26cb5a37003ca0d864117a124e54dbeb-799a4.png 400w,\n/static/2019-11-15-15-48-13-26cb5a37003ca0d864117a124e54dbeb-0f2f0.png 455w" data-sizes="(max-width: 455px) 100vw, 455px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h2 id="代码优化"><a href="#%E4%BB%A3%E7%A0%81%E4%BC%98%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>代码优化</h2>\n<ol>\n<li>\n<p>除了在使用大量原生语法外，利用 gulp-file-include 插件大量复用了模板代码，确保多次使用的 html 代码在模板代码文件夹下。</p>\n</li>\n<li>\n<p>同时为了首屏加载速度，图片需要压缩，这里用了阿里云的 oss 图片压缩服务，代码如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="27417080411935244000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 参数的功能分别是调整宽度、质量、是否是渐进式、格式转换为 jpg\nfunction compressImg(oss, width = window.innerWidth) {\n  return \\`\\${oss}?x-oss-process=image/resize,w_\\${width}/quality,q_50/interlace,1/format,jpg\\`;\n}`, `27417080411935244000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 参数的功能分别是调整宽度、质量、是否是渐进式、格式转换为 jpg</span>\n<span class="token keyword">function</span> <span class="token function">compressImg</span><span class="token punctuation">(</span><span class="token parameter">oss<span class="token punctuation">,</span> width <span class="token operator">=</span> window<span class="token punctuation">.</span>innerWidth</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>oss<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">?x-oss-process=image/resize,w_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>width<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/quality,q_50/interlace,1/format,jpg</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n<li>\n<p>尽量在各自对应的平台加载相应的代码，比如微信分享脚本只在微信端加载，背景图只在桌面端加载，图片压缩的宽度尽可能的小</p>\n</li>\n</ol>\n<h1 id="加载效果"><a href="#%E5%8A%A0%E8%BD%BD%E6%95%88%E6%9E%9C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>加载效果</h1>\n<p>加载大小非自定义图片部分 28.4kb，自定义图片部分 57.5kb。</p>\n<p>加载速度（不限速）264ms，3g low（限速 120 kb/s）1.01s。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2019-11-15-16-27-42-a8e9a3af61496e6fd0ce82a4bcfaa4d2-c26ee.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 38.22505800464037%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAAsSAAALEgHS3X78AAABp0lEQVQY002Nj0vicBjG919fgdNCzQvKHwcHB0Ed1JVkRdN2rZmpc9bMzFrmlGbrh0xvszWnc23f9e2+GkUfXh6eF97nebGV5ZXE5laW2mfT9Nrv5WDAHwoGv4fmgn5/KBDw4bgP9/hmZn3+QCIeZ9PpzN+9PJViqFSOJDCOImunXDa5wzOZxMafb1PTHo8Hx3GkXq8XGaTvntiMn5C7VyUWTY1jrwp5jCFT60u/WHK7miFocndhMRyNRmOxWCQSCYfDSKMTkKWJbTa50SwzzYuyWCk1uCJ2nD38Oe8tFw5a9aqhdQFwHccBAFiWpaqqMwGttm2fc0fCZUmWBEngqyfF2jGLlXK5ev2sXi1IfNHsKxC+ffLFjrm/vRbK2ae2IN/fHFE0sZPE8vR+q8UPtEdDFZ0Xw3Vf4QcoDj8qkJqG2lfFF0PWtQ5N7a0ltjDm+lxRJMeQbf3BtY3x3eS7BSDXfq+YhOEbMDVHf7AHcrf3yEsNoX2H/VhdP6xU5KHWVDrKyER/wSsEEFrA/TcEQ9McDMdjjkbdwbPY64ha71Z/Fvv9hm78B0R1gs7qLKXOAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2019 11 15 16 27 42" title="" data-src="/static/2019-11-15-16-27-42-a8e9a3af61496e6fd0ce82a4bcfaa4d2-fee1c.png" data-srcset="/static/2019-11-15-16-27-42-a8e9a3af61496e6fd0ce82a4bcfaa4d2-a67b7.png 200w,\n/static/2019-11-15-16-27-42-a8e9a3af61496e6fd0ce82a4bcfaa4d2-0b187.png 400w,\n/static/2019-11-15-16-27-42-a8e9a3af61496e6fd0ce82a4bcfaa4d2-fee1c.png 800w,\n/static/2019-11-15-16-27-42-a8e9a3af61496e6fd0ce82a4bcfaa4d2-b1a91.png 1200w,\n/static/2019-11-15-16-27-42-a8e9a3af61496e6fd0ce82a4bcfaa4d2-95179.png 1600w,\n/static/2019-11-15-16-27-42-a8e9a3af61496e6fd0ce82a4bcfaa4d2-c26ee.png 1724w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2019-11-15-16-28-14-f42acdff926771d49665fafeed0fa979-5fe3e.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 24.685314685314683%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAIAAADKYVtkAAAACXBIWXMAAAsSAAALEgHS3X78AAAAuklEQVQY021P2W4EIQzj//9ypIFh2HANEMJRqd6t2qdaYEVJnDjKE6WUnHuBX0Raa3uZnJ855lpr/oe/vGLpYy1Zk5f0KU24CnI181N67zIA+fAnkPf/4d6VNsY5d1lrLpC19413WxtiaMwxpdZaKQWVnHNnrsDzFKJwO2W0Po4DNe99DCFGEBBrbV9711KwEA7O88RMCN+mxyjeZyKFdbgTB69f7L1hCtsQg6FkZvRAT0Q4dcyJoTmlb7OFHDC6aGk1AAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2019 11 15 16 28 14" title="" data-src="/static/2019-11-15-16-28-14-f42acdff926771d49665fafeed0fa979-fee1c.png" data-srcset="/static/2019-11-15-16-28-14-f42acdff926771d49665fafeed0fa979-a67b7.png 200w,\n/static/2019-11-15-16-28-14-f42acdff926771d49665fafeed0fa979-0b187.png 400w,\n/static/2019-11-15-16-28-14-f42acdff926771d49665fafeed0fa979-fee1c.png 800w,\n/static/2019-11-15-16-28-14-f42acdff926771d49665fafeed0fa979-b1a91.png 1200w,\n/static/2019-11-15-16-28-14-f42acdff926771d49665fafeed0fa979-5fe3e.png 1430w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2019-11-15-16-30-09-d7cf482606701089fd178f161bae0fb6-4cbd1.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 41.47582697201018%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAAsSAAALEgHS3X78AAABF0lEQVQY01WRi26EIBBF/f9PbLJZVFgQBBVUYLfd9Kht0l4emfcdhmYKeolzTCmy1hRCcKOzwaHWmvOz5FpqfVbOf2BpSsn7zt431iXlvJda9i3MdlyXuG9p20vOpZR1XfGXEznnxhg9jiNK/YtSqB1jgvX1eqWUtm1D8N67E/M8E9D0veh7SfLXic9fIC9xoc6VDCFGY0zbtl3XwYe9Efc7ulIK3VrrTyBfQvlpIdIk0QQIIaBFPt6spGxPDMNAYdLoyp4g+ZoNPVMFZlxSSlyM82A2w6D18WzG936/j9a5z814iMBA2zDj5S/IhAZy7M3H7XYXQmltMPNL3lv1sL1y8kFLzo0+TA9tBuv8NPVSdhx1GFC/AbHnxLOwfWV5AAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2019 11 15 16 30 09" title="" data-src="/static/2019-11-15-16-30-09-d7cf482606701089fd178f161bae0fb6-fee1c.png" data-srcset="/static/2019-11-15-16-30-09-d7cf482606701089fd178f161bae0fb6-a67b7.png 200w,\n/static/2019-11-15-16-30-09-d7cf482606701089fd178f161bae0fb6-0b187.png 400w,\n/static/2019-11-15-16-30-09-d7cf482606701089fd178f161bae0fb6-fee1c.png 800w,\n/static/2019-11-15-16-30-09-d7cf482606701089fd178f161bae0fb6-4cbd1.png 1179w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2019-11-15-16-32-29-01c45e20b0783eb591eb982aecbcc9fc-28530.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 54.91559086395233%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsSAAALEgHS3X78AAABjElEQVQoz11S25KkIAz1/39wax9Wu21FkQYEwl3tOerDzkwqFQ4hIddmFYJC0kpNjA2MzW0r21YIIaXSWkspjTH+G5Gnm4Gb4/M5Ltq37dhPgmar2447jgq5na/QX7LWmnPJoJSavOcQvM1ujc6XsnrnczHBUa6ags30jkbFtFBSsQpKMkbhrYqZ29AIbY1P0nppSbmoCZy0P6UCW8+1URRXn8VKbxu0T8qFBV6hNn+68e+Tt0yN0gu3SX9Iv7/plMDclJ5bFT7AMOi5AV7s9m+ULdPNOL6miaERV43lO+9bzSmSs/tZfAke0N5KxsaFz834eg59b41FJ8pPgiaEsBpTz2+LdSACjDE+H4++6xrZv0zbBsYSUfnlj8bG6Oe5OAcMA/T2VIbg+t5PU/MaRnwDxkj/B7+mgfOMrBSGgyfkDEYWiPzouhaR+TLzmWMfiOia7Aa77RwrBn4kZHvra72XBDilxJcFwRrO+bqu1p4VYZmuusjMQjyn97DYYbRCYB+wFLcz0oEzMgL4AmVFc9jLrIuGAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2019 11 15 16 32 29" title="" data-src="/static/2019-11-15-16-32-29-01c45e20b0783eb591eb982aecbcc9fc-fee1c.png" data-srcset="/static/2019-11-15-16-32-29-01c45e20b0783eb591eb982aecbcc9fc-a67b7.png 200w,\n/static/2019-11-15-16-32-29-01c45e20b0783eb591eb982aecbcc9fc-0b187.png 400w,\n/static/2019-11-15-16-32-29-01c45e20b0783eb591eb982aecbcc9fc-fee1c.png 800w,\n/static/2019-11-15-16-32-29-01c45e20b0783eb591eb982aecbcc9fc-28530.png 1007w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>',
id:"/home/runner/work/GatsbyBlog/GatsbyBlog/blog/轻量级网站构建实践/index.md absPath of file >>> MarkdownRemark",timeToRead:5,frontmatter:{date:"2019-11-15 15:04:04",path:"/lightweight-website-construction/",tags:"前端, 轻量级网站, 预研",title:"轻量级网站构建实践",draft:null}}],length:26,tag:"预研",pagesSum:6,page:3}}}});