webpackJsonp([0xb3df144b0b3c],{1683:function(n,a){n.exports={data:{site:{siteMetadata:{title:"女王控的博客",description:'前端工程师，黑猫女王控，欢迎勾搭，技术相关<a href="https://github.com/towavephone" target="_blank">@towavephone</a>，QQ闲聊<a href="tencent://AddContact/?fromId=45&fromSubId=1&subcmd=all&uin=634407147&website=www.oicqzone.com">@towave</a>，bili关注<a href="https://space.bilibili.com/11507708#/" target="_blank">@towave</a>',siteUrl:"https://blog.towavephone.com"}},mainPost:{html:'<h1 id="webgl-三维纹理"><a href="#webgl-%E4%B8%89%E7%BB%B4%E7%BA%B9%E7%90%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>WebGL 三维纹理</h1>\n<p>在 WebGL 中如何使用纹理？你可能会从二维图像处理的文章中得到启发，如果我们讲的再深入一点可能更好理解。</p>\n<p>首先需要调整着色器以便使用纹理，这里是顶点着色器的修改部分，我们需要传递纹理坐标，在这个例子中直接将它们传到片断着色器中。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="23293402653145125000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`attribute vec4 a_position;\nattribute vec2 a_texcoord;\n\nuniform mat4 u_matrix;\n\nvarying vec2 v_texcoord;\n\nvoid main() {\n  // 将位置和矩阵相乘\n  gl_Position = u_matrix * a_position;\n\n  // 传递纹理坐标到片断着色器\n  v_texcoord = a_texcoord;\n}`, `23293402653145125000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl{2,6,12-13}"\n              >\n                <span class="gatsby-code-button-language">glsl{2,6,12-13}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">attribute</span> <span class="token keyword">vec4</span> a_position<span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">attribute</span> <span class="token keyword">vec2</span> a_texcoord<span class="token punctuation">;</span></span>\n<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> u_matrix<span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line"><span class="token keyword">varying</span> <span class="token keyword">vec2</span> v_texcoord<span class="token punctuation">;</span></span>\n<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 将位置和矩阵相乘</span>\n  gl_Position <span class="token operator">=</span> u_matrix <span class="token operator">*</span> a_position<span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line">  <span class="token comment">// 传递纹理坐标到片断着色器</span></span><span class="gatsby-highlight-code-line">  v_texcoord <span class="token operator">=</span> a_texcoord<span class="token punctuation">;</span></span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在片断着色器中声明一个 sampler2D 类型的全局变量，可以让我们引用一个纹理，然后使用从顶点着色器传入的纹理坐标调用 texture2D 方法，在纹理上找到对应的颜色。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="26152657011144000000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`precision mediump float;\n\n// 从顶点着色器中传入的值\nvarying vec2 v_texcoord;\n\n// 纹理\nuniform sampler2D u_texture;\n\nvoid main() {\n   gl_FragColor = texture2D(u_texture, v_texcoord);\n}`, `26152657011144000000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl{4,6-7,10}"\n              >\n                <span class="gatsby-code-button-language">glsl{4,6-7,10}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">precision</span> <span class="token keyword">mediump</span> <span class="token keyword">float</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 从顶点着色器中传入的值</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">varying</span> <span class="token keyword">vec2</span> v_texcoord<span class="token punctuation">;</span></span>\n<span class="gatsby-highlight-code-line"><span class="token comment">// 纹理</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">uniform</span> <span class="token keyword">sampler2D</span> u_texture<span class="token punctuation">;</span></span>\n<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n<span class="gatsby-highlight-code-line">   gl_FragColor <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>u_texture<span class="token punctuation">,</span> v_texcoord<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们需要设置纹理坐标</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="75763353747609900000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 找到顶点坐标中的属性\nvar positionLocation = gl.getAttribLocation(program, \'a_position\');\nvar texcoordLocation = gl.getAttribLocation(program, \'a_texcoord\');\n\n// ...\n\n// 为纹理坐标创建一个缓冲\nvar buffer = gl.createBuffer();\ngl.bindBuffer(gl.ARRAY_BUFFER, buffer);\ngl.enableVertexAttribArray(texcoordLocation);\n\n// 以浮点型格式传递纹理坐标\ngl.vertexAttribPointer(texcoordLocation, 2, gl.FLOAT, false, 0, 0);\n\n// 设置纹理坐标\nsetTexcoords(gl);`, `75763353747609900000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{3,7,10,12-13,15-16}"\n              >\n                <span class="gatsby-code-button-language">js{3,7,10,12-13,15-16}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 找到顶点坐标中的属性</span>\n<span class="token keyword">var</span> positionLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'a_position\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">var</span> texcoordLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'a_texcoord\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="token comment">// ...</span>\n\n<span class="gatsby-highlight-code-line"><span class="token comment">// 为纹理坐标创建一个缓冲</span></span><span class="token keyword">var</span> buffer <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line">gl<span class="token punctuation">.</span><span class="token function">enableVertexAttribArray</span><span class="token punctuation">(</span>texcoordLocation<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="gatsby-highlight-code-line"><span class="token comment">// 以浮点型格式传递纹理坐标</span></span><span class="gatsby-highlight-code-line">gl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>texcoordLocation<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="gatsby-highlight-code-line"><span class="token comment">// 设置纹理坐标</span></span><span class="gatsby-highlight-code-line"><span class="token function">setTexcoords</span><span class="token punctuation">(</span>gl<span class="token punctuation">)</span><span class="token punctuation">;</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="f"><a href="#f" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>F</h2>\n<p>如你所见，我们将图像映射到 F 中的每个矩形面上。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="40260745130070430000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 为 F 设置纹理坐标缓冲\nfunction setTexcoords(gl) {\n  gl.bufferData(\n    gl.ARRAY_BUFFER,\n    new Float32Array([\n      // 正面左竖\n      0,\n      0,\n      0,\n      1,\n      1,\n      0,\n      0,\n      1,\n      1,\n      1,\n      1,\n      0,\n\n      // 正面上横\n      0,\n      0,\n      0,\n      1,\n      1,\n      0,\n      0,\n      1,\n      1,\n      1,\n      1,\n      0\n\n      //  ...\n    ]),\n    gl.STATIC_DRAW\n  );\n}`, `40260745130070430000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 为 F 设置纹理坐标缓冲</span>\n<span class="token keyword">function</span> <span class="token function">setTexcoords</span><span class="token punctuation">(</span><span class="token parameter">gl</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  gl<span class="token punctuation">.</span><span class="token function">bufferData</span><span class="token punctuation">(</span>\n    gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span>\n    <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span>\n      <span class="token comment">// 正面左竖</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">1</span><span class="token punctuation">,</span>\n      <span class="token number">1</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">1</span><span class="token punctuation">,</span>\n      <span class="token number">1</span><span class="token punctuation">,</span>\n      <span class="token number">1</span><span class="token punctuation">,</span>\n      <span class="token number">1</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n\n      <span class="token comment">// 正面上横</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">1</span><span class="token punctuation">,</span>\n      <span class="token number">1</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">1</span><span class="token punctuation">,</span>\n      <span class="token number">1</span><span class="token punctuation">,</span>\n      <span class="token number">1</span><span class="token punctuation">,</span>\n      <span class="token number">1</span><span class="token punctuation">,</span>\n      <span class="token number">0</span>\n\n      <span class="token comment">//  ...</span>\n    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    gl<span class="token punctuation">.</span><span class="token constant">STATIC_DRAW</span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>事实上使用一个带有 F 的图像能够在结果中清楚的分辨出纹理的方向。</p>\n<p>我们还需要一个纹理，我们可以从头做一个但在这个例子中就直接加载一个图像，因为那可能是常用的做法。</p>\n<p>这是我们将要使用的图像</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-07-06-11-32-56-600ddd9b9ef854cd730f661916b4f758-34a30.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 256px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 100%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAIAAAAC64paAAAACXBIWXMAAAsSAAALEgHS3X78AAADQElEQVQ4y53Se0wURxwH8O/svVzUAy14R9SkcmrLcXCXAzGBayGmxEeMQhFJjQWixpjYCmo0PojhIbZqaGurRCMhZ1R8lNaYaP/w0dqcxEj/qFUBQcWGcjlB5OEDFXfn5+yKxkTSGJNPJjs7v+9OfjMLmoD3Bl44RPlKUnVcw94ytKqVrRqKgK7o/gG1gm69g9uga6C/tRQecgwQ7j/FyTpvXc0np/1JZ/yeC/74gN9ZfyBWEA9/+l3n/J7f/Ikn/KkHq71tITwlLYjjHL8SavowL3bdEpTvlL78GTMvIvkqnK2YLFxD7EUk/oKMSrZoJYq9WFt8HqcIxxQgiyObMKcfSxJydyP7rDHhpmTvY7JiYCSa0nFY7iHqLxZXi/n5WJByFjmETBEO42wkMXO/tDp+9jmktEn2AZhpFOpt+GIaClJRkIwCLxZ7pM89coYnKtYdbW7QImEqE591M3KjP77MldYKxyPJolghXuz2GdDuNJAHihuqkAA1XvMsTpuSjqmlEm1F/+YfXGk9+ECxMGUqo1zULpatgeXj76yJbimMbimy3yiKbl49pqWIKeWMl70kdm5k1IIHDftcMwYxgkeAp4LW4skh8736mO7Lju46R3epozPHMRg3adeUj9EVkMSt8kZQE9DL2UNCR1+1M0OFkUeCfwbaAvod9AD0GHQJ9C2ez2I0GjUjrWgOGh4TelT0iaM8xNkR7a72xcwchEXsrPpAG3C9UiopjtpWZqv42laRZStPslfaIzPtH6HqLjtKIoXDIpzOWTohvXeXbW4vrKqFPRc952PP7Ah8eMXg6oSrA54gkoKYHkRKCGkKtHqdycTNRoLcWxGx8BYmDECcNqNkVLvHwtQ5KoxkmcsjSLaQbCaLiUxvgA/8U1CSsWdD+NLz8P4L2wBMFI6asWOcCKaDfFB8Wiuv0Wv4kalVoG9M3UXh6/cjM4DEO5hITK5ltk0stJeRKPiJ8WGhHTwEumrsmmPdmIO8EsyohusPjCuFLYBgF0gU/AcalvhvOwihZ6xtq1SyAsvWYekm5G1Bbgnye9BEuKsXBIcl4tt1OwjfESr1Ufhet+PV6vBE2CFwOFR95No0RuDa6Ph/LwDyagrEe1kcagAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 07 06 11 32 56" title="" data-src="/static/2022-07-06-11-32-56-600ddd9b9ef854cd730f661916b4f758-34a30.png" data-srcset="/static/2022-07-06-11-32-56-600ddd9b9ef854cd730f661916b4f758-b25ce.png 200w,\n/static/2022-07-06-11-32-56-600ddd9b9ef854cd730f661916b4f758-34a30.png 256w" data-sizes="(max-width: 256px) 100vw, 256px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>加载图像的过程是异步的，我们请求图像资源后浏览器需要一段时间去下载。通常有两种处理方法，一种是等纹理下载完成后再开始绘制，另一种是在图像加载前使用生成的纹理，这种方式可以立即启动渲染，一旦图像下载完成就拷贝到纹理。我们将使用下方的方法。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="91239473052395960000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 创建一个纹理\nvar texture = gl.createTexture();\ngl.bindTexture(gl.TEXTURE_2D, texture);\n\n// 用 1x1 个蓝色像素填充纹理\ngl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, 1, 1, 0, gl.RGBA, gl.UNSIGNED_BYTE, new Uint8Array([0, 0, 255, 255]));\n\n// 异步加载图像\nvar image = new Image();\nimage.src = \'resources/f-texture.png\';\nimage.addEventListener(\'load\', function () {\n  // 现在图像加载完成，拷贝到纹理中\n  gl.bindTexture(gl.TEXTURE_2D, texture);\n  gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, image);\n  gl.generateMipmap(gl.TEXTURE_2D);\n});`, `91239473052395960000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 创建一个纹理</span>\n<span class="token keyword">var</span> texture <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createTexture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> texture<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 用 1x1 个蓝色像素填充纹理</span>\ngl<span class="token punctuation">.</span><span class="token function">texImage2D</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGBA</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGBA</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">UNSIGNED_BYTE</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 异步加载图像</span>\n<span class="token keyword">var</span> image <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nimage<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">\'resources/f-texture.png\'</span><span class="token punctuation">;</span>\nimage<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">\'load\'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 现在图像加载完成，拷贝到纹理中</span>\n  gl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> texture<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">texImage2D</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGBA</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGBA</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">UNSIGNED_BYTE</span><span class="token punctuation">,</span> image<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">generateMipmap</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/7x6dzh?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>如果我只想使用一部分图像覆盖 ‘F’ 的正面怎么办，纹理是通过“纹理坐标”来引用的，纹理坐标 0.0 到 1.0 对应纹理从左到右，0.0 到 1.0 对应第一个像素所在行到最后一行。注意我没有使用上或者下，上下在纹理坐标空间中是没有意义的，因为绘制一些东西后再重定向后，是没有上下的概念的，主要是依据传递给 WebGL 的纹理数据，纹理数据的开头对应纹理坐标 0, 0，结尾对应纹理坐标 1, 1</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-07-26-17-11-32-0465f57589514b2252f951d56b875d50-be424.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 169px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 88.75739644970415%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAYAAABb0P4QAAAACXBIWXMAAAsSAAALEgHS3X78AAADRElEQVQ4y62UW2gTWRjH/yexChOtJm13G9uZxCZN1azbFratTRHXW1KKwqK++CK+KAMiKroWEW8v4u1BxSo+7KoLgosgqFApiOKtKlrWG6Gt1VrFS0UURbrNZHI+v5mpaVwEZfHAL+dkzv/8ON/hzEDTNFhNVbXCgKYW43+2g66hgaqqdq+parBUC0auAK4NI+DZ4oay+RvgnGeVG3mWY5ubf4LBoC1sKA0VYNrY/HZULnqG2v6XqOt+gZqe5/jli1hzL1DXxbn+G6JqheX4gHoXAoGALZzury3Er8i/iUPLCZfoPc7SIC5QGleGuJpDO6Vwkd6hlYjnbos/tlqONM678ekM6/2N49AIpUU80FsF0WlBqb/wymzBXfMA7pkHxD/MbZsW0WEeFn3mKUGDbZw9JPo2Wo42kCsrLCuOe91zoVQiqU8FUQyULsRKyVME5HGfz4xmxtnPxmCJrAcZDFWhZ5O9qVxhcSjunQsoqErqiHElDVzZ+GYpeLEoWSNF7L0UNb1S1D5l+iTqXktMlQbnCNWOkMfDQn9DwptgoTjSrYvLHLrOwkXrnR0u2y7RTRncYG4xHcxV5hwZ/IzEsT5HeC1XmJjmCLtO6oLuk6CuNNYtdoShiBTxeVLMSEgxp4l3Ol2KozuloKQhqJNE7xlHSJ05JccrvPOskpOzddB8Ai1M4/ewI4yNlGjm81vhkVjN/dJREq1TJGcM0ALCw/iQcMGwMBD3e0uRUNSk0EOsCxPSY9fBFnp35Mkwjc5MIE+mLMvITJkJg3Ok9QhbyOuGhTUJvxdoVLZ3QT/Gob9Z2LTeEf62BfIEIfNnCvJIZgiyMThHux87wuO5wjkzLWFCud8udL7VJN8g9fAmzHPHYfZ2wOT/ptHPvPqMFA2Aum8J+x7SvznCeLUlbFI612I57ePLtYPZyxxk9jA7mV3/wcrsBz1qFvab8nar25199RonFOejYJbnTjkWD0zGWyOKx4OT8GRgIp5YfSr6RXrTUbx5EMFKe4f02ddG86llAd9PcOVNhE+rQMFX4VxpBEXl5SOKfCWR4Ch2KNnvGYtjXP7P1rioutz3Y2W48Gv8wDl/NKSVRMNjeH0Fr5+SPcPv1T4C4QLCt2tV1fcAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 07 26 17 11 32" title="" data-src="/static/2022-07-26-17-11-32-0465f57589514b2252f951d56b875d50-be424.png" data-srcset="/static/2022-07-26-17-11-32-0465f57589514b2252f951d56b875d50-be424.png 169w" data-sizes="(max-width: 169px) 100vw, 169px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>我将纹理载入到 Photoshop 中得到一些点的坐标。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-07-26-17-11-52-1b8b012c6d34e7dd8f80243c6e75a081-bb96f.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 512px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 100%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAIAAAAC64paAAAACXBIWXMAAAsSAAALEgHS3X78AAAEAUlEQVQ4y23Qe1DUVRQH8O/97RsWFldheaXJAjLswqoQMrDApkhaTaOTr15YODWaaCJYKJqCj1EmynQ0dYGspIepM9Y/MiO6QxBlQQ5lSGAgj+FlsaAor989XbBsxpr5zJn5nd/5zr33oGmmosqi7p4h1VnVw8GgIPCgifoQLn4FoDFcWRGhvhmqbAhXNoUp8fNGxdkcrWutsjzXY3C9gjIlOVPimewhoknrWfXr6rJMXUWm6kKW5odsFXgd6CdUl8BdBWoBbwIJzZP1geZ/NOFeHSqLQbUTMChjhFDfjJITMedLHRec8ZeL59aciP621FJ1MrJa+NBS44xyOeeUO+O+KnV8cCjG9T1GCQMycJrjHOHjASyJ3LLU9PyrtoTCgIS8xMizfmGtCL2B0EptRHbsrG1zY3OmL1ydtGCOct1Ol/Q14YtxYCnHs4TFbmRErTygSf10WsjFKUZntPK3aYwAYURizR6qeq3PGc/g3eGzVmlSE8rZMsIzIuzBmScx9YCUFbXoMpJuSoEyNMMGlCTjhXl4OQGvxGFtFDIsihUW/eORPknLtbpaSU+S/g4DuI2RDQNRBdaURoTcVqjHDBCNI/EKtEUqaDbGbZCjRUtzK2LePv+4PN/p54Nji/zjTgaDyfkS7YE776A15Q9MHdew8XBGq1CWrjN881pwy+bAxjcCGzcJpus5Ya7n5n3pUHZs09zZrh7aIU6+xqgRA1eOW+ePQst9wBNB2bh3St1bHdL3nbnvtLkv39y9zDxsCTlsDkX3ZUY3wH8FNQD9nN0mtLuLLakylHwaeCrobdAl0CDoLqgGtB9jixh5oURvxPUexRCJFNxim6c4+4xQ6j5uThuFRpws20G5+KVI2rXdd1+Bae8G096lpt2x/u/4+67wD5KONuJzwikZZSLs4MxBcPQfND3dD4OsYWPizatxZPEUPHpVYe2BtQOzO1lsO2JuG+0XZz31CRKJJcsQKZWKq5UEXf9en+XNCL4Lzbg3ozgU26ZC1aP3IJ1O1mlIp+V2+2Z78oszzR/FxK17LH6DQjkMO3gyKFb1Z67PmgrMaYXpLlRkQKnRGIlOB8iOMfvEU8ae8K5bqP9xgee1hV61aV5X7RjBISYfFRtR3drk86YTSyoR04JHxE3KJL9cqeMYIzFwmHHhfZBwaLIKooM28C5QvbL3ScPW5UjfifnFsFbArwBBNejtZtQq8TZG7fgf4OggdI2w3/dIu9ZizRZkbMVLe5D+liGtIVCs1c1ZlxggdP6XiB+YVEh4l1DEUUR4b0hRdCVgoytkZac2vyYoq817hxjgf0/+S4TNAodZvl9ZiPhs8g44ZtOfC/U7E24sTFFdmjGVECYz8/3hB/4CR7P9mOI83k8AAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 07 26 17 11 52" title="" data-src="/static/2022-07-26-17-11-52-1b8b012c6d34e7dd8f80243c6e75a081-bb96f.png" data-srcset="/static/2022-07-26-17-11-52-1b8b012c6d34e7dd8f80243c6e75a081-7728b.png 200w,\n/static/2022-07-26-17-11-52-1b8b012c6d34e7dd8f80243c6e75a081-23f96.png 400w,\n/static/2022-07-26-17-11-52-1b8b012c6d34e7dd8f80243c6e75a081-bb96f.png 512w" data-sizes="(max-width: 512px) 100vw, 512px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>可以像这样将像素坐标转换到纹理坐标</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="12883915035139394000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`texcoordX = pixelCoordX / (width - 1);\ntexcoordY = pixelCoordY / (height - 1);`, `12883915035139394000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">texcoordX <span class="token operator">=</span> pixelCoordX <span class="token operator">/</span> <span class="token punctuation">(</span>width <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ntexcoordY <span class="token operator">=</span> pixelCoordY <span class="token operator">/</span> <span class="token punctuation">(</span>height <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>这是正面的纹理坐标</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="99844106822190940000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 正面左竖\n 38 / 255,  44 / 255,\n 38 / 255, 223 / 255,\n113 / 255,  44 / 255,\n 38 / 255, 223 / 255,\n113 / 255, 223 / 255,\n113 / 255,  44 / 255,\n\n// 正面上横\n113 / 255, 44 / 255,\n113 / 255, 85 / 255,\n218 / 255, 44 / 255,\n113 / 255, 85 / 255,\n218 / 255, 85 / 255,\n218 / 255, 44 / 255,\n\n// 正面中横\n113 / 255, 112 / 255,\n113 / 255, 151 / 255,\n203 / 255, 112 / 255,\n113 / 255, 151 / 255,\n203 / 255, 151 / 255,\n203 / 255, 112 / 255,`, `99844106822190940000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">// 正面左竖\n 38 / 255,  44 / 255,\n 38 / 255, 223 / 255,\n113 / 255,  44 / 255,\n 38 / 255, 223 / 255,\n113 / 255, 223 / 255,\n113 / 255,  44 / 255,\n\n// 正面上横\n113 / 255, 44 / 255,\n113 / 255, 85 / 255,\n218 / 255, 44 / 255,\n113 / 255, 85 / 255,\n218 / 255, 85 / 255,\n218 / 255, 44 / 255,\n\n// 正面中横\n113 / 255, 112 / 255,\n113 / 255, 151 / 255,\n203 / 255, 112 / 255,\n113 / 255, 151 / 255,\n203 / 255, 151 / 255,\n203 / 255, 112 / 255,</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>对背面也使用相同的纹理坐标，得到这样的结果。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/x9ilbj?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>并不是非常好看，但是希望这样能展示出纹理坐标的用法。如果你使用代码生成几何体（立方体，球体，等等），通常情况下计算期望的纹理坐标也是比较容易的。另一方面如果通过软件例如 Blender, Maya, 3D Studio Max 制作几何体，那么你的美术（或者你自己）就会用软件调整纹理坐标。</p>\n<p>如果纹理坐标再 0.0 到 1.0 之外会怎样？WebGL 默认会重复纹理，0.0 到 1.0 是一份纹理的“拷贝”，1.0 到 2.0 是另外一份拷贝，-4.0 到 -3.0 也是另外一份拷贝。让我们在一个平面上使用这些纹理坐标。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="79401565596822100000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`-3, -1,\n 2, -1,\n-3,  4,\n-3,  4,\n 2, -1,\n 2,  4,`, `79401565596822100000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">-3, -1,\n 2, -1,\n-3,  4,\n-3,  4,\n 2, -1,\n 2,  4,</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这是结果</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/2mkgm4?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>你可以使用 <code class="language-text">CLAMP_TO_EDGE</code> 告诉 WebGL 再某个方向不需要重复，例如</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="38318631865130690000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);\ngl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);`, `38318631865130690000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_WRAP_S</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">CLAMP_TO_EDGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_WRAP_T</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">CLAMP_TO_EDGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>点击上方示例中的按钮，观察结果。</p>\n<p>你可能注意到在加载纹理时调用了 <code class="language-text">gl.generateMipmap</code>，那是干什么的？</p>\n<p>假设我们有这样一个 16×16 像素的纹理。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-07-26-18-15-32-2473614d25fdc3c00c8f3d474452a38d-34a30.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 256px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 100%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAIAAAAC64paAAAACXBIWXMAAAsSAAALEgHS3X78AAADTUlEQVQ4y3WU+0tUQRTHz8zdu66Vrpar677cNE1XdOlmhNRCBUXlriK2a1KJZY8fymLdXr4ipOw/iIh+jR4U9UNmkKVmtb1cAy2NQP1BMvxJix6ud+40s3fNNenw5TBnhg9n5nDOAGXmdlMAGh/PPQBBmPlQRt6a1jumtvbezEIWfktIVE9/IQ3zL7UmsDYAVRQ6NES9Xn6m1VKEVPidLTev5WZ624PeLCcLw6LI/AwIFMG9paucadVgOQWUEJ48GKQ+H+cxVuG3ttzsphvpF6PwLNsHRDF0LFu5wbgHbM3YEgBOhsPcDwxQh4PGxZHI9RicEwPLGMuA3i9JKTZWg7VJtNSD5WQEZibL3E9PU6eTILQYnsGacSFhudkP1jMCy8nIeZgZe/zv33RykmzaxOFVzpxzt9mbn2RJvEI6s8V4WGvxIxVTpSwy+dNn6vO+WZKyuuVGWlt7X2b+c5TqMB9CWReQrQFZTyJrQPUxmVUjkQL2dodOt+S23sq8dK9utXebtgLSL2DjeUhtBkMDGM5G/bNXI/N6zdXdM/R68OvVnlFT7bXM5vs5e8+sc1duKfW53D6Xp9Ll2R1RlcuzByD2Dea5SpjqIf1EfIHfHrgeDBXSKZAnMf0CdOKvBPo1ESCpLqrEoxBXC/pjsKIONMdFx5HNd3aMfDTQSax8B/oD6DTQb3+F6XcddHQNR/V0qKPzA1s87Bx48mL8yqvnGzu2Bt5KJafKXGVVJZXl270VMdq13Vv5n4L1hQYvn17/oCSvs7xK2lYE+2FFK9I3gr4pRo0wO0sWiJCZsTFaVf3OCMWP3AU9ZQNrkx4je7atFtsDmoz6OfH1wsyRPiM7d7Cu6JeMxe07C7pLn0lpLOyKt4hmP+vnBU0S7a5wmN93aopIkqzlA9Sfv1yFg1IKC38KmlGNPtlUxxjRXD8Pk3BYYfzwMHG52FSrg/EPTDCSAXfprJLxABsp0eKPwIRwMhRSamoUhrF5xmgxLGOkAN+/q8suSt0H1sbISLLbTkwoBw/yhDodFQQi8r+ivzAlChfxN8tsUxBmBJF9BtcTHHbzkblrezw8p8FA9XomkpxEdcv611s53FUadGVQcanMNiOnYX0yTYh7qbezb+gPwJ4w/p3YzUQAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 07 26 18 15 32" title="" data-src="/static/2022-07-26-18-15-32-2473614d25fdc3c00c8f3d474452a38d-34a30.png" data-srcset="/static/2022-07-26-18-15-32-2473614d25fdc3c00c8f3d474452a38d-b25ce.png 200w,\n/static/2022-07-26-18-15-32-2473614d25fdc3c00c8f3d474452a38d-34a30.png 256w" data-sizes="(max-width: 256px) 100vw, 256px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>假设我们要将它绘制在屏幕的 2×2 个像素上，那么这 4 个像素应该使用什么颜色？这里有 256 个像素可以选择，如果在 Photoshop 中将 16×16 的图像缩放到 2×2，它会将每个角 8×8 的像素的平均值赋给这四个像素。不幸的是绘制 64 个像素再求平均在 GPU 中是非常慢的。假设你有一个 2048x2048 像素的纹理想要绘制成 2x2 个像素，就需要对 1024x1024 或 100 万个像素求平均 4 次，这需要很多运算同时速度要快。</p>\n<p>事实上 GPU 使用的是一个纹理贴图（mipmap），纹理贴图是一个逐渐缩小的图像集合，每一个是前一个的四分之一大小，16×16 纹理的纹理贴图看起来像这样。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-07-26-18-24-47-826b55e46e30d1e7b02a1f268afb3011-49396.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 526px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 49.80988593155894%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAACn0lEQVQoz32SXUiTURjHn83Nz5E6szWnbUPHJuJHaBATyq/U/EpjbmpCCs2PFG3imuW80MrEJKJQUltptnKZoLeKFwm7y4sgJMIisunKRtb7vr4zt/dpm4gE4e/m/A+c8+M8/A+8n57ecAgEW+sA5DYAVVdUT2mLGyjCk3+ygFyGgK00scax1Ndv+xYldA6kZJHveBH0hRDlj4etPV/GTuSQtcfzVnvPV+2o5PGvwUEQW7i4iMj1RwRAnUaPzWq9L++wOZjPL0eWtG3704ePm4TpGT5QqtAgL8Zw6SXn40GLy9zZikVZuSu9ZWUNueJoEax9tZHogZ5fYJAFTFNBA6NXtzIeIZMp1DAgMWKQuJE29Ew6up+8wZq+DlfLrWy8YkgnLPWVYzNJIrOan6iDPVx/SAp3YdA6j8a2O1hUYMQsKEfg9zMQbESI0NNLb1d+2SzTOFqnwPb0DIxK1JIAAtGe525pCUcpOsaC0tohqqLpOarrx5nqlheYUP0Iawcaccoch5ZxBTM1IUOTKZleHRm20QmxtKlASCzzw5zqwFw7SGvivLJzMYV+3hVvFgKUXByk1I1mVGlNTLl2CvPuN+PIQiy+fKrAVxMy98ykHMdGZd81AIprAOKckxKpiQfSexwQwxElxytKC4r0vbI7OhRgm/69P/KiFW8PncVKnRJPQ6Vn1BtuCO1CONS+Dv4SLvyPsPx/9+u2NZ/QOTfnKYKLHS3x2NOZ4ms5+6jKDZIu5EY32cNDDvO85zPj49jDPDarihvDAn6GzyEKku0LNwiCQqsV3YEB3maxqzMNDddTfUKa7ec+E1mBINLZ5QAhvguhmXAgn2dnKadAgJueb+KVXG1LQn17Mro82QngXmUHY2pEmR2El4N3hacO9P0FBBFJz5t90QUAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 07 26 18 24 47" title="" data-src="/static/2022-07-26-18-24-47-826b55e46e30d1e7b02a1f268afb3011-49396.png" data-srcset="/static/2022-07-26-18-24-47-826b55e46e30d1e7b02a1f268afb3011-68c83.png 200w,\n/static/2022-07-26-18-24-47-826b55e46e30d1e7b02a1f268afb3011-d339c.png 400w,\n/static/2022-07-26-18-24-47-826b55e46e30d1e7b02a1f268afb3011-49396.png 526w" data-sizes="(max-width: 526px) 100vw, 526px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>通常每个子图都是前一级的双线性插值，这就是 <code class="language-text">gl.generateMipmap</code> 做的事情，它根据原始图像创建所有的缩小级别，你也可以自己提供缩小级别的图像。</p>\n<p>现在如果你想将 16x16 像素的纹理绘制到屏幕的 2×2 个像素上，WebGL 会从创建的贴图中找到从之前级别贴图插值出的 2×2 贴图来使用。</p>\n<p>你可以为纹理选择不同的贴图筛选条件来控制 WebGL 的插值，一共有这 6 种模式</p>\n<ol>\n<li><code class="language-text">NEAREST</code> 从最大的贴图中选择 1 个像素</li>\n<li><code class="language-text">LINEAR</code> 从最大的贴图中选择 4 个像素然后混合</li>\n<li><code class="language-text">NEAREST_MIPMAP_NEAREST</code> 选择最合适的贴图，然后从上面找到一个像素</li>\n<li><code class="language-text">LINEAR_MIPMAP_NEAREST</code> 选择最合适的贴图，然后取出 4 个像素进行混合</li>\n<li><code class="language-text">NEAREST_MIPMAP_LINEAR</code> 选择最合适的两个贴图，从每个上面选择 1 个像素然后混合</li>\n<li><code class="language-text">LINEAR_MIPMAP_LINEAR</code> 选择最合适的两个贴图，从每个上选择 4 个像素然后混合</li>\n</ol>\n<p>你可以通过这两个例子看到贴图的重要性，第一个显示的是使用 NEAREST 或 LINEAR，只从最大的贴图上选择像素，当物体运动时就会出现抖动。由于每个像素都从最大的图上选择，随着位置和大小的改变，可能会在不同的时间选择不同的像素，从而出现抖动。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/vqm8in?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>观察发现左边和中间的抖动会多于右边。由于右边的使用多级贴图并且混合颜色，绘制的越小 WebGL 挑选的像素离原图关系越远。相反的中间的小图虽然使用了 LINEAR 混合 4 个像素的颜色，但这 4 个像素是从大图中选出来，不同的选择会有较大的差别，所以还是抖动明显。右下角的图保持颜色一致是从右中图中挑选的像素。</p>\n<p>第二个例子显示了一些深入屏幕中的多边形。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/b83r9o?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>6 个深入屏幕的横梁使用的是之前 6 种不同的筛选模式。</p>\n<ol>\n<li>左上使用的是 NEAREST，你会感受到明显的块状感；</li>\n<li>中上使用的是 LINEAR 也没有好到哪里去；</li>\n<li>右上使用的是 <code class="language-text">NEAREST_MIPMAP_NEAREST</code>，点击图像切换纹理，每个贴图都是不同的颜色，就可以清除的看出它使用的是哪个贴图；</li>\n<li>左下使用的是 <code class="language-text">LINEAR_MIPMAP_NEAREST</code>，意思是挑选最合适贴图种的 4 个像素进行混合，你会发现贴图切换的部分非常突兀；</li>\n<li>中下使用的是 <code class="language-text">NEAREST_MIPMAP_LINEAR</code>，也就是找到最合适的两个贴图各取一点进行混合，如果仔细看会发现仍然有块状感，尤其是水平方向；</li>\n<li>右下使用的是 <code class="language-text">LINEAR_MIPMAP_LINEAR</code>，也就是选出最合适的两个贴图各取 4 个点进行混合。</li>\n</ol>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-07-26-18-34-03-78ccf98aed0504f340a65ea221cc4dd2-d1477.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 536px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 48.50746268656717%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAACFUlEQVQoz4WSTWgTURDHZ5MaSbWpIcSPNiD21IOiN0HwKl71IlUPHnsQFRJIsKtN05Ztg/TkwQoieBJEPTR4KV68BtQe1IOIXqLJpjRhs++9TTb7xpmsQaRCZ3nM7ts3v/nPzAMTPGmCcu+CEqUxJdq2El1fCSGU6/ueqtV27GRyxwbwVC4rXcSubNpOqw7wo/fwiWvjp1rTzirzfWnt9svKBSgB4gKteVorY4i9Dv5j29tKAPBCzOeHu12/U9nwsbSAztUb1Z+YvYSzsA/YGFY0tL4PWlsJrVVba0Stgz57xHZLdPJ54eRylHRe98uriNZyV35BXPOuz6z/ArjCHKTn8fOnUWBlDDPJL49SbneoIgR6PUmapeT3chmRlQIEkhhx+GP9Z2dHLuNk+MFlsjKGPTiG6NRCKCv1ybcastNsug1KICyr7xBMxeO9xrnz745y/CacjIYKAexYDIB7xsEMYRhDGU5JglVKtnRINdYLm8erX1+nbs6+OZJIVA5nMhvp02dWIgyambw2EPY2nQZrepoL+FseQxlmhm0IiuTnQNVPwecY/McymRe7NxkUDiAcCJfPPS1GdLBIf+9FVb1w4uNBPlu4+C1iGFtGKvXBmJp6NIifmHi1Gzg0Lp97yoNidUsMjHj2nfGtA3x2bqQNe5rneVJK5fJl5ku9OK4ElSlImUuwHkG+30pWRwcK99f35P0GGKax+c9h9fsAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 07 26 18 34 03" title="" data-src="/static/2022-07-26-18-34-03-78ccf98aed0504f340a65ea221cc4dd2-d1477.png" data-srcset="/static/2022-07-26-18-34-03-78ccf98aed0504f340a65ea221cc4dd2-bb263.png 200w,\n/static/2022-07-26-18-34-03-78ccf98aed0504f340a65ea221cc4dd2-9a78f.png 400w,\n/static/2022-07-26-18-34-03-78ccf98aed0504f340a65ea221cc4dd2-d1477.png 536w" data-sizes="(max-width: 536px) 100vw, 536px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>你可能会想既然理论上 <code class="language-text">LINEAR_MIPMAP_LINEAR</code> 是最好的选择为什么还要有其他选择</p>\n<ol>\n<li><code class="language-text">LINEAR_MIPMAP_LINEAR</code> 是最慢的，读 8 个像素比读 1 个像素慢一些，在现代的 GPU 上如果一次使用一个贴图可能没什么问题，但是现在的游戏可能一次就需要 2 到 4 个贴图，4 贴图 * 8 像素每贴图 = 绘制每个像素需要读取 32 个像素，那就会慢很多了。</li>\n<li>如果想实现特定的效果，比如做一些复古的东西可能就需要使用 NEAREST。贴图也占用内存，事实上它占用额外 33% 的内存，那是非常多的内存，尤其是使用很大的纹理例如想要在游戏的标题屏幕上绘制的东西。如果你不会绘制比最大的贴图要小的东西，为什么要把内存浪费在贴图上，直接使用 NEAREST 或 LINEAR 就只使用第一个贴图。</li>\n</ol>\n<p>设置筛选器可以调用 <code class="language-text">gl.texParameter</code></p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="51939562656872210000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR_MIPMAP_LINEAR);\ngl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);`, `51939562656872210000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_MIN_FILTER</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">LINEAR_MIPMAP_LINEAR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_MAG_FILTER</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">LINEAR</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<ul>\n<li><code class="language-text">TEXTURE_MIN_FILTER</code> 是当绘制的比最大贴图小的时候。</li>\n<li><code class="language-text">TEXTURE_MAG_FILTER</code> 是绘制的比最大的贴图大的时候。</li>\n<li>对于 <code class="language-text">TEXTURE_MAG_FILTER</code> 只有 NEAREST 和 LINEAR 两个可选设置。</li>\n</ul>\n<p>假设我们想使用这个纹理。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-07-27-11-18-57-ed68bb1d941ff88c000e39ce803fc505-4493b.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 320px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 75%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAIAAABr+ngCAAAACXBIWXMAAAsSAAALEgHS3X78AAADaElEQVQozxVRaVcaZxh9Z4CZgRlmnMyArLLIolhlcaWIrFG2pmg8LohoNcegLUEhCG5piFZjBRPSaM7pMamk1Hh6mn7ol35p+9v6+u2e5973Pve5L5jPLLQRouiDqYNiDgCQ3cxHImEIdvaf7ZWfCgDoUClkUpIUIo3z08ZJdcSinot4cysLj772AwxFRJi4XN65P+yCb8IhX4ec5Rjm5vbTeGCsTYK/u77qULSTmPDXm98yi2moMXcaWFJCCgUgExpZnYq1Xh+HB3rMGoWckeIIMur1335qsXcLUWefjUKB3d77379/93VbxAAkJ+N6jQaDNlaeGtLLN9eWW9WN76L9xWn/esJ98WK79fal26ZzdpvUfBuGgIXUXPP6ZxGKihFA4xgpQDmGAl2WTmgxu7j8/VYWuiqlhFUm7Tdpa9WdP2qljdhAZT5UmA3evv2h+eY46LIE3E6LXsNT4k6TARjVMlpCnp+9DPbbWEqSLz7RtvMIAPXG68rWt9BXw9JWFdejUx6Vc//8cpp7MFya8RZmRo/zd/eDPufgq+eVexiqU8mXlmYVDGnU6//6fON22CgRmoiNKzkWysqlfO3kEAWAE+MqKdGlkYH7zq7dx5n97KIEw2CFKApZEInFmxd1lhDJadJu62JwISMhrq/eraZmIe3zeDzuMQLGS/sc1cdz5/n5vRnPk6Tnm5jHY7ee7G7t57MoglASEpYEizUZjJ9bzcE+OwFAPBqfmpqHnQHIcYyUI0Rzk9HfX6wtjdk2k6NXh9uXexu5+GA6NJjwDnQbtF9Fwh8uGpREiqOIRIhSQgGNCcD0w0mrTg0jZNezhZUUzEwTRHsbbVIqUrHwn2elymyoMO1/f1z6+OZkOTISG7Y5u4xGrYqjpcDvHZVRBHdPdn54MNZrpnHhRDBk0evgbYHx+M3HJs/yuEDEs5zL7kj4hurF1avt9MFStDgXBgIUFQIwOPTlWWmdF4sULJNKrXS0y+CdpUrl6NkBCpAOtcrpcIkxHOYqlJ4eVZ+zDNdrNYNgr1krl2WS8dXkBOQoAZBRJIsLeY6/uLxMzy/Aodfr3zuswf1SSvqqcZ5O3Q1JTATWJjw7D/2NR4ndaV+gR+fqtalVSvi9JrP1p/qPX/Q4oK6NZnm5EgKtwVirn3q8PoiDwcD/9JnJ+bKL33UAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 07 27 11 18 57" title="" data-src="/static/2022-07-27-11-18-57-ed68bb1d941ff88c000e39ce803fc505-4493b.png" data-srcset="/static/2022-07-27-11-18-57-ed68bb1d941ff88c000e39ce803fc505-102e5.png 200w,\n/static/2022-07-27-11-18-57-ed68bb1d941ff88c000e39ce803fc505-4493b.png 320w" data-sizes="(max-width: 320px) 100vw, 320px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>这是结果。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/ibn1oh?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>为什么键盘的纹理没有出现？那是因为 WebGL 限制了纹理的维度必须是 2 的整数次幂，2 的幂有 <code class="language-text">1, 2, 4, 8, 16, 32, 64, 128, 256, 512, 1024, 2048</code> 等等。<code class="language-text">F</code> 纹理是 256 × 256，256 是 2 的幂。键盘纹理是 320x240，都不是 2 的幂，所以显示纹理失败，在着色器中当 texture2D 被调用的时候由于纹理没有正确设置，就会使用颜色 <code class="language-text">(0, 0, 0, 1)</code> 也就是黑色。如果打开 JavaScript 控制台或者浏览器控制台，根据浏览器不同可能会显示不同的错误信息，像这样</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="64061182923910990000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`WebGL: INVALID_OPERATION: generateMipmap: level 0 not power of 2\n   or not all the same size\nWebGL: drawArrays: texture bound to texture unit 0 is not renderable.\n   It maybe non-power-of-2 and have incompatible texture filtering or\n   is not \'texture complete\'.`, `64061182923910990000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">WebGL: INVALID_OPERATION: generateMipmap: level 0 not power of 2\n   or not all the same size\nWebGL: drawArrays: texture bound to texture unit 0 is not renderable.\n   It maybe non-power-of-2 and have incompatible texture filtering or\n   is not &#39;texture complete&#39;.</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>解决这个问题只需要将包裹模式设置为 <code class="language-text">CLAMP_TO_EDGE</code> 并且通过设置过滤器为 <code class="language-text">LINEAR or NEAREST</code> 来关闭贴图映射。</p>\n<p>让我们来更新图像加载的代码解决这个问题，首先需要一个方法判断一个数是不是 2 的幂。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="98745607029603200000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function isPowerOf2(value) {\n  return (value & (value - 1)) == 0;\n}`, `98745607029603200000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">isPowerOf2</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token punctuation">(</span>value <span class="token operator">&amp;</span> <span class="token punctuation">(</span>value <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>我不准备深入讲解二进制运算，以及它的的原理。有了它后，就可以这样使用。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/g387je?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h2 id="6-个面"><a href="#6-%E4%B8%AA%E9%9D%A2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>6 个面</h2>\n<p>一个常见的问题是 <code class="language-text">如何为立方体的每个面设置不同的图像？</code>，假设我们有 6 个这样的图片。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-07-27-11-25-05-5de944cbd03733d24939020a6120f6c2-ad3a8.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 396px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 69.1919191919192%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsSAAALEgHS3X78AAAEAElEQVQ4yxWRW0yTBwCF/2SOxagM5pQoq4CuoKiASpGGu2i5CBStglWGXIWyf4AKAwq0Ugad0mq1SFELTDaYiAoIiJepRLwEAph5QUFFnXFuS3zcEh+Wb+zhPJ7z5Zwj3Ou289hezHitivGqBO5q4xipFxnvsDB4UMPtGjW/95bx4bmdkZOlTDXtZ/LKj1w5+wONubuwqRQcVcdi1Ru42N2HMKZXMpi4iAn9Jh6IMkZS3BkI+oTB8h10ZocyVhDAr21h3GyR87SpmOEDCdxpKKF9exTtG32xBHmhXelK8jwH4uVyhFuaMM6XyjAX+VO1YwUm5UrawhdyIyOIF7Xx/NmZT59xI816OW+v1THRUkjH7khGNdFM/HSU232HqS+Oo3XzGso8XBCGxGC0qR4klXmSJa4gJ0aKNlxKz4zpb1sM7wYqmbxu4fFlM6+GTjFYl8aZzE3c3elPty6NoR4LHSXJNKx3x+K/DOFO6UYqIpeQlezN5q0eJKu8SVi3BL06lOFvQxipSpypupdHnbX8UpdKof9C2tKjGFP50BDogTklHnOEDIPLHMok8/8PjKRZ9jHNKg9EuROqtXPx83XimCGLXrUv9oBZjCY6ciHSGeua2RySzWXEpmPgayX1rg7YAlw4KHWkxPEjWjRpCP+8HOX9tWZedegZPVrE/RYzr4cHeHzjEk9OmnjbcYRpewW/2St5d/YwTxu/Z6znHNMvJpjobefRaRM3G0zc6+/h/t0bCMYaA9k5uewTRcpLSygoKmKbajv2Bgvvb7by7PRBnvx8hKk+Oy8Hz/HH8/uMDvbxorWRWzYr79+9Zur2df6aGmegqREhyFOCsyAgmZHcxRl1iA+m6ly6WowY4mZmSFnKXs1aNCpfCn0W0Kz0o8tawfgZC5NNBbxp2sn0CTUP6tO5pEtBSFntzWonR9YucsZ38WzyYlaxWyEnY3ssplOp5FTFUKJVkhYhJ0HqSrtGybNbfUwcT+ZDayRXLeHsS/VCFyXBmr8eoeWraJQL5pC0QcbVRh3D3SL9x9U0GTPp70rncus3bF7tScSihWwLkmKIl9JZlMW0LZZH1cHUZIURHPwloQFuKDZ4Izw0ZjBWoeZencjDNhun87cwad1B/7E8KgoisFWq0WZuIXyxK6KPhPLFs+gqzuB1r40hwx6M+4PJF/3ISfKiukCGcKE2j39H7LxpFLmYF4lJ5oLVx5G63Qq0M8TqdV9glrlR7Sehevmn6NwdqN+TjH7XVmrVCvap/SjZ4kqbKOV8gR/C8qXuhKxww56toCw+kANxq9ArZs5Iiua7wGXols3D6Ps5hS4OlPtLuFSTi+2QDrf5n5EZ6IU5I4zK9FBO7FpHdsgq/gPV0ZSNWhnZqgAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 07 27 11 25 05" title="" data-src="/static/2022-07-27-11-25-05-5de944cbd03733d24939020a6120f6c2-ad3a8.png" data-srcset="/static/2022-07-27-11-25-05-5de944cbd03733d24939020a6120f6c2-2a85e.png 200w,\n/static/2022-07-27-11-25-05-5de944cbd03733d24939020a6120f6c2-ad3a8.png 396w" data-sizes="(max-width: 396px) 100vw, 396px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>脑中出现了 3 个答案</p>\n<ol>\n<li>\n<p>制作一个复杂的着色器，引用 6 个纹理，传入一些额外的顶点信息表明使用的纹理是什么。不要这样做！稍微一想就知道你要写一大堆不同的着色器应用于不同面数量的图形之类。</p>\n</li>\n<li>\n<p>绘制 6 个面代替立方体，这是常用的解决办法，不错但是只能用在简单的图形例如立方体。如果有一个包含 1000 个方形的图形就要绘制 1000 个面，会非常慢。</p>\n</li>\n<li>\n<p>我敢说，最好的方法就是将图像放在一个纹理中，然后利用纹理坐标映射不同的图像到每个面，这是很多高性能应用（读作游戏）使用的技术。例如我们将所有的图像放入这样一个纹理中</p>\n</li>\n</ol>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-07-27-11-25-42-8e1dad0514f14feaa56c6d74c490f512-bb96f.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 512px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 50%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAAsSAAALEgHS3X78AAACFElEQVQoz2PYWJN+uCP33saOqysaV1QkzosyO9vh8PZk6rm5WRd7I7aXOczJNplZ4Lgs32drTxEfHw8DAwMjIyMDBJyam/l5jdemVv0JiSrTMnT2FJvdnO6+vEPyyvLcU93BNRXmmY12SZFWoepiC7J8hISFUDRfmOR3qdMiI87Q1FLG21b0dr/l0911J9bVPjo6eXW156wJDjO6Yu2kZcPMFNp8tbhZWEGaGWBga2fx0tLoiky1+lS5GbkK27JUz9Y53FyQs7nUpdpGuDJEoz/RIdVEPV+Zp0SCkR2sBaHZ0VCvyM+0JFxrSprehGj9eQG6a/1EN/oKzLAXnuKu2uag2mEh02Yi0emgOifDm4eLA+xsmOZ19RH78yzOlVvsSdaak+Jgpy5rLCkYYKgc6WqanxyyoKmo21GvVkO4xMWmqaGRg4MDxc+HkhS3l2quzNFdGyS2wYnbUZxPnotdW5i1IMQiO8pjSZD56eashZXBjZZyYZKCLMzMDMhgTbxicrFMfKZMjofSdHflJlOZcAOl5V35R1amzCtz2OyvfGBS4bal9fOD9FtVBdH9vDpCrNRHLjpc3sdd2kNf+EJ/4ruVVUc7cxdGm2/Js1rvrTjdXGpCqGOTLHeZkhgXBzuK5hNNvpuipCf7ixe7KpZn+yX4Wa2tDp2XbN3vKl7lorR6Yt1KP6OZlhKdtgbL2qt5eVESCQBl2rROD+pDJwAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 07 27 11 25 42" title="" data-src="/static/2022-07-27-11-25-42-8e1dad0514f14feaa56c6d74c490f512-bb96f.png" data-srcset="/static/2022-07-27-11-25-42-8e1dad0514f14feaa56c6d74c490f512-7728b.png 200w,\n/static/2022-07-27-11-25-42-8e1dad0514f14feaa56c6d74c490f512-23f96.png 400w,\n/static/2022-07-27-11-25-42-8e1dad0514f14feaa56c6d74c490f512-bb96f.png 512w" data-sizes="(max-width: 512px) 100vw, 512px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>然后为立方体的每个面设置不同的纹理坐标。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="23603249807189420000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 选择左下图\n0   , 0  ,\n0   , 0.5,\n0.25, 0  ,\n0   , 0.5,\n0.25, 0.5,\n0.25, 0  ,\n// 选择中下图\n0.25, 0  ,\n0.5 , 0  ,\n0.25, 0.5,\n0.25, 0.5,\n0.5 , 0  ,\n0.5 , 0.5,\n// 选择中右图\n0.5 , 0  ,\n0.5 , 0.5,\n0.75, 0  ,\n0.5 , 0.5,\n0.75, 0.5,\n0.75, 0  ,\n// 选择左上图\n0   , 0.5,\n0.25, 0.5,\n0   , 1  ,\n0   , 1  ,\n0.25, 0.5,\n0.25, 1  ,\n// 选择中上图\n0.25, 0.5,\n0.25, 1  ,\n0.5 , 0.5,\n0.25, 1  ,\n0.5 , 1  ,\n0.5 , 0.5,\n// 选择右上图\n0.5 , 0.5,\n0.75, 0.5,\n0.5 , 1  ,\n0.5 , 1  ,\n0.75, 0.5,\n0.75, 1  ,`, `23603249807189420000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">// 选择左下图\n0   , 0  ,\n0   , 0.5,\n0.25, 0  ,\n0   , 0.5,\n0.25, 0.5,\n0.25, 0  ,\n// 选择中下图\n0.25, 0  ,\n0.5 , 0  ,\n0.25, 0.5,\n0.25, 0.5,\n0.5 , 0  ,\n0.5 , 0.5,\n// 选择中右图\n0.5 , 0  ,\n0.5 , 0.5,\n0.75, 0  ,\n0.5 , 0.5,\n0.75, 0.5,\n0.75, 0  ,\n// 选择左上图\n0   , 0.5,\n0.25, 0.5,\n0   , 1  ,\n0   , 1  ,\n0.25, 0.5,\n0.25, 1  ,\n// 选择中上图\n0.25, 0.5,\n0.25, 1  ,\n0.5 , 0.5,\n0.25, 1  ,\n0.5 , 1  ,\n0.5 , 0.5,\n// 选择右上图\n0.5 , 0.5,\n0.75, 0.5,\n0.5 , 1  ,\n0.5 , 1  ,\n0.75, 0.5,\n0.75, 1  ,</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/7he08e?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>这种将多个图像通过一个纹理提供的方法通常被叫做纹理图集，它是最好的方式，因为只需要加载一个贴图，着色器也会因为只用一个贴图而保持简单，不同于多个平面需要多次调用绘制，这样只需要调用一次绘制。</p>\n<h2 id="uvs-vs-纹理坐标"><a href="#uvs-vs-%E7%BA%B9%E7%90%86%E5%9D%90%E6%A0%87" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>UVs vs. 纹理坐标</h2>\n<p>纹理坐标经常被简写为 <code class="language-text">texture coords</code>，<code class="language-text">texcoords</code> 或 UVs(发音为 Ew-Vees)，我不知道术语 UVs 是从哪来的，除了一点那就是顶点位置使用 <code class="language-text">x, y, z, w</code>，所以对于纹理坐标他们决定使用 <code class="language-text">s, t, u, v</code>，好让你清楚使用的两个类型的区别。有了这些你可能会想它应该读作 Es-Tees，因为纹理包裹的设置被叫做 <code class="language-text">TEXTURE_WRAP_S</code> 和 <code class="language-text">TEXTURE_WRAP_T</code>，但是出于某些原因我的图形相关的同事都叫它 Ew-Vees。</p>\n<p>所以现在你就知道了如果有人说 UVs 其实就是再说纹理坐标。</p>\n<h1 id="webgl-数据纹理"><a href="#webgl-%E6%95%B0%E6%8D%AE%E7%BA%B9%E7%90%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>WebGL 数据纹理</h1>\n<p>上节中讲到了纹理的工作原理以及如何使用，我们用下载的图像创建纹理，在这篇文章中我们将直接用 JavaScript 创建数据。</p>\n<p>用 JavaScript 为纹理创建数据是比较直接的，默认情况下 WebGL1 只支持少量数据类型的纹理</p>\n<table>\n<thead>\n<tr>\n<th align="left">格式</th>\n<th align="left">数据类型</th>\n<th align="left">通道数</th>\n<th align="left">单像素字节数</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align="left">RGBA</td>\n<td align="left">UNSIGNED_BYTE</td>\n<td align="left">4</td>\n<td align="left">4</td>\n</tr>\n<tr>\n<td align="left">RGB</td>\n<td align="left">UNSIGNED_BYTE</td>\n<td align="left">3</td>\n<td align="left">3</td>\n</tr>\n<tr>\n<td align="left">RGBA</td>\n<td align="left"><code class="language-text">UNSIGNED_SHORT_4_4_4_4</code></td>\n<td align="left">4</td>\n<td align="left">2</td>\n</tr>\n<tr>\n<td align="left">RGBA</td>\n<td align="left"><code class="language-text">UNSIGNED_SHORT_5_5_5_1</code></td>\n<td align="left">4</td>\n<td align="left">2</td>\n</tr>\n<tr>\n<td align="left">RGB</td>\n<td align="left"><code class="language-text">UNSIGNED_SHORT_5_6_5</code></td>\n<td align="left">3</td>\n<td align="left">2</td>\n</tr>\n<tr>\n<td align="left">LUMINANCE_ALPHA</td>\n<td align="left">UNSIGNED_BYTE</td>\n<td align="left">2</td>\n<td align="left">2</td>\n</tr>\n<tr>\n<td align="left">LUMINANCE</td>\n<td align="left">UNSIGNED_BYTE</td>\n<td align="left">1</td>\n<td align="left">1</td>\n</tr>\n<tr>\n<td align="left">ALPHA</td>\n<td align="left">UNSIGNED_BYTE</td>\n<td align="left">1</td>\n<td align="left">1</td>\n</tr>\n</tbody>\n</table>\n<p>让我们创建一个 3×2 像素的 LUMINANCE（亮度/黑白）纹理，由于它是 LUMINANCE 纹理，所以每个像素只有一个值，在 R，G，B 通道是相同的。</p>\n<p>我们继续使用上篇文章中的例子，首先修改纹理坐标，每个面使用整个纹理</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="30759095572856410000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 填充立方体纹理坐标的缓冲\nfunction setTexcoords(gl) {\n  gl.bufferData(\n    gl.ARRAY_BUFFER,\n    new Float32Array([\n      // 正面\n      0,\n      0,\n      0,\n      1,\n      1,\n      0,\n      1,\n      0,\n      0,\n      1,\n      1,\n      1\n      // ...\n    ])\n  );\n}`, `30759095572856410000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 填充立方体纹理坐标的缓冲</span>\n<span class="token keyword">function</span> <span class="token function">setTexcoords</span><span class="token punctuation">(</span><span class="token parameter">gl</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  gl<span class="token punctuation">.</span><span class="token function">bufferData</span><span class="token punctuation">(</span>\n    gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span>\n    <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span>\n      <span class="token comment">// 正面</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">1</span><span class="token punctuation">,</span>\n      <span class="token number">1</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">1</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">1</span><span class="token punctuation">,</span>\n      <span class="token number">1</span><span class="token punctuation">,</span>\n      <span class="token number">1</span>\n      <span class="token comment">// ...</span>\n    <span class="token punctuation">]</span><span class="token punctuation">)</span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后修改代码创建一个纹理</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="77519043409132110000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 创建一个纹理\nvar texture = gl.createTexture();\ngl.bindTexture(gl.TEXTURE_2D, texture);\n\n// // 用 1x1 的蓝色像素填充纹理\n// gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, 1, 1, 0, gl.RGBA, gl.UNSIGNED_BYTE,\n//               new Uint8Array([0, 0, 255, 255]));\n\n// 用 3x2 的像素填充纹理\nconst level = 0;\nconst internalFormat = gl.LUMINANCE;\nconst width = 3;\nconst height = 2;\nconst border = 0;\nconst format = gl.LUMINANCE;\nconst type = gl.UNSIGNED_BYTE;\nconst data = new Uint8Array([128, 64, 128, 0, 192, 0]);\ngl.texImage2D(gl.TEXTURE_2D, level, internalFormat, width, height, border, format, type, data);\n\n// 设置筛选器，我们不需要使用贴图所以就不用筛选器了\ngl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);\ngl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);\ngl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);\ngl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);\n\n// // 异步加载图像\n// ...`, `77519043409132110000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 创建一个纹理</span>\n<span class="token keyword">var</span> texture <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createTexture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> texture<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// // 用 1x1 的蓝色像素填充纹理</span>\n<span class="token comment">// gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, 1, 1, 0, gl.RGBA, gl.UNSIGNED_BYTE,</span>\n<span class="token comment">//               new Uint8Array([0, 0, 255, 255]));</span>\n\n<span class="token comment">// 用 3x2 的像素填充纹理</span>\n<span class="token keyword">const</span> level <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> internalFormat <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token constant">LUMINANCE</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> width <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> height <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> border <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> format <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token constant">LUMINANCE</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> type <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token constant">UNSIGNED_BYTE</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">192</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">texImage2D</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> level<span class="token punctuation">,</span> internalFormat<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> border<span class="token punctuation">,</span> format<span class="token punctuation">,</span> type<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 设置筛选器，我们不需要使用贴图所以就不用筛选器了</span>\ngl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_MIN_FILTER</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">NEAREST</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_MAG_FILTER</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">NEAREST</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_WRAP_S</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">CLAMP_TO_EDGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_WRAP_T</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">CLAMP_TO_EDGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// // 异步加载图像</span>\n<span class="token comment">// ...</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/h9ssxi?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>发现不生效，查看 JavaScript 控制台看到这样的错误信息</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="64109382879471075000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`WebGL: INVALID_OPERATION: texImage2D: ArrayBufferView not big enough for request`, `64109382879471075000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">WebGL: INVALID_OPERATION: texImage2D: ArrayBufferView not big enough for request</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>结果是 WebGL 中有一种首次创建 OpenGL 后的模糊设定，计算机有时在数据为某些特定大小时速度会快一些，例如一次拷贝 2，4 或 8 个字节比一次拷贝 1 个字节要快，WebGL 默认使用 4 字节长度，所以它期望每一行数据是多个 4 字节数据（最后一行除外）。</p>\n<p>我们之前的数据每行只有 3 个字节，总共为 6 字节，但是 WebGL 试图在第一行获取 4 个字节，第二行获取 3 个字节，总共 7 个字节，所以会出现这样的报错。</p>\n<p>我们可以告诉 WebGL 一次处理 1 个字节</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="43462770627683440000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const alignment = 1;\ngl.pixelStorei(gl.UNPACK_ALIGNMENT, alignment);`, `43462770627683440000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> alignment <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">pixelStorei</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">UNPACK_ALIGNMENT</span><span class="token punctuation">,</span> alignment<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>有效参数为 1，2，4 和 8</p>\n<p>我觉得你可能无法计算出对齐数据和非对齐数据的速度区别，所以希望默认值是 1 而不是 4，这样这个问题就不会困扰新手，但是为了适配 OpenGL，所以要保留相同的默认设置，这样移植应用就不用改变行数，然后可以为新的应用在需要的地方设置属性为 1。</p>\n<p>有了这个设置后就能正常运行了</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/25tn1o?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h1 id="webgl-渲染到纹理"><a href="#webgl-%E6%B8%B2%E6%9F%93%E5%88%B0%E7%BA%B9%E7%90%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>WebGL 渲染到纹理</h1>\n<p>上篇讲到如何利用 JavaScript 向纹理提供数据，这篇文章我们会使用 WebGL 渲染内容到纹理上，这个话题在图像处理中简单讲到过，但这里将详细介绍。</p>\n<p>渲染到纹理非常简单，创建一个确定大小的纹理</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="4126385100515639300"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 创建渲染对象\nconst targetTextureWidth = 256;\nconst targetTextureHeight = 256;\nconst targetTexture = gl.createTexture();\ngl.bindTexture(gl.TEXTURE_2D, targetTexture);\n\n{\n  // 定义 0 级的大小和格式\n  const level = 0;\n  const internalFormat = gl.RGBA;\n  const border = 0;\n  const format = gl.RGBA;\n  const type = gl.UNSIGNED_BYTE;\n  const data = null;\n  gl.texImage2D(\n    gl.TEXTURE_2D,\n    level,\n    internalFormat,\n    targetTextureWidth,\n    targetTextureHeight,\n    border,\n    format,\n    type,\n    data\n  );\n\n  // 设置筛选器，不需要使用贴图\n  gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);\n  gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);\n  gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);\n}`, `4126385100515639300`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 创建渲染对象</span>\n<span class="token keyword">const</span> targetTextureWidth <span class="token operator">=</span> <span class="token number">256</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> targetTextureHeight <span class="token operator">=</span> <span class="token number">256</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> targetTexture <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createTexture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> targetTexture<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token punctuation">{</span>\n  <span class="token comment">// 定义 0 级的大小和格式</span>\n  <span class="token keyword">const</span> level <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> internalFormat <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token constant">RGBA</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> border <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> format <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token constant">RGBA</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> type <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token constant">UNSIGNED_BYTE</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">texImage2D</span><span class="token punctuation">(</span>\n    gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span>\n    level<span class="token punctuation">,</span>\n    internalFormat<span class="token punctuation">,</span>\n    targetTextureWidth<span class="token punctuation">,</span>\n    targetTextureHeight<span class="token punctuation">,</span>\n    border<span class="token punctuation">,</span>\n    format<span class="token punctuation">,</span>\n    type<span class="token punctuation">,</span>\n    data\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 设置筛选器，不需要使用贴图</span>\n  gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_MIN_FILTER</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">LINEAR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_WRAP_S</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">CLAMP_TO_EDGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_WRAP_T</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">CLAMP_TO_EDGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>注意 data 是 null，我们不需要提供数据，只需要让 WebGL 分配一个纹理。</p>\n<p>接下来创建一个帧缓冲（framebuffer），帧缓冲只是一个附件集，附件是纹理或者 renderbuffers，我们之前讲过纹理，Renderbuffers 和纹理很像但是支持纹理不支持的格式和可选项，同时不能像纹理那样直接将 renderbuffer 提供给着色器。</p>\n<p>让我们来创建一个帧缓冲并和纹理绑定</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="13857228125344356000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 创建并绑定帧缓冲\nconst fb = gl.createFramebuffer();\ngl.bindFramebuffer(gl.FRAMEBUFFER, fb);\n\n// 附加纹理为第一个颜色附件\nconst attachmentPoint = gl.COLOR_ATTACHMENT0;\ngl.framebufferTexture2D(gl.FRAMEBUFFER, attachmentPoint, gl.TEXTURE_2D, targetTexture, level);`, `13857228125344356000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 创建并绑定帧缓冲</span>\n<span class="token keyword">const</span> fb <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createFramebuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">bindFramebuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">FRAMEBUFFER</span><span class="token punctuation">,</span> fb<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 附加纹理为第一个颜色附件</span>\n<span class="token keyword">const</span> attachmentPoint <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token constant">COLOR_ATTACHMENT0</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">framebufferTexture2D</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">FRAMEBUFFER</span><span class="token punctuation">,</span> attachmentPoint<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> targetTexture<span class="token punctuation">,</span> level<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>与纹理和缓冲相似，在创建完帧缓冲后我们需要将它绑定到 FRAMEBUFFER 绑定点，那样所有的方法都会作用到绑定的帧缓冲，无论是哪个帧缓冲。</p>\n<p>绑定帧缓冲后，每次调用 <code class="language-text">gl.clear</code>, <code class="language-text">gl.drawArrays</code> 或 <code class="language-text">gl.drawElements</code> WebGL 都会渲染到纹理上而不是画布上。</p>\n<p>将原来的渲染代码构造成一个方法，就可以调用两次，一次渲染到纹理，一次渲染到画布。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="78559203003595540000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function drawCube(aspect) {\n  // 告诉它使用的程序（着色器对）\n  gl.useProgram(program);\n\n  // 启用位置属性\n  gl.enableVertexAttribArray(positionLocation);\n\n  // 绑定到位置缓冲\n  gl.bindBuffer(gl.ARRAY_BUFFER, positionBuffer);\n\n  // 告诉位置属性如何从 positionBuffer (ARRAY_BUFFER) 中读取数据\n  var size = 3; // 每次迭代需要三个单位数据\n  var type = gl.FLOAT; // 单位数据类型为 32 位浮点型\n  var normalize = false; // 不需要单位化\n  var stride = 0; // 每次迭代移动的距离\n  var offset = 0; // 从缓冲起始处开始\n  gl.vertexAttribPointer(positionLocation, size, type, normalize, stride, offset);\n\n  // 启用纹理坐标属性\n  gl.enableVertexAttribArray(texcoordLocation);\n\n  // 绑定纹理坐标缓冲\n  gl.bindBuffer(gl.ARRAY_BUFFER, texcoordBuffer);\n\n  // 告诉纹理坐标属性如何从 texcoordBuffer 读取数据\n  var size = 2; // 每次迭代两个单位数据\n  var type = gl.FLOAT; // 单位数据类型是 32 位浮点型\n  var normalize = false; // 不需要单位化数据\n  var stride = 0; // 每次迭代移动的数据\n  var offset = 0; // 从缓冲起始处开始\n  gl.vertexAttribPointer(texcoordLocation, size, type, normalize, stride, offset);\n\n  // 计算投影矩阵\n\n  // var aspect = gl.canvas.clientWidth / gl.canvas.clientHeight;\n  var projectionMatrix = m4.perspective(fieldOfViewRadians, aspect, 1, 2000);\n\n  var cameraPosition = [0, 0, 2];\n  var up = [0, 1, 0];\n  var target = [0, 0, 0];\n\n  // 计算相机矩阵\n  var cameraMatrix = m4.lookAt(cameraPosition, target, up);\n\n  // 根据相机矩阵计算视图矩阵\n  var viewMatrix = m4.inverse(cameraMatrix);\n\n  var viewProjectionMatrix = m4.multiply(projectionMatrix, viewMatrix);\n\n  var matrix = m4.xRotate(viewProjectionMatrix, modelXRotationRadians);\n  matrix = m4.yRotate(matrix, modelYRotationRadians);\n\n  // 设置矩阵\n  gl.uniformMatrix4fv(matrixLocation, false, matrix);\n\n  // 使用纹理单元 0\n  gl.uniform1i(textureLocation, 0);\n\n  // 绘制几何体\n  gl.drawArrays(gl.TRIANGLES, 0, 6 * 6);\n}`, `78559203003595540000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">drawCube</span><span class="token punctuation">(</span><span class="token parameter">aspect</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 告诉它使用的程序（着色器对）</span>\n  gl<span class="token punctuation">.</span><span class="token function">useProgram</span><span class="token punctuation">(</span>program<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 启用位置属性</span>\n  gl<span class="token punctuation">.</span><span class="token function">enableVertexAttribArray</span><span class="token punctuation">(</span>positionLocation<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 绑定到位置缓冲</span>\n  gl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> positionBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 告诉位置属性如何从 positionBuffer (ARRAY_BUFFER) 中读取数据</span>\n  <span class="token keyword">var</span> size <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token comment">// 每次迭代需要三个单位数据</span>\n  <span class="token keyword">var</span> type <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">;</span> <span class="token comment">// 单位数据类型为 32 位浮点型</span>\n  <span class="token keyword">var</span> normalize <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// 不需要单位化</span>\n  <span class="token keyword">var</span> stride <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 每次迭代移动的距离</span>\n  <span class="token keyword">var</span> offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 从缓冲起始处开始</span>\n  gl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>positionLocation<span class="token punctuation">,</span> size<span class="token punctuation">,</span> type<span class="token punctuation">,</span> normalize<span class="token punctuation">,</span> stride<span class="token punctuation">,</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 启用纹理坐标属性</span>\n  gl<span class="token punctuation">.</span><span class="token function">enableVertexAttribArray</span><span class="token punctuation">(</span>texcoordLocation<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 绑定纹理坐标缓冲</span>\n  gl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> texcoordBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 告诉纹理坐标属性如何从 texcoordBuffer 读取数据</span>\n  <span class="token keyword">var</span> size <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">// 每次迭代两个单位数据</span>\n  <span class="token keyword">var</span> type <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">;</span> <span class="token comment">// 单位数据类型是 32 位浮点型</span>\n  <span class="token keyword">var</span> normalize <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// 不需要单位化数据</span>\n  <span class="token keyword">var</span> stride <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 每次迭代移动的数据</span>\n  <span class="token keyword">var</span> offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 从缓冲起始处开始</span>\n  gl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>texcoordLocation<span class="token punctuation">,</span> size<span class="token punctuation">,</span> type<span class="token punctuation">,</span> normalize<span class="token punctuation">,</span> stride<span class="token punctuation">,</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 计算投影矩阵</span>\n\n  <span class="token comment">// var aspect = gl.canvas.clientWidth / gl.canvas.clientHeight;</span>\n  <span class="token keyword">var</span> projectionMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">perspective</span><span class="token punctuation">(</span>fieldOfViewRadians<span class="token punctuation">,</span> aspect<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">var</span> cameraPosition <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> up <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> target <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 计算相机矩阵</span>\n  <span class="token keyword">var</span> cameraMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">lookAt</span><span class="token punctuation">(</span>cameraPosition<span class="token punctuation">,</span> target<span class="token punctuation">,</span> up<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 根据相机矩阵计算视图矩阵</span>\n  <span class="token keyword">var</span> viewMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">inverse</span><span class="token punctuation">(</span>cameraMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">var</span> viewProjectionMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>projectionMatrix<span class="token punctuation">,</span> viewMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">var</span> matrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">xRotate</span><span class="token punctuation">(</span>viewProjectionMatrix<span class="token punctuation">,</span> modelXRotationRadians<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  matrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">yRotate</span><span class="token punctuation">(</span>matrix<span class="token punctuation">,</span> modelYRotationRadians<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 设置矩阵</span>\n  gl<span class="token punctuation">.</span><span class="token function">uniformMatrix4fv</span><span class="token punctuation">(</span>matrixLocation<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> matrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 使用纹理单元 0</span>\n  gl<span class="token punctuation">.</span><span class="token function">uniform1i</span><span class="token punctuation">(</span>textureLocation<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 绘制几何体</span>\n  gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TRIANGLES</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">6</span> <span class="token operator">*</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>注意到我们需要传入 aspect 计算投影矩阵，因为目标纹理的比例和画布不同。</p>\n<p>然后这样调用</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="8460290137394110000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 绘制场景\nfunction drawScene(time) {\n  // ...\n\n  {\n    // 通过绑定帧缓冲绘制到纹理\n    gl.bindFramebuffer(gl.FRAMEBUFFER, fb);\n\n    // 使用 3×2 的纹理渲染立方体\n    gl.bindTexture(gl.TEXTURE_2D, texture);\n\n    // 告诉 WebGL 如何从裁剪空间映射到像素空间\n    gl.viewport(0, 0, targetTextureWidth, targetTextureHeight);\n\n    // 清空画布和深度缓冲\n    gl.clearColor(0, 0, 1, 1); // clear to blue\n    gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);\n\n    const aspect = targetTextureWidth / targetTextureHeight;\n    drawCube(aspect);\n  }\n\n  {\n    // 渲染到画布\n    gl.bindFramebuffer(gl.FRAMEBUFFER, null);\n\n    // 立方体使用刚才渲染的纹理\n    gl.bindTexture(gl.TEXTURE_2D, targetTexture);\n\n    // 告诉 WebGL 如何从裁剪空间映射到像素空间\n    gl.viewport(0, 0, gl.canvas.width, gl.canvas.height);\n\n    // 清空画布和深度缓冲\n    gl.clearColor(1, 1, 1, 1); // clear to white\n    gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);\n\n    const aspect = gl.canvas.clientWidth / gl.canvas.clientHeight;\n    drawCube(aspect);\n  }\n\n  requestAnimationFrame(drawScene);\n}`, `8460290137394110000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 绘制场景</span>\n<span class="token keyword">function</span> <span class="token function">drawScene</span><span class="token punctuation">(</span><span class="token parameter">time</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// ...</span>\n\n  <span class="token punctuation">{</span>\n    <span class="token comment">// 通过绑定帧缓冲绘制到纹理</span>\n    gl<span class="token punctuation">.</span><span class="token function">bindFramebuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">FRAMEBUFFER</span><span class="token punctuation">,</span> fb<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// 使用 3×2 的纹理渲染立方体</span>\n    gl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> texture<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// 告诉 WebGL 如何从裁剪空间映射到像素空间</span>\n    gl<span class="token punctuation">.</span><span class="token function">viewport</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> targetTextureWidth<span class="token punctuation">,</span> targetTextureHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// 清空画布和深度缓冲</span>\n    gl<span class="token punctuation">.</span><span class="token function">clearColor</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// clear to blue</span>\n    gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span> <span class="token operator">|</span> gl<span class="token punctuation">.</span><span class="token constant">DEPTH_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">const</span> aspect <span class="token operator">=</span> targetTextureWidth <span class="token operator">/</span> targetTextureHeight<span class="token punctuation">;</span>\n    <span class="token function">drawCube</span><span class="token punctuation">(</span>aspect<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token punctuation">{</span>\n    <span class="token comment">// 渲染到画布</span>\n    gl<span class="token punctuation">.</span><span class="token function">bindFramebuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">FRAMEBUFFER</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// 立方体使用刚才渲染的纹理</span>\n    gl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> targetTexture<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// 告诉 WebGL 如何从裁剪空间映射到像素空间</span>\n    gl<span class="token punctuation">.</span><span class="token function">viewport</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>width<span class="token punctuation">,</span> gl<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// 清空画布和深度缓冲</span>\n    gl<span class="token punctuation">.</span><span class="token function">clearColor</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// clear to white</span>\n    gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span> <span class="token operator">|</span> gl<span class="token punctuation">.</span><span class="token constant">DEPTH_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">const</span> aspect <span class="token operator">=</span> gl<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>clientWidth <span class="token operator">/</span> gl<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>clientHeight<span class="token punctuation">;</span>\n    <span class="token function">drawCube</span><span class="token punctuation">(</span>aspect<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>drawScene<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/r4pvwu?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>十分重要的是要记得调用 gl.viewport 设置要绘制的对象的大小，在这个例子中第一次渲染到纹理，所以设置视图大小覆盖纹理，第二次渲染到画布所以设置视图大小覆盖画布。</p>\n<p>同样的当我们计算投影矩阵的时候需要使用正确的比例，我花了无数个小时调试，寻找出现搞笑的渲染结果的原因，最后发现是少调用了一个 gl.viewport 或者都忘了，并使用正确的比例，由于在代码中很少直接调用 gl.bindFramebuffer 所以就容易忘掉这些。所以我把这个方法调用放在一个方法里，像这样</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="44470869516023920000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function bindFrambufferAndSetViewport(fb, width, height) {\n  gl.bindFramebuffer(gl.FRAMEBUFFER, fb);\n  gl.viewport(0, 0, width, height);\n}`, `44470869516023920000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">bindFrambufferAndSetViewport</span><span class="token punctuation">(</span><span class="token parameter">fb<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  gl<span class="token punctuation">.</span><span class="token function">bindFramebuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">FRAMEBUFFER</span><span class="token punctuation">,</span> fb<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">viewport</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后使用这个方法改变渲染对象，就不容易忘记了。</p>\n<p>还有一个需要注意的事情是我们的帧缓冲没有深度缓冲，只有纹理。这意味着没有深度检测，所以三维就不能正常体现，如果我们绘制三个立方体就会看到这样。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/ybyek1?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>如果仔细看中间的立方体，会看到 3 个垂直绘制的立方体，一个在后面，一个在中间另一个在前面，但是我们绘制的三个立方体是相同深度的，观察画布上水平方向的 3 个立方体就会发现他们是正确相交的。那是因为在帧缓冲中没有深度缓冲，但是画布有。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-07-28-14-10-24-07df0c129841d7423b721ecba2eaf018-eb890.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 47.25568942436412%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAAsSAAALEgHS3X78AAAB4UlEQVQoz2P4DwP//iExwZwfn95e29h0Y/eUR0cX/vn97cfvD2C5v//+Q5UygPhg1suf/6NPfJ1w8MHLb/9//fn5/uPHT99f3Dg2886VXd8/PV6wYW7hLOkHHzYDVYP1/4Vq/gvS/Tfr+n+G6XcZcpWl1rYErJ5g0WgTs5LbM5bHo083cEeFwGRhy4kM5WsYdt/N+fXnK8SBDH9AOv9te/GHYe1/FotglnwGhgYGqQleignmUhYMQCAW6iQ7OY1fncEghUnTn9kplWH6cd1nH09BbX78/a/isf8MvQuYHPkZvaWAGthbtNiiPEUi+IWTeC2zZZI2a9pWMuilMZhFMLk7sCRVM5y5tRaqefa1TwyFS5h74piStBkT1RmUdTWXz9dbFyAcyi0YK2C2yKxis3TdVgYVGyYGBpa4OIarl7L//gbq+8MAcvXv38v27RacOIlBmZep3IFh0S255Uu4W/UYMmUZFBk4u9z0Z0XFNzAULGLyjGaoqVb/8/ctJEogAQYy4eHb9x693QwTDvhc/L/t0vGmWRN67+/on1fRf3bbjmdXN+ztnrRLrX0j4/37O8E6/0CdDXLB378QU+Y9+PPw2z9IrP95fuvNmbXfr+78/fwWyH1/fjz/eBkcydB4BgDHYVtYhhduXQAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 07 28 14 10 24" title="" data-src="/static/2022-07-28-14-10-24-07df0c129841d7423b721ecba2eaf018-fee1c.png" data-srcset="/static/2022-07-28-14-10-24-07df0c129841d7423b721ecba2eaf018-a67b7.png 200w,\n/static/2022-07-28-14-10-24-07df0c129841d7423b721ecba2eaf018-0b187.png 400w,\n/static/2022-07-28-14-10-24-07df0c129841d7423b721ecba2eaf018-fee1c.png 800w,\n/static/2022-07-28-14-10-24-07df0c129841d7423b721ecba2eaf018-b1a91.png 1200w,\n/static/2022-07-28-14-10-24-07df0c129841d7423b721ecba2eaf018-eb890.png 1494w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>想要加深度缓冲就需要创建一个，然后附加到帧缓冲中</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="59903130119309615000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 创建一个深度缓冲\nconst depthBuffer = gl.createRenderbuffer();\ngl.bindRenderbuffer(gl.RENDERBUFFER, depthBuffer);\n\n// 设置深度缓冲的大小和 targetTexture 相同\ngl.renderbufferStorage(gl.RENDERBUFFER, gl.DEPTH_COMPONENT16, targetTextureWidth, targetTextureHeight);\ngl.framebufferRenderbuffer(gl.FRAMEBUFFER, gl.DEPTH_ATTACHMENT, gl.RENDERBUFFER, depthBuffer);`, `59903130119309615000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 创建一个深度缓冲</span>\n<span class="token keyword">const</span> depthBuffer <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createRenderbuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">bindRenderbuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">RENDERBUFFER</span><span class="token punctuation">,</span> depthBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 设置深度缓冲的大小和 targetTexture 相同</span>\ngl<span class="token punctuation">.</span><span class="token function">renderbufferStorage</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">RENDERBUFFER</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">DEPTH_COMPONENT16</span><span class="token punctuation">,</span> targetTextureWidth<span class="token punctuation">,</span> targetTextureHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">framebufferRenderbuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">FRAMEBUFFER</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">DEPTH_ATTACHMENT</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RENDERBUFFER</span><span class="token punctuation">,</span> depthBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>有了这个以后的结果。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/6lvkt6?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>现在帧缓冲附加了深度缓冲以后内部的立方体也能正确相交了。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-07-28-14-11-01-de07cce6dec3e423b4321a8a4721ba21-eb890.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 47.18875502008032%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAAsSAAALEgHS3X78AAAB60lEQVQoz2P4DwZ//oEAmPnvz///P398u7ip69KGput7pt/cPeXMmvpTy0o/3j0Lkv739z8MMECof/9BOq/ev1+1ZYfZni/n3v/6/P7Ww9tHr53c8fTRpQ/vnz2+sefi9Un33h9/8/Ua0C64ZpCNSx58celsY01OZMhyYVi8U235WlUXMY9sYb8gDqMm5+gdLc5Z8mbVDBHLGCpXcD58cR7iBJDNP/7+U9/+j6G5kinXgCVdn8HYRnPrUgFTNeVIRt0oBkEve60lobqVDJlLmRK6WESkGM6fXwrU9ffvb4a/IPf+ib/2n6F2DYsaD+McfQY1BnYXD46CLuF0Dp4UIetUwdJNnLWbGJzSGKVVWQLCGGZMKwBr/sPwG6T5X8+D/wxTX7DriTBHMjFU2YtPrdVcEiYcxy+YIuGwzNxvk6tuGYNaJKNHI5u7F0NBqSHY2f8Y/oA173v9n2HFN4aieIbIBIakFMUlZby9NrxZ4oqeLAz5hvwzA7njGQyzGFXcGH2LGOYfdP/z9ycowCDx8+n3/+Irf2LXbfHsSOzZsHrniztTTuyatH7OhPldMy4caD2+WK2BuXWn3K4bua9/nfj//x9KVEHjCxgH4Nj++/Hdp/MbPl3Z/v7K1v93j90/NHvP9vjP726hxTMAHENVlUPBr4gAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 07 28 14 11 01" title="" data-src="/static/2022-07-28-14-11-01-de07cce6dec3e423b4321a8a4721ba21-fee1c.png" data-srcset="/static/2022-07-28-14-11-01-de07cce6dec3e423b4321a8a4721ba21-a67b7.png 200w,\n/static/2022-07-28-14-11-01-de07cce6dec3e423b4321a8a4721ba21-0b187.png 400w,\n/static/2022-07-28-14-11-01-de07cce6dec3e423b4321a8a4721ba21-fee1c.png 800w,\n/static/2022-07-28-14-11-01-de07cce6dec3e423b4321a8a4721ba21-b1a91.png 1200w,\n/static/2022-07-28-14-11-01-de07cce6dec3e423b4321a8a4721ba21-eb890.png 1494w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>需要特别注意的是 WebGL 只允许三种附件组合形式。根据 <a href="https://registry.khronos.org/webgl/specs/latest/1.0/#FBO_ATTACHMENTS" target="_blank" rel="nofollow noreferrer noopener">规范</a> 一定能正确运行的附件组合是：</p>\n<ul>\n<li><code class="language-text">COLOR_ATTACHMENT0</code> = <code class="language-text">RGBA/UNSIGNED_BYTE</code> texture</li>\n<li><code class="language-text">COLOR_ATTACHMENT0</code> = <code class="language-text">RGBA/UNSIGNED_BYTE</code> texture + <code class="language-text">DEPTH_ATTACHMENT</code> = <code class="language-text">DEPTH_COMPONENT16</code> renderbuffer</li>\n<li><code class="language-text">COLOR_ATTACHMENT0</code> = <code class="language-text">RGBA/UNSIGNED_BYTE</code> texture + <code class="language-text">DEPTH_STENCIL_ATTACHMENT</code> = <code class="language-text">DEPTH_STENCIL</code> renderbuffer</li>\n</ul>\n<p>对于其他的组合就需要检查用户系统/gpu/驱动/浏览器的支持情况。要检查的话需要创建帧缓冲，附加附件，然后调用</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="70009749224033350000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var status = gl.checkFramebufferStatus(gl.FRAMEBUFFER);`, `70009749224033350000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> status <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">checkFramebufferStatus</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">FRAMEBUFFER</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>如果状态是 <code class="language-text">FRAMEBUFFER_COMPLETE</code> 那这种组合就能使用，反之不能使用。你就需要告诉用户他们不走运或者撤销一些方法。</p>\n<blockquote>\n<p><strong>其实 Canvas 本身就是一个纹理</strong></p>\n<p>只是一点小事，浏览器使用上方的技术实现的画布，在背后它们创建了一个颜色纹理，一个深度缓冲，一个帧缓冲，然后绑定到当前的帧缓冲，当你调用你的渲染方法时就会绘制到那个纹理上，然后再用那个纹理将画布渲染到网页中。</p>\n</blockquote>\n<h1 id="webgl-使用多个纹理"><a href="#webgl-%E4%BD%BF%E7%94%A8%E5%A4%9A%E4%B8%AA%E7%BA%B9%E7%90%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>WebGL 使用多个纹理</h1>\n<p>现在可能是一个合适的时机去回答“如何使用 2 个或多个纹理？”。</p>\n<p>非常简单，回到几节之前绘制一个图像的着色器，将它升级到使用两个纹理。</p>\n<p>首先改变代码加载两个图像，这其实不是 WebGL 的事情，是 HTML5 和 JavaScript 的事情，但是我也会涉及到。图像加载是异步的，可能需要适应一下。</p>\n<p>基本上有两种方式来处理图像的加载，一种是重构代码，让它在没有纹理的时候运行，当图像加载后，再更新程序。我们会在以后的文章中用到这个方法。</p>\n<p>这个例子中就等两个图像都加载完成后再开始绘制。</p>\n<p>首先修改加载单个图像的方法，非常简单，先创建一个新的 Image 对象，设置加载的 url，然后设置回调函数在图像加载完成后调用。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="34587576921436990000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function loadImage(url, callback) {\n  var image = new Image();\n  image.src = url;\n  image.onload = callback;\n  return image;\n}`, `34587576921436990000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">loadImage</span><span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> image <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  image<span class="token punctuation">.</span>src <span class="token operator">=</span> url<span class="token punctuation">;</span>\n  image<span class="token punctuation">.</span>onload <span class="token operator">=</span> callback<span class="token punctuation">;</span>\n  <span class="token keyword">return</span> image<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在来创建一个方法加载一个 URL 序列，并且创建一个图像序列。首先设置 imagesToLoad 为加载图像的个数，然后为每个图像调用 loadImage，当 imagesToLoad 递减到 0 的时候说明所有图像加载完成，调用回调函数。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="32603190089183556000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function loadImages(urls, callback) {\n  var images = [];\n  var imagesToLoad = urls.length;\n\n  // 每个图像加载完成后调用一次\n  var onImageLoad = function () {\n    --imagesToLoad;\n    // 如果所有图像都加载完成就调用回调函数\n    if (imagesToLoad == 0) {\n      callback(images);\n    }\n  };\n\n  for (var ii = 0; ii < imagesToLoad; ++ii) {\n    var image = loadImage(urls[ii], onImageLoad);\n    images.push(image);\n  }\n}`, `32603190089183556000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">loadImages</span><span class="token punctuation">(</span><span class="token parameter">urls<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> images <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> imagesToLoad <span class="token operator">=</span> urls<span class="token punctuation">.</span>length<span class="token punctuation">;</span>\n\n  <span class="token comment">// 每个图像加载完成后调用一次</span>\n  <span class="token keyword">var</span> <span class="token function-variable function">onImageLoad</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token operator">--</span>imagesToLoad<span class="token punctuation">;</span>\n    <span class="token comment">// 如果所有图像都加载完成就调用回调函数</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>imagesToLoad <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token function">callback</span><span class="token punctuation">(</span>images<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> ii <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> ii <span class="token operator">&lt;</span> imagesToLoad<span class="token punctuation">;</span> <span class="token operator">++</span>ii<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">var</span> image <span class="token operator">=</span> <span class="token function">loadImage</span><span class="token punctuation">(</span>urls<span class="token punctuation">[</span>ii<span class="token punctuation">]</span><span class="token punctuation">,</span> onImageLoad<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    images<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>image<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后就可以像这样调用 loadImages</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="74561629778733480000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function main() {\n  loadImages([\'resources/leaves.jpg\', \'resources/star.jpg\'], render);\n}`, `74561629778733480000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token function">loadImages</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'resources/leaves.jpg\'</span><span class="token punctuation">,</span> <span class="token string">\'resources/star.jpg\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> render<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>接下来修改着色器使用两个纹理，在这个例子中我们将两个纹理相乘。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="79540766968236600000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<script id=&quot;fragment-shader-2d&quot; type=&quot;x-shader/x-fragment&quot;>\n  precision mediump float;\n\n  // 纹理\n  uniform sampler2D u_image0;\n  uniform sampler2D u_image1;\n\n  // 从顶点着色器传入的 texCoords\n  varying vec2 v_texCoord;\n\n  void main() {\n     vec4 color0 = texture2D(u_image0, v_texCoord);\n     vec4 color1 = texture2D(u_image1, v_texCoord);\n     gl_FragColor = color0 * color1;\n  }\n</script>`, `79540766968236600000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="html"\n              >\n                <span class="gatsby-code-button-language">html</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="html"><pre style="counter-reset: linenumber NaN" class="language-html line-numbers"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>fragment-shader-2d<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>x-shader/x-fragment<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">\n  precision mediump float<span class="token punctuation">;</span>\n\n  <span class="token comment">// 纹理</span>\n  uniform sampler2D u_image0<span class="token punctuation">;</span>\n  uniform sampler2D u_image1<span class="token punctuation">;</span>\n\n  <span class="token comment">// 从顶点着色器传入的 texCoords</span>\n  varying vec2 v_texCoord<span class="token punctuation">;</span>\n\n  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n     vec4 color0 <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>u_image0<span class="token punctuation">,</span> v_texCoord<span class="token punctuation">)</span><span class="token punctuation">;</span>\n     vec4 color1 <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>u_image1<span class="token punctuation">,</span> v_texCoord<span class="token punctuation">)</span><span class="token punctuation">;</span>\n     gl_FragColor <span class="token operator">=</span> color0 <span class="token operator">*</span> color1<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>需要创建两个 WebGL 纹理对象。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="68468539647200140000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 创建两个纹理\nvar textures = [];\nfor (var ii = 0; ii < 2; ++ii) {\n  var texture = gl.createTexture();\n  gl.bindTexture(gl.TEXTURE_2D, texture);\n\n  // 设置参数以便使用任意尺的影像\n  gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);\n  gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);\n  gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);\n  gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);\n\n  // 上传图像到纹理\n  gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, images[ii]);\n\n  // 将纹理添加到纹理序列\n  textures.push(texture);\n}`, `68468539647200140000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 创建两个纹理</span>\n<span class="token keyword">var</span> textures <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> ii <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> ii <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token operator">++</span>ii<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> texture <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createTexture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> texture<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 设置参数以便使用任意尺的影像</span>\n  gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_WRAP_S</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">CLAMP_TO_EDGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_WRAP_T</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">CLAMP_TO_EDGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_MIN_FILTER</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">NEAREST</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_MAG_FILTER</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">NEAREST</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 上传图像到纹理</span>\n  gl<span class="token punctuation">.</span><span class="token function">texImage2D</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGBA</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGBA</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">UNSIGNED_BYTE</span><span class="token punctuation">,</span> images<span class="token punctuation">[</span>ii<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 将纹理添加到纹理序列</span>\n  textures<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>texture<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>WebGL 有一个叫做 <code class="language-text">texture units</code> 的对象，你可以把它看成是一个纹理引用的序列，你需要告诉着色器每个 sampler（取样器）使用哪一个 <code class="language-text">texture unit</code>（纹理单元）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="89557552346771280000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 寻找取样器的位置\nvar u_image0Location = gl.getUniformLocation(program, \'u_image0\');\nvar u_image1Location = gl.getUniformLocation(program, \'u_image1\');\n\n// ...\n\n// 设置使用的纹理单元\ngl.uniform1i(u_image0Location, 0); // 纹理单元 0\ngl.uniform1i(u_image1Location, 1); // 纹理单元 1`, `89557552346771280000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 寻找取样器的位置</span>\n<span class="token keyword">var</span> u_image0Location <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_image0\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> u_image1Location <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_image1\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// ...</span>\n\n<span class="token comment">// 设置使用的纹理单元</span>\ngl<span class="token punctuation">.</span><span class="token function">uniform1i</span><span class="token punctuation">(</span>u_image0Location<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 纹理单元 0</span>\ngl<span class="token punctuation">.</span><span class="token function">uniform1i</span><span class="token punctuation">(</span>u_image1Location<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 纹理单元 1</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后将每个纹理单元绑定纹理。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="212844418010549300"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 设置每个纹理单元对应一个纹理\ngl.activeTexture(gl.TEXTURE0);\ngl.bindTexture(gl.TEXTURE_2D, textures[0]);\n\ngl.activeTexture(gl.TEXTURE1);\ngl.bindTexture(gl.TEXTURE_2D, textures[1]);`, `212844418010549300`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 设置每个纹理单元对应一个纹理</span>\ngl<span class="token punctuation">.</span><span class="token function">activeTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> textures<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\ngl<span class="token punctuation">.</span><span class="token function">activeTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> textures<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>使用的两个图像像这样</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-07-29-11-32-39-4cd92f77f03080b59a4d157d2f8e633c-32662.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 490px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 37.55102040816327%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsSAAALEgHS3X78AAACSUlEQVQozz2RW0gTYACFf9OpKfpgm/O2Oed9q00b3uclzcrExCsmkjMvyRLFttIHK6NRa0mahUXQxQTLii6KBblqEZJGECUmgdVLkvZUEASRfA2DHg6cp3O+wxGXimsZPmhn0mzhbVkJ41mpXC+q4GKNiWullYzUJtPfVky4KpZgmZTw8DCk8mDilSqWGwzQkAD1GjAlQtNGxGR8NK8KtTjL0pgtSuNNeTG3GqxMVDRxs7qGvj2ZHDaVss7HDyHEf7V3dHGkJ43PZLC4msPizyw+fjciXiaoeJocxnS+jLnaBBYsJm50tXK5wl1i7uDRuQsMnurDw9OToKAgjDlG7MdOMuwaRZT4oegOQ+XSo1gxEEUuYkItw6UJ5YvFwLf9aSzUZXGlNoOePG9Gs6OZaS7k9IEqN5WEuNgYvq4s09vdg78mArHkQPTtQyiCER/cnquI+1IfJlMULOQreZcbwfsCNU+yYxjLi+dOeQGuNjPnre1I1v+bvLVwG/0O+5r3fAhedRbEoXuIF7jpVhHjO9WcrY7AqQxgWrOBuY5Upus2M5App3OXlAlzLkOtu/HyD1gLkctDcE49pn5vC5K4IYR3EbJNn5C5fwnV/UI8KAzhxI5ARhK8eaaTsXS7lBWbEUe6L43bfRks8GOgMgUh+UcYqYzE+dyJxWTFEdhLukcKYyEzzKv+8Fr9AzFVX8Bdaw7jlkxm2/KZt23BZTMz2NXM8UY3XUsyZzqr0OoNqKNUJOn0xGkT0coiWU0aYFVv47fuKOjskGznL0nUUudy5vVDAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 07 29 11 32 39" title="" data-src="/static/2022-07-29-11-32-39-4cd92f77f03080b59a4d157d2f8e633c-32662.png" data-srcset="/static/2022-07-29-11-32-39-4cd92f77f03080b59a4d157d2f8e633c-ee8ca.png 200w,\n/static/2022-07-29-11-32-39-4cd92f77f03080b59a4d157d2f8e633c-15948.png 400w,\n/static/2022-07-29-11-32-39-4cd92f77f03080b59a4d157d2f8e633c-32662.png 490w" data-sizes="(max-width: 490px) 100vw, 490px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>这就是使用 WebGL 将它们相乘的结果。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/plcqlr?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>有些需要回顾的部分。</p>\n<p>理解纹理单元的简单方式是：所有的纹理方法可以在 <code class="language-text">激活的纹理单元</code> 上使用，<code class="language-text">激活的纹理单元</code> 就是一个全局变量指向你想使用的所有纹理单元，每个纹理单元有两个目标对象，<code class="language-text">TEXTURE_2D</code> 目标和 <code class="language-text">TEXTURE_CUBE_MAP</code> 目标。每个纹理方法针对激活纹理单元上的一个目标，如果用 JavaScript 表示 WebGL 方法可能像这样</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="54869050700171580000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var getContext = function() {\n  var textureUnits = [\n    { TEXTURE_2D: ??, TEXTURE_CUBE_MAP: ?? },\n    { TEXTURE_2D: ??, TEXTURE_CUBE_MAP: ?? },\n    { TEXTURE_2D: ??, TEXTURE_CUBE_MAP: ?? },\n    { TEXTURE_2D: ??, TEXTURE_CUBE_MAP: ?? },\n    { TEXTURE_2D: ??, TEXTURE_CUBE_MAP: ?? },\n    // ...\n   ];\n  var activeTextureUnit = 0;\n\n  var activeTexture = function(unit) {\n    // 将纹理单元枚举转换成索引\n    var index = unit - gl.TEXTURE0;\n    // 设置激活纹理单元\n    activeTextureUnit = index;\n  };\n\n  var bindTexture = function(target, texture) {\n    // 设置激活纹理单元的目标对象纹理\n    textureUnits[activeTextureUnit][target] = texture;\n  };\n\n  var texImage2D = function(target, ... args ...) {\n    // 绑定对应纹理单元调用相应的方法\n    var texture = textureUnits[activeTextureUnit][target];\n    texture.image2D(...args...);\n  };\n\n  // 返回 WebGL API\n  return {\n    activeTexture: activeTexture,\n    bindTexture: bindTexture,\n    texImage2D: texImage2D,\n  }\n};`, `54869050700171580000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> <span class="token function-variable function">getContext</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> textureUnits <span class="token operator">=</span> <span class="token punctuation">[</span>\n    <span class="token punctuation">{</span> <span class="token constant">TEXTURE_2D</span><span class="token punctuation">:</span> <span class="token operator">?</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token constant">TEXTURE_CUBE_MAP</span><span class="token punctuation">:</span> <span class="token operator">?</span><span class="token operator">?</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token punctuation">{</span> <span class="token constant">TEXTURE_2D</span><span class="token punctuation">:</span> <span class="token operator">?</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token constant">TEXTURE_CUBE_MAP</span><span class="token punctuation">:</span> <span class="token operator">?</span><span class="token operator">?</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token punctuation">{</span> <span class="token constant">TEXTURE_2D</span><span class="token punctuation">:</span> <span class="token operator">?</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token constant">TEXTURE_CUBE_MAP</span><span class="token punctuation">:</span> <span class="token operator">?</span><span class="token operator">?</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token punctuation">{</span> <span class="token constant">TEXTURE_2D</span><span class="token punctuation">:</span> <span class="token operator">?</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token constant">TEXTURE_CUBE_MAP</span><span class="token punctuation">:</span> <span class="token operator">?</span><span class="token operator">?</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token punctuation">{</span> <span class="token constant">TEXTURE_2D</span><span class="token punctuation">:</span> <span class="token operator">?</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token constant">TEXTURE_CUBE_MAP</span><span class="token punctuation">:</span> <span class="token operator">?</span><span class="token operator">?</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token comment">// ...</span>\n   <span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> activeTextureUnit <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">var</span> <span class="token function-variable function">activeTexture</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">unit</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 将纹理单元枚举转换成索引</span>\n    <span class="token keyword">var</span> index <span class="token operator">=</span> unit <span class="token operator">-</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE0</span><span class="token punctuation">;</span>\n    <span class="token comment">// 设置激活纹理单元</span>\n    activeTextureUnit <span class="token operator">=</span> index<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">var</span> <span class="token function-variable function">bindTexture</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> texture</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 设置激活纹理单元的目标对象纹理</span>\n    textureUnits<span class="token punctuation">[</span>activeTextureUnit<span class="token punctuation">]</span><span class="token punctuation">[</span>target<span class="token punctuation">]</span> <span class="token operator">=</span> texture<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">var</span> <span class="token function-variable function">texImage2D</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> <span class="token operator">...</span> args <span class="token operator">...</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 绑定对应纹理单元调用相应的方法</span>\n    <span class="token keyword">var</span> texture <span class="token operator">=</span> textureUnits<span class="token punctuation">[</span>activeTextureUnit<span class="token punctuation">]</span><span class="token punctuation">[</span>target<span class="token punctuation">]</span><span class="token punctuation">;</span>\n    texture<span class="token punctuation">.</span><span class="token function">image2D</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 返回 WebGL API</span>\n  <span class="token keyword">return</span> <span class="token punctuation">{</span>\n    activeTexture<span class="token punctuation">:</span> activeTexture<span class="token punctuation">,</span>\n    bindTexture<span class="token punctuation">:</span> bindTexture<span class="token punctuation">,</span>\n    texImage2D<span class="token punctuation">:</span> texImage2D<span class="token punctuation">,</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>着色器获得纹理单元</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="70622764418165730000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`gl.uniform1i(u_image0Location, 0); // 纹理单元 0\ngl.uniform1i(u_image1Location, 1); // 纹理单元 1`, `70622764418165730000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">gl<span class="token punctuation">.</span><span class="token function">uniform1i</span><span class="token punctuation">(</span>u_image0Location<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 纹理单元 0</span>\ngl<span class="token punctuation">.</span><span class="token function">uniform1i</span><span class="token punctuation">(</span>u_image1Location<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 纹理单元 1</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>需要注意的是，设置全局变量的时候使用索引代替纹理单元，但是调用 <code class="language-text">gl.activeTexture</code> 的时候你需要传递特殊的常量 <code class="language-text">gl.TEXTURE0</code>, <code class="language-text">gl.TEXTURE1</code> 之类。幸运的是这些常量是连续的，所以这些代码</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="80541886877451260000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`gl.activeTexture(gl.TEXTURE0);\ngl.bindTexture(gl.TEXTURE_2D, textures[0]);\n\ngl.activeTexture(gl.TEXTURE1);\ngl.bindTexture(gl.TEXTURE_2D, textures[1]);`, `80541886877451260000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">gl<span class="token punctuation">.</span><span class="token function">activeTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> textures<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\ngl<span class="token punctuation">.</span><span class="token function">activeTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> textures<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以写成这样</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="36527827088240940000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`gl.activeTexture(gl.TEXTURE0 + 0);\ngl.bindTexture(gl.TEXTURE_2D, textures[0]);\n\ngl.activeTexture(gl.TEXTURE0 + 1);\ngl.bindTexture(gl.TEXTURE_2D, textures[1]);`, `36527827088240940000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">gl<span class="token punctuation">.</span><span class="token function">activeTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE0</span> <span class="token operator">+</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> textures<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\ngl<span class="token punctuation">.</span><span class="token function">activeTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE0</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> textures<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>或这样</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="58779716176148050000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`for (var ii = 0; ii < 2; ++ii) {\n  gl.activeTexture(gl.TEXTURE0 + ii);\n  gl.bindTexture(gl.TEXTURE_2D, textures[ii]);\n}`, `58779716176148050000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> ii <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> ii <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token operator">++</span>ii<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  gl<span class="token punctuation">.</span><span class="token function">activeTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE0</span> <span class="token operator">+</span> ii<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> textures<span class="token punctuation">[</span>ii<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>希望这样能够帮助你理解 WebGL 单次绘制中如何使用多个纹理。</p>\n<h1 id="webgl-纹理映射的透视纠正"><a href="#webgl-%E7%BA%B9%E7%90%86%E6%98%A0%E5%B0%84%E7%9A%84%E9%80%8F%E8%A7%86%E7%BA%A0%E6%AD%A3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>WebGL 纹理映射的透视纠正</h1>\n<p>这篇文章讲纹理映射的透视纠正，要理解它你可能需要先看看透视投影和纹理，你也需要知道可变量以及它的用处，但是我还会简短的介绍一下。</p>\n<p>在工作原理中我们讲过了可变量的工作原理，顶点着色器可以声明可变量并给它赋值，一旦顶点着色器被引用 3 次就会画一个三角形。绘制这个三角形的每个像素都会调用片断着色器获得像素颜色，在三个顶点之间的点会得到差之后的可变量。</p>\n<html><head></head><body><iframe data-src="https://codesandbox.io/embed/zi15x?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe></body></html>\n<!-- [fragment-shader-anim](embedded-codesandbox://webgl-fundamental-base-concept/fragment-shader-anim?view=preview) -->\n<h2 id="矩形"><a href="#%E7%9F%A9%E5%BD%A2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>矩形</h2>\n<p>回到我们的第一篇文章，在裁剪空间中绘制一个三角形，没有数学运算，只是传入裁剪空间坐标到一个简单的顶点着色器，像这样</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="27396762848307143000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 属性从缓冲中获取数据\nattribute vec4 a_position;\n\n// 所有的着色器都有一个 main 函数\nvoid main() {\n\n   // gl_Position 是着色器需要设置的一个特殊的变量\n   gl_Position = a_position;\n}`, `27396762848307143000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl"\n              >\n                <span class="gatsby-code-button-language">glsl</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token comment">// 属性从缓冲中获取数据</span>\n<span class="token keyword">attribute</span> <span class="token keyword">vec4</span> a_position<span class="token punctuation">;</span>\n\n<span class="token comment">// 所有的着色器都有一个 main 函数</span>\n<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n\n   <span class="token comment">// gl_Position 是着色器需要设置的一个特殊的变量</span>\n   gl_Position <span class="token operator">=</span> a_position<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>还有一个简单的片断着色器提供固定的颜色</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="6839556666939694000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 片断着色器没有默认的精度，\n// 中等精度是个不错的默认值\nprecision mediump float;\n\nvoid main() {\n   // gl_FragColor 是片断着色器需要设置的一个特殊变量\n   gl_FragColor = vec4(1, 0, 0.5, 1); // 返回红紫色\n}`, `6839556666939694000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl"\n              >\n                <span class="gatsby-code-button-language">glsl</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token comment">// 片断着色器没有默认的精度，</span>\n<span class="token comment">// 中等精度是个不错的默认值</span>\n<span class="token keyword">precision</span> <span class="token keyword">mediump</span> <span class="token keyword">float</span><span class="token punctuation">;</span>\n\n<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token comment">// gl_FragColor 是片断着色器需要设置的一个特殊变量</span>\n   gl_FragColor <span class="token operator">=</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 返回红紫色</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>让我们在裁剪空间绘制两个矩形，为每个顶点传递 X, Y, Z 和 W。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="84830056971836030000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var positions = [\n  // 第一个矩形的第一个三角形\n  -0.8,\n  -0.8,\n  0,\n  1,\n  0.8,\n  -0.8,\n  0,\n  1,\n  -0.8,\n  -0.2,\n  0,\n  1,\n\n  // 第一个矩形的第二个三角形\n  -0.8,\n  -0.2,\n  0,\n  1,\n  0.8,\n  -0.8,\n  0,\n  1,\n  0.8,\n  -0.2,\n  0,\n  1,\n\n  // 第二个矩形的第一个三角形\n  -0.8,\n  0.2,\n  0,\n  1,\n  0.8,\n  0.2,\n  0,\n  1,\n  -0.8,\n  0.8,\n  0,\n  1,\n\n  // 第二个矩形的第二个三角形\n  -0.8,\n  0.8,\n  0,\n  1,\n  0.8,\n  0.2,\n  0,\n  1,\n  0.8,\n  0.8,\n  0,\n  1\n];`, `84830056971836030000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> positions <span class="token operator">=</span> <span class="token punctuation">[</span>\n  <span class="token comment">// 第一个矩形的第一个三角形</span>\n  <span class="token operator">-</span><span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token operator">-</span><span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token number">0</span><span class="token punctuation">,</span>\n  <span class="token number">1</span><span class="token punctuation">,</span>\n  <span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token operator">-</span><span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token number">0</span><span class="token punctuation">,</span>\n  <span class="token number">1</span><span class="token punctuation">,</span>\n  <span class="token operator">-</span><span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token operator">-</span><span class="token number">0.2</span><span class="token punctuation">,</span>\n  <span class="token number">0</span><span class="token punctuation">,</span>\n  <span class="token number">1</span><span class="token punctuation">,</span>\n\n  <span class="token comment">// 第一个矩形的第二个三角形</span>\n  <span class="token operator">-</span><span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token operator">-</span><span class="token number">0.2</span><span class="token punctuation">,</span>\n  <span class="token number">0</span><span class="token punctuation">,</span>\n  <span class="token number">1</span><span class="token punctuation">,</span>\n  <span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token operator">-</span><span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token number">0</span><span class="token punctuation">,</span>\n  <span class="token number">1</span><span class="token punctuation">,</span>\n  <span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token operator">-</span><span class="token number">0.2</span><span class="token punctuation">,</span>\n  <span class="token number">0</span><span class="token punctuation">,</span>\n  <span class="token number">1</span><span class="token punctuation">,</span>\n\n  <span class="token comment">// 第二个矩形的第一个三角形</span>\n  <span class="token operator">-</span><span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token number">0.2</span><span class="token punctuation">,</span>\n  <span class="token number">0</span><span class="token punctuation">,</span>\n  <span class="token number">1</span><span class="token punctuation">,</span>\n  <span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token number">0.2</span><span class="token punctuation">,</span>\n  <span class="token number">0</span><span class="token punctuation">,</span>\n  <span class="token number">1</span><span class="token punctuation">,</span>\n  <span class="token operator">-</span><span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token number">0</span><span class="token punctuation">,</span>\n  <span class="token number">1</span><span class="token punctuation">,</span>\n\n  <span class="token comment">// 第二个矩形的第二个三角形</span>\n  <span class="token operator">-</span><span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token number">0</span><span class="token punctuation">,</span>\n  <span class="token number">1</span><span class="token punctuation">,</span>\n  <span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token number">0.2</span><span class="token punctuation">,</span>\n  <span class="token number">0</span><span class="token punctuation">,</span>\n  <span class="token number">1</span><span class="token punctuation">,</span>\n  <span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token number">0</span><span class="token punctuation">,</span>\n  <span class="token number">1</span>\n<span class="token punctuation">]</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这是结果</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/oqzsfs?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>再添加一个浮点型可变量，并把它从顶点着色器直接传递到片断着色器</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="17068494635091081000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`attribute vec4 a_position;\nattribute float a_brightness;\n\nvarying float v_brightness;\n\nvoid main() {\n   gl_Position = a_position;\n\n   // 直接传递亮度到片断着色器\n   v_brightness = a_brightness;\n}`, `17068494635091081000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl{2,4,9-10}"\n              >\n                <span class="gatsby-code-button-language">glsl{2,4,9-10}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">attribute</span> <span class="token keyword">vec4</span> a_position<span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">attribute</span> <span class="token keyword">float</span> a_brightness<span class="token punctuation">;</span></span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">varying</span> <span class="token keyword">float</span> v_brightness<span class="token punctuation">;</span></span>\n<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   gl_Position <span class="token operator">=</span> a_position<span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line">   <span class="token comment">// 直接传递亮度到片断着色器</span></span><span class="gatsby-highlight-code-line">   v_brightness <span class="token operator">=</span> a_brightness<span class="token punctuation">;</span></span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在片断着色器中使用可变量设置颜色</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="30257701699265892000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`precision mediump float;\n\n// 顶点着色器的值插值后传入这里\nvarying float v_brightness;\n\nvoid main() {\n   gl_FragColor = vec4(v_brightness, 0, 0, 1);  // 红色\n}`, `30257701699265892000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl{3-4,7}"\n              >\n                <span class="gatsby-code-button-language">glsl{3-4,7}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">precision</span> <span class="token keyword">mediump</span> <span class="token keyword">float</span><span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line"><span class="token comment">// 顶点着色器的值插值后传入这里</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">varying</span> <span class="token keyword">float</span> v_brightness<span class="token punctuation">;</span></span>\n<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n<span class="gatsby-highlight-code-line">   gl_FragColor <span class="token operator">=</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>v_brightness<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 红色</span></span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们需要给可变量提供数据，创建一个缓冲放入一些数据，每个顶点一个值，我们将设置左边亮度为 0，右边亮度为 1。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="12900565684510611000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 创建缓冲并放入 12 个亮度值\nvar brightnessBuffer = gl.createBuffer();\n\n// 绑定到 ARRAY_BUFFER\ngl.bindBuffer(gl.ARRAY_BUFFER, brightnessBuffer);\n\nvar brightness = [\n  // 第一个矩形的第一个三角形\n  0,\n  1,\n  0,\n\n  // 第一个矩形的第二个三角形\n  0,\n  1,\n  1,\n\n  // 第二个矩形的第一个三角形\n  0,\n  1,\n  0,\n\n  // 第二个矩形的第二个三角形\n  0,\n  1,\n  1\n];\n\ngl.bufferData(gl.ARRAY_BUFFER, new Float32Array(brightness), gl.STATIC_DRAW);`, `12900565684510611000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 创建缓冲并放入 12 个亮度值</span>\n<span class="token keyword">var</span> brightnessBuffer <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 绑定到 ARRAY_BUFFER</span>\ngl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> brightnessBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">var</span> brightness <span class="token operator">=</span> <span class="token punctuation">[</span>\n  <span class="token comment">// 第一个矩形的第一个三角形</span>\n  <span class="token number">0</span><span class="token punctuation">,</span>\n  <span class="token number">1</span><span class="token punctuation">,</span>\n  <span class="token number">0</span><span class="token punctuation">,</span>\n\n  <span class="token comment">// 第一个矩形的第二个三角形</span>\n  <span class="token number">0</span><span class="token punctuation">,</span>\n  <span class="token number">1</span><span class="token punctuation">,</span>\n  <span class="token number">1</span><span class="token punctuation">,</span>\n\n  <span class="token comment">// 第二个矩形的第一个三角形</span>\n  <span class="token number">0</span><span class="token punctuation">,</span>\n  <span class="token number">1</span><span class="token punctuation">,</span>\n  <span class="token number">0</span><span class="token punctuation">,</span>\n\n  <span class="token comment">// 第二个矩形的第二个三角形</span>\n  <span class="token number">0</span><span class="token punctuation">,</span>\n  <span class="token number">1</span><span class="token punctuation">,</span>\n  <span class="token number">1</span>\n<span class="token punctuation">]</span><span class="token punctuation">;</span>\n\ngl<span class="token punctuation">.</span><span class="token function">bufferData</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span>brightness<span class="token punctuation">)</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">STATIC_DRAW</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>还需要在初始化阶段找到 <code class="language-text">a_brightness</code> 的位置</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="35607653226173985000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 找到顶点数据的输入位置\nvar positionAttributeLocation = gl.getAttribLocation(program, \'a_position\');\nvar brightnessAttributeLocation = gl.getAttribLocation(program, \'a_brightness\');`, `35607653226173985000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{3}"\n              >\n                <span class="gatsby-code-button-language">js{3}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 找到顶点数据的输入位置</span>\n<span class="token keyword">var</span> positionAttributeLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'a_position\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">var</span> brightnessAttributeLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'a_brightness\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后在渲染阶段设置属性</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="97294112874525840000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 启用属性\ngl.enableVertexAttribArray(brightnessAttributeLocation);\n\n// 绑定位置缓冲\ngl.bindBuffer(gl.ARRAY_BUFFER, brightnessBuffer);\n\n// 告诉属性如何从缓冲中读取数据\nvar size = 1; // 每次迭代读取一个单位数据\nvar type = gl.FLOAT; // 数据类型是 32 位浮点型\nvar normalize = false; // 不用单位化\nvar stride = 0; // 每次迭代需要移动的距离\nvar offset = 0; // 从缓冲的起始处开始\ngl.vertexAttribPointer(brightnessAttributeLocation, size, type, normalize, stride, offset);`, `97294112874525840000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 启用属性</span>\ngl<span class="token punctuation">.</span><span class="token function">enableVertexAttribArray</span><span class="token punctuation">(</span>brightnessAttributeLocation<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 绑定位置缓冲</span>\ngl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> brightnessBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 告诉属性如何从缓冲中读取数据</span>\n<span class="token keyword">var</span> size <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 每次迭代读取一个单位数据</span>\n<span class="token keyword">var</span> type <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">;</span> <span class="token comment">// 数据类型是 32 位浮点型</span>\n<span class="token keyword">var</span> normalize <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// 不用单位化</span>\n<span class="token keyword">var</span> stride <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 每次迭代需要移动的距离</span>\n<span class="token keyword">var</span> offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 从缓冲的起始处开始</span>\ngl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>brightnessAttributeLocation<span class="token punctuation">,</span> size<span class="token punctuation">,</span> type<span class="token punctuation">,</span> normalize<span class="token punctuation">,</span> stride<span class="token punctuation">,</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在渲染后得到会得到两个矩形，左边 brightness 是 0 右边是 1，中间的部分是插值（或可变量）。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/cfvjcf?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>在透视投影的文章中我们知道 WebGL 会将放入 <code class="language-text">gl_Position</code> 的值除以 <code class="language-text">gl_Position.w</code>。</p>\n<p>在上方的顶点中我们提供的 W 值为 1，但是我们知道 WebGL 会除以 W，所以做如下修改应该结果不变。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="36181112853803700000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var mult = 20;\nvar positions = [\n  // 第一个矩形的第一个三角形\n  -0.8,\n  0.8,\n  0,\n  1,\n  0.8,\n  0.8,\n  0,\n  1,\n  -0.8,\n  0.2,\n  0,\n  1,\n\n  // 第一个矩形的第二个三角形\n  -0.8,\n  0.2,\n  0,\n  1,\n  0.8,\n  0.8,\n  0,\n  1,\n  0.8,\n  0.2,\n  0,\n  1,\n\n  // 第二个矩形的第一个三角形\n  -0.8,\n  -0.2,\n  0,\n  1,\n  0.8 * mult,\n  -0.2 * mult,\n  0,\n  mult,\n  -0.8,\n  -0.8,\n  0,\n  1,\n\n  // 第二个矩形的第二个三角形\n  -0.8,\n  -0.8,\n  0,\n  1,\n  0.8 * mult,\n  -0.2 * mult,\n  0,\n  mult,\n  0.8 * mult,\n  -0.8 * mult,\n  0,\n  mult\n];`, `36181112853803700000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> mult <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> positions <span class="token operator">=</span> <span class="token punctuation">[</span>\n  <span class="token comment">// 第一个矩形的第一个三角形</span>\n  <span class="token operator">-</span><span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token number">0</span><span class="token punctuation">,</span>\n  <span class="token number">1</span><span class="token punctuation">,</span>\n  <span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token number">0</span><span class="token punctuation">,</span>\n  <span class="token number">1</span><span class="token punctuation">,</span>\n  <span class="token operator">-</span><span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token number">0.2</span><span class="token punctuation">,</span>\n  <span class="token number">0</span><span class="token punctuation">,</span>\n  <span class="token number">1</span><span class="token punctuation">,</span>\n\n  <span class="token comment">// 第一个矩形的第二个三角形</span>\n  <span class="token operator">-</span><span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token number">0.2</span><span class="token punctuation">,</span>\n  <span class="token number">0</span><span class="token punctuation">,</span>\n  <span class="token number">1</span><span class="token punctuation">,</span>\n  <span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token number">0</span><span class="token punctuation">,</span>\n  <span class="token number">1</span><span class="token punctuation">,</span>\n  <span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token number">0.2</span><span class="token punctuation">,</span>\n  <span class="token number">0</span><span class="token punctuation">,</span>\n  <span class="token number">1</span><span class="token punctuation">,</span>\n\n  <span class="token comment">// 第二个矩形的第一个三角形</span>\n  <span class="token operator">-</span><span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token operator">-</span><span class="token number">0.2</span><span class="token punctuation">,</span>\n  <span class="token number">0</span><span class="token punctuation">,</span>\n  <span class="token number">1</span><span class="token punctuation">,</span>\n  <span class="token number">0.8</span> <span class="token operator">*</span> mult<span class="token punctuation">,</span>\n  <span class="token operator">-</span><span class="token number">0.2</span> <span class="token operator">*</span> mult<span class="token punctuation">,</span>\n  <span class="token number">0</span><span class="token punctuation">,</span>\n  mult<span class="token punctuation">,</span>\n  <span class="token operator">-</span><span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token operator">-</span><span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token number">0</span><span class="token punctuation">,</span>\n  <span class="token number">1</span><span class="token punctuation">,</span>\n\n  <span class="token comment">// 第二个矩形的第二个三角形</span>\n  <span class="token operator">-</span><span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token operator">-</span><span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token number">0</span><span class="token punctuation">,</span>\n  <span class="token number">1</span><span class="token punctuation">,</span>\n  <span class="token number">0.8</span> <span class="token operator">*</span> mult<span class="token punctuation">,</span>\n  <span class="token operator">-</span><span class="token number">0.2</span> <span class="token operator">*</span> mult<span class="token punctuation">,</span>\n  <span class="token number">0</span><span class="token punctuation">,</span>\n  mult<span class="token punctuation">,</span>\n  <span class="token number">0.8</span> <span class="token operator">*</span> mult<span class="token punctuation">,</span>\n  <span class="token operator">-</span><span class="token number">0.8</span> <span class="token operator">*</span> mult<span class="token punctuation">,</span>\n  <span class="token number">0</span><span class="token punctuation">,</span>\n  mult\n<span class="token punctuation">]</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如上所示我们将第二个矩形右边的点的 X 和 Y 都乘以 mult，同时设置 W 为 mult。由于 WebGL 会除以 W 所以我们应该得到相同的结果对么？</p>\n<p>这是结果</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/51qz0x?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>注意两个矩形和上一个例子位置相同，事实是 <code class="language-text">X * MULT / MULT(W)</code> 还是 X，Y 也一样，但颜色却不同，为什么？</p>\n<p>事实是 WebGL 使用 W 实现纹理映射或者可变量插值的透视投影。</p>\n<p>如果将片断着色器改成这样就更容易看出效果</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="52392666348361750000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`gl_FragColor = vec4(fract(v_brightness * 10), 0, 0, 1); // 红色`, `52392666348361750000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">gl_FragColor <span class="token operator">=</span> <span class="token function">vec4</span><span class="token punctuation">(</span><span class="token function">fract</span><span class="token punctuation">(</span>v_brightness <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 红色</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>将 <code class="language-text">v_brightness</code> 乘以 10 就会是值的范围为 0 到 10，fract 会保留小数部分所以结果还是 0 到 1 之间，但是总共是 10 次 0 到 1 了。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/yiilg8?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>现在应该更容易看出透视效果。</p>\n<p>线性插值应该是这样的公式</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="52150603172777440000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`result = (1 - t) * a + t * b;`, `52150603172777440000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">result <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> t<span class="token punctuation">)</span> <span class="token operator">*</span> a <span class="token operator">+</span> t <span class="token operator">*</span> b<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>t 的范围是 0 到 1，表示 a 到 b 之间的位置，0 表示在 a 点，1 表示在 b 点。</p>\n<p>可变量经过 WebGL 的插值时使用这个公式</p>\n<p><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>r</mi><mi>e</mi><mi>s</mi><mi>u</mi><mi>l</mi><mi>t</mi><mo>=</mo><mfrac><mrow><mo>(</mo><mn>1</mn><mo>−</mo><mi>t</mi><mo>)</mo><mo>∗</mo><mi>a</mi><mi mathvariant="normal">/</mi><mi>a</mi><mi>W</mi><mo>+</mo><mi>t</mi><mo>∗</mo><mi>b</mi><mi mathvariant="normal">/</mi><mi>b</mi><mi>W</mi></mrow><mrow><mo>(</mo><mn>1</mn><mo>−</mo><mi>t</mi><mo>)</mo><mi mathvariant="normal">/</mi><mi>a</mi><mi>W</mi><mo>+</mo><mi>t</mi><mi mathvariant="normal">/</mi><mi>b</mi><mi>W</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">result=\\frac{(1 - t) * a / aW + t * b / bW}{(1 - t) / aW + t / bW}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:1.01em;"></span><span class="strut bottom" style="height:1.53em;vertical-align:-0.52em;"></span><span class="base"><span class="mord mathit" style="margin-right:0.02778em;">r</span><span class="mord mathit">e</span><span class="mord mathit">s</span><span class="mord mathit">u</span><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="mord mathit">t</span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.01em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mtight">1</span><span class="mbin mtight">−</span><span class="mord mathit mtight">t</span><span class="mclose mtight">)</span><span class="mord mtight">/</span><span class="mord mathit mtight">a</span><span class="mord mathit mtight" style="margin-right:0.13889em;">W</span><span class="mbin mtight">+</span><span class="mord mathit mtight">t</span><span class="mord mtight">/</span><span class="mord mathit mtight">b</span><span class="mord mathit mtight" style="margin-right:0.13889em;">W</span></span></span></span><span style="top:-3.15em;"><span class="pstrut" style="height:3em;"></span><span class="stretchy" style="height:0.2em;"><svg width=\'400em\' height=\'0.2em\' viewBox=\'0 0 400000 200\' preserveAspectRatio=\'xMinYMin slice\'><path d=\'M0 80H400000 v40H0z M0 80H400000 v40H0z\'/></svg></span></span><span style="top:-3.485em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mtight">1</span><span class="mbin mtight">−</span><span class="mord mathit mtight">t</span><span class="mclose mtight">)</span><span class="mbin mtight">∗</span><span class="mord mathit mtight">a</span><span class="mord mtight">/</span><span class="mord mathit mtight">a</span><span class="mord mathit mtight" style="margin-right:0.13889em;">W</span><span class="mbin mtight">+</span><span class="mord mathit mtight">t</span><span class="mbin mtight">∗</span><span class="mord mathit mtight">b</span><span class="mord mtight">/</span><span class="mord mathit mtight">b</span><span class="mord mathit mtight" style="margin-right:0.13889em;">W</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.52em;"></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></p>\n<p>aW 表示 a 点的 W 值，也就是 <code class="language-text">gl_Position.w</code> 的值，而不一定等于缓冲中的值， 同理 bW 是设置在 b 点的 <code class="language-text">gl_Position.w</code>。</p>\n<h2 id="正方体"><a href="#%E6%AD%A3%E6%96%B9%E4%BD%93" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>正方体</h2>\n<p>为什么这个很重要？这有一个简单的纹理，使用纹理文章的例子，并调整了 UV，每个面使用整张纹理，是一个 4×4 像素的纹理。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/7rjd5e?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>现在将例子中的顶点着色器做一些修改，手工除以 W，只增加了一行代码</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="93683088615747800000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`attribute vec4 a_position;\nattribute vec2 a_texcoord;\n\nuniform mat4 u_matrix;\n\nvarying vec2 v_texcoord;\n\nvoid main() {\n  // 将位置和矩阵相乘\n  gl_Position = u_matrix * a_position;\n\n  // 手工除以 W\n  gl_Position /= gl_Position.w;\n\n  // 将纹理坐标传到片断着色器\n  v_texcoord = a_texcoord;\n}`, `93683088615747800000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl"\n              >\n                <span class="gatsby-code-button-language">glsl</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">attribute</span> <span class="token keyword">vec4</span> a_position<span class="token punctuation">;</span>\n<span class="token keyword">attribute</span> <span class="token keyword">vec2</span> a_texcoord<span class="token punctuation">;</span>\n\n<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> u_matrix<span class="token punctuation">;</span>\n\n<span class="token keyword">varying</span> <span class="token keyword">vec2</span> v_texcoord<span class="token punctuation">;</span>\n\n<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 将位置和矩阵相乘</span>\n  gl_Position <span class="token operator">=</span> u_matrix <span class="token operator">*</span> a_position<span class="token punctuation">;</span>\n\n  <span class="token comment">// 手工除以 W</span>\n  gl_Position <span class="token operator">/</span><span class="token operator">=</span> gl_Position<span class="token punctuation">.</span>w<span class="token punctuation">;</span>\n\n  <span class="token comment">// 将纹理坐标传到片断着色器</span>\n  v_texcoord <span class="token operator">=</span> a_texcoord<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>除以 W 意味值 <code class="language-text">gl_Position.w</code> 始终为 1，X, Y 和 Z 不会有什么影响，因为 WebGL 也会默认做除法，这是结果。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/mneucd?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>我们还是得到了一个立方体，但是纹理变得扭曲了，这是因为没有传入 W WebGL 就不能正确的实现纹理的透视纠正，或者更准确地说，WebGL 就不能正确的对可变量的插值实现透视。</p>\n<p>如果你还记得的话 W 就是透视矩阵中的 Z，当 W 始终为 1 时 WebGL 做的就是一个简单的线性插值，事实上如果你拿着上述的等式</p>\n<p><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>r</mi><mi>e</mi><mi>s</mi><mi>u</mi><mi>l</mi><mi>t</mi><mo>=</mo><mfrac><mrow><mo>(</mo><mn>1</mn><mo>−</mo><mi>t</mi><mo>)</mo><mo>∗</mo><mi>a</mi><mi mathvariant="normal">/</mi><mi>a</mi><mi>W</mi><mo>+</mo><mi>t</mi><mo>∗</mo><mi>b</mi><mi mathvariant="normal">/</mi><mi>b</mi><mi>W</mi></mrow><mrow><mo>(</mo><mn>1</mn><mo>−</mo><mi>t</mi><mo>)</mo><mi mathvariant="normal">/</mi><mi>a</mi><mi>W</mi><mo>+</mo><mi>t</mi><mi mathvariant="normal">/</mi><mi>b</mi><mi>W</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">result=\\frac{(1 - t) * a / aW + t * b / bW}{(1 - t) / aW + t / bW}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:1.01em;"></span><span class="strut bottom" style="height:1.53em;vertical-align:-0.52em;"></span><span class="base"><span class="mord mathit" style="margin-right:0.02778em;">r</span><span class="mord mathit">e</span><span class="mord mathit">s</span><span class="mord mathit">u</span><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="mord mathit">t</span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.01em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mtight">1</span><span class="mbin mtight">−</span><span class="mord mathit mtight">t</span><span class="mclose mtight">)</span><span class="mord mtight">/</span><span class="mord mathit mtight">a</span><span class="mord mathit mtight" style="margin-right:0.13889em;">W</span><span class="mbin mtight">+</span><span class="mord mathit mtight">t</span><span class="mord mtight">/</span><span class="mord mathit mtight">b</span><span class="mord mathit mtight" style="margin-right:0.13889em;">W</span></span></span></span><span style="top:-3.15em;"><span class="pstrut" style="height:3em;"></span><span class="stretchy" style="height:0.2em;"><svg width=\'400em\' height=\'0.2em\' viewBox=\'0 0 400000 200\' preserveAspectRatio=\'xMinYMin slice\'><path d=\'M0 80H400000 v40H0z M0 80H400000 v40H0z\'/></svg></span></span><span style="top:-3.485em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mtight">1</span><span class="mbin mtight">−</span><span class="mord mathit mtight">t</span><span class="mclose mtight">)</span><span class="mbin mtight">∗</span><span class="mord mathit mtight">a</span><span class="mord mtight">/</span><span class="mord mathit mtight">a</span><span class="mord mathit mtight" style="margin-right:0.13889em;">W</span><span class="mbin mtight">+</span><span class="mord mathit mtight">t</span><span class="mbin mtight">∗</span><span class="mord mathit mtight">b</span><span class="mord mtight">/</span><span class="mord mathit mtight">b</span><span class="mord mathit mtight" style="margin-right:0.13889em;">W</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.52em;"></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></p>\n<p>设置所有的 W 为 1 就会得到</p>\n<p><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>r</mi><mi>e</mi><mi>s</mi><mi>u</mi><mi>l</mi><mi>t</mi><mo>=</mo><mo>(</mo><mn>1</mn><mo>−</mo><mi>t</mi><mo>)</mo><mo>∗</mo><mi>a</mi><mo>+</mo><mi>t</mi><mo>∗</mo><mi>b</mi></mrow><annotation encoding="application/x-tex">result=(1 - t) * a + t * b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base"><span class="mord mathit" style="margin-right:0.02778em;">r</span><span class="mord mathit">e</span><span class="mord mathit">s</span><span class="mord mathit">u</span><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="mord mathit">t</span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mord rule" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mord rule" style="margin-right:0.2222222222222222em;"></span><span class="mord mathit">t</span><span class="mclose">)</span><span class="mord rule" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mord rule" style="margin-right:0.2222222222222222em;"></span><span class="mord mathit">a</span><span class="mord rule" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mord rule" style="margin-right:0.2222222222222222em;"></span><span class="mord mathit">t</span><span class="mord rule" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mord rule" style="margin-right:0.2222222222222222em;"></span><span class="mord mathit">b</span></span></span></span></p>\n<p>就和上方提到的线性插值一样了。</p>\n<p>现在就清楚为什么 WebGL 要使用 4x4 的矩阵和包含 X, Y, Z 和 W 四个值的向量了吧。X 和 Y 除以 W 得到裁剪空间坐标，Z 除以 W 也得到裁剪空间的 Z 坐标，W 同时还为纹理映射的透视纠正提供了帮助。</p>\n<blockquote>\n<p><strong>二十世纪中叶的游戏机</strong></p>\n<p>一点小事，Playstation 1 和其他同一时代的游戏机都没有做纹理映射的透视纠正，根据以上的信息你就能看出为什么路面是这样的了。</p>\n</blockquote>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-08-02-16-00-44-e432e6738c9bdb1d77bd4eb24a4de0a2-0208c.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 493px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 82.55578093306288%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAAAsSAAALEgHS3X78AAAECElEQVQ4y0WUSW8jdRTE23Ziu+Ml7d2O7fbSdmzH2bwmjuNxPFkmq5NRxmEmZGOYRYwEDswiEAcQQkLihOAwFyQkrtw4cIYPwYkP8+O1DZpDqdWt7vpX1avXSq3oYtGYJuVTRlg0ggxqBudpjeNGho9aPt6s5znJRjlIBki6FSJTCiGngvYf/AKPwCdQjrZ0+ls17lRzJDSFZtbH60qe14UIrxo5dotTfH+9ye3pPg/bDbIhO0u5CLN6iLJdYUm1kVOtdBzm1YKyszrPdnuB1YUUlUKUaszBpe5lkNF4mtMoRxVenRZ576RHS96tlvzs92psrlfZNsKcVEp05wt8ttVjzYiidMXe4PgulVKMTFwlE7KSDljQ/QpG2Eo+YuFhw009aSOkKqQllohLIeAQqy4LvikrEbeVgNeGf0oU3uTj9Gaj9KIqA7+dOSFKBy0YgqwgHVDYm1c5WvQQEMK410JQrAWdllGOQSEOyvOY20JSs6IclBK0CzEOmwXOagWykmM2NCYzkZIDqqJuvzxFfNpCQmAqDYuaoAwn5rHS1J1UEg4Mvw2lnw3xMCm5COl8MTwiMIkywXekOTmgk3eM7ZoTFsKgqJsNTVKK2kfqImLfL8NROksp1kpieTnFnUp6VB1DcjRJDIEulqPTCnPxSfIJjZDbRjlmZz3v5HzFw2nVRS5g486sk/s1D4qujfsX88rJErapzBxIWO5nhKgyY2MjM8lKysFGNStNiLBZcrEza6ehT7CSsfOo4+dBS+NUoCT9kol8nA/a6Oh20nK/ELHxxZqXn3Z9vGx52MxOsr/g5ajsFCIHW6Jmu6iykXPQNSbZK6uCKe6VVJRm3M6w7uaPszB/P53h90GYnw8DvGy76QqROdmm4eG6HeJ4XmzWPezPOdktOTleULlohRjUNQ6qbo4XXSh/nmn88yLOb2dBvt2a5nXHw/yMFZ9rvEo5UX57mKSZltyydrYLY5Vdw8njwxWGl9t82m8wzLjZLDpRfvlkk73iBLnwODeTKCr7qks9wjLR4YHOs7th2ukJ9kXVodg7mrPzvL/Mh/0mO2WN82acvzQvn0u2SqNVJz76MVhGJAkpri4F1WRPB6sRfriZo5uZELsq5zU3l00v1ytevrre4HE3wUCsnt5N87aS4+uEKCwbM1JWcwPGW/B/cZeTTn4d1hnuJNiQLHfF6pUQPVvXeL7m4ZubHrf9IsPjDDedJCeSZc8cSjmfYsYzJjTVxUy7ovDHJ4u86etspG30Jfz3ZXAftKa5Wp3msuHixT2D7z4+YO8iS+8kzpNBncMFB0pCs71TJwhJbi+Psnx5P8OabpPMnAyWVM4qLiH1jnDR8PJoWeX2IM/VVpgHbR/na7K+0oJ/AeLI7QPA18vhAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 08 02 16 00 44" title="" data-src="/static/2022-08-02-16-00-44-e432e6738c9bdb1d77bd4eb24a4de0a2-0208c.png" data-srcset="/static/2022-08-02-16-00-44-e432e6738c9bdb1d77bd4eb24a4de0a2-1777c.png 200w,\n/static/2022-08-02-16-00-44-e432e6738c9bdb1d77bd4eb24a4de0a2-1db89.png 400w,\n/static/2022-08-02-16-00-44-e432e6738c9bdb1d77bd4eb24a4de0a2-0208c.png 493w" data-sizes="(max-width: 493px) 100vw, 493px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-08-02-16-00-59-4087026cd585b660b2ed880ad936c473-0208c.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 493px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 82.55578093306288%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAAAsSAAALEgHS3X78AAAEW0lEQVQ4y02T+0/TVxjGv/GnXTKzLTFbpqJGGZVLlYEB5U7LpbRcLNIhYikIvdEbQkEolAoFWgpykYsoUMS5LQY102nUHxxbjJoZY6ZkWzTbD8v2DyzZkv1gPjstuuwkT875vuc8z/u87zlfSdvmQF5vxjsd4Ien9/CHFlDnNqLdW0limpV3dpjoqKzGrsilSr4HeXIqNUfrMLS4OOxyMT5zhkSFBynGxoaddqSBARMObzcdISfhz0e5NNbFlVAdl4LHcTmcvL/XTW2VgRaDHof+CCqVGrPFgm8ogN3QiLNBT+1hF/s+rOKD7U1I88MBFiaHGDjuYGwgxNm5C8xNBAjPjHLlwhjnTozQ3tRKrbkFrU5PeUUFZqsVj3+I/s4e+jwn0Na0sWOznvdENdJksJ9lXy+jTisn3Q58ThsjXe1MBQZYmF1kZXyJa+MznJouoqy6kCxlGQZDA75gkGavF09oEJ3Zj7TdwRsyF9Jlm5Fws5HTRz7lrLaUqTYTg/ZjDLnM+B0GQt42hn3duI8bsbbpMTir0Dc04RseodsfYHhshBpzPxu2NSNttSDlxMUSnprl8e3b3FpY4ML4BGd8HQQ9btGGVvqsevqbG/BbLfRabKICI51WE27Rd7u3l+7gIGWGHjYluzF1LiLtfvMtVnp7+fOP33nx7Clr167x65Mn/LT2jAd37vDt6irXv7rK+cV5wrMTzAX6mDxhI9juYrjfx6nTIxy2DOIdvUpgtAfp3Y0bubi0xF8vX3JvcIhzb7zNpQQ5j8R6tbWNB11d3LVYeTwxyUOBx8th3A4bavGMDNpyjPV6Onq8uD0e1JX5SGIwOzPDP8B3fX6+n55j7foNrqtKWG3v4KI8mRviEm7qDdzt7OJpKIRNrFvcbnw+H9U6HeryLApKs0krVKwLzs3O8rcQvON08XB8kuf37/PlxzK+zszmZlExz1cus7awyKrNzo9T09hMZtKzhEhJKQeUhWSXaUjKLSI2s2BdcElcRmT8LIi/fLPKb89f8Oj8MrcmT/PF/CLz4WVOBkcwWJziAowkF2rYmpzOjvRc9io1QkjJ5kwF8UI0Ktjl6+OzlSv0Tkxj9/mptjpR1DWRpqtFpihhc2omH32yny0pGWwV8870HORKtXh/dupa2jlab8GQkklcvgqpov4YsVlKtqXlRAkx+7KIEQIxKQfYLrBLxOMy84nPKSQhr5gkhRqZcHKw3kRlg5nEgjKy1Ie4uWkLlcn7kfI0pcTnqcQPXhLNGrG9SziIy1CwW4jEC5GE/BIBVfTcbrEfQZWxmTTNIVKLikitrqVfnDElpCDtych5RRKE3PU5giTRm9cCkSTRMwKRORLTmZwUVNegrtWSUapDXnYQmTAkpeTkR4kJEZcRJ3mqKOl1kihexdZdFhOXXUBGhY7GVieJpmJijyrRNNZH96QEkS1SbgT/J//3nb/eDll24XpCgci+TLQjo1xHklqNvFRDuroymuhfJf3i+UrsKnIAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 08 02 16 00 59" title="" data-src="/static/2022-08-02-16-00-59-4087026cd585b660b2ed880ad936c473-0208c.png" data-srcset="/static/2022-08-02-16-00-59-4087026cd585b660b2ed880ad936c473-1777c.png 200w,\n/static/2022-08-02-16-00-59-4087026cd585b660b2ed880ad936c473-1db89.png 400w,\n/static/2022-08-02-16-00-59-4087026cd585b660b2ed880ad936c473-0208c.png 493w" data-sizes="(max-width: 493px) 100vw, 493px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h1 id="webgl-平面的和透视的投影映射"><a href="#webgl-%E5%B9%B3%E9%9D%A2%E7%9A%84%E5%92%8C%E9%80%8F%E8%A7%86%E7%9A%84%E6%8A%95%E5%BD%B1%E6%98%A0%E5%B0%84" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>WebGL 平面的和透视的投影映射</h1>\n<p>投影映射是投影一张图像的过程，就像一个电影放映机对准一个屏幕，然后将电影投影到屏幕上。电影放映机投影的是一个透视的平面。屏幕离放映机越远，则图像就会越大。如果你将屏幕旋转使其不与电影放映机垂直，那么结果将会是一个梯形或者是任意的四边形。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-08-03-13-45-50-463bff587cbf7c110a8a0f36ca288c44-b4b51.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 200px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 75%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsSAAALEgHS3X78AAAB7UlEQVQ4y2M42HiTcVLiEnYGBgZGBmqAdaVH5BflbCsAMjmMlSx5gDQLRQauKNirvLJwfxGIHWweB3IpFxBzAzEnEDOTbODqogOKy/J3FYPYRT4NrEhSLEiGc6Ab3nhzO0PBnvmMRQcWMRTum89SsHcBa8G+BYwMa0sOKy7O3V4KMkBf3oQXagAIs0HDlRlqOCfUAjZBGQm44QV75jGie1lpVeH+QhD7//n/TFBDQDQ71GAuqGEgV7Ixs7KA+By522dxF+5boALSB3RhBdCFrUAXajGsLNynBDQUHIbN4ZNxRQhIHBQcXBx8POCIy94yXRho4L2CvfOTgQb+bbix7T/Q0GiGdQgvs+uhehmEeZAiCOxKbmEBMJ20rJsHaOCfsmPL/xfunf8O6Lp/QAODUFzYEDaBFYcLYeHIDnfh1hnYXQgKw5WwMHzwnxEpIljRwhCMoWHIlbF+Ck/h/oWYYQiJ5R3YYpkDajgs/GCxzC6qLMeEM5aR02GORyUrmjeREzlKhIX2VzDEzGlmAsY20IULgOlwPiQdLi/Yo7yqCJJTEhxy2JBdQlb+Xo+Ul3XljHmhLgPRhkBsBMSmQGwBxLpArA7ExkBsCRXXgaZZBLjU84axI3omO5qXWKFJhgdqOBc0TLmhfH4onxPdgQBTp64v2kzZ0gAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 08 03 13 45 50" title="" data-src="/static/2022-08-03-13-45-50-463bff587cbf7c110a8a0f36ca288c44-b4b51.png" data-srcset="/static/2022-08-03-13-45-50-463bff587cbf7c110a8a0f36ca288c44-b4b51.png 200w" data-sizes="(max-width: 200px) 100vw, 200px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>当然，投影映射并不只能投影到平面。还有圆柱型的投影映射、球形的投影映射，等等。</p>\n<p>我们先来介绍下平面的投影映射。在这种情况下，你需要将电影放映机想象成和屏幕一样大，这样即使屏幕离电影放映机很远，电影的图像也不会变得很大，它会保持原来的尺寸。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-08-03-15-05-08-9ea73865c9e4099852ba5730c692bdb1-a74f3.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 176px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 85.22727272727273%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAAAsSAAALEgHS3X78AAACWElEQVQ4y62UzWvTcBjHf2nemzbtLJuz2gruoIchKg7Ru2dRbyIbAwWR2SbdVhUviijiScGbuoQ5W7viBAVhrs067XxB8OJlngTBqv+Agi/E75N1NdDFOjDw5fckpJ98n7eyqVOz3P3RZyJb43WlsdCKDceKQrpRtURWztWShcyTY3ie6NISOmNcBHGgBFmK4lSOl6/FTcc+m61accOx6wB+BfAwu2dUN5cMx6Av1c4vcZ2c2e4H7wRMNqvWN0AWAWycezPjGlV7iE3naqlCdi5LX012pcMcxykUB0nRIypOaXjqqgJo4/Srkms61s/x+l0ArUE2bc6ni9kKAaW+9VuVEBeSKA6SlojTySNlAn7O1SZdOPyef14kh4OUcrpkOhlKw3Xdf27K6NM7Mhx9wUnAHwQ0ySEBIQ+4cOFdxxredt+3argqsPynhusSkW6d69BlKaxQl8NHb15UKeU2INJtOcwfuBTC6PzV4b7hQ14W2bkJGcDVU/6vNVx2WCEg15/aKYU4XkAcqNiGbtqq0IkHNzyHbV32zWG0R++NoIZhqlGQZE3VaB6H7Ms0Nh/zL4o0h7/GFwvLc+hPeS0XBlkyaFMcewn6dOZ1GSl7DufJ4Qje0XrjGzU4VH2boTbV2hRZC9O9YFQmYnB4HdA0gG/JKeIj7GH+JW+dfKQTUOQl2gLRB1vZELqXfZJ2HNzf+ocCKAVtgbSgjLZDu6Fd0B5oL7QN6ocGms8HBEnc1PbLmbE6mxx57MURRV95zFMnm41Qm655n1uRFwUhluyhd1hm9hYHdyT2G/U4MUYOT3dVAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 08 03 15 05 08" title="" data-src="/static/2022-08-03-15-05-08-9ea73865c9e4099852ba5730c692bdb1-a74f3.png" data-srcset="/static/2022-08-03-15-05-08-9ea73865c9e4099852ba5730c692bdb1-a74f3.png 176w" data-sizes="(max-width: 176px) 100vw, 176px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>首先，让我们创建一个场景，该场景会绘制一个平面和一个球体。我们将用一个简单的 8x8 棋盘纹理对它们进行贴图。</p>\n<p>这些着色器和纹理文章中的那些着色器是类似的，只是各个矩阵是分开的，这样我们就不需要在 JavaScript 中把它们乘在一起了。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="22468731420579460000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 顶点着色器\nattribute vec4 a_position;\nattribute vec2 a_texcoord;\n\nuniform mat4 u_projection;\nuniform mat4 u_view;\nuniform mat4 u_world;\n\nvarying vec2 v_texcoord;\n\nvoid main() {\n  gl_Position = u_projection * u_view * u_world * a_position;\n\n  // 把纹理坐标传给片段着色器\n  v_texcoord = a_texcoord;\n}`, `22468731420579460000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl"\n              >\n                <span class="gatsby-code-button-language">glsl</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token comment">// 顶点着色器</span>\n<span class="token keyword">attribute</span> <span class="token keyword">vec4</span> a_position<span class="token punctuation">;</span>\n<span class="token keyword">attribute</span> <span class="token keyword">vec2</span> a_texcoord<span class="token punctuation">;</span>\n\n<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> u_projection<span class="token punctuation">;</span>\n<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> u_view<span class="token punctuation">;</span>\n<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> u_world<span class="token punctuation">;</span>\n\n<span class="token keyword">varying</span> <span class="token keyword">vec2</span> v_texcoord<span class="token punctuation">;</span>\n\n<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  gl_Position <span class="token operator">=</span> u_projection <span class="token operator">*</span> u_view <span class="token operator">*</span> u_world <span class="token operator">*</span> a_position<span class="token punctuation">;</span>\n\n  <span class="token comment">// 把纹理坐标传给片段着色器</span>\n  v_texcoord <span class="token operator">=</span> a_texcoord<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>另外，我还添加了一个 <code class="language-text">u_colorMult</code> uniform 来乘以纹理颜色。这样我们就可以通过制作一个单色纹理（monochrome texture）来改变它的颜色。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="57871725573776960000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 片段着色器\nprecision mediump float;\n\n// 从顶点着色器传来的\nvarying vec2 v_texcoord;\n\nuniform vec4 u_colorMult;\nuniform sampler2D u_texture;\n\nvoid main() {\n  gl_FragColor = texture2D(u_texture, v_texcoord) * u_colorMult;\n}`, `57871725573776960000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl"\n              >\n                <span class="gatsby-code-button-language">glsl</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token comment">// 片段着色器</span>\n<span class="token keyword">precision</span> <span class="token keyword">mediump</span> <span class="token keyword">float</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 从顶点着色器传来的</span>\n<span class="token keyword">varying</span> <span class="token keyword">vec2</span> v_texcoord<span class="token punctuation">;</span>\n\n<span class="token keyword">uniform</span> <span class="token keyword">vec4</span> u_colorMult<span class="token punctuation">;</span>\n<span class="token keyword">uniform</span> <span class="token keyword">sampler2D</span> u_texture<span class="token punctuation">;</span>\n\n<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  gl_FragColor <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>u_texture<span class="token punctuation">,</span> v_texcoord<span class="token punctuation">)</span> <span class="token operator">*</span> u_colorMult<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>下面是设置程序、球体 buffers 和平面 buffers 的代码</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="62590364860496050000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 设置 GLSL 程序\n// 编译着色器、链接程序、查找 locations\nconst textureProgramInfo = webglUtils.createProgramInfo(gl, [\'vertex-shader-3d\', \'fragment-shader-3d\']);\n\nconst sphereBufferInfo = primitives.createSphereBufferInfo(\n  gl,\n  1, // 半径\n  12, // 横轴细分数\n  6 // 纵轴细分数\n);\n\nconst planeBufferInfo = primitives.createPlaneBufferInfo(\n  gl,\n  20, // 宽\n  20, // 高\n  1, // 横轴细分数\n  1 // 纵轴细分数\n);`, `62590364860496050000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 设置 GLSL 程序</span>\n<span class="token comment">// 编译着色器、链接程序、查找 locations</span>\n<span class="token keyword">const</span> textureProgramInfo <span class="token operator">=</span> webglUtils<span class="token punctuation">.</span><span class="token function">createProgramInfo</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">\'vertex-shader-3d\'</span><span class="token punctuation">,</span> <span class="token string">\'fragment-shader-3d\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> sphereBufferInfo <span class="token operator">=</span> primitives<span class="token punctuation">.</span><span class="token function">createSphereBufferInfo</span><span class="token punctuation">(</span>\n  gl<span class="token punctuation">,</span>\n  <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// 半径</span>\n  <span class="token number">12</span><span class="token punctuation">,</span> <span class="token comment">// 横轴细分数</span>\n  <span class="token number">6</span> <span class="token comment">// 纵轴细分数</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> planeBufferInfo <span class="token operator">=</span> primitives<span class="token punctuation">.</span><span class="token function">createPlaneBufferInfo</span><span class="token punctuation">(</span>\n  gl<span class="token punctuation">,</span>\n  <span class="token number">20</span><span class="token punctuation">,</span> <span class="token comment">// 宽</span>\n  <span class="token number">20</span><span class="token punctuation">,</span> <span class="token comment">// 高</span>\n  <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// 横轴细分数</span>\n  <span class="token number">1</span> <span class="token comment">// 纵轴细分数</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>和创建一个 8x8 棋盘纹理的代码，使用了我们在数据纹理文章中介绍过的技术。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="89240743422647160000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 创建一个 8x8 棋盘纹理\nconst checkerboardTexture = gl.createTexture();\ngl.bindTexture(gl.TEXTURE_2D, checkerboardTexture);\ngl.texImage2D(\n  gl.TEXTURE_2D,\n  0, // mip level\n  gl.LUMINANCE, // internal format\n  8, // width\n  8, // height\n  0, // border\n  gl.LUMINANCE, // format\n  gl.UNSIGNED_BYTE, // type\n  new Uint8Array([\n    // data\n    0xff,\n    0xcc,\n    0xff,\n    0xcc,\n    0xff,\n    0xcc,\n    0xff,\n    0xcc,\n    0xcc,\n    0xff,\n    0xcc,\n    0xff,\n    0xcc,\n    0xff,\n    0xcc,\n    0xff,\n    0xff,\n    0xcc,\n    0xff,\n    0xcc,\n    0xff,\n    0xcc,\n    0xff,\n    0xcc,\n    0xcc,\n    0xff,\n    0xcc,\n    0xff,\n    0xcc,\n    0xff,\n    0xcc,\n    0xff,\n    0xff,\n    0xcc,\n    0xff,\n    0xcc,\n    0xff,\n    0xcc,\n    0xff,\n    0xcc,\n    0xcc,\n    0xff,\n    0xcc,\n    0xff,\n    0xcc,\n    0xff,\n    0xcc,\n    0xff,\n    0xff,\n    0xcc,\n    0xff,\n    0xcc,\n    0xff,\n    0xcc,\n    0xff,\n    0xcc,\n    0xcc,\n    0xff,\n    0xcc,\n    0xff,\n    0xcc,\n    0xff,\n    0xcc,\n    0xff\n  ])\n);\ngl.generateMipmap(gl.TEXTURE_2D);\ngl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);`, `89240743422647160000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 创建一个 8x8 棋盘纹理</span>\n<span class="token keyword">const</span> checkerboardTexture <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createTexture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> checkerboardTexture<span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">texImage2D</span><span class="token punctuation">(</span>\n  gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span>\n  <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// mip level</span>\n  gl<span class="token punctuation">.</span><span class="token constant">LUMINANCE</span><span class="token punctuation">,</span> <span class="token comment">// internal format</span>\n  <span class="token number">8</span><span class="token punctuation">,</span> <span class="token comment">// width</span>\n  <span class="token number">8</span><span class="token punctuation">,</span> <span class="token comment">// height</span>\n  <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// border</span>\n  gl<span class="token punctuation">.</span><span class="token constant">LUMINANCE</span><span class="token punctuation">,</span> <span class="token comment">// format</span>\n  gl<span class="token punctuation">.</span><span class="token constant">UNSIGNED_BYTE</span><span class="token punctuation">,</span> <span class="token comment">// type</span>\n  <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span>\n    <span class="token comment">// data</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span>\n  <span class="token punctuation">]</span><span class="token punctuation">)</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">generateMipmap</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_MAG_FILTER</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">NEAREST</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>为了绘制，我们将会创建一个函数，该函数需要一个投影矩阵和一个相机矩阵作为参数，以便从相机矩阵中计算出视图矩阵，然后绘制球体和立方体</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="63064829822080330000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 每个物体的 uniforms\nconst planeUniforms = {\n  u_colorMult: [0.5, 0.5, 1, 1], // 浅蓝色\n  u_texture: checkerboardTexture,\n  u_world: m4.translation(0, 0, 0)\n};\n\nconst sphereUniforms = {\n  u_colorMult: [1, 0.5, 0.5, 1], // 粉红色\n  u_texture: checkerboardTexture,\n  u_world: m4.translation(2, 3, 4)\n};\n\nfunction drawScene(projectionMatrix, cameraMatrix) {\n  // 从相机矩阵中计算出视图矩阵\n  const viewMatrix = m4.inverse(cameraMatrix);\n\n  gl.useProgram(textureProgramInfo.program);\n\n  // 设置球体和平面共享的 uniforms\n  webglUtils.setUniforms(textureProgramInfo, {\n    u_view: viewMatrix,\n    u_projection: projectionMatrix\n  });\n\n  // ------ 绘制球体 --------\n\n  // 设置所有需要的 attributes\n  webglUtils.setBuffersAndAttributes(gl, textureProgramInfo, sphereBufferInfo);\n\n  // 设置球体特有的 uniforms\n  webglUtils.setUniforms(textureProgramInfo, sphereUniforms);\n\n  // 调用 gl.drawArrays 或 gl.drawElements\n  webglUtils.drawBufferInfo(gl, sphereBufferInfo);\n\n  // ------ 绘制平面 --------\n\n  // 设置所有需要的 attributes\n  webglUtils.setBuffersAndAttributes(gl, textureProgramInfo, planeBufferInfo);\n\n  // 设置平面特有的 uniforms\n  webglUtils.setUniforms(textureProgramInfo, planeUniforms);\n\n  // 调用 gl.drawArrays 或 gl.drawElements\n  webglUtils.drawBufferInfo(gl, planeBufferInfo);\n}`, `63064829822080330000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 每个物体的 uniforms</span>\n<span class="token keyword">const</span> planeUniforms <span class="token operator">=</span> <span class="token punctuation">{</span>\n  u_colorMult<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 浅蓝色</span>\n  u_texture<span class="token punctuation">:</span> checkerboardTexture<span class="token punctuation">,</span>\n  u_world<span class="token punctuation">:</span> m4<span class="token punctuation">.</span><span class="token function">translation</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> sphereUniforms <span class="token operator">=</span> <span class="token punctuation">{</span>\n  u_colorMult<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 粉红色</span>\n  u_texture<span class="token punctuation">:</span> checkerboardTexture<span class="token punctuation">,</span>\n  u_world<span class="token punctuation">:</span> m4<span class="token punctuation">.</span><span class="token function">translation</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">function</span> <span class="token function">drawScene</span><span class="token punctuation">(</span><span class="token parameter">projectionMatrix<span class="token punctuation">,</span> cameraMatrix</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 从相机矩阵中计算出视图矩阵</span>\n  <span class="token keyword">const</span> viewMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">inverse</span><span class="token punctuation">(</span>cameraMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  gl<span class="token punctuation">.</span><span class="token function">useProgram</span><span class="token punctuation">(</span>textureProgramInfo<span class="token punctuation">.</span>program<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 设置球体和平面共享的 uniforms</span>\n  webglUtils<span class="token punctuation">.</span><span class="token function">setUniforms</span><span class="token punctuation">(</span>textureProgramInfo<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n    u_view<span class="token punctuation">:</span> viewMatrix<span class="token punctuation">,</span>\n    u_projection<span class="token punctuation">:</span> projectionMatrix\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// ------ 绘制球体 --------</span>\n\n  <span class="token comment">// 设置所有需要的 attributes</span>\n  webglUtils<span class="token punctuation">.</span><span class="token function">setBuffersAndAttributes</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> textureProgramInfo<span class="token punctuation">,</span> sphereBufferInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 设置球体特有的 uniforms</span>\n  webglUtils<span class="token punctuation">.</span><span class="token function">setUniforms</span><span class="token punctuation">(</span>textureProgramInfo<span class="token punctuation">,</span> sphereUniforms<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 调用 gl.drawArrays 或 gl.drawElements</span>\n  webglUtils<span class="token punctuation">.</span><span class="token function">drawBufferInfo</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> sphereBufferInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// ------ 绘制平面 --------</span>\n\n  <span class="token comment">// 设置所有需要的 attributes</span>\n  webglUtils<span class="token punctuation">.</span><span class="token function">setBuffersAndAttributes</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> textureProgramInfo<span class="token punctuation">,</span> planeBufferInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 设置平面特有的 uniforms</span>\n  webglUtils<span class="token punctuation">.</span><span class="token function">setUniforms</span><span class="token punctuation">(</span>textureProgramInfo<span class="token punctuation">,</span> planeUniforms<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 调用 gl.drawArrays 或 gl.drawElements</span>\n  webglUtils<span class="token punctuation">.</span><span class="token function">drawBufferInfo</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> planeBufferInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们可以在一个 render 函数中使用这份代码，就像这样</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="31896083636944093000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const settings = {\n  cameraX: 2.75,\n  cameraY: 5\n};\n\nconst fieldOfViewRadians = degToRad(60);\n\nfunction render() {\n  webglUtils.resizeCanvasToDisplaySize(gl.canvas);\n\n  // 告诉 WebGL 如何从裁剪空间转换为像素\n  gl.viewport(0, 0, gl.canvas.width, gl.canvas.height);\n\n  gl.enable(gl.CULL_FACE);\n  gl.enable(gl.DEPTH_TEST);\n\n  // 清除 canvas 和深度缓冲区\n  gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);\n\n  // 计算投影矩阵\n  const aspect = gl.canvas.clientWidth / gl.canvas.clientHeight;\n  const projectionMatrix = m4.perspective(fieldOfViewRadians, aspect, 1, 2000);\n\n  // 使用 look at 计算相机的矩阵\n  const cameraPosition = [settings.cameraX, settings.cameraY, 7];\n  const target = [0, 0, 0];\n  const up = [0, 1, 0];\n  const cameraMatrix = m4.lookAt(cameraPosition, target, up);\n\n  drawScene(projectionMatrix, cameraMatrix);\n}\n\nrender();`, `31896083636944093000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> settings <span class="token operator">=</span> <span class="token punctuation">{</span>\n  cameraX<span class="token punctuation">:</span> <span class="token number">2.75</span><span class="token punctuation">,</span>\n  cameraY<span class="token punctuation">:</span> <span class="token number">5</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> fieldOfViewRadians <span class="token operator">=</span> <span class="token function">degToRad</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  webglUtils<span class="token punctuation">.</span><span class="token function">resizeCanvasToDisplaySize</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>canvas<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 告诉 WebGL 如何从裁剪空间转换为像素</span>\n  gl<span class="token punctuation">.</span><span class="token function">viewport</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>width<span class="token punctuation">,</span> gl<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  gl<span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">CULL_FACE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">DEPTH_TEST</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 清除 canvas 和深度缓冲区</span>\n  gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span> <span class="token operator">|</span> gl<span class="token punctuation">.</span><span class="token constant">DEPTH_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 计算投影矩阵</span>\n  <span class="token keyword">const</span> aspect <span class="token operator">=</span> gl<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>clientWidth <span class="token operator">/</span> gl<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>clientHeight<span class="token punctuation">;</span>\n  <span class="token keyword">const</span> projectionMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">perspective</span><span class="token punctuation">(</span>fieldOfViewRadians<span class="token punctuation">,</span> aspect<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 使用 look at 计算相机的矩阵</span>\n  <span class="token keyword">const</span> cameraPosition <span class="token operator">=</span> <span class="token punctuation">[</span>settings<span class="token punctuation">.</span>cameraX<span class="token punctuation">,</span> settings<span class="token punctuation">.</span>cameraY<span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> target <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> up <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> cameraMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">lookAt</span><span class="token punctuation">(</span>cameraPosition<span class="token punctuation">,</span> target<span class="token punctuation">,</span> up<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token function">drawScene</span><span class="token punctuation">(</span>projectionMatrix<span class="token punctuation">,</span> cameraMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>所以，现在我们有了一个简单的场景，场景内有一个平面和一个球体。我添加了一对滑块来让你改变相机的位置，以便你理解该场景。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/7gmu66?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>现在，让我们使用平面投影的方式将一个纹理投影到该球体和平面上。</p>\n<p>首先要做的是，加载一个纹理。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="75628087978166530000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function loadImageTexture(url) {\n  // 创建一个纹理\n  const texture = gl.createTexture();\n  gl.bindTexture(gl.TEXTURE_2D, texture);\n  // 用一个 1x1 蓝色像素填充该纹理\n  gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, 1, 1, 0, gl.RGBA, gl.UNSIGNED_BYTE, new Uint8Array([0, 0, 255, 255]));\n  // 异步加载一张图片\n  const image = new Image();\n  image.src = url;\n  image.addEventListener(\'load\', function () {\n    // 现在图片加载完了，把它拷贝到纹理中\n    gl.bindTexture(gl.TEXTURE_2D, texture);\n    gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, image);\n    // 假设该纹理的宽高是 2 的整次幂\n    gl.generateMipmap(gl.TEXTURE_2D);\n    render();\n  });\n  return texture;\n}\n\nconst imageTexture = loadImageTexture(\'resources/f-texture.png\');`, `75628087978166530000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">loadImageTexture</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 创建一个纹理</span>\n  <span class="token keyword">const</span> texture <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createTexture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> texture<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// 用一个 1x1 蓝色像素填充该纹理</span>\n  gl<span class="token punctuation">.</span><span class="token function">texImage2D</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGBA</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGBA</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">UNSIGNED_BYTE</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// 异步加载一张图片</span>\n  <span class="token keyword">const</span> image <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  image<span class="token punctuation">.</span>src <span class="token operator">=</span> url<span class="token punctuation">;</span>\n  image<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">\'load\'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 现在图片加载完了，把它拷贝到纹理中</span>\n    gl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> texture<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    gl<span class="token punctuation">.</span><span class="token function">texImage2D</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGBA</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGBA</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">UNSIGNED_BYTE</span><span class="token punctuation">,</span> image<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// 假设该纹理的宽高是 2 的整次幂</span>\n    gl<span class="token punctuation">.</span><span class="token function">generateMipmap</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> texture<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">const</span> imageTexture <span class="token operator">=</span> <span class="token function">loadImageTexture</span><span class="token punctuation">(</span><span class="token string">\'resources/f-texture.png\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>回想一下可视化相机的文章。我们创建了一个 -1 到 +1 的立方体，然后把它绘制出来表示相机的视椎体。我们的矩阵使得视椎体内的空间表示的是世界空间中一些锥体形状的区域，这些区域从世界空间中被转换到了 -1 到 +1 的裁剪空间。我们可以在这里做类似的事。</p>\n<p>让我们来试试吧。首先，在我们的片段着色器中，我们会在 0.0 到 1.0 之间的纹理坐标上绘制投影的纹理。而在这个范围外的纹理坐标，我们将会使用棋盘纹理。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="3872590319525093400"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`precision mediump float;\n\n// 从顶点着色器传来的\nvarying vec2 v_texcoord;\nvarying vec4 v_projectedTexcoord;\n\nuniform vec4 u_colorMult;\nuniform sampler2D u_texture;\nuniform sampler2D u_projectedTexture;\n\nvoid main() {\n  // gl_FragColor = texture2D(u_texture, v_texcoord) * u_colorMult;\n  // 除以 w 得到正确的值，详见透视投影的文章\n  vec3 projectedTexcoord = v_projectedTexcoord.xyz / v_projectedTexcoord.w;\n\n  bool inRange =\n      projectedTexcoord.x >= 0.0 &&\n      projectedTexcoord.x <= 1.0 &&\n      projectedTexcoord.y >= 0.0 &&\n      projectedTexcoord.y <= 1.0;\n\n  vec4 projectedTexColor = texture2D(u_projectedTexture, projectedTexcoord.xy);\n  vec4 texColor = texture2D(u_texture, v_texcoord) * u_colorMult;\n\n  float projectedAmount = inRange ? 1.0 : 0.0;\n  gl_FragColor = mix(texColor, projectedTexColor, projectedAmount);\n}`, `3872590319525093400`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl{5,9,12-26}"\n              >\n                <span class="gatsby-code-button-language">glsl{5,9,12-26}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">precision</span> <span class="token keyword">mediump</span> <span class="token keyword">float</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 从顶点着色器传来的</span>\n<span class="token keyword">varying</span> <span class="token keyword">vec2</span> v_texcoord<span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">varying</span> <span class="token keyword">vec4</span> v_projectedTexcoord<span class="token punctuation">;</span></span>\n<span class="token keyword">uniform</span> <span class="token keyword">vec4</span> u_colorMult<span class="token punctuation">;</span>\n<span class="token keyword">uniform</span> <span class="token keyword">sampler2D</span> u_texture<span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">uniform</span> <span class="token keyword">sampler2D</span> u_projectedTexture<span class="token punctuation">;</span></span>\n<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n<span class="gatsby-highlight-code-line">  <span class="token comment">// gl_FragColor = texture2D(u_texture, v_texcoord) * u_colorMult;</span></span><span class="gatsby-highlight-code-line">  <span class="token comment">// 除以 w 得到正确的值，详见透视投影的文章</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">vec3</span> projectedTexcoord <span class="token operator">=</span> v_projectedTexcoord<span class="token punctuation">.</span>xyz <span class="token operator">/</span> v_projectedTexcoord<span class="token punctuation">.</span>w<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line">  <span class="token keyword">bool</span> inRange <span class="token operator">=</span></span><span class="gatsby-highlight-code-line">      projectedTexcoord<span class="token punctuation">.</span>x <span class="token operator">>=</span> <span class="token number">0.0</span> <span class="token operator">&amp;&amp;</span></span><span class="gatsby-highlight-code-line">      projectedTexcoord<span class="token punctuation">.</span>x <span class="token operator">&lt;=</span> <span class="token number">1.0</span> <span class="token operator">&amp;&amp;</span></span><span class="gatsby-highlight-code-line">      projectedTexcoord<span class="token punctuation">.</span>y <span class="token operator">>=</span> <span class="token number">0.0</span> <span class="token operator">&amp;&amp;</span></span><span class="gatsby-highlight-code-line">      projectedTexcoord<span class="token punctuation">.</span>y <span class="token operator">&lt;=</span> <span class="token number">1.0</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line">  <span class="token keyword">vec4</span> projectedTexColor <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>u_projectedTexture<span class="token punctuation">,</span> projectedTexcoord<span class="token punctuation">.</span>xy<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">vec4</span> texColor <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>u_texture<span class="token punctuation">,</span> v_texcoord<span class="token punctuation">)</span> <span class="token operator">*</span> u_colorMult<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line">  <span class="token keyword">float</span> projectedAmount <span class="token operator">=</span> inRange <span class="token operator">?</span> <span class="token number">1.0</span> <span class="token punctuation">:</span> <span class="token number">0.0</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  gl_FragColor <span class="token operator">=</span> <span class="token function">mix</span><span class="token punctuation">(</span>texColor<span class="token punctuation">,</span> projectedTexColor<span class="token punctuation">,</span> projectedAmount<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>为了计算投影的纹理坐标，我们会创建一个矩阵，该矩阵表示 3D 空间中一个确切方向的方位和位置，就像可视化相机文章中的相机那样。然后我们会通过那个 3D 空间投影球体顶点和平面顶点的世界坐标。使用我们刚刚写的代码，那些位于 0 到 1 的投影纹理坐标就会显示该投影纹理。</p>\n<p>让我们添加代码到顶点着色器，通过该空间投影球体和平面的世界坐标</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="81534678306516160000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`attribute vec4 a_position;\nattribute vec2 a_texcoord;\n\nuniform mat4 u_projection;\nuniform mat4 u_view;\nuniform mat4 u_world;\nuniform mat4 u_textureMatrix;\n\nvarying vec2 v_texcoord;\nvarying vec4 v_projectedTexcoord;\n\nvoid main() {\n  vec4 worldPosition = u_world * a_position;\n\n  // gl_Position = u_projection * u_view * u_world * a_position;\n  gl_Position = u_projection * u_view * worldPosition;\n\n  // 将纹理坐标传给片段着色器\n  v_texcoord = a_texcoord;\n\n  v_projectedTexcoord = u_textureMatrix * worldPosition;\n}`, `81534678306516160000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl{7,10,13,15-16,21}"\n              >\n                <span class="gatsby-code-button-language">glsl{7,10,13,15-16,21}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">attribute</span> <span class="token keyword">vec4</span> a_position<span class="token punctuation">;</span>\n<span class="token keyword">attribute</span> <span class="token keyword">vec2</span> a_texcoord<span class="token punctuation">;</span>\n\n<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> u_projection<span class="token punctuation">;</span>\n<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> u_view<span class="token punctuation">;</span>\n<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> u_world<span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">uniform</span> <span class="token keyword">mat4</span> u_textureMatrix<span class="token punctuation">;</span></span>\n<span class="token keyword">varying</span> <span class="token keyword">vec2</span> v_texcoord<span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">varying</span> <span class="token keyword">vec4</span> v_projectedTexcoord<span class="token punctuation">;</span></span>\n<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n<span class="gatsby-highlight-code-line">  <span class="token keyword">vec4</span> worldPosition <span class="token operator">=</span> u_world <span class="token operator">*</span> a_position<span class="token punctuation">;</span></span>\n<span class="gatsby-highlight-code-line">  <span class="token comment">// gl_Position = u_projection * u_view * u_world * a_position;</span></span><span class="gatsby-highlight-code-line">  gl_Position <span class="token operator">=</span> u_projection <span class="token operator">*</span> u_view <span class="token operator">*</span> worldPosition<span class="token punctuation">;</span></span>\n  <span class="token comment">// 将纹理坐标传给片段着色器</span>\n  v_texcoord <span class="token operator">=</span> a_texcoord<span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line">  v_projectedTexcoord <span class="token operator">=</span> u_textureMatrix <span class="token operator">*</span> worldPosition<span class="token punctuation">;</span></span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在，剩下要做的就是计算定义了该方位空间的矩阵。我们要做的就是计算出一个世界矩阵，就像我们对其他物体做的那样，然后取它的逆矩阵。这样我们就得到了一个矩阵，该矩阵可以让我们将其他物体的世界坐标转换为相对于该空间的坐标。这和相机文章中的视图矩阵做的事情是完全一样的。</p>\n<p>我们会使用创建的 lookAt 函数</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="87104406199535200000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const settings = {\n  cameraX: 2.75,\n  cameraY: 5,\n  posX: 3.5,\n  posY: 4.4,\n  posZ: 4.7,\n  targetX: 0.8,\n  targetY: 0,\n  targetZ: 4.7\n};\n\nfunction drawScene(projectionMatrix, cameraMatrix) {\n  // 从相机矩阵中创建一个视图矩阵\n  const viewMatrix = m4.inverse(cameraMatrix);\n\n  let textureWorldMatrix = m4.lookAt(\n    [settings.posX, settings.posY, settings.posZ], // position\n    [settings.targetX, settings.targetY, settings.targetZ], // target\n    [0, 1, 0] // up\n  );\n\n  // 使用这个世界矩阵的逆矩阵来创建\n  // 一个矩阵，该矩阵会变换其他世界坐标\n  // 为相对于这个空间的坐标。\n  const textureMatrix = m4.inverse(textureWorldMatrix);\n\n  // 设置对球体和平面都一样的 uniforms\n  webglUtils.setUniforms(textureProgramInfo, {\n    u_view: viewMatrix,\n    u_projection: projectionMatrix,\n    u_textureMatrix: textureMatrix,\n    u_projectedTexture: imageTexture\n  });\n\n  // ...\n}`, `87104406199535200000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{4-9,31-32}"\n              >\n                <span class="gatsby-code-button-language">js{4-9,31-32}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> settings <span class="token operator">=</span> <span class="token punctuation">{</span>\n  cameraX<span class="token punctuation">:</span> <span class="token number">2.75</span><span class="token punctuation">,</span>\n  cameraY<span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>\n<span class="gatsby-highlight-code-line">  posX<span class="token punctuation">:</span> <span class="token number">3.5</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">  posY<span class="token punctuation">:</span> <span class="token number">4.4</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">  posZ<span class="token punctuation">:</span> <span class="token number">4.7</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">  targetX<span class="token punctuation">:</span> <span class="token number">0.8</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">  targetY<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">  targetZ<span class="token punctuation">:</span> <span class="token number">4.7</span></span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">function</span> <span class="token function">drawScene</span><span class="token punctuation">(</span><span class="token parameter">projectionMatrix<span class="token punctuation">,</span> cameraMatrix</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 从相机矩阵中创建一个视图矩阵</span>\n  <span class="token keyword">const</span> viewMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">inverse</span><span class="token punctuation">(</span>cameraMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">let</span> textureWorldMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">lookAt</span><span class="token punctuation">(</span>\n    <span class="token punctuation">[</span>settings<span class="token punctuation">.</span>posX<span class="token punctuation">,</span> settings<span class="token punctuation">.</span>posY<span class="token punctuation">,</span> settings<span class="token punctuation">.</span>posZ<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// position</span>\n    <span class="token punctuation">[</span>settings<span class="token punctuation">.</span>targetX<span class="token punctuation">,</span> settings<span class="token punctuation">.</span>targetY<span class="token punctuation">,</span> settings<span class="token punctuation">.</span>targetZ<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// target</span>\n    <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token comment">// up</span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 使用这个世界矩阵的逆矩阵来创建</span>\n  <span class="token comment">// 一个矩阵，该矩阵会变换其他世界坐标</span>\n  <span class="token comment">// 为相对于这个空间的坐标。</span>\n  <span class="token keyword">const</span> textureMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">inverse</span><span class="token punctuation">(</span>textureWorldMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 设置对球体和平面都一样的 uniforms</span>\n  webglUtils<span class="token punctuation">.</span><span class="token function">setUniforms</span><span class="token punctuation">(</span>textureProgramInfo<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n    u_view<span class="token punctuation">:</span> viewMatrix<span class="token punctuation">,</span>\n    u_projection<span class="token punctuation">:</span> projectionMatrix<span class="token punctuation">,</span>\n<span class="gatsby-highlight-code-line">    u_textureMatrix<span class="token punctuation">:</span> textureMatrix<span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    u_projectedTexture<span class="token punctuation">:</span> imageTexture</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// ...</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>当然，你不一定要用 lookAt。你可以任选一种方法来创建一个世界矩阵，例如使用一个场景图或矩阵栈。</p>\n<p>在我们运行之前，让我们添加一些缩放比例</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="61562737356911910000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const settings = {\n  cameraX: 2.75,\n  cameraY: 5,\n  posX: 3.5,\n  posY: 4.4,\n  posZ: 4.7,\n  targetX: 0.8,\n  targetY: 0,\n  targetZ: 4.7,\n  projWidth: 2,\n  projHeight: 2\n};\n\nfunction drawScene(projectionMatrix, cameraMatrix) {\n  // 从相机矩阵中创建一个视图矩阵\n  const viewMatrix = m4.inverse(cameraMatrix);\n\n  let textureWorldMatrix = m4.lookAt(\n    [settings.posX, settings.posY, settings.posZ], // position\n    [settings.targetX, settings.targetY, settings.targetZ], // target\n    [0, 1, 0] // up\n  );\n  textureWorldMatrix = m4.scale(textureWorldMatrix, settings.projWidth, settings.projHeight, 1);\n\n  // 使用这个世界矩阵的逆矩阵来创建\n  // 一个矩阵，该矩阵会变换其他世界坐标\n  // 为相对于这个空间的坐标。\n  const textureMatrix = m4.inverse(textureWorldMatrix);\n\n  // ...\n}`, `61562737356911910000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{10-11,23}"\n              >\n                <span class="gatsby-code-button-language">js{10-11,23}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> settings <span class="token operator">=</span> <span class="token punctuation">{</span>\n  cameraX<span class="token punctuation">:</span> <span class="token number">2.75</span><span class="token punctuation">,</span>\n  cameraY<span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>\n  posX<span class="token punctuation">:</span> <span class="token number">3.5</span><span class="token punctuation">,</span>\n  posY<span class="token punctuation">:</span> <span class="token number">4.4</span><span class="token punctuation">,</span>\n  posZ<span class="token punctuation">:</span> <span class="token number">4.7</span><span class="token punctuation">,</span>\n  targetX<span class="token punctuation">:</span> <span class="token number">0.8</span><span class="token punctuation">,</span>\n  targetY<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>\n  targetZ<span class="token punctuation">:</span> <span class="token number">4.7</span><span class="token punctuation">,</span>\n<span class="gatsby-highlight-code-line">  projWidth<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">  projHeight<span class="token punctuation">:</span> <span class="token number">2</span></span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">function</span> <span class="token function">drawScene</span><span class="token punctuation">(</span><span class="token parameter">projectionMatrix<span class="token punctuation">,</span> cameraMatrix</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 从相机矩阵中创建一个视图矩阵</span>\n  <span class="token keyword">const</span> viewMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">inverse</span><span class="token punctuation">(</span>cameraMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">let</span> textureWorldMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">lookAt</span><span class="token punctuation">(</span>\n    <span class="token punctuation">[</span>settings<span class="token punctuation">.</span>posX<span class="token punctuation">,</span> settings<span class="token punctuation">.</span>posY<span class="token punctuation">,</span> settings<span class="token punctuation">.</span>posZ<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// position</span>\n    <span class="token punctuation">[</span>settings<span class="token punctuation">.</span>targetX<span class="token punctuation">,</span> settings<span class="token punctuation">.</span>targetY<span class="token punctuation">,</span> settings<span class="token punctuation">.</span>targetZ<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// target</span>\n    <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token comment">// up</span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line">  textureWorldMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">scale</span><span class="token punctuation">(</span>textureWorldMatrix<span class="token punctuation">,</span> settings<span class="token punctuation">.</span>projWidth<span class="token punctuation">,</span> settings<span class="token punctuation">.</span>projHeight<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n  <span class="token comment">// 使用这个世界矩阵的逆矩阵来创建</span>\n  <span class="token comment">// 一个矩阵，该矩阵会变换其他世界坐标</span>\n  <span class="token comment">// 为相对于这个空间的坐标。</span>\n  <span class="token keyword">const</span> textureMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">inverse</span><span class="token punctuation">(</span>textureWorldMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// ...</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样我们就得到了一个投影的纹理。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/k0k2q1?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>但我觉得这样很难看到该纹理所处的空间。让我们添加一个线框立方体来帮助可视化。</p>\n<p>首先，我们需要一个单独的着色器集合。这些着色器只能绘制纯色，没有纹理。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="8831726624021697000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<script id=&quot;color-vertex-shader&quot; type=&quot;x-shader/x-vertex&quot;>\n  attribute vec4 a_position;\n\n  uniform mat4 u_projection;\n  uniform mat4 u_view;\n  uniform mat4 u_world;\n\n  void main() {\n    // 将 position 乘以矩阵\n    gl_Position = u_projection * u_view * u_world * a_position;\n  }\n</script>\n\n<script id=&quot;color-fragment-shader&quot; type=&quot;x-shader/x-fragment&quot;>\n  precision mediump float;\n\n  uniform vec4 u_color;\n  void main() {\n    gl_FragColor = u_color;\n  }\n</script>`, `8831726624021697000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="html"\n              >\n                <span class="gatsby-code-button-language">html</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="html"><pre style="counter-reset: linenumber NaN" class="language-html line-numbers"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>color-vertex-shader<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>x-shader/x-vertex<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">\n  attribute vec4 a_position<span class="token punctuation">;</span>\n\n  uniform mat4 u_projection<span class="token punctuation">;</span>\n  uniform mat4 u_view<span class="token punctuation">;</span>\n  uniform mat4 u_world<span class="token punctuation">;</span>\n\n  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 将 position 乘以矩阵</span>\n    gl_Position <span class="token operator">=</span> u_projection <span class="token operator">*</span> u_view <span class="token operator">*</span> u_world <span class="token operator">*</span> a_position<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>\n\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>color-fragment-shader<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>x-shader/x-fragment<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">\n  precision mediump float<span class="token punctuation">;</span>\n\n  uniform vec4 u_color<span class="token punctuation">;</span>\n  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    gl_FragColor <span class="token operator">=</span> u_color<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后我们还需要编译和链接这些着色器</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="10894222960038590000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 设置 GLSL 程序\nconst textureProgramInfo = webglUtils.createProgramInfo(gl, [\'vertex-shader-3d\', \'fragment-shader-3d\']);\nconst colorProgramInfo = webglUtils.createProgramInfo(gl, [\'color-vertex-shader\', \'color-fragment-shader\']);`, `10894222960038590000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{3}"\n              >\n                <span class="gatsby-code-button-language">js{3}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 设置 GLSL 程序</span>\n<span class="token keyword">const</span> textureProgramInfo <span class="token operator">=</span> webglUtils<span class="token punctuation">.</span><span class="token function">createProgramInfo</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">\'vertex-shader-3d\'</span><span class="token punctuation">,</span> <span class="token string">\'fragment-shader-3d\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">const</span> colorProgramInfo <span class="token operator">=</span> webglUtils<span class="token punctuation">.</span><span class="token function">createProgramInfo</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">\'color-vertex-shader\'</span><span class="token punctuation">,</span> <span class="token string">\'color-fragment-shader\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后我们需要一些数据来绘制线框立方体</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="57485576564647320000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const sphereBufferInfo = primitives.createSphereBufferInfo(\n  gl,\n  1, // 半径\n  12, // 横轴细分数\n  6 // 纵轴细分数\n);\n\nconst planeBufferInfo = primitives.createPlaneBufferInfo(\n  gl,\n  20, // 宽度\n  20, // 高度\n  1, // 横轴细分数\n  1 // 纵轴细分数\n);\n\nconst cubeLinesBufferInfo = webglUtils.createBufferInfoFromArrays(gl, {\n  position: [0, 0, -1, 1, 0, -1, 0, 1, -1, 1, 1, -1, 0, 0, 1, 1, 0, 1, 0, 1, 1, 1, 1, 1],\n  indices: [0, 1, 1, 3, 3, 2, 2, 0, 4, 5, 5, 7, 7, 6, 6, 4, 0, 4, 1, 5, 3, 7, 2, 6]\n});`, `57485576564647320000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{16-19}"\n              >\n                <span class="gatsby-code-button-language">js{16-19}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> sphereBufferInfo <span class="token operator">=</span> primitives<span class="token punctuation">.</span><span class="token function">createSphereBufferInfo</span><span class="token punctuation">(</span>\n  gl<span class="token punctuation">,</span>\n  <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// 半径</span>\n  <span class="token number">12</span><span class="token punctuation">,</span> <span class="token comment">// 横轴细分数</span>\n  <span class="token number">6</span> <span class="token comment">// 纵轴细分数</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> planeBufferInfo <span class="token operator">=</span> primitives<span class="token punctuation">.</span><span class="token function">createPlaneBufferInfo</span><span class="token punctuation">(</span>\n  gl<span class="token punctuation">,</span>\n  <span class="token number">20</span><span class="token punctuation">,</span> <span class="token comment">// 宽度</span>\n  <span class="token number">20</span><span class="token punctuation">,</span> <span class="token comment">// 高度</span>\n  <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// 横轴细分数</span>\n  <span class="token number">1</span> <span class="token comment">// 纵轴细分数</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line"><span class="token keyword">const</span> cubeLinesBufferInfo <span class="token operator">=</span> webglUtils<span class="token punctuation">.</span><span class="token function">createBufferInfoFromArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">  position<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">  indices<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span></span><span class="gatsby-highlight-code-line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>注意，为了匹配纹理坐标，该立方体在 X 轴和 Y 轴上的范围是 0 到 1。而在 Z 轴上，它的范围是 -1 到 1。这样我们缩放它的时候就能使其在两个方向上都拉伸了。</p>\n<p>要使用该立方体的话，我们只需要使用之前的 textureWorldMatrix 就可以了，因为我们要做的是绘制表示那个空间的立方体。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="29319852150314807000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function drawScene(projectionMatrix, cameraMatrix) {\n  //...\n  // ------ 绘制立方体 ------\n\n  gl.useProgram(colorProgramInfo.program);\n\n  // 设置所有需要的 attributes\n  webglUtils.setBuffersAndAttributes(gl, colorProgramInfo, cubeLinesBufferInfo);\n\n  // 在 Z 轴上缩放该立方体，\n  // 以便表示该纹理是被投影到无限远的。\n  const mat = m4.scale(textureWorldMatrix, 1, 1, 1000);\n\n  // 设置我们计算出来的 unifroms\n  webglUtils.setUniforms(colorProgramInfo, {\n    u_color: [0, 0, 0, 1],\n    u_view: viewMatrix,\n    u_projection: projectionMatrix,\n    u_world: mat\n  });\n\n  // 调用 gl.drawArrays 或者 gl.drawElements\n  webglUtils.drawBufferInfo(gl, cubeLinesBufferInfo, gl.LINES);\n}`, `29319852150314807000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">drawScene</span><span class="token punctuation">(</span><span class="token parameter">projectionMatrix<span class="token punctuation">,</span> cameraMatrix</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">//...</span>\n  <span class="token comment">// ------ 绘制立方体 ------</span>\n\n  gl<span class="token punctuation">.</span><span class="token function">useProgram</span><span class="token punctuation">(</span>colorProgramInfo<span class="token punctuation">.</span>program<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 设置所有需要的 attributes</span>\n  webglUtils<span class="token punctuation">.</span><span class="token function">setBuffersAndAttributes</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> colorProgramInfo<span class="token punctuation">,</span> cubeLinesBufferInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 在 Z 轴上缩放该立方体，</span>\n  <span class="token comment">// 以便表示该纹理是被投影到无限远的。</span>\n  <span class="token keyword">const</span> mat <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">scale</span><span class="token punctuation">(</span>textureWorldMatrix<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 设置我们计算出来的 unifroms</span>\n  webglUtils<span class="token punctuation">.</span><span class="token function">setUniforms</span><span class="token punctuation">(</span>colorProgramInfo<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n    u_color<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n    u_view<span class="token punctuation">:</span> viewMatrix<span class="token punctuation">,</span>\n    u_projection<span class="token punctuation">:</span> projectionMatrix<span class="token punctuation">,</span>\n    u_world<span class="token punctuation">:</span> mat\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 调用 gl.drawArrays 或者 gl.drawElements</span>\n  webglUtils<span class="token punctuation">.</span><span class="token function">drawBufferInfo</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> cubeLinesBufferInfo<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">LINES</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>有了这些，现在我们可以更加容易地看到投影位于哪里了。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/7n5fyf?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>有一点需要注意的是，我们并没有真正地投影该纹理。我们在做的是相反的事情。即对被渲染物体的每一个像素，我们判断纹理的哪一部分是被投影到该像素上的，然后再查找该部分纹理上的颜色。</p>\n<p>既然我们在上面提到了电影放映机，那么我们如何模拟一台电影放映机呢？我们只需要简单地使用一个投影矩阵来乘以它（即上面的纹理矩阵）</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="45546409288832290000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const settings = {\n  cameraX: 2.75,\n  cameraY: 5,\n  posX: 2.5,\n  posY: 4.8,\n  posZ: 4.3,\n  targetX: 2.5,\n  targetY: 0,\n  targetZ: 3.5,\n  projWidth: 1,\n  projHeight: 1,\n  perspective: true,\n  fieldOfView: 45\n};\n\n// ...\n\nfunction drawScene(projectionMatrix, cameraMatrix) {\n  // 从相机矩阵中创建一个视图矩阵\n  const viewMatrix = m4.inverse(cameraMatrix);\n\n  const textureWorldMatrix = m4.lookAt(\n    [settings.posX, settings.posY, settings.posZ], // position\n    [settings.targetX, settings.targetY, settings.targetZ], // target\n    [0, 1, 0] // up\n  );\n  // textureWorldMatrix = m4.scale(textureWorldMatrix, settings.projWidth, settings.projHeight, 1);\n\n  const textureProjectionMatrix = settings.perspective\n    ? m4.perspective(\n        degToRad(settings.fieldOfView),\n        settings.projWidth / settings.projHeight,\n        0.1, // near\n        200\n      ) // far\n    : m4.orthographic(\n        -settings.projWidth / 2, // left\n        settings.projWidth / 2, // right\n        -settings.projHeight / 2, // bottom\n        settings.projHeight / 2, // top\n        0.1, // near\n        200\n      ); // far\n\n  // 使用这个世界矩阵的逆矩阵来创建\n  // 一个矩阵，该矩阵会变换其他世界坐标\n  // 为相对于这个空间的坐标。\n  // const textureMatrix = m4.inverse(textureWorldMatrix);\n  const textureMatrix = m4.multiply(textureProjectionMatrix, m4.inverse(textureWorldMatrix));\n}`, `45546409288832290000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{12-13,27,29-43,48-49}"\n              >\n                <span class="gatsby-code-button-language">js{12-13,27,29-43,48-49}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> settings <span class="token operator">=</span> <span class="token punctuation">{</span>\n  cameraX<span class="token punctuation">:</span> <span class="token number">2.75</span><span class="token punctuation">,</span>\n  cameraY<span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>\n  posX<span class="token punctuation">:</span> <span class="token number">2.5</span><span class="token punctuation">,</span>\n  posY<span class="token punctuation">:</span> <span class="token number">4.8</span><span class="token punctuation">,</span>\n  posZ<span class="token punctuation">:</span> <span class="token number">4.3</span><span class="token punctuation">,</span>\n  targetX<span class="token punctuation">:</span> <span class="token number">2.5</span><span class="token punctuation">,</span>\n  targetY<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>\n  targetZ<span class="token punctuation">:</span> <span class="token number">3.5</span><span class="token punctuation">,</span>\n  projWidth<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>\n  projHeight<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>\n<span class="gatsby-highlight-code-line">  perspective<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">  fieldOfView<span class="token punctuation">:</span> <span class="token number">45</span></span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token comment">// ...</span>\n\n<span class="token keyword">function</span> <span class="token function">drawScene</span><span class="token punctuation">(</span><span class="token parameter">projectionMatrix<span class="token punctuation">,</span> cameraMatrix</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 从相机矩阵中创建一个视图矩阵</span>\n  <span class="token keyword">const</span> viewMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">inverse</span><span class="token punctuation">(</span>cameraMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> textureWorldMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">lookAt</span><span class="token punctuation">(</span>\n    <span class="token punctuation">[</span>settings<span class="token punctuation">.</span>posX<span class="token punctuation">,</span> settings<span class="token punctuation">.</span>posY<span class="token punctuation">,</span> settings<span class="token punctuation">.</span>posZ<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// position</span>\n    <span class="token punctuation">[</span>settings<span class="token punctuation">.</span>targetX<span class="token punctuation">,</span> settings<span class="token punctuation">.</span>targetY<span class="token punctuation">,</span> settings<span class="token punctuation">.</span>targetZ<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// target</span>\n    <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token comment">// up</span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line">  <span class="token comment">// textureWorldMatrix = m4.scale(textureWorldMatrix, settings.projWidth, settings.projHeight, 1);</span></span>\n<span class="gatsby-highlight-code-line">  <span class="token keyword">const</span> textureProjectionMatrix <span class="token operator">=</span> settings<span class="token punctuation">.</span>perspective</span><span class="gatsby-highlight-code-line">    <span class="token operator">?</span> m4<span class="token punctuation">.</span><span class="token function">perspective</span><span class="token punctuation">(</span></span><span class="gatsby-highlight-code-line">        <span class="token function">degToRad</span><span class="token punctuation">(</span>settings<span class="token punctuation">.</span>fieldOfView<span class="token punctuation">)</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">        settings<span class="token punctuation">.</span>projWidth <span class="token operator">/</span> settings<span class="token punctuation">.</span>projHeight<span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">        <span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token comment">// near</span></span><span class="gatsby-highlight-code-line">        <span class="token number">200</span></span><span class="gatsby-highlight-code-line">      <span class="token punctuation">)</span> <span class="token comment">// far</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">:</span> m4<span class="token punctuation">.</span><span class="token function">orthographic</span><span class="token punctuation">(</span></span><span class="gatsby-highlight-code-line">        <span class="token operator">-</span>settings<span class="token punctuation">.</span>projWidth <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token comment">// left</span></span><span class="gatsby-highlight-code-line">        settings<span class="token punctuation">.</span>projWidth <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token comment">// right</span></span><span class="gatsby-highlight-code-line">        <span class="token operator">-</span>settings<span class="token punctuation">.</span>projHeight <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token comment">// bottom</span></span><span class="gatsby-highlight-code-line">        settings<span class="token punctuation">.</span>projHeight <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token comment">// top</span></span><span class="gatsby-highlight-code-line">        <span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token comment">// near</span></span><span class="gatsby-highlight-code-line">        <span class="token number">200</span></span><span class="gatsby-highlight-code-line">      <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// far</span></span>\n  <span class="token comment">// 使用这个世界矩阵的逆矩阵来创建</span>\n  <span class="token comment">// 一个矩阵，该矩阵会变换其他世界坐标</span>\n  <span class="token comment">// 为相对于这个空间的坐标。</span>\n<span class="gatsby-highlight-code-line">  <span class="token comment">// const textureMatrix = m4.inverse(textureWorldMatrix);</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">const</span> textureMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>textureProjectionMatrix<span class="token punctuation">,</span> m4<span class="token punctuation">.</span><span class="token function">inverse</span><span class="token punctuation">(</span>textureWorldMatrix<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>注意，我添加了一个选项，可以选择是使用透视投影矩阵还是使用正交投影矩阵。</p>\n<p>在绘制线框的时候我们也需要使用那个投影矩阵</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="52265484306842590000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// ------ 绘制立方体 ------\n\n// ...\n\n// // 在 Z 轴上缩放该立方体，\n// // 以便表示该纹理是被投影到无限远的。\n// const mat = m4.scale(textureWorldMatrix, 1, 1, 1000);\n\n// 调整立方体使其匹配该投影\nconst mat = m4.multiply(textureWorldMatrix, m4.inverse(textureProjectionMatrix));`, `52265484306842590000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// ------ 绘制立方体 ------</span>\n\n<span class="token comment">// ...</span>\n\n<span class="token comment">// // 在 Z 轴上缩放该立方体，</span>\n<span class="token comment">// // 以便表示该纹理是被投影到无限远的。</span>\n<span class="token comment">// const mat = m4.scale(textureWorldMatrix, 1, 1, 1000);</span>\n\n<span class="token comment">// 调整立方体使其匹配该投影</span>\n<span class="token keyword">const</span> mat <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>textureWorldMatrix<span class="token punctuation">,</span> m4<span class="token punctuation">.</span><span class="token function">inverse</span><span class="token punctuation">(</span>textureProjectionMatrix<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>有了这些，我们就得到了</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/1co2ct?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>它已经正常工作了，但我们的投影和我们的线框立方体都只是使用了 0 到 1 的空间，所以它只使用到了投影视椎体的 1/4。</p>\n<p>要修复这个问题，首先让我们的立方体在所有方向上都是 -1 到 +1</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="64740198143504560000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const cubeLinesBufferInfo = webglUtils.createBufferInfoFromArrays(gl, {\n  position: [\n    //   0,  0, -1,\n    //   1,  0, -1,\n    //   0,  1, -1,\n    //   1,  1, -1,\n    //   0,  0,  1,\n    //   1,  0,  1,\n    //   0,  1,  1,\n    //   1,  1,  1,\n    -1,\n    -1,\n    -1,\n    1,\n    -1,\n    -1,\n    -1,\n    1,\n    -1,\n    1,\n    1,\n    -1,\n    -1,\n    -1,\n    1,\n    1,\n    -1,\n    1,\n    -1,\n    1,\n    1,\n    1,\n    1,\n    1\n  ],\n  indices: [0, 1, 1, 3, 3, 2, 2, 0, 4, 5, 5, 7, 7, 6, 6, 4, 0, 4, 1, 5, 3, 7, 2, 6]\n});`, `64740198143504560000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{3-34}"\n              >\n                <span class="gatsby-code-button-language">js{3-34}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> cubeLinesBufferInfo <span class="token operator">=</span> webglUtils<span class="token punctuation">.</span><span class="token function">createBufferInfoFromArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n  position<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n<span class="gatsby-highlight-code-line">    <span class="token comment">//   0,  0, -1,</span></span><span class="gatsby-highlight-code-line">    <span class="token comment">//   1,  0, -1,</span></span><span class="gatsby-highlight-code-line">    <span class="token comment">//   0,  1, -1,</span></span><span class="gatsby-highlight-code-line">    <span class="token comment">//   1,  1, -1,</span></span><span class="gatsby-highlight-code-line">    <span class="token comment">//   0,  0,  1,</span></span><span class="gatsby-highlight-code-line">    <span class="token comment">//   1,  0,  1,</span></span><span class="gatsby-highlight-code-line">    <span class="token comment">//   0,  1,  1,</span></span><span class="gatsby-highlight-code-line">    <span class="token comment">//   1,  1,  1,</span></span><span class="gatsby-highlight-code-line">    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token number">1</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token number">1</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token number">1</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token number">1</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token number">1</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token number">1</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token number">1</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token number">1</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token number">1</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token number">1</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token number">1</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token number">1</span></span>  <span class="token punctuation">]</span><span class="token punctuation">,</span>\n  indices<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后当将其用于纹理矩阵时，我们需要使视椎体内的空间范围是 0 到 1。这可以通过使空间偏移 0.5 然后将其缩放 0.5 倍来实现。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="48686103337748095000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const textureWorldMatrix = m4.lookAt(\n  [settings.posX, settings.posY, settings.posZ], // position\n  [settings.targetX, settings.targetY, settings.targetZ], // target\n  [0, 1, 0] // up\n);\n\nconst textureProjectionMatrix = settings.perspective\n  ? m4.perspective(\n      degToRad(settings.fieldOfView),\n      settings.projWidth / settings.projHeight,\n      0.1, // near\n      200\n    ) // far\n  : m4.orthographic(\n      -settings.projWidth / 2, // left\n      settings.projWidth / 2, // right\n      -settings.projHeight / 2, // bottom\n      settings.projHeight / 2, // top\n      0.1, // near\n      200\n    ); // far\n\n// // 使用这个世界矩阵的逆矩阵来创建\n// // 一个矩阵，该矩阵会变换其他世界坐标\n// // 为相对于这个空间的坐标。\n// const textureMatrix = m4.multiply(textureProjectionMatrix, m4.inverse(textureWorldMatrix));\n\nlet textureMatrix = m4.identity();\ntextureMatrix = m4.translate(textureMatrix, 0.5, 0.5, 0.5);\ntextureMatrix = m4.scale(textureMatrix, 0.5, 0.5, 0.5);\ntextureMatrix = m4.multiply(textureMatrix, textureProjectionMatrix);\n// 使用这个世界矩阵的逆矩阵来创建\n// 一个矩阵，该矩阵会变换其他世界坐标\n// 为相对于这个空间的坐标。\ntextureMatrix = m4.multiply(textureMatrix, m4.inverse(textureWorldMatrix));`, `48686103337748095000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{23-26,28-35}"\n              >\n                <span class="gatsby-code-button-language">js{23-26,28-35}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> textureWorldMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">lookAt</span><span class="token punctuation">(</span>\n  <span class="token punctuation">[</span>settings<span class="token punctuation">.</span>posX<span class="token punctuation">,</span> settings<span class="token punctuation">.</span>posY<span class="token punctuation">,</span> settings<span class="token punctuation">.</span>posZ<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// position</span>\n  <span class="token punctuation">[</span>settings<span class="token punctuation">.</span>targetX<span class="token punctuation">,</span> settings<span class="token punctuation">.</span>targetY<span class="token punctuation">,</span> settings<span class="token punctuation">.</span>targetZ<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// target</span>\n  <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token comment">// up</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> textureProjectionMatrix <span class="token operator">=</span> settings<span class="token punctuation">.</span>perspective\n  <span class="token operator">?</span> m4<span class="token punctuation">.</span><span class="token function">perspective</span><span class="token punctuation">(</span>\n      <span class="token function">degToRad</span><span class="token punctuation">(</span>settings<span class="token punctuation">.</span>fieldOfView<span class="token punctuation">)</span><span class="token punctuation">,</span>\n      settings<span class="token punctuation">.</span>projWidth <span class="token operator">/</span> settings<span class="token punctuation">.</span>projHeight<span class="token punctuation">,</span>\n      <span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token comment">// near</span>\n      <span class="token number">200</span>\n    <span class="token punctuation">)</span> <span class="token comment">// far</span>\n  <span class="token punctuation">:</span> m4<span class="token punctuation">.</span><span class="token function">orthographic</span><span class="token punctuation">(</span>\n      <span class="token operator">-</span>settings<span class="token punctuation">.</span>projWidth <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token comment">// left</span>\n      settings<span class="token punctuation">.</span>projWidth <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token comment">// right</span>\n      <span class="token operator">-</span>settings<span class="token punctuation">.</span>projHeight <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token comment">// bottom</span>\n      settings<span class="token punctuation">.</span>projHeight <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token comment">// top</span>\n      <span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token comment">// near</span>\n      <span class="token number">200</span>\n    <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// far</span>\n\n<span class="gatsby-highlight-code-line"><span class="token comment">// // 使用这个世界矩阵的逆矩阵来创建</span></span><span class="gatsby-highlight-code-line"><span class="token comment">// // 一个矩阵，该矩阵会变换其他世界坐标</span></span><span class="gatsby-highlight-code-line"><span class="token comment">// // 为相对于这个空间的坐标。</span></span><span class="gatsby-highlight-code-line"><span class="token comment">// const textureMatrix = m4.multiply(textureProjectionMatrix, m4.inverse(textureWorldMatrix));</span></span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">let</span> textureMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">identity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">textureMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">translate</span><span class="token punctuation">(</span>textureMatrix<span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">textureMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">scale</span><span class="token punctuation">(</span>textureMatrix<span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">textureMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>textureMatrix<span class="token punctuation">,</span> textureProjectionMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"><span class="token comment">// 使用这个世界矩阵的逆矩阵来创建</span></span><span class="gatsby-highlight-code-line"><span class="token comment">// 一个矩阵，该矩阵会变换其他世界坐标</span></span><span class="gatsby-highlight-code-line"><span class="token comment">// 为相对于这个空间的坐标。</span></span><span class="gatsby-highlight-code-line">textureMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>textureMatrix<span class="token punctuation">,</span> m4<span class="token punctuation">.</span><span class="token function">inverse</span><span class="token punctuation">(</span>textureWorldMatrix<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在，它看起来可以正常工作了</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/1b2dir?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>那么，平面投影一个纹理有什么作用呢？</p>\n<ol>\n<li>\n<p>因为你想要这么做，大多数 3D 建模软件都提供了一种将一个纹理进行平面投影的方法。</p>\n</li>\n<li>\n<p>另一个作用是贴花（decal）。贴花是一种在物体表面上放置溅射的油漆或爆炸痕迹的方式。要实现贴花，通常不会使用上面着色器的那种做法。相反，你需要写一些函数来遍历需要应用贴花的模型的几何。对于每一个三角形，你需要检查该三角形是否位于该贴花的范围内，这与 JavaScript 的着色器例子中的 inRange 检查一样。对于在贴花范围内的每个三角形，你把该三角形和投影的纹理坐标添加到某个新的几何中。然后你把该贴花添加到你的绘制列表中。</p>\n<p>为贴花生成几何是对的，否则你就需要为 2 个贴花、3 个贴、4 个贴花等等提供不同的着色器，然后你的着色器很快就会变得很复杂，并达到 GPUs 着色器的纹理限制。</p>\n</li>\n<li>\n<p>还有另一个作用是模拟真实世界的投影映射。你对一个物体进行了 3D 建模，你将会把视频投影到该模型上，你使用了类似上面那样的代码来实现投影，除了你的纹理是视频外。然后你可以编辑并完善该视频，使其匹配该模型，而不用在实际现场中使用一个真正的投影仪。</p>\n</li>\n<li>\n<p>这种投影的另一个用处就是用阴影映射来计算阴影。</p>\n</li>\n</ol>\n<h2 id="在条件语句内的纹理引用"><a href="#%E5%9C%A8%E6%9D%A1%E4%BB%B6%E8%AF%AD%E5%8F%A5%E5%86%85%E7%9A%84%E7%BA%B9%E7%90%86%E5%BC%95%E7%94%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>在条件语句内的纹理引用</h2>\n<p>在上面的片段着色器中，在所有的情况下我们都对两个纹理进行了读取</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="48188475762961920000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`  vec4 projectedTexColor = texture2D(u_projectedTexture, projectedTexcoord.xy);\n  vec4 texColor = texture2D(u_texture, v_texcoord) * u_colorMult;\n\n  float projectedAmount = inRange ? 1.0 : 0.0;\n  gl_FragColor = mix(texColor, projectedTexColor, projectedAmount);`, `48188475762961920000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl"\n              >\n                <span class="gatsby-code-button-language">glsl</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl">  <span class="token keyword">vec4</span> projectedTexColor <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>u_projectedTexture<span class="token punctuation">,</span> projectedTexcoord<span class="token punctuation">.</span>xy<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">vec4</span> texColor <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>u_texture<span class="token punctuation">,</span> v_texcoord<span class="token punctuation">)</span> <span class="token operator">*</span> u_colorMult<span class="token punctuation">;</span>\n\n  <span class="token keyword">float</span> projectedAmount <span class="token operator">=</span> inRange <span class="token operator">?</span> <span class="token number">1.0</span> <span class="token punctuation">:</span> <span class="token number">0.0</span><span class="token punctuation">;</span>\n  gl_FragColor <span class="token operator">=</span> <span class="token function">mix</span><span class="token punctuation">(</span>texColor<span class="token punctuation">,</span> projectedTexColor<span class="token punctuation">,</span> projectedAmount<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>为什么我们不像下面这样做呢？</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="2643644456852789000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`if (inRange) {\n   gl_FragColor = texture2D(u_projectedTexture, projectedTexcoord.xy);\n} else {\n   gl_FragColor = texture2D(u_texture, v_texcoord) * u_colorMult;\n}`, `2643644456852789000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl"\n              >\n                <span class="gatsby-code-button-language">glsl</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">if</span> <span class="token punctuation">(</span>inRange<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   gl_FragColor <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>u_projectedTexture<span class="token punctuation">,</span> projectedTexcoord<span class="token punctuation">.</span>xy<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n   gl_FragColor <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>u_texture<span class="token punctuation">,</span> v_texcoord<span class="token punctuation">)</span> <span class="token operator">*</span> u_colorMult<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>摘自 <a href="https://www.khronos.org/files/opengles_shading_language.pdf" target="_blank" rel="nofollow noreferrer noopener">GLSL ES 1.0 spec Appendix A, Section 6</a></p>\n<p>Texture Accesses</p>\n<p>Accessing mip-mapped textures within the body of a non-uniform conditional block gives an undefined value. A non-uniform conditional block is a block whose execution cannot be determined at compile time.</p>\n<p>换句话说，如果我们要使用 mip-mapped 的纹理，那我们就必须确保总是能够访问到它们。我们可以在条件语句内使用访问纹理的结果。例如我们可以写成这样：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="17941788211153930000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`vec4 projectedTexColor = texture2D(u_projectedTexture, projectedTexcoord.xy);\nvec4 texColor = texture2D(u_texture, v_texcoord) * u_colorMult;\n\nif (inRange) {\n   gl_FragColor = projectedTexColor;\n} else {\n   gl_FragColor = texColor;\n}`, `17941788211153930000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl"\n              >\n                <span class="gatsby-code-button-language">glsl</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">vec4</span> projectedTexColor <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>u_projectedTexture<span class="token punctuation">,</span> projectedTexcoord<span class="token punctuation">.</span>xy<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">vec4</span> texColor <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>u_texture<span class="token punctuation">,</span> v_texcoord<span class="token punctuation">)</span> <span class="token operator">*</span> u_colorMult<span class="token punctuation">;</span>\n\n<span class="token keyword">if</span> <span class="token punctuation">(</span>inRange<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   gl_FragColor <span class="token operator">=</span> projectedTexColor<span class="token punctuation">;</span>\n<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n   gl_FragColor <span class="token operator">=</span> texColor<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>或者这样</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="56644228898390516000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`vec4 projectedTexColor = texture2D(u_projectedTexture, projectedTexcoord.xy);\nvec4 texColor = texture2D(u_texture, v_texcoord) * u_colorMult;\n\ngl_FragColor = inRange ? projectedTexColor : texColor;`, `56644228898390516000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl"\n              >\n                <span class="gatsby-code-button-language">glsl</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">vec4</span> projectedTexColor <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>u_projectedTexture<span class="token punctuation">,</span> projectedTexcoord<span class="token punctuation">.</span>xy<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">vec4</span> texColor <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>u_texture<span class="token punctuation">,</span> v_texcoord<span class="token punctuation">)</span> <span class="token operator">*</span> u_colorMult<span class="token punctuation">;</span>\n\ngl_FragColor <span class="token operator">=</span> inRange <span class="token operator">?</span> projectedTexColor <span class="token punctuation">:</span> texColor<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>但是我们不能在条件语句内访问 mip-mapped 的纹理本身。这样做在你的 GPU 上可能是可行的，但并不是在所有的 GPUs 上都能行。注意，规范没有说明能否在条件语句内访问 non-mipmapped 的纹理，所以，如果你确定你的纹理是 non-mipmapped 的，那就没什么问题。</p>\n<p>无论如何，重要的是你要知道有这么个东西</p>\n<p>至于我为什么使用 mix 而不使用基于 inRange 的三元运算符，则只是一个个人喜好。mix 更加灵活，所以我通常这样写。</p>\n<h1 id="webgl-渐变纹理"><a href="#webgl-%E6%B8%90%E5%8F%98%E7%BA%B9%E7%90%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>WebGL 渐变纹理</h1>\n<p>WebGL 中的一个重要认识是纹理不仅仅是直接应用于三角形的东西，正如我们在纹理文章中所介绍的那样。纹理是随机访问数据的数组，通常是二维数据数组。因此，使用随机访问数据数组的任何解决方案都是我们可以使用纹理的地方。</p>\n<p>在关于定向光的文章中，我们介绍了如何使用点积来计算 2 个向量之间的角度。在那里 ​ 我们计算了光的方向与模型表面法线的点积，这提供了 2 个向量之间角度的余弦值。余弦是从 -1 到 +1 的值，我们将其用作颜色的直接乘数。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="40212094595221840000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`float light = dot(normal, u_reverseLightDirection);\n\ngl_FragColor = u_color;\ngl_FragColor.rgb *= light;`, `40212094595221840000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl"\n              >\n                <span class="gatsby-code-button-language">glsl</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">float</span> light <span class="token operator">=</span> <span class="token function">dot</span><span class="token punctuation">(</span>normal<span class="token punctuation">,</span> u_reverseLightDirection<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\ngl_FragColor <span class="token operator">=</span> u_color<span class="token punctuation">;</span>\ngl_FragColor<span class="token punctuation">.</span>rgb <span class="token operator">*</span><span class="token operator">=</span> light<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这会使颜色变暗，使其远离光线。</p>\n<p>如果我们不直接使用该点积，而是使用它从一维纹理中查找值，该怎么办？</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="84538757393247620000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`precision mediump float;\n\n// 从顶点着色器传入\nvarying vec3 v_normal;\n\nuniform vec3 u_reverseLightDirection;\nuniform vec4 u_color;\nuniform sampler2D u_ramp;\n\nvoid main() {\n  // 因为 v_normal 是一个变量，所以它是插值的\n  // 所以它不会是单位向量。规范化它\n  // 将再次使其成为单位向量\n  vec3 normal = normalize(v_normal);\n\n  // float light = dot(normal, u_reverseLightDirection);\n  float cosAngle = dot(normal, u_reverseLightDirection);\n\n  // 从 -1 <-> 1 转换为 0 <-> 1\n  float u = cosAngle * 0.5 + 0.5;\n\n  // 创建一个纹理坐标\n  vec2 uv = vec2(u, 0.5);\n\n  // 从一维纹理中查找一个值\n  vec4 rampColor = texture2D(u_ramp, uv);\n\n  gl_FragColor = u_color;\n  // gl_FragColor.rgb *= light;\n  gl_FragColor *= rampColor;\n}`, `84538757393247620000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl{8,16-26,29-30}"\n              >\n                <span class="gatsby-code-button-language">glsl{8,16-26,29-30}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">precision</span> <span class="token keyword">mediump</span> <span class="token keyword">float</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 从顶点着色器传入</span>\n<span class="token keyword">varying</span> <span class="token keyword">vec3</span> v_normal<span class="token punctuation">;</span>\n\n<span class="token keyword">uniform</span> <span class="token keyword">vec3</span> u_reverseLightDirection<span class="token punctuation">;</span>\n<span class="token keyword">uniform</span> <span class="token keyword">vec4</span> u_color<span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">uniform</span> <span class="token keyword">sampler2D</span> u_ramp<span class="token punctuation">;</span></span>\n<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 因为 v_normal 是一个变量，所以它是插值的</span>\n  <span class="token comment">// 所以它不会是单位向量。规范化它</span>\n  <span class="token comment">// 将再次使其成为单位向量</span>\n  <span class="token keyword">vec3</span> normal <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>v_normal<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line">  <span class="token comment">// float light = dot(normal, u_reverseLightDirection);</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">float</span> cosAngle <span class="token operator">=</span> <span class="token function">dot</span><span class="token punctuation">(</span>normal<span class="token punctuation">,</span> u_reverseLightDirection<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line">  <span class="token comment">// 从 -1 &lt;-> 1 转换为 0 &lt;-> 1</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">float</span> u <span class="token operator">=</span> cosAngle <span class="token operator">*</span> <span class="token number">0.5</span> <span class="token operator">+</span> <span class="token number">0.5</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line">  <span class="token comment">// 创建一个纹理坐标</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">vec2</span> uv <span class="token operator">=</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span>u<span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line">  <span class="token comment">// 从一维纹理中查找一个值</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">vec4</span> rampColor <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>u_ramp<span class="token punctuation">,</span> uv<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n  gl_FragColor <span class="token operator">=</span> u_color<span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line">  <span class="token comment">// gl_FragColor.rgb *= light;</span></span><span class="gatsby-highlight-code-line">  gl_FragColor <span class="token operator">*</span><span class="token operator">=</span> rampColor<span class="token punctuation">;</span></span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们需要制作纹理，让我们从 2x1 纹理开始，我们将使用 LUMINANCE 为我们提供单色纹理的格式，每个纹理像素仅使用 1 个字节。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="45147323430128750000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var tex = gl.createTexture();\ngl.bindTexture(gl.TEXTURE_2D, tex);\ngl.texImage2D(\n  gl.TEXTURE_2D, // 目标\n  0, // mip 级别\n  gl.LUMINANCE, // 内部格式\n  2, // 宽度\n  1, // 高度\n  0, // 边界\n  gl.LUMINANCE, // 格式\n  gl.UNSIGNED_BYTE, // 类型\n  new Uint8Array([90, 255])\n);\n\ngl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);\ngl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);\ngl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);\ngl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);`, `45147323430128750000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> tex <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createTexture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> tex<span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">texImage2D</span><span class="token punctuation">(</span>\n  gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> <span class="token comment">// 目标</span>\n  <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// mip 级别</span>\n  gl<span class="token punctuation">.</span><span class="token constant">LUMINANCE</span><span class="token punctuation">,</span> <span class="token comment">// 内部格式</span>\n  <span class="token number">2</span><span class="token punctuation">,</span> <span class="token comment">// 宽度</span>\n  <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// 高度</span>\n  <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// 边界</span>\n  gl<span class="token punctuation">.</span><span class="token constant">LUMINANCE</span><span class="token punctuation">,</span> <span class="token comment">// 格式</span>\n  gl<span class="token punctuation">.</span><span class="token constant">UNSIGNED_BYTE</span><span class="token punctuation">,</span> <span class="token comment">// 类型</span>\n  <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">90</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\ngl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_WRAP_S</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">CLAMP_TO_EDGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_WRAP_T</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">CLAMP_TO_EDGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_MIN_FILTER</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">NEAREST</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_MAG_FILTER</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">NEAREST</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>上面 2 个像素的颜色是深灰色（90）和白色（255）。我们还设置了纹理参数，因此不会有过滤。</p>\n<p>修改新纹理的样本，我们需要查找 <code class="language-text">u_ramp</code> 变量</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="46803344228567220000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var worldViewProjectionLocation = gl.getUniformLocation(program, \'u_worldViewProjection\');\nvar worldInverseTransposeLocation = gl.getUniformLocation(program, \'u_worldInverseTranspose\');\nvar colorLocation = gl.getUniformLocation(program, \'u_color\');\nvar rampLocation = gl.getUniformLocation(program, \'u_ramp\');\nvar reverseLightDirectionLocation = gl.getUniformLocation(program, \'u_reverseLightDirection\');`, `46803344228567220000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{4}"\n              >\n                <span class="gatsby-code-button-language">js{4}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> worldViewProjectionLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_worldViewProjection\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> worldInverseTransposeLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_worldInverseTranspose\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> colorLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_color\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">var</span> rampLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_ramp\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="token keyword">var</span> reverseLightDirectionLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_reverseLightDirection\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们需要在渲染时设置纹理</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="3411756914245267500"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 将纹理绑定到活动纹理单元 0\ngl.activeTexture(gl.TEXTURE0 + 0);\ngl.bindTexture(gl.TEXTURE_2D, tex);\n// 告诉着色器 u_ramp 应该使用纹理单元 0 上的纹理\ngl.uniform1i(rampLocation, 0);`, `3411756914245267500`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 将纹理绑定到活动纹理单元 0</span>\ngl<span class="token punctuation">.</span><span class="token function">activeTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE0</span> <span class="token operator">+</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> tex<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// 告诉着色器 u_ramp 应该使用纹理单元 0 上的纹理</span>\ngl<span class="token punctuation">.</span><span class="token function">uniform1i</span><span class="token punctuation">(</span>rampLocation<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我将 3D 的 F 数据换成了低多边形头部的数据。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/kcp967?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>如果您旋转模型，您会看到它看起来类似于卡通着色</p>\n<p>在上面的示例中，我们设置了纹理过滤，NEAREST 这意味着我们只需从纹理中选择最近的纹理元作为我们的颜色。只有 2 个纹理元，所以如果表面背对光，我们得到第一种颜色（深灰色），如果表面朝向光，我们得到第二种颜色（白色），那种颜色乘以以前的 <code class="language-text">gl_FragColor</code> 颜色 light。</p>\n<p>考虑一下，如果我们切换到 LINEAR 过滤，我们应该得到与使用纹理之前相同的结果。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="65455125101140560000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);\n// gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);\ngl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);\ngl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);`, `65455125101140560000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);</span>\n<span class="token comment">// gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);</span>\ngl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_MIN_FILTER</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">LINEAR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_MAG_FILTER</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">LINEAR</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/l4glzu?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>这看起来很相似，但如果我们真的将它们并排比较…</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-08-04-11-29-57-756c6fb89441c612727e6bfb485f5329-21746.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 449px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 64.3652561247216%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsSAAALEgHS3X78AAADcElEQVQ4yz2TbUxVdRzH//dyAas1e2CjOcJSdwkUMpgujFByrcf1wmq2dMu5NdeiFwk2s5W90OGkgSQ0lhuXHA8ijMTMsEnYCzdbY6GbiVvjIYHLlXPvOefec+7zvZ9+97K1nbPz5rfP+X6/v+9PWXoISw/yRbiTkuQe3OH3+GDuSxa0RaKhCAE9gGEY6IaOruuk9DjD+hhVs3tx//kmL/y6m/F/rpMKJ2RWR90zFnk1dhCVqkKlt6GsatSkG/foK0zMTGIH7Sw0M2wZIY6FulD3t6D+LkeNl6HOFpHb/DTfj3cTEQGq3T4voM24ki/hTO/AYdSQN7EVdeYxPhxqIGUnWNY1bN3irjlNnrUD5d1Czu2tOK6Wk3u2FHW0gLUNFfh8PtRJu0fUyUCyTr7bUXYNzglRe6qQfd31xKwomu4nrNvcMu+Sbwpw4XlxUYka24SjtwT1eSHrPqpg9t9ZVL91RUBiNSGwaC3qr0pcQxtRLY/z1UgTRNMsB5YJSc5zxjzF3rdkphzHmFg+V0LesadQnz5K1aFabNNCjYSuoZI1K8CMwtGNuG5KRleLafq5FWJkgUHdZMFcwr30LuqPMhz3qnEOlZLbJEBPEdVHXyYWiqJ+CV0XYO3Ki2T4UxmuS5m/r6Fl5DTEBehfxhSgz7jPJm0PanYzDsnbebGM/MYi1DeF1B1+fQU4ad4hP7lTFL6YBeb0lOA6vhbVuoaesXOkYim0gPb/luu0jyXDZ3HGtuMceIYH3ilAfbKavcf3kwjHUZlcVideE7tiO1aLc0Ts9LpxnCxm9MYV4pE4/oA/u5i0dHCXfhjlqyBnTiyf2cCqQ0+i6h/mYNtnpKJJVFjq8Ea0MbtpV6wO55RU5sf1rGurxru4iBkMZgudAaaMOO3agJS3HNctqc1wKXmt61EHHuHC+EUS0YQA/RY3jJs4M0uJC2xK6nCqAM/vvcStmNj1Zy8lU25/QK5G09k2tx91e4MApdgNq9jdvI+wHIDm1+QwIjbI40le4gl28dCdGo6Mn4CENCYWxTTNrMKgKA1HI9klTdnTPDf9Pg9ermRn59t4l7yk02kiEbmUgYEB2k5/y7XLv9HYfIQTP7TQ391Lx3cdeDwe5ufnsW2bmZkZOjs7ae9oZ2ToAueHBznwdT1Dg4P09/XT1dVFX18f/wGu7dCA/AoUogAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 08 04 11 29 57" title="" data-src="/static/2022-08-04-11-29-57-756c6fb89441c612727e6bfb485f5329-21746.png" data-srcset="/static/2022-08-04-11-29-57-756c6fb89441c612727e6bfb485f5329-17e1d.png 200w,\n/static/2022-08-04-11-29-57-756c6fb89441c612727e6bfb485f5329-f4f9f.png 400w,\n/static/2022-08-04-11-29-57-756c6fb89441c612727e6bfb485f5329-21746.png 449w" data-sizes="(max-width: 449px) 100vw, 449px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>我们可以看到它们并不相同。这是怎么回事？</p>\n<p>LINEAR 过滤像素之间的混合。如果我们使用线性过滤放大 2 像素纹理，我们会看到问题</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-08-04-11-30-56-2f5398c85f07c1d54a1bd7430a5751c3-cf56a.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 353px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 141.07648725212462%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAcCAYAAABh2p9gAAAACXBIWXMAAAsSAAALEgHS3X78AAAEXklEQVRIx8WVW09cVRTHz1xgZpgWixUo2ktCorVGihELRTncivpgoqZFX/XVFBvtgw9+AjXR+uA3MJJoGG5P3goMkaS0TaXFBpgpDENhDsNw51z22eec+bvOmTMMIiZGE92T3+y19+z93ytrrT1buH37Fn67NwmYpkN8ehq3xsdxf5LmqGUNA5MTE7hzbwLcMpClT2w2jl8n7zpY9hr6TiTn8MuNmxBUTYOGQuPENsH2zDm26uwsLGL7FpE/hs4hGIoCtW8ALNIHLdIP1jsAlWyd5uyxTuz092Nwawg9bAQRdRh9LIoeeQi92ohDRM3Nr+tb5GFiHoYgAETWhbu95c5vEn7pOQioh8BfIC8IVufa5yCY1Ot1uCNPQdCSCzCCj9DGIOALI+stgUHYfdZXQvMl2Dp8CEfTTSTYDh9vhddsg5dRb7TCZ9uEh7fgrhIjD23BosO0sZi8CjoYQmDXBtlb4RIcSb9Igq20sZk8aiGPqDdc24aLOUHtT4IBVzDwzwTV/0LQ/NeCblKyByYltCcpbW5SCNbiJMVJEI09ej4p84WyyWP8Zdmcy5WK6ZaNXT6mWzacykaZpqQsL0NtexV6UztYcweYeAEKwcUOBzRewHZ7B17JvIfz1hWIrAvN7H2I8mWIymU0q10QtS7HjqtJOoQxaLE49PiDXeSpaew8mMFGMoZMKo4lKQZpMYbUyizm1+cws53AlJxAnC0grj/MQbbKtVwMtVCZEzfuPwSDUHwhJKuCGGsI47uLZfi86xg++OQUOr8+jZqhWvhn6uHdbIafte3iU1sLdWj6wxQrv5NRO9uGUASpsgg364PovVSKa1fKcfWzE+jsfhLPjtbAk6C4qZQkUyQo0xbBmzChzLhZLi7NlY0n5JQK9wSQOlaM8YYSRC4dIcFKEjyJt7qfQk30LLxzDRBkER6jxSFfRgfWoV0+Otk5wZArWIGrn+4VpD8JuSlXh0ahDgse7rvLBwl++L8JOn8OgVInIVlvyImj7g0iVRXA+PkwIp1l+NKJ4Sm83X0aZ6O18O3GsDUH3ZRCDOeTdHeD7i3xEV7KsgfSUQ/G64rQ82YYX3Q9SmXzOC5+U40z0WcgJJ6njY3k2Us5LII3uh4uLkI7Xg2j/Dh45UkYhFz+BBbOVOHGyyfQ9041vvroaXx8rRbvflsPMSqiIt6BxzZfQyV7w6HCRn0d95VZCgHnYKkUuLRMSNBTErSlFFhagrIiYWdtGRtrKaxtSFjbSSMtpyGxDJbYClJ6BhJfdbBtxhl5TE+nhT+2BTpgeXUV3LTA6CVTNQZVZdAZh8lNbGTWsTj/EPubaZgQsll6aS1rF9BYkWWo9BpyXYeuMzBmozm2znUoqoIdWmO/0VbWKkD7hby6Lby3/7tt//qch/vE7N4+zR7ml9ve2WN7XiePdfLetvPr8wgHnZZZSeP7H35EX/8AoqOjGB6JYnBwAD/9fB3Xh4YxNjaGfvptdi7hrM8L2+13fHsuGmkZGUcAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 08 04 11 30 56" title="" data-src="/static/2022-08-04-11-30-56-2f5398c85f07c1d54a1bd7430a5751c3-cf56a.png" data-srcset="/static/2022-08-04-11-30-56-2f5398c85f07c1d54a1bd7430a5751c3-da624.png 200w,\n/static/2022-08-04-11-30-56-2f5398c85f07c1d54a1bd7430a5751c3-cf56a.png 353w" data-sizes="(max-width: 353px) 100vw, 353px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>每边有半个像素，没有插值。想象一下，如果纹理设置 <code class="language-text">TEXTURE_WRAP_S</code> 为 REPEAT，然后我们期望红色像素的最左半部分线性地向绿色混合，就好像绿色向左重复一样。但是左边的颜色更红，因为我们使用的是 <code class="language-text">CLAMP_TO_EDGE</code></p>\n<p>要真正获得渐变，我们只想从该中心范围中选择值。我们可以通过着色器中的一些数学运算来做到这一点</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="8650713833844037000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`precision mediump float;\n\n// 从顶点着色器传入\nvarying vec3 v_normal;\n\nuniform vec3 u_reverseLightDirection;\nuniform vec4 u_color;\nuniform sampler2D u_ramp;\nuniform vec2 u_rampSize;\n\nvoid main() {\n  // 因为 v_normal 是一个变量，所以它是插值的\n  // 所以它不会是单位向量。规范化它\n  // 将再次使其成为单位向量\n  vec3 normal = normalize(v_normal);\n\n  float cosAngle = dot(normal, u_reverseLightDirection);\n\n  // 从 -1 <-> 1 转换为 0 <-> 1\n  float u = cosAngle * 0.5 + 0.5;\n\n  // 制作纹理坐标\n  vec2 uv = vec2(u, 0.5);\n\n  // 缩放到渐变的大小\n  vec2 texelRange = uv * (u_rampSize - 1.0);\n\n  // 偏移半个纹理元并转换为纹理坐标\n  vec2 rampUV = (texelRange + 0.5) / u_rampSize;\n\n  // vec4 rampColor = texture2D(u_ramp, uv);\n  vec4 rampColor = texture2D(u_ramp, rampUV);\n\n  gl_FragColor = u_color;\n  gl_FragColor *= rampColor;\n}`, `8650713833844037000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl{9,25-29,31-32}"\n              >\n                <span class="gatsby-code-button-language">glsl{9,25-29,31-32}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">precision</span> <span class="token keyword">mediump</span> <span class="token keyword">float</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 从顶点着色器传入</span>\n<span class="token keyword">varying</span> <span class="token keyword">vec3</span> v_normal<span class="token punctuation">;</span>\n\n<span class="token keyword">uniform</span> <span class="token keyword">vec3</span> u_reverseLightDirection<span class="token punctuation">;</span>\n<span class="token keyword">uniform</span> <span class="token keyword">vec4</span> u_color<span class="token punctuation">;</span>\n<span class="token keyword">uniform</span> <span class="token keyword">sampler2D</span> u_ramp<span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">uniform</span> <span class="token keyword">vec2</span> u_rampSize<span class="token punctuation">;</span></span>\n<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 因为 v_normal 是一个变量，所以它是插值的</span>\n  <span class="token comment">// 所以它不会是单位向量。规范化它</span>\n  <span class="token comment">// 将再次使其成为单位向量</span>\n  <span class="token keyword">vec3</span> normal <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>v_normal<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">float</span> cosAngle <span class="token operator">=</span> <span class="token function">dot</span><span class="token punctuation">(</span>normal<span class="token punctuation">,</span> u_reverseLightDirection<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 从 -1 &lt;-> 1 转换为 0 &lt;-> 1</span>\n  <span class="token keyword">float</span> u <span class="token operator">=</span> cosAngle <span class="token operator">*</span> <span class="token number">0.5</span> <span class="token operator">+</span> <span class="token number">0.5</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 制作纹理坐标</span>\n  <span class="token keyword">vec2</span> uv <span class="token operator">=</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span>u<span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line">  <span class="token comment">// 缩放到渐变的大小</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">vec2</span> texelRange <span class="token operator">=</span> uv <span class="token operator">*</span> <span class="token punctuation">(</span>u_rampSize <span class="token operator">-</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line">  <span class="token comment">// 偏移半个纹理元并转换为纹理坐标</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">vec2</span> rampUV <span class="token operator">=</span> <span class="token punctuation">(</span>texelRange <span class="token operator">+</span> <span class="token number">0.5</span><span class="token punctuation">)</span> <span class="token operator">/</span> u_rampSize<span class="token punctuation">;</span></span>\n<span class="gatsby-highlight-code-line">  <span class="token comment">// vec4 rampColor = texture2D(u_ramp, uv);</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">vec4</span> rampColor <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>u_ramp<span class="token punctuation">,</span> rampUV<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n  gl_FragColor <span class="token operator">=</span> u_color<span class="token punctuation">;</span>\n  gl_FragColor <span class="token operator">*</span><span class="token operator">=</span> rampColor<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>上面我们基本上是在缩放我们的 uv 坐标，所以它从 0 到 1 比纹理的宽度小 1。然后添加半个像素并转换回标准化纹理坐标。</p>\n<p>我们需要查找位置 <code class="language-text">u_rampSize</code></p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="28088472324334866000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var colorLocation = gl.getUniformLocation(program, \'u_color\');\nvar rampLocation = gl.getUniformLocation(program, \'u_ramp\');\nvar rampSizeLocation = gl.getUniformLocation(program, \'u_rampSize\');`, `28088472324334866000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> colorLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_color\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> rampLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_ramp\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> rampSizeLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_rampSize\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>我们需要在渲染时设置它</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="79214109129193910000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 将纹理绑定到活动纹理单元 0\ngl.activeTexture(gl.TEXTURE0 + 0);\ngl.bindTexture(gl.TEXTURE_2D, tex);\n// 告诉着色器 u_ramp 应该使用纹理单元 0 上的纹理\ngl.uniform1i(rampLocation, 0);\ngl.uniform2fv(rampSizeLocation, [2, 1]);`, `79214109129193910000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 将纹理绑定到活动纹理单元 0</span>\ngl<span class="token punctuation">.</span><span class="token function">activeTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE0</span> <span class="token operator">+</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> tex<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// 告诉着色器 u_ramp 应该使用纹理单元 0 上的纹理</span>\ngl<span class="token punctuation">.</span><span class="token function">uniform1i</span><span class="token punctuation">(</span>rampLocation<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">uniform2fv</span><span class="token punctuation">(</span>rampSizeLocation<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在我们运行它之前，让我们添加一个标志，以便我们可以比较有无渐变纹理</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="99899464904451100000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`precision mediump float;\n\n// 从顶点着色器传入\nvarying vec3 v_normal;\n\nuniform vec3 u_reverseLightDirection;\nuniform vec4 u_color;\nuniform sampler2D u_ramp;\nuniform vec2 u_rampSize;\nuniform bool u_useRampTexture;\n\nvoid main() {\n  // 因为 v_normal 是一个变量，所以它是插值的\n  // 所以它不会是单位向量。规范化它\n  // 将再次使其成为单位向量\n  vec3 normal = normalize(v_normal);\n\n  float cosAngle = dot(normal, u_reverseLightDirection);\n\n  // 从 -1 <-> 1 转换为 0 <-> 1\n  float u = cosAngle * 0.5 + 0.5;\n\n  // 制作纹理坐标\n  vec2 uv = vec2(u, 0.5);\n\n  // 缩放到渐变的大小\n  vec2 texelRange = uv * (u_rampSize - 1.0);\n\n  // 偏移半个纹理元并转换为纹理坐标\n  vec2 rampUV = (texelRange + 0.5) / u_rampSize;\n\n  vec4 rampColor = texture2D(u_ramp, rampUV);\n\n  if (!u_useRampTexture) {\n    rampColor = vec4(u, u, u, 1);\n  }\n\n  gl_FragColor = u_color;\n  gl_FragColor *= rampColor;\n}`, `99899464904451100000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl{10,34-36}"\n              >\n                <span class="gatsby-code-button-language">glsl{10,34-36}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">precision</span> <span class="token keyword">mediump</span> <span class="token keyword">float</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 从顶点着色器传入</span>\n<span class="token keyword">varying</span> <span class="token keyword">vec3</span> v_normal<span class="token punctuation">;</span>\n\n<span class="token keyword">uniform</span> <span class="token keyword">vec3</span> u_reverseLightDirection<span class="token punctuation">;</span>\n<span class="token keyword">uniform</span> <span class="token keyword">vec4</span> u_color<span class="token punctuation">;</span>\n<span class="token keyword">uniform</span> <span class="token keyword">sampler2D</span> u_ramp<span class="token punctuation">;</span>\n<span class="token keyword">uniform</span> <span class="token keyword">vec2</span> u_rampSize<span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">uniform</span> <span class="token keyword">bool</span> u_useRampTexture<span class="token punctuation">;</span></span>\n<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 因为 v_normal 是一个变量，所以它是插值的</span>\n  <span class="token comment">// 所以它不会是单位向量。规范化它</span>\n  <span class="token comment">// 将再次使其成为单位向量</span>\n  <span class="token keyword">vec3</span> normal <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>v_normal<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">float</span> cosAngle <span class="token operator">=</span> <span class="token function">dot</span><span class="token punctuation">(</span>normal<span class="token punctuation">,</span> u_reverseLightDirection<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 从 -1 &lt;-> 1 转换为 0 &lt;-> 1</span>\n  <span class="token keyword">float</span> u <span class="token operator">=</span> cosAngle <span class="token operator">*</span> <span class="token number">0.5</span> <span class="token operator">+</span> <span class="token number">0.5</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 制作纹理坐标</span>\n  <span class="token keyword">vec2</span> uv <span class="token operator">=</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span>u<span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 缩放到渐变的大小</span>\n  <span class="token keyword">vec2</span> texelRange <span class="token operator">=</span> uv <span class="token operator">*</span> <span class="token punctuation">(</span>u_rampSize <span class="token operator">-</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 偏移半个纹理元并转换为纹理坐标</span>\n  <span class="token keyword">vec2</span> rampUV <span class="token operator">=</span> <span class="token punctuation">(</span>texelRange <span class="token operator">+</span> <span class="token number">0.5</span><span class="token punctuation">)</span> <span class="token operator">/</span> u_rampSize<span class="token punctuation">;</span>\n\n  <span class="token keyword">vec4</span> rampColor <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>u_ramp<span class="token punctuation">,</span> rampUV<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>u_useRampTexture<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    rampColor <span class="token operator">=</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>u<span class="token punctuation">,</span> u<span class="token punctuation">,</span> u<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span></span>\n  gl_FragColor <span class="token operator">=</span> u_color<span class="token punctuation">;</span>\n  gl_FragColor <span class="token operator">*</span><span class="token operator">=</span> rampColor<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们也会查找 uniform 的位置。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="18622994642101310000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var rampLocation = gl.getUniformLocation(program, \'u_ramp\');\nvar rampSizeLocation = gl.getUniformLocation(program, \'u_rampSize\');\nvar useRampTextureLocation = gl.getUniformLocation(program, \'u_useRampTexture\');`, `18622994642101310000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{3}"\n              >\n                <span class="gatsby-code-button-language">js{3}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> rampLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_ramp\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> rampSizeLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_rampSize\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">var</span> useRampTextureLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_useRampTexture\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>并设置它</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="48476306537465680000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var data = {\n  useRampTexture: true\n};\n\n// ...\n\n// 将纹理绑定到活动纹理单元 0\ngl.activeTexture(gl.TEXTURE0 + 0);\ngl.bindTexture(gl.TEXTURE_2D, tex);\n// 告诉着色器 u_ramp 应该使用纹理单元 0 上的纹理\ngl.uniform1i(rampLocation, 0);\ngl.uniform2fv(rampSizeLocation, [2, 1]);\n\ngl.uniform1i(useRampTextureLocation, data.useRampTexture);`, `48476306537465680000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{14}"\n              >\n                <span class="gatsby-code-button-language">js{14}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> data <span class="token operator">=</span> <span class="token punctuation">{</span>\n  useRampTexture<span class="token punctuation">:</span> <span class="token boolean">true</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token comment">// ...</span>\n\n<span class="token comment">// 将纹理绑定到活动纹理单元 0</span>\ngl<span class="token punctuation">.</span><span class="token function">activeTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE0</span> <span class="token operator">+</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> tex<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// 告诉着色器 u_ramp 应该使用纹理单元 0 上的纹理</span>\ngl<span class="token punctuation">.</span><span class="token function">uniform1i</span><span class="token punctuation">(</span>rampLocation<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">uniform2fv</span><span class="token punctuation">(</span>rampSizeLocation<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line">gl<span class="token punctuation">.</span><span class="token function">uniform1i</span><span class="token punctuation">(</span>useRampTextureLocation<span class="token punctuation">,</span> data<span class="token punctuation">.</span>useRampTexture<span class="token punctuation">)</span><span class="token punctuation">;</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>并且我们可以看到旧的光照方式和新的渐变纹理方式匹配</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/hhj00m?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>单击 useRampTexture 复选框，我们看不到任何变化，因为这两种技术现在匹配。</p>\n<blockquote>\n<p>注意：我通常不建议 <code class="language-text">u_useRampTexture</code> 在着色器中使用条件。相反，我建议制作 2 个着色器程序，一个使用普通光照，一个使用渐变纹理。不幸的是，由于代码没有使用类似于 out helper 库的东西，因此支持 2 个着色器程序将进行相当大的更改。每个程序都需要自己的一组位置。做出如此大的改变会分散本文的重点，因此在这种情况下，我决定使用条件。一般来说，虽然我尽量避免使用条件来选择着色器中的特征，而是为不同的特征创建不同的着色器。</p>\n</blockquote>\n<blockquote>\n<p>注意：这个数学只有在我们使用 LINEAR 过滤时才重要。如果我们使用 NEAREST 过滤，我们需要原始数学。</p>\n</blockquote>\n<p>现在我们知道渐变数学是正确的，让我们制作一堆不同的渐变纹理。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="59537431000749970000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 创建一个 256 数组，其中元素 0 到 127\n// 从 64 到 191 和元素 128 到 255\n// 都是 255\nconst smoothSolid = new Array(256).fill(255);\nfor (let i = 0; i < 128; ++i) {\n  smoothSolid[i] = 64 + i;\n}\n\nconst ramps = [\n  { name: \'dark-white\', color: [0.2, 1, 0.2, 1], format: gl.LUMINANCE, filter: false, data: [80, 255] },\n  {\n    name: \'dark-white-skewed\',\n    color: [0.2, 1, 0.2, 1],\n    format: gl.LUMINANCE,\n    filter: false,\n    data: [80, 80, 80, 255, 255]\n  },\n  { name: \'normal\', color: [0.2, 1, 0.2, 1], format: gl.LUMINANCE, filter: true, data: [0, 255] },\n  { name: \'3-step\', color: [0.2, 1, 0.2, 1], format: gl.LUMINANCE, filter: false, data: [80, 160, 255] },\n  { name: \'4-step\', color: [0.2, 1, 0.2, 1], format: gl.LUMINANCE, filter: false, data: [80, 140, 200, 255] },\n  {\n    name: \'4-step skewed\',\n    color: [0.2, 1, 0.2, 1],\n    format: gl.LUMINANCE,\n    filter: false,\n    data: [80, 80, 80, 80, 140, 200, 255]\n  },\n  { name: \'black-white-black\', color: [0.2, 1, 0.2, 1], format: gl.LUMINANCE, filter: false, data: [80, 255, 80] },\n  {\n    name: \'stripes\',\n    color: [0.2, 1, 0.2, 1],\n    format: gl.LUMINANCE,\n    filter: false,\n    data: [\n      80,\n      255,\n      80,\n      255,\n      80,\n      255,\n      80,\n      255,\n      80,\n      255,\n      80,\n      255,\n      80,\n      255,\n      80,\n      255,\n      80,\n      255,\n      80,\n      255,\n      80,\n      255,\n      80,\n      255,\n      80,\n      255,\n      80,\n      255,\n      80,\n      255,\n      80,\n      255\n    ]\n  },\n  {\n    name: \'stripe\',\n    color: [0.2, 1, 0.2, 1],\n    format: gl.LUMINANCE,\n    filter: false,\n    data: [\n      80,\n      80,\n      80,\n      80,\n      80,\n      80,\n      80,\n      80,\n      80,\n      80,\n      80,\n      80,\n      0,\n      0,\n      255,\n      255,\n      255,\n      255,\n      255,\n      255,\n      255,\n      255,\n      255,\n      255,\n      255,\n      255,\n      255,\n      255\n    ]\n  },\n  { name: \'smooth-solid\', color: [0.2, 1, 0.2, 1], format: gl.LUMINANCE, filter: false, data: smoothSolid },\n  { name: \'rgb\', color: [1, 1, 1, 1], format: gl.RGB, filter: true, data: [255, 0, 0, 0, 255, 0, 0, 0, 255] }\n];\n\nvar elementsForFormat = {};\nelementsForFormat[gl.LUMINANCE] = 1;\nelementsForFormat[gl.RGB] = 3;\n\nramps.forEach((ramp) => {\n  const { name, format, filter, data } = ramp;\n  var tex = gl.createTexture();\n  gl.bindTexture(gl.TEXTURE_2D, tex);\n  gl.pixelStorei(gl.UNPACK_ALIGNMENT, 1);\n  const width = data.length / elementsForFormat[format];\n  gl.texImage2D(\n    gl.TEXTURE_2D, // 目标\n    0, // mip 级别\n    format, // 内部格式\n    width,\n    1, // 高度\n    0, // 边界\n    format, // 格式\n    gl.UNSIGNED_BYTE, // 类型\n    new Uint8Array(data)\n  );\n  gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);\n  gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);\n  gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, filter ? gl.LINEAR : gl.NEAREST);\n  gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, filter ? gl.LINEAR : gl.NEAREST);\n  ramp.texture = tex;\n  ramp.size = [width, 1];\n});`, `59537431000749970000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 创建一个 256 数组，其中元素 0 到 127</span>\n<span class="token comment">// 从 64 到 191 和元素 128 到 255</span>\n<span class="token comment">// 都是 255</span>\n<span class="token keyword">const</span> smoothSolid <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">128</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  smoothSolid<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">64</span> <span class="token operator">+</span> i<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">const</span> ramps <span class="token operator">=</span> <span class="token punctuation">[</span>\n  <span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">\'dark-white\'</span><span class="token punctuation">,</span> color<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> format<span class="token punctuation">:</span> gl<span class="token punctuation">.</span><span class="token constant">LUMINANCE</span><span class="token punctuation">,</span> filter<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> data<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">80</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token punctuation">{</span>\n    name<span class="token punctuation">:</span> <span class="token string">\'dark-white-skewed\'</span><span class="token punctuation">,</span>\n    color<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n    format<span class="token punctuation">:</span> gl<span class="token punctuation">.</span><span class="token constant">LUMINANCE</span><span class="token punctuation">,</span>\n    filter<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n    data<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">80</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">]</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">\'normal\'</span><span class="token punctuation">,</span> color<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> format<span class="token punctuation">:</span> gl<span class="token punctuation">.</span><span class="token constant">LUMINANCE</span><span class="token punctuation">,</span> filter<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> data<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">\'3-step\'</span><span class="token punctuation">,</span> color<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> format<span class="token punctuation">:</span> gl<span class="token punctuation">.</span><span class="token constant">LUMINANCE</span><span class="token punctuation">,</span> filter<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> data<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">80</span><span class="token punctuation">,</span> <span class="token number">160</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">\'4-step\'</span><span class="token punctuation">,</span> color<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> format<span class="token punctuation">:</span> gl<span class="token punctuation">.</span><span class="token constant">LUMINANCE</span><span class="token punctuation">,</span> filter<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> data<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">80</span><span class="token punctuation">,</span> <span class="token number">140</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token punctuation">{</span>\n    name<span class="token punctuation">:</span> <span class="token string">\'4-step skewed\'</span><span class="token punctuation">,</span>\n    color<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n    format<span class="token punctuation">:</span> gl<span class="token punctuation">.</span><span class="token constant">LUMINANCE</span><span class="token punctuation">,</span>\n    filter<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n    data<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">80</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">,</span> <span class="token number">140</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">]</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">\'black-white-black\'</span><span class="token punctuation">,</span> color<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> format<span class="token punctuation">:</span> gl<span class="token punctuation">.</span><span class="token constant">LUMINANCE</span><span class="token punctuation">,</span> filter<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> data<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">80</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token punctuation">{</span>\n    name<span class="token punctuation">:</span> <span class="token string">\'stripes\'</span><span class="token punctuation">,</span>\n    color<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n    format<span class="token punctuation">:</span> gl<span class="token punctuation">.</span><span class="token constant">LUMINANCE</span><span class="token punctuation">,</span>\n    filter<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n    data<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n      <span class="token number">80</span><span class="token punctuation">,</span>\n      <span class="token number">255</span><span class="token punctuation">,</span>\n      <span class="token number">80</span><span class="token punctuation">,</span>\n      <span class="token number">255</span><span class="token punctuation">,</span>\n      <span class="token number">80</span><span class="token punctuation">,</span>\n      <span class="token number">255</span><span class="token punctuation">,</span>\n      <span class="token number">80</span><span class="token punctuation">,</span>\n      <span class="token number">255</span><span class="token punctuation">,</span>\n      <span class="token number">80</span><span class="token punctuation">,</span>\n      <span class="token number">255</span><span class="token punctuation">,</span>\n      <span class="token number">80</span><span class="token punctuation">,</span>\n      <span class="token number">255</span><span class="token punctuation">,</span>\n      <span class="token number">80</span><span class="token punctuation">,</span>\n      <span class="token number">255</span><span class="token punctuation">,</span>\n      <span class="token number">80</span><span class="token punctuation">,</span>\n      <span class="token number">255</span><span class="token punctuation">,</span>\n      <span class="token number">80</span><span class="token punctuation">,</span>\n      <span class="token number">255</span><span class="token punctuation">,</span>\n      <span class="token number">80</span><span class="token punctuation">,</span>\n      <span class="token number">255</span><span class="token punctuation">,</span>\n      <span class="token number">80</span><span class="token punctuation">,</span>\n      <span class="token number">255</span><span class="token punctuation">,</span>\n      <span class="token number">80</span><span class="token punctuation">,</span>\n      <span class="token number">255</span><span class="token punctuation">,</span>\n      <span class="token number">80</span><span class="token punctuation">,</span>\n      <span class="token number">255</span><span class="token punctuation">,</span>\n      <span class="token number">80</span><span class="token punctuation">,</span>\n      <span class="token number">255</span><span class="token punctuation">,</span>\n      <span class="token number">80</span><span class="token punctuation">,</span>\n      <span class="token number">255</span><span class="token punctuation">,</span>\n      <span class="token number">80</span><span class="token punctuation">,</span>\n      <span class="token number">255</span>\n    <span class="token punctuation">]</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token punctuation">{</span>\n    name<span class="token punctuation">:</span> <span class="token string">\'stripe\'</span><span class="token punctuation">,</span>\n    color<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n    format<span class="token punctuation">:</span> gl<span class="token punctuation">.</span><span class="token constant">LUMINANCE</span><span class="token punctuation">,</span>\n    filter<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n    data<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n      <span class="token number">80</span><span class="token punctuation">,</span>\n      <span class="token number">80</span><span class="token punctuation">,</span>\n      <span class="token number">80</span><span class="token punctuation">,</span>\n      <span class="token number">80</span><span class="token punctuation">,</span>\n      <span class="token number">80</span><span class="token punctuation">,</span>\n      <span class="token number">80</span><span class="token punctuation">,</span>\n      <span class="token number">80</span><span class="token punctuation">,</span>\n      <span class="token number">80</span><span class="token punctuation">,</span>\n      <span class="token number">80</span><span class="token punctuation">,</span>\n      <span class="token number">80</span><span class="token punctuation">,</span>\n      <span class="token number">80</span><span class="token punctuation">,</span>\n      <span class="token number">80</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">255</span><span class="token punctuation">,</span>\n      <span class="token number">255</span><span class="token punctuation">,</span>\n      <span class="token number">255</span><span class="token punctuation">,</span>\n      <span class="token number">255</span><span class="token punctuation">,</span>\n      <span class="token number">255</span><span class="token punctuation">,</span>\n      <span class="token number">255</span><span class="token punctuation">,</span>\n      <span class="token number">255</span><span class="token punctuation">,</span>\n      <span class="token number">255</span><span class="token punctuation">,</span>\n      <span class="token number">255</span><span class="token punctuation">,</span>\n      <span class="token number">255</span><span class="token punctuation">,</span>\n      <span class="token number">255</span><span class="token punctuation">,</span>\n      <span class="token number">255</span><span class="token punctuation">,</span>\n      <span class="token number">255</span><span class="token punctuation">,</span>\n      <span class="token number">255</span>\n    <span class="token punctuation">]</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">\'smooth-solid\'</span><span class="token punctuation">,</span> color<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> format<span class="token punctuation">:</span> gl<span class="token punctuation">.</span><span class="token constant">LUMINANCE</span><span class="token punctuation">,</span> filter<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> data<span class="token punctuation">:</span> smoothSolid <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">\'rgb\'</span><span class="token punctuation">,</span> color<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> format<span class="token punctuation">:</span> gl<span class="token punctuation">.</span><span class="token constant">RGB</span><span class="token punctuation">,</span> filter<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> data<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">]</span> <span class="token punctuation">}</span>\n<span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n<span class="token keyword">var</span> elementsForFormat <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\nelementsForFormat<span class="token punctuation">[</span>gl<span class="token punctuation">.</span><span class="token constant">LUMINANCE</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>\nelementsForFormat<span class="token punctuation">[</span>gl<span class="token punctuation">.</span><span class="token constant">RGB</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>\n\nramps<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">ramp</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> name<span class="token punctuation">,</span> format<span class="token punctuation">,</span> filter<span class="token punctuation">,</span> data <span class="token punctuation">}</span> <span class="token operator">=</span> ramp<span class="token punctuation">;</span>\n  <span class="token keyword">var</span> tex <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createTexture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> tex<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">pixelStorei</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">UNPACK_ALIGNMENT</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> width <span class="token operator">=</span> data<span class="token punctuation">.</span>length <span class="token operator">/</span> elementsForFormat<span class="token punctuation">[</span>format<span class="token punctuation">]</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">texImage2D</span><span class="token punctuation">(</span>\n    gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> <span class="token comment">// 目标</span>\n    <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// mip 级别</span>\n    format<span class="token punctuation">,</span> <span class="token comment">// 内部格式</span>\n    width<span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// 高度</span>\n    <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// 边界</span>\n    format<span class="token punctuation">,</span> <span class="token comment">// 格式</span>\n    gl<span class="token punctuation">.</span><span class="token constant">UNSIGNED_BYTE</span><span class="token punctuation">,</span> <span class="token comment">// 类型</span>\n    <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_WRAP_S</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">CLAMP_TO_EDGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_WRAP_T</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">CLAMP_TO_EDGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_MIN_FILTER</span><span class="token punctuation">,</span> filter <span class="token operator">?</span> gl<span class="token punctuation">.</span><span class="token constant">LINEAR</span> <span class="token punctuation">:</span> gl<span class="token punctuation">.</span><span class="token constant">NEAREST</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_MAG_FILTER</span><span class="token punctuation">,</span> filter <span class="token operator">?</span> gl<span class="token punctuation">.</span><span class="token constant">LINEAR</span> <span class="token punctuation">:</span> gl<span class="token punctuation">.</span><span class="token constant">NEAREST</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  ramp<span class="token punctuation">.</span>texture <span class="token operator">=</span> tex<span class="token punctuation">;</span>\n  ramp<span class="token punctuation">.</span>size <span class="token operator">=</span> <span class="token punctuation">[</span>width<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>让我们制作着色器，这样我们就可以同时处理 NEAREST 和 LINEAR。就像我上面提到的，我通常不在着色器中使用布尔 if 语句，但如果区别很简单并且我可以在没有条件的情况下做到这一点，那么我会考虑使用一个着色器。为此，我们可以添加一个 <code class="language-text">u_linearAdjust</code>，我们将其设置为 0.0 或 1.0</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="59537857743603230000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`precision mediump float;\n\n// 从顶点着色器传入\nvarying vec3 v_normal;\n\nuniform vec3 u_reverseLightDirection;\nuniform vec4 u_color;\nuniform sampler2D u_ramp;\nuniform vec2 u_rampSize;\n// uniform bool u_useRampTexture;\n// uniform float u_linearAdjust; // 如果是线性的，则为 1.0，如果是最近的，则为 0.0\n\nvoid main() {\n  // 因为 v_normal 是一个变量，所以它是插值的\n  // 所以它不会是单位向量，规范化它\n  // 将再次使其成为单位向量\n  vec3 normal = normalize(v_normal);\n\n  float cosAngle = dot(normal, u_reverseLightDirection);\n\n  // 从 -1 <-> 1 转换为 0 <-> 1\n  float u = cosAngle * 0.5 + 0.5;\n\n  // 制作纹理坐标\n  vec2 uv = vec2(u, 0.5);\n\n  // 缩放到渐变的大小\n  // vec2 texelRange = uv * (u_rampSize - 1.0);\n  vec2 texelRange = uv * (u_rampSize - u_linearAdjust);\n\n  // // 偏移半个纹理元并转换为纹理坐标\n  // vec2 rampUV = (texelRange + 0.5) / u_rampSize;\n  // 如果是线性的，则偏移半个纹理元并转换为纹理坐标\n  vec2 rampUV = (texelRange + 0.5 * u_linearAdjust) / u_rampSize;\n\n  vec4 rampColor = texture2D(u_ramp, rampUV);\n\n  // if (!u_useRampTexture) {\n  //   rampColor = vec4(u, u, u, 1);\n  // }\n\n  gl_FragColor = u_color;\n  gl_FragColor *= rampColor;\n}`, `59537857743603230000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl{10-11,28-29,31-34,38-40}"\n              >\n                <span class="gatsby-code-button-language">glsl{10-11,28-29,31-34,38-40}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">precision</span> <span class="token keyword">mediump</span> <span class="token keyword">float</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 从顶点着色器传入</span>\n<span class="token keyword">varying</span> <span class="token keyword">vec3</span> v_normal<span class="token punctuation">;</span>\n\n<span class="token keyword">uniform</span> <span class="token keyword">vec3</span> u_reverseLightDirection<span class="token punctuation">;</span>\n<span class="token keyword">uniform</span> <span class="token keyword">vec4</span> u_color<span class="token punctuation">;</span>\n<span class="token keyword">uniform</span> <span class="token keyword">sampler2D</span> u_ramp<span class="token punctuation">;</span>\n<span class="token keyword">uniform</span> <span class="token keyword">vec2</span> u_rampSize<span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line"><span class="token comment">// uniform bool u_useRampTexture;</span></span><span class="gatsby-highlight-code-line"><span class="token comment">// uniform float u_linearAdjust; // 如果是线性的，则为 1.0，如果是最近的，则为 0.0</span></span>\n<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 因为 v_normal 是一个变量，所以它是插值的</span>\n  <span class="token comment">// 所以它不会是单位向量，规范化它</span>\n  <span class="token comment">// 将再次使其成为单位向量</span>\n  <span class="token keyword">vec3</span> normal <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>v_normal<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">float</span> cosAngle <span class="token operator">=</span> <span class="token function">dot</span><span class="token punctuation">(</span>normal<span class="token punctuation">,</span> u_reverseLightDirection<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 从 -1 &lt;-> 1 转换为 0 &lt;-> 1</span>\n  <span class="token keyword">float</span> u <span class="token operator">=</span> cosAngle <span class="token operator">*</span> <span class="token number">0.5</span> <span class="token operator">+</span> <span class="token number">0.5</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 制作纹理坐标</span>\n  <span class="token keyword">vec2</span> uv <span class="token operator">=</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span>u<span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 缩放到渐变的大小</span>\n<span class="gatsby-highlight-code-line">  <span class="token comment">// vec2 texelRange = uv * (u_rampSize - 1.0);</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">vec2</span> texelRange <span class="token operator">=</span> uv <span class="token operator">*</span> <span class="token punctuation">(</span>u_rampSize <span class="token operator">-</span> u_linearAdjust<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="gatsby-highlight-code-line">  <span class="token comment">// // 偏移半个纹理元并转换为纹理坐标</span></span><span class="gatsby-highlight-code-line">  <span class="token comment">// vec2 rampUV = (texelRange + 0.5) / u_rampSize;</span></span><span class="gatsby-highlight-code-line">  <span class="token comment">// 如果是线性的，则偏移半个纹理元并转换为纹理坐标</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">vec2</span> rampUV <span class="token operator">=</span> <span class="token punctuation">(</span>texelRange <span class="token operator">+</span> <span class="token number">0.5</span> <span class="token operator">*</span> u_linearAdjust<span class="token punctuation">)</span> <span class="token operator">/</span> u_rampSize<span class="token punctuation">;</span></span>\n  <span class="token keyword">vec4</span> rampColor <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>u_ramp<span class="token punctuation">,</span> rampUV<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line">  <span class="token comment">// if (!u_useRampTexture) {</span></span><span class="gatsby-highlight-code-line">  <span class="token comment">//   rampColor = vec4(u, u, u, 1);</span></span><span class="gatsby-highlight-code-line">  <span class="token comment">// }</span></span>\n  gl_FragColor <span class="token operator">=</span> u_color<span class="token punctuation">;</span>\n  gl_FragColor <span class="token operator">*</span><span class="token operator">=</span> rampColor<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在初始化时查找位置</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="63037415176259740000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var colorLocation = gl.getUniformLocation(program, \'u_color\');\nvar rampLocation = gl.getUniformLocation(program, \'u_ramp\');\nvar rampSizeLocation = gl.getUniformLocation(program, \'u_rampSize\');\nvar linearAdjustLocation = gl.getUniformLocation(program, \'u_linearAdjust\');`, `63037415176259740000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{4}"\n              >\n                <span class="gatsby-code-button-language">js{4}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> colorLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_color\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> rampLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_ramp\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> rampSizeLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_rampSize\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">var</span> linearAdjustLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_linearAdjust\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>并在渲染时选择其中一个纹理</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="14812411560959960000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var data = {\n  ramp: 0\n};\n\n// ...\n\nconst { texture, color, size, filter } = ramps[data.ramp];\n\n// 设置要使用的颜色\n// gl.uniform4fv(colorLocation, [0.2, 1, 0.2, 1]);\ngl.uniform4fv(colorLocation, color);\n\n// 设置光照方向\ngl.uniform3fv(reverseLightDirectionLocation, m4.normalize([-1.75, 0.7, 1]));\n\n// 将纹理绑定到活动纹理单元 0\ngl.activeTexture(gl.TEXTURE0 + 0);\n// gl.bindTexture(gl.TEXTURE_2D, tex);\ngl.bindTexture(gl.TEXTURE_2D, texture);\n\n// 告诉着色器 u_ramp 应该使用纹理单元 0 上的纹理\ngl.uniform1i(rampLocation, 0);\n// gl.uniform2fv(rampSizeLocation, [2, 1]);\ngl.uniform2fv(rampSizeLocation, size);\n\n// 如果是线性调整\ngl.uniform1f(linearAdjustLocation, filter ? 1 : 0);`, `14812411560959960000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{7,10-11,18-19,23-24,26-27}"\n              >\n                <span class="gatsby-code-button-language">js{7,10-11,18-19,23-24,26-27}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> data <span class="token operator">=</span> <span class="token punctuation">{</span>\n  ramp<span class="token punctuation">:</span> <span class="token number">0</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token comment">// ...</span>\n\n<span class="gatsby-highlight-code-line"><span class="token keyword">const</span> <span class="token punctuation">{</span> texture<span class="token punctuation">,</span> color<span class="token punctuation">,</span> size<span class="token punctuation">,</span> filter <span class="token punctuation">}</span> <span class="token operator">=</span> ramps<span class="token punctuation">[</span>data<span class="token punctuation">.</span>ramp<span class="token punctuation">]</span><span class="token punctuation">;</span></span>\n<span class="token comment">// 设置要使用的颜色</span>\n<span class="gatsby-highlight-code-line"><span class="token comment">// gl.uniform4fv(colorLocation, [0.2, 1, 0.2, 1]);</span></span><span class="gatsby-highlight-code-line">gl<span class="token punctuation">.</span><span class="token function">uniform4fv</span><span class="token punctuation">(</span>colorLocation<span class="token punctuation">,</span> color<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="token comment">// 设置光照方向</span>\ngl<span class="token punctuation">.</span><span class="token function">uniform3fv</span><span class="token punctuation">(</span>reverseLightDirectionLocation<span class="token punctuation">,</span> m4<span class="token punctuation">.</span><span class="token function">normalize</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1.75</span><span class="token punctuation">,</span> <span class="token number">0.7</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 将纹理绑定到活动纹理单元 0</span>\ngl<span class="token punctuation">.</span><span class="token function">activeTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE0</span> <span class="token operator">+</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line"><span class="token comment">// gl.bindTexture(gl.TEXTURE_2D, tex);</span></span><span class="gatsby-highlight-code-line">gl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> texture<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="token comment">// 告诉着色器 u_ramp 应该使用纹理单元 0 上的纹理</span>\ngl<span class="token punctuation">.</span><span class="token function">uniform1i</span><span class="token punctuation">(</span>rampLocation<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line"><span class="token comment">// gl.uniform2fv(rampSizeLocation, [2, 1]);</span></span><span class="gatsby-highlight-code-line">gl<span class="token punctuation">.</span><span class="token function">uniform2fv</span><span class="token punctuation">(</span>rampSizeLocation<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="gatsby-highlight-code-line"><span class="token comment">// 如果是线性调整</span></span><span class="gatsby-highlight-code-line">gl<span class="token punctuation">.</span><span class="token function">uniform1f</span><span class="token punctuation">(</span>linearAdjustLocation<span class="token punctuation">,</span> filter <span class="token operator">?</span> <span class="token number">1</span> <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/zgif20?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>尝试不同的渐变纹理，你会看到很多奇怪的效果。这是制作通用调整着色器的一种方法。您可以通过设置 2 种颜色和像这样的阈值来制作进行 2 种颜色卡通着色的着色器。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="18073902033534095000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`uniform vec4 color1;\nuniform vec4 color2;\nuniform float threshold;\n\n// ...\n\nfloat cosAngle = dot(normal, u_reverseLightDirection);\n\n// 从 -1 <-> 1 转换为 0 <-> 1\nfloat u = cosAngle * 0.5 + 0.5;\n\ngl_FragColor = mix(color1, color2, step(cosAngle, threshold));`, `18073902033534095000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl"\n              >\n                <span class="gatsby-code-button-language">glsl</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">uniform</span> <span class="token keyword">vec4</span> color1<span class="token punctuation">;</span>\n<span class="token keyword">uniform</span> <span class="token keyword">vec4</span> color2<span class="token punctuation">;</span>\n<span class="token keyword">uniform</span> <span class="token keyword">float</span> threshold<span class="token punctuation">;</span>\n\n<span class="token comment">// ...</span>\n\n<span class="token keyword">float</span> cosAngle <span class="token operator">=</span> <span class="token function">dot</span><span class="token punctuation">(</span>normal<span class="token punctuation">,</span> u_reverseLightDirection<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 从 -1 &lt;-> 1 转换为 0 &lt;-> 1</span>\n<span class="token keyword">float</span> u <span class="token operator">=</span> cosAngle <span class="token operator">*</span> <span class="token number">0.5</span> <span class="token operator">+</span> <span class="token number">0.5</span><span class="token punctuation">;</span>\n\ngl_FragColor <span class="token operator">=</span> <span class="token function">mix</span><span class="token punctuation">(</span>color1<span class="token punctuation">,</span> color2<span class="token punctuation">,</span> <span class="token function">step</span><span class="token punctuation">(</span>cosAngle<span class="token punctuation">,</span> threshold<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>它会起作用。但是，如果您想要 3 步或 4 步版本，则需要编写另一个着色器。使用渐变纹理，您可以提供不同的纹理。此外，请注意上面，即使您想要一个 2 步色调着色器，您仍然可以通过在纹理中放置更多或更少的数据来调整步进发生的位置。例如纹理</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="53267282425367090000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`[dark, light]`, `53267282425367090000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">[dark, light]</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>为您提供 2 步纹理，其中它在面向或远离光线的中间分裂。但质地像</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="9524408130201522000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`[dark, dark, dark, light, light]`, `9524408130201522000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">[dark, dark, dark, light, light]</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>无需更改着色器即可将拆分移动到背对光和朝向光之间的 60% 标记。</p>\n<p>这个使用渐变纹理进行卡通着色或奇怪效果的具体示例可能对您有用也可能不那么有用，但更重要的结论只是使用一些值在纹理中查找数据的基本概念。使用这样的纹理不仅仅是为了转换光照计算。您可以使用渐变纹理进行后期处理，以实现与 Photoshop 中的渐变贴图相同的效果</p>\n<p>您还可以将渐变纹理用于基于 GPU 的动画。您将关键值存储在纹理中，并使用时间作为在纹理上移动的值。这种技术有很多用途。</p>',
excerpt:"WebGL 三维纹理 在 WebGL…",timeToRead:41,tableOfContents:'<ul>\n<li>\n<p><a href="/webgl-fundamental-textures/#webgl-%E4%B8%89%E7%BB%B4%E7%BA%B9%E7%90%86">WebGL 三维纹理</a></p>\n<ul>\n<li><a href="/webgl-fundamental-textures/#f">F</a></li>\n<li><a href="/webgl-fundamental-textures/#6-%E4%B8%AA%E9%9D%A2">6 个面</a></li>\n<li><a href="/webgl-fundamental-textures/#uvs-vs-%E7%BA%B9%E7%90%86%E5%9D%90%E6%A0%87">UVs vs. 纹理坐标</a></li>\n</ul>\n</li>\n<li><a href="/webgl-fundamental-textures/#webgl-%E6%95%B0%E6%8D%AE%E7%BA%B9%E7%90%86">WebGL 数据纹理</a></li>\n<li><a href="/webgl-fundamental-textures/#webgl-%E6%B8%B2%E6%9F%93%E5%88%B0%E7%BA%B9%E7%90%86">WebGL 渲染到纹理</a></li>\n<li><a href="/webgl-fundamental-textures/#webgl-%E4%BD%BF%E7%94%A8%E5%A4%9A%E4%B8%AA%E7%BA%B9%E7%90%86">WebGL 使用多个纹理</a></li>\n<li>\n<p><a href="/webgl-fundamental-textures/#webgl-%E7%BA%B9%E7%90%86%E6%98%A0%E5%B0%84%E7%9A%84%E9%80%8F%E8%A7%86%E7%BA%A0%E6%AD%A3">WebGL 纹理映射的透视纠正</a></p>\n<ul>\n<li><a href="/webgl-fundamental-textures/#%E7%9F%A9%E5%BD%A2">矩形</a></li>\n<li><a href="/webgl-fundamental-textures/#%E6%AD%A3%E6%96%B9%E4%BD%93">正方体</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/webgl-fundamental-textures/#webgl-%E5%B9%B3%E9%9D%A2%E7%9A%84%E5%92%8C%E9%80%8F%E8%A7%86%E7%9A%84%E6%8A%95%E5%BD%B1%E6%98%A0%E5%B0%84">WebGL 平面的和透视的投影映射</a></p>\n<ul>\n<li><a href="/webgl-fundamental-textures/#%E5%9C%A8%E6%9D%A1%E4%BB%B6%E8%AF%AD%E5%8F%A5%E5%86%85%E7%9A%84%E7%BA%B9%E7%90%86%E5%BC%95%E7%94%A8">在条件语句内的纹理引用</a></li>\n</ul>\n</li>\n<li><a href="/webgl-fundamental-textures/#webgl-%E6%B8%90%E5%8F%98%E7%BA%B9%E7%90%86">WebGL 渐变纹理</a></li>\n</ul>',wordCount:{words:1629},frontmatter:{date:"2022-07-27 14:35:19",path:"/webgl-fundamental-textures/",tags:"前端, 可视化, WebGL, 读书笔记",title:"WebGL 理论基础——纹理",draft:null,catalog_number:null}},nextPost:{html:'<h1 id="基本概念"><a href="#%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>基本概念</h1>\n<h2 id="镜像"><a href="#%E9%95%9C%E5%83%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>镜像</h2>\n<p>Docker 镜像是一个特殊的文件系统，除了提供容器运行时所需的程序、库、资源、配置等文件外，还包含了一些为运行时准备的一些配置参数（如匿名卷、环境变量、用户等）。镜像不包含任何动态数据，其内容在构建之后也不会被改变。</p>\n<h3 id="分层存储"><a href="#%E5%88%86%E5%B1%82%E5%AD%98%E5%82%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>分层存储</h3>\n<p>因为镜像包含操作系统完整的 root 文件系统，其体积往往是庞大的，因此在 Docker 设计时，就充分利用 Union FS 的技术，将其设计为分层存储的架构。所以严格来说，镜像并非是像一个 ISO 那样的打包文件，镜像只是一个虚拟的概念，其实际体现并非由一个文件组成，而是由一组文件系统组成，或者说，由多层文件系统联合组成。</p>\n<p>镜像构建时，会一层层构建，前一层是后一层的基础。每一层构建完就不会再发生改变，后一层上的任何改变只发生在自己这一层。比如，删除前一层文件的操作，实际不是真的删除前一层的文件，而是仅在当前层标记为该文件已删除。在最终容器运行的时候，虽然不会看到这个文件，但是实际上该文件会一直跟随镜像。因此，在构建镜像的时候，需要额外小心，每一层尽量只包含该层需要添加的东西，任何额外的东西应该在该层构建结束前清理掉。</p>\n<p>分层存储的特征还使得镜像的复用、定制变的更为容易。甚至可以用之前构建好的镜像作为基础层，然后进一步添加新的层，以定制自己所需的内容，构建新的镜像。</p>\n<h2 id="容器"><a href="#%E5%AE%B9%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>容器</h2>\n<p>镜像（Image）和容器（Container）的关系，就像是面向对象程序设计中的类和实例一样，镜像是静态的定义，容器是镜像运行时的实体。容器可以被创建、启动、停止、删除、暂停等。</p>\n<p>容器的实质是进程，但与直接在宿主执行的进程不同，容器进程运行于属于自己的独立的命名空间（opens new window）。因此容器可以拥有自己的 root 文件系统、自己的网络配置、自己的进程空间，甚至自己的用户 ID 空间。容器内的进程是运行在一个隔离的环境里，使用起来，就好像是在一个独立于宿主的系统下操作一样。这种特性使得容器封装的应用比直接在宿主运行更加安全。也因为这种隔离的特性，很多人初学 Docker 时常常会混淆容器和虚拟机。</p>\n<p>前面讲过镜像使用的是分层存储，容器也是如此。每一个容器运行时，是以镜像为基础层，在其上创建一个当前容器的存储层，我们可以称这个为容器运行时读写而准备的存储层为容器存储层。</p>\n<p>容器存储层的生存周期和容器一样，容器消亡时，容器存储层也随之消亡。因此，任何保存于容器存储层的信息都会随容器删除而丢失。</p>\n<p>按照 Docker 最佳实践的要求，容器不应该向其存储层内写入任何数据，容器存储层要保持无状态化。所有的文件写入操作，都应该使用数据卷（Volume）、或者绑定宿主目录，在这些位置的读写会跳过容器存储层，直接对宿主（或网络存储）发生读写，其性能和稳定性更高。</p>\n<p>数据卷的生存周期独立于容器，容器消亡，数据卷不会消亡。因此，使用数据卷后，容器删除或者重新运行之后，数据却不会丢失。</p>\n<h2 id="仓库"><a href="#%E4%BB%93%E5%BA%93" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>仓库</h2>\n<p>镜像构建完成后，可以很容易的在当前宿主机上运行，但是，如果需要在其它服务器上使用这个镜像，我们就需要一个集中的存储、分发镜像的服务，Docker Registry 就是这样的服务。</p>\n<p>一个 Docker Registry 中可以包含多个仓库（Repository）；每个仓库可以包含多个标签（Tag）；每个标签对应一个镜像。</p>\n<p>通常，一个仓库会包含同一个软件不同版本的镜像，而标签就常用于对应该软件的各个版本。我们可以通过 <code class="language-text">&lt;仓库名&gt;:&lt;标签&gt;</code> 的格式来指定具体是这个软件哪个版本的镜像。如果不给出标签，将以 latest 作为默认标签。</p>\n<p>以 Ubuntu 镜像为例，ubuntu 是仓库的名字，其内包含有不同的版本标签，如 16.04, 18.04。我们可以通过 ubuntu:16.04 或者 ubuntu:18.04 来具体指定所需哪个版本的镜像。如果忽略了标签，比如 ubuntu，那将视为 ubuntu:latest。</p>\n<p>仓库名经常以两段式路径形式出现，比如 jwilder/nginx-proxy，前者往往意味着 Docker Registry 多用户环境下的用户名，后者则往往是对应的软件名。但这并非绝对，取决于所使用的具体 Docker Registry 的软件或服务。</p>\n<h3 id="docker-registry-公开服务"><a href="#docker-registry-%E5%85%AC%E5%BC%80%E6%9C%8D%E5%8A%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Docker Registry 公开服务</h3>\n<p>Docker Registry 公开服务是开放给用户使用、允许用户管理镜像的 Registry 服务。一般这类公开服务允许用户免费上传、下载公开的镜像，并可能提供收费服务供用户管理私有镜像。</p>\n<p>最常使用的 Registry 公开服务是官方的 Docker Hub，这也是默认的 Registry，并拥有大量的高质量的官方镜像。除此以外，还有 Red Hat 的 Quay.io ；Google 的 Google Container Registry，Kubernetes 的镜像使用的就是这个服务；代码托管平台 GitHub 推出的 ghcr.io。</p>\n<p>由于某些原因，在国内访问这些服务可能会比较慢。国内的一些云服务商提供了针对 Docker Hub 的镜像服务（Registry Mirror），这些镜像服务被称为加速器。常见的有阿里云加速器、DaoCloud 加速器等。使用加速器会直接从国内的地址下载 Docker Hub 的镜像，比直接从 Docker Hub 下载速度会提高很多。</p>\n<p>国内也有一些云服务商提供类似于 Docker Hub 的公开服务。比如网易云镜像服务、DaoCloud 镜像市场、阿里云镜像库等。</p>\n<h3 id="私有-docker-registry"><a href="#%E7%A7%81%E6%9C%89-docker-registry" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>私有 Docker Registry</h3>\n<p>除了使用公开服务外，用户还可以在本地搭建私有 Docker Registry。Docker 官方提供了 Docker Registry 镜像，可以直接使用做为私有 Registry 服务。在私有仓库一节中，会有进一步的搭建私有 Registry 服务的讲解。</p>\n<p>开源的 Docker Registry 镜像只提供了 Docker Registry API 的服务端实现，足以支持 docker 命令，不影响使用。但不包含图形界面，以及镜像维护、用户管理、访问控制等高级功能。</p>\n<p>除了官方的 Docker Registry 外，还有第三方软件实现了 Docker Registry API，甚至提供了用户界面以及一些高级功能，比如 Harbor 和 Sonatype Nexus</p>\n<h1 id="使用镜像"><a href="#%E4%BD%BF%E7%94%A8%E9%95%9C%E5%83%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用镜像</h1>\n<p>Docker 运行容器前需要本地存在对应的镜像，如果本地不存在该镜像，Docker 会从镜像仓库下载该镜像。</p>\n<h2 id="获取镜像"><a href="#%E8%8E%B7%E5%8F%96%E9%95%9C%E5%83%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>获取镜像</h2>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="58526596173841840000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker pull [选项] [Docker Registry 地址[:端口号]/]仓库名[:标签]`, `58526596173841840000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker pull <span class="token punctuation">[</span>选项<span class="token punctuation">]</span> <span class="token punctuation">[</span>Docker Registry 地址<span class="token punctuation">[</span>:端口号<span class="token punctuation">]</span>/<span class="token punctuation">]</span>仓库名<span class="token punctuation">[</span>:标签<span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<ul>\n<li>Docker 镜像仓库地址：地址的格式一般是 <code class="language-text">&lt;域名/IP&gt;[:端口号]</code>。默认地址是 Docker Hub(docker.io)。</li>\n<li>仓库名：如之前所说，这里的仓库名是两段式名称，即 <code class="language-text">&lt;用户名&gt;/&lt;软件名&gt;</code>。对于 Docker Hub，如果不给出用户名，则默认为 library，也就是官方镜像。</li>\n</ul>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="627295381499970400"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker pull ubuntu:18.04\n18.04: Pulling from library/ubuntu\n92dc2a97ff99: Pull complete\nbe13a9d27eb8: Pull complete\nc8299583700a: Pull complete\nDigest: sha256:4bc3ae6596938cb0d9e5ac51a1152ec9dcac2a1c50829c74abd9c4361e321b26\nStatus: Downloaded newer image for ubuntu:18.04\ndocker.io/library/ubuntu:18.04 # 完整名称`, `627295381499970400`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker pull ubuntu:18.04\n<span class="token number">18.04</span>: Pulling from library/ubuntu\n92dc2a97ff99: Pull complete\nbe13a9d27eb8: Pull complete\nc8299583700a: Pull complete\nDigest: sha256:4bc3ae6596938cb0d9e5ac51a1152ec9dcac2a1c50829c74abd9c4361e321b26\nStatus: Downloaded newer image <span class="token keyword">for</span> ubuntu:18.04\ndocker.io/library/ubuntu:18.04 <span class="token comment"># 完整名称</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="运行"><a href="#%E8%BF%90%E8%A1%8C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>运行</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="1543049580420996600"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run -it --rm ubuntu:18.04 bash\n\nroot@e7009c6ce357:/# cat /etc/os-release\nNAME=&quot;Ubuntu&quot;\nVERSION=&quot;18.04.1 LTS (Bionic Beaver)&quot;\nID=ubuntu\nID_LIKE=debian\nPRETTY_NAME=&quot;Ubuntu 18.04.1 LTS&quot;\nVERSION_ID=&quot;18.04&quot;\nHOME_URL=&quot;https://www.ubuntu.com/&quot;\nSUPPORT_URL=&quot;https://help.ubuntu.com/&quot;\nBUG_REPORT_URL=&quot;https://bugs.launchpad.net/ubuntu/&quot;\nPRIVACY_POLICY_URL=&quot;https://www.ubuntu.com/legal/terms-and-policies/privacy-policy&quot;\nVERSION_CODENAME=bionic\nUBUNTU_CODENAME=bionic`, `1543049580420996600`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run -it --rm ubuntu:18.04 <span class="token function">bash</span>\n\nroot@e7009c6ce357:/<span class="token comment"># cat /etc/os-release</span>\n<span class="token assign-left variable">NAME</span><span class="token operator">=</span><span class="token string">"Ubuntu"</span>\n<span class="token assign-left variable">VERSION</span><span class="token operator">=</span><span class="token string">"18.04.1 LTS (Bionic Beaver)"</span>\n<span class="token assign-left variable">ID</span><span class="token operator">=</span>ubuntu\n<span class="token assign-left variable">ID_LIKE</span><span class="token operator">=</span>debian\n<span class="token assign-left variable">PRETTY_NAME</span><span class="token operator">=</span><span class="token string">"Ubuntu 18.04.1 LTS"</span>\n<span class="token assign-left variable">VERSION_ID</span><span class="token operator">=</span><span class="token string">"18.04"</span>\n<span class="token assign-left variable">HOME_URL</span><span class="token operator">=</span><span class="token string">"https://www.ubuntu.com/"</span>\n<span class="token assign-left variable">SUPPORT_URL</span><span class="token operator">=</span><span class="token string">"https://help.ubuntu.com/"</span>\n<span class="token assign-left variable">BUG_REPORT_URL</span><span class="token operator">=</span><span class="token string">"https://bugs.launchpad.net/ubuntu/"</span>\n<span class="token assign-left variable">PRIVACY_POLICY_URL</span><span class="token operator">=</span><span class="token string">"https://www.ubuntu.com/legal/terms-and-policies/privacy-policy"</span>\n<span class="token assign-left variable">VERSION_CODENAME</span><span class="token operator">=</span>bionic\n<span class="token assign-left variable">UBUNTU_CODENAME</span><span class="token operator">=</span>bionic</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>docker run 就是运行容器的命令，具体格式我们会在容器一节进行详细讲解，我们这里简要的说明一下上面用到的参数。</p>\n<ul>\n<li><code class="language-text">-it</code>：这是两个参数，一个是 <code class="language-text">-i</code> 交互式操作，一个是 <code class="language-text">-t</code> 终端。我们这里打算进入 bash 执行一些命令并查看返回结果，因此我们需要交互式终端。</li>\n<li><code class="language-text">--rm</code>：这个参数是说容器退出后随之将其删除。默认情况下，为了排障需求，退出的容器并不会立即删除，除非手动 docker rm。我们这里只是随便执行个命令，看看结果，不需要排障和保留结果，因此使用 —rm 可以避免浪费空间。</li>\n<li><code class="language-text">ubuntu:18.04</code>：这是指用 <code class="language-text">ubuntu:18.04</code> 镜像为基础来启动容器。</li>\n<li><code class="language-text">bash</code>：放在镜像名后的是命令，这里我们希望有个交互式 Shell，因此用的是 bash。进入容器后，我们可以在 Shell 下操作，执行任何所需的命令。这里，我们执行了 cat /etc/os-release，这是 Linux 常用的查看当前系统版本的命令，从返回的结果可以看到容器内是 <code class="language-text">Ubuntu 18.04.1 LTS</code> 系统。</li>\n</ul>\n<p>最后我们通过 exit 退出了这个容器。</p>\n<h2 id="列出镜像"><a href="#%E5%88%97%E5%87%BA%E9%95%9C%E5%83%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>列出镜像</h2>\n<p>列出已经下载下来的镜像，可以使用 docker image ls 命令。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="82283986349669200000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker image ls\nREPOSITORY           TAG                 IMAGE ID            CREATED             SIZE\nredis                latest              5f515359c7f8        5 days ago          183 MB\nnginx                latest              05a60462f8ba        5 days ago          181 MB\nmongo                3.2                 fe9198c04d62        5 days ago          342 MB\n<none>               <none>              00285df0df87        5 days ago          342 MB\nubuntu               18.04               329ed837d508        3 days ago          63.3MB\nubuntu               bionic              329ed837d508        3 days ago          63.3MB`, `82283986349669200000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker image <span class="token function">ls</span>\nREPOSITORY           TAG                 IMAGE ID            CREATED             SIZE\nredis                latest              5f515359c7f8        <span class="token number">5</span> days ago          <span class="token number">183</span> MB\nnginx                latest              05a60462f8ba        <span class="token number">5</span> days ago          <span class="token number">181</span> MB\nmongo                <span class="token number">3.2</span>                 fe9198c04d62        <span class="token number">5</span> days ago          <span class="token number">342</span> MB\n<span class="token operator">&lt;</span>none<span class="token operator">></span>               <span class="token operator">&lt;</span>none<span class="token operator">></span>              00285df0df87        <span class="token number">5</span> days ago          <span class="token number">342</span> MB\nubuntu               <span class="token number">18.04</span>               329ed837d508        <span class="token number">3</span> days ago          <span class="token number">63</span>.3MB\nubuntu               bionic              329ed837d508        <span class="token number">3</span> days ago          <span class="token number">63</span>.3MB</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="镜像体积"><a href="#%E9%95%9C%E5%83%8F%E4%BD%93%E7%A7%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>镜像体积</h3>\n<p>Docker Hub 中显示的体积是压缩后的体积，而 docker image ls 显示的是镜像下载到本地后展开的大小</p>\n<p>另外一个需要注意的问题是，docker image ls 列表中的镜像体积总和并非是所有镜像实际硬盘消耗。由于 Docker 镜像是多层存储结构，并且可以继承、复用，因此不同镜像可能会因为使用相同的基础镜像，从而拥有共同的层。由于 Docker 使用 Union FS，相同的层只需要保存一份即可，因此实际镜像硬盘占用空间很可能要比这个列表镜像大小的总和要小的多。</p>\n<p>你可以通过 docker system df 命令来便捷的查看镜像、容器、数据卷所占用的空间。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="73832372792560470000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker system df\n\nTYPE                TOTAL               ACTIVE              SIZE                RECLAIMABLE\nImages              24                  0                   1.992GB             1.992GB (100%)\nContainers          1                   0                   62.82MB             62.82MB (100%)\nLocal Volumes       9                   0                   652.2MB             652.2MB (100%)\nBuild Cache                                                 0B                  0B`, `73832372792560470000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker system <span class="token function">df</span>\n\nTYPE                TOTAL               ACTIVE              SIZE                RECLAIMABLE\nImages              <span class="token number">24</span>                  <span class="token number">0</span>                   <span class="token number">1</span>.992GB             <span class="token number">1</span>.992GB <span class="token punctuation">(</span><span class="token number">100</span>%<span class="token punctuation">)</span>\nContainers          <span class="token number">1</span>                   <span class="token number">0</span>                   <span class="token number">62</span>.82MB             <span class="token number">62</span>.82MB <span class="token punctuation">(</span><span class="token number">100</span>%<span class="token punctuation">)</span>\nLocal Volumes       <span class="token number">9</span>                   <span class="token number">0</span>                   <span class="token number">652</span>.2MB             <span class="token number">652</span>.2MB <span class="token punctuation">(</span><span class="token number">100</span>%<span class="token punctuation">)</span>\nBuild Cache                                                 0B                  0B</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="虚悬镜像"><a href="#%E8%99%9A%E6%82%AC%E9%95%9C%E5%83%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>虚悬镜像</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="3541140234900908000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<none>               <none>              00285df0df87        5 days ago          342 MB`, `3541140234900908000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token operator">&lt;</span>none<span class="token operator">></span>               <span class="token operator">&lt;</span>none<span class="token operator">></span>              00285df0df87        <span class="token number">5</span> days ago          <span class="token number">342</span> MB</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>这个镜像原本是有镜像名和标签的，原来为 <code class="language-text">mongo:3.2</code>，随着官方镜像维护，发布了新版本后，重新 <code class="language-text">docker pull mongo:3.2</code> 时，<code class="language-text">mongo:3.2</code> 这个镜像名被转移到了新下载的镜像身上，而旧的镜像上的这个名称则被取消，从而成为了 <code class="language-text">&lt;none&gt;</code>。除了 docker pull 可能导致这种情况，docker build 也同样可以导致这种现象。由于新旧镜像同名，旧镜像名称被取消，从而出现仓库名、标签均为 <code class="language-text">&lt;none&gt;</code> 的镜像。这类无标签镜像也被称为虚悬镜像 (dangling image) ，可以用下面的命令专门显示这类镜像：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="16601003555816196000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker image ls -f dangling=true\nREPOSITORY          TAG                 IMAGE ID            CREATED             SIZE\n<none>              <none>              00285df0df87        5 days ago          342 MB`, `16601003555816196000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker image <span class="token function">ls</span> -f <span class="token assign-left variable">dangling</span><span class="token operator">=</span>true\nREPOSITORY          TAG                 IMAGE ID            CREATED             SIZE\n<span class="token operator">&lt;</span>none<span class="token operator">></span>              <span class="token operator">&lt;</span>none<span class="token operator">></span>              00285df0df87        <span class="token number">5</span> days ago          <span class="token number">342</span> MB</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>一般来说，虚悬镜像已经失去了存在的价值，是可以随意删除的，可以用下面的命令删除。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="40250745660759860000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker image prune`, `40250745660759860000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker image prune</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h3 id="中间层镜像"><a href="#%E4%B8%AD%E9%97%B4%E5%B1%82%E9%95%9C%E5%83%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>中间层镜像</h3>\n<p>为了加速镜像构建、重复利用资源，Docker 会利用中间层镜像。所以在使用一段时间后，可能会看到一些依赖的中间层镜像。默认的 docker image ls 列表中只会显示顶层镜像，如果希望显示包括中间层镜像在内的所有镜像的话，需要加 -a 参数。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="63232187699617540000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker image ls -a`, `63232187699617540000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker image <span class="token function">ls</span> -a</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>这样会看到很多无标签的镜像，与之前的虚悬镜像不同，这些无标签的镜像很多都是中间层镜像，是其它镜像所依赖的镜像。这些无标签镜像不应该删除，否则会导致上层镜像因为依赖丢失而出错。实际上，这些镜像也没必要删除，因为之前说过，相同的层只会存一遍，而这些镜像是别的镜像的依赖，因此并不会因为它们被列出来而多存了一份，无论如何你也会需要它们。只要删除那些依赖它们的镜像后，这些依赖的中间层镜像也会被连带删除。</p>\n<h3 id="列出部分镜像"><a href="#%E5%88%97%E5%87%BA%E9%83%A8%E5%88%86%E9%95%9C%E5%83%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>列出部分镜像</h3>\n<p>不加任何参数的情况下，docker image ls 会列出所有顶层镜像，但是有时候我们只希望列出部分镜像。docker image ls 有好几个参数可以帮助做到这个事情。</p>\n<p>根据仓库名列出镜像</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="29211603649366434000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker image ls ubuntu\nREPOSITORY          TAG                 IMAGE ID            CREATED             SIZE\nubuntu              18.04               329ed837d508        3 days ago          63.3MB\nubuntu              bionic              329ed837d508        3 days ago          63.3MB`, `29211603649366434000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker image <span class="token function">ls</span> ubuntu\nREPOSITORY          TAG                 IMAGE ID            CREATED             SIZE\nubuntu              <span class="token number">18.04</span>               329ed837d508        <span class="token number">3</span> days ago          <span class="token number">63</span>.3MB\nubuntu              bionic              329ed837d508        <span class="token number">3</span> days ago          <span class="token number">63</span>.3MB</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>列出特定的某个镜像，也就是说指定仓库名和标签</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="22282693417338417000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker image ls ubuntu:18.04\nREPOSITORY          TAG                 IMAGE ID            CREATED             SIZE\nubuntu              18.04               329ed837d508        3 days ago          63.3MB`, `22282693417338417000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker image <span class="token function">ls</span> ubuntu:18.04\nREPOSITORY          TAG                 IMAGE ID            CREATED             SIZE\nubuntu              <span class="token number">18.04</span>               329ed837d508        <span class="token number">3</span> days ago          <span class="token number">63</span>.3MB</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>除此以外，docker image ls 还支持强大的过滤器参数 <code class="language-text">--filter</code>，或者简写 -f。之前我们已经看到了使用过滤器来列出虚悬镜像的用法，它还有更多的用法。比如，我们希望看到在 <code class="language-text">mongo:3.2</code> 之后建立的镜像，可以用下面的命令：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="66508671161728650000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker image ls -f since=mongo:3.2\nREPOSITORY          TAG                 IMAGE ID            CREATED             SIZE\nredis               latest              5f515359c7f8        5 days ago          183 MB\nnginx               latest              05a60462f8ba        5 days ago          181 MB`, `66508671161728650000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker image <span class="token function">ls</span> -f <span class="token assign-left variable">since</span><span class="token operator">=</span>mongo:3.2\nREPOSITORY          TAG                 IMAGE ID            CREATED             SIZE\nredis               latest              5f515359c7f8        <span class="token number">5</span> days ago          <span class="token number">183</span> MB\nnginx               latest              05a60462f8ba        <span class="token number">5</span> days ago          <span class="token number">181</span> MB</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>想查看某个位置之前的镜像也可以，只需要把 since 换成 before 即可。</p>\n<p>此外，如果镜像构建时，定义了 LABEL，还可以通过 LABEL 来过滤。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="45386124169145310000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker image ls -f label=com.example.version=0.1`, `45386124169145310000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker image <span class="token function">ls</span> -f <span class="token assign-left variable">label</span><span class="token operator">=</span>com.example.version<span class="token operator">=</span><span class="token number">0.1</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h3 id="以特定格式显示"><a href="#%E4%BB%A5%E7%89%B9%E5%AE%9A%E6%A0%BC%E5%BC%8F%E6%98%BE%E7%A4%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>以特定格式显示</h3>\n<p>默认情况下，docker image ls 会输出一个完整的表格，但是我们并非所有时候都会需要这些内容。比如，刚才删除虚悬镜像的时候，我们需要利用 docker image ls 把所有的虚悬镜像的 ID 列出来，然后才可以交给 docker image rm 命令作为参数来删除指定的这些镜像，这个时候就用到了 -q 参数。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="7073457895938517000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker image ls -q\n5f515359c7f8\n05a60462f8ba\nfe9198c04d62\n00285df0df87\n329ed837d508\n329ed837d508`, `7073457895938517000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker image <span class="token function">ls</span> -q\n5f515359c7f8\n05a60462f8ba\nfe9198c04d62\n00285df0df87\n329ed837d508\n329ed837d508</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>—filter 配合 -q 产生出指定范围的 ID 列表，然后送给另一个 docker 命令作为参数，从而针对这组实体成批的进行某种操作的做法在 Docker 命令行使用过程中非常常见，不仅仅是镜像，将来我们会在各个命令中看到这类搭配以完成很强大的功能。因此每次在文档看到过滤器后，可以多注意一下它们的用法。</p>\n<p>另外一些时候，我们可能只是对表格的结构不满意，希望自己组织列；或者不希望有标题，这样方便其它程序解析结果等，这就用到了 Go 的模板语法。</p>\n<p>比如，下面的命令会直接列出镜像结果，并且只包含镜像 ID 和仓库名：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="78268685990981340000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker image ls --format &quot;{{.ID}}: {{.Repository}}&quot;\n5f515359c7f8: redis\n05a60462f8ba: nginx\nfe9198c04d62: mongo\n00285df0df87: <none>\n329ed837d508: ubuntu\n329ed837d508: ubuntu`, `78268685990981340000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker image <span class="token function">ls</span> --format <span class="token string">"{{.ID}}: {{.Repository}}"</span>\n5f515359c7f8: redis\n05a60462f8ba: nginx\nfe9198c04d62: mongo\n00285df0df87: <span class="token operator">&lt;</span>none<span class="token operator">></span>\n329ed837d508: ubuntu\n329ed837d508: ubuntu</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>或者打算以表格等距显示，并且有标题行，和默认一样，不过自己定义列：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="69891440830338650000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker image ls --format &quot;table {{.ID}}\\t{{.Repository}}\\t{{.Tag}}&quot;\nIMAGE ID            REPOSITORY          TAG\n5f515359c7f8        redis               latest\n05a60462f8ba        nginx               latest\nfe9198c04d62        mongo               3.2\n00285df0df87        <none>              <none>\n329ed837d508        ubuntu              18.04\n329ed837d508        ubuntu              bionic`, `69891440830338650000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker image <span class="token function">ls</span> --format <span class="token string">"table {{.ID}}<span class="token entity" title="\\t">\\t</span>{{.Repository}}<span class="token entity" title="\\t">\\t</span>{{.Tag}}"</span>\nIMAGE ID            REPOSITORY          TAG\n5f515359c7f8        redis               latest\n05a60462f8ba        nginx               latest\nfe9198c04d62        mongo               <span class="token number">3.2</span>\n00285df0df87        <span class="token operator">&lt;</span>none<span class="token operator">></span>              <span class="token operator">&lt;</span>none<span class="token operator">></span>\n329ed837d508        ubuntu              <span class="token number">18.04</span>\n329ed837d508        ubuntu              bionic</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="删除本地镜像"><a href="#%E5%88%A0%E9%99%A4%E6%9C%AC%E5%9C%B0%E9%95%9C%E5%83%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>删除本地镜像</h2>\n<p>如果要删除本地的镜像，可以使用 docker image rm 命令，其格式为：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="42765293718002300000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker image rm [选项] <镜像1> [<镜像2> ...]`, `42765293718002300000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker image <span class="token function">rm</span> <span class="token punctuation">[</span>选项<span class="token punctuation">]</span> <span class="token operator">&lt;</span>镜像<span class="token operator"><span class="token file-descriptor important">1</span>></span> <span class="token punctuation">[</span><span class="token operator">&lt;</span>镜像<span class="token operator"><span class="token file-descriptor important">2</span>></span> <span class="token punctuation">..</span>.<span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h3 id="用-id、镜像名、摘要删除镜像"><a href="#%E7%94%A8-id%E3%80%81%E9%95%9C%E5%83%8F%E5%90%8D%E3%80%81%E6%91%98%E8%A6%81%E5%88%A0%E9%99%A4%E9%95%9C%E5%83%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>用 ID、镜像名、摘要删除镜像</h3>\n<p>其中，&#x3C;镜像> 可以是 镜像短 ID、镜像长 ID、镜像名或者镜像摘要。</p>\n<p>比如我们有这么一些镜像：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="46523836424731370000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker image ls\nREPOSITORY                  TAG                 IMAGE ID            CREATED             SIZE\ncentos                      latest              0584b3d2cf6d        3 weeks ago         196.5 MB\nredis                       alpine              501ad78535f0        3 weeks ago         21.03 MB\ndocker                      latest              cf693ec9b5c7        3 weeks ago         105.1 MB\nnginx                       latest              e43d811ce2f4        5 weeks ago         181.5 MB`, `46523836424731370000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker image <span class="token function">ls</span>\nREPOSITORY                  TAG                 IMAGE ID            CREATED             SIZE\ncentos                      latest              0584b3d2cf6d        <span class="token number">3</span> weeks ago         <span class="token number">196.5</span> MB\nredis                       alpine              501ad78535f0        <span class="token number">3</span> weeks ago         <span class="token number">21.03</span> MB\ndocker                      latest              cf693ec9b5c7        <span class="token number">3</span> weeks ago         <span class="token number">105.1</span> MB\nnginx                       latest              e43d811ce2f4        <span class="token number">5</span> weeks ago         <span class="token number">181.5</span> MB</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="38365110377397670000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker image rm 501\n\\$ docker image rm centos`, `38365110377397670000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker image <span class="token function">rm</span> <span class="token number">501</span>\n$ docker image <span class="token function">rm</span> centos</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>当然，更精确的是使用镜像摘要删除镜像。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="19583290732333847000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker image ls --digests\nREPOSITORY                  TAG                 DIGEST                                                                    IMAGE ID            CREATED             SIZE\nnode                        slim                sha256:b4f0e0bdeb578043c1ea6862f0d40cc4afe32a4a582f3be235a3b164422be228   6e0c4c8e3913        3 weeks ago         214 MB\n\n\\$ docker image rm node@sha256:b4f0e0bdeb578043c1ea6862f0d40cc4afe32a4a582f3be235a3b164422be228\nUntagged: node@sha256:b4f0e0bdeb578043c1ea6862f0d40cc4afe32a4a582f3be235a3b164422be228`, `19583290732333847000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker image <span class="token function">ls</span> --digests\nREPOSITORY                  TAG                 DIGEST                                                                    IMAGE ID            CREATED             SIZE\nnode                        slim                sha256:b4f0e0bdeb578043c1ea6862f0d40cc4afe32a4a582f3be235a3b164422be228   6e0c4c8e3913        <span class="token number">3</span> weeks ago         <span class="token number">214</span> MB\n\n$ docker image <span class="token function">rm</span> node@sha256:b4f0e0bdeb578043c1ea6862f0d40cc4afe32a4a582f3be235a3b164422be228\nUntagged: node@sha256:b4f0e0bdeb578043c1ea6862f0d40cc4afe32a4a582f3be235a3b164422be228</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="untagged-和-deleted"><a href="#untagged-%E5%92%8C-deleted" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Untagged 和 Deleted</h3>\n<p>删除行为分为两类，一类是 Untagged，另一类是 Deleted。我们之前介绍过，镜像的唯一标识是其 ID 和摘要，而一个镜像可以有多个标签。</p>\n<p>因此当我们使用上面命令删除镜像的时候，实际上是在要求删除某个标签的镜像。所以首先需要做的是将满足我们要求的所有镜像标签都取消，这就是我们看到的 Untagged 的信息。因为一个镜像可以对应多个标签，因此当我们删除了所指定的标签后，可能还有别的标签指向了这个镜像，如果是这种情况，那么 Delete 行为就不会发生。所以并非所有的 docker image rm 都会产生删除镜像的行为，有可能仅仅是取消了某个标签而已。</p>\n<p>当该镜像所有的标签都被取消了，该镜像很可能会失去了存在的意义，因此会触发删除行为。镜像是多层存储结构，因此在删除的时候也是从上层向基础层方向依次进行判断删除。镜像的多层结构让镜像复用变得非常容易，因此很有可能某个其它镜像正依赖于当前镜像的某一层。这种情况，依旧不会触发删除该层的行为。直到没有任何层依赖当前层时，才会真实的删除当前层。这就是为什么，有时候会奇怪，为什么明明没有别的标签指向这个镜像，但是它还是存在的原因，也是为什么有时候会发现所删除的层数和自己 docker pull 看到的层数不一样的原因。</p>\n<p>除了镜像依赖以外，还需要注意的是容器对镜像的依赖。如果有用这个镜像启动的容器存在（即使容器没有运行），那么同样不可以删除这个镜像。之前讲过，容器是以镜像为基础，再加一层容器存储层，组成这样的多层存储结构去运行的。因此该镜像如果被这个容器所依赖的，那么删除必然会导致故障。如果这些容器是不需要的，应该先将它们删除，然后再来删除镜像。</p>\n<h3 id="用-docker-image-ls-命令来配合"><a href="#%E7%94%A8-docker-image-ls-%E5%91%BD%E4%BB%A4%E6%9D%A5%E9%85%8D%E5%90%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>用 docker image ls 命令来配合</h3>\n<p>像其它可以承接多个实体的命令一样，可以使用 docker image ls -q 来配合使用 docker image rm，这样可以成批的删除希望删除的镜像。我们在“镜像列表”章节介绍过很多过滤镜像列表的方式都可以拿过来使用。</p>\n<p>比如，我们需要删除所有仓库名为 redis 的镜像：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="63383040813670924000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker image rm \\$(docker image ls -q redis)`, `63383040813670924000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker image <span class="token function">rm</span> <span class="token variable"><span class="token variable">$(</span>docker image <span class="token function">ls</span> -q redis<span class="token variable">)</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>或者删除所有在 <code class="language-text">mongo:3.2</code> 之前的镜像：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="91250712089964430000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker image rm \\$(docker image ls -q -f before=mongo:3.2)`, `91250712089964430000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker image <span class="token function">rm</span> <span class="token variable"><span class="token variable">$(</span>docker image <span class="token function">ls</span> -q -f <span class="token assign-left variable">before</span><span class="token operator">=</span>mongo:3.2<span class="token variable">)</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>充分利用你的想象力和 Linux 命令行的强大，你可以完成很多非常赞的功能。</p>\n<h2 id="利用-commit-理解镜像构成"><a href="#%E5%88%A9%E7%94%A8-commit-%E7%90%86%E8%A7%A3%E9%95%9C%E5%83%8F%E6%9E%84%E6%88%90" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>利用 commit 理解镜像构成</h2>\n<p>让我们以定制一个 Web 服务器为例子，来讲解镜像是如何构建的。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="35798975176042623000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run --name webserver -d -p 80:80 nginx`, `35798975176042623000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run --name webserver -d -p <span class="token number">80</span>:80 nginx</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>这条命令会用 nginx 镜像启动一个容器，命名为 webserver，并且映射了 80 端口，这样我们可以用浏览器去访问这个 nginx 服务器。</p>\n<p>如果是在本机运行的 Docker，那么可以直接访问：<code class="language-text">http://localhost</code> ，如果是在虚拟机、云服务器上安装的 Docker，则需要将 localhost 换为虚拟机地址或者实际云服务器地址。</p>\n<p>直接用浏览器访问的话，我们会看到默认的 Nginx 欢迎页面。</p>\n<p>现在，假设我们非常不喜欢这个欢迎页面，我们希望改成欢迎 Docker 的文字，我们可以使用 docker exec 命令进入容器，修改其内容。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="87116068127505510000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker exec -it webserver bash\nroot@3729b97e8226:/# echo \'<h1>Hello, Docker!</h1>\' > /usr/share/nginx/html/index.html\nroot@3729b97e8226:/# exit\nexit`, `87116068127505510000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker <span class="token builtin class-name">exec</span> -it webserver <span class="token function">bash</span>\nroot@3729b97e8226:/<span class="token comment"># echo \'&lt;h1>Hello, Docker!&lt;/h1>\' > /usr/share/nginx/html/index.html</span>\nroot@3729b97e8226:/<span class="token comment"># exit</span>\n<span class="token builtin class-name">exit</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们以交互式终端方式进入 webserver 容器，并执行了 bash 命令，也就是获得一个可操作的 Shell。</p>\n<p>然后，我们用 <code class="language-text">&lt;h1&gt;Hello, Docker!&lt;/h1&gt;</code> 覆盖了 <code class="language-text">/usr/share/nginx/html/index.html</code> 的内容。</p>\n<p>现在我们再刷新浏览器的话，会发现内容被改变了。</p>\n<p>我们修改了容器的文件，也就是改动了容器的存储层。我们可以通过 docker diff 命令看到具体的改动。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="44053090427663230000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker diff webserver\nC /root\nA /root/.bash_history\nC /run\nC /usr\nC /usr/share\nC /usr/share/nginx\nC /usr/share/nginx/html\nC /usr/share/nginx/html/index.html\nC /var\nC /var/cache\nC /var/cache/nginx\nA /var/cache/nginx/client_temp\nA /var/cache/nginx/fastcgi_temp\nA /var/cache/nginx/proxy_temp\nA /var/cache/nginx/scgi_temp\nA /var/cache/nginx/uwsgi_temp`, `44053090427663230000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker <span class="token function">diff</span> webserver\nC /root\nA /root/.bash_history\nC /run\nC /usr\nC /usr/share\nC /usr/share/nginx\nC /usr/share/nginx/html\nC /usr/share/nginx/html/index.html\nC /var\nC /var/cache\nC /var/cache/nginx\nA /var/cache/nginx/client_temp\nA /var/cache/nginx/fastcgi_temp\nA /var/cache/nginx/proxy_temp\nA /var/cache/nginx/scgi_temp\nA /var/cache/nginx/uwsgi_temp</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在我们定制好了变化，我们希望能将其保存下来形成镜像。</p>\n<p>要知道，当我们运行一个容器的时候（如果不使用卷的话），我们做的任何文件修改都会被记录于容器存储层里。而 Docker 提供了一个 docker commit 命令，可以将容器的存储层保存下来成为镜像。换句话说，就是在原有镜像的基础上，再叠加上容器的存储层，并构成新的镜像。以后我们运行这个新镜像的时候，就会拥有原有容器最后的文件变化。</p>\n<p>docker commit 的语法格式为：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="14976351862325287000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`docker commit [选项] <容器ID或容器名> [<仓库名>[:<标签>]]`, `14976351862325287000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">docker commit <span class="token punctuation">[</span>选项<span class="token punctuation">]</span> <span class="token operator">&lt;</span>容器ID或容器名<span class="token operator">></span> <span class="token punctuation">[</span><span class="token operator">&lt;</span>仓库名<span class="token operator">></span><span class="token punctuation">[</span>:<span class="token operator">&lt;</span>标签<span class="token operator">></span><span class="token punctuation">]</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>我们可以用下面的命令将容器保存为镜像：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="55554009633428850000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker commit \\\n    --author &quot;Tao Wang <twang2218@gmail.com>&quot; \\\n    --message &quot;修改了默认网页&quot; \\\n    webserver \\\n    nginx:v2\nsha256:07e33465974800ce65751acc279adc6ed2dc5ed4e0838f8b86f0c87aa1795214`, `55554009633428850000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker commit <span class="token punctuation">\\</span>\n    --author <span class="token string">"Tao Wang &lt;twang2218@gmail.com>"</span> <span class="token punctuation">\\</span>\n    --message <span class="token string">"修改了默认网页"</span> <span class="token punctuation">\\</span>\n    webserver <span class="token punctuation">\\</span>\n    nginx:v2\nsha256:07e33465974800ce65751acc279adc6ed2dc5ed4e0838f8b86f0c87aa1795214</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>其中 —author 是指定修改的作者，而 —message 则是记录本次修改的内容。这点和 git 版本控制相似，不过这里这些信息可以省略留空。</p>\n<p>我们可以在 docker image ls 中看到这个新定制的镜像：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="34779023646952380000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker image ls nginx\nREPOSITORY          TAG                 IMAGE ID            CREATED             SIZE\nnginx               v2                  07e334659748        9 seconds ago       181.5 MB\nnginx               1.11                05a60462f8ba        12 days ago         181.5 MB\nnginx               latest              e43d811ce2f4        4 weeks ago         181.5 MB`, `34779023646952380000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker image <span class="token function">ls</span> nginx\nREPOSITORY          TAG                 IMAGE ID            CREATED             SIZE\nnginx               v2                  07e334659748        <span class="token number">9</span> seconds ago       <span class="token number">181.5</span> MB\nnginx               <span class="token number">1.11</span>                05a60462f8ba        <span class="token number">12</span> days ago         <span class="token number">181.5</span> MB\nnginx               latest              e43d811ce2f4        <span class="token number">4</span> weeks ago         <span class="token number">181.5</span> MB</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们还可以用 docker history 具体查看镜像内的历史记录，如果比较 <code class="language-text">nginx:latest</code> 的历史记录，我们会发现新增了我们刚刚提交的这一层。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="52210691408225490000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker history nginx:v2\nIMAGE               CREATED             CREATED BY                                      SIZE                COMMENT\n07e334659748        54 seconds ago      nginx -g daemon off;                            95 B                修改了默认网页\ne43d811ce2f4        4 weeks ago         /bin/sh -c #(nop)  CMD [&quot;nginx&quot; &quot;-g&quot; &quot;daemon    0 B\n<missing>           4 weeks ago         /bin/sh -c #(nop)  EXPOSE 443/tcp 80/tcp        0 B\n<missing>           4 weeks ago         /bin/sh -c ln -sf /dev/stdout /var/log/nginx/   22 B\n<missing>           4 weeks ago         /bin/sh -c apt-key adv --keyserver hkp://pgp.   58.46 MB\n<missing>           4 weeks ago         /bin/sh -c #(nop)  ENV NGINX_VERSION=1.11.5-1   0 B\n<missing>           4 weeks ago         /bin/sh -c #(nop)  MAINTAINER NGINX Docker Ma   0 B\n<missing>           4 weeks ago         /bin/sh -c #(nop)  CMD [&quot;/bin/bash&quot;]            0 B\n<missing>           4 weeks ago         /bin/sh -c #(nop) ADD file:23aa4f893e3288698c   123 MB`, `52210691408225490000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker <span class="token function">history</span> nginx:v2\nIMAGE               CREATED             CREATED BY                                      SIZE                COMMENT\n07e334659748        <span class="token number">54</span> seconds ago      nginx -g daemon off<span class="token punctuation">;</span>                            <span class="token number">95</span> B                修改了默认网页\ne43d811ce2f4        <span class="token number">4</span> weeks ago         /bin/sh -c <span class="token comment">#(nop)  CMD ["nginx" "-g" "daemon    0 B</span>\n<span class="token operator">&lt;</span>missing<span class="token operator">></span>           <span class="token number">4</span> weeks ago         /bin/sh -c <span class="token comment">#(nop)  EXPOSE 443/tcp 80/tcp        0 B</span>\n<span class="token operator">&lt;</span>missing<span class="token operator">></span>           <span class="token number">4</span> weeks ago         /bin/sh -c <span class="token function">ln</span> -sf /dev/stdout /var/log/nginx/   <span class="token number">22</span> B\n<span class="token operator">&lt;</span>missing<span class="token operator">></span>           <span class="token number">4</span> weeks ago         /bin/sh -c apt-key adv --keyserver hkp://pgp.   <span class="token number">58.46</span> MB\n<span class="token operator">&lt;</span>missing<span class="token operator">></span>           <span class="token number">4</span> weeks ago         /bin/sh -c <span class="token comment">#(nop)  ENV NGINX_VERSION=1.11.5-1   0 B</span>\n<span class="token operator">&lt;</span>missing<span class="token operator">></span>           <span class="token number">4</span> weeks ago         /bin/sh -c <span class="token comment">#(nop)  MAINTAINER NGINX Docker Ma   0 B</span>\n<span class="token operator">&lt;</span>missing<span class="token operator">></span>           <span class="token number">4</span> weeks ago         /bin/sh -c <span class="token comment">#(nop)  CMD ["/bin/bash"]            0 B</span>\n<span class="token operator">&lt;</span>missing<span class="token operator">></span>           <span class="token number">4</span> weeks ago         /bin/sh -c <span class="token comment">#(nop) ADD file:23aa4f893e3288698c   123 MB</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>新的镜像定制好后，我们可以来运行这个镜像。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="90447702963374670000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`docker run --name web2 -d -p 81:80 nginx:v2`, `90447702963374670000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">docker run --name web2 -d -p <span class="token number">81</span>:80 nginx:v2</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>这里我们命名为新的服务为 web2，并且映射到 81 端口。访问 <code class="language-text">http://localhost:81</code> 看到结果，其内容应该和之前修改后的 webserver 一样。</p>\n<p>至此，我们第一次完成了定制镜像，使用的是 docker commit 命令，手动操作给旧的镜像添加了新的一层，形成新的镜像，对镜像多层存储应该有了更直观的感觉。</p>\n<h3 id="慎用-docker-commit"><a href="#%E6%85%8E%E7%94%A8-docker-commit" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>慎用 docker commit</h3>\n<p>使用 docker commit 命令虽然可以比较直观的帮助理解镜像分层存储的概念，但是实际环境中并不会这样使用。</p>\n<p>首先，如果仔细观察之前的 docker diff webserver 的结果，你会发现除了真正想要修改的 /usr/share/nginx/html/index.html 文件外，由于命令的执行，还有很多文件被改动或添加了。这还仅仅是最简单的操作，如果是安装软件包、编译构建，那会有大量的无关内容被添加进来，将会导致镜像极为臃肿。</p>\n<p>此外，使用 docker commit 意味着所有对镜像的操作都是黑箱操作，生成的镜像也被称为黑箱镜像，换句话说，就是除了制作镜像的人知道执行过什么命令、怎么生成的镜像，别人根本无从得知。而且，即使是这个制作镜像的人，过一段时间后也无法记清具体的操作。这种黑箱镜像的维护工作是非常痛苦的。</p>\n<p>而且，回顾之前提及的镜像所使用的分层存储的概念，除当前层外，之前的每一层都是不会发生改变的，换句话说，任何修改的结果仅仅是在当前层进行标记、添加、修改，而不会改动上一层。如果使用 docker commit 制作镜像，以及后期修改的话，每一次修改都会让镜像更加臃肿一次，所删除的上一层的东西并不会丢失，会一直如影随形的跟着这个镜像，即使根本无法访问到。这会让镜像更加臃肿。</p>\n<h2 id="使用-dockerfile-定制镜像"><a href="#%E4%BD%BF%E7%94%A8-dockerfile-%E5%AE%9A%E5%88%B6%E9%95%9C%E5%83%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用 Dockerfile 定制镜像</h2>\n<p>从刚才的 docker commit 的学习中，我们可以了解到，镜像的定制实际上就是定制每一层所添加的配置、文件。如果我们可以把每一层修改、安装、构建、操作的命令都写入一个脚本，用这个脚本来构建、定制镜像，那么之前提及的无法重复的问题、镜像构建透明性的问题、体积的问题就都会解决。这个脚本就是 Dockerfile。</p>\n<p>Dockerfile 是一个文本文件，其内包含了一条条的指令(Instruction)，每一条指令构建一层，因此每一条指令的内容，就是描述该层应当如何构建。</p>\n<p>还以之前定制 nginx 镜像为例，这次我们使用 Dockerfile 来定制。</p>\n<p>在一个空白目录中，建立一个文本文件，并命名为 Dockerfile：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="571246671045266800"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ mkdir mynginx\n\\$ cd mynginx\n\\$ touch Dockerfile`, `571246671045266800`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ <span class="token function">mkdir</span> mynginx\n$ <span class="token builtin class-name">cd</span> mynginx\n$ <span class="token function">touch</span> Dockerfile</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>其内容为：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="31831285885655093000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`FROM nginx\nRUN echo \'<h1>Hello, Docker!</h1>\' > /usr/share/nginx/html/index.html`, `31831285885655093000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">FROM nginx\nRUN <span class="token builtin class-name">echo</span> <span class="token string">\'&lt;h1>Hello, Docker!&lt;/h1>\'</span> <span class="token operator">></span> /usr/share/nginx/html/index.html</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>这个 Dockerfile 很简单，一共就两行。涉及到了两条指令，FROM 和 RUN。</p>\n<h3 id="from-指定基础镜像"><a href="#from-%E6%8C%87%E5%AE%9A%E5%9F%BA%E7%A1%80%E9%95%9C%E5%83%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>FROM 指定基础镜像</h3>\n<p>所谓定制镜像，那一定是以一个镜像为基础，在其上进行定制。就像我们之前运行了一个 nginx 镜像的容器，再进行修改一样，基础镜像是必须指定的。而 FROM 就是指定基础镜像，因此一个 Dockerfile 中 FROM 是必备的指令，并且必须是第一条指令。</p>\n<p>在 Docker Hub 上有非常多的高质量的官方镜像，有可以直接拿来使用的服务类的镜像，如 nginx、redis、mongo、mysql、httpd、php、tomcat 等；也有一些方便开发、构建、运行各种语言应用的镜像，如 node、openjdk、python、ruby、golang 等。可以在其中寻找一个最符合我们最终目标的镜像为基础镜像进行定制。</p>\n<p>如果没有找到对应服务的镜像，官方镜像中还提供了一些更为基础的操作系统镜像，如 ubuntu、debian、centos、fedora、alpine 等，这些操作系统的软件库为我们提供了更广阔的扩展空间。</p>\n<p>除了选择现有镜像为基础镜像外，Docker 还存在一个特殊的镜像，名为 scratch。这个镜像是虚拟的概念，并不实际存在，它表示一个空白的镜像。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="81592589671263080000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`FROM scratch\n...`, `81592589671263080000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">FROM scratch\n<span class="token punctuation">..</span>.</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>如果你以 scratch 为基础镜像的话，意味着你不以任何镜像为基础，接下来所写的指令将作为镜像第一层开始存在。</p>\n<p>不以任何系统为基础，直接将可执行文件复制进镜像的做法并不罕见，对于 Linux 下静态编译的程序来说，并不需要有操作系统提供运行时支持，所需的一切库都已经在可执行文件里了，因此直接 FROM scratch 会让镜像体积更加小巧。使用 Go 语言开发的应用很多会使用这种方式来制作镜像，这也是为什么有人认为 Go 是特别适合容器微服务架构的语言的原因之一。</p>\n<h3 id="run-执行命令"><a href="#run-%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>RUN 执行命令</h3>\n<p>RUN 指令是用来执行命令行命令的。由于命令行的强大能力，RUN 指令在定制镜像时是最常用的指令之一。其格式有两种：</p>\n<ul>\n<li>\n<p>shell 格式：<code class="language-text">RUN &lt;命令&gt;</code>，就像直接在命令行中输入的命令一样。刚才写的 Dockerfile 中的 RUN 指令就是这种格式。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="41730020707506460000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`RUN echo \'<h1>Hello, Docker!</h1>\' > /usr/share/nginx/html/index.html`, `41730020707506460000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">RUN <span class="token builtin class-name">echo</span> <span class="token string">\'&lt;h1>Hello, Docker!&lt;/h1>\'</span> <span class="token operator">></span> /usr/share/nginx/html/index.html</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n</li>\n<li>\n<p>exec 格式：RUN [“可执行文件”, “参数 1”, “参数 2”]，这更像是函数调用中的格式。</p>\n</li>\n</ul>\n<p>既然 RUN 就像 Shell 脚本一样可以执行命令，那么我们是否就可以像 Shell 脚本一样把每个命令对应一个 RUN 呢？比如这样：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="19554580688296894000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`FROM debian:stretch\n\nRUN apt-get update\nRUN apt-get install -y gcc libc6-dev make wget\nRUN wget -O redis.tar.gz &quot;http://download.redis.io/releases/redis-5.0.3.tar.gz&quot;\nRUN mkdir -p /usr/src/redis\nRUN tar -xzf redis.tar.gz -C /usr/src/redis --strip-components=1\nRUN make -C /usr/src/redis\nRUN make -C /usr/src/redis install`, `19554580688296894000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">FROM debian:stretch\n\nRUN <span class="token function">apt-get</span> update\nRUN <span class="token function">apt-get</span> <span class="token function">install</span> -y gcc libc6-dev <span class="token function">make</span> <span class="token function">wget</span>\nRUN <span class="token function">wget</span> -O redis.tar.gz <span class="token string">"http://download.redis.io/releases/redis-5.0.3.tar.gz"</span>\nRUN <span class="token function">mkdir</span> -p /usr/src/redis\nRUN <span class="token function">tar</span> -xzf redis.tar.gz -C /usr/src/redis --strip-components<span class="token operator">=</span><span class="token number">1</span>\nRUN <span class="token function">make</span> -C /usr/src/redis\nRUN <span class="token function">make</span> -C /usr/src/redis <span class="token function">install</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>之前说过，Dockerfile 中每一个指令都会建立一层，RUN 也不例外。每一个 RUN 的行为，就和刚才我们手工建立镜像的过程一样：新建立一层，在其上执行这些命令，执行结束后，commit 这一层的修改，构成新的镜像。</p>\n<p>而上面的这种写法，创建了 7 层镜像。这是完全没有意义的，而且很多运行时不需要的东西，都被装进了镜像里，比如编译环境、更新的软件包等等。结果就是产生非常臃肿、非常多层的镜像，不仅仅增加了构建部署的时间，也很容易出错。 这是很多初学 Docker 的人常犯的一个错误。</p>\n<p>Union FS 是有最大层数限制的，比如 AUFS，曾经是最大不得超过 42 层，现在是不得超过 127 层。</p>\n<p>上面的 Dockerfile 正确的写法应该是这样：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="88655698661500030000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`FROM debian:stretch\n\nRUN set -x; buildDeps=\'gcc libc6-dev make wget\' \\\n    && apt-get update \\\n    && apt-get install -y \\$buildDeps \\\n    && wget -O redis.tar.gz &quot;http://download.redis.io/releases/redis-5.0.3.tar.gz&quot; \\\n    && mkdir -p /usr/src/redis \\\n    && tar -xzf redis.tar.gz -C /usr/src/redis --strip-components=1 \\\n    && make -C /usr/src/redis \\\n    && make -C /usr/src/redis install \\\n    && rm -rf /var/lib/apt/lists/* \\\n    && rm redis.tar.gz \\\n    && rm -r /usr/src/redis \\\n    && apt-get purge -y --auto-remove \\$buildDeps`, `88655698661500030000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">FROM debian:stretch\n\nRUN <span class="token builtin class-name">set</span> -x<span class="token punctuation">;</span> <span class="token assign-left variable">buildDeps</span><span class="token operator">=</span><span class="token string">\'gcc libc6-dev make wget\'</span> <span class="token punctuation">\\</span>\n    <span class="token operator">&amp;&amp;</span> <span class="token function">apt-get</span> update <span class="token punctuation">\\</span>\n    <span class="token operator">&amp;&amp;</span> <span class="token function">apt-get</span> <span class="token function">install</span> -y <span class="token variable">$buildDeps</span> <span class="token punctuation">\\</span>\n    <span class="token operator">&amp;&amp;</span> <span class="token function">wget</span> -O redis.tar.gz <span class="token string">"http://download.redis.io/releases/redis-5.0.3.tar.gz"</span> <span class="token punctuation">\\</span>\n    <span class="token operator">&amp;&amp;</span> <span class="token function">mkdir</span> -p /usr/src/redis <span class="token punctuation">\\</span>\n    <span class="token operator">&amp;&amp;</span> <span class="token function">tar</span> -xzf redis.tar.gz -C /usr/src/redis --strip-components<span class="token operator">=</span><span class="token number">1</span> <span class="token punctuation">\\</span>\n    <span class="token operator">&amp;&amp;</span> <span class="token function">make</span> -C /usr/src/redis <span class="token punctuation">\\</span>\n    <span class="token operator">&amp;&amp;</span> <span class="token function">make</span> -C /usr/src/redis <span class="token function">install</span> <span class="token punctuation">\\</span>\n    <span class="token operator">&amp;&amp;</span> <span class="token function">rm</span> -rf /var/lib/apt/lists/* <span class="token punctuation">\\</span>\n    <span class="token operator">&amp;&amp;</span> <span class="token function">rm</span> redis.tar.gz <span class="token punctuation">\\</span>\n    <span class="token operator">&amp;&amp;</span> <span class="token function">rm</span> -r /usr/src/redis <span class="token punctuation">\\</span>\n    <span class="token operator">&amp;&amp;</span> <span class="token function">apt-get</span> purge -y --auto-remove <span class="token variable">$buildDeps</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>首先，之前所有的命令只有一个目的，就是编译、安装 redis 可执行文件。因此没有必要建立很多层，这只是一层的事情。因此，这里没有使用很多个 RUN 一一对应不同的命令，而是仅仅使用一个 RUN 指令，并使用 &#x26;&#x26; 将各个所需命令串联起来，将之前的 7 层 简化为了 1 层。在撰写 Dockerfile 的时候，要经常提醒自己，这并不是在写 Shell 脚本，而是在定义每一层该如何构建。</p>\n<p>并且，这里为了格式化还进行了换行。Dockerfile 支持 Shell 类的行尾添加 \\ 的命令换行方式，以及行首 # 进行注释的格式。良好的格式，比如换行、缩进、注释等，会让维护、排障更为容易，这是一个比较好的习惯。</p>\n<p>此外，还可以看到这一组命令的最后添加了清理工作的命令，删除了为了编译构建所需要的软件，清理了所有下载、展开的文件，并且还清理了 apt 缓存文件。这是很重要的一步，我们之前说过，镜像是多层存储，每一层的东西并不会在下一层被删除，会一直跟随着镜像。因此镜像构建时，一定要确保每一层只添加真正需要添加的东西，任何无关的东西都应该清理掉。</p>\n<p>很多人初学 Docker 制作出了很臃肿的镜像的原因之一，就是忘记了每一层构建的最后一定要清理掉无关文件。</p>\n<h3 id="构建镜像"><a href="#%E6%9E%84%E5%BB%BA%E9%95%9C%E5%83%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>构建镜像</h3>\n<p>好了，让我们再回到之前定制的 nginx 镜像的 Dockerfile 来。现在我们明白了这个 Dockerfile 的内容，那么让我们来构建这个镜像吧。</p>\n<p>在 Dockerfile 文件所在目录执行：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="16101935840520976000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker build -t nginx:v3 .\nSending build context to Docker daemon 2.048 kB\nStep 1 : FROM nginx\n ---> e43d811ce2f4\nStep 2 : RUN echo \'<h1>Hello, Docker!</h1>\' > /usr/share/nginx/html/index.html\n ---> Running in 9cdc27646c7b\n ---> 44aa4490ce2c\nRemoving intermediate container 9cdc27646c7b\nSuccessfully built 44aa4490ce2c`, `16101935840520976000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker build -t nginx:v3 <span class="token builtin class-name">.</span>\nSending build context to Docker daemon <span class="token number">2.048</span> kB\nStep <span class="token number">1</span> <span class="token builtin class-name">:</span> FROM nginx\n ---<span class="token operator">></span> e43d811ce2f4\nStep <span class="token number">2</span> <span class="token builtin class-name">:</span> RUN <span class="token builtin class-name">echo</span> <span class="token string">\'&lt;h1>Hello, Docker!&lt;/h1>\'</span> <span class="token operator">></span> /usr/share/nginx/html/index.html\n ---<span class="token operator">></span> Running <span class="token keyword">in</span> 9cdc27646c7b\n ---<span class="token operator">></span> 44aa4490ce2c\nRemoving intermediate container 9cdc27646c7b\nSuccessfully built 44aa4490ce2c</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>从命令的输出结果中，我们可以清晰的看到镜像的构建过程。在 Step 2 中，如同我们之前所说的那样，RUN 指令启动了一个容器 9cdc27646c7b，执行了所要求的命令，并最后提交了这一层 44aa4490ce2c，随后删除了所用到的这个容器 9cdc27646c7b。</p>\n<p>这里我们使用了 docker build 命令进行镜像构建。其格式为：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="35891236017377760000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`docker build [选项] <上下文路径/URL/->`, `35891236017377760000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">docker build <span class="token punctuation">[</span>选项<span class="token punctuation">]</span> <span class="token operator">&lt;</span>上下文路径/URL/-<span class="token operator">></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>在这里我们指定了最终镜像的名称 <code class="language-text">-t nginx:v3</code>，构建成功后，我们可以像之前运行 nginx:v2 那样来运行这个镜像，其结果会和 nginx:v2 一样。</p>\n<h3 id="镜像构建上下文（context）"><a href="#%E9%95%9C%E5%83%8F%E6%9E%84%E5%BB%BA%E4%B8%8A%E4%B8%8B%E6%96%87%EF%BC%88context%EF%BC%89" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>镜像构建上下文（Context）</h3>\n<p>如果注意，会看到 docker build 命令最后有一个 <code class="language-text">.</code>。<code class="language-text">.</code> 表示当前目录，而 Dockerfile 就在当前目录，因此不少初学者以为这个路径是在指定 Dockerfile 所在路径，这么理解其实是不准确的。如果对应上面的命令格式，你可能会发现，这是在指定上下文路径。那么什么是上下文呢？</p>\n<p>首先我们要理解 docker build 的工作原理。Docker 在运行时分为 Docker 引擎（也就是服务端守护进程）和客户端工具。Docker 的引擎提供了一组 REST API，被称为 Docker Remote API，而如 docker 命令这样的客户端工具，则是通过这组 API 与 Docker 引擎交互，从而完成各种功能。因此，虽然表面上我们好像是在本机执行各种 docker 功能，但实际上，一切都是使用的远程调用形式在服务端（Docker 引擎）完成。也因为这种 C/S 设计，让我们操作远程服务器的 Docker 引擎变得轻而易举。</p>\n<p>当我们进行镜像构建的时候，并非所有定制都会通过 RUN 指令完成，经常会需要将一些本地文件复制进镜像，比如通过 COPY 指令、ADD 指令等。而 docker build 命令构建镜像，其实并非在本地构建，而是在服务端，也就是 Docker 引擎中构建的。那么在这种客户端/服务端的架构中，如何才能让服务端获得本地文件呢？</p>\n<p>这就引入了上下文的概念。当构建的时候，用户会指定构建镜像上下文的路径，docker build 命令得知这个路径后，会将路径下的所有内容打包，然后上传给 Docker 引擎。这样 Docker 引擎收到这个上下文包后，展开就会获得构建镜像所需的一切文件。</p>\n<p>如果在 Dockerfile 中这么写：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="43626187458929750000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`COPY ./package.json /app/`, `43626187458929750000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">COPY ./package.json /app/</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>这并不是要复制执行 docker build 命令所在的目录下的 package.json，也不是复制 Dockerfile 所在目录下的 package.json，而是复制上下文（context）目录下的 package.json。</p>\n<p>因此，COPY 这类指令中的源文件的路径都是相对路径。这也是初学者经常会问的为什么 <code class="language-text">COPY ../package.json /app</code> 或者 <code class="language-text">COPY /opt/xxxx /app</code> 无法工作的原因，因为这些路径已经超出了上下文的范围，Docker 引擎无法获得这些位置的文件。如果真的需要那些文件，应该将它们复制到上下文目录中去。</p>\n<p>现在就可以理解刚才的命令 <code class="language-text">docker build -t nginx:v3 .</code> 中的这个 <code class="language-text">.</code>，实际上是在指定上下文的目录，docker build 命令会将该目录下的内容打包交给 Docker 引擎以帮助构建镜像。</p>\n<p>如果观察 docker build 输出，我们其实已经看到了这个发送上下文的过程：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="17867438305859906000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker build -t nginx:v3 .\nSending build context to Docker daemon 2.048 kB\n...`, `17867438305859906000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker build -t nginx:v3 <span class="token builtin class-name">.</span>\nSending build context to Docker daemon <span class="token number">2.048</span> kB\n<span class="token punctuation">..</span>.</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>理解构建上下文对于镜像构建是很重要的，避免犯一些不应该的错误。比如有些初学者在发现 <code class="language-text">COPY /opt/xxxx /app</code> 不工作后，于是干脆将 Dockerfile 放到了硬盘根目录去构建，结果发现 docker build 执行后，在发送一个几十 GB 的东西，极为缓慢而且很容易构建失败。那是因为这种做法是在让 docker build 打包整个硬盘，这显然是使用错误。</p>\n<p>一般来说，应该会将 Dockerfile 置于一个空目录下，或者项目根目录下。如果该目录下没有所需文件，那么应该把所需文件复制一份过来。如果目录下有些东西确实不希望构建时传给 Docker 引擎，那么可以用 .gitignore 一样的语法写一个 .dockerignore，该文件是用于剔除不需要作为上下文传递给 Docker 引擎的。</p>\n<p>那么为什么会有人误以为 <code class="language-text">.</code> 是指定 Dockerfile 所在目录呢？这是因为在默认情况下，如果不额外指定 Dockerfile 的话，会将上下文目录下的名为 Dockerfile 的文件作为 Dockerfile。</p>\n<p>这只是默认行为，实际上 Dockerfile 的文件名并不要求必须为 Dockerfile，而且并不要求必须位于上下文目录中，比如可以用 -f ../Dockerfile.php 参数指定某个文件作为 Dockerfile。</p>\n<p>当然，一般大家习惯性的会使用默认的文件名 Dockerfile，以及会将其置于镜像构建上下文目录中。</p>\n<h3 id="其它-docker-build-的用法"><a href="#%E5%85%B6%E5%AE%83-docker-build-%E7%9A%84%E7%94%A8%E6%B3%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>其它 docker build 的用法</h3>\n<h4 id="直接用-git-repo-进行构建"><a href="#%E7%9B%B4%E6%8E%A5%E7%94%A8-git-repo-%E8%BF%9B%E8%A1%8C%E6%9E%84%E5%BB%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>直接用 Git repo 进行构建</h4>\n<p>或许你已经注意到了，docker build 还支持从 URL 构建，比如可以直接从 Git repo 中构建：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="84518684200495890000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# \\$env:DOCKER_BUILDKIT=0\n# export DOCKER_BUILDKIT=0\n\n\\$ docker build -t hello-world https://github.com/docker-library/hello-world.git#master:amd64/hello-world\n\nStep 1/3 : FROM scratch\n --->\nStep 2/3 : COPY hello /\n ---> ac779757d46e\nStep 3/3 : CMD [&quot;/hello&quot;]\n ---> Running in d2a513a760ed\nRemoving intermediate container d2a513a760ed\n ---> 038ad4142d2b\nSuccessfully built 038ad4142d2b`, `84518684200495890000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token comment"># $env:DOCKER_BUILDKIT=0</span>\n<span class="token comment"># export DOCKER_BUILDKIT=0</span>\n\n$ docker build -t hello-world https://github.com/docker-library/hello-world.git<span class="token comment">#master:amd64/hello-world</span>\n\nStep <span class="token number">1</span>/3 <span class="token builtin class-name">:</span> FROM scratch\n ---<span class="token operator">></span>\nStep <span class="token number">2</span>/3 <span class="token builtin class-name">:</span> COPY hello /\n ---<span class="token operator">></span> ac779757d46e\nStep <span class="token number">3</span>/3 <span class="token builtin class-name">:</span> CMD <span class="token punctuation">[</span><span class="token string">"/hello"</span><span class="token punctuation">]</span>\n ---<span class="token operator">></span> Running <span class="token keyword">in</span> d2a513a760ed\nRemoving intermediate container d2a513a760ed\n ---<span class="token operator">></span> 038ad4142d2b\nSuccessfully built 038ad4142d2b</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这行命令指定了构建所需的 Git repo，并且指定分支为 master，构建目录为 /amd64/hello-world/，然后 Docker 就会自己去 git clone 这个项目、切换到指定分支、并进入到指定目录后开始构建。</p>\n<h4 id="用给定的-tar-压缩包构建"><a href="#%E7%94%A8%E7%BB%99%E5%AE%9A%E7%9A%84-tar-%E5%8E%8B%E7%BC%A9%E5%8C%85%E6%9E%84%E5%BB%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>用给定的 tar 压缩包构建</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="592311049934357600"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker build http://server/context.tar.gz`, `592311049934357600`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker build http://server/context.tar.gz</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>如果所给出的 URL 不是个 Git repo，而是个 tar 压缩包，那么 Docker 引擎会下载这个包，并自动解压缩，以其作为上下文，开始构建。</p>\n<h4 id="从标准输入中读取-dockerfile-进行构建"><a href="#%E4%BB%8E%E6%A0%87%E5%87%86%E8%BE%93%E5%85%A5%E4%B8%AD%E8%AF%BB%E5%8F%96-dockerfile-%E8%BF%9B%E8%A1%8C%E6%9E%84%E5%BB%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>从标准输入中读取 Dockerfile 进行构建</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="12452971799241630000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`docker build - < Dockerfile`, `12452971799241630000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">docker build - <span class="token operator">&lt;</span> Dockerfile</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>或</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="78820279991481470000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`cat Dockerfile | docker build -`, `78820279991481470000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token function">cat</span> Dockerfile <span class="token operator">|</span> docker build -</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>如果标准输入传入的是文本文件，则将其视为 Dockerfile，并开始构建。这种形式由于直接从标准输入中读取 Dockerfile 的内容，它没有上下文，因此不可以像其他方法那样可以将本地文件 COPY 进镜像之类的事情。</p>\n<h4 id="从标准输入中读取上下文压缩包进行构建"><a href="#%E4%BB%8E%E6%A0%87%E5%87%86%E8%BE%93%E5%85%A5%E4%B8%AD%E8%AF%BB%E5%8F%96%E4%B8%8A%E4%B8%8B%E6%96%87%E5%8E%8B%E7%BC%A9%E5%8C%85%E8%BF%9B%E8%A1%8C%E6%9E%84%E5%BB%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>从标准输入中读取上下文压缩包进行构建</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="18515843423631995000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker build - < context.tar.gz`, `18515843423631995000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker build - <span class="token operator">&lt;</span> context.tar.gz</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>如果发现标准输入的文件格式是 gzip、bzip2 以及 xz 的话，将会使其为上下文压缩包，直接将其展开，将里面视为上下文，并开始构建。</p>\n<h2 id="其它制作镜像的方式"><a href="#%E5%85%B6%E5%AE%83%E5%88%B6%E4%BD%9C%E9%95%9C%E5%83%8F%E7%9A%84%E6%96%B9%E5%BC%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>其它制作镜像的方式</h2>\n<p>除了标准的使用 Dockerfile 生成镜像的方法外，由于各种特殊需求和历史原因，还提供了一些其它方法用以生成镜像。</p>\n<h3 id="从-rootfs-压缩包导入"><a href="#%E4%BB%8E-rootfs-%E5%8E%8B%E7%BC%A9%E5%8C%85%E5%AF%BC%E5%85%A5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>从 rootfs 压缩包导入</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="27115066255828290000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`docker import [选项] <文件>|<URL>|- [<仓库名>[:<标签>]]`, `27115066255828290000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">docker <span class="token function">import</span> <span class="token punctuation">[</span>选项<span class="token punctuation">]</span> <span class="token operator">&lt;</span>文件<span class="token operator">>|</span><span class="token operator">&lt;</span>URL<span class="token operator">>|</span>- <span class="token punctuation">[</span><span class="token operator">&lt;</span>仓库名<span class="token operator">></span><span class="token punctuation">[</span>:<span class="token operator">&lt;</span>标签<span class="token operator">></span><span class="token punctuation">]</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>压缩包可以是本地文件、远程 Web 文件，甚至是从标准输入中得到。压缩包将会在镜像 / 目录展开，并直接作为镜像第一层提交。</p>\n<p>比如我们想要创建一个 OpenVZ 的 Ubuntu 16.04 模板的镜像：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="80169233266020970000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker import \\\n    http://download.openvz.org/template/precreated/ubuntu-16.04-x86_64.tar.gz \\\n    openvz/ubuntu:16.04\n\nDownloading from http://download.openvz.org/template/precreated/ubuntu-16.04-x86_64.tar.gz\nsha256:412b8fc3e3f786dca0197834a698932b9c51b69bd8cf49e100c35d38c9879213`, `80169233266020970000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker <span class="token function">import</span> <span class="token punctuation">\\</span>\n    http://download.openvz.org/template/precreated/ubuntu-16.04-x86_64.tar.gz <span class="token punctuation">\\</span>\n    openvz/ubuntu:16.04\n\nDownloading from http://download.openvz.org/template/precreated/ubuntu-16.04-x86_64.tar.gz\nsha256:412b8fc3e3f786dca0197834a698932b9c51b69bd8cf49e100c35d38c9879213</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这条命令自动下载了 ubuntu-16.04-x86_64.tar.gz 文件，并且作为根文件系统展开导入，并保存为镜像 openvz/ubuntu:16.04。</p>\n<p>导入成功后，我们可以用 docker image ls 看到这个导入的镜像：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="33297086545669562000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker image ls openvz/ubuntu\nREPOSITORY          TAG                 IMAGE ID            CREATED             SIZE\nopenvz/ubuntu       16.04               412b8fc3e3f7        55 seconds ago      505MB`, `33297086545669562000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker image <span class="token function">ls</span> openvz/ubuntu\nREPOSITORY          TAG                 IMAGE ID            CREATED             SIZE\nopenvz/ubuntu       <span class="token number">16.04</span>               412b8fc3e3f7        <span class="token number">55</span> seconds ago      505MB</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>如果我们查看其历史的话，会看到描述中有导入的文件链接：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="58395003649006690000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker history openvz/ubuntu:16.04\nIMAGE               CREATED              CREATED BY          SIZE                COMMENT\nf477a6e18e98        About a minute ago                       214.9 MB            Imported from http://download.openvz.org/template/precreated/ubuntu-16.04-x86_64.tar.gz`, `58395003649006690000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker <span class="token function">history</span> openvz/ubuntu:16.04\nIMAGE               CREATED              CREATED BY          SIZE                COMMENT\nf477a6e18e98        About a minute ago                       <span class="token number">214.9</span> MB            Imported from http://download.openvz.org/template/precreated/ubuntu-16.04-x86_64.tar.gz</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<h2 id="docker-镜像的导入和导出-docker-save-和-docker-load"><a href="#docker-%E9%95%9C%E5%83%8F%E7%9A%84%E5%AF%BC%E5%85%A5%E5%92%8C%E5%AF%BC%E5%87%BA-docker-save-%E5%92%8C-docker-load" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Docker 镜像的导入和导出 docker save 和 docker load</h2>\n<p>Docker 还提供了 docker save 和 docker load 命令，用以将镜像保存为一个文件，然后传输到另一个位置上，再加载进来。这是在没有 Docker Registry 时的做法，现在已经不推荐，镜像迁移应该直接使用 Docker Registry，无论是直接使用 Docker Hub 还是使用内网私有 Registry 都可以。</p>\n<h3 id="保存镜像"><a href="#%E4%BF%9D%E5%AD%98%E9%95%9C%E5%83%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>保存镜像</h3>\n<p>使用 docker save 命令可以将镜像保存为归档文件。</p>\n<p>比如我们希望保存这个 alpine 镜像。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="51706602157792215000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker image ls alpine\nREPOSITORY          TAG                 IMAGE ID            CREATED             SIZE\nalpine              latest              baa5d63471ea        5 weeks ago         4.803 MB`, `51706602157792215000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker image <span class="token function">ls</span> alpine\nREPOSITORY          TAG                 IMAGE ID            CREATED             SIZE\nalpine              latest              baa5d63471ea        <span class="token number">5</span> weeks ago         <span class="token number">4.803</span> MB</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>保存镜像的命令为：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="65647283065275160000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker save alpine -o filename\n\\$ file filename\nfilename: POSIX tar archive`, `65647283065275160000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker save alpine -o filename\n$ <span class="token function">file</span> filename\nfilename: POSIX <span class="token function">tar</span> archive</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>这里的 filename 可以为任意名称甚至任意后缀名，但文件的本质都是归档文件</p>\n<p>注意：如果同名则会覆盖（没有警告）</p>\n<p>若使用 gzip 压缩：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="33086129311809920000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker save alpine | gzip > alpine-latest.tar.gz`, `33086129311809920000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker save alpine <span class="token operator">|</span> <span class="token function">gzip</span> <span class="token operator">></span> alpine-latest.tar.gz</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>然后我们将 alpine-latest.tar.gz 文件复制到了到了另一个机器上，可以用下面这个命令加载镜像：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="55405946608996246000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker load -i alpine-latest.tar.gz\nLoaded image: alpine:latest`, `55405946608996246000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker load -i alpine-latest.tar.gz\nLoaded image: alpine:latest</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>如果我们结合这两个命令以及 ssh 甚至 pv 的话，利用 Linux 强大的管道，我们可以写一个命令完成从一个机器将镜像迁移到另一个机器，并且带进度条的功能：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="98753192620207730000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`docker save <镜像名> | bzip2 | pv | ssh <用户名>@<主机名> \'cat | docker load\'`, `98753192620207730000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">docker save <span class="token operator">&lt;</span>镜像名<span class="token operator">></span> <span class="token operator">|</span> <span class="token function">bzip2</span> <span class="token operator">|</span> <span class="token function">pv</span> <span class="token operator">|</span> <span class="token function">ssh</span> <span class="token operator">&lt;</span>用户名<span class="token operator">></span>@<span class="token operator">&lt;</span>主机名<span class="token operator">></span> <span class="token string">\'cat | docker load\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h2 id="镜像的实现原理"><a href="#%E9%95%9C%E5%83%8F%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>镜像的实现原理</h2>\n<p>Docker 镜像是怎么实现增量的修改和维护的？</p>\n<p>每个镜像都由很多层次构成，Docker 使用 Union FS 将这些不同的层结合到一个镜像中去。</p>\n<p>通常 Union FS 有两个用途, 一方面可以实现不借助 LVM、RAID 将多个 disk 挂到同一个目录下,另一个更常用的就是将一个只读的分支和一个可写的分支联合在一起，Live CD 正是基于此方法可以允许在镜像不变的基础上允许用户在其上进行一些写操作。</p>\n<p>Docker 在 OverlayFS 上构建的容器也是利用了类似的原理。</p>\n<h1 id="dockerfile"><a href="#dockerfile" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Dockerfile</h1>\n<h2 id="copy-复制文件"><a href="#copy-%E5%A4%8D%E5%88%B6%E6%96%87%E4%BB%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>COPY 复制文件</h2>\n<p>格式：</p>\n<ul>\n<li><code class="language-text">COPY [--chown=&lt;user&gt;:&lt;group&gt;] &lt;源路径&gt;... &lt;目标路径&gt;</code></li>\n<li><code class="language-text">COPY [--chown=&lt;user&gt;:&lt;group&gt;] [&quot;&lt;源路径1&gt;&quot;,... &quot;&lt;目标路径&gt;&quot;]</code></li>\n</ul>\n<p>和 RUN 指令一样，也有两种格式，一种类似于命令行，一种类似于函数调用。</p>\n<p>COPY 指令将从构建上下文目录中 <code class="language-text">&lt;源路径&gt;</code> 的文件/目录复制到新的一层的镜像内的 <code class="language-text">&lt;目标路径&gt;</code> 位置。比如：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="59983025020514870000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`COPY package.json /usr/src/app/`, `59983025020514870000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">COPY</span> package.json /usr/src/app/</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p><code class="language-text">&lt;源路径&gt;</code> 可以是多个，甚至可以是通配符，其通配符规则要满足 Go 的 filepath.Match 规则，如：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="49705742764035875000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`COPY hom* /mydir/\nCOPY hom?.txt /mydir/`, `49705742764035875000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">COPY</span> hom* /mydir/\n<span class="token keyword">COPY</span> hom<span class="token punctuation">?</span>.txt /mydir/</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p><code class="language-text">&lt;目标路径&gt;</code> 可以是容器内的绝对路径，也可以是相对于工作目录的相对路径（工作目录可以用 WORKDIR 指令来指定）。目标路径不需要事先创建，如果目录不存在会在复制文件前先行创建缺失目录。</p>\n<p>此外，还需要注意一点，使用 COPY 指令，源文件的各种元数据都会保留。比如读、写、执行权限、文件变更时间等。这个特性对于镜像定制很有用。特别是构建相关文件都在使用 Git 进行管理的时候。</p>\n<p>在使用该指令的时候还可以加上 <code class="language-text">--chown=&lt;user&gt;:&lt;group&gt;</code> 选项来改变文件的所属用户及所属组。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="38802916043621940000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`COPY --chown=55:mygroup files* /mydir/\nCOPY --chown=bin files* /mydir/\nCOPY --chown=1 files* /mydir/\nCOPY --chown=10:11 files* /mydir/`, `38802916043621940000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">COPY</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>chown=55<span class="token punctuation">:</span>mygroup files* /mydir/\n<span class="token keyword">COPY</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>chown=bin files* /mydir/\n<span class="token keyword">COPY</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>chown=1 files* /mydir/\n<span class="token keyword">COPY</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>chown=10<span class="token punctuation">:</span>11 files* /mydir/</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果源路径为文件夹，复制的时候不是直接复制该文件夹，而是将文件夹中的内容复制到目标路径。</p>\n<h2 id="add-更高级的复制文件"><a href="#add-%E6%9B%B4%E9%AB%98%E7%BA%A7%E7%9A%84%E5%A4%8D%E5%88%B6%E6%96%87%E4%BB%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ADD 更高级的复制文件</h2>\n<p>ADD 指令和 COPY 的格式和性质基本一致。但是在 COPY 基础上增加了一些功能。</p>\n<p>比如 <code class="language-text">&lt;源路径&gt;</code> 可以是一个 URL，这种情况下，Docker 引擎会试图去下载这个链接的文件放到 <code class="language-text">&lt;目标路径&gt;</code> 去。下载后的文件权限自动设置为 600，如果这并不是想要的权限，那么还需要增加额外的一层 RUN 进行权限调整，另外，如果下载的是个压缩包，需要解压缩，也一样还需要额外的一层 RUN 指令进行解压缩。所以不如直接使用 RUN 指令，然后使用 wget 或者 curl 工具下载，处理权限、解压缩、然后清理无用文件更合理。因此，这个功能其实并不实用，而且不推荐使用。</p>\n<p>如果 <code class="language-text">&lt;源路径&gt;</code> 为一个 tar 压缩文件的话，压缩格式为 gzip, bzip2 以及 xz 的情况下，ADD 指令将会自动解压缩这个压缩文件到 <code class="language-text">&lt;目标路径&gt;</code> 去。</p>\n<p>在某些情况下，这个自动解压缩的功能非常有用，比如官方镜像 ubuntu 中：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="69958970805144950000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`FROM scratch\nADD ubuntu-xenial-core-cloudimg-amd64-root.tar.gz /\n...`, `69958970805144950000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">FROM</span> scratch\n<span class="token keyword">ADD</span> ubuntu<span class="token punctuation">-</span>xenial<span class="token punctuation">-</span>core<span class="token punctuation">-</span>cloudimg<span class="token punctuation">-</span>amd64<span class="token punctuation">-</span>root.tar.gz /\n<span class="token punctuation">...</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>但在某些情况下，如果我们真的是希望复制个压缩文件进去，而不解压缩，这时就不可以使用 ADD 命令了。</p>\n<p>在 Docker 官方的 Dockerfile 最佳实践文档中要求，尽可能的使用 COPY，因为 COPY 的语义很明确，就是复制文件而已，而 ADD 则包含了更复杂的功能，其行为也不一定很清晰。最适合使用 ADD 的场合，就是所提及的需要自动解压缩的场合。</p>\n<p>另外需要注意的是，ADD 指令会令镜像构建缓存失效，从而可能会令镜像构建变得比较缓慢。</p>\n<p>因此在 COPY 和 ADD 指令中选择的时候，可以遵循这样的原则，所有的文件复制均使用 COPY 指令，仅在需要自动解压缩的场合使用 ADD。</p>\n<p>在使用该指令的时候还可以加上 <code class="language-text">--chown=&lt;user&gt;:&lt;group&gt;</code> 选项来改变文件的所属用户及所属组。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="92978851504573900000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`ADD --chown=55:mygroup files* /mydir/\nADD --chown=bin files* /mydir/\nADD --chown=1 files* /mydir/k\nADD --chown=10:11 files* /mydir/`, `92978851504573900000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">ADD</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>chown=55<span class="token punctuation">:</span>mygroup files* /mydir/\n<span class="token keyword">ADD</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>chown=bin files* /mydir/\n<span class="token keyword">ADD</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>chown=1 files* /mydir/k\n<span class="token keyword">ADD</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>chown=10<span class="token punctuation">:</span>11 files* /mydir/</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="cmd-容器启动命令"><a href="#cmd-%E5%AE%B9%E5%99%A8%E5%90%AF%E5%8A%A8%E5%91%BD%E4%BB%A4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>CMD 容器启动命令</h2>\n<p>CMD 指令的格式和 RUN 相似，也是两种格式：</p>\n<ul>\n<li>shell 格式：<code class="language-text">CMD &lt;命令&gt;</code></li>\n<li>exec 格式：<code class="language-text">CMD [&quot;可执行文件&quot;, &quot;参数1&quot;, &quot;参数2&quot;...]</code></li>\n<li>参数列表格式：<code class="language-text">CMD [&quot;参数1&quot;, &quot;参数2&quot;...]</code>。在指定了 ENTRYPOINT 指令后，用 CMD 指定具体的参数。</li>\n</ul>\n<p>之前介绍容器的时候曾经说过，Docker 不是虚拟机，容器就是进程。既然是进程，那么在启动容器的时候，需要指定所运行的程序及参数。CMD 指令就是用于指定默认的容器主进程的启动命令的。</p>\n<p>在运行时可以指定新的命令来替代镜像设置中的这个默认命令，比如，ubuntu 镜像默认的 CMD 是 <code class="language-text">/bin/bash</code>，如果我们直接 <code class="language-text">docker run -it ubuntu</code> 的话，会直接进入 bash。我们也可以在运行时指定运行别的命令，如 <code class="language-text">docker run -it ubuntu cat /etc/os-release</code>。这就是用 <code class="language-text">cat /etc/os-release</code> 命令替换了默认的 <code class="language-text">/bin/bash</code> 命令了，输出了系统版本信息。</p>\n<p>在指令格式上，一般推荐使用 exec 格式，这类格式在解析时会被解析为 JSON 数组，因此一定要使用双引号，而不要使用单引号。</p>\n<p>如果使用 shell 格式的话，实际的命令会被包装为 <code class="language-text">sh -c</code> 的参数的形式进行执行。比如：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="71244567658360316000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`CMD echo \\$HOME`, `71244567658360316000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">CMD</span> echo $HOME</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>在实际执行中，会将其变更为：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="49767359697206520000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`CMD [ &quot;sh&quot;, &quot;-c&quot;, &quot;echo \\$HOME&quot; ]`, `49767359697206520000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">CMD</span> <span class="token punctuation">[</span> <span class="token string">"sh"</span><span class="token punctuation">,</span> <span class="token string">"-c"</span><span class="token punctuation">,</span> <span class="token string">"echo $HOME"</span> <span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>这就是为什么我们可以使用环境变量的原因，因为这些环境变量会被 shell 进行解析处理。</p>\n<p>提到 CMD 就不得不提容器中应用在前台执行和后台执行的问题。这是初学者常出现的一个混淆。</p>\n<p>Docker 不是虚拟机，容器中的应用都应该以前台执行，而不是像虚拟机、物理机里面那样，用 systemd 去启动后台服务，容器内没有后台服务的概念。</p>\n<p>一些初学者将 CMD 写为：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="98218116735681330000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`CMD service nginx start`, `98218116735681330000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">CMD</span> service nginx start</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>然后发现容器执行后就立即退出了。甚至在容器内去使用 systemctl 命令结果却发现根本执行不了。这就是因为没有搞明白前台、后台的概念，没有区分容器和虚拟机的差异，依旧在以传统虚拟机的角度去理解容器。</p>\n<p>对于容器而言，其启动程序就是容器应用进程，容器就是为了主进程而存在的，主进程退出，容器就失去了存在的意义，从而退出，其它辅助进程不是它需要关心的东西。</p>\n<p>而使用 <code class="language-text">service nginx start</code> 命令，则是希望 upstart 来以后台守护进程形式启动 nginx 服务。而刚才说了 <code class="language-text">CMD service nginx start</code> 会被理解为 <code class="language-text">CMD [ &quot;sh&quot;, &quot;-c&quot;, &quot;service nginx start&quot;]</code>，因此主进程实际上是 sh。那么当 <code class="language-text">service nginx start</code> 命令结束后，sh 也就结束了，sh 作为主进程退出了，自然就会令容器退出。</p>\n<p>正确的做法是直接执行 nginx 可执行文件，并且要求以前台形式运行。比如：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="46068787301346650000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`CMD [&quot;nginx&quot;, &quot;-g&quot;, &quot;daemon off;&quot;]`, `46068787301346650000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">CMD</span> <span class="token punctuation">[</span><span class="token string">"nginx"</span><span class="token punctuation">,</span> <span class="token string">"-g"</span><span class="token punctuation">,</span> <span class="token string">"daemon off;"</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h2 id="entrypoint-入口点"><a href="#entrypoint-%E5%85%A5%E5%8F%A3%E7%82%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ENTRYPOINT 入口点</h2>\n<p>ENTRYPOINT 的格式和 RUN 指令格式一样，分为 exec 格式和 shell 格式。</p>\n<p>ENTRYPOINT 的目的和 CMD 一样，都是在指定容器启动程序及参数。ENTRYPOINT 在运行时也可以替代，不过比 CMD 要略显繁琐，需要通过 docker run 的参数 <code class="language-text">--entrypoint</code> 来指定。</p>\n<p>当指定了 ENTRYPOINT 后，CMD 的含义就发生了改变，不再是直接的运行其命令，而是将 CMD 的内容作为参数传给 ENTRYPOINT 指令，换句话说实际执行时，将变为：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="66431639400001140000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<ENTRYPOINT> &quot;<CMD>&quot;`, `66431639400001140000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token operator">&lt;</span>ENTRYPOINT<span class="token operator">></span> <span class="token string">"&lt;CMD>"</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>那么有了 CMD 后，为什么还要有 ENTRYPOINT 呢？这种 <code class="language-text">&lt;ENTRYPOINT&gt; &quot;&lt;CMD&gt;&quot;</code> 有什么好处么？让我们来看几个场景。</p>\n<h3 id="场景一：让镜像变成像命令一样使用"><a href="#%E5%9C%BA%E6%99%AF%E4%B8%80%EF%BC%9A%E8%AE%A9%E9%95%9C%E5%83%8F%E5%8F%98%E6%88%90%E5%83%8F%E5%91%BD%E4%BB%A4%E4%B8%80%E6%A0%B7%E4%BD%BF%E7%94%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>场景一：让镜像变成像命令一样使用</h3>\n<p>假设我们需要一个得知自己当前公网 IP 的镜像，那么可以先用 CMD 来实现：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="23143990020518834000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`FROM ubuntu:18.04\nRUN apt-get update \\\n    && apt-get install -y curl \\\n    && rm -rf /var/lib/apt/lists/*\nCMD [ &quot;curl&quot;, &quot;-s&quot;, &quot;http://myip.ipip.net&quot; ]`, `23143990020518834000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">FROM</span> ubuntu<span class="token punctuation">:</span>18.04\n<span class="token keyword">RUN</span> apt<span class="token punctuation">-</span>get update \\\n    &amp;&amp; apt<span class="token punctuation">-</span>get install <span class="token punctuation">-</span>y curl \\\n    &amp;&amp; rm <span class="token punctuation">-</span>rf /var/lib/apt/lists/*\n<span class="token keyword">CMD</span> <span class="token punctuation">[</span> <span class="token string">"curl"</span><span class="token punctuation">,</span> <span class="token string">"-s"</span><span class="token punctuation">,</span> <span class="token string">"http://myip.ipip.net"</span> <span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>假如我们使用 <code class="language-text">docker build -t myip .</code> 来构建镜像的话，如果我们需要查询当前公网 IP，只需要执行：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="80728235582532290000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run myip\n当前 IP：61.148.226.66 来自：北京市 联通`, `80728235582532290000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run myip\n当前 IP：61.148.226.66 来自：北京市 联通</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>嗯，这么看起来好像可以直接把镜像当做命令使用了，不过命令总有参数，如果我们希望加参数呢？比如从上面的 CMD 中可以看到实质的命令是 curl，那么如果我们希望显示 HTTP 头信息，就需要加上 -i 参数。那么我们可以直接加 -i 参数给 <code class="language-text">docker run myip</code> 么？</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="3971789911115952600"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run myip -i\ndocker: Error response from daemon: invalid header field value &quot;oci runtime error: container_linux.go:247: starting container process caused \\&quot;exec: \\\\\\&quot;-i\\\\\\&quot;: executable file not found in \\$PATH\\&quot;\\n&quot;.`, `3971789911115952600`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run myip -i\ndocker: Error response from daemon: invalid header field value <span class="token string">"oci runtime error: container_linux.go:247: starting container process caused <span class="token entity" title="\\&quot;">\\"</span>exec: <span class="token entity" title="\\\\">\\\\</span><span class="token entity" title="\\&quot;">\\"</span>-i<span class="token entity" title="\\\\">\\\\</span><span class="token entity" title="\\&quot;">\\"</span>: executable file not found in <span class="token environment constant">$PATH</span><span class="token entity" title="\\&quot;">\\"</span><span class="token entity" title="\\n">\\n</span>"</span><span class="token builtin class-name">.</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>我们可以看到可执行文件找不到的报错，<code class="language-text">executable file not found</code>。之前我们说过，跟在镜像名后面的是 command，运行时会替换 CMD 的默认值。因此这里的 -i 替换了原来的 CMD，而不是添加在原来的 <code class="language-text">curl -s http://myip.ipip.net</code> 后面。而 -i 根本不是命令，所以自然找不到。</p>\n<p>那么如果我们希望加入 -i 这参数，我们就必须重新完整的输入这个命令：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="55693907429172890000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run myip curl -s http://myip.ipip.net -i`, `55693907429172890000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run myip <span class="token function">curl</span> -s http://myip.ipip.net -i</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>这显然不是很好的解决方案，而使用 ENTRYPOINT 就可以解决这个问题。现在我们重新用 ENTRYPOINT 来实现这个镜像：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="21530820976439525000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`FROM ubuntu:18.04\nRUN apt-get update \\\n    && apt-get install -y curl \\\n    && rm -rf /var/lib/apt/lists/*\nENTRYPOINT [ &quot;curl&quot;, &quot;-s&quot;, &quot;http://myip.ipip.net&quot; ]`, `21530820976439525000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">FROM</span> ubuntu<span class="token punctuation">:</span>18.04\n<span class="token keyword">RUN</span> apt<span class="token punctuation">-</span>get update \\\n    &amp;&amp; apt<span class="token punctuation">-</span>get install <span class="token punctuation">-</span>y curl \\\n    &amp;&amp; rm <span class="token punctuation">-</span>rf /var/lib/apt/lists/*\n<span class="token keyword">ENTRYPOINT</span> <span class="token punctuation">[</span> <span class="token string">"curl"</span><span class="token punctuation">,</span> <span class="token string">"-s"</span><span class="token punctuation">,</span> <span class="token string">"http://myip.ipip.net"</span> <span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这次我们再来尝试直接使用 <code class="language-text">docker run myip -i</code>：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="41039559069085970000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run myip\n当前 IP：61.148.226.66 来自：北京市 联通\n\n\\$ docker run myip -i\nHTTP/1.1 200 OK\nServer: nginx/1.8.0\nDate: Tue, 22 Nov 2016 05:12:40 GMT\nContent-Type: text/html; charset=UTF-8\nVary: Accept-Encoding\nX-Powered-By: PHP/5.6.24-1~dotdeb+7.1\nX-Cache: MISS from cache-2\nX-Cache-Lookup: MISS from cache-2:80\nX-Cache: MISS from proxy-2_6\nTransfer-Encoding: chunked\nVia: 1.1 cache-2:80, 1.1 proxy-2_6:8006\nConnection: keep-alive\n\n当前 IP：61.148.226.66 来自：北京市 联通`, `41039559069085970000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run myip\n当前 IP：61.148.226.66 来自：北京市 联通\n\n$ docker run myip -i\nHTTP/1.1 <span class="token number">200</span> OK\nServer: nginx/1.8.0\nDate: Tue, <span class="token number">22</span> Nov <span class="token number">2016</span> 05:12:40 GMT\nContent-Type: text/html<span class="token punctuation">;</span> <span class="token assign-left variable">charset</span><span class="token operator">=</span>UTF-8\nVary: Accept-Encoding\nX-Powered-By: PHP/5.6.24-1~dotdeb+7.1\nX-Cache: MISS from cache-2\nX-Cache-Lookup: MISS from cache-2:80\nX-Cache: MISS from proxy-2_6\nTransfer-Encoding: chunked\nVia: <span class="token number">1.1</span> cache-2:80, <span class="token number">1.1</span> proxy-2_6:8006\nConnection: keep-alive\n\n当前 IP：61.148.226.66 来自：北京市 联通</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以看到，这次成功了。这是因为当存在 ENTRYPOINT 后，CMD 的内容将会作为参数传给 ENTRYPOINT，而这里 -i 就是新的 CMD，因此会作为参数传给 curl，从而达到了我们预期的效果。</p>\n<h3 id="场景二：应用运行前的准备工作"><a href="#%E5%9C%BA%E6%99%AF%E4%BA%8C%EF%BC%9A%E5%BA%94%E7%94%A8%E8%BF%90%E8%A1%8C%E5%89%8D%E7%9A%84%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>场景二：应用运行前的准备工作</h3>\n<p>启动容器就是启动主进程，但有些时候，启动主进程前，需要一些准备工作。</p>\n<p>比如 mysql 类的数据库，可能需要一些数据库配置、初始化的工作，这些工作要在最终的 mysql 服务器运行之前解决。</p>\n<p>此外，可能希望避免使用 root 用户去启动服务，从而提高安全性，而在启动服务前还需要以 root 身份执行一些必要的准备工作，最后切换到服务用户身份启动服务。或者除了服务外，其它命令依旧可以使用 root 身份执行，方便调试等。</p>\n<p>这些准备工作是和容器 CMD 无关的，无论 CMD 为什么，都需要事先进行一个预处理的工作。这种情况下，可以写一个脚本，然后放入 ENTRYPOINT 中去执行，而这个脚本会将接到的参数（也就是 <code class="language-text">&lt;CMD&gt;</code>）作为命令，在脚本最后执行。比如官方镜像 redis 中就是这么做的：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="43025156630883820000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`FROM alpine:3.4\n...\nRUN addgroup -S redis && adduser -S -G redis redis\n...\nENTRYPOINT [&quot;docker-entrypoint.sh&quot;]\n\nEXPOSE 6379\nCMD [ &quot;redis-server&quot; ]`, `43025156630883820000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">FROM</span> alpine<span class="token punctuation">:</span>3.4\n<span class="token punctuation">...</span>\n<span class="token keyword">RUN</span> addgroup <span class="token punctuation">-</span>S redis &amp;&amp; adduser <span class="token punctuation">-</span>S <span class="token punctuation">-</span>G redis redis\n<span class="token punctuation">...</span>\n<span class="token keyword">ENTRYPOINT</span> <span class="token punctuation">[</span><span class="token string">"docker-entrypoint.sh"</span><span class="token punctuation">]</span>\n\n<span class="token keyword">EXPOSE</span> 6379\n<span class="token keyword">CMD</span> <span class="token punctuation">[</span> <span class="token string">"redis-server"</span> <span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以看到其中为了 redis 服务创建了 redis 用户，并在最后指定了 ENTRYPOINT 为 docker-entrypoint.sh 脚本。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="65170375732871545000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`#!/bin/sh\n...\n# allow the container to be started with \\`--user\\`\nif [ &quot;\\$1&quot; = \'redis-server\' -a &quot;\\$(id -u)&quot; = \'0\' ]; then\n   find . \\! -user redis -exec chown redis \'{}\' +\n   exec gosu redis &quot;\\$0&quot; &quot;\\$@&quot;\nfi\n\nexec &quot;\\$@&quot;`, `65170375732871545000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token shebang important">#!/bin/sh</span>\n<span class="token punctuation">..</span>.\n<span class="token comment"># allow the container to be started with `--user`</span>\n<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">"<span class="token variable">$1</span>"</span> <span class="token operator">=</span> <span class="token string">\'redis-server\'</span> -a <span class="token string">"<span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> -u<span class="token variable">)</span></span>"</span> <span class="token operator">=</span> <span class="token string">\'0\'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>\n   <span class="token function">find</span> <span class="token builtin class-name">.</span> <span class="token punctuation">\\</span><span class="token operator">!</span> -user redis -exec <span class="token function">chown</span> redis <span class="token string">\'{}\'</span> +\n   <span class="token builtin class-name">exec</span> gosu redis <span class="token string">"<span class="token variable">$0</span>"</span> <span class="token string">"<span class="token variable">$@</span>"</span>\n<span class="token keyword">fi</span>\n\n<span class="token builtin class-name">exec</span> <span class="token string">"<span class="token variable">$@</span>"</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>该脚本的内容就是根据 CMD 的内容来判断，如果是 redis-server 的话，则切换到 redis 用户身份启动服务器，否则依旧使用 root 身份执行。比如：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="63173824665320310000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run -it redis id\nuid=0(root) gid=0(root) groups=0(root)`, `63173824665320310000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run -it redis <span class="token function">id</span>\n<span class="token assign-left variable">uid</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span> <span class="token assign-left variable">gid</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span> <span class="token assign-left variable">groups</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<h2 id="env-设置环境变量"><a href="#env-%E8%AE%BE%E7%BD%AE%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ENV 设置环境变量</h2>\n<p>格式有两种：</p>\n<ul>\n<li><code class="language-text">ENV &lt;key&gt; &lt;value&gt;</code></li>\n<li><code class="language-text">ENV &lt;key1&gt;=&lt;value1&gt; &lt;key2&gt;=&lt;value2&gt;...</code></li>\n</ul>\n<p>这个指令很简单，就是设置环境变量而已，无论是后面的其它指令如 RUN，还是运行时的应用，都可以直接使用这里定义的环境变量。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="36874471130940090000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`ENV VERSION=1.0 DEBUG=on \\\n    NAME=&quot;Happy Feet&quot;`, `36874471130940090000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">ENV</span> VERSION=1.0 DEBUG=on \\\n    NAME=<span class="token string">"Happy Feet"</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>这个例子中演示了如何换行，以及对含有空格的值用双引号括起来的办法，这和 Shell 下的行为是一致的。</p>\n<p>定义了环境变量，那么在后续的指令中，就可以使用这个环境变量。比如在官方 node 镜像 Dockerfile 中，就有类似这样的代码：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="315287502202266100"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`ENV NODE_VERSION 7.2.0\n\nRUN curl -SLO &quot;https://nodejs.org/dist/v\\$NODE_VERSION/node-v\\$NODE_VERSION-linux-x64.tar.xz&quot; \\\n  && curl -SLO &quot;https://nodejs.org/dist/v\\$NODE_VERSION/SHASUMS256.txt.asc&quot; \\\n  && gpg --batch --decrypt --output SHASUMS256.txt SHASUMS256.txt.asc \\\n  && grep &quot; node-v\\$NODE_VERSION-linux-x64.tar.xz\\\\$&quot; SHASUMS256.txt | sha256sum -c - \\\n  && tar -xJf &quot;node-v\\$NODE_VERSION-linux-x64.tar.xz&quot; -C /usr/local --strip-components=1 \\\n  && rm &quot;node-v\\$NODE_VERSION-linux-x64.tar.xz&quot; SHASUMS256.txt.asc SHASUMS256.txt \\\n  && ln -s /usr/local/bin/node /usr/local/bin/nodejs`, `315287502202266100`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">ENV</span> NODE_VERSION 7.2.0\n\n<span class="token keyword">RUN</span> curl <span class="token punctuation">-</span>SLO <span class="token string">"https://nodejs.org/dist/v$NODE_VERSION/node-v$NODE_VERSION-linux-x64.tar.xz"</span> \\\n  &amp;&amp; curl <span class="token punctuation">-</span>SLO <span class="token string">"https://nodejs.org/dist/v$NODE_VERSION/SHASUMS256.txt.asc"</span> \\\n  &amp;&amp; gpg <span class="token punctuation">-</span><span class="token punctuation">-</span>batch <span class="token punctuation">-</span><span class="token punctuation">-</span>decrypt <span class="token punctuation">-</span><span class="token punctuation">-</span>output SHASUMS256.txt SHASUMS256.txt.asc \\\n  &amp;&amp; grep <span class="token string">" node-v$NODE_VERSION-linux-x64.tar.xz\\$"</span> SHASUMS256.txt <span class="token punctuation">|</span> sha256sum <span class="token punctuation">-</span>c <span class="token punctuation">-</span> \\\n  &amp;&amp; tar <span class="token punctuation">-</span>xJf <span class="token string">"node-v$NODE_VERSION-linux-x64.tar.xz"</span> <span class="token punctuation">-</span>C /usr/local <span class="token punctuation">-</span><span class="token punctuation">-</span>strip<span class="token punctuation">-</span>components=1 \\\n  &amp;&amp; rm <span class="token string">"node-v$NODE_VERSION-linux-x64.tar.xz"</span> SHASUMS256.txt.asc SHASUMS256.txt \\\n  &amp;&amp; ln <span class="token punctuation">-</span>s /usr/local/bin/node /usr/local/bin/nodejs</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在这里先定义了环境变量 <code class="language-text">NODE_VERSION</code>，其后的 RUN 这层里，多次使用 <code class="language-text">$NODE_VERSION</code> 来进行操作定制。可以看到，将来升级镜像构建版本的时候，只需要更新 7.2.0 即可，Dockerfile 构建维护变得更轻松了。</p>\n<p>下列指令可以支持环境变量展开：ADD、COPY、ENV、EXPOSE、FROM、LABEL、USER、WORKDIR、VOLUME、STOPSIGNAL、ONBUILD、RUN。</p>\n<p>可以从这个指令列表里感觉到，环境变量可以使用的地方很多，很强大。通过环境变量，我们可以让一份 Dockerfile 制作更多的镜像，只需使用不同的环境变量即可。</p>\n<h2 id="arg-构建参数"><a href="#arg-%E6%9E%84%E5%BB%BA%E5%8F%82%E6%95%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ARG 构建参数</h2>\n<p>格式：<code class="language-text">ARG &lt;参数名&gt;[=&lt;默认值&gt;]</code></p>\n<p>构建参数和 ENV 的效果一样，都是设置环境变量。所不同的是，ARG 所设置的构建环境的环境变量，在将来容器运行时是不会存在这些环境变量的。但是不要因此就使用 ARG 保存密码之类的信息，因为 docker history 还是可以看到所有值的。</p>\n<p>Dockerfile 中的 ARG 指令是定义参数名称，以及定义其默认值。该默认值可以在构建命令 docker build 中用 <code class="language-text">--build-arg &lt;参数名&gt;=&lt;值&gt;</code> 来覆盖。</p>\n<p>灵活的使用 ARG 指令，能够在不修改 Dockerfile 的情况下，构建出不同的镜像。</p>\n<p>ARG 指令有生效范围，如果在 FROM 指令之前指定，那么只能用于 FROM 指令中。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="52876199997652630000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`ARG DOCKER_USERNAME=library\n\nFROM \\${DOCKER_USERNAME}/alpine\n\nRUN set -x ; echo \\${DOCKER_USERNAME}`, `52876199997652630000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">ARG</span> DOCKER_USERNAME=library\n\n<span class="token keyword">FROM</span> $<span class="token punctuation">{</span>DOCKER_USERNAME<span class="token punctuation">}</span>/alpine\n\n<span class="token keyword">RUN</span> set <span class="token punctuation">-</span>x ; echo $<span class="token punctuation">{</span>DOCKER_USERNAME<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>使用上述 Dockerfile 会发现无法输出 <code class="language-text">${DOCKER_USERNAME}</code> 变量的值，要想正常输出，你必须在 FROM 之后再次指定 ARG</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="28835490677276975000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# 只在 FROM 中生效\nARG DOCKER_USERNAME=library\n\nFROM \\${DOCKER_USERNAME}/alpine\n\n# 要想在 FROM 之后使用，必须再次指定\nARG DOCKER_USERNAME=library\n\nRUN set -x ; echo \\${DOCKER_USERNAME}`, `28835490677276975000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token comment"># 只在 FROM 中生效</span>\n<span class="token keyword">ARG</span> DOCKER_USERNAME=library\n\n<span class="token keyword">FROM</span> $<span class="token punctuation">{</span>DOCKER_USERNAME<span class="token punctuation">}</span>/alpine\n\n<span class="token comment"># 要想在 FROM 之后使用，必须再次指定</span>\n<span class="token keyword">ARG</span> DOCKER_USERNAME=library\n\n<span class="token keyword">RUN</span> set <span class="token punctuation">-</span>x ; echo $<span class="token punctuation">{</span>DOCKER_USERNAME<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>对于多阶段构建，尤其要注意这个问题</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="29685949419609360000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# 这个变量在每个 FROM 中都生效\nARG DOCKER_USERNAME=library\n\nFROM \\${DOCKER_USERNAME}/alpine\n\nRUN set -x ; echo 1\n\nFROM \\${DOCKER_USERNAME}/alpine\n\nRUN set -x ; echo 2`, `29685949419609360000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token comment"># 这个变量在每个 FROM 中都生效</span>\n<span class="token keyword">ARG</span> DOCKER_USERNAME=library\n\n<span class="token keyword">FROM</span> $<span class="token punctuation">{</span>DOCKER_USERNAME<span class="token punctuation">}</span>/alpine\n\n<span class="token keyword">RUN</span> set <span class="token punctuation">-</span>x ; echo 1\n\n<span class="token keyword">FROM</span> $<span class="token punctuation">{</span>DOCKER_USERNAME<span class="token punctuation">}</span>/alpine\n\n<span class="token keyword">RUN</span> set <span class="token punctuation">-</span>x ; echo 2</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>对于上述 Dockerfile 两个 FROM 指令都可以使用 <code class="language-text">${DOCKER_USERNAME}</code>，对于在各个阶段中使用的变量都必须在每个阶段分别指定：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="39104507957975820000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`ARG DOCKER_USERNAME=library\n\nFROM \\${DOCKER_USERNAME}/alpine\n\n# 在 FROM 之后使用变量，必须在每个阶段分别指定\nARG DOCKER_USERNAME=library\n\nRUN set -x ; echo \\${DOCKER_USERNAME}\n\nFROM \\${DOCKER_USERNAME}/alpine\n\n# 在 FROM 之后使用变量，必须在每个阶段分别指定\nARG DOCKER_USERNAME=library\n\nRUN set -x ; echo \\${DOCKER_USERNAME}`, `39104507957975820000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">ARG</span> DOCKER_USERNAME=library\n\n<span class="token keyword">FROM</span> $<span class="token punctuation">{</span>DOCKER_USERNAME<span class="token punctuation">}</span>/alpine\n\n<span class="token comment"># 在 FROM 之后使用变量，必须在每个阶段分别指定</span>\n<span class="token keyword">ARG</span> DOCKER_USERNAME=library\n\n<span class="token keyword">RUN</span> set <span class="token punctuation">-</span>x ; echo $<span class="token punctuation">{</span>DOCKER_USERNAME<span class="token punctuation">}</span>\n\n<span class="token keyword">FROM</span> $<span class="token punctuation">{</span>DOCKER_USERNAME<span class="token punctuation">}</span>/alpine\n\n<span class="token comment"># 在 FROM 之后使用变量，必须在每个阶段分别指定</span>\n<span class="token keyword">ARG</span> DOCKER_USERNAME=library\n\n<span class="token keyword">RUN</span> set <span class="token punctuation">-</span>x ; echo $<span class="token punctuation">{</span>DOCKER_USERNAME<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="volume-定义匿名卷"><a href="#volume-%E5%AE%9A%E4%B9%89%E5%8C%BF%E5%90%8D%E5%8D%B7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>VOLUME 定义匿名卷</h2>\n<p>格式为：</p>\n<ul>\n<li><code class="language-text">VOLUME [&quot;&lt;路径 1&gt;&quot;, &quot;&lt;路径 2&gt;&quot;...]</code></li>\n<li><code class="language-text">VOLUME &lt;路径&gt;</code></li>\n</ul>\n<p>之前我们说过，容器运行时应该尽量保持容器存储层不发生写操作，对于数据库类需要保存动态数据的应用，其数据库文件应该保存于卷(volume)中，后面的章节我们会进一步介绍 Docker 卷的概念。为了防止运行时用户忘记将动态文件所保存目录挂载为卷，在 Dockerfile 中，我们可以事先指定某些目录挂载为匿名卷，这样在运行时如果用户不指定挂载，其应用也可以正常运行，不会向容器存储层写入大量数据。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="43839509374118850000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`VOLUME /data`, `43839509374118850000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">VOLUME</span> /data</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>这里的 /data 目录就会在容器运行时自动挂载为匿名卷，任何向 /data 中写入的信息都不会记录进容器存储层，从而保证了容器存储层的无状态化。当然，运行容器时可以覆盖这个挂载设置。比如：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="21202011808579346000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run -d -v mydata:/data xxxx`, `21202011808579346000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile">$ docker run <span class="token punctuation">-</span>d <span class="token punctuation">-</span>v mydata<span class="token punctuation">:</span>/data xxxx</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>在这行命令中，就使用了 mydata 这个命名卷挂载到了 /data 这个位置，替代了 Dockerfile 中定义的匿名卷的挂载配置。</p>\n<h2 id="expose-声明端口"><a href="#expose-%E5%A3%B0%E6%98%8E%E7%AB%AF%E5%8F%A3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>EXPOSE 声明端口</h2>\n<p>格式为 <code class="language-text">EXPOSE &lt;端口1&gt; [&lt;端口2&gt;...]</code>。</p>\n<p>EXPOSE 指令是声明容器运行时提供服务的端口，这只是一个声明，在容器运行时并不会因为这个声明应用就会开启这个端口的服务。在 Dockerfile 中写入这样的声明有两个好处，一个是帮助镜像使用者理解这个镜像服务的守护端口，以方便配置映射；另一个用处则是在运行时使用随机端口映射时，也就是 <code class="language-text">docker run -P</code> 时，会自动随机映射 EXPOSE 的端口。</p>\n<p>要将 EXPOSE 和在运行时使用 <code class="language-text">-p &lt;宿主端口&gt;:&lt;容器端口&gt;</code> 区分开来。-p，是映射宿主端口和容器端口，换句话说，就是将容器的对应端口服务公开给外界访问，而 EXPOSE 仅仅是声明容器打算使用什么端口而已，并不会自动在宿主进行端口映射。</p>\n<h2 id="workdir-指定工作目录"><a href="#workdir-%E6%8C%87%E5%AE%9A%E5%B7%A5%E4%BD%9C%E7%9B%AE%E5%BD%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>WORKDIR 指定工作目录</h2>\n<p>格式为 <code class="language-text">WORKDIR &lt;工作目录路径&gt;</code>。</p>\n<p>使用 WORKDIR 指令可以来指定工作目录（或者称为当前目录），以后各层的当前目录就被改为指定的目录，如该目录不存在，WORKDIR 会帮你建立目录。</p>\n<p>之前提到一些初学者常犯的错误是把 Dockerfile 等同于 Shell 脚本来书写，这种错误的理解还可能会导致出现下面这样的错误：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="11755824875262544000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`RUN cd /app\nRUN echo &quot;hello&quot; > world.txt`, `11755824875262544000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">RUN</span> cd /app\n<span class="token keyword">RUN</span> echo <span class="token string">"hello"</span> <span class="token punctuation">></span> world.txt</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>如果将这个 Dockerfile 进行构建镜像运行后，会发现找不到 <code class="language-text">/app/world.txt</code> 文件，或者其内容不是 hello。原因其实很简单，在 Shell 中，连续两行是同一个进程执行环境，因此前一个命令修改的内存状态，会直接影响后一个命令；而在 Dockerfile 中，这两行 RUN 命令的执行环境根本不同，是两个完全不同的容器。这就是对 Dockerfile 构建分层存储的概念不了解所导致的错误。</p>\n<p>之前说过每一个 RUN 都是启动一个容器、执行命令、然后提交存储层文件变更。第一层 <code class="language-text">RUN cd /app</code> 的执行仅仅是当前进程的工作目录变更，一个内存上的变化而已，其结果不会造成任何文件变更。而到第二层的时候，启动的是一个全新的容器，跟第一层的容器更完全没关系，自然不可能继承前一层构建过程中的内存变化。</p>\n<p>因此如果需要改变以后各层的工作目录的位置，那么应该使用 WORKDIR 指令。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="23452060416120180000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`WORKDIR /app\n\nRUN echo &quot;hello&quot; > world.txt`, `23452060416120180000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">WORKDIR</span> /app\n\n<span class="token keyword">RUN</span> echo <span class="token string">"hello"</span> <span class="token punctuation">></span> world.txt</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>如果你的 WORKDIR 指令使用的相对路径，那么所切换的路径与之前的 WORKDIR 有关：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="6292808999390353000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`WORKDIR /a\nWORKDIR b\nWORKDIR c\n\nRUN pwd`, `6292808999390353000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">WORKDIR</span> /a\n<span class="token keyword">WORKDIR</span> b\n<span class="token keyword">WORKDIR</span> c\n\n<span class="token keyword">RUN</span> pwd</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>RUN pwd 的工作目录为 /a/b/c。</p>\n<h2 id="user-指定当前用户"><a href="#user-%E6%8C%87%E5%AE%9A%E5%BD%93%E5%89%8D%E7%94%A8%E6%88%B7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>USER 指定当前用户</h2>\n<p>格式：<code class="language-text">USER &lt;用户名&gt;[:&lt;用户组&gt;]</code></p>\n<p>USER 指令和 WORKDIR 相似，都是改变环境状态并影响以后的层。WORKDIR 是改变工作目录，USER 则是改变之后层的执行 RUN, CMD 以及 ENTRYPOINT 这类命令的身份。</p>\n<p>注意，USER 只是帮助你切换到指定用户而已，这个用户必须是事先建立好的，否则无法切换。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="17973511359420800000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`RUN groupadd -r redis && useradd -r -g redis redis\nUSER redis\nRUN [ &quot;redis-server&quot; ]`, `17973511359420800000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">RUN</span> groupadd <span class="token punctuation">-</span>r redis &amp;&amp; useradd <span class="token punctuation">-</span>r <span class="token punctuation">-</span>g redis redis\n<span class="token keyword">USER</span> redis\n<span class="token keyword">RUN</span> <span class="token punctuation">[</span> <span class="token string">"redis-server"</span> <span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>如果以 root 执行的脚本，在执行期间希望改变身份，比如希望以某个已经建立好的用户来运行某个服务进程，不要使用 su 或者 sudo，这些都需要比较麻烦的配置，而且在 TTY 缺失的环境下经常出错。建议使用 gosu。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="10997081175879030000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# 建立 redis 用户，并使用 gosu 换另一个用户执行命令\nRUN groupadd -r redis && useradd -r -g redis redis\n# 下载 gosu\nRUN wget -O /usr/local/bin/gosu &quot;https://github.com/tianon/gosu/releases/download/1.12/gosu-amd64&quot; \\\n    && chmod +x /usr/local/bin/gosu \\\n    && gosu nobody true\n# 设置 CMD，并以另外的用户执行\nCMD [ &quot;exec&quot;, &quot;gosu&quot;, &quot;redis&quot;, &quot;redis-server&quot; ]`, `10997081175879030000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token comment"># 建立 redis 用户，并使用 gosu 换另一个用户执行命令</span>\n<span class="token keyword">RUN</span> groupadd <span class="token punctuation">-</span>r redis &amp;&amp; useradd <span class="token punctuation">-</span>r <span class="token punctuation">-</span>g redis redis\n<span class="token comment"># 下载 gosu</span>\n<span class="token keyword">RUN</span> wget <span class="token punctuation">-</span>O /usr/local/bin/gosu <span class="token string">"https://github.com/tianon/gosu/releases/download/1.12/gosu-amd64"</span> \\\n    &amp;&amp; chmod +x /usr/local/bin/gosu \\\n    &amp;&amp; gosu nobody true\n<span class="token comment"># 设置 CMD，并以另外的用户执行</span>\n<span class="token keyword">CMD</span> <span class="token punctuation">[</span> <span class="token string">"exec"</span><span class="token punctuation">,</span> <span class="token string">"gosu"</span><span class="token punctuation">,</span> <span class="token string">"redis"</span><span class="token punctuation">,</span> <span class="token string">"redis-server"</span> <span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="healthcheck-健康检查"><a href="#healthcheck-%E5%81%A5%E5%BA%B7%E6%A3%80%E6%9F%A5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>HEALTHCHECK 健康检查</h2>\n<p>格式：</p>\n<ul>\n<li><code class="language-text">HEALTHCHECK [选项] CMD &lt;命令&gt;</code>：设置检查容器健康状况的命令</li>\n<li><code class="language-text">HEALTHCHECK NONE</code>：如果基础镜像有健康检查指令，使用这行可以屏蔽掉其健康检查指令</li>\n</ul>\n<p>HEALTHCHECK 指令是告诉 Docker 应该如何进行判断容器的状态是否正常，这是 Docker 1.12 引入的新指令。</p>\n<p>在没有 HEALTHCHECK 指令前，Docker 引擎只可以通过容器内主进程是否退出来判断容器是否状态异常。很多情况下这没问题，但是如果程序进入死锁状态，或者死循环状态，应用进程并不退出，但是该容器已经无法提供服务了。在 1.12 以前，Docker 不会检测到容器的这种状态，从而不会重新调度，导致可能会有部分容器已经无法提供服务了却还在接受用户请求。</p>\n<p>而自 1.12 之后，Docker 提供了 HEALTHCHECK 指令，通过该指令指定一行命令，用这行命令来判断容器主进程的服务状态是否还正常，从而比较真实的反应容器实际状态。</p>\n<p>当在一个镜像指定了 HEALTHCHECK 指令后，用其启动容器，初始状态会为 starting，在 HEALTHCHECK 指令检查成功后变为 healthy，如果连续一定次数失败，则会变为 unhealthy。</p>\n<p>HEALTHCHECK 支持下列选项：</p>\n<ul>\n<li><code class="language-text">--interval=&lt;间隔&gt;</code>：两次健康检查的间隔，默认为 30 秒；</li>\n<li><code class="language-text">--timeout=&lt;时长&gt;</code>：健康检查命令运行超时时间，如果超过这个时间，本次健康检查就被视为失败，默认 30 秒；</li>\n<li><code class="language-text">--retries=&lt;次数&gt;</code>：当连续失败指定次数后，则将容器状态视为 unhealthy，默认 3 次。</li>\n</ul>\n<p>和 CMD, ENTRYPOINT 一样，HEALTHCHECK 只可以出现一次，如果写了多个，只有最后一个生效。</p>\n<p>在 <code class="language-text">HEALTHCHECK [选项] CMD</code> 后面的命令，格式和 ENTRYPOINT 一样，分为 shell 格式，和 exec 格式。命令的返回值决定了该次健康检查的成功与否：0：成功；1：失败；2：保留，不要使用这个值。</p>\n<p>假设我们有个镜像是个最简单的 Web 服务，我们希望增加健康检查来判断其 Web 服务是否在正常工作，我们可以用 curl 来帮助判断，其 Dockerfile 的 HEALTHCHECK 可以这么写：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="98202117235462800000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`FROM nginx\nRUN apt-get update && apt-get install -y curl && rm -rf /var/lib/apt/lists/*\nHEALTHCHECK --interval=5s --timeout=3s \\\n  CMD curl -fs http://localhost/ || exit 1`, `98202117235462800000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">FROM</span> nginx\n<span class="token keyword">RUN</span> apt<span class="token punctuation">-</span>get update &amp;&amp; apt<span class="token punctuation">-</span>get install <span class="token punctuation">-</span>y curl &amp;&amp; rm <span class="token punctuation">-</span>rf /var/lib/apt/lists/*\n<span class="token keyword">HEALTHCHECK</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>interval=5s <span class="token punctuation">-</span><span class="token punctuation">-</span>timeout=3s \\\n  <span class="token keyword">CMD</span> curl <span class="token punctuation">-</span>fs http<span class="token punctuation">:</span>//localhost/ <span class="token punctuation">|</span><span class="token punctuation">|</span> exit 1</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这里我们设置了每 5 秒检查一次（这里为了试验所以间隔非常短，实际应该相对较长），如果健康检查命令超过 3 秒没响应就视为失败，并且使用 curl -fs <a href="http://localhost/" target="_blank" rel="nofollow noreferrer noopener">http://localhost/</a> || exit 1 作为健康检查命令。</p>\n<p>使用 docker build 来构建这个镜像：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="3354057973019753000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker build -t myweb:v1 .`, `3354057973019753000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker build -t myweb:v1 <span class="token builtin class-name">.</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>构建好了后，我们启动一个容器：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="59189159022944530000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run -d --name web -p 80:80 myweb:v1`, `59189159022944530000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run -d --name web -p <span class="token number">80</span>:80 myweb:v1</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>当运行该镜像后，可以通过 <code class="language-text">docker container ls</code> 看到最初的状态为 (health: starting)：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="48190248557424000000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker container ls\nCONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS                            PORTS               NAMES\n03e28eb00bd0        myweb:v1            &quot;nginx -g \'daemon off&quot;   3 seconds ago       Up 2 seconds (health: starting)   80/tcp, 443/tcp     web`, `48190248557424000000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker container <span class="token function">ls</span>\nCONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS                            PORTS               NAMES\n03e28eb00bd0        myweb:v1            <span class="token string">"nginx -g \'daemon off"</span>   <span class="token number">3</span> seconds ago       Up <span class="token number">2</span> seconds <span class="token punctuation">(</span>health: starting<span class="token punctuation">)</span>   <span class="token number">80</span>/tcp, <span class="token number">443</span>/tcp     web</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>在等待几秒钟后，再次 docker container ls，就会看到健康状态变化为了 (healthy)：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="12166330475373498000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker container ls\nCONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS                    PORTS               NAMES\n03e28eb00bd0        myweb:v1            &quot;nginx -g \'daemon off&quot;   18 seconds ago      Up 16 seconds (healthy)   80/tcp, 443/tcp     web`, `12166330475373498000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker container <span class="token function">ls</span>\nCONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS                    PORTS               NAMES\n03e28eb00bd0        myweb:v1            <span class="token string">"nginx -g \'daemon off"</span>   <span class="token number">18</span> seconds ago      Up <span class="token number">16</span> seconds <span class="token punctuation">(</span>healthy<span class="token punctuation">)</span>   <span class="token number">80</span>/tcp, <span class="token number">443</span>/tcp     web</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>如果健康检查连续失败超过了重试次数，状态就会变为 (unhealthy)。</p>\n<p>为了帮助排障，健康检查命令的输出（包括 stdout 以及 stderr）都会被存储于健康状态里，可以用 docker inspect 来查看。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="38977244326399260000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker inspect --format \'{{json .State.Health}}\' web | python -m json.tool\n{\n    &quot;FailingStreak&quot;: 0,\n    &quot;Log&quot;: [\n        {\n            &quot;End&quot;: &quot;2016-11-25T14:35:37.940957051Z&quot;,\n            &quot;ExitCode&quot;: 0,\n            &quot;Output&quot;: &quot;<!DOCTYPE html>\\n<html>\\n<head>\\n<title>Welcome to nginx!</title>\\n<style>\\n    body {\\n        width: 35em;\\n        margin: 0 auto;\\n        font-family: Tahoma, Verdana, Arial, sans-serif;\\n    }\\n</style>\\n</head>\\n<body>\\n<h1>Welcome to nginx!</h1>\\n<p>If you see this page, the nginx web server is successfully installed and\\nworking. Further configuration is required.</p>\\n\\n<p>For online documentation and support please refer to\\n<a href=\\&quot;http://nginx.org/\\&quot;>nginx.org</a>.<br/>\\nCommercial support is available at\\n<a href=\\&quot;http://nginx.com/\\&quot;>nginx.com</a>.</p>\\n\\n<p><em>Thank you for using nginx.</em></p>\\n</body>\\n</html>\\n&quot;,\n            &quot;Start&quot;: &quot;2016-11-25T14:35:37.780192565Z&quot;\n        }\n    ],\n    &quot;Status&quot;: &quot;healthy&quot;\n}`, `38977244326399260000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker inspect --format <span class="token string">\'{{json .State.Health}}\'</span> web <span class="token operator">|</span> python -m json.tool\n<span class="token punctuation">{</span>\n    <span class="token string">"FailingStreak"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>,\n    <span class="token string">"Log"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>\n        <span class="token punctuation">{</span>\n            <span class="token string">"End"</span><span class="token builtin class-name">:</span> <span class="token string">"2016-11-25T14:35:37.940957051Z"</span>,\n            <span class="token string">"ExitCode"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>,\n            <span class="token string">"Output"</span><span class="token builtin class-name">:</span> <span class="token string">"&lt;!DOCTYPE html><span class="token entity" title="\\n">\\n</span>&lt;html><span class="token entity" title="\\n">\\n</span>&lt;head><span class="token entity" title="\\n">\\n</span>&lt;title>Welcome to nginx!&lt;/title><span class="token entity" title="\\n">\\n</span>&lt;style><span class="token entity" title="\\n">\\n</span>    body {<span class="token entity" title="\\n">\\n</span>        width: 35em;<span class="token entity" title="\\n">\\n</span>        margin: 0 auto;<span class="token entity" title="\\n">\\n</span>        font-family: Tahoma, Verdana, Arial, sans-serif;<span class="token entity" title="\\n">\\n</span>    }<span class="token entity" title="\\n">\\n</span>&lt;/style><span class="token entity" title="\\n">\\n</span>&lt;/head><span class="token entity" title="\\n">\\n</span>&lt;body><span class="token entity" title="\\n">\\n</span>&lt;h1>Welcome to nginx!&lt;/h1><span class="token entity" title="\\n">\\n</span>&lt;p>If you see this page, the nginx web server is successfully installed and<span class="token entity" title="\\n">\\n</span>working. Further configuration is required.&lt;/p><span class="token entity" title="\\n">\\n</span><span class="token entity" title="\\n">\\n</span>&lt;p>For online documentation and support please refer to<span class="token entity" title="\\n">\\n</span>&lt;a href=<span class="token entity" title="\\&quot;">\\"</span>http://nginx.org/<span class="token entity" title="\\&quot;">\\"</span>>nginx.org&lt;/a>.&lt;br/><span class="token entity" title="\\n">\\n</span>Commercial support is available at<span class="token entity" title="\\n">\\n</span>&lt;a href=<span class="token entity" title="\\&quot;">\\"</span>http://nginx.com/<span class="token entity" title="\\&quot;">\\"</span>>nginx.com&lt;/a>.&lt;/p><span class="token entity" title="\\n">\\n</span><span class="token entity" title="\\n">\\n</span>&lt;p>&lt;em>Thank you for using nginx.&lt;/em>&lt;/p><span class="token entity" title="\\n">\\n</span>&lt;/body><span class="token entity" title="\\n">\\n</span>&lt;/html><span class="token entity" title="\\n">\\n</span>"</span>,\n            <span class="token string">"Start"</span><span class="token builtin class-name">:</span> <span class="token string">"2016-11-25T14:35:37.780192565Z"</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">]</span>,\n    <span class="token string">"Status"</span><span class="token builtin class-name">:</span> <span class="token string">"healthy"</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="label-指令"><a href="#label-%E6%8C%87%E4%BB%A4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>LABEL 指令</h2>\n<p>LABEL 指令用来给镜像以键值对的形式添加一些元数据（metadata）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="80946823188423300000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`LABEL <key>=<value> <key>=<value> <key>=<value> ...`, `80946823188423300000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">LABEL</span> &lt;key<span class="token punctuation">></span>=&lt;value<span class="token punctuation">></span> &lt;key<span class="token punctuation">></span>=&lt;value<span class="token punctuation">></span> &lt;key<span class="token punctuation">></span>=&lt;value<span class="token punctuation">></span> <span class="token punctuation">...</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>我们还可以用一些标签来申明镜像的作者、文档地址等：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="19645641635444530000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`LABEL org.opencontainers.image.authors=&quot;yeasy&quot;\n\nLABEL org.opencontainers.image.documentation=&quot;https://yeasy.gitbooks.io&quot;`, `19645641635444530000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">LABEL</span> org.opencontainers.image.authors=<span class="token string">"yeasy"</span>\n\n<span class="token keyword">LABEL</span> org.opencontainers.image.documentation=<span class="token string">"https://yeasy.gitbooks.io"</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>具体可以参考 <a href="https://github.com/opencontainers/image-spec/blob/master/annotations.md" target="_blank" rel="nofollow noreferrer noopener">https://github.com/opencontainers/image-spec/blob/master/annotations.md</a></p>\n<h2 id="shell-指令"><a href="#shell-%E6%8C%87%E4%BB%A4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>SHELL 指令</h2>\n<p>格式：<code class="language-text">SHELL [&quot;executable&quot;, &quot;parameters&quot;]</code></p>\n<p>SHELL 指令可以指定 <code class="language-text">RUN ENTRYPOINT CMD</code> 指令的 shell，Linux 中默认为 <code class="language-text">[&quot;/bin/sh&quot;, &quot;-c&quot;]</code></p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="53258930175577770000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`SHELL [&quot;/bin/sh&quot;, &quot;-c&quot;]\n\nRUN lll ; ls\n\nSHELL [&quot;/bin/sh&quot;, &quot;-cex&quot;]\n\nRUN lll ; ls`, `53258930175577770000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">SHELL</span> <span class="token punctuation">[</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span> <span class="token string">"-c"</span><span class="token punctuation">]</span>\n\n<span class="token keyword">RUN</span> lll ; ls\n\n<span class="token keyword">SHELL</span> <span class="token punctuation">[</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span> <span class="token string">"-cex"</span><span class="token punctuation">]</span>\n\n<span class="token keyword">RUN</span> lll ; ls</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>两个 RUN 运行同一命令，第二个 RUN 运行的命令会打印出每条命令并当遇到错误时退出。</p>\n<p>当 <code class="language-text">ENTRYPOINT CMD</code> 以 shell 格式指定时，SHELL 指令所指定的 shell 也会成为这两个指令的 shell</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="51881178270202690000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`SHELL [&quot;/bin/sh&quot;, &quot;-cex&quot;]\n\n# /bin/sh -cex &quot;nginx&quot;\nENTRYPOINT nginx\n\n\\`\\`\\`dockerfile\nSHELL [&quot;/bin/sh&quot;, &quot;-cex&quot;]\n\n# /bin/sh -cex &quot;nginx&quot;\nCMD nginx`, `51881178270202690000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">SHELL</span> <span class="token punctuation">[</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span> <span class="token string">"-cex"</span><span class="token punctuation">]</span>\n\n<span class="token comment"># /bin/sh -cex </span><span class="token string">"nginx"</span>\n<span class="token keyword">ENTRYPOINT</span> nginx\n\n```dockerfile\n<span class="token keyword">SHELL</span> <span class="token punctuation">[</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span> <span class="token string">"-cex"</span><span class="token punctuation">]</span>\n\n<span class="token comment"># /bin/sh -cex </span><span class="token string">"nginx"</span>\n<span class="token keyword">CMD</span> nginx</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="onbuild-为他人做嫁衣裳"><a href="#onbuild-%E4%B8%BA%E4%BB%96%E4%BA%BA%E5%81%9A%E5%AB%81%E8%A1%A3%E8%A3%B3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ONBUILD 为他人做嫁衣裳</h2>\n<p>格式：<code class="language-text">ONBUILD &lt;其它指令&gt;</code>。</p>\n<p>ONBUILD 是一个特殊的指令，它后面跟的是其它指令，比如 RUN, COPY 等，而这些指令，在当前镜像构建时并不会被执行。只有当以当前镜像为基础镜像，去构建下一级镜像的时候才会被执行。</p>\n<p>Dockerfile 中的其它指令都是为了定制当前镜像而准备的，唯有 ONBUILD 是为了帮助别人定制自己而准备的。</p>\n<p>假设我们要制作 Node.js 所写的应用的镜像。我们都知道 Node.js 使用 npm 进行包管理，所有依赖、配置、启动信息等会放到 package.json 文件里。在拿到程序代码后，需要先进行 npm install 才可以获得所有需要的依赖。然后就可以通过 npm start 来启动应用。因此，一般来说会这样写 Dockerfile：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="70479098117954830000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`FROM node:slim\nRUN mkdir /app\nWORKDIR /app\nCOPY ./package.json /app\nRUN [ &quot;npm&quot;, &quot;install&quot; ]\nCOPY . /app/\nCMD [ &quot;npm&quot;, &quot;start&quot; ]`, `70479098117954830000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">FROM</span> node<span class="token punctuation">:</span>slim\n<span class="token keyword">RUN</span> mkdir /app\n<span class="token keyword">WORKDIR</span> /app\n<span class="token keyword">COPY</span> ./package.json /app\n<span class="token keyword">RUN</span> <span class="token punctuation">[</span> <span class="token string">"npm"</span><span class="token punctuation">,</span> <span class="token string">"install"</span> <span class="token punctuation">]</span>\n<span class="token keyword">COPY</span> . /app/\n<span class="token keyword">CMD</span> <span class="token punctuation">[</span> <span class="token string">"npm"</span><span class="token punctuation">,</span> <span class="token string">"start"</span> <span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>把这个 Dockerfile 放到 Node.js 项目的根目录，构建好镜像后，就可以直接拿来启动容器运行。但是如果我们还有第二个 Node.js 项目也差不多呢？好吧，那就再把这个 Dockerfile 复制到第二个项目里。那如果有第三个项目呢？再复制么？文件的副本越多，版本控制就越困难，让我们继续看这样的场景维护的问题。</p>\n<p>如果第一个 Node.js 项目在开发过程中，发现这个 Dockerfile 里存在问题，比如敲错字了、或者需要安装额外的包，然后开发人员修复了这个 Dockerfile，再次构建，问题解决。第一个项目没问题了，但是第二个项目呢？虽然最初 Dockerfile 是复制、粘贴自第一个项目的，但是并不会因为第一个项目修复了他们的 Dockerfile，而第二个项目的 Dockerfile 就会被自动修复。</p>\n<p>那么我们可不可以做一个基础镜像，然后各个项目使用这个基础镜像呢？这样基础镜像更新，各个项目不用同步 Dockerfile 的变化，重新构建后就继承了基础镜像的更新？好吧，可以，让我们看看这样的结果。那么上面的这个 Dockerfile 就会变为：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="9115965558860828000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`FROM node:slim\nRUN mkdir /app\nWORKDIR /app\nCMD [ &quot;npm&quot;, &quot;start&quot; ]`, `9115965558860828000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">FROM</span> node<span class="token punctuation">:</span>slim\n<span class="token keyword">RUN</span> mkdir /app\n<span class="token keyword">WORKDIR</span> /app\n<span class="token keyword">CMD</span> <span class="token punctuation">[</span> <span class="token string">"npm"</span><span class="token punctuation">,</span> <span class="token string">"start"</span> <span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这里我们把项目相关的构建指令拿出来，放到子项目里去。假设这个基础镜像的名字为 my-node 的话，各个项目内的自己的 Dockerfile 就变为：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="6625976567507963000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`FROM my-node\nCOPY ./package.json /app\nRUN [ &quot;npm&quot;, &quot;install&quot; ]\nCOPY . /app/`, `6625976567507963000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">FROM</span> my<span class="token punctuation">-</span>node\n<span class="token keyword">COPY</span> ./package.json /app\n<span class="token keyword">RUN</span> <span class="token punctuation">[</span> <span class="token string">"npm"</span><span class="token punctuation">,</span> <span class="token string">"install"</span> <span class="token punctuation">]</span>\n<span class="token keyword">COPY</span> . /app/</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>基础镜像变化后，各个项目都用这个 Dockerfile 重新构建镜像，会继承基础镜像的更新。</p>\n<p>那么，问题解决了么？没有。准确说，只解决了一半。如果这个 Dockerfile 里面有些东西需要调整呢？比如 npm install 都需要加一些参数，那怎么办？这一行 RUN 是不可能放入基础镜像的，因为涉及到了当前项目的 <code class="language-text">./package.json</code>，难道又要一个个修改么？所以说，这样制作基础镜像，只解决了原来的 Dockerfile 的前 4 条指令的变化问题，而后面三条指令的变化则完全没办法处理。</p>\n<p>ONBUILD 可以解决这个问题。让我们用 ONBUILD 重新写一下基础镜像的 Dockerfile:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="52764327700002950000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`FROM node:slim\nRUN mkdir /app\nWORKDIR /app\nONBUILD COPY ./package.json /app\nONBUILD RUN [ &quot;npm&quot;, &quot;install&quot; ]\nONBUILD COPY . /app/\nCMD [ &quot;npm&quot;, &quot;start&quot; ]`, `52764327700002950000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">FROM</span> node<span class="token punctuation">:</span>slim\n<span class="token keyword">RUN</span> mkdir /app\n<span class="token keyword">WORKDIR</span> /app\n<span class="token keyword">ONBUILD</span> <span class="token keyword">COPY</span> ./package.json /app\n<span class="token keyword">ONBUILD</span> <span class="token keyword">RUN</span> <span class="token punctuation">[</span> <span class="token string">"npm"</span><span class="token punctuation">,</span> <span class="token string">"install"</span> <span class="token punctuation">]</span>\n<span class="token keyword">ONBUILD</span> <span class="token keyword">COPY</span> . /app/\n<span class="token keyword">CMD</span> <span class="token punctuation">[</span> <span class="token string">"npm"</span><span class="token punctuation">,</span> <span class="token string">"start"</span> <span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这次我们回到原始的 Dockerfile，但是这次将项目相关的指令加上 ONBUILD，这样在构建基础镜像的时候，这三行并不会被执行。然后各个项目的 Dockerfile 就变成了简单地：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="22843217114850734000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`FROM my-node`, `22843217114850734000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">FROM</span> my<span class="token punctuation">-</span>node</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>是的，只有这么一行。当在各个项目目录中，用这个只有一行的 Dockerfile 构建镜像时，之前基础镜像的那三行 ONBUILD 就会开始执行，成功的将当前项目的代码复制进镜像、并且针对本项目执行 npm install，生成应用镜像。</p>\n<h2 id="多阶段构建"><a href="#%E5%A4%9A%E9%98%B6%E6%AE%B5%E6%9E%84%E5%BB%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>多阶段构建</h2>\n<h3 id="之前的做法"><a href="#%E4%B9%8B%E5%89%8D%E7%9A%84%E5%81%9A%E6%B3%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>之前的做法</h3>\n<p>在 Docker 17.05 版本之前，我们构建 Docker 镜像时，通常会采用两种方式：</p>\n<h4 id="全部放入一个-dockerfile"><a href="#%E5%85%A8%E9%83%A8%E6%94%BE%E5%85%A5%E4%B8%80%E4%B8%AA-dockerfile" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>全部放入一个 Dockerfile</h4>\n<p>一种方式是将所有的构建过程包含在一个 Dockerfile 中，包括项目及其依赖库的编译、测试、打包等流程，这里可能会带来的一些问题：</p>\n<ul>\n<li>镜像层次多，镜像体积较大，部署时间变长</li>\n<li>源代码存在泄露的风险</li>\n</ul>\n<p>例如，编写 app.go 文件，该程序输出 Hello World!</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="42695784507090680000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`package main\n\nimport &quot;fmt&quot;\n\nfunc main(){\n    fmt.Printf(&quot;Hello World!&quot;);\n}`, `42695784507090680000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="go"\n              >\n                <span class="gatsby-code-button-language">go</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="go"><pre style="counter-reset: linenumber NaN" class="language-go line-numbers"><code class="language-go"><span class="token keyword">package</span> main\n\n<span class="token keyword">import</span> <span class="token string">"fmt"</span>\n\n<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>\n    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"Hello World!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>编写 Dockerfile.one 文件</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="40025206914179950000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`FROM golang:alpine\n\nRUN apk --no-cache add git ca-certificates\n\nWORKDIR /go/src/github.com/go/helloworld/\n\nCOPY app.go .\n\nRUN go get -d -v github.com/go-sql-driver/mysql \\\n  && CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo -o app . \\\n  && cp /go/src/github.com/go/helloworld/app /root\n\nWORKDIR /root/\n\nCMD [&quot;./app&quot;]`, `40025206914179950000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">FROM</span> golang<span class="token punctuation">:</span>alpine\n\n<span class="token keyword">RUN</span> apk <span class="token punctuation">-</span><span class="token punctuation">-</span>no<span class="token punctuation">-</span>cache add git ca<span class="token punctuation">-</span>certificates\n\n<span class="token keyword">WORKDIR</span> /go/src/github.com/go/helloworld/\n\n<span class="token keyword">COPY</span> app.go .\n\n<span class="token keyword">RUN</span> go get <span class="token punctuation">-</span>d <span class="token punctuation">-</span>v github.com/go<span class="token punctuation">-</span>sql<span class="token punctuation">-</span>driver/mysql \\\n  &amp;&amp; CGO_ENABLED=0 GOOS=linux go build <span class="token punctuation">-</span>a <span class="token punctuation">-</span>installsuffix cgo <span class="token punctuation">-</span>o app . \\\n  &amp;&amp; cp /go/src/github.com/go/helloworld/app /root\n\n<span class="token keyword">WORKDIR</span> /root/\n\n<span class="token keyword">CMD</span> <span class="token punctuation">[</span><span class="token string">"./app"</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>构建镜像</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="8291681493303815000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker build -t go/helloworld:1 -f Dockerfile.one .`, `8291681493303815000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker build -t go/helloworld:1 -f Dockerfile.one <span class="token builtin class-name">.</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h4 id="分散到多个-dockerfile"><a href="#%E5%88%86%E6%95%A3%E5%88%B0%E5%A4%9A%E4%B8%AA-dockerfile" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>分散到多个 Dockerfile</h4>\n<p>另一种方式，就是我们事先在一个 Dockerfile 将项目及其依赖库编译测试打包好后，再将其拷贝到运行环境中，这种方式需要我们编写两个 Dockerfile 和一些编译脚本才能将其两个阶段自动整合起来，这种方式虽然可以很好地规避第一种方式存在的风险，但明显部署过程较复杂。</p>\n<p>例如，编写 Dockerfile.build 文件</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="92241016338413000000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`FROM golang:alpine\n\nRUN apk --no-cache add git\n\nWORKDIR /go/src/github.com/go/helloworld\n\nCOPY app.go .\n\nRUN go get -d -v github.com/go-sql-driver/mysql \\\n  && CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo -o app .`, `92241016338413000000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">FROM</span> golang<span class="token punctuation">:</span>alpine\n\n<span class="token keyword">RUN</span> apk <span class="token punctuation">-</span><span class="token punctuation">-</span>no<span class="token punctuation">-</span>cache add git\n\n<span class="token keyword">WORKDIR</span> /go/src/github.com/go/helloworld\n\n<span class="token keyword">COPY</span> app.go .\n\n<span class="token keyword">RUN</span> go get <span class="token punctuation">-</span>d <span class="token punctuation">-</span>v github.com/go<span class="token punctuation">-</span>sql<span class="token punctuation">-</span>driver/mysql \\\n  &amp;&amp; CGO_ENABLED=0 GOOS=linux go build <span class="token punctuation">-</span>a <span class="token punctuation">-</span>installsuffix cgo <span class="token punctuation">-</span>o app .</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>编写 Dockerfile.copy 文件</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="56834772101825480000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`FROM alpine:latest\n\nRUN apk --no-cache add ca-certificates\n\nWORKDIR /root/\n\nCOPY app .\n\nCMD [&quot;./app&quot;]`, `56834772101825480000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">FROM</span> alpine<span class="token punctuation">:</span>latest\n\n<span class="token keyword">RUN</span> apk <span class="token punctuation">-</span><span class="token punctuation">-</span>no<span class="token punctuation">-</span>cache add ca<span class="token punctuation">-</span>certificates\n\n<span class="token keyword">WORKDIR</span> /root/\n\n<span class="token keyword">COPY</span> app .\n\n<span class="token keyword">CMD</span> <span class="token punctuation">[</span><span class="token string">"./app"</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>新建 build.sh</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="56991505387625456000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`#!/bin/sh\necho Building go/helloworld:build\n\ndocker build -t go/helloworld:build . -f Dockerfile.build\n\ndocker create --name extract go/helloworld:build\ndocker cp extract:/go/src/github.com/go/helloworld/app ./app\ndocker rm -f extract\n\necho Building go/helloworld:2\n\ndocker build --no-cache -t go/helloworld:2 . -f Dockerfile.copy\nrm ./app`, `56991505387625456000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token shebang important">#!/bin/sh</span>\n<span class="token builtin class-name">echo</span> Building go/helloworld:build\n\ndocker build -t go/helloworld:build <span class="token builtin class-name">.</span> -f Dockerfile.build\n\ndocker create --name extract go/helloworld:build\ndocker <span class="token function">cp</span> extract:/go/src/github.com/go/helloworld/app ./app\ndocker <span class="token function">rm</span> -f extract\n\n<span class="token builtin class-name">echo</span> Building go/helloworld:2\n\ndocker build --no-cache -t go/helloworld:2 <span class="token builtin class-name">.</span> -f Dockerfile.copy\n<span class="token function">rm</span> ./app</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在运行脚本即可构建镜像</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="52669460828334460000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ chmod +x build.sh\n\n\\$ ./build.sh`, `52669460828334460000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ <span class="token function">chmod</span> +x build.sh\n\n$ ./build.sh</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>对比两种方式生成的镜像大小</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="32023905571477828000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker image ls\n\nREPOSITORY      TAG    IMAGE ID        CREATED         SIZE\ngo/helloworld   2      f7cf3465432c    22 seconds ago  6.47MB\ngo/helloworld   1      f55d3e16affc    2 minutes ago   295MB`, `32023905571477828000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker image <span class="token function">ls</span>\n\nREPOSITORY      TAG    IMAGE ID        CREATED         SIZE\ngo/helloworld   <span class="token number">2</span>      f7cf3465432c    <span class="token number">22</span> seconds ago  <span class="token number">6</span>.47MB\ngo/helloworld   <span class="token number">1</span>      f55d3e16affc    <span class="token number">2</span> minutes ago   295MB</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="使用多阶段构建"><a href="#%E4%BD%BF%E7%94%A8%E5%A4%9A%E9%98%B6%E6%AE%B5%E6%9E%84%E5%BB%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用多阶段构建</h3>\n<p>为解决以上问题，Docker v17.05 开始支持多阶段构建 (multistage builds)。使用多阶段构建我们就可以很容易解决前面提到的问题，并且只需要编写一个 Dockerfile：</p>\n<p>例如，编写 Dockerfile 文件</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="72692276007583790000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`FROM golang:alpine as builder\n\nRUN apk --no-cache add git\n\nWORKDIR /go/src/github.com/go/helloworld/\n\nRUN go get -d -v github.com/go-sql-driver/mysql\n\nCOPY app.go .\n\nRUN CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo -o app .\n\nFROM alpine:latest as prod\n\nRUN apk --no-cache add ca-certificates\n\nWORKDIR /root/\n\nCOPY --from=0 /go/src/github.com/go/helloworld/app .\n\nCMD [&quot;./app&quot;]`, `72692276007583790000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">FROM</span> golang<span class="token punctuation">:</span>alpine as builder\n\n<span class="token keyword">RUN</span> apk <span class="token punctuation">-</span><span class="token punctuation">-</span>no<span class="token punctuation">-</span>cache add git\n\n<span class="token keyword">WORKDIR</span> /go/src/github.com/go/helloworld/\n\n<span class="token keyword">RUN</span> go get <span class="token punctuation">-</span>d <span class="token punctuation">-</span>v github.com/go<span class="token punctuation">-</span>sql<span class="token punctuation">-</span>driver/mysql\n\n<span class="token keyword">COPY</span> app.go .\n\n<span class="token keyword">RUN</span> CGO_ENABLED=0 GOOS=linux go build <span class="token punctuation">-</span>a <span class="token punctuation">-</span>installsuffix cgo <span class="token punctuation">-</span>o app .\n\n<span class="token keyword">FROM</span> alpine<span class="token punctuation">:</span>latest as prod\n\n<span class="token keyword">RUN</span> apk <span class="token punctuation">-</span><span class="token punctuation">-</span>no<span class="token punctuation">-</span>cache add ca<span class="token punctuation">-</span>certificates\n\n<span class="token keyword">WORKDIR</span> /root/\n\n<span class="token keyword">COPY</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>from=0 /go/src/github.com/go/helloworld/app .\n\n<span class="token keyword">CMD</span> <span class="token punctuation">[</span><span class="token string">"./app"</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>构建镜像</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="23208351863407084000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker build -t go/helloworld:3 .`, `23208351863407084000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker build -t go/helloworld:3 <span class="token builtin class-name">.</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>对比三个镜像大小</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="69339678368888455000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker image ls\n\nREPOSITORY        TAG   IMAGE ID         CREATED            SIZE\ngo/helloworld     3     d6911ed9c846     7 seconds ago      6.47MB\ngo/helloworld     2     f7cf3465432c     22 seconds ago     6.47MB\ngo/helloworld     1     f55d3e16affc     2 minutes ago      295MB`, `69339678368888455000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker image <span class="token function">ls</span>\n\nREPOSITORY        TAG   IMAGE ID         CREATED            SIZE\ngo/helloworld     <span class="token number">3</span>     d6911ed9c846     <span class="token number">7</span> seconds ago      <span class="token number">6</span>.47MB\ngo/helloworld     <span class="token number">2</span>     f7cf3465432c     <span class="token number">22</span> seconds ago     <span class="token number">6</span>.47MB\ngo/helloworld     <span class="token number">1</span>     f55d3e16affc     <span class="token number">2</span> minutes ago      295MB</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>很明显使用多阶段构建的镜像体积小，同时也完美解决了上边提到的问题。</p>\n<h4 id="只构建某一阶段的镜像"><a href="#%E5%8F%AA%E6%9E%84%E5%BB%BA%E6%9F%90%E4%B8%80%E9%98%B6%E6%AE%B5%E7%9A%84%E9%95%9C%E5%83%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>只构建某一阶段的镜像</h4>\n<p>我们可以使用 as 来为某一阶段命名，例如</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="59702331803473990000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`FROM golang:alpine as builder`, `59702331803473990000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">FROM</span> golang<span class="token punctuation">:</span>alpine as builder</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>例如当我们只想构建 builder 阶段的镜像时，增加 —target=builder 参数即可</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="368342891882456060"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker build --target builder -t username/imagename:tag .`, `368342891882456060`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile">$ docker build <span class="token punctuation">-</span><span class="token punctuation">-</span>target builder <span class="token punctuation">-</span>t username/imagename<span class="token punctuation">:</span>tag .</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h4 id="构建时从其他镜像复制文件"><a href="#%E6%9E%84%E5%BB%BA%E6%97%B6%E4%BB%8E%E5%85%B6%E4%BB%96%E9%95%9C%E5%83%8F%E5%A4%8D%E5%88%B6%E6%96%87%E4%BB%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>构建时从其他镜像复制文件</h4>\n<p>上面例子中我们使用 <code class="language-text">COPY --from=0 /go/src/github.com/go/helloworld/app .</code> 从上一阶段的镜像中复制文件，我们也可以复制任意镜像中的文件。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="86253625910806900000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ COPY --from=nginx:latest /etc/nginx/nginx.conf /nginx.conf`, `86253625910806900000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile">$ COPY <span class="token punctuation">-</span><span class="token punctuation">-</span>from=nginx<span class="token punctuation">:</span>latest /etc/nginx/nginx.conf /nginx.conf</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h2 id="构建多种系统架构支持的-docker-镜像----docker-manifest-命令详解"><a href="#%E6%9E%84%E5%BB%BA%E5%A4%9A%E7%A7%8D%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84%E6%94%AF%E6%8C%81%E7%9A%84-docker-%E9%95%9C%E5%83%8F----docker-manifest-%E5%91%BD%E4%BB%A4%E8%AF%A6%E8%A7%A3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>构建多种系统架构支持的 Docker 镜像 — docker manifest 命令详解</h2>\n<p>我们知道使用镜像创建一个容器，该镜像必须与 Docker 宿主机系统架构一致，例如 <code class="language-text">Linux x86_64</code> 架构的系统中只能使用 <code class="language-text">Linux x86_64</code> 的镜像创建容器。</p>\n<p>Windows、macOS 除外，其使用了 <code class="language-text">binfmt_misc</code> 提供了多种架构支持，在 Windows、macOS 系统上 (x86_64) 可以运行 arm 等其他架构的镜像。</p>\n<p>例如我们在 <code class="language-text">Linux x86_64</code> 中构建一个 <code class="language-text">username/test</code> 镜像。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="7107390243248091000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`FROM alpine\n\nCMD echo 1`, `7107390243248091000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">FROM</span> alpine\n\n<span class="token keyword">CMD</span> echo 1</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>构建镜像后推送到 Docker Hub，之后我们尝试在树莓派 Linux arm64v8 中使用这个镜像。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="27382967693173543000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run -it --rm username/test`, `27382967693173543000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run -it --rm username/test</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>可以发现这个镜像根本获取不到。</p>\n<p>要解决这个问题，通常采用的做法是通过镜像名区分不同系统架构的镜像，例如在 <code class="language-text">Linux x86_64</code> 和 <code class="language-text">Linux arm64v8</code> 分别构建 <code class="language-text">username/test</code> 和 <code class="language-text">username/arm64v8-test</code> 镜像。运行时使用对应架构的镜像即可。</p>\n<p>这样做显得很繁琐，那么有没有一种方法让 Docker 引擎根据系统架构自动拉取对应的镜像呢？</p>\n<p>我们发现在 <code class="language-text">Linux x86_64</code> 和 <code class="language-text">Linux arm64v8</code> 架构的计算机中分别使用 <code class="language-text">golang:alpine</code> 镜像运行容器 <code class="language-text">$ docker run golang:alpine go version</code> 时，容器能够正常的运行。</p>\n<p>这是什么原因呢？</p>\n<p>原因就是 <code class="language-text">golang:alpine</code> 官方镜像有一个 manifest 列表 (manifest list) 。</p>\n<p>当用户获取一个镜像时，Docker 引擎会首先查找该镜像是否有 manifest 列表，如果有的话 Docker 引擎会按照 Docker 运行环境（系统及架构）查找出对应镜像（例如 golang:alpine）。如果没有的话会直接获取镜像（例如上例中我们构建的 username/test）。</p>\n<p>我们可以使用 <code class="language-text">$ docker manifest inspect golang:alpine</code> 查看这个 manifest 列表的结构。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="36666831803947540000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker manifest inspect golang:alpine`, `36666831803947540000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker manifest inspect golang:alpine</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="54873458151296710000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`{\n  &quot;schemaVersion&quot;: 2,\n  &quot;mediaType&quot;: &quot;application/vnd.docker.distribution.manifest.list.v2+json&quot;,\n  &quot;manifests&quot;: [\n    {\n      &quot;mediaType&quot;: &quot;application/vnd.docker.distribution.manifest.v2+json&quot;,\n      &quot;size&quot;: 1365,\n      &quot;digest&quot;: &quot;sha256:5e28ac423243b187f464d635bcfe1e909f4a31c6c8bce51d0db0a1062bec9e16&quot;,\n      &quot;platform&quot;: {\n        &quot;architecture&quot;: &quot;amd64&quot;,\n        &quot;os&quot;: &quot;linux&quot;\n      }\n    },\n    {\n      &quot;mediaType&quot;: &quot;application/vnd.docker.distribution.manifest.v2+json&quot;,\n      &quot;size&quot;: 1365,\n      &quot;digest&quot;: &quot;sha256:2945c46e26c9787da884b4065d1de64cf93a3b81ead1b949843dda1fcd458bae&quot;,\n      &quot;platform&quot;: {\n        &quot;architecture&quot;: &quot;arm&quot;,\n        &quot;os&quot;: &quot;linux&quot;,\n        &quot;variant&quot;: &quot;v7&quot;\n      }\n    },\n    {\n      &quot;mediaType&quot;: &quot;application/vnd.docker.distribution.manifest.v2+json&quot;,\n      &quot;size&quot;: 1365,\n      &quot;digest&quot;: &quot;sha256:87fff60114fd3402d0c1a7ddf1eea1ded658f171749b57dc782fd33ee2d47b2d&quot;,\n      &quot;platform&quot;: {\n        &quot;architecture&quot;: &quot;arm64&quot;,\n        &quot;os&quot;: &quot;linux&quot;,\n        &quot;variant&quot;: &quot;v8&quot;\n      }\n    },\n    {\n      &quot;mediaType&quot;: &quot;application/vnd.docker.distribution.manifest.v2+json&quot;,\n      &quot;size&quot;: 1365,\n      &quot;digest&quot;: &quot;sha256:607b43f1d91144f82a9433764e85eb3ccf83f73569552a49bc9788c31b4338de&quot;,\n      &quot;platform&quot;: {\n        &quot;architecture&quot;: &quot;386&quot;,\n        &quot;os&quot;: &quot;linux&quot;\n      }\n    },\n    {\n      &quot;mediaType&quot;: &quot;application/vnd.docker.distribution.manifest.v2+json&quot;,\n      &quot;size&quot;: 1365,\n      &quot;digest&quot;: &quot;sha256:25ead0e21ed5e246ce31e274b98c09aaf548606788ef28eaf375dc8525064314&quot;,\n      &quot;platform&quot;: {\n        &quot;architecture&quot;: &quot;ppc64le&quot;,\n        &quot;os&quot;: &quot;linux&quot;\n      }\n    },\n    {\n      &quot;mediaType&quot;: &quot;application/vnd.docker.distribution.manifest.v2+json&quot;,\n      &quot;size&quot;: 1365,\n      &quot;digest&quot;: &quot;sha256:69f5907fa93ea591175b2c688673775378ed861eeb687776669a48692bb9754d&quot;,\n      &quot;platform&quot;: {\n        &quot;architecture&quot;: &quot;s390x&quot;,\n        &quot;os&quot;: &quot;linux&quot;\n      }\n    }\n  ]\n}`, `54873458151296710000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="json"\n              >\n                <span class="gatsby-code-button-language">json</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="json"><pre style="counter-reset: linenumber NaN" class="language-json line-numbers"><code class="language-json"><span class="token punctuation">{</span>\n  <span class="token property">"schemaVersion"</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>\n  <span class="token property">"mediaType"</span><span class="token operator">:</span> <span class="token string">"application/vnd.docker.distribution.manifest.list.v2+json"</span><span class="token punctuation">,</span>\n  <span class="token property">"manifests"</span><span class="token operator">:</span> <span class="token punctuation">[</span>\n    <span class="token punctuation">{</span>\n      <span class="token property">"mediaType"</span><span class="token operator">:</span> <span class="token string">"application/vnd.docker.distribution.manifest.v2+json"</span><span class="token punctuation">,</span>\n      <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">1365</span><span class="token punctuation">,</span>\n      <span class="token property">"digest"</span><span class="token operator">:</span> <span class="token string">"sha256:5e28ac423243b187f464d635bcfe1e909f4a31c6c8bce51d0db0a1062bec9e16"</span><span class="token punctuation">,</span>\n      <span class="token property">"platform"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n        <span class="token property">"architecture"</span><span class="token operator">:</span> <span class="token string">"amd64"</span><span class="token punctuation">,</span>\n        <span class="token property">"os"</span><span class="token operator">:</span> <span class="token string">"linux"</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token punctuation">{</span>\n      <span class="token property">"mediaType"</span><span class="token operator">:</span> <span class="token string">"application/vnd.docker.distribution.manifest.v2+json"</span><span class="token punctuation">,</span>\n      <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">1365</span><span class="token punctuation">,</span>\n      <span class="token property">"digest"</span><span class="token operator">:</span> <span class="token string">"sha256:2945c46e26c9787da884b4065d1de64cf93a3b81ead1b949843dda1fcd458bae"</span><span class="token punctuation">,</span>\n      <span class="token property">"platform"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n        <span class="token property">"architecture"</span><span class="token operator">:</span> <span class="token string">"arm"</span><span class="token punctuation">,</span>\n        <span class="token property">"os"</span><span class="token operator">:</span> <span class="token string">"linux"</span><span class="token punctuation">,</span>\n        <span class="token property">"variant"</span><span class="token operator">:</span> <span class="token string">"v7"</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token punctuation">{</span>\n      <span class="token property">"mediaType"</span><span class="token operator">:</span> <span class="token string">"application/vnd.docker.distribution.manifest.v2+json"</span><span class="token punctuation">,</span>\n      <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">1365</span><span class="token punctuation">,</span>\n      <span class="token property">"digest"</span><span class="token operator">:</span> <span class="token string">"sha256:87fff60114fd3402d0c1a7ddf1eea1ded658f171749b57dc782fd33ee2d47b2d"</span><span class="token punctuation">,</span>\n      <span class="token property">"platform"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n        <span class="token property">"architecture"</span><span class="token operator">:</span> <span class="token string">"arm64"</span><span class="token punctuation">,</span>\n        <span class="token property">"os"</span><span class="token operator">:</span> <span class="token string">"linux"</span><span class="token punctuation">,</span>\n        <span class="token property">"variant"</span><span class="token operator">:</span> <span class="token string">"v8"</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token punctuation">{</span>\n      <span class="token property">"mediaType"</span><span class="token operator">:</span> <span class="token string">"application/vnd.docker.distribution.manifest.v2+json"</span><span class="token punctuation">,</span>\n      <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">1365</span><span class="token punctuation">,</span>\n      <span class="token property">"digest"</span><span class="token operator">:</span> <span class="token string">"sha256:607b43f1d91144f82a9433764e85eb3ccf83f73569552a49bc9788c31b4338de"</span><span class="token punctuation">,</span>\n      <span class="token property">"platform"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n        <span class="token property">"architecture"</span><span class="token operator">:</span> <span class="token string">"386"</span><span class="token punctuation">,</span>\n        <span class="token property">"os"</span><span class="token operator">:</span> <span class="token string">"linux"</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token punctuation">{</span>\n      <span class="token property">"mediaType"</span><span class="token operator">:</span> <span class="token string">"application/vnd.docker.distribution.manifest.v2+json"</span><span class="token punctuation">,</span>\n      <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">1365</span><span class="token punctuation">,</span>\n      <span class="token property">"digest"</span><span class="token operator">:</span> <span class="token string">"sha256:25ead0e21ed5e246ce31e274b98c09aaf548606788ef28eaf375dc8525064314"</span><span class="token punctuation">,</span>\n      <span class="token property">"platform"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n        <span class="token property">"architecture"</span><span class="token operator">:</span> <span class="token string">"ppc64le"</span><span class="token punctuation">,</span>\n        <span class="token property">"os"</span><span class="token operator">:</span> <span class="token string">"linux"</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token punctuation">{</span>\n      <span class="token property">"mediaType"</span><span class="token operator">:</span> <span class="token string">"application/vnd.docker.distribution.manifest.v2+json"</span><span class="token punctuation">,</span>\n      <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">1365</span><span class="token punctuation">,</span>\n      <span class="token property">"digest"</span><span class="token operator">:</span> <span class="token string">"sha256:69f5907fa93ea591175b2c688673775378ed861eeb687776669a48692bb9754d"</span><span class="token punctuation">,</span>\n      <span class="token property">"platform"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n        <span class="token property">"architecture"</span><span class="token operator">:</span> <span class="token string">"s390x"</span><span class="token punctuation">,</span>\n        <span class="token property">"os"</span><span class="token operator">:</span> <span class="token string">"linux"</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">]</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以看出 manifest 列表中包含了不同系统架构所对应的镜像 digest 值，这样 Docker 就可以在不同的架构中使用相同的 manifest (例如 golang:alpine) 获取对应的镜像。</p>\n<p>下面介绍如何使用 <code class="language-text">$ docker manifest</code> 命令创建并推送 manifest 列表到 Docker Hub。</p>\n<h3 id="构建镜像-1"><a href="#%E6%9E%84%E5%BB%BA%E9%95%9C%E5%83%8F-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>构建镜像</h3>\n<p>首先在 <code class="language-text">Linux x86_64</code> 构建 <code class="language-text">username/x8664-test</code> 镜像。并在 <code class="language-text">Linux arm64v8</code> 中构建 <code class="language-text">username/arm64v8-test</code> 镜像，构建好之后推送到 Docker Hub。</p>\n<h3 id="创建-manifest-列表"><a href="#%E5%88%9B%E5%BB%BA-manifest-%E5%88%97%E8%A1%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>创建 manifest 列表</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="11903618975010599000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# \\$ docker manifest create MANIFEST_LIST MANIFEST [MANIFEST...]\n\\$ docker manifest create username/test \\\n      username/x8664-test \\\n      username/arm64v8-test`, `11903618975010599000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token comment"># $ docker manifest create MANIFEST_LIST MANIFEST [MANIFEST...]</span>\n$ docker manifest create username/test <span class="token punctuation">\\</span>\n      username/x8664-test <span class="token punctuation">\\</span>\n      username/arm64v8-test</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>当要修改一个 manifest 列表时，可以加入 -a 或 —amend 参数。</p>\n<h3 id="设置-manifest-列表"><a href="#%E8%AE%BE%E7%BD%AE-manifest-%E5%88%97%E8%A1%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>设置 manifest 列表</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="47122595618521145000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# \\$ docker manifest annotate [OPTIONS] MANIFEST_LIST MANIFEST\n\\$ docker manifest annotate username/test \\\n      username/x8664-test \\\n      --os linux --arch x86_64\n\n\\$ docker manifest annotate username/test \\\n      username/arm64v8-test \\\n      --os linux --arch arm64 --variant v8`, `47122595618521145000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token comment"># $ docker manifest annotate [OPTIONS] MANIFEST_LIST MANIFEST</span>\n$ docker manifest annotate username/test <span class="token punctuation">\\</span>\n      username/x8664-test <span class="token punctuation">\\</span>\n      --os linux --arch x86_64\n\n$ docker manifest annotate username/test <span class="token punctuation">\\</span>\n      username/arm64v8-test <span class="token punctuation">\\</span>\n      --os linux --arch arm64 --variant v8</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样就配置好了 manifest 列表。</p>\n<h3 id="查看-manifest-列表"><a href="#%E6%9F%A5%E7%9C%8B-manifest-%E5%88%97%E8%A1%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>查看 manifest 列表</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="52875468699658420000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker manifest inspect username/test`, `52875468699658420000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker manifest inspect username/test</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h3 id="推送-manifest-列表"><a href="#%E6%8E%A8%E9%80%81-manifest-%E5%88%97%E8%A1%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>推送 manifest 列表</h3>\n<p>最后我们可以将其推送到 Docker Hub。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="11389765851053734000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker manifest push username/test`, `11389765851053734000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker manifest push username/test</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h3 id="测试"><a href="#%E6%B5%8B%E8%AF%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>测试</h3>\n<p>我们在 <code class="language-text">Linux x86_64</code> <code class="language-text">Linux arm64v8</code> 中分别执行 <code class="language-text">$ docker run -it --rm username/test</code> 命令，发现可以正确的执行。</p>\n<h1 id="操作容器"><a href="#%E6%93%8D%E4%BD%9C%E5%AE%B9%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>操作容器</h1>\n<p>容器是 Docker 又一核心概念。</p>\n<p>简单的说，容器是独立运行的一个或一组应用，以及它们的运行态环境。对应的，虚拟机可以理解为模拟运行的一整套操作系统（提供了运行态环境和其他系统环境）和跑在上面的应用。</p>\n<p>本章将具体介绍如何来管理一个容器，包括创建、启动和停止等。</p>\n<h2 id="启动容器"><a href="#%E5%90%AF%E5%8A%A8%E5%AE%B9%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>启动容器</h2>\n<p>启动容器有两种方式，一种是基于镜像新建一个容器并启动，另外一个是将在终止状态（exited）的容器重新启动。</p>\n<p>因为 Docker 的容器实在太轻量级了，很多时候用户都是随时删除和新创建容器。</p>\n<h3 id="新建并启动"><a href="#%E6%96%B0%E5%BB%BA%E5%B9%B6%E5%90%AF%E5%8A%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>新建并启动</h3>\n<p>所需要的命令主要为 docker run。</p>\n<p>例如，下面的命令输出一个 “Hello World”，之后终止容器。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="51064739469552010000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run ubuntu:18.04 /bin/echo \'Hello world\'\nHello world`, `51064739469552010000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run ubuntu:18.04 /bin/echo <span class="token string">\'Hello world\'</span>\nHello world</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>这跟在本地直接执行 <code class="language-text">/bin/echo &#39;hello world&#39;</code> 几乎感觉不出任何区别。</p>\n<p>下面的命令则启动一个 bash 终端，允许用户进行交互。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="73920316809208450000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run -t -i ubuntu:18.04 /bin/bash\nroot@af8bae53bdd3:/#`, `73920316809208450000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run -t -i ubuntu:18.04 /bin/bash\nroot@af8bae53bdd3:/<span class="token comment">#</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>其中，<code class="language-text">-t</code> 选项让 Docker 分配一个伪终端（pseudo-tty）并绑定到容器的标准输入上，<code class="language-text">-i</code> 则让容器的标准输入保持打开。</p>\n<p>在交互模式下，用户可以通过所创建的终端来输入命令，例如</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="15695775590960360000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`root@af8bae53bdd3:/# pwd\n/\nroot@af8bae53bdd3:/# ls\nbin boot dev etc home lib lib64 media mnt opt proc root run sbin srv sys tmp usr var`, `15695775590960360000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">root@af8bae53bdd3:/<span class="token comment"># pwd</span>\n/\nroot@af8bae53bdd3:/<span class="token comment"># ls</span>\nbin boot dev etc home lib lib64 media mnt opt proc root run sbin srv sys tmp usr var</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>当利用 docker run 来创建容器时，Docker 在后台运行的标准操作包括：</p>\n<ul>\n<li>检查本地是否存在指定的镜像，不存在就从 registry 下载</li>\n<li>利用镜像创建并启动一个容器</li>\n<li>分配一个文件系统，并在只读的镜像层外面挂载一层可读写层</li>\n<li>从宿主主机配置的网桥接口中桥接一个虚拟接口到容器中去</li>\n<li>从地址池配置一个 ip 地址给容器</li>\n<li>执行用户指定的应用程序</li>\n<li>执行完毕后容器被终止</li>\n</ul>\n<h3 id="启动已终止容器"><a href="#%E5%90%AF%E5%8A%A8%E5%B7%B2%E7%BB%88%E6%AD%A2%E5%AE%B9%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>启动已终止容器</h3>\n<p>可以利用 <code class="language-text">docker container start</code> 命令，直接将一个已经终止（exited）的容器启动运行。</p>\n<p>容器的核心为所执行的应用程序，所需要的资源都是应用程序运行所必需的。除此之外，并没有其它的资源。可以在伪终端中利用 ps 或 top 来查看进程信息。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="78178514617559650000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`root@ba267838cc1b:/# ps\n  PID TTY          TIME CMD\n    1 ?        00:00:00 bash\n   11 ?        00:00:00 ps`, `78178514617559650000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">root@ba267838cc1b:/<span class="token comment"># ps</span>\n  PID TTY          TIME CMD\n    <span class="token number">1</span> ?        00:00:00 <span class="token function">bash</span>\n   <span class="token number">11</span> ?        00:00:00 <span class="token function">ps</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可见，容器中仅运行了指定的 bash 应用。这种特点使得 Docker 对资源的利用率极高，是货真价实的轻量级虚拟化。</p>\n<h2 id="后台运行"><a href="#%E5%90%8E%E5%8F%B0%E8%BF%90%E8%A1%8C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>后台运行</h2>\n<p>更多的时候，需要让 Docker 在后台运行而不是直接把执行命令的结果输出在当前宿主机下。此时，可以通过添加 <code class="language-text">-d</code> 参数来实现。</p>\n<p>下面举两个例子来说明一下。</p>\n<p>如果不使用 <code class="language-text">-d</code> 参数运行容器。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="60855615114008740000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run ubuntu:18.04 /bin/sh -c &quot;while true; do echo hello world; sleep 1; done&quot;\nhello world\nhello world\nhello world\nhello world`, `60855615114008740000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run ubuntu:18.04 /bin/sh -c <span class="token string">"while true; do echo hello world; sleep 1; done"</span>\nhello world\nhello world\nhello world\nhello world</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>容器会把输出的结果 (STDOUT) 打印到宿主机上面</p>\n<p>如果使用了 <code class="language-text">-d</code> 参数运行容器。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="60381859145971980000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run -d ubuntu:18.04 /bin/sh -c &quot;while true; do echo hello world; sleep 1; done&quot;\n77b2dc01fe0f3f1265df143181e7b9af5e05279a884f4776ee75350ea9d8017a`, `60381859145971980000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run -d ubuntu:18.04 /bin/sh -c <span class="token string">"while true; do echo hello world; sleep 1; done"</span>\n77b2dc01fe0f3f1265df143181e7b9af5e05279a884f4776ee75350ea9d8017a</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>此时容器会在后台运行并不会把输出的结果 (STDOUT) 打印到宿主机上面(输出结果可以用 <code class="language-text">docker logs</code> 查看)。</p>\n<blockquote>\n<p>注：容器是否会长久运行，是和 docker run 指定的命令有关，和 <code class="language-text">-d</code> 参数无关。</p>\n</blockquote>\n<p>使用 <code class="language-text">-d</code> 参数启动后会返回一个唯一的 id，也可以通过 docker container ls 命令来查看容器信息。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="7279815053777838000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker container ls\nCONTAINER ID  IMAGE         COMMAND               CREATED        STATUS       PORTS NAMES\n77b2dc01fe0f  ubuntu:18.04  /bin/sh -c \'while tr  2 minutes ago  Up 1 minute        agitated_wright`, `7279815053777838000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker container <span class="token function">ls</span>\nCONTAINER ID  IMAGE         COMMAND               CREATED        STATUS       PORTS NAMES\n77b2dc01fe0f  ubuntu:18.04  /bin/sh -c \'while <span class="token function">tr</span>  <span class="token number">2</span> minutes ago  Up <span class="token number">1</span> minute        agitated_wright</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>要获取容器的输出信息，可以通过 <code class="language-text">docker container logs</code> 命令。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="93798909503309870000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker container logs [container ID or NAMES]\nhello world\nhello world\nhello world\n. . .`, `93798909503309870000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker container logs <span class="token punctuation">[</span>container ID or NAMES<span class="token punctuation">]</span>\nhello world\nhello world\nhello world\n<span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="终止容器"><a href="#%E7%BB%88%E6%AD%A2%E5%AE%B9%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>终止容器</h2>\n<p>可以使用 <code class="language-text">docker container stop</code> 来终止一个运行中的容器。</p>\n<p>此外，当 Docker 容器中指定的应用终结时，容器也自动终止。</p>\n<p>例如对于上一章节中只启动了一个终端的容器，用户通过 <code class="language-text">exit</code> 命令或 <code class="language-text">Ctrl+d</code> 来退出终端时，所创建的容器立刻终止。</p>\n<p>终止状态的容器可以用 <code class="language-text">docker container ls -a</code> 命令看到。例如</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="17946139536836526000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker container ls -a\nCONTAINER ID        IMAGE                    COMMAND                CREATED             STATUS                          PORTS               NAMES\nba267838cc1b        ubuntu:18.04             &quot;/bin/bash&quot;            30 minutes ago      Exited (0) About a minute ago                       trusting_newton`, `17946139536836526000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker container <span class="token function">ls</span> -a\nCONTAINER ID        IMAGE                    COMMAND                CREATED             STATUS                          PORTS               NAMES\nba267838cc1b        ubuntu:18.04             <span class="token string">"/bin/bash"</span>            <span class="token number">30</span> minutes ago      Exited <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> About a minute ago                       trusting_newton</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>处于终止状态的容器，可以通过 <code class="language-text">docker container start</code> 命令来重新启动。</p>\n<p>此外，<code class="language-text">docker container restart</code> 命令会将一个运行态的容器终止，然后再重新启动它。</p>\n<h2 id="进入容器"><a href="#%E8%BF%9B%E5%85%A5%E5%AE%B9%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>进入容器</h2>\n<p>在使用 <code class="language-text">-d</code> 参数时，容器启动后会进入后台。</p>\n<p>某些时候需要进入容器进行操作，包括使用 docker attach 命令或 docker exec 命令，推荐大家使用 docker exec 命令，原因会在下面说明。</p>\n<h3 id="attach-命令"><a href="#attach-%E5%91%BD%E4%BB%A4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>attach 命令</h3>\n<p>下面示例如何使用 docker attach 命令。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="6517486014816520000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run -dit ubuntu\n243c32535da7d142fb0e6df616a3c3ada0b8ab417937c853a9e1c251f499f550\n\n\\$ docker container ls\nCONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES\n243c32535da7        ubuntu:latest       &quot;/bin/bash&quot;         18 seconds ago      Up 17 seconds                           nostalgic_hypatia\n\n\\$ docker attach 243c\nroot@243c32535da7:/#`, `6517486014816520000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run -dit ubuntu\n243c32535da7d142fb0e6df616a3c3ada0b8ab417937c853a9e1c251f499f550\n\n$ docker container <span class="token function">ls</span>\nCONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES\n243c32535da7        ubuntu:latest       <span class="token string">"/bin/bash"</span>         <span class="token number">18</span> seconds ago      Up <span class="token number">17</span> seconds                           nostalgic_hypatia\n\n$ docker attach 243c\nroot@243c32535da7:/<span class="token comment">#</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>注意：如果从这个 stdin 中 exit，会导致容器的停止。</p>\n<h3 id="exec-命令--i--t-参数"><a href="#exec-%E5%91%BD%E4%BB%A4--i--t-%E5%8F%82%E6%95%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>exec 命令 -i -t 参数</h3>\n<p>docker exec 后边可以跟多个参数，这里主要说明 <code class="language-text">-i -t</code> 参数。</p>\n<p>只用 <code class="language-text">-i</code> 参数时，由于没有分配伪终端，界面没有我们熟悉的 Linux 命令提示符，但命令执行结果仍然可以返回。</p>\n<p>当 <code class="language-text">-i -t</code> 参数一起使用时，则可以看到我们熟悉的 Linux 命令提示符。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="64577368005972360000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run -dit ubuntu\n69d137adef7a8a689cbcb059e94da5489d3cddd240ff675c640c8d96e84fe1f6\n\n\\$ docker container ls\nCONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES\n69d137adef7a        ubuntu:latest       &quot;/bin/bash&quot;         18 seconds ago      Up 17 seconds                           zealous_swirles\n\n\\$ docker exec -i 69d1 bash\nls\nbin\nboot\ndev\n...\n\n\\$ docker exec -it 69d1 bash\nroot@69d137adef7a:/#`, `64577368005972360000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run -dit ubuntu\n69d137adef7a8a689cbcb059e94da5489d3cddd240ff675c640c8d96e84fe1f6\n\n$ docker container <span class="token function">ls</span>\nCONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES\n69d137adef7a        ubuntu:latest       <span class="token string">"/bin/bash"</span>         <span class="token number">18</span> seconds ago      Up <span class="token number">17</span> seconds                           zealous_swirles\n\n$ docker <span class="token builtin class-name">exec</span> -i 69d1 <span class="token function">bash</span>\n<span class="token function">ls</span>\nbin\nboot\ndev\n<span class="token punctuation">..</span>.\n\n$ docker <span class="token builtin class-name">exec</span> -it 69d1 <span class="token function">bash</span>\nroot@69d137adef7a:/<span class="token comment">#</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果从这个 stdin 中 exit，不会导致容器的停止。这就是为什么推荐大家使用 docker exec 的原因。</p>\n<p>更多参数说明请使用 <code class="language-text">docker exec --help</code> 查看。</p>\n<h2 id="导出和导入容器"><a href="#%E5%AF%BC%E5%87%BA%E5%92%8C%E5%AF%BC%E5%85%A5%E5%AE%B9%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>导出和导入容器</h2>\n<h3 id="导出容器"><a href="#%E5%AF%BC%E5%87%BA%E5%AE%B9%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>导出容器</h3>\n<p>如果要导出本地某个容器，可以使用 docker export 命令。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="91164243997834870000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker container ls -a\nCONTAINER ID        IMAGE               COMMAND             CREATED             STATUS                    PORTS               NAMES\n7691a814370e        ubuntu:18.04        &quot;/bin/bash&quot;         36 hours ago        Exited (0) 21 hours ago                       test\n\\$ docker export 7691a814370e > ubuntu.tar`, `91164243997834870000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker container <span class="token function">ls</span> -a\nCONTAINER ID        IMAGE               COMMAND             CREATED             STATUS                    PORTS               NAMES\n7691a814370e        ubuntu:18.04        <span class="token string">"/bin/bash"</span>         <span class="token number">36</span> hours ago        Exited <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token number">21</span> hours ago                       <span class="token builtin class-name">test</span>\n$ docker <span class="token builtin class-name">export</span> 7691a814370e <span class="token operator">></span> ubuntu.tar</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样将导出容器快照到本地文件。</p>\n<h3 id="导入容器快照"><a href="#%E5%AF%BC%E5%85%A5%E5%AE%B9%E5%99%A8%E5%BF%AB%E7%85%A7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>导入容器快照</h3>\n<p>可以使用 docker import 从容器快照文件中再导入为镜像，例如</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="89613680558121730000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ cat ubuntu.tar | docker import - test/ubuntu:v1.0\n\\$ docker image ls\nREPOSITORY          TAG                 IMAGE ID            CREATED              VIRTUAL SIZE\ntest/ubuntu         v1.0                9d37a6082e97        About a minute ago   171.3 MB`, `89613680558121730000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ <span class="token function">cat</span> ubuntu.tar <span class="token operator">|</span> docker <span class="token function">import</span> - test/ubuntu:v1.0\n$ docker image <span class="token function">ls</span>\nREPOSITORY          TAG                 IMAGE ID            CREATED              VIRTUAL SIZE\ntest/ubuntu         v1.0                9d37a6082e97        About a minute ago   <span class="token number">171.3</span> MB</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>此外，也可以通过指定 URL 或者某个目录来导入，例如</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="23777404533500770000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker import http://example.com/exampleimage.tgz example/imagerepo`, `23777404533500770000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker <span class="token function">import</span> http://example.com/exampleimage.tgz example/imagerepo</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<blockquote>\n<p>注：用户既可以使用 docker load 来导入镜像存储文件到本地镜像库，也可以使用 docker import 来导入一个容器快照到本地镜像库。这两者的区别在于容器快照文件将丢弃所有的历史记录和元数据信息（即仅保存容器当时的快照状态），而镜像存储文件将保存完整记录，体积也要大。此外，从容器快照文件导入时可以重新指定标签等元数据信息。</p>\n</blockquote>\n<h2 id="删除容器"><a href="#%E5%88%A0%E9%99%A4%E5%AE%B9%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>删除容器</h2>\n<p>可以使用 <code class="language-text">docker container rm</code> 来删除一个处于终止状态的容器。例如</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="36738289029757200000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker container rm trusting_newton\ntrusting_newton`, `36738289029757200000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker container <span class="token function">rm</span> trusting_newton\ntrusting_newton</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>如果要删除一个运行中的容器，可以添加 -f 参数。Docker 会发送 SIGKILL 信号给容器。</p>\n<h3 id="清理所有处于终止状态的容器"><a href="#%E6%B8%85%E7%90%86%E6%89%80%E6%9C%89%E5%A4%84%E4%BA%8E%E7%BB%88%E6%AD%A2%E7%8A%B6%E6%80%81%E7%9A%84%E5%AE%B9%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>清理所有处于终止状态的容器</h3>\n<p>用 <code class="language-text">docker container ls -a</code> 命令可以查看所有已经创建的包括终止状态的容器，如果数量太多要一个个删除可能会很麻烦，用下面的命令可以清理掉所有处于终止状态的容器。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="5925081454650006000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker container prune`, `5925081454650006000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker container prune</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h1 id="docker-仓库"><a href="#docker-%E4%BB%93%E5%BA%93" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Docker 仓库</h1>\n<p>仓库（Repository）是集中存放镜像的地方。</p>\n<p>一个容易混淆的概念是注册服务器（Registry）。实际上注册服务器是管理仓库的具体服务器，每个服务器上可以有多个仓库，而每个仓库下面有多个镜像。从这方面来说，仓库可以被认为是一个具体的项目或目录。例如对于仓库地址 <code class="language-text">docker.io/ubuntu</code> 来说，docker.io 是注册服务器地址，ubuntu 是仓库名。</p>\n<p>大部分时候，并不需要严格区分这两者的概念。</p>\n<h2 id="docker-hub"><a href="#docker-hub" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Docker Hub</h2>\n<p>目前 Docker 官方维护了一个公共仓库 Docker Hub，大部分需求都可以通过在 Docker Hub 中直接下载镜像来实现。</p>\n<h3 id="注册"><a href="#%E6%B3%A8%E5%86%8C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>注册</h3>\n<p>你可以在 <a href="https://hub.docker.com" target="_blank" rel="nofollow noreferrer noopener">https://hub.docker.com</a> 免费注册一个 Docker 账号。</p>\n<h3 id="登录"><a href="#%E7%99%BB%E5%BD%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>登录</h3>\n<p>可以通过执行 docker login 命令交互式的输入用户名及密码来完成在命令行界面登录 Docker Hub。</p>\n<p>你可以通过 docker logout 退出登录。</p>\n<h3 id="拉取镜像"><a href="#%E6%8B%89%E5%8F%96%E9%95%9C%E5%83%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>拉取镜像</h3>\n<p>你可以通过 docker search 命令来查找官方仓库中的镜像，并利用 docker pull 命令来将它下载到本地。</p>\n<p>例如以 centos 为关键词进行搜索：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="48324909423522430000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker search centos\nNAME                               DESCRIPTION                                     STARS     OFFICIAL   AUTOMATED\ncentos                             The official build of CentOS.                   6449      [OK]\nansible/centos7-ansible            Ansible on Centos7                              132                  [OK]\nconsol/centos-xfce-vnc             Centos container with &quot;headless&quot; VNC session…   126                  [OK]\njdeathe/centos-ssh                 OpenSSH / Supervisor / EPEL/IUS/SCL Repos - …   117                  [OK]\ncentos/systemd                     systemd enabled base container.                 96                   [OK]`, `48324909423522430000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker search centos\nNAME                               DESCRIPTION                                     STARS     OFFICIAL   AUTOMATED\ncentos                             The official build of CentOS.                   <span class="token number">6449</span>      <span class="token punctuation">[</span>OK<span class="token punctuation">]</span>\nansible/centos7-ansible            Ansible on Centos7                              <span class="token number">132</span>                  <span class="token punctuation">[</span>OK<span class="token punctuation">]</span>\nconsol/centos-xfce-vnc             Centos container with <span class="token string">"headless"</span> VNC session…   <span class="token number">126</span>                  <span class="token punctuation">[</span>OK<span class="token punctuation">]</span>\njdeathe/centos-ssh                 OpenSSH / Supervisor / EPEL/IUS/SCL Repos - …   <span class="token number">117</span>                  <span class="token punctuation">[</span>OK<span class="token punctuation">]</span>\ncentos/systemd                     systemd enabled base container.                 <span class="token number">96</span>                   <span class="token punctuation">[</span>OK<span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以看到返回了很多包含关键字的镜像，其中包括镜像名字、描述、收藏数（表示该镜像的受关注程度）、是否官方创建（OFFICIAL）、是否自动构建 （AUTOMATED）。</p>\n<p>根据是否是官方提供，可将镜像分为两类。</p>\n<ol>\n<li>\n<p>类似 centos 这样的镜像，被称为基础镜像或根镜像。这些基础镜像由 Docker 公司创建、验证、支持、提供。这样的镜像往往使用单个单词作为名字。</p>\n</li>\n<li>\n<p>比如 <code class="language-text">ansible/centos7-ansible</code> 镜像，它是由 Docker Hub 的注册用户创建并维护的，往往带有用户名称前缀。可以通过前缀 <code class="language-text">username/</code> 来指定使用某个用户提供的镜像，比如 ansible 用户。</p>\n</li>\n</ol>\n<p>另外，在查找的时候通过 <code class="language-text">--filter=stars=N</code> 参数可以指定仅显示收藏数量为 N 以上的镜像。</p>\n<p>下载官方 centos 镜像到本地。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="37544011806184250000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker pull centos\nUsing default tag: latest\nlatest: Pulling from library/centos\n7a0437f04f83: Pull complete\nDigest: sha256:5528e8b1b1719d34604c87e11dcd1c0a20bedf46e83b5632cdeac91b8c04efc1\nStatus: Downloaded newer image for centos:latest\ndocker.io/library/centos:latest`, `37544011806184250000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker pull centos\nUsing default tag: latest\nlatest: Pulling from library/centos\n7a0437f04f83: Pull complete\nDigest: sha256:5528e8b1b1719d34604c87e11dcd1c0a20bedf46e83b5632cdeac91b8c04efc1\nStatus: Downloaded newer image <span class="token keyword">for</span> centos:latest\ndocker.io/library/centos:latest</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="推送镜像"><a href="#%E6%8E%A8%E9%80%81%E9%95%9C%E5%83%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>推送镜像</h3>\n<p>用户也可以在登录后通过 docker push 命令来将自己的镜像推送到 Docker Hub。</p>\n<p>以下命令中的 username 请替换为你的 Docker 账号用户名。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="45658608685945940000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker tag ubuntu:18.04 username/ubuntu:18.04\n\n\\$ docker image ls\n\nREPOSITORY                                               TAG                    IMAGE ID            CREATED             SIZE\nubuntu                                                   18.04                  275d79972a86        6 days ago          94.6MB\nusername/ubuntu                                          18.04                  275d79972a86        6 days ago          94.6MB\n\n\\$ docker push username/ubuntu:18.04\n\n\\$ docker search username\n\nNAME                      DESCRIPTION                                     STARS               OFFICIAL            AUTOMATED\nusername/ubuntu`, `45658608685945940000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker tag ubuntu:18.04 username/ubuntu:18.04\n\n$ docker image <span class="token function">ls</span>\n\nREPOSITORY                                               TAG                    IMAGE ID            CREATED             SIZE\nubuntu                                                   <span class="token number">18.04</span>                  275d79972a86        <span class="token number">6</span> days ago          <span class="token number">94</span>.6MB\nusername/ubuntu                                          <span class="token number">18.04</span>                  275d79972a86        <span class="token number">6</span> days ago          <span class="token number">94</span>.6MB\n\n$ docker push username/ubuntu:18.04\n\n$ docker search username\n\nNAME                      DESCRIPTION                                     STARS               OFFICIAL            AUTOMATED\nusername/ubuntu</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="自动构建"><a href="#%E8%87%AA%E5%8A%A8%E6%9E%84%E5%BB%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>自动构建</h3>\n<p>2021 年 7 月 26 日之后，该项功能仅限付费用户使用。</p>\n<p>自动构建（Automated Builds）可以自动触发构建镜像，方便升级镜像。</p>\n<p>有时候，用户构建了镜像，安装了某个软件，当软件发布新版本则需要手动更新镜像。</p>\n<p>而自动构建允许用户通过 Docker Hub 指定跟踪一个目标网站（支持 GitHub 或 BitBucket）上的项目，一旦项目发生新的提交（commit）或者创建了新的标签（tag），Docker Hub 会自动构建镜像并推送到 Docker Hub 中。</p>\n<p>要配置自动构建，包括如下的步骤：</p>\n<ul>\n<li>登录 Docker Hub；</li>\n<li>在 Docker Hub 点击右上角头像，在账号设置（Account Settings）中关联（Linked Accounts）目标网站；</li>\n<li>在 Docker Hub 中新建或选择已有的仓库，在 Builds 选项卡中选择 Configure Automated Builds；</li>\n<li>选取一个目标网站中的项目（需要含 Dockerfile）和分支；</li>\n<li>指定 Dockerfile 的位置，并保存。</li>\n</ul>\n<p>之后，可以在 Docker Hub 的仓库页面的 Timeline 选项卡中查看每次构建的状态。</p>\n<h1 id="数据管理"><a href="#%E6%95%B0%E6%8D%AE%E7%AE%A1%E7%90%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>数据管理</h1>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-07-17-02-27-55-a787655c53be0430f111e9269abb1da8-1041c.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 501px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 50.898203592814376%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAB20lEQVQoz1VQyY4TMRDNx3DjM/gCJMSFExe+gfMIjcSFE0cQ4gc4c0AzIIZMkgnJZJkOnXQmvS9O2+1e3HbbvVBJJNBIpXLpVT35vdd78vr941fnj16ePT//RAseJVmcFiFOA5KGJAuTLMAwUACjJEc0hw61p7mHae/Zm48v3n5+evbh3ZfLruvariMZu7dc0/G2pmPsbMsNLC9MWXnaHnp7eFPGezgrjkhXt62fci8TurcfL1aD8fRqML782Z9rumaYdw6yKZd1HeViGaRMNnkpehHNgZmUcmQTHWWqaSspfRRjQjcesiLsI+xGsVKKydokbBmmFxtkJiXjogfGuGqchN3jYmQnVlL+EwafmAk3MN/EpawPSMwqUAf7pj3KhiRk09pJWYoKpYwwIaTKWSml8jNR8KrkgosKtkIIUoh9UZ1sHsgQL0wLnw7/mCt9M/x9O54t19udASkVKiZ0oRuT+d1cW2/urQvNJlz9J6OjZ1XXW9ubLlfDyexmOp+tjK9TA64CFI/nq/5oAvitttZd9CDtE7lumvXO+XF9870/vLoefRtMf2kW4BBeAclUEmSDF/jjAdnHFGZVN8Eebx1/5wamF5puQBJaNy0UHEJrjww4g5KqAQRn7C+cXiHdG08wcwAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 07 17 02 27 55" title="" data-src="/static/2022-07-17-02-27-55-a787655c53be0430f111e9269abb1da8-1041c.png" data-srcset="/static/2022-07-17-02-27-55-a787655c53be0430f111e9269abb1da8-d18f3.png 200w,\n/static/2022-07-17-02-27-55-a787655c53be0430f111e9269abb1da8-764b5.png 400w,\n/static/2022-07-17-02-27-55-a787655c53be0430f111e9269abb1da8-1041c.png 501w" data-sizes="(max-width: 501px) 100vw, 501px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>这一章介绍如何在 Docker 内部以及容器之间管理数据，在容器中管理数据主要有两种方式：</p>\n<ul>\n<li>数据卷（Volumes）</li>\n<li>挂载主机目录 (Bind mounts)</li>\n</ul>\n<h2 id="数据卷"><a href="#%E6%95%B0%E6%8D%AE%E5%8D%B7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>数据卷</h2>\n<p>数据卷是一个可供一个或多个容器使用的特殊目录，它绕过 UFS，可以提供很多有用的特性：</p>\n<ul>\n<li>数据卷可以在容器之间共享和重用</li>\n<li>对数据卷的修改会立马生效</li>\n<li>对数据卷的更新，不会影响镜像</li>\n<li>数据卷默认会一直存在，即使容器被删除</li>\n</ul>\n<blockquote>\n<p>注意：数据卷的使用，类似于 Linux 下对目录或文件进行 mount，镜像中的被指定为挂载点的目录中的文件会复制到数据卷中（仅数据卷为空时会复制）。</p>\n</blockquote>\n<h3 id="创建一个数据卷"><a href="#%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E6%95%B0%E6%8D%AE%E5%8D%B7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>创建一个数据卷</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="97029067396994660000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker volume create my-vol`, `97029067396994660000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker volume create my-vol</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>查看所有的数据卷</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="68215439387821840000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker volume ls\n\nDRIVER              VOLUME NAME\nlocal               my-vol`, `68215439387821840000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker volume <span class="token function">ls</span>\n\nDRIVER              VOLUME NAME\n<span class="token builtin class-name">local</span>               my-vol</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在主机里使用以下命令可以查看指定数据卷的信息</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="85520067501946630000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker volume inspect my-vol\n[\n    {\n        &quot;Driver&quot;: &quot;local&quot;,\n        &quot;Labels&quot;: {},\n        &quot;Mountpoint&quot;: &quot;/var/lib/docker/volumes/my-vol/_data&quot;,\n        &quot;Name&quot;: &quot;my-vol&quot;,\n        &quot;Options&quot;: {},\n        &quot;Scope&quot;: &quot;local&quot;\n    }\n]`, `85520067501946630000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker volume inspect my-vol\n<span class="token punctuation">[</span>\n    <span class="token punctuation">{</span>\n        <span class="token string">"Driver"</span><span class="token builtin class-name">:</span> <span class="token string">"local"</span>,\n        <span class="token string">"Labels"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>,\n        <span class="token string">"Mountpoint"</span><span class="token builtin class-name">:</span> <span class="token string">"/var/lib/docker/volumes/my-vol/_data"</span>,\n        <span class="token string">"Name"</span><span class="token builtin class-name">:</span> <span class="token string">"my-vol"</span>,\n        <span class="token string">"Options"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>,\n        <span class="token string">"Scope"</span><span class="token builtin class-name">:</span> <span class="token string">"local"</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="启动一个挂载数据卷的容器"><a href="#%E5%90%AF%E5%8A%A8%E4%B8%80%E4%B8%AA%E6%8C%82%E8%BD%BD%E6%95%B0%E6%8D%AE%E5%8D%B7%E7%9A%84%E5%AE%B9%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>启动一个挂载数据卷的容器</h3>\n<p>在用 docker run 命令的时候，使用 <code class="language-text">--mount</code> 标记来将数据卷挂载到容器里。在一次 docker run 中可以挂载多个数据卷。</p>\n<p>下面创建一个名为 web 的容器，并加载一个数据卷到容器的 <code class="language-text">/usr/share/nginx/html</code> 目录。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="33804864743090745000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run -d -P \\\n    --name web \\\n    # -v my-vol:/usr/share/nginx/html \\\n    --mount source=my-vol,target=/usr/share/nginx/html \\\n    nginx:alpine`, `33804864743090745000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run -d -P <span class="token punctuation">\\</span>\n    --name web <span class="token punctuation">\\</span>\n    <span class="token comment"># -v my-vol:/usr/share/nginx/html \\</span>\n    --mount <span class="token assign-left variable">source</span><span class="token operator">=</span>my-vol,target<span class="token operator">=</span>/usr/share/nginx/html <span class="token punctuation">\\</span>\n    nginx:alpine</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="查看数据卷的具体信息"><a href="#%E6%9F%A5%E7%9C%8B%E6%95%B0%E6%8D%AE%E5%8D%B7%E7%9A%84%E5%85%B7%E4%BD%93%E4%BF%A1%E6%81%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>查看数据卷的具体信息</h3>\n<p>在主机里使用以下命令可以查看 web 容器的信息</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="39374134503869415000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker inspect web`, `39374134503869415000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker inspect web</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>数据卷信息在 <code class="language-text">&quot;Mounts&quot; Key</code> 下面</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="75681366930572300000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`&quot;Mounts&quot;: [\n    {\n        &quot;Type&quot;: &quot;volume&quot;,\n        &quot;Name&quot;: &quot;my-vol&quot;,\n        &quot;Source&quot;: &quot;/var/lib/docker/volumes/my-vol/_data&quot;,\n        &quot;Destination&quot;: &quot;/usr/share/nginx/html&quot;,\n        &quot;Driver&quot;: &quot;local&quot;,\n        &quot;Mode&quot;: &quot;&quot;,\n        &quot;RW&quot;: true,\n        &quot;Propagation&quot;: &quot;&quot;\n    }\n],`, `75681366930572300000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="json"\n              >\n                <span class="gatsby-code-button-language">json</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="json"><pre style="counter-reset: linenumber NaN" class="language-json line-numbers"><code class="language-json"><span class="token property">"Mounts"</span><span class="token operator">:</span> <span class="token punctuation">[</span>\n    <span class="token punctuation">{</span>\n        <span class="token property">"Type"</span><span class="token operator">:</span> <span class="token string">"volume"</span><span class="token punctuation">,</span>\n        <span class="token property">"Name"</span><span class="token operator">:</span> <span class="token string">"my-vol"</span><span class="token punctuation">,</span>\n        <span class="token property">"Source"</span><span class="token operator">:</span> <span class="token string">"/var/lib/docker/volumes/my-vol/_data"</span><span class="token punctuation">,</span>\n        <span class="token property">"Destination"</span><span class="token operator">:</span> <span class="token string">"/usr/share/nginx/html"</span><span class="token punctuation">,</span>\n        <span class="token property">"Driver"</span><span class="token operator">:</span> <span class="token string">"local"</span><span class="token punctuation">,</span>\n        <span class="token property">"Mode"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>\n        <span class="token property">"RW"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n        <span class="token property">"Propagation"</span><span class="token operator">:</span> <span class="token string">""</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">]</span><span class="token punctuation">,</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="删除数据卷"><a href="#%E5%88%A0%E9%99%A4%E6%95%B0%E6%8D%AE%E5%8D%B7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>删除数据卷</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="74403281536522900000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker volume rm my-vol`, `74403281536522900000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker volume <span class="token function">rm</span> my-vol</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>数据卷是被设计用来持久化数据的，它的生命周期独立于容器，Docker 不会在容器被删除后自动删除数据卷，并且也不存在垃圾回收这样的机制来处理没有任何容器引用的数据卷。如果需要在删除容器的同时移除数据卷。可以在删除容器的时候使用 <code class="language-text">docker rm -v</code> 这个命令。</p>\n<p>无主的数据卷可能会占据很多空间，要清理请使用以下命令</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="44557804489285010000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker volume prune`, `44557804489285010000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker volume prune</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h2 id="挂载主机目录"><a href="#%E6%8C%82%E8%BD%BD%E4%B8%BB%E6%9C%BA%E7%9B%AE%E5%BD%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>挂载主机目录</h2>\n<h3 id="挂载一个主机目录作为数据卷"><a href="#%E6%8C%82%E8%BD%BD%E4%B8%80%E4%B8%AA%E4%B8%BB%E6%9C%BA%E7%9B%AE%E5%BD%95%E4%BD%9C%E4%B8%BA%E6%95%B0%E6%8D%AE%E5%8D%B7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>挂载一个主机目录作为数据卷</h3>\n<p>使用 <code class="language-text">--mount</code> 标记可以指定挂载一个本地主机的目录到容器中去。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="72570468168302215000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run -d -P \\\n    --name web \\\n    # -v /src/webapp:/usr/share/nginx/html \\\n    --mount type=bind,source=/src/webapp,target=/usr/share/nginx/html \\\n    nginx:alpine`, `72570468168302215000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run -d -P <span class="token punctuation">\\</span>\n    --name web <span class="token punctuation">\\</span>\n    <span class="token comment"># -v /src/webapp:/usr/share/nginx/html \\</span>\n    --mount <span class="token assign-left variable">type</span><span class="token operator">=</span>bind,source<span class="token operator">=</span>/src/webapp,target<span class="token operator">=</span>/usr/share/nginx/html <span class="token punctuation">\\</span>\n    nginx:alpine</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>上面的命令加载主机的 <code class="language-text">/src/webapp</code> 目录到容器的 <code class="language-text">/usr/share/nginx/html</code> 目录。这个功能在进行测试的时候十分方便，比如用户可以放置一些程序到本地目录中，来查看容器是否正常工作。本地目录的路径必须是绝对路径，以前使用 <code class="language-text">-v</code> 参数时如果本地目录不存在 Docker 会自动为你创建一个文件夹，现在使用 <code class="language-text">--mount</code> 参数时如果本地目录不存在，Docker 会报错。</p>\n<p>Docker 挂载主机目录的默认权限是读写，用户也可以通过增加 readonly 指定为只读。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="2210399336955726300"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run -d -P \\\n    --name web \\\n    # -v /src/webapp:/usr/share/nginx/html:ro \\\n    --mount type=bind,source=/src/webapp,target=/usr/share/nginx/html,readonly \\\n    nginx:alpine`, `2210399336955726300`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run -d -P <span class="token punctuation">\\</span>\n    --name web <span class="token punctuation">\\</span>\n    <span class="token comment"># -v /src/webapp:/usr/share/nginx/html:ro \\</span>\n    --mount <span class="token assign-left variable">type</span><span class="token operator">=</span>bind,source<span class="token operator">=</span>/src/webapp,target<span class="token operator">=</span>/usr/share/nginx/html,readonly <span class="token punctuation">\\</span>\n    nginx:alpine</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>加了 readonly 之后，就挂载为只读了。如果你在容器内 <code class="language-text">/usr/share/nginx/html</code> 目录新建文件，会显示如下错误</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="11679781186775063000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`/usr/share/nginx/html # touch new.txt\ntouch: new.txt: Read-only file system`, `11679781186775063000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">/usr/share/nginx/html <span class="token comment"># touch new.txt</span>\ntouch: new.txt: Read-only <span class="token function">file</span> system</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<h3 id="查看数据卷的具体信息-1"><a href="#%E6%9F%A5%E7%9C%8B%E6%95%B0%E6%8D%AE%E5%8D%B7%E7%9A%84%E5%85%B7%E4%BD%93%E4%BF%A1%E6%81%AF-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>查看数据卷的具体信息</h3>\n<p>在主机里使用以下命令可以查看 web 容器的信息</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="72043480024001495000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker inspect web`, `72043480024001495000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker inspect web</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>挂载主机目录的配置信息在 <code class="language-text">&quot;Mounts&quot; Key</code> 下面</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="23918752629566886000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`&quot;Mounts&quot;: [\n    {\n        &quot;Type&quot;: &quot;bind&quot;,\n        &quot;Source&quot;: &quot;/src/webapp&quot;,\n        &quot;Destination&quot;: &quot;/usr/share/nginx/html&quot;,\n        &quot;Mode&quot;: &quot;&quot;,\n        &quot;RW&quot;: true,\n        &quot;Propagation&quot;: &quot;rprivate&quot;\n    }\n],`, `23918752629566886000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="json"\n              >\n                <span class="gatsby-code-button-language">json</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="json"><pre style="counter-reset: linenumber NaN" class="language-json line-numbers"><code class="language-json"><span class="token property">"Mounts"</span><span class="token operator">:</span> <span class="token punctuation">[</span>\n    <span class="token punctuation">{</span>\n        <span class="token property">"Type"</span><span class="token operator">:</span> <span class="token string">"bind"</span><span class="token punctuation">,</span>\n        <span class="token property">"Source"</span><span class="token operator">:</span> <span class="token string">"/src/webapp"</span><span class="token punctuation">,</span>\n        <span class="token property">"Destination"</span><span class="token operator">:</span> <span class="token string">"/usr/share/nginx/html"</span><span class="token punctuation">,</span>\n        <span class="token property">"Mode"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>\n        <span class="token property">"RW"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n        <span class="token property">"Propagation"</span><span class="token operator">:</span> <span class="token string">"rprivate"</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">]</span><span class="token punctuation">,</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="挂载一个本地主机文件作为数据卷"><a href="#%E6%8C%82%E8%BD%BD%E4%B8%80%E4%B8%AA%E6%9C%AC%E5%9C%B0%E4%B8%BB%E6%9C%BA%E6%96%87%E4%BB%B6%E4%BD%9C%E4%B8%BA%E6%95%B0%E6%8D%AE%E5%8D%B7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>挂载一个本地主机文件作为数据卷</h3>\n<p><code class="language-text">--mount</code> 标记也可以从主机挂载单个文件到容器中</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="81510641790169020000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run --rm -it \\\n   # -v \\$HOME/.bash_history:/root/.bash_history \\\n   --mount type=bind,source=\\$HOME/.bash_history,target=/root/.bash_history \\\n   ubuntu:18.04 \\\n   bash\n\nroot@2affd44b4667:/# history\n1  ls\n2  diskutil list`, `81510641790169020000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run --rm -it <span class="token punctuation">\\</span>\n   <span class="token comment"># -v $HOME/.bash_history:/root/.bash_history \\</span>\n   --mount <span class="token assign-left variable">type</span><span class="token operator">=</span>bind,source<span class="token operator">=</span><span class="token environment constant">$HOME</span>/.bash_history,target<span class="token operator">=</span>/root/.bash_history <span class="token punctuation">\\</span>\n   ubuntu:18.04 <span class="token punctuation">\\</span>\n   <span class="token function">bash</span>\n\nroot@2affd44b4667:/<span class="token comment"># history</span>\n<span class="token number">1</span>  <span class="token function">ls</span>\n<span class="token number">2</span>  diskutil list</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样就可以记录在容器输入过的命令了。</p>\n<h1 id="网络"><a href="#%E7%BD%91%E7%BB%9C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>网络</h1>\n<p>Docker 允许通过外部访问容器或容器互联的方式来提供网络服务。</p>\n<h2 id="外部访问容器"><a href="#%E5%A4%96%E9%83%A8%E8%AE%BF%E9%97%AE%E5%AE%B9%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>外部访问容器</h2>\n<p>容器中可以运行一些网络应用，要让外部也可以访问这些应用，可以通过 <code class="language-text">-P</code> 或 <code class="language-text">-p</code> 参数来指定端口映射。</p>\n<p>当使用 <code class="language-text">-P</code> 标记时，Docker 会随机映射一个端口到内部容器开放的网络端口。</p>\n<p>使用 <code class="language-text">docker container ls</code> 可以看到，本地主机的 32768 被映射到了容器的 80 端口。此时访问本机的 32768 端口即可访问容器内 NGINX 默认页面。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="29235871519077515000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run -d -P nginx:alpine\n\n\\$ docker container ls -l\nCONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                   NAMES\nfae320d08268        nginx:alpine        &quot;/docker-entrypoint.…&quot;   24 seconds ago      Up 20 seconds       0.0.0.0:32768->80/tcp   bold_mcnulty`, `29235871519077515000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run -d -P nginx:alpine\n\n$ docker container <span class="token function">ls</span> -l\nCONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                   NAMES\nfae320d08268        nginx:alpine        <span class="token string">"/docker-entrypoint.…"</span>   <span class="token number">24</span> seconds ago      Up <span class="token number">20</span> seconds       <span class="token number">0.0</span>.0.0:32768-<span class="token operator">></span><span class="token number">80</span>/tcp   bold_mcnulty</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>同样的，可以通过 docker logs 命令来查看访问记录。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="73760058241564975000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker logs fa\n172.17.0.1 - - [25/Aug/2020:08:34:04 +0000] &quot;GET / HTTP/1.1&quot; 200 612 &quot;-&quot; &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:80.0) Gecko/20100101 Firefox/80.0&quot; &quot;-&quot;`, `73760058241564975000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker logs fa\n<span class="token number">172.17</span>.0.1 - - <span class="token punctuation">[</span><span class="token number">25</span>/Aug/2020:08:34:04 +0000<span class="token punctuation">]</span> <span class="token string">"GET / HTTP/1.1"</span> <span class="token number">200</span> <span class="token number">612</span> <span class="token string">"-"</span> <span class="token string">"Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:80.0) Gecko/20100101 Firefox/80.0"</span> <span class="token string">"-"</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p><code class="language-text">-p</code> 则可以指定要映射的端口，并且，在一个指定端口上只可以绑定一个容器。支持的格式有 <code class="language-text">ip:hostPort:containerPort | ip::containerPort | hostPort:containerPort</code>。</p>\n<h3 id="映射所有接口地址"><a href="#%E6%98%A0%E5%B0%84%E6%89%80%E6%9C%89%E6%8E%A5%E5%8F%A3%E5%9C%B0%E5%9D%80" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>映射所有接口地址</h3>\n<p>使用 <code class="language-text">hostPort:containerPort</code> 格式本地的 80 端口映射到容器的 80 端口，可以执行</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="81948752786874040000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run -d -p 80:80 nginx:alpine`, `81948752786874040000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run -d -p <span class="token number">80</span>:80 nginx:alpine</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>此时默认会绑定本地所有接口上的所有地址。</p>\n<h3 id="映射到指定地址的指定端口"><a href="#%E6%98%A0%E5%B0%84%E5%88%B0%E6%8C%87%E5%AE%9A%E5%9C%B0%E5%9D%80%E7%9A%84%E6%8C%87%E5%AE%9A%E7%AB%AF%E5%8F%A3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>映射到指定地址的指定端口</h3>\n<p>可以使用 <code class="language-text">ip:hostPort:containerPort</code> 格式指定映射使用一个特定地址，比如 localhost 地址 127.0.0.1</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="55927224023536690000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run -d -p 127.0.0.1:80:80 nginx:alpine`, `55927224023536690000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run -d -p <span class="token number">127.0</span>.0.1:80:80 nginx:alpine</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h3 id="映射到指定地址的任意端口"><a href="#%E6%98%A0%E5%B0%84%E5%88%B0%E6%8C%87%E5%AE%9A%E5%9C%B0%E5%9D%80%E7%9A%84%E4%BB%BB%E6%84%8F%E7%AB%AF%E5%8F%A3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>映射到指定地址的任意端口</h3>\n<p>使用 <code class="language-text">ip::containerPort</code> 绑定 localhost 的任意端口到容器的 80 端口，本地主机会自动分配一个端口。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="9142582041202063000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run -d -p 127.0.0.1::80 nginx:alpine`, `9142582041202063000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run -d -p <span class="token number">127.0</span>.0.1::80 nginx:alpine</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>还可以使用 udp 标记来指定 udp 端口</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="60752035549827220000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run -d -p 127.0.0.1:80:80/udp nginx:alpine`, `60752035549827220000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run -d -p <span class="token number">127.0</span>.0.1:80:80/udp nginx:alpine</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h3 id="查看映射端口配置"><a href="#%E6%9F%A5%E7%9C%8B%E6%98%A0%E5%B0%84%E7%AB%AF%E5%8F%A3%E9%85%8D%E7%BD%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>查看映射端口配置</h3>\n<p>使用 docker port 来查看当前映射的端口配置，也可以查看到绑定的地址</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="91869072722766410000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker port fa 80\n0.0.0.0:32768`, `91869072722766410000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker port fa <span class="token number">80</span>\n<span class="token number">0.0</span>.0.0:32768</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>注意：</p>\n<ul>\n<li>容器有自己的内部网络和 ip 地址（使用 docker inspect 查看，Docker 还可以有一个可变的网络配置。）</li>\n<li><code class="language-text">-p</code> 标记可以多次使用来绑定多个端口</li>\n</ul>\n<p>例如</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="61765376678205320000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run -d \\\n    -p 80:80 \\\n    -p 443:443 \\\n    nginx:alpine`, `61765376678205320000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run -d <span class="token punctuation">\\</span>\n    -p <span class="token number">80</span>:80 <span class="token punctuation">\\</span>\n    -p <span class="token number">443</span>:443 <span class="token punctuation">\\</span>\n    nginx:alpine</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="容器互联"><a href="#%E5%AE%B9%E5%99%A8%E4%BA%92%E8%81%94" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>容器互联</h2>\n<p>如果你之前有 Docker 使用经验，你可能已经习惯了使用 <code class="language-text">--link</code> 参数来使容器互联。</p>\n<p>随着 Docker 网络的完善，强烈建议大家将容器加入自定义的 Docker 网络来连接多个容器，而不是使用 <code class="language-text">--link</code> 参数。</p>\n<h3 id="新建网络"><a href="#%E6%96%B0%E5%BB%BA%E7%BD%91%E7%BB%9C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>新建网络</h3>\n<p>下面先创建一个新的 Docker 网络。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="36105327084746830000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker network create -d bridge my-net`, `36105327084746830000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker network create -d bridge my-net</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p><code class="language-text">-d</code> 参数指定 Docker 网络类型，有 bridge、overlay。其中 overlay 网络类型用于 Swarm mode，在本小节中你可以忽略它。</p>\n<h3 id="连接容器"><a href="#%E8%BF%9E%E6%8E%A5%E5%AE%B9%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>连接容器</h3>\n<p>运行一个容器并连接到新建的 my-net 网络</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="40922425563146130000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run -it --rm --name busybox1 --network my-net busybox sh`, `40922425563146130000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run -it --rm --name busybox1 --network my-net busybox <span class="token function">sh</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>打开新的终端，再运行一个容器并加入到 my-net 网络</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="75102752064751200000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run -it --rm --name busybox2 --network my-net busybox sh`, `75102752064751200000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run -it --rm --name busybox2 --network my-net busybox <span class="token function">sh</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>再打开一个新的终端查看容器信息</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="91620211765022930000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker container ls\n\nCONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES\nb47060aca56b        busybox             &quot;sh&quot;                11 minutes ago      Up 11 minutes                           busybox2\n8720575823ec        busybox             &quot;sh&quot;                16 minutes ago      Up 16 minutes                           busybox1`, `91620211765022930000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker container <span class="token function">ls</span>\n\nCONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES\nb47060aca56b        busybox             <span class="token string">"sh"</span>                <span class="token number">11</span> minutes ago      Up <span class="token number">11</span> minutes                           busybox2\n8720575823ec        busybox             <span class="token string">"sh"</span>                <span class="token number">16</span> minutes ago      Up <span class="token number">16</span> minutes                           busybox1</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>下面通过 ping 来证明 busybox1 容器和 busybox2 容器建立了互联关系。</p>\n<p>在 busybox1 容器输入以下命令</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="27566673313897484000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`/ # ping busybox2\nPING busybox2 (172.19.0.3): 56 data bytes\n64 bytes from 172.19.0.3: seq=0 ttl=64 time=0.072 ms\n64 bytes from 172.19.0.3: seq=1 ttl=64 time=0.118 ms`, `27566673313897484000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">/ <span class="token comment"># ping busybox2</span>\nPING busybox2 <span class="token punctuation">(</span><span class="token number">172.19</span>.0.3<span class="token punctuation">)</span>: <span class="token number">56</span> data bytes\n<span class="token number">64</span> bytes from <span class="token number">172.19</span>.0.3: <span class="token assign-left variable">seq</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.072</span> ms\n<span class="token number">64</span> bytes from <span class="token number">172.19</span>.0.3: <span class="token assign-left variable">seq</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.118</span> ms</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>用 ping 来测试连接 busybox2 容器，它会解析成 172.19.0.3。</p>\n<p>同理在 busybox2 容器执行 ping busybox1，也会成功连接到。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="45458520544062850000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`/ # ping busybox1\nPING busybox1 (172.19.0.2): 56 data bytes\n64 bytes from 172.19.0.2: seq=0 ttl=64 time=0.064 ms\n64 bytes from 172.19.0.2: seq=1 ttl=64 time=0.143 ms`, `45458520544062850000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">/ <span class="token comment"># ping busybox1</span>\nPING busybox1 <span class="token punctuation">(</span><span class="token number">172.19</span>.0.2<span class="token punctuation">)</span>: <span class="token number">56</span> data bytes\n<span class="token number">64</span> bytes from <span class="token number">172.19</span>.0.2: <span class="token assign-left variable">seq</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.064</span> ms\n<span class="token number">64</span> bytes from <span class="token number">172.19</span>.0.2: <span class="token assign-left variable">seq</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.143</span> ms</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样，busybox1 容器和 busybox2 容器建立了互联关系。</p>\n<h3 id="docker-compose"><a href="#docker-compose" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Docker Compose</h3>\n<p>如果你有多个容器之间需要互相连接，推荐使用 Docker Compose。</p>\n<h2 id="配置-dns"><a href="#%E9%85%8D%E7%BD%AE-dns" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>配置 DNS</h2>\n<p>如何自定义配置容器的主机名和 DNS 呢？秘诀就是 Docker 利用虚拟文件来挂载容器的 3 个相关配置文件。</p>\n<p>在容器中使用 mount 命令可以看到挂载信息：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="62491697572617740000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ mount\n/dev/disk/by-uuid/1fec...ebdf on /etc/hostname type ext4 ...\n/dev/disk/by-uuid/1fec...ebdf on /etc/hosts type ext4 ...\ntmpfs on /etc/resolv.conf type tmpfs ...`, `62491697572617740000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ <span class="token function">mount</span>\n/dev/disk/by-uuid/1fec<span class="token punctuation">..</span>.ebdf on /etc/hostname <span class="token builtin class-name">type</span> ext4 <span class="token punctuation">..</span>.\n/dev/disk/by-uuid/1fec<span class="token punctuation">..</span>.ebdf on /etc/hosts <span class="token builtin class-name">type</span> ext4 <span class="token punctuation">..</span>.\ntmpfs on /etc/resolv.conf <span class="token builtin class-name">type</span> tmpfs <span class="token punctuation">..</span>.</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这种机制可以让宿主主机 DNS 信息发生更新后，所有 Docker 容器的 DNS 配置通过 <code class="language-text">/etc/resolv.conf</code> 文件立刻得到更新。</p>\n<p>配置全部容器的 DNS，也可以在 <code class="language-text">/etc/docker/daemon.json</code> 文件中增加以下内容来设置。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="81411881855124230000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`{\n  &quot;dns&quot;: [&quot;114.114.114.114&quot;, &quot;8.8.8.8&quot;]\n}`, `81411881855124230000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="json"\n              >\n                <span class="gatsby-code-button-language">json</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="json"><pre style="counter-reset: linenumber NaN" class="language-json line-numbers"><code class="language-json"><span class="token punctuation">{</span>\n  <span class="token property">"dns"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"114.114.114.114"</span><span class="token punctuation">,</span> <span class="token string">"8.8.8.8"</span><span class="token punctuation">]</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>这样每次启动的容器 DNS 自动配置为 <code class="language-text">114.114.114.114</code> 和 <code class="language-text">8.8.8.8</code>。使用以下命令来证明其已经生效。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="10057662019112446000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run -it --rm ubuntu:18.04 cat etc/resolv.conf\n\nnameserver 114.114.114.114\nnameserver 8.8.8.8`, `10057662019112446000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run -it --rm ubuntu:18.04 <span class="token function">cat</span> etc/resolv.conf\n\nnameserver <span class="token number">114.114</span>.114.114\nnameserver <span class="token number">8.8</span>.8.8</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果用户想要手动指定容器的配置，可以在使用 docker run 命令启动容器时加入如下参数：</p>\n<p><code class="language-text">-h HOSTNAME</code> 或者 <code class="language-text">--hostname=HOSTNAME</code> 设定容器的主机名，它会被写到容器内的 <code class="language-text">/etc/hostname</code> 和 <code class="language-text">/etc/hosts</code>。但它在容器外部看不到，既不会在 <code class="language-text">docker container ls</code> 中显示，也不会在其他的容器的 <code class="language-text">/etc/hosts</code> 看到。</p>\n<p><code class="language-text">--dns=IP_ADDRESS</code> 添加 DNS 服务器到容器的 <code class="language-text">/etc/resolv.conf</code> 中，让容器用这个服务器来解析所有不在 <code class="language-text">/etc/hosts</code> 中的主机名。</p>\n<p><code class="language-text">--dns-search=DOMAIN</code> 设定容器的搜索域，当设定搜索域为 <code class="language-text">.example.com</code> 时，在搜索一个名为 host 的主机时，DNS 不仅搜索 host，还会搜索 <code class="language-text">host.example.com</code>。</p>\n<p>注意：如果在容器启动时没有指定最后两个参数，Docker 会默认用主机上的 <code class="language-text">/etc/resolv.conf</code> 来配置容器。</p>\n<h1 id="高级网络配置"><a href="#%E9%AB%98%E7%BA%A7%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>高级网络配置</h1>\n<p>本章将介绍 Docker 的一些高级网络配置和选项。</p>\n<p>当 Docker 启动时，会自动在主机上创建一个 docker0 虚拟网桥，实际上是 Linux 的一个 bridge，可以理解为一个软件交换机。它会在挂载到它的网口之间进行转发。</p>\n<p>同时，Docker 随机分配一个本地未占用的私有网段（在 RFC1918 中定义）中的一个地址给 docker0 接口。比如典型的 <code class="language-text">172.17.42.1</code>，掩码为 <code class="language-text">255.255.0.0</code>。此后启动的容器内的网口也会自动分配一个同一网段（172.17.0.0/16）的地址。</p>\n<p>当创建一个 Docker 容器的时候，同时会创建了一对 <code class="language-text">veth pair</code> 接口（当数据包发送到一个接口时，另外一个接口也可以收到相同的数据包）。这对接口一端在容器内，即 eth0；另一端在本地并被挂载到 docker0 网桥，名称以 veth 开头（例如 vethAQI2QT）。通过这种方式，主机可以跟容器通信，容器之间也可以相互通信。Docker 就创建了在主机和所有容器之间一个虚拟共享网络。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-07-18-14-38-31-406d237313be1836c53fa30dee8bd076-b7caf.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 63.76172090457805%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsSAAALEgHS3X78AAACy0lEQVQ4y11S23LTSBDNxy9P1L5AQZEAtS8LVCULVSSYwFLEsnwhbIiDHfkSsr7EsS4jjXX1SJbj9KGVBCrwcKp7WqfPnOnWWqrCvkpmMh4eOPPhvpgP9kU8/E/MI0+kKhKWeyImTktMhSHO7JbwA0vkWSwmliPap6YwBqZocZzaQmQqtNe4KbhYREgbT7HUH2BZfYj80xPwNyzzFN+mOg4HL3E02ub4CmI2ACjH4YmJZx+H2KyM8XxvhNaphUJnTanIy5UPd2/jsv/yDnW2/qBZeZ0S36QsTag70qikr9MbbZ3Kh3+TIwd0uVT0pTehR//UaWPzA62/2id2SXkarAqHMlMzKG2DpHEXovsn0sojhPIcaRrDGGmMJxhP7mG/vwlTfANdKHw6NrFV/oLR2X1saS066EyxzK4EQ5mlIeJhk2ZmA+K8hmTURBK6UPMQtvs/pvYBbLuOc6cD37fAM8SZ6eBkNIZt6egNz2hqu8gUC6p5IPNFgny1oDgOIT0Xy1WORRYhY6yWKZIogOcKzjMsFjEKAxd5jMtlAuE4nEd0wTlrXTtU8wi+NyUp/4LnPcbMHcNloutYkCwUBNsIo4eIwi4EO/GEyVEiDHWY1l1I2aCZ5yNV/mptsYikawvopa/UO3qPfmsX1d0jaDttVN60r2L13x3UtWfQSjVUdgyuf0V520CzXsNpZwefyzU60Pv8opAFs0h6jkCl1KLydhcF9FIb+tsbcF7be46adg/V91XUdnuovTvmS4vLDOb3sff6mJqN7rVg8WQGP88mT1gowPkNLPjSQxx9RJK8gDU9QtfoodNuYTIe8TicG75FvuQl3l4KO6ViEb8ihj9zEPgewoD/VZ5dHEkefjGv8Db3qvfnUopGPhADt1E0Gcc8z/IHNA8/o1Gv8DLOWSDBb1wquFeCbPNaUF0Xb6MgZ2n0U7zIf9R/1H4X/A5Lt609X+QIKgAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 07 18 14 38 31" title="" data-src="/static/2022-07-18-14-38-31-406d237313be1836c53fa30dee8bd076-fee1c.png" data-srcset="/static/2022-07-18-14-38-31-406d237313be1836c53fa30dee8bd076-a67b7.png 200w,\n/static/2022-07-18-14-38-31-406d237313be1836c53fa30dee8bd076-0b187.png 400w,\n/static/2022-07-18-14-38-31-406d237313be1836c53fa30dee8bd076-fee1c.png 800w,\n/static/2022-07-18-14-38-31-406d237313be1836c53fa30dee8bd076-b1a91.png 1200w,\n/static/2022-07-18-14-38-31-406d237313be1836c53fa30dee8bd076-95179.png 1600w,\n/static/2022-07-18-14-38-31-406d237313be1836c53fa30dee8bd076-b7caf.png 1813w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>接下来的部分将介绍在一些场景中，Docker 所有的网络定制配置。以及通过 Linux 命令来调整、补充、甚至替换 Docker 默认的网络配置。</p>\n<h2 id="快速配置指南"><a href="#%E5%BF%AB%E9%80%9F%E9%85%8D%E7%BD%AE%E6%8C%87%E5%8D%97" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>快速配置指南</h2>\n<p>下面是一个跟 Docker 网络相关的命令列表。</p>\n<p>其中有些命令选项只有在 Docker 服务启动的时候才能配置，而且不能马上生效。</p>\n<ul>\n<li><code class="language-text">-b BRIDGE</code> 或 <code class="language-text">--bridge=BRIDGE</code> 指定容器挂载的网桥</li>\n<li><code class="language-text">--bip=CIDR</code> 定制 docker0 的掩码</li>\n<li><code class="language-text">-H SOCKET...</code> 或 <code class="language-text">--host=SOCKET... Docker</code> 服务端接收命令的通道</li>\n<li><code class="language-text">--icc=true|false</code> 是否支持容器之间进行通信</li>\n<li><code class="language-text">--ip-forward=true|false</code> 请看下文容器之间的通信</li>\n<li><code class="language-text">--iptables=true|false</code> 是否允许 Docker 添加 iptables 规则</li>\n<li><code class="language-text">--mtu=BYTES</code> 容器网络中的 MTU</li>\n</ul>\n<p>下面 2 个命令选项既可以在启动服务时指定，也可以在启动容器时指定。在 Docker 服务启动的时候指定则会成为默认值，后面执行 docker run 时可以覆盖设置的默认值。</p>\n<ul>\n<li><code class="language-text">--dns=IP_ADDRESS...</code> 使用指定的 DNS 服务器</li>\n<li><code class="language-text">--dns-search=DOMAIN...</code> 指定 DNS 搜索域</li>\n</ul>\n<p>最后这些选项只有在 docker run 执行时使用，因为它是针对容器的特性内容。</p>\n<ul>\n<li><code class="language-text">-h HOSTNAME</code> 或 <code class="language-text">--hostname=HOSTNAME</code> 配置容器主机名</li>\n<li><code class="language-text">--link=CONTAINER_NAME:ALIAS</code> 添加到另一个容器的连接</li>\n<li><code class="language-text">--net=bridge|none|container:NAME_or_ID|host</code> 配置容器的桥接模式</li>\n<li><code class="language-text">-p SPEC</code> 或 <code class="language-text">--publish=SPEC</code> 映射容器端口到宿主主机</li>\n<li><code class="language-text">-P</code> 或 <code class="language-text">--publish-all=true|false</code> 映射容器所有端口到宿主主机</li>\n</ul>\n<h2 id="容器访问控制"><a href="#%E5%AE%B9%E5%99%A8%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>容器访问控制</h2>\n<p>容器的访问控制，主要通过 Linux 上的 iptables 防火墙来进行管理和实现。iptables 是 Linux 上默认的防火墙软件，在大部分发行版中都自带。</p>\n<h3 id="容器访问外部网络"><a href="#%E5%AE%B9%E5%99%A8%E8%AE%BF%E9%97%AE%E5%A4%96%E9%83%A8%E7%BD%91%E7%BB%9C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>容器访问外部网络</h3>\n<p>容器要想访问外部网络，需要本地系统的转发支持。在 Linux 系统中，检查转发是否打开。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="47504212561822000000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$sysctl net.ipv4.ip_forward\nnet.ipv4.ip_forward = 1`, `47504212561822000000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token variable">$sysctl</span> net.ipv4.ip_forward\nnet.ipv4.ip_forward <span class="token operator">=</span> <span class="token number">1</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>如果为 0，说明没有开启转发，则需要手动打开。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="57039912677702970000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$sysctl -w net.ipv4.ip_forward=1`, `57039912677702970000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token variable">$sysctl</span> -w net.ipv4.ip_forward<span class="token operator">=</span><span class="token number">1</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>如果在启动 Docker 服务的时候设定 <code class="language-text">--ip-forward=true</code>, Docker 就会自动设定系统的 <code class="language-text">ip_forward</code> 参数为 1。</p>\n<h3 id="容器之间访问"><a href="#%E5%AE%B9%E5%99%A8%E4%B9%8B%E9%97%B4%E8%AE%BF%E9%97%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>容器之间访问</h3>\n<p>容器之间相互访问，需要两方面的支持。</p>\n<ol>\n<li>容器的网络拓扑是否已经互联。默认情况下，所有容器都会被连接到 docker0 网桥上。</li>\n<li>本地系统的防火墙软件 <code class="language-text">iptables</code> 是否允许通过。</li>\n</ol>\n<h4 id="访问所有端口"><a href="#%E8%AE%BF%E9%97%AE%E6%89%80%E6%9C%89%E7%AB%AF%E5%8F%A3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>访问所有端口</h4>\n<p>当启动 Docker 服务（即 dockerd）的时候，默认会添加一条转发策略到本地主机 iptables 的 FORWARD 链上。策略为通过（ACCEPT）还是禁止（DROP）取决于配置<code class="language-text">--icc=true</code>（缺省值）还是 <code class="language-text">--icc=false</code>。当然，如果手动指定 <code class="language-text">--iptables=false</code> 则不会添加 iptables 规则。</p>\n<p>可见，默认情况下，不同容器之间是允许网络互通的。如果为了安全考虑，可以在 <code class="language-text">/etc/docker/daemon.json</code> 文件中配置 <code class="language-text">{&quot;icc&quot;: false}</code> 来禁止它。</p>\n<h4 id="访问指定端口"><a href="#%E8%AE%BF%E9%97%AE%E6%8C%87%E5%AE%9A%E7%AB%AF%E5%8F%A3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>访问指定端口</h4>\n<p>在通过 <code class="language-text">--icc=false</code> 关闭网络访问后，还可以通过 <code class="language-text">--link=CONTAINER_NAME:ALIAS</code> 选项来访问容器的开放端口。</p>\n<p>例如，在启动 Docker 服务时，可以同时使用 <code class="language-text">--icc=false --iptables=true</code> 参数来关闭允许相互的网络访问，并让 Docker 可以修改系统中的 iptables 规则。</p>\n<p>此时，系统中的 iptables 规则可能是类似</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="64498007998140270000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ sudo iptables -nL\n...\nChain FORWARD (policy ACCEPT)\ntarget     prot opt source               destination\nDROP       all  --  0.0.0.0/0            0.0.0.0/0\n...`, `64498007998140270000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ <span class="token function">sudo</span> iptables -nL\n<span class="token punctuation">..</span>.\nChain FORWARD <span class="token punctuation">(</span>policy ACCEPT<span class="token punctuation">)</span>\ntarget     prot opt <span class="token builtin class-name">source</span>               destination\nDROP       all  --  <span class="token number">0.0</span>.0.0/0            <span class="token number">0.0</span>.0.0/0\n<span class="token punctuation">..</span>.</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>之后，启动容器（docker run）时使用 <code class="language-text">--link=CONTAINER_NAME:ALIAS</code> 选项。Docker 会在 iptable 中为两个容器分别添加一条 ACCEPT 规则，允许相互访问开放的端口（取决于 Dockerfile 中的 EXPOSE 指令）。</p>\n<p>当添加了 <code class="language-text">--link=CONTAINER_NAME:ALIAS</code> 选项后，添加了 iptables 规则。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="92453224520448800000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ sudo iptables -nL\n...\nChain FORWARD (policy ACCEPT)\ntarget     prot opt source               destination\nACCEPT     tcp  --  172.17.0.2           172.17.0.3           tcp spt:80\nACCEPT     tcp  --  172.17.0.3           172.17.0.2           tcp dpt:80\nDROP       all  --  0.0.0.0/0            0.0.0.0/0`, `92453224520448800000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ <span class="token function">sudo</span> iptables -nL\n<span class="token punctuation">..</span>.\nChain FORWARD <span class="token punctuation">(</span>policy ACCEPT<span class="token punctuation">)</span>\ntarget     prot opt <span class="token builtin class-name">source</span>               destination\nACCEPT     tcp  --  <span class="token number">172.17</span>.0.2           <span class="token number">172.17</span>.0.3           tcp spt:80\nACCEPT     tcp  --  <span class="token number">172.17</span>.0.3           <span class="token number">172.17</span>.0.2           tcp dpt:80\nDROP       all  --  <span class="token number">0.0</span>.0.0/0            <span class="token number">0.0</span>.0.0/0</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>注意：<code class="language-text">--link=CONTAINER_NAME:ALIAS</code> 中的 CONTAINER_NAME 目前必须是 Docker 分配的名字，或使用 <code class="language-text">--name</code> 参数指定的名字。主机名则不会被识别。</p>\n<h2 id="映射容器端口到宿主主机的实现"><a href="#%E6%98%A0%E5%B0%84%E5%AE%B9%E5%99%A8%E7%AB%AF%E5%8F%A3%E5%88%B0%E5%AE%BF%E4%B8%BB%E4%B8%BB%E6%9C%BA%E7%9A%84%E5%AE%9E%E7%8E%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>映射容器端口到宿主主机的实现</h2>\n<p>默认情况下，容器可以主动访问到外部网络的连接，但是外部网络无法访问到容器。</p>\n<h3 id="容器访问外部实现"><a href="#%E5%AE%B9%E5%99%A8%E8%AE%BF%E9%97%AE%E5%A4%96%E9%83%A8%E5%AE%9E%E7%8E%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>容器访问外部实现</h3>\n<p>容器所有到外部网络的连接，源地址都会被 NAT 成本地系统的 IP 地址。这是使用 iptables 的源地址伪装操作实现的。</p>\n<p>查看主机的 NAT 规则。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="5177784993542333000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ sudo iptables -t nat -nL\n...\nChain POSTROUTING (policy ACCEPT)\ntarget     prot opt source               destination\nMASQUERADE  all  --  172.17.0.0/16       !172.17.0.0/16\n...`, `5177784993542333000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ <span class="token function">sudo</span> iptables -t nat -nL\n<span class="token punctuation">..</span>.\nChain POSTROUTING <span class="token punctuation">(</span>policy ACCEPT<span class="token punctuation">)</span>\ntarget     prot opt <span class="token builtin class-name">source</span>               destination\nMASQUERADE  all  --  <span class="token number">172.17</span>.0.0/16       <span class="token operator">!</span><span class="token number">172.17</span>.0.0/16\n<span class="token punctuation">..</span>.</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>其中，上述规则将所有源地址在 <code class="language-text">172.17.0.0/16</code> 网段，目标地址为其他网段（外部网络）的流量动态伪装为从系统网卡发出。MASQUERADE 跟传统 SNAT 的好处是它能动态从网卡获取地址。</p>\n<h3 id="外部访问容器实现"><a href="#%E5%A4%96%E9%83%A8%E8%AE%BF%E9%97%AE%E5%AE%B9%E5%99%A8%E5%AE%9E%E7%8E%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>外部访问容器实现</h3>\n<p>容器允许外部访问，可以在 docker run 时候通过 -p 或 -P 参数来启用。</p>\n<p>不管用那种办法，其实也是在本地的 iptable 的 nat 表中添加相应的规则。</p>\n<p>使用 -P 时：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="63402344018595725000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ iptables -t nat -nL\n...\nChain DOCKER (2 references)\ntarget     prot opt source               destination\nDNAT       tcp  --  0.0.0.0/0            0.0.0.0/0            tcp dpt:49153 to:172.17.0.2:80`, `63402344018595725000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ iptables -t nat -nL\n<span class="token punctuation">..</span>.\nChain DOCKER <span class="token punctuation">(</span><span class="token number">2</span> references<span class="token punctuation">)</span>\ntarget     prot opt <span class="token builtin class-name">source</span>               destination\nDNAT       tcp  --  <span class="token number">0.0</span>.0.0/0            <span class="token number">0.0</span>.0.0/0            tcp dpt:49153 to:172.17.0.2:80</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>使用 -p 80:80 时：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="4107636134801517600"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ iptables -t nat -nL\nChain DOCKER (2 references)\ntarget     prot opt source               destination\nDNAT       tcp  --  0.0.0.0/0            0.0.0.0/0            tcp dpt:80 to:172.17.0.2:80`, `4107636134801517600`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ iptables -t nat -nL\nChain DOCKER <span class="token punctuation">(</span><span class="token number">2</span> references<span class="token punctuation">)</span>\ntarget     prot opt <span class="token builtin class-name">source</span>               destination\nDNAT       tcp  --  <span class="token number">0.0</span>.0.0/0            <span class="token number">0.0</span>.0.0/0            tcp dpt:80 to:172.17.0.2:80</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>注意：</p>\n<ul>\n<li>\n<p>这里的规则映射了 <code class="language-text">0.0.0.0</code>，意味着将接受主机来自所有接口的流量。用户可以通过 <code class="language-text">-p IP:host_port:container_port</code> 或 <code class="language-text">-p IP::port</code> 来指定允许访问容器的主机上的 IP、接口等，以制定更严格的规则。</p>\n</li>\n<li>\n<p>如果希望永久绑定到某个固定的 IP 地址，可以在 Docker 配置文件 <code class="language-text">/etc/docker/daemon.json</code> 中添加如下内容。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="58384385305505560000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`{\n&quot;ip&quot;: &quot;0.0.0.0&quot;\n}`, `58384385305505560000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="json"\n              >\n                <span class="gatsby-code-button-language">json</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="json"><pre style="counter-reset: linenumber NaN" class="language-json line-numbers"><code class="language-json"><span class="token punctuation">{</span>\n<span class="token property">"ip"</span><span class="token operator">:</span> <span class="token string">"0.0.0.0"</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n</li>\n</ul>\n<h2 id="自定义网桥"><a href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BD%91%E6%A1%A5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>自定义网桥</h2>\n<p>除了默认的 docker0 网桥，用户也可以指定网桥来连接各个容器。</p>\n<p>在启动 Docker 服务的时候，使用 <code class="language-text">-b BRIDGE</code> 或 <code class="language-text">--bridge=BRIDGE</code> 来指定使用的网桥。</p>\n<p>如果服务已经运行，那需要先停止服务，并删除旧的网桥。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="47171568446387370000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ sudo systemctl stop docker\n\\$ sudo ip link set dev docker0 down\n\\$ sudo brctl delbr docker0`, `47171568446387370000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ <span class="token function">sudo</span> systemctl stop docker\n$ <span class="token function">sudo</span> <span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> dev docker0 down\n$ <span class="token function">sudo</span> brctl delbr docker0</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>然后创建一个网桥 bridge0。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="38733214157222110000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ sudo brctl addbr bridge0\n\\$ sudo ip addr add 192.168.5.1/24 dev bridge0\n\\$ sudo ip link set dev bridge0 up`, `38733214157222110000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ <span class="token function">sudo</span> brctl addbr bridge0\n$ <span class="token function">sudo</span> <span class="token function">ip</span> addr <span class="token function">add</span> <span class="token number">192.168</span>.5.1/24 dev bridge0\n$ <span class="token function">sudo</span> <span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> dev bridge0 up</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>查看确认网桥创建并启动。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="63742658820587140000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ ip addr show bridge0\n4: bridge0: <BROADCAST,MULTICAST> mtu 1500 qdisc noop state UP group default\n    link/ether 66:38:d0:0d:76:18 brd ff:ff:ff:ff:ff:ff\n    inet 192.168.5.1/24 scope global bridge0\n       valid_lft forever preferred_lft forever`, `63742658820587140000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ <span class="token function">ip</span> addr show bridge0\n<span class="token number">4</span>: bridge0: <span class="token operator">&lt;</span>BROADCAST,MULTICAST<span class="token operator">></span> mtu <span class="token number">1500</span> qdisc noop state UP group default\n    link/ether <span class="token number">66</span>:38:d0:0d:76:18 brd ff:ff:ff:ff:ff:ff\n    inet <span class="token number">192.168</span>.5.1/24 scope global bridge0\n       valid_lft forever preferred_lft forever</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在 Docker 配置文件 <code class="language-text">/etc/docker/daemon.json</code> 中添加如下内容，即可将 Docker 默认桥接到创建的网桥上。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="41798604765248130000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`{\n  &quot;bridge&quot;: &quot;bridge0&quot;\n}`, `41798604765248130000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="json"\n              >\n                <span class="gatsby-code-button-language">json</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="json"><pre style="counter-reset: linenumber NaN" class="language-json line-numbers"><code class="language-json"><span class="token punctuation">{</span>\n  <span class="token property">"bridge"</span><span class="token operator">:</span> <span class="token string">"bridge0"</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>启动 Docker 服务。</p>\n<p>新建一个容器，可以看到它已经桥接到了 bridge0 上。</p>\n<p>可以继续用 brctl show 命令查看桥接的信息。另外，在容器中可以使用 ip addr 和 ip route 命令来查看 IP 地址配置和路由信息。</p>\n<h2 id="工具和示例"><a href="#%E5%B7%A5%E5%85%B7%E5%92%8C%E7%A4%BA%E4%BE%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>工具和示例</h2>\n<p>在介绍自定义网络拓扑之前，你可能会对一些外部工具和例子感兴趣：</p>\n<h3 id="pipework"><a href="#pipework" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>pipework</h3>\n<p>Jérôme Petazzoni 编写了一个叫 <a href="https://github.com/jpetazzo/pipework" target="_blank" rel="nofollow noreferrer noopener">pipework</a> 的 shell 脚本，可以帮助用户在比较复杂的场景中完成容器的连接。</p>\n<h3 id="playground"><a href="#playground" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>playground</h3>\n<p>Brandon Rhodes 创建了一个提供完整的 Docker 容器网络拓扑管理的 <a href="https://github.com/brandon-rhodes/fopnp/tree/m/playground" target="_blank" rel="nofollow noreferrer noopener">Python 库</a>，包括路由、NAT 防火墙；以及一些提供 HTTP SMTP POP IMAP Telnet SSH FTP 的服务器。</p>\n<h2 id="编辑网络配置文件"><a href="#%E7%BC%96%E8%BE%91%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>编辑网络配置文件</h2>\n<p>Docker 1.2.0 开始支持在运行中的容器里编辑 <code class="language-text">/etc/hosts</code>, <code class="language-text">/etc/hostname</code> 和 <code class="language-text">/etc/resolv.conf</code> 文件。</p>\n<p>但是这些修改是临时的，只在运行的容器中保留，容器终止或重启后并不会被保存下来，也不会被 <code class="language-text">docker commit</code> 提交。</p>\n<h2 id="示例：创建一个点到点连接"><a href="#%E7%A4%BA%E4%BE%8B%EF%BC%9A%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E7%82%B9%E5%88%B0%E7%82%B9%E8%BF%9E%E6%8E%A5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>示例：创建一个点到点连接</h2>\n<p>默认情况下，Docker 会将所有容器连接到由 docker0 提供的虚拟子网中。</p>\n<p>用户有时候需要两个容器之间可以直连通信，而不用通过主机网桥进行桥接。</p>\n<p>解决办法很简单：创建一对 peer 接口，分别放到两个容器中，配置成点到点链路类型即可。</p>\n<p>首先启动 2 个容器：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="32233684083521540000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run -i -t --rm --net=none base /bin/bash\nroot@1f1f4c1f931a:/#\n\\$ docker run -i -t --rm --net=none base /bin/bash\nroot@12e343489d2f:/#`, `32233684083521540000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run -i -t --rm --net<span class="token operator">=</span>none base /bin/bash\nroot@1f1f4c1f931a:/<span class="token comment">#</span>\n$ docker run -i -t --rm --net<span class="token operator">=</span>none base /bin/bash\nroot@12e343489d2f:/<span class="token comment">#</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>找到进程号，然后创建网络命名空间的跟踪文件。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="95643233686255730000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker inspect -f \'{{.State.Pid}}\' 1f1f4c1f931a\n2989\n\\$ docker inspect -f \'{{.State.Pid}}\' 12e343489d2f\n3004\n\\$ sudo mkdir -p /var/run/netns\n\\$ sudo ln -s /proc/2989/ns/net /var/run/netns/2989\n\\$ sudo ln -s /proc/3004/ns/net /var/run/netns/3004`, `95643233686255730000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker inspect -f <span class="token string">\'{{.State.Pid}}\'</span> 1f1f4c1f931a\n<span class="token number">2989</span>\n$ docker inspect -f <span class="token string">\'{{.State.Pid}}\'</span> 12e343489d2f\n<span class="token number">3004</span>\n$ <span class="token function">sudo</span> <span class="token function">mkdir</span> -p /var/run/netns\n$ <span class="token function">sudo</span> <span class="token function">ln</span> -s /proc/2989/ns/net /var/run/netns/2989\n$ <span class="token function">sudo</span> <span class="token function">ln</span> -s /proc/3004/ns/net /var/run/netns/3004</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>创建一对 peer 接口，然后配置路由</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="4562638229961901600"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ sudo ip link add A type veth peer name B\n\n\\$ sudo ip link set A netns 2989\n\\$ sudo ip netns exec 2989 ip addr add 10.1.1.1/32 dev A\n\\$ sudo ip netns exec 2989 ip link set A up\n\\$ sudo ip netns exec 2989 ip route add 10.1.1.2/32 dev A\n\n\\$ sudo ip link set B netns 3004\n\\$ sudo ip netns exec 3004 ip addr add 10.1.1.2/32 dev B\n\\$ sudo ip netns exec 3004 ip link set B up\n\\$ sudo ip netns exec 3004 ip route add 10.1.1.1/32 dev B`, `4562638229961901600`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ <span class="token function">sudo</span> <span class="token function">ip</span> <span class="token function">link</span> <span class="token function">add</span> A <span class="token builtin class-name">type</span> veth peer name B\n\n$ <span class="token function">sudo</span> <span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> A netns <span class="token number">2989</span>\n$ <span class="token function">sudo</span> <span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> <span class="token number">2989</span> <span class="token function">ip</span> addr <span class="token function">add</span> <span class="token number">10.1</span>.1.1/32 dev A\n$ <span class="token function">sudo</span> <span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> <span class="token number">2989</span> <span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> A up\n$ <span class="token function">sudo</span> <span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> <span class="token number">2989</span> <span class="token function">ip</span> route <span class="token function">add</span> <span class="token number">10.1</span>.1.2/32 dev A\n\n$ <span class="token function">sudo</span> <span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> B netns <span class="token number">3004</span>\n$ <span class="token function">sudo</span> <span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> <span class="token number">3004</span> <span class="token function">ip</span> addr <span class="token function">add</span> <span class="token number">10.1</span>.1.2/32 dev B\n$ <span class="token function">sudo</span> <span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> <span class="token number">3004</span> <span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> B up\n$ <span class="token function">sudo</span> <span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> <span class="token number">3004</span> <span class="token function">ip</span> route <span class="token function">add</span> <span class="token number">10.1</span>.1.1/32 dev B</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在这 2 个容器就可以相互 ping 通，并成功建立连接。点到点链路不需要子网和子网掩码。</p>\n<p>此外，也可以不指定 <code class="language-text">--net=none</code> 来创建点到点链路。这样容器还可以通过原先的网络来通信。</p>\n<p>利用类似的办法，可以创建一个只跟主机通信的容器。但是一般情况下，更推荐使用 <code class="language-text">--icc=false</code> 来关闭容器之间的通信。</p>\n<h1 id="swarm-mode"><a href="#swarm-mode" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Swarm mode</h1>\n<p>Docker 1.12 <a href="https://docs.docker.com/engine/swarm/" target="_blank" rel="nofollow noreferrer noopener">Swarm mode</a> 已经内嵌入 Docker 引擎，成为了 docker 子命令 docker swarm。请注意与旧的 Docker Swarm 区分开来。</p>\n<p>Swarm mode 内置 kv 存储功能，提供了众多的新特性，比如：具有容错能力的去中心化设计、内置服务发现、负载均衡、路由网格、动态伸缩、滚动更新、安全传输等。使得 Docker 原生的 Swarm 集群具备与 Mesos、Kubernetes 竞争的实力。</p>\n<h2 id="基本概念-1"><a href="#%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>基本概念</h2>\n<p>Swarm 是使用 <a href="https://github.com/docker/swarmkit/" target="_blank" rel="nofollow noreferrer noopener">SwarmKit</a> 构建的 Docker 引擎内置（原生）的集群管理和编排工具。</p>\n<p>使用 Swarm 集群之前需要了解以下几个概念。</p>\n<h3 id="节点"><a href="#%E8%8A%82%E7%82%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>节点</h3>\n<p>运行 Docker 的主机可以主动初始化一个 Swarm 集群或者加入一个已存在的 Swarm 集群，这样这个运行 Docker 的主机就成为一个 Swarm 集群的节点 (node) 。</p>\n<p>节点分为管理 (manager) 节点和工作 (worker) 节点。</p>\n<p>管理节点用于 Swarm 集群的管理，docker swarm 命令基本只能在管理节点执行（节点退出集群命令 <code class="language-text">docker swarm leave</code> 可以在工作节点执行）。一个 Swarm 集群可以有多个管理节点，但只有一个管理节点可以成为 leader，leader 通过 <a href="https://thesecretlivesofdata.com/raft/" target="_blank" rel="nofollow noreferrer noopener">raft 协议</a>实现。</p>\n<p>工作节点是任务执行节点，管理节点将服务 (service) 下发至工作节点执行。管理节点默认也作为工作节点。你也可以通过配置让服务只运行在管理节点。</p>\n<p>来自 Docker 官网的这张图片形象的展示了集群中管理节点与工作节点的关系。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-07-19-11-16-29-db0a7eee4e4ce292445a5148537ae9ac-d1d8a.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 46.893123446561724%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAAsSAAALEgHS3X78AAABmUlEQVQoz22PWU/bQBSF8///QougahRE+1CQKgQq0DYtSI2VhpSgxCFexmPH+9iexZ7FS90AD7Q9Ojq69+HTuXfQ7dR2HVEt4s2jc9n1Lh5TdRHldpyDpIAJTih/Qtp20D0rKOtpJLRYTkJxZaSXm/ji4Y8/m2io2ad6fO2xW594RDbtP3BcNdOQj91SC/jUZ9cQX1r5jUt+BmwM8FfItEjYtEl4W+/oF3BUNd8hOV+4exPn7QJ9Afhi5b+eOG/u0m+QflpuX/0AV4BkslV/we2ueRFXmh0Nb/0TPbWwmm+Lw1/BxzWysJy52WgenBo5kv9rZqImlapk3XRdnwlmlWq4ajDjOeP9o3XbUV7z5hno4URKm1CAscvYA8piJWDJbFyEguspAkVhZLlXMq+k/RCKysxzWJaoVkjKwbwojgxjf+UcO95obQwN/wSA/aX9wfFH682hGbwzreEaHNn+e8M40N1jAA+WmzOYBoIPQiE8KeaIWiUHFZ+lxJfiPmc6Lj0hZil1hVgV7D6jgZL9ahI6dYOxue2P+g2C3u29d5l6SwAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 07 19 11 16 29" title="" data-src="/static/2022-07-19-11-16-29-db0a7eee4e4ce292445a5148537ae9ac-fee1c.png" data-srcset="/static/2022-07-19-11-16-29-db0a7eee4e4ce292445a5148537ae9ac-a67b7.png 200w,\n/static/2022-07-19-11-16-29-db0a7eee4e4ce292445a5148537ae9ac-0b187.png 400w,\n/static/2022-07-19-11-16-29-db0a7eee4e4ce292445a5148537ae9ac-fee1c.png 800w,\n/static/2022-07-19-11-16-29-db0a7eee4e4ce292445a5148537ae9ac-b1a91.png 1200w,\n/static/2022-07-19-11-16-29-db0a7eee4e4ce292445a5148537ae9ac-d1d8a.png 1207w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h3 id="服务和任务"><a href="#%E6%9C%8D%E5%8A%A1%E5%92%8C%E4%BB%BB%E5%8A%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>服务和任务</h3>\n<p>任务（Task）是 Swarm 中的最小的调度单位，目前来说就是一个单一的容器。</p>\n<p>服务（Services）是指一组任务的集合，服务定义了任务的属性。服务有两种模式：</p>\n<ol>\n<li><code class="language-text">replicated services</code> 按照一定规则在各个工作节点上运行指定个数的任务。</li>\n<li><code class="language-text">global services</code> 每个工作节点上运行一个任务</li>\n</ol>\n<p>两种模式通过 <code class="language-text">docker service create</code> 的 <code class="language-text">--mode</code> 参数指定。</p>\n<p>来自 Docker 官网的这张图片形象的展示了容器、任务、服务的关系。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-07-19-11-16-53-f4c415047158c2dd2c692b7057088a9b-fee1c.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 69%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAIAAACgpqunAAAACXBIWXMAAAsSAAALEgHS3X78AAACF0lEQVQoz4VS227bMAzN/3/JHnfBuqJb16xp2mQN2mRYk665+iZbN9uKJcuWZGWyvZcBQ0cQgiTygDw8HJxeN2uXqw2mqbsCAFfP2+WvLeeijZxOg1eAjbXPnE8gekyzOWNTQsYRmGI8JiSW8tSDbZcnSlmIUmltux9nldLnfvBuvfscgRFjS4R9kLj6wzh+4bwF2y7RGLP3o5edl7FjX9OdR1FeRuArwjdpepPntwgvKF0Qeh7H2x5cmwYKRaRJeA1YRav2KVQja1UppWxTNQ1mxXLnraPYeaFUaYxumhbMVTMM5G2irsPS+QTpy0BGx0pr7cKZUlRrUtdJWfqce0IEUkZSii464LW5R2qO6/cPmzfjn3d+PiMGFLUj4tp2bM/C6CJOrtJ0CuETRKsEnQOwLrq2XdoEqhmUH+b7tw+7sccmuAU3xjAhLkF84YfXEM3KckXTgKY+It8gXPOiBTt6s6R6xMr5nGjXwndYJUWtu7HvhViX4inLbg7+2A/vQrA6skWW0arqBqabUttDQlYHsAnhj42fclk3VsiWtpu687KqEE1xzmDGKmOcFr2Wgz7811K1Up16qUYQDQkZUTpm+Qjje0qmCH0CYN9L9e+l7E5Z12cH7+N2/yUEE843hCKICcRjiF5eAfdmrF0wNsvzmeOM0DWIJxA+pOkQoaAs/wNu+3dmbX7kay/wYniIoeNs7J8N/g1ZjhJSNTR2XQAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 07 19 11 16 53" title="" data-src="/static/2022-07-19-11-16-53-f4c415047158c2dd2c692b7057088a9b-fee1c.png" data-srcset="/static/2022-07-19-11-16-53-f4c415047158c2dd2c692b7057088a9b-a67b7.png 200w,\n/static/2022-07-19-11-16-53-f4c415047158c2dd2c692b7057088a9b-0b187.png 400w,\n/static/2022-07-19-11-16-53-f4c415047158c2dd2c692b7057088a9b-fee1c.png 800w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h2 id="创建-swarm-集群"><a href="#%E5%88%9B%E5%BB%BA-swarm-%E9%9B%86%E7%BE%A4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>创建 Swarm 集群</h2>\n<p>Swarm 集群由管理节点和工作节点组成，本节我们来创建一个包含一个管理节点和两个工作节点的最小 Swarm 集群。</p>\n<h3 id="初始化集群"><a href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E9%9B%86%E7%BE%A4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>初始化集群</h3>\n<p>在已经安装好 Docker 的主机上执行如下命令：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="38422079650685360000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker swarm init --advertise-addr 192.168.99.100\nSwarm initialized: current node (dxn1zf6l61qsb1josjja83ngz) is now a manager.\n\nTo add a worker to this swarm, run the following command:\n\n    docker swarm join \\\n    --token SWMTKN-1-49nj1cmql0jkz5s954yi3oex3nedyz0fb0xx14ie39trti4wxv-8vxv8rssmk743ojnwacrr2e7c \\\n    192.168.99.100:2377\n\nTo add a manager to this swarm, run \'docker swarm join-token manager\' and follow the instructions.`, `38422079650685360000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker swarm init --advertise-addr <span class="token number">192.168</span>.99.100\nSwarm initialized: current node <span class="token punctuation">(</span>dxn1zf6l61qsb1josjja83ngz<span class="token punctuation">)</span> is now a manager.\n\nTo <span class="token function">add</span> a worker to this swarm, run the following command:\n\n    docker swarm <span class="token function">join</span> <span class="token punctuation">\\</span>\n    --token SWMTKN-1-49nj1cmql0jkz5s954yi3oex3nedyz0fb0xx14ie39trti4wxv-8vxv8rssmk743ojnwacrr2e7c <span class="token punctuation">\\</span>\n    <span class="token number">192.168</span>.99.100:2377\n\nTo <span class="token function">add</span> a manager to this swarm, run <span class="token string">\'docker swarm join-token manager\'</span> and follow the instructions.</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果你的 Docker 主机有多个网卡，拥有多个 IP，必须使用 <code class="language-text">--advertise-addr</code> 指定 IP。</p>\n<blockquote>\n<p>执行 <code class="language-text">docker swarm init</code> 命令的节点自动成为管理节点。</p>\n</blockquote>\n<h3 id="增加工作节点"><a href="#%E5%A2%9E%E5%8A%A0%E5%B7%A5%E4%BD%9C%E8%8A%82%E7%82%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>增加工作节点</h3>\n<p>上一步我们初始化了一个 Swarm 集群，拥有了一个管理节点，下面我们继续在两个 Docker 主机中分别执行如下命令，创建工作节点并加入到集群中。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="17538996509273730000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker swarm join \\\n    --token SWMTKN-1-49nj1cmql0jkz5s954yi3oex3nedyz0fb0xx14ie39trti4wxv-8vxv8rssmk743ojnwacrr2e7c \\\n    192.168.99.100:2377\n\nThis node joined a swarm as a worker.`, `17538996509273730000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker swarm <span class="token function">join</span> <span class="token punctuation">\\</span>\n    --token SWMTKN-1-49nj1cmql0jkz5s954yi3oex3nedyz0fb0xx14ie39trti4wxv-8vxv8rssmk743ojnwacrr2e7c <span class="token punctuation">\\</span>\n    <span class="token number">192.168</span>.99.100:2377\n\nThis node joined a swarm as a worker.</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="查看集群"><a href="#%E6%9F%A5%E7%9C%8B%E9%9B%86%E7%BE%A4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>查看集群</h3>\n<p>经过上边的两步，我们已经拥有了一个最小的 Swarm 集群，包含一个管理节点和两个工作节点。</p>\n<p>在管理节点使用 <code class="language-text">docker node ls</code> 查看集群。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="42004282660044950000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker node ls\nID                           HOSTNAME  STATUS  AVAILABILITY  MANAGER STATUS\n03g1y59jwfg7cf99w4lt0f662    worker2   Ready   Active\n9j68exjopxe7wfl6yuxml7a7j    worker1   Ready   Active\ndxn1zf6l61qsb1josjja83ngz *  manager   Ready   Active        Leader`, `42004282660044950000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker node <span class="token function">ls</span>\nID                           <span class="token environment constant">HOSTNAME</span>  STATUS  AVAILABILITY  MANAGER STATUS\n03g1y59jwfg7cf99w4lt0f662    worker2   Ready   Active\n9j68exjopxe7wfl6yuxml7a7j    worker1   Ready   Active\ndxn1zf6l61qsb1josjja83ngz *  manager   Ready   Active        Leader</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="部署服务"><a href="#%E9%83%A8%E7%BD%B2%E6%9C%8D%E5%8A%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>部署服务</h2>\n<p>我们使用 docker service 命令来管理 Swarm 集群中的服务，该命令只能在管理节点运行。</p>\n<h3 id="新建服务"><a href="#%E6%96%B0%E5%BB%BA%E6%9C%8D%E5%8A%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>新建服务</h3>\n<p>现在我们在上一节创建的 Swarm 集群中运行一个名为 nginx 服务。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="59745578128551460000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker service create --replicas 3 -p 80:80 --name nginx nginx:1.13.7-alpine`, `59745578128551460000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker <span class="token function">service</span> create --replicas <span class="token number">3</span> -p <span class="token number">80</span>:80 --name nginx nginx:1.13.7-alpine</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>现在我们使用浏览器，输入任意节点 IP（即 <code class="language-text">192.168.99.100:80</code>），即可看到 nginx 默认页面。</p>\n<h3 id="查看服务"><a href="#%E6%9F%A5%E7%9C%8B%E6%9C%8D%E5%8A%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>查看服务</h3>\n<p>使用 <code class="language-text">docker service ls</code> 来查看当前 Swarm 集群运行的服务。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="21400927403129377000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker service ls\nID                  NAME                MODE                REPLICAS            IMAGE                 PORTS\nkc57xffvhul5        nginx               replicated          3/3                 nginx:1.13.7-alpine   *:80->80/tcp`, `21400927403129377000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker <span class="token function">service</span> <span class="token function">ls</span>\nID                  NAME                MODE                REPLICAS            IMAGE                 PORTS\nkc57xffvhul5        nginx               replicated          <span class="token number">3</span>/3                 nginx:1.13.7-alpine   *:80-<span class="token operator">></span><span class="token number">80</span>/tcp</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>使用 <code class="language-text">docker service ps</code> 来查看某个服务的详情。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="43882342385482146000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker service ps nginx\nID                  NAME                IMAGE                 NODE                DESIRED STATE       CURRENT STATE                ERROR               PORTS\npjfzd39buzlt        nginx.1             nginx:1.13.7-alpine   swarm2              Running             Running about a minute ago\nhy9eeivdxlaa        nginx.2             nginx:1.13.7-alpine   swarm1              Running             Running about a minute ago\n36wmpiv7gmfo        nginx.3             nginx:1.13.7-alpine   swarm3              Running             Running about a minute ago`, `43882342385482146000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker <span class="token function">service</span> <span class="token function">ps</span> nginx\nID                  NAME                IMAGE                 NODE                DESIRED STATE       CURRENT STATE                ERROR               PORTS\npjfzd39buzlt        nginx.1             nginx:1.13.7-alpine   swarm2              Running             Running about a minute ago\nhy9eeivdxlaa        nginx.2             nginx:1.13.7-alpine   swarm1              Running             Running about a minute ago\n36wmpiv7gmfo        nginx.3             nginx:1.13.7-alpine   swarm3              Running             Running about a minute ago</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>使用 <code class="language-text">docker service logs</code> 来查看某个服务的日志。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="47486659888895440000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker service logs nginx\nnginx.3.36wmpiv7gmfo@swarm3    | 10.255.0.4 - - [25/Nov/2017:02:10:30 +0000] &quot;GET / HTTP/1.1&quot; 200 612 &quot;-&quot; &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10.13; rv:58.0) Gecko/20100101 Firefox/58.0&quot; &quot;-&quot;\nnginx.3.36wmpiv7gmfo@swarm3    | 10.255.0.4 - - [25/Nov/2017:02:10:30 +0000] &quot;GET /favicon.ico HTTP/1.1&quot; 404 169 &quot;-&quot; &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10.13; rv:58.0) Gecko/20100101 Firefox/58.0&quot; &quot;-&quot;\nnginx.3.36wmpiv7gmfo@swarm3    | 2017/11/25 02:10:30 [error] 5#5: *1 open() &quot;/usr/share/nginx/html/favicon.ico&quot; failed (2: No such file or directory), client: 10.255.0.4, server: localhost, request: &quot;GET /favicon.ico HTTP/1.1&quot;, host: &quot;192.168.99.102&quot;\nnginx.1.pjfzd39buzlt@swarm2    | 10.255.0.2 - - [25/Nov/2017:02:10:26 +0000] &quot;GET / HTTP/1.1&quot; 200 612 &quot;-&quot; &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10.13; rv:58.0) Gecko/20100101 Firefox/58.0&quot; &quot;-&quot;\nnginx.1.pjfzd39buzlt@swarm2    | 10.255.0.2 - - [25/Nov/2017:02:10:27 +0000] &quot;GET /favicon.ico HTTP/1.1&quot; 404 169 &quot;-&quot; &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10.13; rv:58.0) Gecko/20100101 Firefox/58.0&quot; &quot;-&quot;\nnginx.1.pjfzd39buzlt@swarm2    | 2017/11/25 02:10:27 [error] 5#5: *1 open() &quot;/usr/share/nginx/html/favicon.ico&quot; failed (2: No such file or directory), client: 10.255.0.2, server: localhost, request: &quot;GET /favicon.ico HTTP/1.1&quot;, host: &quot;192.168.99.101&quot;`, `47486659888895440000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker <span class="token function">service</span> logs nginx\nnginx.3.36wmpiv7gmfo@swarm3    <span class="token operator">|</span> <span class="token number">10.255</span>.0.4 - - <span class="token punctuation">[</span><span class="token number">25</span>/Nov/2017:02:10:30 +0000<span class="token punctuation">]</span> <span class="token string">"GET / HTTP/1.1"</span> <span class="token number">200</span> <span class="token number">612</span> <span class="token string">"-"</span> <span class="token string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10.13; rv:58.0) Gecko/20100101 Firefox/58.0"</span> <span class="token string">"-"</span>\nnginx.3.36wmpiv7gmfo@swarm3    <span class="token operator">|</span> <span class="token number">10.255</span>.0.4 - - <span class="token punctuation">[</span><span class="token number">25</span>/Nov/2017:02:10:30 +0000<span class="token punctuation">]</span> <span class="token string">"GET /favicon.ico HTTP/1.1"</span> <span class="token number">404</span> <span class="token number">169</span> <span class="token string">"-"</span> <span class="token string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10.13; rv:58.0) Gecko/20100101 Firefox/58.0"</span> <span class="token string">"-"</span>\nnginx.3.36wmpiv7gmfo@swarm3    <span class="token operator">|</span> <span class="token number">2017</span>/11/25 02:10:30 <span class="token punctuation">[</span>error<span class="token punctuation">]</span> <span class="token number">5</span><span class="token comment">#5: *1 open() "/usr/share/nginx/html/favicon.ico" failed (2: No such file or directory), client: 10.255.0.4, server: localhost, request: "GET /favicon.ico HTTP/1.1", host: "192.168.99.102"</span>\nnginx.1.pjfzd39buzlt@swarm2    <span class="token operator">|</span> <span class="token number">10.255</span>.0.2 - - <span class="token punctuation">[</span><span class="token number">25</span>/Nov/2017:02:10:26 +0000<span class="token punctuation">]</span> <span class="token string">"GET / HTTP/1.1"</span> <span class="token number">200</span> <span class="token number">612</span> <span class="token string">"-"</span> <span class="token string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10.13; rv:58.0) Gecko/20100101 Firefox/58.0"</span> <span class="token string">"-"</span>\nnginx.1.pjfzd39buzlt@swarm2    <span class="token operator">|</span> <span class="token number">10.255</span>.0.2 - - <span class="token punctuation">[</span><span class="token number">25</span>/Nov/2017:02:10:27 +0000<span class="token punctuation">]</span> <span class="token string">"GET /favicon.ico HTTP/1.1"</span> <span class="token number">404</span> <span class="token number">169</span> <span class="token string">"-"</span> <span class="token string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10.13; rv:58.0) Gecko/20100101 Firefox/58.0"</span> <span class="token string">"-"</span>\nnginx.1.pjfzd39buzlt@swarm2    <span class="token operator">|</span> <span class="token number">2017</span>/11/25 02:10:27 <span class="token punctuation">[</span>error<span class="token punctuation">]</span> <span class="token number">5</span><span class="token comment">#5: *1 open() "/usr/share/nginx/html/favicon.ico" failed (2: No such file or directory), client: 10.255.0.2, server: localhost, request: "GET /favicon.ico HTTP/1.1", host: "192.168.99.101"</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="服务伸缩"><a href="#%E6%9C%8D%E5%8A%A1%E4%BC%B8%E7%BC%A9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>服务伸缩</h3>\n<p>我们可以使用 <code class="language-text">docker service scale</code> 对一个服务运行的容器数量进行伸缩。</p>\n<p>当业务处于高峰期时，我们需要扩展服务运行的容器数量。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="46923308765729940000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker service scale nginx=5`, `46923308765729940000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker <span class="token function">service</span> scale <span class="token assign-left variable">nginx</span><span class="token operator">=</span><span class="token number">5</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>当业务平稳时，我们需要减少服务运行的容器数量。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="24786874519212110000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker service scale nginx=2`, `24786874519212110000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker <span class="token function">service</span> scale <span class="token assign-left variable">nginx</span><span class="token operator">=</span><span class="token number">2</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h3 id="删除服务"><a href="#%E5%88%A0%E9%99%A4%E6%9C%8D%E5%8A%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>删除服务</h3>\n<p>使用 <code class="language-text">docker service rm</code> 来从 Swarm 集群移除某个服务。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="34895341884287580000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker service rm nginx`, `34895341884287580000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker <span class="token function">service</span> <span class="token function">rm</span> nginx</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h2 id="在-swarm-集群中使用-compose-文件"><a href="#%E5%9C%A8-swarm-%E9%9B%86%E7%BE%A4%E4%B8%AD%E4%BD%BF%E7%94%A8-compose-%E6%96%87%E4%BB%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>在 Swarm 集群中使用 compose 文件</h2>\n<p>正如之前使用 <code class="language-text">docker-compose.yml</code> 来一次配置、启动多个容器，在 Swarm 集群中也可以使用 compose 文件（docker-compose.yml）来配置、启动多个服务。</p>\n<p>上一节中，我们使用 <code class="language-text">docker service create</code> 一次只能部署一个服务，使用 <code class="language-text">docker-compose.yml</code> 我们可以一次启动多个关联的服务。</p>\n<p>我们以在 Swarm 集群中部署 WordPress 为例进行说明。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="36218908316336894000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`version: \'3\'\n\nservices:\n  wordpress:\n    image: wordpress\n    ports:\n      - 80:80\n    networks:\n      - overlay\n    environment:\n      WORDPRESS_DB_HOST: db:3306\n      WORDPRESS_DB_USER: wordpress\n      WORDPRESS_DB_PASSWORD: wordpress\n    deploy:\n      mode: replicated\n      replicas: 3\n\n  db:\n    image: mysql\n    networks:\n      - overlay\n    volumes:\n      - db-data:/var/lib/mysql\n    environment:\n      MYSQL_ROOT_PASSWORD: somewordpress\n      MYSQL_DATABASE: wordpress\n      MYSQL_USER: wordpress\n      MYSQL_PASSWORD: wordpress\n    deploy:\n      placement:\n        constraints: [node.role == manager]\n\n  visualizer:\n    image: dockersamples/visualizer:stable\n    ports:\n      - \'8080:8080\'\n    stop_grace_period: 1m30s\n    volumes:\n      - \'/var/run/docker.sock:/var/run/docker.sock\'\n    deploy:\n      placement:\n        constraints: [node.role == manager]\n\nvolumes:\n  db-data:\nnetworks:\n  overlay:`, `36218908316336894000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">\'3\'</span>\n\n<span class="token key atrule">services</span><span class="token punctuation">:</span>\n  <span class="token key atrule">wordpress</span><span class="token punctuation">:</span>\n    <span class="token key atrule">image</span><span class="token punctuation">:</span> wordpress\n    <span class="token key atrule">ports</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> <span class="token datetime number">80:80</span>\n    <span class="token key atrule">networks</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> overlay\n    <span class="token key atrule">environment</span><span class="token punctuation">:</span>\n      <span class="token key atrule">WORDPRESS_DB_HOST</span><span class="token punctuation">:</span> db<span class="token punctuation">:</span><span class="token number">3306</span>\n      <span class="token key atrule">WORDPRESS_DB_USER</span><span class="token punctuation">:</span> wordpress\n      <span class="token key atrule">WORDPRESS_DB_PASSWORD</span><span class="token punctuation">:</span> wordpress\n    <span class="token key atrule">deploy</span><span class="token punctuation">:</span>\n      <span class="token key atrule">mode</span><span class="token punctuation">:</span> replicated\n      <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>\n\n  <span class="token key atrule">db</span><span class="token punctuation">:</span>\n    <span class="token key atrule">image</span><span class="token punctuation">:</span> mysql\n    <span class="token key atrule">networks</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> overlay\n    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> db<span class="token punctuation">-</span>data<span class="token punctuation">:</span>/var/lib/mysql\n    <span class="token key atrule">environment</span><span class="token punctuation">:</span>\n      <span class="token key atrule">MYSQL_ROOT_PASSWORD</span><span class="token punctuation">:</span> somewordpress\n      <span class="token key atrule">MYSQL_DATABASE</span><span class="token punctuation">:</span> wordpress\n      <span class="token key atrule">MYSQL_USER</span><span class="token punctuation">:</span> wordpress\n      <span class="token key atrule">MYSQL_PASSWORD</span><span class="token punctuation">:</span> wordpress\n    <span class="token key atrule">deploy</span><span class="token punctuation">:</span>\n      <span class="token key atrule">placement</span><span class="token punctuation">:</span>\n        <span class="token key atrule">constraints</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>node.role == manager<span class="token punctuation">]</span>\n\n  <span class="token key atrule">visualizer</span><span class="token punctuation">:</span>\n    <span class="token key atrule">image</span><span class="token punctuation">:</span> dockersamples/visualizer<span class="token punctuation">:</span>stable\n    <span class="token key atrule">ports</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> <span class="token string">\'8080:8080\'</span>\n    <span class="token key atrule">stop_grace_period</span><span class="token punctuation">:</span> 1m30s\n    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> <span class="token string">\'/var/run/docker.sock:/var/run/docker.sock\'</span>\n    <span class="token key atrule">deploy</span><span class="token punctuation">:</span>\n      <span class="token key atrule">placement</span><span class="token punctuation">:</span>\n        <span class="token key atrule">constraints</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>node.role == manager<span class="token punctuation">]</span>\n\n<span class="token key atrule">volumes</span><span class="token punctuation">:</span>\n  <span class="token key atrule">db-data</span><span class="token punctuation">:</span>\n<span class="token key atrule">networks</span><span class="token punctuation">:</span>\n  overlay<span class="token punctuation">:</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在 Swarm 集群管理节点新建该文件，其中的 visualizer 服务提供一个可视化页面，我们可以从浏览器中很直观的查看集群中各个服务的运行节点。</p>\n<p>在 Swarm 集群中使用 <code class="language-text">docker-compose.yml</code> 需要用 <code class="language-text">docker stack</code> 命令，下面我们对该命令进行详细讲解。</p>\n<h3 id="部署服务-1"><a href="#%E9%83%A8%E7%BD%B2%E6%9C%8D%E5%8A%A1-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>部署服务</h3>\n<p>部署服务使用 <code class="language-text">docker stack deploy</code>，其中 <code class="language-text">-c</code> 参数指定 compose 文件名。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="12396944863107406000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker stack deploy -c docker-compose.yml wordpress`, `12396944863107406000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker stack deploy -c docker-compose.yml wordpress</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>现在我们打开浏览器输入 <code class="language-text">任一节点IP:8080</code> 即可看到各节点运行状态。</p>\n<p>在浏览器新的标签页输入 <code class="language-text">任一节点IP</code> 即可看到 WordPress 安装界面，安装完成之后，输入 <code class="language-text">任一节点IP</code> 即可看到 WordPress 页面。</p>\n<h3 id="查看服务-1"><a href="#%E6%9F%A5%E7%9C%8B%E6%9C%8D%E5%8A%A1-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>查看服务</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="20732674616971837000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker stack ls\nNAME                SERVICES\nwordpress           3`, `20732674616971837000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker stack <span class="token function">ls</span>\nNAME                SERVICES\nwordpress           <span class="token number">3</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<h3 id="移除服务"><a href="#%E7%A7%BB%E9%99%A4%E6%9C%8D%E5%8A%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>移除服务</h3>\n<p>要移除服务，使用 <code class="language-text">docker stack down</code></p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="62544936295182430000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker stack down wordpress\nRemoving service wordpress_db\nRemoving service wordpress_visualizer\nRemoving service wordpress_wordpress\nRemoving network wordpress_overlay\nRemoving network wordpress_default`, `62544936295182430000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker stack down wordpress\nRemoving <span class="token function">service</span> wordpress_db\nRemoving <span class="token function">service</span> wordpress_visualizer\nRemoving <span class="token function">service</span> wordpress_wordpress\nRemoving network wordpress_overlay\nRemoving network wordpress_default</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>该命令不会移除服务所使用的数据卷，如果你想移除数据卷请使用 <code class="language-text">docker volume rm</code></p>\n<h2 id="在-swarm-集群中管理敏感数据"><a href="#%E5%9C%A8-swarm-%E9%9B%86%E7%BE%A4%E4%B8%AD%E7%AE%A1%E7%90%86%E6%95%8F%E6%84%9F%E6%95%B0%E6%8D%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>在 Swarm 集群中管理敏感数据</h2>\n<p>在动态的、大规模的分布式集群上，管理和分发密码、证书等敏感信息是极其重要的工作。传统的密钥分发方式（如密钥放入镜像中，设置环境变量，volume 动态挂载等）都存在着潜在的巨大的安全风险。</p>\n<p>Docker 目前已经提供了 secrets 管理功能，用户可以在 Swarm 集群中安全地管理密码、密钥证书等敏感数据，并允许在多个 Docker 容器实例之间共享访问指定的敏感数据。</p>\n<blockquote>\n<p>注意：secret 也可以在 Docker Compose 中使用。</p>\n</blockquote>\n<p>我们可以用 docker secret 命令来管理敏感信息。接下来我们在上面章节中创建好的 Swarm 集群中介绍该命令的使用。</p>\n<p>这里我们以在 Swarm 集群中部署 mysql 和 wordpress 服务为例。</p>\n<h3 id="创建-secret"><a href="#%E5%88%9B%E5%BB%BA-secret" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>创建 secret</h3>\n<p>我们使用 <code class="language-text">docker secret create</code> 命令以管道符的形式创建 secret</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="13591462949565880000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ openssl rand -base64 20 | docker secret create mysql_password -\n\n\\$ openssl rand -base64 20 | docker secret create mysql_root_password -`, `13591462949565880000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ openssl rand -base64 <span class="token number">20</span> <span class="token operator">|</span> docker secret create mysql_password -\n\n$ openssl rand -base64 <span class="token number">20</span> <span class="token operator">|</span> docker secret create mysql_root_password -</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<h3 id="查看-secret"><a href="#%E6%9F%A5%E7%9C%8B-secret" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>查看 secret</h3>\n<p>使用 <code class="language-text">docker secret ls</code> 命令来查看 secret</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="74630913111709860000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker secret ls\n\nID                          NAME                  CREATED             UPDATED\nl1vinzevzhj4goakjap5ya409   mysql_password        41 seconds ago      41 seconds ago\nyvsczlx9votfw3l0nz5rlidig   mysql_root_password   12 seconds ago      12 seconds ago`, `74630913111709860000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker secret <span class="token function">ls</span>\n\nID                          NAME                  CREATED             UPDATED\nl1vinzevzhj4goakjap5ya409   mysql_password        <span class="token number">41</span> seconds ago      <span class="token number">41</span> seconds ago\nyvsczlx9votfw3l0nz5rlidig   mysql_root_password   <span class="token number">12</span> seconds ago      <span class="token number">12</span> seconds ago</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="创建-mysql-服务"><a href="#%E5%88%9B%E5%BB%BA-mysql-%E6%9C%8D%E5%8A%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>创建 MySQL 服务</h3>\n<p>创建服务相关命令已经在前边章节进行了介绍，这里直接列出命令。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="29432747433688600000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker network create -d overlay mysql_private\n\n\\$ docker service create \\\n     --name mysql \\\n     --replicas 1 \\\n     --network mysql_private \\\n     --mount type=volume,source=mydata,destination=/var/lib/mysql \\\n     --secret source=mysql_root_password,target=mysql_root_password \\\n     --secret source=mysql_password,target=mysql_password \\\n     -e MYSQL_ROOT_PASSWORD_FILE=&quot;/run/secrets/mysql_root_password&quot; \\\n     -e MYSQL_PASSWORD_FILE=&quot;/run/secrets/mysql_password&quot; \\\n     -e MYSQL_USER=&quot;wordpress&quot; \\\n     -e MYSQL_DATABASE=&quot;wordpress&quot; \\\n     mysql:latest`, `29432747433688600000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker network create -d overlay mysql_private\n\n$ docker <span class="token function">service</span> create <span class="token punctuation">\\</span>\n     --name mysql <span class="token punctuation">\\</span>\n     --replicas <span class="token number">1</span> <span class="token punctuation">\\</span>\n     --network mysql_private <span class="token punctuation">\\</span>\n     --mount <span class="token assign-left variable">type</span><span class="token operator">=</span>volume,source<span class="token operator">=</span>mydata,destination<span class="token operator">=</span>/var/lib/mysql <span class="token punctuation">\\</span>\n     --secret <span class="token assign-left variable">source</span><span class="token operator">=</span>mysql_root_password,target<span class="token operator">=</span>mysql_root_password <span class="token punctuation">\\</span>\n     --secret <span class="token assign-left variable">source</span><span class="token operator">=</span>mysql_password,target<span class="token operator">=</span>mysql_password <span class="token punctuation">\\</span>\n     -e <span class="token assign-left variable">MYSQL_ROOT_PASSWORD_FILE</span><span class="token operator">=</span><span class="token string">"/run/secrets/mysql_root_password"</span> <span class="token punctuation">\\</span>\n     -e <span class="token assign-left variable">MYSQL_PASSWORD_FILE</span><span class="token operator">=</span><span class="token string">"/run/secrets/mysql_password"</span> <span class="token punctuation">\\</span>\n     -e <span class="token assign-left variable">MYSQL_USER</span><span class="token operator">=</span><span class="token string">"wordpress"</span> <span class="token punctuation">\\</span>\n     -e <span class="token assign-left variable">MYSQL_DATABASE</span><span class="token operator">=</span><span class="token string">"wordpress"</span> <span class="token punctuation">\\</span>\n     mysql:latest</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果你没有在 target 中显式的指定路径时，secret 默认通过 tmpfs 文件系统挂载到容器的 /run/secrets 目录中。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="60825873424723345000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker service create \\\n     --name wordpress \\\n     --replicas 1 \\\n     --network mysql_private \\\n     --publish target=30000,port=80 \\\n     --mount type=volume,source=wpdata,destination=/var/www/html \\\n     --secret source=mysql_password,target=wp_db_password,mode=0444 \\\n     -e WORDPRESS_DB_USER=&quot;wordpress&quot; \\\n     -e WORDPRESS_DB_PASSWORD_FILE=&quot;/run/secrets/wp_db_password&quot; \\\n     -e WORDPRESS_DB_HOST=&quot;mysql:3306&quot; \\\n     -e WORDPRESS_DB_NAME=&quot;wordpress&quot; \\\n     wordpress:latest`, `60825873424723345000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker <span class="token function">service</span> create <span class="token punctuation">\\</span>\n     --name wordpress <span class="token punctuation">\\</span>\n     --replicas <span class="token number">1</span> <span class="token punctuation">\\</span>\n     --network mysql_private <span class="token punctuation">\\</span>\n     --publish <span class="token assign-left variable">target</span><span class="token operator">=</span><span class="token number">30000</span>,port<span class="token operator">=</span><span class="token number">80</span> <span class="token punctuation">\\</span>\n     --mount <span class="token assign-left variable">type</span><span class="token operator">=</span>volume,source<span class="token operator">=</span>wpdata,destination<span class="token operator">=</span>/var/www/html <span class="token punctuation">\\</span>\n     --secret <span class="token assign-left variable">source</span><span class="token operator">=</span>mysql_password,target<span class="token operator">=</span>wp_db_password,mode<span class="token operator">=</span>0444 <span class="token punctuation">\\</span>\n     -e <span class="token assign-left variable">WORDPRESS_DB_USER</span><span class="token operator">=</span><span class="token string">"wordpress"</span> <span class="token punctuation">\\</span>\n     -e <span class="token assign-left variable">WORDPRESS_DB_PASSWORD_FILE</span><span class="token operator">=</span><span class="token string">"/run/secrets/wp_db_password"</span> <span class="token punctuation">\\</span>\n     -e <span class="token assign-left variable">WORDPRESS_DB_HOST</span><span class="token operator">=</span><span class="token string">"mysql:3306"</span> <span class="token punctuation">\\</span>\n     -e <span class="token assign-left variable">WORDPRESS_DB_NAME</span><span class="token operator">=</span><span class="token string">"wordpress"</span> <span class="token punctuation">\\</span>\n     wordpress:latest</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>查看服务</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="72759289560211510000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker service ls\n\nID            NAME   MODE        REPLICAS  IMAGE\nwvnh0siktqr3  mysql      replicated  1/1       mysql:latest\nnzt5xzae4n62  wordpress  replicated  1/1       wordpress:latest`, `72759289560211510000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker <span class="token function">service</span> <span class="token function">ls</span>\n\nID            NAME   MODE        REPLICAS  IMAGE\nwvnh0siktqr3  mysql      replicated  <span class="token number">1</span>/1       mysql:latest\nnzt5xzae4n62  wordpress  replicated  <span class="token number">1</span>/1       wordpress:latest</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在浏览器访问 <code class="language-text">IP:30000</code>，即可开始 WordPress 的安装与使用。</p>\n<p>通过以上方法，我们没有像以前通过设置环境变量来设置 MySQL 密码，而是采用 <code class="language-text">docker secret</code> 来设置密码，防范了密码泄露的风险。</p>\n<h2 id="在-swarm-集群中管理配置数据"><a href="#%E5%9C%A8-swarm-%E9%9B%86%E7%BE%A4%E4%B8%AD%E7%AE%A1%E7%90%86%E9%85%8D%E7%BD%AE%E6%95%B0%E6%8D%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>在 Swarm 集群中管理配置数据</h2>\n<p>在动态的、大规模的分布式集群上，管理和分发配置文件也是很重要的工作。传统的配置文件分发方式（如配置文件放入镜像中，设置环境变量，volume 动态挂载等）都降低了镜像的通用性。</p>\n<p>在 Docker 17.06 以上版本中，Docker 新增了 docker config 子命令来管理集群中的配置信息，以后你无需将配置文件放入镜像或挂载到容器中就可实现对服务的配置。</p>\n<blockquote>\n<p>注意：config 仅能在 Swarm 集群中使用。</p>\n</blockquote>\n<p>这里我们以在 Swarm 集群中部署 redis 服务为例。</p>\n<h3 id="创建-config"><a href="#%E5%88%9B%E5%BB%BA-config" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>创建 config</h3>\n<p>新建 redis.conf 文件</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="80612132627020370000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`port 6380`, `80612132627020370000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">port <span class="token number">6380</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>此项配置 Redis 监听 6380 端口</p>\n<p>我们使用 docker config create 命令创建 config</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="9262085885495530000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker config create redis.conf redis.conf`, `9262085885495530000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker config create redis.conf redis.conf</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h3 id="查看-config"><a href="#%E6%9F%A5%E7%9C%8B-config" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>查看 config</h3>\n<p>使用 docker config ls 命令来查看 config</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="43926193326713150000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker config ls\n\nID                          NAME                CREATED             UPDATED\nyod8fx8iiqtoo84jgwadp86yk   redis.conf          4 seconds ago       4 seconds ago`, `43926193326713150000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker config <span class="token function">ls</span>\n\nID                          NAME                CREATED             UPDATED\nyod8fx8iiqtoo84jgwadp86yk   redis.conf          <span class="token number">4</span> seconds ago       <span class="token number">4</span> seconds ago</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="创建-redis-服务"><a href="#%E5%88%9B%E5%BB%BA-redis-%E6%9C%8D%E5%8A%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>创建 redis 服务</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="63484756331604350000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker service create \\\n     --name redis \\\n     # --config source=redis.conf,target=/etc/redis.conf \\\n     --config redis.conf \\\n     -p 6379:6380 \\\n     redis:latest \\\n     redis-server /redis.conf`, `63484756331604350000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker <span class="token function">service</span> create <span class="token punctuation">\\</span>\n     --name redis <span class="token punctuation">\\</span>\n     <span class="token comment"># --config source=redis.conf,target=/etc/redis.conf \\</span>\n     --config redis.conf <span class="token punctuation">\\</span>\n     -p <span class="token number">6379</span>:6380 <span class="token punctuation">\\</span>\n     redis:latest <span class="token punctuation">\\</span>\n     redis-server /redis.conf</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果你没有在 target 中显式的指定路径时，默认的 redis.conf 以 tmpfs 文件系统挂载到容器的 /config.conf。</p>\n<p>经过测试，redis 可以正常使用。</p>\n<p>以前我们通过监听主机目录来配置 Redis，就需要在集群的每个节点放置该文件，如果采用 <code class="language-text">docker config</code> 来管理服务的配置信息，我们只需在集群中的管理节点创建 config，当部署服务时，集群会自动的将配置文件分发到运行服务的各个节点中，大大降低了配置信息的管理和分发难度。</p>\n<h2 id="swarm-mode-与滚动升级"><a href="#swarm-mode-%E4%B8%8E%E6%BB%9A%E5%8A%A8%E5%8D%87%E7%BA%A7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Swarm mode 与滚动升级</h2>\n<p>在部署服务一节中我们使用 <code class="language-text">nginx:1.13.7-alpine</code> 镜像部署了一个名为 nginx 的服务。</p>\n<p>现在我们想要将 NGINX 版本升级到 <code class="language-text">1.13.12</code>，那么在 <code class="language-text">Swarm mode</code> 中如何升级服务呢？</p>\n<p>你可能会想到，先停止原来的服务，再使用新镜像部署一个服务，不就完成服务的 “升级” 了吗。</p>\n<p>这样做的弊端很明显，如果新部署的服务出现问题，原来的服务删除之后，很难恢复，那么在 Swarm mode 中到底该如何对服务进行滚动升级呢？</p>\n<p>答案就是使用 <code class="language-text">docker service update</code> 命令。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="39195478730415420000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker service update \\\n    --image nginx:1.13.12-alpine \\\n    nginx`, `39195478730415420000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker <span class="token function">service</span> update <span class="token punctuation">\\</span>\n    --image nginx:1.13.12-alpine <span class="token punctuation">\\</span>\n    nginx</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>以上命令使用 <code class="language-text">--image</code> 选项更新了服务的镜像。当然我们也可以使用 <code class="language-text">docker service update</code> 更新任意的配置。</p>\n<p><code class="language-text">--secret-add</code> 选项可以增加一个密钥</p>\n<p><code class="language-text">--secret-rm</code> 选项可以删除一个密钥</p>\n<p>更多选项可以通过 <code class="language-text">docker service update -h</code> 命令查看。</p>\n<h3 id="服务回退"><a href="#%E6%9C%8D%E5%8A%A1%E5%9B%9E%E9%80%80" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>服务回退</h3>\n<p>现在假设我们发现 nginx 服务的镜像升级到 <code class="language-text">nginx:1.13.12-alpine</code> 出现了一些问题，我们可以使用命令一键回退。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="52391204357954750000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker service rollback nginx`, `52391204357954750000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker <span class="token function">service</span> rollback nginx</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>现在使用 docker service ps 命令查看 nginx 服务详情。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="44702776492202600000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker service ps nginx\n\nID                  NAME                IMAGE                  NODE                DESIRED STATE       CURRENT STATE                ERROR               PORTS\nrt677gop9d4x        nginx.1             nginx:1.13.7-alpine   VM-20-83-debian     Running             Running about a minute ago\nd9pw13v59d00         \\_ nginx.1         nginx:1.13.12-alpine  VM-20-83-debian     Shutdown            Shutdown 2 minutes ago\ni7ynkbg6ybq5         \\_ nginx.1         nginx:1.13.7-alpine   VM-20-83-debian     Shutdown            Shutdown 2 minutes ago`, `44702776492202600000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker <span class="token function">service</span> <span class="token function">ps</span> nginx\n\nID                  NAME                IMAGE                  NODE                DESIRED STATE       CURRENT STATE                ERROR               PORTS\nrt677gop9d4x        nginx.1             nginx:1.13.7-alpine   VM-20-83-debian     Running             Running about a minute ago\nd9pw13v59d00         <span class="token punctuation">\\</span>_ nginx.1         nginx:1.13.12-alpine  VM-20-83-debian     Shutdown            Shutdown <span class="token number">2</span> minutes ago\ni7ynkbg6ybq5         <span class="token punctuation">\\</span>_ nginx.1         nginx:1.13.7-alpine   VM-20-83-debian     Shutdown            Shutdown <span class="token number">2</span> minutes ago</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>结果的输出详细记录了服务的部署、滚动升级、回退的过程。</p>\n<h1 id="docker-buildx"><a href="#docker-buildx" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Docker Buildx</h1>\n<p>Docker Buildx 是一个 docker CLI 插件，其扩展了 docker 命令，支持 Moby BuildKit 提供的功能。提供了与 docker build 相同的用户体验，并增加了许多新功能。</p>\n<blockquote>\n<p>该功能仅适用于 Docker v19.03+ 版本</p>\n</blockquote>\n<h2 id="使用-buildkit-构建镜像"><a href="#%E4%BD%BF%E7%94%A8-buildkit-%E6%9E%84%E5%BB%BA%E9%95%9C%E5%83%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用 BuildKit 构建镜像</h2>\n<p>BuildKit 是下一代的镜像构建组件，在 <a href="https://github.com/moby/buildkit" target="_blank" rel="nofollow noreferrer noopener">https://github.com/moby/buildkit</a> 开源。</p>\n<blockquote>\n<p>注意：如果您的镜像构建使用的是云服务商提供的镜像构建服务（腾讯云容器服务、阿里云容器服务等），由于上述服务提供商的 Docker 版本低于 18.09，BuildKit 无法使用，将造成镜像构建失败。建议使用 BuildKit 构建镜像时使用一个新的 Dockerfile 文件（例如 Dockerfile.buildkit）</p>\n</blockquote>\n<p>目前，Docker Hub 自动构建已经支持 buildkit，具体请参考 <a href="https://github.com/docker-practice/docker-hub-buildx" target="_blank" rel="nofollow noreferrer noopener">https://github.com/docker-practice/docker-hub-buildx</a></p>\n<h3 id="dockerfile-新增指令详解"><a href="#dockerfile-%E6%96%B0%E5%A2%9E%E6%8C%87%E4%BB%A4%E8%AF%A6%E8%A7%A3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Dockerfile 新增指令详解</h3>\n<p>启用 BuildKit 之后，我们可以使用下面几个新的 Dockerfile 指令来加快镜像构建。</p>\n<h4 id="run---mounttypecache"><a href="#run---mounttypecache" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>RUN —mount=type=cache</h4>\n<p>目前，几乎所有的程序都会使用依赖管理工具，例如 Go 中的 go mod、Node.js 中的 npm 等等，当我们构建一个镜像时，往往会重复的从互联网中获取依赖包，难以缓存，大大降低了镜像的构建效率。</p>\n<p>例如一个前端工程需要用到 npm：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="19398543374529843000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`FROM node:alpine as builder\n\nWORKDIR /app\n\nCOPY package.json /app/\n\nRUN npm i --registry=https://registry.npm.taobao.org \\\n        && rm -rf ~/.npm\n\nCOPY src /app/src\n\nRUN npm run build\n\nFROM nginx:alpine\n\nCOPY --from=builder /app/dist /app/dist`, `19398543374529843000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">FROM</span> node<span class="token punctuation">:</span>alpine as builder\n\n<span class="token keyword">WORKDIR</span> /app\n\n<span class="token keyword">COPY</span> package.json /app/\n\n<span class="token keyword">RUN</span> npm i <span class="token punctuation">-</span><span class="token punctuation">-</span>registry=https<span class="token punctuation">:</span>//registry.npm.taobao.org \\\n        &amp;&amp; rm <span class="token punctuation">-</span>rf ~/.npm\n\n<span class="token keyword">COPY</span> src /app/src\n\n<span class="token keyword">RUN</span> npm run build\n\n<span class="token keyword">FROM</span> nginx<span class="token punctuation">:</span>alpine\n\n<span class="token keyword">COPY</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>from=builder /app/dist /app/dist</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>使用多阶段构建，构建的镜像中只包含了目标文件夹 dist，但仍然存在一些问题，当 package.json 文件变动时，<code class="language-text">RUN npm i &amp;&amp; rm -rf ~/.npm</code> 这一层会重新执行，变更多次后，生成了大量的中间层镜像。</p>\n<p>为解决这个问题，进一步的我们可以设想一个类似数据卷的功能，在镜像构建时把 <code class="language-text">node_modules</code> 文件夹挂载上去，在构建完成后，这个 <code class="language-text">node_modules</code> 文件夹会自动卸载，实际的镜像中并不包含 <code class="language-text">node_modules</code> 这个文件夹，这样我们就省去了每次获取依赖的时间，大大增加了镜像构建效率，同时也避免了生成了大量的中间层镜像。</p>\n<p>BuildKit 提供了 <code class="language-text">RUN --mount=type=cache</code> 指令，可以实现上边的设想。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="43137296335895626000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# syntax = docker/dockerfile:experimental\nFROM node:alpine as builder\n\nWORKDIR /app\n\nCOPY package.json /app/\n\nRUN --mount=type=cache,target=/app/node_modules,id=my_app_npm_module,sharing=locked \\\n    --mount=type=cache,target=/root/.npm,id=npm_cache \\\n        npm i --registry=https://registry.npm.taobao.org\n\nCOPY src /app/src\n\nRUN --mount=type=cache,target=/app/node_modules,id=my_app_npm_module,sharing=locked \\\n# --mount=type=cache,target=/app/dist,id=my_app_dist,sharing=locked \\\n        npm run build\n\nFROM nginx:alpine\n\n# COPY --from=builder /app/dist /app/dist\n\n# 为了更直观的说明 from 和 source 指令，这里使用 RUN 指令\nRUN --mount=type=cache,target=/tmp/dist,from=builder,source=/app/dist \\\n    # --mount=type=cache,target/tmp/dist,from=my_app_dist,sharing=locked \\\n    mkdir -p /app/dist && cp -r /tmp/dist/* /app/dist`, `43137296335895626000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token comment"># syntax = docker/dockerfile:experimental</span>\n<span class="token keyword">FROM</span> node<span class="token punctuation">:</span>alpine as builder\n\n<span class="token keyword">WORKDIR</span> /app\n\n<span class="token keyword">COPY</span> package.json /app/\n\n<span class="token keyword">RUN</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>mount=type=cache<span class="token punctuation">,</span>target=/app/node_modules<span class="token punctuation">,</span>id=my_app_npm_module<span class="token punctuation">,</span>sharing=locked \\\n    <span class="token punctuation">-</span><span class="token punctuation">-</span>mount=type=cache<span class="token punctuation">,</span>target=/root/.npm<span class="token punctuation">,</span>id=npm_cache \\\n        npm i <span class="token punctuation">-</span><span class="token punctuation">-</span>registry=https<span class="token punctuation">:</span>//registry.npm.taobao.org\n\n<span class="token keyword">COPY</span> src /app/src\n\n<span class="token keyword">RUN</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>mount=type=cache<span class="token punctuation">,</span>target=/app/node_modules<span class="token punctuation">,</span>id=my_app_npm_module<span class="token punctuation">,</span>sharing=locked \\\n<span class="token comment"># --mount=type=cache,target=/app/dist,id=my_app_dist,sharing=locked \\</span>\n        npm run build\n\n<span class="token keyword">FROM</span> nginx<span class="token punctuation">:</span>alpine\n\n<span class="token comment"># COPY --from=builder /app/dist /app/dist</span>\n\n<span class="token comment"># 为了更直观的说明 from 和 source 指令，这里使用 RUN 指令</span>\n<span class="token keyword">RUN</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>mount=type=cache<span class="token punctuation">,</span>target=/tmp/dist<span class="token punctuation">,</span>from=builder<span class="token punctuation">,</span>source=/app/dist \\\n    <span class="token comment"># --mount=type=cache,target/tmp/dist,from=my_app_dist,sharing=locked \\</span>\n    mkdir <span class="token punctuation">-</span>p /app/dist &amp;&amp; cp <span class="token punctuation">-</span>r /tmp/dist/* /app/dist</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>由于 BuildKit 为实验特性，每个 Dockerfile 文件开头都必须加上如下指令</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="21462498736967016000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# syntax = docker/dockerfile:experimental`, `21462498736967016000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token comment"># syntax = docker/dockerfile:experimental</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>第一个 RUN 指令执行后，id 为 <code class="language-text">my_app_npm_module</code> 的缓存文件夹挂载到了 <code class="language-text">/app/node_modules</code> 文件夹中。多次执行也不会产生多个中间层镜像。</p>\n<p>第二个 RUN 指令执行时需要用到 <code class="language-text">node_modules</code> 文件夹，<code class="language-text">node_modules</code> 已经挂载，命令也可以正确执行。</p>\n<p>第三个 RUN 指令将上一阶段产生的文件复制到指定位置，from 指明缓存的来源，这里 builder 表示缓存来源于构建的第一阶段，source 指明缓存来源的文件夹。</p>\n<p>上面的 Dockerfile 中 <code class="language-text">--mount=type=cache,...</code> 中指令作用如下：</p>\n<table>\n<thead>\n<tr>\n<th align="left">Option</th>\n<th align="left">Description</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align="left">id</td>\n<td align="left">id 设置一个标志，以便区分缓存。</td>\n</tr>\n<tr>\n<td align="left">target(必填项)</td>\n<td align="left">缓存的挂载目标文件夹。</td>\n</tr>\n<tr>\n<td align="left">ro,readonly</td>\n<td align="left">只读，缓存文件夹不能被写入。</td>\n</tr>\n<tr>\n<td align="left">sharing</td>\n<td align="left">有 shared private locked 值可供选择。sharing 设置当一个缓存被多次使用时的表现，由于 BuildKit 支持并行构建，当多个步骤使用同一缓存时（同一 id）会发生冲突。shared 表示多个步骤可以同时读写，private 表示当多个步骤使用同一缓存时，每个步骤使用不同的缓存，locked 表示当一个步骤完成释放缓存后，后一个步骤才能继续使用该缓存。</td>\n</tr>\n<tr>\n<td align="left">from</td>\n<td align="left">缓存来源（构建阶段），不填写时为空文件夹。</td>\n</tr>\n<tr>\n<td align="left">source</td>\n<td align="left">来源的文件夹路径。</td>\n</tr>\n</tbody>\n</table>\n<h4 id="run---mounttypebind"><a href="#run---mounttypebind" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>RUN —mount=type=bind</h4>\n<p>该指令可以将一个镜像（或上一构建阶段）的文件挂载到指定位置。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="2783587255904218600"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# syntax = docker/dockerfile:experimental\n\nRUN --mount=type=bind,from=php:alpine,source=/usr/local/bin/docker-php-entrypoint,target=/docker-php-entrypoint \\\n        cat /docker-php-entrypoint`, `2783587255904218600`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token comment"># syntax = docker/dockerfile:experimental</span>\n\n<span class="token keyword">RUN</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>mount=type=bind<span class="token punctuation">,</span>from=php<span class="token punctuation">:</span>alpine<span class="token punctuation">,</span>source=/usr/local/bin/docker<span class="token punctuation">-</span>php<span class="token punctuation">-</span>entrypoint<span class="token punctuation">,</span>target=/docker<span class="token punctuation">-</span>php<span class="token punctuation">-</span>entrypoint \\\n        cat /docker<span class="token punctuation">-</span>php<span class="token punctuation">-</span>entrypoint</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="run---mounttypetmpfs"><a href="#run---mounttypetmpfs" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>RUN —mount=type=tmpfs</h4>\n<p>该指令可以将一个 tmpfs 文件系统挂载到指定位置。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="15997679479417903000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# syntax = docker/dockerfile:experimental\n\nRUN --mount=type=tmpfs,target=/temp \\\n        mount | grep /temp`, `15997679479417903000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token comment"># syntax = docker/dockerfile:experimental</span>\n\n<span class="token keyword">RUN</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>mount=type=tmpfs<span class="token punctuation">,</span>target=/temp \\\n        mount <span class="token punctuation">|</span> grep /temp</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="run---mounttypesecret"><a href="#run---mounttypesecret" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>RUN —mount=type=secret</h4>\n<p>该指令可以将一个文件（例如密钥）挂载到指定位置。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="44108633088072606000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# syntax = docker/dockerfile:experimental\n\nRUN --mount=type=secret,id=aws,target=/root/.aws/credentials \\\n        cat /root/.aws/credentials\n\n\\$ docker build -t test --secret id=aws,src=\\$HOME/.aws/credentials .`, `44108633088072606000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token comment"># syntax = docker/dockerfile:experimental</span>\n\n<span class="token keyword">RUN</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>mount=type=secret<span class="token punctuation">,</span>id=aws<span class="token punctuation">,</span>target=/root/.aws/credentials \\\n        cat /root/.aws/credentials\n\n$ docker build <span class="token punctuation">-</span>t test <span class="token punctuation">-</span><span class="token punctuation">-</span>secret id=aws<span class="token punctuation">,</span>src=$HOME/.aws/credentials .</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="run---mounttypessh"><a href="#run---mounttypessh" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>RUN —mount=type=ssh</h4>\n<p>该指令可以挂载 ssh 密钥。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="52185174916770530000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# syntax = docker/dockerfile:experimental\n\nFROM alpine\nRUN apk add --no-cache openssh-client\nRUN mkdir -p -m 0700 ~/.ssh && ssh-keyscan gitlab.com >> ~/.ssh/known_hosts\nRUN --mount=type=ssh ssh git@gitlab.com | tee /hello`, `52185174916770530000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token comment"># syntax = docker/dockerfile:experimental</span>\n\n<span class="token keyword">FROM</span> alpine\n<span class="token keyword">RUN</span> apk add <span class="token punctuation">-</span><span class="token punctuation">-</span>no<span class="token punctuation">-</span>cache openssh<span class="token punctuation">-</span>client\n<span class="token keyword">RUN</span> mkdir <span class="token punctuation">-</span>p <span class="token punctuation">-</span>m 0700 ~/.ssh &amp;&amp; ssh<span class="token punctuation">-</span>keyscan gitlab.com <span class="token punctuation">></span><span class="token punctuation">></span> ~/.ssh/known_hosts\n<span class="token keyword">RUN</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>mount=type=ssh ssh git@gitlab.com <span class="token punctuation">|</span> tee /hello</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="35260811955546820000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ eval \\$(ssh-agent)\n\\$ ssh-add ~/.ssh/id_rsa\n(Input your passphrase here)\n\\$ docker build -t test --ssh default=\\$SSH_AUTH_SOCK .`, `35260811955546820000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ <span class="token builtin class-name">eval</span> <span class="token variable"><span class="token variable">$(</span>ssh-agent<span class="token variable">)</span></span>\n$ ssh-add ~/.ssh/id_rsa\n<span class="token punctuation">(</span>Input your passphrase here<span class="token punctuation">)</span>\n$ docker build -t <span class="token builtin class-name">test</span> --ssh <span class="token assign-left variable">default</span><span class="token operator">=</span><span class="token environment constant">$SSH_AUTH_SOCK</span> <span class="token builtin class-name">.</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="使用-buildx-构建镜像"><a href="#%E4%BD%BF%E7%94%A8-buildx-%E6%9E%84%E5%BB%BA%E9%95%9C%E5%83%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用 Buildx 构建镜像</h2>\n<h3 id="使用"><a href="#%E4%BD%BF%E7%94%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用</h3>\n<p>你可以直接使用 docker buildx build 命令构建镜像。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="49035207066047250000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker buildx build .\n[+] Building 8.4s (23/32)\n => ...`, `49035207066047250000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker buildx build <span class="token builtin class-name">.</span>\n<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Building <span class="token number">8</span>.4s <span class="token punctuation">(</span><span class="token number">23</span>/32<span class="token punctuation">)</span>\n <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">..</span>.</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>Buildx 使用 BuildKit 引擎 进行构建，支持许多新的功能，具体参考 Buildkit 一节。</p>\n<h3 id="官方文档"><a href="#%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>官方文档</h3>\n<p><a href="https://docs.docker.com/engine/reference/commandline/buildx/" target="_blank" rel="nofollow noreferrer noopener">https://docs.docker.com/engine/reference/commandline/buildx/</a></p>\n<h2 id="使用-buildx-构建多种系统架构支持的-docker-镜像"><a href="#%E4%BD%BF%E7%94%A8-buildx-%E6%9E%84%E5%BB%BA%E5%A4%9A%E7%A7%8D%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84%E6%94%AF%E6%8C%81%E7%9A%84-docker-%E9%95%9C%E5%83%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用 buildx 构建多种系统架构支持的 Docker 镜像</h2>\n<p>在之前的版本中构建多种系统架构支持的 Docker 镜像，要想使用统一的名字必须使用 <code class="language-text">$ docker manifest</code> 命令。</p>\n<p>在 Docker 19.03+ 版本中可以使用 <code class="language-text">$ docker buildx build</code> 命令使用 BuildKit 构建镜像。该命令支持 <code class="language-text">--platform</code> 参数可以同时构建支持多种系统架构的 Docker 镜像，大大简化了构建步骤。</p>\n<h3 id="新建-builder-实例"><a href="#%E6%96%B0%E5%BB%BA-builder-%E5%AE%9E%E4%BE%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>新建 builder 实例</h3>\n<p>Docker for Linux 不支持构建 arm 架构镜像，我们可以运行一个新的容器让其支持该特性，Docker 桌面版无需进行此项设置。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="80316845362131300000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run --rm --privileged tonistiigi/binfmt:latest --install all`, `80316845362131300000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run --rm --privileged tonistiigi/binfmt:latest --install all</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>由于 Docker 默认的 builder 实例不支持同时指定多个 <code class="language-text">--platform</code>，我们必须首先创建一个新的 builder 实例。同时由于国内拉取镜像较缓慢，我们可以使用配置了<a href="https://github.com/moby/buildkit/blob/master/docs/buildkitd.toml.md" target="_blank" rel="nofollow noreferrer noopener">镜像加速地址</a>的 <a href="https://github.com/docker-practice/buildx" target="_blank" rel="nofollow noreferrer noopener">dockerpracticesig/buildkit:master</a> 镜像替换官方镜像。</p>\n<blockquote>\n<p>如果你有私有的镜像加速器，可以基于 <a href="https://github.com/docker-practice/buildx" target="_blank" rel="nofollow noreferrer noopener">https://github.com/docker-practice/buildx</a> 构建自己的 buildkit 镜像并使用它。</p>\n</blockquote>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="22826459435884438000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# 适用于国内环境\n\\$ docker buildx create --use --name=mybuilder-cn --driver docker-container --driver-opt image=dockerpracticesig/buildkit:master\n\n# 适用于腾讯云环境(腾讯云主机、coding.net 持续集成)\n\\$ docker buildx create --use --name=mybuilder-cn --driver docker-container --driver-opt image=dockerpracticesig/buildkit:master-tencent\n\n# \\$ docker buildx create --name mybuilder --driver docker-container\n\n\\$ docker buildx use mybuilder`, `22826459435884438000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token comment"># 适用于国内环境</span>\n$ docker buildx create --use --name<span class="token operator">=</span>mybuilder-cn --driver docker-container --driver-opt <span class="token assign-left variable">image</span><span class="token operator">=</span>dockerpracticesig/buildkit:master\n\n<span class="token comment"># 适用于腾讯云环境(腾讯云主机、coding.net 持续集成)</span>\n$ docker buildx create --use --name<span class="token operator">=</span>mybuilder-cn --driver docker-container --driver-opt <span class="token assign-left variable">image</span><span class="token operator">=</span>dockerpracticesig/buildkit:master-tencent\n\n<span class="token comment"># $ docker buildx create --name mybuilder --driver docker-container</span>\n\n$ docker buildx use mybuilder</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="构建镜像-2"><a href="#%E6%9E%84%E5%BB%BA%E9%95%9C%E5%83%8F-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>构建镜像</h3>\n<p>新建 Dockerfile 文件。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="43572828542786530000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`FROM --platform=\\$TARGETPLATFORM alpine\n\nRUN uname -a > /os.txt\n\nCMD cat /os.txt`, `43572828542786530000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">FROM</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>platform=$TARGETPLATFORM alpine\n\n<span class="token keyword">RUN</span> uname <span class="token punctuation">-</span>a <span class="token punctuation">></span> /os.txt\n\n<span class="token keyword">CMD</span> cat /os.txt</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>使用 <code class="language-text">$ docker buildx build</code> 命令构建镜像，注意将 <code class="language-text">myusername</code> 替换为自己的 <code class="language-text">Docker Hub</code> 用户名。</p>\n<p><code class="language-text">--push</code> 参数表示将构建好的镜像推送到 Docker 仓库。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="14146115788010238000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker buildx build --platform linux/arm,linux/arm64,linux/amd64 -t myusername/hello . --push\n\n# 查看镜像信息\n\\$ docker buildx imagetools inspect myusername/hello`, `14146115788010238000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker buildx build --platform linux/arm,linux/arm64,linux/amd64 -t myusername/hello <span class="token builtin class-name">.</span> --push\n\n<span class="token comment"># 查看镜像信息</span>\n$ docker buildx imagetools inspect myusername/hello</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在不同架构运行该镜像，可以得到该架构的信息。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="62782383729645900000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# arm\n\\$ docker run -it --rm myusername/hello\nLinux buildkitsandbox 4.9.125-linuxkit #1 SMP Fri Sep 7 08:20:28 UTC 2018 armv7l Linux\n\n# arm64\n\\$ docker run -it --rm myusername/hello\nLinux buildkitsandbox 4.9.125-linuxkit #1 SMP Fri Sep 7 08:20:28 UTC 2018 aarch64 Linux\n\n# amd64\n\\$ docker run -it --rm myusername/hello\nLinux buildkitsandbox 4.9.125-linuxkit #1 SMP Fri Sep 7 08:20:28 UTC 2018 x86_64 Linux`, `62782383729645900000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token comment"># arm</span>\n$ docker run -it --rm myusername/hello\nLinux buildkitsandbox <span class="token number">4.9</span>.125-linuxkit <span class="token comment">#1 SMP Fri Sep 7 08:20:28 UTC 2018 armv7l Linux</span>\n\n<span class="token comment"># arm64</span>\n$ docker run -it --rm myusername/hello\nLinux buildkitsandbox <span class="token number">4.9</span>.125-linuxkit <span class="token comment">#1 SMP Fri Sep 7 08:20:28 UTC 2018 aarch64 Linux</span>\n\n<span class="token comment"># amd64</span>\n$ docker run -it --rm myusername/hello\nLinux buildkitsandbox <span class="token number">4.9</span>.125-linuxkit <span class="token comment">#1 SMP Fri Sep 7 08:20:28 UTC 2018 x86_64 Linux</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="架构相关变量"><a href="#%E6%9E%B6%E6%9E%84%E7%9B%B8%E5%85%B3%E5%8F%98%E9%87%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>架构相关变量</h3>\n<p>Dockerfile 支持如下架构相关的变量</p>\n<ul>\n<li>TARGETPLATFORM：构建镜像的目标平台，例如 <code class="language-text">linux/amd64</code>, <code class="language-text">linux/arm/v7</code>, <code class="language-text">windows/amd64</code>。</li>\n<li>TARGETOS：TARGETPLATFORM 的 OS 类型，例如 linux, windows</li>\n<li>TARGETARCH：TARGETPLATFORM 的架构类型，例如 amd64, arm</li>\n<li>TARGETVARIANT：TARGETPLATFORM 的变种，该变量可能为空，例如 v7</li>\n<li>BUILDPLATFORM：构建镜像主机平台，例如 <code class="language-text">linux/amd64</code></li>\n<li>BUILDOS：BUILDPLATFORM 的 OS 类型，例如 linux</li>\n<li>BUILDARCH：BUILDPLATFORM 的架构类型，例如 amd64</li>\n<li>BUILDVARIANT：BUILDPLATFORM 的变种，该变量可能为空，例如 v7</li>\n</ul>\n<h4 id="使用举例"><a href="#%E4%BD%BF%E7%94%A8%E4%B8%BE%E4%BE%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用举例</h4>\n<p>例如我们要构建支持 <code class="language-text">linux/arm/v7</code> 和 <code class="language-text">linux/amd64</code> 两种架构的镜像。假设已经生成了两个平台对应的二进制文件：</p>\n<ul>\n<li>bin/dist-linux-arm</li>\n<li>bin/dist-linux-amd64</li>\n</ul>\n<p>那么 Dockerfile 可以这样书写：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="88458780825415880000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`FROM scratch\n\n# 使用变量必须申明\nARG TARGETOS\n\nARG TARGETARCH\n\nCOPY bin/dist-\\${TARGETOS}-\\${TARGETARCH} /dist\n\nENTRYPOINT [&quot;dist&quot;]`, `88458780825415880000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">FROM scratch\n\n<span class="token comment"># 使用变量必须申明</span>\nARG TARGETOS\n\nARG TARGETARCH\n\nCOPY bin/dist-<span class="token variable">${TARGETOS}</span>-<span class="token variable">${TARGETARCH}</span> /dist\n\nENTRYPOINT <span class="token punctuation">[</span><span class="token string">"dist"</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="podman"><a href="#podman" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>podman</h1>\n<p><a href="https://github.com/containers/podman" target="_blank" rel="nofollow noreferrer noopener">podman</a> 是一个无守护程序与 docker 命令兼容的下一代 Linux 容器工具。</p>\n<h2 id="安装"><a href="#%E5%AE%89%E8%A3%85" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>安装</h2>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="90421427668265650000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ sudo yum -y install podman`, `90421427668265650000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ <span class="token function">sudo</span> yum -y <span class="token function">install</span> podman</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h2 id="使用-1"><a href="#%E4%BD%BF%E7%94%A8-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用</h2>\n<p>podman 与 docker 命令完全兼容，只需将 docker 替换为 podman 即可，例如运行一个容器：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="53282263393437180000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# \\$ docker run -d -p 80:80 nginx:alpine\n\n\\$ podman run -d -p 80:80 nginx:alpine`, `53282263393437180000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token comment"># $ docker run -d -p 80:80 nginx:alpine</span>\n\n$ podman run -d -p <span class="token number">80</span>:80 nginx:alpine</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<h1 id="常见问题总结"><a href="#%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E6%80%BB%E7%BB%93" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>常见问题总结</h1>\n<h2 id="镜像相关"><a href="#%E9%95%9C%E5%83%8F%E7%9B%B8%E5%85%B3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>镜像相关</h2>\n<h3 id="如何批量清理临时镜像文件？"><a href="#%E5%A6%82%E4%BD%95%E6%89%B9%E9%87%8F%E6%B8%85%E7%90%86%E4%B8%B4%E6%97%B6%E9%95%9C%E5%83%8F%E6%96%87%E4%BB%B6%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>如何批量清理临时镜像文件？</h3>\n<p>答：可以使用 <code class="language-text">docker image prune</code> 命令。</p>\n<h3 id="如何查看镜像支持的环境变量？"><a href="#%E5%A6%82%E4%BD%95%E6%9F%A5%E7%9C%8B%E9%95%9C%E5%83%8F%E6%94%AF%E6%8C%81%E7%9A%84%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>如何查看镜像支持的环境变量？</h3>\n<p>答：可以使用 <code class="language-text">docker run IMAGE env</code> 命令。</p>\n<h3 id="本地的镜像文件都存放在哪里？"><a href="#%E6%9C%AC%E5%9C%B0%E7%9A%84%E9%95%9C%E5%83%8F%E6%96%87%E4%BB%B6%E9%83%BD%E5%AD%98%E6%94%BE%E5%9C%A8%E5%93%AA%E9%87%8C%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>本地的镜像文件都存放在哪里？</h3>\n<p>答：与 Docker 相关的本地资源默认存放在 <code class="language-text">/var/lib/docker/</code> 目录下，以 overlay2 文件系统为例，其中 containers 目录存放容器信息，image 目录存放镜像信息，overlay2 目录下存放具体的镜像层文件。</p>\n<h3 id="构建-docker-镜像应该遵循哪些原则？"><a href="#%E6%9E%84%E5%BB%BA-docker-%E9%95%9C%E5%83%8F%E5%BA%94%E8%AF%A5%E9%81%B5%E5%BE%AA%E5%93%AA%E4%BA%9B%E5%8E%9F%E5%88%99%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>构建 Docker 镜像应该遵循哪些原则？</h3>\n<p>答：整体原则上，尽量保持镜像功能的明确和内容的精简，要点包括</p>\n<ul>\n<li>尽量选取满足需求但较小的基础系统镜像，例如大部分时候可以选择 alpine 镜像，仅有不足六兆大小；</li>\n<li>清理编译生成文件、安装包的缓存等临时文件；</li>\n<li>安装各个软件时候要指定准确的版本号，并避免引入不需要的依赖；</li>\n<li>从安全角度考虑，应用要尽量使用系统的库和依赖；</li>\n<li>如果安装应用时候需要配置一些特殊的环境变量，在安装后要还原不需要保持的变量值；</li>\n<li>使用 Dockerfile 创建镜像时候要添加 <code class="language-text">.dockerignore</code> 文件或使用干净的工作目录。</li>\n</ul>\n<h3 id="碰到网络问题，无法-pull-镜像，命令行指定-http_proxy-无效？"><a href="#%E7%A2%B0%E5%88%B0%E7%BD%91%E7%BB%9C%E9%97%AE%E9%A2%98%EF%BC%8C%E6%97%A0%E6%B3%95-pull-%E9%95%9C%E5%83%8F%EF%BC%8C%E5%91%BD%E4%BB%A4%E8%A1%8C%E6%8C%87%E5%AE%9A-http_proxy-%E6%97%A0%E6%95%88%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>碰到网络问题，无法 pull 镜像，命令行指定 <code class="language-text">http_proxy</code> 无效？</h3>\n<p>答：在 Docker 配置文件中添加 <code class="language-text">export http_proxy=&quot;http://&lt;PROXY_HOST&gt;:&lt;PROXY_PORT&gt;&quot;</code>，之后重启 Docker 服务即可。</p>\n<h2 id="容器相关"><a href="#%E5%AE%B9%E5%99%A8%E7%9B%B8%E5%85%B3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>容器相关</h2>\n<h3 id="容器退出后，通过-docker-container-ls-命令查看不到，数据会丢失么？"><a href="#%E5%AE%B9%E5%99%A8%E9%80%80%E5%87%BA%E5%90%8E%EF%BC%8C%E9%80%9A%E8%BF%87-docker-container-ls-%E5%91%BD%E4%BB%A4%E6%9F%A5%E7%9C%8B%E4%B8%8D%E5%88%B0%EF%BC%8C%E6%95%B0%E6%8D%AE%E4%BC%9A%E4%B8%A2%E5%A4%B1%E4%B9%88%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>容器退出后，通过 <code class="language-text">docker container ls</code> 命令查看不到，数据会丢失么？</h3>\n<p>答：容器退出后会处于终止（exited）状态，此时可以通过 <code class="language-text">docker container ls -a</code> 查看。其中的数据也不会丢失，还可以通过 docker start 命令来启动它。只有删除掉容器才会清除所有数据。</p>\n<h3 id="如何停止所有正在运行的容器？"><a href="#%E5%A6%82%E4%BD%95%E5%81%9C%E6%AD%A2%E6%89%80%E6%9C%89%E6%AD%A3%E5%9C%A8%E8%BF%90%E8%A1%8C%E7%9A%84%E5%AE%B9%E5%99%A8%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>如何停止所有正在运行的容器？</h3>\n<p>答：可以使用 <code class="language-text">docker stop $(docker container ls -q)</code> 命令。</p>\n<h3 id="如何批量清理已经停止的容器？"><a href="#%E5%A6%82%E4%BD%95%E6%89%B9%E9%87%8F%E6%B8%85%E7%90%86%E5%B7%B2%E7%BB%8F%E5%81%9C%E6%AD%A2%E7%9A%84%E5%AE%B9%E5%99%A8%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>如何批量清理已经停止的容器？</h3>\n<p>答：可以使用 <code class="language-text">docker container prune</code> 命令。</p>\n<h3 id="如何获取某个容器的-pid-信息？"><a href="#%E5%A6%82%E4%BD%95%E8%8E%B7%E5%8F%96%E6%9F%90%E4%B8%AA%E5%AE%B9%E5%99%A8%E7%9A%84-pid-%E4%BF%A1%E6%81%AF%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>如何获取某个容器的 PID 信息？</h3>\n<p>答：可以使用</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="56228874912918970000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`docker inspect --format \'{{ .State.Pid }}\' <CONTAINER ID or NAME>`, `56228874912918970000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">docker inspect --format <span class="token string">\'{{ .State.Pid }}\'</span> <span class="token operator">&lt;</span>CONTAINER ID or NAME<span class="token operator">></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h3 id="如何获取某个容器的-ip-地址？"><a href="#%E5%A6%82%E4%BD%95%E8%8E%B7%E5%8F%96%E6%9F%90%E4%B8%AA%E5%AE%B9%E5%99%A8%E7%9A%84-ip-%E5%9C%B0%E5%9D%80%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>如何获取某个容器的 IP 地址？</h3>\n<p>答：可以使用</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="29356720975351337000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`docker inspect --format \'{{ .NetworkSettings.IPAddress }}\' <CONTAINER ID or NAME>`, `29356720975351337000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">docker inspect --format <span class="token string">\'{{ .NetworkSettings.IPAddress }}\'</span> <span class="token operator">&lt;</span>CONTAINER ID or NAME<span class="token operator">></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h3 id="如何给容器指定一个固定-ip-地址，而不是每次重启容器-ip-地址都会变？"><a href="#%E5%A6%82%E4%BD%95%E7%BB%99%E5%AE%B9%E5%99%A8%E6%8C%87%E5%AE%9A%E4%B8%80%E4%B8%AA%E5%9B%BA%E5%AE%9A-ip-%E5%9C%B0%E5%9D%80%EF%BC%8C%E8%80%8C%E4%B8%8D%E6%98%AF%E6%AF%8F%E6%AC%A1%E9%87%8D%E5%90%AF%E5%AE%B9%E5%99%A8-ip-%E5%9C%B0%E5%9D%80%E9%83%BD%E4%BC%9A%E5%8F%98%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>如何给容器指定一个固定 IP 地址，而不是每次重启容器 IP 地址都会变？</h3>\n<p>答：使用以下命令启动容器可以使容器 IP 固定不变</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="39333079089570090000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker network create -d bridge --subnet 172.25.0.0/16 my-net\n\n\\$ docker run --network=my-net --ip=172.25.3.3 -itd --name=my-container busybox`, `39333079089570090000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker network create -d bridge --subnet <span class="token number">172.25</span>.0.0/16 my-net\n\n$ docker run --network<span class="token operator">=</span>my-net --ip<span class="token operator">=</span><span class="token number">172.25</span>.3.3 -itd --name<span class="token operator">=</span>my-container busybox</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<h3 id="如何临时退出一个正在交互的容器的终端，而不终止它？"><a href="#%E5%A6%82%E4%BD%95%E4%B8%B4%E6%97%B6%E9%80%80%E5%87%BA%E4%B8%80%E4%B8%AA%E6%AD%A3%E5%9C%A8%E4%BA%A4%E4%BA%92%E7%9A%84%E5%AE%B9%E5%99%A8%E7%9A%84%E7%BB%88%E7%AB%AF%EF%BC%8C%E8%80%8C%E4%B8%8D%E7%BB%88%E6%AD%A2%E5%AE%83%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>如何临时退出一个正在交互的容器的终端，而不终止它？</h3>\n<p>答：按 <code class="language-text">Ctrl-p</code> <code class="language-text">Ctrl-q</code>。如果按 <code class="language-text">Ctrl-c</code> 往往会让容器内应用进程终止，进而会终止容器。</p>\n<h3 id="使用-docker-port-命令映射容器的端口时，系统报错-error-no-public-port-80-published-for-xxx？"><a href="#%E4%BD%BF%E7%94%A8-docker-port-%E5%91%BD%E4%BB%A4%E6%98%A0%E5%B0%84%E5%AE%B9%E5%99%A8%E7%9A%84%E7%AB%AF%E5%8F%A3%E6%97%B6%EF%BC%8C%E7%B3%BB%E7%BB%9F%E6%8A%A5%E9%94%99-error-no-public-port-80-published-for-xxx%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用 docker port 命令映射容器的端口时，系统报错 “Error: No public port ‘80’ published for xxx”？</h3>\n<ul>\n<li>\n<p>创建镜像时 Dockerfile 要通过 EXPOSE 指定正确的开放端口；</p>\n</li>\n<li>\n<p>容器启动时指定 <code class="language-text">PublishAllPort = true</code>。</p>\n</li>\n</ul>\n<h3 id="可以在一个容器中同时运行多个应用进程么？"><a href="#%E5%8F%AF%E4%BB%A5%E5%9C%A8%E4%B8%80%E4%B8%AA%E5%AE%B9%E5%99%A8%E4%B8%AD%E5%90%8C%E6%97%B6%E8%BF%90%E8%A1%8C%E5%A4%9A%E4%B8%AA%E5%BA%94%E7%94%A8%E8%BF%9B%E7%A8%8B%E4%B9%88%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>可以在一个容器中同时运行多个应用进程么？</h3>\n<p>答：一般并不推荐在同一个容器内运行多个应用进程。如果有类似需求，可以通过一些额外的进程管理机制，比如 supervisord 来管理所运行的进程。可以参考 <a href="https://docs.docker.com/config/containers/multi-service_container/" target="_blank" rel="nofollow noreferrer noopener">https://docs.docker.com/config/containers/multi-service_container/</a> 。</p>\n<h3 id="如何控制容器占用系统资源（cpu、内存）的份额？"><a href="#%E5%A6%82%E4%BD%95%E6%8E%A7%E5%88%B6%E5%AE%B9%E5%99%A8%E5%8D%A0%E7%94%A8%E7%B3%BB%E7%BB%9F%E8%B5%84%E6%BA%90%EF%BC%88cpu%E3%80%81%E5%86%85%E5%AD%98%EF%BC%89%E7%9A%84%E4%BB%BD%E9%A2%9D%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>如何控制容器占用系统资源（CPU、内存）的份额？</h3>\n<p>答：在使用 <code class="language-text">docker create</code> 命令创建容器或使用 <code class="language-text">docker run</code> 创建并启动容器的时候，可以使用 <code class="language-text">-c|--cpu-shares[=0]</code> 参数来调整容器使用 CPU 的权重；使用 <code class="language-text">-m|--memory[=MEMORY]</code> 参数来调整容器使用内存的大小。</p>\n<h2 id="仓库相关"><a href="#%E4%BB%93%E5%BA%93%E7%9B%B8%E5%85%B3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>仓库相关</h2>\n<h3 id="仓库（repository）、注册服务器（registry）、注册索引（index）有何关系？"><a href="#%E4%BB%93%E5%BA%93%EF%BC%88repository%EF%BC%89%E3%80%81%E6%B3%A8%E5%86%8C%E6%9C%8D%E5%8A%A1%E5%99%A8%EF%BC%88registry%EF%BC%89%E3%80%81%E6%B3%A8%E5%86%8C%E7%B4%A2%E5%BC%95%EF%BC%88index%EF%BC%89%E6%9C%89%E4%BD%95%E5%85%B3%E7%B3%BB%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>仓库（Repository）、注册服务器（Registry）、注册索引（Index）有何关系？</h3>\n<p>首先，仓库是存放一组关联镜像的集合，比如同一个应用的不同版本的镜像。</p>\n<p>注册服务器是存放实际的镜像文件的地方。注册索引则负责维护用户的账号、权限、搜索、标签等的管理。因此，注册服务器利用注册索引来实现认证等管理。</p>\n<h2 id="配置相关"><a href="#%E9%85%8D%E7%BD%AE%E7%9B%B8%E5%85%B3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>配置相关</h2>\n<h3 id="docker-的配置文件放在哪里，如何修改配置？"><a href="#docker-%E7%9A%84%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E6%94%BE%E5%9C%A8%E5%93%AA%E9%87%8C%EF%BC%8C%E5%A6%82%E4%BD%95%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Docker 的配置文件放在哪里，如何修改配置？</h3>\n<p>答：使用 systemd 的系统（如 <code class="language-text">Ubuntu 16.04</code>、Centos 等）的配置文件在 <code class="language-text">/etc/docker/daemon.json</code>。</p>\n<h3 id="如何更改-docker-的默认存储位置？"><a href="#%E5%A6%82%E4%BD%95%E6%9B%B4%E6%94%B9-docker-%E7%9A%84%E9%BB%98%E8%AE%A4%E5%AD%98%E5%82%A8%E4%BD%8D%E7%BD%AE%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>如何更改 Docker 的默认存储位置？</h3>\n<p>答：Docker 的默认存储位置是 <code class="language-text">/var/lib/docker</code>，如果希望将 Docker 的本地文件存储到其他分区，可以使用 Linux 软连接的方式来完成，或者在启动 daemon 时通过 <code class="language-text">-g</code> 参数指定，或者修改配置文件 <code class="language-text">/etc/docker/daemon.json</code> 的 “data-root” 项 。可以使用 <code class="language-text">docker system info | grep &quot;Root Dir&quot;</code> 查看当前使用的存储位置。</p>\n<p>例如，如下操作将默认存储位置迁移到 <code class="language-text">/storage/docker</code>。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="66956885916232160000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`[root@s26 ~]# df -h\nFilesystem                    Size  Used Avail Use% Mounted on\n/dev/mapper/VolGroup-lv_root   50G  5.3G   42G  12% /\ntmpfs                          48G  228K   48G   1% /dev/shm\n/dev/sda1                     485M   40M  420M   9% /boot\n/dev/mapper/VolGroup-lv_home  222G  188M  210G   1% /home\n/dev/sdb2                     2.7T  323G  2.3T  13% /storage\n[root@s26 ~]# service docker stop\n[root@s26 ~]# cd /var/lib/\n[root@s26 lib]# mv docker /storage/\n[root@s26 lib]# ln -s /storage/docker/ docker\n[root@s26 lib]# ls -la docker\nlrwxrwxrwx. 1 root root 15 11月 17 13:43 docker -> /storage/docker\n[root@s26 lib]# service docker start`, `66956885916232160000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token punctuation">[</span>root@s26 ~<span class="token punctuation">]</span><span class="token comment"># df -h</span>\nFilesystem                    Size  Used Avail Use% Mounted on\n/dev/mapper/VolGroup-lv_root   50G  <span class="token number">5</span>.3G   42G  <span class="token number">12</span>% /\ntmpfs                          48G  228K   48G   <span class="token number">1</span>% /dev/shm\n/dev/sda1                     485M   40M  420M   <span class="token number">9</span>% /boot\n/dev/mapper/VolGroup-lv_home  222G  188M  210G   <span class="token number">1</span>% /home\n/dev/sdb2                     <span class="token number">2</span>.7T  323G  <span class="token number">2</span>.3T  <span class="token number">13</span>% /storage\n<span class="token punctuation">[</span>root@s26 ~<span class="token punctuation">]</span><span class="token comment"># service docker stop</span>\n<span class="token punctuation">[</span>root@s26 ~<span class="token punctuation">]</span><span class="token comment"># cd /var/lib/</span>\n<span class="token punctuation">[</span>root@s26 lib<span class="token punctuation">]</span><span class="token comment"># mv docker /storage/</span>\n<span class="token punctuation">[</span>root@s26 lib<span class="token punctuation">]</span><span class="token comment"># ln -s /storage/docker/ docker</span>\n<span class="token punctuation">[</span>root@s26 lib<span class="token punctuation">]</span><span class="token comment"># ls -la docker</span>\nlrwxrwxrwx. <span class="token number">1</span> root root <span class="token number">15</span> <span class="token number">11</span>月 <span class="token number">17</span> <span class="token number">13</span>:43 docker -<span class="token operator">></span> /storage/docker\n<span class="token punctuation">[</span>root@s26 lib<span class="token punctuation">]</span><span class="token comment"># service docker start</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="使用内存和-swap-限制启动容器时候报警告：warning-your-kernel-does-not-support-cgroup-swap-limit-warning-your-kernel-does-not-support-swap-limit-capabilities-limitation-discarded？"><a href="#%E4%BD%BF%E7%94%A8%E5%86%85%E5%AD%98%E5%92%8C-swap-%E9%99%90%E5%88%B6%E5%90%AF%E5%8A%A8%E5%AE%B9%E5%99%A8%E6%97%B6%E5%80%99%E6%8A%A5%E8%AD%A6%E5%91%8A%EF%BC%9Awarning-your-kernel-does-not-support-cgroup-swap-limit-warning-your-kernel-does-not-support-swap-limit-capabilities-limitation-discarded%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用内存和 swap 限制启动容器时候报警告：“WARNING: Your kernel does not support cgroup swap limit. WARNING: Your kernel does not support swap limit capabilities. Limitation discarded.“？</h3>\n<p>答：这是因为系统默认没有开启对内存和 swap 使用的统计功能，引入该功能会带来性能的下降。要开启该功能，可以采取如下操作：</p>\n<ul>\n<li>编辑 <code class="language-text">/etc/default/grub</code> 文件（Ubuntu 系统为例），配置 <code class="language-text">GRUB_CMDLINE_LINUX=&quot;cgroup_enable=memory swapaccount=1&quot;</code></li>\n<li>更新 grub：<code class="language-text">$ sudo update-grub</code></li>\n<li>重启系统，即可。</li>\n</ul>\n<h2 id="docker-与虚拟化"><a href="#docker-%E4%B8%8E%E8%99%9A%E6%8B%9F%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Docker 与虚拟化</h2>\n<h3 id="docker-与-lxc（linux-container）有何不同？"><a href="#docker-%E4%B8%8E-lxc%EF%BC%88linux-container%EF%BC%89%E6%9C%89%E4%BD%95%E4%B8%8D%E5%90%8C%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Docker 与 LXC（Linux Container）有何不同？</h3>\n<p>答：LXC 利用 Linux 上相关技术实现了容器。Docker 则在如下的几个方面进行了改进：</p>\n<ul>\n<li>移植性：通过抽象容器配置，容器可以实现从一个平台移植到另一个平台；</li>\n<li>镜像系统：基于 OverlayFS 的镜像系统为容器的分发带来了很多的便利，同时共同的镜像层只需要存储一份，实现高效率的存储；</li>\n<li>版本管理：类似于 Git 的版本管理理念，用户可以更方便的创建、管理镜像文件；</li>\n<li>仓库系统：仓库系统大大降低了镜像的分发和管理的成本；</li>\n<li>周边工具：各种现有工具（配置管理、云平台）对 Docker 的支持，以及基于 Docker 的 PaaS、CI 等系统，让 Docker 的应用更加方便和多样化。</li>\n</ul>\n<h3 id="docker-与-vagrant-有何不同？"><a href="#docker-%E4%B8%8E-vagrant-%E6%9C%89%E4%BD%95%E4%B8%8D%E5%90%8C%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Docker 与 Vagrant 有何不同？</h3>\n<p>答：两者的定位完全不同。</p>\n<ul>\n<li>Vagrant 类似 Boot2Docker（一款运行 Docker 的最小内核），是一套虚拟机的管理环境。Vagrant 可以在多种系统上和虚拟机软件中运行，可以在 Windows，Mac 等非 Linux 平台上为 Docker 提供支持，自身具有较好的包装性和移植性。</li>\n<li>原生的 Docker 自身只能运行在 Linux 平台上，但启动和运行的性能都比虚拟机要快，往往更适合快速开发和部署应用的场景。</li>\n</ul>\n<p>简单说：Vagrant 适合用来管理虚拟机，而 Docker 适合用来管理应用环境。</p>\n<h3 id="开发环境中-docker-和-vagrant-该如何选择？"><a href="#%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E4%B8%AD-docker-%E5%92%8C-vagrant-%E8%AF%A5%E5%A6%82%E4%BD%95%E9%80%89%E6%8B%A9%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>开发环境中 Docker 和 Vagrant 该如何选择？</h3>\n<p>答：Docker 不是虚拟机，而是进程隔离，对于资源的消耗很少，但是目前需要 Linux 环境支持。Vagrant 是虚拟机上做的封装，虚拟机本身会消耗资源。</p>\n<p>如果本地使用的 Linux 环境，推荐都使用 Docker。</p>\n<p>如果本地使用的是 macOS 或者 Windows 环境，那就需要开虚拟机，单一开发环境下 Vagrant 更简单；多环境开发下推荐在 Vagrant 里面再使用 Docker 进行环境隔离。</p>\n<h2 id="其它"><a href="#%E5%85%B6%E5%AE%83" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>其它</h2>\n<h3 id="docker-能在非-linux-平台（比如-windows-或-macos-）上运行么？"><a href="#docker-%E8%83%BD%E5%9C%A8%E9%9D%9E-linux-%E5%B9%B3%E5%8F%B0%EF%BC%88%E6%AF%94%E5%A6%82-windows-%E6%88%96-macos-%EF%BC%89%E4%B8%8A%E8%BF%90%E8%A1%8C%E4%B9%88%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Docker 能在非 Linux 平台（比如 Windows 或 macOS ）上运行么？</h3>\n<p>答：完全可以。</p>\n<h3 id="如何将一台宿主主机的-docker-环境迁移到另外一台宿主主机？"><a href="#%E5%A6%82%E4%BD%95%E5%B0%86%E4%B8%80%E5%8F%B0%E5%AE%BF%E4%B8%BB%E4%B8%BB%E6%9C%BA%E7%9A%84-docker-%E7%8E%AF%E5%A2%83%E8%BF%81%E7%A7%BB%E5%88%B0%E5%8F%A6%E5%A4%96%E4%B8%80%E5%8F%B0%E5%AE%BF%E4%B8%BB%E4%B8%BB%E6%9C%BA%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>如何将一台宿主主机的 Docker 环境迁移到另外一台宿主主机？</h3>\n<p>答：停止 Docker 服务。将整个 Docker 存储文件夹复制到另外一台宿主主机，然后调整另外一台宿主主机的配置即可。</p>\n<h3 id="如何进入-docker-容器的网络命名空间？"><a href="#%E5%A6%82%E4%BD%95%E8%BF%9B%E5%85%A5-docker-%E5%AE%B9%E5%99%A8%E7%9A%84%E7%BD%91%E7%BB%9C%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>如何进入 Docker 容器的网络命名空间？</h3>\n<p>答：Docker 在创建容器后，删除了宿主主机上 <code class="language-text">/var/run/netns</code> 目录中的相关的网络命名空间文件。因此，在宿主主机上是无法看到或访问容器的网络命名空间的。</p>\n<p>用户可以通过如下方法来手动恢复它。</p>\n<p>首先，使用下面的命令查看容器进程信息，比如这里的 1234。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="34169638915579957000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker inspect --format=\'{{. State.Pid}}\' \\$container_id\n1234`, `34169638915579957000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker inspect --format<span class="token operator">=</span><span class="token string">\'{{. State.Pid}}\'</span> <span class="token variable">$container_id</span>\n<span class="token number">1234</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>接下来，在 <code class="language-text">/proc</code> 目录下，把对应的网络命名空间文件链接到 <code class="language-text">/var/run/netns</code> 目录。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="12786562508770417000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ sudo ln -s /proc/1234/ns/net /var/run/netns/`, `12786562508770417000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ <span class="token function">sudo</span> <span class="token function">ln</span> -s /proc/1234/ns/net /var/run/netns/</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>然后，在宿主主机上就可以看到容器的网络命名空间信息。例如</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="33687981253350375000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ sudo ip netns show\n1234`, `33687981253350375000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ <span class="token function">sudo</span> <span class="token function">ip</span> netns show\n<span class="token number">1234</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>此时，用户可以通过正常的系统命令来查看或操作容器的命名空间了。例如修改容器的 IP 地址信息为 <code class="language-text">172.17.0.100/16</code>。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="28249061931635500000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ sudo ip netns exec 1234 ifconfig eth0 172.17.0.100/16`, `28249061931635500000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ <span class="token function">sudo</span> <span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> <span class="token number">1234</span> <span class="token function">ifconfig</span> eth0 <span class="token number">172.17</span>.0.100/16</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h3 id="如何获取容器绑定到本地那个-veth-接口上？"><a href="#%E5%A6%82%E4%BD%95%E8%8E%B7%E5%8F%96%E5%AE%B9%E5%99%A8%E7%BB%91%E5%AE%9A%E5%88%B0%E6%9C%AC%E5%9C%B0%E9%82%A3%E4%B8%AA-veth-%E6%8E%A5%E5%8F%A3%E4%B8%8A%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>如何获取容器绑定到本地那个 veth 接口上？</h3>\n<p>答：Docker 容器启动后，会通过 veth 接口对连接到本地网桥，veth 接口命名跟容器命名毫无关系，十分难以找到对应关系。</p>\n<p>最简单的一种方式是通过查看接口的索引号，在容器中执行 <code class="language-text">ip a</code> 命令，查看到本地接口最前面的接口索引号，如 205，将此值加上 1，即 206，然后在本地主机执行 <code class="language-text">ip a</code> 命令，查找接口索引号为 206 的接口，两者即为连接的 veth 接口对。</p>\n<h1 id="docker-命令"><a href="#docker-%E5%91%BD%E4%BB%A4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Docker 命令</h1>\n<p>Docker 命令有两大类，客户端命令和服务端命令。前者是主要的操作接口，后者用来启动 Docker Daemon。</p>\n<ul>\n<li>客户端命令：基本命令格式为 <code class="language-text">docker [OPTIONS] COMMAND [arg...]</code>；</li>\n<li>服务端命令：基本命令格式为 <code class="language-text">dockerd [OPTIONS]</code>。</li>\n</ul>\n<p>可以通过 <code class="language-text">man docker</code> 或 <code class="language-text">docker help</code> 来查看这些命令。</p>\n<h2 id="客户端命令docker"><a href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%91%BD%E4%BB%A4docker" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>客户端命令(docker)</h2>\n<h3 id="客户端命令选项"><a href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%91%BD%E4%BB%A4%E9%80%89%E9%A1%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>客户端命令选项</h3>\n<ul>\n<li><code class="language-text">--config=&quot;&quot;</code>：指定客户端配置文件，默认为 <code class="language-text">~/.docker</code>；</li>\n<li><code class="language-text">-D=true|false</code>：是否使用 debug 模式。默认不开启；</li>\n<li><code class="language-text">-H, --host=[]</code>：指定命令对应 Docker 守护进程的监听接口，可以为 unix 套接字 <code class="language-text">unix:///path/to/socket</code>，文件句柄 <code class="language-text">fd://socketfd</code> 或 tcp 套接字 <code class="language-text">tcp://[host[:port]]</code>，默认为 <code class="language-text">unix:///var/run/docker.sock</code>；</li>\n<li><code class="language-text">-l, --log-level=&quot;debug|info|warn|error|fatal&quot;</code>：指定日志输出级别；</li>\n<li><code class="language-text">--tls=true|false</code>：是否对 Docker 守护进程启用 TLS 安全机制，默认为否；</li>\n<li><code class="language-text">--tlscacert=/.docker/ca.pem</code>：TLS CA 签名的可信证书文件路径；</li>\n<li><code class="language-text">--tlscert=/.docker/cert.pem</code>：TLS 可信证书文件路径；</li>\n<li><code class="language-text">--tlscert=/.docker/key.pem</code>：TLS 密钥文件路径；</li>\n<li><code class="language-text">--tlsverify=true|false</code>：启用 TLS 校验，默认为否。</li>\n</ul>\n<h3 id="客户端命令"><a href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%91%BD%E4%BB%A4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>客户端命令</h3>\n<p>可以通过 <code class="language-text">docker COMMAND --help</code> 来查看这些命令的具体用法。</p>\n<ul>\n<li>attach：依附到一个正在运行的容器中；</li>\n<li>build：从一个 Dockerfile 创建一个镜像；</li>\n<li>commit：从一个容器的修改中创建一个新的镜像；</li>\n<li>cp：在容器和本地宿主系统之间复制文件中；</li>\n<li>create：创建一个新容器，但并不运行它；</li>\n<li>diff：检查一个容器内文件系统的修改，包括修改和增加；</li>\n<li>events：从服务端获取实时的事件；</li>\n<li>exec：在运行的容器内执行命令；</li>\n<li>export：导出容器内容为一个 tar 包；</li>\n<li>history：显示一个镜像的历史信息；</li>\n<li>images：列出存在的镜像；</li>\n<li>import：导入一个文件（典型为 tar 包）路径或目录来创建一个本地镜像；</li>\n<li>info：显示一些相关的系统信息；</li>\n<li>inspect：显示一个容器的具体配置信息；</li>\n<li>kill：关闭一个运行中的容器 (包括进程和所有相关资源)；</li>\n<li>load：从一个 tar 包中加载一个镜像；</li>\n<li>login：注册或登录到一个 Docker 的仓库服务器；</li>\n<li>logout：从 Docker 的仓库服务器登出；</li>\n<li>logs：获取容器的 log 信息；</li>\n<li>network：管理 Docker 的网络，包括查看、创建、删除、挂载、卸载等；</li>\n<li>node：管理 swarm 集群中的节点，包括查看、更新、删除、提升/取消管理节点等；</li>\n<li>pause：暂停一个容器中的所有进程；</li>\n<li>port：查找一个 nat 到一个私有网口的公共口；</li>\n<li>ps：列出主机上的容器；</li>\n<li>pull：从一个 Docker 的仓库服务器下拉一个镜像或仓库；</li>\n<li>push：将一个镜像或者仓库推送到一个 Docker 的注册服务器；</li>\n<li>rename：重命名一个容器；</li>\n<li>restart：重启一个运行中的容器；</li>\n<li>rm：删除给定的若干个容器；</li>\n<li>rmi：删除给定的若干个镜像；</li>\n<li>run：创建一个新容器，并在其中运行给定命令；</li>\n<li>save：保存一个镜像为 tar 包文件；</li>\n<li>search：在 Docker index 中搜索一个镜像；</li>\n<li>service：管理 Docker 所启动的应用服务，包括创建、更新、删除等；</li>\n<li>start：启动一个容器；</li>\n<li>stats：输出（一个或多个）容器的资源使用统计信息；</li>\n<li>stop：终止一个运行中的容器；</li>\n<li>swarm：管理 Docker swarm 集群，包括创建、加入、退出、更新等；</li>\n<li>tag：为一个镜像打标签；</li>\n<li>top：查看一个容器中的正在运行的进程信息；</li>\n<li>unpause：将一个容器内所有的进程从暂停状态中恢复；</li>\n<li>update：更新指定的若干容器的配置信息；</li>\n<li>version：输出 Docker 的版本信息；</li>\n<li>volume：管理 Docker volume，包括查看、创建、删除等；</li>\n<li>wait：阻塞直到一个容器终止，然后输出它的退出符。</li>\n</ul>\n<h3 id="一张图总结-docker-的命令"><a href="#%E4%B8%80%E5%BC%A0%E5%9B%BE%E6%80%BB%E7%BB%93-docker-%E7%9A%84%E5%91%BD%E4%BB%A4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>一张图总结 Docker 的命令</h3>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-07-20-14-15-18-6a07fce065941fb650ecfc12354bb03b-95179.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 95%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAIAAAAf7rriAAAACXBIWXMAAAsSAAALEgHS3X78AAACh0lEQVQ4y5VUvW7UQBD2S/EKFLwALW9ARRdRICEh0VBRQQQtNUJEoUAhCaCg5EiU5Mzpcpf7sX3ntfd/7f2zGdvK5YBrGFmrsXe+mdlvvnWQITSdTPr90DlX/6cFK6+qqnXfe1/dmG/t37CgWrPVtjHGWiulVEoVRcEoI4RsAK88iIZQCBKcE4wZawCAT9EySRJKKQTACjGbwTjPM4zj8ej69EQoJaXIsrw3OBqMfkFxsAylQogNYGg1DEPWGqSnrUHNOI4IwdAFF5Kmc8Wyrv2/KwO+4xzACCGtNXyBFV67jEJwCLqtDNQUrakbA7/LAgzDAg6kLUu9illxFiTxbHw1TJLFxkmuT2HdIJvRRWBN0R2g61wbDXVuAa1DwzeTzw/Toy1Xom7DeysFac6c5/ll/4Jymuf49KwXxfN220Pz0Kl1lQpfLT49YN8eVWW+YgsKgEh8WRQAW1K5pCrLMcwWkEA1Qin4XReYSWMbLr2xivKSSWddADTAMNKcMO3hwbyhBWjuRsUZM7Yyl09n7++yvfuKXpNrdL5zcLXX01R28vTa+lxaJDRXxlnDOQdpNweuGkmbaDc7fsEvthVH/paNKjDWdEoEMaUpoiAlzgil8Txappmta+etrusUWjJOSMFTTKYLFiFXmgDmN52NkngOzUfRbLGYDwahEBKKLrN8ME9kWVa1B2HqssSUoOFs8vVsfnRpuAqgveEUHf4cf79IfvSj/eNhOF5UNxcQGMGYAKFKpE7TopB+7fI1ozrojZ9v7z57e/jk9f7jlx8/HAzWbl8Tyk+2Ru/upDv3vIqa795BdqPLAJTrnW0iCpdSo90ff4LWqR0+N7NdE39xpugKg7yUJL8BbOM6W57Sp9wAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 07 20 14 15 18" title="" data-src="/static/2022-07-20-14-15-18-6a07fce065941fb650ecfc12354bb03b-fee1c.png" data-srcset="/static/2022-07-20-14-15-18-6a07fce065941fb650ecfc12354bb03b-a67b7.png 200w,\n/static/2022-07-20-14-15-18-6a07fce065941fb650ecfc12354bb03b-0b187.png 400w,\n/static/2022-07-20-14-15-18-6a07fce065941fb650ecfc12354bb03b-fee1c.png 800w,\n/static/2022-07-20-14-15-18-6a07fce065941fb650ecfc12354bb03b-b1a91.png 1200w,\n/static/2022-07-20-14-15-18-6a07fce065941fb650ecfc12354bb03b-95179.png 1600w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h2 id="服务端命令dockerd"><a href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%91%BD%E4%BB%A4dockerd" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>服务端命令(dockerd)</h2>\n<h3 id="dockerd-命令选项"><a href="#dockerd-%E5%91%BD%E4%BB%A4%E9%80%89%E9%A1%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>dockerd 命令选项</h3>\n<ul>\n<li><code class="language-text">--api-cors-header=&quot;&quot;</code>：CORS 头部域，默认不允许 CORS，要允许任意的跨域访问，可以指定为 ”*“；</li>\n<li><code class="language-text">--authorization-plugin=&quot;&quot;</code>：载入认证的插件；</li>\n<li><code class="language-text">-b=&quot;&quot;</code>：将容器挂载到一个已存在的网桥上。指定为 none 时则禁用容器的网络，与 <code class="language-text">--bip</code> 选项互斥；</li>\n<li><code class="language-text">--bip=&quot;&quot;</code>：让动态创建的 docker0 网桥采用给定的 CIDR 地址; 与 <code class="language-text">-b</code> 选项互斥；</li>\n<li><code class="language-text">--cgroup-parent=&quot;&quot;</code>：指定 cgroup 的父组，默认 fs cgroup 驱动为 <code class="language-text">/docker</code>，systemd cgroup 驱动为 <code class="language-text">system.slice</code>；</li>\n<li><code class="language-text">--cluster-store=&quot;&quot;</code>：构成集群（如 Swarm）时，集群键值数据库服务地址；</li>\n<li><code class="language-text">--cluster-advertise=&quot;&quot;</code>：构成集群时，自身的被访问地址，可以为 <code class="language-text">host:port</code> 或 <code class="language-text">interface:port</code>；</li>\n<li><code class="language-text">--cluster-store-opt=&quot;&quot;</code>：构成集群时，键值数据库的配置选项；</li>\n<li><code class="language-text">--config-file=&quot;/etc/docker/daemon.json&quot;</code>：daemon 配置文件路径；</li>\n<li><code class="language-text">--containerd=&quot;&quot;</code>：containerd 文件的路径；</li>\n<li><code class="language-text">-D, --debug=true|false</code>：是否使用 Debug 模式。缺省为 false；</li>\n<li><code class="language-text">--default-gateway=&quot;&quot;</code>：容器的 IPv4 网关地址，必须在网桥的子网段内；</li>\n<li><code class="language-text">--default-gateway-v6=&quot;&quot;</code>：容器的 IPv6 网关地址；</li>\n<li><code class="language-text">--default-ulimit=[]</code>：默认的 ulimit 值；</li>\n<li><code class="language-text">--disable-legacy-registry=true|false</code>：是否允许访问旧版本的镜像仓库服务器；</li>\n<li><code class="language-text">--dns=&quot;&quot;</code>：指定容器使用的 DNS 服务器地址；</li>\n<li><code class="language-text">--dns-opt=&quot;&quot;</code>：DNS 选项；</li>\n<li><code class="language-text">--dns-search=[]</code>：DNS 搜索域；</li>\n<li><code class="language-text">--exec-opt=[]</code>：运行时的执行选项；</li>\n<li><code class="language-text">--exec-root=&quot;&quot;</code>：容器执行状态文件的根路径，默认为 <code class="language-text">/var/run/docker</code>；</li>\n<li><code class="language-text">--fixed-cidr=&quot;&quot;</code>：限定分配 IPv4 地址范围；</li>\n<li><code class="language-text">--fixed-cidr-v6=&quot;&quot;</code>：限定分配 IPv6 地址范围；</li>\n<li><code class="language-text">-G, --group=&quot;&quot;</code>：分配给 unix 套接字的组，默认为 docker；</li>\n<li><code class="language-text">-g, --graph=&quot;&quot;</code>：Docker 运行时的根路径，默认为 <code class="language-text">/var/lib/docker</code>；</li>\n<li><code class="language-text">-H, --host=[]</code>：指定命令对应 Docker daemon 的监听接口，可以为 unix 套接字 <code class="language-text">unix:///path/to/socket</code>，文件句柄 <code class="language-text">fd://socketfd</code> 或 tcp 套接字 <code class="language-text">tcp://[host[:port]]</code>，默认为 <code class="language-text">unix:///var/run/docker.sock</code>；</li>\n<li><code class="language-text">--icc=true|false</code>：是否启用容器间以及跟 daemon 所在主机的通信。默认为 true。</li>\n<li><code class="language-text">--insecure-registry=[]</code>：允许访问给定的非安全仓库服务；</li>\n<li><code class="language-text">--ip=&quot;&quot;</code>：绑定容器端口时候的默认 IP 地址。缺省为 0.0.0.0；</li>\n<li><code class="language-text">--ip-forward=true|false</code>：是否检查启动在 Docker 主机上的启用 IP 转发服务，默认开启。注意关闭该选项将不对系统转发能力进行任何检查修改；</li>\n<li><code class="language-text">--ip-masq=true|false</code>：是否进行地址伪装，用于容器访问外部网络，默认开启；</li>\n<li><code class="language-text">--iptables=true|false</code>：是否允许 Docker 添加 iptables 规则。缺省为 true；</li>\n<li><code class="language-text">--ipv6=true|false</code>：是否启用 IPv6 支持，默认关闭；</li>\n<li><code class="language-text">-l, --log-level=&quot;debug|info|warn|error|fatal&quot;</code>：指定日志输出级别；</li>\n<li><code class="language-text">--label=&quot;[]&quot;</code>：添加指定的键值对标注；</li>\n<li><code class="language-text">--log-driver=&quot;json-file|syslog|journald|gelf|fluentd|awslogs|splunk|etwlogs|gcplogs|none&quot;</code>：指定日志后端驱动，默认为 <code class="language-text">json-file</code>；</li>\n<li><code class="language-text">--log-opt=[]</code>：日志后端的选项；</li>\n<li><code class="language-text">--mtu=VALUE</code>：指定容器网络的 mtu；</li>\n<li><code class="language-text">-p=&quot;&quot;</code>：指定 daemon 的 PID 文件路径。缺省为 <code class="language-text">/var/run/docker.pid</code>；</li>\n<li><code class="language-text">--raw-logs</code>：输出原始，未加色彩的日志信息；</li>\n<li><code class="language-text">--registry-mirror=&lt;scheme&gt;://&lt;host&gt;</code>：指定 docker pull 时使用的注册服务器镜像地址；</li>\n<li><code class="language-text">-s, --storage-driver=&quot;&quot;</code>：指定使用给定的存储后端；</li>\n<li><code class="language-text">--selinux-enabled=true|false</code>：是否启用 SELinux 支持。缺省值为 false。SELinux 目前尚不支持 overlay 存储驱动；</li>\n<li><code class="language-text">--storage-opt=[]</code>：驱动后端选项；</li>\n<li><code class="language-text">--tls=true|false</code>：是否对 Docker daemon 启用 TLS 安全机制，默认为否；</li>\n<li><code class="language-text">--tlscacert=/.docker/ca.pem</code>：TLS CA 签名的可信证书文件路径；</li>\n<li><code class="language-text">--tlscert=/.docker/cert.pem</code>：TLS 可信证书文件路径；</li>\n<li><code class="language-text">--tlscert=/.docker/key.pem</code>：TLS 密钥文件路径；</li>\n<li><code class="language-text">--tlsverify=true|false</code>：启用 TLS 校验，默认为否；</li>\n<li><code class="language-text">--userland-proxy=true|false</code>：是否使用用户态代理来实现容器间和出容器的回环通信，默认为 true；</li>\n<li><code class="language-text">--userns-remap=default|uid:gid|user:group|user|uid</code>：指定容器的用户命名空间，默认是创建新的 UID 和 GID 映射到容器内进程。</li>\n</ul>\n<h1 id="dockerfile-最佳实践"><a href="#dockerfile-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Dockerfile 最佳实践</h1>\n<h2 id="一般性的指南和建议"><a href="#%E4%B8%80%E8%88%AC%E6%80%A7%E7%9A%84%E6%8C%87%E5%8D%97%E5%92%8C%E5%BB%BA%E8%AE%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>一般性的指南和建议</h2>\n<h3 id="容器应该是短暂的"><a href="#%E5%AE%B9%E5%99%A8%E5%BA%94%E8%AF%A5%E6%98%AF%E7%9F%AD%E6%9A%82%E7%9A%84" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>容器应该是短暂的</h3>\n<p>通过 Dockerfile 构建的镜像所启动的容器应该尽可能短暂（生命周期短）。「短暂」意味着可以停止和销毁容器，并且创建一个新容器并部署好所需的设置和配置工作量应该是极小的。</p>\n<h3 id="使用-dockerignore-文件"><a href="#%E4%BD%BF%E7%94%A8-dockerignore-%E6%96%87%E4%BB%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用 .dockerignore 文件</h3>\n<p>使用 Dockerfile 构建镜像时最好是将 Dockerfile 放置在一个新建的空目录下。然后将构建镜像所需要的文件添加到该目录中。为了提高构建镜像的效率，你可以在目录下新建一个 .dockerignore 文件来指定要忽略的文件和目录。.dockerignore 文件的排除模式语法和 Git 的 .gitignore 文件相似。</p>\n<h3 id="使用多阶段构建-1"><a href="#%E4%BD%BF%E7%94%A8%E5%A4%9A%E9%98%B6%E6%AE%B5%E6%9E%84%E5%BB%BA-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用多阶段构建</h3>\n<p>在 Docker 17.05 以上版本中，你可以使用多阶段构建来减少所构建镜像的大小。</p>\n<h3 id="避免安装不必要的包"><a href="#%E9%81%BF%E5%85%8D%E5%AE%89%E8%A3%85%E4%B8%8D%E5%BF%85%E8%A6%81%E7%9A%84%E5%8C%85" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>避免安装不必要的包</h3>\n<p>为了降低复杂性、减少依赖、减小文件大小、节约构建时间，你应该避免安装任何不必要的包。例如，不要在数据库镜像中包含一个文本编辑器。</p>\n<h3 id="一个容器只运行一个进程"><a href="#%E4%B8%80%E4%B8%AA%E5%AE%B9%E5%99%A8%E5%8F%AA%E8%BF%90%E8%A1%8C%E4%B8%80%E4%B8%AA%E8%BF%9B%E7%A8%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>一个容器只运行一个进程</h3>\n<p>应该保证在一个容器中只运行一个进程。将多个应用解耦到不同容器中，保证了容器的横向扩展和复用。例如 web 应用应该包含三个容器：web 应用、数据库、缓存。</p>\n<p>如果容器互相依赖，你可以使用 Docker 自定义网络来把这些容器连接起来。</p>\n<h3 id="镜像层数尽可能少"><a href="#%E9%95%9C%E5%83%8F%E5%B1%82%E6%95%B0%E5%B0%BD%E5%8F%AF%E8%83%BD%E5%B0%91" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>镜像层数尽可能少</h3>\n<p>你需要在 Dockerfile 可读性（也包括长期的可维护性）和减少层数之间做一个平衡。</p>\n<h3 id="将多行参数排序"><a href="#%E5%B0%86%E5%A4%9A%E8%A1%8C%E5%8F%82%E6%95%B0%E6%8E%92%E5%BA%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>将多行参数排序</h3>\n<p>将多行参数按字母顺序排序（比如要安装多个包时）。这可以帮助你避免重复包含同一个包，更新包列表时也更容易。也便于 PRs 阅读和审查。建议在反斜杠符号 <code class="language-text">\\</code> 之前添加一个空格，以增加可读性。</p>\n<p>下面是来自 <code class="language-text">buildpack-deps</code> 镜像的例子：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="51122330707826880000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`RUN apt-get update && apt-get install -y \\\n  bzr \\\n  cvs \\\n  git \\\n  mercurial \\\n  subversion`, `51122330707826880000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">RUN</span> apt<span class="token punctuation">-</span>get update &amp;&amp; apt<span class="token punctuation">-</span>get install <span class="token punctuation">-</span>y \\\n  bzr \\\n  cvs \\\n  git \\\n  mercurial \\\n  subversion</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="构建缓存"><a href="#%E6%9E%84%E5%BB%BA%E7%BC%93%E5%AD%98" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>构建缓存</h3>\n<p>在镜像的构建过程中，Docker 会遍历 Dockerfile 文件中的指令，然后按顺序执行。在执行每条指令之前，Docker 都会在缓存中查找是否已经存在可重用的镜像，如果有就使用现存的镜像，不再重复创建。如果你不想在构建过程中使用缓存，你可以在 docker build 命令中使用 <code class="language-text">--no-cache=true</code> 选项。</p>\n<p>但是，如果你想在构建的过程中使用缓存，你得明白什么时候会，什么时候不会找到匹配的镜像，遵循的基本规则如下：</p>\n<ul>\n<li>从一个基础镜像开始（FROM 指令指定），下一条指令将和该基础镜像的所有子镜像进行匹配，检查这些子镜像被创建时使用的指令是否和被检查的指令完全一样。如果不是，则缓存失效。</li>\n<li>在大多数情况下，只需要简单地对比 Dockerfile 中的指令和子镜像。然而，有些指令需要更多的检查和解释。</li>\n<li>对于 ADD 和 COPY 指令，镜像中对应文件的内容也会被检查，每个文件都会计算出一个校验和。文件的最后修改时间和最后访问时间不会纳入校验。在缓存的查找过程中，会将这些校验和和已存在镜像中的文件校验和进行对比。如果文件有任何改变，比如内容和元数据，则缓存失效。</li>\n<li>除了 ADD 和 COPY 指令，缓存匹配过程不会查看临时容器中的文件来决定缓存是否匹配。例如，当执行完 <code class="language-text">RUN apt-get -y update</code> 指令后，容器中一些文件被更新，但 Docker 不会检查这些文件。这种情况下，只有指令字符串本身被用来匹配缓存。</li>\n</ul>\n<p>一旦缓存失效，所有后续的 Dockerfile 指令都将产生新的镜像，缓存不会被使用。</p>\n<h2 id="dockerfile-指令"><a href="#dockerfile-%E6%8C%87%E4%BB%A4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Dockerfile 指令</h2>\n<p>下面针对 Dockerfile 中各种指令的最佳编写方式给出建议。</p>\n<h3 id="from"><a href="#from" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>FROM</h3>\n<p>尽可能使用当前官方仓库作为你构建镜像的基础。推荐使用 Alpine 镜像，因为它被严格控制并保持最小尺寸（目前小于 5 MB），但它仍然是一个完整的发行版。</p>\n<h3 id="label"><a href="#label" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>LABEL</h3>\n<p>你可以给镜像添加标签来帮助组织镜像、记录许可信息、辅助自动化构建等。每个标签一行，由 LABEL 开头加上一个或多个标签对。下面的示例展示了各种不同的可能格式。<code class="language-text">#</code> 开头的行是注释内容。</p>\n<p>注意：如果你的字符串中包含空格，必须将字符串放入引号中或者对空格使用转义。如果字符串内容本身就包含引号，必须对引号使用转义。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="64623541263423160000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# Set one or more individual labels\nLABEL com.example.version=&quot;0.0.1-beta&quot;\n\nLABEL vendor=&quot;ACME Incorporated&quot;\n\nLABEL com.example.release-date=&quot;2015-02-12&quot;\n\nLABEL com.example.version.is-production=&quot;&quot;`, `64623541263423160000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token comment"># Set one or more individual labels</span>\n<span class="token keyword">LABEL</span> com.example.version=<span class="token string">"0.0.1-beta"</span>\n\n<span class="token keyword">LABEL</span> vendor=<span class="token string">"ACME Incorporated"</span>\n\n<span class="token keyword">LABEL</span> com.example.release<span class="token punctuation">-</span>date=<span class="token string">"2015-02-12"</span>\n\n<span class="token keyword">LABEL</span> com.example.version.is<span class="token punctuation">-</span>production=<span class="token string">""</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>一个镜像可以包含多个标签，但建议将多个标签放入到一个 LABEL 指令中。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="37651494075037030000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# Set multiple labels at once, using line-continuation characters to break long lines\nLABEL vendor=ACME\\ Incorporated \\\n      com.example.is-beta= \\\n      com.example.is-production=&quot;&quot; \\\n      com.example.version=&quot;0.0.1-beta&quot; \\\n      com.example.release-date=&quot;2015-02-12&quot;`, `37651494075037030000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token comment"># Set multiple labels at once, using line-continuation characters to break long lines</span>\n<span class="token keyword">LABEL</span> vendor=ACME\\ Incorporated \\\n      com.example.is<span class="token punctuation">-</span>beta= \\\n      com.example.is<span class="token punctuation">-</span>production=<span class="token string">""</span> \\\n      com.example.version=<span class="token string">"0.0.1-beta"</span> \\\n      com.example.release<span class="token punctuation">-</span>date=<span class="token string">"2015-02-12"</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>关于标签可以接受的键值对，参考 <a href="https://docs.docker.com/config/labels-custom-metadata/" target="_blank" rel="nofollow noreferrer noopener">Understanding object labels</a>。关于查询标签信息，参考 <a href="https://docs.docker.com/config/labels-custom-metadata/" target="_blank" rel="nofollow noreferrer noopener">Managing labels on objects</a>。</p>\n<h3 id="run"><a href="#run" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>RUN</h3>\n<p>为了保持 Dockerfile 文件的可读性，可理解性，以及可维护性，建议将长的或复杂的 RUN 指令用反斜杠 <code class="language-text">\\</code> 分割成多行。</p>\n<h4 id="apt-get"><a href="#apt-get" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>apt-get</h4>\n<p>RUN 指令最常见的用法是安装包用的 apt-get。因为 <code class="language-text">RUN apt-get</code> 指令会安装包，所以有几个问题需要注意。</p>\n<p>不要使用 <code class="language-text">RUN apt-get upgrade</code> 或 <code class="language-text">dist-upgrade</code>，因为许多基础镜像中的「必须」包不会在一个非特权容器中升级。如果基础镜像中的某个包过时了，你应该联系它的维护者。如果你确定某个特定的包，比如 foo，需要升级，使用 <code class="language-text">apt-get install -y foo</code> 就行，该指令会自动升级 foo 包。</p>\n<p>永远将 <code class="language-text">RUN apt-get update</code> 和 <code class="language-text">apt-get install</code> 组合成一条 RUN 声明，例如：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="23389977129136062000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`RUN apt-get update && apt-get install -y \\\n        package-bar \\\n        package-baz \\\n        package-foo`, `23389977129136062000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">RUN</span> apt<span class="token punctuation">-</span>get update &amp;&amp; apt<span class="token punctuation">-</span>get install <span class="token punctuation">-</span>y \\\n        package<span class="token punctuation">-</span>bar \\\n        package<span class="token punctuation">-</span>baz \\\n        package<span class="token punctuation">-</span>foo</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>将 <code class="language-text">apt-get update</code> 放在一条单独的 RUN 声明中会导致缓存问题以及后续的 <code class="language-text">apt-get install</code> 失败。比如，假设你有一个 Dockerfile 文件：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="85408520634396330000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`FROM ubuntu:18.04\n\nRUN apt-get update\n\nRUN apt-get install -y curl`, `85408520634396330000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">FROM</span> ubuntu<span class="token punctuation">:</span>18.04\n\n<span class="token keyword">RUN</span> apt<span class="token punctuation">-</span>get update\n\n<span class="token keyword">RUN</span> apt<span class="token punctuation">-</span>get install <span class="token punctuation">-</span>y curl</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>构建镜像后，所有的层都在 Docker 的缓存中。假设你后来又修改了其中的 <code class="language-text">apt-get install</code> 添加了一个包：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="38495373878058860000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`FROM ubuntu:18.04\n\nRUN apt-get update\n\nRUN apt-get install -y curl nginx`, `38495373878058860000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">FROM</span> ubuntu<span class="token punctuation">:</span>18.04\n\n<span class="token keyword">RUN</span> apt<span class="token punctuation">-</span>get update\n\n<span class="token keyword">RUN</span> apt<span class="token punctuation">-</span>get install <span class="token punctuation">-</span>y curl nginx</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Docker 发现修改后的 <code class="language-text">RUN apt-get update</code> 指令和之前的完全一样。所以，<code class="language-text">apt-get update</code> 不会执行，而是使用之前的缓存镜像。因为 <code class="language-text">apt-get update</code> 没有运行，后面的 <code class="language-text">apt-get install</code> 可能安装的是过时的 curl 和 nginx 版本。</p>\n<p>使用 <code class="language-text">RUN apt-get update &amp;&amp; apt-get install -y</code> 可以确保你的 Dockerfiles 每次安装的都是包的最新的版本，而且这个过程不需要进一步的编码或额外干预。这项技术叫作 <code class="language-text">cache busting</code>。你也可以显示指定一个包的版本号来达到 <code class="language-text">cache-busting</code>，这就是所谓的固定版本，例如：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="73592949201567540000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`RUN apt-get update && apt-get install -y \\\n    package-bar \\\n    package-baz \\\n    package-foo=1.3.*`, `73592949201567540000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">RUN</span> apt<span class="token punctuation">-</span>get update &amp;&amp; apt<span class="token punctuation">-</span>get install <span class="token punctuation">-</span>y \\\n    package<span class="token punctuation">-</span>bar \\\n    package<span class="token punctuation">-</span>baz \\\n    package<span class="token punctuation">-</span>foo=1.3.*</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>固定版本会迫使构建过程检索特定的版本，而不管缓存中有什么。这项技术也可以减少因所需包中未预料到的变化而导致的失败。</p>\n<p>下面是一个 RUN 指令的示例模板，展示了所有关于 apt-get 的建议。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="48449461285237790000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`RUN apt-get update && apt-get install -y \\\n    aufs-tools \\\n    automake \\\n    build-essential \\\n    curl \\\n    dpkg-sig \\\n    libcap-dev \\\n    libsqlite3-dev \\\n    mercurial \\\n    reprepro \\\n    ruby1.9.1 \\\n    ruby1.9.1-dev \\\n    s3cmd=1.1.* \\\n && rm -rf /var/lib/apt/lists/*`, `48449461285237790000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">RUN</span> apt<span class="token punctuation">-</span>get update &amp;&amp; apt<span class="token punctuation">-</span>get install <span class="token punctuation">-</span>y \\\n    aufs<span class="token punctuation">-</span>tools \\\n    automake \\\n    build<span class="token punctuation">-</span>essential \\\n    curl \\\n    dpkg<span class="token punctuation">-</span>sig \\\n    libcap<span class="token punctuation">-</span>dev \\\n    libsqlite3<span class="token punctuation">-</span>dev \\\n    mercurial \\\n    reprepro \\\n    ruby1.9.1 \\\n    ruby1.9.1<span class="token punctuation">-</span>dev \\\n    s3cmd=1.1.* \\\n &amp;&amp; rm <span class="token punctuation">-</span>rf /var/lib/apt/lists/*</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>其中 s3cmd 指令指定了一个版本号 <code class="language-text">1.1.*</code>。如果之前的镜像使用的是更旧的版本，指定新的版本会导致 <code class="language-text">apt-get udpate</code> 缓存失效并确保安装的是新版本。</p>\n<p>另外，清理掉 apt 缓存 <code class="language-text">var/lib/apt/lists</code> 可以减小镜像大小。因为 RUN 指令的开头为 <code class="language-text">apt-get udpate</code>，包缓存总是会在 <code class="language-text">apt-get install</code> 之前刷新。</p>\n<blockquote>\n<p>注意：官方的 Debian 和 Ubuntu 镜像会自动运行 <code class="language-text">apt-get clean</code>，所以不需要显式的调用 <code class="language-text">apt-get clean</code>。</p>\n</blockquote>\n<h3 id="cmd"><a href="#cmd" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>CMD</h3>\n<p>CMD 指令用于执行目标镜像中包含的软件，可以包含参数。CMD 大多数情况下都应该以 <code class="language-text">CMD [&quot;executable&quot;, &quot;param1&quot;, &quot;param2&quot;...]</code> 的形式使用。因此，如果创建镜像的目的是为了部署某个服务(比如 Apache)，你可能会执行类似于 <code class="language-text">CMD [&quot;apache2&quot;, &quot;-DFOREGROUND&quot;]</code> 形式的命令。我们建议任何服务镜像都使用这种形式的命令。</p>\n<p>多数情况下，CMD 都需要一个交互式的 shell (bash, Python, perl 等)，例如 <code class="language-text">CMD [&quot;perl&quot;, &quot;-de0&quot;]</code>，或者 <code class="language-text">CMD [&quot;PHP&quot;, &quot;-a&quot;]</code>。使用这种形式意味着，当你执行类似 <code class="language-text">docker run -it python</code> 时，你会进入一个准备好的 shell 中。CMD 应该在极少的情况下才能以 <code class="language-text">CMD [&quot;param&quot;, &quot;param&quot;]</code> 的形式与 ENTRYPOINT 协同使用，除非你和你的镜像使用者都对 ENTRYPOINT 的工作方式十分熟悉。</p>\n<h3 id="expose"><a href="#expose" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>EXPOSE</h3>\n<p>EXPOSE 指令用于指定容器将要监听的端口。因此，你应该为你的应用程序使用常见的端口。例如，提供 <code class="language-text">Apache web</code> 服务的镜像应该使用 <code class="language-text">EXPOSE 80</code>，而提供 MongoDB 服务的镜像使用 <code class="language-text">EXPOSE 27017</code>。</p>\n<p>对于外部访问，用户可以在执行 <code class="language-text">docker run</code> 时使用一个标志来指示如何将指定的端口映射到所选择的端口。</p>\n<h3 id="env"><a href="#env" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ENV</h3>\n<p>为了方便新程序运行，你可以使用 ENV 来为容器中安装的程序更新 PATH 环境变量。例如使用 <code class="language-text">ENV PATH /usr/local/nginx/bin:$PATH</code> 来确保 <code class="language-text">CMD [&quot;nginx&quot;]</code> 能正确运行。</p>\n<p>ENV 指令也可用于为你想要容器化的服务提供必要的环境变量，比如 Postgres 需要的 PGDATA。</p>\n<p>最后，ENV 也能用于设置常见的版本号，比如下面的示例：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="86015092015299580000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`ENV PG_MAJOR 9.3\n\nENV PG_VERSION 9.3.4\n\nRUN curl -SL http://example.com/postgres-\\$PG_VERSION.tar.xz | tar -xJC /usr/src/postgress && …\n\nENV PATH /usr/local/postgres-\\$PG_MAJOR/bin:\\$PATH`, `86015092015299580000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">ENV</span> PG_MAJOR 9.3\n\n<span class="token keyword">ENV</span> PG_VERSION 9.3.4\n\n<span class="token keyword">RUN</span> curl <span class="token punctuation">-</span>SL http<span class="token punctuation">:</span>//example.com/postgres<span class="token punctuation">-</span>$PG_VERSION.tar.xz <span class="token punctuation">|</span> tar <span class="token punctuation">-</span>xJC /usr/src/postgress &amp;&amp; …\n\n<span class="token keyword">ENV</span> PATH /usr/local/postgres<span class="token punctuation">-</span>$PG_MAJOR/bin<span class="token punctuation">:</span>$PATH</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>类似于程序中的常量，这种方法可以让你只需改变 ENV 指令来自动的改变容器中的软件版本。</p>\n<h3 id="add-和-copy"><a href="#add-%E5%92%8C-copy" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ADD 和 COPY</h3>\n<p>虽然 ADD 和 COPY 功能类似，但一般优先使用 COPY。因为它比 ADD 更透明。COPY 只支持简单将本地文件拷贝到容器中，而 ADD 有一些并不明显的功能（比如本地 tar 提取和远程 URL 支持）。因此，ADD 的最佳用例是将本地 tar 文件自动提取到镜像中，例如 <code class="language-text">ADD rootfs.tar.xz</code>。</p>\n<p>如果你的 Dockerfile 有多个步骤需要使用上下文中不同的文件。单独 COPY 每个文件，而不是一次性的 COPY 所有文件，这将保证每个步骤的构建缓存只在特定的文件变化时失效。例如：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="66009327011863175000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`COPY requirements.txt /tmp/\n\nRUN pip install --requirement /tmp/requirements.txt\n\nCOPY . /tmp/`, `66009327011863175000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">COPY</span> requirements.txt /tmp/\n\n<span class="token keyword">RUN</span> pip install <span class="token punctuation">-</span><span class="token punctuation">-</span>requirement /tmp/requirements.txt\n\n<span class="token keyword">COPY</span> . /tmp/</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果将 <code class="language-text">COPY . /tmp/</code> 放置在 RUN 指令之前，只要 <code class="language-text">.</code> 目录中任何一个文件变化，都会导致后续指令的缓存失效。</p>\n<p>为了让镜像尽量小，最好不要使用 ADD 指令从远程 URL 获取包，而是使用 curl 和 wget。这样你可以在文件提取完之后删掉不再需要的文件来避免在镜像中额外添加一层。比如尽量避免下面的用法：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="15197925456614382000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`ADD http://example.com/big.tar.xz /usr/src/things/\n\nRUN tar -xJf /usr/src/things/big.tar.xz -C /usr/src/things\n\nRUN make -C /usr/src/things all`, `15197925456614382000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">ADD</span> http<span class="token punctuation">:</span>//example.com/big.tar.xz /usr/src/things/\n\n<span class="token keyword">RUN</span> tar <span class="token punctuation">-</span>xJf /usr/src/things/big.tar.xz <span class="token punctuation">-</span>C /usr/src/things\n\n<span class="token keyword">RUN</span> make <span class="token punctuation">-</span>C /usr/src/things all</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>而是应该使用下面这种方法：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="19724723351378272000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`RUN mkdir -p /usr/src/things \\\n    && curl -SL http://example.com/big.tar.xz \\\n    | tar -xJC /usr/src/things \\\n    && make -C /usr/src/things all`, `19724723351378272000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">RUN</span> mkdir <span class="token punctuation">-</span>p /usr/src/things \\\n    &amp;&amp; curl <span class="token punctuation">-</span>SL http<span class="token punctuation">:</span>//example.com/big.tar.xz \\\n    <span class="token punctuation">|</span> tar <span class="token punctuation">-</span>xJC /usr/src/things \\\n    &amp;&amp; make <span class="token punctuation">-</span>C /usr/src/things all</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>上面使用的管道操作，所以没有中间文件需要删除。</p>\n<p>对于其他不需要 ADD 的自动提取功能的文件或目录，你应该使用 COPY。</p>\n<h3 id="entrypoint"><a href="#entrypoint" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ENTRYPOINT</h3>\n<p>ENTRYPOINT 的最佳用处是设置镜像的主命令，允许将镜像当成命令本身来运行（用 CMD 提供默认选项）。</p>\n<p>例如，下面的示例镜像提供了命令行工具 s3cmd:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="89392946798285200000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`ENTRYPOINT [&quot;s3cmd&quot;]\n\nCMD [&quot;--help&quot;]`, `89392946798285200000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">ENTRYPOINT</span> <span class="token punctuation">[</span><span class="token string">"s3cmd"</span><span class="token punctuation">]</span>\n\n<span class="token keyword">CMD</span> <span class="token punctuation">[</span><span class="token string">"--help"</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>现在直接运行该镜像创建的容器会显示命令帮助：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="1524397180276282400"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run s3cmd`, `1524397180276282400`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run s3cmd</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>或者提供正确的参数来执行某个命令：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="92518701753202560000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run s3cmd ls s3://mybucket`, `92518701753202560000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run s3cmd <span class="token function">ls</span> s3://mybucket</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>这样镜像名可以当成命令行的参考。</p>\n<p>ENTRYPOINT 指令也可以结合一个辅助脚本使用，和前面命令行风格类似，即使启动工具需要不止一个步骤。</p>\n<p>例如，Postgres 官方镜像使用下面的脚本作为 ENTRYPOINT：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="77001653938966680000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`#!/bin/bash\nset -e\n\nif [ &quot;\\$1&quot; = \'postgres\' ]; then\n    chown -R postgres &quot;\\$PGDATA&quot;\n\n    if [ -z &quot;\\$(ls -A &quot;\\$PGDATA&quot;)&quot; ]; then\n        gosu postgres initdb\n    fi\n\n    exec gosu postgres &quot;\\$@&quot;\nfi\n\nexec &quot;\\$@&quot;`, `77001653938966680000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span>\n<span class="token builtin class-name">set</span> -e\n\n<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">"<span class="token variable">$1</span>"</span> <span class="token operator">=</span> <span class="token string">\'postgres\'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>\n    <span class="token function">chown</span> -R postgres <span class="token string">"<span class="token variable">$PGDATA</span>"</span>\n\n    <span class="token keyword">if</span> <span class="token punctuation">[</span> -z <span class="token string">"<span class="token variable"><span class="token variable">$(</span><span class="token function">ls</span> -A <span class="token string">"<span class="token variable">$PGDATA</span>"</span><span class="token variable">)</span></span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>\n        gosu postgres initdb\n    <span class="token keyword">fi</span>\n\n    <span class="token builtin class-name">exec</span> gosu postgres <span class="token string">"<span class="token variable">$@</span>"</span>\n<span class="token keyword">fi</span>\n\n<span class="token builtin class-name">exec</span> <span class="token string">"<span class="token variable">$@</span>"</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<blockquote>\n<p>注意：该脚本使用了 Bash 的内置命令 exec，所以最后运行的进程就是容器的 PID 为 1 的进程。这样，进程就可以接收到任何发送给容器的 Unix 信号了。</p>\n</blockquote>\n<p>该辅助脚本被拷贝到容器，并在容器启动时通过 ENTRYPOINT 执行：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="79961916659263950000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`COPY ./docker-entrypoint.sh /\n\nENTRYPOINT [&quot;/docker-entrypoint.sh&quot;]`, `79961916659263950000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">COPY</span> ./docker<span class="token punctuation">-</span>entrypoint.sh /\n\n<span class="token keyword">ENTRYPOINT</span> <span class="token punctuation">[</span><span class="token string">"/docker-entrypoint.sh"</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>该脚本可以让用户用几种不同的方式和 Postgres 交互。</p>\n<p>你可以很简单地启动 Postgres：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="42810943242484490000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run postgres`, `42810943242484490000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run postgres</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>也可以执行 Postgres 并传递参数：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="92330435635670880000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run postgres postgres --help`, `92330435635670880000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run postgres postgres --help</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>最后，你还可以启动另外一个完全不同的工具，比如 Bash：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="30825565047537996000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run --rm -it postgres bash`, `30825565047537996000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run --rm -it postgres <span class="token function">bash</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h3 id="volume"><a href="#volume" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>VOLUME</h3>\n<p>VOLUME 指令用于暴露任何数据库存储文件，配置文件，或容器创建的文件和目录。强烈建议使用 VOLUME 来管理镜像中的可变部分和用户可以改变的部分。</p>\n<h3 id="user"><a href="#user" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>USER</h3>\n<p>如果某个服务不需要特权执行，建议使用 USER 指令切换到非 root 用户。先在 Dockerfile 中使用类似 <code class="language-text">RUN groupadd -r postgres &amp;&amp; useradd -r -g postgres postgres</code> 的指令创建用户和用户组。</p>\n<blockquote>\n<p>注意：在镜像中，用户和用户组每次被分配的 <code class="language-text">UID/GID</code> 都是不确定的，下次重新构建镜像时被分配到的 <code class="language-text">UID/GID</code> 可能会不一样。如果要依赖确定的 <code class="language-text">UID/GID</code>，你应该显式的指定一个 <code class="language-text">UID/GID</code>。</p>\n</blockquote>\n<p>你应该避免使用 sudo，因为它不可预期的 TTY 和信号转发行为可能造成的问题比它能解决的问题还多。如果你真的需要和 sudo 类似的功能（例如，以 root 权限初始化某个守护进程，以非 root 权限执行它），你可以使用 <a href="https://github.com/tianon/gosu" target="_blank" rel="nofollow noreferrer noopener">gosu</a>。</p>\n<p>最后，为了减少层数和复杂度，避免频繁地使用 USER 来回切换用户。</p>\n<h3 id="workdir"><a href="#workdir" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>WORKDIR</h3>\n<p>为了清晰性和可靠性，你应该总是在 WORKDIR 中使用绝对路径。另外，你应该使用 WORKDIR 来替代类似于 <code class="language-text">RUN cd ... &amp;&amp; do-something</code> 的指令，后者难以阅读、排错和维护。</p>\n<h2 id="官方镜像示例"><a href="#%E5%AE%98%E6%96%B9%E9%95%9C%E5%83%8F%E7%A4%BA%E4%BE%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>官方镜像示例</h2>\n<p>这些官方镜像的 Dockerfile 都是参考典范：<a href="https://github.com/docker-library/docs" target="_blank" rel="nofollow noreferrer noopener">https://github.com/docker-library/docs</a></p>\n<h1 id="如何调试-docker"><a href="#%E5%A6%82%E4%BD%95%E8%B0%83%E8%AF%95-docker" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>如何调试 Docker</h1>\n<h2 id="开启-debug-模式"><a href="#%E5%BC%80%E5%90%AF-debug-%E6%A8%A1%E5%BC%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>开启 Debug 模式</h2>\n<p>在 dockerd 配置文件 <code class="language-text">daemon.json</code>（默认位于 <code class="language-text">/etc/docker/</code>）中添加</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="84551233278548150000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`{\n  &quot;debug&quot;: true\n}`, `84551233278548150000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="json"\n              >\n                <span class="gatsby-code-button-language">json</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="json"><pre style="counter-reset: linenumber NaN" class="language-json line-numbers"><code class="language-json"><span class="token punctuation">{</span>\n  <span class="token property">"debug"</span><span class="token operator">:</span> <span class="token boolean">true</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>重启守护进程。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="60694825383737940000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ sudo kill -SIGHUP \\$(pidof dockerd)`, `60694825383737940000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ <span class="token function">sudo</span> <span class="token function">kill</span> -SIGHUP <span class="token variable"><span class="token variable">$(</span>pidof dockerd<span class="token variable">)</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>此时 dockerd 会在日志中输入更多信息供分析。</p>\n<h2 id="检查内核日志"><a href="#%E6%A3%80%E6%9F%A5%E5%86%85%E6%A0%B8%E6%97%A5%E5%BF%97" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>检查内核日志</h2>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="75468123472296670000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ sudo dmesg | grep dockerd\n\\$ sudo dmesg | grep runc`, `75468123472296670000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ <span class="token function">sudo</span> <span class="token function">dmesg</span> <span class="token operator">|</span> <span class="token function">grep</span> dockerd\n$ <span class="token function">sudo</span> <span class="token function">dmesg</span> <span class="token operator">|</span> <span class="token function">grep</span> runc</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<h2 id="docker-不响应时处理"><a href="#docker-%E4%B8%8D%E5%93%8D%E5%BA%94%E6%97%B6%E5%A4%84%E7%90%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Docker 不响应时处理</h2>\n<p>可以杀死 dockerd 进程查看其堆栈调用情况。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="10975837992533100000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ sudo kill -SIGUSR1 \\$(pidof dockerd)`, `10975837992533100000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ <span class="token function">sudo</span> <span class="token function">kill</span> -SIGUSR1 <span class="token variable"><span class="token variable">$(</span>pidof dockerd<span class="token variable">)</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h2 id="重置-docker-本地数据"><a href="#%E9%87%8D%E7%BD%AE-docker-%E6%9C%AC%E5%9C%B0%E6%95%B0%E6%8D%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>重置 Docker 本地数据</h2>\n<p>注意，本操作会移除所有的 Docker 本地数据，包括镜像和容器等。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="3122723700560348000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ sudo rm -rf /var/lib/docker`, `3122723700560348000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ <span class="token function">sudo</span> <span class="token function">rm</span> -rf /var/lib/docker</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h1 id="compose"><a href="#compose" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Compose</h1>\n<p>Compose 项目是 Docker 官方的开源项目，负责实现对 Docker 容器集群的快速编排。从功能上看，跟 OpenStack 中的 Heat 十分类似。</p>\n<p>其代码目前在 <a href="https://github.com/docker/compose" target="_blank" rel="nofollow noreferrer noopener">https://github.com/docker/compose</a> 上开源。</p>\n<p>Compose 定位是「定义和运行多个 Docker 容器的应用（Defining and running multi-container Docker applications）」，其前身是开源项目 Fig。</p>\n<p>通过第一部分中的介绍，我们知道使用一个 Dockerfile 模板文件，可以让用户很方便的定义一个单独的应用容器。然而，在日常工作中，经常会碰到需要多个容器相互配合来完成某项任务的情况。例如要实现一个 Web 项目，除了 Web 服务容器本身，往往还需要再加上后端的数据库服务容器，甚至还包括负载均衡容器等。</p>\n<p>Compose 恰好满足了这样的需求。它允许用户通过一个单独的 <code class="language-text">docker-compose.yml</code> 模板文件（YAML 格式）来定义一组相关联的应用容器为一个项目（project）。</p>\n<p>Compose 中有两个重要的概念：</p>\n<ul>\n<li>服务 (service)：一个应用的容器，实际上可以包括若干运行相同镜像的容器实例。</li>\n<li>项目 (project)：由一组关联的应用容器组成的一个完整业务单元，在 <code class="language-text">docker-compose.yml</code> 文件中定义。</li>\n</ul>\n<p>Compose 的默认管理对象是项目，通过子命令对项目中的一组容器进行便捷地生命周期管理。</p>\n<p>Compose 项目由 Python 编写，实现上调用了 Docker 服务提供的 API 来对容器进行管理。因此，只要所操作的平台支持 Docker API，就可以在其上利用 Compose 来进行编排管理。</p>\n<h2 id="使用-2"><a href="#%E4%BD%BF%E7%94%A8-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用</h2>\n<h3 id="术语"><a href="#%E6%9C%AF%E8%AF%AD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>术语</h3>\n<p>首先介绍几个术语。</p>\n<ul>\n<li>服务(service)：一个应用容器，实际上可以运行多个相同镜像的实例。</li>\n<li>项目(project)：由一组关联的应用容器组成的一个完整业务单元。</li>\n</ul>\n<p>可见，一个项目可以由多个服务（容器）关联而成，Compose 面向项目进行管理。</p>\n<h3 id="场景"><a href="#%E5%9C%BA%E6%99%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>场景</h3>\n<p>最常见的项目是 web 网站，该项目应该包含 web 应用和缓存。</p>\n<p>下面我们用 Python 来建立一个能够记录页面访问次数的 web 网站。</p>\n<h4 id="web-应用"><a href="#web-%E5%BA%94%E7%94%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>web 应用</h4>\n<p>新建文件夹，在该目录中编写 app.py 文件</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="34500377324262478000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from flask import Flask\nfrom redis import Redis\n\napp = Flask(__name__)\nredis = Redis(host=\'redis\', port=6379)\n\n@app.route(\'/\')\ndef hello():\n    count = redis.incr(\'hits\')\n    return \'Hello World! 该页面已被访问 {} 次。\\n\'.format(count)\n\nif __name__ == &quot;__main__&quot;:\n    app.run(host=&quot;0.0.0.0&quot;, debug=True)`, `34500377324262478000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask\n<span class="token keyword">from</span> redis <span class="token keyword">import</span> Redis\n\napp <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>\nredis <span class="token operator">=</span> Redis<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">\'redis\'</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">6379</span><span class="token punctuation">)</span>\n\n@app<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">\'/\'</span><span class="token punctuation">)</span>\n<span class="token keyword">def</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    count <span class="token operator">=</span> redis<span class="token punctuation">.</span>incr<span class="token punctuation">(</span><span class="token string">\'hits\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">return</span> <span class="token string">\'Hello World! 该页面已被访问 {} 次。\\n\'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span>\n\n<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>\n    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">"0.0.0.0"</span><span class="token punctuation">,</span> debug<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="dockerfile-1"><a href="#dockerfile-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Dockerfile</h4>\n<p>编写 Dockerfile 文件，内容为</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="11933507979561542000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`FROM python:3.6-alpine\nADD . /code\nWORKDIR /code\nRUN pip install redis flask\nCMD [&quot;python&quot;, &quot;app.py&quot;]`, `11933507979561542000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">FROM</span> python<span class="token punctuation">:</span>3.6<span class="token punctuation">-</span>alpine\n<span class="token keyword">ADD</span> . /code\n<span class="token keyword">WORKDIR</span> /code\n<span class="token keyword">RUN</span> pip install redis flask\n<span class="token keyword">CMD</span> <span class="token punctuation">[</span><span class="token string">"python"</span><span class="token punctuation">,</span> <span class="token string">"app.py"</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="docker-composeyml"><a href="#docker-composeyml" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>docker-compose.yml</h4>\n<p>编写 <code class="language-text">docker-compose.yml</code> 文件，这个是 Compose 使用的主模板文件。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="20909205857033330000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`version: \'3\'\nservices:\n  web:\n    build: .\n    ports:\n      - \'5000:5000\'\n\n  redis:\n    image: \'redis:alpine\'`, `20909205857033330000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">\'3\'</span>\n<span class="token key atrule">services</span><span class="token punctuation">:</span>\n  <span class="token key atrule">web</span><span class="token punctuation">:</span>\n    <span class="token key atrule">build</span><span class="token punctuation">:</span> .\n    <span class="token key atrule">ports</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> <span class="token string">\'5000:5000\'</span>\n\n  <span class="token key atrule">redis</span><span class="token punctuation">:</span>\n    <span class="token key atrule">image</span><span class="token punctuation">:</span> <span class="token string">\'redis:alpine\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="运行-compose-项目"><a href="#%E8%BF%90%E8%A1%8C-compose-%E9%A1%B9%E7%9B%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>运行 compose 项目</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="76694913729652800000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker compose up`, `76694913729652800000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker compose up</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>此时访问本地 5000 端口，每次刷新页面，计数就会加 1。</p>\n<h2 id="compose-命令说明"><a href="#compose-%E5%91%BD%E4%BB%A4%E8%AF%B4%E6%98%8E" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Compose 命令说明</h2>\n<h3 id="命令对象与格式"><a href="#%E5%91%BD%E4%BB%A4%E5%AF%B9%E8%B1%A1%E4%B8%8E%E6%A0%BC%E5%BC%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>命令对象与格式</h3>\n<p>对于 Compose 来说，大部分命令的对象既可以是项目本身，也可以指定为项目中的服务或者容器。如果没有特别的说明，命令对象将是项目，这意味着项目中所有的服务都会受到命令影响。</p>\n<p>执行 <code class="language-text">docker compose [COMMAND] --help</code> 可以查看具体某个命令的使用格式。</p>\n<p>docker compose 命令的基本的使用格式是</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="53372586696262550000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`docker compose [-f=<arg>...] [options] [COMMAND] [ARGS...]`, `53372586696262550000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">docker compose <span class="token punctuation">[</span>-f<span class="token operator">=</span><span class="token operator">&lt;</span>arg<span class="token operator">></span><span class="token punctuation">..</span>.<span class="token punctuation">]</span> <span class="token punctuation">[</span>options<span class="token punctuation">]</span> <span class="token punctuation">[</span>COMMAND<span class="token punctuation">]</span> <span class="token punctuation">[</span>ARGS<span class="token punctuation">..</span>.<span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h3 id="命令选项"><a href="#%E5%91%BD%E4%BB%A4%E9%80%89%E9%A1%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>命令选项</h3>\n<ul>\n<li><code class="language-text">-f, --file FILE</code> 指定使用的 Compose 模板文件，默认为 <code class="language-text">docker-compose.yml</code>，可以多次指定。</li>\n<li><code class="language-text">-p, --project-name NAME</code> 指定项目名称，默认将使用所在目录名称作为项目名。</li>\n<li><code class="language-text">--verbose</code> 输出更多调试信息。</li>\n<li><code class="language-text">-v, --version</code> 打印版本并退出。</li>\n</ul>\n<h3 id="命令使用说明"><a href="#%E5%91%BD%E4%BB%A4%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>命令使用说明</h3>\n<h4 id="build"><a href="#build" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>build</h4>\n<p>格式为 <code class="language-text">docker compose build [options] [SERVICE...]</code>。</p>\n<p>构建（重新构建）项目中的服务容器。</p>\n<p>服务容器一旦构建后，将会带上一个标记名，例如对于 web 项目中的一个 db 容器，可能是 <code class="language-text">web_db</code>。</p>\n<p>可以随时在项目目录下运行 <code class="language-text">docker compose build</code> 来重新构建服务。</p>\n<p>选项包括：</p>\n<ul>\n<li><code class="language-text">--force-rm</code> 删除构建过程中的临时容器。</li>\n<li><code class="language-text">--no-cache</code> 构建镜像过程中不使用 cache（这将加长构建过程）。</li>\n<li><code class="language-text">--pull</code> 始终尝试通过 pull 来获取更新版本的镜像。</li>\n</ul>\n<h4 id="config"><a href="#config" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>config</h4>\n<p>验证 Compose 文件格式是否正确，若正确则显示配置，若格式错误显示错误原因。</p>\n<h4 id="down"><a href="#down" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>down</h4>\n<p>此命令将会停止 up 命令所启动的容器，并移除网络</p>\n<h4 id="exec"><a href="#exec" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>exec</h4>\n<p>进入指定的容器。</p>\n<h4 id="help"><a href="#help" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>help</h4>\n<p>获得一个命令的帮助。</p>\n<h4 id="images"><a href="#images" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>images</h4>\n<p>列出 Compose 文件中包含的镜像。</p>\n<h4 id="kill"><a href="#kill" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>kill</h4>\n<p>格式为 <code class="language-text">docker compose kill [options] [SERVICE...]</code>。</p>\n<p>通过发送 SIGKILL 信号来强制停止服务容器。</p>\n<p>支持通过 <code class="language-text">-s</code> 参数来指定发送的信号，例如通过如下指令发送 SIGINT 信号。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="63152421997911580000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker compose kill -s SIGINT`, `63152421997911580000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker compose <span class="token function">kill</span> -s SIGINT</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h4 id="logs"><a href="#logs" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>logs</h4>\n<p>格式为 <code class="language-text">docker compose logs [options] [SERVICE...]</code>。</p>\n<p>查看服务容器的输出。默认情况下，<code class="language-text">docker compose</code> 将对不同的服务输出使用不同的颜色来区分。可以通过 <code class="language-text">--no-color</code> 来关闭颜色。</p>\n<p>该命令在调试问题的时候十分有用。</p>\n<h4 id="pause"><a href="#pause" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>pause</h4>\n<p>格式为 <code class="language-text">docker compose pause [SERVICE...]</code>。</p>\n<p>暂停一个服务容器。</p>\n<h4 id="port"><a href="#port" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>port</h4>\n<p>格式为 <code class="language-text">docker compose port [options] SERVICE PRIVATE_PORT</code>。</p>\n<p>打印某个容器端口所映射的公共端口。</p>\n<p>选项：</p>\n<ul>\n<li><code class="language-text">--protocol=proto</code> 指定端口协议，tcp（默认值）或者 udp。</li>\n<li><code class="language-text">--index=index</code> 如果同一服务存在多个容器，指定命令对象容器的序号（默认为 1）。</li>\n</ul>\n<h4 id="ps"><a href="#ps" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ps</h4>\n<p>格式为 <code class="language-text">docker compose ps [options] [SERVICE...]</code>。</p>\n<p>列出项目中目前的所有容器。</p>\n<p>选项：</p>\n<ul>\n<li><code class="language-text">-q</code> 只打印容器的 ID 信息。</li>\n</ul>\n<h4 id="pull"><a href="#pull" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>pull</h4>\n<p>格式为 <code class="language-text">docker compose pull [options] [SERVICE...]</code>。</p>\n<p>拉取服务依赖的镜像。</p>\n<p>选项：</p>\n<ul>\n<li><code class="language-text">--ignore-pull-failures</code> 忽略拉取镜像过程中的错误。</li>\n</ul>\n<h4 id="push"><a href="#push" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>push</h4>\n<p>推送服务依赖的镜像到 Docker 镜像仓库。</p>\n<h4 id="restart"><a href="#restart" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>restart</h4>\n<p>格式为 <code class="language-text">docker compose restart [options] [SERVICE...]</code>。</p>\n<p>重启项目中的服务。</p>\n<p>选项：</p>\n<ul>\n<li><code class="language-text">-t, --timeout TIMEOUT</code> 指定重启前停止容器的超时（默认为 10 秒）。</li>\n</ul>\n<h4 id="rm"><a href="#rm" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>rm</h4>\n<p>格式为 <code class="language-text">docker compose rm [options] [SERVICE...]</code>。</p>\n<p>删除所有（停止状态的）服务容器。推荐先执行 <code class="language-text">docker compose stop</code> 命令来停止容器。</p>\n<p>选项：</p>\n<ul>\n<li><code class="language-text">-f, --force</code> 强制直接删除，包括非停止状态的容器。一般尽量不要使用该选项。</li>\n<li><code class="language-text">-v</code> 删除容器所挂载的数据卷。</li>\n</ul>\n<h4 id="run-1"><a href="#run-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>run</h4>\n<p>格式为 <code class="language-text">docker compose run [options] [-p PORT...] [-e KEY=VAL...] SERVICE [COMMAND] [ARGS...]</code>。</p>\n<p>在指定服务上执行一个命令。</p>\n<p>例如：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="96337138221118730000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker compose run ubuntu ping docker.com`, `96337138221118730000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker compose run ubuntu <span class="token function">ping</span> docker.com</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>将会启动一个 ubuntu 服务容器，并执行 <code class="language-text">ping docker.com</code> 命令。</p>\n<p>默认情况下，如果存在关联，则所有关联的服务将会自动被启动，除非这些服务已经在运行中。</p>\n<p>该命令类似启动容器后运行指定的命令，相关卷、链接等等都将会按照配置自动创建。</p>\n<p>两个不同点：</p>\n<ol>\n<li>给定命令将会覆盖原有的自动运行命令；</li>\n<li>不会自动创建端口，以避免冲突。</li>\n</ol>\n<p>如果不希望自动启动关联的容器，可以使用 <code class="language-text">--no-deps</code> 选项，例如</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="8050815418758961000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker compose run --no-deps web python manage.py shell`, `8050815418758961000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker compose run --no-deps web python manage.py shell</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>将不会启动 web 容器所关联的其它容器。</p>\n<p>选项：</p>\n<ul>\n<li><code class="language-text">-d</code> 后台运行容器。</li>\n<li><code class="language-text">--name NAME</code> 为容器指定一个名字。</li>\n<li><code class="language-text">--entrypoint CMD</code> 覆盖默认的容器启动指令。</li>\n<li><code class="language-text">-e KEY=VAL</code> 设置环境变量值，可多次使用选项来设置多个环境变量。</li>\n<li><code class="language-text">-u, --user=&quot;&quot;</code> 指定运行容器的用户名或者 uid。</li>\n<li><code class="language-text">--no-deps</code> 不自动启动关联的服务容器。</li>\n<li><code class="language-text">--rm</code> 运行命令后自动删除容器，<code class="language-text">d</code> 模式下将忽略。</li>\n<li><code class="language-text">-p, --publish=[]</code> 映射容器端口到本地主机。</li>\n<li><code class="language-text">--service-ports</code> 配置服务端口并映射到本地主机。</li>\n<li><code class="language-text">-T</code> 不分配伪 tty，意味着依赖 tty 的指令将无法运行。</li>\n</ul>\n<h4 id="start"><a href="#start" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>start</h4>\n<p>格式为 <code class="language-text">docker compose start [SERVICE...]</code>。</p>\n<p>启动已经存在的服务容器。</p>\n<h4 id="stop"><a href="#stop" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>stop</h4>\n<p>格式为 <code class="language-text">docker compose stop [options] [SERVICE...]</code>。</p>\n<p>停止已经处于运行状态的容器，但不删除它。通过 <code class="language-text">docker compose start</code> 可以再次启动这些容器。</p>\n<p>选项：</p>\n<ul>\n<li><code class="language-text">-t, --timeout TIMEOUT</code> 停止容器时候的超时（默认为 10 秒）。</li>\n</ul>\n<h4 id="top"><a href="#top" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>top</h4>\n<p>查看各个服务容器内运行的进程。</p>\n<h4 id="unpause"><a href="#unpause" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>unpause</h4>\n<p>格式为 <code class="language-text">docker compose unpause [SERVICE...]</code>。</p>\n<p>恢复处于暂停状态中的服务。</p>\n<h4 id="up"><a href="#up" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>up</h4>\n<p>格式为 <code class="language-text">docker compose up [options] [SERVICE...]</code>。</p>\n<p>该命令十分强大，它将尝试自动完成包括构建镜像，（重新）创建服务，启动服务，并关联服务相关容器的一系列操作。</p>\n<p>链接的服务都将会被自动启动，除非已经处于运行状态。</p>\n<p>可以说，大部分时候都可以直接通过该命令来启动一个项目。</p>\n<p>默认情况，<code class="language-text">docker compose up</code> 启动的容器都在前台，控制台将会同时打印所有容器的输出信息，可以很方便进行调试。</p>\n<p>当通过 <code class="language-text">Ctrl-C</code> 停止命令时，所有容器将会停止。</p>\n<p>如果使用 <code class="language-text">docker compose up -d</code>，将会在后台启动并运行所有的容器。一般推荐生产环境下使用该选项。</p>\n<p>默认情况，如果服务容器已经存在，<code class="language-text">docker compose up</code> 将会尝试停止容器，然后重新创建（保持使用 <code class="language-text">volumes-from</code> 挂载的卷），以保证新启动的服务匹配 <code class="language-text">docker-compose.yml</code> 文件的最新内容。如果用户不希望容器被停止并重新创建，可以使用 <code class="language-text">docker compose up --no-recreate</code>。这样将只会启动处于停止状态的容器，而忽略已经运行的服务。如果用户只想重新部署某个服务，可以使用 <code class="language-text">docker compose up --no-deps -d &lt;SERVICE_NAME&gt;</code> 来重新创建服务并后台停止旧服务，启动新服务，并不会影响到其所依赖的服务。</p>\n<p>选项：</p>\n<ul>\n<li><code class="language-text">-d</code> 在后台运行服务容器。</li>\n<li><code class="language-text">--no-color</code> 不使用颜色来区分不同的服务的控制台输出。</li>\n<li><code class="language-text">--no-deps</code> 不启动服务所链接的容器。</li>\n<li><code class="language-text">--force-recreate</code> 强制重新创建容器，不能与 <code class="language-text">--no-recreate</code> 同时使用。</li>\n<li><code class="language-text">--no-recreate</code> 如果容器已经存在了，则不重新创建，不能与 <code class="language-text">--force-recreate</code> 同时使用。</li>\n<li><code class="language-text">--no-build</code> 不自动构建缺失的服务镜像。</li>\n<li><code class="language-text">-t, --timeout TIMEOUT</code> 停止容器时候的超时（默认为 10 秒）。</li>\n</ul>\n<h4 id="version"><a href="#version" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>version</h4>\n<p>格式为 <code class="language-text">docker compose version</code>。</p>\n<p>打印版本信息。</p>\n<h2 id="compose-模板文件"><a href="#compose-%E6%A8%A1%E6%9D%BF%E6%96%87%E4%BB%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Compose 模板文件</h2>\n<p>模板文件是使用 Compose 的核心，涉及到的指令关键字也比较多。但大家不用担心，这里面大部分指令跟 docker run 相关参数的含义都是类似的。</p>\n<p>默认的模板文件名称为 <code class="language-text">docker-compose.yml</code>，格式为 YAML 格式。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="69503645879249980000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`version: \'3\'\n\nservices:\n  webapp:\n    image: examples/web\n    ports:\n      - \'80:80\'\n    volumes:\n      - \'/data\'`, `69503645879249980000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">\'3\'</span>\n\n<span class="token key atrule">services</span><span class="token punctuation">:</span>\n  <span class="token key atrule">webapp</span><span class="token punctuation">:</span>\n    <span class="token key atrule">image</span><span class="token punctuation">:</span> examples/web\n    <span class="token key atrule">ports</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> <span class="token string">\'80:80\'</span>\n    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> <span class="token string">\'/data\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>注意每个服务都必须通过 image 指令指定镜像或 build 指令（需要 Dockerfile）等来自动构建生成镜像。</p>\n<p>如果使用 build 指令，在 Dockerfile 中设置的选项(例如：CMD, EXPOSE, VOLUME, ENV 等) 将会自动被获取，无需在 <code class="language-text">docker-compose.yml</code> 中重复设置。</p>\n<p>下面分别介绍各个指令的用法。</p>\n<h3 id="build-1"><a href="#build-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>build</h3>\n<p>指定 Dockerfile 所在文件夹的路径（可以是绝对路径，或者相对 <code class="language-text">docker-compose.yml</code> 文件的路径）。Compose 将会利用它自动构建这个镜像，然后使用这个镜像。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="43182680581259870000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`version: \'3\'\nservices:\n  webapp:\n    build: ./dir`, `43182680581259870000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">\'3\'</span>\n<span class="token key atrule">services</span><span class="token punctuation">:</span>\n  <span class="token key atrule">webapp</span><span class="token punctuation">:</span>\n    <span class="token key atrule">build</span><span class="token punctuation">:</span> ./dir</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>你也可以使用 context 指令指定 Dockerfile 所在文件夹的路径。</p>\n<p>使用 dockerfile 指令指定 Dockerfile 文件名。</p>\n<p>使用 arg 指令指定构建镜像时的变量。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="9986326355474362000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`version: \'3\'\nservices:\n  webapp:\n    build:\n      context: ./dir\n      dockerfile: Dockerfile-alternate\n      args:\n        buildno: 1`, `9986326355474362000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">\'3\'</span>\n<span class="token key atrule">services</span><span class="token punctuation">:</span>\n  <span class="token key atrule">webapp</span><span class="token punctuation">:</span>\n    <span class="token key atrule">build</span><span class="token punctuation">:</span>\n      <span class="token key atrule">context</span><span class="token punctuation">:</span> ./dir\n      <span class="token key atrule">dockerfile</span><span class="token punctuation">:</span> Dockerfile<span class="token punctuation">-</span>alternate\n      <span class="token key atrule">args</span><span class="token punctuation">:</span>\n        <span class="token key atrule">buildno</span><span class="token punctuation">:</span> <span class="token number">1</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>使用 <code class="language-text">cache_from</code> 指定构建镜像的缓存</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="87201103313036020000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`build:\n  context: .\n  cache_from:\n    - alpine:latest\n    - corp/web_app:3.14`, `87201103313036020000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">build</span><span class="token punctuation">:</span>\n  <span class="token key atrule">context</span><span class="token punctuation">:</span> .\n  <span class="token key atrule">cache_from</span><span class="token punctuation">:</span>\n    <span class="token punctuation">-</span> alpine<span class="token punctuation">:</span>latest\n    <span class="token punctuation">-</span> corp/web_app<span class="token punctuation">:</span><span class="token number">3.14</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="cap_add-cap_drop"><a href="#cap_add-cap_drop" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><code class="language-text">cap_add</code>, <code class="language-text">cap_drop</code></h3>\n<p>指定容器的内核能力（capacity）分配。</p>\n<p>例如，让容器拥有所有能力可以指定为：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="91384221855315510000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`cap_add:\n  - ALL`, `91384221855315510000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">cap_add</span><span class="token punctuation">:</span>\n  <span class="token punctuation">-</span> ALL</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>去掉 <code class="language-text">NET_ADMIN</code> 能力可以指定为：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="37502454023404060000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`cap_drop:\n  - NET_ADMIN`, `37502454023404060000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">cap_drop</span><span class="token punctuation">:</span>\n  <span class="token punctuation">-</span> NET_ADMIN</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<h3 id="command"><a href="#command" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>command</h3>\n<p>覆盖容器启动后默认执行的命令。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="39525867264521920000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`command: echo &quot;hello world&quot;`, `39525867264521920000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">command</span><span class="token punctuation">:</span> echo "hello world"</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h3 id="configs"><a href="#configs" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>configs</h3>\n<p>仅用于 Swarm mode，详细内容请查看 Swarm mode 一节。</p>\n<h3 id="cgroup_parent"><a href="#cgroup_parent" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>cgroup_parent</h3>\n<p>指定父 cgroup 组，意味着将继承该组的资源限制。</p>\n<p>例如，创建了一个 cgroup 组名称为 <code class="language-text">cgroups_1</code>。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="72936514579551190000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`cgroup_parent: cgroups_1`, `72936514579551190000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">cgroup_parent</span><span class="token punctuation">:</span> cgroups_1</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h3 id="container_name"><a href="#container_name" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>container_name</h3>\n<p>指定容器名称。默认将会使用 <code class="language-text">项目名称-服务名称-序号</code> 这样的格式。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="79741104810513530000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`container_name: docker-web-container`, `79741104810513530000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">container_name</span><span class="token punctuation">:</span> docker<span class="token punctuation">-</span>web<span class="token punctuation">-</span>container</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<blockquote>\n<p>注意: 指定容器名称后，该服务将无法进行扩展（scale），因为 Docker 不允许多个容器具有相同的名称。</p>\n</blockquote>\n<h3 id="deploy"><a href="#deploy" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>deploy</h3>\n<p>仅用于 Swarm mode，详细内容请查看 Swarm mode 一节</p>\n<h3 id="devices"><a href="#devices" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>devices</h3>\n<p>指定设备映射关系。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="8598315463363892000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`devices:\n  - \'/dev/ttyUSB1:/dev/ttyUSB0\'`, `8598315463363892000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">devices</span><span class="token punctuation">:</span>\n  <span class="token punctuation">-</span> <span class="token string">\'/dev/ttyUSB1:/dev/ttyUSB0\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<h3 id="depends_on"><a href="#depends_on" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>depends_on</h3>\n<p>解决容器的依赖、启动先后的问题。以下例子中会先启动 <code class="language-text">redis db</code> 再启动 web</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="82156139037309220000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`version: \'3\'\n\nservices:\n  web:\n    build: .\n    depends_on:\n      - db\n      - redis\n\n  redis:\n    image: redis\n\n  db:\n    image: postgres`, `82156139037309220000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">\'3\'</span>\n\n<span class="token key atrule">services</span><span class="token punctuation">:</span>\n  <span class="token key atrule">web</span><span class="token punctuation">:</span>\n    <span class="token key atrule">build</span><span class="token punctuation">:</span> .\n    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> db\n      <span class="token punctuation">-</span> redis\n\n  <span class="token key atrule">redis</span><span class="token punctuation">:</span>\n    <span class="token key atrule">image</span><span class="token punctuation">:</span> redis\n\n  <span class="token key atrule">db</span><span class="token punctuation">:</span>\n    <span class="token key atrule">image</span><span class="token punctuation">:</span> postgres</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<blockquote>\n<p>注意：web 服务不会等待 <code class="language-text">redis db</code>「完全启动」之后才启动。</p>\n</blockquote>\n<h3 id="dns"><a href="#dns" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>dns</h3>\n<p>自定义 DNS 服务器。可以是一个值，也可以是一个列表。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="6822959344254876000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`dns: 8.8.8.8\n\ndns:\n  - 8.8.8.8\n  - 114.114.114.114`, `6822959344254876000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">dns</span><span class="token punctuation">:</span> 8.8.8.8\n\n<span class="token key atrule">dns</span><span class="token punctuation">:</span>\n  <span class="token punctuation">-</span> 8.8.8.8\n  <span class="token punctuation">-</span> 114.114.114.114</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="dns_search"><a href="#dns_search" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>dns_search</h3>\n<p>配置 DNS 搜索域。可以是一个值，也可以是一个列表。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="57868895755409965000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`dns_search: example.com\n\ndns_search:\n  - domain1.example.com\n  - domain2.example.com`, `57868895755409965000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">dns_search</span><span class="token punctuation">:</span> example.com\n\n<span class="token key atrule">dns_search</span><span class="token punctuation">:</span>\n  <span class="token punctuation">-</span> domain1.example.com\n  <span class="token punctuation">-</span> domain2.example.com</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="tmpfs"><a href="#tmpfs" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>tmpfs</h3>\n<p>挂载一个 tmpfs 文件系统到容器。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="14115087619162980000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`tmpfs: /run\ntmpfs:\n  - /run\n  - /tmp`, `14115087619162980000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">tmpfs</span><span class="token punctuation">:</span> /run\n<span class="token key atrule">tmpfs</span><span class="token punctuation">:</span>\n  <span class="token punctuation">-</span> /run\n  <span class="token punctuation">-</span> /tmp</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="env_file"><a href="#env_file" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>env_file</h3>\n<p>从文件中获取环境变量，可以为单独的文件路径或列表。</p>\n<p>如果通过 <code class="language-text">docker compose -f FILE</code> 方式来指定 Compose 模板文件，则 <code class="language-text">env_file</code> 中变量的路径会基于模板文件路径。</p>\n<p>如果有变量名称与 environment 指令冲突，则按照惯例，以后者为准。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="53582080858524540000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`env_file: .env\n\nenv_file:\n  - ./common.env\n  - ./apps/web.env\n  - /opt/secrets.env`, `53582080858524540000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">env_file</span><span class="token punctuation">:</span> .env\n\n<span class="token key atrule">env_file</span><span class="token punctuation">:</span>\n  <span class="token punctuation">-</span> ./common.env\n  <span class="token punctuation">-</span> ./apps/web.env\n  <span class="token punctuation">-</span> /opt/secrets.env</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>环境变量文件中每一行必须符合格式，支持 # 开头的注释行。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="70865624980919240000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# common.env: Set development environment\nPROG_ENV=development`, `70865624980919240000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token comment"># common.env: Set development environment</span>\n<span class="token assign-left variable">PROG_ENV</span><span class="token operator">=</span>development</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<h3 id="environment"><a href="#environment" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>environment</h3>\n<p>设置环境变量。你可以使用数组或字典两种格式。</p>\n<p>只给定名称的变量会自动获取运行 Compose 主机上对应变量的值，可以用来防止泄露不必要的数据。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="47969784574543970000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`environment:\n  RACK_ENV: development\n  SESSION_SECRET:\n\nenvironment:\n  - RACK_ENV=development\n  - SESSION_SECRET`, `47969784574543970000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">environment</span><span class="token punctuation">:</span>\n  <span class="token key atrule">RACK_ENV</span><span class="token punctuation">:</span> development\n  <span class="token key atrule">SESSION_SECRET</span><span class="token punctuation">:</span>\n\n<span class="token key atrule">environment</span><span class="token punctuation">:</span>\n  <span class="token punctuation">-</span> RACK_ENV=development\n  <span class="token punctuation">-</span> SESSION_SECRET</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果变量名称或者值中用到 <code class="language-text">true|false</code>，<code class="language-text">yes|no</code> 等表达布尔含义的词汇，最好放到引号里，避免 YAML 自动解析某些内容为对应的布尔语义。这些特定词汇，包括</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="16884250603385030000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`y|Y|yes|Yes|YES|n|N|no|No|NO|true|True|TRUE|false|False|FALSE|on|On|ON|off|Off|OFF`, `16884250603385030000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">y<span class="token operator">|</span>Y<span class="token operator">|</span><span class="token function">yes</span><span class="token operator">|</span>Yes<span class="token operator">|</span>YES<span class="token operator">|</span>n<span class="token operator">|</span>N<span class="token operator">|</span>no<span class="token operator">|</span>No<span class="token operator">|</span>NO<span class="token operator">|</span><span class="token boolean">true</span><span class="token operator">|</span>True<span class="token operator">|</span>TRUE<span class="token operator">|</span><span class="token boolean">false</span><span class="token operator">|</span>False<span class="token operator">|</span>FALSE<span class="token operator">|</span>on<span class="token operator">|</span>On<span class="token operator">|</span>ON<span class="token operator">|</span>off<span class="token operator">|</span>Off<span class="token operator">|</span>OFF</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h3 id="expose-1"><a href="#expose-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>expose</h3>\n<p>暴露端口，但不映射到宿主机，只被连接的服务访问。</p>\n<p>仅可以指定内部端口为参数</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="75057155873563530000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`expose:\n  - \'3000\'\n  - \'8000\'`, `75057155873563530000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">expose</span><span class="token punctuation">:</span>\n  <span class="token punctuation">-</span> <span class="token string">\'3000\'</span>\n  <span class="token punctuation">-</span> <span class="token string">\'8000\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<h3 id="external_links"><a href="#external_links" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>external_links</h3>\n<p>注意：不建议使用该指令。</p>\n<p>链接到 <code class="language-text">docker-compose.yml</code> 外部的容器，甚至并非 Compose 管理的外部容器。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="18738179081663950000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`external_links:\n  - redis_1\n  - project_db_1:mysql\n  - project_db_1:postgresql`, `18738179081663950000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">external_links</span><span class="token punctuation">:</span>\n  <span class="token punctuation">-</span> redis_1\n  <span class="token punctuation">-</span> project_db_1<span class="token punctuation">:</span>mysql\n  <span class="token punctuation">-</span> project_db_1<span class="token punctuation">:</span>postgresql</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="extra_hosts"><a href="#extra_hosts" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>extra_hosts</h3>\n<p>类似 Docker 中的 <code class="language-text">--add-host</code> 参数，指定额外的 host 名称映射信息。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="94753654034747650000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`extra_hosts:\n  - \'googledns:8.8.8.8\'\n  - \'dockerhub:52.1.157.61\'`, `94753654034747650000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">extra_hosts</span><span class="token punctuation">:</span>\n  <span class="token punctuation">-</span> <span class="token string">\'googledns:8.8.8.8\'</span>\n  <span class="token punctuation">-</span> <span class="token string">\'dockerhub:52.1.157.61\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>会在启动后的服务容器中 <code class="language-text">/etc/hosts</code> 文件中添加如下两条条目。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="53291443061174880000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`8.8.8.8 googledns\n52.1.157.61 dockerhub`, `53291443061174880000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token number">8.8</span>.8.8 googledns\n<span class="token number">52.1</span>.157.61 dockerhub</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<h3 id="healthcheck"><a href="#healthcheck" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>healthcheck</h3>\n<p>通过命令检查容器是否健康运行。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="40336847915755630000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`healthcheck:\n  test: [\'CMD\', \'curl\', \'-f\', \'http://localhost\']\n  interval: 1m30s\n  timeout: 10s\n  retries: 3`, `40336847915755630000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">healthcheck</span><span class="token punctuation">:</span>\n  <span class="token key atrule">test</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'CMD\'</span><span class="token punctuation">,</span> <span class="token string">\'curl\'</span><span class="token punctuation">,</span> <span class="token string">\'-f\'</span><span class="token punctuation">,</span> <span class="token string">\'http://localhost\'</span><span class="token punctuation">]</span>\n  <span class="token key atrule">interval</span><span class="token punctuation">:</span> 1m30s\n  <span class="token key atrule">timeout</span><span class="token punctuation">:</span> 10s\n  <span class="token key atrule">retries</span><span class="token punctuation">:</span> <span class="token number">3</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="image"><a href="#image" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>image</h3>\n<p>指定为镜像名称或镜像 ID。如果镜像在本地不存在，Compose 将会尝试拉取这个镜像。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="15793552156718825000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`image: ubuntu\nimage: orchardup/postgresql\nimage: a4bc65fd`, `15793552156718825000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">image</span><span class="token punctuation">:</span> ubuntu\n<span class="token key atrule">image</span><span class="token punctuation">:</span> orchardup/postgresql\n<span class="token key atrule">image</span><span class="token punctuation">:</span> a4bc65fd</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<h3 id="labels"><a href="#labels" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>labels</h3>\n<p>为容器添加 Docker 元数据（metadata）信息。例如可以为容器添加辅助说明信息。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="25255507177428570000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`labels:\n  com.startupteam.description: \'webapp for a startup team\'\n  com.startupteam.department: \'devops department\'\n  com.startupteam.release: \'rc3 for v1.0\'`, `25255507177428570000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">labels</span><span class="token punctuation">:</span>\n  <span class="token key atrule">com.startupteam.description</span><span class="token punctuation">:</span> <span class="token string">\'webapp for a startup team\'</span>\n  <span class="token key atrule">com.startupteam.department</span><span class="token punctuation">:</span> <span class="token string">\'devops department\'</span>\n  <span class="token key atrule">com.startupteam.release</span><span class="token punctuation">:</span> <span class="token string">\'rc3 for v1.0\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="links"><a href="#links" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>links</h3>\n<p>注意：不推荐使用该指令。</p>\n<h3 id="logging"><a href="#logging" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>logging</h3>\n<p>配置日志选项。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="98765452186988580000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`logging:\n  driver: syslog\n  options:\n    syslog-address: \'tcp://192.168.0.42:123\'`, `98765452186988580000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">logging</span><span class="token punctuation">:</span>\n  <span class="token key atrule">driver</span><span class="token punctuation">:</span> syslog\n  <span class="token key atrule">options</span><span class="token punctuation">:</span>\n    <span class="token key atrule">syslog-address</span><span class="token punctuation">:</span> <span class="token string">\'tcp://192.168.0.42:123\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>目前支持三种日志驱动类型。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="4292019537767011300"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`driver: &quot;json-file&quot;\ndriver: &quot;syslog&quot;\ndriver: &quot;none&quot;`, `4292019537767011300`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">driver</span><span class="token punctuation">:</span> <span class="token string">"json-file"</span>\n<span class="token key atrule">driver</span><span class="token punctuation">:</span> <span class="token string">"syslog"</span>\n<span class="token key atrule">driver</span><span class="token punctuation">:</span> <span class="token string">"none"</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>options 配置日志驱动的相关参数。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="85943067731204690000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`options:\n  max-size: \'200k\'\n  max-file: \'10\'`, `85943067731204690000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">options</span><span class="token punctuation">:</span>\n  <span class="token key atrule">max-size</span><span class="token punctuation">:</span> <span class="token string">\'200k\'</span>\n  <span class="token key atrule">max-file</span><span class="token punctuation">:</span> <span class="token string">\'10\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<h3 id="network_mode"><a href="#network_mode" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>network_mode</h3>\n<p>设置网络模式。使用和 docker run 的 <code class="language-text">--network</code> 参数一样的值。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="23924598420411126000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`network_mode: &quot;bridge&quot;\nnetwork_mode: &quot;host&quot;\nnetwork_mode: &quot;none&quot;\nnetwork_mode: &quot;service:[service name]&quot;\nnetwork_mode: &quot;container:[container name/id]&quot;`, `23924598420411126000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">network_mode</span><span class="token punctuation">:</span> <span class="token string">"bridge"</span>\n<span class="token key atrule">network_mode</span><span class="token punctuation">:</span> <span class="token string">"host"</span>\n<span class="token key atrule">network_mode</span><span class="token punctuation">:</span> <span class="token string">"none"</span>\n<span class="token key atrule">network_mode</span><span class="token punctuation">:</span> <span class="token string">"service:[service name]"</span>\n<span class="token key atrule">network_mode</span><span class="token punctuation">:</span> <span class="token string">"container:[container name/id]"</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="networks"><a href="#networks" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>networks</h3>\n<p>配置容器连接的网络。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="40302860910845050000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`version: \'3\'\nservices:\n  some-service:\n    networks:\n      - some-network\n      - other-network\n\nnetworks:\n  some-network:\n  other-network:`, `40302860910845050000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">\'3\'</span>\n<span class="token key atrule">services</span><span class="token punctuation">:</span>\n  <span class="token key atrule">some-service</span><span class="token punctuation">:</span>\n    <span class="token key atrule">networks</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> some<span class="token punctuation">-</span>network\n      <span class="token punctuation">-</span> other<span class="token punctuation">-</span>network\n\n<span class="token key atrule">networks</span><span class="token punctuation">:</span>\n  <span class="token key atrule">some-network</span><span class="token punctuation">:</span>\n  other<span class="token punctuation">-</span>network<span class="token punctuation">:</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="pid"><a href="#pid" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>pid</h3>\n<p>跟主机系统共享进程命名空间。打开该选项的容器之间，以及容器和宿主机系统之间可以通过进程 ID 来相互访问和操作。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="87536761644227600000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`pid: \'host\'`, `87536761644227600000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">pid</span><span class="token punctuation">:</span> <span class="token string">\'host\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h3 id="ports"><a href="#ports" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ports</h3>\n<p>暴露端口信息。</p>\n<p>使用宿主端口：容器端口（HOST:CONTAINER）格式，或者仅仅指定容器的端口（宿主将会随机选择端口）都可以。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="78871228474828570000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`ports:\n  - \'3000\'\n  - \'8000:8000\'\n  - \'49100:22\'\n  - \'127.0.0.1:8001:8001\'`, `78871228474828570000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">ports</span><span class="token punctuation">:</span>\n  <span class="token punctuation">-</span> <span class="token string">\'3000\'</span>\n  <span class="token punctuation">-</span> <span class="token string">\'8000:8000\'</span>\n  <span class="token punctuation">-</span> <span class="token string">\'49100:22\'</span>\n  <span class="token punctuation">-</span> <span class="token string">\'127.0.0.1:8001:8001\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<blockquote>\n<p>注意：当使用 <code class="language-text">HOST:CONTAINER</code> 格式来映射端口时，如果你使用的容器端口小于 60 并且没放到引号里，可能会得到错误结果，因为 YAML 会自动解析 <code class="language-text">xx:yy</code> 这种数字格式为 60 进制。为避免出现这种问题，建议数字串都采用引号包括起来的字符串格式。</p>\n</blockquote>\n<h3 id="secrets"><a href="#secrets" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>secrets</h3>\n<p>存储敏感数据，例如 mysql 服务密码。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="32605685004274410000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`version: \'3.1\'\nservices:\n\nmysql:\n  image: mysql\n  environment:\n    MYSQL_ROOT_PASSWORD_FILE: /run/secrets/db_root_password\n  secrets:\n    - db_root_password\n    - my_other_secret\n\nsecrets:\n  my_secret:\n    file: ./my_secret.txt\n  my_other_secret:\n    external: true`, `32605685004274410000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">\'3.1\'</span>\n<span class="token key atrule">services</span><span class="token punctuation">:</span>\n\n<span class="token key atrule">mysql</span><span class="token punctuation">:</span>\n  <span class="token key atrule">image</span><span class="token punctuation">:</span> mysql\n  <span class="token key atrule">environment</span><span class="token punctuation">:</span>\n    <span class="token key atrule">MYSQL_ROOT_PASSWORD_FILE</span><span class="token punctuation">:</span> /run/secrets/db_root_password\n  <span class="token key atrule">secrets</span><span class="token punctuation">:</span>\n    <span class="token punctuation">-</span> db_root_password\n    <span class="token punctuation">-</span> my_other_secret\n\n<span class="token key atrule">secrets</span><span class="token punctuation">:</span>\n  <span class="token key atrule">my_secret</span><span class="token punctuation">:</span>\n    <span class="token key atrule">file</span><span class="token punctuation">:</span> ./my_secret.txt\n  <span class="token key atrule">my_other_secret</span><span class="token punctuation">:</span>\n    <span class="token key atrule">external</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="security_opt"><a href="#security_opt" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>security_opt</h3>\n<p>指定容器模板标签（label）机制的默认属性（用户、角色、类型、级别等）。例如配置标签的用户名和角色名。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="94427062933465500000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`security_opt:\n  - label:user:USER\n  - label:role:ROLE`, `94427062933465500000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">security_opt</span><span class="token punctuation">:</span>\n  <span class="token punctuation">-</span> label<span class="token punctuation">:</span>user<span class="token punctuation">:</span>USER\n  <span class="token punctuation">-</span> label<span class="token punctuation">:</span>role<span class="token punctuation">:</span>ROLE</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<h3 id="stop_signal"><a href="#stop_signal" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>stop_signal</h3>\n<p>设置另一个信号来停止容器。在默认情况下使用的是 SIGTERM 停止容器。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="47725985770442470000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`stop_signal: SIGUSR1`, `47725985770442470000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">stop_signal</span><span class="token punctuation">:</span> SIGUSR1</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h3 id="sysctls"><a href="#sysctls" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>sysctls</h3>\n<p>配置容器内核参数。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="36629166785124733000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`sysctls:\n  net.core.somaxconn: 1024\n  net.ipv4.tcp_syncookies: 0\n\nsysctls:\n  - net.core.somaxconn=1024\n  - net.ipv4.tcp_syncookies=0`, `36629166785124733000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">sysctls</span><span class="token punctuation">:</span>\n  <span class="token key atrule">net.core.somaxconn</span><span class="token punctuation">:</span> <span class="token number">1024</span>\n  <span class="token key atrule">net.ipv4.tcp_syncookies</span><span class="token punctuation">:</span> <span class="token number">0</span>\n\n<span class="token key atrule">sysctls</span><span class="token punctuation">:</span>\n  <span class="token punctuation">-</span> net.core.somaxconn=1024\n  <span class="token punctuation">-</span> net.ipv4.tcp_syncookies=0</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="ulimits"><a href="#ulimits" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ulimits</h3>\n<p>指定容器的 ulimits 限制值。</p>\n<p>例如，指定最大进程数为 65535，指定文件句柄数为 20000（软限制，应用可以随时修改，不能超过硬限制）和 40000（系统硬限制，只能 root 用户提高）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="46862917321348375000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`ulimits:\n  nproc: 65535\n  nofile:\n    soft: 20000\n    hard: 40000`, `46862917321348375000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">ulimits</span><span class="token punctuation">:</span>\n  <span class="token key atrule">nproc</span><span class="token punctuation">:</span> <span class="token number">65535</span>\n  <span class="token key atrule">nofile</span><span class="token punctuation">:</span>\n    <span class="token key atrule">soft</span><span class="token punctuation">:</span> <span class="token number">20000</span>\n    <span class="token key atrule">hard</span><span class="token punctuation">:</span> <span class="token number">40000</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="volumes"><a href="#volumes" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>volumes</h3>\n<p>数据卷所挂载路径设置。可以设置为宿主机路径（HOST:CONTAINER）或者数据卷名称（VOLUME:CONTAINER），并且可以设置访问模式（HOST:CONTAINER:ro）。</p>\n<p>该指令中路径支持相对路径。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="68916643831567350000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`volumes:\n  - /var/lib/mysql\n  - cache/:/tmp/cache\n  - ~/configs:/etc/configs/:ro`, `68916643831567350000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">volumes</span><span class="token punctuation">:</span>\n  <span class="token punctuation">-</span> /var/lib/mysql\n  <span class="token punctuation">-</span> cache/<span class="token punctuation">:</span>/tmp/cache\n  <span class="token punctuation">-</span> ~/configs<span class="token punctuation">:</span>/etc/configs/<span class="token punctuation">:</span>ro</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果路径为数据卷名称，必须在文件中配置数据卷。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="70189636130099790000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`version: \'3\'\n\nservices:\n  my_src:\n    image: mysql:8.0\n    volumes:\n      - mysql_data:/var/lib/mysql\n\nvolumes:\n  mysql_data:`, `70189636130099790000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">\'3\'</span>\n\n<span class="token key atrule">services</span><span class="token punctuation">:</span>\n  <span class="token key atrule">my_src</span><span class="token punctuation">:</span>\n    <span class="token key atrule">image</span><span class="token punctuation">:</span> mysql<span class="token punctuation">:</span><span class="token number">8.0</span>\n    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> mysql_data<span class="token punctuation">:</span>/var/lib/mysql\n\n<span class="token key atrule">volumes</span><span class="token punctuation">:</span>\n  mysql_data<span class="token punctuation">:</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="其它指令"><a href="#%E5%85%B6%E5%AE%83%E6%8C%87%E4%BB%A4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>其它指令</h3>\n<p>此外，还有包括 domainname, entrypoint, hostname, ipc, <code class="language-text">mac_address</code>, privileged, <code class="language-text">read_only</code>, <code class="language-text">shm_size</code>, restart, <code class="language-text">stdin_open</code>, tty, user, <code class="language-text">working_dir</code> 等指令，基本跟 docker run 中对应参数的功能一致。</p>\n<p>指定服务容器启动后执行的入口文件。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="9092641955049552000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`entrypoint: /code/entrypoint.sh`, `9092641955049552000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">entrypoint</span><span class="token punctuation">:</span> /code/entrypoint.sh</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>指定容器中运行应用的用户名。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="86528164681871340000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`user: nginx`, `86528164681871340000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">user</span><span class="token punctuation">:</span> nginx</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>指定容器中工作目录。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="29357737224749390000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`working_dir: /code`, `29357737224749390000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">working_dir</span><span class="token punctuation">:</span> /code</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>指定容器中搜索域名、主机名、mac 地址等。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="71557763483541660000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`domainname: your_website.com\nhostname: test\nmac_address: 08-00-27-00-0C-0A`, `71557763483541660000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">domainname</span><span class="token punctuation">:</span> your_website.com\n<span class="token key atrule">hostname</span><span class="token punctuation">:</span> test\n<span class="token key atrule">mac_address</span><span class="token punctuation">:</span> 08<span class="token punctuation">-</span>00<span class="token punctuation">-</span>27<span class="token punctuation">-</span>00<span class="token punctuation">-</span>0C<span class="token punctuation">-</span>0A</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>允许容器中运行一些特权命令。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="29955263326776940000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`privileged: true`, `29955263326776940000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">privileged</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>指定容器退出后的重启策略为始终重启。该命令对保持服务始终运行十分有效，在生产环境中推荐配置为 always 或者 <code class="language-text">unless-stopped</code>。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="96369029502289200000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`restart: always`, `96369029502289200000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">restart</span><span class="token punctuation">:</span> always</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>以只读模式挂载容器的 root 文件系统，意味着不能对容器内容进行修改。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="14440005941272816000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`read_only: true`, `14440005941272816000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">read_only</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>打开标准输入，可以接受外部输入。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="39910436913707835000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`stdin_open: true`, `39910436913707835000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">stdin_open</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>模拟一个伪终端。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="18439898926520070000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`tty: true`, `18439898926520070000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">tty</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h3 id="读取变量"><a href="#%E8%AF%BB%E5%8F%96%E5%8F%98%E9%87%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>读取变量</h3>\n<p>Compose 模板文件支持动态读取主机的系统环境变量和当前目录下的 <code class="language-text">.env</code> 文件中的变量。</p>\n<p>例如，下面的 Compose 文件将从运行它的环境中读取变量 <code class="language-text">${MONGO_VERSION}</code> 的值，并写入执行的指令中。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="23639063858426380000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`version: \'3\'\nservices:\n\ndb:\n  image: \'mongo:\\${MONGO_VERSION}\'`, `23639063858426380000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">\'3\'</span>\n<span class="token key atrule">services</span><span class="token punctuation">:</span>\n\n<span class="token key atrule">db</span><span class="token punctuation">:</span>\n  <span class="token key atrule">image</span><span class="token punctuation">:</span> <span class="token string">\'mongo:${MONGO_VERSION}\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果执行 <code class="language-text">MONGO_VERSION=3.2 docker compose up</code> 则会启动一个 <code class="language-text">mongo:3.2</code> 镜像的容器；如果执行 <code class="language-text">MONGO_VERSION=2.8 docker compose up</code> 则会启动一个 <code class="language-text">mongo:2.8</code> 镜像的容器。</p>\n<p>若当前目录存在 <code class="language-text">.env</code> 文件，执行 <code class="language-text">docker compose</code> 命令时将从该文件中读取变量。</p>\n<p>在当前目录新建 <code class="language-text">.env</code> 文件并写入以下内容。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="44650174652396820000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# 支持 # 号注释\nMONGO_VERSION=3.6`, `44650174652396820000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token comment"># 支持 # 号注释</span>\n<span class="token assign-left variable">MONGO_VERSION</span><span class="token operator">=</span><span class="token number">3.6</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>执行 <code class="language-text">docker compose up</code> 则会启动一个 <code class="language-text">mongo:3.6</code> 镜像的容器。</p>\n<h2 id="使用-django"><a href="#%E4%BD%BF%E7%94%A8-django" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用 Django</h2>\n<p>我们现在将使用 Docker Compose 配置并运行一个 <code class="language-text">Django/PostgreSQL</code> 应用。</p>\n<p>在一切工作开始前，需要先编辑好三个必要的文件。</p>\n<p>第一步，因为应用将要运行在一个满足所有环境依赖的 Docker 容器里面，那么我们可以通过编辑 Dockerfile 文件来指定 Docker 容器要安装内容。内容如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="11440315762009901000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`FROM python:3\nENV PYTHONUNBUFFERED 1\nRUN mkdir /code\nWORKDIR /code\nCOPY requirements.txt /code/\nRUN pip install -r requirements.txt\nCOPY . /code/`, `11440315762009901000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">FROM</span> python<span class="token punctuation">:</span>3\n<span class="token keyword">ENV</span> PYTHONUNBUFFERED 1\n<span class="token keyword">RUN</span> mkdir /code\n<span class="token keyword">WORKDIR</span> /code\n<span class="token keyword">COPY</span> requirements.txt /code/\n<span class="token keyword">RUN</span> pip install <span class="token punctuation">-</span>r requirements.txt\n<span class="token keyword">COPY</span> . /code/</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>以上内容指定应用将使用安装了 Python 以及必要依赖包的镜像。更多关于如何编写 Dockerfile 文件的信息可以查看 Dockerfile 使用。</p>\n<p>第二步，在 <code class="language-text">requirements.txt</code> 文件里面写明需要安装的具体依赖包名。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="34820083787691460000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`Django>=2.0,<3.0\npsycopg2>=2.7,<3.0`, `34820083787691460000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">Django&gt;=2.0,&lt;3.0\npsycopg2&gt;=2.7,&lt;3.0</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>第三步，<code class="language-text">docker-compose.yml</code> 文件将把所有的东西关联起来。它描述了应用的构成（一个 web 服务和一个数据库）、使用的 Docker 镜像、镜像之间的连接、挂载到容器的卷，以及服务开放的端口。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="41401926013018644000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`version: \'3\'\nservices:\n  db:\n    image: postgres\n    environment:\n      POSTGRES_PASSWORD: \'postgres\'\n\n  web:\n    build: .\n    command: python manage.py runserver 0.0.0.0:8000\n    volumes:\n      - .:/code\n    ports:\n      - \'8000:8000\'`, `41401926013018644000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">\'3\'</span>\n<span class="token key atrule">services</span><span class="token punctuation">:</span>\n  <span class="token key atrule">db</span><span class="token punctuation">:</span>\n    <span class="token key atrule">image</span><span class="token punctuation">:</span> postgres\n    <span class="token key atrule">environment</span><span class="token punctuation">:</span>\n      <span class="token key atrule">POSTGRES_PASSWORD</span><span class="token punctuation">:</span> <span class="token string">\'postgres\'</span>\n\n  <span class="token key atrule">web</span><span class="token punctuation">:</span>\n    <span class="token key atrule">build</span><span class="token punctuation">:</span> .\n    <span class="token key atrule">command</span><span class="token punctuation">:</span> python manage.py runserver 0.0.0.0<span class="token punctuation">:</span><span class="token number">8000</span>\n    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> .<span class="token punctuation">:</span>/code\n    <span class="token key atrule">ports</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> <span class="token string">\'8000:8000\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>查看 <code class="language-text">docker-compose.yml</code> 章节 了解更多详细的工作机制。</p>\n<p>现在我们就可以使用 <code class="language-text">docker compose run</code> 命令启动一个 Django 应用了。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="61688989596751620000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker compose run web django-admin startproject django_example .`, `61688989596751620000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker compose run web django-admin startproject django_example <span class="token builtin class-name">.</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>由于 web 服务所使用的镜像并不存在，所以 Compose 会首先使用 Dockerfile 为 web 服务构建一个镜像，接着使用这个镜像在容器里运行 <code class="language-text">django-admin startproject django_example</code> 指令。</p>\n<p>这将在当前目录生成一个 Django 应用。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="93864282840826070000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ ls\nDockerfile       docker-compose.yml          django_example       manage.py       requirements.txt`, `93864282840826070000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ <span class="token function">ls</span>\nDockerfile       docker-compose.yml          django_example       manage.py       requirements.txt</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>如果你的系统是 Linux，记得更改文件权限。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="49242731359257100000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ sudo chown -R \\$USER:\\$USER .`, `49242731359257100000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ <span class="token function">sudo</span> <span class="token function">chown</span> -R <span class="token environment constant">$USER</span><span class="token builtin class-name">:</span><span class="token environment constant">$USER</span> <span class="token builtin class-name">.</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>首先，我们要为应用设置好数据库的连接信息。用以下内容替换 <code class="language-text">django_example/settings.py</code> 文件中 <code class="language-text">DATABASES = ...</code> 定义的节点内容。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="45392943806813045000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`DATABASES = {\n    \'default\': {\n        \'ENGINE\': \'django.db.backends.postgresql\',\n        \'NAME\': \'postgres\',\n        \'USER\': \'postgres\',\n        \'HOST\': \'db\',\n        \'PORT\': 5432,\n        \'PASSWORD\': \'postgres\',\n    }\n}`, `45392943806813045000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">DATABASES <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token string">\'default\'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>\n        <span class="token string">\'ENGINE\'</span><span class="token punctuation">:</span> <span class="token string">\'django.db.backends.postgresql\'</span><span class="token punctuation">,</span>\n        <span class="token string">\'NAME\'</span><span class="token punctuation">:</span> <span class="token string">\'postgres\'</span><span class="token punctuation">,</span>\n        <span class="token string">\'USER\'</span><span class="token punctuation">:</span> <span class="token string">\'postgres\'</span><span class="token punctuation">,</span>\n        <span class="token string">\'HOST\'</span><span class="token punctuation">:</span> <span class="token string">\'db\'</span><span class="token punctuation">,</span>\n        <span class="token string">\'PORT\'</span><span class="token punctuation">:</span> <span class="token number">5432</span><span class="token punctuation">,</span>\n        <span class="token string">\'PASSWORD\'</span><span class="token punctuation">:</span> <span class="token string">\'postgres\'</span><span class="token punctuation">,</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这些信息是在 postgres 镜像固定设置好的。然后，运行 <code class="language-text">docker compose up</code>：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="16081021950072926000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker compose up\n\ndjango_db_1 is up-to-date\nCreating django_web_1 ...\nCreating django_web_1 ... done\nAttaching to django_db_1, django_web_1\ndb_1   | The files belonging to this database system will be owned by user &quot;postgres&quot;.\ndb_1   | This user must also own the server process.\ndb_1   |\ndb_1   | The database cluster will be initialized with locale &quot;en_US.utf8&quot;.\ndb_1   | The default database encoding has accordingly been set to &quot;UTF8&quot;.\ndb_1   | The default text search configuration will be set to &quot;english&quot;.\n\nweb_1  | Performing system checks...\nweb_1  |\nweb_1  | System check identified no issues (0 silenced).\nweb_1  |\nweb_1  | November 23, 2017 - 06:21:19\nweb_1  | Django version 1.11.7, using settings \'django_example.settings\'\nweb_1  | Starting development server at http://0.0.0.0:8000/\nweb_1  | Quit the server with CONTROL-C.`, `16081021950072926000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker compose up\n\ndjango_db_1 is up-to-date\nCreating django_web_1 <span class="token punctuation">..</span>.\nCreating django_web_1 <span class="token punctuation">..</span>. <span class="token keyword">done</span>\nAttaching to django_db_1, django_web_1\ndb_1   <span class="token operator">|</span> The files belonging to this database system will be owned by user <span class="token string">"postgres"</span><span class="token builtin class-name">.</span>\ndb_1   <span class="token operator">|</span> This user must also own the server process.\ndb_1   <span class="token operator">|</span>\ndb_1   <span class="token operator">|</span> The database cluster will be initialized with locale <span class="token string">"en_US.utf8"</span><span class="token builtin class-name">.</span>\ndb_1   <span class="token operator">|</span> The default database encoding has accordingly been <span class="token builtin class-name">set</span> to <span class="token string">"UTF8"</span><span class="token builtin class-name">.</span>\ndb_1   <span class="token operator">|</span> The default text search configuration will be <span class="token builtin class-name">set</span> to <span class="token string">"english"</span><span class="token builtin class-name">.</span>\n\nweb_1  <span class="token operator">|</span> Performing system checks<span class="token punctuation">..</span>.\nweb_1  <span class="token operator">|</span>\nweb_1  <span class="token operator">|</span> System check identified no issues <span class="token punctuation">(</span><span class="token number">0</span> silenced<span class="token punctuation">)</span>.\nweb_1  <span class="token operator">|</span>\nweb_1  <span class="token operator">|</span> November <span class="token number">23</span>, <span class="token number">2017</span> - 06:21:19\nweb_1  <span class="token operator">|</span> Django version <span class="token number">1.11</span>.7, using settings <span class="token string">\'django_example.settings\'</span>\nweb_1  <span class="token operator">|</span> Starting development server at http://0.0.0.0:8000/\nweb_1  <span class="token operator">|</span> Quit the server with CONTROL-C.</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这个 Django 应用已经开始在你的 Docker 守护进程里监听着 8000 端口了。打开 <code class="language-text">127.0.0.1:8000</code> 即可看到 Django 欢迎页面。</p>\n<p>你还可以在 Docker 上运行其它的管理命令，例如对于同步数据库结构这种事，在运行完 <code class="language-text">docker compose up</code> 后，在另外一个终端进入文件夹运行以下命令即可：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="46558567753908410000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker compose run web python manage.py syncdb`, `46558567753908410000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker compose run web python manage.py syncdb</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h2 id="使用-wordpress"><a href="#%E4%BD%BF%E7%94%A8-wordpress" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用 WordPress</h2>\n<p>Compose 可以很便捷的让 Wordpress 运行在一个独立的环境中。</p>\n<h3 id="创建空文件夹"><a href="#%E5%88%9B%E5%BB%BA%E7%A9%BA%E6%96%87%E4%BB%B6%E5%A4%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>创建空文件夹</h3>\n<p>假设新建一个名为 wordpress 的文件夹，然后进入这个文件夹。</p>\n<h3 id="创建-docker-composeyml-文件"><a href="#%E5%88%9B%E5%BB%BA-docker-composeyml-%E6%96%87%E4%BB%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>创建 docker-compose.yml 文件</h3>\n<p><code class="language-text">docker-compose.yml</code> 文件将开启一个 wordpress 服务和一个独立的 MySQL 实例：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="28692984237579800000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`version: \'3\'\nservices:\n  db:\n    image: mysql:8.0\n    command:\n      - --default_authentication_plugin=mysql_native_password\n      - --character-set-server=utf8mb4\n      - --collation-server=utf8mb4_unicode_ci\n    volumes:\n      - db_data:/var/lib/mysql\n    restart: always\n    environment:\n      MYSQL_ROOT_PASSWORD: somewordpress\n      MYSQL_DATABASE: wordpress\n      MYSQL_USER: wordpress\n      MYSQL_PASSWORD: wordpress\n\n  wordpress:\n    depends_on:\n      - db\n    image: wordpress:latest\n    ports:\n      - \'8000:80\'\n    restart: always\n    environment:\n      WORDPRESS_DB_HOST: db:3306\n      WORDPRESS_DB_USER: wordpress\n      WORDPRESS_DB_PASSWORD: wordpress\nvolumes:\n  db_data:`, `28692984237579800000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">\'3\'</span>\n<span class="token key atrule">services</span><span class="token punctuation">:</span>\n  <span class="token key atrule">db</span><span class="token punctuation">:</span>\n    <span class="token key atrule">image</span><span class="token punctuation">:</span> mysql<span class="token punctuation">:</span><span class="token number">8.0</span>\n    <span class="token key atrule">command</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>default_authentication_plugin=mysql_native_password\n      <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>character<span class="token punctuation">-</span>set<span class="token punctuation">-</span>server=utf8mb4\n      <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>collation<span class="token punctuation">-</span>server=utf8mb4_unicode_ci\n    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> db_data<span class="token punctuation">:</span>/var/lib/mysql\n    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always\n    <span class="token key atrule">environment</span><span class="token punctuation">:</span>\n      <span class="token key atrule">MYSQL_ROOT_PASSWORD</span><span class="token punctuation">:</span> somewordpress\n      <span class="token key atrule">MYSQL_DATABASE</span><span class="token punctuation">:</span> wordpress\n      <span class="token key atrule">MYSQL_USER</span><span class="token punctuation">:</span> wordpress\n      <span class="token key atrule">MYSQL_PASSWORD</span><span class="token punctuation">:</span> wordpress\n\n  <span class="token key atrule">wordpress</span><span class="token punctuation">:</span>\n    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> db\n    <span class="token key atrule">image</span><span class="token punctuation">:</span> wordpress<span class="token punctuation">:</span>latest\n    <span class="token key atrule">ports</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> <span class="token string">\'8000:80\'</span>\n    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always\n    <span class="token key atrule">environment</span><span class="token punctuation">:</span>\n      <span class="token key atrule">WORDPRESS_DB_HOST</span><span class="token punctuation">:</span> db<span class="token punctuation">:</span><span class="token number">3306</span>\n      <span class="token key atrule">WORDPRESS_DB_USER</span><span class="token punctuation">:</span> wordpress\n      <span class="token key atrule">WORDPRESS_DB_PASSWORD</span><span class="token punctuation">:</span> wordpress\n<span class="token key atrule">volumes</span><span class="token punctuation">:</span>\n  db_data<span class="token punctuation">:</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="构建并运行项目"><a href="#%E6%9E%84%E5%BB%BA%E5%B9%B6%E8%BF%90%E8%A1%8C%E9%A1%B9%E7%9B%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>构建并运行项目</h3>\n<p>运行 <code class="language-text">docker compose up -d Compose</code> 就会拉取镜像再创建我们所需要的镜像，然后启动 wordpress 和数据库容器。接着浏览器访问 <code class="language-text">127.0.0.1:8000</code> 端口就能看到 WordPress 安装界面了。</p>\n<h1 id="kubernetes"><a href="#kubernetes" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Kubernetes</h1>\n<p>Kubernetes 是 Google 团队发起并维护的基于 Docker 的开源容器集群管理系统，它不仅支持常见的云平台，而且支持内部数据中心。</p>\n<p>建于 Docker 之上的 Kubernetes 可以构建一个容器的调度服务，其目的是让用户透过 Kubernetes 集群来进行云端容器集群的管理，而无需用户进行复杂的设置工作。系统会自动选取合适的工作节点来执行具体的容器集群调度处理工作。其核心概念是 Container Pod。一个 Pod 由一组工作于同一物理工作节点的容器构成。这些组容器拥有相同的网络命名空间、IP 以及存储配额，也可以根据实际情况对每一个 Pod 进行端口映射。此外，Kubernetes 工作节点会由主系统进行管理，节点包含了能够运行 Docker 容器所用到的服务。</p>\n<h2 id="项目简介"><a href="#%E9%A1%B9%E7%9B%AE%E7%AE%80%E4%BB%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>项目简介</h2>\n<p>Kubernetes 是 Google 团队发起的开源项目，它的目标是管理跨多个主机的容器，提供基本的部署，维护以及应用伸缩，主要实现语言为 Go 语言。Kubernetes 是：</p>\n<ul>\n<li>易学：轻量级，简单，容易理解</li>\n<li>便携：支持公有云，私有云，混合云，以及多种云平台</li>\n<li>可拓展：模块化，可插拔，支持钩子，可任意组合</li>\n<li>自修复：自动重调度，自动重启，自动复制</li>\n</ul>\n<p>Kubernetes 构建于 Google 数十年经验，一大半来源于 Google 生产环境规模的经验。结合了社区最佳的想法和实践。</p>\n<p>在分布式系统中，部署，调度，伸缩一直是最为重要的也最为基础的功能。Kubernetes 就是希望解决这一序列问题的。</p>\n<p>Kubernetes 目前在 GitHub 进行维护。</p>\n<p>Kubernetes 能够运行在任何地方，虽然 Kubernetes 最初是为 GCE 定制的，但是在后续版本中陆续增加了其他云平台的支持，以及本地数据中心的支持。</p>\n<h2 id="基本概念-2"><a href="#%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>基本概念</h2>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-07-21-13-57-53-20b4f5eff63b3e1b9a12c962cf7d982d-14d8a.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 72.9113924050633%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAIAAABr+ngCAAAACXBIWXMAAAsSAAALEgHS3X78AAABw0lEQVQoz31TS2+bQBD2//8lvVXKpZUvzaWntkoqN3Fi13aCMZiyywL7fs12IErqItrVCI1gv8c8WKR/HB8slw2kaG3HuZBSCiFijJd3FhMMvD64Yvvs1jhlDKO0JoS0bQsAM+AQAcNHKGi/PVYNN8rw7HTXcZKSlbLte26tnSgNYORDGIyK1gWtLZoTqvn2/cPNaklZlpLresIYm1HGVyh7aT04y7u6qA/5edvSXNLaKul9mFf+C4z6WrDymR92Uar+eHx8/06cjiPvRHmEImsM2EtgXJe0kx6C0WRzpxjl52L38ar88pk8rLxWCeIbxQKsU3nR7Z91TWOAplf5r4YrGyDgnPAGK57K9S2vquaUGaedtxD9H+XocKguhdeSRmKjumr3NTidb26qp/thImjR43Eu+PmaMY9jroP/2ZBaCis6pzggyHptB2aPDkeBmYa9ZFTL5eP9j3OJNfqYnANsdhhyj+BLZbQ8dAuD9jKrKNcWwdeH7ZrU+DX6QQkb9YKEyYYNbsdohT7TThmH4E/77QOpEpICjiIgDJP/7fab7cao5Wa9qgoE+IhyWBjMLMkEOW5qsjGc+rbBwQ62YPbP+w0RV2gvodsuPwAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 07 21 13 57 53" title="" data-src="/static/2022-07-21-13-57-53-20b4f5eff63b3e1b9a12c962cf7d982d-fee1c.png" data-srcset="/static/2022-07-21-13-57-53-20b4f5eff63b3e1b9a12c962cf7d982d-a67b7.png 200w,\n/static/2022-07-21-13-57-53-20b4f5eff63b3e1b9a12c962cf7d982d-0b187.png 400w,\n/static/2022-07-21-13-57-53-20b4f5eff63b3e1b9a12c962cf7d982d-fee1c.png 800w,\n/static/2022-07-21-13-57-53-20b4f5eff63b3e1b9a12c962cf7d982d-14d8a.png 1185w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<ul>\n<li>节点（Node）：一个节点是一个运行 Kubernetes 中的主机。</li>\n<li>容器组（Pod）：一个 Pod 对应于由若干容器组成的一个容器组，同个组内的容器共享一个存储卷(volume)。</li>\n<li>容器组生命周期（pos-states）：包含所有容器状态集合，包括容器组状态类型，容器组生命周期，事件，重启策略，以及 <code class="language-text">replication controllers</code>。</li>\n<li>Replication Controllers：主要负责指定数量的 pod 在同一时间一起运行。</li>\n<li>服务（services）：一个 Kubernetes 服务是容器组逻辑的高级抽象，同时也对外提供访问容器组的策略。</li>\n<li>卷（volumes）：一个卷就是一个目录，容器对其有访问权限。</li>\n<li>标签（labels）：标签是用来连接一组对象的，比如容器组。标签可以被用来组织和选择子对象。</li>\n<li>接口权限（<code class="language-text">accessing_the_api</code>）：端口，IP 地址和代理的防火墙规则。</li>\n<li>web 界面（ux）：用户可以通过 web 界面操作 Kubernetes。</li>\n<li>命令行操作（cli）：kubectl 命令。</li>\n</ul>\n<h3 id="节点-1"><a href="#%E8%8A%82%E7%82%B9-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>节点</h3>\n<p>在 Kubernetes 中，节点是实际工作的点，节点可以是虚拟机或者物理机器，依赖于一个集群环境。每个节点都有一些必要的服务以运行容器组，并且它们都可以通过主节点来管理。必要服务包括 Docker，kubelet 和代理服务。</p>\n<h4 id="容器状态"><a href="#%E5%AE%B9%E5%99%A8%E7%8A%B6%E6%80%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>容器状态</h4>\n<p>容器状态用来描述节点的当前状态。现在，其中包含三个信息：</p>\n<h5 id="主机-ip"><a href="#%E4%B8%BB%E6%9C%BA-ip" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>主机 IP</h5>\n<p>主机 IP 需要云平台来查询，Kubernetes 把它作为状态的一部分来保存。如果 Kubernetes 没有运行在云平台上，节点 ID 就是必需的。IP 地址可以变化，并且可以包含多种类型的 IP 地址，如公共 IP，私有 IP，动态 IP，ipv6 等等。</p>\n<h5 id="节点周期"><a href="#%E8%8A%82%E7%82%B9%E5%91%A8%E6%9C%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>节点周期</h5>\n<p>通常来说节点有 Pending，Running，Terminated 三个周期，如果 Kubernetes 发现了一个节点并且其可用，那么 Kubernetes 就把它标记为 Pending。然后在某个时刻，Kubernetes 将会标记其为 Running。节点的结束周期称为 Terminated。一个已经 Terminated 的节点不会接受和调度任何请求，并且已经在其上运行的容器组也会删除。</p>\n<h5 id="节点状态"><a href="#%E8%8A%82%E7%82%B9%E7%8A%B6%E6%80%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>节点状态</h5>\n<p>节点的状态主要是用来描述处于 Running 的节点。当前可用的有 NodeReachable 和 NodeReady。以后可能会增加其他状态。NodeReachable 表示集群可达。NodeReady 表示 kubelet 返回 Status Ok 并且 HTTP 状态检查健康。</p>\n<h4 id="节点管理"><a href="#%E8%8A%82%E7%82%B9%E7%AE%A1%E7%90%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>节点管理</h4>\n<p>节点并非 Kubernetes 创建，而是由云平台创建，或者就是物理机器、虚拟机。在 Kubernetes 中，节点仅仅是一条记录，节点创建之后，Kubernetes 会检查其是否可用。在 Kubernetes 中，节点用如下结构保存：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="2280048760041442000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`{\n  &quot;id&quot;: &quot;10.1.2.3&quot;,\n  &quot;kind&quot;: &quot;Minion&quot;,\n  &quot;apiVersion&quot;: &quot;v1beta1&quot;,\n  &quot;resources&quot;: {\n    &quot;capacity&quot;: {\n      &quot;cpu&quot;: 1000,\n      &quot;memory&quot;: 1073741824\n    }\n  },\n  &quot;labels&quot;: {\n    &quot;name&quot;: &quot;my-first-k8s-node&quot;\n  }\n}`, `2280048760041442000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="json"\n              >\n                <span class="gatsby-code-button-language">json</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="json"><pre style="counter-reset: linenumber NaN" class="language-json line-numbers"><code class="language-json"><span class="token punctuation">{</span>\n  <span class="token property">"id"</span><span class="token operator">:</span> <span class="token string">"10.1.2.3"</span><span class="token punctuation">,</span>\n  <span class="token property">"kind"</span><span class="token operator">:</span> <span class="token string">"Minion"</span><span class="token punctuation">,</span>\n  <span class="token property">"apiVersion"</span><span class="token operator">:</span> <span class="token string">"v1beta1"</span><span class="token punctuation">,</span>\n  <span class="token property">"resources"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n    <span class="token property">"capacity"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n      <span class="token property">"cpu"</span><span class="token operator">:</span> <span class="token number">1000</span><span class="token punctuation">,</span>\n      <span class="token property">"memory"</span><span class="token operator">:</span> <span class="token number">1073741824</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token property">"labels"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"my-first-k8s-node"</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Kubernetes 校验节点可用依赖于 ID。在当前的版本中，有两个接口可以用来管理节点：节点控制和 Kube 管理。</p>\n<h4 id="节点控制"><a href="#%E8%8A%82%E7%82%B9%E6%8E%A7%E5%88%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>节点控制</h4>\n<p>在 Kubernetes 主节点中，节点控制器是用来管理节点的组件。主要包含：</p>\n<ul>\n<li>集群范围内节点同步</li>\n<li>单节点生命周期管理</li>\n</ul>\n<p>节点控制有一个同步轮询，主要监听所有云平台的虚拟实例，会根据节点状态创建和删除。可以通过 <code class="language-text">--node_sync_period</code> 标志来控制该轮询。如果一个实例已经创建，节点控制将会为其创建一个结构。同样的，如果一个节点被删除，节点控制也会删除该结构。在 Kubernetes 启动时可用通过 <code class="language-text">--machines</code> 标记来显示指定节点。同样可以使用 kubectl 来一条一条的添加节点，两者是相同的。通过设置 <code class="language-text">--sync_nodes=false</code> 标记来禁止集群之间的节点同步，你也可以使用 <code class="language-text">api/kubectl</code> 命令行来增删节点。</p>\n<h3 id="容器组"><a href="#%E5%AE%B9%E5%99%A8%E7%BB%84" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>容器组</h3>\n<p>在 Kubernetes 中，使用的最小单位是容器组，容器组是创建，调度，管理的最小单位。一个容器组使用相同的 Docker 容器并共享卷（挂载点）。一个容器组是一个特定应用的打包集合，包含一个或多个容器。</p>\n<p>和运行的容器类似，一个容器组被认为只有很短的运行周期。容器组被调度到一组节点运行，直到容器的生命周期结束或者其被删除。如果节点死掉，运行在其上的容器组将会被删除而不是重新调度。（也许在将来的版本中会添加容器组的移动）。</p>\n<h4 id="容器组设计的初衷"><a href="#%E5%AE%B9%E5%99%A8%E7%BB%84%E8%AE%BE%E8%AE%A1%E7%9A%84%E5%88%9D%E8%A1%B7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>容器组设计的初衷</h4>\n<h4 id="资源共享和通信"><a href="#%E8%B5%84%E6%BA%90%E5%85%B1%E4%BA%AB%E5%92%8C%E9%80%9A%E4%BF%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>资源共享和通信</h4>\n<p>容器组主要是为了数据共享和它们之间的通信。</p>\n<p>在一个容器组中，容器都使用相同的网络地址和端口，可以通过本地网络来相互通信。每个容器组都有独立的 IP，可用通过网络来和其他物理主机或者容器通信。</p>\n<p>容器组有一组存储卷（挂载点），主要是为了让容器在重启之后可以不丢失数据。</p>\n<h4 id="容器组管理"><a href="#%E5%AE%B9%E5%99%A8%E7%BB%84%E7%AE%A1%E7%90%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>容器组管理</h4>\n<p>容器组是一个应用管理和部署的高层次抽象，同时也是一组容器的接口。容器组是部署、水平放缩的最小单位。</p>\n<h4 id="容器组的使用"><a href="#%E5%AE%B9%E5%99%A8%E7%BB%84%E7%9A%84%E4%BD%BF%E7%94%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>容器组的使用</h4>\n<p>容器组可以通过组合来构建复杂的应用，其本来的意义包含：</p>\n<ul>\n<li>内容管理，文件和数据加载以及本地缓存管理等。</li>\n<li>日志和检查点备份，压缩，快照等。</li>\n<li>监听数据变化，跟踪日志，日志和监控代理，消息发布等。</li>\n<li>代理，网桥</li>\n<li>控制器，管理，配置以及更新</li>\n</ul>\n<h4 id="替代方案"><a href="#%E6%9B%BF%E4%BB%A3%E6%96%B9%E6%A1%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>替代方案</h4>\n<p>为什么不在一个单一的容器里运行多个程序？</p>\n<ul>\n<li>透明化。为了使容器组中的容器保持一致的基础设施和服务，比如进程管理和资源监控。这样设计是为了用户的便利性。</li>\n<li>解偶软件之间的依赖。每个容器都可能重新构建和发布，Kubernetes 必须支持热发布和热更新（将来）。</li>\n<li>方便使用。用户不必运行独立的程序管理，也不用担心每个应用程序的退出状态。</li>\n<li>高效。考虑到基础设施有更多的职责，容器必须要轻量化。</li>\n</ul>\n<h4 id="容器组的生命状态"><a href="#%E5%AE%B9%E5%99%A8%E7%BB%84%E7%9A%84%E7%94%9F%E5%91%BD%E7%8A%B6%E6%80%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>容器组的生命状态</h4>\n<p>包括若干状态值：pending、running、succeeded、failed。</p>\n<h5 id="pending"><a href="#pending" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>pending</h5>\n<p>容器组已经被节点接受，但有一个或多个容器还没有运行起来。这将包含某些节点正在下载镜像的时间，这种情形会依赖于网络情况。</p>\n<h5 id="running"><a href="#running" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>running</h5>\n<p>容器组已经被调度到节点，并且所有的容器都已经启动。至少有一个容器处于运行状态（或者处于重启状态）。</p>\n<h5 id="succeeded"><a href="#succeeded" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>succeeded</h5>\n<p>所有的容器都正常退出。</p>\n<h5 id="failed"><a href="#failed" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>failed</h5>\n<p>容器组中所有容器都意外中断了。</p>\n<h4 id="容器组生命周期"><a href="#%E5%AE%B9%E5%99%A8%E7%BB%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>容器组生命周期</h4>\n<p>通常来说，如果容器组被创建了就不会自动销毁，除非被某种行为触发，而触发此种情况可能是人为，或者复制控制器所为。唯一例外的是容器组由 succeeded 状态成功退出，或者在一定时间内重试多次依然失败。</p>\n<p>如果某个节点死掉或者不能连接，那么节点控制器将会标记其上的容器组的状态为 failed。</p>\n<p>举例如下：</p>\n<ul>\n<li>\n<p>容器组状态 running，有 1 容器，容器正常退出</p>\n<ul>\n<li>记录完成事件</li>\n<li>\n<p>如果重启策略为：</p>\n<ul>\n<li>始终：重启容器，容器组保持 running</li>\n<li>失败时：容器组变为 succeeded</li>\n<li>从不：容器组变为 succeeded</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p>容器组状态 running，有 1 容器，容器异常退出</p>\n<ul>\n<li>记录失败事件</li>\n<li>\n<p>如果重启策略为：</p>\n<ul>\n<li>始终：重启容器，容器组保持 running</li>\n<li>失败时：重启容器，容器组保持 running</li>\n<li>从不：容器组变为 failed</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p>容器组状态 running，有 2 容器，有 1 容器异常退出</p>\n<ul>\n<li>记录失败事件</li>\n<li>\n<p>如果重启策略为：</p>\n<ul>\n<li>始终：重启容器，容器组保持 running</li>\n<li>失败时：重启容器，容器组保持 running</li>\n<li>从不：容器组保持 running</li>\n</ul>\n</li>\n<li>\n<p>当有 2 容器退出</p>\n<ul>\n<li>记录失败事件</li>\n<li>如果重启策略为：</li>\n<li>始终：重启容器，容器组保持 running</li>\n<li>失败时：重启容器，容器组保持 running</li>\n<li>从不：容器组变为 failed</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p>容器组状态 running，容器内存不足</p>\n<ul>\n<li>标记容器错误中断</li>\n<li>记录内存不足事件</li>\n<li>\n<p>如果重启策略为：</p>\n<ul>\n<li>始终：重启容器，容器组保持 running</li>\n<li>失败时：重启容器，容器组保持 running</li>\n<li>从不：记录错误事件，容器组变为 failed</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p>容器组状态 running，一块磁盘死掉</p>\n<ul>\n<li>杀死所有容器</li>\n<li>记录事件</li>\n<li>容器组变为 failed</li>\n<li>如果容器组运行在一个控制器下，容器组将会在其他地方重新创建</li>\n</ul>\n</li>\n<li>\n<p>容器组状态 running，对应的节点段溢出</p>\n<ul>\n<li>节点控制器等到超时</li>\n<li>节点控制器标记容器组 failed</li>\n<li>如果容器组运行在一个控制器下，容器组将会在其他地方重新创建</li>\n</ul>\n</li>\n</ul>\n<h3 id="replication-controllers"><a href="#replication-controllers" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Replication Controllers</h3>\n<h3 id="服务"><a href="#%E6%9C%8D%E5%8A%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>服务</h3>\n<h3 id="卷"><a href="#%E5%8D%B7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>卷</h3>\n<h3 id="标签"><a href="#%E6%A0%87%E7%AD%BE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>标签</h3>\n<h3 id="接口权限"><a href="#%E6%8E%A5%E5%8F%A3%E6%9D%83%E9%99%90" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>接口权限</h3>\n<h3 id="web-界面"><a href="#web-%E7%95%8C%E9%9D%A2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>web 界面</h3>\n<h3 id="命令行操作"><a href="#%E5%91%BD%E4%BB%A4%E8%A1%8C%E6%93%8D%E4%BD%9C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>命令行操作</h3>\n<h2 id="基本架构"><a href="#%E5%9F%BA%E6%9C%AC%E6%9E%B6%E6%9E%84" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>基本架构</h2>\n<p>任何优秀的项目都离不开优秀的架构设计。本小节将介绍 Kubernetes 在架构方面的设计考虑。</p>\n<h3 id="基本考虑"><a href="#%E5%9F%BA%E6%9C%AC%E8%80%83%E8%99%91" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>基本考虑</h3>\n<p>如果让我们自己从头设计一套容器管理平台，有如下几个方面是很容易想到的：</p>\n<ul>\n<li>分布式架构，保证扩展性；</li>\n<li>逻辑集中式的控制平面 + 物理分布式的运行平面；</li>\n<li>一套资源调度系统，管理哪个容器该分配到哪个节点上；</li>\n<li>一套对容器内服务进行抽象和 HA 的系统。</li>\n</ul>\n<h3 id="运行原理"><a href="#%E8%BF%90%E8%A1%8C%E5%8E%9F%E7%90%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>运行原理</h3>\n<p>下面这张图完整展示了 Kubernetes 的运行原理。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-07-21-14-00-05-f49072d59e00b9dd169b21a1f7c9363c-ed8e3.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 82.67736274755578%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAAAsSAAALEgHS3X78AAAC4UlEQVQ4y42Uy05TURSGdwvWBJo4cWhECZBooi/gSAdoQuLYqT6FM57AARMMjVPHJAQmJISJRDgoLeV+v5VLaSm3trQ9N79/E0ghxLCSlb332nv961+Xc4xB1tbWIhsbG43r6+uNrFHZPM8z6XTa1Mvy8rJde3p6HuRyudT+/n63zmEYRsfGxi4fraysmNtSLpdvnMfHx83BwYE5OjqK7OzsCEAkupaWll7p/vj4OHJycmLOz88vHVZXV5/B7CvaDcuPVwxnZ2fN4OCguUscx/kyMTHRcecljo9I7w0P3i4uLrbLVq1Wzfz8vL0fGBiIwLAZZvHt7e347u5u8+joaAs+jyHQBKG4FNZxs7e313A7QCaTaSCF6NzcnL2bnp5+AmCGuhUqlUrO9/085+zZ2VmOTPIEz9dqNbua+whpt1FXF4CwVCqFOIfUK8QWAh7Wi6FT74n2nvp9SKVSXbDozOfznTDsmpqaei3AycnJFoBKNEVA/unpqY+PzxufhvjZbNbatDeKIAUkJNXw4uJC50DRAPghwIWFheewK1KesFAoeDh7AHoAeJTAg5QHuAewZw4PDwMeBwAGOASABMVisSZA13W/CZDmtCpFnG2q2MOr9CWy4WPVkGIgUNADGAZECxRZD2Hxl0CfacpTGPzGMY1TErAUq9X6PW9SGlJ3a2vLBdCFnQu4i6MLUFkReRRubm42UccGhvphb29vTEoZYkNDQ7G+vr5YIpGw2t/fHzO3u1QvMHUAeceMtVK7XwT8w2g4pOywdwho95TCkV2q7zMBuwT1SDAGV/qdy5+AfVINYduhumlMmDsbjPvr/Y2xuYdEh4eHXxCwrMapw+qoOquOw9SjTLbjlMozGKP6W9ylFNx+KSMjIy8BqgKi7gpUDbsebu0BtJ03DLNJJpM3lIE2MzMzhu80IkDWNpwrGmxNhRwFotlV6jAMFUwB/psrzbCA/ATaSbMiNjgFcrxLxfwfA8qR2IgatHIAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 07 21 14 00 05" title="" data-src="/static/2022-07-21-14-00-05-f49072d59e00b9dd169b21a1f7c9363c-fee1c.png" data-srcset="/static/2022-07-21-14-00-05-f49072d59e00b9dd169b21a1f7c9363c-a67b7.png 200w,\n/static/2022-07-21-14-00-05-f49072d59e00b9dd169b21a1f7c9363c-0b187.png 400w,\n/static/2022-07-21-14-00-05-f49072d59e00b9dd169b21a1f7c9363c-fee1c.png 800w,\n/static/2022-07-21-14-00-05-f49072d59e00b9dd169b21a1f7c9363c-b1a91.png 1200w,\n/static/2022-07-21-14-00-05-f49072d59e00b9dd169b21a1f7c9363c-95179.png 1600w,\n/static/2022-07-21-14-00-05-f49072d59e00b9dd169b21a1f7c9363c-5d5ba.png 2400w,\n/static/2022-07-21-14-00-05-f49072d59e00b9dd169b21a1f7c9363c-ed8e3.png 3989w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>可见，Kubernetes 首先是一套分布式系统，由多个节点组成，节点分为两类：一类是属于管理平面的主节点/控制节点（Master Node）；一类是属于运行平面的工作节点（Worker Node）。</p>\n<p>显然，复杂的工作肯定都交给控制节点去做了，工作节点负责提供稳定的操作接口和能力抽象即可。</p>\n<p>从这张图上，我们没有能发现 Kubernetes 中对于控制平面的分布式实现，但是由于数据后端自身就是一套分布式的数据库 Etcd，因此可以很容易扩展到分布式实现。</p>\n<h3 id="控制平面"><a href="#%E6%8E%A7%E5%88%B6%E5%B9%B3%E9%9D%A2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>控制平面</h3>\n<h4 id="主节点服务"><a href="#%E4%B8%BB%E8%8A%82%E7%82%B9%E6%9C%8D%E5%8A%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>主节点服务</h4>\n<p>主节点上需要提供如下的管理服务：</p>\n<ul>\n<li>apiserver 是整个系统的对外接口，提供一套 RESTful 的 Kubernetes API，供客户端和其它组件调用；</li>\n<li>scheduler 负责对资源进行调度，分配某个 pod 到某个节点上。是 pluggable 的，意味着很容易选择其它实现方式；</li>\n<li>controller-manager 负责管理控制器，包括 endpoint-controller（刷新服务和 pod 的关联信息）和 replication-controller（维护某个 pod 的复制为配置的数值）。</li>\n</ul>\n<h4 id="etcd"><a href="#etcd" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Etcd</h4>\n<p>这里 Etcd 即作为数据后端，又作为消息中间件。</p>\n<p>通过 Etcd 来存储所有的主节点上的状态信息，很容易实现主节点的分布式扩展。</p>\n<p>组件可以自动的去侦测 Etcd 中的数值变化来获得通知，并且获得更新后的数据来执行相应的操作。</p>\n<h3 id="工作节点"><a href="#%E5%B7%A5%E4%BD%9C%E8%8A%82%E7%82%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>工作节点</h3>\n<ul>\n<li>kubelet 是工作节点执行操作的 agent，负责具体的容器生命周期管理，根据从数据库中获取的信息来管理容器，并上报 pod 运行状态等；</li>\n<li>kube-proxy 是一个简单的网络访问代理，同时也是一个 Load Balancer。它负责将访问到某个服务的请求具体分配给工作节点上的 Pod（同一类标签）。</li>\n</ul>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-07-21-14-00-36-02375bb48eb8832038944c257631be5a-80d40.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 640px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 77.1875%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsSAAALEgHS3X78AAADY0lEQVQ4y2MonHnQpnTZpf9Va2//r914/3/Fymv/q9bf/V+05PzhgoVn5lRvuPe/Yu2tP+Wrb/wvXnbxD5D9P2/+iVYg+yGIXbnuzr+ylVf/lwDNKF568T+DUu1s5czFZ18Vb7j3JnvZxVeF6++8bN7/8X/p8ssnMqbunV+/7RlI02+ghn91W5/+a9777n/GtL3d+QtOPa3b+uR/yfLL/yuBjmnc+Qqo7vZ/hl1zTk5cMe/U4ZULzhxeNf/M4XVLLh7qXHwh0ia+3NnILcy3YftTq4Di/lDX5Jrkmo33LIuWnHVUM3f1jW5eZle64qpN7pyjtkCXWQN9YJM5fZ8dw/X1D/9fXH4dhP9dXnnz//1Nz/6enrxXlwECOBgQgBNKcwExPxAzAzEjkjp2MKshs12zLLnBpDSpzqwyrdkkI6LQTExURpeTn1vr////LN4pjnLOkVaywXkekv4ZLtJGzgYyyvqq3Hyi8jySKjo8UmoGXIIS8gLCMsp8weXTmGE2iwGxFBCLwFw1cU9GxdbXTf+nH835v+hyyf/5F4r+zT1b+H/rm6b/884VhoDUAC1kwADetv7MtoYOrJKi0jwiAqL8Ztb6PCDx7m0pXosvl66df6541oyjeSu7t6TumHe2eP6iy6Uru7YkW4LUaJnLsUMdxMaABUgAsSIQK7BzsqlD+UxQORkgZoGyRYGeUOTm4xAEsnmBWBqIBbAZCPI/s4KCPAvMoK4JraqXr1zacPrMqZ3HTx7L2Xdgb45PmLMIA6lAXl6B6caNG7vfvn37//v37/+fPHkCxv/+/ft///69g6dPn45Ys2YNKKYZvLy8GHEaNG3aNBiT8dq1a8sfPXr4GGjAuxfPn/8Hsv8D6S8/f/78//Lly/8HDx50hEYMI17XnTp7EYV/+sZH8WUr1pbOmLMkpK5rgcyaDTuc5s2bpwmUYuXh4WFjYmJigaZBTINfvHjBkGgLYffVJbLtmZdmfHZFsk55tKrlhCJrm74SV+fcUE1raMwKMTIyCEEjRhxkAYaBpaWlDCv7YsE2tRZ6yb480vD14b7a/+fXF/8/targz8sjjf8f7a97uXdJGTfREdJZ4g02MD/OVnbX3PRv+xZk/t8+K/X/pmlJ/w8uyvq/eXrym5oMF3BaTQo2w/AmALXvklkCjk1AAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 07 21 14 00 36" title="" data-src="/static/2022-07-21-14-00-36-02375bb48eb8832038944c257631be5a-80d40.png" data-srcset="/static/2022-07-21-14-00-36-02375bb48eb8832038944c257631be5a-5da91.png 200w,\n/static/2022-07-21-14-00-36-02375bb48eb8832038944c257631be5a-08121.png 400w,\n/static/2022-07-21-14-00-36-02375bb48eb8832038944c257631be5a-80d40.png 640w" data-sizes="(max-width: 640px) 100vw, 640px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h2 id="部署-kubernetes"><a href="#%E9%83%A8%E7%BD%B2-kubernetes" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>部署 Kubernetes</h2>\n<p>目前，Kubernetes 支持在多种环境下使用，包括本地主机（Ubuntu、Debian、CentOS、Fedora 等）、云服务（腾讯云、阿里云、百度云等）。</p>\n<p>你可以使用以下几种方式部署 Kubernetes：</p>\n<ul>\n<li>kubeadm</li>\n<li>docker-desktop</li>\n<li>k3s</li>\n</ul>\n<p>接下来的小节会对以上几种方式进行详细介绍。</p>\n<h3 id="使用-kubeadm-部署-kubernetescri-使用-containerd"><a href="#%E4%BD%BF%E7%94%A8-kubeadm-%E9%83%A8%E7%BD%B2-kubernetescri-%E4%BD%BF%E7%94%A8-containerd" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用 kubeadm 部署 kubernetes(CRI 使用 containerd)</h3>\n<p>kubeadm 提供了 kubeadm init 以及 kubeadm join 这两个命令作为快速创建 kubernetes 集群的最佳实践。</p>\n<h4 id="安装-containerd"><a href="#%E5%AE%89%E8%A3%85-containerd" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>安装 containerd</h4>\n<p>参考 安装 Docker 一节添加 <code class="language-text">apt/yum</code> 源，之后执行如下命令。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="24384838446094490000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# debian 系\n\\$ sudo apt install containerd.io\n\n# rhel 系\n\\$ sudo yum install containerd.io`, `24384838446094490000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token comment"># debian 系</span>\n$ <span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> containerd.io\n\n<span class="token comment"># rhel 系</span>\n$ <span class="token function">sudo</span> yum <span class="token function">install</span> containerd.io</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="配置-containerd"><a href="#%E9%85%8D%E7%BD%AE-containerd" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>配置 containerd</h4>\n<p>新建 <code class="language-text">/etc/systemd/system/cri-containerd.service</code> 文件</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="85521177795441130000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`[Unit]\nDescription=containerd container runtime for kubernetes\nDocumentation=https://containerd.io\nAfter=network.target local-fs.target\n\n[Service]\nExecStartPre=-/sbin/modprobe overlay\nExecStart=/usr/bin/containerd --config //etc/cri-containerd/config.toml\n\nType=notify\nDelegate=yes\nKillMode=process\nRestart=always\nRestartSec=5\n# Having non-zero Limit*s causes performance problems due to accounting overhead\n# in the kernel. We recommend using cgroups to do container-local accounting.\nLimitNPROC=infinity\nLimitCORE=infinity\nLimitNOFILE=infinity\n# Comment TasksMax if your systemd version does not supports it.\n# Only systemd 226 and above support this version.\nTasksMax=infinity\nOOMScoreAdjust=-999\n\n[Install]\nWantedBy=multi-user.target`, `85521177795441130000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">[Unit]\nDescription=containerd container runtime for kubernetes\nDocumentation=https://containerd.io\nAfter=network.target local-fs.target\n\n[Service]\nExecStartPre=-/sbin/modprobe overlay\nExecStart=/usr/bin/containerd --config //etc/cri-containerd/config.toml\n\nType=notify\nDelegate=yes\nKillMode=process\nRestart=always\nRestartSec=5\n# Having non-zero Limit*s causes performance problems due to accounting overhead\n# in the kernel. We recommend using cgroups to do container-local accounting.\nLimitNPROC=infinity\nLimitCORE=infinity\nLimitNOFILE=infinity\n# Comment TasksMax if your systemd version does not supports it.\n# Only systemd 226 and above support this version.\nTasksMax=infinity\nOOMScoreAdjust=-999\n\n[Install]\nWantedBy=multi-user.target</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>新建 <code class="language-text">/etc/cri-containerd/config.toml</code> containerd 配置文件</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="30308288813213790000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`version = 2\n# persistent data location\nroot = &quot;/var/lib/cri-containerd&quot;\n# runtime state information\nstate = &quot;/run/cri-containerd&quot;\nplugin_dir = &quot;&quot;\ndisabled_plugins = []\nrequired_plugins = []\n# set containerd\'s OOM score\noom_score = 0\n\n[grpc]\n  address = &quot;/run/cri-containerd/cri-containerd.sock&quot;\n  tcp_address = &quot;&quot;\n  tcp_tls_cert = &quot;&quot;\n  tcp_tls_key = &quot;&quot;\n  # socket uid\n  uid = 0\n  # socket gid\n  gid = 0\n  max_recv_message_size = 16777216\n  max_send_message_size = 16777216\n\n[debug]\n  address = &quot;&quot;\n  format = &quot;json&quot;\n  uid = 0\n  gid = 0\n  level = &quot;&quot;\n\n[metrics]\n  address = &quot;127.0.0.1:1338&quot;\n  grpc_histogram = false\n\n[cgroup]\n  path = &quot;&quot;\n\n[timeouts]\n  &quot;io.containerd.timeout.shim.cleanup&quot; = &quot;5s&quot;\n  &quot;io.containerd.timeout.shim.load&quot; = &quot;5s&quot;\n  &quot;io.containerd.timeout.shim.shutdown&quot; = &quot;3s&quot;\n  &quot;io.containerd.timeout.task.state&quot; = &quot;2s&quot;\n\n[plugins]\n  [plugins.&quot;io.containerd.gc.v1.scheduler&quot;]\n    pause_threshold = 0.02\n    deletion_threshold = 0\n    mutation_threshold = 100\n    schedule_delay = &quot;0s&quot;\n    startup_delay = &quot;100ms&quot;\n  [plugins.&quot;io.containerd.grpc.v1.cri&quot;]\n    disable_tcp_service = true\n    stream_server_address = &quot;127.0.0.1&quot;\n    stream_server_port = &quot;0&quot;\n    stream_idle_timeout = &quot;4h0m0s&quot;\n    enable_selinux = false\n    selinux_category_range = 1024\n    sandbox_image = &quot;registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.5&quot;\n    stats_collect_period = 10\n    # systemd_cgroup = false\n    enable_tls_streaming = false\n    max_container_log_line_size = 16384\n    disable_cgroup = false\n    disable_apparmor = false\n    restrict_oom_score_adj = false\n    max_concurrent_downloads = 3\n    disable_proc_mount = false\n    unset_seccomp_profile = &quot;&quot;\n    tolerate_missing_hugetlb_controller = true\n    disable_hugetlb_controller = true\n    ignore_image_defined_volumes = false\n    [plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd]\n      snapshotter = &quot;overlayfs&quot;\n      default_runtime_name = &quot;runc&quot;\n      no_pivot = false\n      disable_snapshot_annotations = false\n      discard_unpacked_layers = false\n      [plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes]\n        [plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes.runc]\n          runtime_type = &quot;io.containerd.runc.v2&quot;\n          pod_annotations = []\n          container_annotations = []\n          privileged_without_host_devices = false\n          base_runtime_spec = &quot;&quot;\n          [plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes.runc.options]\n            # SystemdCgroup enables systemd cgroups.\n            SystemdCgroup = true\n            # BinaryName is the binary name of the runc binary.\n            # BinaryName = &quot;runc&quot;\n            # BinaryName = &quot;crun&quot;\n            # NoPivotRoot disables pivot root when creating a container.\n            # NoPivotRoot = false\n\n            # NoNewKeyring disables new keyring for the container.\n            # NoNewKeyring = false\n\n            # ShimCgroup places the shim in a cgroup.\n            # ShimCgroup = &quot;&quot;\n\n            # IoUid sets the I/O\'s pipes uid.\n            # IoUid = 0\n\n            # IoGid sets the I/O\'s pipes gid.\n            # IoGid = 0\n\n            # Root is the runc root directory.\n            Root = &quot;&quot;\n\n            # CriuPath is the criu binary path.\n            # CriuPath = &quot;&quot;\n\n            # CriuImagePath is the criu image path\n            # CriuImagePath = &quot;&quot;\n\n            # CriuWorkPath is the criu work path.\n            # CriuWorkPath = &quot;&quot;\n    [plugins.&quot;io.containerd.grpc.v1.cri&quot;.cni]\n      bin_dir = &quot;/opt/cni/bin&quot;\n      conf_dir = &quot;/etc/cni/net.d&quot;\n      max_conf_num = 1\n      conf_template = &quot;&quot;\n    [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry]\n      config_path = &quot;/etc/cri-containerd/certs.d&quot;\n      [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.headers]\n        # Foo = [&quot;bar&quot;]\n    [plugins.&quot;io.containerd.grpc.v1.cri&quot;.image_decryption]\n      key_model = &quot;&quot;\n    [plugins.&quot;io.containerd.grpc.v1.cri&quot;.x509_key_pair_streaming]\n      tls_cert_file = &quot;&quot;\n      tls_key_file = &quot;&quot;\n  [plugins.&quot;io.containerd.internal.v1.opt&quot;]\n    path = &quot;/opt/cri-containerd&quot;\n  [plugins.&quot;io.containerd.internal.v1.restart&quot;]\n    interval = &quot;10s&quot;\n  [plugins.&quot;io.containerd.metadata.v1.bolt&quot;]\n    content_sharing_policy = &quot;shared&quot;\n  [plugins.&quot;io.containerd.monitor.v1.cgroups&quot;]\n    no_prometheus = false\n  [plugins.&quot;io.containerd.runtime.v2.task&quot;]\n    platforms = [&quot;linux/amd64&quot;]\n  [plugins.&quot;io.containerd.service.v1.diff-service&quot;]\n    default = [&quot;walking&quot;]\n  [plugins.&quot;io.containerd.snapshotter.v1.devmapper&quot;]\n    root_path = &quot;&quot;\n    pool_name = &quot;&quot;\n    base_image_size = &quot;&quot;\n    async_remove = false`, `30308288813213790000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="toml"\n              >\n                <span class="gatsby-code-button-language">toml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="toml"><pre style="counter-reset: linenumber NaN" class="language-toml line-numbers"><code class="language-toml"><span class="token key property">version</span> <span class="token punctuation">=</span> <span class="token number">2</span>\n<span class="token comment"># persistent data location</span>\n<span class="token key property">root</span> <span class="token punctuation">=</span> <span class="token string">"/var/lib/cri-containerd"</span>\n<span class="token comment"># runtime state information</span>\n<span class="token key property">state</span> <span class="token punctuation">=</span> <span class="token string">"/run/cri-containerd"</span>\n<span class="token key property">plugin_dir</span> <span class="token punctuation">=</span> <span class="token string">""</span>\n<span class="token key property">disabled_plugins</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n<span class="token key property">required_plugins</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n<span class="token comment"># set containerd\'s OOM score</span>\n<span class="token key property">oom_score</span> <span class="token punctuation">=</span> <span class="token number">0</span>\n\n<span class="token punctuation">[</span><span class="token table class-name">grpc</span><span class="token punctuation">]</span>\n  <span class="token key property">address</span> <span class="token punctuation">=</span> <span class="token string">"/run/cri-containerd/cri-containerd.sock"</span>\n  <span class="token key property">tcp_address</span> <span class="token punctuation">=</span> <span class="token string">""</span>\n  <span class="token key property">tcp_tls_cert</span> <span class="token punctuation">=</span> <span class="token string">""</span>\n  <span class="token key property">tcp_tls_key</span> <span class="token punctuation">=</span> <span class="token string">""</span>\n  <span class="token comment"># socket uid</span>\n  <span class="token key property">uid</span> <span class="token punctuation">=</span> <span class="token number">0</span>\n  <span class="token comment"># socket gid</span>\n  <span class="token key property">gid</span> <span class="token punctuation">=</span> <span class="token number">0</span>\n  <span class="token key property">max_recv_message_size</span> <span class="token punctuation">=</span> <span class="token number">16777216</span>\n  <span class="token key property">max_send_message_size</span> <span class="token punctuation">=</span> <span class="token number">16777216</span>\n\n<span class="token punctuation">[</span><span class="token table class-name">debug</span><span class="token punctuation">]</span>\n  <span class="token key property">address</span> <span class="token punctuation">=</span> <span class="token string">""</span>\n  <span class="token key property">format</span> <span class="token punctuation">=</span> <span class="token string">"json"</span>\n  <span class="token key property">uid</span> <span class="token punctuation">=</span> <span class="token number">0</span>\n  <span class="token key property">gid</span> <span class="token punctuation">=</span> <span class="token number">0</span>\n  <span class="token key property">level</span> <span class="token punctuation">=</span> <span class="token string">""</span>\n\n<span class="token punctuation">[</span><span class="token table class-name">metrics</span><span class="token punctuation">]</span>\n  <span class="token key property">address</span> <span class="token punctuation">=</span> <span class="token string">"127.0.0.1:1338"</span>\n  <span class="token key property">grpc_histogram</span> <span class="token punctuation">=</span> <span class="token boolean">false</span>\n\n<span class="token punctuation">[</span><span class="token table class-name">cgroup</span><span class="token punctuation">]</span>\n  <span class="token key property">path</span> <span class="token punctuation">=</span> <span class="token string">""</span>\n\n<span class="token punctuation">[</span><span class="token table class-name">timeouts</span><span class="token punctuation">]</span>\n  <span class="token key property">"io.containerd.timeout.shim.cleanup"</span> <span class="token punctuation">=</span> <span class="token string">"5s"</span>\n  <span class="token key property">"io.containerd.timeout.shim.load"</span> <span class="token punctuation">=</span> <span class="token string">"5s"</span>\n  <span class="token key property">"io.containerd.timeout.shim.shutdown"</span> <span class="token punctuation">=</span> <span class="token string">"3s"</span>\n  <span class="token key property">"io.containerd.timeout.task.state"</span> <span class="token punctuation">=</span> <span class="token string">"2s"</span>\n\n<span class="token punctuation">[</span><span class="token table class-name">plugins</span><span class="token punctuation">]</span>\n  <span class="token punctuation">[</span><span class="token table class-name">plugins."io.containerd.gc.v1.scheduler"</span><span class="token punctuation">]</span>\n    <span class="token key property">pause_threshold</span> <span class="token punctuation">=</span> <span class="token number">0.02</span>\n    <span class="token key property">deletion_threshold</span> <span class="token punctuation">=</span> <span class="token number">0</span>\n    <span class="token key property">mutation_threshold</span> <span class="token punctuation">=</span> <span class="token number">100</span>\n    <span class="token key property">schedule_delay</span> <span class="token punctuation">=</span> <span class="token string">"0s"</span>\n    <span class="token key property">startup_delay</span> <span class="token punctuation">=</span> <span class="token string">"100ms"</span>\n  <span class="token punctuation">[</span><span class="token table class-name">plugins."io.containerd.grpc.v1.cri"</span><span class="token punctuation">]</span>\n    <span class="token key property">disable_tcp_service</span> <span class="token punctuation">=</span> <span class="token boolean">true</span>\n    <span class="token key property">stream_server_address</span> <span class="token punctuation">=</span> <span class="token string">"127.0.0.1"</span>\n    <span class="token key property">stream_server_port</span> <span class="token punctuation">=</span> <span class="token string">"0"</span>\n    <span class="token key property">stream_idle_timeout</span> <span class="token punctuation">=</span> <span class="token string">"4h0m0s"</span>\n    <span class="token key property">enable_selinux</span> <span class="token punctuation">=</span> <span class="token boolean">false</span>\n    <span class="token key property">selinux_category_range</span> <span class="token punctuation">=</span> <span class="token number">1024</span>\n    <span class="token key property">sandbox_image</span> <span class="token punctuation">=</span> <span class="token string">"registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.5"</span>\n    <span class="token key property">stats_collect_period</span> <span class="token punctuation">=</span> <span class="token number">10</span>\n    <span class="token comment"># systemd_cgroup = false</span>\n    <span class="token key property">enable_tls_streaming</span> <span class="token punctuation">=</span> <span class="token boolean">false</span>\n    <span class="token key property">max_container_log_line_size</span> <span class="token punctuation">=</span> <span class="token number">16384</span>\n    <span class="token key property">disable_cgroup</span> <span class="token punctuation">=</span> <span class="token boolean">false</span>\n    <span class="token key property">disable_apparmor</span> <span class="token punctuation">=</span> <span class="token boolean">false</span>\n    <span class="token key property">restrict_oom_score_adj</span> <span class="token punctuation">=</span> <span class="token boolean">false</span>\n    <span class="token key property">max_concurrent_downloads</span> <span class="token punctuation">=</span> <span class="token number">3</span>\n    <span class="token key property">disable_proc_mount</span> <span class="token punctuation">=</span> <span class="token boolean">false</span>\n    <span class="token key property">unset_seccomp_profile</span> <span class="token punctuation">=</span> <span class="token string">""</span>\n    <span class="token key property">tolerate_missing_hugetlb_controller</span> <span class="token punctuation">=</span> <span class="token boolean">true</span>\n    <span class="token key property">disable_hugetlb_controller</span> <span class="token punctuation">=</span> <span class="token boolean">true</span>\n    <span class="token key property">ignore_image_defined_volumes</span> <span class="token punctuation">=</span> <span class="token boolean">false</span>\n    <span class="token punctuation">[</span><span class="token table class-name">plugins."io.containerd.grpc.v1.cri".containerd</span><span class="token punctuation">]</span>\n      <span class="token key property">snapshotter</span> <span class="token punctuation">=</span> <span class="token string">"overlayfs"</span>\n      <span class="token key property">default_runtime_name</span> <span class="token punctuation">=</span> <span class="token string">"runc"</span>\n      <span class="token key property">no_pivot</span> <span class="token punctuation">=</span> <span class="token boolean">false</span>\n      <span class="token key property">disable_snapshot_annotations</span> <span class="token punctuation">=</span> <span class="token boolean">false</span>\n      <span class="token key property">discard_unpacked_layers</span> <span class="token punctuation">=</span> <span class="token boolean">false</span>\n      <span class="token punctuation">[</span><span class="token table class-name">plugins."io.containerd.grpc.v1.cri".containerd.runtimes</span><span class="token punctuation">]</span>\n        <span class="token punctuation">[</span><span class="token table class-name">plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc</span><span class="token punctuation">]</span>\n          <span class="token key property">runtime_type</span> <span class="token punctuation">=</span> <span class="token string">"io.containerd.runc.v2"</span>\n          <span class="token key property">pod_annotations</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n          <span class="token key property">container_annotations</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n          <span class="token key property">privileged_without_host_devices</span> <span class="token punctuation">=</span> <span class="token boolean">false</span>\n          <span class="token key property">base_runtime_spec</span> <span class="token punctuation">=</span> <span class="token string">""</span>\n          <span class="token punctuation">[</span><span class="token table class-name">plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc.options</span><span class="token punctuation">]</span>\n            <span class="token comment"># SystemdCgroup enables systemd cgroups.</span>\n            <span class="token key property">SystemdCgroup</span> <span class="token punctuation">=</span> <span class="token boolean">true</span>\n            <span class="token comment"># BinaryName is the binary name of the runc binary.</span>\n            <span class="token comment"># BinaryName = "runc"</span>\n            <span class="token comment"># BinaryName = "crun"</span>\n            <span class="token comment"># NoPivotRoot disables pivot root when creating a container.</span>\n            <span class="token comment"># NoPivotRoot = false</span>\n\n            <span class="token comment"># NoNewKeyring disables new keyring for the container.</span>\n            <span class="token comment"># NoNewKeyring = false</span>\n\n            <span class="token comment"># ShimCgroup places the shim in a cgroup.</span>\n            <span class="token comment"># ShimCgroup = ""</span>\n\n            <span class="token comment"># IoUid sets the I/O\'s pipes uid.</span>\n            <span class="token comment"># IoUid = 0</span>\n\n            <span class="token comment"># IoGid sets the I/O\'s pipes gid.</span>\n            <span class="token comment"># IoGid = 0</span>\n\n            <span class="token comment"># Root is the runc root directory.</span>\n            <span class="token key property">Root</span> <span class="token punctuation">=</span> <span class="token string">""</span>\n\n            <span class="token comment"># CriuPath is the criu binary path.</span>\n            <span class="token comment"># CriuPath = ""</span>\n\n            <span class="token comment"># CriuImagePath is the criu image path</span>\n            <span class="token comment"># CriuImagePath = ""</span>\n\n            <span class="token comment"># CriuWorkPath is the criu work path.</span>\n            <span class="token comment"># CriuWorkPath = ""</span>\n    <span class="token punctuation">[</span><span class="token table class-name">plugins."io.containerd.grpc.v1.cri".cni</span><span class="token punctuation">]</span>\n      <span class="token key property">bin_dir</span> <span class="token punctuation">=</span> <span class="token string">"/opt/cni/bin"</span>\n      <span class="token key property">conf_dir</span> <span class="token punctuation">=</span> <span class="token string">"/etc/cni/net.d"</span>\n      <span class="token key property">max_conf_num</span> <span class="token punctuation">=</span> <span class="token number">1</span>\n      <span class="token key property">conf_template</span> <span class="token punctuation">=</span> <span class="token string">""</span>\n    <span class="token punctuation">[</span><span class="token table class-name">plugins."io.containerd.grpc.v1.cri".registry</span><span class="token punctuation">]</span>\n      <span class="token key property">config_path</span> <span class="token punctuation">=</span> <span class="token string">"/etc/cri-containerd/certs.d"</span>\n      <span class="token punctuation">[</span><span class="token table class-name">plugins."io.containerd.grpc.v1.cri".registry.headers</span><span class="token punctuation">]</span>\n        <span class="token comment"># Foo = ["bar"]</span>\n    <span class="token punctuation">[</span><span class="token table class-name">plugins."io.containerd.grpc.v1.cri".image_decryption</span><span class="token punctuation">]</span>\n      <span class="token key property">key_model</span> <span class="token punctuation">=</span> <span class="token string">""</span>\n    <span class="token punctuation">[</span><span class="token table class-name">plugins."io.containerd.grpc.v1.cri".x509_key_pair_streaming</span><span class="token punctuation">]</span>\n      <span class="token key property">tls_cert_file</span> <span class="token punctuation">=</span> <span class="token string">""</span>\n      <span class="token key property">tls_key_file</span> <span class="token punctuation">=</span> <span class="token string">""</span>\n  <span class="token punctuation">[</span><span class="token table class-name">plugins."io.containerd.internal.v1.opt"</span><span class="token punctuation">]</span>\n    <span class="token key property">path</span> <span class="token punctuation">=</span> <span class="token string">"/opt/cri-containerd"</span>\n  <span class="token punctuation">[</span><span class="token table class-name">plugins."io.containerd.internal.v1.restart"</span><span class="token punctuation">]</span>\n    <span class="token key property">interval</span> <span class="token punctuation">=</span> <span class="token string">"10s"</span>\n  <span class="token punctuation">[</span><span class="token table class-name">plugins."io.containerd.metadata.v1.bolt"</span><span class="token punctuation">]</span>\n    <span class="token key property">content_sharing_policy</span> <span class="token punctuation">=</span> <span class="token string">"shared"</span>\n  <span class="token punctuation">[</span><span class="token table class-name">plugins."io.containerd.monitor.v1.cgroups"</span><span class="token punctuation">]</span>\n    <span class="token key property">no_prometheus</span> <span class="token punctuation">=</span> <span class="token boolean">false</span>\n  <span class="token punctuation">[</span><span class="token table class-name">plugins."io.containerd.runtime.v2.task"</span><span class="token punctuation">]</span>\n    <span class="token key property">platforms</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"linux/amd64"</span><span class="token punctuation">]</span>\n  <span class="token punctuation">[</span><span class="token table class-name">plugins."io.containerd.service.v1.diff-service"</span><span class="token punctuation">]</span>\n    <span class="token key property">default</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"walking"</span><span class="token punctuation">]</span>\n  <span class="token punctuation">[</span><span class="token table class-name">plugins."io.containerd.snapshotter.v1.devmapper"</span><span class="token punctuation">]</span>\n    <span class="token key property">root_path</span> <span class="token punctuation">=</span> <span class="token string">""</span>\n    <span class="token key property">pool_name</span> <span class="token punctuation">=</span> <span class="token string">""</span>\n    <span class="token key property">base_image_size</span> <span class="token punctuation">=</span> <span class="token string">""</span>\n    <span class="token key property">async_remove</span> <span class="token punctuation">=</span> <span class="token boolean">false</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="安装-kubelet-kubeadm-kubectl-cri-tools-kubernetes-cni"><a href="#%E5%AE%89%E8%A3%85-kubelet-kubeadm-kubectl-cri-tools-kubernetes-cni" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>安装 kubelet kubeadm kubectl cri-tools kubernetes-cni</h4>\n<h5 id="ubuntudebian"><a href="#ubuntudebian" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Ubuntu/Debian</h5>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="16752513797912760000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ apt-get update && apt-get install -y apt-transport-https\n\\$ curl https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg | apt-key add -\n\n\\$ cat <<EOF | sudo tee /etc/apt/sources.list.d/kubernetes.list\ndeb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main\nEOF\n\n\\$ apt-get update\n\\$ apt-get install -y kubelet kubeadm kubectl`, `16752513797912760000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ <span class="token function">apt-get</span> update <span class="token operator">&amp;&amp;</span> <span class="token function">apt-get</span> <span class="token function">install</span> -y apt-transport-https\n$ <span class="token function">curl</span> https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg <span class="token operator">|</span> apt-key <span class="token function">add</span> -\n\n$ <span class="token function">cat</span> <span class="token operator">&lt;&lt;</span>EOF <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /etc/apt/sources.list.d/kubernetes.list\ndeb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main\nEOF\n\n$ <span class="token function">apt-get</span> update\n$ <span class="token function">apt-get</span> <span class="token function">install</span> -y kubelet kubeadm kubectl</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h5 id="centosfedora"><a href="#centosfedora" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>CentOS/Fedora</h5>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="37141853579896210000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ cat <<EOF | sudo tee /etc/yum.repos.d/kubernetes.repo\n[kubernetes]\nname=Kubernetes\nbaseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/\nenabled=1\ngpgcheck=1\nrepo_gpgcheck=1\ngpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg\nEOF\n\n\\$ sudo yum install -y kubelet kubeadm kubectl`, `37141853579896210000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ <span class="token function">cat</span> <span class="token operator">&lt;&lt;</span>EOF <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /etc/yum.repos.d/kubernetes.repo\n<span class="token punctuation">[</span>kubernetes<span class="token punctuation">]</span>\n<span class="token assign-left variable">name</span><span class="token operator">=</span>Kubernetes\n<span class="token assign-left variable">baseurl</span><span class="token operator">=</span>https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/\n<span class="token assign-left variable">enabled</span><span class="token operator">=</span><span class="token number">1</span>\n<span class="token assign-left variable">gpgcheck</span><span class="token operator">=</span><span class="token number">1</span>\n<span class="token assign-left variable">repo_gpgcheck</span><span class="token operator">=</span><span class="token number">1</span>\n<span class="token assign-left variable">gpgkey</span><span class="token operator">=</span>https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg\nEOF\n\n$ <span class="token function">sudo</span> yum <span class="token function">install</span> -y kubelet kubeadm kubectl</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="修改内核的运行参数"><a href="#%E4%BF%AE%E6%94%B9%E5%86%85%E6%A0%B8%E7%9A%84%E8%BF%90%E8%A1%8C%E5%8F%82%E6%95%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>修改内核的运行参数</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="5257188167368487000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ cat <<EOF | sudo tee /etc/sysctl.d/99-kubernetes-cri.conf\nnet.bridge.bridge-nf-call-iptables  = 1\nnet.ipv4.ip_forward                 = 1\nnet.bridge.bridge-nf-call-ip6tables = 1\nEOF\n\n# 应用配置\n\\$ sysctl --system`, `5257188167368487000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ <span class="token function">cat</span> <span class="token operator">&lt;&lt;</span>EOF <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /etc/sysctl.d/99-kubernetes-cri.conf\nnet.bridge.bridge-nf-call-iptables  <span class="token operator">=</span> <span class="token number">1</span>\nnet.ipv4.ip_forward                 <span class="token operator">=</span> <span class="token number">1</span>\nnet.bridge.bridge-nf-call-ip6tables <span class="token operator">=</span> <span class="token number">1</span>\nEOF\n\n<span class="token comment"># 应用配置</span>\n$ sysctl --system</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="配置-kubelet"><a href="#%E9%85%8D%E7%BD%AE-kubelet" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>配置 kubelet</h4>\n<h5 id="修改-kubeletservice"><a href="#%E4%BF%AE%E6%94%B9-kubeletservice" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>修改 kubelet.service</h5>\n<p><code class="language-text">/etc/systemd/system/kubelet.service.d/10-proxy-ipvs.conf</code> 写入以下内容</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="86804249132092150000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# 启用 ipvs 相关内核模块\n[Service]\nExecStartPre=-/sbin/modprobe ip_vs\nExecStartPre=-/sbin/modprobe ip_vs_rr\nExecStartPre=-/sbin/modprobe ip_vs_wrr\nExecStartPre=-/sbin/modprobe ip_vs_sh`, `86804249132092150000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token comment"># 启用 ipvs 相关内核模块</span>\n<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>\n<span class="token assign-left variable">ExecStartPre</span><span class="token operator">=</span>-/sbin/modprobe ip_vs\n<span class="token assign-left variable">ExecStartPre</span><span class="token operator">=</span>-/sbin/modprobe ip_vs_rr\n<span class="token assign-left variable">ExecStartPre</span><span class="token operator">=</span>-/sbin/modprobe ip_vs_wrr\n<span class="token assign-left variable">ExecStartPre</span><span class="token operator">=</span>-/sbin/modprobe ip_vs_sh</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>执行以下命令应用配置。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="78989649199371800000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ sudo systemctl daemon-reload`, `78989649199371800000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ <span class="token function">sudo</span> systemctl daemon-reload</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h4 id="部署"><a href="#%E9%83%A8%E7%BD%B2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>部署</h4>\n<h5 id="master"><a href="#master" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>master</h5>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="92203986625174300000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ systemctl enable cri-containerd\n\n\\$ systemctl start cri-containerd\n\n\\$ sudo kubeadm init \\\n      --image-repository registry.cn-hangzhou.aliyuncs.com/google_containers \\\n      --pod-network-cidr 10.244.0.0/16 \\\n      --cri-socket /run/cri-containerd/cri-containerd.sock \\\n      --v 5 \\\n      --ignore-preflight-errors=all`, `92203986625174300000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ systemctl <span class="token builtin class-name">enable</span> cri-containerd\n\n$ systemctl start cri-containerd\n\n$ <span class="token function">sudo</span> kubeadm init <span class="token punctuation">\\</span>\n      --image-repository registry.cn-hangzhou.aliyuncs.com/google_containers <span class="token punctuation">\\</span>\n      --pod-network-cidr <span class="token number">10.244</span>.0.0/16 <span class="token punctuation">\\</span>\n      --cri-socket /run/cri-containerd/cri-containerd.sock <span class="token punctuation">\\</span>\n      --v <span class="token number">5</span> <span class="token punctuation">\\</span>\n      --ignore-preflight-errors<span class="token operator">=</span>all</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><code class="language-text">--pod-network-cidr 10.244.0.0/16</code> 参数与后续 CNI 插件有关，这里以 flannel 为例，若后续部署其他类型的网络插件请更改此参数。执行可能出现错误，例如缺少依赖包，根据提示安装即可。</p>\n<p>执行成功会输出</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="45395293045547970000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`...\n[addons] Applied essential addon: CoreDNS\nI1116 12:35:13.270407   86677 request.go:538] Throttling request took 181.409184ms, request: POST:https://192.168.199.100:6443/api/v1/namespaces/kube-system/serviceaccounts\nI1116 12:35:13.470292   86677 request.go:538] Throttling request took 186.088112ms, request: POST:https://192.168.199.100:6443/api/v1/namespaces/kube-system/configmaps\n[addons] Applied essential addon: kube-proxy\n\nYour Kubernetes control-plane has initialized successfully!\n\nTo start using your cluster, you need to run the following as a regular user:\n\n  mkdir -p \\$HOME/.kube\n  sudo cp -i /etc/kubernetes/admin.conf \\$HOME/.kube/config\n  sudo chown \\$(id -u):\\$(id -g) \\$HOME/.kube/config\n\nYou should now deploy a pod network to the cluster.\nRun &quot;kubectl apply -f [podnetwork].yaml&quot; with one of the options listed at:\n  https://kubernetes.io/docs/concepts/cluster-administration/addons/\n\nThen you can join any number of worker nodes by running the following on each as root:\n\nkubeadm join 192.168.199.100:6443 --token cz81zt.orsy9gm9v649e5lf \\\n    --discovery-token-ca-cert-hash sha256:5edb316fd0d8ea2792cba15cdf1c899a366f147aa03cba52d4e5c5884ad836fe`, `45395293045547970000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token punctuation">..</span>.\n<span class="token punctuation">[</span>addons<span class="token punctuation">]</span> Applied essential addon: CoreDNS\nI1116 <span class="token number">12</span>:35:13.270407   <span class="token number">86677</span> request.go:538<span class="token punctuation">]</span> Throttling request took <span class="token number">181</span>.409184ms, request: POST:https://192.168.199.100:6443/api/v1/namespaces/kube-system/serviceaccounts\nI1116 <span class="token number">12</span>:35:13.470292   <span class="token number">86677</span> request.go:538<span class="token punctuation">]</span> Throttling request took <span class="token number">186</span>.088112ms, request: POST:https://192.168.199.100:6443/api/v1/namespaces/kube-system/configmaps\n<span class="token punctuation">[</span>addons<span class="token punctuation">]</span> Applied essential addon: kube-proxy\n\nYour Kubernetes control-plane has initialized successfully<span class="token operator">!</span>\n\nTo start using your cluster, you need to run the following as a regular user:\n\n  <span class="token function">mkdir</span> -p <span class="token environment constant">$HOME</span>/.kube\n  <span class="token function">sudo</span> <span class="token function">cp</span> -i /etc/kubernetes/admin.conf <span class="token environment constant">$HOME</span>/.kube/config\n  <span class="token function">sudo</span> <span class="token function">chown</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> -u<span class="token variable">)</span></span><span class="token builtin class-name">:</span><span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> -g<span class="token variable">)</span></span> <span class="token environment constant">$HOME</span>/.kube/config\n\nYou should now deploy a pod network to the cluster.\nRun <span class="token string">"kubectl apply -f [podnetwork].yaml"</span> with one of the options listed at:\n  https://kubernetes.io/docs/concepts/cluster-administration/addons/\n\nThen you can <span class="token function">join</span> any number of worker nodes by running the following on each as root:\n\nkubeadm <span class="token function">join</span> <span class="token number">192.168</span>.199.100:6443 --token cz81zt.orsy9gm9v649e5lf <span class="token punctuation">\\</span>\n    --discovery-token-ca-cert-hash sha256:5edb316fd0d8ea2792cba15cdf1c899a366f147aa03cba52d4e5c5884ad836fe</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h5 id="node-工作节点"><a href="#node-%E5%B7%A5%E4%BD%9C%E8%8A%82%E7%82%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>node 工作节点</h5>\n<p>在另一主机重复部署小节以前的步骤，安装配置好 kubelet。根据提示，加入到集群。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="40417455207695530000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ systemctl enable cri-containerd\n\n\\$ systemctl start cri-containerd\n\n\\$ kubeadm join 192.168.199.100:6443 \\\n    --token cz81zt.orsy9gm9v649e5lf \\\n    --discovery-token-ca-cert-hash sha256:5edb316fd0d8ea2792cba15cdf1c899a366f147aa03cba52d4e5c5884ad836fe \\\n    --cri-socket /run/cri-containerd/cri-containerd.sock`, `40417455207695530000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ systemctl <span class="token builtin class-name">enable</span> cri-containerd\n\n$ systemctl start cri-containerd\n\n$ kubeadm <span class="token function">join</span> <span class="token number">192.168</span>.199.100:6443 <span class="token punctuation">\\</span>\n    --token cz81zt.orsy9gm9v649e5lf <span class="token punctuation">\\</span>\n    --discovery-token-ca-cert-hash sha256:5edb316fd0d8ea2792cba15cdf1c899a366f147aa03cba52d4e5c5884ad836fe <span class="token punctuation">\\</span>\n    --cri-socket /run/cri-containerd/cri-containerd.sock</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="查看服务-2"><a href="#%E6%9F%A5%E7%9C%8B%E6%9C%8D%E5%8A%A1-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>查看服务</h4>\n<p>所有服务启动后，通过 crictl 查看本地实际运行的容器。这些服务大概分为三类：主节点服务、工作节点服务和其它服务。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="54727776017103725000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`CONTAINER_RUNTIME_ENDPOINT=/run/cri-containerd/cri-containerd.sock crictl ps -a`, `54727776017103725000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token assign-left variable">CONTAINER_RUNTIME_ENDPOINT</span><span class="token operator">=</span>/run/cri-containerd/cri-containerd.sock crictl <span class="token function">ps</span> -a</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h5 id="主节点服务-1"><a href="#%E4%B8%BB%E8%8A%82%E7%82%B9%E6%9C%8D%E5%8A%A1-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>主节点服务</h5>\n<ul>\n<li>apiserver 是整个系统的对外接口，提供 RESTful 方式供客户端和其它组件调用；</li>\n<li>scheduler 负责对资源进行调度，分配某个 pod 到某个节点上；</li>\n<li>controller-manager 负责管理控制器，包括 endpoint-controller（刷新服务和 pod 的关联信息）和 replication-controller（维护某个 pod 的复制为配置的数值）。</li>\n</ul>\n<h5 id="工作节点服务"><a href="#%E5%B7%A5%E4%BD%9C%E8%8A%82%E7%82%B9%E6%9C%8D%E5%8A%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>工作节点服务</h5>\n<p>proxy 为 pod 上的服务提供访问的代理。</p>\n<h5 id="其它服务"><a href="#%E5%85%B6%E5%AE%83%E6%9C%8D%E5%8A%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>其它服务</h5>\n<p>Etcd 是所有状态的存储数据库；</p>\n<h4 id="使用-3"><a href="#%E4%BD%BF%E7%94%A8-3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用</h4>\n<p>将 <code class="language-text">/etc/kubernetes/admin.conf</code> 复制到 <code class="language-text">~/.kube/config</code></p>\n<p>执行 <code class="language-text">$ kubectl get all -A</code> 查看启动的服务。</p>\n<p>由于未部署 CNI 插件，CoreDNS 未正常启动。如何使用 Kubernetes，请参考后续章节。</p>\n<h4 id="部署-cni"><a href="#%E9%83%A8%E7%BD%B2-cni" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>部署 CNI</h4>\n<p>这里以 flannel 为例进行介绍。</p>\n<h5 id="flannel"><a href="#flannel" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>flannel</h5>\n<p>检查 podCIDR 设置</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="89084687653063400000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ kubectl get node -o yaml | grep CIDR\n\n# 输出\n    podCIDR: 10.244.0.0/16\n    podCIDRs:`, `89084687653063400000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ kubectl get node -o yaml <span class="token operator">|</span> <span class="token function">grep</span> CIDR\n\n<span class="token comment"># 输出</span>\n    podCIDR: <span class="token number">10.244</span>.0.0/16\n    podCIDRs:</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="99614495291314980000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/v0.11.0/Documentation/kube-flannel.yml`, `99614495291314980000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/v0.11.0/Documentation/kube-flannel.yml</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h4 id="master-节点默认不能运行-pod"><a href="#master-%E8%8A%82%E7%82%B9%E9%BB%98%E8%AE%A4%E4%B8%8D%E8%83%BD%E8%BF%90%E8%A1%8C-pod" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>master 节点默认不能运行 pod</h4>\n<p>如果用 kubeadm 部署一个单节点集群，默认情况下无法使用，请执行以下命令解除限制</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="52556306859807240000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ kubectl taint nodes --all node-role.kubernetes.io/master-\n\n# 恢复默认值\n# \\$ kubectl taint nodes NODE_NAME node-role.kubernetes.io/master=true:NoSchedule`, `52556306859807240000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ kubectl taint nodes --all node-role.kubernetes.io/master-\n\n<span class="token comment"># 恢复默认值</span>\n<span class="token comment"># $ kubectl taint nodes NODE_NAME node-role.kubernetes.io/master=true:NoSchedule</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="docker-desktop-启用-kubernetes"><a href="#docker-desktop-%E5%90%AF%E7%94%A8-kubernetes" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Docker Desktop 启用 Kubernetes</h3>\n<p>使用 Docker Desktop 可以很方便的启用 Kubernetes，由于国内获取不到 k8s.gcr.io 镜像，我们必须首先解决这一问题。</p>\n<h4 id="获取-k8sgcrio-镜像"><a href="#%E8%8E%B7%E5%8F%96-k8sgcrio-%E9%95%9C%E5%83%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>获取 k8s.gcr.io 镜像</h4>\n<p>由于国内拉取不到 k8s.gcr.io 镜像，我们可以使用开源项目 <a href="https://github.com/AliyunContainerService/k8s-for-docker-desktop" target="_blank" rel="nofollow noreferrer noopener">AliyunContainerService/k8s-for-docker-desktop</a> 来获取所需的镜像。</p>\n<h4 id="启用-kubernetes"><a href="#%E5%90%AF%E7%94%A8-kubernetes" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>启用 Kubernetes</h4>\n<p>在 Docker Desktop 设置页面，点击 Kubernetes，选择 Enable Kubernetes，稍等片刻，看到左下方 Kubernetes 变为 running，Kubernetes 启动成功。</p>\n<h4 id="测试-1"><a href="#%E6%B5%8B%E8%AF%95-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>测试</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="70625468236651990000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ kubectl version`, `70625468236651990000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ kubectl version</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>如果正常输出信息，则证明 Kubernetes 成功启动。</p>\n<h3 id="一步步部署-kubernetes-集群"><a href="#%E4%B8%80%E6%AD%A5%E6%AD%A5%E9%83%A8%E7%BD%B2-kubernetes-%E9%9B%86%E7%BE%A4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>一步步部署 kubernetes 集群</h3>\n<p>可以参考 <a href="https://github.com/opsnull/follow-me-install-kubernetes-cluster" target="_blank" rel="nofollow noreferrer noopener">opsnull/follow-me-install-kubernetes-cluster</a> 项目一步步部署 kubernetes 集群。</p>\n<h3 id="kubernetes-dashboard"><a href="#kubernetes-dashboard" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Kubernetes Dashboard</h3>\n<p><a href="https://github.com/kubernetes/dashboard" target="_blank" rel="nofollow noreferrer noopener">Kubernetes Dashboard</a> 是基于网页的 Kubernetes 用户界面。</p>\n<h4 id="部署-1"><a href="#%E9%83%A8%E7%BD%B2-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>部署</h4>\n<p>执行以下命令即可部署 Dashboard：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="8256952390529860000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.0/aio/deploy/recommended.yaml`, `8256952390529860000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.0/aio/deploy/recommended.yaml</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h4 id="访问"><a href="#%E8%AE%BF%E9%97%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>访问</h4>\n<p>通过命令行代理访问，执行以下命令：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="72565398909724156000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ kubectl proxy`, `72565398909724156000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ kubectl proxy</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>到 <code class="language-text">http://localhost:8001/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy/</code> 即可访问。</p>\n<h4 id="登录-1"><a href="#%E7%99%BB%E5%BD%95-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>登录</h4>\n<p>目前，Dashboard 仅支持使用 Bearer 令牌登录。下面教大家如何创建该令牌：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="42899695435728780000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ kubectl create sa dashboard-admin -n kube-system\n\n\\$ kubectl create clusterrolebinding dashboard-admin --clusterrole=cluster-admin --serviceaccount=kube-system:dashboard-admin\n\n\\$ ADMIN_SECRET=\\$(kubectl get secrets -n kube-system | grep dashboard-admin | awk \'{print \\$1}\')\n\n\\$ DASHBOARD_LOGIN_TOKEN=\\$(kubectl describe secret -n kube-system \\${ADMIN_SECRET} | grep -E \'^token\' | awk \'{print \\$2}\')\n\necho \\${DASHBOARD_LOGIN_TOKEN}`, `42899695435728780000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ kubectl create sa dashboard-admin -n kube-system\n\n$ kubectl create clusterrolebinding dashboard-admin --clusterrole<span class="token operator">=</span>cluster-admin --serviceaccount<span class="token operator">=</span>kube-system:dashboard-admin\n\n$ <span class="token assign-left variable">ADMIN_SECRET</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl get secrets -n kube-system <span class="token operator">|</span> <span class="token function">grep</span> dashboard-admin <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">\'{print <span class="token variable">$1</span>}\'</span><span class="token variable">)</span></span>\n\n$ <span class="token assign-left variable">DASHBOARD_LOGIN_TOKEN</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl describe secret -n kube-system $<span class="token punctuation">{</span>ADMIN_SECRET<span class="token punctuation">}</span> <span class="token operator">|</span> <span class="token function">grep</span> -E <span class="token string">\'^token\'</span> <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">\'{print <span class="token variable">$2</span>}\'</span><span class="token variable">)</span></span>\n\n<span class="token builtin class-name">echo</span> <span class="token variable">${DASHBOARD_LOGIN_TOKEN}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>将结果粘贴到登录页面，即可登录。</p>\n<h2 id="kubernetes-命令行-kubectl"><a href="#kubernetes-%E5%91%BD%E4%BB%A4%E8%A1%8C-kubectl" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Kubernetes 命令行 kubectl</h2>\n<h3 id="kubectl-使用"><a href="#kubectl-%E4%BD%BF%E7%94%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>kubectl 使用</h3>\n<p><a href="https://github.com/kubernetes/kubernetes" target="_blank" rel="nofollow noreferrer noopener">kubectl</a> 是 Kubernetes 自带的客户端，可以用它来直接操作 Kubernetes。</p>\n<p>使用格式有两种：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="29143481952759222000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`kubectl [flags]\nkubectl [command]`, `29143481952759222000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">kubectl <span class="token punctuation">[</span>flags<span class="token punctuation">]</span>\nkubectl <span class="token punctuation">[</span>command<span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<h4 id="get"><a href="#get" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>get</h4>\n<p>显示一个或多个资源</p>\n<h4 id="describe"><a href="#describe" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>describe</h4>\n<p>显示资源详情</p>\n<h4 id="create"><a href="#create" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>create</h4>\n<p>从文件或标准输入创建资源</p>\n<h4 id="update"><a href="#update" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>update</h4>\n<p>从文件或标准输入更新资源</p>\n<h4 id="delete"><a href="#delete" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>delete</h4>\n<p>通过文件名、标准输入、资源名或者 label selector 删除资源</p>\n<h4 id="log"><a href="#log" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>log</h4>\n<p>输出 pod 中一个容器的日志</p>\n<h4 id="rolling-update"><a href="#rolling-update" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>rolling-update</h4>\n<p>对指定的 replication controller 执行滚动升级</p>\n<h4 id="exec-1"><a href="#exec-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>exec</h4>\n<p>在容器内部执行命令</p>\n<h4 id="port-forward"><a href="#port-forward" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>port-forward</h4>\n<p>将本地端口转发到 Pod</p>\n<h4 id="proxy"><a href="#proxy" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>proxy</h4>\n<p>为 Kubernetes API server 启动代理服务器</p>\n<h4 id="run-2"><a href="#run-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>run</h4>\n<p>在集群中使用指定镜像启动容器</p>\n<h4 id="expose-2"><a href="#expose-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>expose</h4>\n<p>将 <code class="language-text">replication controller service</code> 或 pod 暴露为新的 <code class="language-text">kubernetes service</code></p>\n<h4 id="label-1"><a href="#label-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>label</h4>\n<p>更新资源的 label</p>\n<h4 id="config-1"><a href="#config-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>config</h4>\n<p>修改 kubernetes 配置文件</p>\n<h4 id="cluster-info"><a href="#cluster-info" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>cluster-info</h4>\n<p>显示集群信息</p>\n<h4 id="api-versions"><a href="#api-versions" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>api-versions</h4>\n<p>以 “组/版本” 的格式输出服务端支持的 API 版本</p>\n<h4 id="version-1"><a href="#version-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>version</h4>\n<p>输出服务端和客户端的版本信息</p>\n<h4 id="help-1"><a href="#help-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>help</h4>\n<p>显示各个命令的帮助信息</p>\n<h3 id="常用命令"><a href="#%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>常用命令</h3>\n<p>使用以下示例集来帮助你熟悉运行常用 kubectl 操作：</p>\n<h4 id="kubectl-apply---以文件或标准输入为准应用或更新资源"><a href="#kubectl-apply---%E4%BB%A5%E6%96%87%E4%BB%B6%E6%88%96%E6%A0%87%E5%87%86%E8%BE%93%E5%85%A5%E4%B8%BA%E5%87%86%E5%BA%94%E7%94%A8%E6%88%96%E6%9B%B4%E6%96%B0%E8%B5%84%E6%BA%90" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>kubectl apply - 以文件或标准输入为准应用或更新资源</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="9518764645326948000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# 使用 example-service.yaml 中的定义创建服务。\nkubectl apply -f example-service.yaml\n\n# 使用 example-controller.yaml 中的定义创建 replication controller。\nkubectl apply -f example-controller.yaml\n\n# 使用 <directory> 路径下的任意 .yaml、.yml 或 .json 文件 创建对象。\nkubectl apply -f <directory>`, `9518764645326948000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token comment"># 使用 example-service.yaml 中的定义创建服务。</span>\nkubectl apply -f example-service.yaml\n\n<span class="token comment"># 使用 example-controller.yaml 中的定义创建 replication controller。</span>\nkubectl apply -f example-controller.yaml\n\n<span class="token comment"># 使用 &lt;directory> 路径下的任意 .yaml、.yml 或 .json 文件 创建对象。</span>\nkubectl apply -f <span class="token operator">&lt;</span>directory<span class="token operator">></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="kubectl-get---列出一个或多个资源"><a href="#kubectl-get---%E5%88%97%E5%87%BA%E4%B8%80%E4%B8%AA%E6%88%96%E5%A4%9A%E4%B8%AA%E8%B5%84%E6%BA%90" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>kubectl get - 列出一个或多个资源</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="47744064487841610000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# 以纯文本输出格式列出所有 Pod。\nkubectl get pods\n\n# 以纯文本输出格式列出所有 Pod，并包含附加信息(如节点名)。\nkubectl get pods -o wide\n\n# 以纯文本输出格式列出具有指定名称的副本控制器。提示：你可以使用别名 \'rc\' 缩短和替换 \'replicationcontroller\' 资源类型。\nkubectl get replicationcontroller <rc-name>\n\n# 以纯文本输出格式列出所有副本控制器和服务。\nkubectl get rc,services\n\n# 以纯文本输出格式列出所有守护程序集，包括未初始化的守护程序集。\nkubectl get ds --include-uninitialized\n\n# 列出在节点 server01 上运行的所有 Pod\nkubectl get pods --field-selector=spec.nodeName=server01`, `47744064487841610000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token comment"># 以纯文本输出格式列出所有 Pod。</span>\nkubectl get pods\n\n<span class="token comment"># 以纯文本输出格式列出所有 Pod，并包含附加信息(如节点名)。</span>\nkubectl get pods -o wide\n\n<span class="token comment"># 以纯文本输出格式列出具有指定名称的副本控制器。提示：你可以使用别名 \'rc\' 缩短和替换 \'replicationcontroller\' 资源类型。</span>\nkubectl get replicationcontroller <span class="token operator">&lt;</span>rc-name<span class="token operator">></span>\n\n<span class="token comment"># 以纯文本输出格式列出所有副本控制器和服务。</span>\nkubectl get rc,services\n\n<span class="token comment"># 以纯文本输出格式列出所有守护程序集，包括未初始化的守护程序集。</span>\nkubectl get ds --include-uninitialized\n\n<span class="token comment"># 列出在节点 server01 上运行的所有 Pod</span>\nkubectl get pods --field-selector<span class="token operator">=</span>spec.nodeName<span class="token operator">=</span>server01</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="kubectl-describe---显示一个或多个资源的详细状态，默认情况下包括未初始化的资源"><a href="#kubectl-describe---%E6%98%BE%E7%A4%BA%E4%B8%80%E4%B8%AA%E6%88%96%E5%A4%9A%E4%B8%AA%E8%B5%84%E6%BA%90%E7%9A%84%E8%AF%A6%E7%BB%86%E7%8A%B6%E6%80%81%EF%BC%8C%E9%BB%98%E8%AE%A4%E6%83%85%E5%86%B5%E4%B8%8B%E5%8C%85%E6%8B%AC%E6%9C%AA%E5%88%9D%E5%A7%8B%E5%8C%96%E7%9A%84%E8%B5%84%E6%BA%90" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>kubectl describe - 显示一个或多个资源的详细状态，默认情况下包括未初始化的资源</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="28982018244723663000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# 显示名为 <pod-name> 的 Pod 的详细信息。\nkubectl describe nodes <node-name>\n\n# 显示名为 <pod-name> 的 Pod 的详细信息。\nkubectl describe pods/<pod-name>\n\n# 显示由名为 <rc-name> 的副本控制器管理的所有 Pod 的详细信息。\n# 记住：副本控制器创建的任何 Pod 都以副本控制器的名称为前缀。\nkubectl describe pods <rc-name>\n\n# 描述所有的 Pod\nkubectl describe pods`, `28982018244723663000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token comment"># 显示名为 &lt;pod-name> 的 Pod 的详细信息。</span>\nkubectl describe nodes <span class="token operator">&lt;</span>node-name<span class="token operator">></span>\n\n<span class="token comment"># 显示名为 &lt;pod-name> 的 Pod 的详细信息。</span>\nkubectl describe pods/<span class="token operator">&lt;</span>pod-name<span class="token operator">></span>\n\n<span class="token comment"># 显示由名为 &lt;rc-name> 的副本控制器管理的所有 Pod 的详细信息。</span>\n<span class="token comment"># 记住：副本控制器创建的任何 Pod 都以副本控制器的名称为前缀。</span>\nkubectl describe pods <span class="token operator">&lt;</span>rc-name<span class="token operator">></span>\n\n<span class="token comment"># 描述所有的 Pod</span>\nkubectl describe pods</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<blockquote>\n<p>说明： <code class="language-text">kubectl get</code> 命令通常用于检索同一资源类别的一个或多个资源。它具有丰富的参数，允许你使用 <code class="language-text">-o</code> 或 <code class="language-text">--output</code> 参数自定义输出格式。你可以指定 <code class="language-text">-w</code> 或 <code class="language-text">--watch</code> 参数以开始监测特定对象的更新。<code class="language-text">kubectl describe</code> 命令更侧重于描述指定资源的许多相关方面。它可以调用对 API 服务器的多个 API 调用来为用户构建视图。 例如，该 <code class="language-text">kubectl describe node</code> 命令不仅检索有关节点的信息，还检索在其上运行的 Pod 的摘要，为节点生成的事件等。</p>\n</blockquote>\n<h4 id="kubectl-delete---基于文件、标准输入或通过指定标签选择器、名称、资源选择器或资源来删除资源"><a href="#kubectl-delete---%E5%9F%BA%E4%BA%8E%E6%96%87%E4%BB%B6%E3%80%81%E6%A0%87%E5%87%86%E8%BE%93%E5%85%A5%E6%88%96%E9%80%9A%E8%BF%87%E6%8C%87%E5%AE%9A%E6%A0%87%E7%AD%BE%E9%80%89%E6%8B%A9%E5%99%A8%E3%80%81%E5%90%8D%E7%A7%B0%E3%80%81%E8%B5%84%E6%BA%90%E9%80%89%E6%8B%A9%E5%99%A8%E6%88%96%E8%B5%84%E6%BA%90%E6%9D%A5%E5%88%A0%E9%99%A4%E8%B5%84%E6%BA%90" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>kubectl delete - 基于文件、标准输入或通过指定标签选择器、名称、资源选择器或资源来删除资源</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="66510840939005570000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# 使用 pod.yaml 文件中指定的类型和名称删除 Pod。\nkubectl delete -f pod.yaml\n\n# 删除所有带有 \'<label-key>=<label-value>\' 标签的 Pod 和服务。\nkubectl delete pods,services -l <label-key>=<label-value>\n\n# 删除所有 Pod，包括未初始化的 Pod。\nkubectl delete pods --all`, `66510840939005570000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token comment"># 使用 pod.yaml 文件中指定的类型和名称删除 Pod。</span>\nkubectl delete -f pod.yaml\n\n<span class="token comment"># 删除所有带有 \'&lt;label-key>=&lt;label-value>\' 标签的 Pod 和服务。</span>\nkubectl delete pods,services -l <span class="token operator">&lt;</span>label-key<span class="token operator">></span><span class="token operator">=</span><span class="token operator">&lt;</span>label-value<span class="token operator">></span>\n\n<span class="token comment"># 删除所有 Pod，包括未初始化的 Pod。</span>\nkubectl delete pods --all</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="kubectl-exec---对-pod-中的容器执行命令"><a href="#kubectl-exec---%E5%AF%B9-pod-%E4%B8%AD%E7%9A%84%E5%AE%B9%E5%99%A8%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>kubectl exec - 对 Pod 中的容器执行命令</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="92620653419033510000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# 从 Pod <pod-name> 中获取运行 \'date\' 的输出。默认情况下，输出来自第一个容器。\nkubectl exec <pod-name> -- date\n\n# 运行输出 \'date\' 获取在 Pod <pod-name> 中容器 <container-name> 的输出。\nkubectl exec <pod-name> -c <container-name> -- date\n\n# 获取一个交互 TTY 并在 Pod <pod-name> 中运行 /bin/bash。默认情况下，输出来自第一个容器。\nkubectl exec -ti <pod-name> -- /bin/bash`, `92620653419033510000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token comment"># 从 Pod &lt;pod-name> 中获取运行 \'date\' 的输出。默认情况下，输出来自第一个容器。</span>\nkubectl <span class="token builtin class-name">exec</span> <span class="token operator">&lt;</span>pod-name<span class="token operator">></span> -- <span class="token function">date</span>\n\n<span class="token comment"># 运行输出 \'date\' 获取在 Pod &lt;pod-name> 中容器 &lt;container-name> 的输出。</span>\nkubectl <span class="token builtin class-name">exec</span> <span class="token operator">&lt;</span>pod-name<span class="token operator">></span> -c <span class="token operator">&lt;</span>container-name<span class="token operator">></span> -- <span class="token function">date</span>\n\n<span class="token comment"># 获取一个交互 TTY 并在 Pod &lt;pod-name> 中运行 /bin/bash。默认情况下，输出来自第一个容器。</span>\nkubectl <span class="token builtin class-name">exec</span> -ti <span class="token operator">&lt;</span>pod-name<span class="token operator">></span> -- /bin/bash</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="kubectl-logs---打印-pod-中容器的日志"><a href="#kubectl-logs---%E6%89%93%E5%8D%B0-pod-%E4%B8%AD%E5%AE%B9%E5%99%A8%E7%9A%84%E6%97%A5%E5%BF%97" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>kubectl logs - 打印 Pod 中容器的日志</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="80916788379994820000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# 返回 Pod <pod-name> 的日志快照。\nkubectl logs <pod-name>\n\n# 从 Pod <pod-name> 开始流式传输日志。这类似于 \'tail -f\' Linux 命令。\nkubectl logs -f <pod-name>`, `80916788379994820000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token comment"># 返回 Pod &lt;pod-name> 的日志快照。</span>\nkubectl logs <span class="token operator">&lt;</span>pod-name<span class="token operator">></span>\n\n<span class="token comment"># 从 Pod &lt;pod-name> 开始流式传输日志。这类似于 \'tail -f\' Linux 命令。</span>\nkubectl logs -f <span class="token operator">&lt;</span>pod-name<span class="token operator">></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="kubectl-diff---查看集群建议更新的差异"><a href="#kubectl-diff---%E6%9F%A5%E7%9C%8B%E9%9B%86%E7%BE%A4%E5%BB%BA%E8%AE%AE%E6%9B%B4%E6%96%B0%E7%9A%84%E5%B7%AE%E5%BC%82" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>kubectl diff - 查看集群建议更新的差异</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="23955890791362912000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# “pod.json”中包含的差异资源。\nkubectl diff -f pod.json\n\n# 从标准输入读取的差异文件。\ncat service.yaml | kubectl diff -f -`, `23955890791362912000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token comment"># “pod.json”中包含的差异资源。</span>\nkubectl <span class="token function">diff</span> -f pod.json\n\n<span class="token comment"># 从标准输入读取的差异文件。</span>\n<span class="token function">cat</span> service.yaml <span class="token operator">|</span> kubectl <span class="token function">diff</span> -f -</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="kubectl-自动补全"><a href="#kubectl-%E8%87%AA%E5%8A%A8%E8%A1%A5%E5%85%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Kubectl 自动补全</h4>\n<h5 id="bash"><a href="#bash" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>BASH</h5>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="49650471639902490000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`source <(kubectl completion bash) # 在 bash 中设置当前 shell 的自动补全，要先安装 bash-completion 包。\necho &quot;source <(kubectl completion bash)&quot; >> ~/.bashrc # 在您的 bash shell 中永久的添加自动补全`, `49650471639902490000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token builtin class-name">source</span> <span class="token operator">&lt;</span><span class="token punctuation">(</span>kubectl completion <span class="token function">bash</span><span class="token punctuation">)</span> <span class="token comment"># 在 bash 中设置当前 shell 的自动补全，要先安装 bash-completion 包。</span>\n<span class="token builtin class-name">echo</span> <span class="token string">"source &lt;(kubectl completion bash)"</span> <span class="token operator">>></span> ~/.bashrc <span class="token comment"># 在您的 bash shell 中永久的添加自动补全</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>您还可以为 kubectl 使用一个速记别名，该别名也可以与 completion 一起使用：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="51967057411323620000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`alias k=kubectl\ncomplete -o default -F __start_kubectl k`, `51967057411323620000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token builtin class-name">alias</span> <span class="token assign-left variable">k</span><span class="token operator">=</span>kubectl\ncomplete -o default -F __start_kubectl k</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<h5 id="zsh"><a href="#zsh" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ZSH</h5>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="74496408935769260000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`source <(kubectl completion zsh)  # 在 zsh 中设置当前 shell 的自动补全\necho \'[[ \\$commands[kubectl] ]] && source <(kubectl completion zsh)\' >> ~/.zshrc # 在您的 zsh shell 中永久的添加自动补全`, `74496408935769260000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token builtin class-name">source</span> <span class="token operator">&lt;</span><span class="token punctuation">(</span>kubectl completion <span class="token function">zsh</span><span class="token punctuation">)</span>  <span class="token comment"># 在 zsh 中设置当前 shell 的自动补全</span>\n<span class="token builtin class-name">echo</span> <span class="token string">\'[[ <span class="token variable">$commands</span>[kubectl] ]] &amp;&amp; source &lt;(kubectl completion zsh)\'</span> <span class="token operator">>></span> ~/.zshrc <span class="token comment"># 在您的 zsh shell 中永久的添加自动补全</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<h5 id="关于---all-namespaces-的一点说明"><a href="#%E5%85%B3%E4%BA%8E---all-namespaces-%E7%9A%84%E4%B8%80%E7%82%B9%E8%AF%B4%E6%98%8E" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>关于 <code class="language-text">--all-namespaces</code> 的一点说明</h5>\n<p>我们经常用到 <code class="language-text">--all-namespaces</code> 参数，你应该要知道它的简写 <code class="language-text">kubectl -A</code></p>\n<h4 id="kubectl-上下文和配置"><a href="#kubectl-%E4%B8%8A%E4%B8%8B%E6%96%87%E5%92%8C%E9%85%8D%E7%BD%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Kubectl 上下文和配置</h4>\n<p>设置 kubectl 与哪个 Kubernetes 集群进行通信并修改配置信息。查看使用 kubeconfig 跨集群授权访问 文档获取配置文件详细信息。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="82739495122084580000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`kubectl config view # 显示合并的 kubeconfig 配置。\n\n# 同时使用多个 kubeconfig 文件并查看合并的配置\nKUBECONFIG=~/.kube/config:~/.kube/kubconfig2 kubectl config view\n\n# 获取 e2e 用户的密码\nkubectl config view -o jsonpath=\'{.users[?(@.name == &quot;e2e&quot;)].user.password}\'\n\nkubectl config view -o jsonpath=\'{.users[].name}\'    # 显示第一个用户\nkubectl config view -o jsonpath=\'{.users[*].name}\'   # 获取用户列表\nkubectl config get-contexts                          # 显示上下文列表\nkubectl config current-context                       # 展示当前所处的上下文\nkubectl config use-context my-cluster-name           # 设置默认的上下文为 my-cluster-name\n\n# 添加新的用户配置到 kubeconf 中，使用 basic auth 进行身份认证\nkubectl config set-credentials kubeuser/foo.kubernetes.com --username=kubeuser --password=kubepassword\n\n# 在指定上下文中持久性地保存名字空间，供所有后续 kubectl 命令使用\nkubectl config set-context --current --namespace=ggckad-s2\n\n# 使用特定的用户名和名字空间设置上下文\nkubectl config set-context gce --user=cluster-admin --namespace=foo \\\n  && kubectl config use-context gce\n\nkubectl config unset users.foo                       # 删除用户 foo\n\n# 设置或显示 context / namespace 的短别名\n# （仅适用于 bash 和 bash 兼容的 shell，在使用 kn 设置命名空间之前要先设置 current-context）\nalias kx=\'f() { [ &quot;\\$1&quot; ] && kubectl config use-context \\$1 || kubectl config current-context ; } ; f\'\nalias kn=\'f() { [ &quot;\\$1&quot; ] && kubectl config set-context --current --namespace \\$1 || kubectl config view --minify | grep namespace | cut -d&quot; &quot; -f6 ; } ; f\'`, `82739495122084580000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">kubectl config view <span class="token comment"># 显示合并的 kubeconfig 配置。</span>\n\n<span class="token comment"># 同时使用多个 kubeconfig 文件并查看合并的配置</span>\n<span class="token assign-left variable">KUBECONFIG</span><span class="token operator">=</span>~/.kube/config:~/.kube/kubconfig2 kubectl config view\n\n<span class="token comment"># 获取 e2e 用户的密码</span>\nkubectl config view -o <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token string">\'{.users[?(@.name == "e2e")].user.password}\'</span>\n\nkubectl config view -o <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token string">\'{.users[].name}\'</span>    <span class="token comment"># 显示第一个用户</span>\nkubectl config view -o <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token string">\'{.users[*].name}\'</span>   <span class="token comment"># 获取用户列表</span>\nkubectl config get-contexts                          <span class="token comment"># 显示上下文列表</span>\nkubectl config current-context                       <span class="token comment"># 展示当前所处的上下文</span>\nkubectl config use-context my-cluster-name           <span class="token comment"># 设置默认的上下文为 my-cluster-name</span>\n\n<span class="token comment"># 添加新的用户配置到 kubeconf 中，使用 basic auth 进行身份认证</span>\nkubectl config set-credentials kubeuser/foo.kubernetes.com --username<span class="token operator">=</span>kubeuser --password<span class="token operator">=</span>kubepassword\n\n<span class="token comment"># 在指定上下文中持久性地保存名字空间，供所有后续 kubectl 命令使用</span>\nkubectl config set-context --current --namespace<span class="token operator">=</span>ggckad-s2\n\n<span class="token comment"># 使用特定的用户名和名字空间设置上下文</span>\nkubectl config set-context gce --user<span class="token operator">=</span>cluster-admin --namespace<span class="token operator">=</span>foo <span class="token punctuation">\\</span>\n  <span class="token operator">&amp;&amp;</span> kubectl config use-context gce\n\nkubectl config <span class="token builtin class-name">unset</span> users.foo                       <span class="token comment"># 删除用户 foo</span>\n\n<span class="token comment"># 设置或显示 context / namespace 的短别名</span>\n<span class="token comment"># （仅适用于 bash 和 bash 兼容的 shell，在使用 kn 设置命名空间之前要先设置 current-context）</span>\n<span class="token builtin class-name">alias</span> <span class="token assign-left variable">kx</span><span class="token operator">=</span><span class="token string">\'f() { [ "<span class="token variable">$1</span>" ] &amp;&amp; kubectl config use-context <span class="token variable">$1</span> || kubectl config current-context ; } ; f\'</span>\n<span class="token builtin class-name">alias</span> <span class="token assign-left variable">kn</span><span class="token operator">=</span><span class="token string">\'f() { [ "<span class="token variable">$1</span>" ] &amp;&amp; kubectl config set-context --current --namespace <span class="token variable">$1</span> || kubectl config view --minify | grep namespace | cut -d" " -f6 ; } ; f\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="kubectl-apply"><a href="#kubectl-apply" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Kubectl apply</h4>\n<p>apply 通过定义 Kubernetes 资源的文件来管理应用。它通过运行 kubectl apply 在集群中创建和更新资源。这是在生产中管理 Kubernetes 应用的推荐方法。 参见 <a href="https://kubectl.docs.kubernetes.io/zh/" target="_blank" rel="nofollow noreferrer noopener">Kubectl 文档</a>。</p>\n<h4 id="创建对象"><a href="#%E5%88%9B%E5%BB%BA%E5%AF%B9%E8%B1%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>创建对象</h4>\n<p>Kubernetes 配置可以用 YAML 或 JSON 定义。可以使用的文件扩展名有 <code class="language-text">.yaml</code>、<code class="language-text">.yml</code> 和 <code class="language-text">.json</code>。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="69391201592348615000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`kubectl apply -f ./my-manifest.yaml           # 创建资源\nkubectl apply -f ./my1.yaml -f ./my2.yaml     # 使用多个文件创建\nkubectl apply -f ./dir                        # 基于目录下的所有清单文件创建资源\nkubectl apply -f https://git.io/vPieo         # 从 URL 中创建资源\nkubectl create deployment nginx --image=nginx # 启动单实例 nginx\n\n# 创建一个打印 “Hello World” 的 Job\nkubectl create job hello --image=busybox:1.28 -- echo &quot;Hello World&quot;\n\n# 创建一个打印 “Hello World” 间隔 1 分钟的 CronJob\nkubectl create cronjob hello --image=busybox:1.28 --schedule=&quot;*/1 * * * *&quot; -- echo &quot;Hello World&quot;\n\nkubectl explain pods                          # 获取 pod 清单的文档说明\n\n# 从标准输入创建多个 YAML 对象\ncat <<EOF | kubectl apply -f -\napiVersion: v1\nkind: Pod\nmetadata:\n  name: busybox-sleep\nspec:\n  containers:\n  - name: busybox\n    image: busybox:1.28\n    args:\n    - sleep\n    - &quot;1000000&quot;\n---\napiVersion: v1\nkind: Pod\nmetadata:\n  name: busybox-sleep-less\nspec:\n  containers:\n  - name: busybox\n    image: busybox:1.28\n    args:\n    - sleep\n    - &quot;1000&quot;\nEOF\n\n# 创建有多个 key 的 Secret\ncat <<EOF | kubectl apply -f -\napiVersion: v1\nkind: Secret\nmetadata:\n  name: mysecret\ntype: Opaque\ndata:\n  password: \\$(echo -n &quot;s33msi4&quot; | base64 -w0)\n  username: \\$(echo -n &quot;jane&quot; | base64 -w0)\nEOF`, `69391201592348615000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">kubectl apply -f ./my-manifest.yaml           <span class="token comment"># 创建资源</span>\nkubectl apply -f ./my1.yaml -f ./my2.yaml     <span class="token comment"># 使用多个文件创建</span>\nkubectl apply -f ./dir                        <span class="token comment"># 基于目录下的所有清单文件创建资源</span>\nkubectl apply -f https://git.io/vPieo         <span class="token comment"># 从 URL 中创建资源</span>\nkubectl create deployment nginx --image<span class="token operator">=</span>nginx <span class="token comment"># 启动单实例 nginx</span>\n\n<span class="token comment"># 创建一个打印 “Hello World” 的 Job</span>\nkubectl create job hello --image<span class="token operator">=</span>busybox:1.28 -- <span class="token builtin class-name">echo</span> <span class="token string">"Hello World"</span>\n\n<span class="token comment"># 创建一个打印 “Hello World” 间隔 1 分钟的 CronJob</span>\nkubectl create cronjob hello --image<span class="token operator">=</span>busybox:1.28 --schedule<span class="token operator">=</span><span class="token string">"*/1 * * * *"</span> -- <span class="token builtin class-name">echo</span> <span class="token string">"Hello World"</span>\n\nkubectl explain pods                          <span class="token comment"># 获取 pod 清单的文档说明</span>\n\n<span class="token comment"># 从标准输入创建多个 YAML 对象</span>\n<span class="token function">cat</span> <span class="token operator">&lt;&lt;</span>EOF <span class="token operator">|</span> kubectl apply -f -\napiVersion: v1\nkind: Pod\nmetadata:\n  name: busybox-sleep\nspec:\n  containers:\n  - name: busybox\n    image: busybox:1.28\n    args:\n    - <span class="token function">sleep</span>\n    - <span class="token string">"1000000"</span>\n---\napiVersion: v1\nkind: Pod\nmetadata:\n  name: busybox-sleep-less\nspec:\n  containers:\n  - name: busybox\n    image: busybox:1.28\n    args:\n    - <span class="token function">sleep</span>\n    - <span class="token string">"1000"</span>\nEOF\n\n<span class="token comment"># 创建有多个 key 的 Secret</span>\n<span class="token function">cat</span> <span class="token operator">&lt;&lt;</span>EOF <span class="token operator">|</span> kubectl apply -f -\napiVersion: v1\nkind: Secret\nmetadata:\n  name: mysecret\ntype: Opaque\ndata:\n  password: <span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">echo</span> -n <span class="token string">"s33msi4"</span> <span class="token operator">|</span> base64 -w0<span class="token variable">)</span></span>\n  username: <span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">echo</span> -n <span class="token string">"jane"</span> <span class="token operator">|</span> base64 -w0<span class="token variable">)</span></span>\nEOF</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="查看和查找资源"><a href="#%E6%9F%A5%E7%9C%8B%E5%92%8C%E6%9F%A5%E6%89%BE%E8%B5%84%E6%BA%90" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>查看和查找资源</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="36502104944978076000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# get 命令的基本输出\nkubectl get services                          # 列出当前命名空间下的所有 services\nkubectl get pods --all-namespaces             # 列出所有命名空间下的全部的 Pods\nkubectl get pods -o wide                      # 列出当前命名空间下的全部 Pods，并显示更详细的信息\nkubectl get deployment my-dep                 # 列出某个特定的 Deployment\nkubectl get pods                              # 列出当前命名空间下的全部 Pods\nkubectl get pod my-pod -o yaml                # 获取一个 pod 的 YAML\n\n# describe 命令的详细输出\nkubectl describe nodes my-node\nkubectl describe pods my-pod\n\n# 列出当前名字空间下所有 Services，按名称排序\nkubectl get services --sort-by=.metadata.name\n\n# 列出 Pods，按重启次数排序\nkubectl get pods --sort-by=\'.status.containerStatuses[0].restartCount\'\n\n# 列举所有 PV 持久卷，按容量排序\nkubectl get pv --sort-by=.spec.capacity.storage\n\n# 获取包含 app=cassandra 标签的所有 Pods 的 version 标签\nkubectl get pods --selector=app=cassandra -o \\\n  jsonpath=\'{.items[*].metadata.labels.version}\'\n\n# 检索带有 “.” 键值，例： \'ca.crt\'\nkubectl get configmap myconfig \\\n  -o jsonpath=\'{.data.ca\\.crt}\'\n\n# 检索一个 base64 编码的值，其中的键名应该包含减号而不是下划线。\nkubectl get secret my-secret --template=\'{{index .data &quot;key-name-with-dashes&quot;}}\'\n\n# 获取所有工作节点（使用选择器以排除标签名称为 \'node-role.kubernetes.io/control-plane\' 的结果）\nkubectl get node --selector=\'!node-role.kubernetes.io/control-plane\'\n\n# 获取当前命名空间中正在运行的 Pods\nkubectl get pods --field-selector=status.phase=Running\n\n# 获取全部节点的 ExternalIP 地址\nkubectl get nodes -o jsonpath=\'{.items[*].status.addresses[?(@.type==&quot;ExternalIP&quot;)].address}\'\n\n# 列出属于某个特定 RC 的 Pods 的名称\n# 在转换对于 jsonpath 过于复杂的场合，&quot;jq&quot; 命令很有用；可以在 https://stedolan.github.io/jq/ 找到它。\nsel=\\${\\$(kubectl get rc my-rc --output=json | jq -j \'.spec.selector | to_entries | .[] | &quot;\\(.key)=\\(.value),&quot;\')%?}\necho \\$(kubectl get pods --selector=\\$sel --output=jsonpath={.items..metadata.name})\n\n# 显示所有 Pods 的标签（或任何其他支持标签的 Kubernetes 对象）\nkubectl get pods --show-labels\n\n# 检查哪些节点处于就绪状态\nJSONPATH=\'{range .items[*]}{@.metadata.name}:{range @.status.conditions[*]}{@.type}={@.status};{end}{end}\' \\\n && kubectl get nodes -o jsonpath=&quot;\\$JSONPATH&quot; | grep &quot;Ready=True&quot;\n\n# 不使用外部工具来输出解码后的 Secret\nkubectl get secret my-secret -o go-template=\'{{range \\$k,\\$v := .data}}{{&quot;### &quot;}}{{\\$k}}{{&quot;\\n&quot;}}{{\\$v|base64decode}}{{&quot;\\n\\n&quot;}}{{end}}\'\n\n# 列出被一个 Pod 使用的全部 Secret\nkubectl get pods -o json | jq \'.items[].spec.containers[].env[]?.valueFrom.secretKeyRef.name\' | grep -v null | sort | uniq\n\n# 列举所有 Pods 中初始化容器的容器 ID（containerID）\n# 可用于在清理已停止的容器时避免删除初始化容器\nkubectl get pods --all-namespaces -o jsonpath=\'{range .items[*].status.initContainerStatuses[*]}{.containerID}{&quot;\\n&quot;}{end}\' | cut -d/ -f3\n\n# 列出事件（Events），按时间戳排序\nkubectl get events --sort-by=.metadata.creationTimestamp\n\n# 比较当前的集群状态和假定某清单被应用之后的集群状态\nkubectl diff -f ./my-manifest.yaml\n\n# 生成一个句点分隔的树，其中包含为节点返回的所有键\n# 在复杂的嵌套JSON结构中定位键时非常有用\nkubectl get nodes -o json | jq -c \'paths|join(&quot;.&quot;)\'\n\n# 生成一个句点分隔的树，其中包含为pod等返回的所有键\nkubectl get pods -o json | jq -c \'paths|join(&quot;.&quot;)\'\n\n# 假设你的 Pods 有默认的容器和默认的名字空间，并且支持 \'env\' 命令，可以使用以下脚本为所有 Pods 生成 ENV 变量。\n# 该脚本也可用于在所有的 Pods 里运行任何受支持的命令，而不仅仅是 \'env\'。\nfor pod in \\$(kubectl get po --output=jsonpath={.items..metadata.name}); do echo \\$pod && kubectl exec -it \\$pod -- env; done\n\n# 获取一个 Deployment 的 status 子资源\nkubectl get deployment nginx-deployment --subresource=status`, `36502104944978076000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token comment"># get 命令的基本输出</span>\nkubectl get services                          <span class="token comment"># 列出当前命名空间下的所有 services</span>\nkubectl get pods --all-namespaces             <span class="token comment"># 列出所有命名空间下的全部的 Pods</span>\nkubectl get pods -o wide                      <span class="token comment"># 列出当前命名空间下的全部 Pods，并显示更详细的信息</span>\nkubectl get deployment my-dep                 <span class="token comment"># 列出某个特定的 Deployment</span>\nkubectl get pods                              <span class="token comment"># 列出当前命名空间下的全部 Pods</span>\nkubectl get pod my-pod -o yaml                <span class="token comment"># 获取一个 pod 的 YAML</span>\n\n<span class="token comment"># describe 命令的详细输出</span>\nkubectl describe nodes my-node\nkubectl describe pods my-pod\n\n<span class="token comment"># 列出当前名字空间下所有 Services，按名称排序</span>\nkubectl get services --sort-by<span class="token operator">=</span>.metadata.name\n\n<span class="token comment"># 列出 Pods，按重启次数排序</span>\nkubectl get pods --sort-by<span class="token operator">=</span><span class="token string">\'.status.containerStatuses[0].restartCount\'</span>\n\n<span class="token comment"># 列举所有 PV 持久卷，按容量排序</span>\nkubectl get <span class="token function">pv</span> --sort-by<span class="token operator">=</span>.spec.capacity.storage\n\n<span class="token comment"># 获取包含 app=cassandra 标签的所有 Pods 的 version 标签</span>\nkubectl get pods --selector<span class="token operator">=</span>app<span class="token operator">=</span>cassandra -o <span class="token punctuation">\\</span>\n  <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token string">\'{.items[*].metadata.labels.version}\'</span>\n\n<span class="token comment"># 检索带有 “.” 键值，例： \'ca.crt\'</span>\nkubectl get configmap myconfig <span class="token punctuation">\\</span>\n  -o <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token string">\'{.data.ca\\.crt}\'</span>\n\n<span class="token comment"># 检索一个 base64 编码的值，其中的键名应该包含减号而不是下划线。</span>\nkubectl get secret my-secret --template<span class="token operator">=</span><span class="token string">\'{{index .data "key-name-with-dashes"}}\'</span>\n\n<span class="token comment"># 获取所有工作节点（使用选择器以排除标签名称为 \'node-role.kubernetes.io/control-plane\' 的结果）</span>\nkubectl get node --selector<span class="token operator">=</span><span class="token string">\'!node-role.kubernetes.io/control-plane\'</span>\n\n<span class="token comment"># 获取当前命名空间中正在运行的 Pods</span>\nkubectl get pods --field-selector<span class="token operator">=</span>status.phase<span class="token operator">=</span>Running\n\n<span class="token comment"># 获取全部节点的 ExternalIP 地址</span>\nkubectl get nodes -o <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token string">\'{.items[*].status.addresses[?(@.type=="ExternalIP")].address}\'</span>\n\n<span class="token comment"># 列出属于某个特定 RC 的 Pods 的名称</span>\n<span class="token comment"># 在转换对于 jsonpath 过于复杂的场合，"jq" 命令很有用；可以在 https://stedolan.github.io/jq/ 找到它。</span>\n<span class="token assign-left variable">sel</span><span class="token operator">=</span><span class="token variable">${$(kubectl get rc my-rc --output=json | jq -j \'.spec.selector | to_entries | .<span class="token punctuation">[</span><span class="token punctuation">]</span> | "\\(.key)=\\(.value)<span class="token operator">,</span>"\')<span class="token operator">%</span>?}</span>\n<span class="token builtin class-name">echo</span> <span class="token variable"><span class="token variable">$(</span>kubectl get pods --selector<span class="token operator">=</span>$sel --output<span class="token operator">=</span>jsonpath<span class="token operator">=</span><span class="token punctuation">{</span>.items<span class="token punctuation">..</span>metadata.name<span class="token punctuation">}</span><span class="token variable">)</span></span>\n\n<span class="token comment"># 显示所有 Pods 的标签（或任何其他支持标签的 Kubernetes 对象）</span>\nkubectl get pods --show-labels\n\n<span class="token comment"># 检查哪些节点处于就绪状态</span>\n<span class="token assign-left variable">JSONPATH</span><span class="token operator">=</span><span class="token string">\'{range .items[*]}{@.metadata.name}:{range @.status.conditions[*]}{@.type}={@.status};{end}{end}\'</span> <span class="token punctuation">\\</span>\n <span class="token operator">&amp;&amp;</span> kubectl get nodes -o <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token string">"<span class="token variable">$JSONPATH</span>"</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">"Ready=True"</span>\n\n<span class="token comment"># 不使用外部工具来输出解码后的 Secret</span>\nkubectl get secret my-secret -o go-template<span class="token operator">=</span><span class="token string">\'{{range <span class="token variable">$k</span>,<span class="token variable">$v</span> := .data}}{{"### "}}{{<span class="token variable">$k</span>}}{{"<span class="token entity" title="\\n">\\n</span>"}}{{<span class="token variable">$v</span>|base64decode}}{{"<span class="token entity" title="\\n">\\n</span><span class="token entity" title="\\n">\\n</span>"}}{{end}}\'</span>\n\n<span class="token comment"># 列出被一个 Pod 使用的全部 Secret</span>\nkubectl get pods -o json <span class="token operator">|</span> jq <span class="token string">\'.items[].spec.containers[].env[]?.valueFrom.secretKeyRef.name\'</span> <span class="token operator">|</span> <span class="token function">grep</span> -v null <span class="token operator">|</span> <span class="token function">sort</span> <span class="token operator">|</span> <span class="token function">uniq</span>\n\n<span class="token comment"># 列举所有 Pods 中初始化容器的容器 ID（containerID）</span>\n<span class="token comment"># 可用于在清理已停止的容器时避免删除初始化容器</span>\nkubectl get pods --all-namespaces -o <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token string">\'{range .items[*].status.initContainerStatuses[*]}{.containerID}{"<span class="token entity" title="\\n">\\n</span>"}{end}\'</span> <span class="token operator">|</span> <span class="token function">cut</span> -d/ -f3\n\n<span class="token comment"># 列出事件（Events），按时间戳排序</span>\nkubectl get events --sort-by<span class="token operator">=</span>.metadata.creationTimestamp\n\n<span class="token comment"># 比较当前的集群状态和假定某清单被应用之后的集群状态</span>\nkubectl <span class="token function">diff</span> -f ./my-manifest.yaml\n\n<span class="token comment"># 生成一个句点分隔的树，其中包含为节点返回的所有键</span>\n<span class="token comment"># 在复杂的嵌套JSON结构中定位键时非常有用</span>\nkubectl get nodes -o json <span class="token operator">|</span> jq -c <span class="token string">\'paths|join(".")\'</span>\n\n<span class="token comment"># 生成一个句点分隔的树，其中包含为pod等返回的所有键</span>\nkubectl get pods -o json <span class="token operator">|</span> jq -c <span class="token string">\'paths|join(".")\'</span>\n\n<span class="token comment"># 假设你的 Pods 有默认的容器和默认的名字空间，并且支持 \'env\' 命令，可以使用以下脚本为所有 Pods 生成 ENV 变量。</span>\n<span class="token comment"># 该脚本也可用于在所有的 Pods 里运行任何受支持的命令，而不仅仅是 \'env\'。</span>\n<span class="token keyword">for</span> <span class="token for-or-select variable">pod</span> <span class="token keyword">in</span> <span class="token variable"><span class="token variable">$(</span>kubectl get po --output<span class="token operator">=</span>jsonpath<span class="token operator">=</span><span class="token punctuation">{</span>.items<span class="token punctuation">..</span>metadata.name<span class="token punctuation">}</span><span class="token variable">)</span></span><span class="token punctuation">;</span> <span class="token keyword">do</span> <span class="token builtin class-name">echo</span> <span class="token variable">$pod</span> <span class="token operator">&amp;&amp;</span> kubectl <span class="token builtin class-name">exec</span> -it <span class="token variable">$pod</span> -- <span class="token function">env</span><span class="token punctuation">;</span> <span class="token keyword">done</span>\n\n<span class="token comment"># 获取一个 Deployment 的 status 子资源</span>\nkubectl get deployment nginx-deployment --subresource<span class="token operator">=</span>status</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="更新资源"><a href="#%E6%9B%B4%E6%96%B0%E8%B5%84%E6%BA%90" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>更新资源</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="10156027685409219000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`kubectl set image deployment/frontend www=image:v2               # 滚动更新 &quot;frontend&quot; Deployment 的 &quot;www&quot; 容器镜像\nkubectl rollout history deployment/frontend                      # 检查 Deployment 的历史记录，包括版本\nkubectl rollout undo deployment/frontend                         # 回滚到上次部署版本\nkubectl rollout undo deployment/frontend --to-revision=2         # 回滚到特定部署版本\nkubectl rollout status -w deployment/frontend                    # 监视 &quot;frontend&quot; Deployment 的滚动升级状态直到完成\nkubectl rollout restart deployment/frontend                      # 轮替重启 &quot;frontend&quot; Deployment\n\ncat pod.json | kubectl replace -f -                              # 通过传入到标准输入的 JSON 来替换 Pod\n\n# 强制替换，删除后重建资源。会导致服务不可用。\nkubectl replace --force -f ./pod.json\n\n# 为多副本的 nginx 创建服务，使用 80 端口提供服务，连接到容器的 8000 端口。\nkubectl expose rc nginx --port=80 --target-port=8000\n\n# 将某单容器 Pod 的镜像版本（标签）更新到 v4\nkubectl get pod mypod -o yaml | sed \'s/\\(image: myimage\\):.*\\$/\\1:v4/\' | kubectl replace -f -\n\nkubectl label pods my-pod new-label=awesome                      # 添加标签\nkubectl annotate pods my-pod icon-url=http://goo.gl/XXBTWq       # 添加注解\nkubectl autoscale deployment foo --min=2 --max=10                # 对 &quot;foo&quot; Deployment 自动伸缩容`, `10156027685409219000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">kubectl <span class="token builtin class-name">set</span> image deployment/frontend <span class="token assign-left variable">www</span><span class="token operator">=</span>image:v2               <span class="token comment"># 滚动更新 "frontend" Deployment 的 "www" 容器镜像</span>\nkubectl rollout <span class="token function">history</span> deployment/frontend                      <span class="token comment"># 检查 Deployment 的历史记录，包括版本</span>\nkubectl rollout undo deployment/frontend                         <span class="token comment"># 回滚到上次部署版本</span>\nkubectl rollout undo deployment/frontend --to-revision<span class="token operator">=</span><span class="token number">2</span>         <span class="token comment"># 回滚到特定部署版本</span>\nkubectl rollout status -w deployment/frontend                    <span class="token comment"># 监视 "frontend" Deployment 的滚动升级状态直到完成</span>\nkubectl rollout restart deployment/frontend                      <span class="token comment"># 轮替重启 "frontend" Deployment</span>\n\n<span class="token function">cat</span> pod.json <span class="token operator">|</span> kubectl replace -f -                              <span class="token comment"># 通过传入到标准输入的 JSON 来替换 Pod</span>\n\n<span class="token comment"># 强制替换，删除后重建资源。会导致服务不可用。</span>\nkubectl replace --force -f ./pod.json\n\n<span class="token comment"># 为多副本的 nginx 创建服务，使用 80 端口提供服务，连接到容器的 8000 端口。</span>\nkubectl expose rc nginx --port<span class="token operator">=</span><span class="token number">80</span> --target-port<span class="token operator">=</span><span class="token number">8000</span>\n\n<span class="token comment"># 将某单容器 Pod 的镜像版本（标签）更新到 v4</span>\nkubectl get pod mypod -o yaml <span class="token operator">|</span> <span class="token function">sed</span> <span class="token string">\'s/\\(image: myimage\\):.*$/<span class="token entity" title="\\1">\\1</span>:v4/\'</span> <span class="token operator">|</span> kubectl replace -f -\n\nkubectl label pods my-pod new-label<span class="token operator">=</span>awesome                      <span class="token comment"># 添加标签</span>\nkubectl annotate pods my-pod icon-url<span class="token operator">=</span>http://goo.gl/XXBTWq       <span class="token comment"># 添加注解</span>\nkubectl autoscale deployment foo --min<span class="token operator">=</span><span class="token number">2</span> --max<span class="token operator">=</span><span class="token number">10</span>                <span class="token comment"># 对 "foo" Deployment 自动伸缩容</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="部分更新资源"><a href="#%E9%83%A8%E5%88%86%E6%9B%B4%E6%96%B0%E8%B5%84%E6%BA%90" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>部分更新资源</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="57935043843712380000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# 部分更新某节点\nkubectl patch node k8s-node-1 -p \'{&quot;spec&quot;:{&quot;unschedulable&quot;:true}}\'\n\n# 更新容器的镜像；spec.containers[*].name 是必须的。因为它是一个合并性质的主键。\nkubectl patch pod valid-pod -p \'{&quot;spec&quot;:{&quot;containers&quot;:[{&quot;name&quot;:&quot;kubernetes-serve-hostname&quot;,&quot;image&quot;:&quot;new image&quot;}]}}\'\n\n# 使用带位置数组的 JSON patch 更新容器的镜像\nkubectl patch pod valid-pod --type=\'json\' -p=\'[{&quot;op&quot;: &quot;replace&quot;, &quot;path&quot;: &quot;/spec/containers/0/image&quot;, &quot;value&quot;:&quot;new image&quot;}]\'\n\n# 使用带位置数组的 JSON patch 禁用某 Deployment 的 livenessProbe\nkubectl patch deployment valid-deployment  --type json   -p=\'[{&quot;op&quot;: &quot;remove&quot;, &quot;path&quot;: &quot;/spec/template/spec/containers/0/livenessProbe&quot;}]\'\n\n# 在带位置数组中添加元素\nkubectl patch sa default --type=\'json\' -p=\'[{&quot;op&quot;: &quot;add&quot;, &quot;path&quot;: &quot;/secrets/1&quot;, &quot;value&quot;: {&quot;name&quot;: &quot;whatever&quot; } }]\'\n\n# 通过修正 scale 子资源来更新 Deployment 的副本数\nkubectl patch deployment nginx-deployment --subresource=\'scale\' --type=\'merge\' -p \'{&quot;spec&quot;:{&quot;replicas&quot;:2}}\'`, `57935043843712380000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token comment"># 部分更新某节点</span>\nkubectl patch node k8s-node-1 -p <span class="token string">\'{"spec":{"unschedulable":true}}\'</span>\n\n<span class="token comment"># 更新容器的镜像；spec.containers[*].name 是必须的。因为它是一个合并性质的主键。</span>\nkubectl patch pod valid-pod -p <span class="token string">\'{"spec":{"containers":[{"name":"kubernetes-serve-hostname","image":"new image"}]}}\'</span>\n\n<span class="token comment"># 使用带位置数组的 JSON patch 更新容器的镜像</span>\nkubectl patch pod valid-pod --type<span class="token operator">=</span><span class="token string">\'json\'</span> -p<span class="token operator">=</span><span class="token string">\'[{"op": "replace", "path": "/spec/containers/0/image", "value":"new image"}]\'</span>\n\n<span class="token comment"># 使用带位置数组的 JSON patch 禁用某 Deployment 的 livenessProbe</span>\nkubectl patch deployment valid-deployment  --type json   -p<span class="token operator">=</span><span class="token string">\'[{"op": "remove", "path": "/spec/template/spec/containers/0/livenessProbe"}]\'</span>\n\n<span class="token comment"># 在带位置数组中添加元素</span>\nkubectl patch sa default --type<span class="token operator">=</span><span class="token string">\'json\'</span> -p<span class="token operator">=</span><span class="token string">\'[{"op": "add", "path": "/secrets/1", "value": {"name": "whatever" } }]\'</span>\n\n<span class="token comment"># 通过修正 scale 子资源来更新 Deployment 的副本数</span>\nkubectl patch deployment nginx-deployment --subresource<span class="token operator">=</span><span class="token string">\'scale\'</span> --type<span class="token operator">=</span><span class="token string">\'merge\'</span> -p <span class="token string">\'{"spec":{"replicas":2}}\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="编辑资源"><a href="#%E7%BC%96%E8%BE%91%E8%B5%84%E6%BA%90" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>编辑资源</h4>\n<p>使用你偏爱的编辑器编辑 API 资源。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="13427736933993329000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`kubectl edit svc/docker-registry                      # 编辑名为 docker-registry 的服务\nKUBE_EDITOR=&quot;nano&quot; kubectl edit svc/docker-registry   # 使用其他编辑器`, `13427736933993329000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">kubectl edit svc/docker-registry                      <span class="token comment"># 编辑名为 docker-registry 的服务</span>\n<span class="token assign-left variable">KUBE_EDITOR</span><span class="token operator">=</span><span class="token string">"nano"</span> kubectl edit svc/docker-registry   <span class="token comment"># 使用其他编辑器</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<h4 id="对资源进行伸缩"><a href="#%E5%AF%B9%E8%B5%84%E6%BA%90%E8%BF%9B%E8%A1%8C%E4%BC%B8%E7%BC%A9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>对资源进行伸缩</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="54438162150516466000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`kubectl scale --replicas=3 rs/foo                                 # 将名为 \'foo\' 的副本集伸缩到 3 副本\nkubectl scale --replicas=3 -f foo.yaml                            # 将在 &quot;foo.yaml&quot; 中的特定资源伸缩到 3 个副本\nkubectl scale --current-replicas=2 --replicas=3 deployment/mysql  # 如果名为 mysql 的 Deployment 的副本当前是 2，那么将它伸缩到 3\nkubectl scale --replicas=5 rc/foo rc/bar rc/baz                   # 伸缩多个副本控制器`, `54438162150516466000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">kubectl scale --replicas<span class="token operator">=</span><span class="token number">3</span> rs/foo                                 <span class="token comment"># 将名为 \'foo\' 的副本集伸缩到 3 副本</span>\nkubectl scale --replicas<span class="token operator">=</span><span class="token number">3</span> -f foo.yaml                            <span class="token comment"># 将在 "foo.yaml" 中的特定资源伸缩到 3 个副本</span>\nkubectl scale --current-replicas<span class="token operator">=</span><span class="token number">2</span> --replicas<span class="token operator">=</span><span class="token number">3</span> deployment/mysql  <span class="token comment"># 如果名为 mysql 的 Deployment 的副本当前是 2，那么将它伸缩到 3</span>\nkubectl scale --replicas<span class="token operator">=</span><span class="token number">5</span> rc/foo rc/bar rc/baz                   <span class="token comment"># 伸缩多个副本控制器</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="删除资源"><a href="#%E5%88%A0%E9%99%A4%E8%B5%84%E6%BA%90" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>删除资源</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="83746217302148090000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`kubectl delete -f ./pod.json                                              # 删除在 pod.json 中指定的类型和名称的 Pod\nkubectl delete pod,service baz foo                                        # 删除名称为 &quot;baz&quot; 和 &quot;foo&quot; 的 Pod 和服务\nkubectl delete pods,services -l name=myLabel                              # 删除包含 name=myLabel 标签的 pods 和服务\nkubectl -n my-ns delete pod,svc --all                                     # 删除在 my-ns 名字空间中全部的 Pods 和服务\n# 删除所有与 pattern1 或 pattern2 awk 模式匹配的 Pods\nkubectl get pods  -n mynamespace --no-headers=true | awk \'/pattern1|pattern2/{print \\$1}\' | xargs  kubectl delete -n mynamespace pod`, `83746217302148090000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">kubectl delete -f ./pod.json                                              <span class="token comment"># 删除在 pod.json 中指定的类型和名称的 Pod</span>\nkubectl delete pod,service baz foo                                        <span class="token comment"># 删除名称为 "baz" 和 "foo" 的 Pod 和服务</span>\nkubectl delete pods,services -l <span class="token assign-left variable">name</span><span class="token operator">=</span>myLabel                              <span class="token comment"># 删除包含 name=myLabel 标签的 pods 和服务</span>\nkubectl -n my-ns delete pod,svc --all                                     <span class="token comment"># 删除在 my-ns 名字空间中全部的 Pods 和服务</span>\n<span class="token comment"># 删除所有与 pattern1 或 pattern2 awk 模式匹配的 Pods</span>\nkubectl get pods  -n mynamespace --no-headers<span class="token operator">=</span>true <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">\'/pattern1|pattern2/{print <span class="token variable">$1</span>}\'</span> <span class="token operator">|</span> <span class="token function">xargs</span>  kubectl delete -n mynamespace pod</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="与运行中的-pods-进行交互"><a href="#%E4%B8%8E%E8%BF%90%E8%A1%8C%E4%B8%AD%E7%9A%84-pods-%E8%BF%9B%E8%A1%8C%E4%BA%A4%E4%BA%92" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>与运行中的 Pods 进行交互</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="9902892178136380000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`kubectl logs my-pod                                 # 获取 pod 日志（标准输出）\nkubectl logs -l name=myLabel                        # 获取含 name=myLabel 标签的 Pods 的日志（标准输出）\nkubectl logs my-pod --previous                      # 获取上个容器实例的 pod 日志（标准输出）\nkubectl logs my-pod -c my-container                 # 获取 Pod 容器的日志（标准输出, 多容器场景）\nkubectl logs -l name=myLabel -c my-container        # 获取含 name=myLabel 标签的 Pod 容器日志（标准输出, 多容器场景）\nkubectl logs my-pod -c my-container --previous      # 获取 Pod 中某容器的上个实例的日志（标准输出, 多容器场景）\nkubectl logs -f my-pod                              # 流式输出 Pod 的日志（标准输出）\nkubectl logs -f my-pod -c my-container              # 流式输出 Pod 容器的日志（标准输出, 多容器场景）\nkubectl logs -f -l name=myLabel --all-containers    # 流式输出含 name=myLabel 标签的 Pod 的所有日志（标准输出）\nkubectl run -i --tty busybox --image=busybox:1.28 -- sh  # 以交互式 Shell 运行 Pod\nkubectl run nginx --image=nginx -n mynamespace      # 在 “mynamespace” 命名空间中运行单个 nginx Pod\nkubectl run nginx --image=nginx                     # 运行 ngins Pod 并将其规约写入到名为 pod.yaml 的文件\n  --dry-run=client -o yaml > pod.yaml\n\nkubectl attach my-pod -i                            # 挂接到一个运行的容器中\nkubectl port-forward my-pod 5000:6000               # 在本地计算机上侦听端口 5000 并转发到 my-pod 上的端口 6000\nkubectl exec my-pod -- ls /                         # 在已有的 Pod 中运行命令（单容器场景）\nkubectl exec --stdin --tty my-pod -- /bin/sh        # 使用交互 shell 访问正在运行的 Pod (一个容器场景)\nkubectl exec my-pod -c my-container -- ls /         # 在已有的 Pod 中运行命令（多容器场景）\nkubectl top pod POD_NAME --containers               # 显示给定 Pod 和其中容器的监控数据\nkubectl top pod POD_NAME --sort-by=cpu              # 显示给定 Pod 的指标并且按照 \'cpu\' 或者 \'memory\' 排序`, `9902892178136380000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">kubectl logs my-pod                                 <span class="token comment"># 获取 pod 日志（标准输出）</span>\nkubectl logs -l <span class="token assign-left variable">name</span><span class="token operator">=</span>myLabel                        <span class="token comment"># 获取含 name=myLabel 标签的 Pods 的日志（标准输出）</span>\nkubectl logs my-pod --previous                      <span class="token comment"># 获取上个容器实例的 pod 日志（标准输出）</span>\nkubectl logs my-pod -c my-container                 <span class="token comment"># 获取 Pod 容器的日志（标准输出, 多容器场景）</span>\nkubectl logs -l <span class="token assign-left variable">name</span><span class="token operator">=</span>myLabel -c my-container        <span class="token comment"># 获取含 name=myLabel 标签的 Pod 容器日志（标准输出, 多容器场景）</span>\nkubectl logs my-pod -c my-container --previous      <span class="token comment"># 获取 Pod 中某容器的上个实例的日志（标准输出, 多容器场景）</span>\nkubectl logs -f my-pod                              <span class="token comment"># 流式输出 Pod 的日志（标准输出）</span>\nkubectl logs -f my-pod -c my-container              <span class="token comment"># 流式输出 Pod 容器的日志（标准输出, 多容器场景）</span>\nkubectl logs -f -l <span class="token assign-left variable">name</span><span class="token operator">=</span>myLabel --all-containers    <span class="token comment"># 流式输出含 name=myLabel 标签的 Pod 的所有日志（标准输出）</span>\nkubectl run -i --tty busybox --image<span class="token operator">=</span>busybox:1.28 -- <span class="token function">sh</span>  <span class="token comment"># 以交互式 Shell 运行 Pod</span>\nkubectl run nginx --image<span class="token operator">=</span>nginx -n mynamespace      <span class="token comment"># 在 “mynamespace” 命名空间中运行单个 nginx Pod</span>\nkubectl run nginx --image<span class="token operator">=</span>nginx                     <span class="token comment"># 运行 ngins Pod 并将其规约写入到名为 pod.yaml 的文件</span>\n  --dry-run<span class="token operator">=</span>client -o yaml <span class="token operator">></span> pod.yaml\n\nkubectl attach my-pod -i                            <span class="token comment"># 挂接到一个运行的容器中</span>\nkubectl port-forward my-pod <span class="token number">5000</span>:6000               <span class="token comment"># 在本地计算机上侦听端口 5000 并转发到 my-pod 上的端口 6000</span>\nkubectl <span class="token builtin class-name">exec</span> my-pod -- <span class="token function">ls</span> /                         <span class="token comment"># 在已有的 Pod 中运行命令（单容器场景）</span>\nkubectl <span class="token builtin class-name">exec</span> --stdin --tty my-pod -- /bin/sh        <span class="token comment"># 使用交互 shell 访问正在运行的 Pod (一个容器场景)</span>\nkubectl <span class="token builtin class-name">exec</span> my-pod -c my-container -- <span class="token function">ls</span> /         <span class="token comment"># 在已有的 Pod 中运行命令（多容器场景）</span>\nkubectl <span class="token function">top</span> pod POD_NAME --containers               <span class="token comment"># 显示给定 Pod 和其中容器的监控数据</span>\nkubectl <span class="token function">top</span> pod POD_NAME --sort-by<span class="token operator">=</span>cpu              <span class="token comment"># 显示给定 Pod 的指标并且按照 \'cpu\' 或者 \'memory\' 排序</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="从容器中复制文件和目录"><a href="#%E4%BB%8E%E5%AE%B9%E5%99%A8%E4%B8%AD%E5%A4%8D%E5%88%B6%E6%96%87%E4%BB%B6%E5%92%8C%E7%9B%AE%E5%BD%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>从容器中复制文件和目录</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="84970945980491580000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`kubectl cp /tmp/foo_dir my-pod:/tmp/bar_dir            # 将 /tmp/foo_dir 本地目录复制到远程当前命名空间中 Pod 中的 /tmp/bar_dir\nkubectl cp /tmp/foo my-pod:/tmp/bar -c my-container    # 将 /tmp/foo 本地文件复制到远程 Pod 中特定容器的 /tmp/bar 下\nkubectl cp /tmp/foo my-namespace/my-pod:/tmp/bar       # 将 /tmp/foo 本地文件复制到远程 “my-namespace” 命名空间内指定 Pod 中的 /tmp/bar\nkubectl cp my-namespace/my-pod:/tmp/foo /tmp/bar       # 将 /tmp/foo 从远程 Pod 复制到本地 /tmp/bar`, `84970945980491580000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">kubectl <span class="token function">cp</span> /tmp/foo_dir my-pod:/tmp/bar_dir            <span class="token comment"># 将 /tmp/foo_dir 本地目录复制到远程当前命名空间中 Pod 中的 /tmp/bar_dir</span>\nkubectl <span class="token function">cp</span> /tmp/foo my-pod:/tmp/bar -c my-container    <span class="token comment"># 将 /tmp/foo 本地文件复制到远程 Pod 中特定容器的 /tmp/bar 下</span>\nkubectl <span class="token function">cp</span> /tmp/foo my-namespace/my-pod:/tmp/bar       <span class="token comment"># 将 /tmp/foo 本地文件复制到远程 “my-namespace” 命名空间内指定 Pod 中的 /tmp/bar</span>\nkubectl <span class="token function">cp</span> my-namespace/my-pod:/tmp/foo /tmp/bar       <span class="token comment"># 将 /tmp/foo 从远程 Pod 复制到本地 /tmp/bar</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<blockquote>\n<p>说明：<code class="language-text">kubectl cp</code> 要求容器镜像中存在 <code class="language-text">tar</code> 二进制文件。如果 <code class="language-text">tar</code> 不存在，<code class="language-text">kubectl cp</code> 将失败。对于进阶用例，例如符号链接、通配符扩展或保留文件权限，请考虑使用 <code class="language-text">kubectl exec</code>。</p>\n</blockquote>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="38527436650849450000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`tar cf - /tmp/foo | kubectl exec -i -n my-namespace my-pod -- tar xf - -C /tmp/bar  # 将 /tmp/foo 本地文件复制到远程 “my-namespace” 命名空间中 pod 中的 /tmp/bar\nkubectl exec -n my-namespace my-pod -- tar cf - /tmp/foo | tar xf - -C /tmp/bar    # 将 /tmp/foo 从远程 pod 复制到本地 /tmp/bar`, `38527436650849450000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token function">tar</span> cf - /tmp/foo <span class="token operator">|</span> kubectl <span class="token builtin class-name">exec</span> -i -n my-namespace my-pod -- <span class="token function">tar</span> xf - -C /tmp/bar  <span class="token comment"># 将 /tmp/foo 本地文件复制到远程 “my-namespace” 命名空间中 pod 中的 /tmp/bar</span>\nkubectl <span class="token builtin class-name">exec</span> -n my-namespace my-pod -- <span class="token function">tar</span> cf - /tmp/foo <span class="token operator">|</span> <span class="token function">tar</span> xf - -C /tmp/bar    <span class="token comment"># 将 /tmp/foo 从远程 pod 复制到本地 /tmp/bar</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<h4 id="与-deployments-和-services-进行交互"><a href="#%E4%B8%8E-deployments-%E5%92%8C-services-%E8%BF%9B%E8%A1%8C%E4%BA%A4%E4%BA%92" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>与 Deployments 和 Services 进行交互</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="39146994257826400000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`kubectl logs deploy/my-deployment                         # 获取一个 Deployment 的 Pod 的日志（单容器例子）\nkubectl logs deploy/my-deployment -c my-container         # 获取一个 Deployment 的 Pod 的日志（多容器例子）\n\nkubectl port-forward svc/my-service 5000                  # 侦听本地端口 5000 并转发到 Service 后端端口 5000\nkubectl port-forward svc/my-service 5000:my-service-port  # 侦听本地端口 5000 并转发到名字为 <my-service-port> 的 Service 目标端口\n\nkubectl port-forward deploy/my-deployment 5000:6000       # 侦听本地端口 5000 并转发到 <my-deployment> 创建的 Pod 里的端口 6000\nkubectl exec deploy/my-deployment -- ls                   # 在 Deployment 里的第一个 Pod 的第一个容器里运行命令（单容器和多容器例子）`, `39146994257826400000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">kubectl logs deploy/my-deployment                         <span class="token comment"># 获取一个 Deployment 的 Pod 的日志（单容器例子）</span>\nkubectl logs deploy/my-deployment -c my-container         <span class="token comment"># 获取一个 Deployment 的 Pod 的日志（多容器例子）</span>\n\nkubectl port-forward svc/my-service <span class="token number">5000</span>                  <span class="token comment"># 侦听本地端口 5000 并转发到 Service 后端端口 5000</span>\nkubectl port-forward svc/my-service <span class="token number">5000</span>:my-service-port  <span class="token comment"># 侦听本地端口 5000 并转发到名字为 &lt;my-service-port> 的 Service 目标端口</span>\n\nkubectl port-forward deploy/my-deployment <span class="token number">5000</span>:6000       <span class="token comment"># 侦听本地端口 5000 并转发到 &lt;my-deployment> 创建的 Pod 里的端口 6000</span>\nkubectl <span class="token builtin class-name">exec</span> deploy/my-deployment -- <span class="token function">ls</span>                   <span class="token comment"># 在 Deployment 里的第一个 Pod 的第一个容器里运行命令（单容器和多容器例子）</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="与节点和集群进行交互"><a href="#%E4%B8%8E%E8%8A%82%E7%82%B9%E5%92%8C%E9%9B%86%E7%BE%A4%E8%BF%9B%E8%A1%8C%E4%BA%A4%E4%BA%92" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>与节点和集群进行交互</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="53272587293177100000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`kubectl cordon my-node                                                # 标记 my-node 节点为不可调度\nkubectl drain my-node                                                 # 对 my-node 节点进行清空操作，为节点维护做准备\nkubectl uncordon my-node                                              # 标记 my-node 节点为可以调度\nkubectl top node my-node                                              # 显示给定节点的度量值\nkubectl cluster-info                                                  # 显示主控节点和服务的地址\nkubectl cluster-info dump                                             # 将当前集群状态转储到标准输出\nkubectl cluster-info dump --output-directory=/path/to/cluster-state   # 将当前集群状态输出到 /path/to/cluster-state\n\n# 如果已存在具有指定键和效果的污点，则替换其值为指定值。\nkubectl taint nodes foo dedicated=special-user:NoSchedule`, `53272587293177100000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">kubectl cordon my-node                                                <span class="token comment"># 标记 my-node 节点为不可调度</span>\nkubectl drain my-node                                                 <span class="token comment"># 对 my-node 节点进行清空操作，为节点维护做准备</span>\nkubectl uncordon my-node                                              <span class="token comment"># 标记 my-node 节点为可以调度</span>\nkubectl <span class="token function">top</span> node my-node                                              <span class="token comment"># 显示给定节点的度量值</span>\nkubectl cluster-info                                                  <span class="token comment"># 显示主控节点和服务的地址</span>\nkubectl cluster-info dump                                             <span class="token comment"># 将当前集群状态转储到标准输出</span>\nkubectl cluster-info dump --output-directory<span class="token operator">=</span>/path/to/cluster-state   <span class="token comment"># 将当前集群状态输出到 /path/to/cluster-state</span>\n\n<span class="token comment"># 如果已存在具有指定键和效果的污点，则替换其值为指定值。</span>\nkubectl taint nodes foo <span class="token assign-left variable">dedicated</span><span class="token operator">=</span>special-user:NoSchedule</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h5 id="资源类型"><a href="#%E8%B5%84%E6%BA%90%E7%B1%BB%E5%9E%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>资源类型</h5>\n<p>列出所支持的全部资源类型和它们的简称、API 组, 是否是名字空间作用域和 Kind。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="86437824144586670000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`kubectl api-resources`, `86437824144586670000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">kubectl api-resources</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>用于探索 API 资源的其他操作：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="10889949442583347000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`kubectl api-resources --namespaced=true      # 所有命名空间作用域的资源\nkubectl api-resources --namespaced=false     # 所有非命名空间作用域的资源\nkubectl api-resources -o name                # 用简单格式列举所有资源（仅显示资源名称）\nkubectl api-resources -o wide                # 用扩展格式列举所有资源（又称 &quot;wide&quot; 格式）\nkubectl api-resources --verbs=list,get       # 支持 &quot;list&quot; 和 &quot;get&quot; 请求动词的所有资源\nkubectl api-resources --api-group=extensions # &quot;extensions&quot; API 组中的所有资源`, `10889949442583347000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">kubectl api-resources --namespaced<span class="token operator">=</span>true      <span class="token comment"># 所有命名空间作用域的资源</span>\nkubectl api-resources --namespaced<span class="token operator">=</span>false     <span class="token comment"># 所有非命名空间作用域的资源</span>\nkubectl api-resources -o name                <span class="token comment"># 用简单格式列举所有资源（仅显示资源名称）</span>\nkubectl api-resources -o wide                <span class="token comment"># 用扩展格式列举所有资源（又称 "wide" 格式）</span>\nkubectl api-resources --verbs<span class="token operator">=</span>list,get       <span class="token comment"># 支持 "list" 和 "get" 请求动词的所有资源</span>\nkubectl api-resources --api-group<span class="token operator">=</span>extensions <span class="token comment"># "extensions" API 组中的所有资源</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h5 id="格式化输出"><a href="#%E6%A0%BC%E5%BC%8F%E5%8C%96%E8%BE%93%E5%87%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>格式化输出</h5>\n<p>要以特定格式将详细信息输出到终端窗口，将 <code class="language-text">-o</code>（或者 <code class="language-text">--output</code>）参数添加到支持的 kubectl 命令中。</p>\n<table>\n<thead>\n<tr>\n<th align="left">输出格式</th>\n<th align="left">描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align="left"><code class="language-text">-o=custom-columns=&lt;spec&gt;</code></td>\n<td align="left">使用逗号分隔的自定义列来打印表格</td>\n</tr>\n<tr>\n<td align="left"><code class="language-text">-o=custom-columns-file=&lt;filename&gt;</code></td>\n<td align="left">使用 \n<code class="language-text">&lt;filename&gt;</code>\n 文件中的自定义列模板打印表格</td>\n</tr>\n<tr>\n<td align="left">-o=json</td>\n<td align="left">输出 JSON 格式的 API 对象</td>\n</tr>\n<tr>\n<td align="left"><code class="language-text">-o=jsonpath=&lt;template&gt;</code></td>\n<td align="left">打印 jsonpath 表达式中定义的字段</td>\n</tr>\n<tr>\n<td align="left"><code class="language-text">-o=jsonpath-file=&lt;filename&gt;</code></td>\n<td align="left">打印在 \n<code class="language-text">&lt;filename&gt;</code>\n 文件中定义的 jsonpath 表达式所指定的字段。</td>\n</tr>\n<tr>\n<td align="left">-o=name</td>\n<td align="left">仅打印资源名称而不打印其他内容</td>\n</tr>\n<tr>\n<td align="left">-o=wide</td>\n<td align="left">以纯文本格式输出额外信息，对于 Pod 来说，输出中包含了节点名称</td>\n</tr>\n<tr>\n<td align="left">-o=yaml</td>\n<td align="left">输出 YAML 格式的 API 对象</td>\n</tr>\n</tbody>\n</table>\n<p>使用 <code class="language-text">-o=custom-columns</code> 的示例：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="74948412223969690000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# 集群中运行着的所有镜像\nkubectl get pods -A -o=custom-columns=\'DATA:spec.containers[*].image\'\n\n# 列举 default 名字空间中运行的所有镜像，按 Pod 分组\nkubectl get pods --namespace default --output=custom-columns=&quot;NAME:.metadata.name,IMAGE:.spec.containers[*].image&quot;\n\n# 除 &quot;k8s.gcr.io/coredns:1.6.2&quot; 之外的所有镜像\nkubectl get pods -A -o=custom-columns=\'DATA:spec.containers[?(@.image!=&quot;k8s.gcr.io/coredns:1.6.2&quot;)].image\'\n\n# 输出 metadata 下面的所有字段，无论 Pod 名字为何\nkubectl get pods -A -o=custom-columns=\'DATA:metadata.*\'`, `74948412223969690000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token comment"># 集群中运行着的所有镜像</span>\nkubectl get pods -A -o<span class="token operator">=</span>custom-columns<span class="token operator">=</span><span class="token string">\'DATA:spec.containers[*].image\'</span>\n\n<span class="token comment"># 列举 default 名字空间中运行的所有镜像，按 Pod 分组</span>\nkubectl get pods --namespace default --output<span class="token operator">=</span>custom-columns<span class="token operator">=</span><span class="token string">"NAME:.metadata.name,IMAGE:.spec.containers[*].image"</span>\n\n<span class="token comment"># 除 "k8s.gcr.io/coredns:1.6.2" 之外的所有镜像</span>\nkubectl get pods -A -o<span class="token operator">=</span>custom-columns<span class="token operator">=</span><span class="token string">\'DATA:spec.containers[?(@.image!="k8s.gcr.io/coredns:1.6.2")].image\'</span>\n\n<span class="token comment"># 输出 metadata 下面的所有字段，无论 Pod 名字为何</span>\nkubectl get pods -A -o<span class="token operator">=</span>custom-columns<span class="token operator">=</span><span class="token string">\'DATA:metadata.*\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>有关更多示例，请参看 <a href="https://kubernetes.io/zh-cn/docs/reference/kubectl/#custom-columns" target="_blank" rel="nofollow noreferrer noopener">kubectl 参考文档</a>。</p>\n<h5 id="kubectl-日志输出详细程度和调试"><a href="#kubectl-%E6%97%A5%E5%BF%97%E8%BE%93%E5%87%BA%E8%AF%A6%E7%BB%86%E7%A8%8B%E5%BA%A6%E5%92%8C%E8%B0%83%E8%AF%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Kubectl 日志输出详细程度和调试</h5>\n<p>Kubectl 日志输出详细程度是通过 <code class="language-text">-v</code> 或者 <code class="language-text">--v</code> 来控制的，参数后跟一个数字表示日志的级别。Kubernetes 通用的日志习惯和相关的日志级别在 <a href="https://github.com/kubernetes/community/blob/master/contributors/devel/sig-instrumentation/logging.md" target="_blank" rel="nofollow noreferrer noopener">这里</a> 有相应的描述。</p>\n<table>\n<thead>\n<tr>\n<th align="left">详细程度</th>\n<th align="left">描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align="left">—v=0</td>\n<td align="left">用于那些应该 始终 对运维人员可见的信息，因为这些信息一般很有用。</td>\n</tr>\n<tr>\n<td align="left">—v=1</td>\n<td align="left">如果您不想要看到冗余信息，此值是一个合理的默认日志级别。</td>\n</tr>\n<tr>\n<td align="left">—v=2</td>\n<td align="left">输出有关服务的稳定状态的信息以及重要的日志消息，这些信息可能与系统中的重大变化有关。这是建议大多数系统设置的默认日志级别。</td>\n</tr>\n<tr>\n<td align="left">—v=3</td>\n<td align="left">包含有关系统状态变化的扩展信息。</td>\n</tr>\n<tr>\n<td align="left">—v=4</td>\n<td align="left">包含调试级别的冗余信息。</td>\n</tr>\n<tr>\n<td align="left">—v=5</td>\n<td align="left">跟踪级别的详细程度。</td>\n</tr>\n<tr>\n<td align="left">—v=6</td>\n<td align="left">显示所请求的资源。</td>\n</tr>\n<tr>\n<td align="left">—v=7</td>\n<td align="left">显示 HTTP 请求头。</td>\n</tr>\n<tr>\n<td align="left">—v=8</td>\n<td align="left">显示 HTTP 请求内容。</td>\n</tr>\n<tr>\n<td align="left">—v=9</td>\n<td align="left">显示 HTTP 请求内容而且不截断内容。</td>\n</tr>\n</tbody>\n</table>\n<p>// TODO <a href="https://vuepress.mirror.docker-practice.com/security/" target="_blank" rel="nofollow noreferrer noopener">https://vuepress.mirror.docker-practice.com/security/</a></p>',
excerpt:"基本概念 镜像 Docker…",frontmatter:{date:"2022-07-14 13:53:03",path:"/docker-introduce-learning/",tags:"后端, Docker, 读书笔记",title:"Docker入门学习",draft:null}},prePost:{html:'<h1 id="webgl-二维平移"><a href="#webgl-%E4%BA%8C%E7%BB%B4%E5%B9%B3%E7%A7%BB" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>WebGL 二维平移</h1>\n<p>平移就是普通意义的“移动”物体。这里有个例子基于前一个例子。首先我们来定义一些变量存储矩形的平移，宽，高和颜色。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="21503463563119250000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var translation = [0, 0];\nvar width = 100;\nvar height = 30;\nvar color = [Math.random(), Math.random(), Math.random(), 1];`, `21503463563119250000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> translation <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> width <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> height <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> color <span class="token operator">=</span> <span class="token punctuation">[</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后定义一个方法重绘所有东西，我们可以在更新变换之后调用这个方法。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="1204399852053006300"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 绘制场景\nfunction drawScene() {\n  webglUtils.resizeCanvasToDisplaySize(gl.canvas);\n\n  // 告诉 WebGL 如何从裁剪空间对应到像素\n  gl.viewport(0, 0, gl.canvas.width, gl.canvas.height);\n\n  // 清空画布\n  gl.clear(gl.COLOR_BUFFER_BIT);\n\n  // 使用我们的程序\n  gl.useProgram(program);\n\n  // 启用属性\n  gl.enableVertexAttribArray(positionLocation);\n\n  // 绑定位置缓冲\n  gl.bindBuffer(gl.ARRAY_BUFFER, positionBuffer);\n\n  // 设置矩形参数\n  setRectangle(gl, translation[0], translation[1], width, height);\n\n  // 告诉属性怎么从 positionBuffer 中读取数据 (ARRAY_BUFFER)\n  var size = 2; // 每次迭代运行提取两个单位数据\n  var type = gl.FLOAT; // 每个单位的数据类型是 32 位浮点型\n  var normalize = false; // 不需要归一化数据\n  var stride = 0; // 0 = 移动单位数量 * 每个单位占用内存（sizeof(type)）\n  var offset = 0; // 从缓冲起始位置开始读取\n  gl.vertexAttribPointer(positionLocation, size, type, normalize, stride, offset);\n\n  // 设置分辨率\n  gl.uniform2f(resolutionLocation, gl.canvas.width, gl.canvas.height);\n\n  // 设置颜色\n  gl.uniform4fv(colorLocation, color);\n\n  // 绘制矩形\n  var primitiveType = gl.TRIANGLES;\n  var offset = 0;\n  var count = 6;\n  gl.drawArrays(primitiveType, offset, count);\n}`, `1204399852053006300`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 绘制场景</span>\n<span class="token keyword">function</span> <span class="token function">drawScene</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  webglUtils<span class="token punctuation">.</span><span class="token function">resizeCanvasToDisplaySize</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>canvas<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 告诉 WebGL 如何从裁剪空间对应到像素</span>\n  gl<span class="token punctuation">.</span><span class="token function">viewport</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>width<span class="token punctuation">,</span> gl<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 清空画布</span>\n  gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 使用我们的程序</span>\n  gl<span class="token punctuation">.</span><span class="token function">useProgram</span><span class="token punctuation">(</span>program<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 启用属性</span>\n  gl<span class="token punctuation">.</span><span class="token function">enableVertexAttribArray</span><span class="token punctuation">(</span>positionLocation<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 绑定位置缓冲</span>\n  gl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> positionBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 设置矩形参数</span>\n  <span class="token function">setRectangle</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> translation<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> translation<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 告诉属性怎么从 positionBuffer 中读取数据 (ARRAY_BUFFER)</span>\n  <span class="token keyword">var</span> size <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">// 每次迭代运行提取两个单位数据</span>\n  <span class="token keyword">var</span> type <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">;</span> <span class="token comment">// 每个单位的数据类型是 32 位浮点型</span>\n  <span class="token keyword">var</span> normalize <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// 不需要归一化数据</span>\n  <span class="token keyword">var</span> stride <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 0 = 移动单位数量 * 每个单位占用内存（sizeof(type)）</span>\n  <span class="token keyword">var</span> offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 从缓冲起始位置开始读取</span>\n  gl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>positionLocation<span class="token punctuation">,</span> size<span class="token punctuation">,</span> type<span class="token punctuation">,</span> normalize<span class="token punctuation">,</span> stride<span class="token punctuation">,</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 设置分辨率</span>\n  gl<span class="token punctuation">.</span><span class="token function">uniform2f</span><span class="token punctuation">(</span>resolutionLocation<span class="token punctuation">,</span> gl<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>width<span class="token punctuation">,</span> gl<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 设置颜色</span>\n  gl<span class="token punctuation">.</span><span class="token function">uniform4fv</span><span class="token punctuation">(</span>colorLocation<span class="token punctuation">,</span> color<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 绘制矩形</span>\n  <span class="token keyword">var</span> primitiveType <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token constant">TRIANGLES</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> count <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>primitiveType<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在下方的例子中，我添加了一对滑块，当它们值改变时会更新 <code class="language-text">translation[0]</code> 和 <code class="language-text">translation[1]</code> 并且调用 drawScene 方法。拖动滑块来平移矩形。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/qj863d?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>到目前为止还不错！但是想象一下如果对一个更复杂的图形做类似操作怎么办。</p>\n<p>假设我们想绘制一个由六个三角形组成的 ‘F’ ，像这样</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-05-10-00-00-30-d54bc92537f9c0ab50f51d070b1a7e69-63541.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 207px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 133.33333333333331%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAbCAYAAAB836/YAAAACXBIWXMAAAsSAAALEgHS3X78AAADdklEQVRIx62Va08TQRSG+z/95BcTYxSvqIl3Wkot2+62dHvb3mkLWCxUi4pKIFEoF4uAwEph2V6IQAxijKVg29eZQYsGCipOc7Lb2Zlnzpw57xlN58ADuEf98IwEEUhHcFfSwtRrgf9NmPV5Uj+MvEvDAXhHQ+xbYDLKnuJLF0xxATcct2EOCdC4RnyIIoF2xPEQ/TgVOgvdNIcYnrC+MHrQicfMHqAPITLK9aUdrUs2aMm45hkTjJk2+NAF85gIjYesSidFyj0IbXfjXPQyzLKdTHtKIAl0VBOQPoZhVSRoU63QjXLQj5sg5rzwfe5EBxnThUdksSQck15opJFdIP3g3gjjfOwqWjM25kXLvICmtJF5wSkipGKUedhFJncQSBS9bBe0j/63vnX9DpQ2I2iIXsEloRF3/E3gkgLsryT4psLwT0fgSYcgTQTgGvXBPe4nFtizNLF+3x6wk6zAq07cGzAgr+ZAW2W7jHKpjJ2vO8S28a24U9fomMpO5ScwzoC6SRPM0yIKKwUGrJLf37YasIucoi7NwTQlIp/P73pYqaBarf6VaWhuRUhwQ1vd0E+ZYZXdUFWVAcvlMoP+arSPTmQ7qFYP8HDYz3LMuRqEYdYCdyGEtZXVI7d2EGwf8D4B2rN+PBvsh5xfwMzSu5rJhfeYVeeQGkuhWCwe7aFFccOqumFedKDx+S0IBReMi23gyZPPO3FzWIczsYs47W3Asrpci/E+oPu1nyWqbqwVgSKRT8YBnlgCL9BN5CeRZNe/IfKase7m6ko71OU/ADaNGBEsxRjQqkrsvXnChPszFgS3YkyKcaJ1u+IjQLU+kJ4ylZA2ZUS4Egcn23CCP4kLvdegneRgXZHAZ53gMiILw93BFiiKUh/oHSNyKkbQTARPKww/60DySRLqehZy7j3mluYxp8xjflneNUVGqVSqfyi+8XZWCCiQxsyW8WB9bf3f04YC7RsBGN5amIdtC1ItRvsSu1qpqaeuh7TqGmQLnB+C7HCoh1k1WzdGR2qZln3tFAfPpwjTs23xmEC6Zd20Cd7NKEvwYwPFFy5WkaOVHna3HBso9NnQ/M7M7gRadY4PTNqgn+VZ/P4LUBvQo23Vw263CLkKbAse5LK5fwdet95gdypNGWpi7nCtHgk0SzwMT0mlHnJCGBLBJQSsra4dqobD2ndBOnoUrBMAugAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 05 10 00 00 30" title="" data-src="/static/2022-05-10-00-00-30-d54bc92537f9c0ab50f51d070b1a7e69-63541.png" data-srcset="/static/2022-05-10-00-00-30-d54bc92537f9c0ab50f51d070b1a7e69-7ebab.png 200w,\n/static/2022-05-10-00-00-30-d54bc92537f9c0ab50f51d070b1a7e69-63541.png 207w" data-sizes="(max-width: 207px) 100vw, 207px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>接着当前的代码我们需要修改 setRectangle，像这样</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="38533096678487150000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 在缓冲存储构成 \'F\' 的值\nfunction setGeometry(gl, x, y) {\n  var width = 100;\n  var height = 150;\n  var thickness = 30;\n  gl.bufferData(\n    gl.ARRAY_BUFFER,\n    new Float32Array([\n      // 左竖\n      x,\n      y,\n      x + thickness,\n      y,\n      x,\n      y + height,\n      x,\n      y + height,\n      x + thickness,\n      y,\n      x + thickness,\n      y + height,\n\n      // 上横\n      x + thickness,\n      y,\n      x + width,\n      y,\n      x + thickness,\n      y + thickness,\n      x + thickness,\n      y + thickness,\n      x + width,\n      y,\n      x + width,\n      y + thickness,\n\n      // 中横\n      x + thickness,\n      y + thickness * 2,\n      x + (width * 2) / 3,\n      y + thickness * 2,\n      x + thickness,\n      y + thickness * 3,\n      x + thickness,\n      y + thickness * 3,\n      x + (width * 2) / 3,\n      y + thickness * 2,\n      x + (width * 2) / 3,\n      y + thickness * 3\n    ]),\n    gl.STATIC_DRAW\n  );\n}`, `38533096678487150000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 在缓冲存储构成 \'F\' 的值</span>\n<span class="token keyword">function</span> <span class="token function">setGeometry</span><span class="token punctuation">(</span><span class="token parameter">gl<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> width <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> height <span class="token operator">=</span> <span class="token number">150</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> thickness <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">bufferData</span><span class="token punctuation">(</span>\n    gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span>\n    <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span>\n      <span class="token comment">// 左竖</span>\n      x<span class="token punctuation">,</span>\n      y<span class="token punctuation">,</span>\n      x <span class="token operator">+</span> thickness<span class="token punctuation">,</span>\n      y<span class="token punctuation">,</span>\n      x<span class="token punctuation">,</span>\n      y <span class="token operator">+</span> height<span class="token punctuation">,</span>\n      x<span class="token punctuation">,</span>\n      y <span class="token operator">+</span> height<span class="token punctuation">,</span>\n      x <span class="token operator">+</span> thickness<span class="token punctuation">,</span>\n      y<span class="token punctuation">,</span>\n      x <span class="token operator">+</span> thickness<span class="token punctuation">,</span>\n      y <span class="token operator">+</span> height<span class="token punctuation">,</span>\n\n      <span class="token comment">// 上横</span>\n      x <span class="token operator">+</span> thickness<span class="token punctuation">,</span>\n      y<span class="token punctuation">,</span>\n      x <span class="token operator">+</span> width<span class="token punctuation">,</span>\n      y<span class="token punctuation">,</span>\n      x <span class="token operator">+</span> thickness<span class="token punctuation">,</span>\n      y <span class="token operator">+</span> thickness<span class="token punctuation">,</span>\n      x <span class="token operator">+</span> thickness<span class="token punctuation">,</span>\n      y <span class="token operator">+</span> thickness<span class="token punctuation">,</span>\n      x <span class="token operator">+</span> width<span class="token punctuation">,</span>\n      y<span class="token punctuation">,</span>\n      x <span class="token operator">+</span> width<span class="token punctuation">,</span>\n      y <span class="token operator">+</span> thickness<span class="token punctuation">,</span>\n\n      <span class="token comment">// 中横</span>\n      x <span class="token operator">+</span> thickness<span class="token punctuation">,</span>\n      y <span class="token operator">+</span> thickness <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span>\n      x <span class="token operator">+</span> <span class="token punctuation">(</span>width <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">3</span><span class="token punctuation">,</span>\n      y <span class="token operator">+</span> thickness <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span>\n      x <span class="token operator">+</span> thickness<span class="token punctuation">,</span>\n      y <span class="token operator">+</span> thickness <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">,</span>\n      x <span class="token operator">+</span> thickness<span class="token punctuation">,</span>\n      y <span class="token operator">+</span> thickness <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">,</span>\n      x <span class="token operator">+</span> <span class="token punctuation">(</span>width <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">3</span><span class="token punctuation">,</span>\n      y <span class="token operator">+</span> thickness <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span>\n      x <span class="token operator">+</span> <span class="token punctuation">(</span>width <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">3</span><span class="token punctuation">,</span>\n      y <span class="token operator">+</span> thickness <span class="token operator">*</span> <span class="token number">3</span>\n    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    gl<span class="token punctuation">.</span><span class="token constant">STATIC_DRAW</span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>你可能发现这样做可能并不好，如果我们想绘制一个含有成百上千个线条的几何图形，将会有很复杂的代码。最重要的是，每次绘制 JavaScript 都要更新所有点。</p>\n<p>这里有个简单的方式，上传几何体然后在着色器中进行平移，以下是新的着色器</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="90596776862863340000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<script id=&quot;vertex-shader-2d&quot; type=&quot;x-shader/x-vertex&quot;>\n   attribute vec2 a_position;\n\n   uniform vec2 u_resolution;\n   uniform vec2 u_translation;\n\n   void main() {\n      // 加上平移量\n      vec2 position = a_position + u_translation;\n\n      // 从像素坐标转换到 0.0 到 1.0\n      vec2 zeroToOne = position / u_resolution;\n      // ...\n   }\n</script>`, `90596776862863340000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token operator">&lt;</span>script id<span class="token operator">=</span><span class="token string">"vertex-shader-2d"</span> type<span class="token operator">=</span><span class="token string">"x-shader/x-vertex"</span><span class="token operator">></span>\n   attribute vec2 a_position<span class="token punctuation">;</span>\n\n   uniform vec2 u_resolution<span class="token punctuation">;</span>\n   uniform vec2 u_translation<span class="token punctuation">;</span>\n\n   <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 加上平移量</span>\n      vec2 position <span class="token operator">=</span> a_position <span class="token operator">+</span> u_translation<span class="token punctuation">;</span>\n\n      <span class="token comment">// 从像素坐标转换到 0.0 到 1.0</span>\n      vec2 zeroToOne <span class="token operator">=</span> position <span class="token operator">/</span> u_resolution<span class="token punctuation">;</span>\n      <span class="token comment">// ...</span>\n   <span class="token punctuation">}</span>\n<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>重构一下代码，首先我们只需要设置一次几何体。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="73887475991039560000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 在缓冲存储构成 \'F\' 的值\nfunction setGeometry(gl) {\n  gl.bufferData(\n    gl.ARRAY_BUFFER,\n    new Float32Array([\n      // 左竖\n      0,\n      0,\n      30,\n      0,\n      0,\n      150,\n      0,\n      150,\n      30,\n      0,\n      30,\n      150,\n\n      // 上横\n      30,\n      0,\n      100,\n      0,\n      30,\n      30,\n      30,\n      30,\n      100,\n      0,\n      100,\n      30,\n\n      // 中横\n      30,\n      60,\n      67,\n      60,\n      30,\n      90,\n      30,\n      90,\n      67,\n      60,\n      67,\n      90\n    ]),\n    gl.STATIC_DRAW\n  );\n}`, `73887475991039560000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 在缓冲存储构成 \'F\' 的值</span>\n<span class="token keyword">function</span> <span class="token function">setGeometry</span><span class="token punctuation">(</span><span class="token parameter">gl</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  gl<span class="token punctuation">.</span><span class="token function">bufferData</span><span class="token punctuation">(</span>\n    gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span>\n    <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span>\n      <span class="token comment">// 左竖</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">30</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">150</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">150</span><span class="token punctuation">,</span>\n      <span class="token number">30</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">30</span><span class="token punctuation">,</span>\n      <span class="token number">150</span><span class="token punctuation">,</span>\n\n      <span class="token comment">// 上横</span>\n      <span class="token number">30</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">100</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">30</span><span class="token punctuation">,</span>\n      <span class="token number">30</span><span class="token punctuation">,</span>\n      <span class="token number">30</span><span class="token punctuation">,</span>\n      <span class="token number">30</span><span class="token punctuation">,</span>\n      <span class="token number">100</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">100</span><span class="token punctuation">,</span>\n      <span class="token number">30</span><span class="token punctuation">,</span>\n\n      <span class="token comment">// 中横</span>\n      <span class="token number">30</span><span class="token punctuation">,</span>\n      <span class="token number">60</span><span class="token punctuation">,</span>\n      <span class="token number">67</span><span class="token punctuation">,</span>\n      <span class="token number">60</span><span class="token punctuation">,</span>\n      <span class="token number">30</span><span class="token punctuation">,</span>\n      <span class="token number">90</span><span class="token punctuation">,</span>\n      <span class="token number">30</span><span class="token punctuation">,</span>\n      <span class="token number">90</span><span class="token punctuation">,</span>\n      <span class="token number">67</span><span class="token punctuation">,</span>\n      <span class="token number">60</span><span class="token punctuation">,</span>\n      <span class="token number">67</span><span class="token punctuation">,</span>\n      <span class="token number">90</span>\n    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    gl<span class="token punctuation">.</span><span class="token constant">STATIC_DRAW</span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后我们只需要在绘制前更新 <code class="language-text">u_translation</code> 为期望的平移量。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="37422078346379670000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// ...\n\nvar translationLocation = gl.getUniformLocation(program, \'u_translation\');\n// ...\n\n// 创建一个存放位置信息的缓冲\nvar positionBuffer = gl.createBuffer();\n// 绑定到 ARRAY_BUFFER (简单的理解为 ARRAY_BUFFER = positionBuffer)\ngl.bindBuffer(gl.ARRAY_BUFFER, positionBuffer);\n// 将几何数据存到缓冲\nsetGeometry(gl);\n\n// ...\n\n// 绘制场景\nfunction drawScene() {\n  // ...\n\n  // 设置平移\n  gl.uniform2fv(translationLocation, translation);\n\n  // 绘制矩形\n  var primitiveType = gl.TRIANGLES;\n  var offset = 0;\n  var count = 18;\n  gl.drawArrays(primitiveType, offset, count);\n}`, `37422078346379670000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// ...</span>\n\n<span class="token keyword">var</span> translationLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_translation\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// ...</span>\n\n<span class="token comment">// 创建一个存放位置信息的缓冲</span>\n<span class="token keyword">var</span> positionBuffer <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// 绑定到 ARRAY_BUFFER (简单的理解为 ARRAY_BUFFER = positionBuffer)</span>\ngl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> positionBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// 将几何数据存到缓冲</span>\n<span class="token function">setGeometry</span><span class="token punctuation">(</span>gl<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// ...</span>\n\n<span class="token comment">// 绘制场景</span>\n<span class="token keyword">function</span> <span class="token function">drawScene</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// ...</span>\n\n  <span class="token comment">// 设置平移</span>\n  gl<span class="token punctuation">.</span><span class="token function">uniform2fv</span><span class="token punctuation">(</span>translationLocation<span class="token punctuation">,</span> translation<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 绘制矩形</span>\n  <span class="token keyword">var</span> primitiveType <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token constant">TRIANGLES</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> count <span class="token operator">=</span> <span class="token number">18</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>primitiveType<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>注意到 setGeometry 只调用了一次，它不在 drawScene 内部了。</p>\n<p>这里是那个例子，同样的，拖动滑块来更新平移量。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/p59ez6?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>现在当我们绘制时，WebGL 几乎做了所有事情，我们做的仅仅是设置平移然后让它绘制，即使我们的几何体有成千上万个点，主要的代码还是保持不变。</p>\n<p>你可以对比上方例子中使用 JavaScript 更新所有点的情况。</p>\n<h1 id="webgl-二维旋转"><a href="#webgl-%E4%BA%8C%E7%BB%B4%E6%97%8B%E8%BD%AC" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>WebGL 二维旋转</h1>\n<p>首先我想向你介绍一个叫做 <code class="language-text">单位圆</code> 的东西，一个圆有一个半径，圆的半径是圆心到圆边缘的距离，单位圆是半径为 1.0 的圆。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-05-10-10-43-30-ce49b6f0198d41f9a6eb0a2eab96ccd8-8130d.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 312px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 99.35897435897438%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsSAAALEgHS3X78AAACYUlEQVQ4y31Ui46bMBDM/6v/0H+o+hMnVa1O1VWNTkpzytMYMIYLD9t4uruBPEksGSzWHmbXMzvb7XbIsgxJkiBN04dTa45nd9/5rNZa1tvtFjP+wKPvezwb4Uk4xihvay1mzIzBmqaBcw4+eDrc4NB4JLnDPnVI84CtqmWtMgdbOQTa5z3t9x5t28qbyc2YKg8G41HaGl+/LDD/W4JJxT4KA44zER8iTBWhi0g/PjJjMB7GmHtApQO+f/uD3FandDiDEMKYoDw7F6FMlFL0Q+wKsKcUsjKi64ADKmyQj2evAPkHY82cZ6Y4xa4Am7bHclNivfrAr9dXvJkFCjQCegt4fkeUB6CoJlLWxqFumX+PTaHw3m2wREqQTkD5si4ZjoBcxn02AcgfhwxhQoVFVFj0CqugBayf0M1AFmnhKX2WTXEGTAgwDIeWeo2X+U+8fczx8vsH/umVpD01mWVuPeomwhaGdagFZKsa1HUt691+B51p1B3r8YDPtkZRFCIPruU4vae6xkA67WBsg8LkzPDoFMUpx9PF3jvFh4dOyWwgGd2mTK5gbYlMLgp/q8N4E4uPLqU6OORlnJDGc9l8UpVM6aeFndpI0ol3An4kbLZhYh4Im43OGxOyU9PFwWJnQO8vrRcHsChyubLe2L5Gg4uuLAWry5YV5TaP9aXyUJpsOTccGRmyEmbcHJnZ2IK4LfW9J0t5ufkk98hJuGneipv4Arhmsk9aGN0wNQAGlfY1Mjx3kxs30GypYdiqIxVMd9mxOQvD9XotyPv9Xlr57Ty2+oTWivalk3GllKxXqxX+A4m6FQCvVArmAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 05 10 10 43 30" title="" data-src="/static/2022-05-10-10-43-30-ce49b6f0198d41f9a6eb0a2eab96ccd8-8130d.png" data-srcset="/static/2022-05-10-10-43-30-ce49b6f0198d41f9a6eb0a2eab96ccd8-08db0.png 200w,\n/static/2022-05-10-10-43-30-ce49b6f0198d41f9a6eb0a2eab96ccd8-8130d.png 312w" data-sizes="(max-width: 312px) 100vw, 312px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>当你拖拽蓝色圆点的时候 X 和 Y 会改变，它们是那一点在圆上的坐标，在最上方时 Y 是 1 并且 X 是 0，在最右边的时候 X 是 1 并且 Y 是 0。</p>\n<p>如果你还记得三年级的数学知识，数字和 1 相乘结果不变。例如 <code class="language-text">123 * 1 = 123</code>，那么，单位圆半径为 1.0 的圆也是 1 的一种形式，它是旋转的 1。所以你可以把一些东西和单位圆相乘，除了发生一些魔法和旋转之外，某种程度上和乘以 1 相似。</p>\n<p>我们将从单位元上任取一点，并将该点的 X 和 Y 与之前例子中的几何体相乘，以下是新的着色器。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="98593847455576540000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<script id=&quot;vertex-shader-2d&quot; type=&quot;x-shader/x-vertex&quot;>\n   attribute vec2 a_position;\n\n   uniform vec2 u_resolution;\n   uniform vec2 u_translation;\n   uniform vec2 u_rotation;\n\n   void main() {\n      // 旋转位置\n      vec2 rotatedPosition = vec2(\n         a_position.x * u_rotation.y + a_position.y * u_rotation.x,\n         a_position.y * u_rotation.y - a_position.x * u_rotation.x\n      );\n\n      // 加上平移\n      vec2 position = rotatedPosition + u_translation;\n   }\n</script>`, `98593847455576540000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token operator">&lt;</span>script id<span class="token operator">=</span><span class="token string">"vertex-shader-2d"</span> type<span class="token operator">=</span><span class="token string">"x-shader/x-vertex"</span><span class="token operator">></span>\n   attribute vec2 a_position<span class="token punctuation">;</span>\n\n   uniform vec2 u_resolution<span class="token punctuation">;</span>\n   uniform vec2 u_translation<span class="token punctuation">;</span>\n   uniform vec2 u_rotation<span class="token punctuation">;</span>\n\n   <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 旋转位置</span>\n      vec2 rotatedPosition <span class="token operator">=</span> <span class="token function">vec2</span><span class="token punctuation">(</span>\n         a_position<span class="token punctuation">.</span>x <span class="token operator">*</span> u_rotation<span class="token punctuation">.</span>y <span class="token operator">+</span> a_position<span class="token punctuation">.</span>y <span class="token operator">*</span> u_rotation<span class="token punctuation">.</span>x<span class="token punctuation">,</span>\n         a_position<span class="token punctuation">.</span>y <span class="token operator">*</span> u_rotation<span class="token punctuation">.</span>y <span class="token operator">-</span> a_position<span class="token punctuation">.</span>x <span class="token operator">*</span> u_rotation<span class="token punctuation">.</span>x\n      <span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token comment">// 加上平移</span>\n      vec2 position <span class="token operator">=</span> rotatedPosition <span class="token operator">+</span> u_translation<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>更新 JavaScript，传递两个值进去。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="2177269451175734000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// ...\n\nvar rotationLocation = gl.getUniformLocation(program, \'u_rotation\');\n\n// ...\n\nvar rotation = [0, 1];\n\n// ...\n\n// 绘制场景\nfunction drawScene() {\n  // ...\n\n  // 设置平移\n  gl.uniform2fv(translationLocation, translation);\n\n  // 设置旋转\n  gl.uniform2fv(rotationLocation, rotation);\n\n  // 绘制几何体\n  var primitiveType = gl.TRIANGLES;\n  var offset = 0;\n  var count = 18; // 6 个三角形组成 \'F\', 每个三角形 3 个点\n  gl.drawArrays(primitiveType, offset, count);\n}`, `2177269451175734000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// ...</span>\n\n<span class="token keyword">var</span> rotationLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_rotation\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// ...</span>\n\n<span class="token keyword">var</span> rotation <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n<span class="token comment">// ...</span>\n\n<span class="token comment">// 绘制场景</span>\n<span class="token keyword">function</span> <span class="token function">drawScene</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// ...</span>\n\n  <span class="token comment">// 设置平移</span>\n  gl<span class="token punctuation">.</span><span class="token function">uniform2fv</span><span class="token punctuation">(</span>translationLocation<span class="token punctuation">,</span> translation<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 设置旋转</span>\n  gl<span class="token punctuation">.</span><span class="token function">uniform2fv</span><span class="token punctuation">(</span>rotationLocation<span class="token punctuation">,</span> rotation<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 绘制几何体</span>\n  <span class="token keyword">var</span> primitiveType <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token constant">TRIANGLES</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> count <span class="token operator">=</span> <span class="token number">18</span><span class="token punctuation">;</span> <span class="token comment">// 6 个三角形组成 \'F\', 每个三角形 3 个点</span>\n  gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>primitiveType<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这是结果，拖动圆形手柄来旋转或拖动滑块来平移。</p>\n<html><head></head><body><iframe data-src="https://codesandbox.io/embed/6g8g2i?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe></body></html>\n<!-- [webgl-2d-geometry-rotation](embedded-codesandbox://webgl-fundamental-2d/webgl-2d-geometry-rotation?view=preview) -->\n<p>为什么会这样？来看看数学公式。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="77751228407811880000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`rotatedX = a_position.x * u_rotation.y + a_position.y * u_rotation.x;\nrotatedY = a_position.y * u_rotation.y - a_position.x * u_rotation.x;`, `77751228407811880000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">rotatedX <span class="token operator">=</span> a_position<span class="token punctuation">.</span>x <span class="token operator">*</span> u_rotation<span class="token punctuation">.</span>y <span class="token operator">+</span> a_position<span class="token punctuation">.</span>y <span class="token operator">*</span> u_rotation<span class="token punctuation">.</span>x<span class="token punctuation">;</span>\nrotatedY <span class="token operator">=</span> a_position<span class="token punctuation">.</span>y <span class="token operator">*</span> u_rotation<span class="token punctuation">.</span>y <span class="token operator">-</span> a_position<span class="token punctuation">.</span>x <span class="token operator">*</span> u_rotation<span class="token punctuation">.</span>x<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>假如你想旋转一个矩形，在开始旋转之前矩形右上角坐标是 3.0, 9.0，让我们在单位圆上以十二点方向为起点顺时针旋转 30 度后取一个点。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-05-10-11-21-43-19e88ce70feb059a97766669f83c462d-29b1b.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 201px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 100%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAIAAAAC64paAAAACXBIWXMAAAsSAAALEgHS3X78AAACLklEQVQ4y4VU227bMAz1d/epX9WH9a0Dmi3pEKAbsCEo0DrxJXbiS2xZtinJ2pGUxE6yYoSQ0PI5JEUe2dNaD8MgpdQ3hn2lpHWO67zv8J7z+r4/oQExi2hoGsUY9f1g35BS4sx0eM95bdsKa1KKshRBIMJQxrF6e6vDUKzX3dNTslikXdee8XA8Fww0OKhlvzcLcW2RSF7jr2nE/f3y7u61qhoLUw5vyAoFCQIzSTTn45kBIhLOn//+NZv/KXIXd0LGAxGlqW5b14+xMaiwyIt9nm0KP96uGesAu8iM3FlGeX7BdBUhqO/78+V8+XP57fsc5zscdJYpOCN5syEhrkelzKRUr3v0IaCgYpWLHoaq709kzge09yqt7VOzS3brfL3arT6yD94d+xEEivMjWTWNjCIFLg7jzGkgiqLnH88vry+zxezx62PNaxtd5blIUwLeQ6cZE77fcl5jzGJiOHCURckhKZri4ctDWZY2Mo5Nq1UJ2Ziy0WSQpeyu5akHxpgUciJY87vfD2nKTGY8EJmG3Wrbzl+4KMbMr9nfbBQE6bRtYGFITfMpeWoQCWQLFY8i4Zy22/+QXVqIpK6VuyRHeUpJdY3pX+DGsk/3EUKCSKwiJ2Q0Fk5V6d1On5MB5MqDYRMXpiwvgnruSkHD2LIzV5g5FmOqqmRZohdDHEsIA9VaonJ4EL3J/cRgBV7BweTjWESReH+vscy8hPkYAOCY/7jPt58hIg7wZ438Cw3pi2j7g+rWAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 05 10 11 21 43" title="" data-src="/static/2022-05-10-11-21-43-19e88ce70feb059a97766669f83c462d-29b1b.png" data-srcset="/static/2022-05-10-11-21-43-19e88ce70feb059a97766669f83c462d-291bf.png 200w,\n/static/2022-05-10-11-21-43-19e88ce70feb059a97766669f83c462d-29b1b.png 201w" data-sizes="(max-width: 201px) 100vw, 201px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>圆上该点的位置是 0.50 和 0.87</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="96807571977551170000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`3.0 * 0.87 + 9.0 * 0.50 = 7.1\n9.0 * 0.87 - 3.0 * 0.50 = 6.3`, `96807571977551170000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">3.0 * 0.87 + 9.0 * 0.50 = 7.1\n9.0 * 0.87 - 3.0 * 0.50 = 6.3</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>这个结果正好是我们需要的结果</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-05-10-11-22-51-ac87387e057abcbeeadeeb22d810a44b-bb96f.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 512px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 32.03125%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsSAAALEgHS3X78AAABSklEQVQY0zVRy07DMBDM/38EEocegAsHhEAcyqG3cqDi2SdNqtiNE8cpiZ3EeQxrV6y0tnc0uzu7Dvq+h9YaaZqirhs4a5oGbduiaQ2ESFBT7NxaS1wDVRQwxniew5wPw4BxHBHoymB2t8VmGRExh20t8jxHlklsvmL87Pa+CeeccIVMpmCcQUqJJEmglPJ8J8xZUJUG06s9eKRQnKig7VDqAssFx/N16As7skgF4QriqJDwDNpoUi9QkFrHcbebNDgVJZ4mK+zXnJJovLqmBIGHyzW+X2NSLT12CBkWsxj3Fyu8vWypYAnGGHLllB69Wl+wqiqEW4YslX6PrW1wZBk+5jF1ziCdwsHifR5hdhvhsBMwtUb5W2F6s6HpQjxOPpFQjh/ZLXJEj2Ec/GKduTedPv7Huq4j3hn3OcOIQjRQSYuUVajN+UP/AGIRxQvPS3zjAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 05 10 11 22 51" title="" data-src="/static/2022-05-10-11-22-51-ac87387e057abcbeeadeeb22d810a44b-bb96f.png" data-srcset="/static/2022-05-10-11-22-51-ac87387e057abcbeeadeeb22d810a44b-7728b.png 200w,\n/static/2022-05-10-11-22-51-ac87387e057abcbeeadeeb22d810a44b-23f96.png 400w,\n/static/2022-05-10-11-22-51-ac87387e057abcbeeadeeb22d810a44b-bb96f.png 512w" data-sizes="(max-width: 512px) 100vw, 512px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>顺时针 60 度也一样</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-05-10-11-23-18-c3cff672243d7b7caed4fb760fd98191-29b1b.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 201px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 100%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAIAAAAC64paAAAACXBIWXMAAAsSAAALEgHS3X78AAACGElEQVQ4y4VTy27bMBDUl/fQa/s5RQ20h1waBEiaNDV6SIu4RiLJsmmL0YOkJD47FG1JqZ1ksZDp3RlyuTuMnHPWWq21OzLEjTkdD/gorLquO6AtfuFSWs4NYzJk4EgFG/BRWDVNo3rTWhWFShKVpjrLzGJRp6mMY0WpTwULeBCjcCBCWKCW3c479rXWZ4SojTFSOkrdZuPC5bQ2Ae/JSCslkUBaiPFuAEmp+t39X+xIiMPB8P2d+xxAEommcQP0sKk6NMl/BZezWX55SVD4ngxYnksUNmWeJLdd++799w8ff7ctH8lxLA+w02SUtlgubn/++Hr27fPsTAi2Jwth0d7/jg2NRGPLp5JSGm/j+Z/5X7rciPTu7pHzNpAN53q1MgCjQ1NDV2pe3/y6Ob8+v7i+uJpfPZp4Tm6TpMpz4E2E0hhTDw8NpoIxq6lJla5TUpGqqyijRVOsn9azL58Iqe/vS2M6XzaaDLLW7bEMOeNa6UnEf3c7SwjubKO+Gb5hxxoeGmY9y7vxbBvHBoIM2vYwaJDz17o9GKQC2UKqo0iEkOv1G+RQM7RUe8lO5Km1rGuX589wY9l2H4GQyjIockKGBrCoKrfduuEwgEJ5MATxYIri2aZReFIQA0L9zA1mDmfMVJUuCvTCZplOEoNqe6IJeBDH94xDUAxSWGDyWaZWK7Vc1nDGMH+JFAAvvufjOUspAH6pkf8AaiSMkwsZIRcAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 05 10 11 23 18" title="" data-src="/static/2022-05-10-11-23-18-c3cff672243d7b7caed4fb760fd98191-29b1b.png" data-srcset="/static/2022-05-10-11-23-18-c3cff672243d7b7caed4fb760fd98191-291bf.png 200w,\n/static/2022-05-10-11-23-18-c3cff672243d7b7caed4fb760fd98191-29b1b.png 201w" data-sizes="(max-width: 201px) 100vw, 201px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>圆上该点的位置是 0.87 和 0.50。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="1575138389761932000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`3.0 * 0.50 + 9.0 * 0.87 = 9.3\n9.0 * 0.50 - 3.0 * 0.87 = 1.9`, `1575138389761932000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">3.0 * 0.50 + 9.0 * 0.87 = 9.3\n9.0 * 0.50 - 3.0 * 0.87 = 1.9</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>你会发现在我们顺时针旋转到右边的过程中，X 变大 Y 变小。如果我们继续旋转超过 90 度后，X 变小 Y 变大，这种形式形成了旋转。</p>\n<p>单位圆上的点还有一个名字，叫做正弦和余弦。所以对于任意给定角，我们只需要求出正弦和余弦，像这样</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="53733283350937590000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function printSineAndCosineForAnAngle(angleInDegrees) {\n  var angleInRadians = (angleInDegrees * Math.PI) / 180;\n  var s = Math.sin(angleInRadians);\n  var c = Math.cos(angleInRadians);\n  console.log(\'s = \' + s + \' c = \' + c);\n}`, `53733283350937590000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">printSineAndCosineForAnAngle</span><span class="token punctuation">(</span><span class="token parameter">angleInDegrees</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> angleInRadians <span class="token operator">=</span> <span class="token punctuation">(</span>angleInDegrees <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">180</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> s <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">sin</span><span class="token punctuation">(</span>angleInRadians<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> c <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">cos</span><span class="token punctuation">(</span>angleInRadians<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'s = \'</span> <span class="token operator">+</span> s <span class="token operator">+</span> <span class="token string">\' c = \'</span> <span class="token operator">+</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果把代码复制到 JavaScript 控制台，然后输入 <code class="language-text">printSineAndCosignForAngle(30)</code>，会打印出 <code class="language-text">s = 0.49 c = 0.87</code>(注意：我对结果四舍五入了)。</p>\n<p>如果你把这些组合起来，就可以对几何体旋转任意角度，使用时只需要设置旋转的角度。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="8544033148466434000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// ...\nvar angleInRadians = (angleInDegrees * Math.PI) / 180;\nrotation[0] = Math.sin(angleInRadians);\nrotation[1] = Math.cos(angleInRadians);`, `8544033148466434000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// ...</span>\n<span class="token keyword">var</span> angleInRadians <span class="token operator">=</span> <span class="token punctuation">(</span>angleInDegrees <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">180</span><span class="token punctuation">;</span>\nrotation<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">sin</span><span class="token punctuation">(</span>angleInRadians<span class="token punctuation">)</span><span class="token punctuation">;</span>\nrotation<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">cos</span><span class="token punctuation">(</span>angleInRadians<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这里有一个设置角度的版本，拖动滑块来旋转或平移。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/4i0mhx?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>这并不是旋转常用的方式，请继续阅读</p>\n<h1 id="webgl-二维缩放"><a href="#webgl-%E4%BA%8C%E7%BB%B4%E7%BC%A9%E6%94%BE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>WebGL 二维缩放</h1>\n<p>缩放和平移一样简单，让我们将位置乘以期望的缩放值，这是前例中的变化部分。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="37116289902763320000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<script id=&quot;vertex-shader-2d&quot; type=&quot;x-shader/x-vertex&quot;>\n   attribute vec2 a_position;\n\n   uniform vec2 u_resolution;\n   uniform vec2 u_translation;\n   uniform vec2 u_rotation;\n   uniform vec2 u_scale;\n\n   void main() {\n      // 缩放\n      vec2 scaledPosition = a_position * u_scale;\n\n      // 旋转\n      vec2 rotatedPosition = vec2(\n         scaledPosition.x * u_rotation.y + scaledPosition.y * u_rotation.x,\n         scaledPosition.y * u_rotation.y - scaledPosition.x * u_rotation.x);\n\n      // 平移\n      vec2 position = rotatedPosition + u_translation;\n   }\n</script>`, `37116289902763320000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{7,10-11,15-16}"\n              >\n                <span class="gatsby-code-button-language">js{7,10-11,15-16}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token operator">&lt;</span>script id<span class="token operator">=</span><span class="token string">"vertex-shader-2d"</span> type<span class="token operator">=</span><span class="token string">"x-shader/x-vertex"</span><span class="token operator">></span>\n   attribute vec2 a_position<span class="token punctuation">;</span>\n\n   uniform vec2 u_resolution<span class="token punctuation">;</span>\n   uniform vec2 u_translation<span class="token punctuation">;</span>\n   uniform vec2 u_rotation<span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line">   uniform vec2 u_scale<span class="token punctuation">;</span></span>\n   <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n<span class="gatsby-highlight-code-line">      <span class="token comment">// 缩放</span></span><span class="gatsby-highlight-code-line">      vec2 scaledPosition <span class="token operator">=</span> a_position <span class="token operator">*</span> u_scale<span class="token punctuation">;</span></span>\n      <span class="token comment">// 旋转</span>\n      vec2 rotatedPosition <span class="token operator">=</span> <span class="token function">vec2</span><span class="token punctuation">(</span>\n<span class="gatsby-highlight-code-line">         scaledPosition<span class="token punctuation">.</span>x <span class="token operator">*</span> u_rotation<span class="token punctuation">.</span>y <span class="token operator">+</span> scaledPosition<span class="token punctuation">.</span>y <span class="token operator">*</span> u_rotation<span class="token punctuation">.</span>x<span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">         scaledPosition<span class="token punctuation">.</span>y <span class="token operator">*</span> u_rotation<span class="token punctuation">.</span>y <span class="token operator">-</span> scaledPosition<span class="token punctuation">.</span>x <span class="token operator">*</span> u_rotation<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n      <span class="token comment">// 平移</span>\n      vec2 position <span class="token operator">=</span> rotatedPosition <span class="token operator">+</span> u_translation<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后需要在 JavaScript 中绘制的地方设置缩放量。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="42562438136864580000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// ...\n\nvar scaleLocation = gl.getUniformLocation(program, \'u_scale\');\n\n// ...\n\nvar scale = [1, 1];\n\n// ...\n\n// 绘制场景\nfunction drawScene() {\n  // ...\n\n  // 设置平移\n  gl.uniform2fv(translationLocation, translation);\n\n  // 设置旋转\n  gl.uniform2fv(rotationLocation, rotation);\n\n  // 设置缩放\n  gl.uniform2fv(scaleLocation, scale);\n\n  // 绘制几何体\n  var primitiveType = gl.TRIANGLES;\n  var offset = 0;\n  var count = 18; // 6 个三角形组成 \'F\', 每个三角形 3 个点\n  gl.drawArrays(primitiveType, offset, count);\n}`, `42562438136864580000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{3,7,21-22}"\n              >\n                <span class="gatsby-code-button-language">js{3,7,21-22}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// ...</span>\n\n<span class="gatsby-highlight-code-line"><span class="token keyword">var</span> scaleLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_scale\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="token comment">// ...</span>\n\n<span class="gatsby-highlight-code-line"><span class="token keyword">var</span> scale <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>\n<span class="token comment">// ...</span>\n\n<span class="token comment">// 绘制场景</span>\n<span class="token keyword">function</span> <span class="token function">drawScene</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// ...</span>\n\n  <span class="token comment">// 设置平移</span>\n  gl<span class="token punctuation">.</span><span class="token function">uniform2fv</span><span class="token punctuation">(</span>translationLocation<span class="token punctuation">,</span> translation<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 设置旋转</span>\n  gl<span class="token punctuation">.</span><span class="token function">uniform2fv</span><span class="token punctuation">(</span>rotationLocation<span class="token punctuation">,</span> rotation<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line">  <span class="token comment">// 设置缩放</span></span><span class="gatsby-highlight-code-line">  gl<span class="token punctuation">.</span><span class="token function">uniform2fv</span><span class="token punctuation">(</span>scaleLocation<span class="token punctuation">,</span> scale<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n  <span class="token comment">// 绘制几何体</span>\n  <span class="token keyword">var</span> primitiveType <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token constant">TRIANGLES</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> count <span class="token operator">=</span> <span class="token number">18</span><span class="token punctuation">;</span> <span class="token comment">// 6 个三角形组成 \'F\', 每个三角形 3 个点</span>\n  gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>primitiveType<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在我们有了缩放，拖动滑块试试。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/byhsth?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>值得一提的是，缩放值为负数的时候会翻转几何体。</p>\n<p>接下来我们将复习神奇的矩阵，这三种操作将包含在一个矩阵中，并表现为一种常用形式。</p>\n<h1 id="webgl-二维矩阵"><a href="#webgl-%E4%BA%8C%E7%BB%B4%E7%9F%A9%E9%98%B5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>WebGL 二维矩阵</h1>\n<p>之前的三篇文章讲了如何对二维物体进行平移，旋转和缩放。每种变换都改变了着色器并且这些变换还受先后顺序影响。在前例中我们先缩放，再旋转，最后平移，如果执行顺序不同结果也不同。</p>\n<p>例如这是缩放 (2, 1)，旋转 30 度，然后平移 (100, 0) 的结果。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-05-14-23-35-02-90dbac2833180f8ec053f36b6fe42598-3e989.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 605px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 61.65289256198348%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABdklEQVQoz5WSSYvCQBCF87P9C96ioB4i3hIF9RQ8iwoeZRwXFJconT06GLMYk3T3VBYUwZlh6tCE7nyvXr1uhqaFMQ7DkP6zmAd8v9/f/kEI+Rv2PO92u4FEEAS+70dRlJCU/MI/YV3XJUlSVVXTNFht24b9MArtq51qkEzoDQzaalpRWtA/ipPOM3nGn/i5PQ+84GHkPawoiuM4rutmPh3baSktgQqFfoFbcyhCNKaZRKbyhMHtfr8/HA6GYSRnmI7RuOE1yuvyaDkaasMKqoiWePbP+RSEPGGEkGmaj3jML5OTuKpaLW1Kx8sRdk7Oqat0QaKv98HdS2eALcvKp8G0M+2wiG06Tf6Dr6FaT+vZXpKcdJUEQ6jL9cF2wMRxDAnBCwEYDGdPZbFZFD+LMK24FWlA5avcNtrsmt1pOziNo3jiTsSlmMMQL9wzfAMMK8Q2dae8wsuGnPkimKzOq4t7yTPHiTvmx+dJqOd6mOAcfr2kLLBvI4mjP19UR7YAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 05 14 23 35 02" title="" data-src="/static/2022-05-14-23-35-02-90dbac2833180f8ec053f36b6fe42598-3e989.png" data-srcset="/static/2022-05-14-23-35-02-90dbac2833180f8ec053f36b6fe42598-4bd12.png 200w,\n/static/2022-05-14-23-35-02-90dbac2833180f8ec053f36b6fe42598-7acd9.png 400w,\n/static/2022-05-14-23-35-02-90dbac2833180f8ec053f36b6fe42598-3e989.png 605w" data-sizes="(max-width: 605px) 100vw, 605px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>这是平移 (100, 0) ，旋转 30 度，然后缩放 (2, 1) 的结果。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-05-14-23-44-24-303cdf4cef353effeeda90c71492cdb9-7376a.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 48.19875776397515%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABHklEQVQoz51RS4uDMBD2/0NvuZRSKLT05KXQWw899FQ8CEUKelm1a91NjI0P1qgx2bEpRcTL7kCGIcn3mBlDKdW2rZRS/T0MOE3T/B+cZVkURYQQjDHUk/+kktPgJEkADOarqgIXY9jAFFAMWXowpTQIAlDmnI/kOtlBvuf3sAx5zd9AYISnFzgMQ8bYUBYUhBSqUx71Vmw1c2ZLb3nIDs7DYT8M7l/K+Bkjq/LZpk1shNHW3+Y0xwU+fZ/M2FzHa/Nmnr2zIYTQYJCt61pn8CRbefw8oi+0cBebj82e7J3YATNAzWrmFm5apgZo6FXp6JtUqiiLnb9DBFmpJbggnFiZdaXX0ch72yD+HqkuLv5lfpvbD1t1E0uSui2lfgExkTtYEfN9vwAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 05 14 23 44 24" title="" data-src="/static/2022-05-14-23-44-24-303cdf4cef353effeeda90c71492cdb9-fee1c.png" data-srcset="/static/2022-05-14-23-44-24-303cdf4cef353effeeda90c71492cdb9-a67b7.png 200w,\n/static/2022-05-14-23-44-24-303cdf4cef353effeeda90c71492cdb9-0b187.png 400w,\n/static/2022-05-14-23-44-24-303cdf4cef353effeeda90c71492cdb9-fee1c.png 800w,\n/static/2022-05-14-23-44-24-303cdf4cef353effeeda90c71492cdb9-7376a.png 805w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>结果截然不同，更糟的是，针对第二种情况中的转换顺序，需要写一个新的着色器。</p>\n<p>有些比我聪明的人可能已经想到了矩阵，对于二维我们使用 3x3 的矩阵，3x3 的矩阵就像是有 9 个格子的格网。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-05-15-16-05-52-35db6e7565a19efd3d9ade8e153af197-a27d0.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 150px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 122.66666666666669%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAZCAIAAAC+dZmEAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAEEklEQVQ4y3VU6VP6SBDN//9xPUsFSm5E5IgQTkFEIJwSwg0JAQSEcAZZOd0XqZ/lWrv9YWhmXk+n+/Ubot1uO53Ox8fHYDAYCoW8Xi/8cDgcCASCX4ZNt9sdi8X8fj/8b1gqlSISiQR+3t/fx+PxZDIRRfHi4gJn2IEvjkbL5RKRx8fHnU5nNpuNZdx4MBjYbDbi5eWF47jPz8/9fn9YDQZDPB6Hv/syOJVKRaVS4bpv2Ha79fl8RC6XKxTYoShiS+C5TrdvNJqeI+HX7mt/OPpYLgShlUpn1Wp1tVLihRZgTZ5rd3qogmBZlo7HTDbbROyZbkx3Fse1WvccDrpd5FMslaKjFrNFpdbe3JiL+ZzTRTVq9Tuz8dZqJ10eOTPD5EqlYqvTrtcqTaFtMJoi4VA6mWSLZaHJN5vNGJ1Uq69zqWTwIVCu8Y1alWu2fD4/kc1mf9Ws0+mi0ejPmkul0tXV1XQy2cmQz0PNoIBgGAbQ19dXZBAEARfp9XrwhN5yPMfzfLfbjUQiGo2mXq/3et0DrNFoeDweAh5ouLy8BENYj46OXC6X1Wo9OTk5bB7s6enp/Pz84B9gmAUi9WWSJA2Hw9FoBAIVCgVomM/ngy/DEXhGZKvVmk6noghmxH6/73A4ZJ7xbb94BvoXz0ql8hfPGCS5YTzXkKTFbreX5rNu7w3BdDwqCM3RZL7drJCHYQsatbpcyPNNmefhW18cjWWeX3JMPh3X3Jh7b0M/Rd5aLH+dKVLRUDAU5IROJknbbA6twWg23+iur5yUt9XkSNJusZL2exd4ZuinB6PlLsMUquVSOvOi1RsCHk+ByVJef61aY/NsOBLVajWFfJZh8tVqjcll82zJ4/UdPptDHZvt7pvn50hkuVis15v9Xt4sl8vgebFY/KxZpgrBmUzm/X2JVo/HI/QcYxx6fFyv19gZDkVpsYDyQEG73ZlMpjJsNHobvFEURYCAs7MzpRKnCrT09PQUo2O328GN4odhTkDvwQcMIdghkBbql+eJ4zA9GCOc4VbkqTdkw/A9PDwgslgsQmG8bM1qtSrzLNf8b54xnr9m+39rhqoy6QS08/fHCsfT2cxoMoVDflxa4wVgZ5LEFgoqpQqzNZfk+DkkMpnKjwGEkYiFvH5/fzD0eii7nVRp9H7KcXp6EozQXL3ivCc1OjwQRsetkXT5oBM3tH5POe4pDEmuVMgPxTHX4OLxyHOU1hmMPo87m06nUxlQmqBpp8ujNxjSdNRqd4DheDQSo1OUx0vgKSiXip9/7D/fMNSMNwyq+Fitv/Usz3Yymczn2d12Cxmh5vlsBjLQ3s1mM/syOJAdKITCVquVJMmwyXRKkiTR6/UgYKDxAGAFyUiLbqMfgT+GJOgf1sPfAwyd/gd1K8thdGBdNgAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 05 15 16 05 52" title="" data-src="/static/2022-05-15-16-05-52-35db6e7565a19efd3d9ade8e153af197-a27d0.png" data-srcset="/static/2022-05-15-16-05-52-35db6e7565a19efd3d9ade8e153af197-a27d0.png 150w" data-sizes="(max-width: 150px) 100vw, 150px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>在计算的时候我们将位置坐标沿着矩阵列的方向依次相乘再将结果加起来。我们的位置信息只有两个值，x 和 y。但是要进行运算需要三个值，所以我们将第三个值赋值为 1。</p>\n<p>在这个例子中结果将是</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-05-15-16-07-18-bb46030f501e9a806141d051e02d6718-b1b7b.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 785px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 21.019108280254777%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAIAAAABPYjBAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAoElEQVQI102O3Q6DIAyFff8HnO4CNxMnw0KUBApIkXWa/ZwL0nycc9pGKWWMSSlJKYdhIKJa67qszHPOGkAIgQEZbltST+U8eucY8leDGGKMROUxjqLv931nH3eFEHgEmLvuygaGpRAi5kze+0vbaq2beogoy2nqb/dSSv2Ii7R+bz7DZy+/7txszDdM1vKxS/0T+6y1M8CR+sGYEgBw4wtjYuUq2fO33AAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 05 15 16 07 18" title="" data-src="/static/2022-05-15-16-07-18-bb46030f501e9a806141d051e02d6718-b1b7b.png" data-srcset="/static/2022-05-15-16-07-18-bb46030f501e9a806141d051e02d6718-8ea14.png 200w,\n/static/2022-05-15-16-07-18-bb46030f501e9a806141d051e02d6718-2d7f3.png 400w,\n/static/2022-05-15-16-07-18-bb46030f501e9a806141d051e02d6718-b1b7b.png 785w" data-sizes="(max-width: 785px) 100vw, 785px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>你可能会想“这样做有什么意义？”，好吧，假设我们要进行平移，平移的量为 tx 和 ty，然后定义一个这样的矩阵</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-05-15-16-13-00-50271c6e4319f518276e448b0c4baddb-64589.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 154px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 120.12987012987013%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAYCAIAAAB1KUohAAAACXBIWXMAAA7DAAAOwwHHb6hkAAADvUlEQVQ4y21Ua1PiWBDl/3/bL1M1zkyVIivDQ4EkvBGS8FYgyEMSCCEBJISnykMJCHtC3Flqy/6Quunbt/t0n3OvZbPZVCqVh3+tVCrxPN9qtTiOMz3lcrlarUqS9MeD+EKh8Pr6aul0OqFQSFVVbGPd7XatVqvH4+n3+9LRBoMBQRDn5+fYlWUZXwRHIhFktGAbuQ+Hw8fHx36/x8Ln88XjcdMDwyKfzzscjsPRTA/QNRoNC8qVioX57BkHtaE6mz8TJBm/jY3Ho/nLYqe/D4cazSbdbtdkpGnj6eGwn4zHubt7nLe021KtyiUizFNP8fvJSPjWQwbsNitFEel0tsJxFEn8vLA6fttJwhuN3goNPhwIfP/5qym2AbtT5or1ak0URYHnlW6fIKlwKCC1282WKHcksSWGIjFUxooXWooiS23pNsEIgoDKbUz4tGdMKxaLnfaczWavrq5Oe358fKzX6xZMFdNuCgKmV6tV4XI6nRRFPTYa1aM1eJ6kKJfLdQxASLXZbAYCAaMy6LLZbH8fDelBidfr9fv9FxcX+IXz8vLSbrcDyx8Pfs/OzlDVgA1UQLJaLlfrla7rYAVY0MRqBd8SvdA0jRRvb2/r9RpOBBeLRYD4gmdIIpFI/I9n9PIFz4qiJBkabby8Licj9bEhOFzuVJLtK73FYqU+9URRSqUzLqejLTZFSdnqm7bY+py2qg6t579AZj53xyYSHq/nr2/fy1whTSe54kM8HvaTAV8gcmWzEoQnFAyXS1zQT3378QOZLNDrfT43nc60EUzD1+Pxsgwz1jRswTOdzbK5HKY9GY8GqjaZjKfTad5UGLSB7k97vr6+jkajpz1nMhkwctozGDUGhnI3NzfJZBIjpRkaV8LldoMq+tMSLMsiwLwtRgRNp9MpzA80WWazGbghSRLb+EJeCIVIwDY8xNEQGgwGsWWGmSrApA3YuNmnsN1uN67rKex0Og2ev4ANnvE44B8aMLeR2+QZikBCLHK5nMkzspuHQTLkbVTmBUFu8QGSKFeqiAVglk2uli8Oh7VU4harNUSCXnqyrMiDyWhwf3fPpjKQBuQpIs3wqcvGok7n78VaJ0mCYdj39zUdD0dCweVmd5fPeX3eZr0WjzJcKQ+2CX8YB/+T5/x5/vwy333scdh8hjRV7ciKCRs8v7+tp7Mp9K7rW9w5ADdgAxUidrud2Y95MbDYbqFFHQuwhVfRnIi+NTwP5QfjAQRVuJypVMqgmWEwKpxEZebTaEgAPMGT+HQaPGOovV7vH+fnqwJzV0hdAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 05 15 16 13 00" title="" data-src="/static/2022-05-15-16-13-00-50271c6e4319f518276e448b0c4baddb-64589.png" data-srcset="/static/2022-05-15-16-13-00-50271c6e4319f518276e448b0c4baddb-64589.png 154w" data-sizes="(max-width: 154px) 100vw, 154px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>然后计算结果</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-05-15-16-13-41-3acd2b74e677131b9b8113928bc56049-85bfe.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 20.51597051597052%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAIAAAABPYjBAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAmUlEQVQI1z2NyxKEIAwE+f9PBBVPguUWYPHYoCCOS605hWY6w5RSxtizlGVRUkosrTVjzLZ9cs5YOOcpRUAi0npNKYUQBBewGNBxHNd14co4jqVW5EBg1lqttcMgIADiSfTAGKMQHF8MFCYcva5P83m2/5RS3L7P84x0j/UTaJbT5KxjPYeqGJP3/g39YKYvdfgOroM7t0O5AZDA5b65ASLvAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 05 15 16 13 41" title="" data-src="/static/2022-05-15-16-13-41-3acd2b74e677131b9b8113928bc56049-fee1c.png" data-srcset="/static/2022-05-15-16-13-41-3acd2b74e677131b9b8113928bc56049-a67b7.png 200w,\n/static/2022-05-15-16-13-41-3acd2b74e677131b9b8113928bc56049-0b187.png 400w,\n/static/2022-05-15-16-13-41-3acd2b74e677131b9b8113928bc56049-fee1c.png 800w,\n/static/2022-05-15-16-13-41-3acd2b74e677131b9b8113928bc56049-85bfe.png 814w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>如果你还记得线性代数的知识，我们可以删除和 0 相乘的部分，和 1 相乘相当于没变，所以简化后为</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-05-15-16-15-20-973a23ee81f457e95a91cef03e322dfd-8f041.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 22.317073170731707%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAIAAAABPYjBAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAA00lEQVQI10VPoQqEUBD0GywGgyIIgsEiCCaT2WywGDxsguBH3AU/wmo5m+DhZ1hETCaDqE8FfXcDhtsw7MzOsLvMMAz7vjdNo6pqHMdfFKXjOG7blqapaZqCIERRBHmaJkK2T1XZti3LchiGzDzPGOR5znGcZVlt24Iu8wIs3oWiKKIoYgpKCAGWZanrOsuyrusy13VBwk5JkuDLsgz0OA5g3/eapjmOgx628zzR1HVtGAbCvu//w0mS4NQ7dvuez9cjCNZ1vT2UUiB+9DyP5/mu635bWaSDj3u+wgAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 05 15 16 15 20" title="" data-src="/static/2022-05-15-16-15-20-973a23ee81f457e95a91cef03e322dfd-fee1c.png" data-srcset="/static/2022-05-15-16-15-20-973a23ee81f457e95a91cef03e322dfd-a67b7.png 200w,\n/static/2022-05-15-16-15-20-973a23ee81f457e95a91cef03e322dfd-0b187.png 400w,\n/static/2022-05-15-16-15-20-973a23ee81f457e95a91cef03e322dfd-fee1c.png 800w,\n/static/2022-05-15-16-15-20-973a23ee81f457e95a91cef03e322dfd-8f041.png 820w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>或者更简洁</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="12735069511938746000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`newX = x + tx;\nnewY = y + ty;`, `12735069511938746000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">newX = x + tx;\nnewY = y + ty;</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>其他的就不用关心了。这个看起来和平移例子中的代码有些相似。</p>\n<p>同样的来实现旋转，在旋转章节提到过，旋转只需要和旋转角对应的正弦和余弦值</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="98216694201055410000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`s = Math.sin(angleToRotateInRadians);\nc = Math.cos(angleToRotateInRadians);`, `98216694201055410000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">s = Math.sin(angleToRotateInRadians);\nc = Math.cos(angleToRotateInRadians);</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>然后我们创建一个这样的矩阵</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-05-15-16-35-29-836213b7ffe55f88348c929c3d810f59-e3522.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 146px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 126.71232876712328%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAZCAIAAAC+dZmEAAAACXBIWXMAAA7DAAAOwwHHb6hkAAADx0lEQVQ4y5VUaVPqWBDl/3+xLMtyLfZF5ckSQiCEQOAhCBKUEFDLp4gjDDthJ0DwnSRvKIcPUzX9oatz03379jnnXkMul6NpOhaLsSwLj1gQhHg8Ho1GWc0Yhkkmkw8PD9/TwuGwKIoGt9vd6/UGgwH8aDSq1Wqnp6e3t7fT6RQr3W4XAcdxRqOx0WhIktTv9+E/Pz9DoZCBoqjNZvP19aV71NtstsfHR8SKZggKhYLL5VosFtu02WyGHQ0kSaqfG6XbbuvFFoulUqkgXq9XQ0lCwPP5i4uLdqvV6/XxKQ369XojkUgYAgEC36/PgocIzpfryWRsNpufnp5Xy0VJKFjM5r40EUolq+nM43EHiOD7+zsdJJ2Xl/4gjeIAinvtRqnytO2sH7vTaWYy6dlcBlpOh10oPohiuVqtlkUxzxfYGLc783g8/h8zA+1ms9lut+EB7+vr6/n5eTqdBqRNzUAEuDGZTLXaRweHaTbh0V9FG4Dt7+8fHx8fHR3BHxwcgFWkHh4eHmmGFYfDAea/p+3t7SHN4PP56vU69gON6P/y8mK32zOZDBhuaIYAwOLYgKrVamEF/u3tDWrRqfoXz1uqtjPzPO90OndmxllUtFerlbJey9o/TIhiSA+xvEDODMFdLofOoHc2n6N4MZ93uj0VMJ0qqdtw//DKytdkrHYua52TcSbLCwhAjN1ipIJEOBwFWlyUufb5yBDzp3jYaVEhaiqvp5PxtjiV4qp//a0V8w6b5WeSS6cz5XI5k06zsXg4wv6XtiHP5XKl8wx5YgQdAkXZQA6qPD0ejyzLy9VKlhf4B2zPzs4gKSQBIXkpIwDtJpMR+6rQyPJ6rUAFuKEGv9+POwg9g1t4xLjJVqsVd9CkGTQDqJF6cnKip2EusK2iTRBEPp9HK5ytWCyiCc6CejwJBc2wiEqv15vNZhHf39/raX+o2pkZe+/wjN0BxA7P0KwqEuCyVjCOik1/IFmtlkq5jBhAwFSe83koFE/KZqOs1hhZAWBqZ+/1VTLBZe/48Xh0k0wycc7puoyEA1yc+/hsfFTfEhznIUg/QTwJwvPzr+lEYtloNldIpVKGK6c1SJJMhMV4NBUC+w7X1fWVLUTRmcxtKvmTDodMjosgFRR5Ph7lSmIxQJJ0JJ66uTHgZk0no+lsvoDq5rNWp4eLUSmLmHCmLkzB112eB8+DPl6hPtbHk8lwOFJ5xq36DthwOAQ3ura3gOF5Bj3fAcP8YMQADigqiMcZfDBMFLP5fX4sMkyE1iwSiYA89AAv/6QxUAeu5G+mztrZXae/5wAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 05 15 16 35 29" title="" data-src="/static/2022-05-15-16-35-29-836213b7ffe55f88348c929c3d810f59-e3522.png" data-srcset="/static/2022-05-15-16-35-29-836213b7ffe55f88348c929c3d810f59-e3522.png 146w" data-sizes="(max-width: 146px) 100vw, 146px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>使用矩阵后得到</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-05-15-16-36-02-e67478d152dd8f8de9256294f3446eac-115a3.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 20.224719101123593%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAIAAAABPYjBAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAmElEQVQI102O0Q6DIAxF/f9fNIEY42DiKJgIrSLsRh62+9SecloGY4z3dF2Xc9s8zyhaa0SElnMm8lprEQHkzNbanHM6jnEcrX0PaDCrtTrnpmkqpeCdPEENWSl1nifgXQozA0KBvK7r0J4A4b4xr34ZuzokCsuydLkHo5SS1uonw9ljCCG2v8DBH7ft03f13PUW4Rh3ZvkCzsvmBlRUjnAAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 05 15 16 36 02" title="" data-src="/static/2022-05-15-16-36-02-e67478d152dd8f8de9256294f3446eac-fee1c.png" data-srcset="/static/2022-05-15-16-36-02-e67478d152dd8f8de9256294f3446eac-a67b7.png 200w,\n/static/2022-05-15-16-36-02-e67478d152dd8f8de9256294f3446eac-0b187.png 400w,\n/static/2022-05-15-16-36-02-e67478d152dd8f8de9256294f3446eac-fee1c.png 800w,\n/static/2022-05-15-16-36-02-e67478d152dd8f8de9256294f3446eac-115a3.png 801w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>即</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="40982418574523515000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`newX = x *  c + y * s;\nnewY = x * -s + y * c;`, `40982418574523515000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">newX = x *  c + y * s;\nnewY = x * -s + y * c;</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>正是我们在旋转例子中得到的结果。</p>\n<p>最后是缩放，我们将两个缩放因子叫做 sx 和 sy 。</p>\n<p>然后创建一个这样的矩阵</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-05-15-16-38-57-7fe444aebd761012c84c541b6c40ef5f-0e000.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 153px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 123.52941176470588%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAZCAIAAAC+dZmEAAAACXBIWXMAAA7DAAAOwwHHb6hkAAADxElEQVQ4y3VUaVfiWBDl/39XURaZbhZbJCwB2cGEdVjC0g1hF4gIKGtCEhDBuYQzHo/D1Iecyn31XlW9e+upttvt4xdrt9svLy+j0QjOEel0OhzHzWazT+QYtlwuVVgzmUyVSiWbzeZyuWKxaLFYdDpdPp/PKQbEHwicnZ1Fo1H4QAoMQ1HU/f29CscUCoWPj4+dYnACgQBJknD2+/0RQYxer+d5/gjiK4piJBI5ZEZO/MuytJJkOH6/nyRdK2EpitJu9y4IfKvZwubx8JnnBQSsVvx4PH6IRlWovlqtlAv5W5vNbDbLmx1N03qt2u1xp9K5TqtBku47u9Ni/IsgrD5/aDAYhPx+m8MZDIWxufO7XBpwfYqOhQK+6UKgKerGbMzlMsXSbxiajNJx088f8RjFMIUqW8tns/FUOoLM6IdhmK89B4NBl8v1tedut4srPN1zIpFA0FKxt7c3r9drs9nktcwrttls2Cqr0Wien59lWeYFQZSk0WgcCoVUIPDq6spgMFxfX+ML3+fzOZ3OTxA5Qd7Dw8Pl5eVnmFqtBkeHskHM09NTo9FoNpuP3a7dbsfNoaKmYr1eL5lM4ixEIxgIlkqlEhg90TPQbz0jRqvVfus5HA4fNmfSKSy87/fSSgCTwWDI4XAgQhJFdIhg0AmehwNusTzs5xfz4VDheTQcaDXnTpebrTWSMdrhIg0/fuLU2esIG1B/u8v1uSe9Rm213pAeX7/X83o8N9a7QDCkgujdpKNcLlfZeqlQALUOJwndvsliMpFKxOmluOa4/rVe93c6USqXkaPIMOlMDlI/UIUZ+NYzbhvOZr0ev7weewZVJ3qGAKBHSZamkylMEASkJQgCkgaLYH61WmHm9Hpdr9/D/ul0tlgswc5hMyJAGtoDn/jCh0hwYUcQl4ycmFkUeXFx8Rl2fn4Ojg63DVVMJpN+v4/+8QygZqhiOBxyimGAMHbgmWVZrAKB1Or1+mmeoe1v84zWTs8zJJVOJefz+Xa3X/GL2XwRCARdTuds8spjnt+308mkVm8q8zyUpDWSIP9kOotGIwrPVweeK5VanKLsTpf5163RoCHsdjqWqlX+EHaH5dZ6ZyOKSToWZ6DaO+uvcIRKpFIqtOrzeg7CbrVZHNBouO+9hM3KViv1RhN4ja2mMlmj0fTYqGVzxU6njSFvtR/B0Wlt//cN+9959rjduFvlke2AQMJOmIwmVHR8eYGk02kwh4TgA1C/36tUq3jqVOv1Gg9N/l/LZDIYA1QL54hgFeIFQ0BQIxB84YPCfwBGl9lcoDPw4AAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 05 15 16 38 57" title="" data-src="/static/2022-05-15-16-38-57-7fe444aebd761012c84c541b6c40ef5f-0e000.png" data-srcset="/static/2022-05-15-16-38-57-7fe444aebd761012c84c541b6c40ef5f-0e000.png 153w" data-sizes="(max-width: 153px) 100vw, 153px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>使用矩阵后得到</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-05-15-16-39-34-f888e505c953d12cd9230d0940f45016-85bfe.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 20.393120393120395%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAIAAAABPYjBAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAnUlEQVQI11WOyQ6DMBBD+f8fREig5NZsiCiQfZla0EqtD3N4sseepBD7vtdapZTbtrXWiOg4DqVUKcVaO8+z9wEw5/wSwnsfY1zXVWs1AZWcex9CCKDWOnyIgY8xnHPLsoQQAXvvKWd8TyndYT3RLWRQxRjDBPoK7uu6GOdPM9F4YEyRc26M+YRRdboTI+lHtZYQgtbmD7YK82Et7huV7eWxPSf+CQAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 05 15 16 39 34" title="" data-src="/static/2022-05-15-16-39-34-f888e505c953d12cd9230d0940f45016-fee1c.png" data-srcset="/static/2022-05-15-16-39-34-f888e505c953d12cd9230d0940f45016-a67b7.png 200w,\n/static/2022-05-15-16-39-34-f888e505c953d12cd9230d0940f45016-0b187.png 400w,\n/static/2022-05-15-16-39-34-f888e505c953d12cd9230d0940f45016-fee1c.png 800w,\n/static/2022-05-15-16-39-34-f888e505c953d12cd9230d0940f45016-85bfe.png 814w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>即</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="91955059619320730000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`newX = x * sx;\nnewY = y * sy;`, `91955059619320730000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">newX = x * sx;\nnewY = y * sy;</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>和缩放例子相似。</p>\n<p>现在你可能还会想“那又怎样，有什么意义？”，好像花了更多精力做之前做过的事情。</p>\n<p>现在开始有趣的部分了，相乘后他们可以用一个矩阵代表三个变换，假定有一个方法 m3.multiply 可以将两个矩阵相乘并返回结果。</p>\n<p>为了方便讲解，我们先创建平移，旋转和缩放矩阵。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="34644199836005417000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var m3 = {\n  translation: function (tx, ty) {\n    return [1, 0, 0, 0, 1, 0, tx, ty, 1];\n  },\n\n  rotation: function (angleInRadians) {\n    var c = Math.cos(angleInRadians);\n    var s = Math.sin(angleInRadians);\n    return [c, -s, 0, s, c, 0, 0, 0, 1];\n  },\n\n  scaling: function (sx, sy) {\n    return [sx, 0, 0, 0, sy, 0, 0, 0, 1];\n  }\n};`, `34644199836005417000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> m3 <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token function-variable function">translation</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">tx<span class="token punctuation">,</span> ty</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> tx<span class="token punctuation">,</span> ty<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n\n  <span class="token function-variable function">rotation</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">angleInRadians</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">var</span> c <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">cos</span><span class="token punctuation">(</span>angleInRadians<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">var</span> s <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">sin</span><span class="token punctuation">(</span>angleInRadians<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">return</span> <span class="token punctuation">[</span>c<span class="token punctuation">,</span> <span class="token operator">-</span>s<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> s<span class="token punctuation">,</span> c<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n\n  <span class="token function-variable function">scaling</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">sx<span class="token punctuation">,</span> sy</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token punctuation">[</span>sx<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> sy<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在该修改着色器了，原来的着色器像这样</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="39955222377643200000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<script id=&quot;vertex-shader-2d&quot; type=&quot;x-shader/x-vertex&quot;>\n   attribute vec2 a_position;\n\n   uniform vec2 u_resolution;\n   uniform vec2 u_translation;\n   uniform vec2 u_rotation;\n   uniform vec2 u_scale;\n\n   void main() {\n      // 缩放\n      vec2 scaledPosition = a_position * u_scale;\n\n      // 旋转\n      vec2 rotatedPosition = vec2(\n         scaledPosition.x * u_rotation.y + scaledPosition.y * u_rotation.x,\n         scaledPosition.y * u_rotation.y - scaledPosition.x * u_rotation.x);\n\n      // 平移\n      vec2 position = rotatedPosition + u_translation;\n      // ...\n   }\n</script>`, `39955222377643200000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token operator">&lt;</span>script id<span class="token operator">=</span><span class="token string">"vertex-shader-2d"</span> type<span class="token operator">=</span><span class="token string">"x-shader/x-vertex"</span><span class="token operator">></span>\n   attribute vec2 a_position<span class="token punctuation">;</span>\n\n   uniform vec2 u_resolution<span class="token punctuation">;</span>\n   uniform vec2 u_translation<span class="token punctuation">;</span>\n   uniform vec2 u_rotation<span class="token punctuation">;</span>\n   uniform vec2 u_scale<span class="token punctuation">;</span>\n\n   <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 缩放</span>\n      vec2 scaledPosition <span class="token operator">=</span> a_position <span class="token operator">*</span> u_scale<span class="token punctuation">;</span>\n\n      <span class="token comment">// 旋转</span>\n      vec2 rotatedPosition <span class="token operator">=</span> <span class="token function">vec2</span><span class="token punctuation">(</span>\n         scaledPosition<span class="token punctuation">.</span>x <span class="token operator">*</span> u_rotation<span class="token punctuation">.</span>y <span class="token operator">+</span> scaledPosition<span class="token punctuation">.</span>y <span class="token operator">*</span> u_rotation<span class="token punctuation">.</span>x<span class="token punctuation">,</span>\n         scaledPosition<span class="token punctuation">.</span>y <span class="token operator">*</span> u_rotation<span class="token punctuation">.</span>y <span class="token operator">-</span> scaledPosition<span class="token punctuation">.</span>x <span class="token operator">*</span> u_rotation<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token comment">// 平移</span>\n      vec2 position <span class="token operator">=</span> rotatedPosition <span class="token operator">+</span> u_translation<span class="token punctuation">;</span>\n      <span class="token comment">// ...</span>\n   <span class="token punctuation">}</span>\n<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>新着色器就简单多了。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="58300137915101910000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<script id=&quot;vertex-shader-2d&quot; type=&quot;x-shader/x-vertex&quot;>\n   attribute vec2 a_position;\n\n   uniform vec2 u_resolution;\n   uniform mat3 u_matrix;\n\n   void main() {\n      // 将位置乘以矩阵\n      vec2 position = (u_matrix * vec3(a_position, 1)).xy;\n      // ...\n   }\n</script>`, `58300137915101910000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token operator">&lt;</span>script id<span class="token operator">=</span><span class="token string">"vertex-shader-2d"</span> type<span class="token operator">=</span><span class="token string">"x-shader/x-vertex"</span><span class="token operator">></span>\n   attribute vec2 a_position<span class="token punctuation">;</span>\n\n   uniform vec2 u_resolution<span class="token punctuation">;</span>\n   uniform mat3 u_matrix<span class="token punctuation">;</span>\n\n   <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 将位置乘以矩阵</span>\n      vec2 position <span class="token operator">=</span> <span class="token punctuation">(</span>u_matrix <span class="token operator">*</span> <span class="token function">vec3</span><span class="token punctuation">(</span>a_position<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>xy<span class="token punctuation">;</span>\n      <span class="token comment">// ...</span>\n   <span class="token punctuation">}</span>\n<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这是使用的方法</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="72046773445785120000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 绘制场景\nfunction drawScene() {\n  // ...\n\n  // 计算矩阵\n  var translationMatrix = m3.translation(translation[0], translation[1]);\n  var rotationMatrix = m3.rotation(angleInRadians);\n  var scaleMatrix = m3.scaling(scale[0], scale[1]);\n\n  // 矩阵相乘\n  var matrix = m3.multiply(translationMatrix, rotationMatrix);\n  matrix = m3.multiply(matrix, scaleMatrix);\n\n  // 设置矩阵\n  gl.uniformMatrix3fv(matrixLocation, false, matrix);\n\n  // 绘制图形\n  gl.drawArrays(gl.TRIANGLES, 0, 18);\n}`, `72046773445785120000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 绘制场景</span>\n<span class="token keyword">function</span> <span class="token function">drawScene</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// ...</span>\n\n  <span class="token comment">// 计算矩阵</span>\n  <span class="token keyword">var</span> translationMatrix <span class="token operator">=</span> m3<span class="token punctuation">.</span><span class="token function">translation</span><span class="token punctuation">(</span>translation<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> translation<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> rotationMatrix <span class="token operator">=</span> m3<span class="token punctuation">.</span><span class="token function">rotation</span><span class="token punctuation">(</span>angleInRadians<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> scaleMatrix <span class="token operator">=</span> m3<span class="token punctuation">.</span><span class="token function">scaling</span><span class="token punctuation">(</span>scale<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> scale<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 矩阵相乘</span>\n  <span class="token keyword">var</span> matrix <span class="token operator">=</span> m3<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>translationMatrix<span class="token punctuation">,</span> rotationMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  matrix <span class="token operator">=</span> m3<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>matrix<span class="token punctuation">,</span> scaleMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 设置矩阵</span>\n  gl<span class="token punctuation">.</span><span class="token function">uniformMatrix3fv</span><span class="token punctuation">(</span>matrixLocation<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> matrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 绘制图形</span>\n  gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TRIANGLES</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这个例子用的新代码，滑块没变，还是对应平移，旋转和缩放，但是他们在着色器中做的事情是相似的。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/4b2hc3?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>可能你还会问，那又怎样？看起来没什么特别好的地方。但是，如果现在我们想改变转换顺序的话，就不需要重写一个着色器了，只需要改变一下数学运算。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="76784847603893520000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// ...\n\n// 矩阵相乘\nvar matrix = m3.multiply(scaleMatrix, rotationMatrix);\nmatrix = m3.multiply(matrix, translationMatrix);\n\n// ...`, `76784847603893520000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{3-5}"\n              >\n                <span class="gatsby-code-button-language">js{3-5}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// ...</span>\n\n<span class="gatsby-highlight-code-line"><span class="token comment">// 矩阵相乘</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">var</span> matrix <span class="token operator">=</span> m3<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>scaleMatrix<span class="token punctuation">,</span> rotationMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">matrix <span class="token operator">=</span> m3<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>matrix<span class="token punctuation">,</span> translationMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="token comment">// ...</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/fdzw2v?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>像这样的矩阵相乘对层级变换至关重要，比如身体的手臂部分运动，月球属于绕太阳转动的地球的一部分，或者树上的树枝。写一个简单的层级运动的例子，我们来画 5 个 ‘F’，并且每个 ‘F’ 都以前一个的矩阵为基础。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="54159694952171920000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 绘制场景\nfunction drawScene() {\n  // 清空画布\n  gl.clear(gl.COLOR_BUFFER_BIT);\n\n  // 计算矩阵\n  var translationMatrix = m3.translation(translation[0], translation[1]);\n  var rotationMatrix = m3.rotation(angleInRadians);\n  var scaleMatrix = m3.scaling(scale[0], scale[1]);\n\n  // 初始矩阵\n  var matrix = m3.identity();\n\n  for (var i = 0; i < 5; ++i) {\n    // 矩阵相乘\n    matrix = m3.multiply(matrix, translationMatrix);\n    matrix = m3.multiply(matrix, rotationMatrix);\n    matrix = m3.multiply(matrix, scaleMatrix);\n\n    // 设置矩阵\n    gl.uniformMatrix3fv(matrixLocation, false, matrix);\n\n    // 绘制图形\n    gl.drawArrays(gl.TRIANGLES, 0, 18);\n  }\n}`, `54159694952171920000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 绘制场景</span>\n<span class="token keyword">function</span> <span class="token function">drawScene</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 清空画布</span>\n  gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 计算矩阵</span>\n  <span class="token keyword">var</span> translationMatrix <span class="token operator">=</span> m3<span class="token punctuation">.</span><span class="token function">translation</span><span class="token punctuation">(</span>translation<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> translation<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> rotationMatrix <span class="token operator">=</span> m3<span class="token punctuation">.</span><span class="token function">rotation</span><span class="token punctuation">(</span>angleInRadians<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> scaleMatrix <span class="token operator">=</span> m3<span class="token punctuation">.</span><span class="token function">scaling</span><span class="token punctuation">(</span>scale<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> scale<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 初始矩阵</span>\n  <span class="token keyword">var</span> matrix <span class="token operator">=</span> m3<span class="token punctuation">.</span><span class="token function">identity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 矩阵相乘</span>\n    matrix <span class="token operator">=</span> m3<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>matrix<span class="token punctuation">,</span> translationMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    matrix <span class="token operator">=</span> m3<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>matrix<span class="token punctuation">,</span> rotationMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    matrix <span class="token operator">=</span> m3<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>matrix<span class="token punctuation">,</span> scaleMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// 设置矩阵</span>\n    gl<span class="token punctuation">.</span><span class="token function">uniformMatrix3fv</span><span class="token punctuation">(</span>matrixLocation<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> matrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// 绘制图形</span>\n    gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TRIANGLES</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在这个例子中用到了一个新方法 <code class="language-text">m3.identity</code>，这个方法创建一个单位矩阵。单位矩阵就像 1.0 一样，和它相乘的矩阵不会变化</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="38398317557067220000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var m3 = {\n  identity: function () {\n    return [1, 0, 0, 0, 1, 0, 0, 0, 1];\n  }\n};`, `38398317557067220000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> m3 <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token function-variable function">identity</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这是 5 个 F。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/w7p3wi?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>再看一个例子，之前的每个例子中 ‘F’ 都是绕着它的左上角旋转 （当然，改变转换顺序的那个例子除外）。这是因为我们总是绕原点旋转，而 ‘F’ 的原点就是左上角，也就是 (0, 0) 。</p>\n<p>现在我们可以使用矩阵运算，并且自定义转换的顺序。所以让我们改变旋转的中心</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="75472603242600870000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 创建一个矩阵，可以将原点移动到 \'F\' 的中心\nvar moveOriginMatrix = m3.translation(-50, -75);\n// ...\n\n// 矩阵相乘\nvar matrix = m3.multiply(translationMatrix, rotationMatrix);\nmatrix = m3.multiply(matrix, scaleMatrix);\nmatrix = m3.multiply(matrix, moveOriginMatrix);`, `75472603242600870000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 创建一个矩阵，可以将原点移动到 \'F\' 的中心</span>\n<span class="token keyword">var</span> moveOriginMatrix <span class="token operator">=</span> m3<span class="token punctuation">.</span><span class="token function">translation</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">50</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">75</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// ...</span>\n\n<span class="token comment">// 矩阵相乘</span>\n<span class="token keyword">var</span> matrix <span class="token operator">=</span> m3<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>translationMatrix<span class="token punctuation">,</span> rotationMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\nmatrix <span class="token operator">=</span> m3<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>matrix<span class="token punctuation">,</span> scaleMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\nmatrix <span class="token operator">=</span> m3<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>matrix<span class="token punctuation">,</span> moveOriginMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这是结果，注意到 F 现在绕中心旋转和缩放了。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/3mvm0w?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>通过这种方式你可以绕任意点旋转和缩放，所以现在你可能知道为什么 PhotoShop 或 Flash 可以让你移动旋转中心。</p>\n<p>还可以做更有趣的事情，如果你回想第一篇文章 WebGL 基础概念，可能会记得在着色器中我们将像素坐标转换到裁剪空间，这是当时的代码</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="27210743514857770000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// ...\n// 从像素坐标转换到 0.0 到 1.0\nvec2 zeroToOne = position / u_resolution;\n\n// 再把 0->1 转换 0->2\nvec2 zeroToTwo = zeroToOne * 2.0;\n\n// 把 0->2 转换到 -1->+1 (裁剪空间)\nvec2 clipSpace = zeroToTwo - 1.0;\n\ngl_Position = vec4(clipSpace * vec2(1, -1), 0, 1);`, `27210743514857770000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl"\n              >\n                <span class="gatsby-code-button-language">glsl</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token comment">// ...</span>\n<span class="token comment">// 从像素坐标转换到 0.0 到 1.0</span>\n<span class="token keyword">vec2</span> zeroToOne <span class="token operator">=</span> position <span class="token operator">/</span> u_resolution<span class="token punctuation">;</span>\n\n<span class="token comment">// 再把 0->1 转换 0->2</span>\n<span class="token keyword">vec2</span> zeroToTwo <span class="token operator">=</span> zeroToOne <span class="token operator">*</span> <span class="token number">2.0</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 把 0->2 转换到 -1->+1 (裁剪空间)</span>\n<span class="token keyword">vec2</span> clipSpace <span class="token operator">=</span> zeroToTwo <span class="token operator">-</span> <span class="token number">1.0</span><span class="token punctuation">;</span>\n\ngl_Position <span class="token operator">=</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>clipSpace <span class="token operator">*</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>逐步观察，首先 <code class="language-text">从像素坐标转换到 0.0 到 1.0</code> 事实上是一个缩放变换，第二步也是缩放变换，接着是一个平移和一个 Y 为 -1 的缩放。我们可以将这些操作放入一个矩阵传给着色器，创建两个缩放矩阵，一个缩放 1.0/分辨率，另一个缩放 2.0，第三个平移 (-1.0, -1.0), 然后第四个将 Y 缩放 -1。 然后将他们乘在一起，由于运算很简单，所以我们就直接定义一个 projection 方法，根据分辨率直接生成矩阵。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="96444506318332360000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var m3 = {\n  projection: function (width, height) {\n    // 注意：这个矩阵翻转了 Y 轴，所以 0 在上方\n    return [2 / width, 0, 0, 0, -2 / height, 0, -1, 1, 1];\n  }\n};`, `96444506318332360000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> m3 <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token function-variable function">projection</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">width<span class="token punctuation">,</span> height</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 注意：这个矩阵翻转了 Y 轴，所以 0 在上方</span>\n    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token number">2</span> <span class="token operator">/</span> width<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span> <span class="token operator">/</span> height<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在可以简化着色器，这是新的着色器。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="74023998009805300000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<script id=&quot;vertex-shader-2d&quot; type=&quot;x-shader/x-vertex&quot;>\n   attribute vec2 a_position;\n\n   uniform mat3 u_matrix;\n\n   void main() {\n      // 使位置和矩阵相乘\n      gl_Position = vec4((u_matrix * vec3(a_position, 1)).xy, 0, 1);\n   }\n</script>`, `74023998009805300000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token operator">&lt;</span>script id<span class="token operator">=</span><span class="token string">"vertex-shader-2d"</span> type<span class="token operator">=</span><span class="token string">"x-shader/x-vertex"</span><span class="token operator">></span>\n   attribute vec2 a_position<span class="token punctuation">;</span>\n\n   uniform mat3 u_matrix<span class="token punctuation">;</span>\n\n   <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 使位置和矩阵相乘</span>\n      gl_Position <span class="token operator">=</span> <span class="token function">vec4</span><span class="token punctuation">(</span><span class="token punctuation">(</span>u_matrix <span class="token operator">*</span> <span class="token function">vec3</span><span class="token punctuation">(</span>a_position<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>xy<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在 JavaScript 中需要乘上投影矩阵</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="21765165554308784000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 绘制场景\nfunction drawScene() {\n  // ...\n\n  // 计算矩阵\n  var projectionMatrix = m3.projection(gl.canvas.clientWidth, gl.canvas.clientHeight);\n\n  // ...\n\n  // 矩阵相乘\n  var matrix = m3.multiply(projectionMatrix, translationMatrix);\n  matrix = m3.multiply(matrix, rotationMatrix);\n  matrix = m3.multiply(matrix, scaleMatrix);\n\n  // ...\n}`, `21765165554308784000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 绘制场景</span>\n<span class="token keyword">function</span> <span class="token function">drawScene</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// ...</span>\n\n  <span class="token comment">// 计算矩阵</span>\n  <span class="token keyword">var</span> projectionMatrix <span class="token operator">=</span> m3<span class="token punctuation">.</span><span class="token function">projection</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>clientWidth<span class="token punctuation">,</span> gl<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>clientHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// ...</span>\n\n  <span class="token comment">// 矩阵相乘</span>\n  <span class="token keyword">var</span> matrix <span class="token operator">=</span> m3<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>projectionMatrix<span class="token punctuation">,</span> translationMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  matrix <span class="token operator">=</span> m3<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>matrix<span class="token punctuation">,</span> rotationMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  matrix <span class="token operator">=</span> m3<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>matrix<span class="token punctuation">,</span> scaleMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// ...</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这里还去除了设置分辨率的代码，通过使用矩阵，我们就把着色器中 6-7 步的操作在一步中完成。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/uyfqlr?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>在继续之前我们可以先简化一下操作，虽然先创建一些矩阵再将它们相乘很常见，但是按照我们的顺序依次操作矩阵也比较常见，比较高效的做法是创建这样的方法</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="58474651289536090000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var m3 = {\n  // ...\n\n  translate: function (m, tx, ty) {\n    return m3.multiply(m, m3.translation(tx, ty));\n  },\n\n  rotate: function (m, angleInRadians) {\n    return m3.multiply(m, m3.rotation(angleInRadians));\n  },\n\n  scale: function (m, sx, sy) {\n    return m3.multiply(m, m3.scaling(sx, sy));\n  }\n\n  // ...\n};`, `58474651289536090000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> m3 <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token comment">// ...</span>\n\n  <span class="token function-variable function">translate</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">m<span class="token punctuation">,</span> tx<span class="token punctuation">,</span> ty</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> m3<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> m3<span class="token punctuation">.</span><span class="token function">translation</span><span class="token punctuation">(</span>tx<span class="token punctuation">,</span> ty<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n\n  <span class="token function-variable function">rotate</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">m<span class="token punctuation">,</span> angleInRadians</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> m3<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> m3<span class="token punctuation">.</span><span class="token function">rotation</span><span class="token punctuation">(</span>angleInRadians<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n\n  <span class="token function-variable function">scale</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">m<span class="token punctuation">,</span> sx<span class="token punctuation">,</span> sy</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> m3<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> m3<span class="token punctuation">.</span><span class="token function">scaling</span><span class="token punctuation">(</span>sx<span class="token punctuation">,</span> sy<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token comment">// ...</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这能够让我们将 7 行的矩阵代码转换成 4 行</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="48958862268994200000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 计算矩阵\nvar matrix = m3.projection(gl.canvas.clientWidth, gl.canvas.clientHeight); // 返回的是画布在浏览器中实际显示的大小，所以这里图片比例不会变化。相反如果直接用 canvas.width 和 canvas.height，画布将被拉伸导致图片变形\nmatrix = m3.translate(matrix, translation[0], translation[1]);\nmatrix = m3.rotate(matrix, angleInRadians);\nmatrix = m3.scale(matrix, scale[0], scale[1]);`, `48958862268994200000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 计算矩阵</span>\n<span class="token keyword">var</span> matrix <span class="token operator">=</span> m3<span class="token punctuation">.</span><span class="token function">projection</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>clientWidth<span class="token punctuation">,</span> gl<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>clientHeight<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 返回的是画布在浏览器中实际显示的大小，所以这里图片比例不会变化。相反如果直接用 canvas.width 和 canvas.height，画布将被拉伸导致图片变形</span>\nmatrix <span class="token operator">=</span> m3<span class="token punctuation">.</span><span class="token function">translate</span><span class="token punctuation">(</span>matrix<span class="token punctuation">,</span> translation<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> translation<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nmatrix <span class="token operator">=</span> m3<span class="token punctuation">.</span><span class="token function">rotate</span><span class="token punctuation">(</span>matrix<span class="token punctuation">,</span> angleInRadians<span class="token punctuation">)</span><span class="token punctuation">;</span>\nmatrix <span class="token operator">=</span> m3<span class="token punctuation">.</span><span class="token function">scale</span><span class="token punctuation">(</span>matrix<span class="token punctuation">,</span> scale<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> scale<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这是结果</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/lvd1iu?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>最后一件事，我们之前使用了多种矩阵顺序。第一例中使用</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="57701136409054050000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`translation * rotation * scale; // 平移 * 旋转 * 缩放`, `57701136409054050000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">translation <span class="token operator">*</span> rotation <span class="token operator">*</span> scale<span class="token punctuation">;</span> <span class="token comment">// 平移 * 旋转 * 缩放</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>第二例中使用</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="3342675448937138000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`scale * rotation * translation; // 缩放 * 旋转 * 平移`, `3342675448937138000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">scale <span class="token operator">*</span> rotation <span class="token operator">*</span> translation<span class="token punctuation">;</span> <span class="token comment">// 缩放 * 旋转 * 平移</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>然后观察了它们的区别。</p>\n<p>这有两种方式解读矩阵运算，给定这样一个表达式</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="81174360151695600000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`projectionMat * translationMat * rotationMat * scaleMat * position;`, `81174360151695600000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">projectionMat <span class="token operator">*</span> translationMat <span class="token operator">*</span> rotationMat <span class="token operator">*</span> scaleMat <span class="token operator">*</span> position<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>第一种可能是多数人觉得比较自然的方式，从右向左解释</p>\n<p>首先将位置乘以缩放矩阵获得缩放后的位置</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="51445505024881920000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`scaledPosition = scaleMat * position;`, `51445505024881920000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">scaledPosition <span class="token operator">=</span> scaleMat <span class="token operator">*</span> position<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>然后将缩放后的位置和旋转矩阵相乘得到缩放旋转位置</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="89512858539707860000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`rotatedScaledPosition = rotationMat * scaledPosition;`, `89512858539707860000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">rotatedScaledPosition <span class="token operator">=</span> rotationMat <span class="token operator">*</span> scaledPosition<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>然后将缩放旋转位置和平移矩阵相乘得到缩放旋转平移位置</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="55236253975868130000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`translatedRotatedScaledPosition = translationMat * rotatedScaledPosition;`, `55236253975868130000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">translatedRotatedScaledPosition <span class="token operator">=</span> translationMat <span class="token operator">*</span> rotatedScaledPosition<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>最后和投影矩阵相乘得到裁剪空间中的坐标</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="20122045844462910000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`clipspacePosition = projectioMatrix * translatedRotatedScaledPosition;`, `20122045844462910000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">clipspacePosition <span class="token operator">=</span> projectioMatrix <span class="token operator">*</span> translatedRotatedScaledPosition<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>第二种方式是从左往右解释，在这个例子中每一个矩阵改变的都是画布的坐标空间，画布的起始空间是裁剪空间的范围(-1 到 +1)，矩阵从左到右改变着画布所在的空间。</p>\n<ol>\n<li>没有矩阵（或者单位矩阵）</li>\n</ol>\n<html><head></head><body><iframe data-src="https://codesandbox.io/embed/siwlob?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview&amp;initialpath=?stage=0" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe></body></html>\n<!-- [webgl-2d-matrix-space-change](embedded-codesandbox://webgl-fundamental-2d/webgl-2d-matrix-space-change?view=preview&initialpath=?stage=0) -->\n<p>白色区域是画布，蓝色是画布以外，我们正在裁剪空间中。传递到这里的点需要在裁剪空间内。</p>\n<ol start="2">\n<li><code class="language-text">matrix = m3.projection(gl.canvas.clientWidth, gl.canvas.clientHeight);</code></li>\n</ol>\n<html><head></head><body><iframe data-src="https://codesandbox.io/embed/siwlob?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview&amp;initialpath=?stage=1" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe></body></html>\n<!-- [webgl-2d-matrix-space-change](embedded-codesandbox://webgl-fundamental-2d/webgl-2d-matrix-space-change?view=preview&initialpath=?stage=1) -->\n<p>现在我们在像素空间，X 范围是 0 到 400，Y 范围是 0 到 300，0,0 点在左上角。传递到这里的点需要在像素空间内，你看到的闪烁是 Y 轴上下颠倒的原因。</p>\n<ol start="3">\n<li><code class="language-text">matrix = m3.translate(matrix, tx, ty);</code></li>\n</ol>\n<html><head></head><body><iframe data-src="https://codesandbox.io/embed/siwlob?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview&amp;initialpath=?stage=2" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe></body></html>\n<!-- [webgl-2d-matrix-space-change](embedded-codesandbox://webgl-fundamental-2d/webgl-2d-matrix-space-change?view=preview&initialpath=?stage=2) -->\n<p>原点被移动到了 tx, ty (150, 100)，所以空间移动了。</p>\n<ol start="4">\n<li><code class="language-text">matrix = m3.rotate(matrix, rotationInRadians);</code></li>\n</ol>\n<html><head></head><body><iframe data-src="https://codesandbox.io/embed/siwlob?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview&amp;initialpath=?stage=3" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe></body></html>\n<!-- [webgl-2d-matrix-space-change](embedded-codesandbox://webgl-fundamental-2d/webgl-2d-matrix-space-change?view=preview&initialpath=?stage=3) -->\n<p>空间绕 tx, ty 旋转</p>\n<ol start="5">\n<li><code class="language-text">matrix = m3.scale(matrix, sx, sy);</code></li>\n</ol>\n<html><head></head><body><iframe data-src="https://codesandbox.io/embed/siwlob?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview&amp;initialpath=?stage=4" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe></body></html>\n<!-- [webgl-2d-matrix-space-change](embedded-codesandbox://webgl-fundamental-2d/webgl-2d-matrix-space-change?view=preview&initialpath=?stage=4) -->\n<p>之前的旋转空间中心在 tx, ty，x 方向缩放 2，y 方向缩放 1.5</p>\n<p>在着色器中执行 <code class="language-text">gl_Position = matrix * position;</code>，position 被直接转换到这个空间。</p>\n<p>选一个你容易接受的方式去理解吧。</p>\n<h1 id="webgl-实现-drawimage-接口"><a href="#webgl-%E5%AE%9E%E7%8E%B0-drawimage-%E6%8E%A5%E5%8F%A3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>WebGL 实现 DrawImage 接口</h1>\n<p>此文上接 WebGL 三维正射投影，如果没读建议从那里开始，你也应了解纹理和纹理坐标，如果不清楚可以看看 WebGL 三维纹理。</p>\n<p>实现大多数二维游戏只需要一个方法去绘制一个图像，当然也有一些二维游戏用线等技术做一些有趣的东西，但是如果你有绘制二维图像的方法，基本上可以做大多数二维游戏。</p>\n<p>画布有一个非常灵活的二维接口叫做 drawImage，用于绘制图像。它有三个版本</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="40271279184581600000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`ctx.drawImage(image, dstX, dstY);\nctx.drawImage(image, dstX, dstY, dstWidth, dstHeight);\nctx.drawImage(image, srcX, srcY, srcWidth, srcHeight, dstX, dstY, dstWidth, dstHeight);`, `40271279184581600000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">ctx<span class="token punctuation">.</span><span class="token function">drawImage</span><span class="token punctuation">(</span>image<span class="token punctuation">,</span> dstX<span class="token punctuation">,</span> dstY<span class="token punctuation">)</span><span class="token punctuation">;</span>\nctx<span class="token punctuation">.</span><span class="token function">drawImage</span><span class="token punctuation">(</span>image<span class="token punctuation">,</span> dstX<span class="token punctuation">,</span> dstY<span class="token punctuation">,</span> dstWidth<span class="token punctuation">,</span> dstHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>\nctx<span class="token punctuation">.</span><span class="token function">drawImage</span><span class="token punctuation">(</span>image<span class="token punctuation">,</span> srcX<span class="token punctuation">,</span> srcY<span class="token punctuation">,</span> srcWidth<span class="token punctuation">,</span> srcHeight<span class="token punctuation">,</span> dstX<span class="token punctuation">,</span> dstY<span class="token punctuation">,</span> dstWidth<span class="token punctuation">,</span> dstHeight<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>用你现在学到的所有东西如何使用 WebGL 实现这个接口？你想到的办法可能是创建一些顶点，像本站第一篇文章那样。将顶点传送到 GPU 是一个比较耗时的操作（尽管某些情况下比较快）。</p>\n<p>这就是 WebGL 发挥作用的地方，讲究富有创造性地编写着色器和使用它们去解决问题。</p>\n<h2 id="drawimage-版本一"><a href="#drawimage-%E7%89%88%E6%9C%AC%E4%B8%80" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>drawImage 版本一</h2>\n<p>让我们从第一个版本开始</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="27321506631491620000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`ctx.drawImage(image, x, y);`, `27321506631491620000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">ctx<span class="token punctuation">.</span><span class="token function">drawImage</span><span class="token punctuation">(</span>image<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>它可以在 x, y 位置处绘制一个原始大小的图像，为了实现相似的功能，WebGL 需要上传 x, y, <code class="language-text">x + width</code>, y, x, <code class="language-text">y + height</code> 和 <code class="language-text">x + width</code>, <code class="language-text">y + height</code> 对应的顶点，当绘制不同的图像或不同的位置时就创建不同的顶点集合。</p>\n<p>一个更常用的方式是只使用一个单位矩形，我们上传一个长度为 1 个单位的正方形，然后使用矩阵运算缩放和平移单位矩形，以达到期望的大小和位置。</p>\n<p>这是代码。</p>\n<p>首先需要一个简单的顶点着色器</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="54052560818934900000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`attribute vec4 a_position;\nattribute vec2 a_texcoord;\n\nuniform mat4 u_matrix;\n\nvarying vec2 v_texcoord;\n\nvoid main() {\n   gl_Position = u_matrix * a_position;\n   v_texcoord = a_texcoord;\n}`, `54052560818934900000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl"\n              >\n                <span class="gatsby-code-button-language">glsl</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">attribute</span> <span class="token keyword">vec4</span> a_position<span class="token punctuation">;</span>\n<span class="token keyword">attribute</span> <span class="token keyword">vec2</span> a_texcoord<span class="token punctuation">;</span>\n\n<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> u_matrix<span class="token punctuation">;</span>\n\n<span class="token keyword">varying</span> <span class="token keyword">vec2</span> v_texcoord<span class="token punctuation">;</span>\n\n<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   gl_Position <span class="token operator">=</span> u_matrix <span class="token operator">*</span> a_position<span class="token punctuation">;</span>\n   v_texcoord <span class="token operator">=</span> a_texcoord<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>和一个简单的片断着色器</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="75296098145871170000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`precision mediump float;\n\nvarying vec2 v_texcoord;\n\nuniform sampler2D u_texture;\n\nvoid main() {\n   gl_FragColor = texture2D(u_texture, v_texcoord);\n}`, `75296098145871170000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl"\n              >\n                <span class="gatsby-code-button-language">glsl</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">precision</span> <span class="token keyword">mediump</span> <span class="token keyword">float</span><span class="token punctuation">;</span>\n\n<span class="token keyword">varying</span> <span class="token keyword">vec2</span> v_texcoord<span class="token punctuation">;</span>\n\n<span class="token keyword">uniform</span> <span class="token keyword">sampler2D</span> u_texture<span class="token punctuation">;</span>\n\n<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   gl_FragColor <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>u_texture<span class="token punctuation">,</span> v_texcoord<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后轮到方法</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="45504167836323340000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 不同于图像，纹理没有对应的长和宽\n// 我们将向纹理传递长和宽\nfunction drawImage(tex, texWidth, texHeight, dstX, dstY) {\n  gl.bindTexture(gl.TEXTURE_2D, tex);\n\n  // 告诉 WebGL 使用的程序\n  gl.useProgram(program);\n\n  // 设置属性，从缓冲中提取数据\n  gl.bindBuffer(gl.ARRAY_BUFFER, positionBuffer);\n  gl.enableVertexAttribArray(positionLocation);\n  gl.vertexAttribPointer(positionLocation, 2, gl.FLOAT, false, 0, 0);\n  gl.bindBuffer(gl.ARRAY_BUFFER, texcoordBuffer);\n  gl.enableVertexAttribArray(texcoordLocation);\n  gl.vertexAttribPointer(texcoordLocation, 2, gl.FLOAT, false, 0, 0);\n\n  // 从像素空间转换到裁剪空间\n  var matrix = m4.orthographic(0, gl.canvas.width, gl.canvas.height, 0, -1, 1);\n\n  // 平移到 dstX, dstY\n  matrix = m4.translate(matrix, dstX, dstY, 0);\n\n  // 缩放单位矩形的宽和高到 texWidth, texHeight 个单位长度\n  matrix = m4.scale(matrix, texWidth, texHeight, 1);\n\n  // 设置矩阵\n  gl.uniformMatrix4fv(matrixLocation, false, matrix);\n\n  // 告诉着色器使用纹理单元 0\n  gl.uniform1i(textureLocation, 0);\n\n  // 绘制矩形\n  gl.drawArrays(gl.TRIANGLES, 0, 6);\n}`, `45504167836323340000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 不同于图像，纹理没有对应的长和宽</span>\n<span class="token comment">// 我们将向纹理传递长和宽</span>\n<span class="token keyword">function</span> <span class="token function">drawImage</span><span class="token punctuation">(</span><span class="token parameter">tex<span class="token punctuation">,</span> texWidth<span class="token punctuation">,</span> texHeight<span class="token punctuation">,</span> dstX<span class="token punctuation">,</span> dstY</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  gl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> tex<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 告诉 WebGL 使用的程序</span>\n  gl<span class="token punctuation">.</span><span class="token function">useProgram</span><span class="token punctuation">(</span>program<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 设置属性，从缓冲中提取数据</span>\n  gl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> positionBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">enableVertexAttribArray</span><span class="token punctuation">(</span>positionLocation<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>positionLocation<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> texcoordBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">enableVertexAttribArray</span><span class="token punctuation">(</span>texcoordLocation<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>texcoordLocation<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 从像素空间转换到裁剪空间</span>\n  <span class="token keyword">var</span> matrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">orthographic</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>width<span class="token punctuation">,</span> gl<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>height<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 平移到 dstX, dstY</span>\n  matrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">translate</span><span class="token punctuation">(</span>matrix<span class="token punctuation">,</span> dstX<span class="token punctuation">,</span> dstY<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 缩放单位矩形的宽和高到 texWidth, texHeight 个单位长度</span>\n  matrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">scale</span><span class="token punctuation">(</span>matrix<span class="token punctuation">,</span> texWidth<span class="token punctuation">,</span> texHeight<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 设置矩阵</span>\n  gl<span class="token punctuation">.</span><span class="token function">uniformMatrix4fv</span><span class="token punctuation">(</span>matrixLocation<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> matrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 告诉着色器使用纹理单元 0</span>\n  gl<span class="token punctuation">.</span><span class="token function">uniform1i</span><span class="token punctuation">(</span>textureLocation<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 绘制矩形</span>\n  gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TRIANGLES</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们来加载一些图像用于纹理</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="71435300209759140000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 创建一个纹理信息 { width: w, height: h, texture: tex }\n// 纹理起初为 1x1 像素，当图像加载完成后更新大小\nfunction loadImageAndCreateTextureInfo(url) {\n  var tex = gl.createTexture();\n  gl.bindTexture(gl.TEXTURE_2D, tex);\n\n  // 假设所有的图像维度都不是 2 的整数次幂\n  gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);\n  gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);\n  gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);\n\n  var textureInfo = {\n    width: 1, // 图像加载前不知道大小\n    height: 1,\n    texture: tex\n  };\n  var img = new Image();\n  img.addEventListener(\'load\', function () {\n    textureInfo.width = img.width;\n    textureInfo.height = img.height;\n\n    gl.bindTexture(gl.TEXTURE_2D, textureInfo.texture);\n    gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, img);\n  });\n\n  return textureInfo;\n}\n\nvar textureInfos = [\n  loadImageAndCreateTextureInfo(\'resources/star.jpg\'),\n  loadImageAndCreateTextureInfo(\'resources/leaves.jpg\'),\n  loadImageAndCreateTextureInfo(\'resources/keyboard.jpg\')\n];`, `71435300209759140000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 创建一个纹理信息 { width: w, height: h, texture: tex }</span>\n<span class="token comment">// 纹理起初为 1x1 像素，当图像加载完成后更新大小</span>\n<span class="token keyword">function</span> <span class="token function">loadImageAndCreateTextureInfo</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> tex <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createTexture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> tex<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 假设所有的图像维度都不是 2 的整数次幂</span>\n  gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_WRAP_S</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">CLAMP_TO_EDGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_WRAP_T</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">CLAMP_TO_EDGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_MIN_FILTER</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">LINEAR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">var</span> textureInfo <span class="token operator">=</span> <span class="token punctuation">{</span>\n    width<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// 图像加载前不知道大小</span>\n    height<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>\n    texture<span class="token punctuation">:</span> tex\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> img <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  img<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">\'load\'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    textureInfo<span class="token punctuation">.</span>width <span class="token operator">=</span> img<span class="token punctuation">.</span>width<span class="token punctuation">;</span>\n    textureInfo<span class="token punctuation">.</span>height <span class="token operator">=</span> img<span class="token punctuation">.</span>height<span class="token punctuation">;</span>\n\n    gl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> textureInfo<span class="token punctuation">.</span>texture<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    gl<span class="token punctuation">.</span><span class="token function">texImage2D</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGBA</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGBA</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">UNSIGNED_BYTE</span><span class="token punctuation">,</span> img<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">return</span> textureInfo<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">var</span> textureInfos <span class="token operator">=</span> <span class="token punctuation">[</span>\n  <span class="token function">loadImageAndCreateTextureInfo</span><span class="token punctuation">(</span><span class="token string">\'resources/star.jpg\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n  <span class="token function">loadImageAndCreateTextureInfo</span><span class="token punctuation">(</span><span class="token string">\'resources/leaves.jpg\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n  <span class="token function">loadImageAndCreateTextureInfo</span><span class="token punctuation">(</span><span class="token string">\'resources/keyboard.jpg\'</span><span class="token punctuation">)</span>\n<span class="token punctuation">]</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>绘制到随机位置</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="96088574503738060000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var drawInfos = [];\nvar numToDraw = 9;\nvar speed = 60;\nfor (var ii = 0; ii < numToDraw; ++ii) {\n  var drawInfo = {\n    x: Math.random() * gl.canvas.width,\n    y: Math.random() * gl.canvas.height,\n    dx: Math.random() > 0.5 ? -1 : 1,\n    dy: Math.random() > 0.5 ? -1 : 1,\n    textureInfo: textureInfos[(Math.random() * textureInfos.length) | 0]\n  };\n  drawInfos.push(drawInfo);\n}\n\nfunction update(deltaTime) {\n  drawInfos.forEach(function (drawInfo) {\n    drawInfo.x += drawInfo.dx * speed * deltaTime;\n    drawInfo.y += drawInfo.dy * speed * deltaTime;\n    if (drawInfo.x < 0) {\n      drawInfo.dx = 1;\n    }\n    if (drawInfo.x >= gl.canvas.width) {\n      drawInfo.dx = -1;\n    }\n    if (drawInfo.y < 0) {\n      drawInfo.dy = 1;\n    }\n    if (drawInfo.y >= gl.canvas.height) {\n      drawInfo.dy = -1;\n    }\n  });\n}\n\nfunction draw() {\n  gl.clear(gl.COLOR_BUFFER_BIT);\n\n  drawInfos.forEach(function (drawInfo) {\n    drawImage(\n      drawInfo.textureInfo.texture,\n      drawInfo.textureInfo.width,\n      drawInfo.textureInfo.height,\n      drawInfo.x,\n      drawInfo.y\n    );\n  });\n}\n\nvar then = 0;\nfunction render(time) {\n  var now = time * 0.001;\n  var deltaTime = Math.min(0.1, now - then);\n  then = now;\n\n  update(deltaTime);\n  draw();\n\n  requestAnimationFrame(render);\n}\nrequestAnimationFrame(render);`, `96088574503738060000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> drawInfos <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> numToDraw <span class="token operator">=</span> <span class="token number">9</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> speed <span class="token operator">=</span> <span class="token number">60</span><span class="token punctuation">;</span>\n<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> ii <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> ii <span class="token operator">&lt;</span> numToDraw<span class="token punctuation">;</span> <span class="token operator">++</span>ii<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> drawInfo <span class="token operator">=</span> <span class="token punctuation">{</span>\n    x<span class="token punctuation">:</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> gl<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>width<span class="token punctuation">,</span>\n    y<span class="token punctuation">:</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> gl<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>height<span class="token punctuation">,</span>\n    dx<span class="token punctuation">:</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0.5</span> <span class="token operator">?</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>\n    dy<span class="token punctuation">:</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0.5</span> <span class="token operator">?</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>\n    textureInfo<span class="token punctuation">:</span> textureInfos<span class="token punctuation">[</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> textureInfos<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">0</span><span class="token punctuation">]</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n  drawInfos<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>drawInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token parameter">deltaTime</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  drawInfos<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">drawInfo</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    drawInfo<span class="token punctuation">.</span>x <span class="token operator">+=</span> drawInfo<span class="token punctuation">.</span>dx <span class="token operator">*</span> speed <span class="token operator">*</span> deltaTime<span class="token punctuation">;</span>\n    drawInfo<span class="token punctuation">.</span>y <span class="token operator">+=</span> drawInfo<span class="token punctuation">.</span>dy <span class="token operator">*</span> speed <span class="token operator">*</span> deltaTime<span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>drawInfo<span class="token punctuation">.</span>x <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      drawInfo<span class="token punctuation">.</span>dx <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>drawInfo<span class="token punctuation">.</span>x <span class="token operator">>=</span> gl<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>width<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      drawInfo<span class="token punctuation">.</span>dx <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>drawInfo<span class="token punctuation">.</span>y <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      drawInfo<span class="token punctuation">.</span>dy <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>drawInfo<span class="token punctuation">.</span>y <span class="token operator">>=</span> gl<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>height<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      drawInfo<span class="token punctuation">.</span>dy <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  drawInfos<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">drawInfo</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token function">drawImage</span><span class="token punctuation">(</span>\n      drawInfo<span class="token punctuation">.</span>textureInfo<span class="token punctuation">.</span>texture<span class="token punctuation">,</span>\n      drawInfo<span class="token punctuation">.</span>textureInfo<span class="token punctuation">.</span>width<span class="token punctuation">,</span>\n      drawInfo<span class="token punctuation">.</span>textureInfo<span class="token punctuation">.</span>height<span class="token punctuation">,</span>\n      drawInfo<span class="token punctuation">.</span>x<span class="token punctuation">,</span>\n      drawInfo<span class="token punctuation">.</span>y\n    <span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">var</span> then <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n<span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token parameter">time</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> now <span class="token operator">=</span> time <span class="token operator">*</span> <span class="token number">0.001</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> deltaTime <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">,</span> now <span class="token operator">-</span> then<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  then <span class="token operator">=</span> now<span class="token punctuation">;</span>\n\n  <span class="token function">update</span><span class="token punctuation">(</span>deltaTime<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>render<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>render<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以在这里看到运行结果</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/6hmyzm?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h2 id="drawimage-版本二"><a href="#drawimage-%E7%89%88%E6%9C%AC%E4%BA%8C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>drawImage 版本二</h2>\n<p>处理 drawImage 方法的第二个版本</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="25950348907492237000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`ctx.drawImage(image, dstX, dstY, dstWidth, dstHeight);`, `25950348907492237000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">ctx<span class="token punctuation">.</span><span class="token function">drawImage</span><span class="token punctuation">(</span>image<span class="token punctuation">,</span> dstX<span class="token punctuation">,</span> dstY<span class="token punctuation">,</span> dstWidth<span class="token punctuation">,</span> dstHeight<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>没什么特别的地方，只是用 dstWidth 和 dstHeight 代替了 texWidth 和 texHeight。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="2751921005761382000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function drawImage(tex, texWidth, texHeight, dstX, dstY, dstWidth, dstHeight) {\n  if (dstWidth === undefined) {\n    dstWidth = texWidth;\n  }\n\n  if (dstHeight === undefined) {\n    dstHeight = texHeight;\n  }\n\n  gl.bindTexture(gl.TEXTURE_2D, tex);\n\n  // ...\n\n  // 从像素空间转换到裁剪空间\n  var projectionMatrix = m3.projection(canvas.width, canvas.height, 1);\n\n  // 缩放单位矩形的宽和高到 dstWidth, dstHeight 个单位长度\n  var scaleMatrix = m4.scaling(dstWidth, dstHeight, 1);\n\n  // 平移到 dstX, dstY\n  var translationMatrix = m4.translation(dstX, dstY, 0);\n\n  // 将矩阵乘起来\n  var matrix = m4.multiply(translationMatrix, scaleMatrix);\n  matrix = m4.multiply(projectionMatrix, matrix);\n\n  // 设置矩阵\n  gl.uniformMatrix4fv(matrixLocation, false, matrix);\n\n  // 告诉着色器使用纹理单元 0\n  gl.uniform1i(textureLocation, 0);\n\n  // 绘制矩形\n  gl.drawArrays(gl.TRIANGLES, 0, 6);\n}`, `2751921005761382000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{1-8,17-18}"\n              >\n                <span class="gatsby-code-button-language">js{1-8,17-18}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="gatsby-highlight-code-line"><span class="token keyword">function</span> <span class="token function">drawImage</span><span class="token punctuation">(</span><span class="token parameter">tex<span class="token punctuation">,</span> texWidth<span class="token punctuation">,</span> texHeight<span class="token punctuation">,</span> dstX<span class="token punctuation">,</span> dstY<span class="token punctuation">,</span> dstWidth<span class="token punctuation">,</span> dstHeight</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>dstWidth <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    dstWidth <span class="token operator">=</span> texWidth<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>dstHeight <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    dstHeight <span class="token operator">=</span> texHeight<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span></span>\n  gl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> tex<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// ...</span>\n\n  <span class="token comment">// 从像素空间转换到裁剪空间</span>\n  <span class="token keyword">var</span> projectionMatrix <span class="token operator">=</span> m3<span class="token punctuation">.</span><span class="token function">projection</span><span class="token punctuation">(</span>canvas<span class="token punctuation">.</span>width<span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>height<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line">  <span class="token comment">// 缩放单位矩形的宽和高到 dstWidth, dstHeight 个单位长度</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">var</span> scaleMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">scaling</span><span class="token punctuation">(</span>dstWidth<span class="token punctuation">,</span> dstHeight<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n  <span class="token comment">// 平移到 dstX, dstY</span>\n  <span class="token keyword">var</span> translationMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">translation</span><span class="token punctuation">(</span>dstX<span class="token punctuation">,</span> dstY<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 将矩阵乘起来</span>\n  <span class="token keyword">var</span> matrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>translationMatrix<span class="token punctuation">,</span> scaleMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  matrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>projectionMatrix<span class="token punctuation">,</span> matrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 设置矩阵</span>\n  gl<span class="token punctuation">.</span><span class="token function">uniformMatrix4fv</span><span class="token punctuation">(</span>matrixLocation<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> matrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 告诉着色器使用纹理单元 0</span>\n  gl<span class="token punctuation">.</span><span class="token function">uniform1i</span><span class="token punctuation">(</span>textureLocation<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 绘制矩形</span>\n  gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TRIANGLES</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我将代码修改为使用不同的大小</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/idjd75?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h2 id="drawimage-版本三"><a href="#drawimage-%E7%89%88%E6%9C%AC%E4%B8%89" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>drawImage 版本三</h2>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="12569804576342292000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`ctx.drawImage(image, srcX, srcY, srcWidth, srcHeight, dstX, dstY, dstWidth, dstHeight);`, `12569804576342292000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">ctx<span class="token punctuation">.</span><span class="token function">drawImage</span><span class="token punctuation">(</span>image<span class="token punctuation">,</span> srcX<span class="token punctuation">,</span> srcY<span class="token punctuation">,</span> srcWidth<span class="token punctuation">,</span> srcHeight<span class="token punctuation">,</span> dstX<span class="token punctuation">,</span> dstY<span class="token punctuation">,</span> dstWidth<span class="token punctuation">,</span> dstHeight<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>为了实现选择部分纹理，就需要操控纹理坐标。纹理坐标的工作原理在这篇文章中讲到，在那篇文章中我们手工创建纹理坐标，是一个非常常见的方式，但是我们也可以在运行时创建，然后使用矩阵简单的修改纹理坐标。</p>\n<p>让我们给顶点着色器添加一个纹理坐标矩阵，然后将纹理坐标和矩阵相乘。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="37876042411803510000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`attribute vec4 a_position;\nattribute vec2 a_texcoord;\n\nuniform mat4 u_matrix;\nuniform mat4 u_textureMatrix;\n\nvarying vec2 v_texcoord;\n\nvoid main() {\n   gl_Position = u_matrix * a_position;\n   v_texcoord = (u_textureMatrix * vec4(a_texcoord, 0, 1)).xy;\n}`, `37876042411803510000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl{5,11}"\n              >\n                <span class="gatsby-code-button-language">glsl{5,11}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">attribute</span> <span class="token keyword">vec4</span> a_position<span class="token punctuation">;</span>\n<span class="token keyword">attribute</span> <span class="token keyword">vec2</span> a_texcoord<span class="token punctuation">;</span>\n\n<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> u_matrix<span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">uniform</span> <span class="token keyword">mat4</span> u_textureMatrix<span class="token punctuation">;</span></span>\n<span class="token keyword">varying</span> <span class="token keyword">vec2</span> v_texcoord<span class="token punctuation">;</span>\n\n<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   gl_Position <span class="token operator">=</span> u_matrix <span class="token operator">*</span> a_position<span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line">   v_texcoord <span class="token operator">=</span> <span class="token punctuation">(</span>u_textureMatrix <span class="token operator">*</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>a_texcoord<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>xy<span class="token punctuation">;</span></span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在我们要找到纹理矩阵的位置</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="25294232384122760000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var matrixLocation = gl.getUniformLocation(program, \'u_matrix\');\nvar textureMatrixLocation = gl.getUniformLocation(program, \'u_textureMatrix\');`, `25294232384122760000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> matrixLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_matrix\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> textureMatrixLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_textureMatrix\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>在 drawImage 方法中需要设置它，用于选择我们需要的部分。我们知道纹理坐标是一个单位矩形所以可以简单的修改，就像对位置的处理一样。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="79475922049053380000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function drawImage(tex, texWidth, texHeight, srcX, srcY, srcWidth, srcHeight, dstX, dstY, dstWidth, dstHeight) {\n  if (dstX === undefined) {\n    dstX = srcX;\n    srcX = 0;\n  }\n\n  if (dstY === undefined) {\n    dstY = srcY;\n    srcY = 0;\n  }\n\n  if (srcWidth === undefined) {\n    srcWidth = texWidth;\n  }\n\n  if (srcHeight === undefined) {\n    srcHeight = texHeight;\n  }\n\n  if (dstWidth === undefined) {\n    dstWidth = srcWidth;\n    srcWidth = texWidth;\n  }\n\n  if (dstHeight === undefined) {\n    dstHeight = srcHeight;\n    srcHeight = texHeight;\n  }\n\n  gl.bindTexture(gl.TEXTURE_2D, tex);\n\n  // ...\n\n  // 从像素空间转换到裁剪空间\n  var projectionMatrix = m3.projection(canvas.width, canvas.height, 1);\n\n  // 缩放单位矩形的宽和高到 dstWidth, dstHeight 个单位长度\n  var scaleMatrix = m4.scaling(dstWidth, dstHeight, 1);\n\n  // 平移到 dstX, dstY\n  var translationMatrix = m4.translation(dstX, dstY, 0);\n\n  // 将矩阵乘起来\n  var matrix = m4.multiply(translationMatrix, scaleMatrix);\n  matrix = m4.multiply(projectionMatrix, matrix);\n\n  // 设置矩阵\n  gl.uniformMatrix4fv(matrixLocation, false, matrix);\n\n  // 因为纹理坐标的范围是 0 到 1\n  // 并且我们的纹理坐标是一个单位矩形\n  // 我们可以旋转平移矩形选择一部分纹理\n  var texMatrix = m4.translation(srcX / texWidth, srcY / texHeight, 0);\n  texMatrix = m4.scale(texMatrix, srcWidth / texWidth, srcHeight / texHeight, 1);\n\n  // 设置纹理矩阵\n  gl.uniformMatrix4fv(textureMatrixLocation, false, texMatrix);\n\n  // 告诉着色器使用纹理单元 0\n  gl.uniform1i(textureLocation, 0);\n\n  // 绘制矩形\n  gl.drawArrays(gl.TRIANGLES, 0, 6);\n}`, `79475922049053380000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{1-18,21-22,26-27,50-57}"\n              >\n                <span class="gatsby-code-button-language">js{1-18,21-22,26-27,50-57}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="gatsby-highlight-code-line"><span class="token keyword">function</span> <span class="token function">drawImage</span><span class="token punctuation">(</span><span class="token parameter">tex<span class="token punctuation">,</span> texWidth<span class="token punctuation">,</span> texHeight<span class="token punctuation">,</span> srcX<span class="token punctuation">,</span> srcY<span class="token punctuation">,</span> srcWidth<span class="token punctuation">,</span> srcHeight<span class="token punctuation">,</span> dstX<span class="token punctuation">,</span> dstY<span class="token punctuation">,</span> dstWidth<span class="token punctuation">,</span> dstHeight</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>dstX <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    dstX <span class="token operator">=</span> srcX<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    srcX <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>dstY <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    dstY <span class="token operator">=</span> srcY<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    srcY <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>srcWidth <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    srcWidth <span class="token operator">=</span> texWidth<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>srcHeight <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    srcHeight <span class="token operator">=</span> texHeight<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span></span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>dstWidth <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n<span class="gatsby-highlight-code-line">    dstWidth <span class="token operator">=</span> srcWidth<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    srcWidth <span class="token operator">=</span> texWidth<span class="token punctuation">;</span></span>  <span class="token punctuation">}</span>\n\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>dstHeight <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n<span class="gatsby-highlight-code-line">    dstHeight <span class="token operator">=</span> srcHeight<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    srcHeight <span class="token operator">=</span> texHeight<span class="token punctuation">;</span></span>  <span class="token punctuation">}</span>\n\n  gl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> tex<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// ...</span>\n\n  <span class="token comment">// 从像素空间转换到裁剪空间</span>\n  <span class="token keyword">var</span> projectionMatrix <span class="token operator">=</span> m3<span class="token punctuation">.</span><span class="token function">projection</span><span class="token punctuation">(</span>canvas<span class="token punctuation">.</span>width<span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>height<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 缩放单位矩形的宽和高到 dstWidth, dstHeight 个单位长度</span>\n  <span class="token keyword">var</span> scaleMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">scaling</span><span class="token punctuation">(</span>dstWidth<span class="token punctuation">,</span> dstHeight<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 平移到 dstX, dstY</span>\n  <span class="token keyword">var</span> translationMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">translation</span><span class="token punctuation">(</span>dstX<span class="token punctuation">,</span> dstY<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 将矩阵乘起来</span>\n  <span class="token keyword">var</span> matrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>translationMatrix<span class="token punctuation">,</span> scaleMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  matrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>projectionMatrix<span class="token punctuation">,</span> matrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 设置矩阵</span>\n  gl<span class="token punctuation">.</span><span class="token function">uniformMatrix4fv</span><span class="token punctuation">(</span>matrixLocation<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> matrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line">  <span class="token comment">// 因为纹理坐标的范围是 0 到 1</span></span><span class="gatsby-highlight-code-line">  <span class="token comment">// 并且我们的纹理坐标是一个单位矩形</span></span><span class="gatsby-highlight-code-line">  <span class="token comment">// 我们可以旋转平移矩形选择一部分纹理</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">var</span> texMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">translation</span><span class="token punctuation">(</span>srcX <span class="token operator">/</span> texWidth<span class="token punctuation">,</span> srcY <span class="token operator">/</span> texHeight<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  texMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">scale</span><span class="token punctuation">(</span>texMatrix<span class="token punctuation">,</span> srcWidth <span class="token operator">/</span> texWidth<span class="token punctuation">,</span> srcHeight <span class="token operator">/</span> texHeight<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line">  <span class="token comment">// 设置纹理矩阵</span></span><span class="gatsby-highlight-code-line">  gl<span class="token punctuation">.</span><span class="token function">uniformMatrix4fv</span><span class="token punctuation">(</span>textureMatrixLocation<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> texMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n  <span class="token comment">// 告诉着色器使用纹理单元 0</span>\n  gl<span class="token punctuation">.</span><span class="token function">uniform1i</span><span class="token punctuation">(</span>textureLocation<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 绘制矩形</span>\n  gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TRIANGLES</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我也上传了这个版本的例子，这是结果</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/50p8z5?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>不同于画布的二维接口，WebGL 对 drawImage 的情况做了更多的处理。</p>\n<p>一个是我们可以给源或者目标宽高传递负值，负的 srcWidth 会选择 srcX 左边的像素，负的 dstWidth 会将图像绘制在 dstX 的左边，在画布的二维接口中报错是好一点的情况，坏一点时会出现 udefined。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/ytbfsj?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>另一个是我们使用矩阵就可以实现任何矩阵运算可以实现的效果。</p>\n<p>例如绕纹理中心旋转纹理坐标。</p>\n<p>修改纹理坐标的矩阵代码</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="81391409183493370000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 像二维投影矩阵那样将坐标从纹理空间转换到像素空间\nvar texMatrix = m4.scaling(1 / texWidth, 1 / texHeight, 1);\n\n// 选择一个旋转中心\n// 移动到中心旋转后在回来\nvar texMatrix = m4.translate(texMatrix, texWidth * 0.5, texHeight * 0.5, 0);\nvar texMatrix = m4.zRotate(texMatrix, srcRotation);\nvar texMatrix = m4.translate(texMatrix, texWidth * -0.5, texHeight * -0.5, 0);\n\n// 因为在像素空间，缩放和平移现在是按像素单位\nvar texMatrix = m4.translate(texMatrix, srcX, srcY, 0);\nvar texMatrix = m4.scale(texMatrix, srcWidth, srcHeight, 1);\n\n// 设置纹理矩阵\ngl.uniformMatrix4fv(textureMatrixLocation, false, texMatrix);`, `81391409183493370000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{1-12}"\n              >\n                <span class="gatsby-code-button-language">js{1-12}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="gatsby-highlight-code-line"><span class="token comment">// 像二维投影矩阵那样将坐标从纹理空间转换到像素空间</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">var</span> texMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">scaling</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">/</span> texWidth<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token operator">/</span> texHeight<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line"><span class="token comment">// 选择一个旋转中心</span></span><span class="gatsby-highlight-code-line"><span class="token comment">// 移动到中心旋转后在回来</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">var</span> texMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">translate</span><span class="token punctuation">(</span>texMatrix<span class="token punctuation">,</span> texWidth <span class="token operator">*</span> <span class="token number">0.5</span><span class="token punctuation">,</span> texHeight <span class="token operator">*</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">var</span> texMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">zRotate</span><span class="token punctuation">(</span>texMatrix<span class="token punctuation">,</span> srcRotation<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">var</span> texMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">translate</span><span class="token punctuation">(</span>texMatrix<span class="token punctuation">,</span> texWidth <span class="token operator">*</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> texHeight <span class="token operator">*</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line"><span class="token comment">// 因为在像素空间，缩放和平移现在是按像素单位</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">var</span> texMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">translate</span><span class="token punctuation">(</span>texMatrix<span class="token punctuation">,</span> srcX<span class="token punctuation">,</span> srcY<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">var</span> texMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">scale</span><span class="token punctuation">(</span>texMatrix<span class="token punctuation">,</span> srcWidth<span class="token punctuation">,</span> srcHeight<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="token comment">// 设置纹理矩阵</span>\ngl<span class="token punctuation">.</span><span class="token function">uniformMatrix4fv</span><span class="token punctuation">(</span>textureMatrixLocation<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> texMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/fs0bbt?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>可以看出一个问题，在旋转的过程中会看到超出边缘的纹理，由于设置的是 <code class="language-text">CLAMP_TO_EDGE</code> 所以得到重复的边缘。</p>\n<p>我们可以在着色器中丢弃超出 0 到 1 范围的纹理，discard 将会立即退出着色器，不写入像素。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="46551234149612110000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`precision mediump float;\n\nvarying vec2 v_texcoord;\n\nuniform sampler2D texture;\n\nvoid main() {\n   if (v_texcoord.x < 0.0 ||\n       v_texcoord.y < 0.0 ||\n       v_texcoord.x > 1.0 ||\n       v_texcoord.y > 1.0) {\n     discard;\n   }\n\n   gl_FragColor = texture2D(texture, v_texcoord);\n}`, `46551234149612110000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl{8-13}"\n              >\n                <span class="gatsby-code-button-language">glsl{8-13}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">precision</span> <span class="token keyword">mediump</span> <span class="token keyword">float</span><span class="token punctuation">;</span>\n\n<span class="token keyword">varying</span> <span class="token keyword">vec2</span> v_texcoord<span class="token punctuation">;</span>\n\n<span class="token keyword">uniform</span> <span class="token keyword">sampler2D</span> texture<span class="token punctuation">;</span>\n\n<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n<span class="gatsby-highlight-code-line">   <span class="token keyword">if</span> <span class="token punctuation">(</span>v_texcoord<span class="token punctuation">.</span>x <span class="token operator">&lt;</span> <span class="token number">0.0</span> <span class="token operator">||</span></span><span class="gatsby-highlight-code-line">       v_texcoord<span class="token punctuation">.</span>y <span class="token operator">&lt;</span> <span class="token number">0.0</span> <span class="token operator">||</span></span><span class="gatsby-highlight-code-line">       v_texcoord<span class="token punctuation">.</span>x <span class="token operator">></span> <span class="token number">1.0</span> <span class="token operator">||</span></span><span class="gatsby-highlight-code-line">       v_texcoord<span class="token punctuation">.</span>y <span class="token operator">></span> <span class="token number">1.0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">     <span class="token keyword">discard</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">   <span class="token punctuation">}</span></span>\n   gl_FragColor <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>texture<span class="token punctuation">,</span> v_texcoord<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在边缘消失了</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/vf56m7?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>或者你想的话也可以对超出的部分使用纯色</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="62006629553565020000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`precision mediump float;\n\nvarying vec2 v_texcoord;\n\nuniform sampler2D texture;\n\nvoid main() {\n   if (v_texcoord.x < 0.0 ||\n       v_texcoord.y < 0.0 ||\n       v_texcoord.x > 1.0 ||\n       v_texcoord.y > 1.0) {\n     gl_FragColor = vec4(0, 0, 1, 1); // 蓝色\n     return;\n   }\n\n   gl_FragColor = texture2D(texture, v_texcoord);\n}`, `62006629553565020000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl{12-13}"\n              >\n                <span class="gatsby-code-button-language">glsl{12-13}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">precision</span> <span class="token keyword">mediump</span> <span class="token keyword">float</span><span class="token punctuation">;</span>\n\n<span class="token keyword">varying</span> <span class="token keyword">vec2</span> v_texcoord<span class="token punctuation">;</span>\n\n<span class="token keyword">uniform</span> <span class="token keyword">sampler2D</span> texture<span class="token punctuation">;</span>\n\n<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>v_texcoord<span class="token punctuation">.</span>x <span class="token operator">&lt;</span> <span class="token number">0.0</span> <span class="token operator">||</span>\n       v_texcoord<span class="token punctuation">.</span>y <span class="token operator">&lt;</span> <span class="token number">0.0</span> <span class="token operator">||</span>\n       v_texcoord<span class="token punctuation">.</span>x <span class="token operator">></span> <span class="token number">1.0</span> <span class="token operator">||</span>\n       v_texcoord<span class="token punctuation">.</span>y <span class="token operator">></span> <span class="token number">1.0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n<span class="gatsby-highlight-code-line">     gl_FragColor <span class="token operator">=</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 蓝色</span></span><span class="gatsby-highlight-code-line">     <span class="token keyword">return</span><span class="token punctuation">;</span></span>   <span class="token punctuation">}</span>\n\n   gl_FragColor <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>texture<span class="token punctuation">,</span> v_texcoord<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/pd6src?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>接下来讲实现画布二维接口中的矩阵栈。</p>\n<h2 id="一个小优化"><a href="#%E4%B8%80%E4%B8%AA%E5%B0%8F%E4%BC%98%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>一个小优化</h2>\n<p>我并不是要建议使用这个优化，而是想提出更多创意性的想法，因为使用 WebGL 就是利用它提供的特性去做创意。</p>\n<p>你可能会注意到我们使用的位置单位矩形和纹理坐标刚好匹配，所以我们就可以使用位置作为纹理坐标。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="12015879228049365000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`attribute vec4 a_position;\n// attribute vec2 a_texcoord;\n\nuniform mat4 u_matrix;\nuniform mat4 u_textureMatrix;\n\nvarying vec2 v_texcoord;\n\nvoid main() {\n   gl_Position = u_matrix * a_position;\n   v_texcoord = (u_textureMatrix * a_position).xy;\n}`, `12015879228049365000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl{11}"\n              >\n                <span class="gatsby-code-button-language">glsl{11}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">attribute</span> <span class="token keyword">vec4</span> a_position<span class="token punctuation">;</span>\n<span class="token comment">// attribute vec2 a_texcoord;</span>\n\n<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> u_matrix<span class="token punctuation">;</span>\n<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> u_textureMatrix<span class="token punctuation">;</span>\n\n<span class="token keyword">varying</span> <span class="token keyword">vec2</span> v_texcoord<span class="token punctuation">;</span>\n\n<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   gl_Position <span class="token operator">=</span> u_matrix <span class="token operator">*</span> a_position<span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line">   v_texcoord <span class="token operator">=</span> <span class="token punctuation">(</span>u_textureMatrix <span class="token operator">*</span> a_position<span class="token punctuation">)</span><span class="token punctuation">.</span>xy<span class="token punctuation">;</span></span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在移除关于纹理坐标设置的代码，得到的结果和之前是相同的。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/n0b4pe?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>// TODO <a href="https://webglfundamentals.org/webgl/lessons/zh_cn/webgl-2d-matrix-stack.html" target="_blank" rel="nofollow noreferrer noopener">https://webglfundamentals.org/webgl/lessons/zh_cn/webgl-2d-matrix-stack.html</a></p>',
excerpt:"WebGL…",frontmatter:{date:"2022-08-05 18:45:42",path:"/webgl-fundamental-2d/",tags:"前端, 可视化, WebGL, 读书笔记",title:"WebGL 理论基础——二维",draft:null}}},pathContext:{mainPostPath:"/webgl-fundamental-textures/",nextPostPath:"/docker-introduce-learning/",prePostPath:"/webgl-fundamental-2d/"}}}});