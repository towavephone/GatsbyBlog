webpackJsonp([0x7b49c2290b7e],{1427:function(n,a){n.exports={data:{file:{childImageSharp:{sizes:{base64:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAeCAYAAAAsEj5rAAAACXBIWXMAAAsSAAALEgHS3X78AAAHlElEQVRIx12We2xT5xXAbcI2Vmn7o1I1uhVYRxL8tuPn9bXv0+/4/YgdOyYkkATCCEEYsqVNC2wCIYQWShmUBFh4hMAWECot0BUtlI4yAS1oKqJQXimsDBgTU8codnLO7r0uUPpJn87Rp+/8vvOdc75zr8xmZmTieI1NykU5yxOfxDncz3NUjAlyDXMjXGMhys+cG+FzGQ8VU4t7XuV8z8m+GUkrJclSqVReYJ0ZWQ8Tl2AdTPhnq9ns2QKd+crDZiHha8NsYCE21HZiXphpb3sxxTf99Tdsw51ldHqFaLOXXyzvYqOyZ0YPk5soylfouuUbvHOxh56JbiqJfi4/FnE1lxKetrGUZ954nbcdU/752ORpxWVsc6mZjPxctFtApeVtra1lmIPwTxClgeCqvGTsX/WWOEbtyTGWSoGbToOPzUHQ1QghVxOEhRniZ5U8XB4TzvTdgj1ZJdq2OOrkGhVRBnrYFum6TiK0l2fr0emMlVxcBhlnEniqDjlBuqg0CnD0MPWiDrwzhR4u+5B3x3WiLUNHJjxzZYvR8ZKTCP+Xo1JoM/nBYvSB1egHuyUIrCOBPj4LtD0KlD2K4h7SGip62aygxzaK9rHA3Aqt2vw0MRYjnyJtYaQdsXG9hgWFwgmVlXZUKUjUqmm0CgfwhA80Kgr1Wg40Sue4SuFEnZq+YjMbJ0kh0zmfemjQ0j2EJYh2a23RVOODIBvHmCsBUaoWLDoWKIsP50bTApxC5QwH1Ghp0Gk4MBk8aDLQEslooCc88VClsK+zGANI2mqLer0XFuea8PSuN+DM7o3QWyhAR7IBfj+vDbyOICS9aSjkZo8nvSlUKuxXLDUOKdN6LSl/AlRUE+vNAnD50l8XeTIEPiYEzXYG5mlNeGz7BvjPpY/g5snDcHxwE+zs7oCh1zvHCrNm48u/ML8j2muVQblBZ3t6ZY2KXKtQcDiwdk1xx9rV0BlqghEuD4fNUTy1Zwhw7Cbioxu461fdsOgFDa5pbh3zu6NifE9f+XCPlGHS5nuaFI3K8brJ4EUHES4WFiyEP2/dCPc2vYH/3NIHePcywP1LWLp3Ec4tWQa3FvbAu7294yqVA801rju5utYfiQyKDD4DnC8GWEhMafJPtBALxuHjo3+C8bufIn59DfHBFcDiDcQvzyF+/iEsbWuDadNMaDW5H7nY6Iyyh165zfLNtdUqIqLTsEJSQqBVUTD1JQPqdRT8sf9NuH7kMHy0fRg+O3EUzp96H/Zs2SBklxFKxwFmowtdTCIoPQx7oKLzl32PPTRPVSudDwQgCrUGL0+twdzsDjjSdwD2J1fh/q7N0N+1EtykB178qVY4lAahRktWkw95JrG4DAxPvHU3Wwb+rlcsHfK0WNxCoMdUCgdUaxnMBPKw7dVe2LyhDw4MboORA4NQOd2CaiUFaqWjZJGAyQGRUeubP8FqElqZspquEBeUM2zrnEQUa3R8USVcp2qGDZV6ErqXL4PfrlwFhSU9cPL4MejfshOsZq90sCg5KvHZ5MnPfa+cmFrxukRFuRZNcYqIoNngHheeFmiF11ClIDBdPwfqG9qhc1E3rF25GnrX90M204JqBfWItPrP8lTqa7vFpSw3GJ9cZjI4pW5TXaWezpKxh4Q5gEY9LwApVOtZMApxVWhd2DKvC7K5FjTUsFCj45Ah4yXaHuz1MBlgyHCb1HXISIXMTcekOJqN1h/72Mx92h5DwuwHjeChWseBQsNgJJ6H944eB5oNgaLajnaL/07E24wuKr7Cz+XuuenUsMioCxYmyHhnSPLQTYVVYVfjI46Mo80WBLMgLY4E1FhCOENBAsfHQG/0juuNPqGguU8ywXas5XNbg6783wJ8w781GtUPJc+irkap/Ufdje0JXytStnDJbA2D1Z4EKxEHsyUMRmsIdcZaNFpCYBYqwWQLPhD3Btn6t2Pe5uF0cD7Sdr/xmSab8racFaDooOvuk0wDEs40EFQGbVQGbEKXJoTPgZ3JoJGIgULvR6M1jE67rzvpae5ojC7GEJ9rfgILc7lC3NV0T6flTtjoPLK+VuD8rcD65gDtaQInPxOtzoxQRrXgD8/BdW/+YezYByfxvfdHvnxl+ZLKCDfzUMIze60Ey+brJukrqcjA1u3tBw8dfZiZuRQFaNFory/WEPUlE5kFK5WDQKRtbFPfUOnChUvFL27cwKuj/8CBHXv2iQw/k/KGuNwyCYiIkhw+sO/569eu7b1+ffR/H5z4BAcG38X1m/biyjX9ODR8GC9dHsXLV0fx5KlzePDIyFd7ht9ZJZhJrcvLhV/wMuUPljQWtC6Z+FjfuWPHlPMXLq64Onpz3d8/Pf9WX//OW2vWbITBof3n3tqya9fbh/7SvW1gZ9Xj/V1dr8kf614qIZONjBwrezi8Ty54K5d9ZzTmF+xe1LnioaD+4Nvrn4/ermif3yHp8UCDLMCky7Z+n192+/YdST9z5mPZ7t1D8ouXv6gQ4S9WTplks7mut8xZijxbKz2vvi2D39/cPyB/HC5xOm2czPvd35F8rkGCS0+I4WXV1QbJaMq06XqbNXCQJIILpH8hOic3GghZMpl62qG/Nf4PRzaQ862MzO4AAAAASUVORK5CYII=",aspectRatio:.6666666666666666,src:"/static/avatar-dc7bc85837bf005ae32d2a37dfdfa8a2-25c91.png",srcSet:"/static/avatar-dc7bc85837bf005ae32d2a37dfdfa8a2-8a97b.png 200w,\n/static/avatar-dc7bc85837bf005ae32d2a37dfdfa8a2-0fdf3.png 400w,\n/static/avatar-dc7bc85837bf005ae32d2a37dfdfa8a2-25c91.png 600w",srcWebp:"/static/avatar-dc7bc85837bf005ae32d2a37dfdfa8a2-216f6.webp",srcSetWebp:"/static/avatar-dc7bc85837bf005ae32d2a37dfdfa8a2-5d70e.webp 200w,\n/static/avatar-dc7bc85837bf005ae32d2a37dfdfa8a2-d1677.webp 400w,\n/static/avatar-dc7bc85837bf005ae32d2a37dfdfa8a2-216f6.webp 600w",sizes:"(max-width: 600px) 100vw, 600px"}}},site:{siteMetadata:{title:"女王控的博客",description:'前端工程师，黑猫女王控，欢迎勾搭，技术相关<a href="https://github.com/towavephone" target="_blank">@towavephone</a>，QQ闲聊<a href="tencent://AddContact/?fromId=45&fromSubId=1&subcmd=all&uin=634407147&website=www.oicqzone.com">@towave</a>，bili关注<a href="https://space.bilibili.com/11507708#/" target="_blank">@towave</a>',siteUrl:"https://blog.towavephone.com"}},mainPost:{html:'<h1 id="高并发架构"><a href="#%E9%AB%98%E5%B9%B6%E5%8F%91%E6%9E%B6%E6%9E%84" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>高并发架构</h1>\n<h2 id="消息队列"><a href="#%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>消息队列</h2>\n<h3 id="为什么使用消息队列？"><a href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BD%BF%E7%94%A8%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>为什么使用消息队列？</h3>\n<h4 id="优点"><a href="#%E4%BC%98%E7%82%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>优点</h4>\n<ol>\n<li>解耦：通过一个 MQ，Pub/Sub 发布订阅消息这么一个模型，A 系统就跟其它系统彻底解耦了。</li>\n<li>异步：任务发到消息队列，由消费者异步消费</li>\n<li>削峰：任务发到消息队列，由消费者决定消费速度</li>\n</ol>\n<h4 id="缺点"><a href="#%E7%BC%BA%E7%82%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>缺点</h4>\n<ol>\n<li>系统可用性降低：MQ 挂了如何处理？即如何保证消息队列的高可用？</li>\n<li>系统复杂度提高：怎么保证消息没有重复消费？怎么处理消息丢失的情况？怎么保证消息传递的顺序性？</li>\n<li>一致性问题：A 系统处理完直接返回成功，发到消息队列后供 B、C、D 消费，如果 B、D 成功、C 失败怎么处理？</li>\n</ol>\n<h4 id="kafka、activemq、rabbitmq、rocketmq-有什么优缺点？"><a href="#kafka%E3%80%81activemq%E3%80%81rabbitmq%E3%80%81rocketmq-%E6%9C%89%E4%BB%80%E4%B9%88%E4%BC%98%E7%BC%BA%E7%82%B9%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Kafka、ActiveMQ、RabbitMQ、RocketMQ 有什么优缺点？</h4>\n<table>\n<thead>\n<tr>\n<th>特性</th>\n<th>ActiveMQ</th>\n<th>RabbitMQ</th>\n<th>RocketMQ</th>\n<th>Kafka</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>单机吞吐量</td>\n<td>万级，比 RocketMQ、Kafka 低一个数量级</td>\n<td>同 ActiveMQ</td>\n<td>10 万级，支撑高吞吐</td>\n<td>10 万级，高吞吐，一般配合大数据类的系统来进行实时数据计算、日志采集等场景</td>\n</tr>\n<tr>\n<td>topic 数量对吞吐量的影响</td>\n<td></td>\n<td></td>\n<td>topic 可以达到几百/几千的级别，吞吐量会有较小幅度的下降，这是 RocketMQ 的一大优势，在同等机器下，可以支撑大量的 topic</td>\n<td>topic 从几十到几百个时候，吞吐量会大幅度下降，在同等机器下，Kafka 尽量保证 topic 数量不要过多，如果要支撑大规模的 topic，需要增加更多的机器资源</td>\n</tr>\n<tr>\n<td>时效性</td>\n<td>ms 级</td>\n<td>微秒级，这是 RabbitMQ 的一大特点，延迟最低</td>\n<td>ms 级</td>\n<td>延迟在 ms 级以内</td>\n</tr>\n<tr>\n<td>可用性</td>\n<td>高，基于主从架构实现高可用</td>\n<td>同 ActiveMQ</td>\n<td>非常高，分布式架构</td>\n<td>非常高，分布式，一个数据多个副本，少数机器宕机，不会丢失数据，不会导致不可用</td>\n</tr>\n<tr>\n<td>消息可靠性</td>\n<td>有较低的概率丢失数据</td>\n<td>基本不丢</td>\n<td>经过参数优化配置，可以做到 0 丢失</td>\n<td>同 RocketMQ</td>\n</tr>\n<tr>\n<td>功能支持</td>\n<td>MQ 领域的功能极其完备</td>\n<td>基于 erlang 开发，并发能力很强，性能极好，延时很低</td>\n<td>MQ 功能较为完善，还是分布式的，扩展性好</td>\n<td>功能较为简单，主要支持简单的 MQ 功能，在大数据领域的实时计算以及日志采集被大规模使用</td>\n</tr>\n</tbody>\n</table>\n<p>综上，各种对比之后，有如下建议：</p>\n<p>一般的业务系统要引入 MQ，最早大家都用 ActiveMQ，但是现在确实大家用的不多了，没经过大规模吞吐量场景的验证，社区也不是很活跃，所以大家还是算了吧，我个人不推荐用这个了。</p>\n<p>后来大家开始用 RabbitMQ，但是确实 erlang 语言阻止了大量的 Java 工程师去深入研究和掌控它，对公司而言，几乎处于不可控的状态，但是确实人家是开源的，比较稳定的支持，活跃度也高。</p>\n<p>不过现在确实越来越多的公司会去用 RocketMQ，确实很不错，毕竟是阿里出品，但社区可能有突然黄掉的风险（目前 RocketMQ 已捐给 <a href="https://github.com/apache/rocketmq" target="_blank" rel="nofollow noreferrer noopener">Apache</a>，但 GitHub 上的活跃度其实不算高）对自己公司技术实力有绝对自信的，推荐用 RocketMQ，否则回去老老实实用 RabbitMQ 吧，人家有活跃的开源社区，绝对不会黄。</p>\n<p>所以<strong>中小型公司</strong>，技术实力较为一般，技术挑战不是特别高，用 RabbitMQ 是不错的选择；<strong>大型公司</strong>，基础架构研发实力较强，用 RocketMQ 是很好的选择。</p>\n<p>如果是<strong>大数据领域</strong>的实时计算、日志采集等场景，用 Kafka 是业内标准的，绝对没问题，社区活跃度很高，绝对不会黄，何况几乎是全世界这个领域的事实性规范。</p>\n<h3 id="如何保证消息队列的高可用？"><a href="#%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>如何保证消息队列的高可用？</h3>\n<h4 id="rabbitmq-的高可用性"><a href="#rabbitmq-%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8%E6%80%A7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>RabbitMQ 的高可用性</h4>\n<p>RabbitMQ 是比较有代表性的，因为是基于主从（非分布式）做高可用性的，RabbitMQ 有三种模式：单机模式、普通集群模式、镜像集群模式。</p>\n<h5 id="单机模式"><a href="#%E5%8D%95%E6%9C%BA%E6%A8%A1%E5%BC%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>单机模式</h5>\n<p>单机模式，就是 Demo 级别的，一般就是你本地启动了玩玩儿的，没人生产用单机模式。</p>\n<h5 id="普通集群模式（无高可用性）"><a href="#%E6%99%AE%E9%80%9A%E9%9B%86%E7%BE%A4%E6%A8%A1%E5%BC%8F%EF%BC%88%E6%97%A0%E9%AB%98%E5%8F%AF%E7%94%A8%E6%80%A7%EF%BC%89" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>普通集群模式（无高可用性）</h5>\n<p>普通集群模式，意思就是在多台机器上启动多个 RabbitMQ 实例，每台机器启动一个。你创建的 queue，只会放在一个 RabbitMQ 实例上，但是每个实例都同步 queue 的元数据（元数据可以认为是 queue 的一些配置信息，通过元数据，可以找到 queue 所在实例）。你消费的时候，实际上如果连接到了另外一个实例，那么那个实例会从 queue 所在实例上拉取数据过来。</p>\n<p>缺点如下：</p>\n<ol>\n<li>没做到分布式，就是个普通的集群：因为这导致你要么消费者每次随机连接一个实例然后拉取数据，要么固定连接那个 queue 所在实例消费数据，前者有数据拉取的开销，后者导致单实例性能瓶颈。</li>\n<li>可用性无保障：如果那个放 queue 的实例宕机了，会导致接下来其他实例就无法从那个实例拉取，如果你开启了消息持久化，让 RabbitMQ 落地存储消息的话，消息不一定会丢，得等这个实例恢复了，然后才可以继续从这个 queue 拉取数据</li>\n</ol>\n<p>唯一的好处就是提高在集群中多个节点服务某个 queue 的读写操作</p>\n<h5 id="镜像集群模式（高可用性）"><a href="#%E9%95%9C%E5%83%8F%E9%9B%86%E7%BE%A4%E6%A8%A1%E5%BC%8F%EF%BC%88%E9%AB%98%E5%8F%AF%E7%94%A8%E6%80%A7%EF%BC%89" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>镜像集群模式（高可用性）</h5>\n<p>这种模式，才是所谓的 RabbitMQ 的高可用模式。跟普通集群模式不一样的是，在镜像集群模式下，你创建的 queue，无论是元数据还是 queue 里的消息都会存在于多个实例上，就是说，每个 RabbitMQ 节点都有这个 queue 的一个完整镜像，包含 queue 的全部数据的意思。然后每次你写消息到 queue 的时候，都会自动把消息同步到多个实例的 queue 上。</p>\n<p>开启这个模式的方法：管理控制台新增镜像集群模式的策略，指定的时候是可以要求数据同步到所有节点，也可以要求同步到指定数量的节点，再次创建 queue 的时候，应用这个策略，就会自动将数据同步到其他的节点上去了。</p>\n<p>优点如下：</p>\n<ol>\n<li>可用性相对较高：你任何一个机器宕机了，没事儿，其它机器（节点）还包含了这个 queue 的完整数据，别的 consumer 都可以到其它节点上去消费数据。</li>\n</ol>\n<p>缺点如下：</p>\n<ol>\n<li>性能开销大：消息需要同步到所有机器上，导致网络带宽压力和消耗很重</li>\n<li>非分布式的，就没有扩展性可言：如果某个 queue 负载很重，你加机器，新增的机器也包含了这个 queue 的所有数据，并没有办法线性扩展你的 queue。你想，如果这个 queue 的数据量很大，大到这个机器上的容量无法容纳了，此时该怎么办呢？</li>\n</ol>\n<h4 id="kafka-的高可用性"><a href="#kafka-%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8%E6%80%A7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Kafka 的高可用性</h4>\n<p>基本架构：由多个 broker 组成，每个 broker 是一个节点；你创建一个 topic，这个 topic 可以划分为多个 partition，每个 partition 可以存在于不同的 broker 上，每个 partition 就放一部分数据。</p>\n<p>这就是天然的分布式消息队列，就是说一个 topic 的数据，是分散放在多个机器上的，每个机器就放一部分数据。</p>\n<p>实际上 RabbitMQ 之类的，并不是分布式消息队列，它就是传统的消息队列，只不过提供了一些集群、HA（High Availability, 高可用性） 的机制而已，因为无论怎么玩儿，RabbitMQ 一个 queue 的数据都是放在一个节点里的，镜像集群模式下，也是每个节点都放这个 queue 的完整数据。</p>\n<p>Kafka 0.8 以前，是没有 HA 机制的，就是任何一个 broker 宕机了，那个 broker 上的 partition 就废了，没法写也没法读，没有什么高可用性可言。</p>\n<p>比如说，我们假设创建了一个 topic，指定其 partition 数量是 3 个，分别在三台机器上。但是，如果第二台机器宕机了，会导致这个 topic 的 1/3 的数据就丢了，因此这个是做不到高可用的。</p>\n<p>Kafka 0.8 以后，提供了 HA 机制，就是 replica（复制品） 副本机制。每个 partition 的数据都会同步到其它机器上，形成自己的多个 replica 副本。所有 replica 会选举一个 leader 出来，那么生产和消费都跟这个 leader 打交道，然后其他 replica 就是 follower。写的时候，leader 会负责把数据同步到所有 follower 上去，读的时候就直接读 leader 上的数据即可。只能读写 leader？很简单，要是你可以随意读写每个 follower，那么就要关心数据一致性的问题，系统复杂度太高，很容易出问题。Kafka 会均匀地将一个 partition 的所有 replica 分布在不同的机器上，这样才可以提高容错性。</p>\n<p>这么搞，就有所谓的高可用性了，因为如果某个 broker 宕机了，没事儿，那个 broker 上面的 partition 在其他机器上都有副本的。如果这个宕机的 broker 上面有某个 partition 的 leader，那么此时会从 follower 中重新选举一个新的 leader 出来，大家继续读写那个新的 leader 即可。这就有所谓的高可用性了。</p>\n<p>写数据的时候，生产者就写 leader，然后 leader 将数据落地写本地磁盘，接着其他 follower 自己主动从 leader 来 pull 数据。一旦所有 follower 同步好数据了，就会发送 ack 给 leader，leader 收到所有 follower 的 ack 之后，就会返回写成功的消息给生产者。（当然，这只是其中一种模式，还可以适当调整这个行为）</p>\n<p>消费的时候，只会从 leader 去读，但是只有当一个消息已经被所有 follower 都同步成功返回 ack 的时候，这个消息才会被消费者读到。</p>\n<h3 id="如何保证消息不被重复消费？"><a href="#%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%E6%B6%88%E6%81%AF%E4%B8%8D%E8%A2%AB%E9%87%8D%E5%A4%8D%E6%B6%88%E8%B4%B9%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>如何保证消息不被重复消费？</h3>\n<h4 id="背景"><a href="#%E8%83%8C%E6%99%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>背景</h4>\n<p>首先，比如 RabbitMQ、RocketMQ、Kafka，都有可能会出现消息重复消费的问题，正常。因为这问题通常不是 MQ 自己保证的，是由我们开发来保证的。挑一个 Kafka 来举个例子，说说怎么重复消费吧。</p>\n<p>Kafka 实际上有个 offset 的概念，就是每个消息写进去，都有一个 offset，代表消息的序号，然后 consumer 消费了数据之后，每隔一段时间（定时定期），会把自己消费过的消息的 offset 提交一下，表示“我已经消费过了，下次我要是重启啥的，你就让我继续从上次消费到的 offset 来继续消费吧”。</p>\n<p>但是凡事总有意外，比如我们之前生产经常遇到的，就是你有时候重启系统，看你怎么重启了，如果碰到点着急的，直接 kill 进程了，再重启。这会导致 consumer 有些消息处理了，但是没来得及提交 offset，尴尬了。重启之后，少数消息会再次消费一次。</p>\n<p>有这么个场景。数据 1/2/3 依次进入 Kafka，Kafka 会给这三条数据每条分配一个 offset，代表这条数据的序号，我们就假设分配的 offset 依次是 152/153/154。消费者从 Kafka 去消费的时候，也是按照这个顺序去消费。假如当消费者消费了 offset=153 的这条数据，刚准备去提交 offset 到 Zookeeper，此时消费者进程被重启了。那么此时消费过的数据 1/2 的 offset 并没有提交，Kafka 也就不知道你已经消费了 offset=153 这条数据。那么重启之后，消费者会找 Kafka 说，嘿，哥儿们，你给我接着把上次我消费到的那个地方后面的数据继续给我传递过来。由于之前的 offset 没有提交成功，那么数据 1/2 会再次传过来，如果此时消费者没有去重的话，那么就会导致重复消费。</p>\n<p>如果消费者干的事儿是拿一条数据就往数据库里写一条，会导致说，你可能就把数据 1/2 在数据库里插入了 2 次，那么数据就错啦。</p>\n<h4 id="解决方案"><a href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>解决方案</h4>\n<p>需要保证重复消费的幂等性，需要结合具体场景</p>\n<ol>\n<li>比如你拿个数据要写库，你先根据主键查一下，如果这数据都有了，你就别插入了，update 一下好吧。</li>\n<li>比如你是写 Redis，那没问题了，反正每次都是 set，天然幂等性。</li>\n<li>比如你不是上面两个场景，那做的稍微复杂一点，你需要让生产者发送每条数据的时候，里面加一个全局唯一的 id，类似订单 id 之类的东西，然后你这里消费到了之后，先根据这个 id 去比如 Redis 里查一下，之前消费过吗？如果没有消费过，你就处理，然后这个 id 写 Redis。如果消费过了，那你就别处理了，保证别重复处理相同的消息即可。</li>\n<li>比如基于数据库的唯一键来保证重复数据不会重复插入多条。因为有唯一键约束了，重复数据插入只会报错，不会导致数据库中出现脏数据。</li>\n</ol>\n<h3 id="如何保证消息的可靠性传输？"><a href="#%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%E6%B6%88%E6%81%AF%E7%9A%84%E5%8F%AF%E9%9D%A0%E6%80%A7%E4%BC%A0%E8%BE%93%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>如何保证消息的可靠性传输？</h3>\n<p>数据的丢失问题，可能出现在生产者、MQ、消费者中，咱们从 RabbitMQ 和 Kafka 分别来分析一下吧。</p>\n<h4 id="rabbitmq"><a href="#rabbitmq" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>RabbitMQ</h4>\n<h5 id="生产者弄丢了数据"><a href="#%E7%94%9F%E4%BA%A7%E8%80%85%E5%BC%84%E4%B8%A2%E4%BA%86%E6%95%B0%E6%8D%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>生产者弄丢了数据</h5>\n<p>生产者将数据发送到 RabbitMQ 的时候，可能数据就在半路给搞丢了，因为网络问题啥的，都有可能。</p>\n<p>此时可以选择用 RabbitMQ 提供的事务功能，就是生产者发送数据之前开启 RabbitMQ 事务 <code class="language-text">channel.txSelect()</code>，然后发送消息，如果消息没有成功被 RabbitMQ 接收到，那么生产者会收到异常报错，此时就可以回滚事务 <code class="language-text">channel.txRollback()</code>，然后重试发送消息；如果收到了消息，那么可以提交事务 channel.txCommit() 。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="51796270585633460000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`try {\n    // 通过工厂创建连接\n    connection = factory.newConnection();\n    // 获取通道\n    channel = connection.createChannel();\n    // 开启事务\n    channel.txSelect();\n\n    // 这里发送消息\n    channel.basicPublish(exchange, routingKey, MessageProperties.PERSISTENT_TEXT_PLAIN, msg.getBytes());\n\n    // 模拟出现异常\n    int result = 1 / 0;\n\n    // 提交事务\n    channel.txCommit();\n} catch (IOException | TimeoutException e) {\n    // 捕捉异常，回滚事务\n    channel.txRollback();\n}`, `51796270585633460000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">try</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 通过工厂创建连接</span>\n    connection <span class="token operator">=</span> factory<span class="token punctuation">.</span><span class="token function">newConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// 获取通道</span>\n    channel <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// 开启事务</span>\n    channel<span class="token punctuation">.</span><span class="token function">txSelect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// 这里发送消息</span>\n    channel<span class="token punctuation">.</span><span class="token function">basicPublish</span><span class="token punctuation">(</span>exchange<span class="token punctuation">,</span> routingKey<span class="token punctuation">,</span> <span class="token class-name">MessageProperties</span><span class="token punctuation">.</span>PERSISTENT_TEXT_PLAIN<span class="token punctuation">,</span> msg<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// 模拟出现异常</span>\n    <span class="token keyword">int</span> result <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">/</span> <span class="token number">0</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// 提交事务</span>\n    channel<span class="token punctuation">.</span><span class="token function">txCommit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> <span class="token operator">|</span> <span class="token class-name">TimeoutException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 捕捉异常，回滚事务</span>\n    channel<span class="token punctuation">.</span><span class="token function">txRollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>但是问题是，RabbitMQ 事务机制（同步）一搞，基本上吞吐量会下来，因为太耗性能。</p>\n<p>所以一般来说，如果你要确保说写 RabbitMQ 的消息别丢，可以开启 confirm 模式，在生产者那里设置开启 confirm 模式之后，你每次写的消息都会分配一个唯一的 id，然后如果写入了 RabbitMQ 中，RabbitMQ 会给你回传一个 ack 消息，告诉你说这个消息 ok 了。如果 RabbitMQ 没能处理这个消息，会回调你的一个 nack 接口，告诉你这个消息接收失败，你可以重试。而且你可以结合这个机制自己在内存里维护每个消息 id 的状态，如果超过一定时间还没接收到这个消息的回调，那么你可以重发。</p>\n<p>事务机制和 confirm 机制最大的不同在于，事务机制是同步的，你提交一个事务之后会阻塞在那儿，但是 confirm 机制是异步的，你发送个消息之后就可以发送下一个消息，然后那个消息 RabbitMQ 接收了之后会异步回调你的一个接口通知你这个消息接收到了。</p>\n<p>所以一般在生产者这块避免数据丢失，都是用 confirm 机制的。</p>\n<blockquote>\n<p>已经在 transaction 事务模式的 channel 是不能再设置成 confirm 模式的，即这两种模式是不能共存的。</p>\n</blockquote>\n<p>客户端实现生产者 confirm 有 3 种方式：</p>\n<ol>\n<li>\n<p>普通 confirm 模式：每发送一条消息后，调用 waitForConfirms() 方法，等待服务器端 confirm，如果服务端返回 false 或者在一段时间内都没返回，客户端可以进行消息重发。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="88623772005770790000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`channel.basicPublish(ConfirmConfig.exchangeName, ConfirmConfig.routingKey, MessageProperties.PERSISTENT_TEXT_PLAIN, ConfirmConfig.msg_10B.getBytes());\nif (!channel.waitForConfirms()) {\n   // 消息发送失败\n   // ...\n}`, `88623772005770790000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java">channel<span class="token punctuation">.</span><span class="token function">basicPublish</span><span class="token punctuation">(</span><span class="token class-name">ConfirmConfig</span><span class="token punctuation">.</span>exchangeName<span class="token punctuation">,</span> <span class="token class-name">ConfirmConfig</span><span class="token punctuation">.</span>routingKey<span class="token punctuation">,</span> <span class="token class-name">MessageProperties</span><span class="token punctuation">.</span>PERSISTENT_TEXT_PLAIN<span class="token punctuation">,</span> <span class="token class-name">ConfirmConfig</span><span class="token punctuation">.</span>msg_10B<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>channel<span class="token punctuation">.</span><span class="token function">waitForConfirms</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token comment">// 消息发送失败</span>\n   <span class="token comment">// ...</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n<li>\n<p>批量 confirm 模式：每发送一批消息后，调用 waitForConfirms() 方法，等待服务端 confirm。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="29250479309762077000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`channel.confirmSelect();\nfor (int i = 0; i < batchCount; ++i) {\n   channel.basicPublish(ConfirmConfig.exchangeName, ConfirmConfig.routingKey, MessageProperties.PERSISTENT_TEXT_PLAIN, ConfirmConfig.msg_10B.getBytes());\n}\nif (!channel.waitForConfirms()) {\n   // 消息发送失败\n   // ...\n}`, `29250479309762077000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java">channel<span class="token punctuation">.</span><span class="token function">confirmSelect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> batchCount<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   channel<span class="token punctuation">.</span><span class="token function">basicPublish</span><span class="token punctuation">(</span><span class="token class-name">ConfirmConfig</span><span class="token punctuation">.</span>exchangeName<span class="token punctuation">,</span> <span class="token class-name">ConfirmConfig</span><span class="token punctuation">.</span>routingKey<span class="token punctuation">,</span> <span class="token class-name">MessageProperties</span><span class="token punctuation">.</span>PERSISTENT_TEXT_PLAIN<span class="token punctuation">,</span> <span class="token class-name">ConfirmConfig</span><span class="token punctuation">.</span>msg_10B<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>channel<span class="token punctuation">.</span><span class="token function">waitForConfirms</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token comment">// 消息发送失败</span>\n   <span class="token comment">// ...</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n<li>\n<p>异步 confirm 模式：提供一个回调方法，服务端 confirm 了一条或者多条消息后客户端会回调这个方法。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="32409047477492380000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`SortedSet<Long> confirmSet = Collections.synchronizedSortedSet(new TreeSet<Long>());\nchannel.confirmSelect();\nchannel.addConfirmListener(new ConfirmListener() {\n   public void handleAck(long deliveryTag, boolean multiple) throws IOException {\n       if (multiple) {\n           confirmSet.headSet(deliveryTag + 1).clear();\n       } else {\n           confirmSet.remove(deliveryTag);\n       }\n   }\n\n   public void handleNack(long deliveryTag, boolean multiple) throws IOException {\n       System.out.println(&quot;Nack, SeqNo: &quot; + deliveryTag + &quot;, multiple: &quot; + multiple);\n       if (multiple) {\n           confirmSet.headSet(deliveryTag + 1).clear();\n       } else {\n           confirmSet.remove(deliveryTag);\n       }\n   }\n});\n\nwhile (true) {\n   long nextSeqNo = channel.getNextPublishSeqNo();\n   channel.basicPublish(ConfirmConfig.exchangeName, ConfirmConfig.routingKey, MessageProperties.PERSISTENT_TEXT_PLAIN, ConfirmConfig.msg_10B.getBytes());\n   confirmSet.add(nextSeqNo);\n}`, `32409047477492380000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token class-name">SortedSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">></span></span> confirmSet <span class="token operator">=</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">synchronizedSortedSet</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TreeSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nchannel<span class="token punctuation">.</span><span class="token function">confirmSelect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nchannel<span class="token punctuation">.</span><span class="token function">addConfirmListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ConfirmListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleAck</span><span class="token punctuation">(</span><span class="token keyword">long</span> deliveryTag<span class="token punctuation">,</span> <span class="token keyword">boolean</span> multiple<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>\n       <span class="token keyword">if</span> <span class="token punctuation">(</span>multiple<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n           confirmSet<span class="token punctuation">.</span><span class="token function">headSet</span><span class="token punctuation">(</span>deliveryTag <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n       <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n           confirmSet<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>deliveryTag<span class="token punctuation">)</span><span class="token punctuation">;</span>\n       <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleNack</span><span class="token punctuation">(</span><span class="token keyword">long</span> deliveryTag<span class="token punctuation">,</span> <span class="token keyword">boolean</span> multiple<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>\n       <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Nack, SeqNo: "</span> <span class="token operator">+</span> deliveryTag <span class="token operator">+</span> <span class="token string">", multiple: "</span> <span class="token operator">+</span> multiple<span class="token punctuation">)</span><span class="token punctuation">;</span>\n       <span class="token keyword">if</span> <span class="token punctuation">(</span>multiple<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n           confirmSet<span class="token punctuation">.</span><span class="token function">headSet</span><span class="token punctuation">(</span>deliveryTag <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n       <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n           confirmSet<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>deliveryTag<span class="token punctuation">)</span><span class="token punctuation">;</span>\n       <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">long</span> nextSeqNo <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">getNextPublishSeqNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   channel<span class="token punctuation">.</span><span class="token function">basicPublish</span><span class="token punctuation">(</span><span class="token class-name">ConfirmConfig</span><span class="token punctuation">.</span>exchangeName<span class="token punctuation">,</span> <span class="token class-name">ConfirmConfig</span><span class="token punctuation">.</span>routingKey<span class="token punctuation">,</span> <span class="token class-name">MessageProperties</span><span class="token punctuation">.</span>PERSISTENT_TEXT_PLAIN<span class="token punctuation">,</span> <span class="token class-name">ConfirmConfig</span><span class="token punctuation">.</span>msg_10B<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   confirmSet<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>nextSeqNo<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n</ol>\n<h5 id="rabbitmq-弄丢了数据"><a href="#rabbitmq-%E5%BC%84%E4%B8%A2%E4%BA%86%E6%95%B0%E6%8D%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>RabbitMQ 弄丢了数据</h5>\n<p>就是 RabbitMQ 自己弄丢了数据，这个你必须开启 RabbitMQ 的持久化，就是消息写入之后会持久化到磁盘，哪怕是 RabbitMQ 自己挂了，恢复之后会自动读取之前存储的数据，一般数据不会丢。除非极其罕见的是，RabbitMQ 还没持久化，自己就挂了，可能导致少量数据丢失，但是这个概率较小。</p>\n<p>设置持久化有两个步骤：</p>\n<ol>\n<li>创建 queue 的时候将其设置为持久化。这样就可以保证 RabbitMQ 持久化 queue 的元数据，但是它是不会持久化 queue 里的数据的。</li>\n<li>发送消息的时候将消息的 deliveryMode 设置为 2。就是将消息设置为持久化的，此时 RabbitMQ 就会将消息持久化到磁盘上去。</li>\n</ol>\n<p>必须要同时设置这两个持久化才行，RabbitMQ 哪怕是挂了，再次重启，也会从磁盘上重启恢复 queue，恢复这个 queue 里的数据。</p>\n<p>注意，哪怕是你给 RabbitMQ 开启了持久化机制，也有一种可能，就是这个消息写到了 RabbitMQ 中，但是还没来得及持久化到磁盘上，结果不巧，此时 RabbitMQ 挂了，就会导致内存里的一点点数据丢失。</p>\n<p>所以，持久化可以跟生产者那边的 confirm 机制配合起来，只有消息被持久化到磁盘之后，才会通知生产者 ack 了，所以哪怕是在持久化到磁盘之前，RabbitMQ 挂了，数据丢了，生产者收不到 ack ，你也是可以自己重发的。</p>\n<h5 id="消费端弄丢了数据"><a href="#%E6%B6%88%E8%B4%B9%E7%AB%AF%E5%BC%84%E4%B8%A2%E4%BA%86%E6%95%B0%E6%8D%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>消费端弄丢了数据</h5>\n<p>RabbitMQ 如果丢失了数据，主要是因为你消费的时候，刚消费到，还没处理，结果进程挂了，比如重启了，那么就尴尬了，RabbitMQ 认为你都消费了，这数据就丢了。</p>\n<p>这个时候得用 RabbitMQ 提供的 ack 机制，简单来说，就是你必须关闭 RabbitMQ 的自动 ack，可以通过一个 api 来调用就行，然后每次你自己代码里确保处理完的时候，再在程序里 ack 一把。这样的话，如果你还没处理完，不就没有 ack 了？那 RabbitMQ 就认为你还没处理完，这个时候 RabbitMQ 会把这个消费分配给别的 consumer 去处理，消息是不会丢的。</p>\n<blockquote>\n<p>为了保证消息从队列中可靠地到达消费者，RabbitMQ 提供了消息确认机制。消费者在声明队列时，可以指定 noAck 参数，当 noAck=false，RabbitMQ 会等待消费者显式发回 ack 信号后，才从内存（和磁盘，如果是持久化消息）中移去消息。否则，一旦消息被消费者消费，RabbitMQ 会在队列中立即删除它。</p>\n</blockquote>\n<h4 id="kafka"><a href="#kafka" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Kafka</h4>\n<h5 id="消费端弄丢了数据-1"><a href="#%E6%B6%88%E8%B4%B9%E7%AB%AF%E5%BC%84%E4%B8%A2%E4%BA%86%E6%95%B0%E6%8D%AE-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>消费端弄丢了数据</h5>\n<p>唯一可能导致消费者弄丢数据的情况，就是说，你消费到了这个消息，然后消费者那边自动提交了 offset，让 Kafka 以为你已经消费好了这个消息，但其实你才刚准备处理这个消息，你还没处理，你自己就挂了，此时这条消息就丢咯。</p>\n<p>这不是跟 RabbitMQ 差不多吗，大家都知道 Kafka 会自动提交 offset，那么只要关闭自动提交 offset，在处理完之后自己手动提交 offset，就可以保证数据不会丢。但是此时确实还是可能会有重复消费，比如你刚处理完，还没提交 offset，结果自己挂了，此时肯定会重复消费一次，自己保证幂等性就好了。</p>\n<p>生产环境碰到的一个问题，就是说我们的 Kafka 消费者消费到了数据之后是写到一个内存的 queue 里先缓冲一下，结果有的时候，你刚把消息写入内存 queue，然后消费者会自动提交 offset。然后此时我们重启了系统，就会导致内存 queue 里还没来得及处理的数据就丢失了。</p>\n<h5 id="kafka-弄丢了数据"><a href="#kafka-%E5%BC%84%E4%B8%A2%E4%BA%86%E6%95%B0%E6%8D%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Kafka 弄丢了数据</h5>\n<p>这块比较常见的一个场景，就是 Kafka 某个 broker 宕机，然后重新选举 partition 的 leader。大家想想，要是此时其他的 follower 刚好还有些数据没有同步，结果此时 leader 挂了，然后选举某个 follower 成 leader 之后，不就少了一些数据？这就丢了一些数据啊。</p>\n<p>生产环境也遇到过，之前 Kafka 的 leader 机器宕机了，将 follower 切换为 leader 之后，就会发现说这个数据就丢了。</p>\n<p>所以此时一般是要求起码设置如下 4 个参数：</p>\n<ol>\n<li>给 topic 设置 replication.factor 参数：这个值必须大于 1，要求每个 partition 必须有至少 2 个副本。</li>\n<li>在 Kafka 服务端设置 min.insync.replicas 参数：这个值必须大于 1，这个是要求一个 leader 至少感知到有至少一个 follower 还跟自己保持联系，没掉队，这样才能确保 leader 挂了还有一个 follower 吧。</li>\n<li>在 producer 端设置 acks=all：这个是要求每条数据，必须是写入所有 replica 之后，才能认为是写成功了。</li>\n<li>在 producer 端设置 retries=MAX（很大很大很大的一个值，无限次重试的意思）：这个是要求一旦写入失败，就无限重试，卡在这里了。我们生产环境就是按照上述要求配置的，这样配置之后，至少在 Kafka broker 端就可以保证在 leader 所在 broker 发生故障，进行 leader 切换时，数据不会丢失。</li>\n</ol>\n<h5 id="生产者会不会弄丢数据？"><a href="#%E7%94%9F%E4%BA%A7%E8%80%85%E4%BC%9A%E4%B8%8D%E4%BC%9A%E5%BC%84%E4%B8%A2%E6%95%B0%E6%8D%AE%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>生产者会不会弄丢数据？</h5>\n<p>如果按照上述的思路设置了 acks=all，一定不会丢，要求是你的 leader 接收到消息，所有的 follower 都同步到了消息之后，才认为本次写成功了。如果没满足这个条件，生产者会自动不断的重试，重试无限次。</p>\n<h4 id="rocketmq"><a href="#rocketmq" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>RocketMQ</h4>\n<h5 id="消息丢失的场景"><a href="#%E6%B6%88%E6%81%AF%E4%B8%A2%E5%A4%B1%E7%9A%84%E5%9C%BA%E6%99%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>消息丢失的场景</h5>\n<ol>\n<li>生产者发送消息到 MQ 有可能丢失消息</li>\n<li>MQ 收到消息后写入硬盘可能丢失消息</li>\n<li>消息写入硬盘后，硬盘坏了丢失消息</li>\n<li>消费者消费 MQ 也可能丢失消息</li>\n<li>整个 MQ 节点挂了丢失消息</li>\n</ol>\n<h5 id="生产者发送消息时如何保证不丢失？"><a href="#%E7%94%9F%E4%BA%A7%E8%80%85%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF%E6%97%B6%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%E4%B8%8D%E4%B8%A2%E5%A4%B1%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>生产者发送消息时如何保证不丢失？</h5>\n<p>解决发送时消息丢失的问题可以采用 RocketMQ 自带的事物消息机制</p>\n<p>事物消息原理：首先生产者会发送一个 half 消息(对原始消息的封装)，该消息对消费者不可见，MQ 通过 ACK 机制返回消息接受状态，生产者执行本地事务并且返回给 MQ 一个状态(Commit、RollBack 等)，如果是 Commit 的话 MQ 就会把消息给到下游，RollBack 的话就会丢弃该消息，状态如果为 UnKnow 的话会过一段时间回查本地事务状态，默认回查 15 次，一直是 UnKnow 状态的话就会丢弃此消息。</p>\n<p>为什么先发一个 half 消息，作用就是先判断下 MQ 有没有问题，服务正不正常。</p>\n<h5 id="mq-收到消息后写入硬盘如何保证不丢失？"><a href="#mq-%E6%94%B6%E5%88%B0%E6%B6%88%E6%81%AF%E5%90%8E%E5%86%99%E5%85%A5%E7%A1%AC%E7%9B%98%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%E4%B8%8D%E4%B8%A2%E5%A4%B1%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>MQ 收到消息后写入硬盘如何保证不丢失？</h5>\n<p>数据存盘绕过缓存，改为同步刷盘，这一步需要修改 Broker 的配置文件，将 flushDiskType 改为 <code class="language-text">SYNC_FLUSH</code> 同步刷盘策略，默认的是 <code class="language-text">ASYNC_FLUSH</code> 异步刷盘，一旦同步刷盘返回成功，那么就一定保证消息已经持久化到磁盘中了。</p>\n<h5 id="消息写入硬盘后，硬盘坏了如何保证不丢失？"><a href="#%E6%B6%88%E6%81%AF%E5%86%99%E5%85%A5%E7%A1%AC%E7%9B%98%E5%90%8E%EF%BC%8C%E7%A1%AC%E7%9B%98%E5%9D%8F%E4%BA%86%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%E4%B8%8D%E4%B8%A2%E5%A4%B1%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>消息写入硬盘后，硬盘坏了如何保证不丢失？</h5>\n<p>为了保证磁盘损坏导致丢失数据，RocketMQ 采用主从机构，集群部署，Leader 中的数据在多个 Follower 中都存有备份，防止单点故障导致数据丢失。</p>\n<p>Master 节点挂了怎么办？Master 节点挂了之后 DLedger 登场</p>\n<ul>\n<li>接管 MQ 的 commitLog</li>\n<li>选举从节点</li>\n<li>文件复制 uncommited 状态，多半从节点收到之后改为 commited</li>\n</ul>\n<h5 id="消费者消费-mq-如何保证不丢失？"><a href="#%E6%B6%88%E8%B4%B9%E8%80%85%E6%B6%88%E8%B4%B9-mq-%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%E4%B8%8D%E4%B8%A2%E5%A4%B1%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>消费者消费 MQ 如何保证不丢失？</h5>\n<ol>\n<li>如果是网络问题导致的消费失败可以进行重试机制，默认每条消息重试 16 次</li>\n<li>多线程异步消费失败，MQ 认为已经消费成功但是实际上对于业务逻辑来说消息是没有落地的，解决方案就是按照 mq 官方推荐的先执行本地事务再返回成功状态。</li>\n</ol>\n<h5 id="整个-mq-节点挂了如何保证不丢失？"><a href="#%E6%95%B4%E4%B8%AA-mq-%E8%8A%82%E7%82%B9%E6%8C%82%E4%BA%86%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%E4%B8%8D%E4%B8%A2%E5%A4%B1%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>整个 MQ 节点挂了如何保证不丢失？</h5>\n<p>这种极端情况可以消息发送失败之后先存入本地，例如放到缓存中，另外启动一个线程扫描缓存的消息去重试发送。</p>\n<h3 id="如何保证消息的顺序性？"><a href="#%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%E6%B6%88%E6%81%AF%E7%9A%84%E9%A1%BA%E5%BA%8F%E6%80%A7%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>如何保证消息的顺序性？</h3>\n<h4 id="背景-1"><a href="#%E8%83%8C%E6%99%AF-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>背景</h4>\n<p>以前做过一个 mysql binlog 同步的系统，压力还是非常大的，日同步数据要达到上亿，就是说数据从一个 mysql 库原封不动地同步到另一个 mysql 库里面去（mysql -> mysql）。常见的一点在于说比如大数据 team，就需要同步一个 mysql 库过来，对公司的业务系统的数据做各种复杂的操作。</p>\n<p>你在 mysql 里增删改一条数据，对应出来了增删改 3 条 binlog 日志，接着这三条 binlog 发送到 MQ 里面，再消费出来依次执行，起码得保证人家是按照顺序来的吧？不然本来是：增加、修改、删除；你愣是换了顺序给执行成删除、修改、增加，不全错了么。</p>\n<p>本来这个数据同步过来，应该最后这个数据被删除了；结果你搞错了这个顺序，最后这个数据保留下来了，数据同步就出错了。</p>\n<p>先看看顺序会错乱的俩场景：</p>\n<ul>\n<li>\n<p>RabbitMQ：一个 queue，多个 consumer。比如，生产者向 RabbitMQ 里发送了三条数据，顺序依次是 data1/data2/data3，压入的是 RabbitMQ 的一个内存队列。有三个消费者分别从 MQ 中消费这三条数据中的一条，结果消费者 2 先执行完操作，把 data2 存入数据库，然后是 data1/data3。这不明显乱了。</p>\n</li>\n<li>\n<p>Kafka：比如说我们建了一个 topic，有三个 partition。生产者在写的时候，其实可以指定一个 key，比如说我们指定了某个订单 id 作为 key，那么这个订单相关的数据，一定会被分发到同一个 partition 中去，而且这个 partition 中的数据一定是有顺序的。</p>\n<p>消费者从 partition 中取出来数据的时候，也一定是有顺序的。到这里，顺序还是 ok 的，没有错乱。接着，我们在消费者里可能会搞多个线程来并发处理消息。因为如果消费者是单线程消费处理，而处理比较耗时的话，比如处理一条消息耗时几十 ms，那么 1 秒钟只能处理几十条消息，这吞吐量太低了。而多个线程并发跑的话，顺序可能就乱掉了。</p>\n</li>\n</ul>\n<h4 id="解决方案-1"><a href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>解决方案</h4>\n<h5 id="rabbitmq-1"><a href="#rabbitmq-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>RabbitMQ</h5>\n<p>拆分多个 queue，每个 queue 一个 consumer，就是多一些 queue 而已，确实是麻烦点，这样也会造成吞吐量下降，可以在消费者内部采用多线程的方式去消费。</p>\n<p>或者就一个 queue 但是对应一个 consumer，然后这个 consumer 内部用内存队列做排队，然后分发给底层不同的 worker 来处理。</p>\n<p>注意，这里消费者不直接消费消息，而是将消息根据关键值（比如：订单 id）进行哈希，哈希值相同的消息保存到相同的内存队列里。也就是说，需要保证顺序的消息存到了相同的内存队列，然后由一个唯一的 worker 去处理。</p>\n<p>一句话概括就是同一个 id 下的操作放到同一个 queue 中，那么消费者消费的顺序就得到了保证，下面的 Kafka 同理</p>\n<h5 id="kafka-1"><a href="#kafka-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Kafka</h5>\n<ul>\n<li>一个 topic，一个 partition，一个 consumer，内部单线程消费，单线程吞吐量太低，一般不会用这个。</li>\n<li>写 N 个内存 queue，具有相同 key 的数据都到同一个内存 queue；然后对于 N 个线程，每个线程分别消费一个内存 queue 即可，这样就能保证顺序性。</li>\n</ul>\n<h3 id="如何解决消息队列的延时以及过期失效问题？"><a href="#%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E7%9A%84%E5%BB%B6%E6%97%B6%E4%BB%A5%E5%8F%8A%E8%BF%87%E6%9C%9F%E5%A4%B1%E6%95%88%E9%97%AE%E9%A2%98%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>如何解决消息队列的延时以及过期失效问题？</h3>\n<h4 id="大量消息在-mq-里积压了几个小时了还没解决"><a href="#%E5%A4%A7%E9%87%8F%E6%B6%88%E6%81%AF%E5%9C%A8-mq-%E9%87%8C%E7%A7%AF%E5%8E%8B%E4%BA%86%E5%87%A0%E4%B8%AA%E5%B0%8F%E6%97%B6%E4%BA%86%E8%BF%98%E6%B2%A1%E8%A7%A3%E5%86%B3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>大量消息在 mq 里积压了几个小时了还没解决</h4>\n<p>几千万条数据在 MQ 里积压了七八个小时，从下午 4 点多，积压到了晚上 11 点多。这个是我们真实遇到过的一个场景，确实是线上故障了，这个时候要不然就是修复 consumer 的问题，让它恢复消费速度，然后傻傻的等待几个小时消费完毕。这个肯定不能在面试的时候说吧。</p>\n<p>一个消费者一秒是 1000 条，一秒 3 个消费者是 3000 条，一分钟就是 18 万条。所以如果你积压了几百万到上千万的数据，即使消费者恢复了，也需要大概 1 小时的时间才能恢复过来。</p>\n<p>一般这个时候，只能临时紧急扩容了，具体操作步骤和思路如下：</p>\n<ul>\n<li>先修复 consumer 的问题，确保其恢复消费速度，然后将现有 consumer 都停掉。</li>\n<li>新建一个 topic，partition 是原来的 10 倍，临时建立好原先 10 倍的 queue 数量。</li>\n<li>然后写一个临时的分发数据的 consumer 程序，这个程序部署上去消费积压的数据，消费之后不做耗时的处理，直接均匀轮询写入临时建立好的 10 倍数量的 queue。</li>\n<li>接着临时征用 10 倍的机器来部署 consumer，每一批 consumer 消费一个临时 queue 的数据。这种做法相当于是临时将 queue 资源和 consumer 资源扩大 10 倍，以正常的 10 倍速度来消费数据。</li>\n<li>等快速消费完积压数据之后，得恢复原先部署的架构，重新用原先的 consumer 机器来消费消息。</li>\n</ul>\n<h4 id="mq-中的消息过期失效了"><a href="#mq-%E4%B8%AD%E7%9A%84%E6%B6%88%E6%81%AF%E8%BF%87%E6%9C%9F%E5%A4%B1%E6%95%88%E4%BA%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>mq 中的消息过期失效了</h4>\n<p>假设你用的是 RabbitMQ，RabbtiMQ 是可以设置过期时间的，也就是 TTL。如果消息在 queue 中积压超过一定的时间就会被 RabbitMQ 给清理掉，这个数据就没了。那这就是第二个坑了。这就不是说数据会大量积压在 mq 里，而是大量的数据会直接搞丢。</p>\n<p>这个情况下，就不是说要增加 consumer 消费积压的消息，因为实际上没啥积压，而是丢了大量的消息。我们可以采取一个方案，就是批量重导，这个我们之前线上也有类似的场景干过。就是大量积压的时候，我们当时就直接丢弃数据了，然后等过了高峰期以后，比如大家一起喝咖啡熬夜到晚上 12 点以后，用户都睡觉了。这个时候我们就开始写程序，将丢失的那批数据，写个临时程序，一点一点的查出来，然后重新灌入 mq 里面去，把白天丢的数据给他补回来。也只能是这样了。</p>\n<p>假设 1 万个订单积压在 mq 里面，没有处理，其中 1000 个订单都丢了，你只能手动写程序把那 1000 个订单给查出来，手动发到 mq 里去再补一次。</p>\n<h4 id="mq-都快写满了"><a href="#mq-%E9%83%BD%E5%BF%AB%E5%86%99%E6%BB%A1%E4%BA%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>mq 都快写满了</h4>\n<p>如果消息积压在 mq 里，你很长时间都没有处理掉，此时导致 mq 都快写满了，咋办？这个还有别的办法吗？没有，谁让你第一个方案执行的太慢了，你临时写程序，接入数据来消费，消费一个丢弃一个，都不要了，快速消费掉所有的消息。然后走第二个方案，到了晚上再补数据吧。</p>\n<h4 id="rocketmq-的处理方式"><a href="#rocketmq-%E7%9A%84%E5%A4%84%E7%90%86%E6%96%B9%E5%BC%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>RocketMQ 的处理方式</h4>\n<ol>\n<li>\n<p>提高消费并行度</p>\n<p>绝大部分消息消费行为都属于 IO 密集型，即可能是操作数据库，或者调用 RPC，这类消费行为的消费速度在于后端数据库或者外系统的吞吐量，通过增加消费并行度，可以提高总的消费吞吐量，但是并行度增加到一定程度，反而会下降。所以，应用必须要设置合理的并行度。如下有几种修改消费并行度的方法：</p>\n<ol>\n<li>同一个 ConsumerGroup 下，通过增加 Consumer 实例数量来提高并行度（需要注意的是超过订阅队列数的 Consumer 实例无效）。</li>\n<li>可以通过加机器，或者在已有机器启动多个进程的方式。</li>\n<li>提高单个 Consumer 的消费并行线程，通过修改参数 consumeThreadMin、consumeThreadMax 实现。</li>\n</ol>\n</li>\n<li>\n<p>批量方式消费</p>\n<p>某些业务流程如果支持批量方式消费，则可以很大程度上提高消费吞吐量，例如订单扣款类应用，一次处理一个订单耗时 1s，一次处理 10 个订单可能也只耗时 2s，这样即可大幅度提高消费的吞吐量，通过设置 consumer 的 consumeMessageBatchMaxSize 参数，默认是 1，即一次只消费一条消息，例如设置为 N，那么每次消费的消息数小于等于 N。</p>\n</li>\n<li>\n<p>跳过非重要消息</p>\n<p>发生消息堆积时，如果消费速度一直追不上发送速度，如果业务对数据要求不高的话，可以选择丢弃不重要的消息。例如，当某个队列的消息数堆积到 100000 条以上，则尝试丢弃部分或全部消息，这样就可以快速追上发送消息的速度。示例代码如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="22128103072795890000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public ConsumeConcurrentlyStatus consumeMessage(\n           List<MessageExt> msgs,\n           ConsumeConcurrentlyContext context) {\n  long offset = msgs.get(0).getQueueOffset();\n  String maxOffset =\n           msgs.get(0).getProperty(Message.PROPERTY_MAX_OFFSET);\n  long diff = Long.parseLong(maxOffset) - offset;\n  if (diff > 100000) {\n     // 消息堆积情况的特殊处理\n     return ConsumeConcurrentlyStatus.CONSUME_SUCCESS;\n  }\n  // 正常消费过程\n  return ConsumeConcurrentlyStatus.CONSUME_SUCCESS;\n}`, `22128103072795890000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">ConsumeConcurrentlyStatus</span> <span class="token function">consumeMessage</span><span class="token punctuation">(</span>\n           <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageExt</span><span class="token punctuation">></span></span> msgs<span class="token punctuation">,</span>\n           <span class="token class-name">ConsumeConcurrentlyContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">long</span> offset <span class="token operator">=</span> msgs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getQueueOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token class-name">String</span> maxOffset <span class="token operator">=</span>\n           msgs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token class-name">Message</span><span class="token punctuation">.</span>PROPERTY_MAX_OFFSET<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">long</span> diff <span class="token operator">=</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">parseLong</span><span class="token punctuation">(</span>maxOffset<span class="token punctuation">)</span> <span class="token operator">-</span> offset<span class="token punctuation">;</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>diff <span class="token operator">></span> <span class="token number">100000</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n     <span class="token comment">// 消息堆积情况的特殊处理</span>\n     <span class="token keyword">return</span> <span class="token class-name">ConsumeConcurrentlyStatus</span><span class="token punctuation">.</span>CONSUME_SUCCESS<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token comment">// 正常消费过程</span>\n  <span class="token keyword">return</span> <span class="token class-name">ConsumeConcurrentlyStatus</span><span class="token punctuation">.</span>CONSUME_SUCCESS<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n<li>\n<p>优化每条消息消费过程</p>\n<p>举例如下，某条消息的消费过程如下：</p>\n<ul>\n<li>根据消息从 DB 查询【数据 1】</li>\n<li>根据消息从 DB 查询【数据 2】</li>\n<li>复杂的业务计算</li>\n<li>向 DB 插入【数据 3】</li>\n<li>向 DB 插入【数据 4】</li>\n</ul>\n<p>这条消息的消费过程中有 4 次与 DB 的交互，如果按照每次 5ms 计算，那么总共耗时 20ms，假设业务计算耗时 5ms，那么总过耗时 25ms，所以如果能把 4 次 DB 交互优化为 2 次，那么总耗时就可以优化到 15ms，即总体性能提高了 40%。所以应用如果对延时敏感的话，可以把 DB 部署在 SSD 硬盘，相比于 SCSI 磁盘，前者的 RT 会小很多。</p>\n</li>\n</ol>\n<h3 id="如何设计一个消息队列？"><a href="#%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1%E4%B8%80%E4%B8%AA%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>如何设计一个消息队列？</h3>\n<ul>\n<li>首先这个 mq 得支持可伸缩性吧，就是需要的时候快速扩容，就可以增加吞吐量和容量，那怎么搞？设计个分布式的系统呗，参照一下 kafka 的设计理念，broker -> topic -> partition，每个 partition 放一个机器，就存一部分数据。如果现在资源不够了，简单啊，给 topic 增加 partition，然后做数据迁移，增加机器，不就可以存放更多数据，提供更高的吞吐量了？</li>\n<li>其次你得考虑一下这个 mq 的数据要不要落地磁盘吧？那肯定要了，落磁盘才能保证别进程挂了数据就丢了。那落磁盘的时候怎么落啊？顺序写，这样就没有磁盘随机读写的寻址开销，磁盘顺序读写的性能是很高的，这就是 kafka 的思路。</li>\n<li>其次你考虑一下你的 mq 的可用性啊？这个事儿，具体参考之前可用性那个环节讲解的 kafka 的高可用保障机制。多副本 -> leader &#x26; follower -> broker 挂了重新选举 leader 即可对外服务。</li>\n<li>能不能支持数据 0 丢失啊？可以的，参考我们之前说的那个 kafka 数据零丢失方案。</li>\n</ul>\n<h2 id="搜索引擎"><a href="#%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>搜索引擎</h2>\n<h3 id="es-是什么？"><a href="#es-%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ES 是什么？</h3>\n<h4 id="lucene-和-es-的前世今生"><a href="#lucene-%E5%92%8C-es-%E7%9A%84%E5%89%8D%E4%B8%96%E4%BB%8A%E7%94%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Lucene 和 ES 的前世今生</h4>\n<p>Lucene 是最先进、功能最强大的搜索库。如果直接基于 Lucene 开发，非常复杂，即便写一些简单的功能，也要写大量的 Java 代码，需要深入理解原理。</p>\n<p>ElasticSearch 基于 Lucene，隐藏了 lucene 的复杂性，提供了简单易用的 RESTful api / Java api 接口（另外还有其他语言的 api 接口）。</p>\n<ul>\n<li>分布式的文档存储引擎</li>\n<li>分布式的搜索引擎和分析引擎</li>\n<li>分布式，支持 PB 级数据</li>\n</ul>\n<h4 id="es-的核心概念"><a href="#es-%E7%9A%84%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ES 的核心概念</h4>\n<h5 id="near-realtime"><a href="#near-realtime" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Near Realtime</h5>\n<p>近实时，有两层意思：</p>\n<ul>\n<li>从写入数据到数据可以被搜索到有一个小延迟（大概是 1s）</li>\n<li>基于 ES 执行搜索和分析可以达到秒级</li>\n</ul>\n<h5 id="cluster-集群"><a href="#cluster-%E9%9B%86%E7%BE%A4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Cluster 集群</h5>\n<p>集群包含多个节点，每个节点属于哪个集群都是通过一个配置来决定的，对于中小型应用来说，刚开始一个集群就一个节点很正常。</p>\n<h5 id="node-节点"><a href="#node-%E8%8A%82%E7%82%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Node 节点</h5>\n<p>Node 是集群中的一个节点，节点也有一个名称，默认是随机分配的。默认节点会去加入一个名称为 elasticsearch 的集群。如果直接启动一堆节点，那么它们会自动组成一个 elasticsearch 集群，当然一个节点也可以组成 elasticsearch 集群。</p>\n<h5 id="document--field"><a href="#document--field" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Document &#x26; field</h5>\n<p>文档是 ES 中最小的数据单元，一个 document 可以是一条客户数据、一条商品分类数据、一条订单数据，通常用 json 数据结构来表示。每个 index 下的 type，都可以存储多条 document。一个 document 里面有多个 field，每个 field 就是一个数据字段。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="58329985454266245000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`{\n   &quot;product_id&quot;: &quot;1&quot;,\n   &quot;product_name&quot;: &quot;iPhone X&quot;,\n   &quot;product_desc&quot;: &quot;苹果手机&quot;,\n   &quot;category_id&quot;: &quot;2&quot;,\n   &quot;category_name&quot;: &quot;电子产品&quot;\n}`, `58329985454266245000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="json"\n              >\n                <span class="gatsby-code-button-language">json</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="json"><pre style="counter-reset: linenumber NaN" class="language-json line-numbers"><code class="language-json"><span class="token punctuation">{</span>\n   <span class="token property">"product_id"</span><span class="token operator">:</span> <span class="token string">"1"</span><span class="token punctuation">,</span>\n   <span class="token property">"product_name"</span><span class="token operator">:</span> <span class="token string">"iPhone X"</span><span class="token punctuation">,</span>\n   <span class="token property">"product_desc"</span><span class="token operator">:</span> <span class="token string">"苹果手机"</span><span class="token punctuation">,</span>\n   <span class="token property">"category_id"</span><span class="token operator">:</span> <span class="token string">"2"</span><span class="token punctuation">,</span>\n   <span class="token property">"category_name"</span><span class="token operator">:</span> <span class="token string">"电子产品"</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h5 id="index"><a href="#index" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Index</h5>\n<p>索引包含了一堆有相似结构的文档数据，比如商品索引。一个索引包含很多 document，一个索引就代表了一类相似或者相同的 document。</p>\n<h5 id="type"><a href="#type" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Type</h5>\n<p>类型，每个索引里可以有一个或者多个 type，type 是 index 的一个逻辑分类，比如商品 index 下有多个 type：日化商品 type、电器商品 type、生鲜商品 type。每个 type 下的 document 的 field 可能不太一样。</p>\n<h5 id="shard"><a href="#shard" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>shard</h5>\n<p>单台机器无法存储大量数据，ES 可以将一个索引中的数据切分为多个 shard，分布在多台服务器上存储。有了 shard 就可以横向扩展，存储更多数据，让搜索和分析等操作分布到多台服务器上去执行，提升吞吐量和性能。每个 shard 都是一个 lucene index。</p>\n<h5 id="replica"><a href="#replica" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>replica</h5>\n<p>任何一个服务器随时可能故障或宕机，此时 shard 可能就会丢失，因此可以为每个 shard 创建多个 replica 副本。replica 可以在 shard 故障时提供备用服务，保证数据不丢失，多个 replica 还可以提升搜索操作的吞吐量和性能。primary shard（建立索引时一次设置，不能修改，默认 5 个），replica shard（随时修改数量，默认 1 个），默认每个索引 10 个 shard，5 个 primary shard，5 个 replica shard，最小的高可用配置，是 2 台服务器。</p>\n<p>这么说吧，shard 分为 primary shard 和 replica shard。而 primary shard 一般简称为 shard，而 replica shard 一般简称为 replica。</p>\n<h4 id="es-核心概念-vs-db-核心概念"><a href="#es-%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5-vs-db-%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ES 核心概念 vs. DB 核心概念</h4>\n<table>\n<thead>\n<tr>\n<th>ES</th>\n<th>DB</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>index</td>\n<td>数据库</td>\n</tr>\n<tr>\n<td>type</td>\n<td>数据表</td>\n</tr>\n<tr>\n<td>document</td>\n<td>一行数据</td>\n</tr>\n</tbody>\n</table>\n<h3 id="es-的分布式架构原理？"><a href="#es-%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ES 的分布式架构原理？</h3>\n<p>ElasticSearch 设计的理念就是分布式搜索引擎，底层其实还是基于 lucene 的。核心思想就是在多台机器上启动多个 ES 进程实例，组成了一个 ES 集群。</p>\n<p>ES 中存储数据的基本单位是索引，比如说你现在要在 ES 中存储一些订单数据，你就应该在 ES 中创建一个索引 <code class="language-text">order_idx</code>，所有的订单数据就都写到这个索引里面去，一个索引差不多就是相当于是 mysql 里的一个数据库。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="20206879755073225000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`index -> type -> mapping -> document -> field`, `20206879755073225000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">index -&gt; type -&gt; mapping -&gt; document -&gt; field</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>这样吧，为了做个更直白的介绍，我在这里做个类比。但是切记，不要划等号，类比只是为了便于理解。</p>\n<p>index 相当于 mysql 数据库。而 type 没法跟 mysql 里去对比，一个 index 里可以有多个 type，每个 type 的字段都是差不多的，但是有一些略微的差别。假设有一个 index，是订单 index，里面专门是放订单数据的。就好比说你在 mysql 中建表，有些订单是实物商品的订单，比如一件衣服、一双鞋子；有些订单是虚拟商品的订单，比如游戏点卡，话费充值。就两种订单大部分字段是一样的，但是少部分字段可能有略微的一些差别。</p>\n<p>所以就会在订单 index 里，建两个 type，一个是实物商品订单 type，一个是虚拟商品订单 type，这两个 type 大部分字段是一样的，少部分字段是不一样的。</p>\n<p>很多情况下，一个 index 里可能就一个 type，但是确实如果说是一个 index 里有多个 type 的情况（注意，mapping types 这个概念在 ElasticSearch 7.X 已被完全移除，详细说明可以参考官方文档），你可以认为 index 是一个类别的表，具体的每个 type 代表了 mysql 中的一个表。每个 type 有一个 mapping，如果你认为一个 type 是具体的一个表，index 就代表多个 type 同属于的一个类型，而 mapping 就是这个 type 的表结构定义，你在 mysql 中创建一个表，肯定是要定义表结构的，里面有哪些字段，每个字段是什么类型。实际上你往 index 里的一个 type 里面写的一条数据，叫做一条 document，一条 document 就代表了 mysql 中某个表里的一行，每个 document 有多个 field，每个 field 就代表了这个 document 中的一个字段的值。</p>\n<p>你搞一个索引，这个索引可以拆分成多个 shard，每个 shard 存储部分数据。拆分多个 shard 是有好处的，一是支持横向扩展，比如你数据量是 3T，3 个 shard，每个 shard 就 1T 的数据，若现在数据量增加到 4T，怎么扩展，很简单，重新建一个有 4 个 shard 的索引，将数据导进去；二是提高性能，数据分布在多个 shard，即多台服务器上，所有的操作，都会在多台机器上并行分布式执行，提高了吞吐量和性能。</p>\n<p>接着就是这个 shard 的数据实际是有多个备份，就是说每个 shard 都有一个 primary shard，负责写入数据，但是还有几个 replica shard。 primary shard 写入数据之后，会将数据同步到其他几个 replica shard 上去。</p>\n<p>通过这个 replica 的方案，每个 shard 的数据都有多个备份，如果某个机器宕机了，没关系啊，还有别的数据副本在别的机器上呢。高可用了吧。</p>\n<p>ES 集群多个节点，会自动选举一个节点为 master 节点，这个 master 节点其实就是干一些管理的工作的，比如维护索引元数据、负责切换 primary shard 和 replica shard 身份等。要是 master 节点宕机了，那么会重新选举一个节点为 master 节点。</p>\n<p>如果是非 master 节点宕机了，那么会由 master 节点，让那个宕机节点上的 primary shard 的身份转移到其他机器上的 replica shard。接着你要是修复了那个宕机机器，重启了之后，master 节点会控制将缺失的 replica shard 分配过去，同步后续修改的数据之类的，让集群恢复正常。</p>\n<p>说得更简单一点，就是说如果某个非 master 节点宕机了。那么此节点上的 primary shard 不就没了。那好，master 会让 primary shard 对应的 replica shard（在其他机器上）切换为 primary shard。如果宕机的机器修复了，修复后的节点也不再是 primary shard，而是 replica shard。</p>\n<p>其实上述就是 ElasticSearch 作为分布式搜索引擎最基本的一个架构设计。</p>\n<h3 id="es-写入数据的工作原理是什么？"><a href="#es-%E5%86%99%E5%85%A5%E6%95%B0%E6%8D%AE%E7%9A%84%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ES 写入数据的工作原理是什么？</h3>\n<h4 id="es-写数据过程"><a href="#es-%E5%86%99%E6%95%B0%E6%8D%AE%E8%BF%87%E7%A8%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>es 写数据过程</h4>\n<ul>\n<li>客户端选择一个 node 发送请求过去，这个 node 就是 coordinating node（协调节点）。</li>\n<li>coordinating node 对 document 进行路由，将请求转发给对应的 node（有 primary shard）。</li>\n<li>实际的 node 上的 primary shard 处理请求，然后将数据同步到 replica node。</li>\n<li>coordinating node 如果发现 primary node 和所有 replica node 都搞定之后，就返回响应结果给客户端。</li>\n</ul>\n<h4 id="es-读数据过程"><a href="#es-%E8%AF%BB%E6%95%B0%E6%8D%AE%E8%BF%87%E7%A8%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>es 读数据过程</h4>\n<p>可以通过 doc id 来查询，会根据 doc id 进行 hash，判断出来当时把 doc id 分配到了哪个 shard 上面去，从那个 shard 去查询。</p>\n<ul>\n<li>客户端发送请求到任意一个 node，成为 coordinate node 。</li>\n<li>coordinate node 对 doc id 进行哈希路由，将请求转发到对应的 node，此时会使用 round-robin 随机轮询算法，在 primary shard 以及其所有 replica 中随机选择一个，让读请求负载均衡。</li>\n<li>接收请求的 node 返回 document 给 coordinate node 。</li>\n<li>coordinate node 返回 document 给客户端。</li>\n</ul>\n<h4 id="es-搜索数据过程"><a href="#es-%E6%90%9C%E7%B4%A2%E6%95%B0%E6%8D%AE%E8%BF%87%E7%A8%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>es 搜索数据过程</h4>\n<p>es 最强大的是做全文检索，就是比如你有三条数据：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="37453755779103970000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`java真好玩儿啊\njava好难学啊\nj2ee特别牛`, `37453755779103970000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">java真好玩儿啊\njava好难学啊\nj2ee特别牛</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>你根据 java 关键词来搜索，将包含 java 的 document 给搜索出来。es 就会给你返回：java 真好玩儿啊，java 好难学啊。</p>\n<ul>\n<li>客户端发送请求到一个 coordinate node。</li>\n<li>协调节点将搜索请求转发到所有的 shard 对应的 primary shard 或 replica shard，都可以。</li>\n<li>query phase：每个 shard 将自己的搜索结果（其实就是一些 doc id ）返回给协调节点，由协调节点进行数据的合并、排序、分页等操作，产出最终结果。</li>\n<li>fetch phase：接着由协调节点根据 doc id 去各个节点上拉取实际的 document 数据，最终返回给客户端。</li>\n</ul>\n<blockquote>\n<p>写请求是写入 primary shard，然后同步给所有的 replica shard；读请求可以从 primary shard 或 replica shard 读取，采用的是随机轮询算法。</p>\n</blockquote>\n<h4 id="写数据底层原理"><a href="#%E5%86%99%E6%95%B0%E6%8D%AE%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>写数据底层原理</h4>\n<p>先写入内存 buffer，在 buffer 里的时候数据是搜索不到的；同时将数据写入 translog 日志文件。</p>\n<p>如果 buffer 快满了，或者到一定时间，就会将内存 buffer 数据 refresh 到一个新的 segment file 中，但是此时数据不是直接进入 segment file 磁盘文件，而是先进入 os cache。这个过程就是 refresh。</p>\n<p>每隔 1 秒钟，es 将 buffer 中的数据写入一个新的 segment file，每秒钟会产生一个新的磁盘文件 segment file，这个 segment file 中就存储最近 1 秒内 buffer 中写入的数据。</p>\n<p>但是如果 buffer 里面此时没有数据，那当然不会执行 refresh 操作，如果 buffer 里面有数据，默认 1 秒钟执行一次 refresh 操作，刷入一个新的 segment file 中。</p>\n<p>操作系统里面，磁盘文件其实都有一个东西，叫做 os cache，即操作系统缓存，就是说数据写入磁盘文件之前，会先进入 os cache，先进入操作系统级别的一个内存缓存中去。只要 buffer 中的数据被 refresh 操作刷入 os cache 中，这个数据就可以被搜索到了。</p>\n<p>为什么叫 es 是准实时的？NRT，全称 near real-time。默认是每隔 1 秒 refresh 一次的，所以 es 是准实时的，因为写入的数据 1 秒之后才能被看到。可以通过 es 的 restful api 或者 java api，手动执行一次 refresh 操作，就是手动将 buffer 中的数据刷入 os cache 中，让数据立马就可以被搜索到。只要数据被输入 os cache 中，buffer 就会被清空了，因为不需要保留 buffer 了，数据在 translog 里面已经持久化到磁盘一份了。</p>\n<p>重复上面的步骤，新的数据不断进入 buffer 和 translog，不断将 buffer 数据写入一个又一个新的 segment file 中去，每次 refresh 完 buffer 清空，translog 保留。随着这个过程推进，translog 会变得越来越大。当 translog 达到一定长度的时候，就会触发 commit 操作。</p>\n<p>commit 操作发生第一步，就是将 buffer 中现有数据 refresh 到 os cache 中去，清空 buffer。然后，将一个 commit point 写入磁盘文件，里面标识着这个 commit point 对应的所有 segment file，同时强行将 os cache 中目前所有的数据都 fsync 到磁盘文件中去。最后清空现有 translog 日志文件，重启一个 translog，此时 commit 操作完成。</p>\n<p>这个 commit 操作叫做 flush。默认 30 分钟自动执行一次 flush，但如果 translog 过大，也会触发 flush。flush 操作就对应着 commit 的全过程，我们可以通过 es api，手动执行 flush 操作，手动将 os cache 中的数据 fsync 强刷到磁盘上去。</p>\n<p>translog 日志文件的作用是什么？你执行 commit 操作之前，数据要么是停留在 buffer 中，要么是停留在 os cache 中，无论是 buffer 还是 os cache 都是内存，一旦这台机器死了，内存中的数据就全丢了。所以需要将数据对应的操作写入一个专门的日志文件 translog 中，一旦此时机器宕机，再次重启的时候，es 会自动读取 translog 日志文件中的数据，恢复到内存 buffer 和 os cache 中去。</p>\n<p>translog 其实也是先写入 os cache 的，默认每隔 5 秒刷一次到磁盘中去，所以默认情况下，可能有 5 秒的数据会仅仅停留在 buffer 或者 translog 文件的 os cache 中，如果此时机器挂了，会丢失 5 秒钟的数据。但是这样性能比较好，最多丢 5 秒的数据。也可以将 translog 设置成每次写操作必须是直接 fsync 到磁盘，但是性能会差很多。</p>\n<ul>\n<li><code class="language-text">index.translog.sync_interval</code> 控制 translog 多久 fsync 到磁盘，最小为 100ms；</li>\n<li><code class="language-text">index.translog.durability</code> translog 是每 5 秒钟刷新一次还是每次请求都 fsync，这个参数有 2 个取值：request（每次请求都执行 fsync，es 要等 translog fsync 到磁盘后才会返回成功）和 async（默认值，translog 每隔 5 秒钟 fsync 一次）。</li>\n</ul>\n<p>实际上你在这里，如果面试官没有问你 es 丢数据的问题，你可以在这里给面试官炫一把，你说，其实 es 第一是准实时的，数据写入 1 秒后可以搜索到；可能会丢失数据的。有 5 秒的数据，停留在 buffer、translog os cache、segment file os cache 中，而不在磁盘上，此时如果宕机，会导致 5 秒的数据丢失。</p>\n<p>总结一下，数据先写入内存 buffer，然后每隔 1s，将数据 refresh 到 os cache，到了 os cache 数据就能被搜索到（所以我们才说 es 从写入到能被搜索到，中间有 1s 的延迟）。每隔 5s，将数据写入 translog 文件（这样如果机器宕机，内存数据全没，最多会有 5s 的数据丢失），translog 大到一定程度，或者默认每隔 30min，会触发 commit 操作，将缓冲区的数据都 flush 到 segment file 磁盘文件中。</p>\n<blockquote>\n<p>数据写入 segment file 之后，同时就建立好了倒排索引。</p>\n</blockquote>\n<h4 id="删除更新数据底层原理"><a href="#%E5%88%A0%E9%99%A4%E6%9B%B4%E6%96%B0%E6%95%B0%E6%8D%AE%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>删除/更新数据底层原理</h4>\n<p>如果是删除操作，commit 的时候会生成一个 .del 文件，里面将某个 doc 标识为 deleted 状态，那么搜索的时候根据 .del 文件就知道这个 doc 是否被删除了。</p>\n<p>如果是更新操作，就是将原来的 doc 标识为 deleted 状态，然后新写入一条数据。</p>\n<p>buffer 每 refresh 一次，就会产生一个 segment file，所以默认情况下是 1 秒钟一个 segment file，这样下来 segment file 会越来越多，此时会定期执行 merge。每次 merge 的时候，会将多个 segment file 合并成一个，同时这里会将标识为 deleted 的 doc 给物理删除掉，然后将新的 segment file 写入磁盘，这里会写一个 commit point，标识所有新的 segment file，然后打开 segment file 供搜索使用，同时删除旧的 segment file。</p>\n<h4 id="底层-lucene"><a href="#%E5%BA%95%E5%B1%82-lucene" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>底层 lucene</h4>\n<p>简单来说，lucene 就是一个 jar 包，里面包含了封装好的各种建立倒排索引的算法代码。我们用 Java 开发的时候，引入 lucene jar，然后基于 lucene 的 api 去开发就可以了。</p>\n<p>通过 lucene，我们可以将已有的数据建立索引，lucene 会在本地磁盘上面，给我们组织索引的数据结构。</p>\n<h4 id="倒排索引"><a href="#%E5%80%92%E6%8E%92%E7%B4%A2%E5%BC%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>倒排索引</h4>\n<p>在搜索引擎中，每个文档都有一个对应的文档 ID，文档内容被表示为一系列关键词的集合。例如，文档 1 经过分词，提取了 20 个关键词，每个关键词都会记录它在文档中出现的次数和出现位置。</p>\n<p>那么，倒排索引就是关键词到文档 ID 的映射，每个关键词都对应着一系列的文件，这些文件中都出现了关键词。</p>\n<p>举个栗子。</p>\n<p>有以下文档：</p>\n<table>\n<thead>\n<tr>\n<th>DocId</th>\n<th>Doc</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>1</td>\n<td>谷歌地图之父跳槽 Facebook</td>\n</tr>\n<tr>\n<td>2</td>\n<td>谷歌地图之父加盟 Facebook</td>\n</tr>\n<tr>\n<td>3</td>\n<td>谷歌地图创始人拉斯离开谷歌加盟 Facebook</td>\n</tr>\n<tr>\n<td>4</td>\n<td>谷歌地图之父跳槽 Facebook 与 Wave 项目取消有关</td>\n</tr>\n<tr>\n<td>5</td>\n<td>谷歌地图之父拉斯加盟社交网站 Facebook</td>\n</tr>\n</tbody>\n</table>\n<p>对文档进行分词之后，得到以下倒排索引。</p>\n<table>\n<thead>\n<tr>\n<th>WordId</th>\n<th>Word</th>\n<th>DocIds</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>1</td>\n<td>谷歌</td>\n<td>1, 2, 3, 4, 5</td>\n</tr>\n<tr>\n<td>2</td>\n<td>地图</td>\n<td>1, 2, 3, 4, 5</td>\n</tr>\n<tr>\n<td>3</td>\n<td>之父</td>\n<td>1, 2, 4, 5</td>\n</tr>\n<tr>\n<td>4</td>\n<td>跳槽</td>\n<td>1, 4</td>\n</tr>\n<tr>\n<td>5</td>\n<td>Facebook</td>\n<td>1, 2, 3, 4, 5</td>\n</tr>\n<tr>\n<td>6</td>\n<td>加盟</td>\n<td>2, 3, 5</td>\n</tr>\n<tr>\n<td>7</td>\n<td>创始人</td>\n<td>3</td>\n</tr>\n<tr>\n<td>8</td>\n<td>拉斯</td>\n<td>3, 5</td>\n</tr>\n<tr>\n<td>9</td>\n<td>离开</td>\n<td>3</td>\n</tr>\n<tr>\n<td>10</td>\n<td>与</td>\n<td>4</td>\n</tr>\n<tr>\n<td>..</td>\n<td>..</td>\n<td>..</td>\n</tr>\n</tbody>\n</table>\n<p>另外，实用的倒排索引还可以记录更多的信息，比如文档频率信息，表示在文档集合中有多少个文档包含某个单词。</p>\n<p>那么，有了倒排索引，搜索引擎可以很方便地响应用户的查询。比如用户输入查询 Facebook ，搜索系统查找倒排索引，从中读出包含这个单词的文档，这些文档就是提供给用户的搜索结果。</p>\n<p>要注意倒排索引的两个重要细节：</p>\n<ul>\n<li>倒排索引中的所有词项对应一个或多个文档；</li>\n<li>倒排索引中的词项根据字典顺序升序排列</li>\n</ul>\n<blockquote>\n<p>上面只是一个简单的栗子，并没有严格按照字典顺序升序排列。</p>\n</blockquote>\n<h3 id="es-在数据量很大的情况下（数十亿级别）如何提高查询效率？"><a href="#es-%E5%9C%A8%E6%95%B0%E6%8D%AE%E9%87%8F%E5%BE%88%E5%A4%A7%E7%9A%84%E6%83%85%E5%86%B5%E4%B8%8B%EF%BC%88%E6%95%B0%E5%8D%81%E4%BA%BF%E7%BA%A7%E5%88%AB%EF%BC%89%E5%A6%82%E4%BD%95%E6%8F%90%E9%AB%98%E6%9F%A5%E8%AF%A2%E6%95%88%E7%8E%87%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ES 在数据量很大的情况下（数十亿级别）如何提高查询效率？</h3>\n<h4 id="性能优化的杀手锏-filesystem-cache"><a href="#%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E7%9A%84%E6%9D%80%E6%89%8B%E9%94%8F-filesystem-cache" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>性能优化的杀手锏 filesystem cache</h4>\n<p>你往 es 里写的数据，实际上都写到磁盘文件里去了，查询的时候，操作系统会将磁盘文件里的数据自动缓存到 filesystem cache 里面去。</p>\n<p>es 的搜索引擎严重依赖于底层的 filesystem cache，你如果给 filesystem cache 更多的内存，尽量让内存可以容纳所有的 idx segment file 索引数据文件，那么你搜索的时候就基本都是走内存的，性能会非常高。</p>\n<p>性能差距究竟可以有多大？我们之前很多的测试和压测，如果走磁盘一般肯定上秒，搜索性能绝对是秒级别的，1 秒、5 秒、10 秒。但如果是走 filesystem cache，是走纯内存的，那么一般来说性能比走磁盘要高一个数量级，基本上就是毫秒级的，从几毫秒到几百毫秒不等。</p>\n<p>这里有个真实的案例。某个公司 es 节点有 3 台机器，每台机器看起来内存很多，64G，总内存就是 <code class="language-text">64 * 3 = 192G</code>。每台机器给 es jvm heap 是 32G，那么剩下来留给 filesystem cache 的就是每台机器才 32G，总共集群里给 filesystem cache 的就是 <code class="language-text">32 * 3 = 96G</code> 内存。而此时，整个磁盘上索引数据文件，在 3 台机器上一共占用了 1T 的磁盘容量，es 数据量是 1T，那么每台机器的数据量是 300G。这样性能好吗？filesystem cache 的内存才 100G，十分之一的数据可以放内存，其他的都在磁盘，然后你执行搜索操作，大部分操作都是走磁盘，性能肯定差。</p>\n<p>归根结底，你要让 es 性能要好，最佳的情况下，就是你的机器的内存，至少可以容纳你的总数据量的一半。</p>\n<p>根据我们自己的生产环境实践经验，最佳的情况下，是仅仅在 es 中就存少量的数据，就是你要用来搜索的那些索引，如果内存留给 filesystem cache 的是 100G，那么你就将索引数据控制在 100G 以内，这样的话，你的数据几乎全部走内存来搜索，性能非常之高，一般可以在 1 秒以内。</p>\n<p>比如说你现在有一行数据。id,name,age… 30 个字段。但是你现在搜索，只需要根据 id,name,age 三个字段来搜索。如果你傻乎乎往 es 里写入一行数据所有的字段，就会导致说 90% 的数据是不用来搜索的，结果硬是占据了 es 机器上的 filesystem cache 的空间，单条数据的数据量越大，就会导致 filesystem cahce 能缓存的数据就越少。其实，仅仅写入 es 中要用来检索的少数几个字段就可以了，比如说就写入 es id,name,age 三个字段，然后你可以把其他的字段数据存在 mysql/hbase 里，我们一般是建议用 es + hbase 这么一个架构。</p>\n<p>hbase 的特点是适用于海量数据的在线存储，就是对 hbase 可以写入海量数据，但是不要做复杂的搜索，做很简单的一些根据 id 或者范围进行查询的这么一个操作就可以了。从 es 中根据 name 和 age 去搜索，拿到的结果可能就 20 个 doc id，然后根据 doc id 到 hbase 里去查询每个 doc id 对应的完整的数据，给查出来，再返回给前端。</p>\n<p>写入 es 的数据最好小于等于，或者是略微大于 es 的 filesystem cache 的内存容量。然后你从 es 检索可能就花费 20ms，然后再根据 es 返回的 id 去 hbase 里查询，查 20 条数据，可能也就耗费个 30ms，可能你原来那么玩儿，1T 数据都放 es，会每次查询都是 5~10s，现在可能性能就会很高，每次查询就是 50ms。</p>\n<h4 id="数据预热"><a href="#%E6%95%B0%E6%8D%AE%E9%A2%84%E7%83%AD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>数据预热</h4>\n<p>假如说，哪怕是你就按照上述的方案去做了，es 集群中每个机器写入的数据量还是超过了 filesystem cache 一倍，比如说你写入一台机器 60G 数据，结果 filesystem cache 就 30G，还是有 30G 数据留在了磁盘上。</p>\n<p>其实可以做数据预热。</p>\n<p>举个例子，拿微博来说，你可以把一些大 V，平时看的人很多的数据，你自己提前后台搞个系统，每隔一会儿，自己的后台系统去搜索一下热数据，刷到 filesystem cache 里去，后面用户实际上来看这个热数据的时候，他们就是直接从内存里搜索了，很快。</p>\n<p>或者是电商，你可以将平时查看最多的一些商品，比如说 iphone 8 热数据提前后台搞个程序，每隔 1 分钟自己主动访问一次，刷到 filesystem cache 里去。</p>\n<p>对于那些你觉得比较热的、经常会有人访问的数据，最好做一个专门的缓存预热子系统，就是对热数据每隔一段时间，就提前访问一下，让数据进入 filesystem cache 里面去。这样下次别人访问的时候，性能一定会好很多。</p>\n<h4 id="冷热分离"><a href="#%E5%86%B7%E7%83%AD%E5%88%86%E7%A6%BB" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>冷热分离</h4>\n<p>es 可以做类似于 mysql 的水平拆分，就是说将大量的访问很少、频率很低的数据，单独写一个索引，然后将访问很频繁的热数据单独写一个索引。最好是将冷数据写入一个索引中，然后热数据写入另外一个索引中，这样可以确保热数据在被预热之后，尽量都让他们留在 filesystem os cache 里，别让冷数据给冲刷掉。</p>\n<p>你看，假设你有 6 台机器，2 个索引，一个放冷数据，一个放热数据，每个索引 3 个 shard。3 台机器放热数据 index，另外 3 台机器放冷数据 index。然后这样的话，你大量的时间是在访问热数据 index，热数据可能就占总数据量的 10%，此时数据量很少，几乎全都保留在 filesystem cache 里面了，就可以确保热数据的访问性能是很高的。但是对于冷数据而言，是在别的 index 里的，跟热数据 index 不在相同的机器上，大家互相之间都没什么联系了。如果有人访问冷数据，可能大量数据是在磁盘上的，此时性能差点，就 10% 的人去访问冷数据，90% 的人在访问热数据，也无所谓了。</p>\n<h4 id="document-模型设计"><a href="#document-%E6%A8%A1%E5%9E%8B%E8%AE%BE%E8%AE%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>document 模型设计</h4>\n<p>对于 MySQL，我们经常有一些复杂的关联查询。在 es 里该怎么玩儿，es 里面的复杂的关联查询尽量别用，一旦用了性能一般都不太好。</p>\n<p>最好是先在 Java 系统里就完成关联，将关联好的数据直接写入 es 中。搜索的时候，就不需要利用 es 的搜索语法来完成 join 之类的关联搜索了。</p>\n<p>document 模型设计是非常重要的，很多操作，不要在搜索的时候才想去执行各种复杂的乱七八糟的操作。es 能支持的操作就那么多，不要考虑用 es 做一些它不好操作的事情。如果真的有那种操作，尽量在 document 模型设计的时候，写入的时候就完成。另外对于一些太复杂的操作，比如 join/nested/parent-child 搜索都要尽量避免，性能都很差的。</p>\n<h4 id="分页性能优化"><a href="#%E5%88%86%E9%A1%B5%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>分页性能优化</h4>\n<p>es 的分页是较坑的，为啥呢？举个例子吧，假如你每页是 10 条数据，你现在要查询第 100 页，实际上是会把每个 shard 上存储的前 1000 条数据都查到一个协调节点上，如果你有个 5 个 shard，那么就有 5000 条数据，接着协调节点对这 5000 条数据进行一些合并、处理，再获取到最终第 100 页的 10 条数据。</p>\n<p>分布式的，你要查第 100 页的 10 条数据，不可能说从 5 个 shard，每个 shard 就查 2 条数据，最后到协调节点合并成 10 条数据吧？你必须得从每个 shard 都查 1000 条数据过来，然后根据你的需求进行排序、筛选等等操作，最后再次分页，拿到里面第 100 页的数据。你翻页的时候，翻的越深，每个 shard 返回的数据就越多，而且协调节点处理的时间越长，非常坑爹。所以用 es 做分页的时候，你会发现越翻到后面，就越是慢。</p>\n<p>我们之前也是遇到过这个问题，用 es 作分页，前几页就几十毫秒，翻到 10 页或者几十页的时候，基本上就要 5~10 秒才能查出来一页数据了。</p>\n<p>有什么解决方案吗？</p>\n<h5 id="不允许深度分页（默认深度分页性能很差）"><a href="#%E4%B8%8D%E5%85%81%E8%AE%B8%E6%B7%B1%E5%BA%A6%E5%88%86%E9%A1%B5%EF%BC%88%E9%BB%98%E8%AE%A4%E6%B7%B1%E5%BA%A6%E5%88%86%E9%A1%B5%E6%80%A7%E8%83%BD%E5%BE%88%E5%B7%AE%EF%BC%89" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>不允许深度分页（默认深度分页性能很差）</h5>\n<p>跟产品经理说，你系统不允许翻那么深的页，默认翻的越深，性能就越差。</p>\n<h5 id="类似于-app-里的推荐商品不断下拉出来一页一页的"><a href="#%E7%B1%BB%E4%BC%BC%E4%BA%8E-app-%E9%87%8C%E7%9A%84%E6%8E%A8%E8%8D%90%E5%95%86%E5%93%81%E4%B8%8D%E6%96%AD%E4%B8%8B%E6%8B%89%E5%87%BA%E6%9D%A5%E4%B8%80%E9%A1%B5%E4%B8%80%E9%A1%B5%E7%9A%84" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>类似于 app 里的推荐商品不断下拉出来一页一页的</h5>\n<p>类似于微博中，下拉刷微博，刷出来一页一页的，你可以用 scroll api，关于如何使用，自行上网搜索。</p>\n<p>scroll 会一次性给你生成所有数据的一个快照，然后每次滑动向后翻页就是通过游标 <code class="language-text">scroll_id</code> 移动，获取下一页这样子，性能会比上面说的那种分页性能要高很多很多，基本上都是毫秒级的。</p>\n<p>但是，唯一的一点就是，这个适合于那种类似微博下拉翻页的，不能随意跳到任何一页的场景。也就是说，你不能先进入第 10 页，然后去第 120 页，然后又回到第 58 页，不能随意乱跳页。所以现在很多产品，都是不允许你随意翻页的，app，也有一些网站，做的就是你只能往下拉，一页一页的翻。</p>\n<p>初始化时必须指定 scroll 参数，告诉 es 要保存此次搜索的上下文多长时间。你需要确保用户不会持续不断翻页翻几个小时，否则可能因为超时而失败。</p>\n<p>除了用 scroll api，你也可以用 <code class="language-text">search_after</code> 来做，<code class="language-text">search_after</code> 的思想是使用前一页的结果来帮助检索下一页的数据，显然，这种方式也不允许你随意翻页，你只能一页页往后翻。初始化时，需要使用一个唯一值的字段作为 sort 字段。</p>\n<h3 id="es-生产集群的部署架构是什么？"><a href="#es-%E7%94%9F%E4%BA%A7%E9%9B%86%E7%BE%A4%E7%9A%84%E9%83%A8%E7%BD%B2%E6%9E%B6%E6%9E%84%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ES 生产集群的部署架构是什么？</h3>\n<ul>\n<li>es 生产集群我们部署了 5 台机器，每台机器是 6 核 64G 的，集群总内存是 320G。</li>\n<li>我们 es 集群的日增量数据大概是 2000 万条，每天日增量数据大概是 500MB，每月增量数据大概是 6 亿，15G。目前系统已经运行了几个月，现在 es 集群里数据总量大概是 100G 左右。</li>\n<li>目前线上有 5 个索引（这个结合你们自己业务来，看看自己有哪些数据可以放 es 的），每个索引的数据量大概是 20G，所以这个数据量之内，我们每个索引分配的是 8 个 shard，比默认的 5 个 shard 多了 3 个 shard。</li>\n</ul>\n<h2 id="缓存"><a href="#%E7%BC%93%E5%AD%98" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>缓存</h2>\n<h3 id="项目中缓存是如何使用的？"><a href="#%E9%A1%B9%E7%9B%AE%E4%B8%AD%E7%BC%93%E5%AD%98%E6%98%AF%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8%E7%9A%84%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>项目中缓存是如何使用的？</h3>\n<p>这个，需要结合自己项目的业务来。</p>\n<h4 id="为什么要用缓存？"><a href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E7%94%A8%E7%BC%93%E5%AD%98%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>为什么要用缓存？</h4>\n<p>用缓存，主要有两个用途：高性能、高并发。</p>\n<h5 id="高性能"><a href="#%E9%AB%98%E6%80%A7%E8%83%BD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>高性能</h5>\n<p>假设这么个场景，你有个操作，一个请求过来，吭哧吭哧你各种乱七八糟操作 mysql，半天查出来一个结果，耗时 600ms。但是这个结果可能接下来几个小时都不会变了，或者变了也可以不用立即反馈给用户。那么此时咋办？</p>\n<p>缓存啊，折腾 600ms 查出来的结果，扔缓存里，一个 key 对应一个 value，下次再有人查，别走 mysql 折腾 600ms 了，直接从缓存里，通过一个 key 查出来一个 value，2ms 搞定。性能提升 300 倍。</p>\n<p>就是说对于一些需要复杂操作耗时查出来的结果，且确定后面不怎么变化，但是有很多读请求，那么直接将查询出来的结果放在缓存中，后面直接读缓存就好。</p>\n<h4 id="高并发"><a href="#%E9%AB%98%E5%B9%B6%E5%8F%91" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>高并发</h4>\n<p>mysql 这么重的数据库，压根儿设计不是让你玩儿高并发的，虽然也可以玩儿，但是天然支持不好。mysql 单机支撑到 2000QPS 也开始容易报警了。</p>\n<p>所以要是你有个系统，高峰期一秒钟过来的请求有 1 万，那一个 mysql 单机绝对会死掉。你这个时候就只能上缓存，把很多数据放缓存，别放 mysql。缓存功能简单，说白了就是 key-value 式操作，单机支撑的并发量轻松一秒几万十几万，支撑高并发 so easy。单机承载并发量是 mysql 单机的几十倍。</p>\n<p>缓存是走内存的，内存天然就支撑高并发。</p>\n<h4 id="用了缓存之后会有什么不良后果？"><a href="#%E7%94%A8%E4%BA%86%E7%BC%93%E5%AD%98%E4%B9%8B%E5%90%8E%E4%BC%9A%E6%9C%89%E4%BB%80%E4%B9%88%E4%B8%8D%E8%89%AF%E5%90%8E%E6%9E%9C%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>用了缓存之后会有什么不良后果？</h4>\n<p>常见的缓存问题有以下几个：</p>\n<ul>\n<li>缓存与数据库双写不一致</li>\n<li>缓存雪崩、缓存穿透、缓存击穿</li>\n<li>缓存并发竞争</li>\n</ul>\n<h3 id="redis-和-memcached-有什么区别？"><a href="#redis-%E5%92%8C-memcached-%E6%9C%89%E4%BB%80%E4%B9%88%E5%8C%BA%E5%88%AB%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Redis 和 Memcached 有什么区别？</h3>\n<h4 id="区别"><a href="#%E5%8C%BA%E5%88%AB" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>区别</h4>\n<h5 id="redis-支持复杂的数据结构"><a href="#redis-%E6%94%AF%E6%8C%81%E5%A4%8D%E6%9D%82%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Redis 支持复杂的数据结构</h5>\n<p>Redis 相比 Memcached 来说，拥有更多的数据结构，能支持更丰富的数据操作。如果需要缓存能够支持更复杂的结构和操作，Redis 会是不错的选择。</p>\n<h5 id="redis-原生支持集群模式"><a href="#redis-%E5%8E%9F%E7%94%9F%E6%94%AF%E6%8C%81%E9%9B%86%E7%BE%A4%E6%A8%A1%E5%BC%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Redis 原生支持集群模式</h5>\n<p>在 Redis3.x 版本中，便能支持 cluster 模式，而 Memcached 没有原生的集群模式，需要依靠客户端来实现往集群中分片写入数据。</p>\n<h4 id="性能对比"><a href="#%E6%80%A7%E8%83%BD%E5%AF%B9%E6%AF%94" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>性能对比</h4>\n<p>由于 Redis 只使用单核，而 Memcached 可以使用多核，所以平均每一个核上 Redis 在存储小数据时比 Memcached 性能更高。而在 100k 以上的数据中，Memcached 性能要高于 Redis。虽然 Redis 最近也在存储大数据的性能上进行优化，但是比起 Memcached，还是稍有逊色。</p>\n<h4 id="redis-的线程模型"><a href="#redis-%E7%9A%84%E7%BA%BF%E7%A8%8B%E6%A8%A1%E5%9E%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Redis 的线程模型</h4>\n<p>Redis 内部使用文件事件处理器 file event handler，这个文件事件处理器是单线程的，所以 Redis 才叫做单线程的模型。它采用 IO 多路复用机制同时监听多个 socket，将产生事件的 socket 压入内存队列中，事件分派器根据 socket 上的事件类型来选择对应的事件处理器进行处理。</p>\n<p>文件事件处理器的结构包含 4 个部分：</p>\n<ul>\n<li>多个 socket</li>\n<li>IO 多路复用程序</li>\n<li>文件事件分派器</li>\n<li>事件处理器（连接应答处理器、命令请求处理器、命令回复处理器）</li>\n</ul>\n<p>多个 socket 可能会并发产生不同的操作，每个操作对应不同的文件事件，但是 IO 多路复用程序会监听多个 socket，会将产生事件的 socket 放入队列中排队，事件分派器每次从队列中取出一个 socket，根据 socket 的事件类型交给对应的事件处理器进行处理。</p>\n<p>来看客户端与 Redis 的一次通信过程：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-09-18-11-28-38-1fea796f263f42bdf7c25f8599b536ea-d55d3.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 50.992555831265506%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAAsSAAALEgHS3X78AAABMklEQVQoz22Rx27DMBBE+f9/Z0ENVm9Wj6oTK2p5JqGDgcyBWIqzO7MjcRzHvu/LsjwlxnEchuFLguuPRJ7nZVlSfH9C0DnPM9Q4jqMoCoKg67pIguZfiVMCGVXsF0TTNGpw27bIcqKQpqmu61mW8eS6ru/70KZpqusawnlBIMgbtlHACZ24ME3TMIyiKKA+Hg8IOEqSxLIsZh0S7+Z1XbFNRUEzVrnCvt/vnEjBcxwHL6xzu92YWFWVpmkw3zvzlTc+ERWF0sGRbdtIsTyFcseVAg0KOALN1+ulBCmUcxjqhIQF9RELTCcXWljtnTYVW4VhyDLwGLFtG29ERWDKAvA8D31Omvu+h8YscX6CeSTXXqgu8DsInAVVLlj4vxllZqNGvEiRFie+8EIijGA6+xPWH569LZLhi7LkAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 09 18 11 28 38" title="" data-src="/static/2023-09-18-11-28-38-1fea796f263f42bdf7c25f8599b536ea-fee1c.png" data-srcset="/static/2023-09-18-11-28-38-1fea796f263f42bdf7c25f8599b536ea-a67b7.png 200w,\n/static/2023-09-18-11-28-38-1fea796f263f42bdf7c25f8599b536ea-0b187.png 400w,\n/static/2023-09-18-11-28-38-1fea796f263f42bdf7c25f8599b536ea-fee1c.png 800w,\n/static/2023-09-18-11-28-38-1fea796f263f42bdf7c25f8599b536ea-d55d3.png 806w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>要明白，通信是通过 socket 来完成的，不懂的同学可以先去看一看 socket 网络编程。</p>\n<p>首先，Redis 服务端进程初始化的时候，会将 server socket 的 <code class="language-text">AE_READABLE</code> 事件与连接应答处理器关联。</p>\n<p>客户端 socket01 向 Redis 进程的 server socket 请求建立连接，此时 server socket 会产生一个 <code class="language-text">AE_READABLE</code> 事件，IO 多路复用程序监听到 server socket 产生的事件后，将该 socket 压入队列中。文件事件分派器从队列中获取 socket，交给连接应答处理器。连接应答处理器会创建一个能与客户端通信的 socket01，并将该 socket01 的 <code class="language-text">AE_READABLE</code> 事件与命令请求处理器关联。</p>\n<p>假设此时客户端发送了一个 set key value 请求，此时 Redis 中的 socket01 会产生 <code class="language-text">AE_READABLE</code> 事件，IO 多路复用程序将 socket01 压入队列，此时事件分派器从队列中获取到 socket01 产生的 <code class="language-text">AE_READABLE</code> 事件，由于前面 socket01 的 <code class="language-text">AE_READABLE</code> 事件已经与命令请求处理器关联，因此事件分派器将事件交给命令请求处理器来处理。命令请求处理器读取 socket01 的 key value 并在自己内存中完成 key value 的设置。操作完成后，它会将 socket01 的 <code class="language-text">AE_WRITABLE</code> 事件与命令回复处理器关联。</p>\n<p>如果此时客户端准备好接收返回结果了，那么 Redis 中的 socket01 会产生一个 <code class="language-text">AE_WRITABLE</code> 事件，同样压入队列中，事件分派器找到相关联的命令回复处理器，由命令回复处理器对 socket01 输入本次操作的一个结果，比如 ok，之后解除 socket01 的 <code class="language-text">AE_WRITABLE</code> 事件与命令回复处理器的关联。</p>\n<p>这样便完成了一次通信。关于 Redis 的一次通信过程，推荐读者阅读 <a href="https://github.com/doocs/technical-books#database" target="_blank" rel="nofollow noreferrer noopener">Redis 设计与实现——黄健宏</a> 进行系统学习。</p>\n<h4 id="为啥-redis-单线程模型也能效率这么高？"><a href="#%E4%B8%BA%E5%95%A5-redis-%E5%8D%95%E7%BA%BF%E7%A8%8B%E6%A8%A1%E5%9E%8B%E4%B9%9F%E8%83%BD%E6%95%88%E7%8E%87%E8%BF%99%E4%B9%88%E9%AB%98%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>为啥 Redis 单线程模型也能效率这么高？</h4>\n<ul>\n<li>纯内存操作。</li>\n<li>核心是基于非阻塞的 IO 多路复用机制。</li>\n<li>C 语言实现，一般来说，C 语言实现的程序距离操作系统更近，执行速度相对会更快。</li>\n<li>单线程反而避免了多线程的频繁上下文切换问题，预防了多线程可能产生的竞争问题。</li>\n</ul>\n<h4 id="redis-60-开始引入多线程"><a href="#redis-60-%E5%BC%80%E5%A7%8B%E5%BC%95%E5%85%A5%E5%A4%9A%E7%BA%BF%E7%A8%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Redis 6.0 开始引入多线程</h4>\n<p>注意！Redis 6.0 之后的版本抛弃了单线程模型这一设计，原本使用单线程运行的 Redis 也开始选择性地使用多线程模型。</p>\n<p>前面还在强调 Redis 单线程模型的高效性，现在为什么又要引入多线程？这其实说明 Redis 在有些方面，单线程已经不具有优势了。因为读写网络的 Read/Write 系统调用在 Redis 执行期间占用了大部分 CPU 时间，如果把网络读写做成多线程的方式对性能会有很大提升。</p>\n<p>Redis 的多线程部分只是用来处理网络数据的读写和协议解析，执行命令仍然是单线程。之所以这么设计是不想 Redis 因为多线程而变得复杂，需要去控制 key、lua、事务、LPUSH/LPOP 等等的并发问题。</p>\n<h4 id="总结"><a href="#%E6%80%BB%E7%BB%93" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h4>\n<p>Redis 选择使用单线程模型处理客户端的请求主要还是因为 CPU 不是 Redis 服务器的瓶颈，所以使用多线程模型带来的性能提升并不能抵消它带来的开发成本和维护成本，系统的性能瓶颈也主要在网络 I/O 操作上；而 Redis 引入多线程操作也是出于性能上的考虑，对于一些大键值对的删除操作，通过多线程非阻塞地释放内存空间(释放操作不会阻塞网络 IO 读写,因为网络 IO 读写与释放的命令执行不是同一个线程)也能减少对 Redis 主线程阻塞的时间，提高执行的效率。</p>\n<h3 id="redis-都有哪些数据类型及适用场景？"><a href="#redis-%E9%83%BD%E6%9C%89%E5%93%AA%E4%BA%9B%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E5%8F%8A%E9%80%82%E7%94%A8%E5%9C%BA%E6%99%AF%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Redis 都有哪些数据类型及适用场景？</h3>\n<p>Redis 主要有以下几种数据类型：</p>\n<ul>\n<li>Strings</li>\n<li>Hashes</li>\n<li>Lists</li>\n<li>Sets</li>\n<li>Sorted Sets</li>\n</ul>\n<blockquote>\n<p>Redis 除了这 5 种数据类型之外，还有 Bitmaps、HyperLogLogs、Streams 等。</p>\n</blockquote>\n<h4 id="strings"><a href="#strings" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Strings</h4>\n<p>这是最简单的类型，就是普通的 set 和 get，做简单的 KV 缓存。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="76408751712691630000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`set college szu`, `76408751712691630000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token builtin class-name">set</span> college szu</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h4 id="hashes"><a href="#hashes" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Hashes</h4>\n<p>这个是类似 map 的一种结构，这个一般就是可以将结构化的数据，比如一个对象（前提是这个对象没嵌套其他的对象）给缓存在 Redis 里，然后每次读写缓存的时候，可以就操作 hash 里的某个字段。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="67191644521476520000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`hset person name bingo\nhset person age 20\nhset person id 1\nhget person name`, `67191644521476520000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">hset person name bingo\nhset person age <span class="token number">20</span>\nhset person <span class="token function">id</span> <span class="token number">1</span>\nhget person name</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="67075702151970185000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(person = {\n   &quot;name&quot;: &quot;bingo&quot;,\n   &quot;age&quot;: 20,\n   &quot;id&quot;: 1\n})`, `67075702151970185000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="json"\n              >\n                <span class="gatsby-code-button-language">json</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="json"><pre style="counter-reset: linenumber NaN" class="language-json line-numbers"><code class="language-json">(person = <span class="token punctuation">{</span>\n   <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"bingo"</span><span class="token punctuation">,</span>\n   <span class="token property">"age"</span><span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span>\n   <span class="token property">"id"</span><span class="token operator">:</span> <span class="token number">1</span>\n<span class="token punctuation">}</span>)</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="lists"><a href="#lists" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Lists</h4>\n<p>Lists 是有序列表，这个可以玩儿出很多花样。</p>\n<p>比如可以通过 list 存储一些列表型的数据结构，类似粉丝列表、文章的评论列表之类的东西。</p>\n<p>比如可以通过 lrange 命令，读取某个闭区间内的元素，可以基于 list 实现分页查询，这个是很棒的一个功能，基于 Redis 实现简单的高性能分页，可以做类似微博那种下拉不断分页的东西，性能高，就一页一页走。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="7072994565911439000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# 0 开始位置，-1 结束位置，结束位置为 -1 时，表示列表的最后一个位置，即查看所有。\nlrange mylist 0 -1`, `7072994565911439000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token comment"># 0 开始位置，-1 结束位置，结束位置为 -1 时，表示列表的最后一个位置，即查看所有。</span>\nlrange mylist <span class="token number">0</span> -1</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>比如可以搞个简单的消息队列，从 list 头怼进去，从 list 尾巴那里弄出来。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="5964316773235722000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`lpush mylist 1\nlpush mylist 2\nlpush mylist 3 4 5\n\n# 1\nrpop mylist`, `5964316773235722000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">lpush mylist <span class="token number">1</span>\nlpush mylist <span class="token number">2</span>\nlpush mylist <span class="token number">3</span> <span class="token number">4</span> <span class="token number">5</span>\n\n<span class="token comment"># 1</span>\nrpop mylist</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="sets"><a href="#sets" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Sets</h4>\n<p>Sets 是无序集合，自动去重。</p>\n<p>直接基于 set 将系统里需要去重的数据扔进去，自动就给去重了，如果你需要对一些数据进行快速的全局去重，你当然也可以基于 jvm 内存里的 HashSet 进行去重，但是如果你的某个系统部署在多台机器上呢？得基于 Redis 进行全局的 set 去重。</p>\n<p>可以基于 set 玩儿交集、并集、差集的操作，比如交集吧，可以把两个人的粉丝列表整一个交集，看看俩人的共同好友是谁？对吧。</p>\n<p>把两个大 V 的粉丝都放在两个 set 中，对两个 set 做交集。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="57613832091400230000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`#-------操作一个 set-------\n# 添加元素\nsadd mySet 1\n\n# 查看全部元素\nsmembers mySet\n\n# 判断是否包含某个值\nsismember mySet 3\n\n# 删除某些元素\nsrem mySet 1\nsrem mySet 2 4\n\n# 查看元素个数\nscard mySet\n\n# 随机删除一个元素\nspop mySet\n\n#-------操作多个 set-------\n# 将一个 set 的元素移动到另外一个 set\nsmove yourSet mySet 2\n\n# 求两 set 的交集\nsinter yourSet mySet\n\n# 求两 set 的并集\nsunion yourSet mySet\n\n# 求在 yourSet 中而不在 mySet 中的元素\nsdiff yourSet mySet`, `57613832091400230000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token comment">#-------操作一个 set-------</span>\n<span class="token comment"># 添加元素</span>\nsadd mySet <span class="token number">1</span>\n\n<span class="token comment"># 查看全部元素</span>\nsmembers mySet\n\n<span class="token comment"># 判断是否包含某个值</span>\nsismember mySet <span class="token number">3</span>\n\n<span class="token comment"># 删除某些元素</span>\nsrem mySet <span class="token number">1</span>\nsrem mySet <span class="token number">2</span> <span class="token number">4</span>\n\n<span class="token comment"># 查看元素个数</span>\nscard mySet\n\n<span class="token comment"># 随机删除一个元素</span>\nspop mySet\n\n<span class="token comment">#-------操作多个 set-------</span>\n<span class="token comment"># 将一个 set 的元素移动到另外一个 set</span>\nsmove yourSet mySet <span class="token number">2</span>\n\n<span class="token comment"># 求两 set 的交集</span>\nsinter yourSet mySet\n\n<span class="token comment"># 求两 set 的并集</span>\nsunion yourSet mySet\n\n<span class="token comment"># 求在 yourSet 中而不在 mySet 中的元素</span>\n<span class="token function">sdiff</span> yourSet mySet</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="sorted-sets"><a href="#sorted-sets" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Sorted Sets</h4>\n<p>Sorted Sets 是排序的 set，去重但可以排序，写进去的时候给一个分数，自动根据分数排序。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="29343405020262380000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`zadd board 85 zhangsan\nzadd board 72 lisi\nzadd board 96 wangwu\nzadd board 63 zhaoliu\n\n# 获取排名前三的用户（默认是升序，所以需要 rev 改为降序）\nzrevrange board 0 3\n\n# 获取某用户的排名\nzrank board zhaoliu`, `29343405020262380000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">zadd board <span class="token number">85</span> zhangsan\nzadd board <span class="token number">72</span> lisi\nzadd board <span class="token number">96</span> wangwu\nzadd board <span class="token number">63</span> zhaoliu\n\n<span class="token comment"># 获取排名前三的用户（默认是升序，所以需要 rev 改为降序）</span>\nzrevrange board <span class="token number">0</span> <span class="token number">3</span>\n\n<span class="token comment"># 获取某用户的排名</span>\nzrank board zhaoliu</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="redis-的过期策略都有哪些？"><a href="#redis-%E7%9A%84%E8%BF%87%E6%9C%9F%E7%AD%96%E7%95%A5%E9%83%BD%E6%9C%89%E5%93%AA%E4%BA%9B%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Redis 的过期策略都有哪些？</h3>\n<h4 id="redis-过期策略"><a href="#redis-%E8%BF%87%E6%9C%9F%E7%AD%96%E7%95%A5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Redis 过期策略</h4>\n<p>Redis 过期策略是：定期删除 + 惰性删除。</p>\n<p>所谓定期删除，指的是 Redis 默认是每隔 100ms 就随机抽取一些设置了过期时间的 key，检查其是否过期，如果过期就删除。</p>\n<p>假设 Redis 里放了 10w 个 key，都设置了过期时间，你每隔几百毫秒，就检查 10w 个 key，那 Redis 基本上就死了，cpu 负载会很高的，消耗在你的检查过期 key 上了。注意，这里可不是每隔 100ms 就遍历所有的设置过期时间的 key，那样就是一场性能上的灾难。实际上 Redis 是每隔 100ms 随机抽取一些 key 来检查和删除的。</p>\n<p>但是问题是，定期删除可能会导致很多过期 key 到了时间并没有被删除掉，那咋整呢？所以就是惰性删除了。这就是说，在你获取某个 key 的时候，Redis 会检查一下，这个 key 如果设置了过期时间那么是否过期了？如果过期了此时就会删除，不会给你返回任何东西。</p>\n<blockquote>\n<p>获取 key 的时候，如果此时 key 已经过期，就删除，不会返回任何东西。</p>\n</blockquote>\n<p>但是实际上这还是有问题的，如果定期删除漏掉了很多过期 key，然后你也没及时去查，也就没走惰性删除，此时会怎么样？如果大量过期 key 堆积在内存里，导致 Redis 内存块耗尽了，咋整？</p>\n<p>答案是：走内存淘汰机制。</p>\n<h4 id="内存淘汰机制"><a href="#%E5%86%85%E5%AD%98%E6%B7%98%E6%B1%B0%E6%9C%BA%E5%88%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>内存淘汰机制</h4>\n<p>Redis 内存淘汰机制有以下几个：</p>\n<ul>\n<li>noeviction: 当内存不足以容纳新写入数据时，新写入操作会报错，这个一般没人用吧，实在是太恶心了。</li>\n<li>allkeys-lru：当内存不足以容纳新写入数据时，在键空间中，移除最近最少使用的 key（这个是最常用的）。</li>\n<li>allkeys-random：当内存不足以容纳新写入数据时，在键空间中，随机移除某个 key，这个一般没人用吧，为啥要随机，肯定是把最近最少使用的 key 给干掉啊。</li>\n<li>volatile-lru：当内存不足以容纳新写入数据时，在设置了过期时间的键空间中，移除最近最少使用的 key（这个一般不太合适）。</li>\n<li>volatile-random：当内存不足以容纳新写入数据时，在设置了过期时间的键空间中，随机移除某个 key。</li>\n<li>volatile-ttl：当内存不足以容纳新写入数据时，在设置了过期时间的键空间中，有更早过期时间的 key 优先移除。</li>\n</ul>\n<h4 id="手写一个-lru-算法"><a href="#%E6%89%8B%E5%86%99%E4%B8%80%E4%B8%AA-lru-%E7%AE%97%E6%B3%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>手写一个 LRU 算法</h4>\n<p>LRU 就是 Least Recently Used 的缩写，翻译过来就是“最近最少使用”。也就是说 LRU 算法会将最近最少用的缓存移除，让给最新使用的缓存。而往往最常读取的，也就是读取次数最多的，所以利用好 LRU 算法，我们能够提供对热点数据的缓存效率，能够提高缓存服务的内存使用率。</p>\n<p>不求自己纯手工从底层开始打造出自己的 LRU，但是起码要知道如何利用已有的 JDK 数据结构实现一个 Java 版的 LRU。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="42797872934732230000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public class LRUCache<K, V> extends LinkedHashMap<K, V> {\n    private int capacity;\n\n    /**\n     * 传递进来最多能缓存多少数据\n     *\n     * @param capacity 缓存大小\n     */\n    public LRUCache(int capacity) {\n        super(capacity, 0.75f, true);\n        this.capacity = capacity;\n    }\n\n    /**\n     * 如果 map 中的数据量大于设定的最大容量，返回 true，在新加入对象时删除最老的数据\n     *\n     * @param eldest 最老的数据项\n     * @return true 则移除最老的数据\n     */\n    @Override\n    protected boolean removeEldestEntry(Map.Entry<K, V> eldest) {\n        // 当 map 中的数据量大于指定的缓存个数的时候，自动移除最老的数据\n        return size() > capacity;\n    }\n}`, `42797872934732230000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LRUCache</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">></span></span> <span class="token keyword">extends</span> <span class="token class-name">LinkedHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">></span></span> <span class="token punctuation">{</span>\n    <span class="token keyword">private</span> <span class="token keyword">int</span> capacity<span class="token punctuation">;</span>\n\n    <span class="token comment">/**\n     * 传递进来最多能缓存多少数据\n     *\n     * @param capacity 缓存大小\n     */</span>\n    <span class="token keyword">public</span> <span class="token class-name">LRUCache</span><span class="token punctuation">(</span><span class="token keyword">int</span> capacity<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">super</span><span class="token punctuation">(</span>capacity<span class="token punctuation">,</span> <span class="token number">0.75f</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">this</span><span class="token punctuation">.</span>capacity <span class="token operator">=</span> capacity<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token comment">/**\n     * 如果 map 中的数据量大于设定的最大容量，返回 true，在新加入对象时删除最老的数据\n     *\n     * @param eldest 最老的数据项\n     * @return true 则移除最老的数据\n     */</span>\n    <span class="token annotation punctuation">@Override</span>\n    <span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">removeEldestEntry</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">></span></span> eldest<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token comment">// 当 map 中的数据量大于指定的缓存个数的时候，自动移除最老的数据</span>\n        <span class="token keyword">return</span> <span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> capacity<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="如何保证-redis-的高并发和高可用？"><a href="#%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81-redis-%E7%9A%84%E9%AB%98%E5%B9%B6%E5%8F%91%E5%92%8C%E9%AB%98%E5%8F%AF%E7%94%A8%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>如何保证 redis 的高并发和高可用？</h3>\n<p>redis 实现高并发主要依靠主从架构，一主多从，一般来说，很多项目其实就足够了，单主用来写入数据，单机几万 QPS，多从用来查询数据，多个从实例可以提供每秒 10w 的 QPS。</p>\n<p>如果想要在实现高并发的同时，容纳大量的数据，那么就需要 redis 集群，使用 redis 集群之后，可以提供每秒几十万的读写并发。</p>\n<p>redis 高可用，如果是做主从架构部署，那么加上哨兵就可以了，就可以实现任何一个实例宕机就进行主备切换。</p>\n<h3 id="redis-主从架构是怎样的？"><a href="#redis-%E4%B8%BB%E4%BB%8E%E6%9E%B6%E6%9E%84%E6%98%AF%E6%80%8E%E6%A0%B7%E7%9A%84%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Redis 主从架构是怎样的？</h3>\n<p>单机的 Redis，能够承载的 QPS 大概就在上万到几万不等。对于缓存来说，一般都是用来支撑读高并发的。因此架构做成主从（master-slave）架构，一主多从，主负责写，并且将数据复制到其它的 slave 节点，从节点负责读。所有的读请求全部走从节点。这样也可以很轻松实现水平扩容，支撑读高并发。</p>\n<p>Redis replication -> 主从架构 -> 读写分离 -> 水平扩容支撑读高并发</p>\n<h4 id="redis-replication-的核心机制"><a href="#redis-replication-%E7%9A%84%E6%A0%B8%E5%BF%83%E6%9C%BA%E5%88%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Redis replication 的核心机制</h4>\n<ul>\n<li>Redis 采用异步方式复制数据到 slave 节点，不过 Redis2.8 开始，slave node 会周期性地确认自己每次复制的数据量；</li>\n<li>一个 master node 是可以配置多个 slave node 的；</li>\n<li>slave node 也可以连接其他的 slave node；</li>\n<li>slave node 做复制的时候，不会 block master node 的正常工作；</li>\n<li>slave node 在做复制的时候，也不会 block 对自己的查询操作，它会用旧的数据集来提供服务；但是复制完成的时候，需要删除旧数据集，加载新数据集，这个时候就会暂停对外服务了；</li>\n<li>slave node 主要用来进行横向扩容，做读写分离，扩容的 slave node 可以提高读的吞吐量。</li>\n</ul>\n<p>注意，如果采用了主从架构，那么建议必须开启 master node 的持久化，不建议用 slave node 作为 master node 的数据热备，因为那样的话，如果你关掉 master 的持久化，可能在 master 宕机重启的时候数据是空的，然后可能一经过复制，slave node 的数据也丢了。</p>\n<p>另外，master 的各种备份方案，也需要做。万一本地的所有文件丢失了，从备份中挑选一份 rdb 去恢复 master，这样才能确保启动的时候，是有数据的，即使采用了后续讲解的高可用机制，slave node 可以自动接管 master node，但也可能 sentinel 还没检测到 master failure，master node 就自动重启了，还是可能导致上面所有的 slave node 数据被清空。</p>\n<h4 id="redis-主从复制的核心原理"><a href="#redis-%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E7%9A%84%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Redis 主从复制的核心原理</h4>\n<p>当启动一个 slave node 的时候，它会发送一个 PSYNC 命令给 master node。</p>\n<p>如果这是 slave node 初次连接到 master node，那么会触发一次 full resynchronization 全量复制。此时 master 会启动一个后台线程，开始生成一份 RDB 快照文件，同时还会将从客户端 client 新收到的所有写命令缓存在内存中。RDB 文件生成完毕后，master 会将这个 RDB 发送给 slave，slave 会先写入本地磁盘，然后再从本地磁盘加载到内存中，接着 master 会将内存中缓存的写命令发送到 slave，slave 也会同步这些数据。slave node 如果跟 master node 有网络故障，断开了连接，会自动重连，连接之后 master node 仅会复制给 slave 部分缺少的数据。</p>\n<div class="mermaid">flowchart LR\n    RDB --> slave\n    master --> RDB\n    master --> |"初次连接：全量复制"| slave\n    master --> |"重新连接：部分数据复制"| slave\n    slave --> |ping| master\n    slave --> |写入| 磁盘["磁盘（RDB持久化）"]\n    磁盘 --> |加载到内存| slave</div>\n<h5 id="主从复制的断点续传"><a href="#%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E7%9A%84%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>主从复制的断点续传</h5>\n<p>从 Redis2.8 开始，就支持主从复制的断点续传，如果主从复制过程中，网络连接断掉了，那么可以接着上次复制的地方，继续复制下去，而不是从头开始复制一份。</p>\n<p>master node 会在内存中维护一个 backlog，master 和 slave 都会保存一个 replica offset 还有一个 master run id，offset 就是保存在 backlog 中的。如果 master 和 slave 网络连接断掉了，slave 会让 master 从上次 replica offset 开始继续复制，如果没有找到对应的 offset，那么就会执行一次 resynchronization。</p>\n<blockquote>\n<p>如果根据 host + ip 定位 master node，是不靠谱的，如果 master node 重启或者数据出现了变化，那么 slave node 应该根据不同的 run id 区分。</p>\n</blockquote>\n<h5 id="无磁盘化复制"><a href="#%E6%97%A0%E7%A3%81%E7%9B%98%E5%8C%96%E5%A4%8D%E5%88%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>无磁盘化复制</h5>\n<p>master 在内存中直接创建 RDB，然后发送给 slave，不会在自己本地落地磁盘了。只需要在配置文件中开启 repl-diskless-sync yes 即可。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="32412764959622840000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`repl-diskless-sync yes\n\n# 等待 5s 后再开始复制，因为要等更多 slave 重新连接过来\nrepl-diskless-sync-delay 5`, `32412764959622840000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">repl-diskless-sync <span class="token function">yes</span>\n\n<span class="token comment"># 等待 5s 后再开始复制，因为要等更多 slave 重新连接过来</span>\nrepl-diskless-sync-delay <span class="token number">5</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<h5 id="过期-key-处理"><a href="#%E8%BF%87%E6%9C%9F-key-%E5%A4%84%E7%90%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>过期 key 处理</h5>\n<p>slave 不会过期 key，只会等待 master 过期 key。如果 master 过期了一个 key，或者通过 LRU 淘汰了一个 key，那么会模拟一条 del 命令发送给 slave。</p>\n<h4 id="复制的完整流程"><a href="#%E5%A4%8D%E5%88%B6%E7%9A%84%E5%AE%8C%E6%95%B4%E6%B5%81%E7%A8%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>复制的完整流程</h4>\n<p>slave node 启动时，会在自己本地保存 master node 的信息，包括 master node 的 host 和 ip，但是复制流程没开始。</p>\n<p>slave node 内部有个定时任务，每秒检查是否有新的 master node 要连接和复制，如果发现，就跟 master node 建立 socket 网络连接。然后 slave node 发送 ping 命令给 master node。如果 master 设置了 requirepass，那么 slave node 必须发送 masterauth 的口令过去进行认证。master node 第一次执行全量复制，将所有数据发给 slave node。而在后续，master node 持续将写命令，异步复制给 slave node。</p>\n<div class="mermaid">flowchart LR\n    client --> master["master\\n5. 每次 master 接收到新的数据，都异步发送给 slave node"]\n    master -- "4. master 启动全量复制，\\n将自己的所有数据都发送给 slave，\\n实现数据的同步" --> slave\n    slave -- "socket 网络连接\\n3. 如果 master 配置了 require pass，\\n那么 slave node 会发送 master auth 口令去认证" --> master\n    slave["slave\\n1. slave 启动，在本地保存 master node 的 host 和 ip\\n2. slave 内部有定时任务，每秒会 check 是否有 master 要连接，\\n如果有就跟 master 建立 socket 网络来连接"]</div>\n<h5 id="全量复制"><a href="#%E5%85%A8%E9%87%8F%E5%A4%8D%E5%88%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>全量复制</h5>\n<ul>\n<li>\n<p>master 执行 bgsave，在本地生成一份 rdb 快照文件。</p>\n</li>\n<li>\n<p>master node 将 rdb 快照文件发送给 slave node，如果 rdb 复制时间超过 60 秒（repl-timeout），那么 slave node 就会认为复制失败，可以适当调大这个参数（对于千兆网卡的机器，一般每秒传输 100MB，6G 文件，很可能超过 60s）</p>\n</li>\n<li>\n<p>master node 在生成 rdb 时，会将所有新的写命令缓存在内存中，在 slave node 保存了 rdb 之后，再将新的写命令复制给 slave node。</p>\n</li>\n<li>\n<p>如果在复制期间，内存缓冲区持续消耗超过 64MB，或者一次性超过 256MB，那么停止复制，复制失败。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="58373131716499290000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`client-output-buffer-limit slave 256MB 64MB 60`, `58373131716499290000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">client-output-buffer-limit slave 256MB 64MB <span class="token number">60</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n</li>\n<li>\n<p>slave node 接收到 rdb 之后，清空自己的旧数据，然后重新加载 rdb 到自己的内存中。注意，在清空旧数据之前，slave node 依然会基于旧的数据版本对外提供服务。</p>\n</li>\n<li>\n<p>如果 slave node 开启了 AOF，那么会立即执行 BGREWRITEAOF，重写 AOF。</p>\n</li>\n</ul>\n<h5 id="增量复制"><a href="#%E5%A2%9E%E9%87%8F%E5%A4%8D%E5%88%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>增量复制</h5>\n<ul>\n<li>如果全量复制过程中，master-slave 网络连接断掉，那么 slave 重新连接 master 时，会触发增量复制。</li>\n<li>master 直接从自己的 backlog 中获取部分丢失的数据，发送给 slave node，默认 backlog 就是 1MB。</li>\n<li>master 就是根据 slave 发送的 psync 中的 offset 来从 backlog 中获取数据的。</li>\n</ul>\n<h5 id="heartbeat"><a href="#heartbeat" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>heartbeat</h5>\n<p>主从节点互相都会发送 heartbeat 信息。</p>\n<p>master 默认每隔 10 秒发送一次 heartbeat，slave node 每隔 1 秒发送一个 heartbeat。</p>\n<h5 id="异步复制"><a href="#%E5%BC%82%E6%AD%A5%E5%A4%8D%E5%88%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>异步复制</h5>\n<p>master 每次接收到写命令之后，先在内部写入数据，然后异步发送给 slave node。</p>\n<h4 id="redis-如何才能做到高可用"><a href="#redis-%E5%A6%82%E4%BD%95%E6%89%8D%E8%83%BD%E5%81%9A%E5%88%B0%E9%AB%98%E5%8F%AF%E7%94%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Redis 如何才能做到高可用</h4>\n<p>如果系统在 365 天内，有 99.99% 的时间，都是可以对外提供服务的，那么就说系统是高可用的。</p>\n<p>一个 slave 挂掉了，是不会影响可用性的，还有其它的 slave 在提供相同数据下的相同的对外的查询服务。</p>\n<p>但是，如果 master node 死掉了，会怎么样？没法写数据了，写缓存的时候，全部失效了。slave node 还有什么用呢，没有 master 给它们复制数据了，系统相当于不可用了。</p>\n<p>Redis 的高可用架构，叫做 failover 故障转移，也可以叫做主备切换。</p>\n<p>master node 在故障时自动检测，并且将某个 slave node 自动切换为 master node 的过程，叫做主备切换。这个过程，实现了 Redis 的主从架构下的高可用。</p>\n<h3 id="redis-的持久化有哪几种方式？"><a href="#redis-%E7%9A%84%E6%8C%81%E4%B9%85%E5%8C%96%E6%9C%89%E5%93%AA%E5%87%A0%E7%A7%8D%E6%96%B9%E5%BC%8F%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Redis 的持久化有哪几种方式？</h3>\n<p>持久化主要是做灾难恢复、数据恢复，也可以归类到高可用的一个环节中去，比如 Redis 整个挂了，然后 Redis 就不可用了，你要做的事情就是让 Redis 变得可用，尽快变得可用。</p>\n<p>重启 Redis，尽快让它对外提供服务，如果没做数据备份，这时候 Redis 启动了，也不可用啊，数据都没了。</p>\n<p>很可能说，大量的请求过来，缓存全部无法命中，在 Redis 里根本找不到数据，这个时候就死定了，出现缓存雪崩问题。所有请求没有在 Redis 命中，就会去 mysql 数据库这种数据源头中去找，一下子 mysql 承接高并发，然后就挂了。</p>\n<p>如果你把 Redis 持久化做好，备份和恢复方案做到企业级的程度，那么即使你的 Redis 故障了，也可以通过备份数据，快速恢复，一旦恢复立即对外提供服务。</p>\n<h4 id="redis-持久化的两种方式"><a href="#redis-%E6%8C%81%E4%B9%85%E5%8C%96%E7%9A%84%E4%B8%A4%E7%A7%8D%E6%96%B9%E5%BC%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Redis 持久化的两种方式</h4>\n<ul>\n<li>RDB：RDB 持久化机制，是对 Redis 中的数据执行周期性的持久化。</li>\n<li>AOF：AOF 机制对每条写入命令作为日志，以 append-only 的模式写入一个日志文件中，在 Redis 重启的时候，可以通过回放 AOF 日志中的写入指令来重新构建整个数据集。</li>\n</ul>\n<p>通过 RDB 或 AOF，都可以将 Redis 内存中的数据给持久化到磁盘上面来，然后可以将这些数据备份到别的地方去，比如说阿里云等云服务。</p>\n<p>如果 Redis 挂了，服务器上的内存和磁盘上的数据都丢了，可以从云服务上拷贝回来之前的数据，放到指定的目录中，然后重新启动 Redis，Redis 就会自动根据持久化数据文件中的数据，去恢复内存中的数据，继续对外提供服务。</p>\n<p>如果同时使用 RDB 和 AOF 两种持久化机制，那么在 Redis 重启的时候，会使用 AOF 来重新构建数据，因为 AOF 中的数据更加完整。</p>\n<h5 id="rdb-优缺点"><a href="#rdb-%E4%BC%98%E7%BC%BA%E7%82%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>RDB 优缺点</h5>\n<ul>\n<li>RDB 会生成多个数据文件，每个数据文件都代表了某一个时刻中 Redis 的数据，这种多个数据文件的方式，非常适合做冷备，可以将这种完整的数据文件发送到一些远程的安全存储上去，比如说 Amazon 的 S3 云服务上去，在国内可以是阿里云的 ODPS 分布式存储上，以预定好的备份策略来定期备份 Redis 中的数据。</li>\n<li>RDB 对 Redis 对外提供的读写服务，影响非常小，可以让 Redis 保持高性能，因为 Redis 主进程只需要 fork 一个子进程，让子进程执行磁盘 IO 操作来进行 RDB 持久化即可。</li>\n<li>相对于 AOF 持久化机制来说，直接基于 RDB 数据文件来重启和恢复 Redis 进程，更加快速。</li>\n<li>如果想要在 Redis 故障时，尽可能少的丢失数据，那么 RDB 没有 AOF 好。一般来说，RDB 数据快照文件，都是每隔 5 分钟，或者更长时间生成一次，这个时候就得接受一旦 Redis 进程宕机，那么会丢失最近 5 分钟（甚至更长时间）的数据。</li>\n<li>RDB 每次在 fork 子进程来执行 RDB 快照数据文件生成的时候，如果数据文件特别大，可能会导致对客户端提供的服务暂停数毫秒，或者甚至数秒。</li>\n</ul>\n<h5 id="aof-优缺点"><a href="#aof-%E4%BC%98%E7%BC%BA%E7%82%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>AOF 优缺点</h5>\n<ul>\n<li>AOF 可以更好的保护数据不丢失，一般 AOF 会每隔 1 秒，通过一个后台线程执行一次 fsync 操作，最多丢失 1 秒钟的数据。</li>\n<li>AOF 日志文件以 append-only 模式写入，所以没有任何磁盘寻址的开销，写入性能非常高，而且文件不容易破损，即使文件尾部破损，也很容易修复。</li>\n<li>AOF 日志文件即使过大的时候，出现后台重写操作，也不会影响客户端的读写。因为在 rewrite log 的时候，会对其中的指令进行压缩，创建出一份需要恢复数据的最小日志出来。在创建新日志文件的时候，老的日志文件还是照常写入。当新的 merge 后的日志文件 ready 的时候，再交换新老日志文件即可。</li>\n<li>AOF 日志文件的命令通过可读较强的方式进行记录，这个特性非常适合做灾难性的误删除的紧急恢复。比如某人不小心用 flushall 命令清空了所有数据，只要这个时候后台 rewrite 还没有发生，那么就可以立即拷贝 AOF 文件，将最后一条 flushall 命令给删了，然后再将该 AOF 文件放回去，就可以通过恢复机制，自动恢复所有数据。</li>\n<li>对于同一份数据来说，AOF 日志文件通常比 RDB 数据快照文件更大。</li>\n<li>AOF 开启后，支持的写 QPS 会比 RDB 支持的写 QPS 低，因为 AOF 一般会配置成每秒 fsync 一次日志文件，当然，每秒一次 fsync，性能也还是很高的（如果实时写入，那么 QPS 会大降，Redis 性能会大大降低）</li>\n<li>以前 AOF 发生过 bug，就是通过 AOF 记录的日志，进行数据恢复的时候，没有恢复一模一样的数据出来。所以说，类似 AOF 这种较为复杂的基于命令日志 merge 回放的方式，比基于 RDB 每次持久化一份完整的数据快照文件的方式，更加脆弱一些，容易有 bug。不过 AOF 就是为了避免 rewrite 过程导致的 bug，因此每次 rewrite 并不是基于旧的指令日志进行 merge 的，而是基于当时内存中的数据进行指令的重新构建，这样健壮性会好很多。</li>\n</ul>\n<h4 id="rdb-和-aof-到底该如何选择"><a href="#rdb-%E5%92%8C-aof-%E5%88%B0%E5%BA%95%E8%AF%A5%E5%A6%82%E4%BD%95%E9%80%89%E6%8B%A9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>RDB 和 AOF 到底该如何选择</h4>\n<ul>\n<li>不要仅仅使用 RDB，因为那样会导致你丢失很多数据；</li>\n<li>也不要仅仅使用 AOF，因为那样有两个问题：第一，你通过 AOF 做冷备，没有 RDB 做冷备来的恢复速度更快；第二，RDB 每次简单粗暴生成数据快照，更加健壮，可以避免 AOF 这种复杂的备份和恢复机制的 bug；</li>\n<li>Redis 支持同时开启两种持久化方式，我们可以综合使用 AOF 和 RDB 两种持久化机制，用 AOF 来保证数据不丢失，作为数据恢复的第一选择；用 RDB 来做不同程度的冷备，在 AOF 文件都丢失或损坏不可用的时候，还可以使用 RDB 来进行快速的数据恢复。</li>\n</ul>\n<h3 id="redis-哨兵集群如何实现高可用？"><a href="#redis-%E5%93%A8%E5%85%B5%E9%9B%86%E7%BE%A4%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E9%AB%98%E5%8F%AF%E7%94%A8%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Redis 哨兵集群如何实现高可用？</h3>\n<h4 id="哨兵的介绍"><a href="#%E5%93%A8%E5%85%B5%E7%9A%84%E4%BB%8B%E7%BB%8D" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>哨兵的介绍</h4>\n<p>sentinel，中文名是哨兵。哨兵是 Redis 集群架构中非常重要的一个组件，主要有以下功能：</p>\n<ul>\n<li>集群监控：负责监控 Redis master 和 slave 进程是否正常工作。</li>\n<li>消息通知：如果某个 Redis 实例有故障，那么哨兵负责发送消息作为报警通知给管理员。</li>\n<li>故障转移：如果 master node 挂掉了，会自动转移到 slave node 上。</li>\n<li>配置中心：如果故障转移发生了，通知 client 客户端新的 master 地址。</li>\n</ul>\n<p>哨兵用于实现 Redis 集群的高可用，本身也是分布式的，作为一个哨兵集群去运行，互相协同工作。</p>\n<ul>\n<li>故障转移时，判断一个 master node 是否宕机了，需要大部分的哨兵都同意才行，涉及到了分布式选举的问题。</li>\n<li>即使部分哨兵节点挂掉了，哨兵集群还是能正常工作的，因为如果一个作为高可用机制重要组成部分的故障转移系统本身是单点的，那就很坑爹了。</li>\n</ul>\n<h4 id="哨兵的核心知识"><a href="#%E5%93%A8%E5%85%B5%E7%9A%84%E6%A0%B8%E5%BF%83%E7%9F%A5%E8%AF%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>哨兵的核心知识</h4>\n<ul>\n<li>哨兵至少需要 3 个实例，来保证自己的健壮性。</li>\n<li>哨兵 + Redis 主从的部署架构，是不保证数据零丢失的，只能保证 Redis 集群的高可用性。</li>\n<li>对于哨兵 + Redis 主从这种复杂的部署架构，尽量在测试环境和生产环境，都进行充足的测试和演练。</li>\n</ul>\n<p>哨兵集群必须部署 2 个以上节点，如果哨兵集群仅仅部署了 2 个哨兵实例，quorum = 1。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="44255985986354676000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`+----+         +----+\n| M1 |---------| R1 |\n| S1 |         | S2 |\n+----+         +----+`, `44255985986354676000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">+----+         +----+\n| M1 |---------| R1 |\n| S1 |         | S2 |\n+----+         +----+</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>配置 quorum = 1，如果 master 宕机，s1 和 s2 中只要有 1 个哨兵认为 master 宕机了，就可以进行切换，同时 s1 和 s2 会选举出一个哨兵来执行故障转移。但是同时这个时候，需要 majority，也就是大多数哨兵都是运行的。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="59424331800288260000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`2 个哨兵，majority = 2\n3 个哨兵，majority = 2\n4 个哨兵，majority = 2\n5 个哨兵，majority = 3\n...`, `59424331800288260000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">2 个哨兵，majority = 2\n3 个哨兵，majority = 2\n4 个哨兵，majority = 2\n5 个哨兵，majority = 3\n...</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果此时仅仅是 M1 进程宕机了，哨兵 s1 正常运行，那么故障转移是 OK 的。但是如果是整个 M1 和 S1 运行的机器宕机了，那么哨兵只有 1 个，此时就没有 majority 来允许执行故障转移，虽然另外一台机器上还有一个 R1，但是故障转移不会执行。</p>\n<p>经典的 3 节点哨兵集群是这样的：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="73472873562754020000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`       +----+\n       | M1 |\n       | S1 |\n       +----+\n          |\n+----+    |    +----+\n| R2 |----+----| R3 |\n| S2 |         | S3 |\n+----+         +----+`, `73472873562754020000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">       +----+\n       | M1 |\n       | S1 |\n       +----+\n          |\n+----+    |    +----+\n| R2 |----+----| R3 |\n| S2 |         | S3 |\n+----+         +----+</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>配置 quorum = 2，如果 M1 所在机器宕机了，那么三个哨兵还剩下 2 个，S2 和 S3 可以一致认为 master 宕机了，然后选举出一个来执行故障转移，同时 3 个哨兵的 majority 是 2，所以还剩下的 2 个哨兵运行着，就可以允许执行故障转移。</p>\n<h4 id="redis-哨兵主备切换的数据丢失问题"><a href="#redis-%E5%93%A8%E5%85%B5%E4%B8%BB%E5%A4%87%E5%88%87%E6%8D%A2%E7%9A%84%E6%95%B0%E6%8D%AE%E4%B8%A2%E5%A4%B1%E9%97%AE%E9%A2%98" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Redis 哨兵主备切换的数据丢失问题</h4>\n<h5 id="导致数据丢失的两种情况"><a href="#%E5%AF%BC%E8%87%B4%E6%95%B0%E6%8D%AE%E4%B8%A2%E5%A4%B1%E7%9A%84%E4%B8%A4%E7%A7%8D%E6%83%85%E5%86%B5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>导致数据丢失的两种情况</h5>\n<p>主备切换的过程，可能会导致数据丢失：</p>\n<ul>\n<li>\n<p>异步复制导致的数据丢失</p>\n<p>因为 master -> slave 的复制是异步的，所以可能有部分数据还没复制到 slave，master 就宕机了，此时这部分数据就丢失了。</p>\n</li>\n<li>\n<p>脑裂导致的数据丢失</p>\n<p>脑裂，也就是说，某个 master 所在机器突然脱离了正常的网络，跟其他 slave 机器不能连接，但是实际上 master 还运行着。此时哨兵可能就会认为 master 宕机了，然后开启选举，将其他 slave 切换成了 master。这个时候，集群里就会有两个 master，也就是所谓的脑裂。</p>\n<p>此时虽然某个 slave 被切换成了 master，但是可能 client 还没来得及切换到新的 master，还继续向旧 master 写数据。因此旧 master 再次恢复的时候，会被作为一个 slave 挂到新的 master 上去，自己的数据会清空，重新从新的 master 复制数据。而新的 master 并没有后来 client 写入的数据，因此，这部分数据也就丢失了。</p>\n</li>\n</ul>\n<h5 id="数据丢失问题的解决方案"><a href="#%E6%95%B0%E6%8D%AE%E4%B8%A2%E5%A4%B1%E9%97%AE%E9%A2%98%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>数据丢失问题的解决方案</h5>\n<p>进行如下配置：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="5979050523315777000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`min-slaves-to-write 1\nmin-slaves-max-lag 10`, `5979050523315777000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">min-slaves-to-write <span class="token number">1</span>\nmin-slaves-max-lag <span class="token number">10</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>表示，要求至少有 1 个 slave，数据复制和同步的延迟不能超过 10 秒。</p>\n<p>如果说一旦所有的 slave，数据复制和同步的延迟都超过了 10 秒钟，那么这个时候，master 就不会再接收任何请求了。</p>\n<ul>\n<li>\n<p>减少异步复制数据的丢失</p>\n<p>有了 min-slaves-max-lag 这个配置，就可以确保说，一旦 slave 复制数据和 ack 延时太长，就认为可能 master 宕机后损失的数据太多了，那么就拒绝写请求，这样可以把 master 宕机时由于部分数据未同步到 slave 导致的数据丢失降低的可控范围内。</p>\n</li>\n<li>\n<p>减少脑裂的数据丢失</p>\n<p>如果一个 master 出现了脑裂，跟其他 slave 丢了连接，那么上面两个配置可以确保说，如果不能继续给指定数量的 slave 发送数据，而且 slave 超过 10 秒没有给自己 ack 消息，那么就直接拒绝客户端的写请求。因此在脑裂场景下，最多就丢失 10 秒的数据。</p>\n</li>\n</ul>\n<h4 id="sdown-和-odown-转换机制"><a href="#sdown-%E5%92%8C-odown-%E8%BD%AC%E6%8D%A2%E6%9C%BA%E5%88%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>sdown 和 odown 转换机制</h4>\n<ul>\n<li>sdown 是主观宕机，就一个哨兵如果自己觉得一个 master 宕机了，那么就是主观宕机</li>\n<li>odown 是客观宕机，如果 quorum 数量的哨兵都觉得一个 master 宕机了，那么就是客观宕机</li>\n</ul>\n<p>sdown 达成的条件很简单，如果一个哨兵 ping 一个 master，超过了 is-master-down-after-milliseconds 指定的毫秒数之后，就主观认为 master 宕机了；如果一个哨兵在指定时间内，收到了 quorum 数量的其它哨兵也认为那个 master 是 sdown 的，那么就认为是 odown 了。</p>\n<h4 id="哨兵集群的自动发现机制"><a href="#%E5%93%A8%E5%85%B5%E9%9B%86%E7%BE%A4%E7%9A%84%E8%87%AA%E5%8A%A8%E5%8F%91%E7%8E%B0%E6%9C%BA%E5%88%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>哨兵集群的自动发现机制</h4>\n<p>哨兵互相之间的发现，是通过 Redis 的 pub/sub 系统实现的，每个哨兵都会往 <code class="language-text">__sentinel__:hello</code> 这个 channel 里发送一个消息，这时候所有其他哨兵都可以消费到这个消息，并感知到其他的哨兵的存在。</p>\n<p>每隔两秒钟，每个哨兵都会往自己监控的某个 master + slaves 对应的 <code class="language-text">__sentinel__:hello</code> channel 里发送一个消息，内容是自己的 host、ip 和 runid 还有对这个 master 的监控配置。</p>\n<p>每个哨兵也会去监听自己监控的每个 master + slaves 对应的 <code class="language-text">__sentinel__:hello</code> channel，然后去感知到同样在监听这个 master + slaves 的其他哨兵的存在。</p>\n<p>每个哨兵还会跟其他哨兵交换对 master 的监控配置，互相进行监控配置的同步。</p>\n<h4 id="slave-配置的自动纠正"><a href="#slave-%E9%85%8D%E7%BD%AE%E7%9A%84%E8%87%AA%E5%8A%A8%E7%BA%A0%E6%AD%A3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>slave 配置的自动纠正</h4>\n<p>哨兵会负责自动纠正 slave 的一些配置，比如 slave 如果要成为潜在的 master 候选人，哨兵会确保 slave 复制现有 master 的数据；如果 slave 连接到了一个错误的 master 上，比如故障转移之后，那么哨兵会确保它们连接到正确的 master 上。</p>\n<h4 id="slave---master-选举算法"><a href="#slave---master-%E9%80%89%E4%B8%BE%E7%AE%97%E6%B3%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>slave -> master 选举算法</h4>\n<p>如果一个 master 被认为 odown 了，而且 majority 数量的哨兵都允许主备切换，那么某个哨兵就会执行主备切换操作，此时首先要选举一个 slave 来，会考虑 slave 的一些信息：</p>\n<ul>\n<li>跟 master 断开连接的时长</li>\n<li>slave 优先级</li>\n<li>复制 offset</li>\n<li>run id</li>\n</ul>\n<p>如果一个 slave 跟 master 断开连接的时间已经超过了 down-after-milliseconds 的 10 倍，外加 master 宕机的时长，那么 slave 就被认为不适合选举为 master。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="65405968336580500000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(down-after-milliseconds * 10) + milliseconds_since_master_is_in_SDOWN_state`, `65405968336580500000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">(down-after-milliseconds * 10) + milliseconds_since_master_is_in_SDOWN_state</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>接下来会对 slave 进行排序：</p>\n<ul>\n<li>按照 slave 优先级进行排序，slave priority 越低，优先级就越高。</li>\n<li>如果 slave priority 相同，那么看 replica offset，哪个 slave 复制了越多的数据，offset 越靠后，优先级就越高。</li>\n<li>如果上面两个条件都相同，那么选择一个 run id 比较小的那个 slave。</li>\n</ul>\n<h4 id="quorum-和-majority"><a href="#quorum-%E5%92%8C-majority" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>quorum 和 majority</h4>\n<p>每次一个哨兵要做主备切换，首先需要 quorum 数量的哨兵认为 odown，然后选举出一个哨兵来做切换，这个哨兵还需要得到 majority 哨兵的授权，才能正式执行切换。</p>\n<p>如果 quorum &#x3C; majority，比如 5 个哨兵，majority 就是 3，quorum 设置为 2，那么就 3 个哨兵授权就可以执行切换。</p>\n<p>但是如果 quorum >= majority，那么必须 quorum 数量的哨兵都授权，比如 5 个哨兵，quorum 是 5，那么必须 5 个哨兵都同意授权，才能执行切换。</p>\n<h4 id="configuration-epoch"><a href="#configuration-epoch" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>configuration epoch</h4>\n<p>哨兵会对一套 Redis master + slaves 进行监控，有相应的监控的配置。</p>\n<p>执行切换的那个哨兵，会从要切换到的新 master（salve -> master）那里得到一个 configuration epoch，这就是一个 version 号，每次切换的 version 号都必须是唯一的。</p>\n<p>如果第一个选举出的哨兵切换失败了，那么其他哨兵，会等待 failover-timeout 时间，然后接替继续执行切换，此时会重新获取一个新的 configuration epoch，作为新的 version 号。</p>\n<h4 id="configuration-传播"><a href="#configuration-%E4%BC%A0%E6%92%AD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>configuration 传播</h4>\n<p>哨兵完成切换之后，会在自己本地更新生成最新的 master 配置，然后同步给其他的哨兵，就是通过之前说的 pub/sub 消息机制。</p>\n<p>这里之前的 version 号就很重要了，因为各种消息都是通过一个 channel 去发布和监听的，所以一个哨兵完成一次新的切换之后，新的 master 配置是跟着新的 version 号的。其他的哨兵都是根据版本号的大小来更新自己的 master 配置的。</p>\n<h3 id="redis-集群模式的工作原理能说一下么？"><a href="#redis-%E9%9B%86%E7%BE%A4%E6%A8%A1%E5%BC%8F%E7%9A%84%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E8%83%BD%E8%AF%B4%E4%B8%80%E4%B8%8B%E4%B9%88%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Redis 集群模式的工作原理能说一下么？</h3>\n<p>在前几年，Redis 如果要搞几个节点，每个节点存储一部分的数据，得借助一些中间件来实现，比如说有 codis，或者 twemproxy，都有。有一些 Redis 中间件，你读写 Redis 中间件，Redis 中间件负责将你的数据分布式存储在多台机器上的 Redis 实例中。</p>\n<p>这两年，Redis 不断在发展，Redis 也不断有新的版本，现在的 Redis 集群模式，可以做到在多台机器上，部署多个 Redis 实例，每个实例存储一部分的数据，同时每个 Redis 主实例可以挂 Redis 从实例，自动确保说，如果 Redis 主实例挂了，会自动切换到 Redis 从实例上来。</p>\n<p>现在 Redis 的新版本，大家都是用 Redis cluster 的，也就是 Redis 原生支持的 Redis 集群模式，那么面试官肯定会就 Redis cluster 对你来个几连炮。要是你没用过 Redis cluster，正常，以前很多人用 codis 之类的客户端来支持集群，但是起码你得研究一下 Redis cluster 吧。</p>\n<p>如果你的数据量很少，主要是承载高并发高性能的场景，比如你的缓存一般就几个 G，单机就足够了，可以使用 replication，一个 master 多个 slaves，要几个 slave 跟你要求的读吞吐量有关，然后自己搭建一个 sentinel 集群去保证 Redis 主从架构的高可用性。</p>\n<p>Redis cluster，主要是针对海量数据 + 高并发 + 高可用的场景。Redis cluster 支撑 N 个 Redis master node，每个 master node 都可以挂载多个 slave node。这样整个 Redis 就可以横向扩容了。如果你要支撑更大数据量的缓存，那就横向扩容更多的 master 节点，每个 master 节点就能存放更多的数据了。</p>\n<h4 id="redis-cluster-介绍"><a href="#redis-cluster-%E4%BB%8B%E7%BB%8D" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Redis cluster 介绍</h4>\n<ul>\n<li>自动将数据进行分片，每个 master 上放一部分数据</li>\n<li>提供内置的高可用支持，部分 master 不可用时，还是可以继续工作的</li>\n</ul>\n<p>在 Redis cluster 架构下，每个 Redis 要放开两个端口号，比如一个是 6379，另外一个就是加 1w 的端口号，比如 16379。</p>\n<p>16379 端口号是用来进行节点间通信的，也就是 cluster bus 的东西，cluster bus 的通信，用来进行故障检测、配置更新、故障转移授权。cluster bus 用了另外一种二进制的协议，gossip 协议，用于节点间进行高效的数据交换，占用更少的网络带宽和处理时间。</p>\n<h4 id="节点间的内部通信机制"><a href="#%E8%8A%82%E7%82%B9%E9%97%B4%E7%9A%84%E5%86%85%E9%83%A8%E9%80%9A%E4%BF%A1%E6%9C%BA%E5%88%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>节点间的内部通信机制</h4>\n<h5 id="基本通信原理"><a href="#%E5%9F%BA%E6%9C%AC%E9%80%9A%E4%BF%A1%E5%8E%9F%E7%90%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>基本通信原理</h5>\n<p>集群元数据的维护有两种方式：集中式、Gossip 协议。Redis cluster 节点间采用 gossip 协议进行通信。</p>\n<p>集中式是将集群元数据（节点信息、故障等等）集中存储在某个节点上。集中式元数据集中存储的一个典型代表，就是大数据领域的 storm。它是分布式的大数据实时计算引擎，是集中式的元数据存储的结构，底层基于 zookeeper（分布式协调的中间件）对所有元数据进行存储维护。</p>\n<p>Redis 维护集群元数据采用另一个方式，gossip 协议，所有节点都持有一份元数据，不同的节点如果出现了元数据的变更，就不断将元数据发送给其它的节点，让其它节点也进行元数据的变更。</p>\n<p>集中式的好处在于，元数据的读取和更新，时效性非常好，一旦元数据出现了变更，就立即更新到集中式的存储中，其它节点读取的时候就可以感知到；不好在于，所有的元数据的更新压力全部集中在一个地方，可能会导致元数据的存储有压力。</p>\n<p>gossip 好处在于，元数据的更新比较分散，不是集中在一个地方，更新请求会陆陆续续打到所有节点上去更新，降低了压力；不好在于，元数据的更新有延时，可能导致集群中的一些操作会有一些滞后。</p>\n<ul>\n<li>10000 端口：每个节点都有一个专门用于节点间通信的端口，就是自己提供服务的端口号 + 10000，比如 7001，那么用于节点间通信的就是 17001 端口。每个节点每隔一段时间都会往另外几个节点发送 ping 消息，同时其它几个节点接收到 ping 之后返回 pong 。</li>\n<li>交换的信息：信息包括故障信息，节点的增加和删除，hash slot 信息等等。</li>\n</ul>\n<h5 id="gossip-协议"><a href="#gossip-%E5%8D%8F%E8%AE%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>gossip 协议</h5>\n<p>gossip 协议包含多种消息，包含 ping, pong, meet, fail 等等。</p>\n<ul>\n<li>\n<p>meet：某个节点发送 meet 给新加入的节点，让新节点加入集群中，然后新节点就会开始与其它节点进行通信。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="98646194285661800000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`Redis-trib.rb add-node`, `98646194285661800000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">Redis-trib.rb add-node</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>其实内部就是发送了一个 gossip meet 消息给新加入的节点，通知那个节点去加入我们的集群。</p>\n</li>\n<li>\n<p>ping：每个节点都会频繁给其它节点发送 ping，其中包含自己的状态还有自己维护的集群元数据，互相通过 ping 交换元数据。</p>\n</li>\n<li>\n<p>pong：返回 ping 和 meet，包含自己的状态和其它信息，也用于信息广播和更新。</p>\n</li>\n<li>\n<p>fail：某个节点判断另一个节点 fail 之后，就发送 fail 给其它节点，通知其它节点说，某个节点宕机啦。</p>\n</li>\n</ul>\n<h5 id="ping-消息深入"><a href="#ping-%E6%B6%88%E6%81%AF%E6%B7%B1%E5%85%A5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ping 消息深入</h5>\n<p>ping 时要携带一些元数据，如果很频繁，可能会加重网络负担。</p>\n<p>每个节点每秒会执行 10 次 ping，每次会选择 5 个最久没有通信的其它节点。当然如果发现某个节点通信延时达到了 <code class="language-text">cluster_node_timeout / 2</code>，那么立即发送 ping，避免数据交换延时过长，落后的时间太长了。比如说，两个节点之间都 10 分钟没有交换数据了，那么整个集群处于严重的元数据不一致的情况，就会有问题。所以 <code class="language-text">cluster_node_timeout</code> 可以调节，如果调得比较大，那么会降低 ping 的频率。</p>\n<p>每次 ping，会带上自己节点的信息，还有就是带上 1 / 10 其它节点的信息，发送出去，进行交换。至少包含 3 个其它节点的信息，最多包含总节点数减 2 个其它节点的信息。</p>\n<h4 id="分布式寻址算法"><a href="#%E5%88%86%E5%B8%83%E5%BC%8F%E5%AF%BB%E5%9D%80%E7%AE%97%E6%B3%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>分布式寻址算法</h4>\n<ul>\n<li>hash 算法（大量缓存重建）</li>\n<li>一致性 hash 算法（自动缓存迁移）+ 虚拟节点（自动负载均衡）</li>\n<li>Redis cluster 的 hash slot 算法</li>\n</ul>\n<h5 id="hash-算法"><a href="#hash-%E7%AE%97%E6%B3%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>hash 算法</h5>\n<p>来了一个 key，首先计算 hash 值，然后对节点数取模。然后打在不同的 master 节点上。一旦某一个 master 节点宕机，所有请求过来，都会基于最新的剩余 master 节点数去取模，尝试去取数据。这会导致大部分的请求过来，全部无法拿到有效的缓存，导致大量的流量涌入数据库。</p>\n<h5 id="一致性-hash-算法"><a href="#%E4%B8%80%E8%87%B4%E6%80%A7-hash-%E7%AE%97%E6%B3%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>一致性 hash 算法</h5>\n<p>一致性 hash 算法将整个 hash 值空间组织成一个虚拟的圆环，整个空间按顺时针方向组织，下一步将各个 master 节点（使用服务器的 ip 或主机名）进行 hash。这样就能确定每个节点在其哈希环上的位置。</p>\n<p>来了一个 key，首先计算 hash 值，并确定此数据在环上的位置，从此位置沿环顺时针“行走”，遇到的第一个 master 节点就是 key 所在位置。</p>\n<p>在一致性哈希算法中，如果一个节点挂了，受影响的数据仅仅是此节点到环空间前一个节点（沿着逆时针方向行走遇到的第一个节点）之间的数据，其它不受影响。增加一个节点也同理。</p>\n<p>但是，一致性哈希算法在节点太少时，容易因为节点分布不均匀而造成缓存热点的问题。为了解决这种热点问题，一致性 hash 算法引入了虚拟节点机制，即对每一个节点计算多个 hash，每个计算结果位置都放置一个虚拟节点。这样就实现了数据的均匀分布，负载均衡。</p>\n<h5 id="redis-cluster-的-hash-slot-算法"><a href="#redis-cluster-%E7%9A%84-hash-slot-%E7%AE%97%E6%B3%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Redis cluster 的 hash slot 算法</h5>\n<p>Redis cluster 有固定的 16384 个 hash slot，对每个 key 计算 CRC16 值，然后对 16384 取模，可以获取 key 对应的 hash slot。</p>\n<p>Redis cluster 中每个 master 都会持有部分 slot，比如有 3 个 master，那么可能每个 master 持有 5000 多个 hash slot。hash slot 让 node 的增加和移除很简单，增加一个 master，就将其他 master 的 hash slot 移动部分过去，减少一个 master，就将它的 hash slot 移动到其他 master 上去。移动 hash slot 的成本是非常低的。客户端的 api，可以对指定的数据，让他们走同一个 hash slot，通过 hash tag 来实现。</p>\n<p>任何一台机器宕机，另外两个节点，不影响的。因为 key 找的是 hash slot，不是机器。</p>\n<h4 id="redis-cluster-的高可用与主备切换原理"><a href="#redis-cluster-%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8%E4%B8%8E%E4%B8%BB%E5%A4%87%E5%88%87%E6%8D%A2%E5%8E%9F%E7%90%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Redis cluster 的高可用与主备切换原理</h4>\n<p>Redis cluster 的高可用的原理，几乎跟哨兵是类似的。</p>\n<h5 id="判断节点宕机"><a href="#%E5%88%A4%E6%96%AD%E8%8A%82%E7%82%B9%E5%AE%95%E6%9C%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>判断节点宕机</h5>\n<p>如果一个节点认为另外一个节点宕机，那么就是 pfail，主观宕机。如果多个节点都认为另外一个节点宕机了，那么就是 fail，客观宕机，跟哨兵的原理几乎一样，sdown，odown。</p>\n<p>在 cluster-node-timeout 内，某个节点一直没有返回 pong，那么就被认为 pfail。</p>\n<p>如果一个节点认为某个节点 pfail 了，那么会在 gossip ping 消息中，ping 给其他节点，如果超过半数的节点都认为 pfail 了，那么就会变成 fail 。</p>\n<h5 id="从节点过滤"><a href="#%E4%BB%8E%E8%8A%82%E7%82%B9%E8%BF%87%E6%BB%A4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>从节点过滤</h5>\n<p>对宕机的 master node，从其所有的 slave node 中，选择一个切换成 master node。</p>\n<p>检查每个 slave node 与 master node 断开连接的时间，如果超过了 <code class="language-text">cluster-node-timeout * cluster-slave-validity-factor</code>，那么就没有资格切换成 master 。</p>\n<h5 id="从节点选举"><a href="#%E4%BB%8E%E8%8A%82%E7%82%B9%E9%80%89%E4%B8%BE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>从节点选举</h5>\n<p>每个从节点，都根据自己对 master 复制数据的 offset，来设置一个选举时间，offset 越大（复制数据越多）的从节点，选举时间越靠前，优先进行选举。</p>\n<p>所有的 master node 开始 slave 选举投票，给要进行选举的 slave 进行投票，如果大部分 master node（N / 2 + 1）都投票给了某个从节点，那么选举通过，那个从节点可以切换成 master。</p>\n<p>从节点执行主备切换，从节点切换为主节点。</p>\n<h5 id="与哨兵比较"><a href="#%E4%B8%8E%E5%93%A8%E5%85%B5%E6%AF%94%E8%BE%83" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>与哨兵比较</h5>\n<p>整个流程跟哨兵相比，非常类似，所以说，Redis cluster 功能强大，直接集成了 replication 和 sentinel 的功能。</p>\n<h3 id="redis-的雪崩、穿透和击穿，如何应对？"><a href="#redis-%E7%9A%84%E9%9B%AA%E5%B4%A9%E3%80%81%E7%A9%BF%E9%80%8F%E5%92%8C%E5%87%BB%E7%A9%BF%EF%BC%8C%E5%A6%82%E4%BD%95%E5%BA%94%E5%AF%B9%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Redis 的雪崩、穿透和击穿，如何应对？</h3>\n<h4 id="缓存雪崩cache-avalanche"><a href="#%E7%BC%93%E5%AD%98%E9%9B%AA%E5%B4%A9cache-avalanche" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>缓存雪崩(Cache Avalanche)</h4>\n<p>对于系统 A，假设每天高峰期每秒 5000 个请求，本来缓存在高峰期可以扛住每秒 4000 个请求，但是缓存机器意外发生了全盘宕机。缓存挂了，此时 1 秒 5000 个请求全部落数据库，数据库必然扛不住，它会报一下警，然后就挂了。此时，如果没有采用什么特别的方案来处理这个故障，DBA 很着急，重启数据库，但是数据库立马又被新的流量给打死了。</p>\n<p>这就是缓存雪崩。</p>\n<p>大约在 3 年前，国内比较知名的一个互联网公司，曾因为缓存事故，导致雪崩，后台系统全部崩溃，事故从当天下午持续到晚上凌晨 3~4 点，公司损失了几千万。</p>\n<p>缓存雪崩的事前事中事后的解决方案如下：</p>\n<ul>\n<li>事前：Redis 高可用，主从 + 哨兵，Redis cluster，避免全盘崩溃。</li>\n<li>事中：本地 ehcache 缓存 + hystrix 限流 &#x26; 降级，避免 MySQL 被打死。</li>\n<li>事后：Redis 持久化，一旦重启，自动从磁盘上加载数据，快速恢复缓存数据。</li>\n</ul>\n<p>用户发送一个请求，系统 A 收到请求后，先查本地 ehcache 缓存，如果没查到再查 Redis。如果 ehcache 和 Redis 都没有，再查数据库，将数据库中的结果，写入 ehcache 和 Redis 中。</p>\n<p>限流组件，可以设置每秒的请求，有多少能通过组件，剩余的未通过的请求，怎么办？走降级！可以返回一些默认的值，或者友情提示，或者空值。</p>\n<p>好处：</p>\n<ul>\n<li>数据库绝对不会死，限流组件确保了每秒只有多少个请求能通过。</li>\n<li>只要数据库不死，就是说，对用户来说，2/5 的请求都是可以被处理的。</li>\n<li>只要有 2/5 的请求可以被处理，就意味着你的系统没死，对用户来说，可能就是点击几次刷不出来页面，但是多点几次，就可以刷出来了。</li>\n</ul>\n<h4 id="缓存穿透cache-penetration"><a href="#%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8Fcache-penetration" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>缓存穿透(Cache Penetration)</h4>\n<p>对于系统 A，假设一秒 5000 个请求，结果其中 4000 个请求是黑客发出的恶意攻击。</p>\n<p>黑客发出的那 4000 个攻击，缓存中查不到，每次你去数据库里查，也查不到。</p>\n<p>举个栗子。数据库 id 是从 1 开始的，结果黑客发过来的请求 id 全部都是负数。这样的话，缓存中不会有，请求每次都“视缓存于无物”，直接查询数据库。这种恶意攻击场景的缓存穿透就会直接把数据库给打死。</p>\n<p>解决方式很简单，每次系统 A 从数据库中只要没查到，就写一个空值到缓存里去，比如 set -999 UNKNOWN。然后设置一个过期时间，这样的话，下次有相同的 key 来访问的时候，在缓存失效之前，都可以直接从缓存中取数据。</p>\n<p>当然，如果黑客如果每次使用不同的负数 id 来攻击，写空值的方法可能就不奏效了。更为常见的做法是在缓存之前增加布隆过滤器，将数据库中所有可能的数据哈希映射到布隆过滤器中。然后对每个请求进行如下判断：</p>\n<ul>\n<li>请求数据的 key 不存在于布隆过滤器中，可以确定数据就一定不会存在于数据库中，系统可以立即返回不存在。</li>\n<li>请求数据的 key 存在于布隆过滤器中，则继续再向缓存中查询。使用布隆过滤器能够对访问的请求起到了一定的初筛作用，避免了因数据不存在引起的查询压力。</li>\n</ul>\n<h4 id="缓存击穿hotspot-invalid"><a href="#%E7%BC%93%E5%AD%98%E5%87%BB%E7%A9%BFhotspot-invalid" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>缓存击穿(Hotspot Invalid)</h4>\n<p>缓存击穿，就是说某个 key 非常热点，访问非常频繁，处于集中式高并发访问的情况，当这个 key 在失效的瞬间，大量的请求就击穿了缓存，直接请求数据库，就像是在一道屏障上凿开了一个洞。</p>\n<p>不同场景下的解决方式如下：</p>\n<ul>\n<li>若缓存的数据是基本不会发生更新的，则可尝试将该热点数据设置为永不过期。</li>\n<li>若缓存的数据更新不频繁，且缓存刷新的整个流程耗时较少的情况下，则可以采用基于 Redis、zookeeper 等分布式中间件的分布式互斥锁，或者本地互斥锁以保证仅少量的请求能请求数据库并重新构建缓存，其余线程则在锁释放后能访问到新缓存。</li>\n<li>若缓存的数据更新频繁或者在缓存刷新的流程耗时较长的情况下，可以利用定时线程在缓存过期前主动地重新构建缓存或者延后缓存的过期时间，以保证所有的请求能一直访问到对应的缓存。</li>\n</ul>\n<h3 id="如何保证缓存与数据库的双写一致性？"><a href="#%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%E7%BC%93%E5%AD%98%E4%B8%8E%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E5%8F%8C%E5%86%99%E4%B8%80%E8%87%B4%E6%80%A7%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>如何保证缓存与数据库的双写一致性？</h3>\n<p>一般来说，如果允许缓存可以稍微的跟数据库偶尔有不一致的情况，也就是说如果你的系统不是严格要求 “缓存 + 数据库” 必须保持一致性的话，最好不要做这个方案，即：读请求和写请求串行化，串到一个内存队列里去。</p>\n<p>串行化可以保证一定不会出现不一致的情况，但是它也会导致系统的吞吐量大幅度降低，用比正常情况下多几倍的机器去支撑线上的一个请求。</p>\n<h4 id="cache-aside-pattern"><a href="#cache-aside-pattern" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Cache Aside Pattern</h4>\n<p>最经典的缓存 + 数据库读写的模式，就是 Cache Aside Pattern。</p>\n<ul>\n<li>读的时候，先读缓存，缓存没有的话，就读数据库，然后取出数据后放入缓存，同时返回响应。</li>\n<li>更新的时候，先更新数据库，然后再删除缓存。</li>\n</ul>\n<p>为什么是删除缓存，而不是更新缓存？</p>\n<p>原因很简单，很多时候，在复杂点的缓存场景，缓存不单单是数据库中直接取出来的值。</p>\n<p>比如可能更新了某个表的一个字段，然后其对应的缓存，是需要查询另外两个表的数据并进行运算，才能计算出缓存最新的值的。</p>\n<p>另外更新缓存的代价有时候是很高的。是不是说，每次修改数据库的时候，都一定要将其对应的缓存更新一份？也许有的场景是这样，但是对于比较复杂的缓存数据计算的场景，就不是这样了。如果你频繁修改一个缓存涉及的多个表，缓存也频繁更新。但是问题在于，这个缓存到底会不会被频繁访问到？</p>\n<p>举个栗子，一个缓存涉及的表的字段，在 1 分钟内就修改了 20 次，或者是 100 次，那么缓存更新 20 次、100 次；但是这个缓存在 1 分钟内只被读取了 1 次，有大量的冷数据。实际上，如果你只是删除缓存的话，那么在 1 分钟内，这个缓存不过就重新计算一次而已，开销大幅度降低。用到缓存才去算缓存。</p>\n<p>其实删除缓存，而不是更新缓存，就是一个 lazy 计算的思想，不要每次都重新做复杂的计算，不管它会不会用到，而是让它到需要被使用的时候再重新计算。像 mybatis，hibernate，都有懒加载思想。查询一个部门，部门带了一个员工的 list，没有必要说每次查询部门，都把里面的 1000 个员工的数据也同时查出来啊。80% 的情况，查这个部门，就只是要访问这个部门的信息就可以了。先查部门，同时要访问里面的员工，那么这个时候只有在你要访问里面的员工的时候，才会去数据库里面查询 1000 个员工。</p>\n<h4 id="最初级的缓存不一致问题及解决方案"><a href="#%E6%9C%80%E5%88%9D%E7%BA%A7%E7%9A%84%E7%BC%93%E5%AD%98%E4%B8%8D%E4%B8%80%E8%87%B4%E9%97%AE%E9%A2%98%E5%8F%8A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>最初级的缓存不一致问题及解决方案</h4>\n<p>问题：先更新数据库，再删除缓存。如果删除缓存失败了，那么会导致数据库中是新数据，缓存中是旧数据，数据就出现了不一致。</p>\n<ol>\n<li>\n<p>先删除缓存，再更新数据库。如果数据库更新失败了，那么数据库中是旧数据，缓存中是空的，那么数据不会不一致。因为读的时候缓存没有，所以去读了数据库中的旧数据，然后更新到缓存中。</p>\n</li>\n<li>\n<p>延时双删。依旧是先更新数据库，再删除缓存，唯一不同的是，我们把这个删除的动作，在不久之后再执行一次，比如 5s 之后。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="33503771001303130000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public void set(key, value) {\n  putToDb(key, value);\n  deleteFromRedis(key);\n\n  // ... a few seconds later\n  deleteFromRedis(key);\n}`, `33503771001303130000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token function">putToDb</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token function">deleteFromRedis</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// ... a few seconds later</span>\n  <span class="token function">deleteFromRedis</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n</ol>\n<p>删除的动作，可以有多种选择，比如：</p>\n<ol>\n<li>使用 DelayQueue，会随着 JVM 进程的死亡，丢失更新的风险；</li>\n<li>放在 MQ，但编码复杂度增加。</li>\n</ol>\n<p>总之，我们需要综合各种因素去做设计，选择一个最合理的解决方案。</p>\n<h4 id="比较复杂的数据不一致问题分析"><a href="#%E6%AF%94%E8%BE%83%E5%A4%8D%E6%9D%82%E7%9A%84%E6%95%B0%E6%8D%AE%E4%B8%8D%E4%B8%80%E8%87%B4%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>比较复杂的数据不一致问题分析</h4>\n<p>数据发生了变更，先删除了缓存，然后要去修改数据库，此时还没修改。一个请求过来，去读缓存，发现缓存空了，去查询数据库，查到了修改前的旧数据，放到了缓存中。随后数据变更的程序完成了数据库的修改。完了，数据库和缓存中的数据不一样了…</p>\n<p>为什么上亿流量高并发场景下，缓存会出现这个问题？</p>\n<p>只有在对一个数据并发的进行读写的时候，才可能会出现这种问题。其实如果说你的并发量很低的话，特别是读并发很低，每天访问量就 1 万次，那么很少的情况下，不会出现刚才描述的那种不一致的场景。但是问题是，如果每天的是上亿的流量，每秒并发读是几万，每秒只要有数据更新的请求，就可能会出现上述的数据库 + 缓存不一致的情况。</p>\n<p>解决方案如下：</p>\n<p>更新数据的时候，根据数据的唯一标识，将操作路由之后，发送到一个 jvm 内部队列中。读取数据的时候，如果发现数据不在缓存中，那么将重新执行“读取数据 + 更新缓存”的操作，根据唯一标识路由之后，也发送到同一个 jvm 内部队列中。</p>\n<p>一个队列对应一个工作线程，每个工作线程串行拿到对应的操作，然后一条一条的执行。这样的话，一个数据变更的操作，先删除缓存，然后再去更新数据库，但是还没完成更新。此时如果一个读请求过来，没有读到缓存，那么可以先将缓存更新的请求发送到队列中，此时会在队列中积压，然后同步等待缓存更新完成。</p>\n<p>这里有一个优化点，一个队列中，其实多个更新缓存请求串在一起是没意义的，因此可以做过滤，如果发现队列中已经有一个更新缓存的请求了，那么就不用再放个更新请求操作进去了，直接等待前面的更新操作请求完成即可。</p>\n<p>待那个队列对应的工作线程完成了上一个操作的数据库的修改之后，才会去执行下一个操作，也就是缓存更新的操作，此时会从数据库中读取最新的值，然后写入缓存中。</p>\n<p>如果请求还在等待时间范围内，不断轮询发现可以取到值了，那么就直接返回；如果请求等待的时间超过一定时长，那么这一次直接从数据库中读取当前的旧值。</p>\n<p>高并发的场景下，该解决方案要注意的问题：</p>\n<ul>\n<li>\n<p>读请求长时阻塞</p>\n<p>由于读请求进行了非常轻度的异步化，所以一定要注意读超时的问题，每个读请求必须在超时时间范围内返回。</p>\n<p>该解决方案，最大的风险点在于说，可能数据更新很频繁，导致队列中积压了大量更新操作在里面，然后读请求会发生大量的超时，最后导致大量的请求直接走数据库。务必通过一些模拟真实的测试，看看更新数据的频率是怎样的。</p>\n<p>另外一点，因为一个队列中，可能会积压针对多个数据项的更新操作，因此需要根据自己的业务情况进行测试，可能需要部署多个服务，每个服务分摊一些数据的更新操作。如果一个内存队列里会挤压 100 个商品的库存修改操作，每个库存修改操作要耗费 10ms 去完成，那么最后一个商品的读请求，可能等待 <code class="language-text">10 * 100 = 1000ms = 1s</code> 后，才能得到数据，这个时候就导致读请求的长时阻塞。</p>\n<p>一定要根据实际业务系统的运行情况，去进行一些压力测试，和模拟线上环境，去看看最繁忙的时候，内存队列可能会挤压多少更新操作，可能会导致最后一个更新操作对应的读请求，会 hang 多少时间，如果读请求在 200ms 返回，如果你计算过后，哪怕是最繁忙的时候，积压 10 个更新操作，最多等待 200ms，那还可以的。</p>\n<p>如果一个内存队列中可能积压的更新操作特别多，那么你就要加机器，让每个机器上部署的服务实例处理更少的数据，那么每个内存队列中积压的更新操作就会越少。</p>\n<p>其实根据之前的项目经验，一般来说，数据的写频率是很低的，因此实际上正常来说，在队列中积压的更新操作应该是很少的。像这种针对读高并发、读缓存架构的项目，一般来说写请求是非常少的，每秒的 QPS 能到几百就不错了。</p>\n<p>我们来实际粗略测算一下。</p>\n<p>如果一秒有 500 的写操作，如果分成 5 个时间片，每 200ms 就 100 个写操作，放到 20 个内存队列中，每个内存队列，可能就积压 5 个写操作。每个写操作性能测试后，一般是在 20ms 左右就完成，那么针对每个内存队列的数据的读请求，也就最多 hang 一会儿，200ms 以内肯定能返回了。</p>\n<p>经过刚才简单的测算，我们知道，单机支撑的写 QPS 在几百是没问题的，如果写 QPS 扩大了 10 倍，那么就扩容机器，扩容 10 倍的机器，每个机器 20 个队列。</p>\n</li>\n<li>\n<p>读请求并发量过高</p>\n<p>这里还必须做好压力测试，确保恰巧碰上上述情况的时候，还有一个风险，就是突然间大量读请求会在几十毫秒的延时 hang 在服务上，看服务能不能扛的住，需要多少机器才能扛住最大的极限情况的峰值。</p>\n<p>但是因为并不是所有的数据都在同一时间更新，缓存也不会同一时间失效，所以每次可能也就是少数数据的缓存失效了，然后那些数据对应的读请求过来，并发量应该也不会特别大。</p>\n</li>\n<li>\n<p>多服务实例部署的请求路由</p>\n<p>可能这个服务部署了多个实例，那么必须保证说，执行数据更新操作，以及执行缓存更新操作的请求，都通过 Nginx 服务器路由到相同的服务实例上。</p>\n<p>比如说，对同一个商品的读写请求，全部路由到同一台机器上。可以自己去做服务间的按照某个请求参数的 hash 路由，也可以用 Nginx 的 hash 路由功能等等。</p>\n</li>\n<li>\n<p>热点商品的路由问题，导致请求的倾斜</p>\n<p>万一某个商品的读写请求特别高，全部打到相同机器的相同队列里面去了，可能会造成某台机器的压力过大。就是说，因为只有在商品数据更新的时候才会清空缓存，然后才会导致读写并发，所以其实要根据业务系统去看，如果更新频率不是太高的话，这个问题的影响并不是特别大，但是的确可能某些机器的负载会高一些。</p>\n</li>\n</ul>\n<h3 id="如何解决-redis-的并发竞争问题？"><a href="#%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3-redis-%E7%9A%84%E5%B9%B6%E5%8F%91%E7%AB%9E%E4%BA%89%E9%97%AE%E9%A2%98%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>如何解决 Redis 的并发竞争问题？</h3>\n<p>多客户端同时并发写一个 key，可能本来应该先到的数据后到了，导致数据版本错了；或者是多客户端同时获取一个 key，修改值之后再写回去，只要顺序错了，数据就错了。</p>\n<p>而且 Redis 自己就有天然解决这个问题的 CAS 类的乐观锁方案。</p>\n<ol>\n<li>\n<p>某个时刻，多个系统实例都去更新某个 key。可以基于 zookeeper 实现分布式锁。每个系统通过 zookeeper 获取分布式锁，确保同一时间，只能有一个系统实例在操作某个 key，别人都不允许读和写。</p>\n</li>\n<li>\n<p>你要写入缓存的数据，都是从 mysql 里查出来的，都得写入 mysql 中，写入 mysql 中的时候必须保存一个时间戳，从 mysql 查出来的时候，时间戳也查出来。</p>\n<p>每次要写之前，先判断一下当前这个 value 的时间戳是否比缓存里的 value 的时间戳要新。如果是的话，那么可以写，否则，就不能用旧的数据覆盖新的数据。</p>\n</li>\n</ol>\n<h3 id="生产环境中的-redis-是怎么部署的？"><a href="#%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E4%B8%AD%E7%9A%84-redis-%E6%98%AF%E6%80%8E%E4%B9%88%E9%83%A8%E7%BD%B2%E7%9A%84%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>生产环境中的 Redis 是怎么部署的？</h3>\n<p>Redis cluster，10 台机器，5 台机器部署了 Redis 主实例，另外 5 台机器部署了 Redis 的从实例，每个主实例挂了一个从实例，5 个节点对外提供读写服务，每个节点的读写高峰 QPS 可以达到每秒 5 万，5 台机器最多是 25 万读写请求每秒。</p>\n<p>机器是什么配置？</p>\n<p>32G 内存 + 8 核 CPU + 1T 磁盘，但是分配给 Redis 进程的是 10g 内存，一般线上生产环境，Redis 的内存尽量不要超过 10g，超过 10g 可能会有问题。</p>\n<p>5 台机器对外提供读写，一共有 50g 内存。</p>\n<p>因为每个主实例都挂了一个从实例，所以是高可用的，任何一个主实例宕机，都会自动故障迁移，Redis 从实例会自动变成主实例继续提供读写服务。</p>\n<p>你往内存里写的是什么数据？每条数据的大小是多少？</p>\n<p>商品数据，每条数据是 10kb。100 条数据是 1mb，10 万条数据是 1g。常驻内存的是 200 万条商品数据，占用内存是 20g，仅仅不到总内存的 50%。目前高峰期每秒就是 3500 左右的请求量。</p>\n<p>其实大型的公司，会有基础架构的 team 负责缓存集群的运维。</p>\n<h2 id="分库分表"><a href="#%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>分库分表</h2>\n<h3 id="为什么要分库分表？"><a href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>为什么要分库分表？</h3>\n<p>说白了，分库分表是两回事儿，大家可别搞混了，可能是光分库不分表，也可能是光分表不分库，都有可能。</p>\n<p>我先给大家抛出来一个场景。</p>\n<p>假如我们现在是一个小创业公司（或者是一个 BAT 公司刚兴起的一个新部门），现在注册用户就 20 万，每天活跃用户就 1 万，每天单表数据量就 1000，然后高峰期每秒钟并发请求最多就 10 个。我的天，就这种系统，随便找一个有几年工作经验的，然后带几个刚培训出来的，随便干干都可以。</p>\n<p>结果没想到我们运气居然这么好，碰上个 CEO 带着我们走上了康庄大道，业务发展迅猛，过了几个月，注册用户数达到了 2000 万！每天活跃用户数 100 万！每天单表数据量 10 万条！高峰期每秒最大请求达到 1000！同时公司还顺带着融资了两轮，进账了几个亿人民币啊！公司估值达到了惊人的几亿美金！这是小独角兽的节奏！</p>\n<p>好吧，没事，现在大家感觉压力已经有点大了，为啥呢？因为每天多 10 万条数据，一个月就多 300 万条数据，现在咱们单表已经几百万数据了，马上就破千万了。但是勉强还能撑着。高峰期请求现在是 1000，咱们线上部署了几台机器，负载均衡搞了一下，数据库撑 1000QPS 也还凑合。但是大家现在开始感觉有点担心了，接下来咋整呢…</p>\n<p>再接下来几个月，我的天，CEO 太牛逼了，公司用户数已经达到 1 亿，公司继续融资几十亿人民币啊！公司估值达到了惊人的几十亿美金，成为了国内今年最牛逼的明星创业公司！天，我们太幸运了。</p>\n<p>但是我们同时也是不幸的，因为此时每天活跃用户数上千万，每天单表新增数据多达 50 万，目前一个表总数据量都已经达到了两三千万了！扛不住啊！数据库磁盘容量不断消耗掉！高峰期并发达到惊人的 5000 ~ 8000！别开玩笑了，哥。我跟你保证，你的系统支撑不到现在，已经挂掉了！</p>\n<p>好吧，所以你看到这里差不多就理解分库分表是怎么回事儿了，实际上这是跟着你的公司业务发展走的，你公司业务发展越好，用户就越多，数据量越大，请求量越大，那你单个数据库一定扛不住。</p>\n<h4 id="分表"><a href="#%E5%88%86%E8%A1%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>分表</h4>\n<p>比如你单表都几千万数据了，你确定你能扛住么？绝对不行，单表数据量太大，会极大影响你的 sql 执行的性能，到了后面你的 sql 可能就跑的很慢了。一般来说，就以我的经验来看，单表到几百万的时候，性能就会相对差一些了，你就得分表了。</p>\n<p>分表是啥意思？就是把一个表的数据放到多个表中，然后查询的时候你就查一个表。比如按照用户 id 来分表，将一个用户的数据就放在一个表中。然后操作的时候你对一个用户就操作那个表就好了。这样可以控制每个表的数据量在可控的范围内，比如每个表就固定在 200 万以内。</p>\n<h4 id="分库"><a href="#%E5%88%86%E5%BA%93" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>分库</h4>\n<p>分库是啥意思？就是你一个库一般我们经验而言，最多支撑到并发 2000，一定要扩容了，而且一个健康的单库并发值你最好保持在每秒 1000 左右，不要太大。那么你可以将一个库的数据拆分到多个库中，访问的时候就访问一个库好了。</p>\n<p>这就是所谓的分库分表，为啥要分库分表？你明白了吧。</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>分库分表前</th>\n<th>分库分表后</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>并发支撑情况</td>\n<td>MySQL 单机部署，扛不住高并发</td>\n<td>MySQL 从单机到多机，能承受的并发增加了多倍</td>\n</tr>\n<tr>\n<td>磁盘使用情况</td>\n<td>MySQL 单机磁盘容量几乎撑满</td>\n<td>拆分为多个库，数据库服务器磁盘使用率大大降低</td>\n</tr>\n<tr>\n<td>SQL 执行性能</td>\n<td>单表数据量太大，SQL 越跑越慢</td>\n<td>单表数据量减少，SQL 执行效率明显提升</td>\n</tr>\n</tbody>\n</table>\n<h4 id="用过哪些分库分表中间件？不同的分库分表中间件都有什么优点和缺点？"><a href="#%E7%94%A8%E8%BF%87%E5%93%AA%E4%BA%9B%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E4%B8%AD%E9%97%B4%E4%BB%B6%EF%BC%9F%E4%B8%8D%E5%90%8C%E7%9A%84%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E4%B8%AD%E9%97%B4%E4%BB%B6%E9%83%BD%E6%9C%89%E4%BB%80%E4%B9%88%E4%BC%98%E7%82%B9%E5%92%8C%E7%BC%BA%E7%82%B9%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>用过哪些分库分表中间件？不同的分库分表中间件都有什么优点和缺点？</h4>\n<p>这个其实就是看看你了解哪些分库分表的中间件，各个中间件的优缺点是啥？然后你用过哪些分库分表的中间件。</p>\n<p>比较常见的包括：</p>\n<ul>\n<li>Cobar</li>\n<li>TDDL</li>\n<li>Atlas</li>\n<li>Sharding-jdbc</li>\n<li>Mycat</li>\n</ul>\n<h5 id="cobar"><a href="#cobar" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Cobar</h5>\n<p>阿里 b2b 团队开发和开源的，属于 proxy 层方案，就是介于应用服务器和数据库服务器之间。应用程序通过 JDBC 驱动访问 Cobar 集群，Cobar 根据 SQL 和分库规则对 SQL 做分解，然后分发到 MySQL 集群不同的数据库实例上执行。早些年还可以用，但是最近几年都没更新了，基本没啥人用，差不多算是被抛弃的状态吧。而且不支持读写分离、存储过程、跨库 join 和分页等操作。</p>\n<h5 id="tddl"><a href="#tddl" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>TDDL</h5>\n<p>淘宝团队开发的，属于 client 层方案。支持基本的 crud 语法和读写分离，但不支持 join、多表查询等语法。目前使用的也不多，因为还依赖淘宝的 diamond 配置管理系统。</p>\n<h5 id="atlas"><a href="#atlas" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Atlas</h5>\n<p>360 开源的，属于 proxy 层方案，以前是有一些公司在用的，但是确实有一个很大的问题就是社区最新的维护都在 5 年前了。所以，现在用的公司基本也很少了。</p>\n<h5 id="sharding-jdbc"><a href="#sharding-jdbc" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Sharding-jdbc</h5>\n<p>当当开源的，属于 client 层方案，是 ShardingSphere 的 client 层方案，ShardingSphere 还提供 proxy 层的方案 Sharding-Proxy。确实之前用的还比较多一些，因为 SQL 语法支持也比较多，没有太多限制，而且截至 2019.4，已经推出到了 4.0.0-RC1 版本，支持分库分表、读写分离、分布式 id 生成、柔性事务（最大努力送达型事务、TCC 事务）。而且确实之前使用的公司会比较多一些（这个在官网有登记使用的公司，可以看到从 2017 年一直到现在，是有不少公司在用的），目前社区也还一直在开发和维护，还算是比较活跃，个人认为算是一个现在也可以选择的方案。</p>\n<h5 id="mycat"><a href="#mycat" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Mycat</h5>\n<p>基于 Cobar 改造的，属于 proxy 层方案，支持的功能非常完善，而且目前应该是非常火的而且不断流行的数据库中间件，社区很活跃，也有一些公司开始在用了。但是确实相比于 Sharding jdbc 来说，年轻一些，经历的锤炼少一些。</p>\n<h5 id="总结-1"><a href="#%E6%80%BB%E7%BB%93-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h5>\n<p>综上，现在其实建议考量的，就是 Sharding-jdbc 和 Mycat，这两个都可以去考虑使用。</p>\n<p>Sharding-jdbc 这种 client 层方案的优点在于不用部署，运维成本低，不需要代理层的二次转发请求，性能很高，但是如果遇到升级啥的需要各个系统都重新升级版本再发布，各个系统都需要耦合 Sharding-jdbc 的依赖；</p>\n<p>Mycat 这种 proxy 层方案的缺点在于需要部署，自己运维一套中间件，运维成本高，但是好处在于对于各个项目是透明的，如果遇到升级之类的都是自己中间件那里搞就行了。</p>\n<p>通常来说，这两个方案其实都可以选用，但是我个人建议中小型公司选用 Sharding-jdbc，client 层方案轻便，而且维护成本低，不需要额外增派人手，而且中小型公司系统复杂度会低一些，项目也没那么多；但是中大型公司最好还是选用 Mycat 这类 proxy 层方案，因为可能大公司系统和项目非常多，团队很大，人员充足，那么最好是专门弄个人来研究和维护 Mycat，然后大量项目直接透明使用即可。</p>\n<h4 id="你们具体是如何对数据库如何进行垂直拆分或水平拆分的？"><a href="#%E4%BD%A0%E4%BB%AC%E5%85%B7%E4%BD%93%E6%98%AF%E5%A6%82%E4%BD%95%E5%AF%B9%E6%95%B0%E6%8D%AE%E5%BA%93%E5%A6%82%E4%BD%95%E8%BF%9B%E8%A1%8C%E5%9E%82%E7%9B%B4%E6%8B%86%E5%88%86%E6%88%96%E6%B0%B4%E5%B9%B3%E6%8B%86%E5%88%86%E7%9A%84%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>你们具体是如何对数据库如何进行垂直拆分或水平拆分的？</h4>\n<p>水平拆分的意思，就是把一个表的数据给弄到多个库的多个表里去，但是每个库的表结构都一样，只不过每个库表放的数据是不同的，所有库表的数据加起来就是全部数据。水平拆分的意义，就是将数据均匀放更多的库里，然后用多个库来扛更高的并发，还有就是用多个库的存储容量来进行扩容。</p>\n<p>垂直拆分的意思，就是把一个有很多字段的表给拆分成多个表，或者是多个库上去。每个库表的结构都不一样，每个库表都包含部分字段。一般来说，会将较少的访问频率很高的字段放到一个表里去，然后将较多的访问频率很低的字段放到另外一个表里去。因为数据库是有缓存的，你访问频率高的行字段越少，就可以在缓存里缓存更多的行，性能就越好。这个一般在表层面做的较多一些。</p>\n<p>这个其实挺常见的，不一定我说，大家很多同学可能自己都做过，把一个大表拆开，订单表、订单支付表、订单商品表。</p>\n<p>还有表层面的拆分，就是分表，将一个表变成 N 个表，就是让每个表的数据量控制在一定范围内，保证 SQL 的性能。否则单表数据量越大，SQL 性能就越差。一般是 200 万行左右，不要太多，但是也得看具体你怎么操作，也可能是 500 万，或者是 100 万。你的 SQL 越复杂，就最好让单表行数越少。</p>\n<p>好了，无论分库还是分表，上面说的那些数据库中间件都是可以支持的。就是基本上那些中间件可以做到你分库分表之后，中间件可以根据你指定的某个字段值，比如说 userid，自动路由到对应的库上去，然后再自动路由到对应的表里去。</p>\n<p>你就得考虑一下，你的项目里该如何分库分表？一般来说，垂直拆分，你可以在表层面来做，对一些字段特别多的表做一下拆分；水平拆分，你可以说是并发承载不了，或者是数据量太大，容量承载不了，你给拆了，按什么字段来拆，你自己想好；分表，你考虑一下，你如果哪怕是拆到每个库里去，并发和容量都 ok 了，但是每个库的表还是太大了，那么你就分表，将这个表分开，保证每个表的数据量并不是很大。</p>\n<p>而且这儿还有两种分库分表的方式：</p>\n<ul>\n<li>按照 range 来分，就是每个库一段连续的数据，这个一般是按比如时间范围来的，但是这种一般较少用，因为很容易产生热点问题，大量的流量都打在最新的数据上了。</li>\n<li>按照某个字段 hash 一下均匀分散，这个较为常用。</li>\n</ul>\n<p>range 来分，好处在于说，扩容的时候很简单，因为你只要预备好，给每个月都准备一个库就可以了，到了一个新的月份的时候，自然而然，就会写新的库了；缺点，但是大部分的请求，都是访问最新的数据。实际生产用 range，要看场景。</p>\n<p>hash 分发，好处在于说，可以平均分配每个库的数据量和请求压力；坏处在于说扩容起来比较麻烦，会有一个数据迁移的过程，之前的数据需要重新计算 hash 值重新分配到不同的库或表。</p>\n<h3 id="分库分表如何平滑过渡？"><a href="#%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E5%A6%82%E4%BD%95%E5%B9%B3%E6%BB%91%E8%BF%87%E6%B8%A1%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>分库分表如何平滑过渡？</h3>\n<h4 id="停机迁移方案"><a href="#%E5%81%9C%E6%9C%BA%E8%BF%81%E7%A7%BB%E6%96%B9%E6%A1%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>停机迁移方案</h4>\n<p>我先给你说一个最 low 的方案，就是很简单，大家伙儿凌晨 12 点开始运维，网站或者 app 挂个公告，说 0 点到早上 6 点进行运维，无法访问。</p>\n<p>接着到 0 点停机，系统停掉，没有流量写入了，此时老的单库单表数据库静止了。然后你之前得写好一个导数的一次性工具，此时直接跑起来，然后将单库单表的数据哗哗哗读出来，写到分库分表里面去。</p>\n<p>导数完了之后，就 ok 了，修改系统的数据库连接配置啥的，包括可能代码和 SQL 也许有修改，那你就用最新的代码，然后直接启动连到新的分库分表上去。</p>\n<p>验证一下，ok 了，完美，大家伸个懒腰，看看看凌晨 4 点钟的北京夜景，打个滴滴回家吧。</p>\n<p>但是这个方案比较 low，谁都能干，我们来看看高大上一点的方案。</p>\n<h4 id="双写迁移方案"><a href="#%E5%8F%8C%E5%86%99%E8%BF%81%E7%A7%BB%E6%96%B9%E6%A1%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>双写迁移方案</h4>\n<p>这个是我们常用的一种迁移方案，比较靠谱一些，不用停机，不用看北京凌晨 4 点的风景。</p>\n<p>简单来说，就是在线上系统里面，之前所有写库的地方，增删改操作，除了对老库增删改，都加上对新库的增删改，这就是所谓的双写，同时写俩库，老库和新库。</p>\n<p>然后系统部署之后，新库数据差太远，用之前说的导数工具，跑起来读老库数据写新库，写的时候要根据 <code class="language-text">gmt_modified</code> 这类字段判断这条数据最后修改的时间，除非是读出来的数据在新库里没有，或者是比新库的数据新才会写。简单来说，就是不允许用老数据覆盖新数据。</p>\n<p>导完一轮之后，有可能数据还是存在不一致，那么就程序自动做一轮校验，比对新老库每个表的每条数据，接着如果有不一样的，就针对那些不一样的，从老库读数据再次写。反复循环，直到两个库每个表的数据都完全一致为止。</p>\n<p>接着当数据完全一致了，就 ok 了，基于仅仅使用分库分表的最新代码，重新部署一次，不就仅仅基于分库分表在操作了么，还没有几个小时的停机时间，很稳。所以现在基本玩儿数据迁移之类的，都是这么干的。</p>\n<h3 id="如何设计可以动态扩容缩容的分库分表方案？"><a href="#%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1%E5%8F%AF%E4%BB%A5%E5%8A%A8%E6%80%81%E6%89%A9%E5%AE%B9%E7%BC%A9%E5%AE%B9%E7%9A%84%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E6%96%B9%E6%A1%88%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>如何设计可以动态扩容缩容的分库分表方案？</h3>\n<p>对于分库分表来说，主要是面对以下问题：</p>\n<ul>\n<li>选择一个数据库中间件，调研、学习、测试；</li>\n<li>设计你的分库分表的一个方案，你要分成多少个库，每个库分成多少个表，比如 3 个库，每个库 4 个表；</li>\n<li>基于选择好的数据库中间件，以及在测试环境建立好的分库分表的环境，然后测试一下能否正常进行分库分表的读写；</li>\n<li>完成单库单表到分库分表的迁移，双写方案；</li>\n<li>线上系统开始基于分库分表对外提供服务；</li>\n<li>扩容了，扩容成 6 个库，每个库需要 12 个表，你怎么来增加更多库和表呢？</li>\n</ul>\n<p>这个是你必须面对的一个事儿，就是你已经弄好分库分表方案了，然后一堆库和表都建好了，基于分库分表中间件的代码开发啥的都好了，测试都 ok 了，数据能均匀分布到各个库和各个表里去，而且接着你还通过双写的方案咔嚓一下上了系统，已经直接基于分库分表方案在搞了。</p>\n<p>那么现在问题来了，你现在这些库和表又支撑不住了，要继续扩容咋办？这个可能就是说你的每个库的容量又快满了，或者是你的表数据量又太大了，也可能是你每个库的写并发太高了，你得继续扩容。</p>\n<h4 id="停机扩容（不推荐）"><a href="#%E5%81%9C%E6%9C%BA%E6%89%A9%E5%AE%B9%EF%BC%88%E4%B8%8D%E6%8E%A8%E8%8D%90%EF%BC%89" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>停机扩容（不推荐）</h4>\n<p>这个方案就跟停机迁移一样，步骤几乎一致，唯一的一点就是那个导数的工具，是把现有库表的数据抽出来慢慢倒入到新的库和表里去。但是最好别这么玩儿，有点不太靠谱，因为既然分库分表就说明数据量实在是太大了，可能多达几亿条，甚至几十亿，你这么玩儿，可能会出问题。</p>\n<p>从单库单表迁移到分库分表的时候，数据量并不是很大，单表最大也就两三千万。那么你写个工具，多弄几台机器并行跑，1 小时数据就导完了。这没有问题。</p>\n<p>如果 3 个库 + 12 个表，跑了一段时间了，数据量都 1 ~ 2 亿了。光是导 2 亿数据，都要导个几个小时，6 点，刚刚导完数据，还要搞后续的修改配置，重启系统，测试验证，10 点才可以搞完。所以不能这么搞。</p>\n<h4 id="优化后的方案"><a href="#%E4%BC%98%E5%8C%96%E5%90%8E%E7%9A%84%E6%96%B9%E6%A1%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>优化后的方案</h4>\n<p>一开始上来就是 32 个库，每个库 32 个表，那么总共是 1024 张表。</p>\n<p>我可以告诉各位同学，这个分法，第一，基本上国内的互联网肯定都是够用了，第二，无论是并发支撑还是数据量支撑都没问题。</p>\n<p>每个库正常承载的写入并发量是 1000，那么 32 个库就可以承载 <code class="language-text">32 * 1000 = 32000</code> 的写并发，如果每个库承载 1500 的写并发，<code class="language-text">32 * 1500 = 48000</code> 的写并发，接近 5 万每秒的写入并发，前面再加一个 MQ，削峰，每秒写入 MQ 8 万条数据，每秒消费 5 万条数据。</p>\n<p>有些除非是国内排名非常靠前的这些公司，他们的最核心的系统的数据库，可能会出现几百台数据库的这么一个规模，128 个库，256 个库，512 个库。</p>\n<p>1024 张表，假设每个表放 500 万数据，在 MySQL 里可以放 50 亿条数据。</p>\n<p>每秒 5 万的写并发，总共 50 亿条数据，对于国内大部分的互联网公司来说，其实一般来说都够了。</p>\n<p>谈分库分表的扩容，第一次分库分表，就一次性给他分个够，32 个库，1024 张表，可能对大部分的中小型互联网公司来说，已经可以支撑好几年了。</p>\n<p>一个实践是利用 <code class="language-text">32 * 32</code> 来分库分表，即分为 32 个库，每个库里一个表分为 32 张表。一共就是 1024 张表。根据某个 id 先根据 32 取模路由到库，再根据 32 取模路由到库里的表。</p>\n<table>\n<thead>\n<tr>\n<th>orderId</th>\n<th>id % 32 (库)</th>\n<th>id / 32 % 32 (表)</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>259</td>\n<td>3</td>\n<td>8</td>\n</tr>\n<tr>\n<td>1189</td>\n<td>5</td>\n<td>5</td>\n</tr>\n<tr>\n<td>352</td>\n<td>0</td>\n<td>11</td>\n</tr>\n<tr>\n<td>4593</td>\n<td>17</td>\n<td>15</td>\n</tr>\n</tbody>\n</table>\n<p>刚开始的时候，这个库可能就是逻辑库，建在一个数据库上的，就是一个 MySQL 服务器可能建了 n 个库，比如 32 个库。后面如果要拆分，就是不断在库和 MySQL 服务器之间做迁移就可以了。然后系统配合改一下配置即可。</p>\n<p>比如说最多可以扩展到 32 个数据库服务器，每个数据库服务器是一个库。如果还是不够？最多可以扩展到 1024 个数据库服务器，每个数据库服务器上面一个库一个表。因为最多是 1024 个表。</p>\n<p>这么搞，是不用自己写代码做数据迁移的，都交给 DBA 来搞好了，但是 DBA 确实是需要做一些库表迁移的工作，但是总比你自己写代码，然后抽数据导数据来的效率高得多吧。</p>\n<p>哪怕是要减少库的数量，也很简单，其实说白了就是按倍数缩容就可以了，然后修改一下路由规则。</p>\n<p>这里对步骤做一个总结：</p>\n<ol>\n<li>设定好几台数据库服务器，每台服务器上几个库，每个库多少个表，推荐是 <code class="language-text">32 库 * 32 表</code>，对于大部分公司来说，可能几年都够了。</li>\n<li>路由的规则，orderId % 32 = 库，orderId / 32 % 32 = 表</li>\n<li>扩容的时候，申请增加更多的数据库服务器，装好 MySQL，呈倍数扩容，4 台服务器，扩到 8 台服务器，再到 16 台服务器。</li>\n<li>由 DBA 负责将原先数据库服务器的库，迁移到新的数据库服务器上去，库迁移是有一些便捷的工具的。</li>\n<li>我们这边就是修改一下配置，调整迁移的库所在数据库服务器的地址。</li>\n<li>重新发布系统，上线，原先的路由规则变都不用变，直接可以基于 n 倍的数据库服务器的资源，继续进行线上系统的提供服务。</li>\n</ol>\n<h3 id="分库分表之后，id-主键如何处理？"><a href="#%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E4%B9%8B%E5%90%8E%EF%BC%8Cid-%E4%B8%BB%E9%94%AE%E5%A6%82%E4%BD%95%E5%A4%84%E7%90%86%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>分库分表之后，id 主键如何处理？</h3>\n<h4 id="基于数据库的实现方案"><a href="#%E5%9F%BA%E4%BA%8E%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%A1%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>基于数据库的实现方案</h4>\n<h5 id="数据库自增-id"><a href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E8%87%AA%E5%A2%9E-id" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>数据库自增 id</h5>\n<p>这个就是说你的系统里每次得到一个 id，都是往一个库的一个表里插入一条没什么业务含义的数据，然后获取一个数据库自增的一个 id。拿到这个 id 之后再往对应的分库分表里去写入。</p>\n<p>这个方案的好处就是方便简单，谁都会用；缺点就是单库生成自增 id，要是高并发的话，就会有瓶颈的；如果你硬是要改进一下，那么就专门开一个服务出来，这个服务每次就拿到当前 id 最大值，然后自己递增几个 id，一次性返回一批 id，然后再把当前最大 id 值修改成递增几个 id 之后的一个值；但是无论如何都是基于单个数据库。</p>\n<p>适合的场景：你分库分表就俩原因，要不就是单库并发太高，要不就是单库数据量太大；除非是你并发不高，但是数据量太大导致的分库分表扩容，你可以用这个方案，因为可能每秒最高并发最多就几百，那么就走单独的一个库和表生成自增主键即可。</p>\n<h5 id="设置数据库-sequence-或者表自增字段步长"><a href="#%E8%AE%BE%E7%BD%AE%E6%95%B0%E6%8D%AE%E5%BA%93-sequence-%E6%88%96%E8%80%85%E8%A1%A8%E8%87%AA%E5%A2%9E%E5%AD%97%E6%AE%B5%E6%AD%A5%E9%95%BF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>设置数据库 sequence 或者表自增字段步长</h5>\n<p>可以通过设置数据库 sequence 或者表的自增字段步长来进行水平伸缩。</p>\n<p>比如说，现在有 8 个服务节点，每个服务节点使用一个 sequence 功能来产生 ID，每个 sequence 的起始 ID 不同，并且依次递增，步长都是 8。</p>\n<p>适合的场景：在用户防止产生的 ID 重复时，这种方案实现起来比较简单，也能达到性能目标。但是服务节点固定，步长也固定，将来如果还要增加服务节点，就不好搞了。</p>\n<h4 id="uuid"><a href="#uuid" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>UUID</h4>\n<p>好处就是本地生成，不要基于数据库来了；不好之处就是，UUID 太长了、占用空间大，作为主键性能太差了；更重要的是，UUID 不具有有序性，会导致 B+ 树索引在写的时候有过多的随机写操作（连续的 ID 可以产生部分顺序写），还有，由于在写的时候不能产生有顺序的 append 操作，而需要进行 insert 操作，将会读取整个 B+ 树节点到内存，在插入这条记录后会将整个节点写回磁盘，这种操作在记录占用空间比较大的情况下，性能下降明显。</p>\n<p>适合的场景：如果你是要随机生成个什么文件名、编号之类的，你可以用 UUID，但是作为主键是不能用 UUID 的。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="97089166976417420000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`UUID.randomUUID().toString().replace(&quot;-&quot;, &quot;&quot;) -> sfsdf23423rr234sfdaf`, `97089166976417420000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java">UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">"-"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span> <span class="token operator">-></span> sfsdf23423rr234sfdaf</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h4 id="获取系统当前时间"><a href="#%E8%8E%B7%E5%8F%96%E7%B3%BB%E7%BB%9F%E5%BD%93%E5%89%8D%E6%97%B6%E9%97%B4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>获取系统当前时间</h4>\n<p>这个就是获取当前时间即可，但是问题是，并发很高的时候，比如一秒并发几千，会有重复的情况，这个是肯定不合适的。基本就不用考虑了。</p>\n<p>适合的场景：一般如果用这个方案，是将当前时间跟很多其他的业务字段拼接起来，作为一个 id，如果业务上你觉得可以接受，那么也是可以的。你可以将别的业务字段值跟当前时间拼接起来，组成一个全局唯一的编号。</p>\n<h4 id="snowflake-算法"><a href="#snowflake-%E7%AE%97%E6%B3%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>snowflake 算法</h4>\n<p>snowflake 算法是 twitter 开源的分布式 id 生成算法，采用 Scala 语言实现，是把一个 64 位的 long 型的 id，1 个 bit 是不用的，用其中的 41 bits 作为毫秒数，用 10 bits 作为工作机器 id，12 bits 作为序列号。</p>\n<ul>\n<li>1 bit：不用，为啥呢？因为二进制里第一个 bit 为如果是 1，那么都是负数，但是我们生成的 id 都是正数，所以第一个 bit 统一都是 0。</li>\n<li>41 bits：表示的是时间戳，单位是毫秒。41 bits 可以表示的数字多达 2^41 - 1 ，也就是可以标识 2^41 - 1 个毫秒值，换算成年就是表示 69 年的时间。</li>\n<li>10 bits：记录工作机器 id，代表的是这个服务最多可以部署在 2^10 台机器上，也就是 1024 台机器。但是 10 bits 里 5 个 bits 代表机房 id，5 个 bits 代表机器 id。意思就是最多代表 2^5 个机房（32 个机房），每个机房里可以代表 2^5 个机器（32 台机器）。</li>\n<li>12 bits：这个是用来记录同一个毫秒内产生的不同 id，12 bits 可以代表的最大正整数是 <code class="language-text">2^12 - 1 = 4096</code>，也就是说可以用这个 12 bits 代表的数字来区分同一个毫秒内的 4096 个不同的 id。</li>\n</ul>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="72290943140758590000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`0 | 0001100 10100010 10111110 10001001 01011100 00 | 10001 | 1 1001 | 0000 00000000`, `72290943140758590000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="sh"\n              >\n                <span class="gatsby-code-button-language">sh</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="sh"><pre style="counter-reset: linenumber NaN" class="language-sh line-numbers"><code class="language-sh">0 | 0001100 10100010 10111110 10001001 01011100 00 | 10001 | 1 1001 | 0000 00000000</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="98387494342576470000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public class IdWorker {\n\n    private long workerId;\n    private long datacenterId;\n    private long sequence;\n\n    public IdWorker(long workerId, long datacenterId, long sequence) {\n        // sanity check for workerId\n        // 这儿不就检查了一下，要求就是你传递进来的机房 id 和机器 id 不能超过 32，不能小于 0\n        if (workerId > maxWorkerId || workerId < 0) {\n            throw new IllegalArgumentException(\n                    String.format(&quot;worker Id can\'t be greater than %d or less than 0&quot;, maxWorkerId));\n        }\n        if (datacenterId > maxDatacenterId || datacenterId < 0) {\n            throw new IllegalArgumentException(\n                    String.format(&quot;datacenter Id can\'t be greater than %d or less than 0&quot;, maxDatacenterId));\n        }\n        System.out.printf(\n                &quot;worker starting. timestamp left shift %d, datacenter id bits %d, worker id bits %d, sequence bits %d, workerid %d&quot;,\n                timestampLeftShift, datacenterIdBits, workerIdBits, sequenceBits, workerId);\n\n        this.workerId = workerId;\n        this.datacenterId = datacenterId;\n        this.sequence = sequence;\n    }\n\n    private long twepoch = 1288834974657L;\n\n    private long workerIdBits = 5L;\n    private long datacenterIdBits = 5L;\n\n    // 这个是二进制运算，就是 5 bit 最多只能有 31 个数字，也就是说机器 id 最多只能是 32 以内\n    private long maxWorkerId = -1L ^ (-1L << workerIdBits);\n\n    // 这个是一个意思，就是 5 bit 最多只能有 31 个数字，机房 id 最多只能是 32 以内\n    private long maxDatacenterId = -1L ^ (-1L << datacenterIdBits);\n    private long sequenceBits = 12L;\n\n    private long workerIdShift = sequenceBits;\n    private long datacenterIdShift = sequenceBits + workerIdBits;\n    private long timestampLeftShift = sequenceBits + workerIdBits + datacenterIdBits;\n    private long sequenceMask = -1L ^ (-1L << sequenceBits);\n\n    private long lastTimestamp = -1L;\n\n    public long getWorkerId() {\n        return workerId;\n    }\n\n    public long getDatacenterId() {\n        return datacenterId;\n    }\n\n    public long getTimestamp() {\n        return System.currentTimeMillis();\n    }\n\n    public synchronized long nextId() {\n        // 这儿就是获取当前时间戳，单位是毫秒\n        long timestamp = timeGen();\n\n        if (timestamp < lastTimestamp) {\n            System.err.printf(&quot;clock is moving backwards.  Rejecting requests until %d.&quot;, lastTimestamp);\n            throw new RuntimeException(String.format(\n                    &quot;Clock moved backwards.  Refusing to generate id for %d milliseconds&quot;, lastTimestamp - timestamp));\n        }\n\n        if (lastTimestamp == timestamp) {\n            // 这个意思是说一个毫秒内最多只能有 4096 个数字\n            // 无论你传递多少进来，这个位运算保证始终就是在 4096 这个范围内，避免你自己传递个 sequence 超过了 4096 这个范围\n            sequence = (sequence + 1) & sequenceMask;\n            if (sequence == 0) {\n                timestamp = tilNextMillis(lastTimestamp);\n            }\n        } else {\n            sequence = 0;\n        }\n\n        // 这儿记录一下最近一次生成 id 的时间戳，单位是毫秒\n        lastTimestamp = timestamp;\n\n        // 这儿就是将时间戳左移，放到 41 bit那儿；\n        // 将机房 id左移放到 5 bit那儿；\n        // 将机器id左移放到 5 bit 那儿；将序号放最后 12 bit；\n        // 最后拼接起来成一个 64 bit 的二进制数字，转换成 10 进制就是个 long 型\n        return ((timestamp - twepoch) << timestampLeftShift) | (datacenterId << datacenterIdShift)\n                | (workerId << workerIdShift) | sequence;\n    }\n\n    private long tilNextMillis(long lastTimestamp) {\n        long timestamp = timeGen();\n        while (timestamp <= lastTimestamp) {\n            timestamp = timeGen();\n        }\n        return timestamp;\n    }\n\n    private long timeGen() {\n        return System.currentTimeMillis();\n    }\n\n    // ---------------测试---------------\n    public static void main(String[] args) {\n        IdWorker worker = new IdWorker(1, 1, 1);\n        for (int i = 0; i < 30; i++) {\n            System.out.println(worker.nextId());\n        }\n    }\n\n}`, `98387494342576470000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IdWorker</span> <span class="token punctuation">{</span>\n\n    <span class="token keyword">private</span> <span class="token keyword">long</span> workerId<span class="token punctuation">;</span>\n    <span class="token keyword">private</span> <span class="token keyword">long</span> datacenterId<span class="token punctuation">;</span>\n    <span class="token keyword">private</span> <span class="token keyword">long</span> sequence<span class="token punctuation">;</span>\n\n    <span class="token keyword">public</span> <span class="token class-name">IdWorker</span><span class="token punctuation">(</span><span class="token keyword">long</span> workerId<span class="token punctuation">,</span> <span class="token keyword">long</span> datacenterId<span class="token punctuation">,</span> <span class="token keyword">long</span> sequence<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token comment">// sanity check for workerId</span>\n        <span class="token comment">// 这儿不就检查了一下，要求就是你传递进来的机房 id 和机器 id 不能超过 32，不能小于 0</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>workerId <span class="token operator">></span> maxWorkerId <span class="token operator">||</span> workerId <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span>\n                    <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"worker Id can\'t be greater than %d or less than 0"</span><span class="token punctuation">,</span> maxWorkerId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>datacenterId <span class="token operator">></span> maxDatacenterId <span class="token operator">||</span> datacenterId <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span>\n                    <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"datacenter Id can\'t be greater than %d or less than 0"</span><span class="token punctuation">,</span> maxDatacenterId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span>\n                <span class="token string">"worker starting. timestamp left shift %d, datacenter id bits %d, worker id bits %d, sequence bits %d, workerid %d"</span><span class="token punctuation">,</span>\n                timestampLeftShift<span class="token punctuation">,</span> datacenterIdBits<span class="token punctuation">,</span> workerIdBits<span class="token punctuation">,</span> sequenceBits<span class="token punctuation">,</span> workerId<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        <span class="token keyword">this</span><span class="token punctuation">.</span>workerId <span class="token operator">=</span> workerId<span class="token punctuation">;</span>\n        <span class="token keyword">this</span><span class="token punctuation">.</span>datacenterId <span class="token operator">=</span> datacenterId<span class="token punctuation">;</span>\n        <span class="token keyword">this</span><span class="token punctuation">.</span>sequence <span class="token operator">=</span> sequence<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">private</span> <span class="token keyword">long</span> twepoch <span class="token operator">=</span> <span class="token number">1288834974657L</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">private</span> <span class="token keyword">long</span> workerIdBits <span class="token operator">=</span> <span class="token number">5L</span><span class="token punctuation">;</span>\n    <span class="token keyword">private</span> <span class="token keyword">long</span> datacenterIdBits <span class="token operator">=</span> <span class="token number">5L</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// 这个是二进制运算，就是 5 bit 最多只能有 31 个数字，也就是说机器 id 最多只能是 32 以内</span>\n    <span class="token keyword">private</span> <span class="token keyword">long</span> maxWorkerId <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1L</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1L</span> <span class="token operator">&lt;&lt;</span> workerIdBits<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// 这个是一个意思，就是 5 bit 最多只能有 31 个数字，机房 id 最多只能是 32 以内</span>\n    <span class="token keyword">private</span> <span class="token keyword">long</span> maxDatacenterId <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1L</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1L</span> <span class="token operator">&lt;&lt;</span> datacenterIdBits<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">private</span> <span class="token keyword">long</span> sequenceBits <span class="token operator">=</span> <span class="token number">12L</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">private</span> <span class="token keyword">long</span> workerIdShift <span class="token operator">=</span> sequenceBits<span class="token punctuation">;</span>\n    <span class="token keyword">private</span> <span class="token keyword">long</span> datacenterIdShift <span class="token operator">=</span> sequenceBits <span class="token operator">+</span> workerIdBits<span class="token punctuation">;</span>\n    <span class="token keyword">private</span> <span class="token keyword">long</span> timestampLeftShift <span class="token operator">=</span> sequenceBits <span class="token operator">+</span> workerIdBits <span class="token operator">+</span> datacenterIdBits<span class="token punctuation">;</span>\n    <span class="token keyword">private</span> <span class="token keyword">long</span> sequenceMask <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1L</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1L</span> <span class="token operator">&lt;&lt;</span> sequenceBits<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">private</span> <span class="token keyword">long</span> lastTimestamp <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1L</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">getWorkerId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">return</span> workerId<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">getDatacenterId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">return</span> datacenterId<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">return</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">long</span> <span class="token function">nextId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token comment">// 这儿就是获取当前时间戳，单位是毫秒</span>\n        <span class="token keyword">long</span> timestamp <span class="token operator">=</span> <span class="token function">timeGen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>timestamp <span class="token operator">&lt;</span> lastTimestamp<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"clock is moving backwards.  Rejecting requests until %d."</span><span class="token punctuation">,</span> lastTimestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>\n                    <span class="token string">"Clock moved backwards.  Refusing to generate id for %d milliseconds"</span><span class="token punctuation">,</span> lastTimestamp <span class="token operator">-</span> timestamp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>lastTimestamp <span class="token operator">==</span> timestamp<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token comment">// 这个意思是说一个毫秒内最多只能有 4096 个数字</span>\n            <span class="token comment">// 无论你传递多少进来，这个位运算保证始终就是在 4096 这个范围内，避免你自己传递个 sequence 超过了 4096 这个范围</span>\n            sequence <span class="token operator">=</span> <span class="token punctuation">(</span>sequence <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> sequenceMask<span class="token punctuation">;</span>\n            <span class="token keyword">if</span> <span class="token punctuation">(</span>sequence <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                timestamp <span class="token operator">=</span> <span class="token function">tilNextMillis</span><span class="token punctuation">(</span>lastTimestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n            sequence <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n\n        <span class="token comment">// 这儿记录一下最近一次生成 id 的时间戳，单位是毫秒</span>\n        lastTimestamp <span class="token operator">=</span> timestamp<span class="token punctuation">;</span>\n\n        <span class="token comment">// 这儿就是将时间戳左移，放到 41 bit那儿；</span>\n        <span class="token comment">// 将机房 id左移放到 5 bit那儿；</span>\n        <span class="token comment">// 将机器id左移放到 5 bit 那儿；将序号放最后 12 bit；</span>\n        <span class="token comment">// 最后拼接起来成一个 64 bit 的二进制数字，转换成 10 进制就是个 long 型</span>\n        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>timestamp <span class="token operator">-</span> twepoch<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> timestampLeftShift<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>datacenterId <span class="token operator">&lt;&lt;</span> datacenterIdShift<span class="token punctuation">)</span>\n                <span class="token operator">|</span> <span class="token punctuation">(</span>workerId <span class="token operator">&lt;&lt;</span> workerIdShift<span class="token punctuation">)</span> <span class="token operator">|</span> sequence<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">private</span> <span class="token keyword">long</span> <span class="token function">tilNextMillis</span><span class="token punctuation">(</span><span class="token keyword">long</span> lastTimestamp<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">long</span> timestamp <span class="token operator">=</span> <span class="token function">timeGen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">while</span> <span class="token punctuation">(</span>timestamp <span class="token operator">&lt;=</span> lastTimestamp<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            timestamp <span class="token operator">=</span> <span class="token function">timeGen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n        <span class="token keyword">return</span> timestamp<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">private</span> <span class="token keyword">long</span> <span class="token function">timeGen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">return</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token comment">// ---------------测试---------------</span>\n    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token class-name">IdWorker</span> worker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IdWorker</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">30</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>worker<span class="token punctuation">.</span><span class="token function">nextId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>怎么说呢，大概这个意思吧，就是说 41 bit 是当前毫秒单位的一个时间戳，就这意思；然后 5 bit 是你传递进来的一个机房 id（但是最大只能是 32 以内），另外 5 bit 是你传递进来的机器 id（但是最大只能是 32 以内），剩下的那个 12 bit 序列号，就是如果跟你上次生成 id 的时间还在一个毫秒内，那么会把顺序给你累加，最多在 4096 个序号以内。</p>\n<p>所以你自己利用这个工具类，自己搞一个服务，然后对每个机房的每个机器都初始化这么一个东西，刚开始这个机房的这个机器的序号就是 0。然后每次接收到一个请求，说这个机房的这个机器要生成一个 id，你就找到对应的 Worker 生成。</p>\n<p>利用这个 snowflake 算法，你可以开发自己公司的服务，甚至对于机房 id 和机器 id，反正给你预留了 5 bit + 5 bit，你换成别的有业务含义的东西也可以的。</p>\n<p>这个 snowflake 算法相对来说还是比较靠谱的，所以你要真是搞分布式 id 生成，如果是高并发啥的，那么用这个应该性能比较好，一般每秒几万并发的场景，也足够你用了。</p>\n<h3 id="读写分离"><a href="#%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>读写分离</h3>\n<h4 id="如何实现-mysql-的读写分离？"><a href="#%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0-mysql-%E7%9A%84%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>如何实现 MySQL 的读写分离？</h4>\n<p>其实很简单，就是基于主从复制架构，简单来说，就搞一个主库，挂多个从库，然后我们就单单只是写主库，然后主库会自动把数据给同步到从库上去。</p>\n<h4 id="mysql-主从复制原理的是啥？"><a href="#mysql-%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E5%8E%9F%E7%90%86%E7%9A%84%E6%98%AF%E5%95%A5%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>MySQL 主从复制原理的是啥？</h4>\n<p>主库将变更写入 binlog 日志，然后从库连接到主库之后，从库有一个 IO 线程，将主库的 binlog 日志拷贝到自己本地，写入一个 relay 中继日志中。接着从库中有一个 SQL 线程会从中继日志读取 binlog，然后执行 binlog 日志中的内容，也就是在自己本地再次执行一遍 SQL，这样就可以保证自己跟主库的数据是一样的。</p>\n<p>这里有一个非常重要的一点，就是从库同步主库数据的过程是串行化的，也就是说主库上并行的操作，在从库上会串行执行。所以这就是一个非常重要的点了，由于从库从主库拷贝日志以及串行执行 SQL 的特点，在高并发场景下，从库的数据一定会比主库慢一些，是有延时的。所以经常出现，刚写入主库的数据可能是读不到的，要过几十毫秒，甚至几百毫秒才能读取到。</p>\n<p>而且这里还有另外一个问题，就是如果主库突然宕机，然后恰好数据还没同步到从库，那么有些数据可能在从库上是没有的，有些数据可能就丢失了。</p>\n<p>所以 MySQL 实际上在这一块有两个机制，一个是半同步复制，用来解决主库数据丢失问题；一个是并行复制，用来解决主从同步延时问题。</p>\n<p>这个所谓半同步复制，也叫 semi-sync 复制，指的就是主库写入 binlog 日志之后，就会将强制此时立即将数据同步到从库，从库将日志写入自己本地的 relay log 之后，接着会返回一个 ack 给主库，主库接收到至少一个从库的 ack 之后才会认为写操作完成了。</p>\n<p>所谓并行复制，指的是从库开启多个线程，并行读取 relay log 中不同库的日志，然后并行重放不同库的日志，这是库级别的并行。</p>\n<h4 id="mysql-主从同步延时问题（精华）"><a href="#mysql-%E4%B8%BB%E4%BB%8E%E5%90%8C%E6%AD%A5%E5%BB%B6%E6%97%B6%E9%97%AE%E9%A2%98%EF%BC%88%E7%B2%BE%E5%8D%8E%EF%BC%89" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>MySQL 主从同步延时问题（精华）</h4>\n<p>以前线上确实处理过因为主从同步延时问题而导致的线上的 bug，属于小型的生产事故。</p>\n<p>是这个么场景。有个同学是这样写代码逻辑的。先插入一条数据，再把它查出来，然后更新这条数据。在生产环境高峰期，写并发达到了 2000/s，这个时候，主从复制延时大概是在小几十毫秒。线上会发现，每天总有那么一些数据，我们期望更新一些重要的数据状态，但在高峰期时候却没更新。用户跟客服反馈，而客服就会反馈给我们。</p>\n<p>我们通过 MySQL 命令：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="14268256667662094000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`show slave status`, `14268256667662094000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="sql"\n              >\n                <span class="gatsby-code-button-language">sql</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="sql"><pre style="counter-reset: linenumber NaN" class="language-sql line-numbers"><code class="language-sql"><span class="token keyword">show</span> slave <span class="token keyword">status</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>查看 <code class="language-text">Seconds_Behind_Master</code>，可以看到从库复制主库的数据落后了几 ms。</p>\n<p>一般来说，如果主从延迟较为严重，有以下解决方案：</p>\n<ul>\n<li>分库，将一个主库拆分为多个主库，每个主库的写并发就减少了几倍，此时主从延迟可以忽略不计。</li>\n<li>打开 MySQL 支持的并行复制，多个库并行复制。如果说某个库的写入并发就是特别高，单库写并发达到了 2000/s，并行复制还是没意义。</li>\n<li>重写代码，写代码的同学，要慎重，插入数据时立马查询可能查不到。</li>\n<li>如果确实是存在必须先插入，立马要求就查询到，然后立马就要反过来执行一些操作，对这个查询设置直连主库。不推荐这种方法，你要是这么搞，读写分离的意义就丧失了。</li>\n</ul>\n<h2 id="高并发系统"><a href="#%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>高并发系统</h2>\n<h3 id="如何设计一个高并发系统？"><a href="#%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1%E4%B8%80%E4%B8%AA%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>如何设计一个高并发系统？</h3>\n<p>可以分为以下 6 点：</p>\n<ul>\n<li>系统拆分</li>\n<li>缓存</li>\n<li>MQ</li>\n<li>分库分表</li>\n<li>读写分离</li>\n<li>ElasticSearch</li>\n</ul>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-09-22-00-55-45-c9ae581949b705b17b5265f2037be59b-b9e7f.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 77.60416666666667%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAIAAACZeshMAAAACXBIWXMAAAsSAAALEgHS3X78AAABaklEQVQoz43T2W7CUAwE0Pz/JyKBBGInKWRhb6An1xKkUaXiB+RtxmPnkj17djgc1uv17XZ7fmbZALzdbu/3O//xeHwna9tW2CYTyr/BUQtrmqYsy/Crqtrv90IOOj5q4eVyCeoO/JXsdDoVRbHb7fI8123+ZrMJpN+6ruXhhb/AAIvFQmtwH49HyNlsdr1eCQGLE8AoyfSVZgCr1cqdFKbTKRYi9ZXJ6mSQsQIf6XtyeBEoY7EFejo5VbLz+WwpY4ayDVRALEBsi+CGp2i5XMLQErfU4Drwzt6BYxkAcdxJX6wkGSWMkhrIoQKXeYZnr28oCyxLbYBDG/B8Psfick5rsgyHkG7yaDSaTCZgUnSi10oCwfC6HbJJ5ivEzW1kRmZbR0IWLwEFCYbkySANjw2NQheKNHeyAUzTBBCXi+8R/mv/v982JNmG9B/z4GG/TtB/2B2Y+vF4HC90UPv/X+XCdibS8Njtc/sBlFeclPGQJ5oAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 09 22 00 55 45" title="" data-src="/static/2023-09-22-00-55-45-c9ae581949b705b17b5265f2037be59b-fee1c.png" data-srcset="/static/2023-09-22-00-55-45-c9ae581949b705b17b5265f2037be59b-a67b7.png 200w,\n/static/2023-09-22-00-55-45-c9ae581949b705b17b5265f2037be59b-0b187.png 400w,\n/static/2023-09-22-00-55-45-c9ae581949b705b17b5265f2037be59b-fee1c.png 800w,\n/static/2023-09-22-00-55-45-c9ae581949b705b17b5265f2037be59b-b9e7f.png 1152w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h4 id="系统拆分"><a href="#%E7%B3%BB%E7%BB%9F%E6%8B%86%E5%88%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>系统拆分</h4>\n<p>将一个系统拆分为多个子系统，用 dubbo 来搞。然后每个系统连一个数据库，这样本来就一个库，现在多个数据库，不也可以扛高并发么。</p>\n<h4 id="缓存-1"><a href="#%E7%BC%93%E5%AD%98-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>缓存</h4>\n<p>缓存，必须得用缓存。大部分的高并发场景，都是读多写少，那你完全可以在数据库和缓存里都写一份，然后读的时候大量走缓存不就得了。毕竟人家 redis 轻轻松松单机几万的并发。所以你可以考虑考虑你的项目里，那些承载主要请求的读场景，怎么用缓存来抗高并发。</p>\n<h4 id="mq"><a href="#mq" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>MQ</h4>\n<p>MQ，必须得用 MQ。可能你还是会出现高并发写的场景，比如说一个业务操作里要频繁搞数据库几十次，增删改增删改，疯了。那高并发绝对搞挂你的系统，你要是用 redis 来承载写那肯定不行，人家是缓存，数据随时就被 LRU 了，数据格式还无比简单，没有事务支持。所以该用 mysql 还得用 mysql 啊。那你咋办？用 MQ 吧，大量的写请求灌入 MQ 里，排队慢慢玩儿，后边系统消费后慢慢写，控制在 mysql 承载范围之内。所以你得考虑考虑你的项目里，那些承载复杂写业务逻辑的场景里，如何用 MQ 来异步写，提升并发性。MQ 单机抗几万并发也是 ok 的，这个之前还特意说过。</p>\n<h4 id="分库分表-1"><a href="#%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>分库分表</h4>\n<p>分库分表，可能到了最后数据库层面还是免不了抗高并发的要求，好吧，那么就将一个数据库拆分为多个库，多个库来扛更高的并发；然后将一个表拆分为多个表，每个表的数据量保持少一点，提高 sql 跑的性能。</p>\n<h4 id="读写分离-1"><a href="#%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>读写分离</h4>\n<p>读写分离，这个就是说大部分时候数据库可能也是读多写少，没必要所有请求都集中在一个库上吧，可以搞个主从架构，主库写入，从库读取，搞一个读写分离。读流量太多的时候，还可以加更多的从库。</p>\n<h4 id="elasticsearch"><a href="#elasticsearch" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ElasticSearch</h4>\n<p>Elasticsearch，简称 es。es 是分布式的，可以随便扩容，分布式天然就可以支撑高并发，因为动不动就可以扩容加机器来扛更高的并发。那么一些比较简单的查询、统计类的操作，可以考虑用 es 来承载，还有一些全文搜索类的操作，也可以考虑用 es 来承载。</p>\n<p>上面的 6 点，基本就是高并发系统肯定要干的一些事儿，大家可以仔细结合之前讲过的知识考虑一下，到时候你可以系统的把这块阐述一下，然后每个部分要注意哪些问题，之前都讲过了，你都可以阐述阐述，表明你对这块是有点积累的。</p>\n<p>说句实话，毕竟你真正厉害的一点，不是在于弄明白一些技术，或者大概知道一个高并发系统应该长什么样？其实实际上在真正的复杂的业务系统里，做高并发要远远比上面提到的点要复杂几十倍到上百倍。你需要考虑：哪些需要分库分表，哪些不需要分库分表，单库单表跟分库分表如何 join，哪些数据要放到缓存里去，放哪些数据才可以扛住高并发的请求，你需要完成对一个复杂业务系统的分析之后，然后逐步逐步的加入高并发的系统架构的改造，这个过程是无比复杂的，一旦做过一次，并且做好了，你在这个市场上就会非常的吃香。</p>\n<p>其实大部分公司，真正看重的，不是说你掌握高并发相关的一些基本的架构知识，架构中的一些技术，RocketMQ、Kafka、Redis、Elasticsearch，高并发这一块，你了解了，也只能是次一等的人才。对一个有几十万行代码的复杂的分布式系统，一步一步架构、设计以及实践过高并发架构的人，这个经验是难能可贵的。</p>\n<h1 id="分布式系统"><a href="#%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>分布式系统</h1>\n<p>分布式业务系统，就是把原来用 Java 开发的一个大块系统，给拆分成多个子系统，多个子系统之间互相调用，形成一个大系统的整体。假设原来你做了一个 OA 系统，里面包含了权限模块、员工模块、请假模块、财务模块，一个工程，里面包含了一堆模块，模块与模块之间会互相去调用，1 台机器部署。现在如果你把这个系统给拆开，权限系统、员工系统、请假系统、财务系统 4 个系统，4 个工程，分别在 4 台机器上部署。一个请求过来，完成这个请求，这个员工系统，调用权限系统，调用请假系统，调用财务系统，4 个系统分别完成了一部分的事情，最后 4 个系统都干完了以后，才认为是这个请求已经完成了。</p>\n<blockquote>\n<p>近几年开始兴起和流行 Spring Cloud，刚流行还没开始普及，目前普及的是 Dubbo，因此这里也主要讲 Dubbo。</p>\n</blockquote>\n<p>面试官可能会问你以下问题。</p>\n<p>为什么要进行系统拆分？</p>\n<ul>\n<li>为什么要进行系统拆分？如何进行系统拆分？拆分后不用 Dubbo 可以吗？Dubbo 和 thrift 有什么区别呢？</li>\n</ul>\n<p>分布式服务框架</p>\n<ul>\n<li>说一下 Dubbo 的工作原理？注册中心挂了可以继续通信吗？</li>\n<li>Dubbo 支持哪些序列化协议？说一下 Hessian 的数据结构？PB 知道吗？为什么 PB 的效率是最高的？</li>\n<li>Dubbo 负载均衡策略和高可用策略都有哪些？动态代理策略呢？</li>\n<li>Dubbo 的 SPI 思想是什么？</li>\n<li>如何基于 Dubbo 进行服务治理、服务降级、失败重试以及超时重试？</li>\n<li>分布式服务接口的幂等性如何设计（比如不能重复扣款）？</li>\n<li>分布式服务接口请求的顺序性如何保证？</li>\n<li>如何自己设计一个类似 Dubbo 的 RPC 框架？</li>\n</ul>\n<p>分布式锁</p>\n<ul>\n<li>使用 Redis 如何设计分布式锁？使用 zk 来设计分布式锁可以吗？这两种分布式锁的实现方式哪种效率比较高？</li>\n</ul>\n<p>分布式事务</p>\n<ul>\n<li>分布式事务了解吗？你们如何解决分布式事务问题的？TCC 如果出现网络连不通怎么办？XA 的一致性如何保证？</li>\n</ul>\n<p>分布式会话</p>\n<ul>\n<li>集群部署时的分布式 Session 如何实现？</li>\n</ul>\n<h2 id="系统拆分-1"><a href="#%E7%B3%BB%E7%BB%9F%E6%8B%86%E5%88%86-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>系统拆分</h2>\n<h3 id="为什么系统要拆分？"><a href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E7%B3%BB%E7%BB%9F%E8%A6%81%E6%8B%86%E5%88%86%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>为什么系统要拆分？</h3>\n<p>要是不拆分，一个大系统几十万行代码，20 个人维护一份代码，简直是悲剧啊。代码经常改着改着就冲突了，各种代码冲突和合并要处理，非常耗费时间；经常我改动了我的代码，你调用了我的，导致你的代码也得重新测试，麻烦的要死；然后每次发布都是几十万行代码的系统一起发布，大家得一起提心吊胆准备上线，几十万行代码的上线，可能每次上线都要做很多的检查，很多异常问题的处理，简直是又麻烦又痛苦；而且如果我现在打算把技术升级到最新的 spring 版本，还不行，因为这可能导致你的代码报错，我不敢随意乱改技术。</p>\n<p>假设一个系统是 20 万行代码，其中 A 在里面改了 1000 行代码，但是此时发布的时候是这个 20 万行代码的大系统一块儿发布。就意味着 20 万代码在线上就可能出现各种变化，20 个人，每个人都要紧张地等在电脑面前，上线之后，检查日志，看自己负责的那一块儿有没有什么问题。</p>\n<p>A 就检查了自己负责的 1 万行代码对应的功能，确保 ok 就闪人了；结果不巧的是，A 上线的时候不小心修改了线上机器的某个配置，导致另外 B 和 C 负责的 2 万行代码对应的一些功能，出错了。</p>\n<p>几十个人负责维护一个几十万行代码的单块应用，每次上线，准备几个礼拜，上线 -> 部署 -> 检查自己负责的功能。</p>\n<p>拆分了以后，整个世界清爽了，几十万行代码的系统，拆分成 20 个服务，平均每个服务就 1~2 万行代码，每个服务部署到单独的机器上。20 个工程，20 个 git 代码仓库，20 个开发人员，每个人维护自己的那个服务就可以了，是自己独立的代码，跟别人没关系。再也没有代码冲突了，爽。每次就测试我自己的代码就可以了，爽。每次就发布我自己的一个小服务就可以了，爽。技术上想怎么升级就怎么升级，保持接口不变就可以了，真爽。</p>\n<p>所以简单来说，一句话总结，如果是那种代码量多达几十万行的中大型项目，团队里有几十个人，那么如果不拆分系统，开发效率极其低下，问题很多。但是拆分系统之后，每个人就负责自己的一小部分就好了，可以随便玩儿随便弄。分布式系统拆分之后，可以大幅度提升复杂系统大型团队的开发效率。</p>\n<p>但是同时，也要提醒的一点是，系统拆分成分布式系统之后，大量的分布式系统面临的问题也是接踵而来，所以后面的问题都是在围绕分布式系统带来的复杂技术挑战在说。</p>\n<h4 id="如何进行系统拆分？"><a href="#%E5%A6%82%E4%BD%95%E8%BF%9B%E8%A1%8C%E7%B3%BB%E7%BB%9F%E6%8B%86%E5%88%86%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>如何进行系统拆分？</h4>\n<p>这个问题说大可以很大，可以扯到领域驱动模型设计上去，说小了也很小，我不太想给大家太过于学术的说法，因为你也不可能背这个答案，过去了直接说吧。还是说的简单一点，大家自己到时候知道怎么回答就行了。</p>\n<p>系统拆分为分布式系统，拆成多个服务，拆成微服务的架构，是需要拆很多轮的。并不是说上来一个架构师一次就给拆好了，而以后都不用拆。</p>\n<p>第一轮；团队继续扩大，拆好的某个服务，刚开始是 1 个人维护 1 万行代码，后来业务系统越来越复杂，这个服务是 10 万行代码，5 个人；第二轮，1 个服务 -> 5 个服务，每个服务 2 万行代码，每人负责一个服务。</p>\n<p>如果是多人维护一个服务，最理想的情况下，几十个人，1 个人负责 1 个或 2 ~ 3 个服务；某个服务工作量变大了，代码量越来越多，某个同学，负责一个服务，代码量变成了 10 万行了，他自己不堪重负，他现在一个人拆开，5 个服务，1 个人顶着，负责 5 个人，接着招人，2 个人，给那个同学带着，3 个人负责 5 个服务，其中 2 个人每个人负责 2 个服务，1 个人负责 1 个服务。</p>\n<p>个人建议，一个服务的代码不要太多，1 万行左右，两三万撑死了吧。</p>\n<p>大部分的系统，是要进行多轮拆分的，第一次拆分，可能就是将以前的多个模块该拆分开来了，比如说将电商系统拆分成订单系统、商品系统、采购系统、仓储系统、用户系统，等等吧。</p>\n<p>但是后面可能每个系统又变得越来越复杂了，比如说采购系统里面又分成了供应商管理系统、采购单管理系统，订单系统又拆分成了购物车系统、价格系统、订单管理系统。</p>\n<p>扯深了实在很深，所以这里先给大家举个例子，你自己感受一下，核心意思就是根据情况，先拆分一轮，后面如果系统更复杂了，可以继续分拆。你根据自己负责系统的例子，来考虑一下就好了。</p>\n<h4 id="拆分后不用-dubbo-可以吗？"><a href="#%E6%8B%86%E5%88%86%E5%90%8E%E4%B8%8D%E7%94%A8-dubbo-%E5%8F%AF%E4%BB%A5%E5%90%97%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>拆分后不用 dubbo 可以吗？</h4>\n<p>当然可以了，大不了最次，就是各个系统之间，直接基于 spring mvc，就纯 http 接口互相通信呗，还能咋样。但是这个肯定是有问题的，因为 http 接口通信维护起来成本很高，你要考虑超时重试、负载均衡等等各种乱七八糟的问题，比如说你的订单系统调用商品系统，商品系统部署了 5 台机器，你怎么把请求均匀地甩给那 5 台机器？这不就是负载均衡？你要是都自己搞那是可以的，但是确实很痛苦。</p>\n<p>所以 dubbo 说白了，是一种 rpc 框架，就是说本地就是进行接口调用，但是 dubbo 会代理这个调用请求，跟远程机器网络通信，给你处理掉负载均衡、服务实例上下线自动感知、超时重试等等乱七八糟的问题。那你就不用自己做了，用 dubbo 就可以了。</p>\n<h2 id="分布式服务框架"><a href="#%E5%88%86%E5%B8%83%E5%BC%8F%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>分布式服务框架</h2>\n<h3 id="说一下-dubbo-的工作原理？"><a href="#%E8%AF%B4%E4%B8%80%E4%B8%8B-dubbo-%E7%9A%84%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>说一下 Dubbo 的工作原理？</h3>\n<h4 id="dubbo-工作原理"><a href="#dubbo-%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>dubbo 工作原理</h4>\n<ol>\n<li>第一层：service 层，接口层，给服务提供者和消费者来实现的</li>\n<li>第二层：config 层，配置层，主要是对 dubbo 进行各种配置的</li>\n<li>第三层：proxy 层，服务代理层，无论是 consumer 还是 provider，dubbo 都会给你生成代理，代理之间进行网络通信</li>\n<li>第四层：registry 层，服务注册层，负责服务的注册与发现</li>\n<li>第五层：cluster 层，集群层，封装多个服务提供者的路由以及负载均衡，将多个实例组合成一个服务</li>\n<li>第六层：monitor 层，监控层，对 rpc 接口的调用次数和调用时间进行监控</li>\n<li>第七层：protocal 层，远程调用层，封装 rpc 调用</li>\n<li>第八层：exchange 层，信息交换层，封装请求响应模式，同步转异步</li>\n<li>第九层：transport 层，网络传输层，抽象 mina 和 netty 为统一接口</li>\n<li>第十层：serialize 层，数据序列化层</li>\n</ol>\n<h4 id="工作流程"><a href="#%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>工作流程</h4>\n<ol>\n<li>第一步：provider 向注册中心去注册</li>\n<li>第二步：consumer 从注册中心订阅服务，注册中心会通知 consumer 注册好的服务</li>\n<li>第三步：consumer 调用 provider</li>\n<li>第四步：consumer 和 provider 都异步通知监控中心</li>\n</ol>\n<h4 id="注册中心挂了可以继续通信吗？"><a href="#%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E6%8C%82%E4%BA%86%E5%8F%AF%E4%BB%A5%E7%BB%A7%E7%BB%AD%E9%80%9A%E4%BF%A1%E5%90%97%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>注册中心挂了可以继续通信吗？</h4>\n<p>可以，因为刚开始初始化的时候，消费者会将提供者的地址等信息拉取到本地缓存，所以注册中心挂了可以继续通信。</p>\n<h3 id="dubbo-支持哪些序列化协议？"><a href="#dubbo-%E6%94%AF%E6%8C%81%E5%93%AA%E4%BA%9B%E5%BA%8F%E5%88%97%E5%8C%96%E5%8D%8F%E8%AE%AE%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Dubbo 支持哪些序列化协议？</h3>\n<p>序列化，就是把数据结构或者是一些对象，转换为二进制串的过程，而反序列化是将在序列化过程中所生成的二进制串转换成数据结构或者对象的过程。</p>\n<h4 id="dubbo-支持不同的通信协议"><a href="#dubbo-%E6%94%AF%E6%8C%81%E4%B8%8D%E5%90%8C%E7%9A%84%E9%80%9A%E4%BF%A1%E5%8D%8F%E8%AE%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>dubbo 支持不同的通信协议</h4>\n<ul>\n<li>\n<p>dubbo 协议 dubbo://</p>\n<p>默认就是走 dubbo 协议，单一长连接，进行的是 NIO 异步通信，基于 hessian 作为序列化协议。使用的场景是：传输数据量小（每次请求在 100kb 以内），但是并发量很高，以及服务消费者机器数远大于服务提供者机器数的情况。</p>\n<p>为了要支持高并发场景，一般是服务提供者就几台机器，但是服务消费者有上百台，可能每天调用量达到上亿次！此时用长连接是最合适的，就是跟每个服务消费者维持一个长连接就可以，可能总共就 100 个连接。然后后面直接基于长连接 NIO 异步通信，可以支撑高并发请求。</p>\n<p>长连接，通俗点说，就是建立连接过后可以持续发送请求，无须再建立连接。</p>\n<p>而短连接，每次要发送请求之前，需要先重新建立一次连接。</p>\n</li>\n<li>\n<p>rmi 协议 rmi://</p>\n<p>RMI 协议采用 JDK 标准的 <code class="language-text">java.rmi.*</code> 实现，采用阻塞式短连接和 JDK 标准序列化方式。多个短连接，适合消费者和提供者数量差不多的情况，适用于文件的传输，一般较少用。</p>\n</li>\n<li>\n<p>hessian 协议 hessian://</p>\n<p>Hessian 1 协议用于集成 Hessian 的服务，Hessian 底层采用 Http 通讯，采用 Servlet 暴露服务，Dubbo 缺省内嵌 Jetty 作为服务器实现。走 hessian 序列化协议，多个短连接，适用于提供者数量比消费者数量还多的情况，适用于文件的传输，一般较少用。</p>\n</li>\n<li>\n<p>http 协议 http://</p>\n<p>基于 HTTP 表单的远程调用协议，采用 Spring 的 HttpInvoker 实现。走表单序列化。</p>\n</li>\n<li>\n<p>thrift 协议 thrift://</p>\n<p>当前 dubbo 支持的 thrift 协议是对 thrift 原生协议的扩展，在原生协议的基础上添加了一些额外的头信息，比如 service name，magic number 等。</p>\n</li>\n<li>\n<p>webservice webservice://</p>\n<p>基于 WebService 的远程调用协议，基于 Apache CXF 的 frontend-simple 和 transports-http 实现。走 SOAP 文本序列化。</p>\n</li>\n<li>\n<p>memcached 协议 memcached://</p>\n<p>基于 memcached 实现的 RPC 协议。</p>\n</li>\n<li>\n<p>redis 协议 redis://</p>\n<p>基于 Redis 实现的 RPC 协议。</p>\n</li>\n<li>\n<p>rest 协议 rest://</p>\n<p>基于标准的 Java REST API —— JAX-RS 2.0（Java API for RESTful Web Services 的简写）实现的 REST 调用支持。</p>\n</li>\n<li>\n<p>gPRC 协议 grpc://</p>\n<p>Dubbo 自 2.7.5 版本开始支持 gRPC 协议，对于计划使用 HTTP/2 通信，或者想利用 gRPC 带来的 Stream、反压、Reactive 编程等能力的开发者来说，都可以考虑启用 gRPC 协议。</p>\n</li>\n</ul>\n<h4 id="dubbo-支持的序列化协议"><a href="#dubbo-%E6%94%AF%E6%8C%81%E7%9A%84%E5%BA%8F%E5%88%97%E5%8C%96%E5%8D%8F%E8%AE%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>dubbo 支持的序列化协议</h4>\n<p>dubbo 支持 hession、Java 二进制序列化、json、SOAP 文本序列化多种序列化协议。但是 hessian 是其默认的序列化协议。</p>\n<h4 id="说一下-hessian-的数据结构"><a href="#%E8%AF%B4%E4%B8%80%E4%B8%8B-hessian-%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>说一下 Hessian 的数据结构</h4>\n<p>Hessian 的对象序列化机制有 8 种原始类型：</p>\n<ul>\n<li>原始二进制数据</li>\n<li>boolean</li>\n<li>64-bit date（64 位毫秒值的日期）</li>\n<li>64-bit double</li>\n<li>32-bit int</li>\n<li>64-bit long</li>\n<li>null</li>\n<li>UTF-8 编码的 string</li>\n</ul>\n<p>另外还包括 3 种递归类型：</p>\n<ul>\n<li>list for lists and arrays</li>\n<li>map for maps and dictionaries</li>\n<li>object for objects</li>\n</ul>\n<p>还有一种特殊的类型：</p>\n<ul>\n<li>ref：用来表示对共享对象的引用。</li>\n</ul>\n<h4 id="为什么-pb-的效率是最高的？"><a href="#%E4%B8%BA%E4%BB%80%E4%B9%88-pb-%E7%9A%84%E6%95%88%E7%8E%87%E6%98%AF%E6%9C%80%E9%AB%98%E7%9A%84%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>为什么 PB 的效率是最高的？</h4>\n<p>其实 PB 之所以性能如此好，主要得益于两个：第一，它使用 proto 编译器，自动进行序列化和反序列化，速度非常快，应该比 XML 和 JSON 快上了 20 ~ 100 倍；第二，它的数据压缩效果好，就是说它序列化后的数据量体积小。因为体积小，传输起来带宽和速度上会有优化。</p>\n<h3 id="dubbo-负载均衡策略和集群容错策略？"><a href="#dubbo-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AD%96%E7%95%A5%E5%92%8C%E9%9B%86%E7%BE%A4%E5%AE%B9%E9%94%99%E7%AD%96%E7%95%A5%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Dubbo 负载均衡策略和集群容错策略？</h3>\n<h4 id="dubbo-负载均衡策略"><a href="#dubbo-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AD%96%E7%95%A5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>dubbo 负载均衡策略</h4>\n<h5 id="randomloadbalance"><a href="#randomloadbalance" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>RandomLoadBalance</h5>\n<p>默认情况下，dubbo 是 RandomLoadBalance，即随机调用实现负载均衡，可以对 provider 不同实例设置不同的权重，会按照权重来负载均衡，权重越大分配流量越高，一般就用这个默认的就可以了。</p>\n<p>算法思想很简单。假设有一组服务器 servers = <code class="language-text">[A, B, C]</code>，他们对应的权重为 weights = <code class="language-text">[5, 3, 2]</code>，权重总和为 10。现在把这些权重值平铺在一维坐标值上，<code class="language-text">[0, 5)</code> 区间属于服务器 A，<code class="language-text">[5, 8)</code> 区间属于服务器 B，<code class="language-text">[8, 10)</code> 区间属于服务器 C。接下来通过随机数生成器生成一个范围在 <code class="language-text">[0, 10)</code> 之间的随机数，然后计算这个随机数会落到哪个区间上。比如数字 3 会落到服务器 A 对应的区间上，此时返回服务器 A 即可。权重越大的机器，在坐标轴上对应的区间范围就越大，因此随机数生成器生成的数字就会有更大的概率落到此区间内。只要随机数生成器产生的随机数分布性很好，在经过多次选择后，每个服务器被选中的次数比例接近其权重比例。比如，经过一万次选择后，服务器 A 被选中的次数大约为 5000 次，服务器 B 被选中的次数约为 3000 次，服务器 C 被选中的次数约为 2000 次。</p>\n<h5 id="roundrobinloadbalance"><a href="#roundrobinloadbalance" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>RoundRobinLoadBalance</h5>\n<p>这个的话默认就是均匀地将流量打到各个机器上去，但是如果各个机器的性能不一样，容易导致性能差的机器负载过高。所以此时需要调整权重，让性能差的机器承载权重小一些，流量少一些。</p>\n<p>举个栗子。</p>\n<p>跟运维同学申请机器，有的时候，我们运气好，正好公司资源比较充足，刚刚有一批热气腾腾、刚刚做好的虚拟机新鲜出炉，配置都比较高：8 核 + 16G 机器，申请到 2 台。过了一段时间，我们感觉 2 台机器有点不太够，我就去找运维同学说，“哥儿们，你能不能再给我一台机器”，但是这时只剩下一台 4 核 + 8G 的机器。我要还是得要。</p>\n<p>这个时候，可以给两台 8 核 16G 的机器设置权重 4，给剩余 1 台 4 核 8G 的机器设置权重 2。</p>\n<h5 id="leastactiveloadbalance"><a href="#leastactiveloadbalance" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>LeastActiveLoadBalance</h5>\n<p>官网对 LeastActiveLoadBalance 的解释是“最小活跃数负载均衡”，活跃调用数越小，表明该服务提供者效率越高，单位时间内可处理更多的请求，那么此时请求会优先分配给该服务提供者。</p>\n<p>最小活跃数负载均衡算法的基本思想是这样的：</p>\n<p>每个服务提供者会对应着一个活跃数 active。初始情况下，所有服务提供者的 active 均为 0。每当收到一个请求，对应的服务提供者的 active 会加 1，处理完请求后，active 会减 1。所以，如果服务提供者性能较好，处理请求的效率就越高，那么 active 也会下降的越快。因此可以给这样的服务提供者优先分配请求。</p>\n<p>当然，除了最小活跃数，LeastActiveLoadBalance 在实现上还引入了权重值。所以准确的来说，LeastActiveLoadBalance 是基于加权最小活跃数算法实现的。</p>\n<h5 id="consistenthashloadbalance"><a href="#consistenthashloadbalance" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ConsistentHashLoadBalance</h5>\n<p>一致性 Hash 算法，相同参数的请求一定分发到一个 provider 上去，provider 挂掉的时候，会基于虚拟节点均匀分配剩余的流量，抖动不会太大。如果你需要的不是随机负载均衡，是要一类请求都到一个节点，那就走这个一致性 Hash 策略。</p>\n<blockquote>\n<p>关于 dubbo 负载均衡策略更加详细的描述，可以查看官网 <a href="https://dubbo.apache.org/zh/docs/advanced/loadbalance" target="_blank" rel="nofollow noreferrer noopener">https://dubbo.apache.org/zh/docs/advanced/loadbalance</a> 。</p>\n</blockquote>\n<h4 id="dubbo-集群容错策略"><a href="#dubbo-%E9%9B%86%E7%BE%A4%E5%AE%B9%E9%94%99%E7%AD%96%E7%95%A5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>dubbo 集群容错策略</h4>\n<h5 id="failover-cluster-模式"><a href="#failover-cluster-%E6%A8%A1%E5%BC%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Failover Cluster 模式</h5>\n<p>失败自动切换，自动重试其他机器，默认就是这个，常见于读操作。（失败重试其它机器）</p>\n<p>可以通过以下几种方式配置重试次数：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="79875226260837880000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<dubbo:service retries=&quot;2&quot; />`, `79875226260837880000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="xml"\n              >\n                <span class="gatsby-code-button-language">xml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="xml"><pre style="counter-reset: linenumber NaN" class="language-xml line-numbers"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">dubbo:</span>service</span> <span class="token attr-name">retries</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>2<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>或者</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="26718304683151950000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<dubbo:reference retries=&quot;2&quot; />`, `26718304683151950000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="xml"\n              >\n                <span class="gatsby-code-button-language">xml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="xml"><pre style="counter-reset: linenumber NaN" class="language-xml line-numbers"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">dubbo:</span>reference</span> <span class="token attr-name">retries</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>2<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>或者</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="71576252491011560000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<dubbo:reference>\n    <dubbo:method name=&quot;findFoo&quot; retries=&quot;2&quot; />\n</dubbo:reference>`, `71576252491011560000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="xml"\n              >\n                <span class="gatsby-code-button-language">xml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="xml"><pre style="counter-reset: linenumber NaN" class="language-xml line-numbers"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">dubbo:</span>reference</span><span class="token punctuation">></span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">dubbo:</span>method</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>findFoo<span class="token punctuation">"</span></span> <span class="token attr-name">retries</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>2<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">dubbo:</span>reference</span><span class="token punctuation">></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<h5 id="failfast-cluster-模式"><a href="#failfast-cluster-%E6%A8%A1%E5%BC%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Failfast Cluster 模式</h5>\n<p>一次调用失败就立即失败，常见于非幂等性的写操作，比如新增一条记录（调用失败就立即失败）</p>\n<h5 id="failsafe-cluster-模式"><a href="#failsafe-cluster-%E6%A8%A1%E5%BC%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Failsafe Cluster 模式</h5>\n<p>出现异常时忽略掉，常用于不重要的接口调用，比如记录日志。</p>\n<p>配置示例如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="88865120015871900000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<dubbo:service cluster=&quot;failsafe&quot; />`, `88865120015871900000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="xml"\n              >\n                <span class="gatsby-code-button-language">xml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="xml"><pre style="counter-reset: linenumber NaN" class="language-xml line-numbers"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">dubbo:</span>service</span> <span class="token attr-name">cluster</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>failsafe<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>或者</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="21840358249495460000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<dubbo:reference cluster=&quot;failsafe&quot; />`, `21840358249495460000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="xml"\n              >\n                <span class="gatsby-code-button-language">xml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="xml"><pre style="counter-reset: linenumber NaN" class="language-xml line-numbers"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">dubbo:</span>reference</span> <span class="token attr-name">cluster</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>failsafe<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h5 id="failback-cluster-模式"><a href="#failback-cluster-%E6%A8%A1%E5%BC%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Failback Cluster 模式</h5>\n<p>失败了后台自动记录请求，然后定时重发，比较适合于写消息队列这种。</p>\n<h5 id="forking-cluster-模式"><a href="#forking-cluster-%E6%A8%A1%E5%BC%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Forking Cluster 模式</h5>\n<p>并行调用多个 provider，只要一个成功就立即返回。常用于实时性要求比较高的读操作，但是会浪费更多的服务资源，可通过 <code class="language-text">forks=&quot;2&quot;</code> 来设置最大并行数。</p>\n<h5 id="broadcast-cluster-模式"><a href="#broadcast-cluster-%E6%A8%A1%E5%BC%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Broadcast Cluster 模式</h5>\n<p>逐个调用所有的 provider。任何一个 provider 出错则报错（从 2.1.0 版本开始支持）。通常用于通知所有提供者更新缓存或日志等本地资源信息。</p>\n<blockquote>\n<p>关于 dubbo 集群容错策略更加详细的描述，可以查看官网 <a href="https://dubbo.apache.org/zh/docs/advanced/fault-tolerent-strategy" target="_blank" rel="nofollow noreferrer noopener">https://dubbo.apache.org/zh/docs/advanced/fault-tolerent-strategy</a> 。</p>\n</blockquote>\n<h4 id="dubbo-动态代理策略"><a href="#dubbo-%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E7%AD%96%E7%95%A5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>dubbo 动态代理策略</h4>\n<p>默认使用 javassist 动态字节码生成，创建代理类。但是可以通过 spi 扩展机制配置自己的动态代理策略。</p>\n<h3 id="dubbo-的-spi-思想是什么？"><a href="#dubbo-%E7%9A%84-spi-%E6%80%9D%E6%83%B3%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Dubbo 的 SPI 思想是什么？</h3>\n<h4 id="spi-是啥？"><a href="#spi-%E6%98%AF%E5%95%A5%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>spi 是啥？</h4>\n<p>spi，简单来说，就是 service provider interface，说白了是什么意思呢，比如你有个接口，现在这个接口有 3 个实现类，那么在系统运行的时候对这个接口到底选择哪个实现类呢？这就需要 spi 了，需要根据指定的配置或者是默认的配置，去找到对应的实现类加载进来，然后用这个实现类的实例对象。</p>\n<p>举个栗子。</p>\n<p>你有一个接口 A。A1 / A2 / A3 分别是接口 A 的不同实现。你通过配置接口 A = 实现 A2 ，那么在系统实际运行的时候，会加载你的配置，用实现 A2 实例化一个对象来提供服务。</p>\n<p>spi 机制一般用在哪儿？插件扩展的场景，比如说你开发了一个给别人使用的开源框架，如果你想让别人自己写个插件，插到你的开源框架里面，从而扩展某个功能，这个时候 spi 思想就用上了。</p>\n<h4 id="java-spi-思想的体现"><a href="#java-spi-%E6%80%9D%E6%83%B3%E7%9A%84%E4%BD%93%E7%8E%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Java spi 思想的体现</h4>\n<p>spi 经典的思想体现，大家平时都在用，比如说 jdbc。</p>\n<p>Java 定义了一套 jdbc 的接口，但是 Java 并没有提供 jdbc 的实现类。</p>\n<p>但是实际上项目跑的时候，要使用 jdbc 接口的哪些实现类呢？一般来说，我们要根据自己使用的数据库，比如 mysql，你就将 <code class="language-text">mysql-jdbc-connector.jar</code> 引入进来；oracle，你就将 <code class="language-text">oracle-jdbc-connector.jar</code> 引入进来。</p>\n<p>在系统跑的时候，碰到你使用 jdbc 的接口，他会在底层使用你引入的那个 jar 中提供的实现类。</p>\n<h4 id="dubbo-的-spi-思想"><a href="#dubbo-%E7%9A%84-spi-%E6%80%9D%E6%83%B3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>dubbo 的 spi 思想</h4>\n<p>dubbo 也用了 spi 思想，不过没有用 jdk 的 spi 机制，是自己实现的一套 spi 机制。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="71016205735171980000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`Protocol protocol = ExtensionLoader.getExtensionLoader(Protocol.class).getAdaptiveExtension();`, `71016205735171980000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token class-name">Protocol</span> protocol <span class="token operator">=</span> <span class="token class-name">ExtensionLoader</span><span class="token punctuation">.</span><span class="token function">getExtensionLoader</span><span class="token punctuation">(</span><span class="token class-name">Protocol</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAdaptiveExtension</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>Protocol 接口，在系统运行的时候，dubbo 会判断一下应该选用这个 Protocol 接口的哪个实现类来实例化对象来使用。</p>\n<p>它会去找一个你配置的 Protocol，将你配置的 Protocol 实现类，加载到 jvm 中来，然后实例化对象，就用你的那个 Protocol 实现类就可以了。</p>\n<p>上面那行代码就是 dubbo 里大量使用的，就是对很多组件，都是保留一个接口和多个实现，然后在系统运行的时候动态根据配置去找到对应的实现类。如果你没配置，那就走默认的实现好了，没问题。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="93463962366074140000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`@SPI(&quot;dubbo&quot;)\npublic interface Protocol {\n    int getDefaultPort();\n\n    @Adaptive\n    <T> Exporter<T> export(Invoker<T> invoker) throws RpcException;\n\n    @Adaptive\n    <T> Invoker<T> refer(Class<T> type, URL url) throws RpcException;\n\n    void destroy();\n}`, `93463962366074140000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token annotation punctuation">@SPI</span><span class="token punctuation">(</span><span class="token string">"dubbo"</span><span class="token punctuation">)</span>\n<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Protocol</span> <span class="token punctuation">{</span>\n    <span class="token keyword">int</span> <span class="token function">getDefaultPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token annotation punctuation">@Adaptive</span>\n    <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token class-name">Exporter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token function">export</span><span class="token punctuation">(</span><span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> invoker<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RpcException</span><span class="token punctuation">;</span>\n\n    <span class="token annotation punctuation">@Adaptive</span>\n    <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token function">refer</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> type<span class="token punctuation">,</span> <span class="token class-name">URL</span> url<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RpcException</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">void</span> <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在 dubbo 自己的 jar 里，在 <code class="language-text">/META_INF/dubbo/internal/com.alibaba.dubbo.rpc.Protocol</code> 文件中：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="19216310687825035000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`dubbo=com.alibaba.dubbo.rpc.protocol.dubbo.DubboProtocol\nhttp=com.alibaba.dubbo.rpc.protocol.http.HttpProtocol\nhessian=com.alibaba.dubbo.rpc.protocol.hessian.HessianProtocol`, `19216310687825035000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="xml"\n              >\n                <span class="gatsby-code-button-language">xml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="xml"><pre style="counter-reset: linenumber NaN" class="language-xml line-numbers"><code class="language-xml">dubbo=com.alibaba.dubbo.rpc.protocol.dubbo.DubboProtocol\nhttp=com.alibaba.dubbo.rpc.protocol.http.HttpProtocol\nhessian=com.alibaba.dubbo.rpc.protocol.hessian.HessianProtocol</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>所以说，这就看到了 dubbo 的 spi 机制默认是怎么玩儿的了，其实就是 Protocol 接口，<code class="language-text">@SPI(&quot;dubbo&quot;)</code> 说的是，通过 SPI 机制来提供实现类，实现类是通过 dubbo 作为默认 key 去配置文件里找到的，配置文件名称与接口全限定名一样的，通过 dubbo 作为 key 可以找到默认的实现类就是 com.alibaba.dubbo.rpc.protocol.dubbo.DubboProtocol。</p>\n<p>如果想要动态替换掉默认的实现类，需要使用 <code class="language-text">@Adaptive</code> 接口，Protocol 接口中，有两个方法加了 <code class="language-text">@Adaptive</code> 注解，就是说那俩接口会被代理实现。</p>\n<p>啥意思呢？</p>\n<p>比如这个 Protocol 接口搞了俩 <code class="language-text">@Adaptive</code> 注解标注了方法，在运行的时候会针对 Protocol 生成代理类，这个代理类的那俩方法里面会有代理代码，代理代码会在运行的时候动态根据 url 中的 protocol 来获取那个 key，默认是 dubbo，你也可以自己指定，你如果指定了别的 key，那么就会获取别的实现类的实例了。</p>\n<h4 id="如何自己扩展-dubbo-中的组件"><a href="#%E5%A6%82%E4%BD%95%E8%87%AA%E5%B7%B1%E6%89%A9%E5%B1%95-dubbo-%E4%B8%AD%E7%9A%84%E7%BB%84%E4%BB%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>如何自己扩展 dubbo 中的组件</h4>\n<p>下面来说说怎么来自己扩展 dubbo 中的组件。</p>\n<p>自己写个工程，要是那种可以打成 jar 包的，里面的 <code class="language-text">src/main/resources</code> 目录下，搞一个 <code class="language-text">META-INF/services</code>，里面放个文件叫：<code class="language-text">com.alibaba.dubbo.rpc.Protocol</code>，文件里搞一个 <code class="language-text">my=com.bingo.MyProtocol</code>。自己把 jar 弄到 nexus 私服里去。</p>\n<p>然后自己搞一个 dubbo provider 工程，在这个工程里面依赖你自己搞的那个 jar，然后在 spring 配置文件里给个配置：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="80905693467144360000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<dubbo:protocol name=&quot;my&quot; port=&quot;20000&quot; />`, `80905693467144360000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="xml"\n              >\n                <span class="gatsby-code-button-language">xml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="xml"><pre style="counter-reset: linenumber NaN" class="language-xml line-numbers"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">dubbo:</span>protocol</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>my<span class="token punctuation">"</span></span> <span class="token attr-name">port</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>20000<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>provider 启动的时候，就会加载到我们 jar 包里的 <code class="language-text">my=com.bingo.MyProtocol</code> 这行配置里，接着会根据你的配置使用你定义好的 MyProtocol 了，这个就是简单说明一下，你通过上述方式，可以替换掉大量的 dubbo 内部的组件，就是扔个你自己的 jar 包，然后配置一下即可。</p>\n<p>dubbo 里面提供了大量的类似上面的扩展点，就是说，你如果要扩展一个东西，只要自己写个 jar，让你的 consumer 或者是 provider 工程，依赖你的那个 jar，在你的 jar 里指定目录下配置好接口名称对应的文件，里面通过 key = 实现类 。</p>\n<p>然后对于对应的组件，类似 <code class="language-text">&lt;dubbo:protocol&gt;</code> 用你的那个 key 对应的实现类来实现某个接口，你可以自己去扩展 dubbo 的各种功能，提供你自己的实现。</p>\n<h3 id="如何基于-dubbo-进行服务治理？"><a href="#%E5%A6%82%E4%BD%95%E5%9F%BA%E4%BA%8E-dubbo-%E8%BF%9B%E8%A1%8C%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>如何基于 Dubbo 进行服务治理？</h3>\n<p>服务治理，这个问题如果问你，其实就是看看你有没有服务治理的思想，因为这个是做过复杂微服务的人肯定会遇到的一个问题。</p>\n<p>服务降级，这个是涉及到复杂分布式系统中必备的一个话题，因为分布式系统互相来回调用，任何一个系统故障了，你不降级，直接就全盘崩溃？那就太坑爹了吧。</p>\n<p>失败重试，分布式系统中网络请求如此频繁，要是因为网络问题不小心失败了一次，是不是要重试？</p>\n<p>超时重试，跟上面一样，如果不小心网络慢一点，超时了，如何重试？</p>\n<h4 id="服务治理"><a href="#%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>服务治理</h4>\n<h5 id="调用链路自动生成"><a href="#%E8%B0%83%E7%94%A8%E9%93%BE%E8%B7%AF%E8%87%AA%E5%8A%A8%E7%94%9F%E6%88%90" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>调用链路自动生成</h5>\n<p>一个大型的分布式系统，或者说是用现在流行的微服务架构来说吧，分布式系统由大量的服务组成。那么这些服务之间互相是如何调用的？调用链路是啥？说实话，几乎到后面没人搞的清楚了，因为服务实在太多了，可能几百个甚至几千个服务。</p>\n<p>那就需要基于 dubbo 做的分布式系统中，对各个服务之间的调用自动记录下来，然后自动将各个服务之间的依赖关系和调用链路生成出来，做成一张图，显示出来，大家才可以看到对吧。</p>\n<div class="mermaid">---\ntitle: 服务间调用链路\n---\nflowchart LR\n    A[服务 A] --> B[服务 B]\n    A[服务 A] --> C[服务 C]\n    A[服务 A] --> D[服务 D]\n    B[服务 B] --> E[服务 E]\n    B[服务 B] --> F[服务 F]\n    C[服务 C] --> G[服务 G]\n    D[服务 D] --> G[服务 G]</div>\n<h5 id="服务访问压力以及时长统计"><a href="#%E6%9C%8D%E5%8A%A1%E8%AE%BF%E9%97%AE%E5%8E%8B%E5%8A%9B%E4%BB%A5%E5%8F%8A%E6%97%B6%E9%95%BF%E7%BB%9F%E8%AE%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>服务访问压力以及时长统计</h5>\n<p>需要自动统计各个接口和服务之间的调用次数以及访问延时，而且要分成两个级别。</p>\n<ul>\n<li>一个级别是接口粒度，就是每个服务的每个接口每天被调用多少次，TP50/TP90/TP99，三个档次的请求延时分别是多少；</li>\n<li>第二个级别是从源头入口开始，一个完整的请求链路经过几十个服务之后，完成一次请求，每天全链路走多少次，全链路请求延时的 TP50/TP90/TP99，分别是多少。</li>\n</ul>\n<p>这些东西都搞定了之后，后面才可以来看当前系统的压力主要在哪里，如何来扩容和优化。</p>\n<h5 id="其它"><a href="#%E5%85%B6%E5%AE%83" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>其它</h5>\n<ul>\n<li>服务分层（避免循环依赖）</li>\n<li>调用链路失败监控和报警</li>\n<li>服务鉴权</li>\n<li>每个服务的可用性的监控（接口调用成功率？几个 9？99.99%，99.9%，99%）</li>\n</ul>\n<h4 id="服务降级"><a href="#%E6%9C%8D%E5%8A%A1%E9%99%8D%E7%BA%A7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>服务降级</h4>\n<p>比如说服务 A 调用服务 B，结果服务 B 挂掉了，服务 A 重试几次调用服务 B，还是不行，那么直接降级，走一个备用的逻辑，给用户返回响应。</p>\n<p>举个栗子，我们有接口 HelloService。HelloServiceImpl 有该接口的具体实现。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="86971625607701450000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public interface HelloService {\n   void sayHello();\n}\n\npublic class HelloServiceImpl implements HelloService {\n    public void sayHello() {\n        System.out.println(&quot;hello world......&quot;);\n    }\n}`, `86971625607701450000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">HelloService</span> <span class="token punctuation">{</span>\n   <span class="token keyword">void</span> <span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HelloServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">HelloService</span> <span class="token punctuation">{</span>\n    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"hello world......"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="59850098995109315000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?>\n<beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;\n    xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xmlns:dubbo=&quot;http://code.alibabatech.com/schema/dubbo&quot;\n    xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans        http://www.springframework.org/schema/beans/spring-beans.xsd        http://code.alibabatech.com/schema/dubbo        http://code.alibabatech.com/schema/dubbo/dubbo.xsd&quot;>\n\n    <dubbo:application name=&quot;dubbo-provider&quot; />\n    <dubbo:registry address=&quot;zookeeper://127.0.0.1:2181&quot; />\n    <dubbo:protocol name=&quot;dubbo&quot; port=&quot;20880&quot; />\n    <dubbo:service interface=&quot;com.zhss.service.HelloService&quot; ref=&quot;helloServiceImpl&quot; timeout=&quot;10000&quot; />\n    <bean id=&quot;helloServiceImpl&quot; class=&quot;com.zhss.service.HelloServiceImpl&quot; />\n\n</beans>\n\n<?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?>\n<beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;\n    xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;\n    xmlns:dubbo=&quot;http://code.alibabatech.com/schema/dubbo&quot;\n    xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans        http://www.springframework.org/schema/beans/spring-beans.xsd        http://code.alibabatech.com/schema/dubbo        http://code.alibabatech.com/schema/dubbo/dubbo.xsd&quot;>\n\n    <dubbo:application name=&quot;dubbo-consumer&quot;  />\n\n    <dubbo:registry address=&quot;zookeeper://127.0.0.1:2181&quot; />\n\n    <dubbo:reference id=&quot;fooService&quot; interface=&quot;com.test.service.FooService&quot;  timeout=&quot;10000&quot; check=&quot;false&quot; mock=&quot;return null&quot;>\n    </dubbo:reference>\n\n</beans>`, `59850098995109315000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="xml"\n              >\n                <span class="gatsby-code-button-language">xml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="xml"><pre style="counter-reset: linenumber NaN" class="language-xml line-numbers"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?></span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>beans</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/beans<span class="token punctuation">"</span></span>\n    <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">xmlns:</span>dubbo</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://code.alibabatech.com/schema/dubbo<span class="token punctuation">"</span></span>\n    <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/beans        http://www.springframework.org/schema/beans/spring-beans.xsd        http://code.alibabatech.com/schema/dubbo        http://code.alibabatech.com/schema/dubbo/dubbo.xsd<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>\n\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">dubbo:</span>application</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>dubbo-provider<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">dubbo:</span>registry</span> <span class="token attr-name">address</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>zookeeper://127.0.0.1:2181<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">dubbo:</span>protocol</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>dubbo<span class="token punctuation">"</span></span> <span class="token attr-name">port</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>20880<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">dubbo:</span>service</span> <span class="token attr-name">interface</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>com.zhss.service.HelloService<span class="token punctuation">"</span></span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>helloServiceImpl<span class="token punctuation">"</span></span> <span class="token attr-name">timeout</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>10000<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>helloServiceImpl<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>com.zhss.service.HelloServiceImpl<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>\n\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>beans</span><span class="token punctuation">></span></span>\n\n<span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?></span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>beans</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/beans<span class="token punctuation">"</span></span>\n    <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span>\n    <span class="token attr-name"><span class="token namespace">xmlns:</span>dubbo</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://code.alibabatech.com/schema/dubbo<span class="token punctuation">"</span></span>\n    <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/beans        http://www.springframework.org/schema/beans/spring-beans.xsd        http://code.alibabatech.com/schema/dubbo        http://code.alibabatech.com/schema/dubbo/dubbo.xsd<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>\n\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">dubbo:</span>application</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>dubbo-consumer<span class="token punctuation">"</span></span>  <span class="token punctuation">/></span></span>\n\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">dubbo:</span>registry</span> <span class="token attr-name">address</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>zookeeper://127.0.0.1:2181<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>\n\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">dubbo:</span>reference</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>fooService<span class="token punctuation">"</span></span> <span class="token attr-name">interface</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>com.test.service.FooService<span class="token punctuation">"</span></span>  <span class="token attr-name">timeout</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>10000<span class="token punctuation">"</span></span> <span class="token attr-name">check</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span> <span class="token attr-name">mock</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>return null<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">dubbo:</span>reference</span><span class="token punctuation">></span></span>\n\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>beans</span><span class="token punctuation">></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们调用接口失败的时候，可以通过 mock 统一返回 null。</p>\n<p>mock 的值也可以修改为 true，然后再跟接口同一个路径下实现一个 Mock 类，命名规则是 <code class="language-text">接口名称 + Mock</code> 后缀。然后在 Mock 类里实现自己的降级逻辑。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="65213428077088370000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public class HelloServiceMock implements HelloService {\n    public void sayHello() {\n        // 降级逻辑\n    }\n}`, `65213428077088370000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HelloServiceMock</span> <span class="token keyword">implements</span> <span class="token class-name">HelloService</span> <span class="token punctuation">{</span>\n    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token comment">// 降级逻辑</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="失败重试和超时重试"><a href="#%E5%A4%B1%E8%B4%A5%E9%87%8D%E8%AF%95%E5%92%8C%E8%B6%85%E6%97%B6%E9%87%8D%E8%AF%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>失败重试和超时重试</h4>\n<p>所谓失败重试，就是 consumer 调用 provider 要是失败了，比如抛异常了，此时应该是可以重试的，或者调用超时了也可以重试。配置如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="95974728654587690000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<dubbo:reference id=&quot;xxxx&quot; interface=&quot;xx&quot; check=&quot;true&quot; async=&quot;false&quot; retries=&quot;3&quot; timeout=&quot;2000&quot;/>`, `95974728654587690000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="xml"\n              >\n                <span class="gatsby-code-button-language">xml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="xml"><pre style="counter-reset: linenumber NaN" class="language-xml line-numbers"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">dubbo:</span>reference</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>xxxx<span class="token punctuation">"</span></span> <span class="token attr-name">interface</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>xx<span class="token punctuation">"</span></span> <span class="token attr-name">check</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span> <span class="token attr-name">async</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span> <span class="token attr-name">retries</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>3<span class="token punctuation">"</span></span> <span class="token attr-name">timeout</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>2000<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>举个栗子。</p>\n<p>某个服务的接口，要耗费 5s，你这边不能干等着，你这边配置了 timeout 之后，我等待 2s，还没返回，我直接就撤了，不能干等你。</p>\n<p>可以结合你们公司具体的场景来说说你是怎么设置这些参数的：</p>\n<ul>\n<li>timeout：一般设置为 200ms，我们认为不能超过 200ms 还没返回。</li>\n<li>retries：设置 retries，一般是在读请求的时候，比如你要查询个数据，你可以设置个 retries，如果第一次没读到，报错，重试指定的次数，尝试再次读取。</li>\n</ul>\n<h3 id="分布式服务接口的幂等性如何设计？"><a href="#%E5%88%86%E5%B8%83%E5%BC%8F%E6%9C%8D%E5%8A%A1%E6%8E%A5%E5%8F%A3%E7%9A%84%E5%B9%82%E7%AD%89%E6%80%A7%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>分布式服务接口的幂等性如何设计？</h3>\n<p>一个分布式系统中的某个接口，该如何保证幂等性？这个事儿其实是你做分布式系统的时候必须要考虑的一个生产环境的技术问题。啥意思呢？</p>\n<p>假如你有个服务提供一些接口供外部调用，这个服务部署在了 5 台机器上，接着有个接口就是付款接口。然后人家用户在前端上操作的时候，不知道为啥，总之就是一个订单不小心发起了两次支付请求，然后这俩请求分散在了这个服务部署的不同的机器上，好了，结果一个订单扣款扣两次。</p>\n<p>或者是订单系统调用支付系统进行支付，结果不小心因为网络超时了，然后订单系统走了前面我们看到的那个重试机制，咔嚓给你重试了一把，好，支付系统收到一个支付请求两次，而且因为负载均衡算法落在了不同的机器上，尴尬了。。。</p>\n<p>所以你肯定得知道这事儿，否则你做出来的分布式系统恐怕容易埋坑。</p>\n<p>这个不是技术问题，这个没有通用的一个方法，这个应该结合业务来保证幂等性。</p>\n<p>所谓幂等性，就是说一个接口，多次发起同一个请求，你这个接口得保证结果是准确的，比如不能多扣款、不能多插入一条数据、不能将统计值多加了 1。这就是幂等性。</p>\n<p>其实保证幂等性主要是三点：</p>\n<ul>\n<li>对于每个请求必须有一个唯一的标识，举个栗子：订单支付请求，肯定得包含订单 id，一个订单 id 最多支付一次，对吧。</li>\n<li>每次处理完请求之后，必须有一个记录标识这个请求处理过了。常见的方案是在 mysql 中记录个状态啥的，比如支付之前记录一条这个订单的支付流水。</li>\n<li>每次接收请求需要进行判断，判断之前是否处理过。比如说，如果有一个订单已经支付了，就已经有了一条支付流水，那么如果重复发送这个请求，则此时先插入支付流水，orderId 已经存在了，唯一键约束生效，报错插入不进去的。然后你就不用再扣款了。</li>\n</ul>\n<p>实际运作过程中，你要结合自己的业务来，比如说利用 Redis，用 orderId 作为唯一键。只有成功插入这个支付流水，才可以执行实际的支付扣款。</p>\n<p>要求是支付一个订单，必须插入一条支付流水，<code class="language-text">order_id</code> 建一个唯一键 unique key。你在支付一个订单之前，先插入一条支付流水，<code class="language-text">order_id</code> 就已经进去了。你就可以写一个标识到 Redis 里面去，set <code class="language-text">order_id</code> payed ，下一次重复请求过来了，先查 Redis 的 <code class="language-text">order_id</code> 对应的 value，如果是 payed 就说明已经支付过了，你就别重复支付了。</p>\n<h3 id="分布式服务接口请求的顺序性如何保证？"><a href="#%E5%88%86%E5%B8%83%E5%BC%8F%E6%9C%8D%E5%8A%A1%E6%8E%A5%E5%8F%A3%E8%AF%B7%E6%B1%82%E7%9A%84%E9%A1%BA%E5%BA%8F%E6%80%A7%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>分布式服务接口请求的顺序性如何保证？</h3>\n<p>其实分布式系统接口的调用顺序，也是个问题，一般来说是不用保证顺序的。但是有时候可能确实是需要严格的顺序保证。给大家举个例子，你服务 A 调用服务 B，先插入再删除。好，结果俩请求过去了，落在不同机器上，可能插入请求因为某些原因执行慢了一些，导致删除请求先执行了，此时因为没数据所以啥效果也没有；结果这个时候插入请求过来了，好，数据插入进去了，那就尴尬了。</p>\n<p>本来应该是 “先插入 -> 再删除”，这条数据应该没了，结果现在 “先删除 -> 再插入”，数据还存在，最后你死都想不明白是怎么回事。</p>\n<p>所以这都是分布式系统一些很常见的问题。</p>\n<p>首先，一般来说，个人建议是，你们从业务逻辑上设计的这个系统最好是不需要这种顺序性的保证，因为一旦引入顺序性保障，比如使用分布式锁，会导致系统复杂度上升，而且会带来效率低下，热点数据压力过大等问题。</p>\n<p>下面我给个我们用过的方案吧，简单来说，首先你得用 Dubbo 的一致性 hash 负载均衡策略，将比如某一个订单 id 对应的请求都给分发到某个机器上去，接着就是在那个机器上，因为可能还是多线程并发执行的，你可能得立即将某个订单 id 对应的请求扔一个内存队列里去，强制排队，这样来确保他们的顺序性。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-09-24-19-39-21-da9f406aa647b2b81d2a92672c7109b4-c7bf1.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 122.88732394366197%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAZCAIAAAC+dZmEAAAACXBIWXMAAAsSAAALEgHS3X78AAAB+klEQVQ4y43Ux47iUBAFUP//p7FhAwsyiJxzGgZ6TrtaBnmM6JKw3ivq1r0V7ORvaqvVql6vj8fjwWBwOBxut9vj8fj6ZAnAbrfb7/fn8/l4PJ5OJ8/pdHq5XKT4k5pDMXi5XIKJmM/nOLfbLSE8tVptvV5vUxNTKCQJntls1u/3qRgOh4vFQnSpVCJnMplsNhv4+/1eAEZIYXYPBoBms4nZv6vUipmRIEciPdnq9xStkMjyruBvcHRFNCqaR6MRcCaSU7q34NxdIlVo2PV61QiJkBcW/ARHSTC9Xm+RGi1mDimFpyz71AgRlmeGV7/2IjdtEWDawenKeU2NX94n2B/izKlcLrdarXa7jQrACKPVr7Jx+PcJthX0hM5ofjYY12j7K9gI8zV3Op1ut4s2eG6pSSdvNi0HioRFFT/gkKdgWXWLx9idKSeSJzKKceWUUWuTbKVkEqSEUKWrZmbDkGTr6RBOKKJ+wDJpGG+8ZDzk4XHepBYC4xpPwd8bZoaxxuvUYqpZL/7f6syTKECr8BBmGYnU7Uaj8W6r8h8DQw4ly9Riw5T3GQymb7F3sY/w3hCez2AM0XqHGFjw/4pZb4zXU6l6hh/MQRc+g/0wxw7JEtvK8/ULS7wl1WqVbFSVSgW/afHkVvptt30oNdw3xMFT/4xK2a8jLbR/yZ+jkbWSJKAAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 09 24 19 39 21" title="" data-src="/static/2023-09-24-19-39-21-da9f406aa647b2b81d2a92672c7109b4-fee1c.png" data-srcset="/static/2023-09-24-19-39-21-da9f406aa647b2b81d2a92672c7109b4-a67b7.png 200w,\n/static/2023-09-24-19-39-21-da9f406aa647b2b81d2a92672c7109b4-0b187.png 400w,\n/static/2023-09-24-19-39-21-da9f406aa647b2b81d2a92672c7109b4-fee1c.png 800w,\n/static/2023-09-24-19-39-21-da9f406aa647b2b81d2a92672c7109b4-c7bf1.png 852w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>但是这样引发的后续问题就很多，比如说要是某个订单对应的请求特别多，造成某台机器成热点怎么办？解决这些问题又要开启后续一连串的复杂技术方案，曾经这类问题弄的我们头疼不已，所以，还是建议什么呢？</p>\n<p>最好是比如说刚才那种，一个订单的插入和删除操作，能不能合并成一个操作，就是一个删除，或者是其它什么，避免这种问题的产生。</p>\n<h3 id="如何自己设计一个类似-dubbo-的-rpc-框架？"><a href="#%E5%A6%82%E4%BD%95%E8%87%AA%E5%B7%B1%E8%AE%BE%E8%AE%A1%E4%B8%80%E4%B8%AA%E7%B1%BB%E4%BC%BC-dubbo-%E7%9A%84-rpc-%E6%A1%86%E6%9E%B6%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>如何自己设计一个类似 Dubbo 的 RPC 框架？</h3>\n<ul>\n<li>上来你的服务就得去注册中心注册吧，你是不是得有个注册中心，保留各个服务的信息，可以用 zookeeper 来做，对吧。</li>\n<li>然后你的消费者需要去注册中心拿对应的服务信息吧，对吧，而且每个服务可能会存在于多台机器上。</li>\n<li>接着你就该发起一次请求了，咋发起？当然是基于动态代理了，你面向接口获取到一个动态代理，这个动态代理就是接口在本地的一个代理，然后这个代理会找到服务对应的机器地址。</li>\n<li>然后找哪个机器发送请求？那肯定得有个负载均衡算法了，比如最简单的可以随机轮询是不是。</li>\n<li>接着找到一台机器，就可以跟它发送请求了，第一个问题咋发送？你可以说用 netty 了，nio 方式；第二个问题发送啥格式数据？你可以说用 hessian 序列化协议了，或者是别的，对吧。然后请求过去了。</li>\n<li>服务器那边一样的，需要针对你自己的服务生成一个动态代理，监听某个网络端口了，然后代理你本地的服务代码。接收到请求的时候，就调用对应的服务代码，对吧。</li>\n</ul>\n<h3 id="cap-定理的-p-是什么？"><a href="#cap-%E5%AE%9A%E7%90%86%E7%9A%84-p-%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>CAP 定理的 P 是什么？</h3>\n<h4 id="什么是-cap-定理（cap-theorem）"><a href="#%E4%BB%80%E4%B9%88%E6%98%AF-cap-%E5%AE%9A%E7%90%86%EF%BC%88cap-theorem%EF%BC%89" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>什么是 CAP 定理（CAP theorem）</h4>\n<p>在理论计算机科学中，CAP 定理（CAP theorem），又被称作布鲁尔定理（Brewer’s theorem），它指出对于一个分布式计算系统来说，不可能同时满足以下三点：</p>\n<ul>\n<li>一致性（Consistency）（等同于所有节点访问同一份最新的数据副本）</li>\n<li>可用性（Availability）（每次请求都能获取到非错的响应——但是不保证获取的数据为最新数据）</li>\n<li>分区容错性（Partition tolerance）（以实际效果而言，分区相当于对通信的时限要求。系统如果不能在时限内达成数据一致性，就意味着发生了分区的情况，必须就当前操作在 C 和 A 之间做出选择。）</li>\n</ul>\n<h4 id="分区容错性（partition-tolerance）"><a href="#%E5%88%86%E5%8C%BA%E5%AE%B9%E9%94%99%E6%80%A7%EF%BC%88partition-tolerance%EF%BC%89" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>分区容错性（Partition tolerance）</h4>\n<p>理解 CAP 理论的最简单方式是想象两个节点分处分区两侧。允许至少一个节点更新状态会导致数据不一致，即丧失了 C 性质。如果为了保证数据一致性，将分区一侧的节点设置为不可用，那么又丧失了 A 性质。除非两个节点可以互相通信，才能既保证 C 又保证 A，这又会导致丧失 P 性质。</p>\n<ul>\n<li>P 指的是分区容错性，分区现象产生后需要容错，容错是指在 A 与 C 之间选择。如果分布式系统没有分区现象（没有出现不一致不可用情况）本身就没有分区，既然没有分区则就更没有分区容错性 P。</li>\n<li>无论我设计的系统是 AP 还是 CP 系统如果没有出现不一致不可用。则该系统就处于 CA 状态</li>\n<li>P 的体现前提是得有分区情况存在</li>\n</ul>\n<h4 id="常用的-cap-框架对比"><a href="#%E5%B8%B8%E7%94%A8%E7%9A%84-cap-%E6%A1%86%E6%9E%B6%E5%AF%B9%E6%AF%94" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>常用的 CAP 框架对比</h4>\n<table>\n<thead>\n<tr>\n<th>框架</th>\n<th>所属</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Eureka</td>\n<td>AP</td>\n</tr>\n<tr>\n<td>Zookeeper</td>\n<td>CP</td>\n</tr>\n<tr>\n<td>Consul</td>\n<td>CP</td>\n</tr>\n</tbody>\n</table>\n<h5 id="eureka"><a href="#eureka" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Eureka</h5>\n<blockquote>\n<p>Eureka 保证了可用性，实现最终一致性。</p>\n</blockquote>\n<p>Eureka 所有节点都是平等的所有数据都是相同的，且 Eureka 可以相互交叉注册。</p>\n<p>Eureka client 使用内置轮询负载均衡器去注册，有一个检测间隔时间，如果在一定时间内没有收到心跳，才会移除该节点注册信息；如果客户端发现当前 Eureka 不可用，会切换到其他的节点，如果所有的 Eureka 都跪了，Eureka client 会使用最后一次数据作为本地缓存；所以以上的每种设计都是他不具备一致性的特性。</p>\n<p>注意：因为 Eureka AP 的特性和请求间隔同步机制，在服务更新时候一般会手动通过 Eureka 的 api 把当前服务状态设置为 offline，并等待 2 个同步间隔后重新启动，这样就能保证服务更新节点对整体系统的影响</p>\n<h5 id="zookeeper"><a href="#zookeeper" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Zookeeper</h5>\n<blockquote>\n<p>强一致性</p>\n</blockquote>\n<p>Zookeeper 在选举 leader 时会停止服务，只有选举 leader 成功后才能提供服务，选举时间较长；内部使用 paxos 选举投票机制，只有获取半数以上的投票才能成为 leader，否则重新投票，所以部署的时候最好集群节点不小于 3 的奇数个（但是谁能保证跪掉后节点也是奇数个呢）；Zookeeper 健康检查一般是使用 tcp 长链接，在内部网络抖动时或者对应节点阻塞时候都会变成不可用，这里还是比较危险的；</p>\n<h5 id="consul"><a href="#consul" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Consul</h5>\n<p>和 Zookeeper 一样数据 CP</p>\n<p>Consul 注册时候只有过半的节点都写入成功才认为注册成功；leader 挂掉时，重新选举期间整个 Consul 不可用，保证了强一致性但牺牲了可用性</p>\n<p>有很多 blog 说 Consul 属于 ap，官方已经确认他为 CP 机制，原文地址：<a href="https://www.consul.io/docs/intro/vs/serf" target="_blank" rel="nofollow noreferrer noopener">https://www.consul.io/docs/intro/vs/serf</a></p>\n<h2 id="分布式锁"><a href="#%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>分布式锁</h2>\n<h3 id="zookeeper-都有哪些应用场景？"><a href="#zookeeper-%E9%83%BD%E6%9C%89%E5%93%AA%E4%BA%9B%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Zookeeper 都有哪些应用场景？</h3>\n<p>大致来说，zookeeper 的使用场景如下，我就举几个简单的，大家能说几个就好了：</p>\n<ul>\n<li>分布式协调</li>\n<li>分布式锁</li>\n<li>元数据/配置信息管理</li>\n<li>HA 高可用性</li>\n</ul>\n<h4 id="分布式协调"><a href="#%E5%88%86%E5%B8%83%E5%BC%8F%E5%8D%8F%E8%B0%83" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>分布式协调</h4>\n<p>这个其实是 zookeeper 很经典的一个用法，简单来说，就好比，你 A 系统发送个请求到 mq，然后 B 系统消息消费之后处理了。那 A 系统如何知道 B 系统的处理结果？用 zookeeper 就可以实现分布式系统之间的协调工作。A 系统发送请求之后可以在 zookeeper 上对某个节点的值注册个监听器，一旦 B 系统处理完了就修改 zookeeper 那个节点的值，A 系统立马就可以收到通知，完美解决。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-09-24-19-47-25-9f0d7d28f23b0ab0e6eaf59e8f823073-25115.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 41.45907473309609%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAAsSAAALEgHS3X78AAAA90lEQVQY01WQxw6DMAyG8/6vhxCIQzkQ9t6b9GssVa0Pxnb8D6Oe57muyxhDQV7X1fM8x3H6vqc9z7NtW+ppmmjZ1FpHUVTXNa3iw1ue52VZJknyXSUYVlVFAUXXddQsN00j+b5vBYZt+nmesyxD9mUjCAK4ShvLsoAEH8cxXML+AePkOA5jY7YBESziE00mZGkBjOOILNd9bDOFkp6MCM+sgkdNFCjICLAAkuEwDCD3fVdM6fGDAs+Aceu6bhiGvu8XRcFEVrUNOSpNU9wp8xMQIyv/H0FaiGCUm/HFZNs29ITxD8wlPGOBAufswYJJfjt4YZRrJd559cax7K+29wAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 09 24 19 47 25" title="" data-src="/static/2023-09-24-19-47-25-9f0d7d28f23b0ab0e6eaf59e8f823073-fee1c.png" data-srcset="/static/2023-09-24-19-47-25-9f0d7d28f23b0ab0e6eaf59e8f823073-a67b7.png 200w,\n/static/2023-09-24-19-47-25-9f0d7d28f23b0ab0e6eaf59e8f823073-0b187.png 400w,\n/static/2023-09-24-19-47-25-9f0d7d28f23b0ab0e6eaf59e8f823073-fee1c.png 800w,\n/static/2023-09-24-19-47-25-9f0d7d28f23b0ab0e6eaf59e8f823073-25115.png 1124w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h4 id="分布式锁-1"><a href="#%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>分布式锁</h4>\n<p>举个栗子。对某一个数据连续发出两个修改操作，两台机器同时收到了请求，但是只能一台机器先执行完另外一个机器再执行。那么此时就可以使用 zookeeper 分布式锁，一个机器接收到了请求之后先获取 zookeeper 上的一把分布式锁，就是可以去创建一个 znode，接着执行操作；然后另外一个机器也尝试去创建那个 znode，结果发现自己创建不了，因为被别人创建了，那只能等着，等第一个机器执行完了自己再执行。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-09-24-19-47-54-62f8bec95e5312c6e8eba17c02e578e0-99df0.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 45.489443378119%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAAsSAAALEgHS3X78AAABEElEQVQoz22RWW+DQAyE+f9/LU9IRCBxH+G+zxAK26+sRJsqfjC79sx4zCpCiKqqfN/3PC+KIl3XLcsax5H6MAyu69IKgoC64zjLsog/ochP13XzPJO3beNA5TgO8uv14tr3/bquaZqK91AAQciybJqmtm3JDLzIjIIp62Ck7ttkyFIb///aSFCv6xoyMADPM6RBBTN5nkMGCgj5siyBcmUgLXaBgwU47K9p2u12s20bpIIwDWmV/xSGYZIkRVGgbZrm/X5XVdUwDDigAQP7OuPXNvIIk6XW4/HAEZlifgaYa8a10Q9533dmgo7jGASem6bh2dDiyg/HNmcwSHx4Khm04TOQh4WAeR6f9VhEfIpv6zsBGfjYKSMAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 09 24 19 47 54" title="" data-src="/static/2023-09-24-19-47-54-62f8bec95e5312c6e8eba17c02e578e0-fee1c.png" data-srcset="/static/2023-09-24-19-47-54-62f8bec95e5312c6e8eba17c02e578e0-a67b7.png 200w,\n/static/2023-09-24-19-47-54-62f8bec95e5312c6e8eba17c02e578e0-0b187.png 400w,\n/static/2023-09-24-19-47-54-62f8bec95e5312c6e8eba17c02e578e0-fee1c.png 800w,\n/static/2023-09-24-19-47-54-62f8bec95e5312c6e8eba17c02e578e0-99df0.png 1042w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h4 id="元数据配置信息管理"><a href="#%E5%85%83%E6%95%B0%E6%8D%AE%E9%85%8D%E7%BD%AE%E4%BF%A1%E6%81%AF%E7%AE%A1%E7%90%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>元数据/配置信息管理</h4>\n<p>zookeeper 可以用作很多系统的配置信息的管理，比如 kafka、storm 等等很多分布式系统都会选用 zookeeper 来做一些元数据、配置信息的管理，包括 dubbo 注册中心不也支持 zookeeper 么？</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-09-24-19-48-32-db985923e85024a0b3f3383bc97df5d6-9725a.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 61.29032258064516%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAAsSAAALEgHS3X78AAABJ0lEQVQoz43S227CQAwE0P3//0NI8EJCuCRBNBTKJSS0p7EUVUhU+GEVe2fGY2/S99vR933XdR9DHA6HsizTO7TH4+H8HGK326HleV7XdfoH/RTH41Hztm33+z0J/ZPkcrlA32636/XqbIcA/RridDppiBbn/X4/n8+Q6mm73TJQFMVsNptOp/P5fLFYcAVhsKqq4KTqGiIA0yUkTa7xNR/d2spyuUSG4I2X9Xq92WxouXJKsyxTSSGMTI8wnwhUV6uVom8qJqTbNE0/BFESv7ajYfcnYiuucUjwRTcWBqlZzCx9ue3wrBuyD6Km5ciYrjjHf/nO0M0Qsc7JZGK6mIsdS6WSnt7WHeE49QTyS8TyFE00In0/k40K6jGNHW2lvlXw41HG+AEfX7LTwJCs8AAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 09 24 19 48 32" title="" data-src="/static/2023-09-24-19-48-32-db985923e85024a0b3f3383bc97df5d6-fee1c.png" data-srcset="/static/2023-09-24-19-48-32-db985923e85024a0b3f3383bc97df5d6-a67b7.png 200w,\n/static/2023-09-24-19-48-32-db985923e85024a0b3f3383bc97df5d6-0b187.png 400w,\n/static/2023-09-24-19-48-32-db985923e85024a0b3f3383bc97df5d6-fee1c.png 800w,\n/static/2023-09-24-19-48-32-db985923e85024a0b3f3383bc97df5d6-9725a.png 1085w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h4 id="ha-高可用性"><a href="#ha-%E9%AB%98%E5%8F%AF%E7%94%A8%E6%80%A7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>HA 高可用性</h4>\n<p>这个应该是很常见的，比如 hadoop、hdfs、yarn 等很多大数据系统，都选择基于 zookeeper 来开发 HA 高可用机制，就是一个重要进程一般会做主备两个，主进程挂了立马通过 zookeeper 感知到并切换到备用进程。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-09-24-19-49-05-a6ca10a7ae52a5066f638f0999df8e4d-62377.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 46.61016949152542%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAAsSAAALEgHS3X78AAABBElEQVQoz12RB46FQAxDuf8BAVGFEL0tvTP/fbJC7Foigokdm4wWx3Hf923bdl2Xpul5nkqp67qo8zzneS5dalmWy7JIV6BJDxzHMQyDiAVQ0f/coAvTcRzP8yzLsm07CAKtqipI0zRR67p+O3PCUPTI1nWl2zQNBmRkHC2Nj3EcYWRZBkm9wCBpYVIUBYJnrkDjIRI8BtPGQWRC2rYNJYbLDfUX33+OosgwDF3X4bGV93he0EtU3/dd14VDRuJ8xZjgLPvk/5Mk4Z0UfKKhYssJS6GGYSi387ttBuz7LvvEhNjxDZQSFR8O5xv/Y6PBhwswTZNUXINsGCsOJQIm1OeSH/EHGfEDR0pXgl4AAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 09 24 19 49 05" title="" data-src="/static/2023-09-24-19-49-05-a6ca10a7ae52a5066f638f0999df8e4d-fee1c.png" data-srcset="/static/2023-09-24-19-49-05-a6ca10a7ae52a5066f638f0999df8e4d-a67b7.png 200w,\n/static/2023-09-24-19-49-05-a6ca10a7ae52a5066f638f0999df8e4d-0b187.png 400w,\n/static/2023-09-24-19-49-05-a6ca10a7ae52a5066f638f0999df8e4d-fee1c.png 800w,\n/static/2023-09-24-19-49-05-a6ca10a7ae52a5066f638f0999df8e4d-62377.png 1062w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h3 id="分布式锁如何设计？"><a href="#%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>分布式锁如何设计？</h3>\n<p>其实一般问问题，都是这么问的，先问问你 zk，然后其实是要过渡到 zk 相关的一些问题里去，比如分布式锁。因为在分布式系统开发中，分布式锁的使用场景还是很常见的。</p>\n<h4 id="redis-分布式锁"><a href="#redis-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Redis 分布式锁</h4>\n<p>官方叫做 RedLock 算法，是 Redis 官方支持的分布式锁算法。</p>\n<p>这个分布式锁有 3 个重要的考量点：</p>\n<ul>\n<li>互斥（只能有一个客户端获取锁）</li>\n<li>不能死锁</li>\n<li>容错（只要大部分 Redis 节点创建了这把锁就可以）</li>\n</ul>\n<h5 id="redis-最普通的分布式锁"><a href="#redis-%E6%9C%80%E6%99%AE%E9%80%9A%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Redis 最普通的分布式锁</h5>\n<p>第一个最普通的实现方式，就是在 Redis 里使用 <code class="language-text">SET key value [EX seconds] [PX milliseconds] NX</code> 创建一个 key，这样就算加锁。其中：</p>\n<ul>\n<li>NX：表示只有 key 不存在的时候才会设置成功，如果此时 redis 中存在这个 key，那么设置失败，返回 nil。</li>\n<li>EX seconds：设置 key 的过期时间，精确到秒级。意思是 seconds 秒后锁自动释放，别人创建的时候如果发现已经有了就不能加锁了。</li>\n<li>PX milliseconds：同样是设置 key 的过期时间，精确到毫秒级。</li>\n</ul>\n<p>比如执行以下命令：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="98302569152407860000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`SET resource_name my_random_value PX 30000 NX`, `98302569152407860000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">SET resource_name my_random_value PX <span class="token number">30000</span> NX</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>释放锁就是删除 key，但是一般可以用 lua 脚本删除，判断 value 一样才删除：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="91858054832806510000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`-- 删除锁的时候，找到 key 对应的 value，跟自己传过去的 value 做比较，如果是一样的才删除。\nif redis.call(&quot;get&quot;, KEYS[1]) == ARGV[1] then\n    return redis.call(&quot;del&quot;, KEYS[1])\nelse\n    return 0\nend`, `91858054832806510000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="lua"\n              >\n                <span class="gatsby-code-button-language">lua</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="lua"><pre style="counter-reset: linenumber NaN" class="language-lua line-numbers"><code class="language-lua"><span class="token comment">-- 删除锁的时候，找到 key 对应的 value，跟自己传过去的 value 做比较，如果是一样的才删除。</span>\n<span class="token keyword">if</span> redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">"get"</span><span class="token punctuation">,</span> KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> ARGV<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword">then</span>\n    <span class="token keyword">return</span> redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">"del"</span><span class="token punctuation">,</span> KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n<span class="token keyword">else</span>\n    <span class="token keyword">return</span> <span class="token number">0</span>\n<span class="token keyword">end</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>为啥要用 <code class="language-text">random_value</code> 随机值呢？因为如果某个客户端获取到了锁，但是阻塞了很长时间才执行完，比如说超过了 30s，此时可能已经自动释放锁了，此时可能别的客户端已经获取到了这个锁，要是你这个时候直接删除 key 的话会有问题，所以得用随机值加上面的 lua 脚本来释放锁。</p>\n<p>但是这样是肯定不行的。因为如果是普通的 Redis 单实例，那就是单点故障。或者是 Redis 普通主从，那 Redis 主从异步复制，如果主节点挂了（key 就没有了），key 还没同步到从节点，此时从节点切换为主节点，别人就可以 set key，从而拿到锁。</p>\n<h5 id="redlock-算法"><a href="#redlock-%E7%AE%97%E6%B3%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>RedLock 算法</h5>\n<p>这个场景是假设有一个 Redis cluster，有 5 个 Redis master 实例。然后执行如下步骤获取一把锁：</p>\n<ol>\n<li>获取当前时间戳，单位是毫秒；</li>\n<li>跟上面类似，轮流尝试在每个 master 节点上创建锁，超时时间较短，一般就几十毫秒（客户端为了获取锁而使用的超时时间比自动释放锁的总时间要小。例如，如果自动释放时间是 10 秒，那么超时时间可能在 5~50 毫秒范围内）；</li>\n<li>尝试在大多数节点上建立一个锁，比如 5 个节点就要求是 3 个节点 n / 2 + 1 ；</li>\n<li>客户端计算建立好锁的时间，如果建立锁的时间小于超时时间，就算建立成功了；</li>\n<li>要是锁建立失败了，那么就依次把之前建立过的锁删除；</li>\n<li>只要别人建立了一把分布式锁，你就得不断轮询去尝试获取锁。</li>\n</ol>\n<div class="mermaid">graph TB\n   A["系统 A"]\n   B["系统 A"]\n   C["系统 A"]\n   B --> D(("redis master"))\n   B ~~~ E(("redis master"))\n   B --> F(("redis master"))\n   B ~~~ G(("redis master"))\n   B --> H(("redis master"))</div>\n<p>Redis 官方给出了以上两种基于 Redis 实现分布式锁的方法，详细说明可以查看：<a href="https://redis.io/topics/distlock%E3%80%82" target="_blank" rel="nofollow noreferrer noopener">https://redis.io/topics/distlock。</a></p>\n<h4 id="zk-分布式锁"><a href="#zk-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>zk 分布式锁</h4>\n<p>zk 分布式锁，其实可以做的比较简单，就是某个节点尝试创建临时 znode，此时创建成功了就获取了这个锁；这个时候别的客户端来创建锁会失败，只能注册个监听器监听这个锁。释放锁就是删除这个 znode，一旦释放掉就会通知客户端，然后有一个等待着的客户端就可以再次重新加锁。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="69553628485180560000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`/**\n * ZooKeeperSession\n */\npublic class ZooKeeperSession {\n\n    private static CountDownLatch connectedSemaphore = new CountDownLatch(1);\n\n    private ZooKeeper zookeeper;\n    private CountDownLatch latch;\n\n    public ZooKeeperSession() {\n        try {\n            this.zookeeper = new ZooKeeper(&quot;192.168.31.187:2181,192.168.31.19:2181,192.168.31.227:2181&quot;, 50000, new ZooKeeperWatcher());\n            try {\n                connectedSemaphore.await();\n            } catch (InterruptedException e) {\n                e.printStackTrace();\n            }\n\n            System.out.println(&quot;ZooKeeper session established......&quot;);\n        } catch (Exception e) {\n            e.printStackTrace();\n        }\n    }\n\n    /**\n     * 获取分布式锁\n     *\n     * @param productId\n     */\n    public Boolean acquireDistributedLock(Long productId) {\n        String path = &quot;/product-lock-&quot; + productId;\n\n        try {\n            zookeeper.create(path, &quot;&quot;.getBytes(), Ids.OPEN_ACL_UNSAFE, CreateMode.EPHEMERAL);\n            return true;\n        } catch (Exception e) {\n            while (true) {\n                try {\n                    // 相当于是给 node 注册一个监听器，去看看这个监听器是否存在\n                    Stat stat = zk.exists(path, true);\n\n                    if (stat != null) {\n                        this.latch = new CountDownLatch(1);\n                        this.latch.await(waitTime, TimeUnit.MILLISECONDS);\n                        this.latch = null;\n                    }\n                    zookeeper.create(path, &quot;&quot;.getBytes(), Ids.OPEN_ACL_UNSAFE, CreateMode.EPHEMERAL);\n                    return true;\n                } catch (Exception ee) {\n                    continue;\n                }\n            }\n\n        }\n        return true;\n    }\n\n    /**\n     * 释放掉一个分布式锁\n     *\n     * @param productId\n     */\n    public void releaseDistributedLock(Long productId) {\n        String path = &quot;/product-lock-&quot; + productId;\n        try {\n            zookeeper.delete(path, -1);\n            System.out.println(&quot;release the lock for product[id=&quot; + productId + &quot;]......&quot;);\n        } catch (Exception e) {\n            e.printStackTrace();\n        }\n    }\n\n    /**\n     * 建立 zk session 的 watcher\n     */\n    private class ZooKeeperWatcher implements Watcher {\n\n        public void process(WatchedEvent event) {\n            System.out.println(&quot;Receive watched event: &quot; + event.getState());\n\n            if (KeeperState.SyncConnected == event.getState()) {\n                connectedSemaphore.countDown();\n            }\n\n            if (this.latch != null) {\n                this.latch.countDown();\n            }\n        }\n\n    }\n\n    /**\n     * 封装单例的静态内部类\n     */\n    private static class Singleton {\n\n        private static ZooKeeperSession instance;\n\n        static {\n            instance = new ZooKeeperSession();\n        }\n\n        public static ZooKeeperSession getInstance() {\n            return instance;\n        }\n\n    }\n\n    /**\n     * 获取单例\n     *\n     * @return\n     */\n    public static ZooKeeperSession getInstance() {\n        return Singleton.getInstance();\n    }\n\n    /**\n     * 初始化单例的便捷方法\n     */\n    public static void init() {\n        getInstance();\n    }\n\n}`, `69553628485180560000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token comment">/**\n * ZooKeeperSession\n */</span>\n<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ZooKeeperSession</span> <span class="token punctuation">{</span>\n\n    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">CountDownLatch</span> connectedSemaphore <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">private</span> <span class="token class-name">ZooKeeper</span> zookeeper<span class="token punctuation">;</span>\n    <span class="token keyword">private</span> <span class="token class-name">CountDownLatch</span> latch<span class="token punctuation">;</span>\n\n    <span class="token keyword">public</span> <span class="token class-name">ZooKeeperSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">try</span> <span class="token punctuation">{</span>\n            <span class="token keyword">this</span><span class="token punctuation">.</span>zookeeper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZooKeeper</span><span class="token punctuation">(</span><span class="token string">"192.168.31.187:2181,192.168.31.19:2181,192.168.31.227:2181"</span><span class="token punctuation">,</span> <span class="token number">50000</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ZooKeeperWatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token keyword">try</span> <span class="token punctuation">{</span>\n                connectedSemaphore<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span>\n\n            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"ZooKeeper session established......"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token comment">/**\n     * 获取分布式锁\n     *\n     * @param productId\n     */</span>\n    <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">acquireDistributedLock</span><span class="token punctuation">(</span><span class="token class-name">Long</span> productId<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token class-name">String</span> path <span class="token operator">=</span> <span class="token string">"/product-lock-"</span> <span class="token operator">+</span> productId<span class="token punctuation">;</span>\n\n        <span class="token keyword">try</span> <span class="token punctuation">{</span>\n            zookeeper<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Ids</span><span class="token punctuation">.</span>OPEN_ACL_UNSAFE<span class="token punctuation">,</span> <span class="token class-name">CreateMode</span><span class="token punctuation">.</span>EPHEMERAL<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                <span class="token keyword">try</span> <span class="token punctuation">{</span>\n                    <span class="token comment">// 相当于是给 node 注册一个监听器，去看看这个监听器是否存在</span>\n                    <span class="token class-name">Stat</span> stat <span class="token operator">=</span> zk<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n                    <span class="token keyword">if</span> <span class="token punctuation">(</span>stat <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                        <span class="token keyword">this</span><span class="token punctuation">.</span>latch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                        <span class="token keyword">this</span><span class="token punctuation">.</span>latch<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span>waitTime<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>\n                        <span class="token keyword">this</span><span class="token punctuation">.</span>latch <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n                    <span class="token punctuation">}</span>\n                    zookeeper<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Ids</span><span class="token punctuation">.</span>OPEN_ACL_UNSAFE<span class="token punctuation">,</span> <span class="token class-name">CreateMode</span><span class="token punctuation">.</span>EPHEMERAL<span class="token punctuation">)</span><span class="token punctuation">;</span>\n                    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ee<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                    <span class="token keyword">continue</span><span class="token punctuation">;</span>\n                <span class="token punctuation">}</span>\n            <span class="token punctuation">}</span>\n\n        <span class="token punctuation">}</span>\n        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token comment">/**\n     * 释放掉一个分布式锁\n     *\n     * @param productId\n     */</span>\n    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">releaseDistributedLock</span><span class="token punctuation">(</span><span class="token class-name">Long</span> productId<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token class-name">String</span> path <span class="token operator">=</span> <span class="token string">"/product-lock-"</span> <span class="token operator">+</span> productId<span class="token punctuation">;</span>\n        <span class="token keyword">try</span> <span class="token punctuation">{</span>\n            zookeeper<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"release the lock for product[id="</span> <span class="token operator">+</span> productId <span class="token operator">+</span> <span class="token string">"]......"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token comment">/**\n     * 建立 zk session 的 watcher\n     */</span>\n    <span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">ZooKeeperWatcher</span> <span class="token keyword">implements</span> <span class="token class-name">Watcher</span> <span class="token punctuation">{</span>\n\n        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token class-name">WatchedEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Receive watched event: "</span> <span class="token operator">+</span> event<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">KeeperState</span><span class="token punctuation">.</span><span class="token class-name">SyncConnected</span> <span class="token operator">==</span> event<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                connectedSemaphore<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span>\n\n            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>latch <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                <span class="token keyword">this</span><span class="token punctuation">.</span>latch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span>\n\n    <span class="token punctuation">}</span>\n\n    <span class="token comment">/**\n     * 封装单例的静态内部类\n     */</span>\n    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Singleton</span> <span class="token punctuation">{</span>\n\n        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ZooKeeperSession</span> instance<span class="token punctuation">;</span>\n\n        <span class="token keyword">static</span> <span class="token punctuation">{</span>\n            instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZooKeeperSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n\n        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ZooKeeperSession</span> <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">return</span> instance<span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n\n    <span class="token punctuation">}</span>\n\n    <span class="token comment">/**\n     * 获取单例\n     *\n     * @return\n     */</span>\n    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ZooKeeperSession</span> <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">return</span> <span class="token class-name">Singleton</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token comment">/**\n     * 初始化单例的便捷方法\n     */</span>\n    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>也可以采用另一种方式，创建临时顺序节点：</p>\n<p>如果有一把锁，被多个人给竞争，此时多个人会排队，第一个拿到锁的人会执行，然后释放锁；后面的每个人都会去监听排在自己前面的那个人创建的 node 上，一旦某个人释放了锁，排在自己后面的人就会被 ZooKeeper 给通知，一旦被通知了之后，就 ok 了，自己就获取到了锁，就可以执行代码了。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="91385684628030650000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public class ZooKeeperDistributedLock implements Watcher {\n\n    private ZooKeeper zk;\n    private String locksRoot = &quot;/locks&quot;;\n    private String productId;\n    private String waitNode;\n    private String lockNode;\n    private CountDownLatch latch;\n    private CountDownLatch connectedLatch = new CountDownLatch(1);\n    private int sessionTimeout = 30000;\n\n    public ZooKeeperDistributedLock(String productId) {\n        this.productId = productId;\n        try {\n            String address = &quot;192.168.31.187:2181,192.168.31.19:2181,192.168.31.227:2181&quot;;\n            zk = new ZooKeeper(address, sessionTimeout, this);\n            connectedLatch.await();\n        } catch (IOException e) {\n            throw new LockException(e);\n        } catch (KeeperException e) {\n            throw new LockException(e);\n        } catch (InterruptedException e) {\n            throw new LockException(e);\n        }\n    }\n\n    public void process(WatchedEvent event) {\n        if (event.getState() == KeeperState.SyncConnected) {\n            connectedLatch.countDown();\n            return;\n        }\n\n        if (this.latch != null) {\n            this.latch.countDown();\n        }\n    }\n\n    public void acquireDistributedLock() {\n        try {\n            if (this.tryLock()) {\n                return;\n            } else {\n                waitForLock(waitNode, sessionTimeout);\n            }\n        } catch (KeeperException e) {\n            throw new LockException(e);\n        } catch (InterruptedException e) {\n            throw new LockException(e);\n        }\n    }\n\n    public boolean tryLock() {\n        try {\n            // 传入进去的 locksRoot + &quot;/&quot; + productId\n            // 假设 productId 代表了一个商品 id，比如说 1\n            // locksRoot = locks\n            // /locks/10000000000，/locks/10000000001，/locks/10000000002\n            lockNode = zk.create(locksRoot + &quot;/&quot; + productId, new byte[0], ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.EPHEMERAL_SEQUENTIAL);\n\n            // 看看刚创建的节点是不是最小的节点\n            // locks：10000000000，10000000001，10000000002\n            List<String> locks = zk.getChildren(locksRoot, false);\n            Collections.sort(locks);\n\n            if (lockNode.equals(locksRoot + &quot;/&quot; + locks.get(0))) {\n                // 如果是最小的节点，则表示取得锁\n                return true;\n            }\n\n            // 如果不是最小的节点，找到比自己小 1 的节点\n            int previousLockIndex = -1;\n            for (int i = 0; i < locks.size(); i++) {\n                if (lockNode.equals(locksRoot + &quot;/&quot; +locks.get(i))){\n                    previousLockIndex = i - 1;\n                    break;\n                }\n            }\n\n            this.waitNode = locks.get(previousLockIndex);\n        } catch (KeeperException e) {\n            throw new LockException(e);\n        } catch (InterruptedException e) {\n            throw new LockException(e);\n        }\n        return false;\n    }\n\n    private boolean waitForLock(String waitNode, long waitTime) throws InterruptedException, KeeperException {\n        Stat stat = zk.exists(locksRoot + &quot;/&quot; + waitNode, true);\n        if (stat != null) {\n            this.latch = new CountDownLatch(1);\n            this.latch.await(waitTime, TimeUnit.MILLISECONDS);\n            this.latch = null;\n        }\n        return true;\n    }\n\n    public void unlock() {\n        try {\n            // 删除 /locks/10000000000 节点\n            // 删除 /locks/10000000001 节点\n            System.out.println(&quot;unlock &quot; + lockNode);\n            zk.delete(lockNode, -1);\n            lockNode = null;\n            zk.close();\n        } catch (InterruptedException e) {\n            e.printStackTrace();\n        } catch (KeeperException e) {\n            e.printStackTrace();\n        }\n    }\n\n    public class LockException extends RuntimeException {\n        private static final long serialVersionUID = 1L;\n\n        public LockException(String e) {\n            super(e);\n        }\n\n        public LockException(Exception e) {\n            super(e);\n        }\n    }\n}`, `91385684628030650000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ZooKeeperDistributedLock</span> <span class="token keyword">implements</span> <span class="token class-name">Watcher</span> <span class="token punctuation">{</span>\n\n    <span class="token keyword">private</span> <span class="token class-name">ZooKeeper</span> zk<span class="token punctuation">;</span>\n    <span class="token keyword">private</span> <span class="token class-name">String</span> locksRoot <span class="token operator">=</span> <span class="token string">"/locks"</span><span class="token punctuation">;</span>\n    <span class="token keyword">private</span> <span class="token class-name">String</span> productId<span class="token punctuation">;</span>\n    <span class="token keyword">private</span> <span class="token class-name">String</span> waitNode<span class="token punctuation">;</span>\n    <span class="token keyword">private</span> <span class="token class-name">String</span> lockNode<span class="token punctuation">;</span>\n    <span class="token keyword">private</span> <span class="token class-name">CountDownLatch</span> latch<span class="token punctuation">;</span>\n    <span class="token keyword">private</span> <span class="token class-name">CountDownLatch</span> connectedLatch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">private</span> <span class="token keyword">int</span> sessionTimeout <span class="token operator">=</span> <span class="token number">30000</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">public</span> <span class="token class-name">ZooKeeperDistributedLock</span><span class="token punctuation">(</span><span class="token class-name">String</span> productId<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">this</span><span class="token punctuation">.</span>productId <span class="token operator">=</span> productId<span class="token punctuation">;</span>\n        <span class="token keyword">try</span> <span class="token punctuation">{</span>\n            <span class="token class-name">String</span> address <span class="token operator">=</span> <span class="token string">"192.168.31.187:2181,192.168.31.19:2181,192.168.31.227:2181"</span><span class="token punctuation">;</span>\n            zk <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZooKeeper</span><span class="token punctuation">(</span>address<span class="token punctuation">,</span> sessionTimeout<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            connectedLatch<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">LockException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">KeeperException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">LockException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">LockException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token class-name">WatchedEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">KeeperState</span><span class="token punctuation">.</span><span class="token class-name">SyncConnected</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            connectedLatch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token keyword">return</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n\n        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>latch <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">this</span><span class="token punctuation">.</span>latch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">acquireDistributedLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">try</span> <span class="token punctuation">{</span>\n            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                <span class="token keyword">return</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n                <span class="token function">waitForLock</span><span class="token punctuation">(</span>waitNode<span class="token punctuation">,</span> sessionTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">KeeperException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">LockException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">LockException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">try</span> <span class="token punctuation">{</span>\n            <span class="token comment">// 传入进去的 locksRoot + "/" + productId</span>\n            <span class="token comment">// 假设 productId 代表了一个商品 id，比如说 1</span>\n            <span class="token comment">// locksRoot = locks</span>\n            <span class="token comment">// /locks/10000000000，/locks/10000000001，/locks/10000000002</span>\n            lockNode <span class="token operator">=</span> zk<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>locksRoot <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span> productId<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token class-name">ZooDefs</span><span class="token punctuation">.</span><span class="token class-name">Ids</span><span class="token punctuation">.</span>OPEN_ACL_UNSAFE<span class="token punctuation">,</span> <span class="token class-name">CreateMode</span><span class="token punctuation">.</span>EPHEMERAL_SEQUENTIAL<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n            <span class="token comment">// 看看刚创建的节点是不是最小的节点</span>\n            <span class="token comment">// locks：10000000000，10000000001，10000000002</span>\n            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> locks <span class="token operator">=</span> zk<span class="token punctuation">.</span><span class="token function">getChildren</span><span class="token punctuation">(</span>locksRoot<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>locks<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n            <span class="token keyword">if</span> <span class="token punctuation">(</span>lockNode<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>locksRoot <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span> locks<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                <span class="token comment">// 如果是最小的节点，则表示取得锁</span>\n                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span>\n\n            <span class="token comment">// 如果不是最小的节点，找到比自己小 1 的节点</span>\n            <span class="token keyword">int</span> previousLockIndex <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>\n            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> locks<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                <span class="token keyword">if</span> <span class="token punctuation">(</span>lockNode<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>locksRoot <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span>locks<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>\n                    previousLockIndex <span class="token operator">=</span> i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>\n                    <span class="token keyword">break</span><span class="token punctuation">;</span>\n                <span class="token punctuation">}</span>\n            <span class="token punctuation">}</span>\n\n            <span class="token keyword">this</span><span class="token punctuation">.</span>waitNode <span class="token operator">=</span> locks<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>previousLockIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">KeeperException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">LockException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">LockException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">waitForLock</span><span class="token punctuation">(</span><span class="token class-name">String</span> waitNode<span class="token punctuation">,</span> <span class="token keyword">long</span> waitTime<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">KeeperException</span> <span class="token punctuation">{</span>\n        <span class="token class-name">Stat</span> stat <span class="token operator">=</span> zk<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span>locksRoot <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span> waitNode<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>stat <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">this</span><span class="token punctuation">.</span>latch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token keyword">this</span><span class="token punctuation">.</span>latch<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span>waitTime<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token keyword">this</span><span class="token punctuation">.</span>latch <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">try</span> <span class="token punctuation">{</span>\n            <span class="token comment">// 删除 /locks/10000000000 节点</span>\n            <span class="token comment">// 删除 /locks/10000000001 节点</span>\n            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"unlock "</span> <span class="token operator">+</span> lockNode<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            zk<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>lockNode<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            lockNode <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n            zk<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">KeeperException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LockException</span> <span class="token keyword">extends</span> <span class="token class-name">RuntimeException</span> <span class="token punctuation">{</span>\n        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span>\n\n        <span class="token keyword">public</span> <span class="token class-name">LockException</span><span class="token punctuation">(</span><span class="token class-name">String</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">super</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n\n        <span class="token keyword">public</span> <span class="token class-name">LockException</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">super</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>但是，使用 zk 临时节点会存在另一个问题：由于 zk 依靠 session 定期的心跳来维持客户端，如果客户端进入长时间的 GC，可能会导致 zk 认为客户端宕机而释放锁，让其他的客户端获取锁，但是客户端在 GC 恢复后，会认为自己还持有锁，从而可能出现多个客户端同时获取到锁的情形。</p>\n<p>针对这种情况，可以通过 JVM 调优，尽量避免长时间 GC 的情况发生。</p>\n<h4 id="redis-分布式锁和-zk-分布式锁的对比"><a href="#redis-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E5%92%8C-zk-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E7%9A%84%E5%AF%B9%E6%AF%94" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>redis 分布式锁和 zk 分布式锁的对比</h4>\n<ul>\n<li>redis 分布式锁，其实需要自己不断去尝试获取锁，比较消耗性能。</li>\n<li>zk 分布式锁，获取不到锁，注册个监听器即可，不需要不断主动尝试获取锁，性能开销较小。</li>\n</ul>\n<p>另外一点就是，如果是 Redis 获取锁的那个客户端 出现 bug 挂了，那么只能等待超时时间之后才能释放锁；而 zk 的话，因为创建的是临时 znode，只要客户端挂了，znode 就没了，此时就自动释放锁。</p>\n<p>Redis 分布式锁大家没发现好麻烦吗？遍历上锁，计算时间等等，zk 的分布式锁语义清晰实现简单。</p>\n<p>所以先不分析太多的东西，就说这两点，我个人实践认为 zk 的分布式锁比 Redis 的分布式锁牢靠、而且模型简单易用。</p>\n<h2 id="分布式事务"><a href="#%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>分布式事务</h2>\n<h3 id="分布式事务了解吗？"><a href="#%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E4%BA%86%E8%A7%A3%E5%90%97%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>分布式事务了解吗？</h3>\n<p>只要聊到你做了分布式系统，必问分布式事务，你对分布式事务一无所知的话，确实会很坑，你起码得知道有哪些方案，一般怎么来做，每个方案的优缺点是什么。</p>\n<p>现在面试，分布式系统成了标配，而分布式系统带来的分布式事务也成了标配了。因为你做系统肯定要用事务吧，如果是分布式系统，肯定要用分布式事务吧。先不说你搞过没有，起码你得明白有哪几种方案，每种方案可能有啥坑？比如 TCC 方案的网络问题、XA 方案的一致性问题。</p>\n<p>分布式事务的实现主要有以下 6 种方案：</p>\n<ul>\n<li>XA 方案</li>\n<li>TCC 方案</li>\n<li>SAGA 方案</li>\n<li>本地消息表</li>\n<li>可靠消息最终一致性方案</li>\n<li>最大努力通知方案</li>\n</ul>\n<h4 id="两阶段提交方案xa-方案"><a href="#%E4%B8%A4%E9%98%B6%E6%AE%B5%E6%8F%90%E4%BA%A4%E6%96%B9%E6%A1%88xa-%E6%96%B9%E6%A1%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>两阶段提交方案/XA 方案</h4>\n<p>所谓的 XA 方案，即：两阶段提交，有一个事务管理器的概念，负责协调多个数据库（资源管理器）的事务，事务管理器先问问各个数据库你准备好了吗？如果每个数据库都回复 ok，那么就正式提交事务，在各个数据库上执行操作；如果任何其中一个数据库回答不 ok，那么就回滚事务。</p>\n<p>这种分布式事务方案，比较适合单块应用里，跨多个库的分布式事务，而且因为严重依赖于数据库层面来搞定复杂的事务，效率很低，绝对不适合高并发的场景。如果要玩儿，那么基于 Spring + JTA 就可以搞定，自己随便搜个 demo 看看就知道了。</p>\n<p>这个方案，我们很少用，一般来说某个系统内部如果出现跨多个库的这么一个操作，是不合规的。我可以给大家介绍一下，现在微服务，一个大的系统分成几十个甚至几百个服务。一般来说，我们的规定和规范，是要求每个服务只能操作自己对应的一个数据库。</p>\n<p>如果你要操作别的服务对应的库，不允许直连别的服务的库，违反微服务架构的规范，你随便交叉胡乱访问，几百个服务的话，全体乱套，这样的一套服务是没法管理的，没法治理的，可能会出现数据被别人改错，自己的库被别人写挂等情况。</p>\n<p>如果你要操作别人的服务的库，你必须是通过调用别的服务的接口来实现，绝对不允许交叉访问别人的数据库。</p>\n<ul>\n<li>第一阶段，询问</li>\n<li>第二阶段，执行</li>\n</ul>\n<div class="mermaid">graph LR\n   subgraph 系统\n      事务管理器\n   end\n   事务管理器 --> 数据库1\n   事务管理器 --> 数据库2\n   事务管理器 --> 数据库3</div>\n<h4 id="tcc-方案"><a href="#tcc-%E6%96%B9%E6%A1%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>TCC 方案</h4>\n<p>TCC 的全称是：Try、Confirm、Cancel。</p>\n<ul>\n<li>Try 阶段：这个阶段说的是对各个服务的资源做检测以及对资源进行锁定或者预留。</li>\n<li>Confirm 阶段：这个阶段说的是在各个服务中执行实际的操作。</li>\n<li>Cancel 阶段：如果任何一个服务的业务方法执行出错，那么这里就需要进行补偿，就是执行已经执行成功的业务逻辑的回滚操作。（把那些执行成功的回滚）</li>\n</ul>\n<p>这种方案说实话几乎很少人使用，我们用的也比较少，但是也有使用的场景。因为这个事务回滚实际上是严重依赖于你自己写代码来回滚和补偿了，会造成补偿代码巨大，非常之恶心。</p>\n<p>比如说我们，一般来说跟钱相关的，跟钱打交道的，支付、交易相关的场景，我们会用 TCC，严格保证分布式事务要么全部成功，要么全部自动回滚，严格保证资金的正确性，保证在资金上不会出现问题。</p>\n<p>而且最好是你的各个业务执行的时间都比较短。</p>\n<p>但是说实话，一般尽量别这么搞，自己手写回滚逻辑，或者是补偿逻辑，实在太恶心了，那个业务代码是很难维护的。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="22766208690498770000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`Try 阶段：冻结银行资金\n\nConfirm 阶段\n\n1. 在自己的库里插入数据\n2. 调用银行 B 的接囗，扣款\n3. 调用银行 C 的接口，转账\n\nCancel 阶段：回滚\n\n将银行 B 的扣款给他加回去`, `22766208690498770000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">Try 阶段：冻结银行资金\n\nConfirm 阶段\n\n1. 在自己的库里插入数据\n2. 调用银行 B 的接囗，扣款\n3. 调用银行 C 的接口，转账\n\nCancel 阶段：回滚\n\n将银行 B 的扣款给他加回去</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div class="mermaid">graph TB\n   用户 --> 系统A\n   系统A --> 数据库\n   系统A --> 银行B --> A[数据库]\n   系统A --> 银行C --> B[数据库]</div>\n<h4 id="saga-方案"><a href="#saga-%E6%96%B9%E6%A1%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Saga 方案</h4>\n<p>金融核心等业务可能会选择 TCC 方案，以追求强一致性和更高的并发量，而对于更多的金融核心以上的业务系统 往往会选择补偿事务，补偿事务处理在 30 多年前就提出了 Saga 理论，随着微服务的发展，近些年才逐步受到大家的关注。目前业界比较公认的是采用 Saga 作为长事务的解决方案。</p>\n<h5 id="基本原理"><a href="#%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>基本原理</h5>\n<p>业务流程中每个参与者都提交本地事务，若某一个参与者失败，则补偿前面已经成功的参与者。下图左侧是正常的事务流程，当执行到 T3 时发生了错误，则开始执行右边的事务补偿流程，反向执行 T3、T2、T1 的补偿服务 C3、C2、C1，将 T3、T2、T1 已经修改的数据补偿掉。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-09-24-20-20-26-4f6e2fd242e91975178bd7d994b2b7c8-99ffa.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 793px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 102.26986128625472%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAIAAAAC64paAAAACXBIWXMAAAsSAAALEgHS3X78AAADEElEQVQ4y3WU227bRhCG/ZJBEBi5SXKVPEmA9iZvkYvGgGsgaAuhRYDqLMeSKMsSD6JIKeJZFLnnXZIZUrIdN+iAWAx399/Z+WbIM8aYEIKz2iiljDLB67eqqmCe1lOMUIowhpE0OwghRWNnINkeXDux3MPaSW1wIhQKLmqxUuJw4LrODUNZFjhsuVQIwXzV2BlhZOZNbgPt73FrYPU0f2yGOkaEc44oQ67L+/2829UvL/loRNptHgSiKKqyrMWUkbtAA/3IHo43X6fejZPYELksS6EK6vu030eDgfflC7u+xt2uiONHMUQgkmCRb5M0Qhk4XPHTtYWQnBdZLuOIapqIIpVlhZRciNO1QXz0tpFMUQEOHHoEBkuqSQ8EyNDLQjWr5YPkjHG2y7ZuYhsh0Fo7ySrBsRTyBCzLmGkww+DTKTjU0BXGQsqnwEKtdf1XZ/GvFkysyICaKCmpEHi7AWCo19MuPpFBn3Q6PAx/BEbnvnbrawOzN1oNNH+yjleccSgjA723o4MBGY7cVgsPhwSARdETYIjnGdu7SRLmaUb3VNJjVjUwxlSa8t2OTiYiCOR+X0BHPeQs7tFtQpEidQLWTEJuqqgRgiBbLMsm2s/Avjn7tRk5duI46TrJQ7rzhOchy+T7hFlWDUzTwKHQahhxIf/bYf+MWz29rQVT01tk22/Icfb6Epkm73RQr7+4+p1A8j8BI3N/OvMnXb09tHpTf+wcXCkULMPVaZpCe6B+3/78GYO46TCo/iMwLDBiByfeByjL8hB5G8ipuLlhV1f5xUX28SPZbgEVCQJ4GMHy4cPgdSfCOcoJcZw1jdXtsMtL9f59dX5evXpVvHtXIHRkdQRW3VtdZzNeLsLbuT9bBPO7YLajgfztk3z9enV+rj97lr19WyFU771P9VF832GzP4d/dJZtzZ/akQE01a+/BM+fuy9e4AfxU+UpshUby3AOYZfB3SK49Q4byER++FC9fFm9eQPXLvP8f8QEfis4xzkiqB7hP0Awg1LaK3bzlU3GTNNKpcqjGvTl6RAYvwNRcU9jXQNFIwAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 09 24 20 20 26" title="" data-src="/static/2023-09-24-20-20-26-4f6e2fd242e91975178bd7d994b2b7c8-99ffa.png" data-srcset="/static/2023-09-24-20-20-26-4f6e2fd242e91975178bd7d994b2b7c8-e6b42.png 200w,\n/static/2023-09-24-20-20-26-4f6e2fd242e91975178bd7d994b2b7c8-2a82f.png 400w,\n/static/2023-09-24-20-20-26-4f6e2fd242e91975178bd7d994b2b7c8-99ffa.png 793w" data-sizes="(max-width: 793px) 100vw, 793px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h5 id="使用场景"><a href="#%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用场景</h5>\n<p>对于一致性要求高、短流程、并发高的场景，如：金融核心系统，会优先考虑 TCC 方案。而在另外一些场景下，我们并不需要这么强的一致性，只需要保证最终一致性即可。</p>\n<p>比如很多金融核心以上的业务（渠道层、产品层、系统集成层），这些系统的特点是最终一致即可、流程多、流程长、还可能要调用其它公司的服务。这种情况如果选择 TCC 方案开发的话，一来成本高，二来无法要求其它公司的服务也遵循 TCC 模式。同时流程长，事务边界太长，加锁时间长，也会影响并发性能。</p>\n<p>所以 Saga 模式的适用场景是：</p>\n<ul>\n<li>业务流程长、业务流程多；</li>\n<li>参与者包含其它公司或遗留系统服务，无法提供 TCC 模式要求的三个接口。</li>\n</ul>\n<h5 id="优点-1"><a href="#%E4%BC%98%E7%82%B9-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>优点</h5>\n<ul>\n<li>一阶段提交本地事务，无锁，高性能；</li>\n<li>参与者可异步执行，高吞吐；</li>\n<li>补偿服务易于实现，因为一个更新操作的反向操作是比较容易理解的。</li>\n</ul>\n<h5 id="缺点-1"><a href="#%E7%BC%BA%E7%82%B9-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>缺点</h5>\n<p>不保证事务的隔离性。</p>\n<h4 id="本地消息表"><a href="#%E6%9C%AC%E5%9C%B0%E6%B6%88%E6%81%AF%E8%A1%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>本地消息表</h4>\n<p>本地消息表其实是国外的 ebay 搞出来的这么一套思想。</p>\n<p>这个大概意思是这样的：</p>\n<ol>\n<li>A 系统在自己本地一个事务里操作同时，插入一条数据到消息表；</li>\n<li>接着 A 系统将这个消息发送到 MQ 中去；</li>\n<li>B 系统接收到消息之后，在一个事务里，往自己本地消息表里插入一条数据，同时执行其他的业务操作，如果这个消息已经被处理过了，那么此时这个事务会回滚，这样保证不会重复处理消息；</li>\n<li>B 系统执行成功之后，就会更新自己本地消息表的状态以及 A 系统消息表的状态；</li>\n<li>如果 B 系统处理失败了，那么就不会更新消息表状态，那么此时 A 系统会定时扫描自己的消息表，如果有未处理的消息，会再次发送到 MQ 中去，让 B 再次处理；</li>\n<li>这个方案保证了最终一致性，哪怕 B 事务失败了，但是 A 会不断重发消息，直到 B 那边成功为止。</li>\n</ol>\n<p>这个方案说实话最大的问题就在于严重依赖于数据库的消息表来管理事务啥的，如果是高并发场景咋办呢？咋扩展呢？所以一般确实很少用。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-09-24-20-22-38-bb409d68e17c59bab402e21c73dc5d57-cf7a7.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 42.51012145748987%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAAsSAAALEgHS3X78AAAA+klEQVQoz4WRxw6DMAyG8/5PhzhwACHELHuPEgTpVyIhtRzwKbb/YTsiSZIsy9Z1jePYtu2qqsqyfJ0xz7NSqmka0zRpHcehfkP4vh+GIbi2bfM8L4qi67plWaSU0zS9zxjHse97ingA402XVKAHGsM0TTGBrNvIMUJd16RASYGRMiBIAMMwiG3b4JDQQxgfqngiSlELUQcDByYpTlEUIfclQ9BzMh4rIK9X2vcdxNXSUxBMxILICV5akrMhCQiCPOPvPNfBMOPMUITmoBQEAZMzs+d5lmXRVk8hsIXDJqjgiTMP13WpPJM5BhMiYRiG4zi8WZVD3H/1Hh9MEwIVwJg8IAAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 09 24 20 22 38" title="" data-src="/static/2023-09-24-20-22-38-bb409d68e17c59bab402e21c73dc5d57-fee1c.png" data-srcset="/static/2023-09-24-20-22-38-bb409d68e17c59bab402e21c73dc5d57-a67b7.png 200w,\n/static/2023-09-24-20-22-38-bb409d68e17c59bab402e21c73dc5d57-0b187.png 400w,\n/static/2023-09-24-20-22-38-bb409d68e17c59bab402e21c73dc5d57-fee1c.png 800w,\n/static/2023-09-24-20-22-38-bb409d68e17c59bab402e21c73dc5d57-b1a91.png 1200w,\n/static/2023-09-24-20-22-38-bb409d68e17c59bab402e21c73dc5d57-95179.png 1600w,\n/static/2023-09-24-20-22-38-bb409d68e17c59bab402e21c73dc5d57-cf7a7.png 1729w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h4 id="可靠消息最终一致性方案"><a href="#%E5%8F%AF%E9%9D%A0%E6%B6%88%E6%81%AF%E6%9C%80%E7%BB%88%E4%B8%80%E8%87%B4%E6%80%A7%E6%96%B9%E6%A1%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>可靠消息最终一致性方案</h4>\n<p>这个的意思，就是干脆不要用本地的消息表了，直接基于 MQ 来实现事务。比如阿里的 RocketMQ 就支持消息事务。</p>\n<p>大概的意思就是：</p>\n<ol>\n<li>A 系统先发送一个 prepared 消息到 mq，如果这个 prepared 消息发送失败那么就直接取消操作别执行了；</li>\n<li>如果这个消息发送成功过了，那么接着执行本地事务，如果成功就告诉 mq 发送确认消息，如果失败就告诉 mq 回滚消息；</li>\n<li>如果发送了确认消息，那么此时 B 系统会接收到确认消息，然后执行本地的事务；</li>\n<li>mq 会自动定时轮询所有 prepared 消息回调你的接口，问你，这个消息是不是本地事务处理失败了，所有没发送确认的消息，是继续重试还是回滚？一般来说这里你就可以查下数据库看之前本地事务是否执行，如果回滚了，那么这里也回滚吧。这个就是避免可能本地事务执行成功了，而确认消息却发送失败了。</li>\n<li>这个方案里，要是系统 B 的事务失败了咋办？重试咯，自动不断重试直到成功，如果实在是不行，要么就是针对重要的资金类业务进行回滚，比如 B 系统本地回滚后，想办法通知系统 A 也回滚；或者是发送报警由人工来手工回滚和补偿。</li>\n<li>这个还是比较合适的，目前国内互联网公司大都是这么玩儿的，要不你就用 RocketMQ 支持的，要不你就自己基于类似 ActiveMQ？RabbitMQ？自己封装一套类似的逻辑出来，总之思路就是这样子的。</li>\n</ol>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-09-24-20-23-59-c1847381caa4b800d98f2ab899a0679f-9c8dd.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 45.80838323353294%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAAsSAAALEgHS3X78AAABC0lEQVQoz12R6YqDQBCE8/7vJv4QBC9cFS+8Nep6br5MB7NJgUNPd1dV93jL8zyKojRN27a9K0zTRPyjkGXZPM+/CpPC3z/c4jg2TdP3/bIs13Wlqes64qqqlmWByUl+27bzPIVM8CLzUaADk02BeN93VCiN48hcmqY5jjMMQ9/3lI7jWBSeZORxY1ROupGniSsBGaokJcNSBHVdF0XB9UlGjBR3TgZumgaaOBNQleloSJIEDlugguiLXCuwv+d5YRg2CuIm60EmA5/hP3ZGQ2aOFCAj5LquZVlBEEgfbujato3BBxlneYArS4AJfNwuZ34qj8pf4MHe5C+IBN1MJAsDpA3D0HWdca7kAw1tAhJhJ6vbAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 09 24 20 23 59" title="" data-src="/static/2023-09-24-20-23-59-c1847381caa4b800d98f2ab899a0679f-fee1c.png" data-srcset="/static/2023-09-24-20-23-59-c1847381caa4b800d98f2ab899a0679f-a67b7.png 200w,\n/static/2023-09-24-20-23-59-c1847381caa4b800d98f2ab899a0679f-0b187.png 400w,\n/static/2023-09-24-20-23-59-c1847381caa4b800d98f2ab899a0679f-fee1c.png 800w,\n/static/2023-09-24-20-23-59-c1847381caa4b800d98f2ab899a0679f-b1a91.png 1200w,\n/static/2023-09-24-20-23-59-c1847381caa4b800d98f2ab899a0679f-95179.png 1600w,\n/static/2023-09-24-20-23-59-c1847381caa4b800d98f2ab899a0679f-9c8dd.png 1670w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h4 id="最大努力通知方案"><a href="#%E6%9C%80%E5%A4%A7%E5%8A%AA%E5%8A%9B%E9%80%9A%E7%9F%A5%E6%96%B9%E6%A1%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>最大努力通知方案</h4>\n<p>这个方案的大致意思就是：</p>\n<ol>\n<li>系统 A 本地事务执行完之后，发送个消息到 MQ；</li>\n<li>这里会有个专门消费 MQ 的最大努力通知服务，这个服务会消费 MQ 然后写入数据库中记录下来，或者是放入个内存队列也可以，接着调用系统 B 的接口；</li>\n<li>要是系统 B 执行成功就 ok 了；要是系统 B 执行失败了，那么最大努力通知服务就定时尝试重新调用系统 B，反复 N 次，最后还是不行就放弃。</li>\n</ol>\n<h4 id="你们公司是如何处理分布式事务的？"><a href="#%E4%BD%A0%E4%BB%AC%E5%85%AC%E5%8F%B8%E6%98%AF%E5%A6%82%E4%BD%95%E5%A4%84%E7%90%86%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E7%9A%84%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>你们公司是如何处理分布式事务的？</h4>\n<p>如果你真的被问到，可以这么说，我们某某特别严格的场景，用的是 TCC 来保证强一致性；然后其他的一些场景基于阿里的 RocketMQ 来实现分布式事务。</p>\n<p>你找一个严格资金要求绝对不能错的场景，你可以说你是用的 TCC 方案；如果是一般的分布式事务场景，订单插入之后要调用库存服务更新库存，库存数据没有资金那么的敏感，可以用可靠消息最终一致性方案。</p>\n<p>友情提示一下，RocketMQ 3.2.6 之前的版本，是可以按照上面的思路来的，但是之后接口做了一些改变，我这里不再赘述了。</p>\n<p>当然如果你愿意，你可以参考可靠消息最终一致性方案来自己实现一套分布式事务，比如基于 RocketMQ 来玩儿。</p>\n<h2 id="分布式会话"><a href="#%E5%88%86%E5%B8%83%E5%BC%8F%E4%BC%9A%E8%AF%9D" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>分布式会话</h2>\n<h3 id="集群分布式-session-如何实现？"><a href="#%E9%9B%86%E7%BE%A4%E5%88%86%E5%B8%83%E5%BC%8F-session-%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>集群分布式 Session 如何实现？</h3>\n<p>面试官问了你一堆 Dubbo 是怎么玩儿的，你会玩儿 Dubbo 就可以把单块系统弄成分布式系统，然后分布式之后接踵而来的就是一堆问题，最大的问题就是分布式事务、接口幂等性、分布式锁，还有最后一个就是分布式 Session。</p>\n<p>当然了，分布式系统中的问题何止这么一点，非常之多，复杂度很高，这里只是说一下常见的几个问题，也是面试的时候常问的几个。</p>\n<p>Session 是啥？浏览器有个 Cookie，在一段时间内这个 Cookie 都存在，然后每次发请求过来都带上一个特殊的 <code class="language-text">jsessionid cookie</code>，就根据这个东西，在服务端可以维护一个对应的 Session 域，里面可以放点数据。</p>\n<p>一般的话只要你没关掉浏览器，Cookie 还在，那么对应的那个 Session 就在，但是如果 Cookie 没了，Session 也就没了。常见于什么购物车之类的东西，还有登录状态保存之类的。</p>\n<p>这个不多说了，懂 Java 的都该知道这个。</p>\n<p>单块系统的时候这么玩儿 Session 没问题，但是你要是分布式系统呢，那么多的服务，Session 状态在哪儿维护啊？</p>\n<p>其实方法很多，但是常见常用的是以下几种：</p>\n<h4 id="完全不用-session"><a href="#%E5%AE%8C%E5%85%A8%E4%B8%8D%E7%94%A8-session" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>完全不用 Session</h4>\n<p>使用 JWT Token 储存用户身份，然后再从数据库或者 cache 中获取其他的信息。这样无论请求分配到哪个服务器都无所谓。</p>\n<h4 id="tomcat--redis"><a href="#tomcat--redis" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Tomcat + Redis</h4>\n<p>这个其实还挺方便的，就是使用 Session 的代码，跟以前一样，还是基于 Tomcat 原生的 Session 支持即可，然后就是用一个叫做 Tomcat RedisSessionManager 的东西，让所有我们部署的 Tomcat 都将 Session 数据存储到 Redis 即可。</p>\n<p>在 Tomcat 的配置文件中配置：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="60330114181992900000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<Valve className=&quot;com.orangefunction.tomcat.redissessions.RedisSessionHandlerValve&quot; />\n\n<Manager className=&quot;com.orangefunction.tomcat.redissessions.RedisSessionManager&quot;\n         host=&quot;{redis.host}&quot;\n         port=&quot;{redis.port}&quot;\n         database=&quot;{redis.dbnum}&quot;\n         maxInactiveInterval=&quot;60&quot;/>`, `60330114181992900000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="xml"\n              >\n                <span class="gatsby-code-button-language">xml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="xml"><pre style="counter-reset: linenumber NaN" class="language-xml line-numbers"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Valve</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>com.orangefunction.tomcat.redissessions.RedisSessionHandlerValve<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>\n\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Manager</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>com.orangefunction.tomcat.redissessions.RedisSessionManager<span class="token punctuation">"</span></span>\n         <span class="token attr-name">host</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>{redis.host}<span class="token punctuation">"</span></span>\n         <span class="token attr-name">port</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>{redis.port}<span class="token punctuation">"</span></span>\n         <span class="token attr-name">database</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>{redis.dbnum}<span class="token punctuation">"</span></span>\n         <span class="token attr-name">maxInactiveInterval</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>60<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后指定 Redis 的 host 和 port 就 ok 了。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="68070349282125560000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<Valve className=&quot;com.orangefunction.tomcat.redissessions.RedisSessionHandlerValve&quot; />\n<Manager className=&quot;com.orangefunction.tomcat.redissessions.RedisSessionManager&quot;\n     sentinelMaster=&quot;mymaster&quot;\n     sentinels=&quot;<sentinel1-ip>:26379,<sentinel2-ip>:26379,<sentinel3-ip>:26379&quot;\n     maxInactiveInterval=&quot;60&quot;/>`, `68070349282125560000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="xml"\n              >\n                <span class="gatsby-code-button-language">xml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="xml"><pre style="counter-reset: linenumber NaN" class="language-xml line-numbers"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Valve</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>com.orangefunction.tomcat.redissessions.RedisSessionHandlerValve<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Manager</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>com.orangefunction.tomcat.redissessions.RedisSessionManager<span class="token punctuation">"</span></span>\n     <span class="token attr-name">sentinelMaster</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>mymaster<span class="token punctuation">"</span></span>\n     <span class="token attr-name">sentinels</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>&lt;sentinel1-ip>:26379,&lt;sentinel2-ip>:26379,&lt;sentinel3-ip>:26379<span class="token punctuation">"</span></span>\n     <span class="token attr-name">maxInactiveInterval</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>60<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>还可以用上面这种方式基于 Redis 哨兵支持的 Redis 高可用集群来保存 Session 数据，都是 ok 的。</p>\n<h4 id="spring-session--redis"><a href="#spring-session--redis" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Spring Session + Redis</h4>\n<p>上面所说的第二种方式会与 Tomcat 容器重耦合，如果我要将 Web 容器迁移成 Jetty，难道还要重新把 Jetty 都配置一遍？</p>\n<p>因为上面那种 Tomcat + Redis 的方式好用，但是会严重依赖于 Web 容器，不好将代码移植到其他 Web 容器上去，尤其是你要是换了技术栈咋整？比如换成了 Spring Cloud 或者是 Spring Boot 之类的呢？</p>\n<p>所以现在比较好的还是基于 Java 一站式解决方案，也就是 Spring。人家 Spring 基本上承包了大部分我们需要使用的框架，Spirng Cloud 做微服务，Spring Boot 做脚手架，所以用 Spring Session 是一个很好的选择。</p>\n<p>在 pom.xml 中配置：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="28084922894579510000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<dependency>\n  <groupId>org.springframework.session</groupId>\n  <artifactId>spring-session-data-redis</artifactId>\n  <version>1.2.1.RELEASE</version>\n</dependency>\n<dependency>\n  <groupId>redis.clients</groupId>\n  <artifactId>jedis</artifactId>\n  <version>2.8.1</version>\n</dependency>`, `28084922894579510000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="xml"\n              >\n                <span class="gatsby-code-button-language">xml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="xml"><pre style="counter-reset: linenumber NaN" class="language-xml line-numbers"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>\n  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.session<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>\n  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-session-data-redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>\n  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.2.1.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>\n  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>redis.clients<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>\n  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>jedis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>\n  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>2.8.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在 Spring 配置文件中配置：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="78555873692044020000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<bean id=&quot;redisHttpSessionConfiguration&quot;\n     class=&quot;org.springframework.session.data.redis.config.annotation.web.http.RedisHttpSessionConfiguration&quot;>\n    <property name=&quot;maxInactiveIntervalInSeconds&quot; value=&quot;600&quot;/>\n</bean>\n\n<bean id=&quot;jedisPoolConfig&quot; class=&quot;redis.clients.jedis.JedisPoolConfig&quot;>\n    <property name=&quot;maxTotal&quot; value=&quot;100&quot; />\n    <property name=&quot;maxIdle&quot; value=&quot;10&quot; />\n</bean>\n\n<bean id=&quot;jedisConnectionFactory&quot;\n      class=&quot;org.springframework.data.redis.connection.jedis.JedisConnectionFactory&quot; destroy-method=&quot;destroy&quot;>\n    <property name=&quot;hostName&quot; value=&quot;\\${redis_hostname}&quot;/>\n    <property name=&quot;port&quot; value=&quot;\\${redis_port}&quot;/>\n    <property name=&quot;password&quot; value=&quot;\\${redis_pwd}&quot; />\n    <property name=&quot;timeout&quot; value=&quot;3000&quot;/>\n    <property name=&quot;usePool&quot; value=&quot;true&quot;/>\n    <property name=&quot;poolConfig&quot; ref=&quot;jedisPoolConfig&quot;/>\n</bean>`, `78555873692044020000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="xml"\n              >\n                <span class="gatsby-code-button-language">xml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="xml"><pre style="counter-reset: linenumber NaN" class="language-xml line-numbers"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>redisHttpSessionConfiguration<span class="token punctuation">"</span></span>\n     <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>org.springframework.session.data.redis.config.annotation.web.http.RedisHttpSessionConfiguration<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>maxInactiveIntervalInSeconds<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>600<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">></span></span>\n\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>jedisPoolConfig<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>redis.clients.jedis.JedisPoolConfig<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>maxTotal<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>100<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>maxIdle<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>10<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">></span></span>\n\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>jedisConnectionFactory<span class="token punctuation">"</span></span>\n      <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>org.springframework.data.redis.connection.jedis.JedisConnectionFactory<span class="token punctuation">"</span></span> <span class="token attr-name">destroy-method</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>destroy<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>hostName<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>${redis_hostname}<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>port<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>${redis_port}<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>${redis_pwd}<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>timeout<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>3000<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>usePool<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>poolConfig<span class="token punctuation">"</span></span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>jedisPoolConfig<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在 web.xml 中配置：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="95440607556141370000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<filter>\n    <filter-name>springSessionRepositoryFilter</filter-name>\n    <filter-class>org.springframework.web.filter.DelegatingFilterProxy</filter-class>\n</filter>\n<filter-mapping>\n    <filter-name>springSessionRepositoryFilter</filter-name>\n    <url-pattern>/*</url-pattern>\n</filter-mapping>`, `95440607556141370000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="xml"\n              >\n                <span class="gatsby-code-button-language">xml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="xml"><pre style="counter-reset: linenumber NaN" class="language-xml line-numbers"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter</span><span class="token punctuation">></span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter-name</span><span class="token punctuation">></span></span>springSessionRepositoryFilter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter-name</span><span class="token punctuation">></span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter-class</span><span class="token punctuation">></span></span>org.springframework.web.filter.DelegatingFilterProxy<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter-class</span><span class="token punctuation">></span></span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter</span><span class="token punctuation">></span></span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter-mapping</span><span class="token punctuation">></span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter-name</span><span class="token punctuation">></span></span>springSessionRepositoryFilter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter-name</span><span class="token punctuation">></span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url-pattern</span><span class="token punctuation">></span></span>/*<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url-pattern</span><span class="token punctuation">></span></span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter-mapping</span><span class="token punctuation">></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>示例代码：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="48588332180648150000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`@RestController\n@RequestMapping(&quot;/test&quot;)\npublic class TestController {\n\n    @RequestMapping(&quot;/putIntoSession&quot;)\n    public String putIntoSession(HttpServletRequest request, String username) {\n        request.getSession().setAttribute(&quot;name&quot;,  &quot;leo&quot;);\n        return &quot;ok&quot;;\n    }\n\n    @RequestMapping(&quot;/getFromSession&quot;)\n    public String getFromSession(HttpServletRequest request, Model model){\n        String name = request.getSession().getAttribute(&quot;name&quot;);\n        return name;\n    }\n}`, `48588332180648150000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token annotation punctuation">@RestController</span>\n<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/test"</span><span class="token punctuation">)</span>\n<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestController</span> <span class="token punctuation">{</span>\n\n    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/putIntoSession"</span><span class="token punctuation">)</span>\n    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">putIntoSession</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">String</span> username<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        request<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span>  <span class="token string">"leo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">return</span> <span class="token string">"ok"</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/getFromSession"</span><span class="token punctuation">)</span>\n    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getFromSession</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">Model</span> model<span class="token punctuation">)</span><span class="token punctuation">{</span>\n        <span class="token class-name">String</span> name <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">return</span> name<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>上面的代码就是 ok 的，给 Spring Session 配置基于 Redis 来存储 Session 数据，然后配置了一个 Spring Session 的过滤器，这样的话，Session 相关操作都会交给 Spring Session 来管了。接着在代码中，就用原生的 Session 操作，就是直接基于 Spring Session 从 Redis 中获取数据了。</p>\n<p>实现分布式的会话有很多种方式，我说的只不过是比较常见的几种方式，Tomcat + Redis 早期比较常用，但是会重耦合到 Tomcat 中；近些年，通过 Spring Session 来实现。</p>\n<h1 id="高可用架构"><a href="#%E9%AB%98%E5%8F%AF%E7%94%A8%E6%9E%B6%E6%9E%84" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>高可用架构</h1>\n<h2 id="基于-hystrix-实现高可用"><a href="#%E5%9F%BA%E4%BA%8E-hystrix-%E5%AE%9E%E7%8E%B0%E9%AB%98%E5%8F%AF%E7%94%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>基于 Hystrix 实现高可用</h2>\n<h3 id="hystrix-介绍"><a href="#hystrix-%E4%BB%8B%E7%BB%8D" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Hystrix 介绍</h3>\n<h4 id="hystrix-是什么？"><a href="#hystrix-%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Hystrix 是什么？</h4>\n<p>在分布式系统中，每个服务可能会调用很多其他服务，被调用的那些服务就是依赖服务，有的时候某些依赖服务出现故障也是很正常的。</p>\n<p>Hystrix 可以让我们在分布式系统中对服务间的调用进行控制，加入一些调用延迟或者依赖故障的容错机制。</p>\n<p>Hystrix 通过将依赖服务进行资源隔离，进而阻止某个依赖服务出现故障时在整个系统所有的依赖服务调用中进行蔓延；同时 Hystrix 还提供故障时的 fallback 降级机制。</p>\n<p>总而言之，Hystrix 通过这些方法帮助我们提升分布式系统的可用性和稳定性。</p>\n<h4 id="hystrix-的历史"><a href="#hystrix-%E7%9A%84%E5%8E%86%E5%8F%B2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Hystrix 的历史</h4>\n<p>Hystrix 是高可用性保障的一个框架。Netflix（可以认为是国外的优酷或者爱奇艺之类的视频网站）的 API 团队从 2011 年开始做一些提升系统可用性和稳定性的工作，Hystrix 就是从那时候开始发展出来的。</p>\n<p>在 2012 年的时候，Hystrix 就变得比较成熟和稳定了，Netflix 中，除了 API 团队以外，很多其他的团队都开始使用 Hystrix。</p>\n<p>时至今日，Netflix 中每天都有数十亿次的服务间调用，通过 Hystrix 框架在进行，而 Hystrix 也帮助 Netflix 网站提升了整体的可用性和稳定性。</p>\n<p>2018 年 11 月，Hystrix 在其 Github 主页宣布，不再开放新功能，推荐开发者使用其他仍然活跃的开源项目。维护模式的转变绝不意味着 Hystrix 不再有价值。相反，Hystrix 激发了很多伟大的想法和项目，我们高可用的这一块知识还是会针对 Hystrix 进行讲解。</p>\n<h4 id="hystrix-的设计原则"><a href="#hystrix-%E7%9A%84%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Hystrix 的设计原则</h4>\n<ul>\n<li>对依赖服务调用时出现的调用延迟和调用失败进行控制和容错保护。</li>\n<li>在复杂的分布式系统中，阻止某一个依赖服务的故障在整个系统中蔓延。比如某一个服务故障了，导致其它服务也跟着故障。</li>\n<li>提供 fail-fast（快速失败）和快速恢复的支持。</li>\n<li>提供 fallback 优雅降级的支持。</li>\n<li>支持近实时的监控、报警以及运维操作。</li>\n</ul>\n<p>举个栗子。</p>\n<p>有这样一个分布式系统，服务 A 依赖于服务 B，服务 B 依赖于服务 C / D / E。在这样一个成熟的系统内，比如说最多可能只有 100 个线程资源。正常情况下，40 个线程并发调用服务 C，各 30 个线程并发调用 D / E。</p>\n<p>调用服务 C，只需要 20ms，现在因为服务 C 故障了，比如延迟，或者挂了，此时线程会 hang 住 2s 左右。40 个线程全部被卡住，由于请求不断涌入，其它的线程也用来调用服务 C，同样也会被卡住。这样导致服务 B 的线程资源被耗尽，无法接收新的请求，甚至可能因为大量线程不断的运转，导致自己宕机。这种影响势必会蔓延至服务 A，导致服务 A 也跟着挂掉。</p>\n<div class="mermaid">graph TB\n   服务A --> 服务B\n   服务B -- X --> 服务C\n   服务B --> 服务D\n   服务B --> 服务E</div>\n<p>Hystrix 可以对其进行资源隔离，比如限制服务 B 只有 40 个线程调用服务 C。当此 40 个线程被 hang 住时，其它 60 个线程依然能正常调用工作。从而确保整个系统不会被拖垮。</p>\n<h4 id="hystrix-更加细节的设计原则"><a href="#hystrix-%E6%9B%B4%E5%8A%A0%E7%BB%86%E8%8A%82%E7%9A%84%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Hystrix 更加细节的设计原则</h4>\n<ul>\n<li>阻止任何一个依赖服务耗尽所有的资源，比如 tomcat 中的所有线程资源。</li>\n<li>避免请求排队和积压，采用限流和 fail fast 来控制故障。</li>\n<li>提供 fallback 降级机制来应对故障。</li>\n<li>使用资源隔离技术，比如 bulkhead（舱壁隔离技术）、swimlane（泳道技术）、circuit breaker（断路技术）来限制任何一个依赖服务的故障的影响。</li>\n<li>通过近实时的统计、监控、报警功能，来提高故障发现的速度。</li>\n<li>通过近实时的属性和配置热修改功能，来提高故障处理和恢复的速度。</li>\n<li>保护依赖服务调用的所有故障情况，而不仅仅只是网络故障情况。</li>\n</ul>\n<h3 id="电商网站详情页系统架构"><a href="#%E7%94%B5%E5%95%86%E7%BD%91%E7%AB%99%E8%AF%A6%E6%83%85%E9%A1%B5%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>电商网站详情页系统架构</h3>\n<h4 id="小型电商网站的商品详情页系统架构"><a href="#%E5%B0%8F%E5%9E%8B%E7%94%B5%E5%95%86%E7%BD%91%E7%AB%99%E7%9A%84%E5%95%86%E5%93%81%E8%AF%A6%E6%83%85%E9%A1%B5%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>小型电商网站的商品详情页系统架构</h4>\n<p>小型电商网站的页面展示采用页面全量静态化的思想。数据库中存放了所有的商品信息，页面静态化系统，将数据填充进静态模板中，形成静态化页面，推入 Nginx 服务器。用户浏览网站页面时，取用一个已经静态化好的 html 页面，直接返回回去，不涉及任何的业务逻辑处理。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-09-25-15-33-55-9c45b54b8bb04320fa47e632a04be648-700d4.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 540px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 66.66666666666666%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAAAsSAAALEgHS3X78AAABOElEQVQoz42S6YqDQBCEff+HM6DGgAde0XifUVdE3Q8HwhIFt38MY09XdXW10vsQYRjWdV1VVRAEjuP4vs+9aZooitq27fv+UykdwaKIatd17/c7J1zkX68XyQtwuwcA27YNw4Cr6zqR/6o8AcMdx3GapiDLsnw8Hoqi0P9YeQKmD8ht26ZpSpIEPOJR8TXwOViMl+d5lmWY53keYDL/kv0ZDwkYjoqiKMTY12CqaSv2hFpWhWfZHteycYs+qMUw0zQty0KzMGIYhu5PSMMhWBJN8Am1mqbBxeQIoT/U4zj+7MFFgg9L8z3ERbxhtdgZGMDQoQU6avw9SEpCDGuEGzIUUs0JTNd1tC3LMs8zZc/nEyRTqKrKE3ZIpJjtdrvJssyE8CGYnxnxMCKBha/ryidI8kjgwgndLzvt1Dm9rUTlAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 09 25 15 33 55" title="" data-src="/static/2023-09-25-15-33-55-9c45b54b8bb04320fa47e632a04be648-700d4.png" data-srcset="/static/2023-09-25-15-33-55-9c45b54b8bb04320fa47e632a04be648-555fa.png 200w,\n/static/2023-09-25-15-33-55-9c45b54b8bb04320fa47e632a04be648-eb4c6.png 400w,\n/static/2023-09-25-15-33-55-9c45b54b8bb04320fa47e632a04be648-700d4.png 540w" data-sizes="(max-width: 540px) 100vw, 540px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>下面是页面模板的简单 Demo 。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="24183169452290576000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<html>\n   <body>\n      商品名称：#{productName}<br />\n      商品价格：#{productPrice}<br />\n      商品描述：#{productDesc}\n   </body>\n</html>`, `24183169452290576000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="html"\n              >\n                <span class="gatsby-code-button-language">html</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="html"><pre style="counter-reset: linenumber NaN" class="language-html line-numbers"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span>\n   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>\n      商品名称：#{productName}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span> <span class="token punctuation">/></span></span>\n      商品价格：#{productPrice}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span> <span class="token punctuation">/></span></span>\n      商品描述：#{productDesc}\n   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样做，好处在于，用户每次浏览一个页面，不需要进行任何的跟数据库的交互逻辑，也不需要执行任何的代码，直接返回一个 html 页面就可以了，速度和性能非常高。</p>\n<p>对于小网站，页面很少，很实用，非常简单，Java 中可以使用 velocity、freemarker、thymeleaf 等等，然后做个 cms 页面内容管理系统，模板变更的时候，点击按钮或者系统自动化重新进行全量渲染。</p>\n<p>坏处在于，仅仅适用于一些小型的网站，比如页面的规模在几十到几万不等。对于一些大型的电商网站，亿级数量的页面，你说你每次页面模板修改了，都需要将这么多页面全量静态化，靠谱吗？每次渲染花个好几天时间，那你整个网站就废掉了。</p>\n<h4 id="大型电商网站的商品详情页系统架构"><a href="#%E5%A4%A7%E5%9E%8B%E7%94%B5%E5%95%86%E7%BD%91%E7%AB%99%E7%9A%84%E5%95%86%E5%93%81%E8%AF%A6%E6%83%85%E9%A1%B5%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>大型电商网站的商品详情页系统架构</h4>\n<p>大型电商网站商品详情页的系统设计中，当商品数据发生变更时，会将变更消息压入 MQ 消息队列中。缓存服务从消息队列中消费这条消息时，感知到有数据发生变更，便通过调用数据服务接口，获取变更后的数据，然后将整合好的数据推送至 redis 中。Nginx 本地缓存的数据是有一定的时间期限的，比如说 10 分钟，当数据过期之后，它就会从 redis 获取到最新的缓存数据，并且缓存到自己本地。</p>\n<p>用户浏览网页时，动态将 Nginx 本地数据渲染到本地 html 模板并返回给用户。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-09-25-15-34-56-72f41c6acfbd0b1d5bd475c62fff3756-efa6e.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 603px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 94.02985074626866%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAIAAAAf7rriAAAACXBIWXMAAAsSAAALEgHS3X78AAABp0lEQVQ4y4XU2W7iYAwFYN7/uZC4A4GQEEJiK/s27Az7fI3bDEpT4YvEf+LjYx87KTwTW61Wu93uI7HD4cDf7/eDwaBcLo9Go/v9/ng8nj+sELfz+Xy5XESIu16vfOk6nU6xWJSOv1gsbrebtzngsM1ms91uRczn82aziXM2m02n08lk0u12FSKFsLSKL7AiIZfL5Xq9FoqzVCo1Gg1x4/G41+t1EuPngF8Nszrr9Tra0+nkKh1+hUj9Bhyd/0lMNAmev1gOWLQK2+12q9VS+fF4fGV7A071Z2ZGpH1iGal/LTsmr08K0ZlgUsiVBT8Sy2XGRi1zfsMML/rvi9kTw8Pc7/cp55jTMz2E6o2wBnN8MWM3HmVzftb8Ca5Wq5VKpVarQWZU5Stbw7G5OWC0stpK34NzkJuWTXaNrdZwLE9YdkmkAJOFPMPhULepWvZc5frafpsuAl+IW/CfEssMDD6jc3w8/8H0xACJUIdq9lzZeonQUBuBVyE++wJrzEr46GL742cApgUPRac18w0Pk7BCWkn8SYD5kI5oHT0Ux3elJTlCCDH/AKSJRp790jHbAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 09 25 15 34 56" title="" data-src="/static/2023-09-25-15-34-56-72f41c6acfbd0b1d5bd475c62fff3756-efa6e.png" data-srcset="/static/2023-09-25-15-34-56-72f41c6acfbd0b1d5bd475c62fff3756-b4d75.png 200w,\n/static/2023-09-25-15-34-56-72f41c6acfbd0b1d5bd475c62fff3756-f2144.png 400w,\n/static/2023-09-25-15-34-56-72f41c6acfbd0b1d5bd475c62fff3756-efa6e.png 603w" data-sizes="(max-width: 603px) 100vw, 603px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>虽然没有直接返回 html 页面那么快，但是因为数据在本地缓存，所以也很快，其实耗费的也就是动态渲染一个 html 页面的性能。如果 html 模板发生了变更，不需要将所有的页面重新静态化，也不需要发送请求，没有网络请求的开销，直接将数据渲染进最新的 html 页面模板后响应即可。</p>\n<p>在这种架构下，我们需要保证系统的高可用性。</p>\n<p>如果系统访问量很高，Nginx 本地缓存过期失效了，redis 中的缓存也被 LRU 算法给清理掉了，那么会有较高的访问量，从缓存服务调用商品服务。但如果此时商品服务的接口发生故障，调用出现了延时，缓存服务全部的线程都被这个调用商品服务接口给耗尽了，每个线程去调用商品服务接口的时候，都会卡住很长时间，后面大量的请求过来都会卡在那儿，此时缓存服务没有足够的线程去调用其它一些服务的接口，从而导致整个大量的商品详情页无法正常显示。</p>\n<p>这其实就是一个商品接口服务故障导致缓存服务资源耗尽的现象。</p>\n<h3 id="基于-hystrix-线程池技术实现资源隔离"><a href="#%E5%9F%BA%E4%BA%8E-hystrix-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E6%8A%80%E6%9C%AF%E5%AE%9E%E7%8E%B0%E8%B5%84%E6%BA%90%E9%9A%94%E7%A6%BB" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>基于 Hystrix 线程池技术实现资源隔离</h3>\n<p>上一讲提到，如果从 Nginx 开始，缓存都失效了，Nginx 会直接通过缓存服务调用商品服务获取最新商品数据（我们基于电商项目做个讨论），有可能出现调用延时而把缓存服务资源耗尽的情况。这里，我们就来说说，怎么通过 Hystrix 线程池技术实现资源隔离。</p>\n<p>资源隔离，就是说，你如果要把对某一个依赖服务的所有调用请求，全部隔离在同一份资源池内，不会去用其它资源了，这就叫资源隔离。哪怕对这个依赖服务，比如说商品服务，现在同时发起的调用量已经到了 1000，但是分配给商品服务线程池内就 10 个线程，最多就只会用这 10 个线程去执行。不会因为对商品服务调用的延迟，将 Tomcat 内部所有的线程资源全部耗尽。</p>\n<p>Hystrix 进行资源隔离，其实是提供了一个抽象，叫做 Command。这也是 Hystrix 最最基本的资源隔离技术。</p>\n<h4 id="利用-hystrixcommand-获取单条数据"><a href="#%E5%88%A9%E7%94%A8-hystrixcommand-%E8%8E%B7%E5%8F%96%E5%8D%95%E6%9D%A1%E6%95%B0%E6%8D%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>利用 HystrixCommand 获取单条数据</h4>\n<p>我们通过将调用商品服务的操作封装在 HystrixCommand 中，限定一个 key，比如下面的 GetProductInfoCommandGroup，在这里我们可以简单认为这是一个线程池，每次调用商品服务，就只会用该线程池中的资源，不会再去用其它线程资源了。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="93501547960111480000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public class GetProductInfoCommand extends HystrixCommand<ProductInfo> {\n\n    private Long productId;\n\n    public GetProductInfoCommand(Long productId) {\n        super(HystrixCommandGroupKey.Factory.asKey(&quot;GetProductInfoCommandGroup&quot;));\n        this.productId = productId;\n    }\n\n    @Override\n    protected ProductInfo run() {\n        String url = &quot;http://localhost:8081/getProductInfo?productId=&quot; + productId;\n        // 调用商品服务接口\n        String response = HttpClientUtils.sendGetRequest(url);\n        return JSONObject.parseObject(response, ProductInfo.class);\n    }\n}`, `93501547960111480000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GetProductInfoCommand</span> <span class="token keyword">extends</span> <span class="token class-name">HystrixCommand</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ProductInfo</span><span class="token punctuation">></span></span> <span class="token punctuation">{</span>\n\n    <span class="token keyword">private</span> <span class="token class-name">Long</span> productId<span class="token punctuation">;</span>\n\n    <span class="token keyword">public</span> <span class="token class-name">GetProductInfoCommand</span><span class="token punctuation">(</span><span class="token class-name">Long</span> productId<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token class-name">HystrixCommandGroupKey</span><span class="token punctuation">.</span><span class="token class-name">Factory</span><span class="token punctuation">.</span><span class="token function">asKey</span><span class="token punctuation">(</span><span class="token string">"GetProductInfoCommandGroup"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">this</span><span class="token punctuation">.</span>productId <span class="token operator">=</span> productId<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token annotation punctuation">@Override</span>\n    <span class="token keyword">protected</span> <span class="token class-name">ProductInfo</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token class-name">String</span> url <span class="token operator">=</span> <span class="token string">"http://localhost:8081/getProductInfo?productId="</span> <span class="token operator">+</span> productId<span class="token punctuation">;</span>\n        <span class="token comment">// 调用商品服务接口</span>\n        <span class="token class-name">String</span> response <span class="token operator">=</span> <span class="token class-name">HttpClientUtils</span><span class="token punctuation">.</span><span class="token function">sendGetRequest</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">return</span> <span class="token class-name">JSONObject</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> <span class="token class-name">ProductInfo</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们在缓存服务接口中，根据 productId 创建 Command 并执行，获取到商品数据。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="11928054125872034000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`@RequestMapping(&quot;/getProductInfo&quot;)\n@ResponseBody\npublic String getProductInfo(Long productId) {\n    HystrixCommand<ProductInfo> getProductInfoCommand = new GetProductInfoCommand(productId);\n\n    // 通过 command 执行，获取最新商品数据\n    ProductInfo productInfo = getProductInfoCommand.execute();\n    System.out.println(productInfo);\n    return &quot;success&quot;;\n}`, `11928054125872034000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/getProductInfo"</span><span class="token punctuation">)</span>\n<span class="token annotation punctuation">@ResponseBody</span>\n<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getProductInfo</span><span class="token punctuation">(</span><span class="token class-name">Long</span> productId<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token class-name">HystrixCommand</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ProductInfo</span><span class="token punctuation">></span></span> getProductInfoCommand <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GetProductInfoCommand</span><span class="token punctuation">(</span>productId<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// 通过 command 执行，获取最新商品数据</span>\n    <span class="token class-name">ProductInfo</span> productInfo <span class="token operator">=</span> getProductInfoCommand<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>productInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">return</span> <span class="token string">"success"</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>上面执行的是 execute() 方法，其实是同步的。也可以对 command 调用 queue() 方法，它仅仅是将 command 放入线程池的一个等待队列，就立即返回，拿到一个 Future 对象，后面可以继续做其它一些事情，然后过一段时间对 Future 调用 get() 方法获取数据。这是异步的。</p>\n<h4 id="利用-hystrixobservablecommand-批量获取数据"><a href="#%E5%88%A9%E7%94%A8-hystrixobservablecommand-%E6%89%B9%E9%87%8F%E8%8E%B7%E5%8F%96%E6%95%B0%E6%8D%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>利用 HystrixObservableCommand 批量获取数据</h4>\n<p>只要是获取商品数据，全部都绑定到同一个线程池里面去，我们通过 HystrixObservableCommand 的一个线程去执行，而在这个线程里面，批量把多个 productId 的 productInfo 拉回来。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="19431638731650970000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public class GetProductInfosCommand extends HystrixObservableCommand<ProductInfo> {\n\n    private String[] productIds;\n\n    public GetProductInfosCommand(String[] productIds) {\n        // 还是绑定在同一个线程池\n        super(HystrixCommandGroupKey.Factory.asKey(&quot;GetProductInfoGroup&quot;));\n        this.productIds = productIds;\n    }\n\n    @Override\n    protected Observable<ProductInfo> construct() {\n        return Observable.unsafeCreate((Observable.OnSubscribe<ProductInfo>) subscriber -> {\n\n            for (String productId : productIds) {\n                // 批量获取商品数据\n                String url = &quot;http://localhost:8081/getProductInfo?productId=&quot; + productId;\n                String response = HttpClientUtils.sendGetRequest(url);\n                ProductInfo productInfo = JSONObject.parseObject(response, ProductInfo.class);\n                subscriber.onNext(productInfo);\n            }\n            subscriber.onCompleted();\n\n        }).subscribeOn(Schedulers.io());\n    }\n}`, `19431638731650970000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GetProductInfosCommand</span> <span class="token keyword">extends</span> <span class="token class-name">HystrixObservableCommand</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ProductInfo</span><span class="token punctuation">></span></span> <span class="token punctuation">{</span>\n\n    <span class="token keyword">private</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> productIds<span class="token punctuation">;</span>\n\n    <span class="token keyword">public</span> <span class="token class-name">GetProductInfosCommand</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> productIds<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token comment">// 还是绑定在同一个线程池</span>\n        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token class-name">HystrixCommandGroupKey</span><span class="token punctuation">.</span><span class="token class-name">Factory</span><span class="token punctuation">.</span><span class="token function">asKey</span><span class="token punctuation">(</span><span class="token string">"GetProductInfoGroup"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">this</span><span class="token punctuation">.</span>productIds <span class="token operator">=</span> productIds<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token annotation punctuation">@Override</span>\n    <span class="token keyword">protected</span> <span class="token class-name">Observable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ProductInfo</span><span class="token punctuation">></span></span> <span class="token function">construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">return</span> <span class="token class-name">Observable</span><span class="token punctuation">.</span><span class="token function">unsafeCreate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Observable</span><span class="token punctuation">.</span><span class="token class-name">OnSubscribe</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ProductInfo</span><span class="token punctuation">></span></span><span class="token punctuation">)</span> subscriber <span class="token operator">-></span> <span class="token punctuation">{</span>\n\n            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> productId <span class="token operator">:</span> productIds<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                <span class="token comment">// 批量获取商品数据</span>\n                <span class="token class-name">String</span> url <span class="token operator">=</span> <span class="token string">"http://localhost:8081/getProductInfo?productId="</span> <span class="token operator">+</span> productId<span class="token punctuation">;</span>\n                <span class="token class-name">String</span> response <span class="token operator">=</span> <span class="token class-name">HttpClientUtils</span><span class="token punctuation">.</span><span class="token function">sendGetRequest</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>\n                <span class="token class-name">ProductInfo</span> productInfo <span class="token operator">=</span> <span class="token class-name">JSONObject</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> <span class="token class-name">ProductInfo</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                subscriber<span class="token punctuation">.</span><span class="token function">onNext</span><span class="token punctuation">(</span>productInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span>\n            subscriber<span class="token punctuation">.</span><span class="token function">onCompleted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscribeOn</span><span class="token punctuation">(</span><span class="token class-name">Schedulers</span><span class="token punctuation">.</span><span class="token function">io</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在缓存服务接口中，根据传来的 id 列表，比如是以 <code class="language-text">,</code> 分隔的 id 串，通过上面的 HystrixObservableCommand，执行 Hystrix 的一些 API 方法，获取到所有商品数据。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="74741023724431740000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public String getProductInfos(String productIds) {\n    String[] productIdArray = productIds.split(&quot;,&quot;);\n    HystrixObservableCommand<ProductInfo> getProductInfosCommand = new GetProductInfosCommand(productIdArray);\n    Observable<ProductInfo> observable = getProductInfosCommand.observe();\n\n    observable.subscribe(new Observer<ProductInfo>() {\n        @Override\n        public void onCompleted() {\n            System.out.println(&quot;获取完了所有的商品数据&quot;);\n        }\n\n        @Override\n        public void onError(Throwable e) {\n            e.printStackTrace();\n        }\n\n        /**\n         * 获取完一条数据，就回调一次这个方法\n         * @param productInfo\n         */\n        @Override\n        public void onNext(ProductInfo productInfo) {\n            System.out.println(productInfo);\n        }\n    });\n    return &quot;success&quot;;\n}`, `74741023724431740000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getProductInfos</span><span class="token punctuation">(</span><span class="token class-name">String</span> productIds<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> productIdArray <span class="token operator">=</span> productIds<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token class-name">HystrixObservableCommand</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ProductInfo</span><span class="token punctuation">></span></span> getProductInfosCommand <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GetProductInfosCommand</span><span class="token punctuation">(</span>productIdArray<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token class-name">Observable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ProductInfo</span><span class="token punctuation">></span></span> observable <span class="token operator">=</span> getProductInfosCommand<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    observable<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Observer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ProductInfo</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token annotation punctuation">@Override</span>\n        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCompleted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"获取完了所有的商品数据"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n\n        <span class="token annotation punctuation">@Override</span>\n        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onError</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n\n        <span class="token comment">/**\n         * 获取完一条数据，就回调一次这个方法\n         * @param productInfo\n         */</span>\n        <span class="token annotation punctuation">@Override</span>\n        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onNext</span><span class="token punctuation">(</span><span class="token class-name">ProductInfo</span> productInfo<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>productInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">return</span> <span class="token string">"success"</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们回过头来，看看 Hystrix 线程池技术是如何实现资源隔离的。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-09-27-09-44-13-24ac103f7f1e73b648e7a54f15738bbe-344e0.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 307px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 111.40065146579805%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAWCAIAAABPIytRAAAACXBIWXMAAAsSAAALEgHS3X78AAAB3klEQVQ4y5WUWXOCUAyF+f9/SN9d0AcdRcQVF1xQ7FgFcUf6QWprp1PuNDNecyEnOTmJavv93nGcdrs9m80Gg0G32+WcTCa2bfd6vdPpFATB4Q/TOp1Oq9UCH8cxiciyXq/x7/c7+DAMs8CkP5/Pw+GQ0NFoZD+N+mQ8Ho9ZYHgCJij8ZXA+ZNpnZZqcTqe0vVgsOKnJk+VyqagMmNfwpM52uwW82WzA+L4PcwW43+8TBwaRCKVt13VFsPF4rBYMDJ0LbajO53Nog0RFtWCXyyV4Giy+fMoqBBPwbrej4fefllHzG0x7nHB2U4P5arWyLAtHpoiWMkvx5UrqBIyH2oh0vV5hcbvd8N9SI0Jy4Qs79o8rJykSwXK5XLlcBlCv1yuVSj6f5yHNs6okJQ5ks9kkrFgsQs3zPKYDNQ3qMufH4wGeK/xZcvCGYRQKBZQnFILVarXRaPBWxsGZgCEAmAhSshi1Wg0YJwV5RSJY0DD9c/VTo15CGzAv6Ac+7BZkJAs+Qa/ayvxer5p4IiC0S6USWx1FEU/Uc+YDDAD7RCe6rpumiUOTsuRZGya06Zlpx6mJcjCnEcU/iXyxyQD4VTAe1GKeosI/wFSTHzbCgmcZ1GBoU5M4mEdPo6wS/AExkscjVCm1sQAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 09 27 09 44 13" title="" data-src="/static/2023-09-27-09-44-13-24ac103f7f1e73b648e7a54f15738bbe-344e0.png" data-srcset="/static/2023-09-27-09-44-13-24ac103f7f1e73b648e7a54f15738bbe-73b08.png 200w,\n/static/2023-09-27-09-44-13-24ac103f7f1e73b648e7a54f15738bbe-344e0.png 307w" data-sizes="(max-width: 307px) 100vw, 307px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>从 Nginx 开始，缓存都失效了，那么 Nginx 通过缓存服务去调用商品服务。缓存服务默认的线程大小是 10 个，最多就只有 10 个线程去调用商品服务的接口。即使商品服务接口故障了，最多就只有 10 个线程会 hang 死在调用商品服务接口的路上，缓存服务的 Tomcat 内其它的线程还是可以用来调用其它的服务，干其它的事情。</p>\n<h3 id="基于-hystrix-信号量机制实现资源隔离"><a href="#%E5%9F%BA%E4%BA%8E-hystrix-%E4%BF%A1%E5%8F%B7%E9%87%8F%E6%9C%BA%E5%88%B6%E5%AE%9E%E7%8E%B0%E8%B5%84%E6%BA%90%E9%9A%94%E7%A6%BB" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>基于 Hystrix 信号量机制实现资源隔离</h3>\n<p>Hystrix 里面核心的一项功能，其实就是所谓的资源隔离，要解决的最最核心的问题，就是将多个依赖服务的调用分别隔离到各自的资源池内。避免说对某一个依赖服务的调用，因为依赖服务的接口调用的延迟或者失败，导致服务所有的线程资源全部耗费在这个服务的接口调用上。一旦说某个服务的线程资源全部耗尽的话，就可能导致服务崩溃，甚至说这种故障会不断蔓延。</p>\n<p>Hystrix 实现资源隔离，主要有两种技术：</p>\n<ul>\n<li>线程池</li>\n<li>信号量</li>\n</ul>\n<p>默认情况下，Hystrix 使用线程池模式。</p>\n<p>前面已经说过线程池技术了，这一小节就来说说信号量机制实现资源隔离，以及这两种技术的区别与具体应用场景。</p>\n<h4 id="信号量机制"><a href="#%E4%BF%A1%E5%8F%B7%E9%87%8F%E6%9C%BA%E5%88%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>信号量机制</h4>\n<p>信号量的资源隔离只是起到一个开关的作用，比如，服务 A 的信号量大小为 10，那么就是说它同时只允许有 10 个 tomcat 线程来访问服务 A，其它的请求都会被拒绝，从而达到资源隔离和限流保护的作用。</p>\n<h4 id="线程池与信号量区别"><a href="#%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%B8%8E%E4%BF%A1%E5%8F%B7%E9%87%8F%E5%8C%BA%E5%88%AB" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>线程池与信号量区别</h4>\n<p>线程池隔离技术，并不是说去控制类似 tomcat 这种 web 容器的线程。更加严格的意义上来说，Hystrix 的线程池隔离技术，控制的是 tomcat 线程的执行。Hystrix 线程池满后，会确保说，tomcat 的线程不会因为依赖服务的接口调用延迟或故障而被 hang 住，tomcat 其它的线程不会卡死，可以快速返回，然后支撑其它的事情。</p>\n<p>线程池隔离技术，是用 Hystrix 自己的线程去执行调用；而信号量隔离技术，是直接让 tomcat 线程去调用依赖服务。信号量隔离，只是一道关卡，信号量有多少，就允许多少个 tomcat 线程通过它，然后去执行。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-09-27-09-47-04-f8d7a1db585c2d3f7c694a2a3625a9ec-344e0.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 307px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 61.56351791530944%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAAsSAAALEgHS3X78AAABdklEQVQoz2WSWY+CUAyF+f+/xzdeMEbcQjDgvqEQIS4sZhRxZb6xrmMfbnrbc3ra26v0ej3P82af5rouwclk0m63W61Wp9NxbyYpyQ6HQ2U6neZ5fr1e8y87nU7L5TIIgiiK3uMCJqVQDC+OY3TwB4MBOs1mU9f1brf7Tnja5XL5IB+PxyzLdrtdGIaHw+HnZkQEKlJEttstGJS4rlarO1lK4qAPaL1eP+PP0/d95jRNs9/v35W5bzabJEkYLE1T27ZJj0ajRqNBO4jQy/l8Bu04jqqqhUJB07Q7uVKpoEOCB4RjWRaj2jczDIP4YrGgQ8TpBQL6cv61XavVmGo8HrMVyDCJIItfrVYJ0hfVEZ/P5wxVr9fBwKSoUi6XGRIofE52iIMgzw4Ih8enc2mb7lgtVRCnosInYWDKwKQZcIBw+BvIgibC8LIwnprq4r9W9f1JSqUS7/cvxQjFYvFFZgx+Uvqw/X5PeRxOfIlkD5Ml40Dh5/0CHLuUW0S2gzQAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 09 27 09 47 04" title="" data-src="/static/2023-09-27-09-47-04-f8d7a1db585c2d3f7c694a2a3625a9ec-344e0.png" data-srcset="/static/2023-09-27-09-47-04-f8d7a1db585c2d3f7c694a2a3625a9ec-73b08.png 200w,\n/static/2023-09-27-09-47-04-f8d7a1db585c2d3f7c694a2a3625a9ec-344e0.png 307w" data-sizes="(max-width: 307px) 100vw, 307px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>适用场景：</p>\n<ul>\n<li>线程池技术，适合绝大多数场景，比如说我们对依赖服务的网络请求的调用和访问、需要对调用的 timeout 进行控制（捕捉 timeout 超时异常）。</li>\n<li>信号量技术，适合说你的访问不是对外部依赖的访问，而是对内部的一些比较复杂的业务逻辑的访问，并且系统内部的代码，其实不涉及任何的网络请求，那么只要做信号量的普通限流就可以了，因为不需要去捕获 timeout 类似的问题。</li>\n</ul>\n<h4 id="信号量简单-demo"><a href="#%E4%BF%A1%E5%8F%B7%E9%87%8F%E7%AE%80%E5%8D%95-demo" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>信号量简单 Demo</h4>\n<p>业务背景里，比较适合信号量的是什么场景呢？</p>\n<p>比如说，我们一般来说，缓存服务，可能会将一些量特别少、访问又特别频繁的数据，放在自己的纯内存中。</p>\n<p>举个栗子。一般我们在获取到商品数据之后，都要去获取商品是属于哪个地理位置、省、市、卖家等，可能在自己的纯内存中，比如就一个 Map 去获取。对于这种直接访问本地内存的逻辑，比较适合用信号量做一下简单的隔离。</p>\n<p>优点在于，不用自己管理线程池啦，不用 care timeout 超时啦，也不需要进行线程的上下文切换啦。信号量做隔离的话，性能相对来说会高一些。</p>\n<p>假如这是本地缓存，我们可以通过 cityId，拿到 cityName。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="9036656221755601000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public class LocationCache {\n    private static Map<Long, String> cityMap = new HashMap<>();\n\n    static {\n        cityMap.put(1L, &quot;北京&quot;);\n    }\n\n    /**\n     * 通过 cityId 获取 cityName\n     *\n     * @param cityId 城市 id\n     * @return 城市名\n     */\n    public static String getCityName(Long cityId) {\n        return cityMap.get(cityId);\n    }\n}`, `9036656221755601000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LocationCache</span> <span class="token punctuation">{</span>\n    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> cityMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">static</span> <span class="token punctuation">{</span>\n        cityMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">,</span> <span class="token string">"北京"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token comment">/**\n     * 通过 cityId 获取 cityName\n     *\n     * @param cityId 城市 id\n     * @return 城市名\n     */</span>\n    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getCityName</span><span class="token punctuation">(</span><span class="token class-name">Long</span> cityId<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">return</span> cityMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>cityId<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>写一个 GetCityNameCommand，策略设置为信号量。run() 方法中获取本地缓存。我们目的就是对获取本地缓存的代码进行资源隔离。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="5605187791867206000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public class GetCityNameCommand extends HystrixCommand<String> {\n\n    private Long cityId;\n\n    public GetCityNameCommand(Long cityId) {\n        // 设置信号量隔离策略\n        super(Setter.withGroupKey(HystrixCommandGroupKey.Factory.asKey(&quot;GetCityNameGroup&quot;))\n                .andCommandPropertiesDefaults(HystrixCommandProperties.Setter()\n                        .withExecutionIsolationStrategy(HystrixCommandProperties.ExecutionIsolationStrategy.SEMAPHORE)));\n\n        this.cityId = cityId;\n    }\n\n    @Override\n    protected String run() {\n        // 需要进行信号量隔离的代码\n        return LocationCache.getCityName(cityId);\n    }\n}`, `5605187791867206000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GetCityNameCommand</span> <span class="token keyword">extends</span> <span class="token class-name">HystrixCommand</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> <span class="token punctuation">{</span>\n\n    <span class="token keyword">private</span> <span class="token class-name">Long</span> cityId<span class="token punctuation">;</span>\n\n    <span class="token keyword">public</span> <span class="token class-name">GetCityNameCommand</span><span class="token punctuation">(</span><span class="token class-name">Long</span> cityId<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token comment">// 设置信号量隔离策略</span>\n        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token class-name">Setter</span><span class="token punctuation">.</span><span class="token function">withGroupKey</span><span class="token punctuation">(</span><span class="token class-name">HystrixCommandGroupKey</span><span class="token punctuation">.</span><span class="token class-name">Factory</span><span class="token punctuation">.</span><span class="token function">asKey</span><span class="token punctuation">(</span><span class="token string">"GetCityNameGroup"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n                <span class="token punctuation">.</span><span class="token function">andCommandPropertiesDefaults</span><span class="token punctuation">(</span><span class="token class-name">HystrixCommandProperties</span><span class="token punctuation">.</span><span class="token class-name">Setter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n                        <span class="token punctuation">.</span><span class="token function">withExecutionIsolationStrategy</span><span class="token punctuation">(</span><span class="token class-name">HystrixCommandProperties</span><span class="token punctuation">.</span><span class="token class-name">ExecutionIsolationStrategy</span><span class="token punctuation">.</span>SEMAPHORE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        <span class="token keyword">this</span><span class="token punctuation">.</span>cityId <span class="token operator">=</span> cityId<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token annotation punctuation">@Override</span>\n    <span class="token keyword">protected</span> <span class="token class-name">String</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token comment">// 需要进行信号量隔离的代码</span>\n        <span class="token keyword">return</span> <span class="token class-name">LocationCache</span><span class="token punctuation">.</span><span class="token function">getCityName</span><span class="token punctuation">(</span>cityId<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在接口层，通过创建 GetCityNameCommand，传入 cityId，执行 execute() 方法，那么获取本地 cityName 缓存的代码将会进行信号量的资源隔离。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="56701880940951120000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`@RequestMapping(&quot;/getProductInfo&quot;)\n@ResponseBody\npublic String getProductInfo(Long productId) {\n    HystrixCommand<ProductInfo> getProductInfoCommand = new GetProductInfoCommand(productId);\n\n    // 通过 command 执行，获取最新商品数据\n    ProductInfo productInfo = getProductInfoCommand.execute();\n\n    Long cityId = productInfo.getCityId();\n\n    GetCityNameCommand getCityNameCommand = new GetCityNameCommand(cityId);\n    // 获取本地内存（cityName）的代码会被信号量进行资源隔离\n    String cityName = getCityNameCommand.execute();\n\n    productInfo.setCityName(cityName);\n\n    System.out.println(productInfo);\n    return &quot;success&quot;;\n}`, `56701880940951120000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/getProductInfo"</span><span class="token punctuation">)</span>\n<span class="token annotation punctuation">@ResponseBody</span>\n<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getProductInfo</span><span class="token punctuation">(</span><span class="token class-name">Long</span> productId<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token class-name">HystrixCommand</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ProductInfo</span><span class="token punctuation">></span></span> getProductInfoCommand <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GetProductInfoCommand</span><span class="token punctuation">(</span>productId<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// 通过 command 执行，获取最新商品数据</span>\n    <span class="token class-name">ProductInfo</span> productInfo <span class="token operator">=</span> getProductInfoCommand<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token class-name">Long</span> cityId <span class="token operator">=</span> productInfo<span class="token punctuation">.</span><span class="token function">getCityId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token class-name">GetCityNameCommand</span> getCityNameCommand <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GetCityNameCommand</span><span class="token punctuation">(</span>cityId<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// 获取本地内存（cityName）的代码会被信号量进行资源隔离</span>\n    <span class="token class-name">String</span> cityName <span class="token operator">=</span> getCityNameCommand<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    productInfo<span class="token punctuation">.</span><span class="token function">setCityName</span><span class="token punctuation">(</span>cityName<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>productInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">return</span> <span class="token string">"success"</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="hystrix-隔离策略细粒度控制"><a href="#hystrix-%E9%9A%94%E7%A6%BB%E7%AD%96%E7%95%A5%E7%BB%86%E7%B2%92%E5%BA%A6%E6%8E%A7%E5%88%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Hystrix 隔离策略细粒度控制</h3>\n<p>Hystrix 实现资源隔离，有两种策略：</p>\n<ul>\n<li>线程池隔离</li>\n<li>信号量隔离</li>\n</ul>\n<p>对资源隔离这一块东西，其实可以做一定细粒度的一些控制。</p>\n<h4 id="executionisolationstrategy"><a href="#executionisolationstrategy" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>execution.isolation.strategy</h4>\n<p>指定了 HystrixCommand.run() 的资源隔离策略：THREAD or SEMAPHORE，一种基于线程池，一种基于信号量。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="37967972261229880000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// to use thread isolation\nHystrixCommandProperties.Setter().withExecutionIsolationStrategy(ExecutionIsolationStrategy.THREAD)\n\n// to use semaphore isolation\nHystrixCommandProperties.Setter().withExecutionIsolationStrategy(ExecutionIsolationStrategy.SEMAPHORE)`, `37967972261229880000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token comment">// to use thread isolation</span>\n<span class="token class-name">HystrixCommandProperties</span><span class="token punctuation">.</span><span class="token class-name">Setter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withExecutionIsolationStrategy</span><span class="token punctuation">(</span><span class="token class-name">ExecutionIsolationStrategy</span><span class="token punctuation">.</span>THREAD<span class="token punctuation">)</span>\n\n<span class="token comment">// to use semaphore isolation</span>\n<span class="token class-name">HystrixCommandProperties</span><span class="token punctuation">.</span><span class="token class-name">Setter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withExecutionIsolationStrategy</span><span class="token punctuation">(</span><span class="token class-name">ExecutionIsolationStrategy</span><span class="token punctuation">.</span>SEMAPHORE<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>线程池机制，每个 command 运行在一个线程中，限流是通过线程池的大小来控制的；信号量机制，command 是运行在调用线程中（也就是 Tomcat 的线程池），通过信号量的容量来进行限流。</p>\n<p>如何在线程池和信号量之间做选择？</p>\n<p>默认的策略就是线程池。</p>\n<p>线程池其实最大的好处就是对于网络访问请求，如果有超时的话，可以避免调用线程阻塞住。</p>\n<p>而使用信号量的场景，通常是针对超大并发量的场景下，每个服务实例每秒都几百的 QPS，那么此时你用线程池的话，线程一般不会太多，可能撑不住那么高的并发，如果要撑住，可能要耗费大量的线程资源，那么就是用信号量，来进行限流保护。一般用信号量常见于那种基于纯内存的一些业务逻辑服务，而不涉及到任何网络访问请求。</p>\n<h4 id="command-key--command-group"><a href="#command-key--command-group" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>command key &#x26; command group</h4>\n<p>我们使用线程池隔离，要怎么对依赖服务、依赖服务接口、线程池三者做划分呢？</p>\n<p>每一个 command，都可以设置一个自己的名称 command key，同时可以设置一个自己的组 command group。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="88955571307469110000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`private static final Setter cachedSetter = Setter.withGroupKey(HystrixCommandGroupKey.Factory.asKey(&quot;ExampleGroup&quot;))\n                                                 .andCommandKey(HystrixCommandKey.Factory.asKey(&quot;HelloWorld&quot;));\n\npublic CommandHelloWorld(String name) {\n    super(cachedSetter);\n    this.name = name;\n}`, `88955571307469110000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Setter</span> cachedSetter <span class="token operator">=</span> <span class="token class-name">Setter</span><span class="token punctuation">.</span><span class="token function">withGroupKey</span><span class="token punctuation">(</span><span class="token class-name">HystrixCommandGroupKey</span><span class="token punctuation">.</span><span class="token class-name">Factory</span><span class="token punctuation">.</span><span class="token function">asKey</span><span class="token punctuation">(</span><span class="token string">"ExampleGroup"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n                                                 <span class="token punctuation">.</span><span class="token function">andCommandKey</span><span class="token punctuation">(</span><span class="token class-name">HystrixCommandKey</span><span class="token punctuation">.</span><span class="token class-name">Factory</span><span class="token punctuation">.</span><span class="token function">asKey</span><span class="token punctuation">(</span><span class="token string">"HelloWorld"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">public</span> <span class="token class-name">CommandHelloWorld</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">super</span><span class="token punctuation">(</span>cachedSetter<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>command group 是一个非常重要的概念，默认情况下，就是通过 command group 来定义一个线程池的，而且还会通过 command group 来聚合一些监控和报警信息。同一个 command group 中的请求，都会进入同一个线程池中。</p>\n<h4 id="command-thread-pool"><a href="#command-thread-pool" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>command thread pool</h4>\n<p>ThreadPoolKey 代表了一个 HystrixThreadPool，用来进行统一监控、统计、缓存。默认的 ThreadPoolKey 就是 command group 的名称。每个 command 都会跟它的 ThreadPoolKey 对应的 ThreadPool 绑定在一起。</p>\n<p>如果不想直接用 command group，也可以手动设置 ThreadPool 的名称。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="64300717108463570000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`private static final Setter cachedSetter = Setter.withGroupKey(HystrixCommandGroupKey.Factory.asKey(&quot;ExampleGroup&quot;))\n                                                 .andCommandKey(HystrixCommandKey.Factory.asKey(&quot;HelloWorld&quot;))\n                                                 .andThreadPoolKey(HystrixThreadPoolKey.Factory.asKey(&quot;HelloWorldPool&quot;));\n\npublic CommandHelloWorld(String name) {\n    super(cachedSetter);\n    this.name = name;\n}`, `64300717108463570000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Setter</span> cachedSetter <span class="token operator">=</span> <span class="token class-name">Setter</span><span class="token punctuation">.</span><span class="token function">withGroupKey</span><span class="token punctuation">(</span><span class="token class-name">HystrixCommandGroupKey</span><span class="token punctuation">.</span><span class="token class-name">Factory</span><span class="token punctuation">.</span><span class="token function">asKey</span><span class="token punctuation">(</span><span class="token string">"ExampleGroup"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n                                                 <span class="token punctuation">.</span><span class="token function">andCommandKey</span><span class="token punctuation">(</span><span class="token class-name">HystrixCommandKey</span><span class="token punctuation">.</span><span class="token class-name">Factory</span><span class="token punctuation">.</span><span class="token function">asKey</span><span class="token punctuation">(</span><span class="token string">"HelloWorld"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n                                                 <span class="token punctuation">.</span><span class="token function">andThreadPoolKey</span><span class="token punctuation">(</span><span class="token class-name">HystrixThreadPoolKey</span><span class="token punctuation">.</span><span class="token class-name">Factory</span><span class="token punctuation">.</span><span class="token function">asKey</span><span class="token punctuation">(</span><span class="token string">"HelloWorldPool"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">public</span> <span class="token class-name">CommandHelloWorld</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">super</span><span class="token punctuation">(</span>cachedSetter<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="command-key--command-group--command-thread-pool"><a href="#command-key--command-group--command-thread-pool" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>command key &#x26; command group &#x26; command thread pool</h4>\n<p>command key 代表了一类 command，一般来说，代表了下游依赖服务的某个接口。</p>\n<p>command group 代表了某一个下游依赖服务，这是很合理的，一个依赖服务可能会暴露出来多个接口，每个接口就是一个 command key。command group 在逻辑上对一堆 command key 的调用次数、成功次数、timeout 次数、失败次数等进行统计，可以看到某一个服务整体的一些访问情况。一般来说，推荐根据一个服务区划分出一个线程池，command key 默认都是属于同一个线程池的。</p>\n<p>比如说有一个服务 A，你估算出来服务 A 每秒所有接口加起来的整体 QPS 在 100 左右，你有一个服务 B 去调用服务 A。你的服务 B 部署了 10 个实例，每个实例上，用 command group 去对应下游服务 A。给一个线程池，量大概是 10 就可以了，这样服务 B 对服务 A 整体的访问 QPS 就大概是每秒 100 了。</p>\n<p>但是，如果说 command group 对应了一个服务，而这个服务暴露出来的几个接口，访问量很不一样，差异非常之大。你可能就希望在这个服务对应 command group 的内部，包含对应多个接口的 command key，做一些细粒度的资源隔离。就是说，希望对同一个服务的不同接口，使用不同的线程池。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="55453958194405065000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`command key -> command group\n\ncommand key -> 自己的 thread pool key`, `55453958194405065000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">command key -&gt; command group\n\ncommand key -&gt; 自己的 thread pool key</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>逻辑上来说，多个 command key 属于一个 command group，在做统计的时候，会放在一起统计。每个 command key 有自己的线程池，每个接口有自己的线程池，去做资源隔离和限流。</p>\n<p>说白点，就是说如果你的 command key 要用自己的线程池，可以定义自己的 thread pool key，就 ok 了。</p>\n<h4 id="coresize"><a href="#coresize" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>coreSize</h4>\n<p>设置线程池的大小，默认是 10。一般来说，用这个默认的 10 个线程大小就够了。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="23321242031670250000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`HystrixThreadPoolProperties.Setter().withCoreSize(int value);`, `23321242031670250000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token class-name">HystrixThreadPoolProperties</span><span class="token punctuation">.</span><span class="token class-name">Setter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withCoreSize</span><span class="token punctuation">(</span><span class="token keyword">int</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h4 id="queuesizerejectionthreshold"><a href="#queuesizerejectionthreshold" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>queueSizeRejectionThreshold</h4>\n<p>如果说线程池中的 10 个线程都在工作中，没有空闲的线程来做其它的事情，此时再有请求过来，会先进入队列积压。如果说队列积压满了，再有请求过来，就直接 reject，拒绝请求，执行 fallback 降级的逻辑，快速返回。</p>\n<p>控制 queue 满了之后 reject 的 threshold，因为 maxQueueSize 不允许热修改，因此提供这个参数可以热修改，控制队列的最大大小。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="71471059199321416000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`HystrixThreadPoolProperties.Setter().withQueueSizeRejectionThreshold(int value);`, `71471059199321416000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token class-name">HystrixThreadPoolProperties</span><span class="token punctuation">.</span><span class="token class-name">Setter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withQueueSizeRejectionThreshold</span><span class="token punctuation">(</span><span class="token keyword">int</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h4 id="executionisolationsemaphoremaxconcurrentrequests"><a href="#executionisolationsemaphoremaxconcurrentrequests" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>execution.isolation.semaphore.maxConcurrentRequests</h4>\n<p>设置使用 SEMAPHORE 隔离策略的时候允许访问的最大并发量，超过这个最大并发量，请求直接被 reject。</p>\n<p>这个并发量的设置，跟线程池大小的设置，应该是类似的，但是基于信号量的话，性能会好很多，而且 Hystrix 框架本身的开销会小很多。</p>\n<p>默认值是 10，尽量设置的小一些，因为一旦设置的太大，而且有延时发生，可能瞬间导致 tomcat 本身的线程资源被占满。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="91625232274758900000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`HystrixCommandProperties.Setter().withExecutionIsolationSemaphoreMaxConcurrentRequests(int value);`, `91625232274758900000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token class-name">HystrixCommandProperties</span><span class="token punctuation">.</span><span class="token class-name">Setter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withExecutionIsolationSemaphoreMaxConcurrentRequests</span><span class="token punctuation">(</span><span class="token keyword">int</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h3 id="深入-hystrix-执行时内部原理"><a href="#%E6%B7%B1%E5%85%A5-hystrix-%E6%89%A7%E8%A1%8C%E6%97%B6%E5%86%85%E9%83%A8%E5%8E%9F%E7%90%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>深入 Hystrix 执行时内部原理</h3>\n<p>前面我们了解了 Hystrix 最基本的支持高可用的技术：资源隔离 + 限流。</p>\n<ul>\n<li>创建 command；</li>\n<li>执行这个 command；</li>\n<li>配置这个 command 对应的 group 和线程池。</li>\n</ul>\n<p>这里，我们要讲一下，你开始执行这个 command，调用了这个 command 的 execute() 方法之后，Hystrix 底层的执行流程和步骤以及原理是什么。</p>\n<p>在讲解这个流程的过程中，我会带出来 Hystrix 其他的一些核心以及重要的功能。</p>\n<p>这里是整个 8 大步骤的流程图，我会对每个步骤进行细致的讲解。学习的过程中，对照着这个流程图，相信思路会比较清晰。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-09-27-09-59-32-2b9166454fa5de7e44a005835af85350-0e897.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 578px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 160.0346020761246%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAgCAIAAACdAM/hAAAACXBIWXMAAAsSAAALEgHS3X78AAADO0lEQVQ4y5VVSW/TQBTO/+KIKvVUUC9I8Ns4cECqEJSloVQUSmhD1tI6jpOQtKRZ7diKt/Fuj8c8e1q3cUObPkWj8cx8b/neklxwQzDGCKHpaMyxbKvJCZOpaRiEkMFgUKvVqtXqeDyGT9/3o0RymqZ5nucmAhuk6bOp8Kfd6bTaIj8DXXBo27bjOJZlwRq/QSgMwxgMF9Et8WJxo/8IQG6DSXzhWbV2ucQWS80i22cC7K8EhmBgNR2UP/zwtby7X90r/P7mYy/RSu61fC2u5zruw932bH3Y+DFtHo7ZgtSr4sBNr+4EJ267hjypvD3de1XPvxSZfOCaq4EvVeAIm54lwy/CdkTCFd1OzUey7ijIyVq8G0wJFyT13dfTzz9bsop8P874A8CypheZQZUd6cjAQWAYxqpuU3HiWvWpOijJLNh1F8DhlVDjqm7ohkXBaSVfUkCIbRghxEJIDu4EQahUKo1Gg2GYTqfNi/MiO620ZiqK82SaJqggCV4pHTEbj9lnG+yLzcbmeg5Cgk4EN/2EHAhSkOQiy5ebvKYbNMLYXohjOn4dltcelTfXmedPT5+sLY8ZmY6GTBz40IY3CcNhKEvSpN8PgLMgWA42TMu0Ei7IQqYheOhsPZkQWbYpZ4qmF+pnpcaF5bgQERiHiOicgY2u66qqZsEAg5gh7slM+Vjg3n9v8KIMlFIYnTagCMBAYTbP8A3vaEY0w5uKCvTlbDbr9/vD4ZBmm2qB/QIY3KBeUUVgwbIteDGfzyVJglzSIqV5yYIv8ckRsFXjhpXGXxh71CPA0NdZsJMIuAdjdSaKcDQRldc7pe39E0FS4CVUUezH1QBdcPsmWEzAcTGYeI78xVYl5CptywcgPQqxh3TZNNTAd4FCQsg9XRUHHAR+gCMPjWqfukfb3MHW5ORL6Fs8L5yfn4GkZpZYBloCHEa+KbcPzsr5XnlH7RWj0NN0JEkiz/PpVFgGvs5zlPBgp2OIJjKdFtdgIDAFpy8ueG0gqClPINRsFgx/dIqiQLnCBjhHujYSlK3d+pu9Y0kxbAtq0QQ36EqFdngMhlrlOK7b7Y5Go/rxca/bhU7qTdFQsmif4FuSDpZ/2UIm2YGLvMoAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 09 27 09 59 32" title="" data-src="/static/2023-09-27-09-59-32-2b9166454fa5de7e44a005835af85350-0e897.png" data-srcset="/static/2023-09-27-09-59-32-2b9166454fa5de7e44a005835af85350-d60f6.png 200w,\n/static/2023-09-27-09-59-32-2b9166454fa5de7e44a005835af85350-6689e.png 400w,\n/static/2023-09-27-09-59-32-2b9166454fa5de7e44a005835af85350-0e897.png 578w" data-sizes="(max-width: 578px) 100vw, 578px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h4 id="步骤一：创建-command"><a href="#%E6%AD%A5%E9%AA%A4%E4%B8%80%EF%BC%9A%E5%88%9B%E5%BB%BA-command" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>步骤一：创建 command</h4>\n<p>一个 HystrixCommand 或 HystrixObservableCommand 对象，代表了对某个依赖服务发起的一次请求或者调用。创建的时候，可以在构造函数中传入任何需要的参数。</p>\n<ul>\n<li>HystrixCommand 主要用于仅仅会返回一个结果的调用。</li>\n<li>HystrixObservableCommand 主要用于可能会返回多条结果的调用。</li>\n</ul>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="20190870643351278000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 创建 HystrixCommand\nHystrixCommand hystrixCommand = new HystrixCommand(arg1, arg2);\n\n// 创建 HystrixObservableCommand\nHystrixObservableCommand hystrixObservableCommand = new HystrixObservableCommand(arg1, arg2);`, `20190870643351278000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token comment">// 创建 HystrixCommand</span>\n<span class="token class-name">HystrixCommand</span> hystrixCommand <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HystrixCommand</span><span class="token punctuation">(</span>arg1<span class="token punctuation">,</span> arg2<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 创建 HystrixObservableCommand</span>\n<span class="token class-name">HystrixObservableCommand</span> hystrixObservableCommand <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HystrixObservableCommand</span><span class="token punctuation">(</span>arg1<span class="token punctuation">,</span> arg2<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="步骤二：调用-command-执行方法"><a href="#%E6%AD%A5%E9%AA%A4%E4%BA%8C%EF%BC%9A%E8%B0%83%E7%94%A8-command-%E6%89%A7%E8%A1%8C%E6%96%B9%E6%B3%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>步骤二：调用 command 执行方法</h4>\n<p>执行 command，就可以发起一次对依赖服务的调用。</p>\n<p>要执行 command，可以在 4 个方法中选择其中的一个：execute()、queue()、observe()、toObservable()。</p>\n<p>其中 execute() 和 queue() 方法仅仅对 HystrixCommand 适用。</p>\n<ul>\n<li><code class="language-text">execute()</code>：调用后直接 block 住，属于同步调用，直到依赖服务返回单条结果，或者抛出异常。</li>\n<li><code class="language-text">queue()</code>：返回一个 Future，属于异步调用，后面可以通过 Future 获取单条结果。</li>\n<li><code class="language-text">observe()</code>：订阅一个 Observable 对象，Observable 代表的是依赖服务返回的结果，获取到一个那个代表结果的 Observable 对象的拷贝对象。</li>\n<li><code class="language-text">toObservable()</code>：返回一个 Observable 对象，如果我们订阅这个对象，就会执行 command 并且获取返回结果。</li>\n</ul>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="35881329224367750000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`K             value    = hystrixCommand.execute();\nFuture<K>     fValue   = hystrixCommand.queue();\nObservable<K> oValue   = hystrixObservableCommand.observe();\nObservable<K> toOValue = hystrixObservableCommand.toObservable();`, `35881329224367750000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token class-name">K</span>             value    <span class="token operator">=</span> hystrixCommand<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">></span></span>     fValue   <span class="token operator">=</span> hystrixCommand<span class="token punctuation">.</span><span class="token function">queue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token class-name">Observable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">></span></span> oValue   <span class="token operator">=</span> hystrixObservableCommand<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token class-name">Observable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">></span></span> toOValue <span class="token operator">=</span> hystrixObservableCommand<span class="token punctuation">.</span><span class="token function">toObservable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>execute() 实际上会调用 <code class="language-text">queue().get()</code> 方法，可以看一下 Hystrix 源码。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="40979722208614240000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public R execute() {\n    try {\n        return queue().get();\n    } catch (Exception e) {\n        throw Exceptions.sneakyThrow(decomposeException(e));\n    }\n}`, `40979722208614240000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">R</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">try</span> <span class="token punctuation">{</span>\n        <span class="token keyword">return</span> <span class="token function">queue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">throw</span> <span class="token class-name">Exceptions</span><span class="token punctuation">.</span><span class="token function">sneakyThrow</span><span class="token punctuation">(</span><span class="token function">decomposeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>而在 queue() 方法中，会调用 <code class="language-text">toObservable().toBlocking().toFuture()</code>。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="53547935067998175000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`final Future<R> delegate = toObservable().toBlocking().toFuture();`, `53547935067998175000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">final</span> <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">></span></span> delegate <span class="token operator">=</span> <span class="token function">toObservable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBlocking</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toFuture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>也就是说，先通过 toObservable() 获得 Future 对象，然后调用 Future 的 get() 方法。那么，其实无论是哪种方式执行 command，最终都是依赖于 toObservable() 去执行的。</p>\n<h4 id="步骤三：检查是否开启缓存（不太常用）"><a href="#%E6%AD%A5%E9%AA%A4%E4%B8%89%EF%BC%9A%E6%A3%80%E6%9F%A5%E6%98%AF%E5%90%A6%E5%BC%80%E5%90%AF%E7%BC%93%E5%AD%98%EF%BC%88%E4%B8%8D%E5%A4%AA%E5%B8%B8%E7%94%A8%EF%BC%89" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>步骤三：检查是否开启缓存（不太常用）</h4>\n<p>从这一步开始，就进入到 Hystrix 底层运行原理啦，看一下 Hystrix 一些更高级的功能和特性。</p>\n<p>如果这个 command 开启了请求缓存 Request Cache，而且这个调用的结果在缓存中存在，那么直接从缓存中返回结果。否则，继续往后的步骤。</p>\n<h4 id="步骤四：检查是否开启了断路器"><a href="#%E6%AD%A5%E9%AA%A4%E5%9B%9B%EF%BC%9A%E6%A3%80%E6%9F%A5%E6%98%AF%E5%90%A6%E5%BC%80%E5%90%AF%E4%BA%86%E6%96%AD%E8%B7%AF%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>步骤四：检查是否开启了断路器</h4>\n<p>检查这个 command 对应的依赖服务是否开启了断路器。如果断路器被打开了，那么 Hystrix 就不会执行这个 command，而是直接去执行 fallback 降级机制，返回降级结果。</p>\n<h4 id="步骤五：检查线程池队列信号量是否已满"><a href="#%E6%AD%A5%E9%AA%A4%E4%BA%94%EF%BC%9A%E6%A3%80%E6%9F%A5%E7%BA%BF%E7%A8%8B%E6%B1%A0%E9%98%9F%E5%88%97%E4%BF%A1%E5%8F%B7%E9%87%8F%E6%98%AF%E5%90%A6%E5%B7%B2%E6%BB%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>步骤五：检查线程池/队列/信号量是否已满</h4>\n<p>如果这个 command 线程池和队列已满，或者 semaphore 信号量已满，那么也不会执行 command，而是直接去调用 fallback 降级机制，同时发送 reject 信息给断路器统计。</p>\n<h4 id="步骤六：执行-command"><a href="#%E6%AD%A5%E9%AA%A4%E5%85%AD%EF%BC%9A%E6%89%A7%E8%A1%8C-command" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>步骤六：执行 command</h4>\n<p>调用 HystrixObservableCommand 对象的 construct() 方法，或者 HystrixCommand 的 run() 方法来实际执行这个 command。</p>\n<ul>\n<li>\n<p><code class="language-text">HystrixCommand.run()</code> 返回单条结果，或者抛出异常。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="93123594316525190000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 通过 command 执行，获取最新一条商品数据\nProductInfo productInfo = getProductInfoCommand.execute();`, `93123594316525190000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token comment">// 通过 command 执行，获取最新一条商品数据</span>\n<span class="token class-name">ProductInfo</span> productInfo <span class="token operator">=</span> getProductInfoCommand<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n</li>\n<li>\n<p><code class="language-text">HystrixObservableCommand.construct()</code> 返回一个 Observable 对象，可以获取多条结果。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="27862052750710587000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`Observable<ProductInfo> observable = getProductInfosCommand.observe();\n\n// 订阅获取多条结果\nobservable.subscribe(new Observer<ProductInfo>() {\n  @Override\n  public void onCompleted() {\n     System.out.println(&quot;获取完了所有的商品数据&quot;);\n  }\n\n  @Override\n  public void onError(Throwable e) {\n     e.printStackTrace();\n  }\n\n  /**\n   * 获取完一条数据，就回调一次这个方法\n   *\n   * @param productInfo 商品信息\n   */\n  @Override\n  public void onNext(ProductInfo productInfo) {\n     System.out.println(productInfo);\n  }\n});`, `27862052750710587000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token class-name">Observable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ProductInfo</span><span class="token punctuation">></span></span> observable <span class="token operator">=</span> getProductInfosCommand<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 订阅获取多条结果</span>\nobservable<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Observer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ProductInfo</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token annotation punctuation">@Override</span>\n  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCompleted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n     <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"获取完了所有的商品数据"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token annotation punctuation">@Override</span>\n  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onError</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n     e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token comment">/**\n   * 获取完一条数据，就回调一次这个方法\n   *\n   * @param productInfo 商品信息\n   */</span>\n  <span class="token annotation punctuation">@Override</span>\n  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onNext</span><span class="token punctuation">(</span><span class="token class-name">ProductInfo</span> productInfo<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n     <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>productInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n</ul>\n<p>如果是采用线程池方式，并且 HystrixCommand.run() 或者 HystrixObservableCommand.construct() 的执行时间超过了 timeout 时长的话，那么 command 所在的线程会抛出一个 TimeoutException，这时会执行 fallback 降级机制，不会去管 run() 或 construct() 返回的值了。另一种情况，如果 command 执行出错抛出了其它异常，那么也会走 fallback 降级。这两种情况下，Hystrix 都会发送异常事件给断路器统计。</p>\n<p>注意，我们是不可能终止掉一个调用严重延迟的依赖服务的线程的，只能说给你抛出来一个 TimeoutException。</p>\n<p>如果没有 timeout，也正常执行的话，那么调用线程就会拿到一些调用依赖服务获取到的结果，然后 Hystrix 也会做一些 logging 记录和 metric 度量统计。</p>\n<h4 id="步骤七：断路健康检查"><a href="#%E6%AD%A5%E9%AA%A4%E4%B8%83%EF%BC%9A%E6%96%AD%E8%B7%AF%E5%81%A5%E5%BA%B7%E6%A3%80%E6%9F%A5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>步骤七：断路健康检查</h4>\n<p>Hystrix 会把每一个依赖服务的调用成功、失败、Reject、Timeout 等事件发送给 circuit breaker 断路器。断路器就会对这些事件的次数进行统计，根据异常事件发生的比例来决定是否要进行断路（熔断）。如果打开了断路器，那么在接下来一段时间内，会直接断路，返回降级结果。</p>\n<p>如果在之后，断路器尝试执行 command，调用没有出错，返回了正常结果，那么 Hystrix 就会把断路器关闭。</p>\n<h4 id="步骤八：调用-fallback-降级机制"><a href="#%E6%AD%A5%E9%AA%A4%E5%85%AB%EF%BC%9A%E8%B0%83%E7%94%A8-fallback-%E9%99%8D%E7%BA%A7%E6%9C%BA%E5%88%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>步骤八：调用 fallback 降级机制</h4>\n<p>在以下几种情况中，Hystrix 会调用 fallback 降级机制。</p>\n<ul>\n<li>断路器处于打开状态；</li>\n<li>线程池 / 队列 / semaphore 满了；</li>\n<li>command 执行超时；</li>\n<li>run() 或者 construct() 抛出异常。</li>\n</ul>\n<p>一般在降级机制中，都建议给出一些默认的返回值，比如静态的一些代码逻辑，或者从内存中的缓存中提取一些数据，在这里尽量不要再进行网络请求了。</p>\n<p>在降级中，如果一定要进行网络调用的话，也应该将那个调用放在一个 HystrixCommand 中进行隔离。</p>\n<ul>\n<li>HystrixCommand 中，实现 getFallback() 方法，可以提供降级机制。</li>\n<li>HystrixObservableCommand 中，实现 resumeWithFallback() 方法，返回一个 Observable 对象，可以提供降级结果。</li>\n</ul>\n<p>如果没有实现 fallback，或者 fallback 抛出了异常，Hystrix 会返回一个 Observable，但是不会返回任何数据。</p>\n<p>不同的 command 执行方式，其 fallback 为空或者异常时的返回结果不同。</p>\n<ul>\n<li>对于 execute()，直接抛出异常。</li>\n<li>对于 queue()，返回一个 Future，调用 get() 时抛出异常。</li>\n<li>对于 observe()，返回一个 Observable 对象，但是调用 subscribe() 方法订阅它时，立即抛出调用者的 onError() 方法。</li>\n<li>对于 toObservable()，返回一个 Observable 对象，但是调用 subscribe() 方法订阅它时，立即抛出调用者的 onError() 方法。</li>\n</ul>\n<h4 id="不同的执行方式"><a href="#%E4%B8%8D%E5%90%8C%E7%9A%84%E6%89%A7%E8%A1%8C%E6%96%B9%E5%BC%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>不同的执行方式</h4>\n<ul>\n<li>execute()，获取一个 Future.get()，然后拿到单个结果。</li>\n<li>queue()，返回一个 Future。</li>\n<li>observe()，立即订阅 Observable，然后启动 8 大执行步骤，返回一个拷贝的 Observable，订阅时立即回调给你结果。</li>\n<li>toObservable()，返回一个原始的 Observable，必须手动订阅才会去执行 8 大步骤。</li>\n</ul>\n<h3 id="基于-request-cache-请求缓存技术优化批量商品数据查询接口"><a href="#%E5%9F%BA%E4%BA%8E-request-cache-%E8%AF%B7%E6%B1%82%E7%BC%93%E5%AD%98%E6%8A%80%E6%9C%AF%E4%BC%98%E5%8C%96%E6%89%B9%E9%87%8F%E5%95%86%E5%93%81%E6%95%B0%E6%8D%AE%E6%9F%A5%E8%AF%A2%E6%8E%A5%E5%8F%A3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>基于 request cache 请求缓存技术优化批量商品数据查询接口</h3>\n<p>Hystrix command 执行时 8 大步骤第三步，就是检查 Request cache 是否有缓存。</p>\n<p>首先，有一个概念，叫做 Request Context 请求上下文，一般来说，在一个 web 应用中，如果我们用到了 Hystrix，我们会在一个 filter 里面，对每一个请求都施加一个请求上下文。就是说，每一次请求，就是一次请求上下文。然后在这次请求上下文中，我们会去执行 N 多代码，调用 N 多依赖服务，有的依赖服务可能还会调用好几次。</p>\n<p>在一次请求上下文中，如果有多个 command，参数都是一样的，调用的接口也是一样的，而结果可以认为也是一样的。那么这个时候，我们可以让第一个 command 执行返回的结果缓存在内存中，然后这个请求上下文后续的其它对这个依赖的调用全部从内存中取出缓存结果就可以了。</p>\n<p>这样的话，好处在于不用在一次请求上下文中反复多次执行一样的 command，避免重复执行网络请求，提升整个请求的性能。</p>\n<p>举个栗子。比如说我们在一次请求上下文中，请求获取 productId 为 1 的数据，第一次缓存中没有，那么会从商品服务中获取数据，返回最新数据结果，同时将数据缓存在内存中。后续同一次请求上下文中，如果还有获取 productId 为 1 的数据的请求，直接从缓存中取就好了。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-09-27-10-07-36-239f345702116484b6b7320ac165a986-aa752.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 339px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 76.99115044247787%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAIAAABr+ngCAAAACXBIWXMAAAsSAAALEgHS3X78AAAB00lEQVQoz4WS147CQAxF5/+/BiR4AyFE74QSqkChEwiQ0FvgBK9WLDysH6wZj+/1tcdqPB4/Hg98Pp/v9/uz2Ww6nV4uFw7EXdfFc91ut4FAoN1u7/d727aHw+H9flcClqRfI3uxWNxuNygsy1oul7lczufzwavreq/XIwKdGo1GnBqNRrVaxVcqFVjn83mn0wG/Xq8nkwlP1AyHw4CJkE+QAgoa0zQJwUJotVodDodYLAYLwVqt1mw2CZIWDAaj0ShKYUc5Aj3ZwOr1OnlUwFMftZlMJp1Og6RmPB5vtVpQAyiXy9SXThVDAsxbqVSiH1io4/f7ISIDpKZp3W5X+spms+RLw47jqMFgQIfcqQYLSCowJHQWCgV0cd7tdqQahgFys9mAJAKvogGyi8UiIimOhyISiYRCofP5zMykPdLAXK9X2JmRfIQnm4zj8ShfcjqdGBgKkUOcVJ6YPKPiSSbPLPltEhR3lKdSqWQyyZASiQTPqOWApwh4KkMtywMXLIiC0fsqKWK8DDGwynjBsEayNgDIEXUYB0+2DMl8mSwMUdkE+Y+P5Xu3n/WkgiSJR9X7bou5X+ZV5oHpgRdPlMbo5XvnPyvTM1ul/zVWhY/5F/wEmDk0yToSgMwAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 09 27 10 07 36" title="" data-src="/static/2023-09-27-10-07-36-239f345702116484b6b7320ac165a986-aa752.png" data-srcset="/static/2023-09-27-10-07-36-239f345702116484b6b7320ac165a986-bb04d.png 200w,\n/static/2023-09-27-10-07-36-239f345702116484b6b7320ac165a986-aa752.png 339w" data-sizes="(max-width: 339px) 100vw, 339px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>HystrixCommand 和 HystrixObservableCommand 都可以指定一个缓存 key，然后 Hystrix 会自动进行缓存，接着在同一个 request context 内，再次访问的话，就会直接取用缓存。</p>\n<p>下面，我们结合一个具体的业务场景，来看一下如何使用 request cache 请求缓存技术。当然，以下代码只作为一个基本的 Demo 而已。</p>\n<p>现在，假设我们要做一个批量查询商品数据的接口，在这个里面，我们是用 HystrixCommand 一次性批量查询多个商品 id 的数据。但是这里有个问题，如果说 Nginx 在本地缓存失效了，重新获取一批缓存，传递过来的 productIds 都没有进行去重，比如 <code class="language-text">productIds=1,1,1,2,2</code>，那么可能说，商品 id 出现了重复，如果按照我们之前的业务逻辑，可能就会重复对 <code class="language-text">productId=1</code> 的商品查询三次，<code class="language-text">productId=2</code> 的商品查询两次。</p>\n<p>我们对批量查询商品数据的接口，可以用 request cache 做一个优化，就是说一次请求，就是一次 request context，对相同的商品查询只执行一次，其余重复的都走 request cache。</p>\n<h4 id="实现-hystrix-请求上下文过滤器并注册"><a href="#%E5%AE%9E%E7%8E%B0-hystrix-%E8%AF%B7%E6%B1%82%E4%B8%8A%E4%B8%8B%E6%96%87%E8%BF%87%E6%BB%A4%E5%99%A8%E5%B9%B6%E6%B3%A8%E5%86%8C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>实现 Hystrix 请求上下文过滤器并注册</h4>\n<p>定义 HystrixRequestContextFilter 类，实现 Filter 接口。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="33074594431171800000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`/**\n * Hystrix 请求上下文过滤器\n */\npublic class HystrixRequestContextFilter implements Filter {\n\n    @Override\n    public void init(FilterConfig filterConfig) throws ServletException {\n\n    }\n\n    @Override\n    public void doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain) {\n        HystrixRequestContext context = HystrixRequestContext.initializeContext();\n        try {\n            filterChain.doFilter(servletRequest, servletResponse);\n        } catch (IOException | ServletException e) {\n            e.printStackTrace();\n        } finally {\n            context.shutdown();\n        }\n    }\n\n    @Override\n    public void destroy() {\n\n    }\n}`, `33074594431171800000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token comment">/**\n * Hystrix 请求上下文过滤器\n */</span>\n<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HystrixRequestContextFilter</span> <span class="token keyword">implements</span> <span class="token class-name">Filter</span> <span class="token punctuation">{</span>\n\n    <span class="token annotation punctuation">@Override</span>\n    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">FilterConfig</span> filterConfig<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>\n\n    <span class="token punctuation">}</span>\n\n    <span class="token annotation punctuation">@Override</span>\n    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> servletRequest<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> servletResponse<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> filterChain<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token class-name">HystrixRequestContext</span> context <span class="token operator">=</span> <span class="token class-name">HystrixRequestContext</span><span class="token punctuation">.</span><span class="token function">initializeContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">try</span> <span class="token punctuation">{</span>\n            filterChain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>servletRequest<span class="token punctuation">,</span> servletResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> <span class="token operator">|</span> <span class="token class-name">ServletException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>\n            context<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token annotation punctuation">@Override</span>\n    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后将该 filter 对象注册到 SpringBoot Application 中。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="82586201930844650000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`@SpringBootApplication\npublic class EshopApplication {\n\n    public static void main(String[] args) {\n        SpringApplication.run(EshopApplication.class, args);\n    }\n\n    @Bean\n    public FilterRegistrationBean filterRegistrationBean() {\n        FilterRegistrationBean filterRegistrationBean = new FilterRegistrationBean(new HystrixRequestContextFilter());\n        filterRegistrationBean.addUrlPatterns(&quot;/*&quot;);\n        return filterRegistrationBean;\n    }\n}`, `82586201930844650000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token annotation punctuation">@SpringBootApplication</span>\n<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EshopApplication</span> <span class="token punctuation">{</span>\n\n    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">EshopApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token annotation punctuation">@Bean</span>\n    <span class="token keyword">public</span> <span class="token class-name">FilterRegistrationBean</span> <span class="token function">filterRegistrationBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token class-name">FilterRegistrationBean</span> filterRegistrationBean <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FilterRegistrationBean</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HystrixRequestContextFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        filterRegistrationBean<span class="token punctuation">.</span><span class="token function">addUrlPatterns</span><span class="token punctuation">(</span><span class="token string">"/*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">return</span> filterRegistrationBean<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="command-重写-getcachekey-方法"><a href="#command-%E9%87%8D%E5%86%99-getcachekey-%E6%96%B9%E6%B3%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>command 重写 getCacheKey() 方法</h4>\n<p>在 GetProductInfoCommand 中，重写 getCacheKey() 方法，这样的话，每一次请求的结果，都会放在 Hystrix 请求上下文中。下一次同一个 productId 的数据请求，直接取缓存，无须再调用 run() 方法。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="24694057860493280000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public class GetProductInfoCommand extends HystrixCommand<ProductInfo> {\n\n    private Long productId;\n\n    private static final HystrixCommandKey KEY = HystrixCommandKey.Factory.asKey(&quot;GetProductInfoCommand&quot;);\n\n    public GetProductInfoCommand(Long productId) {\n        super(Setter.withGroupKey(HystrixCommandGroupKey.Factory.asKey(&quot;ProductInfoService&quot;))\n                .andCommandKey(KEY));\n        this.productId = productId;\n    }\n\n    @Override\n    protected ProductInfo run() {\n        String url = &quot;http://localhost:8081/getProductInfo?productId=&quot; + productId;\n        String response = HttpClientUtils.sendGetRequest(url);\n        System.out.println(&quot;调用接口查询商品数据，productId=&quot; + productId);\n        return JSONObject.parseObject(response, ProductInfo.class);\n    }\n\n    /**\n     * 每次请求的结果，都会放在 Hystrix 绑定的请求上下文上\n     *\n     * @return cacheKey 缓存 key\n     */\n    @Override\n    public String getCacheKey() {\n        return &quot;product_info_&quot; + productId;\n    }\n\n    /**\n     * 将某个商品 id 的缓存清空\n     *\n     * @param productId 商品 id\n     */\n    public static void flushCache(Long productId) {\n        HystrixRequestCache.getInstance(KEY,\n                HystrixConcurrencyStrategyDefault.getInstance()).clear(&quot;product_info_&quot; + productId);\n    }\n}`, `24694057860493280000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GetProductInfoCommand</span> <span class="token keyword">extends</span> <span class="token class-name">HystrixCommand</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ProductInfo</span><span class="token punctuation">></span></span> <span class="token punctuation">{</span>\n\n    <span class="token keyword">private</span> <span class="token class-name">Long</span> productId<span class="token punctuation">;</span>\n\n    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">HystrixCommandKey</span> KEY <span class="token operator">=</span> <span class="token class-name">HystrixCommandKey</span><span class="token punctuation">.</span><span class="token class-name">Factory</span><span class="token punctuation">.</span><span class="token function">asKey</span><span class="token punctuation">(</span><span class="token string">"GetProductInfoCommand"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">public</span> <span class="token class-name">GetProductInfoCommand</span><span class="token punctuation">(</span><span class="token class-name">Long</span> productId<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token class-name">Setter</span><span class="token punctuation">.</span><span class="token function">withGroupKey</span><span class="token punctuation">(</span><span class="token class-name">HystrixCommandGroupKey</span><span class="token punctuation">.</span><span class="token class-name">Factory</span><span class="token punctuation">.</span><span class="token function">asKey</span><span class="token punctuation">(</span><span class="token string">"ProductInfoService"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n                <span class="token punctuation">.</span><span class="token function">andCommandKey</span><span class="token punctuation">(</span>KEY<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">this</span><span class="token punctuation">.</span>productId <span class="token operator">=</span> productId<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token annotation punctuation">@Override</span>\n    <span class="token keyword">protected</span> <span class="token class-name">ProductInfo</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token class-name">String</span> url <span class="token operator">=</span> <span class="token string">"http://localhost:8081/getProductInfo?productId="</span> <span class="token operator">+</span> productId<span class="token punctuation">;</span>\n        <span class="token class-name">String</span> response <span class="token operator">=</span> <span class="token class-name">HttpClientUtils</span><span class="token punctuation">.</span><span class="token function">sendGetRequest</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"调用接口查询商品数据，productId="</span> <span class="token operator">+</span> productId<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">return</span> <span class="token class-name">JSONObject</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> <span class="token class-name">ProductInfo</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token comment">/**\n     * 每次请求的结果，都会放在 Hystrix 绑定的请求上下文上\n     *\n     * @return cacheKey 缓存 key\n     */</span>\n    <span class="token annotation punctuation">@Override</span>\n    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getCacheKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">return</span> <span class="token string">"product_info_"</span> <span class="token operator">+</span> productId<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token comment">/**\n     * 将某个商品 id 的缓存清空\n     *\n     * @param productId 商品 id\n     */</span>\n    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">flushCache</span><span class="token punctuation">(</span><span class="token class-name">Long</span> productId<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token class-name">HystrixRequestCache</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span>KEY<span class="token punctuation">,</span>\n                <span class="token class-name">HystrixConcurrencyStrategyDefault</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token string">"product_info_"</span> <span class="token operator">+</span> productId<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这里写了一个 flushCache() 方法，用于我们开发手动删除缓存。</p>\n<h4 id="controller-调用-command-查询商品信息"><a href="#controller-%E8%B0%83%E7%94%A8-command-%E6%9F%A5%E8%AF%A2%E5%95%86%E5%93%81%E4%BF%A1%E6%81%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>controller 调用 command 查询商品信息</h4>\n<p>在一次 web 请求上下文中，传入商品 id 列表，查询多条商品数据信息。对于每个 productId，都创建一个 command。</p>\n<p>如果 id 列表没有去重，那么重复的 id，第二次查询的时候就会直接走缓存。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="45194279585597650000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`@Controller\npublic class CacheController {\n\n    /**\n     * 一次性批量查询多条商品数据的请求\n     *\n     * @param productIds 以 , 分隔的商品 id 列表\n     * @return 响应状态\n     */\n    @RequestMapping(&quot;/getProductInfos&quot;)\n    @ResponseBody\n    public String getProductInfos(String productIds) {\n        for (String productId : productIds.split(&quot;,&quot;)) {\n            // 对每个 productId，都创建一个 command\n            GetProductInfoCommand getProductInfoCommand = new GetProductInfoCommand(Long.valueOf(productId));\n            ProductInfo productInfo = getProductInfoCommand.execute();\n            System.out.println(&quot;是否是从缓存中取的结果：&quot; + getProductInfoCommand.isResponseFromCache());\n        }\n\n        return &quot;success&quot;;\n    }\n}`, `45194279585597650000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token annotation punctuation">@Controller</span>\n<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CacheController</span> <span class="token punctuation">{</span>\n\n    <span class="token comment">/**\n     * 一次性批量查询多条商品数据的请求\n     *\n     * @param productIds 以 , 分隔的商品 id 列表\n     * @return 响应状态\n     */</span>\n    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/getProductInfos"</span><span class="token punctuation">)</span>\n    <span class="token annotation punctuation">@ResponseBody</span>\n    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getProductInfos</span><span class="token punctuation">(</span><span class="token class-name">String</span> productIds<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> productId <span class="token operator">:</span> productIds<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token comment">// 对每个 productId，都创建一个 command</span>\n            <span class="token class-name">GetProductInfoCommand</span> getProductInfoCommand <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GetProductInfoCommand</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>productId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token class-name">ProductInfo</span> productInfo <span class="token operator">=</span> getProductInfoCommand<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"是否是从缓存中取的结果："</span> <span class="token operator">+</span> getProductInfoCommand<span class="token punctuation">.</span><span class="token function">isResponseFromCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n\n        <span class="token keyword">return</span> <span class="token string">"success"</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="发起请求"><a href="#%E5%8F%91%E8%B5%B7%E8%AF%B7%E6%B1%82" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>发起请求</h4>\n<p>调用接口，查询多个商品的信息。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="15210701949324657000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`http://localhost:8080/getProductInfos?productIds=1,1,1,2,2,5`, `15210701949324657000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">http://localhost:8080/getProductInfos?productIds=1,1,1,2,2,5</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>在控制台，我们可以看到以下结果。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="90148411165642110000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`调用接口查询商品数据，productId=1\n是否是从缓存中取的结果：false\n是否是从缓存中取的结果：true\n是否是从缓存中取的结果：true\n调用接口查询商品数据，productId=2\n是否是从缓存中取的结果：false\n是否是从缓存中取的结果：true\n调用接口查询商品数据，productId=5\n是否是从缓存中取的结果：false`, `90148411165642110000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">调用接口查询商品数据，productId=1\n是否是从缓存中取的结果：false\n是否是从缓存中取的结果：true\n是否是从缓存中取的结果：true\n调用接口查询商品数据，productId=2\n是否是从缓存中取的结果：false\n是否是从缓存中取的结果：true\n调用接口查询商品数据，productId=5\n是否是从缓存中取的结果：false</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>第一次查询 productId=1 的数据，会调用接口进行查询，不是从缓存中取结果。而随后再出现查询 productId=1 的请求，就直接取缓存了，这样的话，效率明显高很多。</p>\n<h4 id="删除缓存"><a href="#%E5%88%A0%E9%99%A4%E7%BC%93%E5%AD%98" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>删除缓存</h4>\n<p>我们写一个 UpdateProductInfoCommand，在更新商品信息之后，手动调用之前写的 flushCache()，手动将缓存删除。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="86164774028013930000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public class UpdateProductInfoCommand extends HystrixCommand<Boolean> {\n\n    private Long productId;\n\n    public UpdateProductInfoCommand(Long productId) {\n        super(HystrixCommandGroupKey.Factory.asKey(&quot;UpdateProductInfoGroup&quot;));\n        this.productId = productId;\n    }\n\n    @Override\n    protected Boolean run() throws Exception {\n        // 这里执行一次商品信息的更新\n        // ...\n\n        // 然后清空缓存\n        GetProductInfoCommand.flushCache(productId);\n        return true;\n    }\n}`, `86164774028013930000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UpdateProductInfoCommand</span> <span class="token keyword">extends</span> <span class="token class-name">HystrixCommand</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">></span></span> <span class="token punctuation">{</span>\n\n    <span class="token keyword">private</span> <span class="token class-name">Long</span> productId<span class="token punctuation">;</span>\n\n    <span class="token keyword">public</span> <span class="token class-name">UpdateProductInfoCommand</span><span class="token punctuation">(</span><span class="token class-name">Long</span> productId<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token class-name">HystrixCommandGroupKey</span><span class="token punctuation">.</span><span class="token class-name">Factory</span><span class="token punctuation">.</span><span class="token function">asKey</span><span class="token punctuation">(</span><span class="token string">"UpdateProductInfoGroup"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">this</span><span class="token punctuation">.</span>productId <span class="token operator">=</span> productId<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token annotation punctuation">@Override</span>\n    <span class="token keyword">protected</span> <span class="token class-name">Boolean</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>\n        <span class="token comment">// 这里执行一次商品信息的更新</span>\n        <span class="token comment">// ...</span>\n\n        <span class="token comment">// 然后清空缓存</span>\n        <span class="token class-name">GetProductInfoCommand</span><span class="token punctuation">.</span><span class="token function">flushCache</span><span class="token punctuation">(</span>productId<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样，以后查询该商品的请求，第一次就会走接口调用去查询最新的商品信息。</p>\n<h3 id="基于本地缓存的-fallback-降级机制"><a href="#%E5%9F%BA%E4%BA%8E%E6%9C%AC%E5%9C%B0%E7%BC%93%E5%AD%98%E7%9A%84-fallback-%E9%99%8D%E7%BA%A7%E6%9C%BA%E5%88%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>基于本地缓存的 fallback 降级机制</h3>\n<p>Hystrix 出现以下四种情况，都会去调用 fallback 降级机制：</p>\n<ul>\n<li>断路器处于打开的状态。</li>\n<li>资源池已满（线程池 + 队列 / 信号量）。</li>\n<li>Hystrix 调用各种接口，或者访问外部依赖，比如 MySQL、Redis、Zookeeper、Kafka 等等，出现了任何异常的情况。</li>\n<li>访问外部依赖的时候，访问时间过长，报了 TimeoutException 异常。</li>\n</ul>\n<h4 id="两种最经典的降级机制"><a href="#%E4%B8%A4%E7%A7%8D%E6%9C%80%E7%BB%8F%E5%85%B8%E7%9A%84%E9%99%8D%E7%BA%A7%E6%9C%BA%E5%88%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>两种最经典的降级机制</h4>\n<ul>\n<li>\n<p>纯内存数据</p>\n<p>在降级逻辑中，你可以在内存中维护一个 ehcache，作为一个纯内存的基于 LRU 自动清理的缓存，让数据放在缓存内。如果说外部依赖有异常，fallback 这里直接尝试从 ehcache 中获取数据。</p>\n</li>\n<li>\n<p>默认值</p>\n<p>fallback 降级逻辑中，也可以直接返回一个默认值。</p>\n</li>\n</ul>\n<p>在 HystrixCommand，降级逻辑的书写，是通过实现 getFallback() 接口；而在 HystrixObservableCommand 中，则是实现 resumeWithFallback() 方法。</p>\n<p>现在，我们用一个简单的栗子，来演示 fallback 降级是怎么做的。</p>\n<p>比如，有这么个场景。我们现在有个包含 brandId 的商品数据，假设正常的逻辑是这样：拿到一个商品数据，根据 brandId 去调用品牌服务的接口，获取品牌的最新名称 brandName。</p>\n<p>假如说，品牌服务接口挂掉了，那么我们可以尝试从本地内存中，获取一份稍过期的数据，先凑合着用。</p>\n<h4 id="步骤一：本地缓存获取数据"><a href="#%E6%AD%A5%E9%AA%A4%E4%B8%80%EF%BC%9A%E6%9C%AC%E5%9C%B0%E7%BC%93%E5%AD%98%E8%8E%B7%E5%8F%96%E6%95%B0%E6%8D%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>步骤一：本地缓存获取数据</h4>\n<p>本地获取品牌名称的代码大致如下</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="97812151688779600000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`/**\n * 品牌名称本地缓存\n *\n */\npublic class BrandCache {\n\n    private static Map<Long, String> brandMap = new HashMap<>();\n\n    static {\n        brandMap.put(1L, &quot;Nike&quot;);\n    }\n\n    /**\n     * brandId 获取 brandName\n     *\n     * @param brandId 品牌 id\n     * @return 品牌名\n     */\n    public static String getBrandName(Long brandId) {\n        return brandMap.get(brandId);\n    }`, `97812151688779600000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token comment">/**\n * 品牌名称本地缓存\n *\n */</span>\n<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BrandCache</span> <span class="token punctuation">{</span>\n\n    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> brandMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">static</span> <span class="token punctuation">{</span>\n        brandMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">,</span> <span class="token string">"Nike"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token comment">/**\n     * brandId 获取 brandName\n     *\n     * @param brandId 品牌 id\n     * @return 品牌名\n     */</span>\n    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getBrandName</span><span class="token punctuation">(</span><span class="token class-name">Long</span> brandId<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">return</span> brandMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>brandId<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="步骤二：实现-getbrandnamecommand"><a href="#%E6%AD%A5%E9%AA%A4%E4%BA%8C%EF%BC%9A%E5%AE%9E%E7%8E%B0-getbrandnamecommand" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>步骤二：实现 GetBrandNameCommand</h4>\n<p>在 GetBrandNameCommand 中，run() 方法的正常逻辑是去调用品牌服务的接口获取到品牌名称，如果调用失败，报错了，那么就会去调用 fallback 降级机制。</p>\n<p>这里，我们直接模拟接口调用报错，给它抛出个异常。</p>\n<p>而在 getFallback() 方法中，就是我们的降级逻辑，我们直接从本地的缓存中，获取到品牌名称的数据。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="26503823339198940000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`/**\n * 获取品牌名称的 command\n *\n */\npublic class GetBrandNameCommand extends HystrixCommand<String> {\n\n    private Long brandId;\n\n    public GetBrandNameCommand(Long brandId) {\n        super(Setter.withGroupKey(HystrixCommandGroupKey.Factory.asKey(&quot;BrandService&quot;))\n                .andCommandKey(HystrixCommandKey.Factory.asKey(&quot;GetBrandNameCommand&quot;))\n                .andCommandPropertiesDefaults(HystrixCommandProperties.Setter()\n                        // 设置降级机制最大并发请求数\n                        .withFallbackIsolationSemaphoreMaxConcurrentRequests(15)));\n        this.brandId = brandId;\n    }\n\n    @Override\n    protected String run() throws Exception {\n        // 这里正常的逻辑应该是去调用一个品牌服务的接口获取名称\n        // 如果调用失败，报错了，那么就会去调用 fallback 降级机制\n\n        // 这里我们直接模拟调用报错，抛出异常\n        throw new Exception();\n    }\n\n    @Override\n    protected String getFallback() {\n        return BrandCache.getBrandName(brandId);\n    }\n}`, `26503823339198940000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token comment">/**\n * 获取品牌名称的 command\n *\n */</span>\n<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GetBrandNameCommand</span> <span class="token keyword">extends</span> <span class="token class-name">HystrixCommand</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> <span class="token punctuation">{</span>\n\n    <span class="token keyword">private</span> <span class="token class-name">Long</span> brandId<span class="token punctuation">;</span>\n\n    <span class="token keyword">public</span> <span class="token class-name">GetBrandNameCommand</span><span class="token punctuation">(</span><span class="token class-name">Long</span> brandId<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token class-name">Setter</span><span class="token punctuation">.</span><span class="token function">withGroupKey</span><span class="token punctuation">(</span><span class="token class-name">HystrixCommandGroupKey</span><span class="token punctuation">.</span><span class="token class-name">Factory</span><span class="token punctuation">.</span><span class="token function">asKey</span><span class="token punctuation">(</span><span class="token string">"BrandService"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n                <span class="token punctuation">.</span><span class="token function">andCommandKey</span><span class="token punctuation">(</span><span class="token class-name">HystrixCommandKey</span><span class="token punctuation">.</span><span class="token class-name">Factory</span><span class="token punctuation">.</span><span class="token function">asKey</span><span class="token punctuation">(</span><span class="token string">"GetBrandNameCommand"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n                <span class="token punctuation">.</span><span class="token function">andCommandPropertiesDefaults</span><span class="token punctuation">(</span><span class="token class-name">HystrixCommandProperties</span><span class="token punctuation">.</span><span class="token class-name">Setter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n                        <span class="token comment">// 设置降级机制最大并发请求数</span>\n                        <span class="token punctuation">.</span><span class="token function">withFallbackIsolationSemaphoreMaxConcurrentRequests</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">this</span><span class="token punctuation">.</span>brandId <span class="token operator">=</span> brandId<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token annotation punctuation">@Override</span>\n    <span class="token keyword">protected</span> <span class="token class-name">String</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>\n        <span class="token comment">// 这里正常的逻辑应该是去调用一个品牌服务的接口获取名称</span>\n        <span class="token comment">// 如果调用失败，报错了，那么就会去调用 fallback 降级机制</span>\n\n        <span class="token comment">// 这里我们直接模拟调用报错，抛出异常</span>\n        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token annotation punctuation">@Override</span>\n    <span class="token keyword">protected</span> <span class="token class-name">String</span> <span class="token function">getFallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">return</span> <span class="token class-name">BrandCache</span><span class="token punctuation">.</span><span class="token function">getBrandName</span><span class="token punctuation">(</span>brandId<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>FallbackIsolationSemaphoreMaxConcurrentRequests 用于设置 fallback 最大允许的并发请求量，默认值是 10，是通过 semaphore 信号量的机制去限流的。如果超出了这个最大值，那么直接 reject。</p>\n<h4 id="步骤三：cachecontroller-调用接口"><a href="#%E6%AD%A5%E9%AA%A4%E4%B8%89%EF%BC%9Acachecontroller-%E8%B0%83%E7%94%A8%E6%8E%A5%E5%8F%A3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>步骤三：CacheController 调用接口</h4>\n<p>在 CacheController 中，我们通过 productInfo 获取 brandId，然后创建 GetBrandNameCommand 并执行，去尝试获取 brandName。这里执行会报错，因为我们在 run() 方法中直接抛出异常，Hystrix 就会去调用 getFallback() 方法走降级逻辑。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="64153958727904480000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`@Controller\npublic class CacheController {\n\n    @RequestMapping(&quot;/getProductInfo&quot;)\n    @ResponseBody\n    public String getProductInfo(Long productId) {\n        HystrixCommand<ProductInfo> getProductInfoCommand = new GetProductInfoCommand(productId);\n\n        ProductInfo productInfo = getProductInfoCommand.execute();\n        Long brandId = productInfo.getBrandId();\n\n        HystrixCommand<String> getBrandNameCommand = new GetBrandNameCommand(brandId);\n\n        // 执行会抛异常报错，然后走降级\n        String brandName = getBrandNameCommand.execute();\n        productInfo.setBrandName(brandName);\n\n        System.out.println(productInfo);\n        return &quot;success&quot;;\n    }\n}`, `64153958727904480000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token annotation punctuation">@Controller</span>\n<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CacheController</span> <span class="token punctuation">{</span>\n\n    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/getProductInfo"</span><span class="token punctuation">)</span>\n    <span class="token annotation punctuation">@ResponseBody</span>\n    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getProductInfo</span><span class="token punctuation">(</span><span class="token class-name">Long</span> productId<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token class-name">HystrixCommand</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ProductInfo</span><span class="token punctuation">></span></span> getProductInfoCommand <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GetProductInfoCommand</span><span class="token punctuation">(</span>productId<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        <span class="token class-name">ProductInfo</span> productInfo <span class="token operator">=</span> getProductInfoCommand<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token class-name">Long</span> brandId <span class="token operator">=</span> productInfo<span class="token punctuation">.</span><span class="token function">getBrandId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        <span class="token class-name">HystrixCommand</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> getBrandNameCommand <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GetBrandNameCommand</span><span class="token punctuation">(</span>brandId<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        <span class="token comment">// 执行会抛异常报错，然后走降级</span>\n        <span class="token class-name">String</span> brandName <span class="token operator">=</span> getBrandNameCommand<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        productInfo<span class="token punctuation">.</span><span class="token function">setBrandName</span><span class="token punctuation">(</span>brandName<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>productInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">return</span> <span class="token string">"success"</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>关于降级逻辑的演示，基本上就结束了。</p>\n<h3 id="深入-hystrix-断路器执行原理"><a href="#%E6%B7%B1%E5%85%A5-hystrix-%E6%96%AD%E8%B7%AF%E5%99%A8%E6%89%A7%E8%A1%8C%E5%8E%9F%E7%90%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>深入 Hystrix 断路器执行原理</h3>\n<h4 id="状态机"><a href="#%E7%8A%B6%E6%80%81%E6%9C%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>状态机</h4>\n<p>Hystrix 断路器有三种状态，分别是关闭（Closed）、打开（Open）与半开（Half-Open），三种状态转化关系如下：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-09-28-11-55-44-b09482ba9e52a70a141f372366c8acf9-b5415.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 48.33729216152019%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAAsSAAALEgHS3X78AAABV0lEQVQoz5WQW0/CQBCF9///IcOTD4ZIooDlEqxQWnqBUspuL3vt7rYO1BjFhMQv8zRzzmTOoO4PWpswDKMoopTGcRwEweGQ+r5fVRVM27b9VqLyi4IQIgS31hpjCoZ3x+1i7QSpVzLSS8EGQxCIKxdzlmWwe7cLfH+LMVZKcca8vfu2eXkaPzrb8TpeccGkFEIJqSRUGIXZMYNdCBY0Sv08BigoTvH+CEX2JStucqlG9acgMFHOb8x3aLuWS9GrUZ3Eue/VSSQINpfAGlJJKfP8lJ9zTIiGB15ptG7E2cpM89TKkxEndBgN54OH/HV0Xs4hrWBMMkarah/HhyTJ0pRTemlyXhaVyBckGm5mgyJ+NmSC8oWDV8ujMym8Tav1pZqms5bTOvS3YOusufab1lhDI1W4grhN+aGrNeqfXtc1XPs7Wwcp7n8CzWbOdDp13XfP87p/8gmJ4TvxB09hkwAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 09 28 11 55 44" title="" data-src="/static/2023-09-28-11-55-44-b09482ba9e52a70a141f372366c8acf9-fee1c.png" data-srcset="/static/2023-09-28-11-55-44-b09482ba9e52a70a141f372366c8acf9-a67b7.png 200w,\n/static/2023-09-28-11-55-44-b09482ba9e52a70a141f372366c8acf9-0b187.png 400w,\n/static/2023-09-28-11-55-44-b09482ba9e52a70a141f372366c8acf9-fee1c.png 800w,\n/static/2023-09-28-11-55-44-b09482ba9e52a70a141f372366c8acf9-b5415.png 842w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<ol>\n<li>Closed 断路器关闭：调用下游的请求正常通过</li>\n<li>Open 断路器打开：阻断对下游服务的调用，直接走 Fallback 逻辑</li>\n<li>Half-Open 断路器处于半开状态：SleepWindowInMilliseconds</li>\n</ol>\n<h5 id="enabled"><a href="#enabled" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Enabled</h5>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="85822099544354680000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`HystrixCommandProperties.Setter()\n    .withCircuitBreakerEnabled(boolean)`, `85822099544354680000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token class-name">HystrixCommandProperties</span><span class="token punctuation">.</span><span class="token class-name">Setter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">withCircuitBreakerEnabled</span><span class="token punctuation">(</span><span class="token keyword">boolean</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>控制断路器是否工作，包括跟踪依赖服务调用的健康状况，以及对异常情况过多时是否允许触发断路。默认值 true。</p>\n<h5 id="circuitbreakerrequestvolumethreshold"><a href="#circuitbreakerrequestvolumethreshold" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>circuitBreaker.requestVolumeThreshold</h5>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="21090936629721190000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`HystrixCommandProperties.Setter()\n    .withCircuitBreakerRequestVolumeThreshold(int)`, `21090936629721190000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token class-name">HystrixCommandProperties</span><span class="token punctuation">.</span><span class="token class-name">Setter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">withCircuitBreakerRequestVolumeThreshold</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>表示在一次统计的时间滑动窗口中（这个参数也很重要，下面有说到），至少经过多少个请求，才可能触发断路，默认值 20。经过 Hystrix 断路器的流量只有在超过了一定阈值后，才有可能触发断路。比如说，要求在 10s 内经过断路器的流量必须达到 20 个，而实际经过断路器的请求有 19 个，即使这 19 个请求全都失败，也不会去判断要不要断路。</p>\n<h5 id="circuitbreakererrorthresholdpercentage"><a href="#circuitbreakererrorthresholdpercentage" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>circuitBreaker.errorThresholdPercentage</h5>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="31589091892154110000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`HystrixCommandProperties.Setter()\n    .withCircuitBreakerErrorThresholdPercentage(int)`, `31589091892154110000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token class-name">HystrixCommandProperties</span><span class="token punctuation">.</span><span class="token class-name">Setter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">withCircuitBreakerErrorThresholdPercentage</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>表示异常比例达到多少，才会触发断路，默认值是 50(%)。</p>\n<h5 id="circuitbreakersleepwindowinmilliseconds"><a href="#circuitbreakersleepwindowinmilliseconds" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>circuitBreaker.sleepWindowInMilliseconds</h5>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="20095874840742425000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`HystrixCommandProperties.Setter()\n    .withCircuitBreakerSleepWindowInMilliseconds(int)`, `20095874840742425000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token class-name">HystrixCommandProperties</span><span class="token punctuation">.</span><span class="token class-name">Setter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">withCircuitBreakerSleepWindowInMilliseconds</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>断路器状态由 Close 转换到 Open，在之后 SleepWindowInMilliseconds 时间内，所有经过该断路器的请求会被断路，不调用后端服务，直接走 Fallback 降级机制，默认值 5000(ms)。</p>\n<p>而在该参数时间过后，断路器会变为 Half-Open 半开闭状态，尝试让一条请求经过断路器，看能不能正常调用。如果调用成功了，那么就自动恢复，断路器转为 Close 状态。</p>\n<h5 id="forceopen"><a href="#forceopen" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ForceOpen</h5>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="5808856435121767000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`HystrixCommandProperties.Setter()\n    .withCircuitBreakerForceOpen(boolean)`, `5808856435121767000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token class-name">HystrixCommandProperties</span><span class="token punctuation">.</span><span class="token class-name">Setter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">withCircuitBreakerForceOpen</span><span class="token punctuation">(</span><span class="token keyword">boolean</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>如果设置为 true 的话，直接强迫打开断路器，相当于是手动断路了，手动降级，默认值是 false。</p>\n<h5 id="forceclosed"><a href="#forceclosed" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ForceClosed</h5>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="10957834031026260000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`HystrixCommandProperties.Setter()\n    .withCircuitBreakerForceClosed(boolean)`, `10957834031026260000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token class-name">HystrixCommandProperties</span><span class="token punctuation">.</span><span class="token class-name">Setter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">withCircuitBreakerForceClosed</span><span class="token punctuation">(</span><span class="token keyword">boolean</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>如果设置为 true，直接强迫关闭断路器，相当于手动停止断路了，手动升级，默认值是 false。</p>\n<h4 id="metrics-统计器"><a href="#metrics-%E7%BB%9F%E8%AE%A1%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Metrics 统计器</h4>\n<p>与 Hystrix 断路器紧密协作的，还有另一个重要组件 —— 统计器（Metrics）。统计器中最重要的参数要数滑动窗口（metrics.rollingStats.timeInMilliseconds）以及桶（metrics.rollingStats.numBuckets）了，这里引用一段博文来解释滑动窗口（默认值是 10000 ms）：</p>\n<blockquote>\n<p>一位乘客坐在正在行驶的列车的靠窗座位上，列车行驶的公路两侧种着一排挺拔的白杨树，随着列车的前进，路边的白杨树迅速从窗口滑过。我们用每棵树来代表一个请求，用列车的行驶代表时间的流逝，那么，列车上的这个窗口就是一个典型的滑动窗口，这个乘客能通过窗口看到的白杨树就是 Hystrix 要统计的数据。</p>\n</blockquote>\n<p>Hystrix 并不是只要有一条请求经过就去统计，而是将整个滑动窗口均分为 numBuckets 份，时间每经过一份就去统计一次。在经过一个时间窗口后，才会判断断路器状态要不要开启，请看下面的例子。</p>\n<h4 id="实例-demo"><a href="#%E5%AE%9E%E4%BE%8B-demo" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>实例 Demo</h4>\n<h5 id="hystrixcommand-配置参数"><a href="#hystrixcommand-%E9%85%8D%E7%BD%AE%E5%8F%82%E6%95%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>HystrixCommand 配置参数</h5>\n<p>在 GetProductInfoCommand 中配置 Setter 断路器相关参数。</p>\n<ul>\n<li>滑动窗口中，最少 20 个请求，才可能触发断路。</li>\n<li>异常比例达到 40% 时，才触发断路。</li>\n<li>断路后 3000ms 内，所有请求都被 reject，直接走 fallback 降级，不会调用 run() 方法。3000ms 过后，变为 half-open 状态。</li>\n</ul>\n<p>run() 方法中，我们判断一下 productId 是否为 -1，是的话，直接抛出异常。这么写，我们之后测试的时候就可以传入 productId = -1，模拟服务执行异常了。</p>\n<p>在降级逻辑中，我们直接给它返回降级商品就好了。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="78629318222414800000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public class GetProductInfoCommand extends HystrixCommand<ProductInfo> {\n\n    private Long productId;\n\n    private static final HystrixCommandKey KEY = HystrixCommandKey.Factory.asKey(&quot;GetProductInfoCommand&quot;);\n\n    public GetProductInfoCommand(Long productId) {\n        super(Setter.withGroupKey(HystrixCommandGroupKey.Factory.asKey(&quot;ProductInfoService&quot;))\n                .andCommandKey(KEY)\n                .andCommandPropertiesDefaults(HystrixCommandProperties.Setter()\n                        // 是否允许断路器工作\n                        .withCircuitBreakerEnabled(true)\n                        // 滑动窗口中，最少有多少个请求，才可能触发断路\n                        .withCircuitBreakerRequestVolumeThreshold(20)\n                        // 异常比例达到多少，才触发断路，默认 50%\n                        .withCircuitBreakerErrorThresholdPercentage(40)\n                        // 断路后多少时间内直接 reject 请求，之后进入 half-open 状态，默认 5000ms\n                        .withCircuitBreakerSleepWindowInMilliseconds(3000)));\n        this.productId = productId;\n    }\n\n    @Override\n    protected ProductInfo run() throws Exception {\n        System.out.println(&quot;调用接口查询商品数据，productId =&quot; + productId);\n\n        if (productId == -1L) {\n            throw new Exception();\n        }\n\n        String url = &quot;http://localhost:8081/getProductInfo?productId=&quot; + productId;\n        String response = HttpClientUtils.sendGetRequest(url);\n        return JSONObject.parseObject(response, ProductInfo.class);\n    }\n\n    @Override\n    protected ProductInfo getFallback() {\n        ProductInfo productInfo = new ProductInfo();\n        productInfo.setName(&quot;降级商品&quot;);\n        return productInfo;\n    }\n}`, `78629318222414800000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GetProductInfoCommand</span> <span class="token keyword">extends</span> <span class="token class-name">HystrixCommand</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ProductInfo</span><span class="token punctuation">></span></span> <span class="token punctuation">{</span>\n\n    <span class="token keyword">private</span> <span class="token class-name">Long</span> productId<span class="token punctuation">;</span>\n\n    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">HystrixCommandKey</span> KEY <span class="token operator">=</span> <span class="token class-name">HystrixCommandKey</span><span class="token punctuation">.</span><span class="token class-name">Factory</span><span class="token punctuation">.</span><span class="token function">asKey</span><span class="token punctuation">(</span><span class="token string">"GetProductInfoCommand"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">public</span> <span class="token class-name">GetProductInfoCommand</span><span class="token punctuation">(</span><span class="token class-name">Long</span> productId<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token class-name">Setter</span><span class="token punctuation">.</span><span class="token function">withGroupKey</span><span class="token punctuation">(</span><span class="token class-name">HystrixCommandGroupKey</span><span class="token punctuation">.</span><span class="token class-name">Factory</span><span class="token punctuation">.</span><span class="token function">asKey</span><span class="token punctuation">(</span><span class="token string">"ProductInfoService"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n                <span class="token punctuation">.</span><span class="token function">andCommandKey</span><span class="token punctuation">(</span>KEY<span class="token punctuation">)</span>\n                <span class="token punctuation">.</span><span class="token function">andCommandPropertiesDefaults</span><span class="token punctuation">(</span><span class="token class-name">HystrixCommandProperties</span><span class="token punctuation">.</span><span class="token class-name">Setter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n                        <span class="token comment">// 是否允许断路器工作</span>\n                        <span class="token punctuation">.</span><span class="token function">withCircuitBreakerEnabled</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>\n                        <span class="token comment">// 滑动窗口中，最少有多少个请求，才可能触发断路</span>\n                        <span class="token punctuation">.</span><span class="token function">withCircuitBreakerRequestVolumeThreshold</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>\n                        <span class="token comment">// 异常比例达到多少，才触发断路，默认 50%</span>\n                        <span class="token punctuation">.</span><span class="token function">withCircuitBreakerErrorThresholdPercentage</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span>\n                        <span class="token comment">// 断路后多少时间内直接 reject 请求，之后进入 half-open 状态，默认 5000ms</span>\n                        <span class="token punctuation">.</span><span class="token function">withCircuitBreakerSleepWindowInMilliseconds</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">this</span><span class="token punctuation">.</span>productId <span class="token operator">=</span> productId<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token annotation punctuation">@Override</span>\n    <span class="token keyword">protected</span> <span class="token class-name">ProductInfo</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>\n        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"调用接口查询商品数据，productId ="</span> <span class="token operator">+</span> productId<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>productId <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1L</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n\n        <span class="token class-name">String</span> url <span class="token operator">=</span> <span class="token string">"http://localhost:8081/getProductInfo?productId="</span> <span class="token operator">+</span> productId<span class="token punctuation">;</span>\n        <span class="token class-name">String</span> response <span class="token operator">=</span> <span class="token class-name">HttpClientUtils</span><span class="token punctuation">.</span><span class="token function">sendGetRequest</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">return</span> <span class="token class-name">JSONObject</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> <span class="token class-name">ProductInfo</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token annotation punctuation">@Override</span>\n    <span class="token keyword">protected</span> <span class="token class-name">ProductInfo</span> <span class="token function">getFallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token class-name">ProductInfo</span> productInfo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProductInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        productInfo<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"降级商品"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">return</span> productInfo<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h5 id="断路测试类"><a href="#%E6%96%AD%E8%B7%AF%E6%B5%8B%E8%AF%95%E7%B1%BB" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>断路测试类</h5>\n<p>我们在测试类中，前 30 次请求，传入 productId = -1，然后休眠 3s，之后 70 次请求，传入 productId = 1。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="76414893355311300000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`@SpringBootTest\n@RunWith(SpringRunner.class)\npublic class CircuitBreakerTest {\n\n    @Test\n    public void testCircuitBreaker() {\n        String baseURL = &quot;http://localhost:8080/getProductInfo?productId=&quot;;\n\n        for (int i = 0; i < 30; ++i) {\n            // 传入 -1，会抛出异常，然后走降级逻辑\n            HttpClientUtils.sendGetRequest(baseURL + &quot;-1&quot;);\n        }\n\n        TimeUtils.sleep(3);\n        System.out.println(&quot;After sleeping...&quot;);\n\n        for (int i = 31; i < 100; ++i) {\n            // 传入 1，走服务正常调用\n            HttpClientUtils.sendGetRequest(baseURL + &quot;1&quot;);\n        }\n    }\n}`, `76414893355311300000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token annotation punctuation">@SpringBootTest</span>\n<span class="token annotation punctuation">@RunWith</span><span class="token punctuation">(</span><span class="token class-name">SpringRunner</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>\n<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CircuitBreakerTest</span> <span class="token punctuation">{</span>\n\n    <span class="token annotation punctuation">@Test</span>\n    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testCircuitBreaker</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token class-name">String</span> baseURL <span class="token operator">=</span> <span class="token string">"http://localhost:8080/getProductInfo?productId="</span><span class="token punctuation">;</span>\n\n        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">30</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token comment">// 传入 -1，会抛出异常，然后走降级逻辑</span>\n            <span class="token class-name">HttpClientUtils</span><span class="token punctuation">.</span><span class="token function">sendGetRequest</span><span class="token punctuation">(</span>baseURL <span class="token operator">+</span> <span class="token string">"-1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n\n        <span class="token class-name">TimeUtils</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"After sleeping..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">31</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token comment">// 传入 1，走服务正常调用</span>\n            <span class="token class-name">HttpClientUtils</span><span class="token punctuation">.</span><span class="token function">sendGetRequest</span><span class="token punctuation">(</span>baseURL <span class="token operator">+</span> <span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="测试结果"><a href="#%E6%B5%8B%E8%AF%95%E7%BB%93%E6%9E%9C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>测试结果</h4>\n<p>测试结果，我们可以明显看出系统断路与恢复的整个过程。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="70961747159934080000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`调用接口查询商品数据，productId = -1\nProductInfo(id=null, name=降级商品, price=null, pictureList=null, specification=null, service=null, color=null, size=null, shopId=null, modifiedTime=null, cityId=null, cityName=null, brandId=null, brandName=null)\n// ...\n// 这里重复打印了 20 次上面的结果\n\n\nProductInfo(id=null, name=降级商品, price=null, pictureList=null, specification=null, service=null, color=null, size=null, shopId=null, modifiedTime=null, cityId=null, cityName=null, brandId=null, brandName=null)\n// ...\n// 这里重复打印了 8 次上面的结果\n\n\n// 休眠 3s 后\n调用接口查询商品数据，productId = 1\nProductInfo(id=1, name=iphone7手机, price=5599.0, pictureList=a.jpg,b.jpg, specification=iphone7的规格, service=iphone7的售后服务, color=红色,白色,黑色, size=5.5, shopId=1, modifiedTime=2017-01-01 12:00:00, cityId=1, cityName=null, brandId=1, brandName=null)\n// ...\n// 这里重复打印了 69 次上面的结果`, `70961747159934080000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java">调用接口查询商品数据，productId <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>\n<span class="token class-name">ProductInfo</span><span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> name<span class="token operator">=</span>降级商品<span class="token punctuation">,</span> price<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> pictureList<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> specification<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> service<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> shopId<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> modifiedTime<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> cityId<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> cityName<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> brandId<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> brandName<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">)</span>\n<span class="token comment">// ...</span>\n<span class="token comment">// 这里重复打印了 20 次上面的结果</span>\n\n\n<span class="token class-name">ProductInfo</span><span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> name<span class="token operator">=</span>降级商品<span class="token punctuation">,</span> price<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> pictureList<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> specification<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> service<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> shopId<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> modifiedTime<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> cityId<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> cityName<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> brandId<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> brandName<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">)</span>\n<span class="token comment">// ...</span>\n<span class="token comment">// 这里重复打印了 8 次上面的结果</span>\n\n\n<span class="token comment">// 休眠 3s 后</span>\n调用接口查询商品数据，productId <span class="token operator">=</span> <span class="token number">1</span>\n<span class="token class-name">ProductInfo</span><span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> name<span class="token operator">=</span>iphone7手机<span class="token punctuation">,</span> price<span class="token operator">=</span><span class="token number">5599.0</span><span class="token punctuation">,</span> pictureList<span class="token operator">=</span>a<span class="token punctuation">.</span>jpg<span class="token punctuation">,</span>b<span class="token punctuation">.</span>jpg<span class="token punctuation">,</span> specification<span class="token operator">=</span>iphone7的规格<span class="token punctuation">,</span> service<span class="token operator">=</span>iphone7的售后服务<span class="token punctuation">,</span> color<span class="token operator">=</span>红色<span class="token punctuation">,</span>白色<span class="token punctuation">,</span>黑色<span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token number">5.5</span><span class="token punctuation">,</span> shopId<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> modifiedTime<span class="token operator">=</span><span class="token number">2017</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span><span class="token punctuation">,</span> cityId<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> cityName<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> brandId<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> brandName<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">)</span>\n<span class="token comment">// ...</span>\n<span class="token comment">// 这里重复打印了 69 次上面的结果</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>前 30 次请求，我们传入的 productId 为 -1，所以服务执行过程中会抛出异常。我们设置了最少 20 次请求通过断路器并且异常比例超出 40% 就触发断路。因此执行了 21 次接口调用，每次都抛异常并且走降级，21 次过后，断路器就被打开了。</p>\n<p>之后的 9 次请求，都不会执行 run() 方法，也就不会打印以下信息。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="15244084178180174000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`调用接口查询商品数据，productId = -1`, `15244084178180174000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">调用接口查询商品数据，productId = -1</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>而是直接走降级逻辑，调用 getFallback() 执行。</p>\n<p>休眠了 3s 后，我们在之后的 70 次请求中，都传入 productId 为 1。由于我们前面设置了 3000ms 过后断路器变为 half-open 状态。因此 Hystrix 会尝试执行请求，发现成功了，那么断路器关闭，之后的所有请求也都能正常调用了。</p>\n<h3 id="深入-hystrix-线程池隔离与接口限流"><a href="#%E6%B7%B1%E5%85%A5-hystrix-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E9%9A%94%E7%A6%BB%E4%B8%8E%E6%8E%A5%E5%8F%A3%E9%99%90%E6%B5%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>深入 Hystrix 线程池隔离与接口限流</h3>\n<p>前面讲了 Hystrix 的 request cache 请求缓存、fallback 优雅降级、circuit breaker 断路器快速熔断，这一讲，我们来详细说说 Hystrix 的线程池隔离与接口限流。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-09-28-12-02-15-63fa307b76f648b60f5304df4340ab1f-4a060.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 354px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 172.5988700564972%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAjCAIAAAAblL1PAAAACXBIWXMAAAsSAAALEgHS3X78AAADVUlEQVRIx3XVV1PrQAwF4Pz/38MLMzCUoYd26Qk9lFCSECCUhJvc+7FijM0YPXjWax3p6Ei7rlxcXFxeXnre3d0tLi4uLCxcX1+fnJycnZ2dnp52Op2/yT6SjUajfzmrHB8fc63X60dHR/Pz82trawcHB6IsLS0BT09Pb21t+XR4eFir1W5vb2GyEJXIsLOzw0nO19fXh4cHeJuPj492/iTjsL29jWABLDPveHl+fgbo9/tcz8/P8ex2u+/v7/EV+Zubm3IwV4H39/c3NjaazWbU0mg0rAPA4VfwcDj0rZHMpjot0M54lWfGzert7e3l5QVtPFdWVqTF3ysVLH4FPz09QSrSuplMTq+e0UgLvICjBOsCWHg8V1dXvcqpYMXT35PyQgyT/Uo7GBKcMHqjVRa9Xs8+FnwMTPTv/v5egQXwKJmFEJIDDAaD0IJs8mOBUbVatTaOX0OCnsIExgpzyFarpTzdNliQYDY3NzfNCWcSRAsqMdWeKAjRbrd5mE2v1hiKfnV15QkM6amcr5p9yDTAU0ghjDHa8qswtI3ixRLx+2AEODsx8UTYIQlY7ECCqSvOxs/MTGYlqFYVwZYQQbKTDDKk+gZrgN5Q0jqOXkyoTWrJRi1EVGRdAMPIg5UKEdOJ2dlZIdwKhlT9YFNTU9qpt0gVwD/6jKQ5icwxM+vr6yhMTk66J0LFEnBeHt2SNjyE6Cbb29vDv6B2diRDMMRIFedBHiJFOK1SSwk4TpUxoge1ZmZmtApVC4JR2JmpJhO3hDbOds2AzKTa3d01TDFYy8vLhhkRtAXiU047pkWRaAOgqot0Mq0TExNjY2Nk053MuQDuJXPoKSy/dTakKMiMl50SMOZx+2e3h2fG003EjU9hPPNgUQlGHtxqydCOq0ctomTXWEmfXX1x11Er6MHEleBTOTgvGCelxsxmyNjX4fw1xj7B9Iib0YfosFZRm85RMxgJ9dx45+/ALzC2BsiHubk5dwVhzYwQkNZGNf5VVODPzQjowuepyg5GjAoKvqmZkxJoLi43UdRiQuPXZ6eCHm5mw4SGWqbVJDpP+Su61D4vQIHjFyWJYdAq9CgkIi0GyfrJvI5yVlGV2gwwpK6q2Z+dNkjadBN4dULGx8etHbI8nf8lqIVNRF7MmwAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 09 28 12 02 15" title="" data-src="/static/2023-09-28-12-02-15-63fa307b76f648b60f5304df4340ab1f-4a060.png" data-srcset="/static/2023-09-28-12-02-15-63fa307b76f648b60f5304df4340ab1f-ca453.png 200w,\n/static/2023-09-28-12-02-15-63fa307b76f648b60f5304df4340ab1f-4a060.png 354w" data-sizes="(max-width: 354px) 100vw, 354px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>Hystrix 通过判断线程池或者信号量是否已满，超出容量的请求，直接 Reject 走降级，从而达到限流的作用。</p>\n<p>限流是限制对后端服务的访问量，比如说你对 MySQL、Redis、Zookeeper 以及其它各种后端中间件的资源的访问的限制，其实是为了避免过大的流量直接打死后端的服务。</p>\n<h4 id="线程池隔离技术的设计"><a href="#%E7%BA%BF%E7%A8%8B%E6%B1%A0%E9%9A%94%E7%A6%BB%E6%8A%80%E6%9C%AF%E7%9A%84%E8%AE%BE%E8%AE%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>线程池隔离技术的设计</h4>\n<p>Hystrix 采用了 Bulkhead Partition 舱壁隔离技术，来将外部依赖进行资源隔离，进而避免任何外部依赖的故障导致本服务崩溃。</p>\n<p>舱壁隔离，是说将船体内部空间区隔划分成若干个隔舱，一旦某几个隔舱发生破损进水，水流不会在其间相互流动，如此一来船舶在受损时，依然能具有足够的浮力和稳定性，进而减低立即沉船的危险。</p>\n<p>Hystrix 对每个外部依赖用一个单独的线程池，这样的话，如果对那个外部依赖调用延迟很严重，最多就是耗尽那个依赖自己的线程池而已，不会影响其他的依赖调用。</p>\n<h4 id="hystrix-应用线程池机制的场景"><a href="#hystrix-%E5%BA%94%E7%94%A8%E7%BA%BF%E7%A8%8B%E6%B1%A0%E6%9C%BA%E5%88%B6%E7%9A%84%E5%9C%BA%E6%99%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Hystrix 应用线程池机制的场景</h4>\n<ul>\n<li>每个服务都会调用几十个后端依赖服务，那些后端依赖服务通常是由很多不同的团队开发的。</li>\n<li>每个后端依赖服务都会提供它自己的 client 调用库，比如说用 thrift 的话，就会提供对应的 thrift 依赖。</li>\n<li>client 调用库随时会变更。</li>\n<li>client 调用库随时可能会增加新的网络请求的逻辑。</li>\n<li>client 调用库可能会包含诸如自动重试、数据解析、内存中缓存等逻辑。</li>\n<li>client 调用库一般都对调用者来说是个黑盒，包括实现细节、网络访问、默认配置等等。</li>\n<li>在真实的生产环境中，经常会出现调用者，突然间惊讶的发现，client 调用库发生了某些变化。</li>\n<li>即使 client 调用库没有改变，依赖服务本身可能会发生逻辑上的变化。</li>\n<li>有些依赖的 client 调用库可能还会拉取其他的依赖库，而且可能那些依赖库配置的不正确。</li>\n<li>大多数网络请求都是同步调用的。</li>\n<li>调用失败和延迟，也有可能会发生在 client 调用库本身的代码中，不一定就是发生在网络请求中。</li>\n</ul>\n<p>简单来说，就是你必须默认 client 调用库很不靠谱，而且随时可能发生各种变化，所以就要用强制隔离的方式来确保任何服务的故障不会影响当前服务。</p>\n<h4 id="线程池机制的优点"><a href="#%E7%BA%BF%E7%A8%8B%E6%B1%A0%E6%9C%BA%E5%88%B6%E7%9A%84%E4%BC%98%E7%82%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>线程池机制的优点</h4>\n<ul>\n<li>任何一个依赖服务都可以被隔离在自己的线程池内，即使自己的线程池资源填满了，也不会影响任何其他的服务调用。</li>\n<li>服务可以随时引入一个新的依赖服务，因为即使这个新的依赖服务有问题，也不会影响其他任何服务的调用。</li>\n<li>当一个故障的依赖服务重新变好的时候，可以通过清理掉线程池，瞬间恢复该服务的调用，而如果是 tomcat 线程池被占满，再恢复就很麻烦。</li>\n<li>如果一个 client 调用库配置有问题，线程池的健康状况随时会报告，比如成功 / 失败 / 拒绝 / 超时的次数统计，然后可以近实时热修改依赖服务的调用配置，而不用停机。</li>\n<li>基于线程池的异步本质，可以在同步的调用之上，构建一层异步调用层。</li>\n</ul>\n<p>简单来说，最大的好处，就是资源隔离，确保说任何一个依赖服务故障，不会拖垮当前的这个服务。</p>\n<h4 id="线程池机制的缺点"><a href="#%E7%BA%BF%E7%A8%8B%E6%B1%A0%E6%9C%BA%E5%88%B6%E7%9A%84%E7%BC%BA%E7%82%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>线程池机制的缺点</h4>\n<ul>\n<li>线程池机制最大的缺点就是增加了 CPU 的开销。除了 tomcat 本身的调用线程之外，还有 Hystrix 自己管理的线程池。</li>\n<li>每个 command 的执行都依托一个独立的线程，会进行排队，调度，还有上下文切换。</li>\n<li>Hystrix 官方自己做了一个多线程异步带来的额外开销统计，通过对比多线程异步调用 + 同步调用得出，Netflix API 每天通过 Hystrix 执行 10 亿次调用，每个服务实例有 40 个以上的线程池，每个线程池有 10 个左右的线程。最后发现说，用 Hystrix 的额外开销，就是给请求带来了 3ms 左右的延时，最多延时在 10ms 以内，相比于可用性和稳定性的提升，这是可以接受的。</li>\n</ul>\n<p>我们可以用 Hystrix semaphore 技术来实现对某个依赖服务的并发访问量的限制，而不是通过线程池 / 队列的大小来限制流量。</p>\n<p>semaphore 技术可以用来限流和削峰，但是不能用来对调用延迟的服务进行 timeout 和隔离。</p>\n<p>execution.isolation.strategy 设置为 SEMAPHORE，那么 Hystrix 就会用 semaphore 机制来替代线程池机制，来对依赖服务的访问进行限流。如果通过 semaphore 调用的时候，底层的网络调用延迟很严重，那么是无法 timeout 的，只能一直 block 住。一旦请求数量超过了 semaphore 限定的数量之后，就会立即开启限流。</p>\n<h4 id="接口限流-demo"><a href="#%E6%8E%A5%E5%8F%A3%E9%99%90%E6%B5%81-demo" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>接口限流 Demo</h4>\n<p>假设一个线程池大小为 8，等待队列的大小为 10。timeout 时长我们设置长一些，20s。</p>\n<p>在 command 内部，写死代码，做一个 sleep，比如 sleep 3s。</p>\n<ul>\n<li>withCoreSize：设置线程池大小。</li>\n<li>withMaxQueueSize：设置等待队列大小。</li>\n<li>withQueueSizeRejectionThreshold：这个与 withMaxQueueSize 配合使用，等待队列的大小，取得是这两个参数的较小值。</li>\n</ul>\n<p>如果只设置了线程池大小，另外两个 queue 相关参数没有设置的话，等待队列是处于关闭的状态。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="51662006353694690000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public class GetProductInfoCommand extends HystrixCommand<ProductInfo> {\n\n    private Long productId;\n\n    private static final HystrixCommandKey KEY = HystrixCommandKey.Factory.asKey(&quot;GetProductInfoCommand&quot;);\n\n    public GetProductInfoCommand(Long productId) {\n        super(Setter.withGroupKey(HystrixCommandGroupKey.Factory.asKey(&quot;ProductInfoService&quot;))\n                .andCommandKey(KEY)\n                // 线程池相关配置信息\n                .andThreadPoolPropertiesDefaults(HystrixThreadPoolProperties.Setter()\n                        // 设置线程池大小为 8\n                        .withCoreSize(8)\n                        // 设置等待队列大小为 10\n                        .withMaxQueueSize(10)\n                        .withQueueSizeRejectionThreshold(12))\n                .andCommandPropertiesDefaults(HystrixCommandProperties.Setter()\n                        .withCircuitBreakerEnabled(true)\n                        .withCircuitBreakerRequestVolumeThreshold(20)\n                        .withCircuitBreakerErrorThresholdPercentage(40)\n                        .withCircuitBreakerSleepWindowInMilliseconds(3000)\n                        // 设置超时时间\n                        .withExecutionTimeoutInMilliseconds(20000)\n                        // 设置 fallback 最大请求并发数\n                        .withFallbackIsolationSemaphoreMaxConcurrentRequests(30)));\n        this.productId = productId;\n    }\n\n    @Override\n    protected ProductInfo run() throws Exception {\n        System.out.println(&quot;调用接口查询商品数据，productId =&quot; + productId);\n\n        if (productId == -1L) {\n            throw new Exception();\n        }\n\n        // 请求过来，会在这里hang住3秒钟\n        if (productId == -2L) {\n            TimeUtils.sleep(3);\n        }\n\n        String url = &quot;http://localhost:8081/getProductInfo?productId=&quot; + productId;\n        String response = HttpClientUtils.sendGetRequest(url);\n        System.out.println(response);\n        return JSONObject.parseObject(response, ProductInfo.class);\n    }\n\n    @Override\n    protected ProductInfo getFallback() {\n        ProductInfo productInfo = new ProductInfo();\n        productInfo.setName(&quot;降级商品&quot;);\n        return productInfo;\n    }\n}`, `51662006353694690000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GetProductInfoCommand</span> <span class="token keyword">extends</span> <span class="token class-name">HystrixCommand</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ProductInfo</span><span class="token punctuation">></span></span> <span class="token punctuation">{</span>\n\n    <span class="token keyword">private</span> <span class="token class-name">Long</span> productId<span class="token punctuation">;</span>\n\n    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">HystrixCommandKey</span> KEY <span class="token operator">=</span> <span class="token class-name">HystrixCommandKey</span><span class="token punctuation">.</span><span class="token class-name">Factory</span><span class="token punctuation">.</span><span class="token function">asKey</span><span class="token punctuation">(</span><span class="token string">"GetProductInfoCommand"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">public</span> <span class="token class-name">GetProductInfoCommand</span><span class="token punctuation">(</span><span class="token class-name">Long</span> productId<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token class-name">Setter</span><span class="token punctuation">.</span><span class="token function">withGroupKey</span><span class="token punctuation">(</span><span class="token class-name">HystrixCommandGroupKey</span><span class="token punctuation">.</span><span class="token class-name">Factory</span><span class="token punctuation">.</span><span class="token function">asKey</span><span class="token punctuation">(</span><span class="token string">"ProductInfoService"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n                <span class="token punctuation">.</span><span class="token function">andCommandKey</span><span class="token punctuation">(</span>KEY<span class="token punctuation">)</span>\n                <span class="token comment">// 线程池相关配置信息</span>\n                <span class="token punctuation">.</span><span class="token function">andThreadPoolPropertiesDefaults</span><span class="token punctuation">(</span><span class="token class-name">HystrixThreadPoolProperties</span><span class="token punctuation">.</span><span class="token class-name">Setter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n                        <span class="token comment">// 设置线程池大小为 8</span>\n                        <span class="token punctuation">.</span><span class="token function">withCoreSize</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span>\n                        <span class="token comment">// 设置等待队列大小为 10</span>\n                        <span class="token punctuation">.</span><span class="token function">withMaxQueueSize</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>\n                        <span class="token punctuation">.</span><span class="token function">withQueueSizeRejectionThreshold</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n                <span class="token punctuation">.</span><span class="token function">andCommandPropertiesDefaults</span><span class="token punctuation">(</span><span class="token class-name">HystrixCommandProperties</span><span class="token punctuation">.</span><span class="token class-name">Setter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n                        <span class="token punctuation">.</span><span class="token function">withCircuitBreakerEnabled</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>\n                        <span class="token punctuation">.</span><span class="token function">withCircuitBreakerRequestVolumeThreshold</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>\n                        <span class="token punctuation">.</span><span class="token function">withCircuitBreakerErrorThresholdPercentage</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span>\n                        <span class="token punctuation">.</span><span class="token function">withCircuitBreakerSleepWindowInMilliseconds</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span>\n                        <span class="token comment">// 设置超时时间</span>\n                        <span class="token punctuation">.</span><span class="token function">withExecutionTimeoutInMilliseconds</span><span class="token punctuation">(</span><span class="token number">20000</span><span class="token punctuation">)</span>\n                        <span class="token comment">// 设置 fallback 最大请求并发数</span>\n                        <span class="token punctuation">.</span><span class="token function">withFallbackIsolationSemaphoreMaxConcurrentRequests</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">this</span><span class="token punctuation">.</span>productId <span class="token operator">=</span> productId<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token annotation punctuation">@Override</span>\n    <span class="token keyword">protected</span> <span class="token class-name">ProductInfo</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>\n        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"调用接口查询商品数据，productId ="</span> <span class="token operator">+</span> productId<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>productId <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1L</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n\n        <span class="token comment">// 请求过来，会在这里hang住3秒钟</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>productId <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">2L</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token class-name">TimeUtils</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n\n        <span class="token class-name">String</span> url <span class="token operator">=</span> <span class="token string">"http://localhost:8081/getProductInfo?productId="</span> <span class="token operator">+</span> productId<span class="token punctuation">;</span>\n        <span class="token class-name">String</span> response <span class="token operator">=</span> <span class="token class-name">HttpClientUtils</span><span class="token punctuation">.</span><span class="token function">sendGetRequest</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">return</span> <span class="token class-name">JSONObject</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> <span class="token class-name">ProductInfo</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token annotation punctuation">@Override</span>\n    <span class="token keyword">protected</span> <span class="token class-name">ProductInfo</span> <span class="token function">getFallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token class-name">ProductInfo</span> productInfo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProductInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        productInfo<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"降级商品"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">return</span> productInfo<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们模拟 25 个请求。前 8 个请求，调用接口时会直接被 hang 住 3s，那么后面的 10 个请求会先进入等待队列中等待前面的请求执行完毕。最后的 7 个请求过来，会直接被 reject，调用 fallback 降级逻辑。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="69040080072886575000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`@SpringBootTest\n@RunWith(SpringRunner.class)\npublic class RejectTest {\n\n    @Test\n    public void testReject() {\n        for (int i = 0; i < 25; ++i) {\n            new Thread(() -> HttpClientUtils.sendGetRequest(&quot;http://localhost:8080/getProductInfo?productId=-2&quot;)).start();\n        }\n        // 防止主线程提前结束执行\n        TimeUtils.sleep(50);\n    }\n}`, `69040080072886575000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token annotation punctuation">@SpringBootTest</span>\n<span class="token annotation punctuation">@RunWith</span><span class="token punctuation">(</span><span class="token class-name">SpringRunner</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>\n<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RejectTest</span> <span class="token punctuation">{</span>\n\n    <span class="token annotation punctuation">@Test</span>\n    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testReject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">25</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name">HttpClientUtils</span><span class="token punctuation">.</span><span class="token function">sendGetRequest</span><span class="token punctuation">(</span><span class="token string">"http://localhost:8080/getProductInfo?productId=-2"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n        <span class="token comment">// 防止主线程提前结束执行</span>\n        <span class="token class-name">TimeUtils</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>从执行结果中，我们可以明显看出一共打印出了 7 个降级商品。这也就是请求数超过线程池 + 队列的数量而直接被 reject 的结果。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="51332548772730410000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`ProductInfo(id=null, name=降级商品, price=null, pictureList=null, specification=null, service=null, color=null, size=null, shopId=null, modifiedTime=null, cityId=null, cityName=null, brandId=null, brandName=null)\nProductInfo(id=null, name=降级商品, price=null, pictureList=null, specification=null, service=null, color=null, size=null, shopId=null, modifiedTime=null, cityId=null, cityName=null, brandId=null, brandName=null)\nProductInfo(id=null, name=降级商品, price=null, pictureList=null, specification=null, service=null, color=null, size=null, shopId=null, modifiedTime=null, cityId=null, cityName=null, brandId=null, brandName=null)\nProductInfo(id=null, name=降级商品, price=null, pictureList=null, specification=null, service=null, color=null, size=null, shopId=null, modifiedTime=null, cityId=null, cityName=null, brandId=null, brandName=null)\nProductInfo(id=null, name=降级商品, price=null, pictureList=null, specification=null, service=null, color=null, size=null, shopId=null, modifiedTime=null, cityId=null, cityName=null, brandId=null, brandName=null)\nProductInfo(id=null, name=降级商品, price=null, pictureList=null, specification=null, service=null, color=null, size=null, shopId=null, modifiedTime=null, cityId=null, cityName=null, brandId=null, brandName=null)\n调用接口查询商品数据，productId = -2\n调用接口查询商品数据，productId = -2\n调用接口查询商品数据，productId = -2\n调用接口查询商品数据，productId = -2\n调用接口查询商品数据，productId = -2\n调用接口查询商品数据，productId = -2\n调用接口查询商品数据，productId = -2\n调用接口查询商品数据，productId = -2\nProductInfo(id=null, name=降级商品, price=null, pictureList=null, specification=null, service=null, color=null, size=null, shopId=null, modifiedTime=null, cityId=null, cityName=null, brandId=null, brandName=null)\n{&quot;id&quot;: -2, &quot;name&quot;: &quot;iphone7手机&quot;, &quot;price&quot;: 5599, &quot;pictureList&quot;:&quot;a.jpg,b.jpg&quot;, &quot;specification&quot;: &quot;iphone7的规格&quot;, &quot;service&quot;: &quot;iphone7的售后服务&quot;, &quot;color&quot;: &quot;红色,白色,黑色&quot;, &quot;size&quot;: &quot;5.5&quot;, &quot;shopId&quot;: 1, &quot;modifiedTime&quot;: &quot;2017-01-01 12:00:00&quot;, &quot;cityId&quot;: 1, &quot;brandId&quot;: 1}\n// 后面都是一些正常的商品信息，就不贴出来了\n// ...`, `51332548772730410000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">ProductInfo(id=null, name=降级商品, price=null, pictureList=null, specification=null, service=null, color=null, size=null, shopId=null, modifiedTime=null, cityId=null, cityName=null, brandId=null, brandName=null)\nProductInfo(id=null, name=降级商品, price=null, pictureList=null, specification=null, service=null, color=null, size=null, shopId=null, modifiedTime=null, cityId=null, cityName=null, brandId=null, brandName=null)\nProductInfo(id=null, name=降级商品, price=null, pictureList=null, specification=null, service=null, color=null, size=null, shopId=null, modifiedTime=null, cityId=null, cityName=null, brandId=null, brandName=null)\nProductInfo(id=null, name=降级商品, price=null, pictureList=null, specification=null, service=null, color=null, size=null, shopId=null, modifiedTime=null, cityId=null, cityName=null, brandId=null, brandName=null)\nProductInfo(id=null, name=降级商品, price=null, pictureList=null, specification=null, service=null, color=null, size=null, shopId=null, modifiedTime=null, cityId=null, cityName=null, brandId=null, brandName=null)\nProductInfo(id=null, name=降级商品, price=null, pictureList=null, specification=null, service=null, color=null, size=null, shopId=null, modifiedTime=null, cityId=null, cityName=null, brandId=null, brandName=null)\n调用接口查询商品数据，productId = -2\n调用接口查询商品数据，productId = -2\n调用接口查询商品数据，productId = -2\n调用接口查询商品数据，productId = -2\n调用接口查询商品数据，productId = -2\n调用接口查询商品数据，productId = -2\n调用接口查询商品数据，productId = -2\n调用接口查询商品数据，productId = -2\nProductInfo(id=null, name=降级商品, price=null, pictureList=null, specification=null, service=null, color=null, size=null, shopId=null, modifiedTime=null, cityId=null, cityName=null, brandId=null, brandName=null)\n{&quot;id&quot;: -2, &quot;name&quot;: &quot;iphone7手机&quot;, &quot;price&quot;: 5599, &quot;pictureList&quot;:&quot;a.jpg,b.jpg&quot;, &quot;specification&quot;: &quot;iphone7的规格&quot;, &quot;service&quot;: &quot;iphone7的售后服务&quot;, &quot;color&quot;: &quot;红色,白色,黑色&quot;, &quot;size&quot;: &quot;5.5&quot;, &quot;shopId&quot;: 1, &quot;modifiedTime&quot;: &quot;2017-01-01 12:00:00&quot;, &quot;cityId&quot;: 1, &quot;brandId&quot;: 1}\n// 后面都是一些正常的商品信息，就不贴出来了\n// ...</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="基于-timeout-机制为服务接口调用超时提供安全保护"><a href="#%E5%9F%BA%E4%BA%8E-timeout-%E6%9C%BA%E5%88%B6%E4%B8%BA%E6%9C%8D%E5%8A%A1%E6%8E%A5%E5%8F%A3%E8%B0%83%E7%94%A8%E8%B6%85%E6%97%B6%E6%8F%90%E4%BE%9B%E5%AE%89%E5%85%A8%E4%BF%9D%E6%8A%A4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>基于 timeout 机制为服务接口调用超时提供安全保护</h3>\n<p>一般来说，在调用依赖服务的接口的时候，比较常见的一个问题就是超时。超时是在一个复杂的分布式系统中，系统不稳定，或者系统抖动的现象。出现大量超时，线程资源会被 hang 死，从而导致吞吐量大幅度下降，甚至服务崩溃。</p>\n<p>你去调用各种各样的依赖服务，特别是在大公司，你甚至都不认识开发一个服务的人，你都不知道那个人的技术水平怎么样，对那个人根本不了解。</p>\n<p>Peter Steiner 说过，<code class="language-text">On the Internet, nobody knows you&#39;re a dog</code>，也就是说在互联网的另外一头，你都不知道甚至坐着一条狗。</p>\n<p>像特别复杂的分布式系统，特别是在大公司里，多个团队、大型协作，你可能都不知道服务是谁的，很可能说开发服务的那个哥儿们甚至是一个实习生。依赖服务的接口性能可能很不稳定，有时候 2ms，有时候 200ms，甚至 2s，都有可能。</p>\n<p>如果你不对各种依赖服务接口的调用做超时控制，来给你的服务提供安全保护措施，那么很可能你的服务就被各种垃圾的依赖服务的性能给拖死了。大量的接口调用很慢，大量的线程被卡死。如果你做了资源的隔离，那么也就是线程池的线程被卡死，但其实我们可以做超时控制，没必要让它们全卡死。</p>\n<h4 id="timeoutmilliseconds"><a href="#timeoutmilliseconds" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>TimeoutMilliseconds</h4>\n<p>在 Hystrix 中，我们可以手动设置 timeout 时长，如果一个 command 运行时间超过了设定的时长，那么就被认为是 timeout，然后 Hystrix command 标识为 timeout，同时执行 fallback 降级逻辑。</p>\n<p>TimeoutMilliseconds 默认值是 1000，也就是 1000ms。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="70128775980021030000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`HystrixCommandProperties.Setter()\n    ..withExecutionTimeoutInMilliseconds(int)`, `70128775980021030000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token class-name">HystrixCommandProperties</span><span class="token punctuation">.</span><span class="token class-name">Setter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token function">withExecutionTimeoutInMilliseconds</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<h4 id="timeoutenabled"><a href="#timeoutenabled" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>TimeoutEnabled</h4>\n<p>这个参数用于控制是否要打开 timeout 机制，默认值是 true。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="25259215356954632000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`HystrixCommandProperties.Setter()\n    .withExecutionTimeoutEnabled(boolean)`, `25259215356954632000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token class-name">HystrixCommandProperties</span><span class="token punctuation">.</span><span class="token class-name">Setter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">withExecutionTimeoutEnabled</span><span class="token punctuation">(</span><span class="token keyword">boolean</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<h4 id="实例-demo-1"><a href="#%E5%AE%9E%E4%BE%8B-demo-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>实例 Demo</h4>\n<p>我们在 command 中，将超时时间设置为 500ms，然后在 run() 方法中，设置休眠时间 1s，这样一个请求过来，直接休眠 1s，结果就会因为超时而执行降级逻辑。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="88435079847918100000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public class GetProductInfoCommand extends HystrixCommand<ProductInfo> {\n\n    private Long productId;\n\n    private static final HystrixCommandKey KEY = HystrixCommandKey.Factory.asKey(&quot;GetProductInfoCommand&quot;);\n\n    public GetProductInfoCommand(Long productId) {\n        super(Setter.withGroupKey(HystrixCommandGroupKey.Factory.asKey(&quot;ProductInfoService&quot;))\n                .andCommandKey(KEY)\n                .andThreadPoolPropertiesDefaults(HystrixThreadPoolProperties.Setter()\n                        .withCoreSize(8)\n                        .withMaxQueueSize(10)\n                        .withQueueSizeRejectionThreshold(8))\n                .andCommandPropertiesDefaults(HystrixCommandProperties.Setter()\n                        .withCircuitBreakerEnabled(true)\n                        .withCircuitBreakerRequestVolumeThreshold(20)\n                        .withCircuitBreakerErrorThresholdPercentage(40)\n                        .withCircuitBreakerSleepWindowInMilliseconds(3000)\n                        // 设置是否打开超时，默认是 true\n                        .withExecutionTimeoutEnabled(true)\n                        // 设置超时时间，默认 1000(ms)\n                        .withExecutionTimeoutInMilliseconds(500)\n                        .withFallbackIsolationSemaphoreMaxConcurrentRequests(30)));\n        this.productId = productId;\n    }\n\n    @Override\n    protected ProductInfo run() throws Exception {\n        System.out.println(&quot;调用接口查询商品数据，productId =&quot; + productId);\n\n        // 休眠1s\n        TimeUtils.sleep(1);\n\n        String url = &quot;http://localhost:8081/getProductInfo?productId=&quot; + productId;\n        String response = HttpClientUtils.sendGetRequest(url);\n        System.out.println(response);\n        return JSONObject.parseObject(response, ProductInfo.class);\n    }\n\n    @Override\n    protected ProductInfo getFallback() {\n        ProductInfo productInfo = new ProductInfo();\n        productInfo.setName(&quot;降级商品&quot;);\n        return productInfo;\n    }\n}`, `88435079847918100000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GetProductInfoCommand</span> <span class="token keyword">extends</span> <span class="token class-name">HystrixCommand</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ProductInfo</span><span class="token punctuation">></span></span> <span class="token punctuation">{</span>\n\n    <span class="token keyword">private</span> <span class="token class-name">Long</span> productId<span class="token punctuation">;</span>\n\n    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">HystrixCommandKey</span> KEY <span class="token operator">=</span> <span class="token class-name">HystrixCommandKey</span><span class="token punctuation">.</span><span class="token class-name">Factory</span><span class="token punctuation">.</span><span class="token function">asKey</span><span class="token punctuation">(</span><span class="token string">"GetProductInfoCommand"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">public</span> <span class="token class-name">GetProductInfoCommand</span><span class="token punctuation">(</span><span class="token class-name">Long</span> productId<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token class-name">Setter</span><span class="token punctuation">.</span><span class="token function">withGroupKey</span><span class="token punctuation">(</span><span class="token class-name">HystrixCommandGroupKey</span><span class="token punctuation">.</span><span class="token class-name">Factory</span><span class="token punctuation">.</span><span class="token function">asKey</span><span class="token punctuation">(</span><span class="token string">"ProductInfoService"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n                <span class="token punctuation">.</span><span class="token function">andCommandKey</span><span class="token punctuation">(</span>KEY<span class="token punctuation">)</span>\n                <span class="token punctuation">.</span><span class="token function">andThreadPoolPropertiesDefaults</span><span class="token punctuation">(</span><span class="token class-name">HystrixThreadPoolProperties</span><span class="token punctuation">.</span><span class="token class-name">Setter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n                        <span class="token punctuation">.</span><span class="token function">withCoreSize</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span>\n                        <span class="token punctuation">.</span><span class="token function">withMaxQueueSize</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>\n                        <span class="token punctuation">.</span><span class="token function">withQueueSizeRejectionThreshold</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n                <span class="token punctuation">.</span><span class="token function">andCommandPropertiesDefaults</span><span class="token punctuation">(</span><span class="token class-name">HystrixCommandProperties</span><span class="token punctuation">.</span><span class="token class-name">Setter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n                        <span class="token punctuation">.</span><span class="token function">withCircuitBreakerEnabled</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>\n                        <span class="token punctuation">.</span><span class="token function">withCircuitBreakerRequestVolumeThreshold</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>\n                        <span class="token punctuation">.</span><span class="token function">withCircuitBreakerErrorThresholdPercentage</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span>\n                        <span class="token punctuation">.</span><span class="token function">withCircuitBreakerSleepWindowInMilliseconds</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span>\n                        <span class="token comment">// 设置是否打开超时，默认是 true</span>\n                        <span class="token punctuation">.</span><span class="token function">withExecutionTimeoutEnabled</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>\n                        <span class="token comment">// 设置超时时间，默认 1000(ms)</span>\n                        <span class="token punctuation">.</span><span class="token function">withExecutionTimeoutInMilliseconds</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span>\n                        <span class="token punctuation">.</span><span class="token function">withFallbackIsolationSemaphoreMaxConcurrentRequests</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">this</span><span class="token punctuation">.</span>productId <span class="token operator">=</span> productId<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token annotation punctuation">@Override</span>\n    <span class="token keyword">protected</span> <span class="token class-name">ProductInfo</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>\n        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"调用接口查询商品数据，productId ="</span> <span class="token operator">+</span> productId<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        <span class="token comment">// 休眠1s</span>\n        <span class="token class-name">TimeUtils</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        <span class="token class-name">String</span> url <span class="token operator">=</span> <span class="token string">"http://localhost:8081/getProductInfo?productId="</span> <span class="token operator">+</span> productId<span class="token punctuation">;</span>\n        <span class="token class-name">String</span> response <span class="token operator">=</span> <span class="token class-name">HttpClientUtils</span><span class="token punctuation">.</span><span class="token function">sendGetRequest</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">return</span> <span class="token class-name">JSONObject</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> <span class="token class-name">ProductInfo</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token annotation punctuation">@Override</span>\n    <span class="token keyword">protected</span> <span class="token class-name">ProductInfo</span> <span class="token function">getFallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token class-name">ProductInfo</span> productInfo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProductInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        productInfo<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"降级商品"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">return</span> productInfo<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在测试类中，我们直接发起请求。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="98321719883337470000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`@SpringBootTest\n@RunWith(SpringRunner.class)\npublic class TimeoutTest {\n\n    @Test\n    public void testTimeout() {\n        HttpClientUtils.sendGetRequest(&quot;http://localhost:8080/getProductInfo?productId=1&quot;);\n    }\n}`, `98321719883337470000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token annotation punctuation">@SpringBootTest</span>\n<span class="token annotation punctuation">@RunWith</span><span class="token punctuation">(</span><span class="token class-name">SpringRunner</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>\n<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TimeoutTest</span> <span class="token punctuation">{</span>\n\n    <span class="token annotation punctuation">@Test</span>\n    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token class-name">HttpClientUtils</span><span class="token punctuation">.</span><span class="token function">sendGetRequest</span><span class="token punctuation">(</span><span class="token string">"http://localhost:8080/getProductInfo?productId=1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>结果中可以看到，打印出了降级商品相关信息。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="57110315401996910000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`ProductInfo(id=null, name=降级商品, price=null, pictureList=null, specification=null, service=null, color=null, size=null, shopId=null, modifiedTime=null, cityId=null, cityName=null, brandId=null, brandName=null)\n{&quot;id&quot;: 1, &quot;name&quot;: &quot;iphone7手机&quot;, &quot;price&quot;: 5599, &quot;pictureList&quot;:&quot;a.jpg,b.jpg&quot;, &quot;specification&quot;: &quot;iphone7的规格&quot;, &quot;service&quot;: &quot;iphone7的售后服务&quot;, &quot;color&quot;: &quot;红色,白色,黑色&quot;, &quot;size&quot;: &quot;5.5&quot;, &quot;shopId&quot;: 1, &quot;modifiedTime&quot;: &quot;2017-01-01 12:00:00&quot;, &quot;cityId&quot;: 1, &quot;brandId&quot;: 1}`, `57110315401996910000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">ProductInfo(id=null, name=降级商品, price=null, pictureList=null, specification=null, service=null, color=null, size=null, shopId=null, modifiedTime=null, cityId=null, cityName=null, brandId=null, brandName=null)\n{&quot;id&quot;: 1, &quot;name&quot;: &quot;iphone7手机&quot;, &quot;price&quot;: 5599, &quot;pictureList&quot;:&quot;a.jpg,b.jpg&quot;, &quot;specification&quot;: &quot;iphone7的规格&quot;, &quot;service&quot;: &quot;iphone7的售后服务&quot;, &quot;color&quot;: &quot;红色,白色,黑色&quot;, &quot;size&quot;: &quot;5.5&quot;, &quot;shopId&quot;: 1, &quot;modifiedTime&quot;: &quot;2017-01-01 12:00:00&quot;, &quot;cityId&quot;: 1, &quot;brandId&quot;: 1}</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<h2 id="高可用系统"><a href="#%E9%AB%98%E5%8F%AF%E7%94%A8%E7%B3%BB%E7%BB%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>高可用系统</h2>\n<h3 id="如何设计一个高可用系统？"><a href="#%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1%E4%B8%80%E4%B8%AA%E9%AB%98%E5%8F%AF%E7%94%A8%E7%B3%BB%E7%BB%9F%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>如何设计一个高可用系统？</h3>\n<h2 id="限流"><a href="#%E9%99%90%E6%B5%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>限流</h2>\n<h3 id="如何限流？说一下具体的实现？"><a href="#%E5%A6%82%E4%BD%95%E9%99%90%E6%B5%81%EF%BC%9F%E8%AF%B4%E4%B8%80%E4%B8%8B%E5%85%B7%E4%BD%93%E7%9A%84%E5%AE%9E%E7%8E%B0%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>如何限流？说一下具体的实现？</h3>\n<blockquote>\n<p>限流可以认为服务降级的一种，限流就是限制系统的输入和输出流量以达到保护系统的目的。一般来说系统的吞吐量是可以被测算的，为了保证系统的稳定运行，一旦达到需要限制的阈值，就需要限制流量并采取一些措施以完成限制流量的目的。比如：延迟处理，拒绝处理，或者部分拒绝处理等等。</p>\n</blockquote>\n<h4 id="限流方法"><a href="#%E9%99%90%E6%B5%81%E6%96%B9%E6%B3%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>限流方法</h4>\n<h5 id="计数器"><a href="#%E8%AE%A1%E6%95%B0%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>计数器</h5>\n<p>控制单位时间内的请求数量。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="17441803772297026000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import java.util.concurrent.atomic.AtomicInteger;\n\npublic class Counter {\n    /**\n     * 最大访问数量\n     */\n    private final int limit = 10;\n    /**\n     * 访问时间差\n     */\n    private final long timeout = 1000;\n    /**\n     * 请求时间\n     */\n    private long time;\n    /**\n     * 当前计数器\n     */\n    private AtomicInteger reqCount = new AtomicInteger(0);\n\n    public boolean limit() {\n        long now = System.currentTimeMillis();\n        if (now < time + timeout) {\n            // 单位时间内\n            reqCount.addAndGet(1);\n            return reqCount.get() <= limit;\n        } else {\n            // 超出单位时间\n            time = now;\n            reqCount = new AtomicInteger(0);\n            return true;\n        }\n    }\n}`, `17441803772297026000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>atomic</span><span class="token punctuation">.</span><span class="token class-name">AtomicInteger</span><span class="token punctuation">;</span>\n\n<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Counter</span> <span class="token punctuation">{</span>\n    <span class="token comment">/**\n     * 最大访问数量\n     */</span>\n    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> limit <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>\n    <span class="token comment">/**\n     * 访问时间差\n     */</span>\n    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> timeout <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span>\n    <span class="token comment">/**\n     * 请求时间\n     */</span>\n    <span class="token keyword">private</span> <span class="token keyword">long</span> time<span class="token punctuation">;</span>\n    <span class="token comment">/**\n     * 当前计数器\n     */</span>\n    <span class="token keyword">private</span> <span class="token class-name">AtomicInteger</span> reqCount <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">limit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">long</span> now <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>now <span class="token operator">&lt;</span> time <span class="token operator">+</span> timeout<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token comment">// 单位时间内</span>\n            reqCount<span class="token punctuation">.</span><span class="token function">addAndGet</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token keyword">return</span> reqCount<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> limit<span class="token punctuation">;</span>\n        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n            <span class="token comment">// 超出单位时间</span>\n            time <span class="token operator">=</span> now<span class="token punctuation">;</span>\n            reqCount <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>劣势：</p>\n<p>假设在 00:01 时发生一个请求，在 <code class="language-text">00:01 - 00:58</code> 之间不在发送请求，在 00:59 时发送剩下的所有请求 n-1 (n 为限流请求数量)，在下一分钟的 00:01 发送 n 个请求，这样在 2 秒钟内请求到达了 2n - 1 个。</p>\n<p>设每分钟请求数量为 60 个，每秒可以处理 1 个请求，用户在 00:59 发送 60 个请求，在 01:00 发送 60 个请求 此时 2 秒钟有 120 个请求(每秒 60 个请求)，远远大于了每秒钟处理数量的阈值。</p>\n<h5 id="滑动窗口"><a href="#%E6%BB%91%E5%8A%A8%E7%AA%97%E5%8F%A3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>滑动窗口</h5>\n<p>滑动窗口是对计数器方式的改进，增加一个时间粒度的度量单位，把一分钟分成若干等分（6 份，每份 10 秒），在每一份上设置独立计数器，在 <code class="language-text">00:00 - 00:09</code> 之间发生请求计数器累加 1，当等分数量越大限流统计就越详细。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="23298992337483960000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`package com.example.demo1.service;\n\nimport java.util.Iterator;\nimport java.util.Random;\nimport java.util.concurrent.ConcurrentLinkedQueue;\nimport java.util.stream.IntStream;\n\npublic class TimeWindow {\n    private ConcurrentLinkedQueue<Long> queue = new ConcurrentLinkedQueue<Long>();\n\n    /**\n     * 间隔秒数\n     */\n    private int seconds;\n\n    /**\n     * 最大限流\n     */\n    private int max;\n\n    public TimeWindow(int max, int seconds) {\n        this.seconds = seconds;\n        this.max = max;\n\n        /**\n         * 永续线程执行清理 queue 任务\n         */\n        new Thread(() -> {\n            while (true) {\n                try {\n                    // 等待间隔秒数 - 1 执行清理操作\n                    Thread.sleep((seconds - 1) * 1000L);\n                } catch (InterruptedException e) {\n                    e.printStackTrace();\n                }\n                clean();\n            }\n        }).start();\n\n    }\n\n    public static void main(String[] args) throws Exception {\n        final TimeWindow timeWindow = new TimeWindow(10， 1);\n\n        // 测试 3 个线程\n        IntStream.range(0， 3).forEach((i) -> {\n            new Thread(() -> {\n                while (true) {\n                    try {\n                        Thread.sleep(new Random().nextInt(20) * 100);\n                    } catch (InterruptedException e) {\n                        e.printStackTrace();\n                    }\n                    timeWindow.take();\n                }\n            }).start();\n        });\n    }\n\n    /**\n     * 获取令牌，并且添加时间\n     */\n    public void take() {\n        long start = System.currentTimeMillis();\n        try {\n            int size = sizeOfValid();\n            if (size > max) {\n                System.err.println(&quot;超限&quot;);\n            }\n            synchronized (queue) {\n                if (sizeOfValid() > max) {\n                    System.err.println(&quot;超限&quot;);\n                    System.err.println(&quot;queue 中有 &quot; + queue.size() + &quot; 最大数量 &quot; + max);\n                }\n                this.queue.offer(System.currentTimeMillis());\n            }\n            System.out.println(&quot;queue 中有 &quot; + queue.size() + &quot; 最大数量 &quot; + max);\n        }\n    }\n\n    public int sizeOfValid() {\n        Iterator<Long> it = queue.iterator();\n        Long ms = System.currentTimeMillis() - seconds * 1000;\n        int count = 0;\n        while (it.hasNext()) {\n            long t = it.next();\n            if (t > ms) {\n                // 在当前的统计时间范围内\n                count++;\n            }\n        }\n        return count;\n    }\n\n    /**\n     * 清理过期的时间\n     */\n    public void clean() {\n        Long c = System.currentTimeMillis() - seconds * 1000;\n\n        Long tl = null;\n        while ((tl = queue.peek()) != null && tl < c) {\n            System.out.println(&quot;清理数据&quot;);\n            queue.poll();\n        }\n    }\n\n}`, `23298992337483960000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>demo1<span class="token punctuation">.</span>service</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util</span><span class="token punctuation">.</span><span class="token class-name">Iterator</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util</span><span class="token punctuation">.</span><span class="token class-name">Random</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent</span><span class="token punctuation">.</span><span class="token class-name">ConcurrentLinkedQueue</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>stream</span><span class="token punctuation">.</span><span class="token class-name">IntStream</span><span class="token punctuation">;</span>\n\n<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TimeWindow</span> <span class="token punctuation">{</span>\n    <span class="token keyword">private</span> <span class="token class-name">ConcurrentLinkedQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">></span></span> queue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentLinkedQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">/**\n     * 间隔秒数\n     */</span>\n    <span class="token keyword">private</span> <span class="token keyword">int</span> seconds<span class="token punctuation">;</span>\n\n    <span class="token comment">/**\n     * 最大限流\n     */</span>\n    <span class="token keyword">private</span> <span class="token keyword">int</span> max<span class="token punctuation">;</span>\n\n    <span class="token keyword">public</span> <span class="token class-name">TimeWindow</span><span class="token punctuation">(</span><span class="token keyword">int</span> max<span class="token punctuation">,</span> <span class="token keyword">int</span> seconds<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">this</span><span class="token punctuation">.</span>seconds <span class="token operator">=</span> seconds<span class="token punctuation">;</span>\n        <span class="token keyword">this</span><span class="token punctuation">.</span>max <span class="token operator">=</span> max<span class="token punctuation">;</span>\n\n        <span class="token comment">/**\n         * 永续线程执行清理 queue 任务\n         */</span>\n        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">{</span>\n            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                <span class="token keyword">try</span> <span class="token punctuation">{</span>\n                    <span class="token comment">// 等待间隔秒数 - 1 执行清理操作</span>\n                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token punctuation">(</span>seconds <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                <span class="token punctuation">}</span>\n                <span class="token function">clean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>\n        <span class="token keyword">final</span> <span class="token class-name">TimeWindow</span> timeWindow <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TimeWindow</span><span class="token punctuation">(</span><span class="token number">10</span>， <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        <span class="token comment">// 测试 3 个线程</span>\n        <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span><span class="token number">0</span>， <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">{</span>\n            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">{</span>\n                <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                    <span class="token keyword">try</span> <span class="token punctuation">{</span>\n                        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                    <span class="token punctuation">}</span>\n                    timeWindow<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                <span class="token punctuation">}</span>\n            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token comment">/**\n     * 获取令牌，并且添加时间\n     */</span>\n    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">long</span> start <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">try</span> <span class="token punctuation">{</span>\n            <span class="token keyword">int</span> size <span class="token operator">=</span> <span class="token function">sizeOfValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">></span> max<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                <span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"超限"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span>\n            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>queue<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sizeOfValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> max<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                    <span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"超限"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                    <span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"queue 中有 "</span> <span class="token operator">+</span> queue<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" 最大数量 "</span> <span class="token operator">+</span> max<span class="token punctuation">)</span><span class="token punctuation">;</span>\n                <span class="token punctuation">}</span>\n                <span class="token keyword">this</span><span class="token punctuation">.</span>queue<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span>\n            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"queue 中有 "</span> <span class="token operator">+</span> queue<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" 最大数量 "</span> <span class="token operator">+</span> max<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">sizeOfValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">></span></span> it <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token class-name">Long</span> ms <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> seconds <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span>\n        <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n        <span class="token keyword">while</span> <span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">long</span> t <span class="token operator">=</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">></span> ms<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                <span class="token comment">// 在当前的统计时间范围内</span>\n                count<span class="token operator">++</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span>\n        <span class="token keyword">return</span> count<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token comment">/**\n     * 清理过期的时间\n     */</span>\n    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">clean</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token class-name">Long</span> c <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> seconds <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span>\n\n        <span class="token class-name">Long</span> tl <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>tl <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> tl <span class="token operator">&lt;</span> c<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"清理数据"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            queue<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h5 id="leaky-bucket-漏桶"><a href="#leaky-bucket-%E6%BC%8F%E6%A1%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Leaky Bucket 漏桶</h5>\n<p>规定固定容量的桶，有水进入，有水流出。对于流进的水我们无法估计进来的数量、速度，对于流出的水我们可以控制速度。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="48611808645926400000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public class LeakBucket {\n    /**\n     * 时间\n     */\n    private long time;\n    /**\n     * 总量\n     */\n    private Double total;\n    /**\n     * 水流出去的速度\n     */\n    private Double rate;\n    /**\n     * 当前总量\n     */\n    private Double nowSize;\n\n    public boolean limit() {\n        long now = System.currentTimeMillis();\n        nowSize = Math.max(0， (nowSize - (now - time) * rate));\n        time = now;\n        if ((nowSize + 1) < total) {\n            nowSize++;\n            return true;\n        } else {\n            return false;\n        }\n\n    }\n}`, `48611808645926400000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LeakBucket</span> <span class="token punctuation">{</span>\n    <span class="token comment">/**\n     * 时间\n     */</span>\n    <span class="token keyword">private</span> <span class="token keyword">long</span> time<span class="token punctuation">;</span>\n    <span class="token comment">/**\n     * 总量\n     */</span>\n    <span class="token keyword">private</span> <span class="token class-name">Double</span> total<span class="token punctuation">;</span>\n    <span class="token comment">/**\n     * 水流出去的速度\n     */</span>\n    <span class="token keyword">private</span> <span class="token class-name">Double</span> rate<span class="token punctuation">;</span>\n    <span class="token comment">/**\n     * 当前总量\n     */</span>\n    <span class="token keyword">private</span> <span class="token class-name">Double</span> nowSize<span class="token punctuation">;</span>\n\n    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">limit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">long</span> now <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        nowSize <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0</span>， <span class="token punctuation">(</span>nowSize <span class="token operator">-</span> <span class="token punctuation">(</span>now <span class="token operator">-</span> time<span class="token punctuation">)</span> <span class="token operator">*</span> rate<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        time <span class="token operator">=</span> now<span class="token punctuation">;</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>nowSize <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> total<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            nowSize<span class="token operator">++</span><span class="token punctuation">;</span>\n            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h5 id="token-bucket-令牌桶"><a href="#token-bucket-%E4%BB%A4%E7%89%8C%E6%A1%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Token Bucket 令牌桶</h5>\n<p>规定固定容量的桶，token 以固定速度往桶内填充，当桶满时 token 不会被继续放入，每过来一个请求把 token 从桶中移除，如果桶中没有 token 不能请求。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="10880185736712810000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public class TokenBucket {\n    /**\n     * 时间\n     */\n    private long time;\n    /**\n     * 总量\n     */\n    private Double total;\n    /**\n     * token 放入速度\n     */\n    private Double rate;\n    /**\n     * 当前总量\n     */\n    private Double nowSize;\n\n    public boolean limit() {\n        long now = System.currentTimeMillis();\n        nowSize = Math.min(total， nowSize + (now - time) * rate);\n        time = now;\n        if (nowSize < 1) {\n            // 桶里没有 token\n            return false;\n        } else {\n            // 存在 token\n            nowSize -= 1;\n            return true;\n        }\n    }\n\n}`, `10880185736712810000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TokenBucket</span> <span class="token punctuation">{</span>\n    <span class="token comment">/**\n     * 时间\n     */</span>\n    <span class="token keyword">private</span> <span class="token keyword">long</span> time<span class="token punctuation">;</span>\n    <span class="token comment">/**\n     * 总量\n     */</span>\n    <span class="token keyword">private</span> <span class="token class-name">Double</span> total<span class="token punctuation">;</span>\n    <span class="token comment">/**\n     * token 放入速度\n     */</span>\n    <span class="token keyword">private</span> <span class="token class-name">Double</span> rate<span class="token punctuation">;</span>\n    <span class="token comment">/**\n     * 当前总量\n     */</span>\n    <span class="token keyword">private</span> <span class="token class-name">Double</span> nowSize<span class="token punctuation">;</span>\n\n    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">limit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">long</span> now <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        nowSize <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>total， nowSize <span class="token operator">+</span> <span class="token punctuation">(</span>now <span class="token operator">-</span> time<span class="token punctuation">)</span> <span class="token operator">*</span> rate<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        time <span class="token operator">=</span> now<span class="token punctuation">;</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>nowSize <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token comment">// 桶里没有 token</span>\n            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n            <span class="token comment">// 存在 token</span>\n            nowSize <span class="token operator">-=</span> <span class="token number">1</span><span class="token punctuation">;</span>\n            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="工作中的使用"><a href="#%E5%B7%A5%E4%BD%9C%E4%B8%AD%E7%9A%84%E4%BD%BF%E7%94%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>工作中的使用</h4>\n<h5 id="spring-cloud-gateway"><a href="#spring-cloud-gateway" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>spring cloud gateway</h5>\n<p>spring cloud gateway 默认使用 redis 进行限流，一般只是修改参数属于拿来即用，并没有去从头实现上述那些算法。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="83102736155243710000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<dependency>\n    <groupId>org.springframework.cloud</groupId>\n    <artifactId>spring-cloud-starter-gateway</artifactId>\n</dependency>\n<dependency>\n    <groupId>org.springframework.boot</groupId>\n    <artifactId>spring-boot-starter-data-redis-reactive</artifactId>\n</dependency>`, `83102736155243710000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="xml"\n              >\n                <span class="gatsby-code-button-language">xml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="xml"><pre style="counter-reset: linenumber NaN" class="language-xml line-numbers"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-starter-gateway<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-data-redis-reactive<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="53487940866991310000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`spring:\n   cloud:\n      gateway:\n         routes:\n            - id: requestratelimiter_route\n\n              uri: lb://pigx-upms\n              order: 10000\n              predicates:\n                 - Path=/admin/**\n\n              filters:\n                 - name: RequestRateLimiter\n\n                   args:\n                      redis-rate-limiter.replenishRate: 1 # 令牌桶的容积\n                      redis-rate-limiter.burstCapacity: 3 # 流速每秒\n                      key-resolver: \'#{@remoteAddrKeyResolver}\' # SPEL 表达式去的对应的 bean\n\n                 - StripPrefix=1`, `53487940866991310000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yaml"\n              >\n                <span class="gatsby-code-button-language">yaml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yaml"><pre style="counter-reset: linenumber NaN" class="language-yaml line-numbers"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>\n   <span class="token key atrule">cloud</span><span class="token punctuation">:</span>\n      <span class="token key atrule">gateway</span><span class="token punctuation">:</span>\n         <span class="token key atrule">routes</span><span class="token punctuation">:</span>\n            <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> requestratelimiter_route\n\n              <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//pigx<span class="token punctuation">-</span>upms\n              <span class="token key atrule">order</span><span class="token punctuation">:</span> <span class="token number">10000</span>\n              <span class="token key atrule">predicates</span><span class="token punctuation">:</span>\n                 <span class="token punctuation">-</span> Path=/admin/**\n\n              <span class="token key atrule">filters</span><span class="token punctuation">:</span>\n                 <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> RequestRateLimiter\n\n                   <span class="token key atrule">args</span><span class="token punctuation">:</span>\n                      <span class="token key atrule">redis-rate-limiter.replenishRate</span><span class="token punctuation">:</span> <span class="token number">1 </span><span class="token comment"># 令牌桶的容积</span>\n                      <span class="token key atrule">redis-rate-limiter.burstCapacity</span><span class="token punctuation">:</span> <span class="token number">3 </span><span class="token comment"># 流速每秒</span>\n                      <span class="token key atrule">key-resolver</span><span class="token punctuation">:</span> <span class="token string">\'#{@remoteAddrKeyResolver}\'</span> <span class="token comment"># SPEL 表达式去的对应的 bean</span>\n\n                 <span class="token punctuation">-</span> StripPrefix=1</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="22835520628080873000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`@Bean\nKeyResolver remoteAddrKeyResolver() {\n    return exchange -> Mono.just(exchange.getRequest().getRemoteAddress().getHostName());\n}`, `22835520628080873000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token annotation punctuation">@Bean</span>\n<span class="token class-name">KeyResolver</span> <span class="token function">remoteAddrKeyResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> exchange <span class="token operator">-></span> <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span>exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRemoteAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHostName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<h5 id="sentinel"><a href="#sentinel" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>sentinel</h5>\n<ul>\n<li>\n<p>通过配置来控制每个 url 的流量</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="39756104293990610000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<dependency>\n  <groupId>com.alibaba.cloud</groupId>\n  <artifactId>spring-cloud-starter-alibaba-sentinel</artifactId>\n</dependency>`, `39756104293990610000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="xml"\n              >\n                <span class="gatsby-code-button-language">xml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="xml"><pre style="counter-reset: linenumber NaN" class="language-xml line-numbers"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>\n  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>\n  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-starter-alibaba-sentinel<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="65625220244435260000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`spring:\n  cloud:\n     nacos:\n        discovery:\n           server-addr: localhost:8848\n     sentinel:\n        transport:\n           dashboard: localhost:8080\n           port: 8720\n        datasource:\n           ds:\n              nacos:\n                 server-addr: localhost:8848\n                 dataId: spring-cloud-sentinel-nacos\n                 groupId: DEFAULT_GROUP\n                 rule-type: flow\n                 namespace: xxxxxxxx`, `65625220244435260000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yaml"\n              >\n                <span class="gatsby-code-button-language">yaml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yaml"><pre style="counter-reset: linenumber NaN" class="language-yaml line-numbers"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>\n  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>\n     <span class="token key atrule">nacos</span><span class="token punctuation">:</span>\n        <span class="token key atrule">discovery</span><span class="token punctuation">:</span>\n           <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">8848</span>\n     <span class="token key atrule">sentinel</span><span class="token punctuation">:</span>\n        <span class="token key atrule">transport</span><span class="token punctuation">:</span>\n           <span class="token key atrule">dashboard</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">8080</span>\n           <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8720</span>\n        <span class="token key atrule">datasource</span><span class="token punctuation">:</span>\n           <span class="token key atrule">ds</span><span class="token punctuation">:</span>\n              <span class="token key atrule">nacos</span><span class="token punctuation">:</span>\n                 <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">8848</span>\n                 <span class="token key atrule">dataId</span><span class="token punctuation">:</span> spring<span class="token punctuation">-</span>cloud<span class="token punctuation">-</span>sentinel<span class="token punctuation">-</span>nacos\n                 <span class="token key atrule">groupId</span><span class="token punctuation">:</span> DEFAULT_GROUP\n                 <span class="token key atrule">rule-type</span><span class="token punctuation">:</span> flow\n                 <span class="token key atrule">namespace</span><span class="token punctuation">:</span> xxxxxxxx</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n<li>\n<p>配置内容在 nacos 上进行编辑</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="99465295729139420000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`[\n  {\n     &quot;resource&quot;: &quot;/hello&quot;,\n     &quot;limitApp&quot;: &quot;default&quot;,\n     &quot;grade&quot;: 1,\n     &quot;count&quot;: 1,\n     &quot;strategy&quot;: 0,\n     &quot;controlBehavior&quot;: 0,\n     &quot;clusterMode&quot;: false\n  }\n]`, `99465295729139420000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="json"\n              >\n                <span class="gatsby-code-button-language">json</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="json"><pre style="counter-reset: linenumber NaN" class="language-json line-numbers"><code class="language-json"><span class="token punctuation">[</span>\n  <span class="token punctuation">{</span>\n     <span class="token property">"resource"</span><span class="token operator">:</span> <span class="token string">"/hello"</span><span class="token punctuation">,</span>\n     <span class="token property">"limitApp"</span><span class="token operator">:</span> <span class="token string">"default"</span><span class="token punctuation">,</span>\n     <span class="token property">"grade"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>\n     <span class="token property">"count"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>\n     <span class="token property">"strategy"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>\n     <span class="token property">"controlBehavior"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>\n     <span class="token property">"clusterMode"</span><span class="token operator">:</span> <span class="token boolean">false</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n<li>\n<p>resource：资源名，即限流规则的作用对象。</p>\n</li>\n<li>\n<p>limitApp：流控针对的调用来源，若为 default 则不区分调用来源。</p>\n</li>\n<li>\n<p>grade：限流阈值类型，QPS 或线程数模式，0 代表根据并发数量来限流，1 代表根据 QPS 来进行流量控制。</p>\n</li>\n<li>\n<p>count：限流阈值</p>\n</li>\n<li>\n<p>strategy：判断的根据是资源自身，还是根据其它关联资源 (refResource)，还是根据链路入口</p>\n</li>\n<li>\n<p>controlBehavior：流控效果（直接拒绝 / 排队等待 / 慢启动模式）</p>\n</li>\n<li>\n<p>clusterMode：是否为集群模式</p>\n</li>\n</ul>\n<h5 id="总结-2"><a href="#%E6%80%BB%E7%BB%93-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h5>\n<p>sentinel 和 spring cloud gateway 两个框架都是很好的限流框架，但是在使用中还没有将 spring-cloud-alibaba 接入到项目中进行使用，所以我会选择 spring cloud gateway，接入完整的或者接入 Nacos 项目使用 setinel 会有更加好的体验.</p>\n<h2 id="熔断"><a href="#%E7%86%94%E6%96%AD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>熔断</h2>\n<h3 id="如何进行熔断？"><a href="#%E5%A6%82%E4%BD%95%E8%BF%9B%E8%A1%8C%E7%86%94%E6%96%AD%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>如何进行熔断？</h3>\n<h3 id="熔断框架都有哪些？具体实现原理知道吗？"><a href="#%E7%86%94%E6%96%AD%E6%A1%86%E6%9E%B6%E9%83%BD%E6%9C%89%E5%93%AA%E4%BA%9B%EF%BC%9F%E5%85%B7%E4%BD%93%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E7%9F%A5%E9%81%93%E5%90%97%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>熔断框架都有哪些？具体实现原理知道吗？</h3>\n<h3 id="熔断框架，选用-sentinel-还是-hystrix？"><a href="#%E7%86%94%E6%96%AD%E6%A1%86%E6%9E%B6%EF%BC%8C%E9%80%89%E7%94%A8-sentinel-%E8%BF%98%E6%98%AF-hystrix%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>熔断框架，选用 Sentinel 还是 Hystrix？</h3>\n<p>Sentinel 是阿里中间件团队研发的面向分布式服务架构的轻量级高可用流量控制组件，于 2018 年 7 月正式开源。Sentinel 主要以流量为切入点，从流量控制、熔断降级、系统负载保护等多个维度来帮助用户提升服务的稳定性。大家可能会问：Sentinel 和之前经常用到的熔断降级库 Netflix Hystrix 有什么异同呢？本文将从资源模型和执行模型、隔离设计、熔断降级、实时指标统计设计等角度将 Sentinel 和 Hystrix 进行对比，希望在面临技术选型的时候，对各位开发者能有所帮助。</p>\n<p>Sentinel 项目地址：<a href="https://github.com/alibaba/Sentinel" target="_blank" rel="nofollow noreferrer noopener">https://github.com/alibaba/Sentinel</a></p>\n<h4 id="总体说明"><a href="#%E6%80%BB%E4%BD%93%E8%AF%B4%E6%98%8E" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总体说明</h4>\n<p>先来看一下 Hystrix 的官方介绍：</p>\n<blockquote>\n<p>Hystrix is a library that helps you control the interactions between these distributed services by adding latency tolerance and fault tolerance logic. Hystrix does this by isolating points of access between the services, stopping cascading failures across them, and providing fallback options, all of which improve your system’s overall resiliency.</p>\n</blockquote>\n<p>可以看到 Hystrix 的关注点在于以隔离和熔断为主的容错机制，超时或被熔断的调用将会快速失败，并可以提供 fallback 机制。</p>\n<p>而 Sentinel 的侧重点在于：</p>\n<ul>\n<li>多样化的流量控制</li>\n<li>熔断降级</li>\n<li>系统负载保护</li>\n<li>实时监控和控制台</li>\n</ul>\n<p>两者解决的问题还是有比较大的不同的，下面我们来具体对比一下。</p>\n<h4 id="共同特性"><a href="#%E5%85%B1%E5%90%8C%E7%89%B9%E6%80%A7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>共同特性</h4>\n<h5 id="资源模型和执行模型上的对比"><a href="#%E8%B5%84%E6%BA%90%E6%A8%A1%E5%9E%8B%E5%92%8C%E6%89%A7%E8%A1%8C%E6%A8%A1%E5%9E%8B%E4%B8%8A%E7%9A%84%E5%AF%B9%E6%AF%94" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>资源模型和执行模型上的对比</h5>\n<p>Hystrix 的资源模型设计上采用了命令模式，将对外部资源的调用和 fallback 逻辑封装成一个命令对象 HystrixCommand 或 HystrixObservableCommand，其底层的执行是基于 RxJava 实现的。每个 Command 创建时都要指定 commandKey 和 groupKey（用于区分资源）以及对应的隔离策略（线程池隔离 or 信号量隔离）。线程池隔离模式下需要配置线程池对应的参数（线程池名称、容量、排队超时等），然后 Command 就会在指定的线程池按照指定的容错策略执行；信号量隔离模式下需要配置最大并发数，执行 Command 时 Hystrix 就会限制其并发调用。</p>\n<p>Sentinel 的设计则更为简单。相比 Hystrix Command 强依赖隔离规则，Sentinel 的资源定义与规则配置的耦合度更低。Hystrix 的 Command 强依赖于隔离规则配置的原因是隔离规则会直接影响 Command 的执行。在执行的时候 Hystrix 会解析 Command 的隔离规则来创建 RxJava Scheduler 并在其上调度执行，若是线程池模式则 Scheduler 底层的线程池为配置的线程池，若是信号量模式则简单包装成当前线程执行的 Scheduler。</p>\n<p>而 Sentinel 则不一样，开发的时候只需要考虑这个方法 / 代码是否需要保护，至于用什么来保护，可以任何时候动态实时的去修改。</p>\n<p>从 0.1.1 版本开始，Sentinel 还支持基于注解的资源定义方式，可以通过注解参数指定异常处理函数和 fallback 函数。Sentinel 提供多样化的规则配置方式。除了直接通过 loadRules API 将规则注册到内存态之外，用户还可以注册各种外部数据源来提供动态的规则。用户可以根据系统当前的实时情况去动态地变更规则配置，数据源会将变更推送至 Sentinel 并即时生效。</p>\n<h5 id="隔离设计上的对比"><a href="#%E9%9A%94%E7%A6%BB%E8%AE%BE%E8%AE%A1%E4%B8%8A%E7%9A%84%E5%AF%B9%E6%AF%94" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>隔离设计上的对比</h5>\n<p>隔离是 Hystrix 的核心功能之一。Hystrix 提供两种隔离策略：线程池隔离 Bulkhead Pattern 和信号量隔离，其中最推荐也是最常用的是线程池隔离。Hystrix 的线程池隔离针对不同的资源分别创建不同的线程池，不同服务调用都发生在不同的线程池中，在线程池排队、超时等阻塞情况时可以快速失败，并可以提供 fallback 机制。线程池隔离的好处是隔离度比较高，可以针对某个资源的线程池去进行处理而不影响其它资源，但是代价就是线程上下文切换的 overhead 比较大，特别是对低延时的调用有比较大的影响。</p>\n<p>但是，实际情况下，线程池隔离并没有带来非常多的好处。最直接的影响，就是会让机器资源碎片化。考虑这样一个常见的场景，在 Tomcat 之类的 Servlet 容器使用 Hystrix，本身 Tomcat 自身的线程数目就非常多了（可能到几十或一百多），如果加上 Hystrix 为各个资源创建的线程池，总共线程数目会非常多（几百个线程），这样上下文切换会有非常大的损耗。另外，线程池模式比较彻底的隔离性使得 Hystrix 可以针对不同资源线程池的排队、超时情况分别进行处理，但这其实是超时熔断和流量控制要解决的问题，如果组件具备了超时熔断和流量控制的能力，线程池隔离就显得没有那么必要了。</p>\n<p>Hystrix 的信号量隔离限制对某个资源调用的并发数。这样的隔离非常轻量级，仅限制对某个资源调用的并发数，而不是显式地去创建线程池，所以 overhead 比较小，但是效果不错。但缺点是无法对慢调用自动进行降级，只能等待客户端自己超时，因此仍然可能会出现级联阻塞的情况。</p>\n<p>Sentinel 可以通过并发线程数模式的流量控制来提供信号量隔离的功能。并且结合基于响应时间的熔断降级模式，可以在不稳定资源的平均响应时间比较高的时候自动降级，防止过多的慢调用占满并发数，影响整个系统。</p>\n<h5 id="熔断降级的对比"><a href="#%E7%86%94%E6%96%AD%E9%99%8D%E7%BA%A7%E7%9A%84%E5%AF%B9%E6%AF%94" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>熔断降级的对比</h5>\n<p>Sentinel 和 Hystrix 的熔断降级功能本质上都是基于熔断器模式 Circuit Breaker Pattern。Sentinel 与 Hystrix 都支持基于失败比率（异常比率）的熔断降级，在调用达到一定量级并且失败比率达到设定的阈值时自动进行熔断，此时所有对该资源的调用都会被 block，直到过了指定的时间窗口后才启发性地恢复。上面提到过，Sentinel 还支持基于平均响应时间的熔断降级，可以在服务响应时间持续飙高的时候自动熔断，拒绝掉更多的请求，直到一段时间后才恢复。这样可以防止调用非常慢造成级联阻塞的情况。</p>\n<h5 id="实时指标统计实现的对比"><a href="#%E5%AE%9E%E6%97%B6%E6%8C%87%E6%A0%87%E7%BB%9F%E8%AE%A1%E5%AE%9E%E7%8E%B0%E7%9A%84%E5%AF%B9%E6%AF%94" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>实时指标统计实现的对比</h5>\n<p>Hystrix 和 Sentinel 的实时指标数据统计实现都是基于滑动窗口的。Hystrix 1.5 之前的版本是通过环形数组实现的滑动窗口，通过锁配合 CAS 的操作对每个桶的统计信息进行更新。Hystrix 1.5 开始对实时指标统计的实现进行了重构，将指标统计数据结构抽象成了响应式流（reactive stream）的形式，方便消费者去利用指标信息。同时底层改造成了基于 RxJava 的事件驱动模式，在服务调用成功 / 失败 / 超时的时候发布相应的事件，通过一系列的变换和聚合最终得到实时的指标统计数据流，可以被熔断器或 Dashboard 消费。</p>\n<p>Sentinel 目前抽象出了 Metric 指标统计接口，底层可以有不同的实现，目前默认的实现是基于 LeapArray 的滑动窗口，后续根据需要可能会引入 reactive stream 等实现。</p>\n<h4 id="sentinel-特性"><a href="#sentinel-%E7%89%B9%E6%80%A7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Sentinel 特性</h4>\n<p>除了之前提到的两者的共同特性之外，Sentinel 还提供以下的特色功能：</p>\n<h5 id="轻量级、高性能"><a href="#%E8%BD%BB%E9%87%8F%E7%BA%A7%E3%80%81%E9%AB%98%E6%80%A7%E8%83%BD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>轻量级、高性能</h5>\n<p>Sentinel 作为一个功能完备的高可用流量管控组件，其核心 sentinel-core 没有任何多余依赖，打包后只有不到 200KB，非常轻量级。开发者可以放心地引入 sentinel-core 而不需担心依赖问题。同时，Sentinel 提供了多种扩展点，用户可以很方便地根据需求去进行扩展，并且无缝地切合到 Sentinel 中。</p>\n<p>引入 Sentinel 带来的性能损耗非常小。只有在业务单机量级超过 25W QPS 的时候才会有一些显著的影响（5% - 10% 左右），单机 QPS 不太大的时候损耗几乎可以忽略不计。</p>\n<h5 id="流量控制"><a href="#%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>流量控制</h5>\n<p>Sentinel 可以针对不同的调用关系，以不同的运行指标（如 QPS、并发调用数、系统负载等）为基准，对资源调用进行流量控制，将随机的请求调整成合适的形状。</p>\n<p>Sentinel 支持多样化的流量整形策略，在 QPS 过高的时候可以自动将流量调整成合适的形状。常用的有：</p>\n<ul>\n<li>直接拒绝模式：即超出的请求直接拒绝。</li>\n<li>慢启动预热模式：当流量激增的时候，控制流量通过的速率，让通过的流量缓慢增加，在一定时间内逐渐增加到阈值上限，给冷系统一个预热的时间，避免冷系统被压垮。</li>\n<li>匀速器模式：利用 Leaky Bucket 算法实现的匀速模式，严格控制了请求通过的时间间隔，同时堆积的请求将会排队，超过超时时长的请求直接被拒绝。Sentinel 还支持基于调用关系的限流，包括基于调用方限流、基于调用链入口限流、关联流量限流等，依托于 Sentinel 强大的调用链路统计信息，可以提供精准的不同维度的限流。</li>\n</ul>\n<p>目前 Sentinel 对异步调用链路的支持还不是很好，后续版本会着重改善支持异步调用。</p>\n<h5 id="系统负载保护"><a href="#%E7%B3%BB%E7%BB%9F%E8%B4%9F%E8%BD%BD%E4%BF%9D%E6%8A%A4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>系统负载保护</h5>\n<p>Sentinel 对系统的维度提供保护，负载保护算法借鉴了 TCP BBR 的思想。当系统负载较高的时候，如果仍持续让请求进入，可能会导致系统崩溃，无法响应。在集群环境下，网络负载均衡会把本应这台机器承载的流量转发到其它的机器上去。如果这个时候其它的机器也处在一个边缘状态的时候，这个增加的流量就会导致这台机器也崩溃，最后导致整个集群不可用。针对这个情况，Sentinel 提供了对应的保护机制，让系统的入口流量和系统的负载达到一个平衡，保证系统在能力范围之内处理最多的请求。</p>\n<h5 id="实时监控和控制面板"><a href="#%E5%AE%9E%E6%97%B6%E7%9B%91%E6%8E%A7%E5%92%8C%E6%8E%A7%E5%88%B6%E9%9D%A2%E6%9D%BF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>实时监控和控制面板</h5>\n<p>Sentinel 提供 HTTP API 用于获取实时的监控信息，如调用链路统计信息、簇点信息、规则信息等。如果用户正在使用 Spring Boot / Spring Cloud 并使用了 Sentinel Spring Cloud Starter，还可以方便地通过其暴露的 Actuator Endpoint 来获取运行时的一些信息，如动态规则等。未来 Sentinel 还会支持标准化的指标监控 API，可以方便地整合各种监控系统和可视化系统，如 Prometheus、Grafana 等。</p>\n<p>Sentinel 控制台（Dashboard）提供了机器发现、配置规则、查看实时监控、查看调用链路信息等功能，使得用户可以非常方便地去查看监控和进行配置。</p>\n<h5 id="生态"><a href="#%E7%94%9F%E6%80%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>生态</h5>\n<p>Sentinel 目前已经针对 Servlet、Dubbo、Spring Boot / Spring Cloud、gRPC 等进行了适配，用户只需引入相应依赖并进行简单配置即可非常方便地享受 Sentinel 的高可用流量防护能力。未来 Sentinel 还会对更多常用框架进行适配，并且会为 Service Mesh 提供集群流量防护的能力。</p>\n<h4 id="总结-3"><a href="#%E6%80%BB%E7%BB%93-3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h4>\n<table>\n<thead>\n<tr>\n<th>#</th>\n<th>Sentinel</th>\n<th>Hystrix</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>隔离策略</td>\n<td>信号量隔离</td>\n<td>线程池隔离/信号量隔离</td>\n</tr>\n<tr>\n<td>熔断降级策略</td>\n<td>基于响应时间或失败比率</td>\n<td>基于失败比率</td>\n</tr>\n<tr>\n<td>实时指标实现</td>\n<td>滑动窗口</td>\n<td>滑动窗口（基于 RxJava）</td>\n</tr>\n<tr>\n<td>规则配置</td>\n<td>支持多种数据源</td>\n<td>支持多种数据源</td>\n</tr>\n<tr>\n<td>扩展性</td>\n<td>多个扩展点</td>\n<td>插件的形式</td>\n</tr>\n<tr>\n<td>基于注解的支持</td>\n<td>支持</td>\n<td>支持</td>\n</tr>\n<tr>\n<td>限流</td>\n<td>基于 QPS，支持基于调用关系的限流</td>\n<td>不支持</td>\n</tr>\n<tr>\n<td>流量整形</td>\n<td>支持慢启动、匀速器模式</td>\n<td>不支持</td>\n</tr>\n<tr>\n<td>系统负载保护</td>\n<td>支持</td>\n<td>不支持</td>\n</tr>\n<tr>\n<td>控制台</td>\n<td>开箱即用，可配置规则、查看秒级监控、机器发现等</td>\n<td>不完善</td>\n</tr>\n<tr>\n<td>常见框架的适配</td>\n<td>Servlet、Spring Cloud、Dubbo、gRPC</td>\n<td>Servlet、Spring Cloud Netflix</td>\n</tr>\n</tbody>\n</table>\n<h2 id="降级"><a href="#%E9%99%8D%E7%BA%A7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>降级</h2>\n<h3 id="如何进行降级？"><a href="#%E5%A6%82%E4%BD%95%E8%BF%9B%E8%A1%8C%E9%99%8D%E7%BA%A7%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>如何进行降级？</h3>\n<h1 id="微服务架构"><a href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>微服务架构</h1>\n<h2 id="微服务的一些概念"><a href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%9A%84%E4%B8%80%E4%BA%9B%E6%A6%82%E5%BF%B5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>微服务的一些概念</h2>\n<h3 id="关于微服务架构的描述"><a href="#%E5%85%B3%E4%BA%8E%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84%E7%9A%84%E6%8F%8F%E8%BF%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>关于微服务架构的描述</h3>\n<p>过去几年中出现了“微服务架构”这一术语，它描述了将软件应用程序设计为若干个可独立部署的服务套件的特定方法。尽管这种架构风格尚未有精确的定义，但围绕业务能力、自动部署、端点智能以及语言和数据的分散控制等组织来说，它们还是存在着某些共同特征。</p>\n<p>“微服务”——在拥挤的软件架构街道上又一个新名词。虽然我们的自然倾向是对它轻蔑一瞥，但这一术语描述了一种越来越具有吸引力的软件系统风格。在过去几年中，我们已经看到许多项目使用了这种风格，到目前为止其结果都是正向的，以至于它变成了我们 ThoughtWorks 许多同事构建企业应用程序的默认风格。然而遗憾的是，并没有太多信息可以概述微服务的风格以及如何实现。</p>\n<p>简而言之，微服务架构风格是一种将单个应用程序开发为一套小型服务的方法，每个小型服务都在自己的进程中运行，并以轻量级机制（通常是 HTTP 资源 API）进行通信。这些服务围绕业务功能构建，可通过全自动部署机制来独立部署。这些服务共用一个最小型的集中式管理，它们可以使用不同的编程语言编写，并使用不同的数据存储技术。</p>\n<p>在开始解释微服务风格之前，将它与单体（monolithic）风格进行比较是有用的：单体应用程序被构建为单一单元。企业应用程序通常由三个部分构成：客户端用户界面（由用户机器上的浏览器中运行的 HTML 页面和 Javascript 组成）、数据库（由许多表组成，通常是在关系型数据库中管理）系统、服务器端应用程序。服务器端应用程序处理 HTTP 请求，执行一些逻辑处理，从数据库检索和更新数据，选择数据并填充到要发送到浏览器的 HTML 视图中。这个服务器端应用程序是一个整体——一个逻辑可执行文件。对系统的任何更改都涉及构建和部署新版本的服务器端应用程序。</p>\n<p>这种单体服务器是构建这种系统的自然方式。处理一个请求的所有逻辑都在一个进程中运行，允许你使用语言的基本功能将应用程序划分为类、函数和命名空间。需要注意的是，你可以在开发人员的笔记本电脑上运行和测试应用程序，并使用部署管道确保对程序做出的改动被适当测试并部署到生产环境中。你可以通过在负载均衡器后面运行许多实例来水平扩展整体块。</p>\n<p>单体应用程序可以取得成功，但越来越多的人对它们感到不满——尤其是在将更多应用程序部署到云的时候。变更周期被捆绑在一起——即使只是对应用程序的一小部分进行了更改，也需要重建和部署整个单体应用。随着时间的推移，通常很难保持良好的模块化结构，也更难以保持应该只影响该模块中的一个模块的更改。对系统进行扩展时，不得不扩展整个应用系统，而不能仅扩展该系统中需要更多资源的那些部分。</p>\n<p>这些不满催生了微服务架构风格：将应用程序构建为服务套件。除了服务可独立部署、独立扩展的事实之外，每个服务还提供了一个牢固的模块边界，甚至允许以不同的编程语言编写不同的服务。他们也可以由不同的团队管理。</p>\n<p>我们并不认为微服务风格是新颖的或创新的，其根源至少可以追溯到 Unix 的设计原则。但我们认为没有足够多的人考虑微服务架构，如果使用它，许多软件的开发会变得更好。</p>\n<h4 id="微服务架构的特征"><a href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84%E7%9A%84%E7%89%B9%E5%BE%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>微服务架构的特征</h4>\n<p>虽然不能说微服务架构风格有正式的定义，但我们可以尝试描述一下我们认为的在符合这个标签的架构中，它们所具有的一些共同特征。与概述共同特征的任何定义一样，并非所有微服务架构都具有所有特征，但我们确实期望大多数微服务架构都具有大多数特征。虽然我们的作者一直是这个相当宽松的社区的活跃成员，但我们的本意还是尝试描述我们两人在自己和自己所了解的团队的工作中所看到的情况。特别要说明的是，我们没有制定一些相关的定义。</p>\n<h5 id="通过服务进行组件化"><a href="#%E9%80%9A%E8%BF%87%E6%9C%8D%E5%8A%A1%E8%BF%9B%E8%A1%8C%E7%BB%84%E4%BB%B6%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>通过服务进行组件化</h5>\n<p>只要我们参与软件行业，就一直希望通过将组件集成在一起来构建系统，就像我们在物理世界中看到的事物的构建方式一样。在过去的几十年中，我们已经看到了大多数语言平台的公共软件库都取得了极大的进展。</p>\n<p>在谈论组件时，就会碰到一个有关定义的难题，即什么是组件？我们的定义是，组件是可独立更换和升级的软件单元。</p>\n<p>微服务架构也会使用软件库，但组件化软件的主要方式是拆分为多个服务。我们把库定义为链接到程序并使用内存函数调用来调用的组件，而服务是一种进程外组件，通过 Web 服务请求或远程过程调用等机制进行通信（这与许多面向对象程序中的服务对象的概念是不同的。）</p>\n<p>将服务作为组件（而不是库）的一个主要原因是服务可以独立部署。如果你有一个应用程序是由单一进程里的多个库组成，任何一个组件的更改都会导致整个应用程序的重新部署。但如果应用程序可拆分为多个服务，那么单个服务的变更只需要重新部署该服务即可。当然这也不是绝对的，一些服务接口的修改可能会导致多个服务之间的协同修改，但一个好的微服务架构的目的是通过内聚服务边界和服务协议的演进机制来最小化这些协同修改。</p>\n<p>将服务用作组件的另一个结果是更明确的组件接口。大多数语言没有一个良好的机制来定义显式发布的接口。通常，它只是文档和规则来阻止客户端破坏组件的封装，这会导致组件之间过于紧耦合。通过使用显式远程调用机制，服务可以更轻松地避免这种情况。</p>\n<p>像这样使用服务确实存在一些不好的地方。远程调用比进程内调用更昂贵，远程 API 需要设计成较粗的粒度，这通常更难以使用。如果你需要更改组件之间的职责分配，那么当你跨越进程边界时，这种组件行为的改动会更加难以实现。</p>\n<p>近似地，我们可以把一个个服务映射为一个个运行时进程，但这仅仅是一个近似而已。一个服务可能包括多个始终一起开发和部署的进程，比如一个应用系统的进程和仅由该服务使用的数据库。</p>\n<h5 id="围绕业务能力进行组织"><a href="#%E5%9B%B4%E7%BB%95%E4%B8%9A%E5%8A%A1%E8%83%BD%E5%8A%9B%E8%BF%9B%E8%A1%8C%E7%BB%84%E7%BB%87" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>围绕业务能力进行组织</h5>\n<p>在将大型应用程序拆分为多个部分时，管理层往往侧重于技术层面，从而导致 UI 团队、服务器端逻辑团队、数据库团队的划分。当团队按照这些方式分开时，即便是简单的更改也可能导致跨团队项目的时间和预算批准。一个聪明的团队将围绕这个进行优化，“两害相权取其轻”——只需将逻辑强制应用到他们可以访问的任何应用程序中。换句话说，逻辑无处不在。这是康威定律的一个例子。</p>\n<blockquote>\n<p>任何设计系统（广义上的）的组织都会产生一种设计，其结构是组织通信结构的副本。</p>\n</blockquote>\n<p>微服务采用不同的划分方式，它是围绕业务功能将系统拆分为多个服务。这些服务为该业务领域采用广泛的软件实现，包括用户界面、持久化存储和任何外部协作。因此，团队是跨职能的，包括开发所需的全部技能：用户体验、数据库和项目管理。</p>\n<p>以这种方式组建的一家公司是 <code class="language-text">www.comparethemarket.com</code>，跨职能团队负责构建和运营每个产品，每个产品拆分为多个独立的服务，彼此通过消息总线来通信。</p>\n<p>大型单体应用程序也可以围绕业务功能进行模块化，尽管这不是常见的情况。当然，我们会敦促构建单体应用系统的大型团队根据业务线来将自己分解为若干小团队。我们在这里看到的主要问题是，它们往往围绕太多的上下文进行组织。如果单体跨越了模块边界，对团队的个体成员来说，很难将它们装入短期的记忆中。此外，我们看到模块化生产线需要大量的规则来执行。服务组件所要求的更加明确的分离，使得它更容易保持团队边界清晰。</p>\n<h5 id="是产品不是项目"><a href="#%E6%98%AF%E4%BA%A7%E5%93%81%E4%B8%8D%E6%98%AF%E9%A1%B9%E7%9B%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>是产品不是项目</h5>\n<p>我们看到的大多数应用程序开发工作都使用这样一个项目模式：目标是交付一些软件，然后就完工了。一旦完成后，软件将移交给维护组织，然后构建它的项目团队也随之解散了。</p>\n<p>微服务支持者倾向于避免这种模式，而是认为团队应该负责产品的整个生命周期。对此一个共同的启示是亚马逊的 <code class="language-text">you build, you run it</code> 的概念，开发团队对生产中的软件负全部责任。这使开发者经常接触他们的软件在生产环境如何工作，并增加与他们的用户联系，因为他们必须承担至少部分的支持工作。</p>\n<p>产品心态与业务能力的联系紧密相连。要持续关注软件如何帮助用户提升业务能力，而不是把软件看成是将要完成的一组功能。</p>\n<p>没有理由说为什么这种方法不能用在单一应用程序上，但较小的服务粒度，使得它更容易在服务开发者和用户之间建立个人关系。</p>\n<h5 id="智能端点和哑管"><a href="#%E6%99%BA%E8%83%BD%E7%AB%AF%E7%82%B9%E5%92%8C%E5%93%91%E7%AE%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>智能端点和哑管</h5>\n<p>在不同进程之间建立通信时，我们已经看到许多产品和方法，都强调将大量的智能特性放入通信机制本身。一个很好的例子是企业服务总线（ESB），其中 ESB 产品通常包括用于消息路由、编排、转换和应用业务规则的复杂工具。</p>\n<p>微服务社区倾向于采用另一种方法：智能端点和哑管。基于微服务构建的应用程序的目标是尽可能的解耦和尽可能的内聚——他们拥有自己的领域逻辑，他们的行为更像经典 UNIX 理念中的过滤器——接收请求，应用适当的逻辑并产生响应。使用简单的 REST 风格的协议来编排它们，而不是使用像 WS-Choreography 或者 BPEL 或者通过中心工具编制（orchestration）等复杂的协议。</p>\n<p>最常用的两种协议是带有资源 API 的 HTTP 请求：响应和轻量级消息传递。对第一种协议最好的表述是</p>\n<blockquote>\n<p>本身就是 web，而不是隐藏在 web 的后面。</p>\n</blockquote>\n<p>微服务团队使用的规则和协议，正是构建万维网的规则和协议（在更大程度上是 UNIX 的）。从开发者和运营人员的角度讲，通常使用的资源可以很容易的缓存。</p>\n<p>第二种常用方法是在轻量级消息总线上传递消息。选择的基础设施是典型的哑点（哑在这里只充当消息路由器）</p>\n<ol>\n<li>像 RabbitMQ 或 ZeroMQ 这样简单的实现仅仅提供一个可靠的异步交换结构</li>\n<li>在服务里，智能特性仍旧存在于那些生产和消费诸多消息的各个端点中，即存在于各个服务中。</li>\n</ol>\n<p>单体应用中，组件都在同一进程内执行，它们之间通过方法调用或函数调用通信。把单体变成微服务最大的问题在于通信模式的改变。一种幼稚的转换是从内存方法调用转变成 RPC，这导致频繁通信且性能不好。相反，你需要用粗粒度通信代替细粒度通信。</p>\n<h5 id="去中心化的治理"><a href="#%E5%8E%BB%E4%B8%AD%E5%BF%83%E5%8C%96%E7%9A%84%E6%B2%BB%E7%90%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>去中心化的治理</h5>\n<p>集中治理的一个后果是单一技术平台的标准化发展趋势。经验表明，这种方法正在收缩 —— 不是每个问题都是钉子，不是每个问题都是锤子。我们更喜欢使用正确的工具来完成工作，而单体应用程序在一定程度上可以利用语言的优势，这是不常见的。</p>\n<p>把单体的组件分裂成服务，在构建这些服务时可以有自己的选择。你想使用 Node.js 开发一个简单的报告页面？去吧。用 C++ 实现一个特别粗糙的近乎实时的组件？好极了。你想换用一个更适合组件读操作数据的不同风格的数据库？我们有技术来重建它。</p>\n<p>当然，仅仅因为你可以做些什么，而不意味着你应该这样做 —— 但用这种方式划分系统意味着你可以选择。</p>\n<p>团队在构建微服务时也更喜欢用不同的方法来达标。他们更喜欢生产有用的工具这种想法，而不是写在纸上的标准，这样其他开发者可以用这些工具解决他们所面临的相似的问题。有时，这些工具通常在实施中收获并与更广泛的群体共享，但不完全使用一个内部开源模型。现在 git 和 github 已经成为事实上的版本控制系统的选择，在内部开放源代码的实践也正变得越来越常见。</p>\n<p>Netflix 是遵循这一理念的一个很好的例子。尤其是以库的形式分享有用的且经过市场检验的代码，这激励其他开发者用类似的方式解决相似的问题，同时还为采用不同方法敞开了大门。共享库倾向于聚焦在数据存储、进程间通信和我们接下来要深入讨论的基础设施自动化的共性问题。</p>\n<p>对于微服务社区来说，开销特别缺乏吸引力。这并不是说社区不重视服务合约。恰恰相反，因为他们有更多的合约。只是他们正在寻找不同的方式来管理这些合约。像 Tolerant Reader 和 Consumer-Driven Contracts 这样的模式通常被用于微服务。这些援助服务合约在独立进化。执行消费者驱动的合约作为构建的一部分，增加了信心并对服务是否在运作提供了更快的反馈。事实上，我们知道澳大利亚的一个团队用消费者驱动的合约这种模式来驱动新业务的构建。他们使用简单的工具定义服务的合约。这已变成自动构建的一部分，即使新服务的代码还没写。服务仅在满足合约的时候才被创建出来，这是在构建新软件时避免 <code class="language-text">YAGNI</code> 困境的一个优雅的方法。围绕这些成长起来的技术和工具，通过减少服务间的临时耦合，限制了中心合约管理的需要。</p>\n<p>也许去中心化治理的最高境界就是亚马逊广为流传的 <code class="language-text">build it / run it</code> 理念。团队要对他们构建的软件的各方面负责，包括 7*24 小时的运营。这一级别的责任下放绝对是不规范的，但我们看到越来越多的公司让开发团队负起更多责任。Netflix 是采用这一理念的另一家公司。每天凌晨 3 点被传呼机叫醒无疑是一个强有力的激励，使你在写代码时关注质量。这是关于尽可能远离传统的集中治理模式的一些想法。</p>\n<h5 id="分散数据管理"><a href="#%E5%88%86%E6%95%A3%E6%95%B0%E6%8D%AE%E7%AE%A1%E7%90%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>分散数据管理</h5>\n<p>数据管理的去中心化有许多不同的呈现方式。在最抽象的层面上，这意味着使系统间存在差异的世界概念模型。在整合一个大型企业时，客户的销售视图将不同于支持视图，这是一个常见的问题。客户的销售视图中的一些事情可能不会出现在支持视图中。它们确实可能有不同的属性和（更坏的）共同属性，这些共同属性在语义上有微妙的不同。</p>\n<p>这个问题常见于应用程序之间，但也可能发生在应用程序内部，尤其当应用程序被划分成分离的组件时。一个有用的思维方式是有界上下文（Bounded Context）内的领域驱动设计（Domain-Driven Design, DDD）理念。DDD 把一个复杂域划分成多个有界的上下文，并且映射出它们之间的关系。这个过程对单体架构和微服务架构都是有用的，但在服务和上下文边界间有天然的相关性，边界有助于澄清和加强分离，就像业务能力部分描述的那样。</p>\n<p>和概念模型的去中心化决策一样，微服务也去中心化数据存储决策。虽然单体应用程序更喜欢单一的逻辑数据库做持久化存储，但企业往往倾向于一系列应用程序共用一个单一的数据库——这些决定是供应商授权许可的商业模式驱动的。微服务更倾向于让每个服务管理自己的数据库，或者同一数据库技术的不同实例，或完全不同的数据库系统，这就是所谓的混合持久化（Polyglot Persistence）。你可以在单体应用程序中使用混合持久化，但它更常出现在为服务里。</p>\n<p>对跨微服务的数据来说，去中心化责任对管理升级有影响。处理更新的常用方法是在更新多个资源时使用事务来保证一致性。这个方法通常用在单体中。</p>\n<p>像这样使用事务有助于一致性，但会产生显著地临时耦合，这在横跨多个服务时是有问题的。分布式事务是出了名的难以实现，因此微服务架构强调服务间的无事务协作，对一致性可能只是最后一致性和通过补偿操作处理问题。</p>\n<p>对很多开发团队来说，选择用这样的方式管理不一致性是一个新的挑战，但这通常与业务实践相匹配。通常业务处理一定程度的不一致，以快速响应需求，同时有某些类型的逆转过程来处理错误。这种权衡是值得的，只要修复错误的代价小于更大一致性下损失业务的代价。</p>\n<h5 id="基建自动化"><a href="#%E5%9F%BA%E5%BB%BA%E8%87%AA%E5%8A%A8%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>基建自动化</h5>\n<p>基础设施自动化技术在过去几年中发生了巨大变化——特别是云和 AWS 的发展降低了构建、部署和运行微服务的操作复杂性。</p>\n<p>许多使用微服务构建的产品或系统都是由具有丰富的持续交付和持续集成经验的团队构建的，以这种方式构建软件的团队广泛使用基础设施自动化技术</p>\n<p>由于这并不是一篇关于持续交付的文章，我们在这里只关注持续交付的几个关键特性。我们希望有尽可能多的信心确保我们的软件正常运行，因此我们进行了大量的自动化测试。想让软件达到晋级 Promotion 状态从而推上流水线，就意味着要在每一个新的环境中，对软件进行自动化部署。</p>\n<p>一个单体应用程序可以非常愉快地通过这些环境构建、测试和推动。事实证明，一旦你为单体投入了自动化整体生产，那么部署更多的应用程序似乎不再那么可怕了。请记住，持续交付的目标之一就是让部署工作变得枯燥，所以无论是一个还是三个应用程序，只要部署工作依旧很枯燥，那么就没什么可担心的了。</p>\n<p>我们看到团队大量的基础设施自动化的另一个领域是在管理生产环境中的微服务。与我们上面的断言（只要部署很无聊）相比，单体和微服务之间没有太大的区别，但是每个部署的运行环境可能会截然不同。</p>\n<h5 id="设计时为故障做好准备"><a href="#%E8%AE%BE%E8%AE%A1%E6%97%B6%E4%B8%BA%E6%95%85%E9%9A%9C%E5%81%9A%E5%A5%BD%E5%87%86%E5%A4%87" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>设计时为故障做好准备</h5>\n<p>使用服务作为组件的结果是，需要设计应用程序以便它们能够容忍服务的失败。如果服务提供者商不可用，任何服务呼叫都可能失败，客户必须尽可能优雅地对此做出响应。与单体设计相比，这是一个缺点，因为它这会引入额外的复杂性来处理它。结果是微服务团队不断反思服务失败是如何影响用户体验的。Netflix 的 Simian Army 能够引发服务甚至数据中心的故障在工作日发生故障，从而来测试应用程序的弹性和监控能力。</p>\n<p>生产中的这种自动化测试足以让大多数运维团队兴奋得浑身颤栗，就像在一周的长假即将到来前一样。这并不是说单体架构风格不能构建先进的监控系统——只是根据我们的经验，这在单体系统中并不常见罢了。</p>\n<p>由于服务可能随时发生故障，因此能够快速检测故障并在可能的情况下自动恢复服务就显得至关重要。微服务应用程序非常重视应用程序的实时监控，比如检查架构元素（数据库每秒获得多少请求）和业务相关度量（例如每分钟收到多少订单）。语义监控可以提供出现问题的早期预警系统，从而触发开发团队跟进和调查。</p>\n<p>这对于微服务架构来说尤为重要，因为微服务偏好编排和事件写作，这会导致一些紧急状况。虽然许多权威人士对于偶然事件的价值持积极态度，但事实是，突发行为有时可能是一件坏事。监控至关重要，它能够快速发现不良紧急行为并进行修复。</p>\n<p>单体系统也可以像微服务一样实现透明的监控——事实上，它们也应该如此。不同之处在于你必须能够知道在不同进程中运行的服务在何时断开了连接。对于同一过程中的库，这种透明性用处并不大。</p>\n<p>微服务团队希望看到针对每个服务的复杂监控和日志记录，例如显示“运行/宕机”状态的仪表盘以及各种运维和业务相关的指标。有关断路器状态，当前吞吐量和延迟的详细信息也是我们在工作中经常遇到的其他例子。</p>\n<h5 id="演化设计"><a href="#%E6%BC%94%E5%8C%96%E8%AE%BE%E8%AE%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>演化设计</h5>\n<p>微服务从业者通常有进化设计的背景，并把服务分解视为进一步的工具，使应用程序开发人员能够控制应用程序中的更改，而不会降低变更速度。变更控制并不一定意味着变更的减少——在正确的态度和工具的帮助下，你可以对软件进行频繁，快速且有良好控制的更改。</p>\n<p>每当要试图将软件系统分解为组件时，你就会面临这样的决策，即如何进行拆分——我们决定拆分应用程序的原则是什么？组件的关键属性具有独立替换和可升级性的特点——这意味着我们寻找这些点，想象如何在不影响其协作者的情况下重写组件。实际上，许多微服务组通过明确地期望许多服务被废弃而不是长期演变来进一步考虑这一点。</p>\n<p>Guardian 网站是设计和构建成单体应用程序的一个很好的例子，但是它也在微服务方向上不断发展演化。原先的单体系统仍然是网站的核心，但他们更喜欢通过构建一些微服务 API 的方式来添加新的功能。这种方法对于本质上是临时的功能尤其方便，例如处理体育赛事的专用页面。网站的这一部分可以使用快速开发语言快速组合在一起，在赛事结束后立即删除。我们在金融机构看到过类似的方法，为市场机会增加新服务，并在几个月甚至几周后丢弃。</p>\n<p>这种强调可替换性的特点，是模块化设计一般性原则的一个特例，即通过变化模式来驱动模块化的实现。大家都愿意将那些同时发生变化的东西放在同一个模块，很少变化的系统模块应该与目前正在经历大量变动的系统处于不同的服务中。如果你发现自己反复更改两项服务，那就表明它们应该合并了。</p>\n<p>将组件放入服务中可以为更细粒度的发布计划添加机会。对于单体来说，任何更改都需要完整构建和部署整个应用程序。但是，使用微服务，你只需要重新部署你修改的服务。这可以简化并加快发布过程。缺点是你必须担心一项服务的变化会打破其消费者。传统的集成方法是尝试使用版本控制来解决这个问题，但微服务世界中的偏好是仅仅把使用版本控制作为最后的手段。我们可以通过设计服务尽可能容忍服务提供者的变化来避免大量的版本控制。</p>\n<h4 id="微服务是未来吗？"><a href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%98%AF%E6%9C%AA%E6%9D%A5%E5%90%97%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>微服务是未来吗？</h4>\n<p>我们写这篇文章的主要目的是解释微服务的主要思想和原则。通过花时间来做到这一点，我们清楚地认为微服务架构风格是一个重要的想法——在研发企业系统时，值得对它进行认真考虑。我们最近使用这种方式构建了几个系统，并且了解到其它团队也赞同这种风格。</p>\n<p>我们了解到那些在某种程度上开创这种架构风格的先驱，包括亚马逊、Netflix、英国卫报、英国政府数字化服务中心、realestate.com.au、Forward 和 comparethemarket.com。2013 年的技术会议上充满了一些公司的例子，这些公司正在转向可以归类为微服务的公司，包括 Travis CI。此外，有很多组织长期以来一直在做我们称之为微服务的东西，但没有使用过这个名字。（通常这被标记为 SOA——尽管如我们所说，SOA 有许多相互矛盾的形式）</p>\n<p>然而，尽管有这些积极的经验，但并不是说我们确信微服务是软件架构的未来发展方向。虽然到目前为止我们的经验与整体应用相比是积极的，但我们意识到没有足够的时间让我们做出充分完整的判断。</p>\n<p>通常，架构决策所产生的真正效果，只有在该决策做出若干年后才能真正显现。我们已经看到由带着强烈的模块化愿望的优秀团队所做的一些项目，最终却构建出一个单体架构，并在几年之内不断腐化。许多人认为，如果使用微服务就不大可能出现这种腐化，因为服务的边界是明确的，而且难以随意搞乱。然而，对于那些开发时间足够长的各种系统，除非我们已经见识得足够多，否则我们无法真正评价微服务架构是如何成熟的。</p>\n<p>有人觉得微服务或许很难成熟起来，这当然是有原因的。在组件化上所做的任何工作的成功与否，取决于软件与组件的匹配程度。准确地搞清楚某个组件的边界的位置应该出现在哪里，是一项困难的工作。进化设计承认难以对边界进行正确定位，所以它将工作的重点放到了易于对边界进行重构之上。但是当各个组件成为各个进行远程通信的服务后，比起在单一进程内进行各个软件库之间的调用，此时的重构就变得更加困难。跨越服务边界的代码移动就变得困难起来。接口的任何变化，都需要在其各个参与者之间进行协调。向后兼容的层次也需要被添加进来。测试也会变得更加复杂。</p>\n<p>另一个问题是，如果这些组件不能干净利落地组合成一个系统，那么所做的一切工作，仅仅是将组件内的复杂性转移到组件之间的连接之上。这样做的后果，不仅仅是将复杂性搬了家，它还将复杂性转移到那些不再明确且难以控制的边界之上。当在观察一个小型且简单的组件内部时，人们很容易觉得事情已经变得更好了，然而他们却忽视了服务之间杂乱的连接。</p>\n<p>最后，还有一个团队技能的因素。新技术往往会被技术更加过硬的团队所采用。对于技术更加过硬的团队而更有效的一项技术，不一定适用于一个技术略逊一筹的团队。我们已经看到大量这样的案例，那些技术略逊一筹的团队构建出了杂乱的单体架构。当这种杂乱发生到微服务身上时，会出现什么情况？这需要花时间来观察。一个糟糕的团队，总会构建一个糟糕的系统——在这种情况下，很难讲微服务究竟是减少了杂乱，还是让事情变得更糟。</p>\n<p>我们听到的一个合理的论点是，你不应该从微服务架构开始，而是从整体开始，保持模块化，并在整体出现问题时将其拆分为微服务。（这个建议并不理想，因为好的进程内接口通常不是一个好的服务接口。）</p>\n<p>所以我们谨慎乐观地写下这个。到目前为止，我们已经看到了足够多的微服务风格，觉得它可能是一条值得走的路。我们无法确定最终会在哪里结束，但软件开发的挑战之一是你只能根据你当前必须拥有的不完善信息做出决策。</p>\n<h3 id="从单体式架构迁移到微服务架构"><a href="#%E4%BB%8E%E5%8D%95%E4%BD%93%E5%BC%8F%E6%9E%B6%E6%9E%84%E8%BF%81%E7%A7%BB%E5%88%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>从单体式架构迁移到微服务架构</h3>\n<p>迁移单体式应用到微服务架构意味着一系列现代化过程，有点像这几代开发者一直在做的事情，实时上，当迁移时，我们可以重用一些想法。</p>\n<p>一个策略是：不要大规模（big bang）重写代码（只有当你承担重建一套全新基于微服务的应用时候可以采用重写这种方法）。重写代码听起来很不错，但实际上充满了风险最终可能会失败，就如 Martin Fowler 所说：</p>\n<blockquote>\n<p>the only thing a Big Bang rewrite guarantees is a Big Bang!</p>\n</blockquote>\n<p>相反，应该采取逐步迁移单体式应用的策略，通过逐步生成微服务新应用，与旧的单体式应用集成，随着时间推移，单体式应用在整个架构中比例逐渐下降直到消失或者成为微服务架构一部分。这个策略有点像在高速路上限速到 70 迈对车做维护，尽管有挑战，但是比起重写的风险小很多。</p>\n<p>Martin Fowler 将这种现代化策略成为绞杀（Strangler）应用，名字来源于雨林中的绞杀藤（strangler vine），也叫绞杀榕（strangler fig）。绞杀藤为了爬到森林顶端都要缠绕着大树生长，一段时间后，树死了，留下树形藤。这种应用也使用同一种模式，围绕着传统应用开发了新型微服务应用，传统应用会渐渐退出舞台。</p>\n<p>我们来看看其他可行策略。</p>\n<h4 id="策略-1：停止挖掘"><a href="#%E7%AD%96%E7%95%A5-1%EF%BC%9A%E5%81%9C%E6%AD%A2%E6%8C%96%E6%8E%98" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>策略 1：停止挖掘</h4>\n<p>Law of Holes 是说当自己进洞就应该停止挖掘。对于单体式应用不可管理时这是最佳建议。换句话说，应该停止让单体式应用继续变大，也就是说当开发新功能时不应该为旧单体应用添加新代码，最佳方法应该是将新功能开发成独立微服务。如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-09-29-09-52-00-c608303ef436c1765c6b2eabc05a4484-c8bcb.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 711px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 102.81293952180029%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAVCAIAAADJt1n/AAAACXBIWXMAAAsSAAALEgHS3X78AAACNElEQVQ4y5VUWW7bMBDVVdtrtDcqUKAfLdCPpigQxHFax/GSyNa+W5ZlSWS0UCIpdWQFjrzERQeEwCHnzQwfHyU054xSKknSdDYbDAcLccEYOxsmNG9bWVcwLgRcAo+SxzES/xtcN/WX4Oqd+OH94uPXzS9w/w2u65rXHCYxRVpmf1K+fVa/65mzpQkswhYEXKrcFUkYlpA+mozvp2MZGwnF+603wUVRIIyrskQsdcnaoK5OXZcEmKWEEPyMsyw7A+76kWT56sfPpSmTpmzZ5hWMNmlDZEuBLVEU98EH4HapblKSbUmya7HuHySmOC2ymvPjyl0mCOKMRRXiu+gjbljNEE+Pjt2Cq6oKw20UxXf3f6biPIkTcPhhEbCMFZimO9p7beu6vl4H2zCyfcdZuXGc2LbjrVb9+i+3UGFIsXPbFSEMQ9d1X+J6TRmGURTkVBimb8uSTMp2S1AUtdN9x1h78l3DCKPb33eO72R1kdEi47lm6ZPZdK4+TZYzea0qiSYEQXBETzcvCLme3Mq2WjWUsJLwUrKUm8dhnueQnTJ64w1f2fZ9fzafQyN7JdCKGrrx+k4Z9dKVKivj8cMm3IyCB2HPKmgIIQTI/etN09Q0zY6uFsypjoySVnlZ5FVx7Q4Ez/NOb7XzNE3v6xHoMJBlP7vOswdfKVYETddB0u3t9QzcKIocxz3NeyASjLHR9dbXE+eqpsHP6PTN9UdLGEhClhXTtAzDhGGZ9mKxBJFdLgv2FwE1uwAaSiY1AAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 09 29 09 52 00" title="" data-src="/static/2023-09-29-09-52-00-c608303ef436c1765c6b2eabc05a4484-c8bcb.png" data-srcset="/static/2023-09-29-09-52-00-c608303ef436c1765c6b2eabc05a4484-af944.png 200w,\n/static/2023-09-29-09-52-00-c608303ef436c1765c6b2eabc05a4484-e4377.png 400w,\n/static/2023-09-29-09-52-00-c608303ef436c1765c6b2eabc05a4484-c8bcb.png 711w" data-sizes="(max-width: 711px) 100vw, 711px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>除了新服务和传统应用，还有两个模块，其一是请求路由器，负责处理入口（http）请求，有点像之前提到的 API 网关。路由器将新功能请求发送给新开发的服务，而将传统请求发给单体式应用。</p>\n<p>另外一个是胶水代码（glue code），将微服务和单体应用集成起来，微服务很少能独立存在，经常会访问单体应用的数据。胶水代码，可能在单体应用或者为服务或者二者兼而有之，负责数据整合。微服务通过胶水代码从单体应用中读写数据。​</p>\n<p>微服务有三种方式访问单体应用数据：</p>\n<ul>\n<li>换成单体应用提供的远程 API</li>\n<li>直接访问单体应用数据库</li>\n<li>自己维护一份从单体应用中同步的数据</li>\n</ul>\n<p>胶水代码也被称为容灾层（anti-corruption layer），这是因为胶水代码保护微服务全新域模型免受传统单体应用域模型污染。胶水代码在这两种模型间提供翻译功能。术语 anti-corruption layer 第一次出现在 Eric Evans 撰写的必读书 <code class="language-text">Domain Driven Design</code>，随后就被提炼为一篇白皮书。开发容灾层可能有点不是很重要，但却是避免单体式泥潭的必要部分。</p>\n<p>将新功能以轻量级微服务方式实现有很多优点，例如可以阻止单体应用变的更加无法管理。微服务本身可以开发、部署和独立扩展。采用微服务架构会给开发者带来不同的切身感受。</p>\n<p>然而，这方法并不解决任何单体式本身问题，为了解决单体式本身问题必须深入单体应用做出改变。我们来看看这么做的策略。</p>\n<h4 id="策略-2：将前端和后端分离"><a href="#%E7%AD%96%E7%95%A5-2%EF%BC%9A%E5%B0%86%E5%89%8D%E7%AB%AF%E5%92%8C%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>策略 2：将前端和后端分离</h4>\n<p>减小单体式应用复杂度的策略是讲表现层和业务逻辑、数据访问层分开。典型的企业应用至少有三个不同元素构成：</p>\n<ol>\n<li>表现层 —— 处理 HTTP 请求，要么响应一个 RESTAPI 请求，要么是提供一个基于 HTML 的图形接口。对于一个复杂用户接口应用，表现层经常是代码重要的部分。</li>\n<li>业务逻辑层 —— 完成业务逻辑的应用核心。</li>\n<li>数据访问层 —— 访问基础元素，例如数据库和消息代理。</li>\n</ol>\n<p>在表现层与业务数据访问层之间有清晰的隔离。业务层有由若干方面组成的粗粒度（coarse-grained）的 API，内部包含了业务逻辑元素。API 是可以将单体业务分割成两个更小应用的天然边界，其中一个应用是表现层，另外一个是业务和数据访问逻辑。分割后，表现逻辑应用远程调用业务逻辑应用，下图表示迁移前后架构不同：​</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-09-29-09-56-24-0c44dfc20d86e2b914b160430046fb2e-6f1f8.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 55.18590998043052%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsSAAALEgHS3X78AAABJUlEQVQoz31Ry3KDMAzM/39Qp+cce+21k0wDTmhI0/ghWVgGujyGpu2QHcYYodVKq00/gpkrU4k0/R1U9XSsvPP9CjbTS5LsPg+a9f5f13WHq6GGhzu+cPwhT6Gr2qePLbVxpo0nCT9X270t/rGGurMy+IFD/XXhOItMPfvgOQvi5MJbeH+5vWqXfSbO8YcsjWDmQYoopbS4EEVwcd7V9aWieh9KMBGJreCZySEEESEmZIMPZauelCkQ9HnEUA4cjeypSQ2qIG2YGUzwhz69b1JCpO1aZKOLRR/TaKcuk7ZKOfKijGzn/flco0T/EKwRFli2ky/zquBNeTJTew+AHs3R3Kz9tecYY1GWi1tryDmDvDS4WbwtikLm8VYBX0pjnHPTqr8BdAyDl1JDdDUAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 09 29 09 56 24" title="" data-src="/static/2023-09-29-09-56-24-0c44dfc20d86e2b914b160430046fb2e-fee1c.png" data-srcset="/static/2023-09-29-09-56-24-0c44dfc20d86e2b914b160430046fb2e-a67b7.png 200w,\n/static/2023-09-29-09-56-24-0c44dfc20d86e2b914b160430046fb2e-0b187.png 400w,\n/static/2023-09-29-09-56-24-0c44dfc20d86e2b914b160430046fb2e-fee1c.png 800w,\n/static/2023-09-29-09-56-24-0c44dfc20d86e2b914b160430046fb2e-6f1f8.png 1022w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>单体应用这么分割有两个好处，其一使得应用两部分开发、部署和扩展各自独立，特别地，允许表现层开发者在用户界面上快速选择，进行 A/B 测试；其二，使得一些远程 API 可以被微服务调用。</p>\n<p>然而，这种策略只是部分的解决方案。很可能应用的两部分之一或者全部都是不可管理的，因此需要使用第三种策略来消除剩余的单体架构。</p>\n<h4 id="策略-3：抽出服务"><a href="#%E7%AD%96%E7%95%A5-3%EF%BC%9A%E6%8A%BD%E5%87%BA%E6%9C%8D%E5%8A%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>策略 3：抽出服务</h4>\n<p>第三种迁移策略就是从单体应用中抽取出某些模块成为独立微服务。每当抽取一个模块变成微服务，单体应用就变简单一些；一旦转换足够多的模块，单体应用本身已经不成为问题了，要么消失了，要么简单到成为一个服务。</p>\n<h5 id="排序那个模块应该被转成微服务"><a href="#%E6%8E%92%E5%BA%8F%E9%82%A3%E4%B8%AA%E6%A8%A1%E5%9D%97%E5%BA%94%E8%AF%A5%E8%A2%AB%E8%BD%AC%E6%88%90%E5%BE%AE%E6%9C%8D%E5%8A%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>排序那个模块应该被转成微服务</h5>\n<p>一个巨大的复杂单体应用由成十上百个模块构成，每个都是被抽取对象。决定第一个被抽取模块一般都是挑战，一般最好是从最容易抽取的模块开始，这会让开发者积累足够经验，这些经验可以为后续模块化工作带来巨大好处。</p>\n<p>转换模块成为微服务一般很耗费时间，一般可以根据获益程度来排序，一般从经常变化模块开始会获益最大。一旦转换一个模块为微服务，就可以将其开发部署成独立模块，从而加速开发进程。</p>\n<p>将资源消耗大户先抽取出来也是排序标准之一。例如，将内存数据库抽取出来成为一个微服务会非常有用，可以将其部署在大内存主机上。同样的，将对计算资源很敏感的算法应用抽取出来也是非常有益的，这种服务可以被部署在有很多 CPU 的主机上。通过将资源消耗模块转换成微服务，可以使得应用易于扩展。</p>\n<p>查找现有粗粒度边界来决定哪个模块应该被抽取，也是很有益的，这使得移植工作更容易和简单。例如，只与其他应用异步同步消息的模块就是一个明显边界，可以很简单容易地将其转换为微服务。</p>\n<h5 id="如何抽取模块"><a href="#%E5%A6%82%E4%BD%95%E6%8A%BD%E5%8F%96%E6%A8%A1%E5%9D%97" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>如何抽取模块</h5>\n<p>抽取模块第一步就是定义好模块和单体应用之间粗粒度接口，由于单体应用需要微服务的数据，反之亦然，因此更像是一个双向 API。因为必须在负责依赖关系和细粒度接口模式之间做好平衡，因此开发这种 API 很有挑战性，尤其对使用域模型模式的业务逻辑层来说更具有挑战，因此经常需要改变代码来解决依赖性问题</p>\n<p>一旦完成粗粒度接口，也就将此模块转换成独立微服务。为了实现，必须写代码使得单体应用和微服务之间通过使用进程间通信（IPC）机制的 API 来交换信息。如图所示迁移前后对比：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-09-29-09-58-24-1e61b87151b94eacc4b7e922c10acd39-69166.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 702px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 132.47863247863248%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAaCAIAAAA44esqAAAACXBIWXMAAAsSAAALEgHS3X78AAAC10lEQVQ4y31U23KbMBDl/3+j06f2KU/thySZxE0ccwdJXCSEhISgR8gltpN0Z8xgsbtn9+weReu6LsuC56tMfqS/Osv9yepPdgt/eyt+pr8P8rSfRPi5xdugZSs7NSmkcjfBywKfyU5wgNsW4nxwgB1HRQmtqrJpGmMMEl+A+3drTF3XpziuykpKGTJGAJnnmTLatA3nnDWsbVoPvixmNnqe3OpBGGNZnmutq6oqinJ2M84j5FdKtW1LGWu7LjyttUDrNS9HYhYLz67r5Cjbru05H6QcBrn4slffDzBHpYqyRCLOxc5iaA9vQgilNcCRou97B1sX3zPip2miFD3X6Bld3LCN7LNzrGmSNC2rCsUHUqKdOoQdT2/DMATvG7bxFMOQ5CmhdN5gz6MK38DZa3zk4qrmYJMz02rQWlykNSVgK5xHuwc4SOIEc1qvzRjbGj6vzhqbpqnYsr8Hn5Epvb9/CGVfIvdacOsPEfb0/EwI2TbsGtlzxphv58LsMjPbB/7wCdOG2xXyf0w5LWb51ddor0HO4wN/ueH5Rh4P4kVYeVV2CPgznL7Fd+3Xquqs+H66exJHH/KuqnVT1STZ0Cqj/fsgwe25bWsxYRxOi2l0N1i544UNW9WoyrLKihyrgvVM8qyqK4wNywR6sVViHIhib3lc9PXo1FlVy6YqLACElucFRkWwRIwN8jwznDesIZx5kSkN524WmAI07sse5YgYLAMQgAYBweNqt1dXC6rGMWGZRgY/gtGX7fz8HISCAXZ9DxyIviak5z2UiCx4qauaCmZWr00YSN2k9k9VQdL9ZqgiLwvsg7Uz2EIT4ELqEdUy3jDdATmM4F1V8H49HsPqQtt75XhB6k1VIkkTQon7qCrI5fD2govifG1d6DE4dH13yuKyrj5XVZpmH1V1IS+TZdnnqkLZj4+P+8348TIAF4fDgVLyiTAQhpsVDH2FjObhEDQb7C+Og+bxl7xdSAAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 09 29 09 58 24" title="" data-src="/static/2023-09-29-09-58-24-1e61b87151b94eacc4b7e922c10acd39-69166.png" data-srcset="/static/2023-09-29-09-58-24-1e61b87151b94eacc4b7e922c10acd39-c9f7c.png 200w,\n/static/2023-09-29-09-58-24-1e61b87151b94eacc4b7e922c10acd39-bfd8b.png 400w,\n/static/2023-09-29-09-58-24-1e61b87151b94eacc4b7e922c10acd39-69166.png 702w" data-sizes="(max-width: 702px) 100vw, 702px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>此例中，正在使用 Y 模块的 Z 模块是备选抽取模块，其元素正在被 X 模块使用，迁移第一步就是定义一套粗粒度 APIs，第一个接口应该是被 X 模块使用的内部接口，用于激活 Z 模块；第二个接口是被 Z 模块使用的外部接口，用于激活 Y 模块。</p>\n<p>迁移第二步就是将模块转换成独立服务。内部和外部接口都使用基于 IPC 机制的代码，一般都会将 Z 模块整合成一个微服务基础框架，出来割接过程中的问题，例如服务发现。</p>\n<p>抽取完模块，也就可以开发、部署和扩展另外一个服务，此服务独立于单体应用和其它服务。可以从头写代码实现服务；这种情况下，将服务和单体应用整合的 API 代码成为容灾层，在两种域模型之间进行翻译工作。每抽取一个服务，就朝着微服务方向前进一步。随着时间推移，单体应用将会越来越简单，用户就可以增加更多独立的微服务。将现有应用迁移成微服务架构的现代化应用，不应该通过从头重写代码方式实现，相反，应该通过逐步迁移的方式。有三种策略可以考虑：将新功能以微服务方式实现；将表现层与业务数据访问层分离；将现存模块抽取变成微服务。随着时间推移，微服务数量会增加，开发团队的弹性和效率将会大大增加。</p>\n<h3 id="微服务的事件驱动数据管理"><a href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%9A%84%E4%BA%8B%E4%BB%B6%E9%A9%B1%E5%8A%A8%E6%95%B0%E6%8D%AE%E7%AE%A1%E7%90%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>微服务的事件驱动数据管理</h3>\n<p>单体式应用一般都会有一个关系型数据库，由此带来的好处是应用可以使用 ACID transactions，可以带来一些重要的操作特性：</p>\n<ol>\n<li>原子性 – 任何改变都是原子性的</li>\n<li>一致性 – 数据库状态一直是一致性的</li>\n<li>隔离性 – 即使交易并发执行，看起来也是串行的</li>\n<li>Durable – 一旦交易提交了就不可回滚</li>\n</ol>\n<p>鉴于以上特性，应用可以简化为：开始一个交易，改变（插入，删除，更新）很多行，然后提交这些交易。</p>\n<p>使用关系型数据库带来另外一个优势在于提供 SQL（功能强大，可声明的，表转化的查询语言）支持。用户可以非常容易通过查询将多个表的数据组合起来，RDBMS 查询调度器决定最佳实现方式，用户不需要担心例如如何访问数据库等底层问题。另外，因为所有应用的数据都在一个数据库中，很容易去查询。</p>\n<p>然而，对于微服务架构来说，数据访问变得非常复杂，这是因为数据都是微服务私有的，唯一可访问的方式就是通过 API。这种打包数据访问方式使得微服务之间松耦合，并且彼此之间独立。如果多个服务访问同一个数据，schema 会更新访问时间，并在所有服务之间进行协调。</p>\n<p>更甚于，不同的微服务经常使用不同的数据库。应用会产生各种不同数据，关系型数据库并不一定是最佳选择。某些场景，某个 NoSQL 数据库可能提供更方便的数据模型，提供更加的性能和可扩展性。例如，某个产生和查询字符串的应用采用例如 Elasticsearch 的字符搜索引擎。同样的，某个产生社交图片数据的应用可以采用图片数据库例如 Neo4j；因此，基于微服务的应用一般都使用 SQL 和 NoSQL 结合的数据库，也就是被称为 polyglot persistence 的方法。</p>\n<p>分区的，polyglot-persistent 架构用于存储数据有许多优势，包括松耦合服务和更佳性能和可扩展性。然而，随之而来的则是分布式数据管理带来的挑战。</p>\n<p>第一个挑战在于如何完成一笔交易的同时保持多个服务之间数据一致性。之所以会有这个问题，我们以一个在线 B2B 商店为例，客户服务维护包括客户的各种信息，例如 credit lines 。订单服务管理订单，需要验证某个新订单与客户的信用限制没有冲突。在单一式应用中，订单服务只需要使用 ACID 交易就可以检查可用信用和创建订单。</p>\n<p>相反的，微服务架构下，订单和客户表分别是相对应服务的私有表，如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-09-29-10-00-19-c2f0ef3aebe9eba366fa69e695182fa2-5fd40.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 54.864253393665166%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsSAAALEgHS3X78AAABaklEQVQoz1VRyU7DMBDNT/MDXDkibhx7hBMHENfekRCoUhFQumRpNidxErxNwnPcumU0sifz3hvPTAIiGo42OhtG93kOndDRoSPQwGf1YB7z+Sx5KFXtKxz0o+V89pvb8O6lWfgSgcdCkV7/zC6XN2/8w1f0b9JAT+n84v3qPnquNHeZAMWdONNsW0VhHoVy35OYlDS5ReWg1nz3Fa52LCp1fRQfH1GktyJZiZDpBt6bX9QkW/tAgOZb7BJVuMeQD+hsH4qUGxiamjq2W5hk4/u3etlgNf9m9mtEb5VpPFVultXqtRuEJ2AiQfIkxtU0PM0yJRWT9baLMaY22hgzIiKTymLdR2XJiqKI670yykLojoYAUZZleZ5HcVyU4JQgMVYhR2QwMnh1x5Hcw5K0scb7vkc+0FpzzvE/lTU9nbY2KIBc/23XSSnRjgRDayFE27ZWDB4i6NvJ3I0TDsjtUknpCN1kiKHHpv8Amud6rd+BOC8AAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 09 29 10 00 19" title="" data-src="/static/2023-09-29-10-00-19-c2f0ef3aebe9eba366fa69e695182fa2-fee1c.png" data-srcset="/static/2023-09-29-10-00-19-c2f0ef3aebe9eba366fa69e695182fa2-a67b7.png 200w,\n/static/2023-09-29-10-00-19-c2f0ef3aebe9eba366fa69e695182fa2-0b187.png 400w,\n/static/2023-09-29-10-00-19-c2f0ef3aebe9eba366fa69e695182fa2-fee1c.png 800w,\n/static/2023-09-29-10-00-19-c2f0ef3aebe9eba366fa69e695182fa2-5fd40.png 884w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>订单服务不能直接访问客户表，只能通过客户服务发布的 API 来访问。订单服务也可以使用 distributed transactions, 也就是周知的两阶段提交 (2PC)。然而，2PC 在现在应用中不是可选性。根据 CAP 理论，必须在可用性（availability）和 ACID 一致性（consistency）之间做出选择，availability 一般是更好的选择。但是，许多现代科技，例如许多 NoSQL 数据库，并不支持 2PC。在服务和数据库之间维护数据一致性是非常根本的需求，因此我们需要找其他的方案。</p>\n<p>第二个挑战是如何完成从多个服务中搜索数据。例如，设想应用需要显示客户和他的订单。如果订单服务提供 API 来接受用户订单信息，那么用户可以使用类应用型的 join 操作接收数据。应用从用户服务接受用户信息，从订单服务接受此用户订单。假设，订单服务只支持通过私有键（key）来查询订单（也许是在使用只支持基于主键接受的 NoSQL 数据库），此时，没有合适的方法来接收所需数据。</p>\n<h4 id="事件驱动架构"><a href="#%E4%BA%8B%E4%BB%B6%E9%A9%B1%E5%8A%A8%E6%9E%B6%E6%9E%84" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>事件驱动架构</h4>\n<p>对许多应用来说，这个解决方案就是使用事件驱动架构（event-driven architecture）。在这种架构中，当某件重要事情发生时，微服务会发布一个事件，例如更新一个业务实体。当订阅这些事件的微服务接收此事件时，就可以更新自己的业务实体，也可能会引发更多的事件发布。</p>\n<p>可以使用事件来实现跨多服务的业务交易。交易一般由一系列步骤构成，每一步骤都由一个更新业务实体的微服务和发布激活下一步骤的事件构成。下图展现如何使用事件驱动方法，在创建订单时检查信用可用度，微服务通过消息代理（Messsage Broker）来交换事件。</p>\n<ol>\n<li>订单服务创建一个带有 NEW 状态的 Order（订单），发布了一个 <code class="language-text">Order Created Event（创建订单）</code> 的事件。</li>\n</ol>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-09-29-11-02-11-81aff6dcc23788181a054bbddd363a70-4767d.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 68.64801864801865%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAIAAACgpqunAAAACXBIWXMAAAsSAAALEgHS3X78AAABnklEQVQoz41SW47UMBDMsfngDEgcAokDIA7BB0JCq9Gy2g9m8/JMMrYTP9puP2jHYXYWpNWWIstOd7mry93kilSW36xdl7WcUspvQJM2ENlHXLyizf4n55gixhBiSDeoheq+uRbhKB/NcYvtSeBgXVelFW78mnbx0kb3XLnuPvVf3v/62JrxeDyy6eQzKtCVTMVJBeV0lr27//C5//qC7JK/4w/fx7snOwi7CJCT5xcj1KoIG7mkDXD+1v74eb6nq19Unrzo4OSivxoG3i3LQuSrbIr2cCLl/8rGFJagd+93MlhrjTUYMVdXc5a4UuYzGQDQo0LDYKKE+NdV593hcGjbttpLbXvvmZkM2vq0TQhhZGwYxonPk5ilXIQQdF11mzHGOQ+bW2TeU9t2XaeUJtBtDSIKKT0iOAfgLADZS9FKLlmGZBed1DxF6fMBq4tNjJHCVMra0mFdSV417PpUdKTm53kWUpCLW+WbIbnFf0NSHoY4fT+M43g6ny+cF/Iro3s7YUW21s453EDWkORXySRbr9roIjtlYm4O7CDyH+r7LYhIiFt4AAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 09 29 11 02 11" title="" data-src="/static/2023-09-29-11-02-11-81aff6dcc23788181a054bbddd363a70-fee1c.png" data-srcset="/static/2023-09-29-11-02-11-81aff6dcc23788181a054bbddd363a70-a67b7.png 200w,\n/static/2023-09-29-11-02-11-81aff6dcc23788181a054bbddd363a70-0b187.png 400w,\n/static/2023-09-29-11-02-11-81aff6dcc23788181a054bbddd363a70-fee1c.png 800w,\n/static/2023-09-29-11-02-11-81aff6dcc23788181a054bbddd363a70-4767d.png 858w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<ol start="2">\n<li>客户服务消费 Order Created Event 事件，为此订单预留信用，发布 <code class="language-text">Credit Reserved Event（信用预留）</code> 事件。</li>\n</ol>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-09-29-11-02-44-cdf2d78ff97efe4208d3bf8d64bf72f4-de7e2.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 59.70319634703196%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAAsSAAALEgHS3X78AAABdElEQVQoz4VSy07DMBDsv3PmzJUP4Au4wY0DEhKgCom3SkKdFDu21++NWcdpaZEQo8TabGY067EXOOI4AcuDecxjLXI23kqttAXnHGiTJyRME6VgQW/tnrHz47dTHiXVtWmdVUoZa1Zd87R6EUndqoejl5NreU9/cScOY7zqby4+rrr49SP2lowlKDmahrVP69dHeD9/vrzjD5Uzi2nctdt8GOYw7ImdkorEG88Hp3Q0Q9QraEWQB2KCxwDJ1no3tjEGDOw4hCGpmsgs9iFgTAYdT/KXeLlcso7VTkqJkmtth3krRkTG2HrNOt5/ckZzCiFijHXspmnEIChe+qR+27Zd12mtwZTwF8Qb5OC8s2RkyyKGgRwOxs7FlpIPIdCaEEk/O1NFKmMLlQoAqM6GjkoqDYVH3kprLriU1Cr8ec9j3p76HupRkY8GwOnzi/PPCX3fU7+Mnf9GvSTFeTu2d95MoP3/Jw6WlGChXt8awQSKxlHrG8c4ts/g+cy6AAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 09 29 11 02 44" title="" data-src="/static/2023-09-29-11-02-44-cdf2d78ff97efe4208d3bf8d64bf72f4-fee1c.png" data-srcset="/static/2023-09-29-11-02-44-cdf2d78ff97efe4208d3bf8d64bf72f4-a67b7.png 200w,\n/static/2023-09-29-11-02-44-cdf2d78ff97efe4208d3bf8d64bf72f4-0b187.png 400w,\n/static/2023-09-29-11-02-44-cdf2d78ff97efe4208d3bf8d64bf72f4-fee1c.png 800w,\n/static/2023-09-29-11-02-44-cdf2d78ff97efe4208d3bf8d64bf72f4-de7e2.png 876w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<ol start="3">\n<li>订单服务消费 Credit Reserved Event ，改变订单的状态为 OPEN。</li>\n</ol>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-09-29-11-03-05-72f6a6fc58ec12c9a44b0139f47e3f45-ce399.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 59.97745208568207%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAAsSAAALEgHS3X78AAABgUlEQVQoz32STW7bMBCFffOeoLtcoIveoLsum126SoAgXiRBYMOyLMsR/2YoUiT7hozdZJE8CAR/5tO8GXKVUso5l1yWtMQUMTl/mWbW1li2WLUwxIUUihyKViknLFLJP/e/vr/80MkqpSatsENMxhhLDkwLu9F3356u7u2j8OUM20Q3w+2f3d9Hv3kZNvvpYBMbtkgscLUWcnxQT7+fr9fquVSt5EAypwOPOzr4PNd9CSdmrXXL3MKmoDe2U8F8gKGYo1ncpR6IPUMw35YtbIxTM/sGxxhzSm7hMUwXWGpxdv2wHl9PbRM9CzEe5lFqaPCyLF3X9fseQf3rYLRBw2KQljqi7XartGrw6XTCct/3XCVwCGGaJozzPBMsMkuPiHBG1bRjmcOdUpq9R/+990hQrwqGrWs/I2ojSSEVvlwVhH0UghFwqNYEft+k/0K3vcCuXVUpx+Nxt+vwDcPgnLR2VT5Xywy42bbWIiHSMp9tfwX7y/PMeLy4OaqFNeeA/wFcX7eZgkZmJgAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 09 29 11 03 05" title="" data-src="/static/2023-09-29-11-03-05-72f6a6fc58ec12c9a44b0139f47e3f45-fee1c.png" data-srcset="/static/2023-09-29-11-03-05-72f6a6fc58ec12c9a44b0139f47e3f45-a67b7.png 200w,\n/static/2023-09-29-11-03-05-72f6a6fc58ec12c9a44b0139f47e3f45-0b187.png 400w,\n/static/2023-09-29-11-03-05-72f6a6fc58ec12c9a44b0139f47e3f45-fee1c.png 800w,\n/static/2023-09-29-11-03-05-72f6a6fc58ec12c9a44b0139f47e3f45-ce399.png 887w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>更复杂的场景可以引入更多步骤，例如在检查用户信用的同时预留库存等。</p>\n<p>考虑到（a）每个服务原子性更新数据库和发布事件，然后（b）消息代理确保事件传递至少一次，然后可以跨多个服务完成业务交易（此交易不是 ACID 交易）。这种模式提供弱确定性，例如最终一致性 eventual consistency。这种交易类型被称作 BASE model。</p>\n<p>亦可以使用事件来维护不同微服务拥有数据预连接（pre-join）的实现视图。维护此视图的服务订阅相关事件并且更新视图。例如，客户订单视图更新服务（维护客户订单视图）会订阅由客户服务和订单服务发布的事件。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-09-29-11-03-35-7c82d6c6279687e4e2cc70ca12112b77-d152b.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 63.62559241706162%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAAAsSAAALEgHS3X78AAABoklEQVQoz5VRTU/bQBD1n+baH4CQeqiEuFRIvVS99FJu0FYVVdpLj6QBE4wTbyC24433+3uZtcOlQCVWo9Xs7Lx582ay+MoTQoghKqe5k9nrYDEKIcritiOd8CqB/VAtDLePKSU9H81DbIwMYLiddcyJrSU7ZhNM6iZGF7wOZhf01gb3L/+QBsiN2SZwzsu9/OCk+QH+Mfr8Zv6u1huQtL94f4g+UsWASihZr2suRaI1/Gj16e3yQ+a8W8i7b+XkAl9jRyarP9+LX0iuofDJxdlZfl70S8Tuy676/XNSNIuVqK9w8TU//zI9TcwyaKTWgISWWo8BCcPQ3ly2N/mmgOaTHO+stc4lFcrrxRaVuMrmN/PZ9O+at9WqupzOZvMZdXyU17m+93TQGZ8qh9FmXdc1dUM03ZIenPs20Y4Zwknp1DM7Gy2E3bRbi01I7XEvO9uPQfCl1//ZfCa1klpuJGaKG2O4EcQwY402higGQW13W3wGTBiFIyhnjIEEVFVoiTDG8KQ0/THOXgQzweA7YTkjhDRtA9ZTwjlnqSDjkr8EfgDORusKaE1w6wAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 09 29 11 03 35" title="" data-src="/static/2023-09-29-11-03-35-7c82d6c6279687e4e2cc70ca12112b77-fee1c.png" data-srcset="/static/2023-09-29-11-03-35-7c82d6c6279687e4e2cc70ca12112b77-a67b7.png 200w,\n/static/2023-09-29-11-03-35-7c82d6c6279687e4e2cc70ca12112b77-0b187.png 400w,\n/static/2023-09-29-11-03-35-7c82d6c6279687e4e2cc70ca12112b77-fee1c.png 800w,\n/static/2023-09-29-11-03-35-7c82d6c6279687e4e2cc70ca12112b77-d152b.png 844w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>当客户订单视图更新服务收到客户或者订单事件，就会更新客户订单视图数据集。可以使用文档数据库（例如 MongoDB）来实现客户订单视图，为每个用户存储一个文档。客户订单视图查询服务负责响应对客户以及最近订单（通过查询客户订单视图数据集）的查询。</p>\n<p>事件驱动架构也是既有优点也有缺点，此架构可以使得交易跨多个服务且提供最终一致性，并且可以使应用维护最终视图；而缺点在于编程模式比 ACID 交易模式更加复杂：为了从应用层级失效中恢复，还需要完成补偿性交易，例如，如果信用检查不成功则必须取消订单；另外，应用必须应对不一致的数据，这是因为临时（in-flight）交易造成的改变是可见的，另外当应用读取未更新的最终视图时也会遇见数据不一致问题。另外一个缺点在于订阅者必须检测和忽略冗余事件。</p>\n<h4 id="原子操作-achieving-atomicity"><a href="#%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C-achieving-atomicity" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>原子操作 Achieving Atomicity</h4>\n<p>事件驱动架构还会碰到数据库更新和发布事件原子性问题。例如，订单服务必须向 ORDER 表插入一行，然后发布 Order Created event，这两个操作需要原子性。如果更新数据库后，服务瘫了（crashes）造成事件未能发布，系统变成不一致状态。确保原子操作的标准方式是使用一个分布式交易，其中包括数据库和消息代理。然而，基于以上描述的 CAP 理论，这却并不是我们想要的。</p>\n<h5 id="使用本地交易发布事件"><a href="#%E4%BD%BF%E7%94%A8%E6%9C%AC%E5%9C%B0%E4%BA%A4%E6%98%93%E5%8F%91%E5%B8%83%E4%BA%8B%E4%BB%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用本地交易发布事件</h5>\n<p>获得原子性的一个方法是对发布事件应用采用 <code class="language-text">multi-step process involving only local transactions</code>，技巧在于一个 EVENT 表，此表在存储业务实体数据库中起到消息列表功能。应用发起一个（本地）数据库交易，更新业务实体状态，向 EVENT 表中插入一个事件，然后提交此次交易。另外一个独立应用进程或者线程查询此 EVENT 表，向消息代理发布事件，然后使用本地交易标志此事件为已发布，如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-09-29-11-04-05-684542c57d8b024355cbfcc87d201658-c4455.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 63.657407407407405%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAAAsSAAALEgHS3X78AAABZ0lEQVQoz6VSuU7DQBD1X1PxCxT8ATUVFV8AFRJJ5UghUi47Dmt77/sw4w1KLNIg5RXW7Oy892ZmXQxX8MnLoP8kU0rn2HjDBeeSF9dFT4eXu6+HtargGDPnHX/erx5nrBz8EGO0znLOhRAX8klZRjXry7fqozLHkAJkXHJzunhevc7ZYtfWW1ETyyRYi4mzVJJRhgVZy/1W1q3DWTGBeWW+K3U8WARHUNRWi9F44gyddKhDsrfJgzKSXUhxZA9DI1AvSTodYGZnRqqUk7ZjgiIe5HittLQKeexjaD2BOLhwroSZMcaEkAIh1DQNY0wrvaN1z7CzljIG+Q3ewxQbXCmAvuzfR18uyuVyWbRdBy2AjDZGMA4SXQbUCyacdU5bqRRC7dSZjevmBdBCjD4E772xxjlPKSWUGmOAA1+XAa2dn/p3ZliYtVZnmAwIfAbE4xVkchbiy09y/c7/BzjfQr7NmXEGC/sBVrPxNjDjXh0AAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 09 29 11 04 05" title="" data-src="/static/2023-09-29-11-04-05-684542c57d8b024355cbfcc87d201658-fee1c.png" data-srcset="/static/2023-09-29-11-04-05-684542c57d8b024355cbfcc87d201658-a67b7.png 200w,\n/static/2023-09-29-11-04-05-684542c57d8b024355cbfcc87d201658-0b187.png 400w,\n/static/2023-09-29-11-04-05-684542c57d8b024355cbfcc87d201658-fee1c.png 800w,\n/static/2023-09-29-11-04-05-684542c57d8b024355cbfcc87d201658-c4455.png 864w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>订单服务向 ORDER 表插入一行，然后向 EVENT 表中插入 Order Created event，事件发布线程或者进程查询 EVENT 表，请求未发布事件，发布他们，然后更新 EVENT 表标志此事件为已发布。</p>\n<p>此方法也是优缺点都有。优点是可以确保事件发布不依赖于 2PC，应用发布业务层级事件而不需要推断他们发生了什么；而缺点在于此方法由于开发人员必须牢记发布事件，因此有可能出现错误。另外此方法对于某些使用 NoSQL 数据库的应用是个挑战，因为 NoSQL 本身交易和查询能力有限。</p>\n<p>此方法因为应用采用了本地交易更新状态和发布事件而不需要 2PC，现在再看看另外一种应用简单更新状态获得原子性的方法。</p>\n<h5 id="挖掘数据库交易日志"><a href="#%E6%8C%96%E6%8E%98%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BA%A4%E6%98%93%E6%97%A5%E5%BF%97" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>挖掘数据库交易日志</h5>\n<p>另外一种不需要 2PC 而获得线程或者进程发布事件原子性的方式就是挖掘数据库交易或者提交日志。应用更新数据库，在数据库交易日志中产生变化，交易日志挖掘进程或者线程读这些交易日志，将日志发布给消息代理。如下图：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-09-29-11-04-38-24edb31bcacaa922281f61d794d60eea-60072.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 75.3114382785957%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAIAAABr+ngCAAAACXBIWXMAAAsSAAALEgHS3X78AAABbklEQVQoz6VRyU7DMBTMF/MZiH/gCCdOSFyQOHNCSKBKLAegREmzNI73LV7Ca90WilALYmJF8rPnzfNMFscFXPSn1cXR9Li1CLZxTOU9yNI95MhVdX3ycl6Yei/HOmvdACtLEiKoWs1nou0d3c2MMXLJueBMsCyVwuDpwJsB7ZVdkgUAWqzIBBNltQj6N2SxIcPGBw9V5sRMt+CA8857v0X44t+WslSqKMuiKFCP5n3HGTfGwBn8dyhrraFFxjnc503TUEKUUowxOA4hKLV6AqT4pgru5WYKQkme55jiBZlQ2iEEC2MsJYyitDM9w5hjE+0tfTh4PjxrLqVVVDIdTI/7yWTS9V0GUpTS+RIwLTChV02bElclqqa6fMKvN9O7++Yx51WJ65mZSyXdMAglssE54IAcaIo1jDbwuDQnsuRdlJVuk23JMJj3M6ofjFlcWzUI8KXKGMPabbaD/C2nTVpbOY9/xH/JMDDkSwT9ANDuZ+v892saAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 09 29 11 04 38" title="" data-src="/static/2023-09-29-11-04-38-24edb31bcacaa922281f61d794d60eea-fee1c.png" data-srcset="/static/2023-09-29-11-04-38-24edb31bcacaa922281f61d794d60eea-a67b7.png 200w,\n/static/2023-09-29-11-04-38-24edb31bcacaa922281f61d794d60eea-0b187.png 400w,\n/static/2023-09-29-11-04-38-24edb31bcacaa922281f61d794d60eea-fee1c.png 800w,\n/static/2023-09-29-11-04-38-24edb31bcacaa922281f61d794d60eea-60072.png 883w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>此方法的例子如 LinkedIn Databus 项目，Databus 挖掘 Oracle 交易日志，根据变化发布事件，LinkedIn 使用 Databus 来保证系统内各记录之间的一致性。</p>\n<p>另外的例子如：AWS 的 streams mechanism in AWS DynamoDB，是一个可管理的 NoSQL 数据库，一个 DynamoDB 流是由过去 24 小时对数据库表基于时序的变化（创建，更新和删除操作），应用可以从流中读取这些变化，然后以事件方式发布这些变化。</p>\n<p>交易日志挖掘也是优缺点并存。优点是确保每次更新发布事件不依赖于 2PC。交易日志挖掘可以通过将发布事件和应用业务逻辑分离开得到简化；而主要缺点在于交易日志对不同数据库有不同格式，甚至不同数据库版本也有不同格式；而且很难从底层交易日志更新记录转换为高层业务事件。</p>\n<p>交易日志挖掘方法通过应用直接更新数据库而不需要 2PC 介入。下面我们再看一种完全不同的方法：不需要更新只依赖事件的方法。</p>\n<h5 id="使用事件源"><a href="#%E4%BD%BF%E7%94%A8%E4%BA%8B%E4%BB%B6%E6%BA%90" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用事件源</h5>\n<p>Event sourcing（事件源）通过使用根本不同的事件中心方式来获得不需 2PC 的原子性，保证业务实体的一致性。这种应用保存业务实体一系列状态改变事件，而不是存储实体现在的状态。应用可以通过重放事件来重建实体现在状态。只要业务实体发生变化，新事件就会添加到时间表中。因为保存事件是单一操作，因此肯定是原子性的。</p>\n<p>为了理解事件源工作方式，考虑事件实体作为一个例子。传统方式中，每个订单映射为 ORDER 表中一行，例如在 <code class="language-text">ORDER_LINE_ITEM</code> 表中。但是对于事件源方式，订单服务以事件状态改变方式存储一个订单：创建的，已批准的，已发货的，取消的；每个事件包括足够数据来重建订单状态。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-09-29-11-05-18-98b6ee1bb1fb6f94966c02cf65b69974-d04af.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 40.88838268792711%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAAsSAAALEgHS3X78AAABDElEQVQY021Qy1LEIBDk/y/+gkdvevKkH7AnK1qllgc9uYlJSAhvmAEclnJrXW0e1cB0N8BKKYOfLt4vP+wn8UztB41Bxqv+die64+nNcH/d3xFhNKawPMzPX34uv9FKdbK7uXsSb20zZnjkrx1/gYKsbQlQmPEYSLLWazLCfurnsJCMliEDha1yNdowQMwpb6hTTuU/IOKw71cptDcYQTqlnHbGxhjZOI6c82njm5TOOTLyKWi0G2iDjsQppRACEe88EfKq+TEAIJNS2RNQqUteoZ7iIkDW5IQUQvcSm1jWVWtdXx4juTA4QXM9A9lVcUrWOrqd0uogrsXsb/XZhx1klqyNtVLKxsmI5m88X9A9rC9U4AAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 09 29 11 05 18" title="" data-src="/static/2023-09-29-11-05-18-98b6ee1bb1fb6f94966c02cf65b69974-fee1c.png" data-srcset="/static/2023-09-29-11-05-18-98b6ee1bb1fb6f94966c02cf65b69974-a67b7.png 200w,\n/static/2023-09-29-11-05-18-98b6ee1bb1fb6f94966c02cf65b69974-0b187.png 400w,\n/static/2023-09-29-11-05-18-98b6ee1bb1fb6f94966c02cf65b69974-fee1c.png 800w,\n/static/2023-09-29-11-05-18-98b6ee1bb1fb6f94966c02cf65b69974-d04af.png 878w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>事件是长期保存在事件数据库中，提供 API 添加和获取实体事件。事件存储跟之前描述的消息代理类似，提供 API 来订阅事件。事件存储将事件递送到所有感兴趣的订阅者，事件存储是事件驱动微服务架构的基干。</p>\n<p>事件源方法有很多优点：解决了事件驱动架构关键问题，使得只要有状态变化就可以可靠地发布事件，也就解决了微服务架构中数据一致性问题。另外，因为是持久化事件而不是对象，也就避免了 <code class="language-text">object relational impedance mismatch problem</code>。</p>\n<p>数据源方法提供了 100% 可靠的业务实体变化监控日志，使得获取任何时点实体状态成为可能。另外，事件源方法可以使得业务逻辑可以由事件交换的松耦合业务实体构成。这些优势使得单体应用移植到微服务架构变的相对容易。</p>\n<p>事件源方法也有不少缺点，因为采用不同或者不太熟悉的模式，使得重新学习不太容易；事件存储只支持主键查询业务实体，必须使用 <code class="language-text">Command Query Responsibility Segregation</code>(CQRS) 来完成查询业务，因此，应用必须处理最终一致数据。</p>\n<h4 id="总结-4"><a href="#%E6%80%BB%E7%BB%93-4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h4>\n<p>在微服务架构中，每个微服务都有自己私有的数据集。不同微服务可能使用不同的 SQL 或者 NoSQL 数据库。尽管数据库架构有很强的优势，但是也面对数据分布式管理的挑战。第一个挑战就是如何在多服务之间维护业务交易一致性；第二个挑战是如何从多服务环境中获取一致性数据。</p>\n<p>最佳解决办法是采用事件驱动架构。其中碰到的一个挑战是如何原子性的更新状态和发布事件。有几种方法可以解决此问题，包括将数据库视为消息队列、交易日志挖掘和事件源。</p>\n<h3 id="选择微服务部署策略"><a href="#%E9%80%89%E6%8B%A9%E5%BE%AE%E6%9C%8D%E5%8A%A1%E9%83%A8%E7%BD%B2%E7%AD%96%E7%95%A5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>选择微服务部署策略</h3>\n<p>部署一个单体式应用意味运行大型应用的多个副本，典型的提供若干个（N）服务器（物理或者虚拟），运行若干个（M）个应用实例。部署单体式应用不会很直接，但是肯定比部署微服务应用简单些。</p>\n<p>一个微服务应用由上百个服务构成，服务可以采用不同语言和框架分别写就。每个服务都是一个单一应用，可以有自己的部署、资源、扩展和监控需求。例如，可以根据服务需求运行若干个服务实例，除此之外，每个实例必须有自己的 CPU，内存和 I/O 资源。尽管很复杂，但是更挑战的是服务部署必须快速、可靠和性价比高。</p>\n<p>有一些微服务部署的模式，先讨论一下每个主机多服务实例的模式。</p>\n<h4 id="单主机多服务实例模式"><a href="#%E5%8D%95%E4%B8%BB%E6%9C%BA%E5%A4%9A%E6%9C%8D%E5%8A%A1%E5%AE%9E%E4%BE%8B%E6%A8%A1%E5%BC%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>单主机多服务实例模式</h4>\n<p>部署微服务的一种方法就是单主机多服务实例模式，使用这种模式，需要提供若干台物理或者虚拟机，每台机器上运行多个服务实例。很多情况下，这是传统的应用部署方法。每个服务实例运行一个或者多个主机的 well-known 端口，主机可以看做宠物。</p>\n<p>下图展示的是这种架构：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-09-29-10-46-22-7206c8a5d75b1a092f5e39871d18f94b-a2194.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 750px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 100.26666666666667%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAIAAAAC64paAAAACXBIWXMAAAsSAAALEgHS3X78AAADV0lEQVQ4y31UWYscVRSuX2n0wSeJIAEhk0AgoOLCYBQxBAaXB0UYxgX0YRJFMDgGo2IyLtPbVFV3bd2137X25dat9lT1KBHB07dvfec75+u+feqrVh6fnq4MY3F+PpvPVVXVxwAMu2VbJrz+Hbvctm2QKHDFlJzNJkttCWJ1qQVBMJ1O/cDfbrd932//EzsSY6zA1+5yq3JJwwHLoTiUgxp5VbSryl4CSEVul95OHMexYpt2ti0P1kfPzV7a026d0F+h0Pbiq+i7K+evv7B47Yvw21o2QP7M/7ihv3N5/vJ7zme8zwgig9hsvfc3n1/R3ri5un0v/iHvStSyw+DuVf3Wi/r+oX/XrSP4uOP4+5vG7efVV+6sD88rcxDDsfk2SxJ+f/bADpxUFKxNeJfldfFI/+3U/LNpmqghhax4m2nO8kR72FRNLGkcIwXGF/V0nbosIWnBndLLuoKJ1MrWhMdJSv0yAnEj21XuxCxkHKMCuyLCCCumacHv8RsUC+q3CGTjzCQSNOxIKHDUkt38mEh8geKOuk0EzCBeqCpMs61bXNCsyru2q5saFgBeJrTgTzAir3KUk6ZupZSe5yme77ue53pu4AW+BxiyIeAS+CGsi3xs8/0g9KOh6rphFClRFCGE8N8BEFJCSIxQMEYYhsG4LsCOCQIEA1ssziHVNG2+WOhL3TTNzWYznc5gz4s8SZPsiUjTFBjYy7KEBsW2HZ5wyzCZTzxzs3YcsI5hGpjg/7cnHFAxRnuWsv6G/Tgp9aE2zhb2B/TxffJL13f/kIvMOI5PUpFdiNfWGm7aNfWtpyZXn5lc/2jzJXSDVd62P356ev3S5Nq++SFpB89/Gnz97OzGpcnenvqmUW84ZoNJQkkesen+8oND71grLHA/FclZqh3YR+9an0wyLWpwJet5vjry7r26PPiJ/r4R4WgSwyTblDIyUc+iIOBNykUG9iQF01fqylqWVQE+KWUV12RtO7PlrCnqSJLh2JZhUZnqqclrHlcIPFh3TSYKLTNRiWlFVrlNm0TITs8sL/dZxcxsHQmC4cHYDazoK/A66ZNuK3cjbbcC9xxJVgMcA0q0T6Et68vheUbjfWacU/g3wfCmlJDRLAQwwZAQRugFM5KAoJkx5jjOX8dQNqufPFE8AAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 09 29 10 46 22" title="" data-src="/static/2023-09-29-10-46-22-7206c8a5d75b1a092f5e39871d18f94b-a2194.png" data-srcset="/static/2023-09-29-10-46-22-7206c8a5d75b1a092f5e39871d18f94b-2e341.png 200w,\n/static/2023-09-29-10-46-22-7206c8a5d75b1a092f5e39871d18f94b-e3a06.png 400w,\n/static/2023-09-29-10-46-22-7206c8a5d75b1a092f5e39871d18f94b-a2194.png 750w" data-sizes="(max-width: 750px) 100vw, 750px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>这种模式有一些参数，一个参数代表每个服务实例由多少进程构成。例如，需要在 Apache Tomcat Server 上部署一个 Java 服务实例作为 web 应用。一个 Node.js 服务实例可能有一个父进程和若干个子进程构成。</p>\n<p>另外一个参数定义同一进程组内有多少服务实例运行。例如，可以在同一个 Apache Tomcat Server 上运行多个 Java web 应用，或者在同一个 OSGI 容器内运行多个 OSGI 捆绑实例。</p>\n<p>单主机多服务实例模式也是优缺点并存。主要优点在于资源利用有效性。多服务实例共享服务器和操作系统，如果进程组运行多个服务实例效率会更高，例如，多个 web 应用共享同一个 Apache Tomcat Server 和 JVM。</p>\n<p>另一个优点在于部署服务实例很快。只需将服务拷贝到主机并启动它。如果服务用 Java 写的，只需要拷贝 JAR 或者 WAR 文件即可。对于其它语言，例如 Node.js 或者 Ruby，需要拷贝源码。也就是说网络负载很低。</p>\n<p>因为没有太多负载，启动服务很快。如果服务是自包含的进程，只需要启动就可以；否则，如果是运行在容器进程组中的某个服务实例，则需要动态部署进容器中，或者重启容器。</p>\n<p>除了上述优点外，单主机多服务实例也有缺陷。其中一个主要缺点是服务实例间很少或者没有隔离，除非每个服务实例是独立进程。如果想精确监控每个服务实例资源使用，就不能限制每个实例资源使用。因此有可能造成某个糟糕的服务实例占用了主机的所有内存或者 CPU。</p>\n<p>同一进程内多服务实例没有隔离。所有实例有可能，例如，共享同一个 JVM heap。某个糟糕服务实例很容易攻击同一进程中其它服务；更甚至于，有可能无法监控每个服务实例使用的资源情况。</p>\n<p>另一个严重问题在于运维团队必须知道如何部署的详细步骤。服务可以用不同语言和框架写成，因此开发团队肯定有很多需要跟运维团队沟通事项。其中复杂性增加了部署过程中出错的可能性。</p>\n<p>可以看到，尽管熟悉，但是单主机多服务实例有很多严重缺陷。下面看看是否有其他部署微服务方式能够避免这些问题。</p>\n<h4 id="单主机单服务实例模式"><a href="#%E5%8D%95%E4%B8%BB%E6%9C%BA%E5%8D%95%E6%9C%8D%E5%8A%A1%E5%AE%9E%E4%BE%8B%E6%A8%A1%E5%BC%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>单主机单服务实例模式</h4>\n<p>另外一种部署微服务方式是单主机单实例模式。当使用这种模式，每个主机上服务实例都是各自独立的。有两种不同实现模式：单虚拟机单实例和单容器单实例。</p>\n<h5 id="单虚拟机单实例模式"><a href="#%E5%8D%95%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%8D%95%E5%AE%9E%E4%BE%8B%E6%A8%A1%E5%BC%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>单虚拟机单实例模式</h5>\n<p>但是用单虚拟机单实例模式，一般将服务打包成虚拟机映像（image），例如一个 Amazon EC2 AMI。每个服务实例是一个使用此映像启动的 VM（例如，EC2 实例）。下图展示了此架构：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/deployment-strategy-2-b0ed87cfb990dd34a620f22ab4b8cf4f-6eb27.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 757px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 83.35535006605019%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAIAAABSJhvpAAAACXBIWXMAAAsSAAALEgHS3X78AAAB3klEQVQ4y5WTu24UMRSG5zEpoKSko0hHxQMAfYRERMdFUNCkCwUSICIt2d1h72uP7/bMeDwznpuNo0UbkFCye3RkWbI+/+f8x478AeGcCytC6Gp0JaiIwVwxlUAUHQ5LIXkuXrL3D+Mnb+R51dTHwFyigl6o7y9+vfqa/aRGRHdiuwh7JRQxXNsCkaRoDa9k5Lwb3BDy7p4JzvKM1HxdQlqLwhQ3ys7fiOyBpmmUSm1ta98kDC3mi2QD4RqANVguV1Hvhks9XZTb/2p2XadzLUs1eEcwiSdxIvFn+I2mPPgXfeIXD8Ynj6ZPp+WytW0orA/hh971gx+cH6xrGtfuemZGPkNn98aPT+m7wpoIWfYF/5iouexyqgWSJLO68z0hBABQN7bsq7KrSm8xo1jTRbH9sDwHJSYFjxJLTWHySvNWuX21rg8ZOgr6AbZ982fOlRJNSiQSbapsFrWuFX2q+vzacOf3hv1lpNedCWeMMsY4zHAslyjcINU/bt8yquuyOZnNZgwyDhgFZLVeRzvmFnI/tgSjzWozSuPX248zvSlNecTzDG5jw54nZ/fHJ6f4raqy49421ETV6eV2lDcFNvy4X6XqjLaCFIR1Qoc5Hw5jjDfrLcDJBM4gTiCAvwGiJswDKXHNdQAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="deployment strategy 2" title="" data-src="/static/deployment-strategy-2-b0ed87cfb990dd34a620f22ab4b8cf4f-6eb27.png" data-srcset="/static/deployment-strategy-2-b0ed87cfb990dd34a620f22ab4b8cf4f-a550b.png 200w,\n/static/deployment-strategy-2-b0ed87cfb990dd34a620f22ab4b8cf4f-80d9e.png 400w,\n/static/deployment-strategy-2-b0ed87cfb990dd34a620f22ab4b8cf4f-6eb27.png 757w" data-sizes="(max-width: 757px) 100vw, 757px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>Netfix 采用这种架构部署 video streaming service。Netfix 使用 Aminator 将每个服务打包成一个 EC2 AMI。每个运行服务实例就是一个 EC2 实例。</p>\n<p>有很多工具可以用来搭建自己的 VMs。可以配置持续集成（CI）服务（例如 Jenkins）避免 Aminator 将服务打包成 EC2 AMI。packer.io 是自动虚机映像创建的另外一种选择。跟 Aminator 不同，它支持一系列虚拟化技术，例如 EC2，DigitalOcean，VirtualBox 和 VMware。​</p>\n<p>Boxfuse 公司有一个创新方法创建虚机映像，克服了如下缺陷。Boxfuse 将 java 应用打包成最小虚机映像，它们创建迅速，启动很快，因为对外暴露服务接口少而更加安全。</p>\n<p>CloudNative 公司有一个用于创建 EC2 AMI 的 SaaS 应用，Bakery。用户微服务架构通过测试后，可以配置自己的 CI 服务器激活 Bakery。Bakery 将服务打包成 AMI。使用如 Bakery 的 SaaS 应用意味着用户不需要浪费时间在设置自己的 AMI 创建架构。</p>\n<p>每个虚拟机服务实例模式有许多优势，主要的 VM 优势在于每个服务实例都是完全独立运行的，都有各自独立的 CPU 和内存而不会被其它服务占用。</p>\n<p>另外一个好处在于用户可以使用成熟云架构，例如 AWS 提供的，云服务都提供如负载均衡和扩展性等有用功能。</p>\n<p>还有一个好处在于服务实施技术被自包含了。一旦服务被打包成 VM 就成为一个黑盒子。VM 的管理 API 成为部署服务的 API，部署成为一个非常简单和可靠的事情。</p>\n<p>单虚拟机单实例模式也有缺点。一个缺点就是资源利用效率不高。每个服务实例占用整个虚拟机的资源，包括操作系统。而且，在一个典型的公有 IaaS 环境，虚机资源都是标准化的，有可能未被充分利用。</p>\n<p>而且，公有 IaaS 根据 VM 来收费，而不管虚机是否繁忙；例如 AWS 提供了自动扩展功能，但是对随需应用缺乏快速响应，使得用户不得不多部署虚拟机，从而增加了部署费用。</p>\n<p>另外一个缺点在于部署服务新版本比较慢。虚机镜像因为大小原因创建起来比较慢，同样原因，虚机初始化也比较慢，操作系统启动也需要时间。但是这并不一直是这样，一些轻量级虚机，例如使用 Boxfuse 创建的虚机，就比较快。</p>\n<p>第三个缺点是对于运维团队，它们负责许多客制化工作。除非使用如 Boxfuse 之类的工具，可以帮助减轻大量创建和管理虚机的工作；否则会占用大量时间从事与核心业务不太无关的工作。</p>\n<p>那么我们来看看另外一种仍然具有虚机特性，但是比较轻量的微服务部署方法。</p>\n<h4 id="单容器单服务实例模式"><a href="#%E5%8D%95%E5%AE%B9%E5%99%A8%E5%8D%95%E6%9C%8D%E5%8A%A1%E5%AE%9E%E4%BE%8B%E6%A8%A1%E5%BC%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>单容器单服务实例模式</h4>\n<p>当使用这种模式时，每个服务实例都运行在各自容器中。容器是运行在操作系统层面的虚拟化机制。一个容器包含若干运行在沙箱中的进程。从进程角度来看，他们有各自的命名空间和根文件系统；可以限制容器的内存和 CPU 资源。某些容器还具有 I/O 限制，这类容器技术包括 Docker 和 Solaris Zones。</p>\n<p>下图展示了这种模式：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/deployment-strategy-3-584a234d8c5e55f1c95a33c95bd1261d-0e0fd.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 745px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 97.18120805369128%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAIAAAAf7rriAAAACXBIWXMAAAsSAAALEgHS3X78AAACFElEQVQ4y5WTy2vVQBjF75/qUpeuXdmVe126EnVVpQh2oShUUKiIQnvpzc195DaZzCSTzCST92Qe8UuvCi0qaQghDPzmO3POmdkw4bHWLpeu53lJQimhGGMSkd1uN5sCK6UBiOOYU1arxlgDi7kQE2EVYmy1eYM/3nUeviRv7WA541NhUGoGc1Yun3lHp/ysMk3O86kwIZEeDOvziEW8y7tBiuxKtgFH/gtrrS99vxACs2iVegHDQhRBGM5A/d7P/c8Nk40ZvWl0625Wi4Wz2Wxd112t1vA6C2ecXOpKWXUDg6+UMk3SvCmqvkEIFUWhlf41yQ5lWc4+Z9/vOQdPghewvZJK9QqS0NaAEDhkq2VnJDDgNk/5ub84jk+2lQ9bpGk6c6rtK/TuC/+RSh6zBPNYDTqhyXw+71XfmFbaXnQlCkMAXtP3dy4ePA0PwbDRbWBaUYO2wlSjN+NYDVhRFjC80rW0IEhCSaTpk5ZdYJfWrDT1CIMqqrjQ1bUz712EIKytTdP2HUQ1SlUZqeNEcQgoz//dMPs7PthI9MVl4MNwhMIN8lCICCaed9VtO/wlp2s5W7N03fV6HeIQBQgy94MA0rpFPSmNS1b8aUSWZdPrSYzSx/jkvvvoiH6ARZokt+g2RPhVnD9eP/+UfoOLkSZsKhyRuB9U1ouIkqzL26GbeiXhYgQBqusmEtQTARZx3TRQm58De0GebKWKggAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="deployment strategy 3" title="" data-src="/static/deployment-strategy-3-584a234d8c5e55f1c95a33c95bd1261d-0e0fd.png" data-srcset="/static/deployment-strategy-3-584a234d8c5e55f1c95a33c95bd1261d-a43ca.png 200w,\n/static/deployment-strategy-3-584a234d8c5e55f1c95a33c95bd1261d-381f8.png 400w,\n/static/deployment-strategy-3-584a234d8c5e55f1c95a33c95bd1261d-0e0fd.png 745w" data-sizes="(max-width: 745px) 100vw, 745px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>使用这种模式需要将服务打包成容器映像。一个容器映像是一个运行包含服务所需库和应用的文件系统 ​。某些容器映像由完整的 linux 根文件系统组成，其它则是轻量级的。例如，为了部署 Java 服务，需要创建包含 Java 运行库的容器映像，也许还要包含 Apache Tomcat server，以及编译过的 Java 应用。</p>\n<p>一旦将服务打包成容器映像，就需要启动若干容器。一般在一个物理机或者虚拟机上运行多个容器，可能需要集群管理系统，例如 k8s 或者 Marathon，来管理容器。集群管理系统将主机作为资源池，根据每个容器对资源的需求，决定将容器调度到那个主机上。</p>\n<p>单容器单服务实例模式也是优缺点都有。容器的优点跟虚机很相似，服务实例之间完全独立，可以很容易监控每个容器消耗的资源。跟虚机相似，容器使用隔离技术部署服务。容器管理 API 也可以作为管理服务的 API。</p>\n<p>然而，跟虚机不一样，容器是一个轻量级技术。容器映像创建起来很快，例如，在笔记本电脑上，将 Spring Boot 应用打包成容器映像只需要 5 秒钟。因为不需要操作系统启动机制，容器启动也很快。当容器启动时，后台服务就启动了。</p>\n<p>使用容器也有一些缺点。尽管容器架构发展迅速，但是还是不如虚机架构成熟。而且由于容器之间共享 host OS 内核因此并不像虚机那么安全。</p>\n<p>另外，容器技术将会对管理容器映像提出许多客制化需求，除非使用如 Google Container Engine 或者 Amazon EC2 Container Service (ECS)，否则用户将同时需要管理容器架构以及虚机架构。</p>\n<p>第三，容器经常被部署在按照虚机收费的架构上，很显然，客户也会增加部署费用来应对负载的增长。</p>\n<p>有趣的是，容器和虚机之间的区别越来越模糊。如前所述，Boxfuse 虚机启动创建都很快，Clear Container 技术面向创建轻量级虚机。unikernel 公司的技术也引起大家关注，Docker 最近收购了 Unikernel 公司。</p>\n<p>除了这些之外，serverless 部署技术，避免了前述容器和 VM 技术的缺陷，吸引了越来越多的注意。下面我们来看看。</p>\n<h4 id="serverless-部署"><a href="#serverless-%E9%83%A8%E7%BD%B2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Serverless 部署</h4>\n<p>AWS Lambda 是 serverless 部署技术的例子，支持 Java，Node.js 和 Python 服务；需要将服务打包成 ZIP 文件上载到 AWS Lambda 就可以部署。可以提供元数据，提供处理服务请求函数的名字（一个事件）。AWS Lambda 自动运行处理请求足够多的微服务，然而只根据运行时间和消耗内存量来计费。当然细节决定成败，AWS Lambda 也有限制。但是大家都不需要担心服务器，虚拟机或者容器内的任何方面绝对吸引人。</p>\n<p>Lambda 函数是无状态服务。一般通过激活 AWS 服务处理请求。例如，当映像上载到 S3 bucket 激活 Lambda 函数后，就可以在 DynamoDB 映像表中插入一个条目，给 Kinesis 流发布一条消息，触发映像处理动作。Lambda 函数也可以通过第三方 web 服务激活。</p>\n<p>有四种方法激活 Lambda 函数：</p>\n<ul>\n<li>直接方式，使用 web 服务请求</li>\n<li>自动方式，回应例如 AWS S3，DynamoDB，Kinesis 或者 Simple Email Service 等产生的事件</li>\n<li>自动方式，通过 AWS API 网关来处理应用客户端发出的 HTTP 请求 ​</li>\n<li>定时方式，通过 cron 响应，很像定时器方式</li>\n</ul>\n<p>可以看出，AWS Lambda 是一种很方便部署微服务的方式。基于请求计费方式意味着用户只需要承担处理自己业务那部分的负载；另外，因为不需要了解基础架构，用户只需要开发自己的应用。</p>\n<p>然而还是有不少限制。不需要用来部署长期服务，例如用来消费从第三方代理转发来的消息，请求必须在 300 秒内完成，服务必须是无状态，因为理论上 AWS Lambda 会为每个请求生成一个独立的实例；必须用某种支持的语言完成，服务必须启动很快，否则，会因为超时被停止。部署微服务应用也是一种挑战。用各种语言和框架写成的服务成百上千。每种服务都是一种迷你应用，有自己独特的部署、资源、扩充和监控需求。有若干种微服务部署模式，包括单虚机单实例以及单容器单实例。另外可选模式还有 AWS Lambda，一种 serverless 方法。</p>\n<h2 id="spring-cloud-微服务架构"><a href="#spring-cloud-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Spring Cloud 微服务架构</h2>\n<h3 id="什么是微服务？微服务之间是如何独立通讯的？"><a href="#%E4%BB%80%E4%B9%88%E6%98%AF%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9F%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%B9%8B%E9%97%B4%E6%98%AF%E5%A6%82%E4%BD%95%E7%8B%AC%E7%AB%8B%E9%80%9A%E8%AE%AF%E7%9A%84%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>什么是微服务？微服务之间是如何独立通讯的？</h3>\n<ul>\n<li>微服务架构是一个分布式系统，按照业务进行划分成为不同的服务单元，解决单体系统性能等不足。</li>\n<li>微服务是一种架构风格，一个大型软件应用由多个服务单元组成，系统中的服务单元可以单独部署，各个服务单元之间是松耦合的。</li>\n</ul>\n<h4 id="同步"><a href="#%E5%90%8C%E6%AD%A5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>同步</h4>\n<h5 id="rest-http-协议"><a href="#rest-http-%E5%8D%8F%E8%AE%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>REST HTTP 协议</h5>\n<p>REST 请求在微服务中是最为常用的一种通讯方式，它依赖于 HTTP \\ HTTPS 协议，RESTFUL 的特点是：</p>\n<ol>\n<li>每一个 URI 代表 1 种资源</li>\n<li>客户端使用 GET、POST、PUT、DELETE 4 个表示操作方式的动词对服务端资源进行操作：GET 用来获取资源，POST 用来新建资源（也可以用于更新资源），PUT 用来更新资源，DELETE 用来删除资源</li>\n<li>通过操作资源的表现形式来操作资源</li>\n<li>资源的表现形式是 XML 或者 HTML</li>\n<li>客户端与服务端之间的交互在请求之间是无状态的，从客户端到服务端的每个请求都必须包含理解请求所必需的信息</li>\n</ol>\n<p>举个例子，有一个服务方提供了如下接口：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="55015167992200765000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`@RestController\n@RequestMapping(&quot;/communication&quot;)\npublic class RestControllerDemo {\n    @GetMapping(&quot;/hello&quot;)\n    public String s() {\n        return &quot;hello&quot;;\n    }\n}`, `55015167992200765000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token annotation punctuation">@RestController</span>\n<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/communication"</span><span class="token punctuation">)</span>\n<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RestControllerDemo</span> <span class="token punctuation">{</span>\n    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/hello"</span><span class="token punctuation">)</span>\n    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">s</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">return</span> <span class="token string">"hello"</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>另外一个服务需要去调用该接口，调用方只需要根据 API 文档发送请求即可获取返回结果。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="42796184167035320000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`@RestController\n@RequestMapping(&quot;/demo&quot;)\npublic class RestDemo{\n    @Autowired\n    RestTemplate restTemplate;\n\n    @GetMapping(&quot;/hello2&quot;)\n    public String s2() {\n        String forObject = restTemplate.getForObject(&quot;http://localhost:9013/communication/hello&quot;, String.class);\n        return forObject;\n    }\n}`, `42796184167035320000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token annotation punctuation">@RestController</span>\n<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/demo"</span><span class="token punctuation">)</span>\n<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RestDemo</span><span class="token punctuation">{</span>\n    <span class="token annotation punctuation">@Autowired</span>\n    <span class="token class-name">RestTemplate</span> restTemplate<span class="token punctuation">;</span>\n\n    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/hello2"</span><span class="token punctuation">)</span>\n    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">s2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token class-name">String</span> forObject <span class="token operator">=</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span><span class="token string">"http://localhost:9013/communication/hello"</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">return</span> forObject<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>通过这样的方式可以实现服务之间的通讯。</p>\n<h5 id="rpc-tcp-协议"><a href="#rpc-tcp-%E5%8D%8F%E8%AE%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>RPC TCP 协议</h5>\n<p>RPC（Remote Procedure Call）远程过程调用，简单的理解是一个节点请求另一个节点提供的服务。它的工作流程是这样的：</p>\n<ol>\n<li>执行客户端调用语句，传送参数</li>\n<li>调用本地系统发送网络消息</li>\n<li>消息传送到远程主机</li>\n<li>服务器得到消息并取得参数</li>\n<li>根据调用请求以及参数执行远程过程（服务）</li>\n<li>执行过程完毕，将结果返回服务器句柄</li>\n<li>服务器句柄返回结果，调用远程主机的系统网络服务发送结果</li>\n<li>消息传回本地主机</li>\n<li>客户端句柄由本地主机的网络服务接收消息</li>\n<li>客户端接收到调用语句返回的结果数据</li>\n</ol>\n<p>首先需要一个服务端：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="6376066077035269000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import java.io.IOException;\nimport java.io.ObjectInputStream;\nimport java.io.ObjectOutputStream;\nimport java.lang.reflect.Method;\nimport java.net.InetSocketAddress;\nimport java.net.ServerSocket;\nimport java.net.Socket;\nimport java.util.concurrent.ConcurrentHashMap;\nimport java.util.concurrent.ExecutorService;\nimport java.util.concurrent.Executors;\n\n/**\n * RPC 服务端用来注册远程方法的接口和实现类\n */\npublic class RPCServer {\n    private static ExecutorService executor = Executors.newFixedThreadPool(Runtime.getRuntime().availableProcessors());\n\n    private static final ConcurrentHashMap<String, Class> serviceRegister = new ConcurrentHashMap<>();\n\n    /**\n     * 注册方法\n     * @param service\n     * @param impl\n     */\n    public void register(Class service, Class impl) {\n        serviceRegister.put(service.getSimpleName(), impl);\n    }\n\n    /**\n     * 启动方法\n     * @param port\n     */\n    public void start(int port) {\n        ServerSocket socket = null;\n        try {\n            socket = new ServerSocket();\n            socket.bind(new InetSocketAddress(port));\n            System.out.println(&quot;服务启动&quot;);\n            System.out.println(serviceRegister);\n            while (true) {\n                executor.execute(new Task(socket.accept()));\n            }\n        } catch (Exception e) {\n            e.printStackTrace();\n        } finally {\n            if (socket != null) {\n                try {\n                    socket.close();\n                } catch (IOException e) {\n                    e.printStackTrace();\n                }\n            }\n        }\n    }\n\n    private static class Task implements Runnable {\n        Socket client = null;\n\n        public Task(Socket client) {\n            this.client = client;\n        }\n\n        @Override\n        public void run() {\n            ObjectInputStream input = null;\n            ObjectOutputStream output = null;\n            try {\n                input = new ObjectInputStream(client.getInputStream());\n                // 按照顺序读取对方写过来的内容\n                String serviceName = input.readUTF();\n                String methodName = input.readUTF();\n                Class<?>[] parameterTypes = (Class<?>[]) input.readObject();\n                Object[] arguments = (Object[]) input.readObject();\n                Class serviceClass = serviceRegister.get(serviceName);\n                if (serviceClass == null) {\n                    throw new ClassNotFoundException(serviceName + &quot; 没有找到!&quot;);\n                }\n                Method method = serviceClass.getMethod(methodName, parameterTypes);\n                Object result = method.invoke(serviceClass.newInstance(), arguments);\n\n                output = new ObjectOutputStream(client.getOutputStream());\n                output.writeObject(result);\n            } catch (Exception e) {\n                e.printStackTrace();\n\n            } finally {\n                try {\n                    // 这里就不写 output != null 才关闭这个逻辑了\n                    output.close();\n                    input.close();\n                    client.close();\n                } catch (IOException e) {\n                    e.printStackTrace();\n                }\n\n            }\n        }\n    }\n\n}`, `6376066077035269000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io</span><span class="token punctuation">.</span><span class="token class-name">IOException</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io</span><span class="token punctuation">.</span><span class="token class-name">ObjectInputStream</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io</span><span class="token punctuation">.</span><span class="token class-name">ObjectOutputStream</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect</span><span class="token punctuation">.</span><span class="token class-name">Method</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>net</span><span class="token punctuation">.</span><span class="token class-name">InetSocketAddress</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>net</span><span class="token punctuation">.</span><span class="token class-name">ServerSocket</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>net</span><span class="token punctuation">.</span><span class="token class-name">Socket</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent</span><span class="token punctuation">.</span><span class="token class-name">ConcurrentHashMap</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent</span><span class="token punctuation">.</span><span class="token class-name">ExecutorService</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent</span><span class="token punctuation">.</span><span class="token class-name">Executors</span><span class="token punctuation">;</span>\n\n<span class="token comment">/**\n * RPC 服务端用来注册远程方法的接口和实现类\n */</span>\n<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RPCServer</span> <span class="token punctuation">{</span>\n    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ExecutorService</span> executor <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">availableProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token punctuation">></span></span> serviceRegister <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">/**\n     * 注册方法\n     * @param service\n     * @param impl\n     */</span>\n    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token class-name">Class</span> service<span class="token punctuation">,</span> <span class="token class-name">Class</span> impl<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        serviceRegister<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>service<span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> impl<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token comment">/**\n     * 启动方法\n     * @param port\n     */</span>\n    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token keyword">int</span> port<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token class-name">ServerSocket</span> socket <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n        <span class="token keyword">try</span> <span class="token punctuation">{</span>\n            socket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            socket<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InetSocketAddress</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"服务启动"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>serviceRegister<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                executor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Task</span><span class="token punctuation">(</span>socket<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>\n            <span class="token keyword">if</span> <span class="token punctuation">(</span>socket <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                <span class="token keyword">try</span> <span class="token punctuation">{</span>\n                    socket<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                <span class="token punctuation">}</span>\n            <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Task</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>\n        <span class="token class-name">Socket</span> client <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n\n        <span class="token keyword">public</span> <span class="token class-name">Task</span><span class="token punctuation">(</span><span class="token class-name">Socket</span> client<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">this</span><span class="token punctuation">.</span>client <span class="token operator">=</span> client<span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n\n        <span class="token annotation punctuation">@Override</span>\n        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token class-name">ObjectInputStream</span> input <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n            <span class="token class-name">ObjectOutputStream</span> output <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n            <span class="token keyword">try</span> <span class="token punctuation">{</span>\n                input <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectInputStream</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                <span class="token comment">// 按照顺序读取对方写过来的内容</span>\n                <span class="token class-name">String</span> serviceName <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">readUTF</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                <span class="token class-name">String</span> methodName <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">readUTF</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> parameterTypes <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> input<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> arguments <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> input<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                <span class="token class-name">Class</span> serviceClass <span class="token operator">=</span> serviceRegister<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">)</span><span class="token punctuation">;</span>\n                <span class="token keyword">if</span> <span class="token punctuation">(</span>serviceClass <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ClassNotFoundException</span><span class="token punctuation">(</span>serviceName <span class="token operator">+</span> <span class="token string">" 没有找到!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                <span class="token punctuation">}</span>\n                <span class="token class-name">Method</span> method <span class="token operator">=</span> serviceClass<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span>methodName<span class="token punctuation">,</span> parameterTypes<span class="token punctuation">)</span><span class="token punctuation">;</span>\n                <span class="token class-name">Object</span> result <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>serviceClass<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n                output <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectOutputStream</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                output<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>\n                <span class="token keyword">try</span> <span class="token punctuation">{</span>\n                    <span class="token comment">// 这里就不写 output != null 才关闭这个逻辑了</span>\n                    output<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                    input<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                    client<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                <span class="token punctuation">}</span>\n\n            <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>其次需要一个客户端：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="98907478432104630000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import java.io.ObjectInputStream;\nimport java.io.ObjectOutputStream;\nimport java.lang.reflect.InvocationHandler;\nimport java.lang.reflect.Method;\nimport java.lang.reflect.Proxy;\nimport java.net.InetSocketAddress;\nimport java.net.Socket;\n\n/**\n * RPC 客户端\n */\npublic class RPCclient<T> {\n    /**\n     * 通过动态代理将参数发送过去到 RPCServer，RPCserver 返回结果这个方法处理成为正确的实体\n     */\n    public static <T> T getRemoteProxyObj(final Class<T> service, final InetSocketAddress addr) {\n\n        return (T) Proxy.newProxyInstance(service.getClassLoader(), new Class<?>[]{service}, new InvocationHandler() {\n            @Override\n            public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {\n\n                Socket socket = null;\n                ObjectOutputStream out = null;\n                ObjectInputStream input = null;\n                try {\n                    socket = new Socket();\n                    socket.connect(addr);\n\n                    // 将实体类，参数，发送给远程调用方\n                    out = new ObjectOutputStream(socket.getOutputStream());\n                    out.writeUTF(service.getSimpleName());\n                    out.writeUTF(method.getName());\n                    out.writeObject(method.getParameterTypes());\n                    out.writeObject(args);\n\n                    input = new ObjectInputStream(socket.getInputStream());\n                    return input.readObject();\n                } catch (Exception e) {\n                    e.printStackTrace();\n                } finally {\n                    out.close();\n                    input.close();\n                    socket.close();\n                }\n                return null;\n            }\n        });\n\n    }\n\n}`, `98907478432104630000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io</span><span class="token punctuation">.</span><span class="token class-name">ObjectInputStream</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io</span><span class="token punctuation">.</span><span class="token class-name">ObjectOutputStream</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect</span><span class="token punctuation">.</span><span class="token class-name">InvocationHandler</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect</span><span class="token punctuation">.</span><span class="token class-name">Method</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect</span><span class="token punctuation">.</span><span class="token class-name">Proxy</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>net</span><span class="token punctuation">.</span><span class="token class-name">InetSocketAddress</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>net</span><span class="token punctuation">.</span><span class="token class-name">Socket</span><span class="token punctuation">;</span>\n\n<span class="token comment">/**\n * RPC 客户端\n */</span>\n<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RPCclient</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token punctuation">{</span>\n    <span class="token comment">/**\n     * 通过动态代理将参数发送过去到 RPCServer，RPCserver 返回结果这个方法处理成为正确的实体\n     */</span>\n    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token class-name">T</span> <span class="token function">getRemoteProxyObj</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> service<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">InetSocketAddress</span> addr<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n\n        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token class-name">Proxy</span><span class="token punctuation">.</span><span class="token function">newProxyInstance</span><span class="token punctuation">(</span>service<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>service<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">InvocationHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token annotation punctuation">@Override</span>\n            <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Object</span> proxy<span class="token punctuation">,</span> <span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>\n\n                <span class="token class-name">Socket</span> socket <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n                <span class="token class-name">ObjectOutputStream</span> out <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n                <span class="token class-name">ObjectInputStream</span> input <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n                <span class="token keyword">try</span> <span class="token punctuation">{</span>\n                    socket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                    socket<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n                    <span class="token comment">// 将实体类，参数，发送给远程调用方</span>\n                    out <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectOutputStream</span><span class="token punctuation">(</span>socket<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                    out<span class="token punctuation">.</span><span class="token function">writeUTF</span><span class="token punctuation">(</span>service<span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                    out<span class="token punctuation">.</span><span class="token function">writeUTF</span><span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                    out<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getParameterTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                    out<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n                    input <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectInputStream</span><span class="token punctuation">(</span>socket<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                    <span class="token keyword">return</span> input<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>\n                    out<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                    input<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                    socket<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                <span class="token punctuation">}</span>\n                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token punctuation">}</span>\n\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>再来一个测试的远程方法。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="82025768151043260000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public interface Tinterface {\n    String send(String msg);\n}\n\npublic class TinterfaceImpl implements Tinterface {\n    @Override\n    public String send(String msg) {\n        return &quot;send message &quot; + msg;\n    }\n}`, `82025768151043260000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Tinterface</span> <span class="token punctuation">{</span>\n    <span class="token class-name">String</span> <span class="token function">send</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TinterfaceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">Tinterface</span> <span class="token punctuation">{</span>\n    <span class="token annotation punctuation">@Override</span>\n    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">send</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">return</span> <span class="token string">"send message "</span> <span class="token operator">+</span> msg<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>测试代码如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="71275757244608130000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import java.net.InetSocketAddress;\n\n\npublic class RunTest {\n    public static void main(String[] args) {\n        new Thread(new Runnable() {\n            @Override\n            public void run() {\n                RPCServer rpcServer = new RPCServer();\n                rpcServer.register(Tinterface.class, TinterfaceImpl.class);\n                rpcServer.start(10000);\n            }\n        }).start();\n        Tinterface tinterface = RPCclient.getRemoteProxyObj(Tinterface.class, new InetSocketAddress(&quot;localhost&quot;, 10000));\n        System.out.println(tinterface.send(&quot;rpc 测试用例&quot;));\n\n    }\n}`, `71275757244608130000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>net</span><span class="token punctuation">.</span><span class="token class-name">InetSocketAddress</span><span class="token punctuation">;</span>\n\n\n<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RunTest</span> <span class="token punctuation">{</span>\n    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token annotation punctuation">@Override</span>\n            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                <span class="token class-name">RPCServer</span> rpcServer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RPCServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                rpcServer<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token class-name">Tinterface</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">TinterfaceImpl</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                rpcServer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token class-name">Tinterface</span> tinterface <span class="token operator">=</span> <span class="token class-name">RPCclient</span><span class="token punctuation">.</span><span class="token function">getRemoteProxyObj</span><span class="token punctuation">(</span><span class="token class-name">Tinterface</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">InetSocketAddress</span><span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>tinterface<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">"rpc 测试用例"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>输出 send message rpc 测试用例</p>\n<h4 id="异步"><a href="#%E5%BC%82%E6%AD%A5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>异步</h4>\n<h5 id="消息中间件"><a href="#%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>消息中间件</h5>\n<p>常见的消息中间件有 Kafka、ActiveMQ、RabbitMQ、RocketMQ，常见的协议有 AMQP、MQTTP、STOMP、XMPP。这里不对消息队列进行拓展了，具体如何使用还是请移步官网。</p>\n<h3 id="spring-cloud-和-dubbo-有哪些区别？"><a href="#spring-cloud-%E5%92%8C-dubbo-%E6%9C%89%E5%93%AA%E4%BA%9B%E5%8C%BA%E5%88%AB%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Spring Cloud 和 Dubbo 有哪些区别？</h3>\n<h3 id="spring-boot-和-spring-cloud，谈谈你对它们的理解？"><a href="#spring-boot-%E5%92%8C-spring-cloud%EF%BC%8C%E8%B0%88%E8%B0%88%E4%BD%A0%E5%AF%B9%E5%AE%83%E4%BB%AC%E7%9A%84%E7%90%86%E8%A7%A3%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Spring Boot 和 Spring Cloud，谈谈你对它们的理解？</h3>\n<h3 id="什么是服务熔断？什么是服务降级？"><a href="#%E4%BB%80%E4%B9%88%E6%98%AF%E6%9C%8D%E5%8A%A1%E7%86%94%E6%96%AD%EF%BC%9F%E4%BB%80%E4%B9%88%E6%98%AF%E6%9C%8D%E5%8A%A1%E9%99%8D%E7%BA%A7%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>什么是服务熔断？什么是服务降级？</h3>\n<h3 id="微服务的优缺点分别是什么？说一下你在项目开发中碰到的坑？"><a href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%9A%84%E4%BC%98%E7%BC%BA%E7%82%B9%E5%88%86%E5%88%AB%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F%E8%AF%B4%E4%B8%80%E4%B8%8B%E4%BD%A0%E5%9C%A8%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E4%B8%AD%E7%A2%B0%E5%88%B0%E7%9A%84%E5%9D%91%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>微服务的优缺点分别是什么？说一下你在项目开发中碰到的坑？</h3>\n<h3 id="你所知道的微服务技术栈都有哪些？"><a href="#%E4%BD%A0%E6%89%80%E7%9F%A5%E9%81%93%E7%9A%84%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8A%80%E6%9C%AF%E6%A0%88%E9%83%BD%E6%9C%89%E5%93%AA%E4%BA%9B%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>你所知道的微服务技术栈都有哪些？</h3>\n<h4 id="微服务开发"><a href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%BC%80%E5%8F%91" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>微服务开发</h4>\n<p>作用：快速开发服务。</p>\n<ul>\n<li>Spring</li>\n<li>Spring MVC</li>\n<li>Spring Boot</li>\n</ul>\n<p><a href="https://spring.io/" target="_blank" rel="nofollow noreferrer noopener">Spring</a> 目前是 JavaWeb 开发人员必不可少的一个框架，SpringBoot 简化了 Spring 开发的配置目前也是业内主流开发框架。</p>\n<h4 id="微服务注册发现"><a href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E5%8F%91%E7%8E%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>微服务注册发现</h4>\n<p>作用：发现服务，注册服务，集中管理服务。</p>\n<ul>\n<li>\n<p>Eureka</p>\n<ul>\n<li>Eureka Server: 提供服务、注册服务, 各个节点启动后，会在 Eureka Server 中进行注册。</li>\n<li>Eureka Client: 简化与 Eureka Server 的交互操作。</li>\n<li>Spring Cloud Netflix: <a href="https://github.com/spring-cloud/spring-cloud-netflix" target="_blank" rel="nofollow noreferrer noopener">GitHub</a>，<a href="https://cloud.spring.io/spring-cloud-netflix/reference/html/" target="_blank" rel="nofollow noreferrer noopener">文档</a></li>\n</ul>\n</li>\n<li>\n<p>Zookeeper</p>\n<blockquote>\n<p>ZooKeeper is a centralized service for maintaining configuration information, naming, providing distributed synchronization, and providing group services.</p>\n</blockquote>\n<p><a href="https://github.com/apache/zookeeper" target="_blank" rel="nofollow noreferrer noopener">Zookeeper</a> 是一个集中的服务，用于维护配置信息、命名、提供分布式同步和提供组服务。</p>\n</li>\n</ul>\n<p>Zookeeper 和 Eureka 区别</p>\n<p>Zookeeper 保证 CP，Eureka 保证 AP：</p>\n<ul>\n<li>C：数据一致性；</li>\n<li>A：服务可用性；</li>\n<li>P：服务对网络分区故障的容错性</li>\n</ul>\n<p>这三个特性在任何分布式系统中不能同时满足，最多同时满足两个。</p>\n<h4 id="微服务配置管理"><a href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>微服务配置管理</h4>\n<p>作用：统一管理一个或多个服务的配置信息, 集中管理。</p>\n<ul>\n<li>\n<p><a href="https://github.com/knightliao/disconf" target="_blank" rel="nofollow noreferrer noopener">Disconf</a></p>\n<p>Distributed Configuration Management Platform（分布式配置管理平台），它是专注于各种分布式系统配置管理的通用组件、通用平台，提供统一的配置管理服务，是一套完整的基于 zookeeper 的分布式配置统一解决方案。</p>\n</li>\n<li>\n<p><a href="https://github.com/spring-cloud/spring-cloud-config" target="_blank" rel="nofollow noreferrer noopener">SpringCloudConfig</a></p>\n</li>\n<li>\n<p><a href="https://github.com/ctripcorp/apollo" target="_blank" rel="nofollow noreferrer noopener">Apollo</a></p>\n<p>Apollo（阿波罗）是携程框架部门研发的分布式配置中心，能够集中化管理应用不同环境、不同集群的配置，配置修改后能够实时推送到应用端，并且具备规范的权限、流程治理等特性，用于微服务配置管理场景。</p>\n</li>\n</ul>\n<h4 id="权限认证"><a href="#%E6%9D%83%E9%99%90%E8%AE%A4%E8%AF%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>权限认证</h4>\n<p>作用：根据系统设置的安全规则或者安全策略, 用户可以访问而且只能访问自己被授权的资源，不多不少。</p>\n<ul>\n<li>\n<p><a href="https://spring.io/projects/spring-security" target="_blank" rel="nofollow noreferrer noopener">Spring Security</a></p>\n</li>\n<li>\n<p><a href="http://shiro.apache.org/" target="_blank" rel="nofollow noreferrer noopener">Apache Shiro</a></p>\n<blockquote>\n<p>Apache Shiro™ is a powerful and easy-to-use Java security framework that performs authentication, authorization, cryptography, and session management. With Shiro’s easy-to-understand API, you can quickly and easily secure any application – from the smallest mobile applications to the largest web and enterprise applications.</p>\n</blockquote>\n</li>\n</ul>\n<h4 id="批处理"><a href="#%E6%89%B9%E5%A4%84%E7%90%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>批处理</h4>\n<p>作用: 批量处理同类型数据或事务</p>\n<p><a href="https://spring.io/projects/spring-batch" target="_blank" rel="nofollow noreferrer noopener">Spring Batch</a></p>\n<h4 id="定时任务"><a href="#%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>定时任务</h4>\n<p>作用: 定时做什么。</p>\n<p><a href="http://www.quartz-scheduler.org/" target="_blank" rel="nofollow noreferrer noopener">Quartz</a></p>\n<h4 id="微服务调用-协议"><a href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E8%B0%83%E7%94%A8-%E5%8D%8F%E8%AE%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>微服务调用 (协议)</h4>\n<p>通讯协议</p>\n<ul>\n<li>\n<p>Rest</p>\n<ul>\n<li>通过 HTTP / HTTPS 发送 Rest 请求进行数据交互</li>\n</ul>\n</li>\n<li>\n<p>RPC</p>\n<ul>\n<li>Remote Procedure Call</li>\n<li>它是一种通过网络从远程计算机程序上请求服务，而不需要了解底层网络技术的协议，RPC 不依赖于具体的网络传输协议，tcp、udp 等都可以。</li>\n</ul>\n</li>\n<li>\n<p><a href="https://www.grpc.io/" target="_blank" rel="nofollow noreferrer noopener">gRPC</a></p>\n<blockquote>\n<p>A high-performance, open-source universal RPC framework</p>\n</blockquote>\n<p>所谓 RPC（remote procedure call 远程过程调用）框架实际是提供了一套机制，使得应用程序之间可以进行通信，而且也遵从 server/client 模型。使用的时候客户端调用 server 端提供的接口就像是调用本地的函数一样。</p>\n</li>\n<li>\n<p>RMI</p>\n<ul>\n<li>Remote Method Invocation</li>\n<li>纯 Java 调用</li>\n</ul>\n</li>\n</ul>\n<h4 id="服务接口调用"><a href="#%E6%9C%8D%E5%8A%A1%E6%8E%A5%E5%8F%A3%E8%B0%83%E7%94%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>服务接口调用</h4>\n<p>作用：多个服务之间的通讯</p>\n<p><a href="https://github.com/OpenFeign/feign" target="_blank" rel="nofollow noreferrer noopener">Feign(HTTP)</a></p>\n<p>Spring Cloud Netflix 的微服务都是以 HTTP 接口的形式暴露的，所以可以用 Apache 的 HttpClient 或 Spring 的 RestTemplate 去调用，而 Feign 是一个使用起来更加方便的 HTTP 客户端，使用起来就像是调用自身工程的方法，而感觉不到是调用远程方法。</p>\n<h4 id="服务熔断"><a href="#%E6%9C%8D%E5%8A%A1%E7%86%94%E6%96%AD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>服务熔断</h4>\n<p>作用: 当请求到达一定阈值时不让请求继续</p>\n<ul>\n<li>\n<p><a href="https://github.com/Netflix/Hystrix" target="_blank" rel="nofollow noreferrer noopener">Hystrix</a></p>\n<blockquote>\n<p>Hystrix is a latency and fault tolerance library designed to isolate points of access to remote systems, services and 3rd party libraries, stop cascading failure and enable resilience in complex distributed systems where failure is inevitable.</p>\n</blockquote>\n</li>\n<li>\n<p><a href="https://github.com/alibaba/Sentinel" target="_blank" rel="nofollow noreferrer noopener">Sentinel</a></p>\n<blockquote>\n<p>A lightweight powerful flow control component enabling reliability and monitoring for microservices.（轻量级的流量控制、熔断降级 Java 库）</p>\n</blockquote>\n</li>\n</ul>\n<h4 id="服务的负载均衡"><a href="#%E6%9C%8D%E5%8A%A1%E7%9A%84%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>服务的负载均衡</h4>\n<p>作用：降低服务压力, 增加吞吐量</p>\n<ul>\n<li>\n<p><a href="https://github.com/Netflix/ribbon" target="_blank" rel="nofollow noreferrer noopener">Ribbon</a></p>\n<p>Spring Cloud Ribbon 是一个基于 HTTP 和 TCP 的客户端负载均衡工具, 它基于 Netflix Ribbon 实现</p>\n</li>\n<li>\n<p><a href="https://github.com/nginx/nginx" target="_blank" rel="nofollow noreferrer noopener">Nginx</a></p>\n<p>Nginx (engine x) 是一个高性能的 HTTP 和反向代理 web 服务器, 同时也提供了 IMAP / POP3 / SMTP 服务</p>\n</li>\n</ul>\n<p>Nginx 与 Ribbon 区别</p>\n<p>Nginx 属于服务端负载均衡，Ribbon 属于客户端负载均衡。Nginx 作用与 Tomcat，Ribbon 作用与各个服务之间的调用 (RPC)。</p>\n<h4 id="消息队列-1"><a href="#%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>消息队列</h4>\n<p>作用: 解耦业务, 异步化处理数据</p>\n<ul>\n<li><a href="http://kafka.apache.org/" target="_blank" rel="nofollow noreferrer noopener">Kafka</a></li>\n<li><a href="https://www.rabbitmq.com/" target="_blank" rel="nofollow noreferrer noopener">RabbitMQ</a></li>\n<li><a href="http://rocketmq.apache.org/" target="_blank" rel="nofollow noreferrer noopener">RocketMQ</a></li>\n<li><a href="http://activemq.apache.org/" target="_blank" rel="nofollow noreferrer noopener">activeMQ</a></li>\n</ul>\n<h4 id="日志采集-elk"><a href="#%E6%97%A5%E5%BF%97%E9%87%87%E9%9B%86-elk" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>日志采集 (elk)</h4>\n<p>作用: 收集各服务日志提供日志分析、用户画像等</p>\n<ul>\n<li><a href="https://github.com/elastic/elasticsearch" target="_blank" rel="nofollow noreferrer noopener">Elasticsearch</a></li>\n<li><a href="https://github.com/elastic/logstash" target="_blank" rel="nofollow noreferrer noopener">Logstash</a></li>\n<li><a href="https://github.com/elastic/kibana" target="_blank" rel="nofollow noreferrer noopener">Kibana</a></li>\n</ul>\n<h4 id="api-网关"><a href="#api-%E7%BD%91%E5%85%B3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>API 网关</h4>\n<p>作用: 外部请求通过 API 网关进行拦截处理，再转发到真正的服务</p>\n<p><a href="https://github.com/Netflix/zuul" target="_blank" rel="nofollow noreferrer noopener">Zuul</a></p>\n<p>Zuul is a gateway service that provides dynamic routing, monitoring, resiliency, security, and more.</p>\n<h4 id="服务监控"><a href="#%E6%9C%8D%E5%8A%A1%E7%9B%91%E6%8E%A7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>服务监控</h4>\n<p>作用: 以可视化或非可视化的形式展示出各个服务的运行情况（CPU、内存、访问量等）</p>\n<ul>\n<li><a href="https://github.com/jjmartres/Zabbix" target="_blank" rel="nofollow noreferrer noopener">Zabbix</a></li>\n<li><a href="https://www.nagios.org/" target="_blank" rel="nofollow noreferrer noopener">Nagios</a></li>\n<li><a href="https://metrics.dropwizard.io/" target="_blank" rel="nofollow noreferrer noopener">Metrics</a></li>\n</ul>\n<h4 id="服务链路追踪"><a href="#%E6%9C%8D%E5%8A%A1%E9%93%BE%E8%B7%AF%E8%BF%BD%E8%B8%AA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>服务链路追踪</h4>\n<p>作用: 明确服务之间的调用关系</p>\n<ul>\n<li><a href="https://github.com/openzipkin/zipkin" target="_blank" rel="nofollow noreferrer noopener">Zipkin</a></li>\n<li><a href="https://github.com/openzipkin/brave" target="_blank" rel="nofollow noreferrer noopener">Brave</a></li>\n</ul>\n<h4 id="数据存储"><a href="#%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>数据存储</h4>\n<p>作用: 存储数据</p>\n<h5 id="关系型数据库"><a href="#%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>关系型数据库</h5>\n<ul>\n<li><a href="https://www.mysql.com/" target="_blank" rel="nofollow noreferrer noopener">MySql</a></li>\n<li><a href="https://www.oracle.com/index.html" target="_blank" rel="nofollow noreferrer noopener">Oracle</a></li>\n<li><a href="https://docs.microsoft.com/zh-cn/sql/?view=sql-server-ver15" target="_blank" rel="nofollow noreferrer noopener">MsSQL</a></li>\n<li><a href="https://www.postgresql.org/" target="_blank" rel="nofollow noreferrer noopener">PostgreSql</a></li>\n</ul>\n<h5 id="非关系型数据库"><a href="#%E9%9D%9E%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>非关系型数据库</h5>\n<ul>\n<li><a href="https://www.mongodb.com/" target="_blank" rel="nofollow noreferrer noopener">Mongodb</a></li>\n<li><a href="https://github.com/elastic/elasticsearch" target="_blank" rel="nofollow noreferrer noopener">Elasticsearch</a></li>\n</ul>\n<h4 id="缓存-2"><a href="#%E7%BC%93%E5%AD%98-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>缓存</h4>\n<p>作用: 存储数据</p>\n<p><a href="https://redis.io/" target="_blank" rel="nofollow noreferrer noopener">redis</a></p>\n<h4 id="分库分表-2"><a href="#%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>分库分表</h4>\n<p>作用: 数据库分库分表方案</p>\n<ul>\n<li><a href="http://shardingsphere.apache.org/" target="_blank" rel="nofollow noreferrer noopener">ShardingSphere</a></li>\n<li><a href="http://www.mycat.io/" target="_blank" rel="nofollow noreferrer noopener">Mycat</a></li>\n</ul>\n<h4 id="服务部署"><a href="#%E6%9C%8D%E5%8A%A1%E9%83%A8%E7%BD%B2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>服务部署</h4>\n<p>作用: 将项目快速部署、上线、持续集成</p>\n<ul>\n<li><a href="http://www.docker.com/" target="_blank" rel="nofollow noreferrer noopener">Docker</a></li>\n<li><a href="https://jenkins.io/zh/" target="_blank" rel="nofollow noreferrer noopener">Jenkins</a></li>\n<li><a href="https://kubernetes.io/" target="_blank" rel="nofollow noreferrer noopener">Kubernetes(K8s)</a></li>\n<li><a href="http://mesos.apache.org/" target="_blank" rel="nofollow noreferrer noopener">Mesos</a></li>\n</ul>\n<h3 id="微服务治理策略"><a href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86%E7%AD%96%E7%95%A5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>微服务治理策略</h3>\n<h4 id="服务的注册和发现"><a href="#%E6%9C%8D%E5%8A%A1%E7%9A%84%E6%B3%A8%E5%86%8C%E5%92%8C%E5%8F%91%E7%8E%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>服务的注册和发现</h4>\n<p>解决问题：集中管理服务</p>\n<p>解决方法：</p>\n<ul>\n<li>Eureka</li>\n<li>Zookeeper</li>\n</ul>\n<h4 id="负载均衡"><a href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>负载均衡</h4>\n<p>解决问题：降低服务器硬件压力</p>\n<p>解决方法：</p>\n<ul>\n<li>Nginx</li>\n<li>Ribbon</li>\n</ul>\n<h4 id="通讯"><a href="#%E9%80%9A%E8%AE%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>通讯</h4>\n<p>解决问题：各个服务之间的沟通桥梁</p>\n<p>解决方法：</p>\n<ul>\n<li>REST（同步）</li>\n<li>RPC（同步）</li>\n<li>MQ（异步）</li>\n</ul>\n<h4 id="配置管理"><a href="#%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>配置管理</h4>\n<p>解决问题：随着服务的增加配置也在增加，如何管理各个服务的配置。</p>\n<p>解决方法：</p>\n<ul>\n<li>Nacos</li>\n<li>Spring Cloud Config</li>\n<li>Apollo</li>\n</ul>\n<h4 id="容错和服务降级"><a href="#%E5%AE%B9%E9%94%99%E5%92%8C%E6%9C%8D%E5%8A%A1%E9%99%8D%E7%BA%A7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>容错和服务降级</h4>\n<p>解决问题：在微服务当中，一个请求经常会涉及到调用几个服务，如果其中某个服务不可以，没有做服务容错的话，极有可能会造成一连串的服务不可用，这就是雪崩效应。</p>\n<p>解决方法：</p>\n<ul>\n<li>Hystrix</li>\n</ul>\n<h4 id="服务依赖关系"><a href="#%E6%9C%8D%E5%8A%A1%E4%BE%9D%E8%B5%96%E5%85%B3%E7%B3%BB" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>服务依赖关系</h4>\n<p>解决问题：多个服务之间来回依赖，启动关系的不明确。</p>\n<p>解决方法：应用分层。</p>\n<h4 id="服务文档"><a href="#%E6%9C%8D%E5%8A%A1%E6%96%87%E6%A1%A3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>服务文档</h4>\n<p>解决问题：降低沟通成本</p>\n<p>解决方法：</p>\n<ul>\n<li>Swagger</li>\n<li>Java doc</li>\n</ul>\n<h4 id="服务安全问题"><a href="#%E6%9C%8D%E5%8A%A1%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>服务安全问题</h4>\n<p>解决问题：敏感数据的安全性</p>\n<p>解决方法：</p>\n<ul>\n<li>Oauth</li>\n<li>Shiro</li>\n<li>Spring Security</li>\n</ul>\n<h4 id="流量控制-1"><a href="#%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>流量控制</h4>\n<p>解决问题：避免一个服务上的流量过大拖垮整个服务体系</p>\n<p>解决方法：</p>\n<ul>\n<li>Hystrix</li>\n</ul>\n<h4 id="自动化测试"><a href="#%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%8B%E8%AF%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>自动化测试</h4>\n<p>解决问题：提前预知异常，确定服务是否可用</p>\n<p>解决方法：</p>\n<ul>\n<li>junit</li>\n</ul>\n<h4 id="服务上线，下线的流程"><a href="#%E6%9C%8D%E5%8A%A1%E4%B8%8A%E7%BA%BF%EF%BC%8C%E4%B8%8B%E7%BA%BF%E7%9A%84%E6%B5%81%E7%A8%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>服务上线，下线的流程</h4>\n<p>解决问题：避免服务随意的上线下线</p>\n<p>解决方法：新服务上线需要经过管理人员审核，服务下线需要告知各个调用方进行修改，直到没有调用该服务才可以进行下线。</p>\n<h4 id="兼容性"><a href="#%E5%85%BC%E5%AE%B9%E6%80%A7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>兼容性</h4>\n<p>解决问题：服务开发持续进行如何做到兼容。</p>\n<p>解决方法：通过版本号的形式进行管理，修改完成进行回归测试。</p>\n<h4 id="服务编排"><a href="#%E6%9C%8D%E5%8A%A1%E7%BC%96%E6%8E%92" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>服务编排</h4>\n<p>解决问题：解决服务依赖问题的一种方式</p>\n<p>解决方法：</p>\n<ul>\n<li>Docker</li>\n<li>K8s</li>\n</ul>\n<h4 id="资源调度"><a href="#%E8%B5%84%E6%BA%90%E8%B0%83%E5%BA%A6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>资源调度</h4>\n<p>解决问题：每个服务的资源占用量不同，如何分配</p>\n<p>解决方法：</p>\n<ul>\n<li>JVM 隔离</li>\n<li>Classload 隔离</li>\n<li>硬件隔离</li>\n</ul>\n<h4 id="容量规划"><a href="#%E5%AE%B9%E9%87%8F%E8%A7%84%E5%88%92" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>容量规划</h4>\n<p>解决问题：随着时间增长，调用逐步增加，什么时候追加机器。</p>\n<p>解决方法：统计每日调用量和响应时间，根据机器情况设置阈值，超过阈值就可以追加机器。</p>\n<h3 id="eureka-和-zookeeper-都可以提供服务注册与发现的功能，它们有什么区别？"><a href="#eureka-%E5%92%8C-zookeeper-%E9%83%BD%E5%8F%AF%E4%BB%A5%E6%8F%90%E4%BE%9B%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E4%B8%8E%E5%8F%91%E7%8E%B0%E7%9A%84%E5%8A%9F%E8%83%BD%EF%BC%8C%E5%AE%83%E4%BB%AC%E6%9C%89%E4%BB%80%E4%B9%88%E5%8C%BA%E5%88%AB%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Eureka 和 Zookeeper 都可以提供服务注册与发现的功能，它们有什么区别？</h3>\n<h3 id="服务发现组件-eureka-的几个主要调用过程"><a href="#%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0%E7%BB%84%E4%BB%B6-eureka-%E7%9A%84%E5%87%A0%E4%B8%AA%E4%B8%BB%E8%A6%81%E8%B0%83%E7%94%A8%E8%BF%87%E7%A8%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>服务发现组件 Eureka 的几个主要调用过程</h3>\n<h4 id="前言"><a href="#%E5%89%8D%E8%A8%80" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>前言</h4>\n<p>现在流行的微服务体系结构正在改变我们构建应用程序的方式，从单一的单体服务转变为越来越小的可单独部署的服务（称为微服务），共同构成了我们的应用程序。当进行一个业务时不可避免就会存在多个服务之间调用，假如一个服务 A 要访问在另一台服务器部署的服务 B，那么前提是服务 A 要知道服务 B 所在机器的 IP 地址和服务对应的端口，最简单的方式就是让服务 A 自己去维护一份服务 B 的配置（包含 IP 地址和端口等信息），但是这种方式有几个明显的缺点：随着我们调用服务数量的增加，配置文件该如何维护；缺乏灵活性，如果服务 B 改变 IP 地址或者端口，服务 A 也要修改相应的文件配置；还有一个就是进行服务的动态扩容或缩小不方便。 一个比较好的解决方案就是服务发现（Service Discovery）。它抽象出来了一个注册中心，当一个新的服务上线时，它会将自己的 IP 和端口注册到注册中心去，会对注册的服务进行定期的心跳检测，当发现服务状态异常时将其从注册中心剔除下线。服务 A 只要从注册中心中获取服务 B 的信息即可，即使当服务 B 的 IP 或者端口变更了，服务 A 也无需修改，从一定程度上解耦了服务。服务发现目前业界有很多开源的实现，比如 apache 的 zookeeper、Netflix 的 eureka、hashicorp 的 consul、CoreOS 的 etcd。</p>\n<h4 id="eureka-是什么"><a href="#eureka-%E6%98%AF%E4%BB%80%E4%B9%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Eureka 是什么</h4>\n<p>Eureka 在 GitHub 上对其的定义为</p>\n<blockquote>\n<p>Eureka is a REST (Representational State Transfer) based service that is primarily used in the AWS cloud for locating services for the purpose of load balancing and failover of middle-tier servers.</p>\n</blockquote>\n<p>At Netflix, Eureka is used for the following purposes apart from playing a critical part in mid-tier load balancing.</p>\n<p>Eureka 是由 Netflix 公司开源，采用的是 Client / Server 模式进行设计，基于 http 协议和使用 Restful Api 开发的服务注册与发现组件，提供了完整的服务注册和服务发现，可以和 Spring Cloud 无缝集成。其中 Server 端扮演着服务注册中心的角色，主要是为 Client 端提供服务注册和发现等功能，维护着 Client 端的服务注册信息，同时定期心跳检测已注册的服务，当不可用时将服务剔除下线，Client 端可以通过 Server 端获取自身所依赖服务的注册信息，从而完成服务间的调用。遗憾的是从其官方的 github wiki 可以发现，2.0 版本已经不再开源。但是不影响我们对其进行深入了解，毕竟服务注册、服务发现相对来说还是比较基础和通用的，其它开源实现框架的思想也是想通的。</p>\n<h4 id="服务注册中心（eureka-server）"><a href="#%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%EF%BC%88eureka-server%EF%BC%89" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>服务注册中心（Eureka Server）</h4>\n<p>我们在项目中引入 Eureka Server 的相关依赖，然后在启动类加上注解 @EnableEurekaServer，就可以将其作为注册中心，启动服务后访问页面如下：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/eureka-server-homepage-b79a2e880266c64758e99d224416d75f-35cb8.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 41.726190476190474%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAAsSAAALEgHS3X78AAABD0lEQVQY02WQXU+DMBSG+/9/hsZbFTfdGGSJjlJgQrzcGG7KR8dG+b4U0EMbDM6nT8jb0/fcgHauu3O3NIriY08Mhx5PcSyEYR9OfYQMNRrR31dEKU0Zq6uq5lRVlaZpPRCFIewURQE5SRJYYElSlmXFQVmWQbv4Sz4QBH4YBhmHMQZfGIorBHQ+x3mRfzVNL6dp27brWkHXfXM6oYBn6COCNWUhK/J8PntazGeKLK9engnGhq5bpgFBx9pYg+hEx1hbOfYrWlvWUlV13hYLsAI7a9N0bFsMx0LfJIRo2pvjoMfp5Ob6aiLdXzh9kMD/c6F0d7tUFbT3vO1m4/ufY+E/HQ77d8+DcPE0+BFF4Q8mdJsyq996pwAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="eureka server homepage" title="" data-src="/static/eureka-server-homepage-b79a2e880266c64758e99d224416d75f-fee1c.png" data-srcset="/static/eureka-server-homepage-b79a2e880266c64758e99d224416d75f-a67b7.png 200w,\n/static/eureka-server-homepage-b79a2e880266c64758e99d224416d75f-0b187.png 400w,\n/static/eureka-server-homepage-b79a2e880266c64758e99d224416d75f-fee1c.png 800w,\n/static/eureka-server-homepage-b79a2e880266c64758e99d224416d75f-b1a91.png 1200w,\n/static/eureka-server-homepage-b79a2e880266c64758e99d224416d75f-95179.png 1600w,\n/static/eureka-server-homepage-b79a2e880266c64758e99d224416d75f-5d5ba.png 2400w,\n/static/eureka-server-homepage-b79a2e880266c64758e99d224416d75f-35cb8.png 3360w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>我们继续添加两个模块 service-provider，service-consumer，然后在启动类加上注解 @EnableEurekaClient 并指定注册中心地址为我们刚刚启动的 Eureka Server，再次访问可以看到两个服务都已经注册进来了。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/eureka-instance-registered-currently-80dbaf232e987ef4ec429a4543128f2e-cf963.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 10.48532055122828%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAIAAADXZGvcAAAACXBIWXMAAAsSAAALEgHS3X78AAAAaklEQVQI1z2JWw5AMBAA3f8IQuvxI1rFB3ECjwQVqrt1GttIJPMxmQmUFAmLUh7zKMwSlqdclMXQd22jaLW1IqlkqSpRe+QP5UBrvcwjIjzOOQRznWBvhJsKkBmz7ct2zKueLnP4BvYDwb4YB1mAzNAEegAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="eureka instance registered currently" title="" data-src="/static/eureka-instance-registered-currently-80dbaf232e987ef4ec429a4543128f2e-fee1c.png" data-srcset="/static/eureka-instance-registered-currently-80dbaf232e987ef4ec429a4543128f2e-a67b7.png 200w,\n/static/eureka-instance-registered-currently-80dbaf232e987ef4ec429a4543128f2e-0b187.png 400w,\n/static/eureka-instance-registered-currently-80dbaf232e987ef4ec429a4543128f2e-fee1c.png 800w,\n/static/eureka-instance-registered-currently-80dbaf232e987ef4ec429a4543128f2e-b1a91.png 1200w,\n/static/eureka-instance-registered-currently-80dbaf232e987ef4ec429a4543128f2e-95179.png 1600w,\n/static/eureka-instance-registered-currently-80dbaf232e987ef4ec429a4543128f2e-5d5ba.png 2400w,\n/static/eureka-instance-registered-currently-80dbaf232e987ef4ec429a4543128f2e-cf963.png 3338w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>可以看到 Eureka 的使用非常简单，只需要添加几个注解和配置就实现了服务注册和服务发现，接下来我们看看它是如何实现这些功能的。</p>\n<h5 id="服务注册（register）"><a href="#%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%EF%BC%88register%EF%BC%89" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>服务注册（Register）</h5>\n<p>注册中心提供了服务注册接口，用于当有新的服务启动后进行调用来实现服务注册，或者心跳检测到服务状态异常时，变更对应服务的状态。服务注册就是发送一个 POST 请求带上当前实例信息到类 ApplicationResource 的 addInstance 方法进行服务注册。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/eureka-server-applicationresource-addinstance-55200ba8b6a4119cc5dc06e049a7c3a9-5edc6.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 45.751189666893275%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAAsSAAALEgHS3X78AAABkElEQVQoz0WR626jMBBGeZwm2MbX8YVLaNoNAQqE3JQ2SkqrvP8z7FBVu6Pzwxrp2PONo2l4exyGx9g/xu6rr6/Vi7WeMsYs4yAlaAFKGqWsVtYkiscs/lfR2K2n++nj1OJh15ZDs7LOE0q5ZxISLhCBMM4YT2hCCSP/5aFdTffzx6kZ6mJEuS1/ZEY1E5KakCinBEhmGFUUmQ+CEjpfEZmyqJr2+7yfxnbzWprnUoPnnCr1tIyXlBOE/BDTJQrYnJlrEbVV0Ry6++fl9r7bdS/1dmV9KjjJ/dIHt7VJA3GWCpcZ8E4oyRlGkQjnIto1RX/qp+nyfTsehte+WTkfYnyPJt5nzgGADJlyXoA1NjhrXQh5CFma5RFG7Y719HX5vI64s76ZM6OcJAyc0+C0DVLjroXWyrgA1lnsG/wAFQ1NsT/399vpPFY9TjHLIY4JSFGkefAhB5WZJA3ZKi/zkIJSi8UTJp4XhnO+X4/Xy3DeV4fhz69M2ZouO9BNSGsLG9A1wEarrdFrDItxhSCE/AUm5Hy5tgFXFwAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="eureka server applicationresource addinstance" title="" data-src="/static/eureka-server-applicationresource-addinstance-55200ba8b6a4119cc5dc06e049a7c3a9-fee1c.png" data-srcset="/static/eureka-server-applicationresource-addinstance-55200ba8b6a4119cc5dc06e049a7c3a9-a67b7.png 200w,\n/static/eureka-server-applicationresource-addinstance-55200ba8b6a4119cc5dc06e049a7c3a9-0b187.png 400w,\n/static/eureka-server-applicationresource-addinstance-55200ba8b6a4119cc5dc06e049a7c3a9-fee1c.png 800w,\n/static/eureka-server-applicationresource-addinstance-55200ba8b6a4119cc5dc06e049a7c3a9-b1a91.png 1200w,\n/static/eureka-server-applicationresource-addinstance-55200ba8b6a4119cc5dc06e049a7c3a9-95179.png 1600w,\n/static/eureka-server-applicationresource-addinstance-55200ba8b6a4119cc5dc06e049a7c3a9-5d5ba.png 2400w,\n/static/eureka-server-applicationresource-addinstance-55200ba8b6a4119cc5dc06e049a7c3a9-5edc6.png 2942w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>可以看到方法调用了类 PeerAwareInstanceRegistryImpl 的 register 方法，该方法主要分为两步：</p>\n<ol>\n<li>调用父类 AbstractInstanceRegistry 的 register 方法把当前服务注册到注册中心</li>\n<li>调用 replicateToPeers 方法使用异步的方式向其它的 Eureka Server 节点同步服务注册信息</li>\n</ol>\n<p>服务注册信息保存在一个嵌套的 map 中，它的结构如下：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/eureka-server-registry-structure-526043c2ac4857314ad0d6990fd04267-f2200.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 16.225448334756617%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAIAAAAcOLh5AAAACXBIWXMAAAsSAAALEgHS3X78AAAAmElEQVQI1w3LSRKDIBAAQH8TlXUA2QYGtbSyqEn+/5qk790ZHzKM1Y7ZDGiGjDkipUSxUMLcIuTkM81lXgNW672ZAgA4xYQQnQQbxLBBT7Jvqm9G1SkQTFXb5hJqTc5QiFEKL3iQMkk1cSY545x3AHYV/UPfLjeeGA9q3/3+Wfej1KstL8SzlPeyHZWelXbnFmVmwTVj//0DnPcmwsPZih4AAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="eureka server registry structure" title="" data-src="/static/eureka-server-registry-structure-526043c2ac4857314ad0d6990fd04267-fee1c.png" data-srcset="/static/eureka-server-registry-structure-526043c2ac4857314ad0d6990fd04267-a67b7.png 200w,\n/static/eureka-server-registry-structure-526043c2ac4857314ad0d6990fd04267-0b187.png 400w,\n/static/eureka-server-registry-structure-526043c2ac4857314ad0d6990fd04267-fee1c.png 800w,\n/static/eureka-server-registry-structure-526043c2ac4857314ad0d6990fd04267-b1a91.png 1200w,\n/static/eureka-server-registry-structure-526043c2ac4857314ad0d6990fd04267-95179.png 1600w,\n/static/eureka-server-registry-structure-526043c2ac4857314ad0d6990fd04267-f2200.png 2342w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>第一层 map 的 key 是应用名称（对应 Demo 里的 SERVICE-PROVIDER），第二层 map 的 key 是应用对应的实例名称（对应 Demo 里的 mghio-mbp:service-provider:9999），一个应用可以有多个实例，主要调用流程如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/eureka-server-register-sequence-chart-67eb023373af9b08afc127edaafc3b27-de400.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 53.308364544319595%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsSAAALEgHS3X78AAABxElEQVQoz21Q227TQBD1d/OGqAolkEqlL/2BvkVNnCZxcENDhXgJhLauycXBVRM7dtbXXa/txN51mcggtYGj0coznnPmzAiPz5FlmWVa+kzXJtrSMC1j6SJX134VRfH4D4TaQLz42d/wjBXss/a1rcj1b+f1YWtw/+P8WjobNMVhG6J125VH/WtDad9+hJ6u2ltRRxCHndZ3CVOSrtPuTa8xaIEWxBhp/ekXWb2U1T68nRv50+jqzhpJyoWk9KDiUFeA6b7jIYR8z8d+6Dku4wyKbGuFb839x+9f25zzpzkvOEkJbB5ijByEMbbdFU1onCSMMdgcGkC9PIFQPAf8S/N1KUQpBUce8Qkl6yTN83x38s4ZgZzk6faDcxhLAEmkLsa6oQehH8URjnCyTv6QwQMQygSEcs7iLCldlEXQUkz1YTWfTCbj6dgPAkxxSRF2nAAnY9nTCmyR8dxzPHtpAeCisH8pLCwC0yYrUAKaE7smsefYtCkKUwKvHSNIZ54+Dw0TW07kPgSLebht2LCN8OL05bvmUbShOc8/yCevam/fNA73xWrzTqq0j/bOKvv1968b1b1apdo5bioSpBAH4uHUmf0GA/hVikoQuXUAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="eureka server register sequence chart" title="" data-src="/static/eureka-server-register-sequence-chart-67eb023373af9b08afc127edaafc3b27-fee1c.png" data-srcset="/static/eureka-server-register-sequence-chart-67eb023373af9b08afc127edaafc3b27-a67b7.png 200w,\n/static/eureka-server-register-sequence-chart-67eb023373af9b08afc127edaafc3b27-0b187.png 400w,\n/static/eureka-server-register-sequence-chart-67eb023373af9b08afc127edaafc3b27-fee1c.png 800w,\n/static/eureka-server-register-sequence-chart-67eb023373af9b08afc127edaafc3b27-b1a91.png 1200w,\n/static/eureka-server-register-sequence-chart-67eb023373af9b08afc127edaafc3b27-95179.png 1600w,\n/static/eureka-server-register-sequence-chart-67eb023373af9b08afc127edaafc3b27-de400.png 1602w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h5 id="服务续约（renew）"><a href="#%E6%9C%8D%E5%8A%A1%E7%BB%AD%E7%BA%A6%EF%BC%88renew%EF%BC%89" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>服务续约（Renew）</h5>\n<p>服务续约会由服务提供者（比如 Demo 中的 service-provider）定期调用，类似于心跳，用来告知注册中心 Eureka Server 自己的状态，避免被 Eureka Server 认为服务时效将其剔除下线。服务续约就是发送一个 PUT 请求带上当前实例信息到类 InstanceResource 的 renewLease 方法进行服务续约操作。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/eureka-server-instanceresource-renew-b958584ac227bfe4b177aefba0148c18-ff616.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 52.326365475387725%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAAsSAAALEgHS3X78AAABvklEQVQozz1RjXKiMBjkZW56JfkS8h8EAZE7D1AERK9atdVp3/8VLvGm/bKT+ZLJZjeb4G3bfk7959h9DJtbVx/rSmkLhBBJCAOg2AE7ED9DBK5BIfpfwbBe3C7Tad+Om7Jv822TK2MxAFGEcVCGME1AAEiA6EGOsAPCD3LX5Jfz9LJfu6ZvF11TfJMjBsISbihVlHCCwesjQI4ZhiGlUTA0Wb/vbrfj+3k39VXfFtrGjhzNqJAgNeiYCaUizoBhIrxtd4vjA0Dw53fW9Ou318P1sO3a5WpVaBMj7H0SBWAIKOI9C+y8ePh9gokXD2yRLevmNO0u43ZZLc2iUHbGGNYSMc4LjnMX20PrC8gtXTnxYGyybl/f7y/vl93YlcO6MHHsjhOKyuVTnf8sU6XT2NjE6MSYRM9SoTRlHGPsAsumv9vredp11abOunbh3hwiSMlTn/9Y5WKRmCIWVWpX6fxXklRxnEkxA8xQ6NM+nKbL63g8tIdx5dLWxjp3OQ1LKTJpcibmjBdSFVqnLMoYmwsx51xh/1XZ7rj5uJ+up2HYlJ5sfWBuJPHMpmkkOdMiEiJiXEjDlQZCn1H4jNA/MD2Is9d5Ox8AAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="eureka server instanceresource renew" title="" data-src="/static/eureka-server-instanceresource-renew-b958584ac227bfe4b177aefba0148c18-fee1c.png" data-srcset="/static/eureka-server-instanceresource-renew-b958584ac227bfe4b177aefba0148c18-a67b7.png 200w,\n/static/eureka-server-instanceresource-renew-b958584ac227bfe4b177aefba0148c18-0b187.png 400w,\n/static/eureka-server-instanceresource-renew-b958584ac227bfe4b177aefba0148c18-fee1c.png 800w,\n/static/eureka-server-instanceresource-renew-b958584ac227bfe4b177aefba0148c18-b1a91.png 1200w,\n/static/eureka-server-instanceresource-renew-b958584ac227bfe4b177aefba0148c18-95179.png 1600w,\n/static/eureka-server-instanceresource-renew-b958584ac227bfe4b177aefba0148c18-5d5ba.png 2400w,\n/static/eureka-server-instanceresource-renew-b958584ac227bfe4b177aefba0148c18-ff616.png 2966w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>进入到 PeerAwareInstanceRegistryImpl 的 renew 方法可以看到，服务续约步骤大体上和服务注册一致，先更新当前 Eureka Server 节点的状态，服务续约成功后再用异步的方式同步状态到其它 Eureka Server 节上，主要调用流程如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/eureka-server-renew-sequence-chart-5ec6f0c64faa5f0b1c92bc729150ab86-2e16b.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 54.32569974554708%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsSAAALEgHS3X78AAABzUlEQVQoz3VQTW/aQBD1D++hapQIRVSccqp6iRSpqUCAQwNRsNTQCkgghI/UUYRjIMasvxav11+p7TUd4gtK1LcjrebNvp03w23eIYoipCJpKon3oqHplmGulitFWUIpTdPdl9yjMS3eVJvizziNIb9bjvlRvdQ/a0yabem6fFsr92vVwTkPMTzvyL3fT11+2Dgb1X9JHU625rXhRX1wST0aR3F32qv0aoJ41X66+aM/Nh+uhIcWpBD18WV/ftdbDC4mQmMiXMt9LjOATWyaJsbYxmtsYbZhQLKEpSzd/B9bMWNslwIFDV2YnBACXwEsgsFXGIbwEqoJHLjTlMvWsAuohfFLxoPesizbJ57nhUH4pg33fofwdxCF2dqJQzzX0xxjJE+QqTnUoT4lrvM3jrZi0CWvw2VKSGOW+FGw9bDZBpA6Ncbq/RKpoijOFjNCiR/6adb5DUAVJfEu48cBuDCQjhDSdR02GmWd6Yu7wAqiGns1bwe2QtS5rRi+tQ5slSLNNSQ8kyx5vn7WqL5ytBlePBPV9DHXktofTvcKP46yOYu31Y+l3EE5fyR8KQ35/XL+oPI5xxdy1cKnYu6k8/24+22/kt8rHX5tHf8DTdRWI9wTK20AAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="eureka server renew sequence chart" title="" data-src="/static/eureka-server-renew-sequence-chart-5ec6f0c64faa5f0b1c92bc729150ab86-fee1c.png" data-srcset="/static/eureka-server-renew-sequence-chart-5ec6f0c64faa5f0b1c92bc729150ab86-a67b7.png 200w,\n/static/eureka-server-renew-sequence-chart-5ec6f0c64faa5f0b1c92bc729150ab86-0b187.png 400w,\n/static/eureka-server-renew-sequence-chart-5ec6f0c64faa5f0b1c92bc729150ab86-fee1c.png 800w,\n/static/eureka-server-renew-sequence-chart-5ec6f0c64faa5f0b1c92bc729150ab86-b1a91.png 1200w,\n/static/eureka-server-renew-sequence-chart-5ec6f0c64faa5f0b1c92bc729150ab86-2e16b.png 1572w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h5 id="服务下线（cancel）"><a href="#%E6%9C%8D%E5%8A%A1%E4%B8%8B%E7%BA%BF%EF%BC%88cancel%EF%BC%89" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>服务下线（Cancel）</h5>\n<p>当服务提供者（比如 Demo 中的 service-provider）停止服务时，会发送请求告知注册中心 Eureka Server 进行服务剔除下线操作，防止服务消费者从注册中心调用到不存在的服务。服务下线就是发送一个 DELETE 请求带上当前实例信息到类 InstanceResource 的 cancelLease 方法进行服务剔除下线操作。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/eureka-server-instanceresource-cancellease-898a90c31d4fc5f9a03e07af3afd1430-aaa0d.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 34.79138627187079%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAAsSAAALEgHS3X78AAABQUlEQVQY0yWPAXKCMBBFOU5NshtIAiihQKVgFVEQtTqIlhl7/yt0sTt/dpJJ3v6/Tl+vf4/Ns62fh3rcbfp1YSMLUqIBVICuABRCCoF86i9xKsa54E67zX5ux9t33e2WbZU1VRpZSwT64Go0AXohoqErooZ/gQcCphFOvU6Gvusvezrsq4w0wYiCfigQc8l8hAAwQJgwAZTFe5kTfKjSpls/xus4dOe2JGcbx64ro/BN+yrRIvdoDjBOXiiokykgJRMATlmmq/rrNlzvl7beFkVJsWNAaSTLQ7aZ810U5PNF6s/flU+ySodKeUpLKZ0wS7NyNZxP47H5LD/DjyyMpp2BsRRm1mhr/ETpRGtLcVx3Adyw2YxN5XTbtDkU9/H86NtTk3d1FscTTG/alcs4jpPUhNoEGpEjCN8ESmkEoJ3/AA1FXwDLT67eAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="eureka server instanceresource cancellease" title="" data-src="/static/eureka-server-instanceresource-cancellease-898a90c31d4fc5f9a03e07af3afd1430-fee1c.png" data-srcset="/static/eureka-server-instanceresource-cancellease-898a90c31d4fc5f9a03e07af3afd1430-a67b7.png 200w,\n/static/eureka-server-instanceresource-cancellease-898a90c31d4fc5f9a03e07af3afd1430-0b187.png 400w,\n/static/eureka-server-instanceresource-cancellease-898a90c31d4fc5f9a03e07af3afd1430-fee1c.png 800w,\n/static/eureka-server-instanceresource-cancellease-898a90c31d4fc5f9a03e07af3afd1430-b1a91.png 1200w,\n/static/eureka-server-instanceresource-cancellease-898a90c31d4fc5f9a03e07af3afd1430-95179.png 1600w,\n/static/eureka-server-instanceresource-cancellease-898a90c31d4fc5f9a03e07af3afd1430-5d5ba.png 2400w,\n/static/eureka-server-instanceresource-cancellease-898a90c31d4fc5f9a03e07af3afd1430-aaa0d.png 2972w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>进入到 PeerAwareInstanceRegistryImpl 的 cancel 方法可以看到，服务续约步骤大体上和服务注册一致，先在当前 Eureka Server 节点剔除下线该服务，服务下线成功后再用异步的方式同步状态到其它 Eureka Server 节上，主要调用流程如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/eureka-server-cancellease-sequence-chart-ff6acd275b3c98a9bdb21f4ad53fc4a7-2e16b.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 54.32569974554708%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsSAAALEgHS3X78AAABzElEQVQoz21QOXPaQBTWL09BXOCkcJEmqZJJYRcM5ooPBgh2PHYwA1gmETgJh5AFOlfa1bVCQkuewAWx8+2bPd71ffu49Qssaagp2vjPSJyIpm6CyZK8kOcQYoztZnI/F8Pjbrn5cJWwBN4dia/wZ/l2qSY0v4/bhW6l2DsBK/VOy/xpa9q5GrUq9+eQczNuc7/18Zf7avWu7gd+tIxuft0WOyf1wQXkCepDY3j5dfitMbisCxdn/VpX4ttir/qjcd6vd8Q7biNmncozTGQh27SRiVgqkMXLmK02Otn6v0iLkyTZdYF+h3qUUsMwVFW1EDIJcnw3oBRCYCtYcDK2Zf4HEKFxuPUTQixk2T52PRfaPaPhXs4QetOYwiUMQ4yx53oKUflJXzU07BDHc7BLojhKi6EulcGeWsJv42QVRDTVkE4j7asQrT8XHheyIAgzScIE+2HAtszPAAVREu96gphGUaSruqIoMFds4ydmTMnMllVH25KgwH7EcxFLho8s3547iurqIzQZoaloS3BfEHVqzSQsm4HF1QbNV7m9d9UP8Ybt6DafOd7fK7x93/yY6xVfF95kSwfZ8gHsmXz2sJX7dH0I0Ux+//P10V+YuVZR6J/RWAAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="eureka server cancellease sequence chart" title="" data-src="/static/eureka-server-cancellease-sequence-chart-ff6acd275b3c98a9bdb21f4ad53fc4a7-fee1c.png" data-srcset="/static/eureka-server-cancellease-sequence-chart-ff6acd275b3c98a9bdb21f4ad53fc4a7-a67b7.png 200w,\n/static/eureka-server-cancellease-sequence-chart-ff6acd275b3c98a9bdb21f4ad53fc4a7-0b187.png 400w,\n/static/eureka-server-cancellease-sequence-chart-ff6acd275b3c98a9bdb21f4ad53fc4a7-fee1c.png 800w,\n/static/eureka-server-cancellease-sequence-chart-ff6acd275b3c98a9bdb21f4ad53fc4a7-b1a91.png 1200w,\n/static/eureka-server-cancellease-sequence-chart-ff6acd275b3c98a9bdb21f4ad53fc4a7-2e16b.png 1572w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h5 id="服务剔除（eviction）"><a href="#%E6%9C%8D%E5%8A%A1%E5%89%94%E9%99%A4%EF%BC%88eviction%EF%BC%89" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>服务剔除（Eviction）</h5>\n<p>服务剔除是注册中心 Eureka Server 在启动时就启动一个守护线程 evictionTimer 来定期（默认为 60 秒）执行检测服务的，判断标准就是超过一定时间没有进行 Renew 的服务，默认的失效时间是 90 秒，也就是说当一个已注册的服务在 90 秒内没有向注册中心 Eureka Server 进行服务续约（Renew），就会被从注册中心剔除下线。失效时间可以通过配置 eureka.instance.leaseExpirationDurationInSeconds 进行修改，定期执行检测服务可以通过配置 eureka.server.evictionIntervalTimerInMs 进行修改，主要调用流程如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/eureka-server-evict-sequence-chart-2284e1042a2b4c589b5c8760dbc6c78f-cfd19.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 50.82352941176471%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAAsSAAALEgHS3X78AAABo0lEQVQoz21QiU7bQBD1//8DCJzIJGqFKlWFgEmLA0agqIpofMRFxYlDHCcksb2X97LdRY1UV2V2pHm7M29m3mr1f8YYi+PY9/0gmCRJsl6vwzDMQa5SVVU1K7XhbNSyO227O3i663lXxv3HzsOpYX84HhhnPy5N91ofGN2HU/22c+l97U+s49uTK9+6cN+wtgTJOPbGC8+fB8Pg+2j66CicBH7yc5bN59nCS4LJ6smJ/eftbLqNxgt3uosUDreRtt+gqjnjnPK6rElBpJSlKHevWwRQqSAX9XumVW9CqqYYLjkTvJSSMipVKCUooPqIPM8RQpBAVVOWlTr7yU0yFYzL/SghhGqRE4AQzrMMY0wY+bOp8nfIrEGGEKqBcZY4UzfNUlTgHUxzCLjgivJXc3NtUf4jcgVefyXPqtFL/BItos1mAxFUcjQmORZEOZWsEJSIIqMAMEhkUUhKJcUcr8kmK3KlfIfTJVghhuN0CRnS7sPhgdU6tNqmf/1p9OXoxtDtjm6fHFqtz4+9C7evsu27rrqeOabpfzsY6Orx3DF7bv83F4EjDb17GxcAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="eureka server evict sequence chart" title="" data-src="/static/eureka-server-evict-sequence-chart-2284e1042a2b4c589b5c8760dbc6c78f-fee1c.png" data-srcset="/static/eureka-server-evict-sequence-chart-2284e1042a2b4c589b5c8760dbc6c78f-a67b7.png 200w,\n/static/eureka-server-evict-sequence-chart-2284e1042a2b4c589b5c8760dbc6c78f-0b187.png 400w,\n/static/eureka-server-evict-sequence-chart-2284e1042a2b4c589b5c8760dbc6c78f-fee1c.png 800w,\n/static/eureka-server-evict-sequence-chart-2284e1042a2b4c589b5c8760dbc6c78f-b1a91.png 1200w,\n/static/eureka-server-evict-sequence-chart-2284e1042a2b4c589b5c8760dbc6c78f-95179.png 1600w,\n/static/eureka-server-evict-sequence-chart-2284e1042a2b4c589b5c8760dbc6c78f-cfd19.png 1700w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h4 id="服务提供者（service-provider）"><a href="#%E6%9C%8D%E5%8A%A1%E6%8F%90%E4%BE%9B%E8%80%85%EF%BC%88service-provider%EF%BC%89" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>服务提供者（Service Provider）</h4>\n<p>对于服务提供方（比如 Demo 中的 service-provider 服务）来说，主要有三大类操作，分别为服务注册（Register）、服务续约（Renew）、服务下线（Cancel），接下来看看这三个操作是如何实现的。</p>\n<h5 id="服务注册（register）-1"><a href="#%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%EF%BC%88register%EF%BC%89-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>服务注册（Register）</h5>\n<p>一个服务要对外提供服务，首先要在注册中心 Eureka Server 进行服务相关信息注册，能进行这一步的前提是你要配置 eureka.client.register-with-eureka = true，这个默认值为 true，注册中心不需要把自己注册到注册中心去，把这个配置设为 false，这个调用比较简单，主要调用流程如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/eureka-service-provider-register-sequence-chart-67eb023373af9b08afc127edaafc3b27-de400.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 53.308364544319595%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsSAAALEgHS3X78AAABxElEQVQoz21Q227TQBD1d/OGqAolkEqlL/2BvkVNnCZxcENDhXgJhLauycXBVRM7dtbXXa/txN51mcggtYGj0coznnPmzAiPz5FlmWVa+kzXJtrSMC1j6SJX134VRfH4D4TaQLz42d/wjBXss/a1rcj1b+f1YWtw/+P8WjobNMVhG6J125VH/WtDad9+hJ6u2ltRRxCHndZ3CVOSrtPuTa8xaIEWxBhp/ekXWb2U1T68nRv50+jqzhpJyoWk9KDiUFeA6b7jIYR8z8d+6Dku4wyKbGuFb839x+9f25zzpzkvOEkJbB5ijByEMbbdFU1onCSMMdgcGkC9PIFQPAf8S/N1KUQpBUce8Qkl6yTN83x38s4ZgZzk6faDcxhLAEmkLsa6oQehH8URjnCyTv6QwQMQygSEcs7iLCldlEXQUkz1YTWfTCbj6dgPAkxxSRF2nAAnY9nTCmyR8dxzPHtpAeCisH8pLCwC0yYrUAKaE7smsefYtCkKUwKvHSNIZ54+Dw0TW07kPgSLebht2LCN8OL05bvmUbShOc8/yCevam/fNA73xWrzTqq0j/bOKvv1968b1b1apdo5bioSpBAH4uHUmf0GA/hVikoQuXUAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="eureka service provider register sequence chart" title="" data-src="/static/eureka-service-provider-register-sequence-chart-67eb023373af9b08afc127edaafc3b27-fee1c.png" data-srcset="/static/eureka-service-provider-register-sequence-chart-67eb023373af9b08afc127edaafc3b27-a67b7.png 200w,\n/static/eureka-service-provider-register-sequence-chart-67eb023373af9b08afc127edaafc3b27-0b187.png 400w,\n/static/eureka-service-provider-register-sequence-chart-67eb023373af9b08afc127edaafc3b27-fee1c.png 800w,\n/static/eureka-service-provider-register-sequence-chart-67eb023373af9b08afc127edaafc3b27-b1a91.png 1200w,\n/static/eureka-service-provider-register-sequence-chart-67eb023373af9b08afc127edaafc3b27-95179.png 1600w,\n/static/eureka-service-provider-register-sequence-chart-67eb023373af9b08afc127edaafc3b27-de400.png 1602w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h5 id="服务续约（renew）-1"><a href="#%E6%9C%8D%E5%8A%A1%E7%BB%AD%E7%BA%A6%EF%BC%88renew%EF%BC%89-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>服务续约（Renew）</h5>\n<p>服务续约是由服务提供者方定期（默认为 30 秒）发起心跳的，主要是用来告知注册中心 Eureka Server 自己状态是正常的还活着，可以通过配置 eureka.instance.lease-renewal-interval-in-seconds 来修改，当然服务续约的前提是要配置 eureka.client.register-with-eureka = true ，将该服务注册到注册中心中去，主要调用流程如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/eureka-service-provider-renew-sequence-chart-1279f9c735e1e6bf51e3a83555d218dd-98822.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 29.83783783783784%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAIAAABM9SnKAAAACXBIWXMAAAsSAAALEgHS3X78AAABJ0lEQVQY02WN7U+CUBjF+f//BGcTc2iJFbWVbZYvEGij6fpA5QuiItfL+xXxLoML3daXZs/Ozp5z9tsOk+d5lmd/5Qe+bujv4w9N06bzGXRsAIGxMAghRySjLkfcgOdfhLp6VXu+uNNa7bFUkc+F0W1vqnBKvdZvcH3+5rUpTpXqgKcYFe07E4kJ98gMrHUIFu5Kh4YBlyCAEzCDke1E3so3AYLrANiRG2BkhpYVbmhc+Wsv9pn832VZlpI0TVIUILzDSZL8lCQjKTkiGfyF6TjC21/ffcb7A7Yjh0b6hDGiy87WBd5mbhrUgb9xI4+S8WHPyPqgILJlpVaSuaJ42hhe32uPhV7pTL1sjbtFsczK3IlU4YdCeyIWpQorV0tPXKHLNt8evgGZGzkSWAp+lgAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="eureka service provider renew sequence chart" title="" data-src="/static/eureka-service-provider-renew-sequence-chart-1279f9c735e1e6bf51e3a83555d218dd-fee1c.png" data-srcset="/static/eureka-service-provider-renew-sequence-chart-1279f9c735e1e6bf51e3a83555d218dd-a67b7.png 200w,\n/static/eureka-service-provider-renew-sequence-chart-1279f9c735e1e6bf51e3a83555d218dd-0b187.png 400w,\n/static/eureka-service-provider-renew-sequence-chart-1279f9c735e1e6bf51e3a83555d218dd-fee1c.png 800w,\n/static/eureka-service-provider-renew-sequence-chart-1279f9c735e1e6bf51e3a83555d218dd-b1a91.png 1200w,\n/static/eureka-service-provider-renew-sequence-chart-1279f9c735e1e6bf51e3a83555d218dd-95179.png 1600w,\n/static/eureka-service-provider-renew-sequence-chart-1279f9c735e1e6bf51e3a83555d218dd-98822.png 1850w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h5 id="服务下线（cancel）-1"><a href="#%E6%9C%8D%E5%8A%A1%E4%B8%8B%E7%BA%BF%EF%BC%88cancel%EF%BC%89-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>服务下线（Cancel）</h5>\n<p>当服务提供者方服务停止时，要发送 DELETE 请求告知注册中心 Eureka Server 自己已经下线，好让注册中心将自己剔除下线，防止服务消费方从注册中心获取到不可用的服务。这个过程实现比较简单，在类 DiscoveryClient 的 shutdown 方法加上注解 @PreDestroy，当服务停止时会自动触发服务剔除下线，执行服务下线逻辑，主要调用流程如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/eureka-service-provider-cancel-sequence-chart-57df88da46d18a95af9a07f90d4b729f-ff8ad.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 37.48531139835488%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAAsSAAALEgHS3X78AAABNElEQVQY031QDUvCUBTd//8VUZg4YUUmbqVFykTNXPvUpbTSfShva+5tjodvm90V9EHQeRfufZfDuYfDHH6DZnSz3syf5oZumKZpr+zA9xFC1rOVpulPZp7nzNiSjnqV1daBP6Hk4rF10qud3TduZ73jbrUq1k9FtiKy4mJQH53Xhhw75GoDrtJnJ68y40br/nxkuS8JjoMwGC0epKW68K1laKuOrjmG5k6hQF13Z6qrw1J1DMXR7NBj4GCRFbtkF8cxxtiz3QhHsAFXh39R2s5L2hevoHkWJlv0hpCPQCtJE0ihAAC7bEXJ/yiaZcxfSZrT4lC+MoU9oTSDGUd4T/bgiBDyfVl3pty44UXrz8BuzO6lzN+ZomQrvNbm1XZLuYZhspQFrcNrnaZ8JaidpiIY3uwdNr179HDsLVwAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="eureka service provider cancel sequence chart" title="" data-src="/static/eureka-service-provider-cancel-sequence-chart-57df88da46d18a95af9a07f90d4b729f-fee1c.png" data-srcset="/static/eureka-service-provider-cancel-sequence-chart-57df88da46d18a95af9a07f90d4b729f-a67b7.png 200w,\n/static/eureka-service-provider-cancel-sequence-chart-57df88da46d18a95af9a07f90d4b729f-0b187.png 400w,\n/static/eureka-service-provider-cancel-sequence-chart-57df88da46d18a95af9a07f90d4b729f-fee1c.png 800w,\n/static/eureka-service-provider-cancel-sequence-chart-57df88da46d18a95af9a07f90d4b729f-b1a91.png 1200w,\n/static/eureka-service-provider-cancel-sequence-chart-57df88da46d18a95af9a07f90d4b729f-95179.png 1600w,\n/static/eureka-service-provider-cancel-sequence-chart-57df88da46d18a95af9a07f90d4b729f-ff8ad.png 1702w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h4 id="服务消费者（service-consumer）"><a href="#%E6%9C%8D%E5%8A%A1%E6%B6%88%E8%B4%B9%E8%80%85%EF%BC%88service-consumer%EF%BC%89" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>服务消费者（Service Consumer）</h4>\n<p>这里的服务消费者如果不需要被其它服务调用的话，其实只会涉及到两个操作，分别是从注册中心获取服务列表（Fetch）和更新服务列表（Update）。如果同时也需要注册到注册中心对外提供服务的话，那么剩下的过程和上文提到的服务提供者是一致的，这里不再阐述，接下来看看这两个操作是如何实现的。</p>\n<h5 id="获取服务列表（fetch）"><a href="#%E8%8E%B7%E5%8F%96%E6%9C%8D%E5%8A%A1%E5%88%97%E8%A1%A8%EF%BC%88fetch%EF%BC%89" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>获取服务列表（Fetch）</h5>\n<p>服务消费者方启动之后首先肯定是要先从注册中心 Eureka Server 获取到可用的服务列表同时本地也会缓存一份。这个获取服务列表的操作是在服务启动后 DiscoverClient 类实例化的时候执行的。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/eureka-service-consumer-fetchregistry-65b5b4f5926a07870709062390975220-c928e.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 38.52511125238398%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAAsSAAALEgHS3X78AAABdUlEQVQY0yVRXXPaMBD03wHpJN3p23Zi6DTNgMFxAYekFBeSNG0604f+/5ceyc7OjaSZ1a5Wxe+h/9kvzuubU/v525cmxQTaAMhoJjn4EBMiKQ2gBCh5oZaKJ8iJEMXhsD0ed91qvl7N23YWUmaxE5PKmApt7cNVTNlSRJOtTYQJdSaTNVzDtNjv2qdxv1l/6ttZt5zFVLI4iGmNWDt/5VztXAIZQESOA8DrpIC3My2Lh2F1Godu2XSL69WiYWfFsaUoSdahLG2qbC5DrFL0zpFWRgGT38EoNpvleBwOD933x7ttf5tyqQ1qBY7Qoify1gXrePrLgbGIlqxDJlHR9c3pvHsat/t+/nVZxXdnKaZ8vbcYvGMZkjVI2ugPKKMNA01xc//2/PLvNP69Hf40dy8h1UrrqRAaROmpysnHyGaG8NI5V62VQs21SyWLdnP/6/n19cd5t39cdH3IFTsLFitIZEKMLkXrHdnLh0mQ7MixFYCYiv94w2yy/+xB1gAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="eureka service consumer fetchregistry" title="" data-src="/static/eureka-service-consumer-fetchregistry-65b5b4f5926a07870709062390975220-fee1c.png" data-srcset="/static/eureka-service-consumer-fetchregistry-65b5b4f5926a07870709062390975220-a67b7.png 200w,\n/static/eureka-service-consumer-fetchregistry-65b5b4f5926a07870709062390975220-0b187.png 400w,\n/static/eureka-service-consumer-fetchregistry-65b5b4f5926a07870709062390975220-fee1c.png 800w,\n/static/eureka-service-consumer-fetchregistry-65b5b4f5926a07870709062390975220-b1a91.png 1200w,\n/static/eureka-service-consumer-fetchregistry-65b5b4f5926a07870709062390975220-95179.png 1600w,\n/static/eureka-service-consumer-fetchregistry-65b5b4f5926a07870709062390975220-5d5ba.png 2400w,\n/static/eureka-service-consumer-fetchregistry-65b5b4f5926a07870709062390975220-c928e.png 3146w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>可以看出，能发生这个获取服务列表的操作前提是要保证配置了 eureka.client.fetch-registry = true，该配置的默认值为 true，主要调用流程如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/eureka-service-consumer-fetch-sequence-chart-8683db39975a563bd19553e41c110d60-0484f.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 50.06765899864683%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAAsSAAALEgHS3X78AAABoUlEQVQoz41R71PaQBDN//8PdIZRLOpUx4Fq0UFlJJHYamVUTAgNv4KhCcHkkiMx5HIBL7iKCjP90vdhb/fdvbc7e9x8BeyZubaraw+KrDQbTbkuqcof8+/Qtmz0iDqtDqV09T2XzlM4MPGF7oXQuThpnNUHclmplKRy6b4M8USp1A2ZV8XjxllFrfJtsdKqnjb5ttPj0vRVPMTWzlUhf31QuCnWTfnw/jhf+7F/e7R/cwTJnSmV5DIk+VoRYqFW3P39XTIVDpSgD4IgCicwVRRGCU3m/wduPB47juN6HkLIffLAJaYxY2xhusBq/nr1QXLsDc9vGBMfYdcwDMuyfN+nCf2320L23nm56pSF00k8hdkpiQkhkRdiQgm46APdHJpABuETSeLPQZZiWHvCpmDxyczS2aLEHnZtFGAfY+xPgoRQNmPLzmQa91C/+diGD3BCpLl6F8pRq4s0zdPt0OkD42hdt387kBRDVUcdFHkfXxWM1sWtbHVrTdwUe5e5n98y/MY6lOebGSF33vu1fbWXEb6uCbmsuA38Fz572a+9AOt4HQ36CWc1AAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="eureka service consumer fetch sequence chart" title="" data-src="/static/eureka-service-consumer-fetch-sequence-chart-8683db39975a563bd19553e41c110d60-fee1c.png" data-srcset="/static/eureka-service-consumer-fetch-sequence-chart-8683db39975a563bd19553e41c110d60-a67b7.png 200w,\n/static/eureka-service-consumer-fetch-sequence-chart-8683db39975a563bd19553e41c110d60-0b187.png 400w,\n/static/eureka-service-consumer-fetch-sequence-chart-8683db39975a563bd19553e41c110d60-fee1c.png 800w,\n/static/eureka-service-consumer-fetch-sequence-chart-8683db39975a563bd19553e41c110d60-b1a91.png 1200w,\n/static/eureka-service-consumer-fetch-sequence-chart-8683db39975a563bd19553e41c110d60-0484f.png 1478w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h5 id="更新服务列表（update）"><a href="#%E6%9B%B4%E6%96%B0%E6%9C%8D%E5%8A%A1%E5%88%97%E8%A1%A8%EF%BC%88update%EF%BC%89" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>更新服务列表（Update）</h5>\n<p>由上面的获取服务列表（Fetch）操作过程可知，本地也会缓存一份，所以这里需要定期的去到注册中心 Eureka Server 获取服务的最新配置，然后比较更新本地缓存，这个更新的间隔时间可以通过配置 eureka.client.registry-fetch-interval-seconds 修改，默认为 30 秒，能进行这一步更新服务列表的前提是你要配置 eureka.client.register-with-eureka = true，这个默认值为 true。主要调用流程如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/eureka-service-consumer-update-sequence-chart-b838343cfb227fe7bb6808cbbaaf8667-e408e.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 53.222222222222214%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsSAAALEgHS3X78AAAB1UlEQVQoz41QW2/TMBTu70aoaNWq7YUHpMFYCutAiKFNXffAJhFEV4EETBqoUq9sTWjTJHWS5uaktmM7CQ6FSpt44JN1Lvb5jr9zSlmW5X/BGdMNYzga9vq9TqfT7Xcn2sQwDU3TVFXNb4NzXlLdae3jC6ldP+/JR1cnj2XpyYfa4eXxWffdjrwntfZ33z+rf3olD1vSxb4oq7UPpFb9afv51NVKiq5+Hl1eKd9HxvXYVgbmqG8Ox46q+XrPGIh0MB/9sG70wCji4nVlhyGCpTRNszxDGPOEMcpyMUSW/w8K2ZxxwogTOLPZTFGUGdBFmhcdxDayovUK+R+/vinIYD43gWmFNgAgjmPCCeV03T7N0jsfrhdckIMg8EIPQNvzvYQkhCcxXqY8vVP6b7JwLGUL5C7xkiYUosgAJgwhpZQQEkQBZVTUIYSEFZoZY7fIQqeLPJZyEYuBV7J/j5njBAs1BJPxzRjMAbCA4y8wwmJTBVmU2vFCcSc+8iGBILIBtEIMIYk85IPIcpaLgITixoaOHTk/3enMMUSAKSn1zEG5WS03Ng++vN652Lt/XCmfVB/Juy+/Ht472thobj1oVLfePnzzrSFicSqn25Xmdvl089oa/wJEHFIFOmBpoQAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="eureka service consumer update sequence chart" title="" data-src="/static/eureka-service-consumer-update-sequence-chart-b838343cfb227fe7bb6808cbbaaf8667-fee1c.png" data-srcset="/static/eureka-service-consumer-update-sequence-chart-b838343cfb227fe7bb6808cbbaaf8667-a67b7.png 200w,\n/static/eureka-service-consumer-update-sequence-chart-b838343cfb227fe7bb6808cbbaaf8667-0b187.png 400w,\n/static/eureka-service-consumer-update-sequence-chart-b838343cfb227fe7bb6808cbbaaf8667-fee1c.png 800w,\n/static/eureka-service-consumer-update-sequence-chart-b838343cfb227fe7bb6808cbbaaf8667-b1a91.png 1200w,\n/static/eureka-service-consumer-update-sequence-chart-b838343cfb227fe7bb6808cbbaaf8667-95179.png 1600w,\n/static/eureka-service-consumer-update-sequence-chart-b838343cfb227fe7bb6808cbbaaf8667-e408e.png 1800w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h4 id="总结-5"><a href="#%E6%80%BB%E7%BB%93-5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h4>\n<p>工作中项目使用的是 Spring Cloud 技术栈，它有一套非常完善的开源代码来整合 Eureka，使用起来非常方便。之前都是直接加注解和修改几个配置属性一气呵成的，没有深入了解过源码实现，本文主要是阐述了服务注册、服务发现等相关过程和实现方式，对 Eureka 服务发现组件有了更近一步的了解。</p>\n<p>// TODO <a href="https://doocs.github.io/advanced-java/#/docs/high-concurrency/how-to-limit-current" target="_blank" rel="nofollow noreferrer noopener">https://doocs.github.io/advanced-java/#/docs/high-concurrency/how-to-limit-current</a></p>',
excerpt:"高并发架构 消息队列 为什么使用消息队列？ 优点 解耦：通过一个 MQ，Pub/Sub 发布订阅消息这么一个模型，A 系统就跟其它系统彻底解耦了。 异步：任务发到消息队列，由消费者异步消费 削峰：任务发到消息队列，由消费者决定消费速度 缺点 系统可用性降低：MQ…",timeToRead:177,tableOfContents:'<ul>\n<li>\n<p><a href="/system-design-deep-learn/#%E9%AB%98%E5%B9%B6%E5%8F%91%E6%9E%B6%E6%9E%84">高并发架构</a></p>\n<ul>\n<li>\n<p><a href="/system-design-deep-learn/#%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97">消息队列</a></p>\n<ul>\n<li>\n<p><a href="/system-design-deep-learn/#%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BD%BF%E7%94%A8%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%EF%BC%9F">为什么使用消息队列？</a></p>\n<ul>\n<li><a href="/system-design-deep-learn/#%E4%BC%98%E7%82%B9">优点</a></li>\n<li><a href="/system-design-deep-learn/#%E7%BC%BA%E7%82%B9">缺点</a></li>\n<li><a href="/system-design-deep-learn/#kafka%E3%80%81activemq%E3%80%81rabbitmq%E3%80%81rocketmq-%E6%9C%89%E4%BB%80%E4%B9%88%E4%BC%98%E7%BC%BA%E7%82%B9%EF%BC%9F">Kafka、ActiveMQ、RabbitMQ、RocketMQ 有什么优缺点？</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/system-design-deep-learn/#%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8%EF%BC%9F">如何保证消息队列的高可用？</a></p>\n<ul>\n<li>\n<p><a href="/system-design-deep-learn/#rabbitmq-%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8%E6%80%A7">RabbitMQ 的高可用性</a></p>\n<ul>\n<li><a href="/system-design-deep-learn/#%E5%8D%95%E6%9C%BA%E6%A8%A1%E5%BC%8F">单机模式</a></li>\n<li><a href="/system-design-deep-learn/#%E6%99%AE%E9%80%9A%E9%9B%86%E7%BE%A4%E6%A8%A1%E5%BC%8F%EF%BC%88%E6%97%A0%E9%AB%98%E5%8F%AF%E7%94%A8%E6%80%A7%EF%BC%89">普通集群模式（无高可用性）</a></li>\n<li><a href="/system-design-deep-learn/#%E9%95%9C%E5%83%8F%E9%9B%86%E7%BE%A4%E6%A8%A1%E5%BC%8F%EF%BC%88%E9%AB%98%E5%8F%AF%E7%94%A8%E6%80%A7%EF%BC%89">镜像集群模式（高可用性）</a></li>\n</ul>\n</li>\n<li><a href="/system-design-deep-learn/#kafka-%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8%E6%80%A7">Kafka 的高可用性</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/system-design-deep-learn/#%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%E6%B6%88%E6%81%AF%E4%B8%8D%E8%A2%AB%E9%87%8D%E5%A4%8D%E6%B6%88%E8%B4%B9%EF%BC%9F">如何保证消息不被重复消费？</a></p>\n<ul>\n<li><a href="/system-design-deep-learn/#%E8%83%8C%E6%99%AF">背景</a></li>\n<li><a href="/system-design-deep-learn/#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88">解决方案</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/system-design-deep-learn/#%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%E6%B6%88%E6%81%AF%E7%9A%84%E5%8F%AF%E9%9D%A0%E6%80%A7%E4%BC%A0%E8%BE%93%EF%BC%9F">如何保证消息的可靠性传输？</a></p>\n<ul>\n<li>\n<p><a href="/system-design-deep-learn/#rabbitmq">RabbitMQ</a></p>\n<ul>\n<li><a href="/system-design-deep-learn/#%E7%94%9F%E4%BA%A7%E8%80%85%E5%BC%84%E4%B8%A2%E4%BA%86%E6%95%B0%E6%8D%AE">生产者弄丢了数据</a></li>\n<li><a href="/system-design-deep-learn/#rabbitmq-%E5%BC%84%E4%B8%A2%E4%BA%86%E6%95%B0%E6%8D%AE">RabbitMQ 弄丢了数据</a></li>\n<li><a href="/system-design-deep-learn/#%E6%B6%88%E8%B4%B9%E7%AB%AF%E5%BC%84%E4%B8%A2%E4%BA%86%E6%95%B0%E6%8D%AE">消费端弄丢了数据</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/system-design-deep-learn/#kafka">Kafka</a></p>\n<ul>\n<li><a href="/system-design-deep-learn/#%E6%B6%88%E8%B4%B9%E7%AB%AF%E5%BC%84%E4%B8%A2%E4%BA%86%E6%95%B0%E6%8D%AE-1">消费端弄丢了数据</a></li>\n<li><a href="/system-design-deep-learn/#kafka-%E5%BC%84%E4%B8%A2%E4%BA%86%E6%95%B0%E6%8D%AE">Kafka 弄丢了数据</a></li>\n<li><a href="/system-design-deep-learn/#%E7%94%9F%E4%BA%A7%E8%80%85%E4%BC%9A%E4%B8%8D%E4%BC%9A%E5%BC%84%E4%B8%A2%E6%95%B0%E6%8D%AE%EF%BC%9F">生产者会不会弄丢数据？</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/system-design-deep-learn/#rocketmq">RocketMQ</a></p>\n<ul>\n<li><a href="/system-design-deep-learn/#%E6%B6%88%E6%81%AF%E4%B8%A2%E5%A4%B1%E7%9A%84%E5%9C%BA%E6%99%AF">消息丢失的场景</a></li>\n<li><a href="/system-design-deep-learn/#%E7%94%9F%E4%BA%A7%E8%80%85%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF%E6%97%B6%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%E4%B8%8D%E4%B8%A2%E5%A4%B1%EF%BC%9F">生产者发送消息时如何保证不丢失？</a></li>\n<li><a href="/system-design-deep-learn/#mq-%E6%94%B6%E5%88%B0%E6%B6%88%E6%81%AF%E5%90%8E%E5%86%99%E5%85%A5%E7%A1%AC%E7%9B%98%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%E4%B8%8D%E4%B8%A2%E5%A4%B1%EF%BC%9F">MQ 收到消息后写入硬盘如何保证不丢失？</a></li>\n<li><a href="/system-design-deep-learn/#%E6%B6%88%E6%81%AF%E5%86%99%E5%85%A5%E7%A1%AC%E7%9B%98%E5%90%8E%EF%BC%8C%E7%A1%AC%E7%9B%98%E5%9D%8F%E4%BA%86%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%E4%B8%8D%E4%B8%A2%E5%A4%B1%EF%BC%9F">消息写入硬盘后，硬盘坏了如何保证不丢失？</a></li>\n<li><a href="/system-design-deep-learn/#%E6%B6%88%E8%B4%B9%E8%80%85%E6%B6%88%E8%B4%B9-mq-%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%E4%B8%8D%E4%B8%A2%E5%A4%B1%EF%BC%9F">消费者消费 MQ 如何保证不丢失？</a></li>\n<li><a href="/system-design-deep-learn/#%E6%95%B4%E4%B8%AA-mq-%E8%8A%82%E7%82%B9%E6%8C%82%E4%BA%86%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%E4%B8%8D%E4%B8%A2%E5%A4%B1%EF%BC%9F">整个 MQ 节点挂了如何保证不丢失？</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p><a href="/system-design-deep-learn/#%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%E6%B6%88%E6%81%AF%E7%9A%84%E9%A1%BA%E5%BA%8F%E6%80%A7%EF%BC%9F">如何保证消息的顺序性？</a></p>\n<ul>\n<li><a href="/system-design-deep-learn/#%E8%83%8C%E6%99%AF-1">背景</a></li>\n<li>\n<p><a href="/system-design-deep-learn/#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-1">解决方案</a></p>\n<ul>\n<li><a href="/system-design-deep-learn/#rabbitmq-1">RabbitMQ</a></li>\n<li><a href="/system-design-deep-learn/#kafka-1">Kafka</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p><a href="/system-design-deep-learn/#%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E7%9A%84%E5%BB%B6%E6%97%B6%E4%BB%A5%E5%8F%8A%E8%BF%87%E6%9C%9F%E5%A4%B1%E6%95%88%E9%97%AE%E9%A2%98%EF%BC%9F">如何解决消息队列的延时以及过期失效问题？</a></p>\n<ul>\n<li><a href="/system-design-deep-learn/#%E5%A4%A7%E9%87%8F%E6%B6%88%E6%81%AF%E5%9C%A8-mq-%E9%87%8C%E7%A7%AF%E5%8E%8B%E4%BA%86%E5%87%A0%E4%B8%AA%E5%B0%8F%E6%97%B6%E4%BA%86%E8%BF%98%E6%B2%A1%E8%A7%A3%E5%86%B3">大量消息在 mq 里积压了几个小时了还没解决</a></li>\n<li><a href="/system-design-deep-learn/#mq-%E4%B8%AD%E7%9A%84%E6%B6%88%E6%81%AF%E8%BF%87%E6%9C%9F%E5%A4%B1%E6%95%88%E4%BA%86">mq 中的消息过期失效了</a></li>\n<li><a href="/system-design-deep-learn/#mq-%E9%83%BD%E5%BF%AB%E5%86%99%E6%BB%A1%E4%BA%86">mq 都快写满了</a></li>\n<li><a href="/system-design-deep-learn/#rocketmq-%E7%9A%84%E5%A4%84%E7%90%86%E6%96%B9%E5%BC%8F">RocketMQ 的处理方式</a></li>\n</ul>\n</li>\n<li><a href="/system-design-deep-learn/#%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1%E4%B8%80%E4%B8%AA%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%EF%BC%9F">如何设计一个消息队列？</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/system-design-deep-learn/#%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E">搜索引擎</a></p>\n<ul>\n<li>\n<p><a href="/system-design-deep-learn/#es-%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F">ES 是什么？</a></p>\n<ul>\n<li><a href="/system-design-deep-learn/#lucene-%E5%92%8C-es-%E7%9A%84%E5%89%8D%E4%B8%96%E4%BB%8A%E7%94%9F">Lucene 和 ES 的前世今生</a></li>\n<li>\n<p><a href="/system-design-deep-learn/#es-%E7%9A%84%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5">ES 的核心概念</a></p>\n<ul>\n<li><a href="/system-design-deep-learn/#near-realtime">Near Realtime</a></li>\n<li><a href="/system-design-deep-learn/#cluster-%E9%9B%86%E7%BE%A4">Cluster 集群</a></li>\n<li><a href="/system-design-deep-learn/#node-%E8%8A%82%E7%82%B9">Node 节点</a></li>\n<li><a href="/system-design-deep-learn/#document--field">Document &#x26; field</a></li>\n<li><a href="/system-design-deep-learn/#index">Index</a></li>\n<li><a href="/system-design-deep-learn/#type">Type</a></li>\n<li><a href="/system-design-deep-learn/#shard">shard</a></li>\n<li><a href="/system-design-deep-learn/#replica">replica</a></li>\n</ul>\n</li>\n<li><a href="/system-design-deep-learn/#es-%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5-vs-db-%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5">ES 核心概念 vs. DB 核心概念</a></li>\n</ul>\n</li>\n<li><a href="/system-design-deep-learn/#es-%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%EF%BC%9F">ES 的分布式架构原理？</a></li>\n<li>\n<p><a href="/system-design-deep-learn/#es-%E5%86%99%E5%85%A5%E6%95%B0%E6%8D%AE%E7%9A%84%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F">ES 写入数据的工作原理是什么？</a></p>\n<ul>\n<li><a href="/system-design-deep-learn/#es-%E5%86%99%E6%95%B0%E6%8D%AE%E8%BF%87%E7%A8%8B">es 写数据过程</a></li>\n<li><a href="/system-design-deep-learn/#es-%E8%AF%BB%E6%95%B0%E6%8D%AE%E8%BF%87%E7%A8%8B">es 读数据过程</a></li>\n<li><a href="/system-design-deep-learn/#es-%E6%90%9C%E7%B4%A2%E6%95%B0%E6%8D%AE%E8%BF%87%E7%A8%8B">es 搜索数据过程</a></li>\n<li><a href="/system-design-deep-learn/#%E5%86%99%E6%95%B0%E6%8D%AE%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86">写数据底层原理</a></li>\n<li><a href="/system-design-deep-learn/#%E5%88%A0%E9%99%A4%E6%9B%B4%E6%96%B0%E6%95%B0%E6%8D%AE%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86">删除/更新数据底层原理</a></li>\n<li><a href="/system-design-deep-learn/#%E5%BA%95%E5%B1%82-lucene">底层 lucene</a></li>\n<li><a href="/system-design-deep-learn/#%E5%80%92%E6%8E%92%E7%B4%A2%E5%BC%95">倒排索引</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/system-design-deep-learn/#es-%E5%9C%A8%E6%95%B0%E6%8D%AE%E9%87%8F%E5%BE%88%E5%A4%A7%E7%9A%84%E6%83%85%E5%86%B5%E4%B8%8B%EF%BC%88%E6%95%B0%E5%8D%81%E4%BA%BF%E7%BA%A7%E5%88%AB%EF%BC%89%E5%A6%82%E4%BD%95%E6%8F%90%E9%AB%98%E6%9F%A5%E8%AF%A2%E6%95%88%E7%8E%87%EF%BC%9F">ES 在数据量很大的情况下（数十亿级别）如何提高查询效率？</a></p>\n<ul>\n<li><a href="/system-design-deep-learn/#%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E7%9A%84%E6%9D%80%E6%89%8B%E9%94%8F-filesystem-cache">性能优化的杀手锏 filesystem cache</a></li>\n<li><a href="/system-design-deep-learn/#%E6%95%B0%E6%8D%AE%E9%A2%84%E7%83%AD">数据预热</a></li>\n<li><a href="/system-design-deep-learn/#%E5%86%B7%E7%83%AD%E5%88%86%E7%A6%BB">冷热分离</a></li>\n<li><a href="/system-design-deep-learn/#document-%E6%A8%A1%E5%9E%8B%E8%AE%BE%E8%AE%A1">document 模型设计</a></li>\n<li>\n<p><a href="/system-design-deep-learn/#%E5%88%86%E9%A1%B5%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96">分页性能优化</a></p>\n<ul>\n<li><a href="/system-design-deep-learn/#%E4%B8%8D%E5%85%81%E8%AE%B8%E6%B7%B1%E5%BA%A6%E5%88%86%E9%A1%B5%EF%BC%88%E9%BB%98%E8%AE%A4%E6%B7%B1%E5%BA%A6%E5%88%86%E9%A1%B5%E6%80%A7%E8%83%BD%E5%BE%88%E5%B7%AE%EF%BC%89">不允许深度分页（默认深度分页性能很差）</a></li>\n<li><a href="/system-design-deep-learn/#%E7%B1%BB%E4%BC%BC%E4%BA%8E-app-%E9%87%8C%E7%9A%84%E6%8E%A8%E8%8D%90%E5%95%86%E5%93%81%E4%B8%8D%E6%96%AD%E4%B8%8B%E6%8B%89%E5%87%BA%E6%9D%A5%E4%B8%80%E9%A1%B5%E4%B8%80%E9%A1%B5%E7%9A%84">类似于 app 里的推荐商品不断下拉出来一页一页的</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li><a href="/system-design-deep-learn/#es-%E7%94%9F%E4%BA%A7%E9%9B%86%E7%BE%A4%E7%9A%84%E9%83%A8%E7%BD%B2%E6%9E%B6%E6%9E%84%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F">ES 生产集群的部署架构是什么？</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/system-design-deep-learn/#%E7%BC%93%E5%AD%98">缓存</a></p>\n<ul>\n<li>\n<p><a href="/system-design-deep-learn/#%E9%A1%B9%E7%9B%AE%E4%B8%AD%E7%BC%93%E5%AD%98%E6%98%AF%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8%E7%9A%84%EF%BC%9F">项目中缓存是如何使用的？</a></p>\n<ul>\n<li>\n<p><a href="/system-design-deep-learn/#%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E7%94%A8%E7%BC%93%E5%AD%98%EF%BC%9F">为什么要用缓存？</a></p>\n<ul>\n<li><a href="/system-design-deep-learn/#%E9%AB%98%E6%80%A7%E8%83%BD">高性能</a></li>\n</ul>\n</li>\n<li><a href="/system-design-deep-learn/#%E9%AB%98%E5%B9%B6%E5%8F%91">高并发</a></li>\n<li><a href="/system-design-deep-learn/#%E7%94%A8%E4%BA%86%E7%BC%93%E5%AD%98%E4%B9%8B%E5%90%8E%E4%BC%9A%E6%9C%89%E4%BB%80%E4%B9%88%E4%B8%8D%E8%89%AF%E5%90%8E%E6%9E%9C%EF%BC%9F">用了缓存之后会有什么不良后果？</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/system-design-deep-learn/#redis-%E5%92%8C-memcached-%E6%9C%89%E4%BB%80%E4%B9%88%E5%8C%BA%E5%88%AB%EF%BC%9F">Redis 和 Memcached 有什么区别？</a></p>\n<ul>\n<li>\n<p><a href="/system-design-deep-learn/#%E5%8C%BA%E5%88%AB">区别</a></p>\n<ul>\n<li><a href="/system-design-deep-learn/#redis-%E6%94%AF%E6%8C%81%E5%A4%8D%E6%9D%82%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84">Redis 支持复杂的数据结构</a></li>\n<li><a href="/system-design-deep-learn/#redis-%E5%8E%9F%E7%94%9F%E6%94%AF%E6%8C%81%E9%9B%86%E7%BE%A4%E6%A8%A1%E5%BC%8F">Redis 原生支持集群模式</a></li>\n</ul>\n</li>\n<li><a href="/system-design-deep-learn/#%E6%80%A7%E8%83%BD%E5%AF%B9%E6%AF%94">性能对比</a></li>\n<li><a href="/system-design-deep-learn/#redis-%E7%9A%84%E7%BA%BF%E7%A8%8B%E6%A8%A1%E5%9E%8B">Redis 的线程模型</a></li>\n<li><a href="/system-design-deep-learn/#%E4%B8%BA%E5%95%A5-redis-%E5%8D%95%E7%BA%BF%E7%A8%8B%E6%A8%A1%E5%9E%8B%E4%B9%9F%E8%83%BD%E6%95%88%E7%8E%87%E8%BF%99%E4%B9%88%E9%AB%98%EF%BC%9F">为啥 Redis 单线程模型也能效率这么高？</a></li>\n<li><a href="/system-design-deep-learn/#redis-60-%E5%BC%80%E5%A7%8B%E5%BC%95%E5%85%A5%E5%A4%9A%E7%BA%BF%E7%A8%8B">Redis 6.0 开始引入多线程</a></li>\n<li><a href="/system-design-deep-learn/#%E6%80%BB%E7%BB%93">总结</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/system-design-deep-learn/#redis-%E9%83%BD%E6%9C%89%E5%93%AA%E4%BA%9B%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E5%8F%8A%E9%80%82%E7%94%A8%E5%9C%BA%E6%99%AF%EF%BC%9F">Redis 都有哪些数据类型及适用场景？</a></p>\n<ul>\n<li><a href="/system-design-deep-learn/#strings">Strings</a></li>\n<li><a href="/system-design-deep-learn/#hashes">Hashes</a></li>\n<li><a href="/system-design-deep-learn/#lists">Lists</a></li>\n<li><a href="/system-design-deep-learn/#sets">Sets</a></li>\n<li><a href="/system-design-deep-learn/#sorted-sets">Sorted Sets</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/system-design-deep-learn/#redis-%E7%9A%84%E8%BF%87%E6%9C%9F%E7%AD%96%E7%95%A5%E9%83%BD%E6%9C%89%E5%93%AA%E4%BA%9B%EF%BC%9F">Redis 的过期策略都有哪些？</a></p>\n<ul>\n<li><a href="/system-design-deep-learn/#redis-%E8%BF%87%E6%9C%9F%E7%AD%96%E7%95%A5">Redis 过期策略</a></li>\n<li><a href="/system-design-deep-learn/#%E5%86%85%E5%AD%98%E6%B7%98%E6%B1%B0%E6%9C%BA%E5%88%B6">内存淘汰机制</a></li>\n<li><a href="/system-design-deep-learn/#%E6%89%8B%E5%86%99%E4%B8%80%E4%B8%AA-lru-%E7%AE%97%E6%B3%95">手写一个 LRU 算法</a></li>\n</ul>\n</li>\n<li><a href="/system-design-deep-learn/#%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81-redis-%E7%9A%84%E9%AB%98%E5%B9%B6%E5%8F%91%E5%92%8C%E9%AB%98%E5%8F%AF%E7%94%A8%EF%BC%9F">如何保证 redis 的高并发和高可用？</a></li>\n<li>\n<p><a href="/system-design-deep-learn/#redis-%E4%B8%BB%E4%BB%8E%E6%9E%B6%E6%9E%84%E6%98%AF%E6%80%8E%E6%A0%B7%E7%9A%84%EF%BC%9F">Redis 主从架构是怎样的？</a></p>\n<ul>\n<li><a href="/system-design-deep-learn/#redis-replication-%E7%9A%84%E6%A0%B8%E5%BF%83%E6%9C%BA%E5%88%B6">Redis replication 的核心机制</a></li>\n<li>\n<p><a href="/system-design-deep-learn/#redis-%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E7%9A%84%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86">Redis 主从复制的核心原理</a></p>\n<ul>\n<li><a href="/system-design-deep-learn/#%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E7%9A%84%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0">主从复制的断点续传</a></li>\n<li><a href="/system-design-deep-learn/#%E6%97%A0%E7%A3%81%E7%9B%98%E5%8C%96%E5%A4%8D%E5%88%B6">无磁盘化复制</a></li>\n<li><a href="/system-design-deep-learn/#%E8%BF%87%E6%9C%9F-key-%E5%A4%84%E7%90%86">过期 key 处理</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/system-design-deep-learn/#%E5%A4%8D%E5%88%B6%E7%9A%84%E5%AE%8C%E6%95%B4%E6%B5%81%E7%A8%8B">复制的完整流程</a></p>\n<ul>\n<li><a href="/system-design-deep-learn/#%E5%85%A8%E9%87%8F%E5%A4%8D%E5%88%B6">全量复制</a></li>\n<li><a href="/system-design-deep-learn/#%E5%A2%9E%E9%87%8F%E5%A4%8D%E5%88%B6">增量复制</a></li>\n<li><a href="/system-design-deep-learn/#heartbeat">heartbeat</a></li>\n<li><a href="/system-design-deep-learn/#%E5%BC%82%E6%AD%A5%E5%A4%8D%E5%88%B6">异步复制</a></li>\n</ul>\n</li>\n<li><a href="/system-design-deep-learn/#redis-%E5%A6%82%E4%BD%95%E6%89%8D%E8%83%BD%E5%81%9A%E5%88%B0%E9%AB%98%E5%8F%AF%E7%94%A8">Redis 如何才能做到高可用</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/system-design-deep-learn/#redis-%E7%9A%84%E6%8C%81%E4%B9%85%E5%8C%96%E6%9C%89%E5%93%AA%E5%87%A0%E7%A7%8D%E6%96%B9%E5%BC%8F%EF%BC%9F">Redis 的持久化有哪几种方式？</a></p>\n<ul>\n<li>\n<p><a href="/system-design-deep-learn/#redis-%E6%8C%81%E4%B9%85%E5%8C%96%E7%9A%84%E4%B8%A4%E7%A7%8D%E6%96%B9%E5%BC%8F">Redis 持久化的两种方式</a></p>\n<ul>\n<li><a href="/system-design-deep-learn/#rdb-%E4%BC%98%E7%BC%BA%E7%82%B9">RDB 优缺点</a></li>\n<li><a href="/system-design-deep-learn/#aof-%E4%BC%98%E7%BC%BA%E7%82%B9">AOF 优缺点</a></li>\n</ul>\n</li>\n<li><a href="/system-design-deep-learn/#rdb-%E5%92%8C-aof-%E5%88%B0%E5%BA%95%E8%AF%A5%E5%A6%82%E4%BD%95%E9%80%89%E6%8B%A9">RDB 和 AOF 到底该如何选择</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/system-design-deep-learn/#redis-%E5%93%A8%E5%85%B5%E9%9B%86%E7%BE%A4%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E9%AB%98%E5%8F%AF%E7%94%A8%EF%BC%9F">Redis 哨兵集群如何实现高可用？</a></p>\n<ul>\n<li><a href="/system-design-deep-learn/#%E5%93%A8%E5%85%B5%E7%9A%84%E4%BB%8B%E7%BB%8D">哨兵的介绍</a></li>\n<li><a href="/system-design-deep-learn/#%E5%93%A8%E5%85%B5%E7%9A%84%E6%A0%B8%E5%BF%83%E7%9F%A5%E8%AF%86">哨兵的核心知识</a></li>\n<li>\n<p><a href="/system-design-deep-learn/#redis-%E5%93%A8%E5%85%B5%E4%B8%BB%E5%A4%87%E5%88%87%E6%8D%A2%E7%9A%84%E6%95%B0%E6%8D%AE%E4%B8%A2%E5%A4%B1%E9%97%AE%E9%A2%98">Redis 哨兵主备切换的数据丢失问题</a></p>\n<ul>\n<li><a href="/system-design-deep-learn/#%E5%AF%BC%E8%87%B4%E6%95%B0%E6%8D%AE%E4%B8%A2%E5%A4%B1%E7%9A%84%E4%B8%A4%E7%A7%8D%E6%83%85%E5%86%B5">导致数据丢失的两种情况</a></li>\n<li><a href="/system-design-deep-learn/#%E6%95%B0%E6%8D%AE%E4%B8%A2%E5%A4%B1%E9%97%AE%E9%A2%98%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88">数据丢失问题的解决方案</a></li>\n</ul>\n</li>\n<li><a href="/system-design-deep-learn/#sdown-%E5%92%8C-odown-%E8%BD%AC%E6%8D%A2%E6%9C%BA%E5%88%B6">sdown 和 odown 转换机制</a></li>\n<li><a href="/system-design-deep-learn/#%E5%93%A8%E5%85%B5%E9%9B%86%E7%BE%A4%E7%9A%84%E8%87%AA%E5%8A%A8%E5%8F%91%E7%8E%B0%E6%9C%BA%E5%88%B6">哨兵集群的自动发现机制</a></li>\n<li><a href="/system-design-deep-learn/#slave-%E9%85%8D%E7%BD%AE%E7%9A%84%E8%87%AA%E5%8A%A8%E7%BA%A0%E6%AD%A3">slave 配置的自动纠正</a></li>\n<li><a href="/system-design-deep-learn/#slave---master-%E9%80%89%E4%B8%BE%E7%AE%97%E6%B3%95">slave -> master 选举算法</a></li>\n<li><a href="/system-design-deep-learn/#quorum-%E5%92%8C-majority">quorum 和 majority</a></li>\n<li><a href="/system-design-deep-learn/#configuration-epoch">configuration epoch</a></li>\n<li><a href="/system-design-deep-learn/#configuration-%E4%BC%A0%E6%92%AD">configuration 传播</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/system-design-deep-learn/#redis-%E9%9B%86%E7%BE%A4%E6%A8%A1%E5%BC%8F%E7%9A%84%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E8%83%BD%E8%AF%B4%E4%B8%80%E4%B8%8B%E4%B9%88%EF%BC%9F">Redis 集群模式的工作原理能说一下么？</a></p>\n<ul>\n<li><a href="/system-design-deep-learn/#redis-cluster-%E4%BB%8B%E7%BB%8D">Redis cluster 介绍</a></li>\n<li>\n<p><a href="/system-design-deep-learn/#%E8%8A%82%E7%82%B9%E9%97%B4%E7%9A%84%E5%86%85%E9%83%A8%E9%80%9A%E4%BF%A1%E6%9C%BA%E5%88%B6">节点间的内部通信机制</a></p>\n<ul>\n<li><a href="/system-design-deep-learn/#%E5%9F%BA%E6%9C%AC%E9%80%9A%E4%BF%A1%E5%8E%9F%E7%90%86">基本通信原理</a></li>\n<li><a href="/system-design-deep-learn/#gossip-%E5%8D%8F%E8%AE%AE">gossip 协议</a></li>\n<li><a href="/system-design-deep-learn/#ping-%E6%B6%88%E6%81%AF%E6%B7%B1%E5%85%A5">ping 消息深入</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/system-design-deep-learn/#%E5%88%86%E5%B8%83%E5%BC%8F%E5%AF%BB%E5%9D%80%E7%AE%97%E6%B3%95">分布式寻址算法</a></p>\n<ul>\n<li><a href="/system-design-deep-learn/#hash-%E7%AE%97%E6%B3%95">hash 算法</a></li>\n<li><a href="/system-design-deep-learn/#%E4%B8%80%E8%87%B4%E6%80%A7-hash-%E7%AE%97%E6%B3%95">一致性 hash 算法</a></li>\n<li><a href="/system-design-deep-learn/#redis-cluster-%E7%9A%84-hash-slot-%E7%AE%97%E6%B3%95">Redis cluster 的 hash slot 算法</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/system-design-deep-learn/#redis-cluster-%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8%E4%B8%8E%E4%B8%BB%E5%A4%87%E5%88%87%E6%8D%A2%E5%8E%9F%E7%90%86">Redis cluster 的高可用与主备切换原理</a></p>\n<ul>\n<li><a href="/system-design-deep-learn/#%E5%88%A4%E6%96%AD%E8%8A%82%E7%82%B9%E5%AE%95%E6%9C%BA">判断节点宕机</a></li>\n<li><a href="/system-design-deep-learn/#%E4%BB%8E%E8%8A%82%E7%82%B9%E8%BF%87%E6%BB%A4">从节点过滤</a></li>\n<li><a href="/system-design-deep-learn/#%E4%BB%8E%E8%8A%82%E7%82%B9%E9%80%89%E4%B8%BE">从节点选举</a></li>\n<li><a href="/system-design-deep-learn/#%E4%B8%8E%E5%93%A8%E5%85%B5%E6%AF%94%E8%BE%83">与哨兵比较</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p><a href="/system-design-deep-learn/#redis-%E7%9A%84%E9%9B%AA%E5%B4%A9%E3%80%81%E7%A9%BF%E9%80%8F%E5%92%8C%E5%87%BB%E7%A9%BF%EF%BC%8C%E5%A6%82%E4%BD%95%E5%BA%94%E5%AF%B9%EF%BC%9F">Redis 的雪崩、穿透和击穿，如何应对？</a></p>\n<ul>\n<li><a href="/system-design-deep-learn/#%E7%BC%93%E5%AD%98%E9%9B%AA%E5%B4%A9cache-avalanche">缓存雪崩(Cache Avalanche)</a></li>\n<li><a href="/system-design-deep-learn/#%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8Fcache-penetration">缓存穿透(Cache Penetration)</a></li>\n<li><a href="/system-design-deep-learn/#%E7%BC%93%E5%AD%98%E5%87%BB%E7%A9%BFhotspot-invalid">缓存击穿(Hotspot Invalid)</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/system-design-deep-learn/#%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%E7%BC%93%E5%AD%98%E4%B8%8E%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E5%8F%8C%E5%86%99%E4%B8%80%E8%87%B4%E6%80%A7%EF%BC%9F">如何保证缓存与数据库的双写一致性？</a></p>\n<ul>\n<li><a href="/system-design-deep-learn/#cache-aside-pattern">Cache Aside Pattern</a></li>\n<li><a href="/system-design-deep-learn/#%E6%9C%80%E5%88%9D%E7%BA%A7%E7%9A%84%E7%BC%93%E5%AD%98%E4%B8%8D%E4%B8%80%E8%87%B4%E9%97%AE%E9%A2%98%E5%8F%8A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88">最初级的缓存不一致问题及解决方案</a></li>\n<li><a href="/system-design-deep-learn/#%E6%AF%94%E8%BE%83%E5%A4%8D%E6%9D%82%E7%9A%84%E6%95%B0%E6%8D%AE%E4%B8%8D%E4%B8%80%E8%87%B4%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90">比较复杂的数据不一致问题分析</a></li>\n</ul>\n</li>\n<li><a href="/system-design-deep-learn/#%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3-redis-%E7%9A%84%E5%B9%B6%E5%8F%91%E7%AB%9E%E4%BA%89%E9%97%AE%E9%A2%98%EF%BC%9F">如何解决 Redis 的并发竞争问题？</a></li>\n<li><a href="/system-design-deep-learn/#%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E4%B8%AD%E7%9A%84-redis-%E6%98%AF%E6%80%8E%E4%B9%88%E9%83%A8%E7%BD%B2%E7%9A%84%EF%BC%9F">生产环境中的 Redis 是怎么部署的？</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/system-design-deep-learn/#%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8">分库分表</a></p>\n<ul>\n<li>\n<p><a href="/system-design-deep-learn/#%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%EF%BC%9F">为什么要分库分表？</a></p>\n<ul>\n<li><a href="/system-design-deep-learn/#%E5%88%86%E8%A1%A8">分表</a></li>\n<li><a href="/system-design-deep-learn/#%E5%88%86%E5%BA%93">分库</a></li>\n<li>\n<p><a href="/system-design-deep-learn/#%E7%94%A8%E8%BF%87%E5%93%AA%E4%BA%9B%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E4%B8%AD%E9%97%B4%E4%BB%B6%EF%BC%9F%E4%B8%8D%E5%90%8C%E7%9A%84%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E4%B8%AD%E9%97%B4%E4%BB%B6%E9%83%BD%E6%9C%89%E4%BB%80%E4%B9%88%E4%BC%98%E7%82%B9%E5%92%8C%E7%BC%BA%E7%82%B9%EF%BC%9F">用过哪些分库分表中间件？不同的分库分表中间件都有什么优点和缺点？</a></p>\n<ul>\n<li><a href="/system-design-deep-learn/#cobar">Cobar</a></li>\n<li><a href="/system-design-deep-learn/#tddl">TDDL</a></li>\n<li><a href="/system-design-deep-learn/#atlas">Atlas</a></li>\n<li><a href="/system-design-deep-learn/#sharding-jdbc">Sharding-jdbc</a></li>\n<li><a href="/system-design-deep-learn/#mycat">Mycat</a></li>\n<li><a href="/system-design-deep-learn/#%E6%80%BB%E7%BB%93-1">总结</a></li>\n</ul>\n</li>\n<li><a href="/system-design-deep-learn/#%E4%BD%A0%E4%BB%AC%E5%85%B7%E4%BD%93%E6%98%AF%E5%A6%82%E4%BD%95%E5%AF%B9%E6%95%B0%E6%8D%AE%E5%BA%93%E5%A6%82%E4%BD%95%E8%BF%9B%E8%A1%8C%E5%9E%82%E7%9B%B4%E6%8B%86%E5%88%86%E6%88%96%E6%B0%B4%E5%B9%B3%E6%8B%86%E5%88%86%E7%9A%84%EF%BC%9F">你们具体是如何对数据库如何进行垂直拆分或水平拆分的？</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/system-design-deep-learn/#%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E5%A6%82%E4%BD%95%E5%B9%B3%E6%BB%91%E8%BF%87%E6%B8%A1%EF%BC%9F">分库分表如何平滑过渡？</a></p>\n<ul>\n<li><a href="/system-design-deep-learn/#%E5%81%9C%E6%9C%BA%E8%BF%81%E7%A7%BB%E6%96%B9%E6%A1%88">停机迁移方案</a></li>\n<li><a href="/system-design-deep-learn/#%E5%8F%8C%E5%86%99%E8%BF%81%E7%A7%BB%E6%96%B9%E6%A1%88">双写迁移方案</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/system-design-deep-learn/#%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1%E5%8F%AF%E4%BB%A5%E5%8A%A8%E6%80%81%E6%89%A9%E5%AE%B9%E7%BC%A9%E5%AE%B9%E7%9A%84%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E6%96%B9%E6%A1%88%EF%BC%9F">如何设计可以动态扩容缩容的分库分表方案？</a></p>\n<ul>\n<li><a href="/system-design-deep-learn/#%E5%81%9C%E6%9C%BA%E6%89%A9%E5%AE%B9%EF%BC%88%E4%B8%8D%E6%8E%A8%E8%8D%90%EF%BC%89">停机扩容（不推荐）</a></li>\n<li><a href="/system-design-deep-learn/#%E4%BC%98%E5%8C%96%E5%90%8E%E7%9A%84%E6%96%B9%E6%A1%88">优化后的方案</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/system-design-deep-learn/#%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E4%B9%8B%E5%90%8E%EF%BC%8Cid-%E4%B8%BB%E9%94%AE%E5%A6%82%E4%BD%95%E5%A4%84%E7%90%86%EF%BC%9F">分库分表之后，id 主键如何处理？</a></p>\n<ul>\n<li>\n<p><a href="/system-design-deep-learn/#%E5%9F%BA%E4%BA%8E%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%A1%88">基于数据库的实现方案</a></p>\n<ul>\n<li><a href="/system-design-deep-learn/#%E6%95%B0%E6%8D%AE%E5%BA%93%E8%87%AA%E5%A2%9E-id">数据库自增 id</a></li>\n<li><a href="/system-design-deep-learn/#%E8%AE%BE%E7%BD%AE%E6%95%B0%E6%8D%AE%E5%BA%93-sequence-%E6%88%96%E8%80%85%E8%A1%A8%E8%87%AA%E5%A2%9E%E5%AD%97%E6%AE%B5%E6%AD%A5%E9%95%BF">设置数据库 sequence 或者表自增字段步长</a></li>\n</ul>\n</li>\n<li><a href="/system-design-deep-learn/#uuid">UUID</a></li>\n<li><a href="/system-design-deep-learn/#%E8%8E%B7%E5%8F%96%E7%B3%BB%E7%BB%9F%E5%BD%93%E5%89%8D%E6%97%B6%E9%97%B4">获取系统当前时间</a></li>\n<li><a href="/system-design-deep-learn/#snowflake-%E7%AE%97%E6%B3%95">snowflake 算法</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/system-design-deep-learn/#%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB">读写分离</a></p>\n<ul>\n<li><a href="/system-design-deep-learn/#%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0-mysql-%E7%9A%84%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB%EF%BC%9F">如何实现 MySQL 的读写分离？</a></li>\n<li><a href="/system-design-deep-learn/#mysql-%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E5%8E%9F%E7%90%86%E7%9A%84%E6%98%AF%E5%95%A5%EF%BC%9F">MySQL 主从复制原理的是啥？</a></li>\n<li><a href="/system-design-deep-learn/#mysql-%E4%B8%BB%E4%BB%8E%E5%90%8C%E6%AD%A5%E5%BB%B6%E6%97%B6%E9%97%AE%E9%A2%98%EF%BC%88%E7%B2%BE%E5%8D%8E%EF%BC%89">MySQL 主从同步延时问题（精华）</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p><a href="/system-design-deep-learn/#%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F">高并发系统</a></p>\n<ul>\n<li>\n<p><a href="/system-design-deep-learn/#%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1%E4%B8%80%E4%B8%AA%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%EF%BC%9F">如何设计一个高并发系统？</a></p>\n<ul>\n<li><a href="/system-design-deep-learn/#%E7%B3%BB%E7%BB%9F%E6%8B%86%E5%88%86">系统拆分</a></li>\n<li><a href="/system-design-deep-learn/#%E7%BC%93%E5%AD%98-1">缓存</a></li>\n<li><a href="/system-design-deep-learn/#mq">MQ</a></li>\n<li><a href="/system-design-deep-learn/#%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8-1">分库分表</a></li>\n<li><a href="/system-design-deep-learn/#%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB-1">读写分离</a></li>\n<li><a href="/system-design-deep-learn/#elasticsearch">ElasticSearch</a></li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p><a href="/system-design-deep-learn/#%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F">分布式系统</a></p>\n<ul>\n<li>\n<p><a href="/system-design-deep-learn/#%E7%B3%BB%E7%BB%9F%E6%8B%86%E5%88%86-1">系统拆分</a></p>\n<ul>\n<li>\n<p><a href="/system-design-deep-learn/#%E4%B8%BA%E4%BB%80%E4%B9%88%E7%B3%BB%E7%BB%9F%E8%A6%81%E6%8B%86%E5%88%86%EF%BC%9F">为什么系统要拆分？</a></p>\n<ul>\n<li><a href="/system-design-deep-learn/#%E5%A6%82%E4%BD%95%E8%BF%9B%E8%A1%8C%E7%B3%BB%E7%BB%9F%E6%8B%86%E5%88%86%EF%BC%9F">如何进行系统拆分？</a></li>\n<li><a href="/system-design-deep-learn/#%E6%8B%86%E5%88%86%E5%90%8E%E4%B8%8D%E7%94%A8-dubbo-%E5%8F%AF%E4%BB%A5%E5%90%97%EF%BC%9F">拆分后不用 dubbo 可以吗？</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p><a href="/system-design-deep-learn/#%E5%88%86%E5%B8%83%E5%BC%8F%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6">分布式服务框架</a></p>\n<ul>\n<li>\n<p><a href="/system-design-deep-learn/#%E8%AF%B4%E4%B8%80%E4%B8%8B-dubbo-%E7%9A%84%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%EF%BC%9F">说一下 Dubbo 的工作原理？</a></p>\n<ul>\n<li><a href="/system-design-deep-learn/#dubbo-%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86">dubbo 工作原理</a></li>\n<li><a href="/system-design-deep-learn/#%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B">工作流程</a></li>\n<li><a href="/system-design-deep-learn/#%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E6%8C%82%E4%BA%86%E5%8F%AF%E4%BB%A5%E7%BB%A7%E7%BB%AD%E9%80%9A%E4%BF%A1%E5%90%97%EF%BC%9F">注册中心挂了可以继续通信吗？</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/system-design-deep-learn/#dubbo-%E6%94%AF%E6%8C%81%E5%93%AA%E4%BA%9B%E5%BA%8F%E5%88%97%E5%8C%96%E5%8D%8F%E8%AE%AE%EF%BC%9F">Dubbo 支持哪些序列化协议？</a></p>\n<ul>\n<li><a href="/system-design-deep-learn/#dubbo-%E6%94%AF%E6%8C%81%E4%B8%8D%E5%90%8C%E7%9A%84%E9%80%9A%E4%BF%A1%E5%8D%8F%E8%AE%AE">dubbo 支持不同的通信协议</a></li>\n<li><a href="/system-design-deep-learn/#dubbo-%E6%94%AF%E6%8C%81%E7%9A%84%E5%BA%8F%E5%88%97%E5%8C%96%E5%8D%8F%E8%AE%AE">dubbo 支持的序列化协议</a></li>\n<li><a href="/system-design-deep-learn/#%E8%AF%B4%E4%B8%80%E4%B8%8B-hessian-%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84">说一下 Hessian 的数据结构</a></li>\n<li><a href="/system-design-deep-learn/#%E4%B8%BA%E4%BB%80%E4%B9%88-pb-%E7%9A%84%E6%95%88%E7%8E%87%E6%98%AF%E6%9C%80%E9%AB%98%E7%9A%84%EF%BC%9F">为什么 PB 的效率是最高的？</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/system-design-deep-learn/#dubbo-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AD%96%E7%95%A5%E5%92%8C%E9%9B%86%E7%BE%A4%E5%AE%B9%E9%94%99%E7%AD%96%E7%95%A5%EF%BC%9F">Dubbo 负载均衡策略和集群容错策略？</a></p>\n<ul>\n<li>\n<p><a href="/system-design-deep-learn/#dubbo-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AD%96%E7%95%A5">dubbo 负载均衡策略</a></p>\n<ul>\n<li><a href="/system-design-deep-learn/#randomloadbalance">RandomLoadBalance</a></li>\n<li><a href="/system-design-deep-learn/#roundrobinloadbalance">RoundRobinLoadBalance</a></li>\n<li><a href="/system-design-deep-learn/#leastactiveloadbalance">LeastActiveLoadBalance</a></li>\n<li><a href="/system-design-deep-learn/#consistenthashloadbalance">ConsistentHashLoadBalance</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/system-design-deep-learn/#dubbo-%E9%9B%86%E7%BE%A4%E5%AE%B9%E9%94%99%E7%AD%96%E7%95%A5">dubbo 集群容错策略</a></p>\n<ul>\n<li><a href="/system-design-deep-learn/#failover-cluster-%E6%A8%A1%E5%BC%8F">Failover Cluster 模式</a></li>\n<li><a href="/system-design-deep-learn/#failfast-cluster-%E6%A8%A1%E5%BC%8F">Failfast Cluster 模式</a></li>\n<li><a href="/system-design-deep-learn/#failsafe-cluster-%E6%A8%A1%E5%BC%8F">Failsafe Cluster 模式</a></li>\n<li><a href="/system-design-deep-learn/#failback-cluster-%E6%A8%A1%E5%BC%8F">Failback Cluster 模式</a></li>\n<li><a href="/system-design-deep-learn/#forking-cluster-%E6%A8%A1%E5%BC%8F">Forking Cluster 模式</a></li>\n<li><a href="/system-design-deep-learn/#broadcast-cluster-%E6%A8%A1%E5%BC%8F">Broadcast Cluster 模式</a></li>\n</ul>\n</li>\n<li><a href="/system-design-deep-learn/#dubbo-%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E7%AD%96%E7%95%A5">dubbo 动态代理策略</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/system-design-deep-learn/#dubbo-%E7%9A%84-spi-%E6%80%9D%E6%83%B3%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F">Dubbo 的 SPI 思想是什么？</a></p>\n<ul>\n<li><a href="/system-design-deep-learn/#spi-%E6%98%AF%E5%95%A5%EF%BC%9F">spi 是啥？</a></li>\n<li><a href="/system-design-deep-learn/#java-spi-%E6%80%9D%E6%83%B3%E7%9A%84%E4%BD%93%E7%8E%B0">Java spi 思想的体现</a></li>\n<li><a href="/system-design-deep-learn/#dubbo-%E7%9A%84-spi-%E6%80%9D%E6%83%B3">dubbo 的 spi 思想</a></li>\n<li><a href="/system-design-deep-learn/#%E5%A6%82%E4%BD%95%E8%87%AA%E5%B7%B1%E6%89%A9%E5%B1%95-dubbo-%E4%B8%AD%E7%9A%84%E7%BB%84%E4%BB%B6">如何自己扩展 dubbo 中的组件</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/system-design-deep-learn/#%E5%A6%82%E4%BD%95%E5%9F%BA%E4%BA%8E-dubbo-%E8%BF%9B%E8%A1%8C%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86%EF%BC%9F">如何基于 Dubbo 进行服务治理？</a></p>\n<ul>\n<li>\n<p><a href="/system-design-deep-learn/#%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86">服务治理</a></p>\n<ul>\n<li><a href="/system-design-deep-learn/#%E8%B0%83%E7%94%A8%E9%93%BE%E8%B7%AF%E8%87%AA%E5%8A%A8%E7%94%9F%E6%88%90">调用链路自动生成</a></li>\n<li><a href="/system-design-deep-learn/#%E6%9C%8D%E5%8A%A1%E8%AE%BF%E9%97%AE%E5%8E%8B%E5%8A%9B%E4%BB%A5%E5%8F%8A%E6%97%B6%E9%95%BF%E7%BB%9F%E8%AE%A1">服务访问压力以及时长统计</a></li>\n<li><a href="/system-design-deep-learn/#%E5%85%B6%E5%AE%83">其它</a></li>\n</ul>\n</li>\n<li><a href="/system-design-deep-learn/#%E6%9C%8D%E5%8A%A1%E9%99%8D%E7%BA%A7">服务降级</a></li>\n<li><a href="/system-design-deep-learn/#%E5%A4%B1%E8%B4%A5%E9%87%8D%E8%AF%95%E5%92%8C%E8%B6%85%E6%97%B6%E9%87%8D%E8%AF%95">失败重试和超时重试</a></li>\n</ul>\n</li>\n<li><a href="/system-design-deep-learn/#%E5%88%86%E5%B8%83%E5%BC%8F%E6%9C%8D%E5%8A%A1%E6%8E%A5%E5%8F%A3%E7%9A%84%E5%B9%82%E7%AD%89%E6%80%A7%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1%EF%BC%9F">分布式服务接口的幂等性如何设计？</a></li>\n<li><a href="/system-design-deep-learn/#%E5%88%86%E5%B8%83%E5%BC%8F%E6%9C%8D%E5%8A%A1%E6%8E%A5%E5%8F%A3%E8%AF%B7%E6%B1%82%E7%9A%84%E9%A1%BA%E5%BA%8F%E6%80%A7%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%EF%BC%9F">分布式服务接口请求的顺序性如何保证？</a></li>\n<li><a href="/system-design-deep-learn/#%E5%A6%82%E4%BD%95%E8%87%AA%E5%B7%B1%E8%AE%BE%E8%AE%A1%E4%B8%80%E4%B8%AA%E7%B1%BB%E4%BC%BC-dubbo-%E7%9A%84-rpc-%E6%A1%86%E6%9E%B6%EF%BC%9F">如何自己设计一个类似 Dubbo 的 RPC 框架？</a></li>\n<li>\n<p><a href="/system-design-deep-learn/#cap-%E5%AE%9A%E7%90%86%E7%9A%84-p-%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F">CAP 定理的 P 是什么？</a></p>\n<ul>\n<li><a href="/system-design-deep-learn/#%E4%BB%80%E4%B9%88%E6%98%AF-cap-%E5%AE%9A%E7%90%86%EF%BC%88cap-theorem%EF%BC%89">什么是 CAP 定理（CAP theorem）</a></li>\n<li><a href="/system-design-deep-learn/#%E5%88%86%E5%8C%BA%E5%AE%B9%E9%94%99%E6%80%A7%EF%BC%88partition-tolerance%EF%BC%89">分区容错性（Partition tolerance）</a></li>\n<li>\n<p><a href="/system-design-deep-learn/#%E5%B8%B8%E7%94%A8%E7%9A%84-cap-%E6%A1%86%E6%9E%B6%E5%AF%B9%E6%AF%94">常用的 CAP 框架对比</a></p>\n<ul>\n<li><a href="/system-design-deep-learn/#eureka">Eureka</a></li>\n<li><a href="/system-design-deep-learn/#zookeeper">Zookeeper</a></li>\n<li><a href="/system-design-deep-learn/#consul">Consul</a></li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p><a href="/system-design-deep-learn/#%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81">分布式锁</a></p>\n<ul>\n<li>\n<p><a href="/system-design-deep-learn/#zookeeper-%E9%83%BD%E6%9C%89%E5%93%AA%E4%BA%9B%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF%EF%BC%9F">Zookeeper 都有哪些应用场景？</a></p>\n<ul>\n<li><a href="/system-design-deep-learn/#%E5%88%86%E5%B8%83%E5%BC%8F%E5%8D%8F%E8%B0%83">分布式协调</a></li>\n<li><a href="/system-design-deep-learn/#%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81-1">分布式锁</a></li>\n<li><a href="/system-design-deep-learn/#%E5%85%83%E6%95%B0%E6%8D%AE%E9%85%8D%E7%BD%AE%E4%BF%A1%E6%81%AF%E7%AE%A1%E7%90%86">元数据/配置信息管理</a></li>\n<li><a href="/system-design-deep-learn/#ha-%E9%AB%98%E5%8F%AF%E7%94%A8%E6%80%A7">HA 高可用性</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/system-design-deep-learn/#%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1%EF%BC%9F">分布式锁如何设计？</a></p>\n<ul>\n<li>\n<p><a href="/system-design-deep-learn/#redis-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81">Redis 分布式锁</a></p>\n<ul>\n<li><a href="/system-design-deep-learn/#redis-%E6%9C%80%E6%99%AE%E9%80%9A%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81">Redis 最普通的分布式锁</a></li>\n<li><a href="/system-design-deep-learn/#redlock-%E7%AE%97%E6%B3%95">RedLock 算法</a></li>\n</ul>\n</li>\n<li><a href="/system-design-deep-learn/#zk-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81">zk 分布式锁</a></li>\n<li><a href="/system-design-deep-learn/#redis-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E5%92%8C-zk-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E7%9A%84%E5%AF%B9%E6%AF%94">redis 分布式锁和 zk 分布式锁的对比</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p><a href="/system-design-deep-learn/#%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1">分布式事务</a></p>\n<ul>\n<li>\n<p><a href="/system-design-deep-learn/#%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E4%BA%86%E8%A7%A3%E5%90%97%EF%BC%9F">分布式事务了解吗？</a></p>\n<ul>\n<li><a href="/system-design-deep-learn/#%E4%B8%A4%E9%98%B6%E6%AE%B5%E6%8F%90%E4%BA%A4%E6%96%B9%E6%A1%88xa-%E6%96%B9%E6%A1%88">两阶段提交方案/XA 方案</a></li>\n<li><a href="/system-design-deep-learn/#tcc-%E6%96%B9%E6%A1%88">TCC 方案</a></li>\n<li>\n<p><a href="/system-design-deep-learn/#saga-%E6%96%B9%E6%A1%88">Saga 方案</a></p>\n<ul>\n<li><a href="/system-design-deep-learn/#%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86">基本原理</a></li>\n<li><a href="/system-design-deep-learn/#%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF">使用场景</a></li>\n<li><a href="/system-design-deep-learn/#%E4%BC%98%E7%82%B9-1">优点</a></li>\n<li><a href="/system-design-deep-learn/#%E7%BC%BA%E7%82%B9-1">缺点</a></li>\n</ul>\n</li>\n<li><a href="/system-design-deep-learn/#%E6%9C%AC%E5%9C%B0%E6%B6%88%E6%81%AF%E8%A1%A8">本地消息表</a></li>\n<li><a href="/system-design-deep-learn/#%E5%8F%AF%E9%9D%A0%E6%B6%88%E6%81%AF%E6%9C%80%E7%BB%88%E4%B8%80%E8%87%B4%E6%80%A7%E6%96%B9%E6%A1%88">可靠消息最终一致性方案</a></li>\n<li><a href="/system-design-deep-learn/#%E6%9C%80%E5%A4%A7%E5%8A%AA%E5%8A%9B%E9%80%9A%E7%9F%A5%E6%96%B9%E6%A1%88">最大努力通知方案</a></li>\n<li><a href="/system-design-deep-learn/#%E4%BD%A0%E4%BB%AC%E5%85%AC%E5%8F%B8%E6%98%AF%E5%A6%82%E4%BD%95%E5%A4%84%E7%90%86%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E7%9A%84%EF%BC%9F">你们公司是如何处理分布式事务的？</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p><a href="/system-design-deep-learn/#%E5%88%86%E5%B8%83%E5%BC%8F%E4%BC%9A%E8%AF%9D">分布式会话</a></p>\n<ul>\n<li>\n<p><a href="/system-design-deep-learn/#%E9%9B%86%E7%BE%A4%E5%88%86%E5%B8%83%E5%BC%8F-session-%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%EF%BC%9F">集群分布式 Session 如何实现？</a></p>\n<ul>\n<li><a href="/system-design-deep-learn/#%E5%AE%8C%E5%85%A8%E4%B8%8D%E7%94%A8-session">完全不用 Session</a></li>\n<li><a href="/system-design-deep-learn/#tomcat--redis">Tomcat + Redis</a></li>\n<li><a href="/system-design-deep-learn/#spring-session--redis">Spring Session + Redis</a></li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p><a href="/system-design-deep-learn/#%E9%AB%98%E5%8F%AF%E7%94%A8%E6%9E%B6%E6%9E%84">高可用架构</a></p>\n<ul>\n<li>\n<p><a href="/system-design-deep-learn/#%E5%9F%BA%E4%BA%8E-hystrix-%E5%AE%9E%E7%8E%B0%E9%AB%98%E5%8F%AF%E7%94%A8">基于 Hystrix 实现高可用</a></p>\n<ul>\n<li>\n<p><a href="/system-design-deep-learn/#hystrix-%E4%BB%8B%E7%BB%8D">Hystrix 介绍</a></p>\n<ul>\n<li><a href="/system-design-deep-learn/#hystrix-%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F">Hystrix 是什么？</a></li>\n<li><a href="/system-design-deep-learn/#hystrix-%E7%9A%84%E5%8E%86%E5%8F%B2">Hystrix 的历史</a></li>\n<li><a href="/system-design-deep-learn/#hystrix-%E7%9A%84%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99">Hystrix 的设计原则</a></li>\n<li><a href="/system-design-deep-learn/#hystrix-%E6%9B%B4%E5%8A%A0%E7%BB%86%E8%8A%82%E7%9A%84%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99">Hystrix 更加细节的设计原则</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/system-design-deep-learn/#%E7%94%B5%E5%95%86%E7%BD%91%E7%AB%99%E8%AF%A6%E6%83%85%E9%A1%B5%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84">电商网站详情页系统架构</a></p>\n<ul>\n<li><a href="/system-design-deep-learn/#%E5%B0%8F%E5%9E%8B%E7%94%B5%E5%95%86%E7%BD%91%E7%AB%99%E7%9A%84%E5%95%86%E5%93%81%E8%AF%A6%E6%83%85%E9%A1%B5%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84">小型电商网站的商品详情页系统架构</a></li>\n<li><a href="/system-design-deep-learn/#%E5%A4%A7%E5%9E%8B%E7%94%B5%E5%95%86%E7%BD%91%E7%AB%99%E7%9A%84%E5%95%86%E5%93%81%E8%AF%A6%E6%83%85%E9%A1%B5%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84">大型电商网站的商品详情页系统架构</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/system-design-deep-learn/#%E5%9F%BA%E4%BA%8E-hystrix-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E6%8A%80%E6%9C%AF%E5%AE%9E%E7%8E%B0%E8%B5%84%E6%BA%90%E9%9A%94%E7%A6%BB">基于 Hystrix 线程池技术实现资源隔离</a></p>\n<ul>\n<li><a href="/system-design-deep-learn/#%E5%88%A9%E7%94%A8-hystrixcommand-%E8%8E%B7%E5%8F%96%E5%8D%95%E6%9D%A1%E6%95%B0%E6%8D%AE">利用 HystrixCommand 获取单条数据</a></li>\n<li><a href="/system-design-deep-learn/#%E5%88%A9%E7%94%A8-hystrixobservablecommand-%E6%89%B9%E9%87%8F%E8%8E%B7%E5%8F%96%E6%95%B0%E6%8D%AE">利用 HystrixObservableCommand 批量获取数据</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/system-design-deep-learn/#%E5%9F%BA%E4%BA%8E-hystrix-%E4%BF%A1%E5%8F%B7%E9%87%8F%E6%9C%BA%E5%88%B6%E5%AE%9E%E7%8E%B0%E8%B5%84%E6%BA%90%E9%9A%94%E7%A6%BB">基于 Hystrix 信号量机制实现资源隔离</a></p>\n<ul>\n<li><a href="/system-design-deep-learn/#%E4%BF%A1%E5%8F%B7%E9%87%8F%E6%9C%BA%E5%88%B6">信号量机制</a></li>\n<li><a href="/system-design-deep-learn/#%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%B8%8E%E4%BF%A1%E5%8F%B7%E9%87%8F%E5%8C%BA%E5%88%AB">线程池与信号量区别</a></li>\n<li><a href="/system-design-deep-learn/#%E4%BF%A1%E5%8F%B7%E9%87%8F%E7%AE%80%E5%8D%95-demo">信号量简单 Demo</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/system-design-deep-learn/#hystrix-%E9%9A%94%E7%A6%BB%E7%AD%96%E7%95%A5%E7%BB%86%E7%B2%92%E5%BA%A6%E6%8E%A7%E5%88%B6">Hystrix 隔离策略细粒度控制</a></p>\n<ul>\n<li><a href="/system-design-deep-learn/#executionisolationstrategy">execution.isolation.strategy</a></li>\n<li><a href="/system-design-deep-learn/#command-key--command-group">command key &#x26; command group</a></li>\n<li><a href="/system-design-deep-learn/#command-thread-pool">command thread pool</a></li>\n<li><a href="/system-design-deep-learn/#command-key--command-group--command-thread-pool">command key &#x26; command group &#x26; command thread pool</a></li>\n<li><a href="/system-design-deep-learn/#coresize">coreSize</a></li>\n<li><a href="/system-design-deep-learn/#queuesizerejectionthreshold">queueSizeRejectionThreshold</a></li>\n<li><a href="/system-design-deep-learn/#executionisolationsemaphoremaxconcurrentrequests">execution.isolation.semaphore.maxConcurrentRequests</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/system-design-deep-learn/#%E6%B7%B1%E5%85%A5-hystrix-%E6%89%A7%E8%A1%8C%E6%97%B6%E5%86%85%E9%83%A8%E5%8E%9F%E7%90%86">深入 Hystrix 执行时内部原理</a></p>\n<ul>\n<li><a href="/system-design-deep-learn/#%E6%AD%A5%E9%AA%A4%E4%B8%80%EF%BC%9A%E5%88%9B%E5%BB%BA-command">步骤一：创建 command</a></li>\n<li><a href="/system-design-deep-learn/#%E6%AD%A5%E9%AA%A4%E4%BA%8C%EF%BC%9A%E8%B0%83%E7%94%A8-command-%E6%89%A7%E8%A1%8C%E6%96%B9%E6%B3%95">步骤二：调用 command 执行方法</a></li>\n<li><a href="/system-design-deep-learn/#%E6%AD%A5%E9%AA%A4%E4%B8%89%EF%BC%9A%E6%A3%80%E6%9F%A5%E6%98%AF%E5%90%A6%E5%BC%80%E5%90%AF%E7%BC%93%E5%AD%98%EF%BC%88%E4%B8%8D%E5%A4%AA%E5%B8%B8%E7%94%A8%EF%BC%89">步骤三：检查是否开启缓存（不太常用）</a></li>\n<li><a href="/system-design-deep-learn/#%E6%AD%A5%E9%AA%A4%E5%9B%9B%EF%BC%9A%E6%A3%80%E6%9F%A5%E6%98%AF%E5%90%A6%E5%BC%80%E5%90%AF%E4%BA%86%E6%96%AD%E8%B7%AF%E5%99%A8">步骤四：检查是否开启了断路器</a></li>\n<li><a href="/system-design-deep-learn/#%E6%AD%A5%E9%AA%A4%E4%BA%94%EF%BC%9A%E6%A3%80%E6%9F%A5%E7%BA%BF%E7%A8%8B%E6%B1%A0%E9%98%9F%E5%88%97%E4%BF%A1%E5%8F%B7%E9%87%8F%E6%98%AF%E5%90%A6%E5%B7%B2%E6%BB%A1">步骤五：检查线程池/队列/信号量是否已满</a></li>\n<li><a href="/system-design-deep-learn/#%E6%AD%A5%E9%AA%A4%E5%85%AD%EF%BC%9A%E6%89%A7%E8%A1%8C-command">步骤六：执行 command</a></li>\n<li><a href="/system-design-deep-learn/#%E6%AD%A5%E9%AA%A4%E4%B8%83%EF%BC%9A%E6%96%AD%E8%B7%AF%E5%81%A5%E5%BA%B7%E6%A3%80%E6%9F%A5">步骤七：断路健康检查</a></li>\n<li><a href="/system-design-deep-learn/#%E6%AD%A5%E9%AA%A4%E5%85%AB%EF%BC%9A%E8%B0%83%E7%94%A8-fallback-%E9%99%8D%E7%BA%A7%E6%9C%BA%E5%88%B6">步骤八：调用 fallback 降级机制</a></li>\n<li><a href="/system-design-deep-learn/#%E4%B8%8D%E5%90%8C%E7%9A%84%E6%89%A7%E8%A1%8C%E6%96%B9%E5%BC%8F">不同的执行方式</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/system-design-deep-learn/#%E5%9F%BA%E4%BA%8E-request-cache-%E8%AF%B7%E6%B1%82%E7%BC%93%E5%AD%98%E6%8A%80%E6%9C%AF%E4%BC%98%E5%8C%96%E6%89%B9%E9%87%8F%E5%95%86%E5%93%81%E6%95%B0%E6%8D%AE%E6%9F%A5%E8%AF%A2%E6%8E%A5%E5%8F%A3">基于 request cache 请求缓存技术优化批量商品数据查询接口</a></p>\n<ul>\n<li><a href="/system-design-deep-learn/#%E5%AE%9E%E7%8E%B0-hystrix-%E8%AF%B7%E6%B1%82%E4%B8%8A%E4%B8%8B%E6%96%87%E8%BF%87%E6%BB%A4%E5%99%A8%E5%B9%B6%E6%B3%A8%E5%86%8C">实现 Hystrix 请求上下文过滤器并注册</a></li>\n<li><a href="/system-design-deep-learn/#command-%E9%87%8D%E5%86%99-getcachekey-%E6%96%B9%E6%B3%95">command 重写 getCacheKey() 方法</a></li>\n<li><a href="/system-design-deep-learn/#controller-%E8%B0%83%E7%94%A8-command-%E6%9F%A5%E8%AF%A2%E5%95%86%E5%93%81%E4%BF%A1%E6%81%AF">controller 调用 command 查询商品信息</a></li>\n<li><a href="/system-design-deep-learn/#%E5%8F%91%E8%B5%B7%E8%AF%B7%E6%B1%82">发起请求</a></li>\n<li><a href="/system-design-deep-learn/#%E5%88%A0%E9%99%A4%E7%BC%93%E5%AD%98">删除缓存</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/system-design-deep-learn/#%E5%9F%BA%E4%BA%8E%E6%9C%AC%E5%9C%B0%E7%BC%93%E5%AD%98%E7%9A%84-fallback-%E9%99%8D%E7%BA%A7%E6%9C%BA%E5%88%B6">基于本地缓存的 fallback 降级机制</a></p>\n<ul>\n<li><a href="/system-design-deep-learn/#%E4%B8%A4%E7%A7%8D%E6%9C%80%E7%BB%8F%E5%85%B8%E7%9A%84%E9%99%8D%E7%BA%A7%E6%9C%BA%E5%88%B6">两种最经典的降级机制</a></li>\n<li><a href="/system-design-deep-learn/#%E6%AD%A5%E9%AA%A4%E4%B8%80%EF%BC%9A%E6%9C%AC%E5%9C%B0%E7%BC%93%E5%AD%98%E8%8E%B7%E5%8F%96%E6%95%B0%E6%8D%AE">步骤一：本地缓存获取数据</a></li>\n<li><a href="/system-design-deep-learn/#%E6%AD%A5%E9%AA%A4%E4%BA%8C%EF%BC%9A%E5%AE%9E%E7%8E%B0-getbrandnamecommand">步骤二：实现 GetBrandNameCommand</a></li>\n<li><a href="/system-design-deep-learn/#%E6%AD%A5%E9%AA%A4%E4%B8%89%EF%BC%9Acachecontroller-%E8%B0%83%E7%94%A8%E6%8E%A5%E5%8F%A3">步骤三：CacheController 调用接口</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/system-design-deep-learn/#%E6%B7%B1%E5%85%A5-hystrix-%E6%96%AD%E8%B7%AF%E5%99%A8%E6%89%A7%E8%A1%8C%E5%8E%9F%E7%90%86">深入 Hystrix 断路器执行原理</a></p>\n<ul>\n<li>\n<p><a href="/system-design-deep-learn/#%E7%8A%B6%E6%80%81%E6%9C%BA">状态机</a></p>\n<ul>\n<li><a href="/system-design-deep-learn/#enabled">Enabled</a></li>\n<li><a href="/system-design-deep-learn/#circuitbreakerrequestvolumethreshold">circuitBreaker.requestVolumeThreshold</a></li>\n<li><a href="/system-design-deep-learn/#circuitbreakererrorthresholdpercentage">circuitBreaker.errorThresholdPercentage</a></li>\n<li><a href="/system-design-deep-learn/#circuitbreakersleepwindowinmilliseconds">circuitBreaker.sleepWindowInMilliseconds</a></li>\n<li><a href="/system-design-deep-learn/#forceopen">ForceOpen</a></li>\n<li><a href="/system-design-deep-learn/#forceclosed">ForceClosed</a></li>\n</ul>\n</li>\n<li><a href="/system-design-deep-learn/#metrics-%E7%BB%9F%E8%AE%A1%E5%99%A8">Metrics 统计器</a></li>\n<li>\n<p><a href="/system-design-deep-learn/#%E5%AE%9E%E4%BE%8B-demo">实例 Demo</a></p>\n<ul>\n<li><a href="/system-design-deep-learn/#hystrixcommand-%E9%85%8D%E7%BD%AE%E5%8F%82%E6%95%B0">HystrixCommand 配置参数</a></li>\n<li><a href="/system-design-deep-learn/#%E6%96%AD%E8%B7%AF%E6%B5%8B%E8%AF%95%E7%B1%BB">断路测试类</a></li>\n</ul>\n</li>\n<li><a href="/system-design-deep-learn/#%E6%B5%8B%E8%AF%95%E7%BB%93%E6%9E%9C">测试结果</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/system-design-deep-learn/#%E6%B7%B1%E5%85%A5-hystrix-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E9%9A%94%E7%A6%BB%E4%B8%8E%E6%8E%A5%E5%8F%A3%E9%99%90%E6%B5%81">深入 Hystrix 线程池隔离与接口限流</a></p>\n<ul>\n<li><a href="/system-design-deep-learn/#%E7%BA%BF%E7%A8%8B%E6%B1%A0%E9%9A%94%E7%A6%BB%E6%8A%80%E6%9C%AF%E7%9A%84%E8%AE%BE%E8%AE%A1">线程池隔离技术的设计</a></li>\n<li><a href="/system-design-deep-learn/#hystrix-%E5%BA%94%E7%94%A8%E7%BA%BF%E7%A8%8B%E6%B1%A0%E6%9C%BA%E5%88%B6%E7%9A%84%E5%9C%BA%E6%99%AF">Hystrix 应用线程池机制的场景</a></li>\n<li><a href="/system-design-deep-learn/#%E7%BA%BF%E7%A8%8B%E6%B1%A0%E6%9C%BA%E5%88%B6%E7%9A%84%E4%BC%98%E7%82%B9">线程池机制的优点</a></li>\n<li><a href="/system-design-deep-learn/#%E7%BA%BF%E7%A8%8B%E6%B1%A0%E6%9C%BA%E5%88%B6%E7%9A%84%E7%BC%BA%E7%82%B9">线程池机制的缺点</a></li>\n<li><a href="/system-design-deep-learn/#%E6%8E%A5%E5%8F%A3%E9%99%90%E6%B5%81-demo">接口限流 Demo</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/system-design-deep-learn/#%E5%9F%BA%E4%BA%8E-timeout-%E6%9C%BA%E5%88%B6%E4%B8%BA%E6%9C%8D%E5%8A%A1%E6%8E%A5%E5%8F%A3%E8%B0%83%E7%94%A8%E8%B6%85%E6%97%B6%E6%8F%90%E4%BE%9B%E5%AE%89%E5%85%A8%E4%BF%9D%E6%8A%A4">基于 timeout 机制为服务接口调用超时提供安全保护</a></p>\n<ul>\n<li><a href="/system-design-deep-learn/#timeoutmilliseconds">TimeoutMilliseconds</a></li>\n<li><a href="/system-design-deep-learn/#timeoutenabled">TimeoutEnabled</a></li>\n<li><a href="/system-design-deep-learn/#%E5%AE%9E%E4%BE%8B-demo-1">实例 Demo</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p><a href="/system-design-deep-learn/#%E9%AB%98%E5%8F%AF%E7%94%A8%E7%B3%BB%E7%BB%9F">高可用系统</a></p>\n<ul>\n<li><a href="/system-design-deep-learn/#%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1%E4%B8%80%E4%B8%AA%E9%AB%98%E5%8F%AF%E7%94%A8%E7%B3%BB%E7%BB%9F%EF%BC%9F">如何设计一个高可用系统？</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/system-design-deep-learn/#%E9%99%90%E6%B5%81">限流</a></p>\n<ul>\n<li>\n<p><a href="/system-design-deep-learn/#%E5%A6%82%E4%BD%95%E9%99%90%E6%B5%81%EF%BC%9F%E8%AF%B4%E4%B8%80%E4%B8%8B%E5%85%B7%E4%BD%93%E7%9A%84%E5%AE%9E%E7%8E%B0%EF%BC%9F">如何限流？说一下具体的实现？</a></p>\n<ul>\n<li>\n<p><a href="/system-design-deep-learn/#%E9%99%90%E6%B5%81%E6%96%B9%E6%B3%95">限流方法</a></p>\n<ul>\n<li><a href="/system-design-deep-learn/#%E8%AE%A1%E6%95%B0%E5%99%A8">计数器</a></li>\n<li><a href="/system-design-deep-learn/#%E6%BB%91%E5%8A%A8%E7%AA%97%E5%8F%A3">滑动窗口</a></li>\n<li><a href="/system-design-deep-learn/#leaky-bucket-%E6%BC%8F%E6%A1%B6">Leaky Bucket 漏桶</a></li>\n<li><a href="/system-design-deep-learn/#token-bucket-%E4%BB%A4%E7%89%8C%E6%A1%B6">Token Bucket 令牌桶</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/system-design-deep-learn/#%E5%B7%A5%E4%BD%9C%E4%B8%AD%E7%9A%84%E4%BD%BF%E7%94%A8">工作中的使用</a></p>\n<ul>\n<li><a href="/system-design-deep-learn/#spring-cloud-gateway">spring cloud gateway</a></li>\n<li><a href="/system-design-deep-learn/#sentinel">sentinel</a></li>\n<li><a href="/system-design-deep-learn/#%E6%80%BB%E7%BB%93-2">总结</a></li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p><a href="/system-design-deep-learn/#%E7%86%94%E6%96%AD">熔断</a></p>\n<ul>\n<li><a href="/system-design-deep-learn/#%E5%A6%82%E4%BD%95%E8%BF%9B%E8%A1%8C%E7%86%94%E6%96%AD%EF%BC%9F">如何进行熔断？</a></li>\n<li><a href="/system-design-deep-learn/#%E7%86%94%E6%96%AD%E6%A1%86%E6%9E%B6%E9%83%BD%E6%9C%89%E5%93%AA%E4%BA%9B%EF%BC%9F%E5%85%B7%E4%BD%93%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E7%9F%A5%E9%81%93%E5%90%97%EF%BC%9F">熔断框架都有哪些？具体实现原理知道吗？</a></li>\n<li>\n<p><a href="/system-design-deep-learn/#%E7%86%94%E6%96%AD%E6%A1%86%E6%9E%B6%EF%BC%8C%E9%80%89%E7%94%A8-sentinel-%E8%BF%98%E6%98%AF-hystrix%EF%BC%9F">熔断框架，选用 Sentinel 还是 Hystrix？</a></p>\n<ul>\n<li><a href="/system-design-deep-learn/#%E6%80%BB%E4%BD%93%E8%AF%B4%E6%98%8E">总体说明</a></li>\n<li>\n<p><a href="/system-design-deep-learn/#%E5%85%B1%E5%90%8C%E7%89%B9%E6%80%A7">共同特性</a></p>\n<ul>\n<li><a href="/system-design-deep-learn/#%E8%B5%84%E6%BA%90%E6%A8%A1%E5%9E%8B%E5%92%8C%E6%89%A7%E8%A1%8C%E6%A8%A1%E5%9E%8B%E4%B8%8A%E7%9A%84%E5%AF%B9%E6%AF%94">资源模型和执行模型上的对比</a></li>\n<li><a href="/system-design-deep-learn/#%E9%9A%94%E7%A6%BB%E8%AE%BE%E8%AE%A1%E4%B8%8A%E7%9A%84%E5%AF%B9%E6%AF%94">隔离设计上的对比</a></li>\n<li><a href="/system-design-deep-learn/#%E7%86%94%E6%96%AD%E9%99%8D%E7%BA%A7%E7%9A%84%E5%AF%B9%E6%AF%94">熔断降级的对比</a></li>\n<li><a href="/system-design-deep-learn/#%E5%AE%9E%E6%97%B6%E6%8C%87%E6%A0%87%E7%BB%9F%E8%AE%A1%E5%AE%9E%E7%8E%B0%E7%9A%84%E5%AF%B9%E6%AF%94">实时指标统计实现的对比</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/system-design-deep-learn/#sentinel-%E7%89%B9%E6%80%A7">Sentinel 特性</a></p>\n<ul>\n<li><a href="/system-design-deep-learn/#%E8%BD%BB%E9%87%8F%E7%BA%A7%E3%80%81%E9%AB%98%E6%80%A7%E8%83%BD">轻量级、高性能</a></li>\n<li><a href="/system-design-deep-learn/#%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6">流量控制</a></li>\n<li><a href="/system-design-deep-learn/#%E7%B3%BB%E7%BB%9F%E8%B4%9F%E8%BD%BD%E4%BF%9D%E6%8A%A4">系统负载保护</a></li>\n<li><a href="/system-design-deep-learn/#%E5%AE%9E%E6%97%B6%E7%9B%91%E6%8E%A7%E5%92%8C%E6%8E%A7%E5%88%B6%E9%9D%A2%E6%9D%BF">实时监控和控制面板</a></li>\n<li><a href="/system-design-deep-learn/#%E7%94%9F%E6%80%81">生态</a></li>\n</ul>\n</li>\n<li><a href="/system-design-deep-learn/#%E6%80%BB%E7%BB%93-3">总结</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p><a href="/system-design-deep-learn/#%E9%99%8D%E7%BA%A7">降级</a></p>\n<ul>\n<li><a href="/system-design-deep-learn/#%E5%A6%82%E4%BD%95%E8%BF%9B%E8%A1%8C%E9%99%8D%E7%BA%A7%EF%BC%9F">如何进行降级？</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p><a href="/system-design-deep-learn/#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84">微服务架构</a></p>\n<ul>\n<li>\n<p><a href="/system-design-deep-learn/#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%9A%84%E4%B8%80%E4%BA%9B%E6%A6%82%E5%BF%B5">微服务的一些概念</a></p>\n<ul>\n<li>\n<p><a href="/system-design-deep-learn/#%E5%85%B3%E4%BA%8E%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84%E7%9A%84%E6%8F%8F%E8%BF%B0">关于微服务架构的描述</a></p>\n<ul>\n<li>\n<p><a href="/system-design-deep-learn/#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84%E7%9A%84%E7%89%B9%E5%BE%81">微服务架构的特征</a></p>\n<ul>\n<li><a href="/system-design-deep-learn/#%E9%80%9A%E8%BF%87%E6%9C%8D%E5%8A%A1%E8%BF%9B%E8%A1%8C%E7%BB%84%E4%BB%B6%E5%8C%96">通过服务进行组件化</a></li>\n<li><a href="/system-design-deep-learn/#%E5%9B%B4%E7%BB%95%E4%B8%9A%E5%8A%A1%E8%83%BD%E5%8A%9B%E8%BF%9B%E8%A1%8C%E7%BB%84%E7%BB%87">围绕业务能力进行组织</a></li>\n<li><a href="/system-design-deep-learn/#%E6%98%AF%E4%BA%A7%E5%93%81%E4%B8%8D%E6%98%AF%E9%A1%B9%E7%9B%AE">是产品不是项目</a></li>\n<li><a href="/system-design-deep-learn/#%E6%99%BA%E8%83%BD%E7%AB%AF%E7%82%B9%E5%92%8C%E5%93%91%E7%AE%A1">智能端点和哑管</a></li>\n<li><a href="/system-design-deep-learn/#%E5%8E%BB%E4%B8%AD%E5%BF%83%E5%8C%96%E7%9A%84%E6%B2%BB%E7%90%86">去中心化的治理</a></li>\n<li><a href="/system-design-deep-learn/#%E5%88%86%E6%95%A3%E6%95%B0%E6%8D%AE%E7%AE%A1%E7%90%86">分散数据管理</a></li>\n<li><a href="/system-design-deep-learn/#%E5%9F%BA%E5%BB%BA%E8%87%AA%E5%8A%A8%E5%8C%96">基建自动化</a></li>\n<li><a href="/system-design-deep-learn/#%E8%AE%BE%E8%AE%A1%E6%97%B6%E4%B8%BA%E6%95%85%E9%9A%9C%E5%81%9A%E5%A5%BD%E5%87%86%E5%A4%87">设计时为故障做好准备</a></li>\n<li><a href="/system-design-deep-learn/#%E6%BC%94%E5%8C%96%E8%AE%BE%E8%AE%A1">演化设计</a></li>\n</ul>\n</li>\n<li><a href="/system-design-deep-learn/#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%98%AF%E6%9C%AA%E6%9D%A5%E5%90%97%EF%BC%9F">微服务是未来吗？</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/system-design-deep-learn/#%E4%BB%8E%E5%8D%95%E4%BD%93%E5%BC%8F%E6%9E%B6%E6%9E%84%E8%BF%81%E7%A7%BB%E5%88%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84">从单体式架构迁移到微服务架构</a></p>\n<ul>\n<li><a href="/system-design-deep-learn/#%E7%AD%96%E7%95%A5-1%EF%BC%9A%E5%81%9C%E6%AD%A2%E6%8C%96%E6%8E%98">策略 1：停止挖掘</a></li>\n<li><a href="/system-design-deep-learn/#%E7%AD%96%E7%95%A5-2%EF%BC%9A%E5%B0%86%E5%89%8D%E7%AB%AF%E5%92%8C%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB">策略 2：将前端和后端分离</a></li>\n<li>\n<p><a href="/system-design-deep-learn/#%E7%AD%96%E7%95%A5-3%EF%BC%9A%E6%8A%BD%E5%87%BA%E6%9C%8D%E5%8A%A1">策略 3：抽出服务</a></p>\n<ul>\n<li><a href="/system-design-deep-learn/#%E6%8E%92%E5%BA%8F%E9%82%A3%E4%B8%AA%E6%A8%A1%E5%9D%97%E5%BA%94%E8%AF%A5%E8%A2%AB%E8%BD%AC%E6%88%90%E5%BE%AE%E6%9C%8D%E5%8A%A1">排序那个模块应该被转成微服务</a></li>\n<li><a href="/system-design-deep-learn/#%E5%A6%82%E4%BD%95%E6%8A%BD%E5%8F%96%E6%A8%A1%E5%9D%97">如何抽取模块</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p><a href="/system-design-deep-learn/#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%9A%84%E4%BA%8B%E4%BB%B6%E9%A9%B1%E5%8A%A8%E6%95%B0%E6%8D%AE%E7%AE%A1%E7%90%86">微服务的事件驱动数据管理</a></p>\n<ul>\n<li><a href="/system-design-deep-learn/#%E4%BA%8B%E4%BB%B6%E9%A9%B1%E5%8A%A8%E6%9E%B6%E6%9E%84">事件驱动架构</a></li>\n<li>\n<p><a href="/system-design-deep-learn/#%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C-achieving-atomicity">原子操作 Achieving Atomicity</a></p>\n<ul>\n<li><a href="/system-design-deep-learn/#%E4%BD%BF%E7%94%A8%E6%9C%AC%E5%9C%B0%E4%BA%A4%E6%98%93%E5%8F%91%E5%B8%83%E4%BA%8B%E4%BB%B6">使用本地交易发布事件</a></li>\n<li><a href="/system-design-deep-learn/#%E6%8C%96%E6%8E%98%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BA%A4%E6%98%93%E6%97%A5%E5%BF%97">挖掘数据库交易日志</a></li>\n<li><a href="/system-design-deep-learn/#%E4%BD%BF%E7%94%A8%E4%BA%8B%E4%BB%B6%E6%BA%90">使用事件源</a></li>\n</ul>\n</li>\n<li><a href="/system-design-deep-learn/#%E6%80%BB%E7%BB%93-4">总结</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/system-design-deep-learn/#%E9%80%89%E6%8B%A9%E5%BE%AE%E6%9C%8D%E5%8A%A1%E9%83%A8%E7%BD%B2%E7%AD%96%E7%95%A5">选择微服务部署策略</a></p>\n<ul>\n<li><a href="/system-design-deep-learn/#%E5%8D%95%E4%B8%BB%E6%9C%BA%E5%A4%9A%E6%9C%8D%E5%8A%A1%E5%AE%9E%E4%BE%8B%E6%A8%A1%E5%BC%8F">单主机多服务实例模式</a></li>\n<li>\n<p><a href="/system-design-deep-learn/#%E5%8D%95%E4%B8%BB%E6%9C%BA%E5%8D%95%E6%9C%8D%E5%8A%A1%E5%AE%9E%E4%BE%8B%E6%A8%A1%E5%BC%8F">单主机单服务实例模式</a></p>\n<ul>\n<li><a href="/system-design-deep-learn/#%E5%8D%95%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%8D%95%E5%AE%9E%E4%BE%8B%E6%A8%A1%E5%BC%8F">单虚拟机单实例模式</a></li>\n</ul>\n</li>\n<li><a href="/system-design-deep-learn/#%E5%8D%95%E5%AE%B9%E5%99%A8%E5%8D%95%E6%9C%8D%E5%8A%A1%E5%AE%9E%E4%BE%8B%E6%A8%A1%E5%BC%8F">单容器单服务实例模式</a></li>\n<li><a href="/system-design-deep-learn/#serverless-%E9%83%A8%E7%BD%B2">Serverless 部署</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p><a href="/system-design-deep-learn/#spring-cloud-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84">Spring Cloud 微服务架构</a></p>\n<ul>\n<li>\n<p><a href="/system-design-deep-learn/#%E4%BB%80%E4%B9%88%E6%98%AF%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9F%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%B9%8B%E9%97%B4%E6%98%AF%E5%A6%82%E4%BD%95%E7%8B%AC%E7%AB%8B%E9%80%9A%E8%AE%AF%E7%9A%84%EF%BC%9F">什么是微服务？微服务之间是如何独立通讯的？</a></p>\n<ul>\n<li>\n<p><a href="/system-design-deep-learn/#%E5%90%8C%E6%AD%A5">同步</a></p>\n<ul>\n<li><a href="/system-design-deep-learn/#rest-http-%E5%8D%8F%E8%AE%AE">REST HTTP 协议</a></li>\n<li><a href="/system-design-deep-learn/#rpc-tcp-%E5%8D%8F%E8%AE%AE">RPC TCP 协议</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/system-design-deep-learn/#%E5%BC%82%E6%AD%A5">异步</a></p>\n<ul>\n<li><a href="/system-design-deep-learn/#%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6">消息中间件</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li><a href="/system-design-deep-learn/#spring-cloud-%E5%92%8C-dubbo-%E6%9C%89%E5%93%AA%E4%BA%9B%E5%8C%BA%E5%88%AB%EF%BC%9F">Spring Cloud 和 Dubbo 有哪些区别？</a></li>\n<li><a href="/system-design-deep-learn/#spring-boot-%E5%92%8C-spring-cloud%EF%BC%8C%E8%B0%88%E8%B0%88%E4%BD%A0%E5%AF%B9%E5%AE%83%E4%BB%AC%E7%9A%84%E7%90%86%E8%A7%A3%EF%BC%9F">Spring Boot 和 Spring Cloud，谈谈你对它们的理解？</a></li>\n<li><a href="/system-design-deep-learn/#%E4%BB%80%E4%B9%88%E6%98%AF%E6%9C%8D%E5%8A%A1%E7%86%94%E6%96%AD%EF%BC%9F%E4%BB%80%E4%B9%88%E6%98%AF%E6%9C%8D%E5%8A%A1%E9%99%8D%E7%BA%A7%EF%BC%9F">什么是服务熔断？什么是服务降级？</a></li>\n<li><a href="/system-design-deep-learn/#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%9A%84%E4%BC%98%E7%BC%BA%E7%82%B9%E5%88%86%E5%88%AB%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F%E8%AF%B4%E4%B8%80%E4%B8%8B%E4%BD%A0%E5%9C%A8%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E4%B8%AD%E7%A2%B0%E5%88%B0%E7%9A%84%E5%9D%91%EF%BC%9F">微服务的优缺点分别是什么？说一下你在项目开发中碰到的坑？</a></li>\n<li>\n<p><a href="/system-design-deep-learn/#%E4%BD%A0%E6%89%80%E7%9F%A5%E9%81%93%E7%9A%84%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8A%80%E6%9C%AF%E6%A0%88%E9%83%BD%E6%9C%89%E5%93%AA%E4%BA%9B%EF%BC%9F">你所知道的微服务技术栈都有哪些？</a></p>\n<ul>\n<li><a href="/system-design-deep-learn/#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%BC%80%E5%8F%91">微服务开发</a></li>\n<li><a href="/system-design-deep-learn/#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E5%8F%91%E7%8E%B0">微服务注册发现</a></li>\n<li><a href="/system-design-deep-learn/#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86">微服务配置管理</a></li>\n<li><a href="/system-design-deep-learn/#%E6%9D%83%E9%99%90%E8%AE%A4%E8%AF%81">权限认证</a></li>\n<li><a href="/system-design-deep-learn/#%E6%89%B9%E5%A4%84%E7%90%86">批处理</a></li>\n<li><a href="/system-design-deep-learn/#%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1">定时任务</a></li>\n<li><a href="/system-design-deep-learn/#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E8%B0%83%E7%94%A8-%E5%8D%8F%E8%AE%AE">微服务调用 (协议)</a></li>\n<li><a href="/system-design-deep-learn/#%E6%9C%8D%E5%8A%A1%E6%8E%A5%E5%8F%A3%E8%B0%83%E7%94%A8">服务接口调用</a></li>\n<li><a href="/system-design-deep-learn/#%E6%9C%8D%E5%8A%A1%E7%86%94%E6%96%AD">服务熔断</a></li>\n<li><a href="/system-design-deep-learn/#%E6%9C%8D%E5%8A%A1%E7%9A%84%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1">服务的负载均衡</a></li>\n<li><a href="/system-design-deep-learn/#%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97-1">消息队列</a></li>\n<li><a href="/system-design-deep-learn/#%E6%97%A5%E5%BF%97%E9%87%87%E9%9B%86-elk">日志采集 (elk)</a></li>\n<li><a href="/system-design-deep-learn/#api-%E7%BD%91%E5%85%B3">API 网关</a></li>\n<li><a href="/system-design-deep-learn/#%E6%9C%8D%E5%8A%A1%E7%9B%91%E6%8E%A7">服务监控</a></li>\n<li><a href="/system-design-deep-learn/#%E6%9C%8D%E5%8A%A1%E9%93%BE%E8%B7%AF%E8%BF%BD%E8%B8%AA">服务链路追踪</a></li>\n<li>\n<p><a href="/system-design-deep-learn/#%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8">数据存储</a></p>\n<ul>\n<li><a href="/system-design-deep-learn/#%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93">关系型数据库</a></li>\n<li><a href="/system-design-deep-learn/#%E9%9D%9E%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93">非关系型数据库</a></li>\n</ul>\n</li>\n<li><a href="/system-design-deep-learn/#%E7%BC%93%E5%AD%98-2">缓存</a></li>\n<li><a href="/system-design-deep-learn/#%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8-2">分库分表</a></li>\n<li><a href="/system-design-deep-learn/#%E6%9C%8D%E5%8A%A1%E9%83%A8%E7%BD%B2">服务部署</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/system-design-deep-learn/#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86%E7%AD%96%E7%95%A5">微服务治理策略</a></p>\n<ul>\n<li><a href="/system-design-deep-learn/#%E6%9C%8D%E5%8A%A1%E7%9A%84%E6%B3%A8%E5%86%8C%E5%92%8C%E5%8F%91%E7%8E%B0">服务的注册和发现</a></li>\n<li><a href="/system-design-deep-learn/#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1">负载均衡</a></li>\n<li><a href="/system-design-deep-learn/#%E9%80%9A%E8%AE%AF">通讯</a></li>\n<li><a href="/system-design-deep-learn/#%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86">配置管理</a></li>\n<li><a href="/system-design-deep-learn/#%E5%AE%B9%E9%94%99%E5%92%8C%E6%9C%8D%E5%8A%A1%E9%99%8D%E7%BA%A7">容错和服务降级</a></li>\n<li><a href="/system-design-deep-learn/#%E6%9C%8D%E5%8A%A1%E4%BE%9D%E8%B5%96%E5%85%B3%E7%B3%BB">服务依赖关系</a></li>\n<li><a href="/system-design-deep-learn/#%E6%9C%8D%E5%8A%A1%E6%96%87%E6%A1%A3">服务文档</a></li>\n<li><a href="/system-design-deep-learn/#%E6%9C%8D%E5%8A%A1%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98">服务安全问题</a></li>\n<li><a href="/system-design-deep-learn/#%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6-1">流量控制</a></li>\n<li><a href="/system-design-deep-learn/#%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%8B%E8%AF%95">自动化测试</a></li>\n<li><a href="/system-design-deep-learn/#%E6%9C%8D%E5%8A%A1%E4%B8%8A%E7%BA%BF%EF%BC%8C%E4%B8%8B%E7%BA%BF%E7%9A%84%E6%B5%81%E7%A8%8B">服务上线，下线的流程</a></li>\n<li><a href="/system-design-deep-learn/#%E5%85%BC%E5%AE%B9%E6%80%A7">兼容性</a></li>\n<li><a href="/system-design-deep-learn/#%E6%9C%8D%E5%8A%A1%E7%BC%96%E6%8E%92">服务编排</a></li>\n<li><a href="/system-design-deep-learn/#%E8%B5%84%E6%BA%90%E8%B0%83%E5%BA%A6">资源调度</a></li>\n<li><a href="/system-design-deep-learn/#%E5%AE%B9%E9%87%8F%E8%A7%84%E5%88%92">容量规划</a></li>\n</ul>\n</li>\n<li><a href="/system-design-deep-learn/#eureka-%E5%92%8C-zookeeper-%E9%83%BD%E5%8F%AF%E4%BB%A5%E6%8F%90%E4%BE%9B%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E4%B8%8E%E5%8F%91%E7%8E%B0%E7%9A%84%E5%8A%9F%E8%83%BD%EF%BC%8C%E5%AE%83%E4%BB%AC%E6%9C%89%E4%BB%80%E4%B9%88%E5%8C%BA%E5%88%AB%EF%BC%9F">Eureka 和 Zookeeper 都可以提供服务注册与发现的功能，它们有什么区别？</a></li>\n<li>\n<p><a href="/system-design-deep-learn/#%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0%E7%BB%84%E4%BB%B6-eureka-%E7%9A%84%E5%87%A0%E4%B8%AA%E4%B8%BB%E8%A6%81%E8%B0%83%E7%94%A8%E8%BF%87%E7%A8%8B">服务发现组件 Eureka 的几个主要调用过程</a></p>\n<ul>\n<li><a href="/system-design-deep-learn/#%E5%89%8D%E8%A8%80">前言</a></li>\n<li><a href="/system-design-deep-learn/#eureka-%E6%98%AF%E4%BB%80%E4%B9%88">Eureka 是什么</a></li>\n<li>\n<p><a href="/system-design-deep-learn/#%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%EF%BC%88eureka-server%EF%BC%89">服务注册中心（Eureka Server）</a></p>\n<ul>\n<li><a href="/system-design-deep-learn/#%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%EF%BC%88register%EF%BC%89">服务注册（Register）</a></li>\n<li><a href="/system-design-deep-learn/#%E6%9C%8D%E5%8A%A1%E7%BB%AD%E7%BA%A6%EF%BC%88renew%EF%BC%89">服务续约（Renew）</a></li>\n<li><a href="/system-design-deep-learn/#%E6%9C%8D%E5%8A%A1%E4%B8%8B%E7%BA%BF%EF%BC%88cancel%EF%BC%89">服务下线（Cancel）</a></li>\n<li><a href="/system-design-deep-learn/#%E6%9C%8D%E5%8A%A1%E5%89%94%E9%99%A4%EF%BC%88eviction%EF%BC%89">服务剔除（Eviction）</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/system-design-deep-learn/#%E6%9C%8D%E5%8A%A1%E6%8F%90%E4%BE%9B%E8%80%85%EF%BC%88service-provider%EF%BC%89">服务提供者（Service Provider）</a></p>\n<ul>\n<li><a href="/system-design-deep-learn/#%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%EF%BC%88register%EF%BC%89-1">服务注册（Register）</a></li>\n<li><a href="/system-design-deep-learn/#%E6%9C%8D%E5%8A%A1%E7%BB%AD%E7%BA%A6%EF%BC%88renew%EF%BC%89-1">服务续约（Renew）</a></li>\n<li><a href="/system-design-deep-learn/#%E6%9C%8D%E5%8A%A1%E4%B8%8B%E7%BA%BF%EF%BC%88cancel%EF%BC%89-1">服务下线（Cancel）</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/system-design-deep-learn/#%E6%9C%8D%E5%8A%A1%E6%B6%88%E8%B4%B9%E8%80%85%EF%BC%88service-consumer%EF%BC%89">服务消费者（Service Consumer）</a></p>\n<ul>\n<li><a href="/system-design-deep-learn/#%E8%8E%B7%E5%8F%96%E6%9C%8D%E5%8A%A1%E5%88%97%E8%A1%A8%EF%BC%88fetch%EF%BC%89">获取服务列表（Fetch）</a></li>\n<li><a href="/system-design-deep-learn/#%E6%9B%B4%E6%96%B0%E6%9C%8D%E5%8A%A1%E5%88%97%E8%A1%A8%EF%BC%88update%EF%BC%89">更新服务列表（Update）</a></li>\n</ul>\n</li>\n<li><a href="/system-design-deep-learn/#%E6%80%BB%E7%BB%93-5">总结</a></li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>',
wordCount:{words:17482},frontmatter:{date:"2023-09-14 13:47:01",path:"/system-design-deep-learn/",tags:"后端, 系统设计, 读书笔记",title:"系统设计深入学习",draft:null,catalog_number:null}},nextPost:{html:'<h1 id="培养-pythonic-思维"><a href="#%E5%9F%B9%E5%85%BB-pythonic-%E6%80%9D%E7%BB%B4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>培养 Pythonic 思维</h1>\n<h2 id="第-1-条：查询自己使用的-python-版本"><a href="#%E7%AC%AC-1-%E6%9D%A1%EF%BC%9A%E6%9F%A5%E8%AF%A2%E8%87%AA%E5%B7%B1%E4%BD%BF%E7%94%A8%E7%9A%84-python-%E7%89%88%E6%9C%AC" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 1 条：查询自己使用的 Python 版本</h2>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="61170574578340560000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ python --version\n\\$ python -V\n\\$ python3 --version\n\\$ python3 -V`, `61170574578340560000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ python --version\n$ python -V\n$ python3 --version\n$ python3 -V</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="33708229752197784000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> import sys\n>>> print(sys.version_info)\nsys.version_info(major=3, minor=6, micro=15, releaselevel=\'final\', serial=0)\n>>> print(sys.version)\n3.6.15 (default, Apr 20 2022, 13:05:41)\n[GCC 5.4.0 20160609]`, `33708229752197784000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token operator">>></span><span class="token operator">></span> <span class="token function">import</span> sys\n<span class="token operator">>></span><span class="token operator">></span> print<span class="token punctuation">(</span>sys.version_info<span class="token punctuation">)</span>\nsys.version_info<span class="token punctuation">(</span>major<span class="token operator">=</span><span class="token number">3</span>, <span class="token assign-left variable">minor</span><span class="token operator">=</span><span class="token number">6</span>, <span class="token assign-left variable">micro</span><span class="token operator">=</span><span class="token number">15</span>, <span class="token assign-left variable">releaselevel</span><span class="token operator">=</span><span class="token string">\'final\'</span>, <span class="token assign-left variable">serial</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> print<span class="token punctuation">(</span>sys.version<span class="token punctuation">)</span>\n<span class="token number">3.6</span>.15 <span class="token punctuation">(</span>default, Apr <span class="token number">20</span> <span class="token number">2022</span>, <span class="token number">13</span>:05:41<span class="token punctuation">)</span>\n<span class="token punctuation">[</span>GCC <span class="token number">5.4</span>.0 <span class="token number">20160609</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Python 2 于 2020 年 1 月 1 日退场，到这一刻，所有的 bug 修复、安全补丁，以及特性向后移植都会停止。此后，如果你还坚持使用 Python 2，那么会面临很多不利因素，因为它不会再获得正式的维护了。深度依赖 Python 2 代码库的开发者可以考虑用 2to3（Python 预装的工具）与 <a href="https://six.readthedocs.io/" target="_blank" rel="nofollow noreferrer noopener">six</a> 这样的工具过渡到 Python 3。</p>\n<h2 id="第-2-条：遵循-pep-8-风格指南"><a href="#%E7%AC%AC-2-%E6%9D%A1%EF%BC%9A%E9%81%B5%E5%BE%AA-pep-8-%E9%A3%8E%E6%A0%BC%E6%8C%87%E5%8D%97" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 2 条：遵循 PEP 8 风格指南</h2>\n<h3 id="与空白有关的建议"><a href="#%E4%B8%8E%E7%A9%BA%E7%99%BD%E6%9C%89%E5%85%B3%E7%9A%84%E5%BB%BA%E8%AE%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>与空白有关的建议</h3>\n<p>在 Python 中，空白（whitespace）在语法上相当重要。Python 程序员对空白字符的用法尤其在意，因为它们会影响代码的清晰程度。在这方面，大家应该遵循以下几条建议。</p>\n<ul>\n<li>用空格（space）表示缩进，而不要用制表符（tab）。</li>\n<li>和语法相关的每一层缩进都用 4 个空格表示。</li>\n<li>每行不超过 79 个字符。</li>\n<li>对于占据多行的长表达式来说，除了首行之外的其余各行都应该在通常的缩进级别之上再加 4 个空格。</li>\n<li>在同一份文件中，函数与类之间用两个空行隔开。</li>\n<li>在同一个类中，方法与方法之间用一个空行隔开。</li>\n<li>使用字典时，键与冒号之间不加空格，写在同一行的冒号和值之间应该加一个空格。</li>\n<li>给变量赋值时，赋值符号的左边和右边各加一个空格，并且只加一个空格就好。</li>\n<li>给变量的类型做注解（annotation）时，不要把变量名和冒号隔开，但在类型信息前应该有一个空格。</li>\n</ul>\n<h3 id="与命名有关的建议"><a href="#%E4%B8%8E%E5%91%BD%E5%90%8D%E6%9C%89%E5%85%B3%E7%9A%84%E5%BB%BA%E8%AE%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>与命名有关的建议</h3>\n<p>PEP 8 建议采用不同的方式来给 Python 代码中的各个部分命名，这样在阅读代码时，就可以根据这些名称看出它们在 Python 语言中的角色。遵循以下与命名相关的建议。</p>\n<ul>\n<li>函数、变量及属性用小写字母来拼写，各单词之间用下划线相连，例如：<code class="language-text">lowercase_underscore</code>。</li>\n<li>受保护的实例属性，用一个下划线开头，例如：<code class="language-text">_leading_underscore</code>。</li>\n<li>私有的实例属性，用两个下划线开头，例如：<code class="language-text">__double_leading_underscore</code>。</li>\n<li>类（包括异常）命名时，每个单词的首字母均大写，例如：CapitalizedWord。</li>\n<li>模块级别的常量，所有字母都大写，各单词之间用下划线相连，例如：<code class="language-text">ALL_CAPS</code>。</li>\n<li>类中的实例方法，应该把第一个参数命名为 self，用来表示该对象本身。</li>\n<li>类方法的第一个参数，应该命名为 cls，用来表示这个类本身。</li>\n</ul>\n<h3 id="与表达式和语句有关的建议"><a href="#%E4%B8%8E%E8%A1%A8%E8%BE%BE%E5%BC%8F%E5%92%8C%E8%AF%AD%E5%8F%A5%E6%9C%89%E5%85%B3%E7%9A%84%E5%BB%BA%E8%AE%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>与表达式和语句有关的建议</h3>\n<p>The Zen of Python 中提到：<code class="language-text">每件事都应该有简单的做法，而且最好只有一种</code>。PEP 8 就试着运用这个理念，来规范表达式和语句的写法。</p>\n<ul>\n<li>采用行内否定，即把否定词直接写在要否定的内容前面，而不要放在整个表达式的前面，例如应该写 <code class="language-text">if a is not b</code>，而不是 <code class="language-text">if not a is b</code>。</li>\n<li>不要通过长度判断容器或序列是不是空的，例如不要通过 <code class="language-text">if len(somelist) == 0</code> 判断 somelist 是否为 <code class="language-text">[]</code> 或 <code class="language-text">&#39;&#39;</code> 等空值，而是应该采用 <code class="language-text">if not somelist</code> 这样的写法来判断，因为 Python 会把空值自动评估为 False。</li>\n<li>如果要判断容器或序列里面有没有内容（比如要判断 somelist 是否为 <code class="language-text">[1]</code> 或 <code class="language-text">&#39;hi&#39;</code> 这样非空的值），也不应该通过长度来判断，而是应该采用 <code class="language-text">if somelist</code> 语句，因为 Python 会把非空的值自动判定为 True。</li>\n<li>不要把 if 语句、for 循环、while 循环及 except 复合语句挤在一行。应该把这些语句分成多行来写，这样更加清晰。</li>\n<li>如果表达式一行写不下，可以用括号将其括起来，而且要适当地添加换行与缩进以便于阅读。多行的表达式，应该用括号括起来，而不要用 <code class="language-text">\\</code> 符号续行。</li>\n</ul>\n<h3 id="与引入有关的建议"><a href="#%E4%B8%8E%E5%BC%95%E5%85%A5%E6%9C%89%E5%85%B3%E7%9A%84%E5%BB%BA%E8%AE%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>与引入有关的建议</h3>\n<p>PEP 8 对于怎样在代码中引入并使用模块，给出了下面几条建议。</p>\n<ul>\n<li>import 语句（含 <code class="language-text">from x import y</code>）总是应该放在文件开头。</li>\n<li>引入模块时，总是应该使用绝对名称，而不应该根据当前模块路径来使用相对名称。例如，要引入 bar 包中的 foo 模块，应该完整地写出 <code class="language-text">from bar import foo</code>，即便当前路径为 bar 包里，也不应该简写为 <code class="language-text">import foo</code>。</li>\n<li>如果一定要用相对名称来编写 import 语句，那就应该明确地写成：<code class="language-text">from . import foo</code>。文件中的 import 语句应该按顺序划分成三个部分：首先引入标准库里的模块，然后引入第三方模块，最后引入自己的模块。属于同一个部分的 import 语句按字母顺序排列。</li>\n</ul>\n<h2 id="第-3-条：了解-bytes-与-str-的区别"><a href="#%E7%AC%AC-3-%E6%9D%A1%EF%BC%9A%E4%BA%86%E8%A7%A3-bytes-%E4%B8%8E-str-%E7%9A%84%E5%8C%BA%E5%88%AB" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 3 条：了解 bytes 与 str 的区别</h2>\n<p>Python 有两种类型可以表示字符序列：一种是 bytes，另一种是 str。</p>\n<p>bytes 实例包含的是原始数据，即 8 位的无符号值（通常按照 ASCII 编码标准来显示）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="44516301022623230000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`a = b\'h\\x65llo\'\nprint(list(a))\nprint(a)\n\n>>>\n[104, 101, 108, 108, 111]\nb\'hello\'`, `44516301022623230000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">a <span class="token operator">=</span> <span class="token string">b\'h\\x65llo\'</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">[</span><span class="token number">104</span><span class="token punctuation">,</span> <span class="token number">101</span><span class="token punctuation">,</span> <span class="token number">108</span><span class="token punctuation">,</span> <span class="token number">108</span><span class="token punctuation">,</span> <span class="token number">111</span><span class="token punctuation">]</span>\n<span class="token string">b\'hello\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>str 实例包含的是 Unicode 码点（code point，也叫作代码点），这些码点与人类语言之中的文本字符相对应。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="35545656057255657000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`a = \'a\\u0300 propos\'\nprint(list(a))\nprint(a)\n\n>>>\n[\'a\', \'̀\', \' \', \'p\', \'r\', \'o\', \'p\', \'o\', \'s\']\nà propos`, `35545656057255657000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">a <span class="token operator">=</span> <span class="token string">\'a\\u0300 propos\'</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">[</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'̀\'</span><span class="token punctuation">,</span> <span class="token string">\' \'</span><span class="token punctuation">,</span> <span class="token string">\'p\'</span><span class="token punctuation">,</span> <span class="token string">\'r\'</span><span class="token punctuation">,</span> <span class="token string">\'o\'</span><span class="token punctuation">,</span> <span class="token string">\'p\'</span><span class="token punctuation">,</span> <span class="token string">\'o\'</span><span class="token punctuation">,</span> <span class="token string">\'s\'</span><span class="token punctuation">]</span>\nà propos</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>两种不同的字符类型与 Python 中两种常见的使用情况相对应：</p>\n<ul>\n<li>开发者需要操作原始的 8 位值序列，序列里面的这些 8 位值合起来表示一个应该按 UTF-8 或其他标准编码的字符串。</li>\n<li>开发者需要操作通用的 Unicode 字符串，而不是操作某种特定编码的字符串。</li>\n</ul>\n<p>我们通常需要编写两个辅助函数，以便在这两种情况之间转换，确保输入值类型符合开发者的预期形式。</p>\n<p>第一个辅助函数接受 bytes 或 str 实例，并返回 str：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="46181243884784170000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def to_str(bytes_or_str):\n    if isinstance(bytes_or_str, bytes):\n        value = bytes_or_str.decode(\'utf-8\')\n    else:\n        value = bytes_or_str\n    return value # Instance of str\n\nprint(repr(to_str(b\'foo\')))\nprint(repr(to_str(\'bar\')))\n\n>>>\n\'foo\'\n\'bar\'`, `46181243884784170000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">to_str</span><span class="token punctuation">(</span>bytes_or_str<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>bytes_or_str<span class="token punctuation">,</span> <span class="token builtin">bytes</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        value <span class="token operator">=</span> bytes_or_str<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">\'utf-8\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">else</span><span class="token punctuation">:</span>\n        value <span class="token operator">=</span> bytes_or_str\n    <span class="token keyword">return</span> value <span class="token comment"># Instance of str</span>\n\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">repr</span><span class="token punctuation">(</span>to_str<span class="token punctuation">(</span><span class="token string">b\'foo\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">repr</span><span class="token punctuation">(</span>to_str<span class="token punctuation">(</span><span class="token string">\'bar\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token string">\'foo\'</span>\n<span class="token string">\'bar\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>第二个辅助函数也接受 bytes 或 str 实例，但它返回的是 bytes：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="76715762569736110000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def to_bytes(bytes_or_str):\n    if isinstance(bytes_or_str, str):\n        value = bytes_or_str.encode(\'utf-8\')\n    else:\n        value = bytes_or_str\n    return value # Instance of bytes\n\nprint(repr(to_bytes(b\'foo\')))\nprint(repr(to_bytes(\'bar\')))\n\n>>>\nb\'foo\'\nb\'bar\'`, `76715762569736110000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">to_bytes</span><span class="token punctuation">(</span>bytes_or_str<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>bytes_or_str<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        value <span class="token operator">=</span> bytes_or_str<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">\'utf-8\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">else</span><span class="token punctuation">:</span>\n        value <span class="token operator">=</span> bytes_or_str\n    <span class="token keyword">return</span> value <span class="token comment"># Instance of bytes</span>\n\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">repr</span><span class="token punctuation">(</span>to_bytes<span class="token punctuation">(</span><span class="token string">b\'foo\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">repr</span><span class="token punctuation">(</span>to_bytes<span class="token punctuation">(</span><span class="token string">\'bar\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token string">b\'foo\'</span>\n<span class="token string">b\'bar\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在 Python 中使用原始的 8 位值与 Unicode 字符串时，有两个问题要注意。</p>\n<p>第一个问题是，bytes 与 str 这两种类型似乎是以相同的方式工作的，但其实例并不相互兼容，所以在传递字符序列的时候必须考虑好其类型。</p>\n<p>可以用 + 操作符将 bytes 添加到 bytes，str 也可以这样。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="31301724886173330000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`print(b\'one\' + b\'two\')\nprint(\'one\' + \'two\')\n\n>>>\nb\'onetwo\'\nonetwo`, `31301724886173330000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">b\'one\'</span> <span class="token operator">+</span> <span class="token string">b\'two\'</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'one\'</span> <span class="token operator">+</span> <span class="token string">\'two\'</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token string">b\'onetwo\'</span>\nonetwo</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>但是不能将 str 实例添加到 bytes 实例：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="99701069880994200000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`b\'one\' + \'two\'\n\n>>>\nTraceback ...\nTypeError: can\'t concat str to bytes`, `99701069880994200000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token string">b\'one\'</span> <span class="token operator">+</span> <span class="token string">\'two\'</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nTypeError<span class="token punctuation">:</span> can\'t concat <span class="token builtin">str</span> to <span class="token builtin">bytes</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>也不能将 bytes 实例添加到 str 实例：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="88696477651136150000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\'one\' + b\'two\'\n\n>>>\nTraceback ...\nTypeError: can only concatenate str (not &quot;bytes&quot;) to str`, `88696477651136150000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token string">\'one\'</span> <span class="token operator">+</span> <span class="token string">b\'two\'</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nTypeError<span class="token punctuation">:</span> can only concatenate <span class="token builtin">str</span> <span class="token punctuation">(</span><span class="token keyword">not</span> <span class="token string">"bytes"</span><span class="token punctuation">)</span> to <span class="token builtin">str</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>bytes 与 bytes 之间可以用二元操作符（binary operator）来比较大小，str 与 str 之间也可以：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="55559049378989410000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`assert b\'red\' > b\'blue\'\nassert \'red\' > \'blue\'`, `55559049378989410000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">assert</span> <span class="token string">b\'red\'</span> <span class="token operator">></span> <span class="token string">b\'blue\'</span>\n<span class="token keyword">assert</span> <span class="token string">\'red\'</span> <span class="token operator">></span> <span class="token string">\'blue\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>但是 str 实例不能与 bytes 实例比较：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="37200721830172470000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`assert \'red\' > b\'blue\'\n\n>>>\nTraceback ...\nTypeError: \'>\' not supported between instances of \'str\' and \'bytes\'`, `37200721830172470000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">assert</span> <span class="token string">\'red\'</span> <span class="token operator">></span> <span class="token string">b\'blue\'</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nTypeError<span class="token punctuation">:</span> <span class="token string">\'>\'</span> <span class="token keyword">not</span> supported between instances of <span class="token string">\'str\'</span> <span class="token keyword">and</span> <span class="token string">\'bytes\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>反过来也一样，也就是说 bytes 实例不能与 str 实例比较：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="77577162367297360000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`assert b\'blue\' < \'red\'\n\n>>>\nTraceback ...\nTypeError: \'<\' not supported between instances of \'bytes\' and \'str\'`, `77577162367297360000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">assert</span> <span class="token string">b\'blue\'</span> <span class="token operator">&lt;</span> <span class="token string">\'red\'</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nTypeError<span class="token punctuation">:</span> <span class="token string">\'&lt;\'</span> <span class="token keyword">not</span> supported between instances of <span class="token string">\'bytes\'</span> <span class="token keyword">and</span> <span class="token string">\'str\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>判断 bytes 与 str 实例是否相等，总是会评估为假（False），即便这两个实例表示的字符完全相同，它们也不相等。例如，在下面这个例子里，它们表示的字符串都相当于 ASCII 编码之中的 foo。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="18470771750778958000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`print(b\'foo\' == \'foo\')\n\n>>>\nFalse`, `18470771750778958000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">b\'foo\'</span> <span class="token operator">==</span> <span class="token string">\'foo\'</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token boolean">False</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>两种类型的实例都可以出现在 % 操作符的右侧，用来替换左侧那个格式字符串（format string）里面的 %s。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="30806929899724268000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`print(b\'red %s\' % b\'blue\')\nprint(\'red %s\' % \'blue\')\n\n>>>\nb\'red blue\'\nred blue`, `30806929899724268000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">b\'red %s\'</span> <span class="token operator">%</span> <span class="token string">b\'blue\'</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'red %s\'</span> <span class="token operator">%</span> <span class="token string">\'blue\'</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token string">b\'red blue\'</span>\nred blue</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果格式字符串是 bytes 类型，那么不能用 str 实例来替换其中的 %s，因为 Python 不知道这个 str 应该按照什么方案来编码。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="33110859388714074000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`print(b\'red %s\' % \'blue\')\n\n>>>\nTraceback ...\nTypeError: %b requires a bytes-like object, or an object that implements _bytes_, not \'str\'`, `33110859388714074000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">b\'red %s\'</span> <span class="token operator">%</span> <span class="token string">\'blue\'</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nTypeError<span class="token punctuation">:</span> <span class="token operator">%</span>b requires a <span class="token builtin">bytes</span><span class="token operator">-</span>like <span class="token builtin">object</span><span class="token punctuation">,</span> <span class="token keyword">or</span> an <span class="token builtin">object</span> that implements _bytes_<span class="token punctuation">,</span> <span class="token keyword">not</span> <span class="token string">\'str\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>但反过来却可以，也就是说如果格式字符串是 str 类型，则可以用 bytes 实例来替换其中的 %s，问题是这可能跟你想要的结果不一样。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="80047927703347540000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`print(\'red %s\' % b\'blue\')\n\n>>>\nred b\'blue\'`, `80047927703347540000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'red %s\'</span> <span class="token operator">%</span> <span class="token string">b\'blue\'</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nred <span class="token string">b\'blue\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样做，会让系统在 bytes 实例上面调用 <code class="language-text">__repr__</code> 方法（参见第 75 条），然后用这次调用所得到的结果替换格式字符串里的 %s，因此程序会直接输出 <code class="language-text">b&#39;blue&#39;</code>，而不是像你想的那样，输出 blue 本身。</p>\n<p>第二个问题发生在操作文件句柄的时候，这里的句柄指由内置的 open 函数返回的句柄。这样的句柄默认需要使用 Unicode 字符串操作，而不能采用原始的 bytes。习惯了 Python 2 的开发者，尤其容易碰到这个问题，进而导致程序出现奇怪的错误。例如，向文件写入二进制数据的时候，下面这种写法其实是错误的。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="3750557673327015400"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`with open(\'data.bin\', \'w\') as f:\n   f.write(b\'\\xf1\\xf2\\xf3\\xf4\\xf5\')\n\n>>>\nTraceback ...\nTypeError: write() argument must be str, not bytes`, `3750557673327015400`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'data.bin\'</span><span class="token punctuation">,</span> <span class="token string">\'w\'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>\n   f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">b\'\\xf1\\xf2\\xf3\\xf4\\xf5\'</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nTypeError<span class="token punctuation">:</span> write<span class="token punctuation">(</span><span class="token punctuation">)</span> argument must be <span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token keyword">not</span> <span class="token builtin">bytes</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>程序发生异常是因为在调用 open 函数时，指定的是 <code class="language-text">&#39;w&#39;</code> 模式，所以系统要求必须以文本模式写入。如果想用二进制模式，那应该指定 <code class="language-text">&#39;wb&#39;</code> 才对。在文本模式下，write 方法接受的是包含 Unicode 数据的 str 实例，不是包含二进制数据的 bytes 实例。所以，我们得把模式改成 <code class="language-text">&#39;wb&#39;</code> 来解决该问题。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="21880697808953100000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`with open(\'data.bin\', \'wb\') as f:\n   f.write(b\'\\xf1\\xf2\\xf3\\xf4\\xf5\')`, `21880697808953100000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'data.bin\'</span><span class="token punctuation">,</span> <span class="token string">\'wb\'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>\n   f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">b\'\\xf1\\xf2\\xf3\\xf4\\xf5\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>读取文件的时候也有类似的问题。例如，如果要把刚才写入的二进制文件读出来，那么不能用下面这种写法，同样需要改成 <code class="language-text">&#39;rb&#39;</code></p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="94774970281665330000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`with open(\'data.bin\', \'r\') as f:\n   data = f.read()\n\n>>>\nTraceback ...\nUnicodeDecodeError: \'utf-8\' codec can\'t decode byte 0xf1 in position 0: invalid continuation byte`, `94774970281665330000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'data.bin\'</span><span class="token punctuation">,</span> <span class="token string">\'r\'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>\n   data <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nUnicodeDecodeError<span class="token punctuation">:</span> <span class="token string">\'utf-8\'</span> codec can\'t decode byte <span class="token number">0xf1</span> <span class="token keyword">in</span> position <span class="token number">0</span><span class="token punctuation">:</span> invalid continuation byte</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>另一种改法是在调用 open 函数的时候，通过 encoding 参数明确指定编码标准，以确保平台特有的一些行为不会干扰代码的运行效果。例如，假设刚才写到文件里的那些二进制数据表示的是一个采用 ‘cp1252’ 标准（cp1252 是一种老式的 Windows 编码方案）来编码的字符串，则可以这样写</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="38482334847560320000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`with open(\'data.bin\', \'r\', encoding=\'cp1252\') as f:\n   data f.read()\n\nassert data == \'ioooδ\'`, `38482334847560320000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'data.bin\'</span><span class="token punctuation">,</span> <span class="token string">\'r\'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">\'cp1252\'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>\n   data f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n<span class="token keyword">assert</span> data <span class="token operator">==</span> <span class="token string">\'ioooδ\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样程序就不会出现异常了，但返回的字符串也与读取原始字节数据所返回的有很大区别。通过这个例子，我们要提醒自己注意当前操作系统默认的编码标准（可以执行 <code class="language-text">python3 -c &#39;import locale; print(locale.getpreferredencoding())&#39;</code> 命令查看），了解它与你所期望的是否一致。如果不确定，那就在调用 open 时明确指定 encoding 参数。</p>\n<h2 id="第-4-条：用支持插值的-f-string-取代-c-风格的格式字符串与-strformat-方法"><a href="#%E7%AC%AC-4-%E6%9D%A1%EF%BC%9A%E7%94%A8%E6%94%AF%E6%8C%81%E6%8F%92%E5%80%BC%E7%9A%84-f-string-%E5%8F%96%E4%BB%A3-c-%E9%A3%8E%E6%A0%BC%E7%9A%84%E6%A0%BC%E5%BC%8F%E5%AD%97%E7%AC%A6%E4%B8%B2%E4%B8%8E-strformat-%E6%96%B9%E6%B3%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 4 条：用支持插值的 f-string 取代 C 风格的格式字符串与 str.format 方法</h2>\n<p>Python 里面最常用的字符串格式化方式是采用 % 格式化操作符。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="27949916045442392000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`a = 0b10111011\nb = 0xc5f\nprint(\'Binary is %d, hex is %d\' % (a, b))\n\n>>>\nBinary is 187, hex is 3167`, `27949916045442392000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">a <span class="token operator">=</span> <span class="token number">0b10111011</span>\nb <span class="token operator">=</span> <span class="token number">0xc5f</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Binary is %d, hex is %d\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nBinary <span class="token keyword">is</span> <span class="token number">187</span><span class="token punctuation">,</span> <span class="token builtin">hex</span> <span class="token keyword">is</span> <span class="token number">3167</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>但是 C 风格的格式字符串，在 Python 里有四个缺点。</p>\n<ol>\n<li>\n<p>如果 % 右侧那个元组里面的值在类型或顺序上有变化，那么程序可能会因为转换类型时发生不兼容问题而出现错误。例如，下面这个简单的格式化表达式是正确的。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="91851759176440450000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`key = \'my_var\'\nvalue = 1.234\nformatted = \'%-10s = %.2f\' % (key, value)\nprint(formatted)\n\n>>>\nmy_var     = 1.23`, `91851759176440450000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">key <span class="token operator">=</span> <span class="token string">\'my_var\'</span>\nvalue <span class="token operator">=</span> <span class="token number">1.234</span>\nformatted <span class="token operator">=</span> <span class="token string">\'%-10s = %.2f\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>formatted<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nmy_var     <span class="token operator">=</span> <span class="token number">1.23</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>但如果把 key 跟 value 互换位置，那么程序就会在运行时出现异常。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="57998465710077166000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`reordered_tuple = \'%-10s = %.2f\' % (value, key)\n\n>>>\nTraceback ...\nTypeError: must be real number, not str`, `57998465710077166000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">reordered_tuple <span class="token operator">=</span> <span class="token string">\'%-10s = %.2f\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>value<span class="token punctuation">,</span> key<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nTypeError<span class="token punctuation">:</span> must be real number<span class="token punctuation">,</span> <span class="token keyword">not</span> <span class="token builtin">str</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果 % 右侧的写法不变，但左侧那个格式字符串里面的两个说明符对调了顺序，那么程序同样会发生这个错误。</p>\n</li>\n<li>\n<p>在填充模板之前，经常要先对准备填写进去的这个值稍微做一些处理，但这样一来，整个表达式可能就会写得很长，让人觉得比较混乱。下面这段代码用来罗列厨房里的各种食材，现在的这种写法并没有对填入格式字符串里面的那三个值（也就是食材的编号 i、食材的名称 item，以及食材的数量 count）预先做出调整。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="404636323146845250"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`pantry = [\n  (\'avocados\', 1.25),\n  (\'bananas\', 2.5),\n  (\'cherries\', 15),\n]\n\nfor i, (item, count) in enumerate(pantry):\n  print(\'#%d: %-10s = %.2f\' % (i, item, count))\n\n>>>\n#0: avocados   = 1.25\n#1: bananas    = 2.50\n#2: cherries   = 15.00`, `404636323146845250`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">pantry <span class="token operator">=</span> <span class="token punctuation">[</span>\n  <span class="token punctuation">(</span><span class="token string">\'avocados\'</span><span class="token punctuation">,</span> <span class="token number">1.25</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n  <span class="token punctuation">(</span><span class="token string">\'bananas\'</span><span class="token punctuation">,</span> <span class="token number">2.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n  <span class="token punctuation">(</span><span class="token string">\'cherries\'</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n<span class="token punctuation">]</span>\n\n<span class="token keyword">for</span> i<span class="token punctuation">,</span> <span class="token punctuation">(</span>item<span class="token punctuation">,</span> count<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>pantry<span class="token punctuation">)</span><span class="token punctuation">:</span>\n  <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'#%d: %-10s = %.2f\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>i<span class="token punctuation">,</span> item<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token comment">#0: avocados   = 1.25</span>\n<span class="token comment">#1: bananas    = 2.50</span>\n<span class="token comment">#2: cherries   = 15.00</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果想让打印出来的信息更好懂，那可能得把这几个值稍微调整一下，但是调整之后，% 操作符右侧的那个三元组就特别长，所以需要多行拆分才能写得下，这会影响程序的可读性。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="42666542480845340000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`pantry = [\n  (\'avocados\', 1.25),\n  (\'bananas\', 2.5),\n  (\'cherries\', 15),\n]\n\nfor i, (item, count) in enumerate(pantry):\n  print(\'#%d: %-10s = %d\' % (\n     i + 1,\n     item.title(),\n     round(count)))\n\n>>>\n#1: Avocados   = 1\n#2: Bananas    = 2\n#3: Cherries   = 15`, `42666542480845340000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">pantry <span class="token operator">=</span> <span class="token punctuation">[</span>\n  <span class="token punctuation">(</span><span class="token string">\'avocados\'</span><span class="token punctuation">,</span> <span class="token number">1.25</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n  <span class="token punctuation">(</span><span class="token string">\'bananas\'</span><span class="token punctuation">,</span> <span class="token number">2.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n  <span class="token punctuation">(</span><span class="token string">\'cherries\'</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n<span class="token punctuation">]</span>\n\n<span class="token keyword">for</span> i<span class="token punctuation">,</span> <span class="token punctuation">(</span>item<span class="token punctuation">,</span> count<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>pantry<span class="token punctuation">)</span><span class="token punctuation">:</span>\n  <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'#%d: %-10s = %d\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>\n     i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>\n     item<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n     <span class="token builtin">round</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token comment">#1: Avocados   = 1</span>\n<span class="token comment">#2: Bananas    = 2</span>\n<span class="token comment">#3: Cherries   = 15</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n<li>\n<p>如果想用同一个值来填充格式字符串里的多个位置，那么必须在 % 操作符右侧的元组中相应地多次重复该值。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="9489710397098117000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`template = \'%s loves food. See %s cook.\'\nname = \'Max\'\nformatted = template % (name, name)\nprint(formatted)\n\n>>>\nMax loves food. See Max cook.`, `9489710397098117000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">template <span class="token operator">=</span> <span class="token string">\'%s loves food. See %s cook.\'</span>\nname <span class="token operator">=</span> <span class="token string">\'Max\'</span>\nformatted <span class="token operator">=</span> template <span class="token operator">%</span> <span class="token punctuation">(</span>name<span class="token punctuation">,</span> name<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>formatted<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nMax loves food<span class="token punctuation">.</span> See Max cook<span class="token punctuation">.</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果想在填充之前把这个值修改一下，那么必须同时修改多处才行，这尤其烦人，且容易出错。例如，如果这次要填的不是 name 而是 name.title()，那就必须提醒自己，要把所有的 name 都改成 name.title()。若是有的地方改了，有的地方没改，那输出的信息可能就不一致了。</p>\n<p>为了解决上面提到的一些问题，Python 的 % 操作符允许我们用 dict 取代 tuple，这样的话，我们就可以让格式字符串里面的说明符与 dict 里面的键以相应的名称对应起来，例如 %(key)s 这个说明符，意思就是用字符串（s）来表示 dict 里面名为 key 的那个键所保存的值。下面通过这种办法解决刚才讲的第一个缺点，也就是 % 操作符两侧的顺序不匹配问题。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="49188581756374460000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`key = \'my_var\'\nvalue = 1.234\nold_way = \'%-10s = %.2f\' % (key, value)\n\nnew_way = \'%(key)-10s = %(value).2f\' % {\n  \'key\': key, \'value\': value}  # Original\n\nreordered = \'%(key)-10s = %(value).2f\' % {\n  \'value\': value, \'key\': key}  # Swapped\n\nassert old_way == new_way == reordered`, `49188581756374460000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">key <span class="token operator">=</span> <span class="token string">\'my_var\'</span>\nvalue <span class="token operator">=</span> <span class="token number">1.234</span>\nold_way <span class="token operator">=</span> <span class="token string">\'%-10s = %.2f\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n\nnew_way <span class="token operator">=</span> <span class="token string">\'%(key)-10s = %(value).2f\'</span> <span class="token operator">%</span> <span class="token punctuation">{</span>\n  <span class="token string">\'key\'</span><span class="token punctuation">:</span> key<span class="token punctuation">,</span> <span class="token string">\'value\'</span><span class="token punctuation">:</span> value<span class="token punctuation">}</span>  <span class="token comment"># Original</span>\n\nreordered <span class="token operator">=</span> <span class="token string">\'%(key)-10s = %(value).2f\'</span> <span class="token operator">%</span> <span class="token punctuation">{</span>\n  <span class="token string">\'value\'</span><span class="token punctuation">:</span> value<span class="token punctuation">,</span> <span class="token string">\'key\'</span><span class="token punctuation">:</span> key<span class="token punctuation">}</span>  <span class="token comment"># Swapped</span>\n\n<span class="token keyword">assert</span> old_way <span class="token operator">==</span> new_way <span class="token operator">==</span> reordered</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这种写法还可以解决刚才讲的第三个缺点，也就是用同一个值替换多个格式说明符的问题。改用这种写法之后，我们就不用在 % 操作符右侧重复这个值了。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="37693977280997835000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`name = \'Max\'\ntemplate = \'%s loves food .See %s cook.\'\nbefore = template % (name, name)  # Tuple\ntemplate = \'%(name)s loves food .See %(name)s cook.\'\nafter = template % {\'name\': name}  # Dictionary\nassert before == after`, `37693977280997835000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">name <span class="token operator">=</span> <span class="token string">\'Max\'</span>\ntemplate <span class="token operator">=</span> <span class="token string">\'%s loves food .See %s cook.\'</span>\nbefore <span class="token operator">=</span> template <span class="token operator">%</span> <span class="token punctuation">(</span>name<span class="token punctuation">,</span> name<span class="token punctuation">)</span>  <span class="token comment"># Tuple</span>\ntemplate <span class="token operator">=</span> <span class="token string">\'%(name)s loves food .See %(name)s cook.\'</span>\nafter <span class="token operator">=</span> template <span class="token operator">%</span> <span class="token punctuation">{</span><span class="token string">\'name\'</span><span class="token punctuation">:</span> name<span class="token punctuation">}</span>  <span class="token comment"># Dictionary</span>\n<span class="token keyword">assert</span> before <span class="token operator">==</span> after</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>但是，这种写法会让刚才讲的第二个缺点变得更加严重，因为字典格式字符串的引入，我们必须给每一个值都定义键名，而且要在键名的右侧加冒号，格式化表达式变得更加冗长，看起来也更加混乱。我们把不采用 dict 的写法与采用 dict 的写法对比一下，可以更明确地意识到这种写法的缺点。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="43302029005748470000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`pantry = [\n(\'avocados\', 1.25),\n(\'bananas\', 2.5),\n(\'cherries\', 15),\n]\n\nfor i, (item, count) in enumerate(pantry):\n  before = \'#%d: %-10s = %d\' % (\n     i + 1,\n     item.title(),\n     round(count)\n  )\n  after = \'#%(loop)d: %(item)-10s = %(count)d\' % {\n     \'loop\': i + 1,\n     \'item\': item.title(),\n     \'count\': round(count),\n  }\n\n  assert before == after`, `43302029005748470000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">pantry <span class="token operator">=</span> <span class="token punctuation">[</span>\n<span class="token punctuation">(</span><span class="token string">\'avocados\'</span><span class="token punctuation">,</span> <span class="token number">1.25</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n<span class="token punctuation">(</span><span class="token string">\'bananas\'</span><span class="token punctuation">,</span> <span class="token number">2.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n<span class="token punctuation">(</span><span class="token string">\'cherries\'</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n<span class="token punctuation">]</span>\n\n<span class="token keyword">for</span> i<span class="token punctuation">,</span> <span class="token punctuation">(</span>item<span class="token punctuation">,</span> count<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>pantry<span class="token punctuation">)</span><span class="token punctuation">:</span>\n  before <span class="token operator">=</span> <span class="token string">\'#%d: %-10s = %d\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>\n     i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>\n     item<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n     <span class="token builtin">round</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span>\n  <span class="token punctuation">)</span>\n  after <span class="token operator">=</span> <span class="token string">\'#%(loop)d: %(item)-10s = %(count)d\'</span> <span class="token operator">%</span> <span class="token punctuation">{</span>\n     <span class="token string">\'loop\'</span><span class="token punctuation">:</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>\n     <span class="token string">\'item\'</span><span class="token punctuation">:</span> item<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n     <span class="token string">\'count\'</span><span class="token punctuation">:</span> <span class="token builtin">round</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">,</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">assert</span> before <span class="token operator">==</span> after</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n<li>\n<p>把 dict 写到格式化表达式里面会让代码变多。每个键都至少要写两次：一次是在格式说明符中，还有一次是在字典中作为键，另外，定义字典的时候，可能还要专门用一个变量来表示这个键所对应的值，而且这个变量的名称或许也和键名相同，这样算下来就是三次了。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="52296348362405420000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`soup = \'lentil\'\nformatted = \'Today\\\'s soup is %(soup)s.\' % {\'soup\': soup}\nprint(formatted)\n\n>>>\nToday\'s soup is lentil.`, `52296348362405420000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">soup <span class="token operator">=</span> <span class="token string">\'lentil\'</span>\nformatted <span class="token operator">=</span> <span class="token string">\'Today\\\'s soup is %(soup)s.\'</span> <span class="token operator">%</span> <span class="token punctuation">{</span><span class="token string">\'soup\'</span><span class="token punctuation">:</span> soup<span class="token punctuation">}</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>formatted<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nToday\'s soup <span class="token keyword">is</span> lentil<span class="token punctuation">.</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>除了要反复写键名，在格式化表达式里面使用 dict 的办法还会让表达式变得特别长，通常必须拆分为多行来写，同时，为了与格式字符串的多行写法相对应，定义字典的时候，也要一行一行地给每个键设定对应的值。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="28648683132481610000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`menu = {\n\'soup\': \'lentil\',\n\'oyster\': \'kumamoto\',\n\'special\': \'schnitzel\',\n}\n\ntemplate = (\'Today\\\'s soup is %(soup)s, \'\n           \'buy one get two %(oyster)s oysters, \'\n           \'and our special entree is %(special)s.\')\nformatted = template % menu\nprint(formatted)\n\n>>>\nToday\'s soup is lentil, buy one get two kumamoto oysters, and our special entree is schnitzel.`, `28648683132481610000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">menu <span class="token operator">=</span> <span class="token punctuation">{</span>\n<span class="token string">\'soup\'</span><span class="token punctuation">:</span> <span class="token string">\'lentil\'</span><span class="token punctuation">,</span>\n<span class="token string">\'oyster\'</span><span class="token punctuation">:</span> <span class="token string">\'kumamoto\'</span><span class="token punctuation">,</span>\n<span class="token string">\'special\'</span><span class="token punctuation">:</span> <span class="token string">\'schnitzel\'</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\n\ntemplate <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">\'Today\\\'s soup is %(soup)s, \'</span>\n           <span class="token string">\'buy one get two %(oyster)s oysters, \'</span>\n           <span class="token string">\'and our special entree is %(special)s.\'</span><span class="token punctuation">)</span>\nformatted <span class="token operator">=</span> template <span class="token operator">%</span> menu\n<span class="token keyword">print</span><span class="token punctuation">(</span>formatted<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nToday\'s soup <span class="token keyword">is</span> lentil<span class="token punctuation">,</span> buy one get two kumamoto oysters<span class="token punctuation">,</span> <span class="token keyword">and</span> our special entree <span class="token keyword">is</span> schnitzel<span class="token punctuation">.</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>为了查看格式字符串中的说明符究竟对应于字典里的哪个键，必须在这两段代码之间来回跳跃，这会令人难以发现其中的 bug。如果要对键名稍做修改，那么必须同步修改格式字符串里的说明符，这更让代码变得相当烦琐，可读性更差。</p>\n</li>\n</ol>\n<h3 id="内置的-format-函数与-str-类的-format-方法"><a href="#%E5%86%85%E7%BD%AE%E7%9A%84-format-%E5%87%BD%E6%95%B0%E4%B8%8E-str-%E7%B1%BB%E7%9A%84-format-%E6%96%B9%E6%B3%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>内置的 format 函数与 str 类的 format 方法</h3>\n<p>Python 3 添加了高级字符串格式化（advanced string formatting）机制，它的表达能力比老式 C 风格的格式字符串要强，且不再使用 % 操作符。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="16438228958787815000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`a = 1234.5678\nformatted = format(a, \',.2f\')\nprint(formatted)\nb = \'my string\'\nformatted = format(b, \'^20s\')\nprint(\'*\', formatted, \'*\')\n\n>>>\n1,234.57\n*      my string       *`, `16438228958787815000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">a <span class="token operator">=</span> <span class="token number">1234.5678</span>\nformatted <span class="token operator">=</span> <span class="token builtin">format</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token string">\',.2f\'</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>formatted<span class="token punctuation">)</span>\nb <span class="token operator">=</span> <span class="token string">\'my string\'</span>\nformatted <span class="token operator">=</span> <span class="token builtin">format</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> <span class="token string">\'^20s\'</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'*\'</span><span class="token punctuation">,</span> formatted<span class="token punctuation">,</span> <span class="token string">\'*\'</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token number">1</span><span class="token punctuation">,</span><span class="token number">234.57</span>\n<span class="token operator">*</span>      my string       <span class="token operator">*</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="50194521334018450000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`key = \'my_var\'\nvalue = 1.234\n\nformatted = \'{} = {}\'.format(key, value)\nprint(formatted)\n\n>>>\nmy_var = 1.234`, `50194521334018450000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">key <span class="token operator">=</span> <span class="token string">\'my_var\'</span>\nvalue <span class="token operator">=</span> <span class="token number">1.234</span>\n\nformatted <span class="token operator">=</span> <span class="token string">\'{} = {}\'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>formatted<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nmy_var <span class="token operator">=</span> <span class="token number">1.234</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>你可以在 {} 里写个冒号，然后把格式说明符写在冒号的右边，用以规定 format 方法所接收的这个值应该按照怎样的格式来调整。在 Python 解释器里输入 help(‘FORMATTING’)，可以详细查看 str.format 使用的这套格式说明符所依据的规则。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="285736544508274900"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`key = \'my_var\'\nvalue = 1.234\n\nformatted = \'{:<10} = {:.2f}\'.format(key, value)\nprint(formatted)\n\n>>>\nmy_var     = 1.23`, `285736544508274900`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">key <span class="token operator">=</span> <span class="token string">\'my_var\'</span>\nvalue <span class="token operator">=</span> <span class="token number">1.234</span>\n\nformatted <span class="token operator">=</span> <span class="token string">\'{:&lt;10} = {:.2f}\'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>formatted<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nmy_var     <span class="token operator">=</span> <span class="token number">1.23</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>运行过程：系统先把 str.format 方法接收到的每个值传给内置的 format 函数，并找到这个值在字符串里对应的 {}，同时将 {} 里面写的格式也传给 format 函数，例如系统在处理 value 的时候，传的就是 format(value, ‘.2f’)。然后，系统会把 format 函数所返回的结果写在整个格式化字符串 {} 所在的位置。另外，每个类都可以通过 <code class="language-text">__format__</code> 这个特殊的方法定制相应的逻辑，这样的话，format 函数在把该类实例转换成字符串时，就会按照这种逻辑来转换。</p>\n<p>C 风格的格式字符串采用 % 操作符来引导格式说明符，所以如果要将这个符号照原样输出，那就必须转义，也就是连写两个 %。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="6470113137401734000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`print(\'%.2f%%\' % 12.5)\nprint(\'{} replaces {{}}\'.format(1.23))\n\n>>>\n12.50%\n1.23 replaces {}`, `6470113137401734000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'%.2f%%\'</span> <span class="token operator">%</span> <span class="token number">12.5</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'{} replaces {{}}\'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token number">1.23</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token number">12.50</span><span class="token operator">%</span>\n<span class="token number">1.23</span> replaces <span class="token punctuation">{</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>调用 str.format 方法的时候，也可以给 str 的 {} 里面写上数字，用来指代 format 方法在这个位置所接收到的参数值位置索引。以后即使这些 {} 在格式字符串中的次序有所变动，也不用调换传给 format 方法的那些参数。于是，这就避免了前面讲的第一个缺点所提到的那个顺序问题。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="22677465676587150000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`key = \'my_var\'\nvalue = 1.234\n\nformatted = \'{1} = {0}\'.format(key, value)\nprint(formatted)\n\n>>>\n1.234 = my_var`, `22677465676587150000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">key <span class="token operator">=</span> <span class="token string">\'my_var\'</span>\nvalue <span class="token operator">=</span> <span class="token number">1.234</span>\n\nformatted <span class="token operator">=</span> <span class="token string">\'{1} = {0}\'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>formatted<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token number">1.234</span> <span class="token operator">=</span> my_var</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>同一个位置索引可以出现在 str 的多个 {} 里面，这些 {} 指代的都是 format 方法在对应位置所收到的值。这就不需要把这个值重复地传给 format 方法，于是就解决了前面提到的第三个缺点。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="91511258152334720000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`name = \'Max\'\nformatted = \'{0} loves food. See {0} cook.\'.format(name)\nprint(formatted)\n\n>>>\nMax loves food. See Max cook.`, `91511258152334720000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">name <span class="token operator">=</span> <span class="token string">\'Max\'</span>\nformatted <span class="token operator">=</span> <span class="token string">\'{0} loves food. See {0} cook.\'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>formatted<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nMax loves food<span class="token punctuation">.</span> See Max cook<span class="token punctuation">.</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然而，这个新的 str.format 方法并没有解决上面讲的第二个缺点。如果在对值做填充之前要先对这个值做出调整，那么用这种方法写出来的代码还是跟原来一样乱，阅读性差。把原来那种写法和现在的新写法对比一下，大家就会看到新写法并不比原来好多少。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="82229660299236260000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`pantry = [\n    (\'avocados\', 1.25),\n    (\'bananas\', 2.5),\n    (\'cherries\', 15),\n]\n\nfor i, (item, count) in enumerate(pantry):\n    old_style = \'#%d: %-10s = %d\' % (\n        i + 1,\n        item.title(),\n        round(count))\n    new_style = \'#{}: {:<10s} = {}\'.format(\n        i + 1,\n        item.title(),\n        round(count))\n    assert old_style == new_style`, `82229660299236260000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">pantry <span class="token operator">=</span> <span class="token punctuation">[</span>\n    <span class="token punctuation">(</span><span class="token string">\'avocados\'</span><span class="token punctuation">,</span> <span class="token number">1.25</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token punctuation">(</span><span class="token string">\'bananas\'</span><span class="token punctuation">,</span> <span class="token number">2.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token punctuation">(</span><span class="token string">\'cherries\'</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n<span class="token punctuation">]</span>\n\n<span class="token keyword">for</span> i<span class="token punctuation">,</span> <span class="token punctuation">(</span>item<span class="token punctuation">,</span> count<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>pantry<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    old_style <span class="token operator">=</span> <span class="token string">\'#%d: %-10s = %d\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>\n        i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>\n        item<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n        <span class="token builtin">round</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">)</span>\n    new_style <span class="token operator">=</span> <span class="token string">\'#{}: {:&lt;10s} = {}\'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>\n        i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>\n        item<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n        <span class="token builtin">round</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">)</span>\n    <span class="token keyword">assert</span> old_style <span class="token operator">==</span> new_style</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>当然，这种 {} 形式的说明符，还支持一些比较高级的用法，例如可以查询 dict 中某个键的值，可以访问 list 里某个位置的元素，还可以把值转化成 Unicode 或 repr 字符串。下面这段代码把这三项特性结合了起来。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="34767430384170738000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`menu = {\n    \'soup\': \'lentil\',\n    \'oyster\': \'kumamoto\',\n    \'special\': \'schnitzel\',\n}\n\nformatted = \'First letter is {menu[oyster][0]!r}\'.format(\n    menu=menu)\nprint(formatted)\n\n>>>\nFirst letter is \'k\'`, `34767430384170738000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">menu <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token string">\'soup\'</span><span class="token punctuation">:</span> <span class="token string">\'lentil\'</span><span class="token punctuation">,</span>\n    <span class="token string">\'oyster\'</span><span class="token punctuation">:</span> <span class="token string">\'kumamoto\'</span><span class="token punctuation">,</span>\n    <span class="token string">\'special\'</span><span class="token punctuation">:</span> <span class="token string">\'schnitzel\'</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\n\nformatted <span class="token operator">=</span> <span class="token string">\'First letter is {menu[oyster][0]!r}\'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>\n    menu<span class="token operator">=</span>menu<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>formatted<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nFirst letter <span class="token keyword">is</span> <span class="token string">\'k\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>但是这些特性，依然不能解决前面提到的第四个缺点，也就是键名需要多次重复的那个问题。下面把 C 风格的格式化表达式与新的 str.format 方法对比一下，看看这两种写法在处理键值对形式的数据时有什么区别。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="68121625979785440000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`old_template = (\n    \'Today\\\'s soup is %(soup)s, \'\n    \'buy one get two %(oyster)s oysters, \'\n    \'and our special entree is %(special)s.\')\nold_formatted = old_template % {\n    \'soup\': \'lentil\',\n    \'oyster\': \'kumamoto\',\n    \'special\': \'schnitzel\',\n}\n\nnew_template = (\n    \'Today\\\'s soup is {soup}, \'\n    \'buy one get two {oyster} oysters, \'\n    \'and our special entree is {special}.\')\nnew_formatted = new_template.format(\n    soup=\'lentil\',\n    oyster=\'kumamoto\',\n    special=\'schnitzel\',\n)\n\nassert old_formatted == new_formatted`, `68121625979785440000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">old_template <span class="token operator">=</span> <span class="token punctuation">(</span>\n    <span class="token string">\'Today\\\'s soup is %(soup)s, \'</span>\n    <span class="token string">\'buy one get two %(oyster)s oysters, \'</span>\n    <span class="token string">\'and our special entree is %(special)s.\'</span><span class="token punctuation">)</span>\nold_formatted <span class="token operator">=</span> old_template <span class="token operator">%</span> <span class="token punctuation">{</span>\n    <span class="token string">\'soup\'</span><span class="token punctuation">:</span> <span class="token string">\'lentil\'</span><span class="token punctuation">,</span>\n    <span class="token string">\'oyster\'</span><span class="token punctuation">:</span> <span class="token string">\'kumamoto\'</span><span class="token punctuation">,</span>\n    <span class="token string">\'special\'</span><span class="token punctuation">:</span> <span class="token string">\'schnitzel\'</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\n\nnew_template <span class="token operator">=</span> <span class="token punctuation">(</span>\n    <span class="token string">\'Today\\\'s soup is {soup}, \'</span>\n    <span class="token string">\'buy one get two {oyster} oysters, \'</span>\n    <span class="token string">\'and our special entree is {special}.\'</span><span class="token punctuation">)</span>\nnew_formatted <span class="token operator">=</span> new_template<span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>\n    soup<span class="token operator">=</span><span class="token string">\'lentil\'</span><span class="token punctuation">,</span>\n    oyster<span class="token operator">=</span><span class="token string">\'kumamoto\'</span><span class="token punctuation">,</span>\n    special<span class="token operator">=</span><span class="token string">\'schnitzel\'</span><span class="token punctuation">,</span>\n<span class="token punctuation">)</span>\n\n<span class="token keyword">assert</span> old_formatted <span class="token operator">==</span> new_formatted</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>新写法稍微好一点儿，因为它不用定义 dict 了，所以不需要把键名用 <code class="language-text">&#39; &#39;</code> 给括起来。它的说明符也比旧写法的说明符要简单一些。然而这些优点并不突出。另外，虽然我们在新写法里面，可以访问字典中的键，也可以访问列表中的元素，但这些功能只涵盖了 Python 表达式的一小部分特性，str.format 方法还是没有能够把 Python 表达式的优势充分发挥出来。</p>\n<h3 id="插值格式字符串"><a href="#%E6%8F%92%E5%80%BC%E6%A0%BC%E5%BC%8F%E5%AD%97%E7%AC%A6%E4%B8%B2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>插值格式字符串</h3>\n<p>Python 3.6 添加了一种新的特性，叫作插值格式字符串（interpolatedformat string，简称 f-string），可以解决上面提到的所有问题。新语法特性要求在格式字符串的前面加字母 f 作为前缀，这跟字母 b 与字母 r 的用法类似，也就是分别表示字节形式的字符串与原始的（或者说未经转义的）字符串的前缀。</p>\n<p>f-string 把格式字符串的表达能力发挥到了极致，它彻底解决了上文提到的第四个缺点，也就是键名重复导致的程序冗余问题。我们不用再像使用 C 风格格式表达式时那样专门定义 dict，也不用再像调用 str.format 方法时那样专门把值传给某个参数，这次可以直接在 f-string 的 {} 里面引用当前 Python 范围内的所有名称，进而达到简化的目的。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="79181819177677000000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`key = \'my_var\'\nvalue = 1.234\n\nformatted = f\'{key} = {value}\'\nprint(formatted)\n\n>>>\nmy_var = 1.234`, `79181819177677000000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">key <span class="token operator">=</span> <span class="token string">\'my_var\'</span>\nvalue <span class="token operator">=</span> <span class="token number">1.234</span>\n\nformatted <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>key<span class="token punctuation">}</span></span><span class="token string"> = </span><span class="token interpolation"><span class="token punctuation">{</span>value<span class="token punctuation">}</span></span><span class="token string">\'</span></span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>formatted<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nmy_var <span class="token operator">=</span> <span class="token number">1.234</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>str.format 方法所支持的那套迷你语言，也就是在 {} 内的冒号右侧所采用的那套规则，现在也可以用到 f-string 里面，而且还可以像早前使用 str.format 时那样，通过 ! 符号把值转化成 Unicode 及 repr 形式的字符串。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="80583825205202270000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`key = \'my_var\'\nvalue = 1.234\n\nformatted = f\'{key!r:<10} = {value:.2f}\'\nprint(formatted)\n\n>>>\n\'my_var\'   = 1.23`, `80583825205202270000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">key <span class="token operator">=</span> <span class="token string">\'my_var\'</span>\nvalue <span class="token operator">=</span> <span class="token number">1.234</span>\n\nformatted <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>key<span class="token conversion-option punctuation">!r</span><span class="token punctuation">:</span><span class="token format-spec">&lt;10</span><span class="token punctuation">}</span></span><span class="token string"> = </span><span class="token interpolation"><span class="token punctuation">{</span>value<span class="token punctuation">:</span><span class="token format-spec">.2f</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>formatted<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token string">\'my_var\'</span>   <span class="token operator">=</span> <span class="token number">1.23</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>同一个问题，使用 f-string 来解决总是比通过 % 操作符使用 C 风格的格式字符串简单，而且也比 str.format 方法简单。下面按照从短到长的顺序把这几种写法所占的篇幅对比一下，每种写法里面的那个赋值符号（=）左侧都对齐到同一个位置，这样很容易看出符号右边的代码到底有多少。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="72825494798409810000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`key = \'my_var\'\nvalue = 1.234\n\nf_string = f\'{key:<10} = {value:.2f}\'\nc_tuple = \'%-10s = %.2f\' % (key, value)\nstr_args = \'{:<10} = {:.2f}\'.format(key, value)\nstr_kw = \'{key:<10} = {value:.2f}\'.format(key=key,\n                                          value=value)\nc_dict = \'%(key)-10s = %(value).2f\' % {\'key\': key,\n                                       \'value\': value}\nassert c_tuple == c_dict == f_string\nassert str_args == str_kw == f_string`, `72825494798409810000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">key <span class="token operator">=</span> <span class="token string">\'my_var\'</span>\nvalue <span class="token operator">=</span> <span class="token number">1.234</span>\n\nf_string <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>key<span class="token punctuation">:</span><span class="token format-spec">&lt;10</span><span class="token punctuation">}</span></span><span class="token string"> = </span><span class="token interpolation"><span class="token punctuation">{</span>value<span class="token punctuation">:</span><span class="token format-spec">.2f</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span>\nc_tuple <span class="token operator">=</span> <span class="token string">\'%-10s = %.2f\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\nstr_args <span class="token operator">=</span> <span class="token string">\'{:&lt;10} = {:.2f}\'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\nstr_kw <span class="token operator">=</span> <span class="token string">\'{key:&lt;10} = {value:.2f}\'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>key<span class="token operator">=</span>key<span class="token punctuation">,</span>\n                                          value<span class="token operator">=</span>value<span class="token punctuation">)</span>\nc_dict <span class="token operator">=</span> <span class="token string">\'%(key)-10s = %(value).2f\'</span> <span class="token operator">%</span> <span class="token punctuation">{</span><span class="token string">\'key\'</span><span class="token punctuation">:</span> key<span class="token punctuation">,</span>\n                                       <span class="token string">\'value\'</span><span class="token punctuation">:</span> value<span class="token punctuation">}</span>\n<span class="token keyword">assert</span> c_tuple <span class="token operator">==</span> c_dict <span class="token operator">==</span> f_string\n<span class="token keyword">assert</span> str_args <span class="token operator">==</span> str_kw <span class="token operator">==</span> f_string</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在 f-string 方法中，各种 Python 表达式都可以出现在 {} 里，于是这就解决了前面提到的第二个缺点。我们现在可以用相当简洁的写法对需要填充到字符串里面的值做出微调。C 风格的写法与采用 str.format 方法的写法可能会让表达式变得很长，但如果改用 f-string，或许一行就能写完。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="43380290369220130000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`pantry = [\n    (\'avocados\', 1.25),\n    (\'bananas\', 2.5),\n    (\'cherries\', 15),\n]\n\nfor i, (item, count) in enumerate(pantry):\n    old_style = \'#%d: %-10s = %d\' % (\n        i + 1,\n        item.title(),\n        round(count))\n    new_style = \'#{}: {:<10s} = {}\'.format(\n        i + 1,\n        item.title(),\n        round(count))\n    f_string = f\'#{i + 1}: {item.title():<10s} = {round(count)}\'\n    assert old_style == new_style == f_string`, `43380290369220130000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">pantry <span class="token operator">=</span> <span class="token punctuation">[</span>\n    <span class="token punctuation">(</span><span class="token string">\'avocados\'</span><span class="token punctuation">,</span> <span class="token number">1.25</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token punctuation">(</span><span class="token string">\'bananas\'</span><span class="token punctuation">,</span> <span class="token number">2.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token punctuation">(</span><span class="token string">\'cherries\'</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n<span class="token punctuation">]</span>\n\n<span class="token keyword">for</span> i<span class="token punctuation">,</span> <span class="token punctuation">(</span>item<span class="token punctuation">,</span> count<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>pantry<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    old_style <span class="token operator">=</span> <span class="token string">\'#%d: %-10s = %d\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>\n        i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>\n        item<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n        <span class="token builtin">round</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">)</span>\n    new_style <span class="token operator">=</span> <span class="token string">\'#{}: {:&lt;10s} = {}\'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>\n        i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>\n        item<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n        <span class="token builtin">round</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">)</span>\n    f_string <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f\'#</span><span class="token interpolation"><span class="token punctuation">{</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{</span>item<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token format-spec">&lt;10s</span><span class="token punctuation">}</span></span><span class="token string"> = </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">round</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span>\n    <span class="token keyword">assert</span> old_style <span class="token operator">==</span> new_style <span class="token operator">==</span> f_string</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>要是想表达得更清楚一些，可以把 f-string 写成多行的形式，类似于 C 语言的相邻字符串拼接（adjacent-string concatenation）。这样写虽然比单行的 f-string 要长，但仍然好过另外那两种多行的写法。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="38090857164044345000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`pantry = [\n    (\'avocados\', 1.25),\n    (\'bananas\', 2.5),\n    (\'cherries\', 15),\n]\n\nfor i, (item, count) in enumerate(pantry):\n    f_string = (\n        f\'# {i + 1}: \'\n        f\'{item.title():<10s} = \'\n        f\'{round(count)}\'\n    )\n    print(f_string)\n\n>>>\n# 1: Avocados   = 1\n# 2: Bananas    = 2\n# 3: Cherries   = 15`, `38090857164044345000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">pantry <span class="token operator">=</span> <span class="token punctuation">[</span>\n    <span class="token punctuation">(</span><span class="token string">\'avocados\'</span><span class="token punctuation">,</span> <span class="token number">1.25</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token punctuation">(</span><span class="token string">\'bananas\'</span><span class="token punctuation">,</span> <span class="token number">2.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token punctuation">(</span><span class="token string">\'cherries\'</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n<span class="token punctuation">]</span>\n\n<span class="token keyword">for</span> i<span class="token punctuation">,</span> <span class="token punctuation">(</span>item<span class="token punctuation">,</span> count<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>pantry<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    f_string <span class="token operator">=</span> <span class="token punctuation">(</span>\n        <span class="token string-interpolation"><span class="token string">f\'# </span><span class="token interpolation"><span class="token punctuation">{</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">}</span></span><span class="token string">: \'</span></span>\n        <span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>item<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token format-spec">&lt;10s</span><span class="token punctuation">}</span></span><span class="token string"> = \'</span></span>\n        <span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">round</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span>\n    <span class="token punctuation">)</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span>f_string<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token comment"># 1: Avocados   = 1</span>\n<span class="token comment"># 2: Bananas    = 2</span>\n<span class="token comment"># 3: Cherries   = 15</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Python 表达式也可以出现在格式说明符中。例如，下面的代码把小数点之后的位数用变量来表示，然后把这个变量的名字 places 用 {} 括起来放到格式说明符中，这样写比采用硬代码更灵活。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="197457277666979170"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`places = 3\nnumber = 1.23456\nprint(f\'My number is {number:.{places}f}\')\n\n>>>\nMy number is 1.235`, `197457277666979170`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">places <span class="token operator">=</span> <span class="token number">3</span>\nnumber <span class="token operator">=</span> <span class="token number">1.23456</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'My number is </span><span class="token interpolation"><span class="token punctuation">{</span>number<span class="token punctuation">:</span><span class="token punctuation">.</span><span class="token punctuation">{</span>places<span class="token punctuation">}</span>f<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nMy number <span class="token keyword">is</span> <span class="token number">1.235</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在 Python 内置的四种字符串格式化办法里面，f-string 可以简洁而清晰地表达出许多种逻辑，这使它成为程序员的最佳选择。如果你想把值以适当的格式填充到字符串里面，那么首先应该考虑的就是采用 f-string 来实现。</p>\n<h3 id="总结"><a href="#%E6%80%BB%E7%BB%93" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>采用 % 操作符把值填充到 C 风格的格式字符串时会遇到许多问题，而且这种写法比较烦琐。</li>\n<li>str.format 方法专门用一套迷你语言来定义它的格式说明符，这套语言给我们提供了一些有用的概念，但是在其他方面，这个方法还是存在与 C 风格的格式字符串一样的多种缺点，所以我们也应该避免使用它。</li>\n<li>f-string 采用新的写法，将值填充到字符串之中，解决了 C 风格的格式字符串所带来的最大问题。f-string 是个简洁而强大的机制，可以直接在格式说明符里嵌入任意 Python 表达式。</li>\n</ol>\n<h2 id="第-5-条：用辅助函数取代复杂的表达式"><a href="#%E7%AC%AC-5-%E6%9D%A1%EF%BC%9A%E7%94%A8%E8%BE%85%E5%8A%A9%E5%87%BD%E6%95%B0%E5%8F%96%E4%BB%A3%E5%A4%8D%E6%9D%82%E7%9A%84%E8%A1%A8%E8%BE%BE%E5%BC%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 5 条：用辅助函数取代复杂的表达式</h2>\n<p>Python 的语法相当简明，所以有时只用一条表达式就能实现许多逻辑。例如，要把 URL 之中的查询字符串拆分成键值对，那么只需要使用 parse_qs 函数就可以了。下面的例子会解析查询字符串之中的每个参数，并把这些参数跟它们所对应的整数值放到一份字典（dict）里面。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="83252451065014680000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from urllib.parse import parse_qs\nmy_values = parse_qs(\'red=5&blue=0&green=\',\n                     keep_blank_values=True)\nprint(repr(my_values))\n\n>>>\n{\'red\': [\'5\'], \'blue\': [\'0\'], \'green\': [\'\']}`, `83252451065014680000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> urllib<span class="token punctuation">.</span>parse <span class="token keyword">import</span> parse_qs\nmy_values <span class="token operator">=</span> parse_qs<span class="token punctuation">(</span><span class="token string">\'red=5&amp;blue=0&amp;green=\'</span><span class="token punctuation">,</span>\n                     keep_blank_values<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">repr</span><span class="token punctuation">(</span>my_values<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">{</span><span class="token string">\'red\'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'5\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">\'blue\'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'0\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">\'green\'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'\'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在解析查询字符串时，可以发现，有的参数可能带有多个值，有的参数可能只有一个值，还有的参数可能是空白值，另外也会遇到根本没提供这个参数的情况。下面这三行代码分别通过 get 方法查询结果字典里面的三个参数，这刚好对应三种不同的情况：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="32973735923363877000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from urllib.parse import parse_qs\nmy_values = parse_qs(\'red=5&blue=0&green=\',\n                     keep_blank_values=True)\n\nprint(\'Red:         \', my_values.get(\'red\'))\nprint(\'Green:       \', my_values.get(\'green\'))\nprint(\'Opacity:     \', my_values.get(\'opacity\'))\n\n>>>\nRed:          [\'5\']\nGreen:        [\'\']\nOpacity:      None`, `32973735923363877000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> urllib<span class="token punctuation">.</span>parse <span class="token keyword">import</span> parse_qs\nmy_values <span class="token operator">=</span> parse_qs<span class="token punctuation">(</span><span class="token string">\'red=5&amp;blue=0&amp;green=\'</span><span class="token punctuation">,</span>\n                     keep_blank_values<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>\n\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Red:         \'</span><span class="token punctuation">,</span> my_values<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">\'red\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Green:       \'</span><span class="token punctuation">,</span> my_values<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">\'green\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Opacity:     \'</span><span class="token punctuation">,</span> my_values<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">\'opacity\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nRed<span class="token punctuation">:</span>          <span class="token punctuation">[</span><span class="token string">\'5\'</span><span class="token punctuation">]</span>\nGreen<span class="token punctuation">:</span>        <span class="token punctuation">[</span><span class="token string">\'\'</span><span class="token punctuation">]</span>\nOpacity<span class="token punctuation">:</span>      <span class="token boolean">None</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果能把参数缺失与参数为空白值这两种情况都默认当成 0，那就更好了。但这样一个小小的逻辑，似乎不值得专门写 if 语句或辅助函数，所以有人会直接用 Boolean 表达式实现。</p>\n<p>Boolean 表达式用 Python 的语法写起来很简单，因为 Python 在对这种表达式求值的时候，会把空白字符串、空白 list 以及 0 值，全都当成 False 看待。所以，只需要把 get 方法查到的结果放在 or 操作符的左边，并且在右边写上 0 就行了。这样的话，只要左边的子表达式为 False，那么整个表达式的值自然就被评估为右边那个表达式的值，也就是 0。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="31017634773718550000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from urllib.parse import parse_qs\nmy_values = parse_qs(\'red=5&blue=0&green=\',\n                     keep_blank_values=True)\n\n# For query string \'red=5&blue=0&green=\'\nred = my_values.get(\'red\', [\'\'])[0] or 0\ngreen = my_values.get(\'green\', [\'\'])[0] or 0\nopacity = my_values.get(\'opacity\', [\'\'])[0] or 0\nprint(f\'Red:     {red!r}\')\nprint(f\'Green:   {green!r}\')\nprint(f\'Opacity: {opacity!r}\')\n\n>>>\nRed:     \'5\'\nGreen:   0\nOpacity: 0`, `31017634773718550000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> urllib<span class="token punctuation">.</span>parse <span class="token keyword">import</span> parse_qs\nmy_values <span class="token operator">=</span> parse_qs<span class="token punctuation">(</span><span class="token string">\'red=5&amp;blue=0&amp;green=\'</span><span class="token punctuation">,</span>\n                     keep_blank_values<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>\n\n<span class="token comment"># For query string \'red=5&amp;blue=0&amp;green=\'</span>\nred <span class="token operator">=</span> my_values<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">\'red\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">\'\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">or</span> <span class="token number">0</span>\ngreen <span class="token operator">=</span> my_values<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">\'green\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">\'\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">or</span> <span class="token number">0</span>\nopacity <span class="token operator">=</span> my_values<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">\'opacity\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">\'\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">or</span> <span class="token number">0</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Red:     </span><span class="token interpolation"><span class="token punctuation">{</span>red<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Green:   </span><span class="token interpolation"><span class="token punctuation">{</span>green<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Opacity: </span><span class="token interpolation"><span class="token punctuation">{</span>opacity<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nRed<span class="token punctuation">:</span>     <span class="token string">\'5\'</span>\nGreen<span class="token punctuation">:</span>   <span class="token number">0</span>\nOpacity<span class="token punctuation">:</span> <span class="token number">0</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>表达式写成这样，看起来很别扭，而且它并没有完全实现我们想要的效果，因为我们还得保证解析出来的参数值是能够直接参与数学运算的整数。于是，需要通过内置的 int() 把这种表达式所解析出来的字符串转换成整数。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="7929934168957398000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`red = int(my_values.get(\'red\', [\'\'])[0] or 0)`, `7929934168957398000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">red <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>my_values<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">\'red\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">\'\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">or</span> <span class="token number">0</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>现在的代码比原来更难读了，因为看上去比原来还要乱。这种代码让人觉得很可怕：如果你是第一次阅读该代码，那必须得把整个表达式逐层拆分，才能明白这行代码的意思，这要花很长时间。代码当然应该写得短一些，但并不意味着非得挤成一行。</p>\n<p>Python 可以用 if/else 结构实现三元的条件表达式，这样写比刚才那种写法更清晰，且能保持代码简短。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="21261521645572800000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`red_str = my_values.get(\'red\', [\'\'])\nred = int(red_str[0]) if red_str[0] else 0`, `21261521645572800000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">red_str <span class="token operator">=</span> my_values<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">\'red\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">\'\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\nred <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>red_str<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">if</span> red_str<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">else</span> <span class="token number">0</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>但在我们这个例子里，这种写法还是不如完整的多行 if/else 结构好，虽然要多写几行，但非常容易看懂。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="43673411624890270000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`green_str = my_values.get(\'green\', [\'\'])\nif green_str[0]:\n    green = int(green_str[0])\nelse:\n    green = 0`, `43673411624890270000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">green_str <span class="token operator">=</span> my_values<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">\'green\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">\'\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n<span class="token keyword">if</span> green_str<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span>\n    green <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>green_str<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n<span class="token keyword">else</span><span class="token punctuation">:</span>\n    green <span class="token operator">=</span> <span class="token number">0</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果要反复使用这套逻辑，那还是写成辅助函数比较好，即使像下面这个例子一样只用两三次，也还是值得这样做。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="31803739533453480000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def get_first_int(values, key, default=0):\n    found = values.get(key, [\'\'])\n    if found[0]:\n        return int(found[0])\n    return default`, `31803739533453480000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">get_first_int</span><span class="token punctuation">(</span>values<span class="token punctuation">,</span> key<span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    found <span class="token operator">=</span> values<span class="token punctuation">.</span>get<span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">\'\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n    <span class="token keyword">if</span> found<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token builtin">int</span><span class="token punctuation">(</span>found<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n    <span class="token keyword">return</span> default</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="总结-1"><a href="#%E6%80%BB%E7%BB%93-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>Python 的语法很容易把复杂的意思挤到同一行表达式里，这样写很难懂。</li>\n<li>复杂的表达式，尤其是那种需要重复使用的复杂表达式，应该写到辅助函数里面。</li>\n<li>用 if/else 结构写成的条件表达式，要比用 or 与 and 写成的 Boolean 表达式更好懂。</li>\n</ol>\n<h2 id="第-6-条：把数据结构直接拆分到多个变量里，不要专门通过下标访问"><a href="#%E7%AC%AC-6-%E6%9D%A1%EF%BC%9A%E6%8A%8A%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E7%9B%B4%E6%8E%A5%E6%8B%86%E5%88%86%E5%88%B0%E5%A4%9A%E4%B8%AA%E5%8F%98%E9%87%8F%E9%87%8C%EF%BC%8C%E4%B8%8D%E8%A6%81%E4%B8%93%E9%97%A8%E9%80%9A%E8%BF%87%E4%B8%8B%E6%A0%87%E8%AE%BF%E9%97%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 6 条：把数据结构直接拆分到多个变量里，不要专门通过下标访问</h2>\n<p>Python 内置的元组（tuple）类型可以创建不可变的序列，把许多元素依次保存起来。最简单的用法是只用元组保存两个值，例如字典里面的键值对。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="45964020880353714000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`snack_calories = {\n    \'chips\': 140,\n    \'popcorn\': 80,\n    \'nuts\': 190,\n}\nitems = tuple(snack_calories.items())\nprint(items)\n\n>>>\n((\'chips\', 140), (\'popcorn\', 80), (\'nuts\', 190))`, `45964020880353714000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">snack_calories <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token string">\'chips\'</span><span class="token punctuation">:</span> <span class="token number">140</span><span class="token punctuation">,</span>\n    <span class="token string">\'popcorn\'</span><span class="token punctuation">:</span> <span class="token number">80</span><span class="token punctuation">,</span>\n    <span class="token string">\'nuts\'</span><span class="token punctuation">:</span> <span class="token number">190</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\nitems <span class="token operator">=</span> <span class="token builtin">tuple</span><span class="token punctuation">(</span>snack_calories<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>items<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">\'chips\'</span><span class="token punctuation">,</span> <span class="token number">140</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">\'popcorn\'</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">\'nuts\'</span><span class="token punctuation">,</span> <span class="token number">190</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们可以用整数作下标，通过下标来访问元组里面对应的元素。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="76812060228900800000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`item = (\'Peanut butter\', \'Jelly\')\nfirst = item[0]\nsecond = item[1]\nprint(first, \'and\', second)\n\n>>>\nPeanut butter and Jelly`, `76812060228900800000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">item <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">\'Peanut butter\'</span><span class="token punctuation">,</span> <span class="token string">\'Jelly\'</span><span class="token punctuation">)</span>\nfirst <span class="token operator">=</span> item<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>\nsecond <span class="token operator">=</span> item<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>first<span class="token punctuation">,</span> <span class="token string">\'and\'</span><span class="token punctuation">,</span> second<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nPeanut butter <span class="token keyword">and</span> Jelly</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>创建好 tuple 之后，就不能通过下标给其中的元素赋新值了。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="72690369707121210000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`pair = (\'Chocolate\', \'Peanut butter\')\npair[0] = \'Honey\'\n\n>>>\nTraceback ...\nTypeError: \'tuple\' object does not support item assignment`, `72690369707121210000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">pair <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">\'Chocolate\'</span><span class="token punctuation">,</span> <span class="token string">\'Peanut butter\'</span><span class="token punctuation">)</span>\npair<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">\'Honey\'</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nTypeError<span class="token punctuation">:</span> <span class="token string">\'tuple\'</span> <span class="token builtin">object</span> does <span class="token keyword">not</span> support item assignment</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Python 还有一种写法，叫作拆分（unpacking）。这种写法让我们只用一条语句，就可以把元组里面的元素分别赋给多个变量。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="95406150806852190000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`item = (\'Peanut butter\', \'Jelly\')\nfirst, second = item  # Unpacking\nprint(first, \'and\', second)\n\n>>>\nPeanut butter and Jelly`, `95406150806852190000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">item <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">\'Peanut butter\'</span><span class="token punctuation">,</span> <span class="token string">\'Jelly\'</span><span class="token punctuation">)</span>\nfirst<span class="token punctuation">,</span> second <span class="token operator">=</span> item  <span class="token comment"># Unpacking</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>first<span class="token punctuation">,</span> <span class="token string">\'and\'</span><span class="token punctuation">,</span> second<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nPeanut butter <span class="token keyword">and</span> Jelly</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>通过 unpacking 来赋值要比通过下标去访问元组内的元素更清晰，而且这种写法所需的代码量通常比较少。当然，赋值操作的左边除了可以罗列单个变量，也可以写成列表、序列或任意深度的可迭代对象（iterable）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="23135757210350130000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`favorite_snacks = {\n    \'salty\': (\'pretzels\', 100),\n    \'sweet\': (\'cookies\', 180),\n    \'veggie\': (\'carrots\', 20),\n}\n\n((type1, (name1, cals1)),\n (type2, (name2, cals2)),\n (type3, (name3, cals3))) = favorite_snacks.items()\nprint(f\'Favorite {type1} is {name1} with {cals1} calories\')\nprint(f\'Favorite {type2} is {name2} with {cals2} calories\')\nprint(f\'Favorite {type3} is {name3} with {cals3} calories\')\n\n>>>\nFavorite salty is pretzels with 100 calories\nFavorite sweet is cookies with 180 calories\nFavorite veggie is carrots with 20 calories`, `23135757210350130000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">favorite_snacks <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token string">\'salty\'</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token string">\'pretzels\'</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token string">\'sweet\'</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token string">\'cookies\'</span><span class="token punctuation">,</span> <span class="token number">180</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token string">\'veggie\'</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token string">\'carrots\'</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\n\n<span class="token punctuation">(</span><span class="token punctuation">(</span>type1<span class="token punctuation">,</span> <span class="token punctuation">(</span>name1<span class="token punctuation">,</span> cals1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n <span class="token punctuation">(</span>type2<span class="token punctuation">,</span> <span class="token punctuation">(</span>name2<span class="token punctuation">,</span> cals2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n <span class="token punctuation">(</span>type3<span class="token punctuation">,</span> <span class="token punctuation">(</span>name3<span class="token punctuation">,</span> cals3<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> favorite_snacks<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Favorite </span><span class="token interpolation"><span class="token punctuation">{</span>type1<span class="token punctuation">}</span></span><span class="token string"> is </span><span class="token interpolation"><span class="token punctuation">{</span>name1<span class="token punctuation">}</span></span><span class="token string"> with </span><span class="token interpolation"><span class="token punctuation">{</span>cals1<span class="token punctuation">}</span></span><span class="token string"> calories\'</span></span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Favorite </span><span class="token interpolation"><span class="token punctuation">{</span>type2<span class="token punctuation">}</span></span><span class="token string"> is </span><span class="token interpolation"><span class="token punctuation">{</span>name2<span class="token punctuation">}</span></span><span class="token string"> with </span><span class="token interpolation"><span class="token punctuation">{</span>cals2<span class="token punctuation">}</span></span><span class="token string"> calories\'</span></span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Favorite </span><span class="token interpolation"><span class="token punctuation">{</span>type3<span class="token punctuation">}</span></span><span class="token string"> is </span><span class="token interpolation"><span class="token punctuation">{</span>name3<span class="token punctuation">}</span></span><span class="token string"> with </span><span class="token interpolation"><span class="token punctuation">{</span>cals3<span class="token punctuation">}</span></span><span class="token string"> calories\'</span></span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nFavorite salty <span class="token keyword">is</span> pretzels <span class="token keyword">with</span> <span class="token number">100</span> calories\nFavorite sweet <span class="token keyword">is</span> cookies <span class="token keyword">with</span> <span class="token number">180</span> calories\nFavorite veggie <span class="token keyword">is</span> carrots <span class="token keyword">with</span> <span class="token number">20</span> calories</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="17108245087859997000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`snacks = [(\'bacon\', 350), (\'donut\', 240), (\'muffin\', 190)]\n\nfor rank, (name, calories) in enumerate(snacks, 1):\n    print(f\'#{rank}: {name} has {calories} calories\')\n\n>>>\n#1: bacon has 350 calories\n#2: donut has 240 calories\n#3: muffin has 190 calories`, `17108245087859997000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">snacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">\'bacon\'</span><span class="token punctuation">,</span> <span class="token number">350</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">\'donut\'</span><span class="token punctuation">,</span> <span class="token number">240</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">\'muffin\'</span><span class="token punctuation">,</span> <span class="token number">190</span><span class="token punctuation">)</span><span class="token punctuation">]</span>\n\n<span class="token keyword">for</span> rank<span class="token punctuation">,</span> <span class="token punctuation">(</span>name<span class="token punctuation">,</span> calories<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>snacks<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'#</span><span class="token interpolation"><span class="token punctuation">{</span>rank<span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token punctuation">}</span></span><span class="token string"> has </span><span class="token interpolation"><span class="token punctuation">{</span>calories<span class="token punctuation">}</span></span><span class="token string"> calories\'</span></span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token comment">#1: bacon has 350 calories</span>\n<span class="token comment">#2: donut has 240 calories</span>\n<span class="token comment">#3: muffin has 190 calories</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这才是符合 Python 风格的写法（Pythonic 式的写法），我们不需要再通过下标逐层访问了。这种写法可以节省篇幅，而且比较容易理解。</p>\n<p>Python 的 unpacking 机制可以用在许多方面，例如构建列表（参见第 13 条）、给函数设计参数列表（参见第 22 条）、传递关键字参数（参见第 23 条）、接收多个返回值（参见第 19 条）等。</p>\n<p>明智地使用 unpacking 机制，可以实现很多原来必须通过下标才能写出的功能，这让代码变得更加清晰，而且能充分发挥 Python 的优势。</p>\n<h3 id="总结-2"><a href="#%E6%80%BB%E7%BB%93-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>unpacking 是一种特殊的 Python 语法，只需要一行代码，就能把数据结构里面的多个值分别赋给相应的变量。</li>\n<li>unpacking 在 Python 中应用广泛，凡是可迭代的对象都能拆分，无论它里面还有多少层迭代结构。</li>\n<li>尽量通过 unpacking 来拆解序列之中的数据，而不要通过下标访问，这样可以让代码更简洁、更清晰。</li>\n</ol>\n<h2 id="第-7-条：尽量用-enumerate-取代-range"><a href="#%E7%AC%AC-7-%E6%9D%A1%EF%BC%9A%E5%B0%BD%E9%87%8F%E7%94%A8-enumerate-%E5%8F%96%E4%BB%A3-range" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 7 条：尽量用 enumerate 取代 range</h2>\n<p>Python 内置的 range 函数适合用来迭代一系列整数。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="638563166221395300"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from random import randint\n\nrandom_bits = 0\nfor i in range(32):\n    if randint(0, 1):\n        random_bits |= 1 << i\nprint(bin(random_bits))\n\n>>>\n0b100101010010000001011011010011`, `638563166221395300`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> random <span class="token keyword">import</span> randint\n\nrandom_bits <span class="token operator">=</span> <span class="token number">0</span>\n<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">if</span> randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        random_bits <span class="token operator">|</span><span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> i\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">bin</span><span class="token punctuation">(</span>random_bits<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token number">0b100101010010000001011011010011</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果要迭代的是某种数据结构，例如字符串列表，那么可以直接在这个序列上面迭代，用不着专门通过 range 设定一个取值范围，然后把这个范围里的每个整数值，依次当成下标来访问列表中的元素。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="88199340907165240000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`flavor_list = [\'vanilla\', \'chocolate\', \'pecan\', \'strawberry\']\n\nfor flavor in flavor_list:\n    print(f\'{flavor} is delicious\')\n\n>>>\nvanilla is delicious\nchocolate is delicious\npecan is delicious\nstrawberry is delicious`, `88199340907165240000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">flavor_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'vanilla\'</span><span class="token punctuation">,</span> <span class="token string">\'chocolate\'</span><span class="token punctuation">,</span> <span class="token string">\'pecan\'</span><span class="token punctuation">,</span> <span class="token string">\'strawberry\'</span><span class="token punctuation">]</span>\n\n<span class="token keyword">for</span> flavor <span class="token keyword">in</span> flavor_list<span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>flavor<span class="token punctuation">}</span></span><span class="token string"> is delicious\'</span></span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nvanilla <span class="token keyword">is</span> delicious\nchocolate <span class="token keyword">is</span> delicious\npecan <span class="token keyword">is</span> delicious\nstrawberry <span class="token keyword">is</span> delicious</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>当然有的时候，在迭代 list 的过程中也需要知道当前处理的这个元素在 list 里的位置。例如，我把爱吃的冰激淋口味写在 <code class="language-text">flavor_list</code> 列表里面，在打印每种口味时，我还想指出这种口味在自己心目中的排名。为了实现这样的功能，我们可以用传统的 range 方式来实现。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="24390302641808080000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`flavor_list = [\'vanilla\', \'chocolate\', \'pecan\', \'strawberry\']\n\nfor i in range(len(flavor_list)):\n    flavor = flavor_list[i]\n    print(f\'{i+1}: {flavor}\')\n\n>>>\n1: vanilla\n2: chocolate\n3: pecan\n4: strawberry`, `24390302641808080000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">flavor_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'vanilla\'</span><span class="token punctuation">,</span> <span class="token string">\'chocolate\'</span><span class="token punctuation">,</span> <span class="token string">\'pecan\'</span><span class="token punctuation">,</span> <span class="token string">\'strawberry\'</span><span class="token punctuation">]</span>\n\n<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>flavor_list<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    flavor <span class="token operator">=</span> flavor_list<span class="token punctuation">[</span>i<span class="token punctuation">]</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{</span>flavor<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token number">1</span><span class="token punctuation">:</span> vanilla\n<span class="token number">2</span><span class="token punctuation">:</span> chocolate\n<span class="token number">3</span><span class="token punctuation">:</span> pecan\n<span class="token number">4</span><span class="token punctuation">:</span> strawberry</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><code class="language-text">range(len(flavor_list))</code> 的写法太过复杂，可以用 enumerate 代替。enumerate 能够把任何一种迭代器（iterator）封装成惰性生成器（lazy generator，参见第 30 条）</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="48161415739249300000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`flavor_list = [\'vanilla\', \'chocolate\', \'pecan\', \'strawberry\']\n\nit = enumerate(flavor_list)\nprint(next(it))\nprint(next(it))\n\n>>>\n(0, \'vanilla\')\n(1, \'chocolate\')`, `48161415739249300000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">flavor_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'vanilla\'</span><span class="token punctuation">,</span> <span class="token string">\'chocolate\'</span><span class="token punctuation">,</span> <span class="token string">\'pecan\'</span><span class="token punctuation">,</span> <span class="token string">\'strawberry\'</span><span class="token punctuation">]</span>\n\nit <span class="token operator">=</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>flavor_list<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">next</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">next</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">\'vanilla\'</span><span class="token punctuation">)</span>\n<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">\'chocolate\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="56760689121674130000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`flavor_list = [\'vanilla\', \'chocolate\', \'pecan\', \'strawberry\']\n\nfor i, flavor in enumerate(flavor_list):\n    print(f\'{i + 1}: {flavor}\')\n\n>>>\n1: vanilla\n2: chocolate\n3: pecan\n4: strawberry`, `56760689121674130000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">flavor_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'vanilla\'</span><span class="token punctuation">,</span> <span class="token string">\'chocolate\'</span><span class="token punctuation">,</span> <span class="token string">\'pecan\'</span><span class="token punctuation">,</span> <span class="token string">\'strawberry\'</span><span class="token punctuation">]</span>\n\n<span class="token keyword">for</span> i<span class="token punctuation">,</span> flavor <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>flavor_list<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{</span>flavor<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token number">1</span><span class="token punctuation">:</span> vanilla\n<span class="token number">2</span><span class="token punctuation">:</span> chocolate\n<span class="token number">3</span><span class="token punctuation">:</span> pecan\n<span class="token number">4</span><span class="token punctuation">:</span> strawberry</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>另外，还可以通过 enumerate 的第二个参数指定起始序号，这样就不用在每次打印的时候去调整了。例如，本例可以从 1 开始计算。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="76522494108571370000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`for i, flavor in enumerate(flavor_list, 1):\n    print(f\'{i + 1}: {flavor}\')`, `76522494108571370000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">for</span> i<span class="token punctuation">,</span> flavor <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>flavor_list<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{</span>flavor<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<h3 id="总结-3"><a href="#%E6%80%BB%E7%BB%93-3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>enumerate 函数可以用简洁的代码迭代 iterator，而且可以指出当前这轮循环的序号。</li>\n<li>不要先通过 range 指定下标的取值范围，然后用下标去访问序列，而是应该直接用 enumerate 函数迭代。</li>\n<li>可以通过 enumerate 的第二个参数指定起始序号（默认为 0）。</li>\n</ol>\n<h2 id="第-8-条：用-zip-函数同时遍历两个迭代器"><a href="#%E7%AC%AC-8-%E6%9D%A1%EF%BC%9A%E7%94%A8-zip-%E5%87%BD%E6%95%B0%E5%90%8C%E6%97%B6%E9%81%8D%E5%8E%86%E4%B8%A4%E4%B8%AA%E8%BF%AD%E4%BB%A3%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 8 条：用 zip 函数同时遍历两个迭代器</h2>\n<p>写 Python 代码时，经常会根据某份列表中的对象创建许多与这份列表有关的新列表。下面这样的列表推导机制，可以把表达式运用到源列表的每个元素上面，从而生成一份派生列表（参见第 27 条）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="30459915329767660000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`names = [\'Cecilia\', \'Lise\', \'Marie\']\ncounts = [len(n) for n in names]\nprint(counts)\n\n>>>\n[7, 4, 5]`, `30459915329767660000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">names <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'Cecilia\'</span><span class="token punctuation">,</span> <span class="token string">\'Lise\'</span><span class="token punctuation">,</span> <span class="token string">\'Marie\'</span><span class="token punctuation">]</span>\ncounts <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token builtin">len</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token keyword">for</span> n <span class="token keyword">in</span> names<span class="token punctuation">]</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>counts<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>派生列表中的元素与源列表中对应位置上面的元素有着一定的关系。如果想同时遍历这两份列表，那可以根据源列表的长度做迭代。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="11315101986174403000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`names = [\'Cecilia\', \'Lise\', \'Marie\']\ncounts = [len(n) for n in names]\n\nlongest_name = None\nmax_count = 0\nfor i in range(len(names)):\n    count = counts[i]\n    if count > max_count:\n        longest_name = names[i]\n        max_count = count\n\nprint(longest_name)\n\n>>>\nCecilia`, `11315101986174403000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">names <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'Cecilia\'</span><span class="token punctuation">,</span> <span class="token string">\'Lise\'</span><span class="token punctuation">,</span> <span class="token string">\'Marie\'</span><span class="token punctuation">]</span>\ncounts <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token builtin">len</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token keyword">for</span> n <span class="token keyword">in</span> names<span class="token punctuation">]</span>\n\nlongest_name <span class="token operator">=</span> <span class="token boolean">None</span>\nmax_count <span class="token operator">=</span> <span class="token number">0</span>\n<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>names<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    count <span class="token operator">=</span> counts<span class="token punctuation">[</span>i<span class="token punctuation">]</span>\n    <span class="token keyword">if</span> count <span class="token operator">></span> max_count<span class="token punctuation">:</span>\n        longest_name <span class="token operator">=</span> names<span class="token punctuation">[</span>i<span class="token punctuation">]</span>\n        max_count <span class="token operator">=</span> count\n\n<span class="token keyword">print</span><span class="token punctuation">(</span>longest_name<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nCecilia</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这种写法的问题在于，整个循环代码看起来很乱。我们要通过下标访问 names 与 counts 这两个列表里的元素，所以表示下标的那个循环变量 i 在循环体里必须出现两次，这让代码变得不太好懂。改用 enumerate 实现（参见第 7 条）会稍微好一些，但仍然不够理想。</p>\n<p>为了把代码写得更清楚，可以用 Python 内置的 zip 函数来实现。这个函数能把两个或更多的 iterator 封装成惰性生成器（lazy generator）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="887570421416250500"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`for name, count in zip(names, counts):\n    if count > max_count:\n        longest_name = name\n        max_count = count`, `887570421416250500`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">for</span> name<span class="token punctuation">,</span> count <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>names<span class="token punctuation">,</span> counts<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">if</span> count <span class="token operator">></span> max_count<span class="token punctuation">:</span>\n        longest_name <span class="token operator">=</span> name\n        max_count <span class="token operator">=</span> count</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>zip 每次只从它封装的那些迭代器里面各自取出一个元素，所以即便源列表很长，程序也不会因为占用内存过多而崩溃。但是，如果输入 zip 的那些列表的长度不一致，那就得小心了。例如，我给 names 列表里又添加了一个名字，但是忘了把它的长度更新到 counts 列表之中。在这种情况下，用 zip 同时遍历这两份列表，会产生奇怪的结果。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="73358251794299640000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`names = [\'Cecilia\', \'Lise\', \'Marie\']\ncounts = [len(n) for n in names]\n\nlongest_name = None\nmax_count = 0\nfor name, count in zip(names, counts):\n    if count > max_count:\n        longest_name = name\n        max_count = count\n\nnames.append(\'Rosalind\')\nfor name, count in zip(names, counts):\n    print(name)\n\n>>>\nCecilia\nLise\nMarie`, `73358251794299640000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">names <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'Cecilia\'</span><span class="token punctuation">,</span> <span class="token string">\'Lise\'</span><span class="token punctuation">,</span> <span class="token string">\'Marie\'</span><span class="token punctuation">]</span>\ncounts <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token builtin">len</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token keyword">for</span> n <span class="token keyword">in</span> names<span class="token punctuation">]</span>\n\nlongest_name <span class="token operator">=</span> <span class="token boolean">None</span>\nmax_count <span class="token operator">=</span> <span class="token number">0</span>\n<span class="token keyword">for</span> name<span class="token punctuation">,</span> count <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>names<span class="token punctuation">,</span> counts<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">if</span> count <span class="token operator">></span> max_count<span class="token punctuation">:</span>\n        longest_name <span class="token operator">=</span> name\n        max_count <span class="token operator">=</span> count\n\nnames<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">\'Rosalind\'</span><span class="token punctuation">)</span>\n<span class="token keyword">for</span> name<span class="token punctuation">,</span> count <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>names<span class="token punctuation">,</span> counts<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nCecilia\nLise\nMarie</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>zip 函数只要其中任何一个迭代器处理完毕，它就不再往下走了。于是，循环的次数实际上等于最短的那份列表所具备的长度。一般情况下，我们都是根据某份列表推导出其他几份列表，然后把这些列表一起封装到 zip 里面，由于这些列表长度相同，因此不会遇到刚才的问题。</p>\n<p>在列表长度不同的情况下，zip 函数的提前终止行为可能跟你想实现的效果不一样。所以，如果无法确定这些列表的长度相同，那就不要把它们传给 zip，而是应该传给另一个叫作 <code class="language-text">zip_longest</code> 的函数，这个函数位于内置的 itertools 模块里。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="36046914738242753000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import itertools\n\nnames = [\'Cecilia\', \'Lise\', \'Marie\']\ncounts = [len(n) for n in names]\n\nlongest_name = None\nmax_count = 0\nfor name, count in zip(names, counts):\n    if count > max_count:\n        longest_name = name\n        max_count = count\n\nnames.append(\'Rosalind\')\n\nfor name, count in itertools.zip_longest(names, counts):\n    print(f\'{name}: {count}\')\n\n>>>\nCecilia: 7\nLise: 4\nMarie: 5\nRosalind: None`, `36046914738242753000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> itertools\n\nnames <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'Cecilia\'</span><span class="token punctuation">,</span> <span class="token string">\'Lise\'</span><span class="token punctuation">,</span> <span class="token string">\'Marie\'</span><span class="token punctuation">]</span>\ncounts <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token builtin">len</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token keyword">for</span> n <span class="token keyword">in</span> names<span class="token punctuation">]</span>\n\nlongest_name <span class="token operator">=</span> <span class="token boolean">None</span>\nmax_count <span class="token operator">=</span> <span class="token number">0</span>\n<span class="token keyword">for</span> name<span class="token punctuation">,</span> count <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>names<span class="token punctuation">,</span> counts<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">if</span> count <span class="token operator">></span> max_count<span class="token punctuation">:</span>\n        longest_name <span class="token operator">=</span> name\n        max_count <span class="token operator">=</span> count\n\nnames<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">\'Rosalind\'</span><span class="token punctuation">)</span>\n\n<span class="token keyword">for</span> name<span class="token punctuation">,</span> count <span class="token keyword">in</span> itertools<span class="token punctuation">.</span>zip_longest<span class="token punctuation">(</span>names<span class="token punctuation">,</span> counts<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{</span>count<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nCecilia<span class="token punctuation">:</span> <span class="token number">7</span>\nLise<span class="token punctuation">:</span> <span class="token number">4</span>\nMarie<span class="token punctuation">:</span> <span class="token number">5</span>\nRosalind<span class="token punctuation">:</span> <span class="token boolean">None</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果其中有些列表已经遍历完了，那么 <code class="language-text">zip_longest</code> 会用当初传给 fillvalue 参数的那个值来填补空缺（本例中空缺的为字符串 <code class="language-text">&#39;Rosalind&#39;</code> 的长度值），默认的参数值是 None。</p>\n<h3 id="总结-4"><a href="#%E6%80%BB%E7%BB%93-4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>内置的 zip 函数可以同时遍历多个迭代器。</li>\n<li>zip 会创建惰性生成器，让它每次只生成一个元组，所以无论输入的数据有多长，它都是一个一个处理的。</li>\n<li>如果提供的迭代器的长度不一致，那么只要其中任何一个迭代完毕，zip 就会停止。如果想按最长的那个迭代器来遍历，那就改用内置的 itertools 模块中的 <code class="language-text">zip_longest</code> 函数。</li>\n</ol>\n<h2 id="第-9-条：不要在-for-与-while-循环后面写-else-块"><a href="#%E7%AC%AC-9-%E6%9D%A1%EF%BC%9A%E4%B8%8D%E8%A6%81%E5%9C%A8-for-%E4%B8%8E-while-%E5%BE%AA%E7%8E%AF%E5%90%8E%E9%9D%A2%E5%86%99-else-%E5%9D%97" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 9 条：不要在 for 与 while 循环后面写 else 块</h2>\n<p>Python 的循环有一项大多数编程语言都不支持的特性，即可以把 else 块紧跟在整个循环结构的后面。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="63637184894470680000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`for i in range(3):\n    print(\'Loop\', i)\nelse:\n    print(\'Else block!\')\n\n>>>\nLoop 0\nLoop 1\nLoop 2\nElse block!`, `63637184894470680000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Loop\'</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span>\n<span class="token keyword">else</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Else block!\'</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nLoop <span class="token number">0</span>\nLoop <span class="token number">1</span>\nLoop <span class="token number">2</span>\nElse block!</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果循环没有从头到尾执行完（也就是循环提前终止了），那么 else 块里的代码是不会执行的。在循环中使用 break 语句实际上会跳过 else 块。这个与实际想象中的功能差别较大</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="10409265013741087000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`for i in range(3):\n    print(\'Loop\', i)\n    if i == 1:\n        break\nelse:\n    print(\'Else block!\')\n\n>>>\nLoop 0\nLoop 1`, `10409265013741087000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Loop\'</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span>\n    <span class="token keyword">if</span> i <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>\n        <span class="token keyword">break</span>\n<span class="token keyword">else</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Else block!\'</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nLoop <span class="token number">0</span>\nLoop <span class="token number">1</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>还有一个奇怪的地方是，如果对空白序列做 for 循环，那么程序立刻就会执行 else 块。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="60997774023176010000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`for x in []:\n    print(\'Never runs\')\nelse:\n    print(\'For Else block!\')\n\n>>>\nFor Else block!`, `60997774023176010000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Never runs\'</span><span class="token punctuation">)</span>\n<span class="token keyword">else</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'For Else block!\'</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nFor Else block!</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>while 循环也是这样，如果首次循环就遇到 False，那么程序也会立刻运行 else 块。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="55218886200716935000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`while False:\n    print(\'Never runs\')\nelse:\n    print(\'While Else block!\')\n\n>>>\nWhile Else block!`, `55218886200716935000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">while</span> <span class="token boolean">False</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Never runs\'</span><span class="token punctuation">)</span>\n<span class="token keyword">else</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'While Else block!\'</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nWhile Else block!</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>把 else 设计成这样，是想让你利用它实现搜索逻辑。例如，如果要判断两个数是否互质（也就是除了 1 之外，是不是没有别的数能够同时整除它们），就可以用这种结构实现。先把有可能同时整除它们的数逐个试一遍，如果全都试过之后还是没找到这样的数，那么循环就会从头到尾执行完（这意味着循环没有因为 break 而提前跳出），然后程序就会执行 else 块里的代码。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="76325250299673360000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`a = 4\nb = 9\n\nfor i in range(2, min(a, b) + 1):\n    print(\'Testing\', i)\n    if a % i == 0 and b % i == 0:\n        print(\'Not coprime\')\n        break\nelse:\n    print(\'Coprime\')\n\n>>>\nTesting 2\nTesting 3\nTesting 4\nCoprime`, `76325250299673360000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">a <span class="token operator">=</span> <span class="token number">4</span>\nb <span class="token operator">=</span> <span class="token number">9</span>\n\n<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token builtin">min</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Testing\'</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span>\n    <span class="token keyword">if</span> a <span class="token operator">%</span> i <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">and</span> b <span class="token operator">%</span> i <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Not coprime\'</span><span class="token punctuation">)</span>\n        <span class="token keyword">break</span>\n<span class="token keyword">else</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Coprime\'</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTesting <span class="token number">2</span>\nTesting <span class="token number">3</span>\nTesting <span class="token number">4</span>\nCoprime</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>实际工作中，会改用辅助函数完成计算。这样的辅助函数有两种常见的写法。</p>\n<ol>\n<li>\n<p>只要发现某个条件成立，就立刻返回，如果始终都没碰到这种情况，那么循环就会完整地执行，让程序返回函数末尾的那个值作为默认返回值。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="59567381629078980000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def coprime(a, b):\n  for i in range(2, min(a, b) + 1):\n     if a % i == 0 and b % i == 0:\n           return False\n  return True\n\nassert coprime(4, 9)\nassert not coprime(3, 6)`, `59567381629078980000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">coprime</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">:</span>\n  <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token builtin">min</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n     <span class="token keyword">if</span> a <span class="token operator">%</span> i <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">and</span> b <span class="token operator">%</span> i <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>\n           <span class="token keyword">return</span> <span class="token boolean">False</span>\n  <span class="token keyword">return</span> <span class="token boolean">True</span>\n\n<span class="token keyword">assert</span> coprime<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span>\n<span class="token keyword">assert</span> <span class="token keyword">not</span> coprime<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n<li>\n<p>用变量来记录循环过程中有没有碰到这样的情况，如果有，那就用 break 提前跳出循环，如果没有，循环就会完整地执行，无论如何，最后都返回这个变量的值。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="27352362323040346000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def coprime_alternate(a, b):\n  is_coprime = True\n  for i in range(2, min(a, b) + 1):\n     if a % i == 0 and b % i == 0:\n           is_coprime = False\n           break\n  return is_coprime\n\nassert coprime_alternate(4, 9)\nassert not coprime_alternate(3, 6)`, `27352362323040346000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">coprime_alternate</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">:</span>\n  is_coprime <span class="token operator">=</span> <span class="token boolean">True</span>\n  <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token builtin">min</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n     <span class="token keyword">if</span> a <span class="token operator">%</span> i <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">and</span> b <span class="token operator">%</span> i <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>\n           is_coprime <span class="token operator">=</span> <span class="token boolean">False</span>\n           <span class="token keyword">break</span>\n  <span class="token keyword">return</span> is_coprime\n\n<span class="token keyword">assert</span> coprime_alternate<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span>\n<span class="token keyword">assert</span> <span class="token keyword">not</span> coprime_alternate<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n</ol>\n<p>for/else 或 while/else 结构本身虽然可以实现某些逻辑表达，但它带来的困惑，已经盖过了它的好处。</p>\n<h3 id="总结-5"><a href="#%E6%80%BB%E7%BB%93-5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>Python 有种特殊的语法，可以把 else 块紧跟在整个 for 循环或 while 循环的后面。</li>\n<li>只有在整个循环没有因为 break 提前跳出的情况下，else 块才会执行</li>\n<li>把 else 块紧跟在整个循环后面，会让人不太容易看出这段代码的意思，所以要避免这样写。</li>\n</ol>\n<h2 id="第-10-条：用赋值表达式减少重复代码"><a href="#%E7%AC%AC-10-%E6%9D%A1%EF%BC%9A%E7%94%A8%E8%B5%8B%E5%80%BC%E8%A1%A8%E8%BE%BE%E5%BC%8F%E5%87%8F%E5%B0%91%E9%87%8D%E5%A4%8D%E4%BB%A3%E7%A0%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 10 条：用赋值表达式减少重复代码</h2>\n<p>赋值表达式（assignment expression）是 Python3.8 新引入的语法，它会用到海象操作符（walrus operator）。这种写法可以解决某些持续已久的代码重复问题。</p>\n<p>这种表达式很有用，可以在普通的赋值语句无法应用的场合实现赋值，例如可以用在条件表达式的 if 语句里面。赋值表达式的值，就是赋给海象操作符左侧那个标识符的值。</p>\n<p>举个例子。如果有一筐新鲜水果要给果汁店做食材，那我们就可以这样定义其中的内容：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="71285117030838330000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`fresh_fruit = {\n    \'apple\': 10,\n    \'banana\': 8,\n    \'lemon\': 5,\n}\n\ndef make_lemonade(count):\n    pass\n\ndef out_of_stock():\n    pass\n\ncount = fresh_fruit.get(\'lemon\', 0)\nif count:\n    make_lemonade(count)\nelse:\n    out_of_stock()`, `71285117030838330000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">fresh_fruit <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token string">\'apple\'</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span>\n    <span class="token string">\'banana\'</span><span class="token punctuation">:</span> <span class="token number">8</span><span class="token punctuation">,</span>\n    <span class="token string">\'lemon\'</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">def</span> <span class="token function">make_lemonade</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n<span class="token keyword">def</span> <span class="token function">out_of_stock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\ncount <span class="token operator">=</span> fresh_fruit<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">\'lemon\'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>\n<span class="token keyword">if</span> count<span class="token punctuation">:</span>\n    make_lemonade<span class="token punctuation">(</span>count<span class="token punctuation">)</span>\n<span class="token keyword">else</span><span class="token punctuation">:</span>\n    out_of_stock<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这段代码看上去虽然简单，但还是显得有点儿松散，因为 count 变量虽然定义在整个 if/else 结构之上，然而只有 if 语句才会用到它，else 块根本就不需要使用这个变量。所以，这种写法让人误以为 count 是个重要的变量，if 和 else 都要用到它，但实际上并非如此。</p>\n<p>我们在 Python 里面经常要先获取某个值，然后判断它是否非零，如果是就执行某段代码。对于这种用法，我们以前总是要通过各种技巧，来避免 count 这样的变量重复出现在代码之中，这些技巧有时会让代码变得比较难懂（参考第 5 条里面提到的那些技巧）。Python 引入赋值表达式正是为了解决这样的问题。下面改用海象操作符来写：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="79071108402718820000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`if count := fresh_fruit.get(\'lemon\', 0):\n    make_lemonade(count)\nelse:\n    out_of_stock()`, `79071108402718820000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">if</span> count <span class="token punctuation">:</span><span class="token operator">=</span> fresh_fruit<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">\'lemon\'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    make_lemonade<span class="token punctuation">(</span>count<span class="token punctuation">)</span>\n<span class="token keyword">else</span><span class="token punctuation">:</span>\n    out_of_stock<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>新代码虽然只省了一行，但读起来却清晰很多，因为这种写法明确体现出 count 变量只与 if 块有关。这个赋值表达式先把 <code class="language-text">:=</code> 右边的值赋给左边的 count 变量，然后对自身求值，也就是把变量的值当成整个表达式的值。由于表达式紧跟着 if，程序会根据它的值是否非零来决定该不该执行 if 块。这种先赋值再判断的做法，正是海象操作符想要表达的意思。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="70826600376275170000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`fresh_fruit = {\n    \'apple\': 10,\n    \'banana\': 8,\n    \'lemon\': 5,\n}\n\ndef make_cider(count):\n    pass\n\ncount = fresh_fruit.get(\'apple\', 0)\n\nif count >= 4:\n    make_cider(count)\nelse:\n    out_of_stock()`, `70826600376275170000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">fresh_fruit <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token string">\'apple\'</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span>\n    <span class="token string">\'banana\'</span><span class="token punctuation">:</span> <span class="token number">8</span><span class="token punctuation">,</span>\n    <span class="token string">\'lemon\'</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">def</span> <span class="token function">make_cider</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\ncount <span class="token operator">=</span> fresh_fruit<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">\'apple\'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>\n\n<span class="token keyword">if</span> count <span class="token operator">>=</span> <span class="token number">4</span><span class="token punctuation">:</span>\n    make_cider<span class="token punctuation">(</span>count<span class="token punctuation">)</span>\n<span class="token keyword">else</span><span class="token punctuation">:</span>\n    out_of_stock<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>同理以上代码可以修改如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="93632053934297970000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`if (count := fresh_fruit.get(\'apple\', 0)) >= 4:\n    make_lemonade(count)\nelse:\n    out_of_stock()`, `93632053934297970000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token punctuation">:</span><span class="token operator">=</span> fresh_fruit<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">\'apple\'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">4</span><span class="token punctuation">:</span>\n    make_lemonade<span class="token punctuation">(</span>count<span class="token punctuation">)</span>\n<span class="token keyword">else</span><span class="token punctuation">:</span>\n    out_of_stock<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>与刚才那个例子一样，修改之后的代码也比原来少了一行。但是这次，我们还要注意另外一个现象：赋值表达式本身是放在一对括号里面的。为什么要这样做呢？因为我们要在 if 语句里面把这个表达式的结果跟 4 这个值相比较。刚才柠檬汁的例子没有加括号，因为那时只凭赋值表达式本身的值就能决定 if/else 的走向：只要表达式的值不是 0，程序就进入 if 分支。但是这次不行，这次要把这个赋值表达式放在更大的表达式里面，所以必须用括号把它括起来。当然，在没有必要加括号的情况下，还是尽量别加括号比较好。</p>\n<p>还有一种类似的逻辑也会出现刚才说的重复代码，这指的是：我们要根据情况给某个变量赋予不同的值，紧接着要用这个变量做参数来调用某个函数。例如，若顾客要点香蕉冰沙，那我们首先得把香蕉切成好几份，然后用其中的两份来制作这道冰沙。如果不够两份，那就抛出香蕉不足（OutOfBananas）异常。下面用传统的写法实现这种逻辑：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="29426775089840017000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def slice_bananas(count):\n    pass\n\n\nclass OutofBananas(Exception):\n    pass\n\n\ndef make_smoothies(count):\n    pass\n\n\nfresh_fruit = {\n    \'apple\': 10,\n    \'banana\': 8,\n    \'lemon\': 5,\n}\n\npieces = 0\ncount = fresh_fruit.get(\'banana\', 0)\nif count >= 2:\n    pieces = slice_bananas(count)\n\ntry:\n    smoothies = make_smoothies(pieces)\nexcept OutofBananas:\n    out_of_stock()`, `29426775089840017000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">slice_bananas</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">OutofBananas</span><span class="token punctuation">(</span>Exception<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n\n<span class="token keyword">def</span> <span class="token function">make_smoothies</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n\nfresh_fruit <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token string">\'apple\'</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span>\n    <span class="token string">\'banana\'</span><span class="token punctuation">:</span> <span class="token number">8</span><span class="token punctuation">,</span>\n    <span class="token string">\'lemon\'</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\n\npieces <span class="token operator">=</span> <span class="token number">0</span>\ncount <span class="token operator">=</span> fresh_fruit<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">\'banana\'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>\n<span class="token keyword">if</span> count <span class="token operator">>=</span> <span class="token number">2</span><span class="token punctuation">:</span>\n    pieces <span class="token operator">=</span> slice_bananas<span class="token punctuation">(</span>count<span class="token punctuation">)</span>\n\n<span class="token keyword">try</span><span class="token punctuation">:</span>\n    smoothies <span class="token operator">=</span> make_smoothies<span class="token punctuation">(</span>pieces<span class="token punctuation">)</span>\n<span class="token keyword">except</span> OutofBananas<span class="token punctuation">:</span>\n    out_of_stock<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>还有一种传统的写法也很常见，就是把 if/else 结构上方那条 pieces = 0 的赋值语句移动到 else 块中。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="30313336151937008000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`count = fresh_fruit.get(\'banana\', 0)\nif count >= 2:\n    pieces = slice_bananas(count)\nelse:\n    pieces = 0\n\ntry:\n    smoothies = make_smoothies(pieces)\nexcept OutofBananas:\n    out_of_stock()`, `30313336151937008000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">count <span class="token operator">=</span> fresh_fruit<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">\'banana\'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>\n<span class="token keyword">if</span> count <span class="token operator">>=</span> <span class="token number">2</span><span class="token punctuation">:</span>\n    pieces <span class="token operator">=</span> slice_bananas<span class="token punctuation">(</span>count<span class="token punctuation">)</span>\n<span class="token keyword">else</span><span class="token punctuation">:</span>\n    pieces <span class="token operator">=</span> <span class="token number">0</span>\n\n<span class="token keyword">try</span><span class="token punctuation">:</span>\n    smoothies <span class="token operator">=</span> make_smoothies<span class="token punctuation">(</span>pieces<span class="token punctuation">)</span>\n<span class="token keyword">except</span> OutofBananas<span class="token punctuation">:</span>\n    out_of_stock<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这种写法看上去稍微有点儿怪，因为 if 与 else 这两个分支都给 pieces 变量定义了初始值。根据 Python 的作用域规则，这种分别定义变量初始值的写法是成立的（参见第 21 条）。虽说成立，但这样写看起来比较别扭，所以很多人喜欢用第一种写法，也就是在进入 if/else 结构之前，先把 pieces 的初始值给设置好。</p>\n<p>改用海象操作符来实现，可以少写一行代码，而且能够压低 count 变量的地位，让它只出现在 if 块里，这样我们就能更清楚地意识到 pieces 变量才是整段代码的重点。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="13849558157485609000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`pieces = 0\nif (count := fresh_fruit.get(\'banana\', 0)) >= 2:\n    pieces = slice_bananas(count)\n\ntry:\n    smoothies = make_smoothies(pieces)\nexcept OutofBananas:\n    out_of_stock()`, `13849558157485609000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">pieces <span class="token operator">=</span> <span class="token number">0</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token punctuation">:</span><span class="token operator">=</span> fresh_fruit<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">\'banana\'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">2</span><span class="token punctuation">:</span>\n    pieces <span class="token operator">=</span> slice_bananas<span class="token punctuation">(</span>count<span class="token punctuation">)</span>\n\n<span class="token keyword">try</span><span class="token punctuation">:</span>\n    smoothies <span class="token operator">=</span> make_smoothies<span class="token punctuation">(</span>pieces<span class="token punctuation">)</span>\n<span class="token keyword">except</span> OutofBananas<span class="token punctuation">:</span>\n    out_of_stock<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>对于在 if 与 else 分支里面分别定义 pieces 变量的写法来说，海象操作符也能让代码变得清晰，因为这次不用再把 count 变量放到整个 if/else 块的上方了。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="86784043729681120000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`if (count := fresh_fruit.get(\'banana\', 0)) >= 2:\n    pieces = slice_bananas(count)\nelse:\n    pieces = 0\n\ntry:\n    smoothies = make_smoothies(pieces)\nexcept OutofBananas:\n    out_of_stock()`, `86784043729681120000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token punctuation">:</span><span class="token operator">=</span> fresh_fruit<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">\'banana\'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">2</span><span class="token punctuation">:</span>\n    pieces <span class="token operator">=</span> slice_bananas<span class="token punctuation">(</span>count<span class="token punctuation">)</span>\n<span class="token keyword">else</span><span class="token punctuation">:</span>\n    pieces <span class="token operator">=</span> <span class="token number">0</span>\n\n<span class="token keyword">try</span><span class="token punctuation">:</span>\n    smoothies <span class="token operator">=</span> make_smoothies<span class="token punctuation">(</span>pieces<span class="token punctuation">)</span>\n<span class="token keyword">except</span> OutofBananas<span class="token punctuation">:</span>\n    out_of_stock<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Python 新手经常会遇到这样一种困难，就是找不到好办法来实现 switch/case 结构。最接近这种结构的做法是在 if/else 结构里面继续嵌套 if/else 结构，或者使用 if/elif/else 结构。</p>\n<p>例如，我们想按照一定的顺序自动给客人制作饮品，这样就不用点餐了。下面这段逻辑先判断能不能做香蕉冰沙，如果不能，就做苹果汁，还不行，就做柠檬汁：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="74904060778135520000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`count = fresh_fruit.get(\'banana\', 0)\nif count >= 2:\n    pieces = slice_bananas(count)\n    to_enjoy = make_smoothies(pieces)\nelse:\n    count = fresh_fruit.get(\'apple\', 0)\n    if count >= 4:\n        to_enjoy = make_cider(count)\n    else:\n        count = fresh_fruit.get(\'lemon\', 0)\n        if count:\n            to_enjoy = make_lemonade(count)\n        else:\n            to_enjoy = \'Nothing\'`, `74904060778135520000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">count <span class="token operator">=</span> fresh_fruit<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">\'banana\'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>\n<span class="token keyword">if</span> count <span class="token operator">>=</span> <span class="token number">2</span><span class="token punctuation">:</span>\n    pieces <span class="token operator">=</span> slice_bananas<span class="token punctuation">(</span>count<span class="token punctuation">)</span>\n    to_enjoy <span class="token operator">=</span> make_smoothies<span class="token punctuation">(</span>pieces<span class="token punctuation">)</span>\n<span class="token keyword">else</span><span class="token punctuation">:</span>\n    count <span class="token operator">=</span> fresh_fruit<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">\'apple\'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>\n    <span class="token keyword">if</span> count <span class="token operator">>=</span> <span class="token number">4</span><span class="token punctuation">:</span>\n        to_enjoy <span class="token operator">=</span> make_cider<span class="token punctuation">(</span>count<span class="token punctuation">)</span>\n    <span class="token keyword">else</span><span class="token punctuation">:</span>\n        count <span class="token operator">=</span> fresh_fruit<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">\'lemon\'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>\n        <span class="token keyword">if</span> count<span class="token punctuation">:</span>\n            to_enjoy <span class="token operator">=</span> make_lemonade<span class="token punctuation">(</span>count<span class="token punctuation">)</span>\n        <span class="token keyword">else</span><span class="token punctuation">:</span>\n            to_enjoy <span class="token operator">=</span> <span class="token string">\'Nothing\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这种难看的写法其实在 Python 代码里特别常见。幸好现在有了海象操作符，让我们能够轻松地模拟出很接近 switch/case 的方案。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="15303269115209206000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`if (count := fresh_fruit.get(\'banana\', 0)) >= 2:\n    pieces = slice_bananas(count)\n    to_enjoy = make_smoothies(pieces)\nelif (count := fresh_fruit.get(\'apple\', 0)) >= 4:\n    to_enjoy = make_cider(count)\nelif count := fresh_fruit.get(\'lemon\', 0):\n    to_enjoy = make_lemonade(count)\nelse:\n    to_enjoy = \'Nothing\'`, `15303269115209206000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token punctuation">:</span><span class="token operator">=</span> fresh_fruit<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">\'banana\'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">2</span><span class="token punctuation">:</span>\n    pieces <span class="token operator">=</span> slice_bananas<span class="token punctuation">(</span>count<span class="token punctuation">)</span>\n    to_enjoy <span class="token operator">=</span> make_smoothies<span class="token punctuation">(</span>pieces<span class="token punctuation">)</span>\n<span class="token keyword">elif</span> <span class="token punctuation">(</span>count <span class="token punctuation">:</span><span class="token operator">=</span> fresh_fruit<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">\'apple\'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">4</span><span class="token punctuation">:</span>\n    to_enjoy <span class="token operator">=</span> make_cider<span class="token punctuation">(</span>count<span class="token punctuation">)</span>\n<span class="token keyword">elif</span> count <span class="token punctuation">:</span><span class="token operator">=</span> fresh_fruit<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">\'lemon\'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    to_enjoy <span class="token operator">=</span> make_lemonade<span class="token punctuation">(</span>count<span class="token punctuation">)</span>\n<span class="token keyword">else</span><span class="token punctuation">:</span>\n    to_enjoy <span class="token operator">=</span> <span class="token string">\'Nothing\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这个版本只比原来短五行，但是看起来却清晰得多，因为嵌套深度与缩进层数都变少了。只要碰到刚才那种难看的结构，我们就应该考虑能不能改用海象操作符来写。</p>\n<p>Python 新手还会遇到一个困难，就是缺少 do/while 循环结构。例如，我们要把新来的水果做成果汁并且装到瓶子里面，直到水果用完为止。下面先用普通的 while 循环来实现：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="67122879565588865000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def pick_fruit():\n    pass\n\n\ndef make_juice(fruit, count):\n    pass\n\n\nbottles = []\nfresh_fruit = pick_fruit()\nwhile fresh_fruit:\n    for fruit, count in fresh_fruit.items():\n        batch = make_juice(fruit, count)\n        bottles.extend(batch)\n    fresh_fruit = pick_fruit()`, `67122879565588865000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">pick_fruit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n\n<span class="token keyword">def</span> <span class="token function">make_juice</span><span class="token punctuation">(</span>fruit<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n\nbottles <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\nfresh_fruit <span class="token operator">=</span> pick_fruit<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">while</span> fresh_fruit<span class="token punctuation">:</span>\n    <span class="token keyword">for</span> fruit<span class="token punctuation">,</span> count <span class="token keyword">in</span> fresh_fruit<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        batch <span class="token operator">=</span> make_juice<span class="token punctuation">(</span>fruit<span class="token punctuation">,</span> count<span class="token punctuation">)</span>\n        bottles<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>batch<span class="token punctuation">)</span>\n    fresh_fruit <span class="token operator">=</span> pick_fruit<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这种写法必须把 <code class="language-text">fresh_fruit = pick_fruit()</code> 写两次，第一次是在进入 while 循环之前，因为我们要给 <code class="language-text">fresh_fruit</code> 设定初始值，第二次是在 while 循环体的末尾，因为我们得把下一轮需要处理的水果列表填充到 <code class="language-text">fresh_fruit</code> 里面。如果想复用这行代码，可以考虑 loop-and-a-half 模式。这个模式虽然能消除重复，但是会让 while 循环看起来很笨，因为它成了无限循环，程序只能通过 break 语句跳出这个循环。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="7108848508342814000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`bottles = []\nwhile True:\n   fresh_fruit = pick_fruit()\n   if not fresh_fruit:\n      break\n    for fruit, count in fresh_fruit.items():\n        batch = make_juice(fruit, count)\n        bottles.extend(batch)`, `7108848508342814000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">bottles <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n<span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>\n   fresh_fruit <span class="token operator">=</span> pick_fruit<span class="token punctuation">(</span><span class="token punctuation">)</span>\n   <span class="token keyword">if</span> <span class="token keyword">not</span> fresh_fruit<span class="token punctuation">:</span>\n      <span class="token keyword">break</span>\n    <span class="token keyword">for</span> fruit<span class="token punctuation">,</span> count <span class="token keyword">in</span> fresh_fruit<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        batch <span class="token operator">=</span> make_juice<span class="token punctuation">(</span>fruit<span class="token punctuation">,</span> count<span class="token punctuation">)</span>\n        bottles<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>batch<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>有了海象操作符，就不需要使用 <code class="language-text">loop-and-a-half</code> 模式了，我们可以在每轮循环的开头给 <code class="language-text">fresh_fruit</code> 变量赋值，并根据变量的值来决定要不要继续循环。这个写法简单易读，所以应该成为首选方案。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="59930273380703130000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`bottles = []\nwhile fresh_fruit := pick_fruit():\n    for fruit, count in fresh_fruit.items():\n        batch = make_juice(fruit, count)\n        bottles.extend(batch)`, `59930273380703130000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">bottles <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n<span class="token keyword">while</span> fresh_fruit <span class="token punctuation">:</span><span class="token operator">=</span> pick_fruit<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">for</span> fruit<span class="token punctuation">,</span> count <span class="token keyword">in</span> fresh_fruit<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        batch <span class="token operator">=</span> make_juice<span class="token punctuation">(</span>fruit<span class="token punctuation">,</span> count<span class="token punctuation">)</span>\n        bottles<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>batch<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在其他一些场合，赋值表达式也能缩减重复代码（参见第 29 条）。总之，如果某个表达式或赋值操作多次出现在一组代码里面，那就可以考虑用赋值表达式把这段代码改得简单一些。</p>\n<h3 id="总结-6"><a href="#%E6%80%BB%E7%BB%93-6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>赋值表达式通过海象操作符（:=）给变量赋值，并且让这个值成为这条表达式的结果，于是，我们可以利用这项特性来缩减代码。如果赋值表达式是大表达式里的一部分，就得用一对括号把它括起来。</li>\n<li>虽说 Python 不支持 switch/case 与 do/while 结构，但可以利用赋值表达式清晰地模拟出这种逻辑。</li>\n</ol>\n<h1 id="列表与字典"><a href="#%E5%88%97%E8%A1%A8%E4%B8%8E%E5%AD%97%E5%85%B8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>列表与字典</h1>\n<h2 id="第-11-条：学会对序列做切片"><a href="#%E7%AC%AC-11-%E6%9D%A1%EF%BC%9A%E5%AD%A6%E4%BC%9A%E5%AF%B9%E5%BA%8F%E5%88%97%E5%81%9A%E5%88%87%E7%89%87" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 11 条：学会对序列做切片</h2>\n<p>Python 有这样一种写法，可以从序列里面切割（slice）出一部分内容，让我们能够轻松地获取原序列的某个子集合。最简单的用法就是切割内置的 list、str 与 bytes。其实，凡是实现了 <code class="language-text">__getitem__</code> 与 <code class="language-text">__setitem__</code> 这两个特殊方法的类都可以切割（参见第 43 条）。</p>\n<p>最基本的写法是用 <code class="language-text">somelist[start:end]</code> 这一形式来切割，也就是从 start 开始一直取到 end 这个位置，但不包含 end 本身的元素。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="47254894230077290000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`a = [\'a\', \'b\', \'c\', \'d\', \'e\', \'f\', \'g\', \'h\']\nprint(\'Middle two:   \', a[3:5])\nprint(\'All but ends: \', a[1:7])\n\n>>>\nMiddle two:    [\'d\', \'e\']\nAll but ends:  [\'b\', \'c\', \'d\', \'e\', \'f\', \'g\']`, `47254894230077290000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">,</span> <span class="token string">\'c\'</span><span class="token punctuation">,</span> <span class="token string">\'d\'</span><span class="token punctuation">,</span> <span class="token string">\'e\'</span><span class="token punctuation">,</span> <span class="token string">\'f\'</span><span class="token punctuation">,</span> <span class="token string">\'g\'</span><span class="token punctuation">,</span> <span class="token string">\'h\'</span><span class="token punctuation">]</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Middle two:   \'</span><span class="token punctuation">,</span> a<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'All but ends: \'</span><span class="token punctuation">,</span> a<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nMiddle two<span class="token punctuation">:</span>    <span class="token punctuation">[</span><span class="token string">\'d\'</span><span class="token punctuation">,</span> <span class="token string">\'e\'</span><span class="token punctuation">]</span>\nAll but ends<span class="token punctuation">:</span>  <span class="token punctuation">[</span><span class="token string">\'b\'</span><span class="token punctuation">,</span> <span class="token string">\'c\'</span><span class="token punctuation">,</span> <span class="token string">\'d\'</span><span class="token punctuation">,</span> <span class="token string">\'e\'</span><span class="token punctuation">,</span> <span class="token string">\'f\'</span><span class="token punctuation">,</span> <span class="token string">\'g\'</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果是从头开始切割列表，那就应该省略冒号左侧的下标 0，这样看起来更清晰。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="22990401049788645000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`assert a[:5] == a[0:5]`, `22990401049788645000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">assert</span> a<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">==</span> a<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>如果一直取到列表末尾，那就应该省略冒号右侧的下标，因为用不着专门把它写出来。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="80998169921087460000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`assert a[5:] == a[5:len(a)]`, `80998169921087460000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">assert</span> a<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">==</span> a<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">:</span><span class="token builtin">len</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>用负数作下标表示从列表末尾往前算。下面这些切割方式，即便是刚看到这段代码的人也应该能明白是什么意思。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="62524331883666506000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`a = [\'a\', \'b\', \'c\', \'d\', \'e\', \'f\', \'g\', \'h\']\nprint(a[:]) # [\'a\', \'b\', \'c\', \'d\', \'e\', \'f\', \'g\', \'h\']\nprint(a[:5]) # [\'a\', \'b\', \'c\', \'d\', \'e\']\nprint(a[:-1]) # [\'a\', \'b\', \'c\', \'d\', \'e\', \'f\', \'g\']\nprint(a[4:]) # [\'e\', \'f\', \'g\', \'h\']\nprint(a[-3:]) # [\'f\', \'g\', \'h\']\nprint(a[2:5]) # [\'c\', \'d\', \'e\']\nprint(a[2:-1]) # [\'c\', \'d\', \'e\', \'f\', \'g\']\nprint(a[-3:-1]) # [\'f\', \'g\']`, `62524331883666506000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">,</span> <span class="token string">\'c\'</span><span class="token punctuation">,</span> <span class="token string">\'d\'</span><span class="token punctuation">,</span> <span class="token string">\'e\'</span><span class="token punctuation">,</span> <span class="token string">\'f\'</span><span class="token punctuation">,</span> <span class="token string">\'g\'</span><span class="token punctuation">,</span> <span class="token string">\'h\'</span><span class="token punctuation">]</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment"># [\'a\', \'b\', \'c\', \'d\', \'e\', \'f\', \'g\', \'h\']</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment"># [\'a\', \'b\', \'c\', \'d\', \'e\']</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment"># [\'a\', \'b\', \'c\', \'d\', \'e\', \'f\', \'g\']</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment"># [\'e\', \'f\', \'g\', \'h\']</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment"># [\'f\', \'g\', \'h\']</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment"># [\'c\', \'d\', \'e\']</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment"># [\'c\', \'d\', \'e\', \'f\', \'g\']</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment"># [\'f\', \'g\']</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果起点与终点所确定的范围超出了列表的边界，那么系统会自动忽略不存在的元素。利用这项特性，很容易就能构造出一个最多只有若干元素的输入序列，例如：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="8071264836997294000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`first_twenty_items = a[:20]\nlast_twenty_items = a[-20:]`, `8071264836997294000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">first_twenty_items <span class="token operator">=</span> a<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">20</span><span class="token punctuation">]</span>\nlast_twenty_items <span class="token operator">=</span> a<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">20</span><span class="token punctuation">:</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>切割时所用的下标可以越界，但是直接访问列表时却不行，那样会让程序抛出异常。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="98767202967847470000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`a[20]\n\n>>>\nTraceback ...\nIndexError: list index out of range`, `98767202967847470000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">a<span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">]</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nIndexError<span class="token punctuation">:</span> <span class="token builtin">list</span> index out of <span class="token builtin">range</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>切割出来的列表是一份全新的列表。即便把某个元素换掉，也不会影响原列表中的相应位置。那个位置上的元素还是旧值。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="24752066418553430000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`a = [\'a\', \'b\', \'c\', \'d\', \'e\', \'f\', \'g\', \'h\']\nb = a[3:]\nprint(\'Before:\', b)\nb[1] = 99\nprint(\'After: \', b)\nprint(\'No change:\', a)\n\n>>>\nBefore: [\'d\', \'e\', \'f\', \'g\', \'h\']\nAfter:  [\'d\', 99, \'f\', \'g\', \'h\']\nNo change: [\'a\', \'b\', \'c\', \'d\', \'e\', \'f\', \'g\', \'h\']`, `24752066418553430000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">,</span> <span class="token string">\'c\'</span><span class="token punctuation">,</span> <span class="token string">\'d\'</span><span class="token punctuation">,</span> <span class="token string">\'e\'</span><span class="token punctuation">,</span> <span class="token string">\'f\'</span><span class="token punctuation">,</span> <span class="token string">\'g\'</span><span class="token punctuation">,</span> <span class="token string">\'h\'</span><span class="token punctuation">]</span>\nb <span class="token operator">=</span> a<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token punctuation">]</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Before:\'</span><span class="token punctuation">,</span> b<span class="token punctuation">)</span>\nb<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">99</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'After: \'</span><span class="token punctuation">,</span> b<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'No change:\'</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nBefore<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'d\'</span><span class="token punctuation">,</span> <span class="token string">\'e\'</span><span class="token punctuation">,</span> <span class="token string">\'f\'</span><span class="token punctuation">,</span> <span class="token string">\'g\'</span><span class="token punctuation">,</span> <span class="token string">\'h\'</span><span class="token punctuation">]</span>\nAfter<span class="token punctuation">:</span>  <span class="token punctuation">[</span><span class="token string">\'d\'</span><span class="token punctuation">,</span> <span class="token number">99</span><span class="token punctuation">,</span> <span class="token string">\'f\'</span><span class="token punctuation">,</span> <span class="token string">\'g\'</span><span class="token punctuation">,</span> <span class="token string">\'h\'</span><span class="token punctuation">]</span>\nNo change<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">,</span> <span class="token string">\'c\'</span><span class="token punctuation">,</span> <span class="token string">\'d\'</span><span class="token punctuation">,</span> <span class="token string">\'e\'</span><span class="token punctuation">,</span> <span class="token string">\'f\'</span><span class="token punctuation">,</span> <span class="token string">\'g\'</span><span class="token punctuation">,</span> <span class="token string">\'h\'</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>切片可以出现在赋值符号的左侧，表示用右侧那些元素把原列表中位于这个范围之内的元素换掉。与 unpacking 形式的赋值不同，这种赋值不要求等号两边所指定的元素个数必须相同（如果是做 unpacking，那么等号左侧用来接收数值的变量个数必须与等号右边所提供的数值个数一致，例如 <code class="language-text">a, b = c[:2]</code>，参见第 6 条）。在原列表中，位于切片范围之前和之后的那些元素会予以保留，但是列表的长度可能有所变化。例如在下面这个例子中，列表会变短，因为赋值符号右侧只提供了 3 个值，但是左侧那个切片却涵盖了 5 个值，列表会比原来少两个元素。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="85866708682928930000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`a = [\'a\', \'b\', \'c\', \'d\', \'e\', \'f\', \'g\', \'h\']\nprint(\'Before \', a)\na[2:7] = [99, 22, 14]\nprint(\'After  \', a)\n\n>>>\nBefore  [\'a\', \'b\', \'c\', \'d\', \'e\', \'f\', \'g\', \'h\']\nAfter   [\'a\', \'b\', 99, 22, 14, \'h\']`, `85866708682928930000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">,</span> <span class="token string">\'c\'</span><span class="token punctuation">,</span> <span class="token string">\'d\'</span><span class="token punctuation">,</span> <span class="token string">\'e\'</span><span class="token punctuation">,</span> <span class="token string">\'f\'</span><span class="token punctuation">,</span> <span class="token string">\'g\'</span><span class="token punctuation">,</span> <span class="token string">\'h\'</span><span class="token punctuation">]</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Before \'</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span>\na<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">99</span><span class="token punctuation">,</span> <span class="token number">22</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">]</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'After  \'</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nBefore  <span class="token punctuation">[</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">,</span> <span class="token string">\'c\'</span><span class="token punctuation">,</span> <span class="token string">\'d\'</span><span class="token punctuation">,</span> <span class="token string">\'e\'</span><span class="token punctuation">,</span> <span class="token string">\'f\'</span><span class="token punctuation">,</span> <span class="token string">\'g\'</span><span class="token punctuation">,</span> <span class="token string">\'h\'</span><span class="token punctuation">]</span>\nAfter   <span class="token punctuation">[</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">,</span> <span class="token number">99</span><span class="token punctuation">,</span> <span class="token number">22</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">,</span> <span class="token string">\'h\'</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>下面这段代码会使列表变长，因为赋值符号右侧的元素数量比左侧那个切片所涵盖的元素数量要多。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="50811459060613240000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`a = [\'a\', \'b\', \'c\', \'d\', \'e\', \'f\', \'g\', \'h\']\nprint(\'Before \', a)\na[2:3] = [47, 11]\nprint(\'After  \', a)\n\n>>>\nBefore  [\'a\', \'b\', \'c\', \'d\', \'e\', \'f\', \'g\', \'h\']\nAfter   [\'a\', \'b\', 47, 11, \'d\', \'e\', \'f\', \'g\', \'h\']`, `50811459060613240000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">,</span> <span class="token string">\'c\'</span><span class="token punctuation">,</span> <span class="token string">\'d\'</span><span class="token punctuation">,</span> <span class="token string">\'e\'</span><span class="token punctuation">,</span> <span class="token string">\'f\'</span><span class="token punctuation">,</span> <span class="token string">\'g\'</span><span class="token punctuation">,</span> <span class="token string">\'h\'</span><span class="token punctuation">]</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Before \'</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span>\na<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">47</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">]</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'After  \'</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nBefore  <span class="token punctuation">[</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">,</span> <span class="token string">\'c\'</span><span class="token punctuation">,</span> <span class="token string">\'d\'</span><span class="token punctuation">,</span> <span class="token string">\'e\'</span><span class="token punctuation">,</span> <span class="token string">\'f\'</span><span class="token punctuation">,</span> <span class="token string">\'g\'</span><span class="token punctuation">,</span> <span class="token string">\'h\'</span><span class="token punctuation">]</span>\nAfter   <span class="token punctuation">[</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">,</span> <span class="token number">47</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token string">\'d\'</span><span class="token punctuation">,</span> <span class="token string">\'e\'</span><span class="token punctuation">,</span> <span class="token string">\'f\'</span><span class="token punctuation">,</span> <span class="token string">\'g\'</span><span class="token punctuation">,</span> <span class="token string">\'h\'</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>起止位置都留空的切片，如果出现在赋值符号右侧，那么表示给这个列表做副本，这样制作出来的新列表内容和原列表相同，但身份不同。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="88006112321295760000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`b = a[:]\nassert b == a and b is not a`, `88006112321295760000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">b <span class="token operator">=</span> a<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span>\n<span class="token keyword">assert</span> b <span class="token operator">==</span> a <span class="token keyword">and</span> b <span class="token keyword">is</span> <span class="token keyword">not</span> a</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>把不带起止下标的切片放在赋值符号左边，表示是用右边那个列表的副本把左侧列表的全部内容替换掉（注意，左侧列表依然保持原来的身份，系统不会分配新的列表）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="38757574419786780000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`a = [\'a\', \'b\', \'c\', \'d\', \'e\', \'f\', \'g\', \'h\']\nb = a\nc = a[:]\nprint(\'Before a\', a)\nprint(\'Before b\', b)\nprint(\'Before c\', b)\na[:] = [101, 102, 103]\nassert b is a and c is not a  # Still the same list object\nprint(\'After a \', a)  # Now has different contents\nprint(\'After b \', b)  # Same list, so same contents as a\nprint(\'After c \', c)  # Not same list, same contents as a\n\n>>>\nBefore a [\'a\', \'b\', \'c\', \'d\', \'e\', \'f\', \'g\', \'h\']\nBefore b [\'a\', \'b\', \'c\', \'d\', \'e\', \'f\', \'g\', \'h\']\nBefore c [\'a\', \'b\', \'c\', \'d\', \'e\', \'f\', \'g\', \'h\']\nAfter a  [101, 102, 103]\nAfter b  [101, 102, 103]\nAfter c  [\'a\', \'b\', \'c\', \'d\', \'e\', \'f\', \'g\', \'h\']`, `38757574419786780000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">,</span> <span class="token string">\'c\'</span><span class="token punctuation">,</span> <span class="token string">\'d\'</span><span class="token punctuation">,</span> <span class="token string">\'e\'</span><span class="token punctuation">,</span> <span class="token string">\'f\'</span><span class="token punctuation">,</span> <span class="token string">\'g\'</span><span class="token punctuation">,</span> <span class="token string">\'h\'</span><span class="token punctuation">]</span>\nb <span class="token operator">=</span> a\nc <span class="token operator">=</span> a<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Before a\'</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Before b\'</span><span class="token punctuation">,</span> b<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Before c\'</span><span class="token punctuation">,</span> b<span class="token punctuation">)</span>\na<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">101</span><span class="token punctuation">,</span> <span class="token number">102</span><span class="token punctuation">,</span> <span class="token number">103</span><span class="token punctuation">]</span>\n<span class="token keyword">assert</span> b <span class="token keyword">is</span> a <span class="token keyword">and</span> c <span class="token keyword">is</span> <span class="token keyword">not</span> a  <span class="token comment"># Still the same list object</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'After a \'</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span>  <span class="token comment"># Now has different contents</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'After b \'</span><span class="token punctuation">,</span> b<span class="token punctuation">)</span>  <span class="token comment"># Same list, so same contents as a</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'After c \'</span><span class="token punctuation">,</span> c<span class="token punctuation">)</span>  <span class="token comment"># Not same list, same contents as a</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nBefore a <span class="token punctuation">[</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">,</span> <span class="token string">\'c\'</span><span class="token punctuation">,</span> <span class="token string">\'d\'</span><span class="token punctuation">,</span> <span class="token string">\'e\'</span><span class="token punctuation">,</span> <span class="token string">\'f\'</span><span class="token punctuation">,</span> <span class="token string">\'g\'</span><span class="token punctuation">,</span> <span class="token string">\'h\'</span><span class="token punctuation">]</span>\nBefore b <span class="token punctuation">[</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">,</span> <span class="token string">\'c\'</span><span class="token punctuation">,</span> <span class="token string">\'d\'</span><span class="token punctuation">,</span> <span class="token string">\'e\'</span><span class="token punctuation">,</span> <span class="token string">\'f\'</span><span class="token punctuation">,</span> <span class="token string">\'g\'</span><span class="token punctuation">,</span> <span class="token string">\'h\'</span><span class="token punctuation">]</span>\nBefore c <span class="token punctuation">[</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">,</span> <span class="token string">\'c\'</span><span class="token punctuation">,</span> <span class="token string">\'d\'</span><span class="token punctuation">,</span> <span class="token string">\'e\'</span><span class="token punctuation">,</span> <span class="token string">\'f\'</span><span class="token punctuation">,</span> <span class="token string">\'g\'</span><span class="token punctuation">,</span> <span class="token string">\'h\'</span><span class="token punctuation">]</span>\nAfter a  <span class="token punctuation">[</span><span class="token number">101</span><span class="token punctuation">,</span> <span class="token number">102</span><span class="token punctuation">,</span> <span class="token number">103</span><span class="token punctuation">]</span>\nAfter b  <span class="token punctuation">[</span><span class="token number">101</span><span class="token punctuation">,</span> <span class="token number">102</span><span class="token punctuation">,</span> <span class="token number">103</span><span class="token punctuation">]</span>\nAfter c  <span class="token punctuation">[</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">,</span> <span class="token string">\'c\'</span><span class="token punctuation">,</span> <span class="token string">\'d\'</span><span class="token punctuation">,</span> <span class="token string">\'e\'</span><span class="token punctuation">,</span> <span class="token string">\'f\'</span><span class="token punctuation">,</span> <span class="token string">\'g\'</span><span class="token punctuation">,</span> <span class="token string">\'h\'</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="总结-7"><a href="#%E6%80%BB%E7%BB%93-7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>切片要尽可能写得简单一些：如果从头开始选取，就省略起始下标 0；如果选到序列末尾，就省略终止下标。</li>\n<li>切片允许起始下标或终止下标越界，所以很容易就能表达“取开头多少个元素”（例如 <code class="language-text">a[:20]</code>）或“取末尾多少个元素”（例如 <code class="language-text">a[-20:0]</code>）等含义，而不用担心切片是否真有这么多元素。</li>\n<li>把切片放在赋值符号的左侧可以将原列表中这段范围内的元素用赋值符号右侧的元素替换掉，但可能会改变原列表的长度。</li>\n</ol>\n<h2 id="第-12-条：不要在切片里同时指定起止下标与步进"><a href="#%E7%AC%AC-12-%E6%9D%A1%EF%BC%9A%E4%B8%8D%E8%A6%81%E5%9C%A8%E5%88%87%E7%89%87%E9%87%8C%E5%90%8C%E6%97%B6%E6%8C%87%E5%AE%9A%E8%B5%B7%E6%AD%A2%E4%B8%8B%E6%A0%87%E4%B8%8E%E6%AD%A5%E8%BF%9B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 12 条：不要在切片里同时指定起止下标与步进</h2>\n<p>除了基本的切片写法（参见第 11 条）外，Python 还有一种特殊的步进切片形式，也就是 somelist[start:end:stride]。这种形式会在每 n 个元素里面选取一个，这样很容易就能把奇数位置上的元素与偶数位置上的元素分别通过 <code class="language-text">x[::2]</code> 与 <code class="language-text">x[1::2]</code> 选取出来。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="41914881446414156000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`x = [\'red\', \'orange\', \'yellow\', \'green\', \'blue\', \'purple\']\nodds = x[::2]\nevens = x[1::2]\nprint(odds)\nprint(evens)\n\n>>>\n[\'red\', \'yellow\', \'blue\']\n[\'orange\', \'green\', \'purple\']`, `41914881446414156000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">x <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'red\'</span><span class="token punctuation">,</span> <span class="token string">\'orange\'</span><span class="token punctuation">,</span> <span class="token string">\'yellow\'</span><span class="token punctuation">,</span> <span class="token string">\'green\'</span><span class="token punctuation">,</span> <span class="token string">\'blue\'</span><span class="token punctuation">,</span> <span class="token string">\'purple\'</span><span class="token punctuation">]</span>\nodds <span class="token operator">=</span> x<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>\nevens <span class="token operator">=</span> x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>odds<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>evens<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">[</span><span class="token string">\'red\'</span><span class="token punctuation">,</span> <span class="token string">\'yellow\'</span><span class="token punctuation">,</span> <span class="token string">\'blue\'</span><span class="token punctuation">]</span>\n<span class="token punctuation">[</span><span class="token string">\'orange\'</span><span class="token punctuation">,</span> <span class="token string">\'green\'</span><span class="token punctuation">,</span> <span class="token string">\'purple\'</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>带有步进的切片经常会引发意外的效果，并且使程序出现 bug。例如，Python 里面有个常见的技巧，就是把 -1 当成步进值对 bytes 类型的字符串做切片，这样就能将字符串反转过来。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="1774430610408450600"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`x = b\'mongoose\'\ny = x[::-1]\nprint(y)\n\n>>>\nb\'esoognom\'`, `1774430610408450600`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">x <span class="token operator">=</span> <span class="token string">b\'mongoose\'</span>\ny <span class="token operator">=</span> x<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token string">b\'esoognom\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Unicode 形式的字符串也可以这样反转（参见第 3 条）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="50107954765194780000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`x = \'多喝水\'\ny = x[::-1]\nprint(y)\n\n>>>\n水喝多`, `50107954765194780000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">x <span class="token operator">=</span> <span class="token string">\'多喝水\'</span>\ny <span class="token operator">=</span> x<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n水喝多</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>但如果把这种字符串编码成 UTF-8 标准的字节数据，就不能用这个技巧来反转了。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="91351515986285100000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`x = \'多喝水\'\nx = x.encode(\'utf-8\')\ny = x[::-1]\nz = y.decode(\'utf-8\')\n\n>>>\nTraceback ...\nUnicodeDecodeError: \'utf-8\' codec can\'t decode byte 0xb4 in position 0: invalid start byte`, `91351515986285100000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">x <span class="token operator">=</span> <span class="token string">\'多喝水\'</span>\nx <span class="token operator">=</span> x<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">\'utf-8\'</span><span class="token punctuation">)</span>\ny <span class="token operator">=</span> x<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>\nz <span class="token operator">=</span> y<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">\'utf-8\'</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nUnicodeDecodeError<span class="token punctuation">:</span> <span class="token string">\'utf-8\'</span> codec can\'t decode byte <span class="token number">0xb4</span> <span class="token keyword">in</span> position <span class="token number">0</span><span class="token punctuation">:</span> invalid start byte</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>除了 -1 之外，用其他负数做步进值，有没有意义呢？请看下面的例子：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="14101829987150905000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`x = [\'a\', \'b\', \'c\', \'d\', \'e\', \'f\', \'g\', \'h\']\nprint(x[::2])  # [\'a\', \'c\', \'e\', \'g\']\nprint(x[::-2])  # [\'h\', \'f\', \'d\', \'b\']`, `14101829987150905000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">x <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">,</span> <span class="token string">\'c\'</span><span class="token punctuation">,</span> <span class="token string">\'d\'</span><span class="token punctuation">,</span> <span class="token string">\'e\'</span><span class="token punctuation">,</span> <span class="token string">\'f\'</span><span class="token punctuation">,</span> <span class="token string">\'g\'</span><span class="token punctuation">,</span> <span class="token string">\'h\'</span><span class="token punctuation">]</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># [\'a\', \'c\', \'e\', \'g\']</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># [\'h\', \'f\', \'d\', \'b\']</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>上例中，<code class="language-text">::2</code> 表示从头开始往后选，每两个元素里面选一个。<code class="language-text">::-2</code> 的含义稍微有点儿绕，表示从末尾开始往前选，每两个元素里面选一个。</p>\n<p>同时使用起止下标与步进会让切片很难懂。方括号里面写三个值显得太过拥挤，读起来不大容易，而且在指定了步进值（尤其是负数步进值）的时候，我们必须很仔细地考虑：这究竟是从前往后取，还是从后往前取？</p>\n<p>为了避免这个问题，笔者建议大家不要把起止下标和步进值同时写在切片里。如果必须指定步进，那么尽量采用正数，而且要把起止下标都留空。即便必须同时使用步进值与起止下标，也应该考虑分成两次来写。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="47722449867684856000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`y = x[::2]  # [\'a\', \'c\', \'e\', \'g\']\nz = y[1:-1] # [\'c\', \'e\']`, `47722449867684856000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">y <span class="token operator">=</span> x<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>  <span class="token comment"># [\'a\', \'c\', \'e\', \'g\']</span>\nz <span class="token operator">=</span> y<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token comment"># [\'c\', \'e\']</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>像刚才那样先隔位选取然后再切割，会让程序多做一次浅拷贝（shallow copy）。所以，应该把最能缩减列表长度的那个切片操作放在前面。如果程序实在没有那么多时间或内存去分两步操作，那么可以改用内置的 itertools 模块中的 islice 方法（参见第 36 条），这个方法用起来更清晰，因为它的起止位置与步进值都不能是负数。</p>\n<h3 id="总结-8"><a href="#%E6%80%BB%E7%BB%93-8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>同时指定切片的起止下标与步进值理解起来会很困难。</li>\n<li>如果要指定步进值，那就省略起止下标，而且最好采用正数作为步进值，尽量别用负数。</li>\n<li>不要把起始位置、终止位置与步进值全都写在同一个切片操作里。如果必须同时使用这三项指标，那就分两次来做（其中一次隔位选取，另一次做切割），也可以改用 itertools 内置模块里的 islice 方法。</li>\n</ol>\n<h2 id="第-13-条：通过带星号的-unpacking-操作来捕获多个元素，不要用切片"><a href="#%E7%AC%AC-13-%E6%9D%A1%EF%BC%9A%E9%80%9A%E8%BF%87%E5%B8%A6%E6%98%9F%E5%8F%B7%E7%9A%84-unpacking-%E6%93%8D%E4%BD%9C%E6%9D%A5%E6%8D%95%E8%8E%B7%E5%A4%9A%E4%B8%AA%E5%85%83%E7%B4%A0%EF%BC%8C%E4%B8%8D%E8%A6%81%E7%94%A8%E5%88%87%E7%89%87" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 13 条：通过带星号的 unpacking 操作来捕获多个元素，不要用切片</h2>\n<p>基本的 unpacking 操作（参见第 6 条）有一项限制，就是必须提前确定需要拆解的序列的长度。例如，销售汽车的时候，我们可能会把每辆车的车龄写在一份列表中，然后按照从大到小的顺序排列好。如果试着通过基本的 unpacking 操作获取其中最旧的两辆车，那么程序运行时会出现异常。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="7359484142389539000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`car_ages = [0, 9, 4, 8, 7, 20, 19, 1, 6, 15]\ncar_ages_descending = sorted(car_ages, reverse=True)\noldest, second_oldest = car_ages_descending\n\n>>>\nTraceback ...\nValueError: too many values to unpack (expected 2)`, `7359484142389539000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">car_ages <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">]</span>\ncar_ages_descending <span class="token operator">=</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span>car_ages<span class="token punctuation">,</span> reverse<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>\noldest<span class="token punctuation">,</span> second_oldest <span class="token operator">=</span> car_ages_descending\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nValueError<span class="token punctuation">:</span> too many values to unpack <span class="token punctuation">(</span>expected <span class="token number">2</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Python 新手经常通过下标与切片（参见第 11 条）来处理这个问题。例如，可以明确通过下标把最旧和第二旧的那两辆车取出来，然后把其余的车放到另一份列表中。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="8701044635870336000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`car_ages = [0, 9, 4, 8, 7, 20, 19, 1, 6, 15]\ncar_ages_descending = sorted(car_ages, reverse=True)\noldest = car_ages_descending[0]\nsecond_oldest = car_ages_descending[1]\nothers = car_ages_descending[2:]\nprint(oldest, second_oldest, others)\n\n>>>\n20 19 [15, 9, 8, 7, 6, 4, 1, 0]`, `8701044635870336000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">car_ages <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">]</span>\ncar_ages_descending <span class="token operator">=</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span>car_ages<span class="token punctuation">,</span> reverse<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>\noldest <span class="token operator">=</span> car_ages_descending<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>\nsecond_oldest <span class="token operator">=</span> car_ages_descending<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>\nothers <span class="token operator">=</span> car_ages_descending<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>oldest<span class="token punctuation">,</span> second_oldest<span class="token punctuation">,</span> others<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token number">20</span> <span class="token number">19</span> <span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样做没问题，但是下标与切片会让代码看起来很乱。而且，用这种办法把序列中的元素分成多个子集合，其实很容易出错，因为我们通常容易把下标多写或少写一个位置。例如，若修改了其中一行，但却忘了更新另一行，那就会遇到这种错误。</p>\n<p>这个问题通过带星号的表达式（starred expression）来解决会更好一些，这也是一种 unpacking 操作，它可以把无法由普通变量接收的那些元素全都囊括进去。下面用带星号的 unpacking 操作改写刚才那段代码，这次既不用取下标，也不用做切片。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="98098289642499960000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`car_ages = [0, 9, 4, 8, 7, 20, 19, 1, 6, 15]\ncar_ages_descending = sorted(car_ages, reverse=True)\noldest, second_oldest, *others = car_ages_descending\nprint(oldest, second_oldest, others)\n\n>>>\n20 19 [15, 9, 8, 7, 6, 4, 1, 0]`, `98098289642499960000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">car_ages <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">]</span>\ncar_ages_descending <span class="token operator">=</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span>car_ages<span class="token punctuation">,</span> reverse<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>\noldest<span class="token punctuation">,</span> second_oldest<span class="token punctuation">,</span> <span class="token operator">*</span>others <span class="token operator">=</span> car_ages_descending\n<span class="token keyword">print</span><span class="token punctuation">(</span>oldest<span class="token punctuation">,</span> second_oldest<span class="token punctuation">,</span> others<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token number">20</span> <span class="token number">19</span> <span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样写简短易读，而且不容易出错，因为它不要求我们在修改完其中一个下标之后，还必须记得同步更新其他的下标。</p>\n<p>这种带星号的表达式可以出现在任意位置，所以它能够捕获序列中的任何一段元素。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="88890623757585810000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`car_ages = [0, 9, 4, 8, 7, 20, 19, 1, 6, 15]\ncar_ages_descending = sorted(car_ages, reverse=True)\noldest, *others, youngest = car_ages_descending\nprint(oldest, youngest, others)\n*others, second_youngest, youngest = car_ages_descending\nprint(youngest, second_youngest, others)\n\n>>>\n20 0 [19, 15, 9, 8, 7, 6, 4, 1]\n0 1 [20, 19, 15, 9, 8, 7, 6, 4]`, `88890623757585810000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">car_ages <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">]</span>\ncar_ages_descending <span class="token operator">=</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span>car_ages<span class="token punctuation">,</span> reverse<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>\noldest<span class="token punctuation">,</span> <span class="token operator">*</span>others<span class="token punctuation">,</span> youngest <span class="token operator">=</span> car_ages_descending\n<span class="token keyword">print</span><span class="token punctuation">(</span>oldest<span class="token punctuation">,</span> youngest<span class="token punctuation">,</span> others<span class="token punctuation">)</span>\n<span class="token operator">*</span>others<span class="token punctuation">,</span> second_youngest<span class="token punctuation">,</span> youngest <span class="token operator">=</span> car_ages_descending\n<span class="token keyword">print</span><span class="token punctuation">(</span>youngest<span class="token punctuation">,</span> second_youngest<span class="token punctuation">,</span> others<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token number">20</span> <span class="token number">0</span> <span class="token punctuation">[</span><span class="token number">19</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>\n<span class="token number">0</span> <span class="token number">1</span> <span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>只不过，在使用这种写法时，至少要有一个普通的接收变量与它搭配，否则就会出现 SyntaxError。例如不能像下面这样，只使用带星号的表达式而不搭配普通变量。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="31399554983643107000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`car_ages = [0, 9, 4, 8, 7, 20, 19, 1, 6, 15]\ncar_ages_descending = sorted(car_ages, reverse=True)\n*others = car_ages_descending\n\n>>>\nSyntaxError: starred assignment target must be in a list or tuple`, `31399554983643107000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">car_ages <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">]</span>\ncar_ages_descending <span class="token operator">=</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span>car_ages<span class="token punctuation">,</span> reverse<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>\n<span class="token operator">*</span>others <span class="token operator">=</span> car_ages_descending\n\n<span class="token operator">>></span><span class="token operator">></span>\nSyntaxError<span class="token punctuation">:</span> starred assignment target must be <span class="token keyword">in</span> a <span class="token builtin">list</span> <span class="token keyword">or</span> <span class="token builtin">tuple</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>另外，对于单层结构来说，同一级里面最多只能出现一次带星号的 unpacking。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="32563482293832925000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`first, *middle, *second_middle, last = [1, 2, 3, 4]\n\n>>>\nSyntaxError: two starred expressions in assignment`, `32563482293832925000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">first<span class="token punctuation">,</span> <span class="token operator">*</span>middle<span class="token punctuation">,</span> <span class="token operator">*</span>second_middle<span class="token punctuation">,</span> last <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nSyntaxError<span class="token punctuation">:</span> two starred expressions <span class="token keyword">in</span> assignment</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果要拆解的结构有很多层，那么同一级的不同部分里面可以各自出现带星号的 unpacking 操作。当然笔者并不推荐这种写法（类似的建议参见第 19 条）。这里举这样一个例子，是想帮助大家理解这种带星号的表达式可以实现怎样的拆分效果。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="54225068901487280000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`car_inventory = {\n    \'Downtown\': (\'Silver Shadow\', \'Pinto\', \'DMC\'),\n    \'Airport\': (\'Skyline\', \'Viper\', \'Gremlin\', \'Nova\'),\n}\n\n((loc1, (best1, *rest1)),\n (loc2, (best2, *rest2))) = car_inventory.items()\nprint(f\'Best at {loc1} is {best1}, {len(rest1)} others\')\nprint(f\'Best at {loc2} is {best2}, {len(rest2)} others\')\n\n>>>\nBest at Downtown is Silver Shadow, 2 others\nBest at Airport is Skyline, 3 others`, `54225068901487280000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">car_inventory <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token string">\'Downtown\'</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token string">\'Silver Shadow\'</span><span class="token punctuation">,</span> <span class="token string">\'Pinto\'</span><span class="token punctuation">,</span> <span class="token string">\'DMC\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token string">\'Airport\'</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token string">\'Skyline\'</span><span class="token punctuation">,</span> <span class="token string">\'Viper\'</span><span class="token punctuation">,</span> <span class="token string">\'Gremlin\'</span><span class="token punctuation">,</span> <span class="token string">\'Nova\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\n\n<span class="token punctuation">(</span><span class="token punctuation">(</span>loc1<span class="token punctuation">,</span> <span class="token punctuation">(</span>best1<span class="token punctuation">,</span> <span class="token operator">*</span>rest1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n <span class="token punctuation">(</span>loc2<span class="token punctuation">,</span> <span class="token punctuation">(</span>best2<span class="token punctuation">,</span> <span class="token operator">*</span>rest2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> car_inventory<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Best at </span><span class="token interpolation"><span class="token punctuation">{</span>loc1<span class="token punctuation">}</span></span><span class="token string"> is </span><span class="token interpolation"><span class="token punctuation">{</span>best1<span class="token punctuation">}</span></span><span class="token string">, </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">len</span><span class="token punctuation">(</span>rest1<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> others\'</span></span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Best at </span><span class="token interpolation"><span class="token punctuation">{</span>loc2<span class="token punctuation">}</span></span><span class="token string"> is </span><span class="token interpolation"><span class="token punctuation">{</span>best2<span class="token punctuation">}</span></span><span class="token string">, </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">len</span><span class="token punctuation">(</span>rest2<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> others\'</span></span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nBest at Downtown <span class="token keyword">is</span> Silver Shadow<span class="token punctuation">,</span> <span class="token number">2</span> others\nBest at Airport <span class="token keyword">is</span> Skyline<span class="token punctuation">,</span> <span class="token number">3</span> others</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>带星号的表达式总会形成一份列表实例。如果要拆分的序列里已经没有元素留给它了，那么列表就是空白的。如果能提前确定有待处理的序列里至少会有 N 个元素，那么这项特性就相当有用。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="64222187617247450000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`short_list = [1, 2]\nfirst, second, *rest = short_list\nprint(first, second, rest)\n\n>>>\n1 2 []`, `64222187617247450000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">short_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span>\nfirst<span class="token punctuation">,</span> second<span class="token punctuation">,</span> <span class="token operator">*</span>rest <span class="token operator">=</span> short_list\n<span class="token keyword">print</span><span class="token punctuation">(</span>first<span class="token punctuation">,</span> second<span class="token punctuation">,</span> rest<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token number">1</span> <span class="token number">2</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>unpacking 操作也可以用在迭代器上，但是这样写与把数据拆分到多个变量里面的那种基本写法相比，并没有太大优势。例如，我可以先构造长度为 2 的取值范围（range），并把它封装在 it 这个迭代器里，然后将其中的值拆分到 first 与 second 这两个变量里。但这样写还不如直接使用形式相符的静态列表（例如[1, 2]），那样更简单。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="1476787451075623000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`it = iter(range(1, 3))\nfirst, second = it\nprint(f\'{first} and {second}\')\n\n>>>\n1 and 2`, `1476787451075623000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">it <span class="token operator">=</span> <span class="token builtin">iter</span><span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\nfirst<span class="token punctuation">,</span> second <span class="token operator">=</span> it\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>first<span class="token punctuation">}</span></span><span class="token string"> and </span><span class="token interpolation"><span class="token punctuation">{</span>second<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token number">1</span> <span class="token keyword">and</span> <span class="token number">2</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>对迭代器做 unpacking 操作的好处，主要体现在带星号的用法上面，它使迭代器的拆分值更清晰。例如，这里有个生成器，每次可以从含有整个一周的汽车订单的 CSV 文件中取出一行数据。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="17671778075612110000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def generate_csv():\n    yield (\'Date\', \'Make\', \'Model\', \'Year\', \'Price\')\n    # ...`, `17671778075612110000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">generate_csv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">yield</span> <span class="token punctuation">(</span><span class="token string">\'Date\'</span><span class="token punctuation">,</span> <span class="token string">\'Make\'</span><span class="token punctuation">,</span> <span class="token string">\'Model\'</span><span class="token punctuation">,</span> <span class="token string">\'Year\'</span><span class="token punctuation">,</span> <span class="token string">\'Price\'</span><span class="token punctuation">)</span>\n    <span class="token comment"># ...</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>我们可以用下标和切片来处理这个生成器所给出的结果，但这样写需要很多行代码，而且看着比较混乱。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="41161957562896000000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def generate_csv():\n    yield (\'Date\', \'Make\', \'Model\', \'Year\', \'Price\')\n    yield (\'Date\', \'Make\', \'Model\', \'Year\', \'Price\')\n    yield (\'Date\', \'Make\', \'Model\', \'Year\', \'Price\')\n    yield (\'Date\', \'Make\', \'Model\', \'Year\', \'Price\')\n    yield (\'Date\', \'Make\', \'Model\', \'Year\', \'Price\')\n    # ...\n\n\nall_csv_rows = list(generate_csv())\nheader = all_csv_rows[0]\nrows = all_csv_rows[1:]\nprint(\'CSV Header:\', header)\nprint(\'Row count:\', len(rows))\n\n>>>\nCSV Header: (\'Date\', \'Make\', \'Model\', \'Year\', \'Price\')\nRow count: 4`, `41161957562896000000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">generate_csv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">yield</span> <span class="token punctuation">(</span><span class="token string">\'Date\'</span><span class="token punctuation">,</span> <span class="token string">\'Make\'</span><span class="token punctuation">,</span> <span class="token string">\'Model\'</span><span class="token punctuation">,</span> <span class="token string">\'Year\'</span><span class="token punctuation">,</span> <span class="token string">\'Price\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">yield</span> <span class="token punctuation">(</span><span class="token string">\'Date\'</span><span class="token punctuation">,</span> <span class="token string">\'Make\'</span><span class="token punctuation">,</span> <span class="token string">\'Model\'</span><span class="token punctuation">,</span> <span class="token string">\'Year\'</span><span class="token punctuation">,</span> <span class="token string">\'Price\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">yield</span> <span class="token punctuation">(</span><span class="token string">\'Date\'</span><span class="token punctuation">,</span> <span class="token string">\'Make\'</span><span class="token punctuation">,</span> <span class="token string">\'Model\'</span><span class="token punctuation">,</span> <span class="token string">\'Year\'</span><span class="token punctuation">,</span> <span class="token string">\'Price\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">yield</span> <span class="token punctuation">(</span><span class="token string">\'Date\'</span><span class="token punctuation">,</span> <span class="token string">\'Make\'</span><span class="token punctuation">,</span> <span class="token string">\'Model\'</span><span class="token punctuation">,</span> <span class="token string">\'Year\'</span><span class="token punctuation">,</span> <span class="token string">\'Price\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">yield</span> <span class="token punctuation">(</span><span class="token string">\'Date\'</span><span class="token punctuation">,</span> <span class="token string">\'Make\'</span><span class="token punctuation">,</span> <span class="token string">\'Model\'</span><span class="token punctuation">,</span> <span class="token string">\'Year\'</span><span class="token punctuation">,</span> <span class="token string">\'Price\'</span><span class="token punctuation">)</span>\n    <span class="token comment"># ...</span>\n\n\nall_csv_rows <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>generate_csv<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\nheader <span class="token operator">=</span> all_csv_rows<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>\nrows <span class="token operator">=</span> all_csv_rows<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'CSV Header:\'</span><span class="token punctuation">,</span> header<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Row count:\'</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>rows<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nCSV Header<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token string">\'Date\'</span><span class="token punctuation">,</span> <span class="token string">\'Make\'</span><span class="token punctuation">,</span> <span class="token string">\'Model\'</span><span class="token punctuation">,</span> <span class="token string">\'Year\'</span><span class="token punctuation">,</span> <span class="token string">\'Price\'</span><span class="token punctuation">)</span>\nRow count<span class="token punctuation">:</span> <span class="token number">4</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>利用带星号的 unpacking 操作，我们可以把第一行（表头）单独放在 header 变量里，同时把迭代器所给出的其余内容合起来表示成 rows 变量。这样写就清楚多了。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="24141490430310597000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def generate_csv():\n    yield (\'Date\', \'Make\', \'Model\', \'Year\', \'Price\')\n    yield (\'Date\', \'Make\', \'Model\', \'Year\', \'Price\')\n    yield (\'Date\', \'Make\', \'Model\', \'Year\', \'Price\')\n    yield (\'Date\', \'Make\', \'Model\', \'Year\', \'Price\')\n    yield (\'Date\', \'Make\', \'Model\', \'Year\', \'Price\')\n    # ...\n\n\nit = list(generate_csv())\nheader, *rows = it\nprint(\'CSV Header:\', header)\nprint(\'Row count:\', len(rows))\n\n>>>\nCSV Header: (\'Date\', \'Make\', \'Model\', \'Year\', \'Price\')\nRow count: 4`, `24141490430310597000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">generate_csv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">yield</span> <span class="token punctuation">(</span><span class="token string">\'Date\'</span><span class="token punctuation">,</span> <span class="token string">\'Make\'</span><span class="token punctuation">,</span> <span class="token string">\'Model\'</span><span class="token punctuation">,</span> <span class="token string">\'Year\'</span><span class="token punctuation">,</span> <span class="token string">\'Price\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">yield</span> <span class="token punctuation">(</span><span class="token string">\'Date\'</span><span class="token punctuation">,</span> <span class="token string">\'Make\'</span><span class="token punctuation">,</span> <span class="token string">\'Model\'</span><span class="token punctuation">,</span> <span class="token string">\'Year\'</span><span class="token punctuation">,</span> <span class="token string">\'Price\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">yield</span> <span class="token punctuation">(</span><span class="token string">\'Date\'</span><span class="token punctuation">,</span> <span class="token string">\'Make\'</span><span class="token punctuation">,</span> <span class="token string">\'Model\'</span><span class="token punctuation">,</span> <span class="token string">\'Year\'</span><span class="token punctuation">,</span> <span class="token string">\'Price\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">yield</span> <span class="token punctuation">(</span><span class="token string">\'Date\'</span><span class="token punctuation">,</span> <span class="token string">\'Make\'</span><span class="token punctuation">,</span> <span class="token string">\'Model\'</span><span class="token punctuation">,</span> <span class="token string">\'Year\'</span><span class="token punctuation">,</span> <span class="token string">\'Price\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">yield</span> <span class="token punctuation">(</span><span class="token string">\'Date\'</span><span class="token punctuation">,</span> <span class="token string">\'Make\'</span><span class="token punctuation">,</span> <span class="token string">\'Model\'</span><span class="token punctuation">,</span> <span class="token string">\'Year\'</span><span class="token punctuation">,</span> <span class="token string">\'Price\'</span><span class="token punctuation">)</span>\n    <span class="token comment"># ...</span>\n\n\nit <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>generate_csv<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\nheader<span class="token punctuation">,</span> <span class="token operator">*</span>rows <span class="token operator">=</span> it\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'CSV Header:\'</span><span class="token punctuation">,</span> header<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Row count:\'</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>rows<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nCSV Header<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token string">\'Date\'</span><span class="token punctuation">,</span> <span class="token string">\'Make\'</span><span class="token punctuation">,</span> <span class="token string">\'Model\'</span><span class="token punctuation">,</span> <span class="token string">\'Year\'</span><span class="token punctuation">,</span> <span class="token string">\'Price\'</span><span class="token punctuation">)</span>\nRow count<span class="token punctuation">:</span> <span class="token number">4</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>带星号的这部分总是会形成一份列表，所以要注意，这有可能耗尽计算机的全部内存并导致程序崩溃。首先必须确定系统有足够的内存可以存储拆分出来的结果数据，然后才可以对迭代器使用带星号的 unpacking 操作（还有另一种做法，参见第 31 条）。</p>\n<h3 id="总结-9"><a href="#%E6%80%BB%E7%BB%93-9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>拆分数据结构并把其中的数据赋给变量时，可以用带星号的表达式，将结构中无法与普通变量相匹配的内容捕获到一份列表里。</li>\n<li>这种带星号的表达式可以出现在赋值符号左侧的任意位置，它总是会形成一份含有零个或多个值的列表。</li>\n<li>在把列表拆解成互相不重叠的多个部分时，这种带星号的 unpacking 方式比较清晰，而通过下标与切片来实现的方式则很容易出错。</li>\n</ol>\n<h2 id="第-14-条：用-sort-方法的-key-参数来表示复杂的排序逻辑"><a href="#%E7%AC%AC-14-%E6%9D%A1%EF%BC%9A%E7%94%A8-sort-%E6%96%B9%E6%B3%95%E7%9A%84-key-%E5%8F%82%E6%95%B0%E6%9D%A5%E8%A1%A8%E7%A4%BA%E5%A4%8D%E6%9D%82%E7%9A%84%E6%8E%92%E5%BA%8F%E9%80%BB%E8%BE%91" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 14 条：用 sort 方法的 key 参数来表示复杂的排序逻辑</h2>\n<p>内置的列表类型提供了名叫 sort 的方法，可以根据多项指标给 list 实例中的元素排序。在默认情况下，sort 方法总是按照自然升序排列列表内的元素。例如，如果列表中的元素都是整数，那么它就按数值从小到大排列。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="13275303601308664000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`numbers = [93, 86, 11, 68, 70]\nnumbers.sort()\nprint(numbers)\n\n>>>\n[11, 68, 70, 86, 93]`, `13275303601308664000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">numbers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">93</span><span class="token punctuation">,</span> <span class="token number">86</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">68</span><span class="token punctuation">,</span> <span class="token number">70</span><span class="token punctuation">]</span>\nnumbers<span class="token punctuation">.</span>sort<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">68</span><span class="token punctuation">,</span> <span class="token number">70</span><span class="token punctuation">,</span> <span class="token number">86</span><span class="token punctuation">,</span> <span class="token number">93</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这里定义了一个 Tool 类表示各种建筑工具，它带有 <code class="language-text">__repr__</code> 方法，因此我们能把这个类的实例打印成字符串。</p>\n<p>如果仅仅这样写，那么这个由该类的对象所构成的列表是没办法用 sort 方法排序的，因为 sort 方法发现，排序所需要的特殊方法并没有定义在 Tool 类中。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="78638862254474170000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Tool:\n    def __init__(self, name, weight):\n        self.name = name\n        self.weight = weight\n\n    def __repr__(self):\n        return f\'Tool({self.name!r}, {self.weight})\'\n\n\ntools = [\n    Tool(\'level\', 3.5),\n    Tool(\'hammer\', 1.25),\n    Tool(\'screwdriver\', 0.5),\n    Tool(\'chisel\', 0.25),\n]\n\ntools.sort()\n\n>>>\nTraceback ...\nTypeError: \'<\' not supported between instances of \'Tool\' and \'Tool\'`, `78638862254474170000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Tool</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> weight<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>name <span class="token operator">=</span> name\n        self<span class="token punctuation">.</span>weight <span class="token operator">=</span> weight\n\n    <span class="token keyword">def</span> <span class="token function">__repr__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f\'Tool(</span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>name<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">, </span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>weight<span class="token punctuation">}</span></span><span class="token string">)\'</span></span>\n\n\ntools <span class="token operator">=</span> <span class="token punctuation">[</span>\n    Tool<span class="token punctuation">(</span><span class="token string">\'level\'</span><span class="token punctuation">,</span> <span class="token number">3.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    Tool<span class="token punctuation">(</span><span class="token string">\'hammer\'</span><span class="token punctuation">,</span> <span class="token number">1.25</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    Tool<span class="token punctuation">(</span><span class="token string">\'screwdriver\'</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    Tool<span class="token punctuation">(</span><span class="token string">\'chisel\'</span><span class="token punctuation">,</span> <span class="token number">0.25</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n<span class="token punctuation">]</span>\n\ntools<span class="token punctuation">.</span>sort<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nTypeError<span class="token punctuation">:</span> <span class="token string">\'&lt;\'</span> <span class="token keyword">not</span> supported between instances of <span class="token string">\'Tool\'</span> <span class="token keyword">and</span> <span class="token string">\'Tool\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>下面用 lambda 关键字定义这样的一个函数，把它传给 sort 方法的 key 参数，让我们能够按照 name 的字母顺序排列这些 Tool 对象。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="59283019059083305000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Tool:\n    def __init__(self, name, weight):\n        self.name = name\n        self.weight = weight\n\n    def __repr__(self):\n        return f\'Tool({self.name!r}, {self.weight})\'\n\n\ntools = [\n    Tool(\'level\', 3.5),\n    Tool(\'hammer\', 1.25),\n    Tool(\'screwdriver\', 0.5),\n    Tool(\'chisel\', 0.25),\n]\n\nprint(\'Unsorted:\', repr(tools))\ntools.sort(key=lambda x: x.name)\nprint(\'\\nSorted:\', tools)\n\n>>>\nUnsorted: [Tool(\'level\', 3.5), Tool(\'hammer\', 1.25), Tool(\'screwdriver\', 0.5), Tool(\'chisel\', 0.25)]\n\nSorted: [Tool(\'chisel\', 0.25), Tool(\'hammer\', 1.25), Tool(\'level\', 3.5), Tool(\'screwdriver\', 0.5)]`, `59283019059083305000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Tool</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> weight<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>name <span class="token operator">=</span> name\n        self<span class="token punctuation">.</span>weight <span class="token operator">=</span> weight\n\n    <span class="token keyword">def</span> <span class="token function">__repr__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f\'Tool(</span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>name<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">, </span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>weight<span class="token punctuation">}</span></span><span class="token string">)\'</span></span>\n\n\ntools <span class="token operator">=</span> <span class="token punctuation">[</span>\n    Tool<span class="token punctuation">(</span><span class="token string">\'level\'</span><span class="token punctuation">,</span> <span class="token number">3.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    Tool<span class="token punctuation">(</span><span class="token string">\'hammer\'</span><span class="token punctuation">,</span> <span class="token number">1.25</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    Tool<span class="token punctuation">(</span><span class="token string">\'screwdriver\'</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    Tool<span class="token punctuation">(</span><span class="token string">\'chisel\'</span><span class="token punctuation">,</span> <span class="token number">0.25</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n<span class="token punctuation">]</span>\n\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Unsorted:\'</span><span class="token punctuation">,</span> <span class="token builtin">repr</span><span class="token punctuation">(</span>tools<span class="token punctuation">)</span><span class="token punctuation">)</span>\ntools<span class="token punctuation">.</span>sort<span class="token punctuation">(</span>key<span class="token operator">=</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">.</span>name<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'\\nSorted:\'</span><span class="token punctuation">,</span> tools<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nUnsorted<span class="token punctuation">:</span> <span class="token punctuation">[</span>Tool<span class="token punctuation">(</span><span class="token string">\'level\'</span><span class="token punctuation">,</span> <span class="token number">3.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Tool<span class="token punctuation">(</span><span class="token string">\'hammer\'</span><span class="token punctuation">,</span> <span class="token number">1.25</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Tool<span class="token punctuation">(</span><span class="token string">\'screwdriver\'</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Tool<span class="token punctuation">(</span><span class="token string">\'chisel\'</span><span class="token punctuation">,</span> <span class="token number">0.25</span><span class="token punctuation">)</span><span class="token punctuation">]</span>\n\nSorted<span class="token punctuation">:</span> <span class="token punctuation">[</span>Tool<span class="token punctuation">(</span><span class="token string">\'chisel\'</span><span class="token punctuation">,</span> <span class="token number">0.25</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Tool<span class="token punctuation">(</span><span class="token string">\'hammer\'</span><span class="token punctuation">,</span> <span class="token number">1.25</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Tool<span class="token punctuation">(</span><span class="token string">\'level\'</span><span class="token punctuation">,</span> <span class="token number">3.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Tool<span class="token punctuation">(</span><span class="token string">\'screwdriver\'</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>有时我们可能需要用多个标准来排序。可以利用元组的特性：如果两个元组的首个元素相等，就比较第二个元素，如果仍然相等，就继续往下比较。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="97922756638198120000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Tool:\n    def __init__(self, name, weight):\n        self.name = name\n        self.weight = weight\n\n    def __repr__(self):\n        return f\'Tool({self.name!r}, {self.weight})\'\n\n\npower_tools = [\n    Tool(\'drill\', 4),\n    Tool(\'circular saw\', 5),\n    Tool(\'jackhammer\', 40),\n    Tool(\'sander\', 4),\n]\n\npower_tools.sort(key=lambda x: (x.weight, x.name))\nprint(power_tools)\n\npower_tools.sort(key=lambda x: (x.weight, x.name), reverse=True)\nprint(power_tools)\n\n>>>\n[Tool(\'drill\', 4), Tool(\'sander\', 4), Tool(\'circular saw\', 5), Tool(\'jackhammer\', 40)]\n[Tool(\'jackhammer\', 40), Tool(\'circular saw\', 5), Tool(\'sander\', 4), Tool(\'drill\', 4)]`, `97922756638198120000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Tool</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> weight<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>name <span class="token operator">=</span> name\n        self<span class="token punctuation">.</span>weight <span class="token operator">=</span> weight\n\n    <span class="token keyword">def</span> <span class="token function">__repr__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f\'Tool(</span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>name<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">, </span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>weight<span class="token punctuation">}</span></span><span class="token string">)\'</span></span>\n\n\npower_tools <span class="token operator">=</span> <span class="token punctuation">[</span>\n    Tool<span class="token punctuation">(</span><span class="token string">\'drill\'</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    Tool<span class="token punctuation">(</span><span class="token string">\'circular saw\'</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    Tool<span class="token punctuation">(</span><span class="token string">\'jackhammer\'</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    Tool<span class="token punctuation">(</span><span class="token string">\'sander\'</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n<span class="token punctuation">]</span>\n\npower_tools<span class="token punctuation">.</span>sort<span class="token punctuation">(</span>key<span class="token operator">=</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>weight<span class="token punctuation">,</span> x<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>power_tools<span class="token punctuation">)</span>\n\npower_tools<span class="token punctuation">.</span>sort<span class="token punctuation">(</span>key<span class="token operator">=</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>weight<span class="token punctuation">,</span> x<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">,</span> reverse<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>power_tools<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">[</span>Tool<span class="token punctuation">(</span><span class="token string">\'drill\'</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Tool<span class="token punctuation">(</span><span class="token string">\'sander\'</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Tool<span class="token punctuation">(</span><span class="token string">\'circular saw\'</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Tool<span class="token punctuation">(</span><span class="token string">\'jackhammer\'</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">]</span>\n<span class="token punctuation">[</span>Tool<span class="token punctuation">(</span><span class="token string">\'jackhammer\'</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Tool<span class="token punctuation">(</span><span class="token string">\'circular saw\'</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Tool<span class="token punctuation">(</span><span class="token string">\'sander\'</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Tool<span class="token punctuation">(</span><span class="token string">\'drill\'</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这种做法有个缺点，就是 key 函数所构造的这个元组只能按同一个排序方向来对比它所表示的各项指标（要是升序，就都得是升序；要是降序，就都得是降序），可以利用以下方法实现不同方向的排序</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="31948901151284527000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`power_tools.sort(key=lambda x: (-x.weight, x.name))\nprint(power_tools)`, `31948901151284527000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">power_tools<span class="token punctuation">.</span>sort<span class="token punctuation">(</span>key<span class="token operator">=</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token operator">-</span>x<span class="token punctuation">.</span>weight<span class="token punctuation">,</span> x<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>power_tools<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>但是 str 类型不支持一元减操作符，可以通过多次调用 sort 方法实现不同方向的排序，这里利用了 sort 方法是稳定排序算法的原理</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="88014587015981020000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`power_tools.sort(key=lambda x: x.name)  # Name ascending\npower_tools.sort(key=lambda x: x.weight, reverse=True)  # Weight descending\nprint(power_tools)`, `88014587015981020000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">power_tools<span class="token punctuation">.</span>sort<span class="token punctuation">(</span>key<span class="token operator">=</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">.</span>name<span class="token punctuation">)</span>  <span class="token comment"># Name ascending</span>\npower_tools<span class="token punctuation">.</span>sort<span class="token punctuation">(</span>key<span class="token operator">=</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">.</span>weight<span class="token punctuation">,</span> reverse<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>  <span class="token comment"># Weight descending</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>power_tools<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>无论有多少项排序指标都可以按照这种思路来实现，而且每项指标可以分别按照各自的方向来排，不用全都是升序或全都是降序。只需要倒着写即可，也就是把最主要的那项排序指标放在最后一轮处理。在上面的例子中，首要指标是重量降序，次要指标是名称升序，所以先按名称升序排列，然后按重量降序排列。</p>\n<p>尽管这两种思路都能实现同样的效果，但只调用一次 sort，还是要比多次调用 sort 更为简单。所以，在实现多个指标按不同方向排序时，应该优先考虑让 key 函数返回元组，并对元组中的相应指标取相反数。只有在万不得已的时候，才可以考虑多次调用 sort 方法。</p>\n<h3 id="总结-10"><a href="#%E6%80%BB%E7%BB%93-10" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>列表的 sort 方法可以根据自然顺序给其中的字符串、整数、元组等内置类型的元素进行排序。</li>\n<li>普通对象如果通过特殊方法定义了自然顺序，那么也可以用 sort 方法来排列，但这样的对象并不多见。</li>\n<li>可以把辅助函数传给 sort 方法的 key 参数，让 sort 根据这个函数所返回的值来排列元素顺序，而不是根据元素本身来排列。</li>\n<li>如果排序时要依据的指标有很多项，可以把它们放在一个元组中，让 key 函数返回这样的元组。对于支持一元减操作符的类型来说，可以单独给这项指标取反，让排序算法在这项指标上按照相反的方向处理。</li>\n<li>如果这些指标不支持一元减操作符，可以多次调用 sort 方法，并在每次调用时分别指定 key 函数与 reverse 参数。最次要的指标放在第一轮处理，然后逐步处理更为重要的指标，首要指标放在最后一轮处理。</li>\n</ol>\n<h2 id="第-15-条：不要过分依赖给字典添加条目时所用的顺序"><a href="#%E7%AC%AC-15-%E6%9D%A1%EF%BC%9A%E4%B8%8D%E8%A6%81%E8%BF%87%E5%88%86%E4%BE%9D%E8%B5%96%E7%BB%99%E5%AD%97%E5%85%B8%E6%B7%BB%E5%8A%A0%E6%9D%A1%E7%9B%AE%E6%97%B6%E6%89%80%E7%94%A8%E7%9A%84%E9%A1%BA%E5%BA%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 15 条：不要过分依赖给字典添加条目时所用的顺序</h2>\n<p>在 Python 3.5 与之前的版本中，迭代字典（dict）时所看到的顺序好像是任意的，不一定与当初把这些键值对添加到字典时的顺序相同。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="3940677044337848000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# Python 3.5\nbaby_names = {\n    \'cat\': \'kitten\',\n    \'dog\': \'puppy\',\n}\n\nprint(baby_names)\n\n>>>\n{\'dog\': \'puppy\', \'cat\': \'kitten\'}`, `3940677044337848000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token comment"># Python 3.5</span>\nbaby_names <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token string">\'cat\'</span><span class="token punctuation">:</span> <span class="token string">\'kitten\'</span><span class="token punctuation">,</span>\n    <span class="token string">\'dog\'</span><span class="token punctuation">:</span> <span class="token string">\'puppy\'</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">print</span><span class="token punctuation">(</span>baby_names<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">{</span><span class="token string">\'dog\'</span><span class="token punctuation">:</span> <span class="token string">\'puppy\'</span><span class="token punctuation">,</span> <span class="token string">\'cat\'</span><span class="token punctuation">:</span> <span class="token string">\'kitten\'</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>之所以出现这种效果，是因为字典类型以前是用哈希表算法来实现的（这个算法通过内置的 hash 函数与一个随机的种子数来运行，而该种子数会在每次启动 Python 解释器时确定）。所以，这样的机制导致这些键值对在字典中的存放顺序不一定会与添加时的顺序相同，而且每次运行程序的时候，存放顺序可能都不一样。</p>\n<p>从 Python 3.6 开始，字典会保留这些键值对在添加时所用的顺序，而且 Python 3.7 版的语言规范正式确立了这条规则。于是，在新版的 Python 里，总是能够按照当初创建字典时的那套顺序来遍历这些键值对。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="2516050731166164000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`baby_names = {\n    \'cat\': \'kitten\',\n    \'dog\': \'puppy\',\n}\n\nprint(baby_names)\n\n>>>\n{\'cat\': \'kitten\', \'dog\': \'puppy\'}`, `2516050731166164000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">baby_names <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token string">\'cat\'</span><span class="token punctuation">:</span> <span class="token string">\'kitten\'</span><span class="token punctuation">,</span>\n    <span class="token string">\'dog\'</span><span class="token punctuation">:</span> <span class="token string">\'puppy\'</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">print</span><span class="token punctuation">(</span>baby_names<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">{</span><span class="token string">\'cat\'</span><span class="token punctuation">:</span> <span class="token string">\'kitten\'</span><span class="token punctuation">,</span> <span class="token string">\'dog\'</span><span class="token punctuation">:</span> <span class="token string">\'puppy\'</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在 Python 3.5 与之前的版本中，dict 所提供的许多方法（包括 keys、values、items 与 popitem 等）都不保证固定的顺序，所以让人觉得好像是随机处理的。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="4903841474574877000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`baby_names = {\n    \'cat\': \'kitten\',\n    \'dog\': \'puppy\',\n}\n\n# Python 3.5\nprint(list(baby_names.keys()))\nprint(list(baby_names.values()))\nprint(list(baby_names.items()))\nprint(baby_names.popitem())  # Randomly chooses an item\n\n>>>\n[\'dog\', \'cat\']\n[\'puppy\', \'kitten\']\n[(\'dog\', \'puppy\'), (\'cat\', \'kitten\')]\n(\'dog\', \'puppy\')`, `4903841474574877000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">baby_names <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token string">\'cat\'</span><span class="token punctuation">:</span> <span class="token string">\'kitten\'</span><span class="token punctuation">,</span>\n    <span class="token string">\'dog\'</span><span class="token punctuation">:</span> <span class="token string">\'puppy\'</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment"># Python 3.5</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>baby_names<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>baby_names<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>baby_names<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>baby_names<span class="token punctuation">.</span>popitem<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># Randomly chooses an item</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">[</span><span class="token string">\'dog\'</span><span class="token punctuation">,</span> <span class="token string">\'cat\'</span><span class="token punctuation">]</span>\n<span class="token punctuation">[</span><span class="token string">\'puppy\'</span><span class="token punctuation">,</span> <span class="token string">\'kitten\'</span><span class="token punctuation">]</span>\n<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">\'dog\'</span><span class="token punctuation">,</span> <span class="token string">\'puppy\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">\'cat\'</span><span class="token punctuation">,</span> <span class="token string">\'kitten\'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>\n<span class="token punctuation">(</span><span class="token string">\'dog\'</span><span class="token punctuation">,</span> <span class="token string">\'puppy\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在新版的 Python 中，这些方法已经可以按照当初添加键值对时的顺序来处理了。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="40566043860079804000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`baby_names = {\n    \'cat\': \'kitten\',\n    \'dog\': \'puppy\',\n}\n\nprint(list(baby_names.keys()))\nprint(list(baby_names.values()))\nprint(list(baby_names.items()))\nprint(baby_names.popitem())  # Randomly chooses an item\n\n>>>\n[\'cat\', \'dog\']\n[\'kitten\', \'puppy\']\n[(\'cat\', \'kitten\'), (\'dog\', \'puppy\')]\n(\'dog\', \'puppy\')`, `40566043860079804000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">baby_names <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token string">\'cat\'</span><span class="token punctuation">:</span> <span class="token string">\'kitten\'</span><span class="token punctuation">,</span>\n    <span class="token string">\'dog\'</span><span class="token punctuation">:</span> <span class="token string">\'puppy\'</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>baby_names<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>baby_names<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>baby_names<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>baby_names<span class="token punctuation">.</span>popitem<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># Randomly chooses an item</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">[</span><span class="token string">\'cat\'</span><span class="token punctuation">,</span> <span class="token string">\'dog\'</span><span class="token punctuation">]</span>\n<span class="token punctuation">[</span><span class="token string">\'kitten\'</span><span class="token punctuation">,</span> <span class="token string">\'puppy\'</span><span class="token punctuation">]</span>\n<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">\'cat\'</span><span class="token punctuation">,</span> <span class="token string">\'kitten\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">\'dog\'</span><span class="token punctuation">,</span> <span class="token string">\'puppy\'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>\n<span class="token punctuation">(</span><span class="token string">\'dog\'</span><span class="token punctuation">,</span> <span class="token string">\'puppy\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这项变化对 Python 中那些依赖字典类型及其实现细节的特性产生了很多影响。</p>\n<p>函数的关键字参数（包括万能的 <code class="language-text">**kwargs</code> 参数，参见第 23 条），以前是按照近乎随机的顺序出现的，这使函数调用操作变得很难调试。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="84779721094755480000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# Python 3.5\ndef my_func(**kwargs):\n    for key, value in kwargs.items():\n        print(\'%s = %s\' % (key, value))\n\n\nmy_func(goose=\'gosling\', kangaroo=\'joey\')\n\n>>>\nkangaroo = joey\ngoose = gosling`, `84779721094755480000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token comment"># Python 3.5</span>\n<span class="token keyword">def</span> <span class="token function">my_func</span><span class="token punctuation">(</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">for</span> key<span class="token punctuation">,</span> value <span class="token keyword">in</span> kwargs<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'%s = %s\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n\nmy_func<span class="token punctuation">(</span>goose<span class="token operator">=</span><span class="token string">\'gosling\'</span><span class="token punctuation">,</span> kangaroo<span class="token operator">=</span><span class="token string">\'joey\'</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nkangaroo <span class="token operator">=</span> joey\ngoose <span class="token operator">=</span> gosling</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在，这些关键字参数总是能够保留调用函数时所指定的那套顺序。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="53122712130124276000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def my_func(**kwargs):\n    for key, value in kwargs.items():\n        print(\'%s = %s\' % (key, value))\n\n\nmy_func(goose=\'gosling\', kangaroo=\'joey\')\n\n>>>\ngoose = gosling\nkangaroo = joey`, `53122712130124276000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">my_func</span><span class="token punctuation">(</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">for</span> key<span class="token punctuation">,</span> value <span class="token keyword">in</span> kwargs<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'%s = %s\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n\nmy_func<span class="token punctuation">(</span>goose<span class="token operator">=</span><span class="token string">\'gosling\'</span><span class="token punctuation">,</span> kangaroo<span class="token operator">=</span><span class="token string">\'joey\'</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\ngoose <span class="token operator">=</span> gosling\nkangaroo <span class="token operator">=</span> joey</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>另外，类也会利用字典来保存这个类的实例所具备的一些数据。在早前版本的 Python 中，对象（object）中的字段看上去好像是按随机顺序出现的。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="6461875500437264000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class MyClass:\n    def __init__(self):\n        self.alligator = \'hatchling\'\n        self.elephant = \'calf\'\n\n\na = MyClass()\nfor key, value in a.__dict__.items():\n    print(\'%s = %s\' % (key, value))\n\n>>>\n# Python 3.5\nelephant = calf\nalligator = hatchling\n\n# Python > 3.5\nalligator = hatchling\nelephant = calf`, `6461875500437264000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">MyClass</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>alligator <span class="token operator">=</span> <span class="token string">\'hatchling\'</span>\n        self<span class="token punctuation">.</span>elephant <span class="token operator">=</span> <span class="token string">\'calf\'</span>\n\n\na <span class="token operator">=</span> MyClass<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">for</span> key<span class="token punctuation">,</span> value <span class="token keyword">in</span> a<span class="token punctuation">.</span>__dict__<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'%s = %s\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token comment"># Python 3.5</span>\nelephant <span class="token operator">=</span> calf\nalligator <span class="token operator">=</span> hatchling\n\n<span class="token comment"># Python > 3.5</span>\nalligator <span class="token operator">=</span> hatchling\nelephant <span class="token operator">=</span> calf</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在的 Python 语言规范已经要求，字典必须保留添加键值对时所依照的顺序。所以，我们可以利用这样的特征来实现一些功能，而且可以把它融入自己给类和函数所设计的 API 中。</p>\n<blockquote>\n<p>其实，内置的 collections 模块早就提供了这种能够保留插入顺序的字典，叫作 OrderedDict。它的行为跟（Python 3.7 以来的）标准 dict 类型很像，但性能上有很大区别。如果要频繁插入或弹出键值对（例如要实现 least-recently-used 缓存），那么 OrderedDict 可能比标准的 Python dict 类型更合适（如何判断是否应该换用这种类型，请参见第 70 条）。</p>\n</blockquote>\n<p>处理字典的时候，不能总是假设所有的字典都能保留键值对插入时的顺序。在 Python 中，我们很容易就能定义出特制的容器类型，并且让这些容器也像标准的 list 与 dict 等类型那样遵守相关的协议（参见第 43 条）。Python 不是静态类型的语言，大多数代码都以鸭子类型（duck typing）机制运作（也就是说，对象支持什么样的行为，就可以当成什么样的数据使用，而不用执着于它在类体系中的地位）。这种特性可能会产生意想不到的问题。</p>\n<p>例如，现在要写一个程序，统计各种小动物的受欢迎程度。我们可以设定一个字典，把每种动物和它得到的票数关联起来。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="43343864437325160000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`votes = {\n    \'otter\': 1281,\n    \'polar bear\': 587,\n    \'fox\': 863,\n}`, `43343864437325160000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">votes <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token string">\'otter\'</span><span class="token punctuation">:</span> <span class="token number">1281</span><span class="token punctuation">,</span>\n    <span class="token string">\'polar bear\'</span><span class="token punctuation">:</span> <span class="token number">587</span><span class="token punctuation">,</span>\n    <span class="token string">\'fox\'</span><span class="token punctuation">:</span> <span class="token number">863</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在定义一个函数来处理投票数据。用户可以把空的字典传给这个函数，这样的话，它就会把每个动物及其排名放到这个字典中。这种字典可以充当数据模型，给带有用户界面（UI）的元素提供数据。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="15969816692032946000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def populate_ranks(votes, ranks):\n    names = list(votes.keys())\n    names.sort(key=votes.get, reverse=True)\n    for i, name in enumerate(names, 1):\n        ranks[name] = i`, `15969816692032946000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">populate_ranks</span><span class="token punctuation">(</span>votes<span class="token punctuation">,</span> ranks<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    names <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>votes<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n    names<span class="token punctuation">.</span>sort<span class="token punctuation">(</span>key<span class="token operator">=</span>votes<span class="token punctuation">.</span>get<span class="token punctuation">,</span> reverse<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>\n    <span class="token keyword">for</span> i<span class="token punctuation">,</span> name <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>names<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        ranks<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> i</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们还需要写一个函数来查出人气最高的动物。这个函数假定 populate_ranks 总是会按照升序向字典写入键值对，这样第一个出现在字典里的就应该是排名最靠前的动物。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="35387126035031245000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def get_winner(ranks):\n    return next(iter(ranks))`, `35387126035031245000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">get_winner</span><span class="token punctuation">(</span>ranks<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">return</span> <span class="token builtin">next</span><span class="token punctuation">(</span><span class="token builtin">iter</span><span class="token punctuation">(</span>ranks<span class="token punctuation">)</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>下面来验证刚才设计的函数，看它们能不能实现想要的结果。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="59876243412361440000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`votes = {\n    \'otter\': 1281,\n    \'polar bear\': 587,\n    \'fox\': 863,\n}\n\n\ndef populate_ranks(votes, ranks):\n    names = list(votes.keys())\n    names.sort(key=votes.get, reverse=True)\n    for i, name in enumerate(names, 1):\n        ranks[name] = i\n\n\ndef get_winner(ranks):\n    return next(iter(ranks))\n\n\nranks = {}\npopulate_ranks(votes, ranks)\nprint(ranks)\nwinner = get_winner(ranks)\nprint(winner)\n\n>>>\n{\'otter\': 1, \'fox\': 2, \'polar bear\': 3}\notter`, `59876243412361440000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">votes <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token string">\'otter\'</span><span class="token punctuation">:</span> <span class="token number">1281</span><span class="token punctuation">,</span>\n    <span class="token string">\'polar bear\'</span><span class="token punctuation">:</span> <span class="token number">587</span><span class="token punctuation">,</span>\n    <span class="token string">\'fox\'</span><span class="token punctuation">:</span> <span class="token number">863</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\n\n\n<span class="token keyword">def</span> <span class="token function">populate_ranks</span><span class="token punctuation">(</span>votes<span class="token punctuation">,</span> ranks<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    names <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>votes<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n    names<span class="token punctuation">.</span>sort<span class="token punctuation">(</span>key<span class="token operator">=</span>votes<span class="token punctuation">.</span>get<span class="token punctuation">,</span> reverse<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>\n    <span class="token keyword">for</span> i<span class="token punctuation">,</span> name <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>names<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        ranks<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> i\n\n\n<span class="token keyword">def</span> <span class="token function">get_winner</span><span class="token punctuation">(</span>ranks<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">return</span> <span class="token builtin">next</span><span class="token punctuation">(</span><span class="token builtin">iter</span><span class="token punctuation">(</span>ranks<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n\nranks <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\npopulate_ranks<span class="token punctuation">(</span>votes<span class="token punctuation">,</span> ranks<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>ranks<span class="token punctuation">)</span>\nwinner <span class="token operator">=</span> get_winner<span class="token punctuation">(</span>ranks<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>winner<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">{</span><span class="token string">\'otter\'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">\'fox\'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">\'polar bear\'</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">}</span>\notter</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>结果没有问题。但是，假设现在的需求变了，我们现在想要按照字母顺序在 UI 中显示，而不是像原来那样按照名次显示。为了实现这种效果，我们用内置的 collections.abc 模块定义这样一个类。这个类的功能和字典一样，而且会按照字母顺序迭代其中的内容。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="71437272820154690000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from collections.abc import MutableMapping\n\n\nclass SortedDict(MutableMapping):\n    def __init__(self):\n        self.data = {}\n\n    def __getitem__(self, key):\n        return self.data[key]\n\n    def __setitem__(self, key, value):\n        self.data[key] = value\n\n    def __delitem__(self, key):\n        del self.data[key]\n\n    def __iter__(self):\n        keys = list(self.data.keys())\n        keys.sort()\n        for key in keys:\n            yield key\n\n    def __len__(self):\n        return len(self.data)\n\n\nvotes = {\n    \'otter\': 1281,\n    \'polar bear\': 587,\n    \'fox\': 863,\n}\n\n\ndef populate_ranks(votes, ranks):\n    names = list(votes.keys())\n    names.sort(key=votes.get, reverse=True)\n    for i, name in enumerate(names, 1):\n        ranks[name] = i\n\n\ndef get_winner(ranks):\n    return next(iter(ranks))\n\n\nsorted_ranks = SortedDict()\npopulate_ranks(votes, sorted_ranks)\nprint(sorted_ranks.data)\nwinner = get_winner(sorted_ranks)\nprint(winner)\n\n>>>\n{\'otter\': 1, \'fox\': 2, \'polar bear\': 3}\nfox`, `71437272820154690000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> collections<span class="token punctuation">.</span>abc <span class="token keyword">import</span> MutableMapping\n\n\n<span class="token keyword">class</span> <span class="token class-name">SortedDict</span><span class="token punctuation">(</span>MutableMapping<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n\n    <span class="token keyword">def</span> <span class="token function">__getitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>data<span class="token punctuation">[</span>key<span class="token punctuation">]</span>\n\n    <span class="token keyword">def</span> <span class="token function">__setitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>data<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value\n\n    <span class="token keyword">def</span> <span class="token function">__delitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">del</span> self<span class="token punctuation">.</span>data<span class="token punctuation">[</span>key<span class="token punctuation">]</span>\n\n    <span class="token keyword">def</span> <span class="token function">__iter__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        keys <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>data<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n        keys<span class="token punctuation">.</span>sort<span class="token punctuation">(</span><span class="token punctuation">)</span>\n        <span class="token keyword">for</span> key <span class="token keyword">in</span> keys<span class="token punctuation">:</span>\n            <span class="token keyword">yield</span> key\n\n    <span class="token keyword">def</span> <span class="token function">__len__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>data<span class="token punctuation">)</span>\n\n\nvotes <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token string">\'otter\'</span><span class="token punctuation">:</span> <span class="token number">1281</span><span class="token punctuation">,</span>\n    <span class="token string">\'polar bear\'</span><span class="token punctuation">:</span> <span class="token number">587</span><span class="token punctuation">,</span>\n    <span class="token string">\'fox\'</span><span class="token punctuation">:</span> <span class="token number">863</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\n\n\n<span class="token keyword">def</span> <span class="token function">populate_ranks</span><span class="token punctuation">(</span>votes<span class="token punctuation">,</span> ranks<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    names <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>votes<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n    names<span class="token punctuation">.</span>sort<span class="token punctuation">(</span>key<span class="token operator">=</span>votes<span class="token punctuation">.</span>get<span class="token punctuation">,</span> reverse<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>\n    <span class="token keyword">for</span> i<span class="token punctuation">,</span> name <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>names<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        ranks<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> i\n\n\n<span class="token keyword">def</span> <span class="token function">get_winner</span><span class="token punctuation">(</span>ranks<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">return</span> <span class="token builtin">next</span><span class="token punctuation">(</span><span class="token builtin">iter</span><span class="token punctuation">(</span>ranks<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n\nsorted_ranks <span class="token operator">=</span> SortedDict<span class="token punctuation">(</span><span class="token punctuation">)</span>\npopulate_ranks<span class="token punctuation">(</span>votes<span class="token punctuation">,</span> sorted_ranks<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>sorted_ranks<span class="token punctuation">.</span>data<span class="token punctuation">)</span>\nwinner <span class="token operator">=</span> get_winner<span class="token punctuation">(</span>sorted_ranks<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>winner<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">{</span><span class="token string">\'otter\'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">\'fox\'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">\'polar bear\'</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">}</span>\nfox</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>没有得到预期的结果，为什么会这样呢？因为 <code class="language-text">get_winner</code> 函数总是假设，迭代字典时的顺序应该跟 <code class="language-text">populate_ranks</code> 函数当初向字典中插入数据时的顺序一样。但是这次，我们用的是 SortedDict 实例，而不是标准的 dict 实例，所以这项假设不成立。因此，函数返回的数据是按字母顺序排列时最先出现的那个数据，也就是 <code class="language-text">&#39;fox&#39;</code>，有以下 3 种解决方案：</p>\n<ol>\n<li>\n<p>重新实现 <code class="language-text">get_winner</code> 函数，使它不再假设 ranks 字典总是能按照固定的顺序来迭代。这是最保险、最稳妥的一种方案。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="70266444667391620000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def get_winner(ranks):\n  for name, rank in ranks.items():\n     if rank == 1:\n           return name\n\nwinner = get_winner(sorted_ranks)\nprint(winner)\n\n>>>\notter`, `70266444667391620000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">get_winner</span><span class="token punctuation">(</span>ranks<span class="token punctuation">)</span><span class="token punctuation">:</span>\n  <span class="token keyword">for</span> name<span class="token punctuation">,</span> rank <span class="token keyword">in</span> ranks<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n     <span class="token keyword">if</span> rank <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>\n           <span class="token keyword">return</span> name\n\nwinner <span class="token operator">=</span> get_winner<span class="token punctuation">(</span>sorted_ranks<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>winner<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\notter</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n<li>\n<p>在函数开头先判断 ranks 是不是预期的那种标准字典（dict）。如果不是，就抛出异常。这个办法的运行性能要比刚才那种好。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="83501115900359690000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def get_winner(ranks):\n  if not isinstance(ranks, dict):\n     raise TypeError(\'must provide a dict instance\')\n  return next(iter(ranks))\n\nget_winner(sorted_ranks)\n\n>>>\nTraceback ...\nTypeError: must provide a dict instance`, `83501115900359690000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">get_winner</span><span class="token punctuation">(</span>ranks<span class="token punctuation">)</span><span class="token punctuation">:</span>\n  <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>ranks<span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n     <span class="token keyword">raise</span> TypeError<span class="token punctuation">(</span><span class="token string">\'must provide a dict instance\'</span><span class="token punctuation">)</span>\n  <span class="token keyword">return</span> <span class="token builtin">next</span><span class="token punctuation">(</span><span class="token builtin">iter</span><span class="token punctuation">(</span>ranks<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\nget_winner<span class="token punctuation">(</span>sorted_ranks<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nTypeError<span class="token punctuation">:</span> must provide a <span class="token builtin">dict</span> instance</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n<li>\n<p>通过类型注解（type annotation）来保证传给 <code class="language-text">get_winner</code> 函数的确实是个真正的 dict 实例，而不是那种行为跟标准字典类似的 MutableMapping（参见第 90 条）。下面就采用严格（strict）模式，针对含有注解的代码运行 mypy 工具。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="71169168382398790000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from typing import Dict, MutableMapping\n\ndef populate_ranks(votes: Dict[str, int],\n                 ranks: Dict[str, int]) -> None:\n  names = list(votes.keys())\n  names.sort(key=votes.get, reverse=True)\n  for i, name in enumerate(names, 1):\n     ranks[name] = i\n\ndef get_winner(ranks: Dict[str, int]) -> str:\n  return next(iter(ranks))\n\nclass SortedDict(MutableMapping[str, int]):\n  def __init__(self):\n     self.data = {}\n\n  def __getitem__(self, key):\n     return self.data[key]\n\n  def __setitem__(self, key, value):\n     self.data[key] = value\n\n  def __delitem__(self, key):\n     del self.data[key]\n\n  def __iter__(self):\n     keys = list(self.data.keys())\n     keys.sort()\n     for key in keys:\n           yield key\n\n  def __len__(self):\n     return len(self.data)\n\nvotes = {\n  \'otter\': 1281,\n  \'polar bear\': 587,\n  \'fox\': 863,\n}\n\nsorted_ranks = SortedDict()\npopulate_ranks(votes, sorted_ranks)\nprint(sorted_ranks.data)\nwinner = get_winner(sorted_ranks)\nprint(winner)\n\n\\$ python3 -m mypy --strict test.py\ntest.py:42: error: Argument 2 to &quot;populate_ranks&quot; has incompatible type &quot;SortedDict&quot;; expected &quot;Dict[str, int]&quot;\ntest.py:44: error: Argument 1 to &quot;get_winner&quot; has incompatible type &quot;SortedDict&quot;; expected &quot;Dict[str, int]&quot;`, `71169168382398790000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> typing <span class="token keyword">import</span> Dict<span class="token punctuation">,</span> MutableMapping\n\n<span class="token keyword">def</span> <span class="token function">populate_ranks</span><span class="token punctuation">(</span>votes<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n                 ranks<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token boolean">None</span><span class="token punctuation">:</span>\n  names <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>votes<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n  names<span class="token punctuation">.</span>sort<span class="token punctuation">(</span>key<span class="token operator">=</span>votes<span class="token punctuation">.</span>get<span class="token punctuation">,</span> reverse<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>\n  <span class="token keyword">for</span> i<span class="token punctuation">,</span> name <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>names<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n     ranks<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> i\n\n<span class="token keyword">def</span> <span class="token function">get_winner</span><span class="token punctuation">(</span>ranks<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">str</span><span class="token punctuation">:</span>\n  <span class="token keyword">return</span> <span class="token builtin">next</span><span class="token punctuation">(</span><span class="token builtin">iter</span><span class="token punctuation">(</span>ranks<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token keyword">class</span> <span class="token class-name">SortedDict</span><span class="token punctuation">(</span>MutableMapping<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n  <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n     self<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n\n  <span class="token keyword">def</span> <span class="token function">__getitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">:</span>\n     <span class="token keyword">return</span> self<span class="token punctuation">.</span>data<span class="token punctuation">[</span>key<span class="token punctuation">]</span>\n\n  <span class="token keyword">def</span> <span class="token function">__setitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n     self<span class="token punctuation">.</span>data<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value\n\n  <span class="token keyword">def</span> <span class="token function">__delitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">:</span>\n     <span class="token keyword">del</span> self<span class="token punctuation">.</span>data<span class="token punctuation">[</span>key<span class="token punctuation">]</span>\n\n  <span class="token keyword">def</span> <span class="token function">__iter__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n     keys <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>data<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n     keys<span class="token punctuation">.</span>sort<span class="token punctuation">(</span><span class="token punctuation">)</span>\n     <span class="token keyword">for</span> key <span class="token keyword">in</span> keys<span class="token punctuation">:</span>\n           <span class="token keyword">yield</span> key\n\n  <span class="token keyword">def</span> <span class="token function">__len__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n     <span class="token keyword">return</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>data<span class="token punctuation">)</span>\n\nvotes <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token string">\'otter\'</span><span class="token punctuation">:</span> <span class="token number">1281</span><span class="token punctuation">,</span>\n  <span class="token string">\'polar bear\'</span><span class="token punctuation">:</span> <span class="token number">587</span><span class="token punctuation">,</span>\n  <span class="token string">\'fox\'</span><span class="token punctuation">:</span> <span class="token number">863</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\n\nsorted_ranks <span class="token operator">=</span> SortedDict<span class="token punctuation">(</span><span class="token punctuation">)</span>\npopulate_ranks<span class="token punctuation">(</span>votes<span class="token punctuation">,</span> sorted_ranks<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>sorted_ranks<span class="token punctuation">.</span>data<span class="token punctuation">)</span>\nwinner <span class="token operator">=</span> get_winner<span class="token punctuation">(</span>sorted_ranks<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>winner<span class="token punctuation">)</span>\n\n$ python3 <span class="token operator">-</span>m mypy <span class="token operator">-</span><span class="token operator">-</span>strict test<span class="token punctuation">.</span>py\ntest<span class="token punctuation">.</span>py<span class="token punctuation">:</span><span class="token number">42</span><span class="token punctuation">:</span> error<span class="token punctuation">:</span> Argument <span class="token number">2</span> to <span class="token string">"populate_ranks"</span> has incompatible <span class="token builtin">type</span> <span class="token string">"SortedDict"</span><span class="token punctuation">;</span> expected <span class="token string">"Dict[str, int]"</span>\ntest<span class="token punctuation">.</span>py<span class="token punctuation">:</span><span class="token number">44</span><span class="token punctuation">:</span> error<span class="token punctuation">:</span> Argument <span class="token number">1</span> to <span class="token string">"get_winner"</span> has incompatible <span class="token builtin">type</span> <span class="token string">"SortedDict"</span><span class="token punctuation">;</span> expected <span class="token string">"Dict[str, int]"</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样可以检查出类型不相符的问题，mypy 会标出错误的用法，指出函数要求的是 dict，但传入的却是 MutableMapping。这个方案既能保证静态类型准确，又不会影响程序的运行效率。</p>\n</li>\n</ol>\n<h3 id="总结-11"><a href="#%E6%80%BB%E7%BB%93-11" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>\n<p>从 Python 3.7 版开始，我们就可以确信迭代标准的字典时所看到的顺序跟这些键值对插入字典时的顺序一致。</p>\n</li>\n<li>\n<p>在 Python 代码中，我们很容易就能定义跟标准的字典很像但本身并不是 dict 实例的对象。对于这种类型的对象，不能假设迭代时看到的顺序必定与插入时的顺序相同。</p>\n</li>\n<li>\n<p>如果不想把这种跟标准字典很相似的类型也当成标准字典来处理，那么可以考虑这样三种办法。</p>\n<ol>\n<li>不要依赖插入时的顺序编写代码；</li>\n<li>在程序运行时明确判断它是不是标准的字典；</li>\n<li>给代码添加类型注解并做静态分析。</li>\n</ol>\n</li>\n</ol>\n<h2 id="第-16-条：用-get-处理键不在字典中的情况，不要使用-in-与-keyerror"><a href="#%E7%AC%AC-16-%E6%9D%A1%EF%BC%9A%E7%94%A8-get-%E5%A4%84%E7%90%86%E9%94%AE%E4%B8%8D%E5%9C%A8%E5%AD%97%E5%85%B8%E4%B8%AD%E7%9A%84%E6%83%85%E5%86%B5%EF%BC%8C%E4%B8%8D%E8%A6%81%E4%BD%BF%E7%94%A8-in-%E4%B8%8E-keyerror" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 16 条：用 get 处理键不在字典中的情况，不要使用 in 与 KeyError</h2>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="65069387204312370000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`counters = {\n    \'pumpernickel\': 2,\n    \'sourdough\': 1,\n}\n\nkey = \'wheat\'\n\nif key not in counters:\n    counters[key] = 0\ncounters[key] += 1\n\nif key in counters:\n    counters[key] += 1\nelse:\n    counters[key] = 1\n\ntry:\n    counters[key] += 1\nexcept KeyError:\n    counters[key] = 1`, `65069387204312370000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">counters <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token string">\'pumpernickel\'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>\n    <span class="token string">\'sourdough\'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\n\nkey <span class="token operator">=</span> <span class="token string">\'wheat\'</span>\n\n<span class="token keyword">if</span> key <span class="token keyword">not</span> <span class="token keyword">in</span> counters<span class="token punctuation">:</span>\n    counters<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span>\ncounters<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1</span>\n\n<span class="token keyword">if</span> key <span class="token keyword">in</span> counters<span class="token punctuation">:</span>\n    counters<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1</span>\n<span class="token keyword">else</span><span class="token punctuation">:</span>\n    counters<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span>\n\n<span class="token keyword">try</span><span class="token punctuation">:</span>\n    counters<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1</span>\n<span class="token keyword">except</span> KeyError<span class="token punctuation">:</span>\n    counters<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>使用 get 来优化</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="87578796123363890000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`counters = {\n    \'pumpernickel\': 2,\n    \'sourdough\': 1,\n}\n\nkey = \'wheat\'\n\ncount = counters.get(key, 0)\ncounters[key] = count + 1`, `87578796123363890000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">counters <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token string">\'pumpernickel\'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>\n    <span class="token string">\'sourdough\'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\n\nkey <span class="token operator">=</span> <span class="token string">\'wheat\'</span>\n\ncount <span class="token operator">=</span> counters<span class="token punctuation">.</span>get<span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>\ncounters<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> count <span class="token operator">+</span> <span class="token number">1</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果使用 setdefault 改写是有问题的，这会有一次访问、两次赋值操作</p>\n<p>而且 setdefault 不管是否有这个键，都会执行默认值的分配，这会造成比较大的性能开销</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="38527006948969930000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`count = counters.setdefault(key, 0)\ncounters[key] = count + 1`, `38527006948969930000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">count <span class="token operator">=</span> counters<span class="token punctuation">.</span>setdefault<span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>\ncounters<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> count <span class="token operator">+</span> <span class="token number">1</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>缓解性能问题的话，可以用 get 方法加赋值表达式，也可以直接用 defaultdict</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="94461623459788080000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`names = votes.get(key)\nif names is None:\n    votes[key] = names = []\nnames.append(who)\n\n# 或者使用赋值表达式\nif (names := votes.get(key)) is None:\n    votes[key] = names = []\nnames.append(who)`, `94461623459788080000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">names <span class="token operator">=</span> votes<span class="token punctuation">.</span>get<span class="token punctuation">(</span>key<span class="token punctuation">)</span>\n<span class="token keyword">if</span> names <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>\n    votes<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> names <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\nnames<span class="token punctuation">.</span>append<span class="token punctuation">(</span>who<span class="token punctuation">)</span>\n\n<span class="token comment"># 或者使用赋值表达式</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span>names <span class="token punctuation">:</span><span class="token operator">=</span> votes<span class="token punctuation">.</span>get<span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>\n    votes<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> names <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\nnames<span class="token punctuation">.</span>append<span class="token punctuation">(</span>who<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>只有与键相关联的默认值构造起来开销很低且可以变化，而且不用担心异常问题（例如 list 实例）。在这种情况下可以使用 setdefault，然而一般也优先考虑使用 defaultdict 取代 dict</p>\n<h3 id="总结-12"><a href="#%E6%80%BB%E7%BB%93-12" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>有四种办法可以处理键不在字典中的情况：in 表达式、KeyError 异常、get 方法与 setdefault 方法。</li>\n<li>如果跟键相关联的值是像计数器这样的基本类型，那么 get 方法就是最好的方案；如果是那种构造起来开销比较大，或是容易出异常的类型，那么可以把这个方法与赋值表达式结合起来使用。</li>\n<li>即使看上去最应该使用 setdefault 方案，也不一定要真的使用 setdefault 方案，而是可以考虑用 defaultdict 取代普通的 dict。</li>\n</ol>\n<h2 id="第-17-条：用-defaultdict-处理内部状态中缺失的元素，而不要用-setdefault"><a href="#%E7%AC%AC-17-%E6%9D%A1%EF%BC%9A%E7%94%A8-defaultdict-%E5%A4%84%E7%90%86%E5%86%85%E9%83%A8%E7%8A%B6%E6%80%81%E4%B8%AD%E7%BC%BA%E5%A4%B1%E7%9A%84%E5%85%83%E7%B4%A0%EF%BC%8C%E8%80%8C%E4%B8%8D%E8%A6%81%E7%94%A8-setdefault" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 17 条：用 defaultdict 处理内部状态中缺失的元素，而不要用 setdefault</h2>\n<p>通过 setdefault 方案把新的城市添加到对应的集合里，这要比利用 get 方法与赋值表达式（Python3.8 的新特性）来实现的方案短很多。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="29355587366812475000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`visits = {\n    \'Mexico\': {\'Tulum\', \'Puerto Vallarta\'},\n    \'Japan\': {\'Hakone\'},\n}\n\nvisits.setdefault(\'France\', set()).add(\'Arles\')  # Short\nif (japan := visits.get(\'Japan\')) is None:  # Long\n    visits[\'Japan\'] = japan = set()\njapan.add(\'Kyoto\')\n\nprint(visits)\n\n>>>\n{\'Mexico\': {\'Tulum\', \'Puerto Vallarta\'}, \'Japan\': {\'Kyoto\', \'Hakone\'}, \'France\': {\'Arles\'}}`, `29355587366812475000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">visits <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token string">\'Mexico\'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">\'Tulum\'</span><span class="token punctuation">,</span> <span class="token string">\'Puerto Vallarta\'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token string">\'Japan\'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">\'Hakone\'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\n\nvisits<span class="token punctuation">.</span>setdefault<span class="token punctuation">(</span><span class="token string">\'France\'</span><span class="token punctuation">,</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>add<span class="token punctuation">(</span><span class="token string">\'Arles\'</span><span class="token punctuation">)</span>  <span class="token comment"># Short</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span>japan <span class="token punctuation">:</span><span class="token operator">=</span> visits<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">\'Japan\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>  <span class="token comment"># Long</span>\n    visits<span class="token punctuation">[</span><span class="token string">\'Japan\'</span><span class="token punctuation">]</span> <span class="token operator">=</span> japan <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\njapan<span class="token punctuation">.</span>add<span class="token punctuation">(</span><span class="token string">\'Kyoto\'</span><span class="token punctuation">)</span>\n\n<span class="token keyword">print</span><span class="token punctuation">(</span>visits<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">{</span><span class="token string">\'Mexico\'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">\'Tulum\'</span><span class="token punctuation">,</span> <span class="token string">\'Puerto Vallarta\'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">\'Japan\'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">\'Kyoto\'</span><span class="token punctuation">,</span> <span class="token string">\'Hakone\'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">\'France\'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">\'Arles\'</span><span class="token punctuation">}</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果程序所访问的这个字典需要由你自己明确地创建，那又该怎么写？</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="1512155308397744600"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Visits:\n    def __init__(self):\n        self.data = {}\n\n    def add(self, country, city):\n        city_set = self.data.setdefault(country, set())\n        city_set.add(city)\n\n\nvisits = Visits()\nvisits.add(\'Russia\', \'Yekaterinburg\')\nvisits.add(\'Tanzania\', \'Zanzibar\')\nprint(visits.data)\n\n>>>\n{\'Russia\': {\'Yekaterinburg\'}, \'Tanzania\': {\'Zanzibar\'}}`, `1512155308397744600`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Visits</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n\n    <span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> country<span class="token punctuation">,</span> city<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        city_set <span class="token operator">=</span> self<span class="token punctuation">.</span>data<span class="token punctuation">.</span>setdefault<span class="token punctuation">(</span>country<span class="token punctuation">,</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n        city_set<span class="token punctuation">.</span>add<span class="token punctuation">(</span>city<span class="token punctuation">)</span>\n\n\nvisits <span class="token operator">=</span> Visits<span class="token punctuation">(</span><span class="token punctuation">)</span>\nvisits<span class="token punctuation">.</span>add<span class="token punctuation">(</span><span class="token string">\'Russia\'</span><span class="token punctuation">,</span> <span class="token string">\'Yekaterinburg\'</span><span class="token punctuation">)</span>\nvisits<span class="token punctuation">.</span>add<span class="token punctuation">(</span><span class="token string">\'Tanzania\'</span><span class="token punctuation">,</span> <span class="token string">\'Zanzibar\'</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>visits<span class="token punctuation">.</span>data<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">{</span><span class="token string">\'Russia\'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">\'Yekaterinburg\'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">\'Tanzania\'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">\'Zanzibar\'</span><span class="token punctuation">}</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>以上代码有以下问题</p>\n<ol>\n<li>调用了名字很怪的 setdefault 方法，很难让人理解发生了什么</li>\n<li>每次调用 add 方法，都会构造新的 set 实例</li>\n</ol>\n<p>改用 defaultdict 可以解决以上问题，它会在键缺失的情况下，自动添加这个键以及键所对应的默认值，每次发现键不存在时，该字典都会调用这个函数返回一份新的默认值</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="22187072296892187000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from collections import defaultdict\n\n\nclass Visits:\n    def __init__(self):\n        self.data = defaultdict(set)\n\n    def add(self, country, city):\n        self.data[country].add(city)\n\n\nvisits = Visits()\nvisits.add(\'England\', \'Bath\')\nvisits.add(\'England\', \'London\')\nprint(visits.data)\n\n>>>\ndefaultdict(<class \'set\'>, {\'England\': {\'Bath\', \'London\'}})`, `22187072296892187000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> collections <span class="token keyword">import</span> defaultdict\n\n\n<span class="token keyword">class</span> <span class="token class-name">Visits</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>data <span class="token operator">=</span> defaultdict<span class="token punctuation">(</span><span class="token builtin">set</span><span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> country<span class="token punctuation">,</span> city<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>data<span class="token punctuation">[</span>country<span class="token punctuation">]</span><span class="token punctuation">.</span>add<span class="token punctuation">(</span>city<span class="token punctuation">)</span>\n\n\nvisits <span class="token operator">=</span> Visits<span class="token punctuation">(</span><span class="token punctuation">)</span>\nvisits<span class="token punctuation">.</span>add<span class="token punctuation">(</span><span class="token string">\'England\'</span><span class="token punctuation">,</span> <span class="token string">\'Bath\'</span><span class="token punctuation">)</span>\nvisits<span class="token punctuation">.</span>add<span class="token punctuation">(</span><span class="token string">\'England\'</span><span class="token punctuation">,</span> <span class="token string">\'London\'</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>visits<span class="token punctuation">.</span>data<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\ndefaultdict<span class="token punctuation">(</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">\'set\'</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">\'England\'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">\'Bath\'</span><span class="token punctuation">,</span> <span class="token string">\'London\'</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="总结-13"><a href="#%E6%80%BB%E7%BB%93-13" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>如果你管理的字典可能需要添加任意的键，那么应该考虑能否用内置的 collections 模块中的 defaultdict 实例来解决问题。</li>\n<li>如果这种键名比较随意的字典是别人传给你的，你无法把它创建成 defaultdict，那么应该考虑通过 get 方法访问其中的键值。然而，在个别情况下，也可以考虑改用 setdefault 方法，因为那样写更短。</li>\n</ol>\n<h2 id="第-18-条：学会利用-__missing__-构造依赖键的默认值"><a href="#%E7%AC%AC-18-%E6%9D%A1%EF%BC%9A%E5%AD%A6%E4%BC%9A%E5%88%A9%E7%94%A8-__missing__-%E6%9E%84%E9%80%A0%E4%BE%9D%E8%B5%96%E9%94%AE%E7%9A%84%E9%BB%98%E8%AE%A4%E5%80%BC" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 18 条：学会利用 <code class="language-text">__missing__</code> 构造依赖键的默认值</h2>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="4016324602374266000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`pictures = {}\npath = \'profile_1234.png\'\nif (handle := pictures.get(path)) is None:\n    try:\n        handle = open(path, \'a+b\')\n    except OSError:\n        print(f\'Failed to open path {path}\')\n        raise\n    else:\n        pictures[path] = handle\n\nhandle.seek(0)\nimage_data = handle.read()`, `4016324602374266000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">pictures <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\npath <span class="token operator">=</span> <span class="token string">\'profile_1234.png\'</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span>handle <span class="token punctuation">:</span><span class="token operator">=</span> pictures<span class="token punctuation">.</span>get<span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>\n    <span class="token keyword">try</span><span class="token punctuation">:</span>\n        handle <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">\'a+b\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">except</span> OSError<span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Failed to open path </span><span class="token interpolation"><span class="token punctuation">{</span>path<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n        <span class="token keyword">raise</span>\n    <span class="token keyword">else</span><span class="token punctuation">:</span>\n        pictures<span class="token punctuation">[</span>path<span class="token punctuation">]</span> <span class="token operator">=</span> handle\n\nhandle<span class="token punctuation">.</span>seek<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>\nimage_data <span class="token operator">=</span> handle<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果改成 setdefault</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="85529709995432660000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`pictures = {}\npath = \'profile_1234.png\'\ntry:\n    handle = pictures.setdefault(path, open(path, \'a+b\'))\nexcept OSError:\n    print(f\'Failed to open path {path}\')\n    raise\nelse:\n    handle.seek(0)\n\nimage_data = handle.read()`, `85529709995432660000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">pictures <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\npath <span class="token operator">=</span> <span class="token string">\'profile_1234.png\'</span>\n<span class="token keyword">try</span><span class="token punctuation">:</span>\n    handle <span class="token operator">=</span> pictures<span class="token punctuation">.</span>setdefault<span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token builtin">open</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">\'a+b\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">except</span> OSError<span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Failed to open path </span><span class="token interpolation"><span class="token punctuation">{</span>path<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n    <span class="token keyword">raise</span>\n<span class="token keyword">else</span><span class="token punctuation">:</span>\n    handle<span class="token punctuation">.</span>seek<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>\n\nimage_data <span class="token operator">=</span> handle<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然而使用 setdefault 实现会有以下问题</p>\n<ol>\n<li>即便图片的路径名已经在字典里了，程序也还是得调用内置的 open 函数创建文件句柄，于是导致这个程序要给已经创建过 handle 的那份文件再度创建 handle（两者可能相互冲突）</li>\n<li>如果 try 块抛出异常，那我们可能无法判断这个异常是 open 函数导致的，还是 setdefault 方法导致的，因为这两次调用全都写在了同一行代码里</li>\n</ol>\n<p>理论上可以使用 defaultdict 优化，但是 defaultdict 的第二个函数不能传参</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="62601673032779910000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from collections import defaultdict\n\n\ndef open_picture(profile_path):\n    try:\n        return open(profile_path, \'a+b\')\n    except OSError:\n        print(f\'Failed to open path {profile_path}\')\n        raise\n\n\npath = \'profile_1234.png\'\npictures = defaultdict(open_picture)\nhandle = pictures[path]\nhandle.seek(0)\nimage_data = handle.read()\n\n>>>\nTraceback ...\nTypeError: open_picture() missing 1 required positional argument: \'profile_path\'`, `62601673032779910000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> collections <span class="token keyword">import</span> defaultdict\n\n\n<span class="token keyword">def</span> <span class="token function">open_picture</span><span class="token punctuation">(</span>profile_path<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">try</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token builtin">open</span><span class="token punctuation">(</span>profile_path<span class="token punctuation">,</span> <span class="token string">\'a+b\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">except</span> OSError<span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Failed to open path </span><span class="token interpolation"><span class="token punctuation">{</span>profile_path<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n        <span class="token keyword">raise</span>\n\n\npath <span class="token operator">=</span> <span class="token string">\'profile_1234.png\'</span>\npictures <span class="token operator">=</span> defaultdict<span class="token punctuation">(</span>open_picture<span class="token punctuation">)</span>\nhandle <span class="token operator">=</span> pictures<span class="token punctuation">[</span>path<span class="token punctuation">]</span>\nhandle<span class="token punctuation">.</span>seek<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>\nimage_data <span class="token operator">=</span> handle<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nTypeError<span class="token punctuation">:</span> open_picture<span class="token punctuation">(</span><span class="token punctuation">)</span> missing <span class="token number">1</span> required positional argument<span class="token punctuation">:</span> <span class="token string">\'profile_path\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以通过继承 dict 类型并实现 <code class="language-text">__missing__</code> 特殊方法来解决这个问题</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="75900876639088740000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def open_picture(profile_path):\n    try:\n        return open(profile_path, \'a+b\')\n    except OSError:\n        print(f\'Failed to open path {profile_path}\')\n        raise\n\n\nclass Pictures(dict):\n    def __missing__(self, key):\n        value = open_picture(key)\n        self[key] = value\n        return value\n\n\npath = \'profile_1234.png\'\npictures = Pictures()\nhandle = pictures[path]\nhandle.seek(0)\nimage_data = handle.read()`, `75900876639088740000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">open_picture</span><span class="token punctuation">(</span>profile_path<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">try</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token builtin">open</span><span class="token punctuation">(</span>profile_path<span class="token punctuation">,</span> <span class="token string">\'a+b\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">except</span> OSError<span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Failed to open path </span><span class="token interpolation"><span class="token punctuation">{</span>profile_path<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n        <span class="token keyword">raise</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">Pictures</span><span class="token punctuation">(</span><span class="token builtin">dict</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__missing__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        value <span class="token operator">=</span> open_picture<span class="token punctuation">(</span>key<span class="token punctuation">)</span>\n        self<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value\n        <span class="token keyword">return</span> value\n\n\npath <span class="token operator">=</span> <span class="token string">\'profile_1234.png\'</span>\npictures <span class="token operator">=</span> Pictures<span class="token punctuation">(</span><span class="token punctuation">)</span>\nhandle <span class="token operator">=</span> pictures<span class="token punctuation">[</span>path<span class="token punctuation">]</span>\nhandle<span class="token punctuation">.</span>seek<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>\nimage_data <span class="token operator">=</span> handle<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="总结-14"><a href="#%E6%80%BB%E7%BB%93-14" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>如果创建默认值需要较大的开销，或者可能抛出异常，那就不适合用 dict 类型的 setdefault 方法实现。</li>\n<li>传给 defaultdict 的函数必须是不需要参数的函数，所以无法创建出需要依赖键名的默认值。</li>\n<li>如果要构造的默认值必须根据键名来确定，那么可以定义自己的 dict 子类并实现 <code class="language-text">__missing__</code> 方法。</li>\n</ol>\n<h1 id="函数"><a href="#%E5%87%BD%E6%95%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>函数</h1>\n<h2 id="第-19-条：不要把函数返回的多个数值拆分到三个以上的变量中"><a href="#%E7%AC%AC-19-%E6%9D%A1%EF%BC%9A%E4%B8%8D%E8%A6%81%E6%8A%8A%E5%87%BD%E6%95%B0%E8%BF%94%E5%9B%9E%E7%9A%84%E5%A4%9A%E4%B8%AA%E6%95%B0%E5%80%BC%E6%8B%86%E5%88%86%E5%88%B0%E4%B8%89%E4%B8%AA%E4%BB%A5%E4%B8%8A%E7%9A%84%E5%8F%98%E9%87%8F%E4%B8%AD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 19 条：不要把函数返回的多个数值拆分到三个以上的变量中</h2>\n<p>unpacking 机制允许 Python 函数返回一个以上的值（参见第 6 条）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="17644881514113608000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def get_stats(numbers):\n    minimum = min(numbers)\n    maximum = max(numbers)\n    return minimum, maximum\n\n\nlengths = [63, 73, 72, 60, 67, 66, 71, 61, 72, 70]\nminimum, maximum = get_stats(lengths)  # Two return values\nprint(f\'Min: {minimum}, Max: {maximum}\')\n\n>>>\nMin: 60, Max: 73`, `17644881514113608000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">def <span class="token function">get_stats</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    minimum <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span>\n    maximum <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span>\n    <span class="token keyword">return</span> minimum<span class="token punctuation">,</span> maximum\n\n\nlengths <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">63</span><span class="token punctuation">,</span> <span class="token number">73</span><span class="token punctuation">,</span> <span class="token number">72</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token number">67</span><span class="token punctuation">,</span> <span class="token number">66</span><span class="token punctuation">,</span> <span class="token number">71</span><span class="token punctuation">,</span> <span class="token number">61</span><span class="token punctuation">,</span> <span class="token number">72</span><span class="token punctuation">,</span> <span class="token number">70</span><span class="token punctuation">]</span>\nminimum<span class="token punctuation">,</span> maximum <span class="token operator">=</span> <span class="token function">get_stats</span><span class="token punctuation">(</span>lengths<span class="token punctuation">)</span>  # Two <span class="token keyword">return</span> values\n<span class="token function">print</span><span class="token punctuation">(</span>f<span class="token string">\'Min: {minimum}, Max: {maximum}\'</span><span class="token punctuation">)</span>\n\n<span class="token operator">>>></span>\nMin<span class="token punctuation">:</span> <span class="token number">60</span><span class="token punctuation">,</span> Max<span class="token punctuation">:</span> <span class="token number">73</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="32595918599042650000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`first, second = 1, 2\nassert first == 1\nassert second == 2\n\n\ndef my_function():\n    return 1, 2\n\n\nfirst, second = my_function()\nassert first == 1\nassert second == 2`, `32595918599042650000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">first<span class="token punctuation">,</span> second <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span>\nassert first <span class="token operator">==</span> <span class="token number">1</span>\nassert second <span class="token operator">==</span> <span class="token number">2</span>\n\n\ndef <span class="token function">my_function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span>\n\n\nfirst<span class="token punctuation">,</span> second <span class="token operator">=</span> <span class="token function">my_function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\nassert first <span class="token operator">==</span> <span class="token number">1</span>\nassert second <span class="token operator">==</span> <span class="token number">2</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在返回多个值的时候，可以用带星号的表达式接收那些没有被普通变量捕获到的值（参见第 13 条）</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="7221307362485874000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def get_avg_ratio(numbers):\n    average = sum(numbers) / len(numbers)\n    scaled = [x / average for x in numbers]\n    scaled.sort(reverse=True)\n    return scaled\n\n\nlengths = [63, 73, 72, 60, 67, 66, 71, 61, 72, 70]\nlongest, *middle, shortest = get_avg_ratio(lengths)\nprint(f\'Longest:  {longest:>4.0%}\')\nprint(f\'Shortest: {shortest:>4.0%}\')\n\n>>>\nLongest:  108%\nShortest:  89%`, `7221307362485874000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">get_avg_ratio</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    average <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span>\n    scaled <span class="token operator">=</span> <span class="token punctuation">[</span>x <span class="token operator">/</span> average <span class="token keyword">for</span> x <span class="token keyword">in</span> numbers<span class="token punctuation">]</span>\n    scaled<span class="token punctuation">.</span>sort<span class="token punctuation">(</span>reverse<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>\n    <span class="token keyword">return</span> scaled\n\n\nlengths <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">63</span><span class="token punctuation">,</span> <span class="token number">73</span><span class="token punctuation">,</span> <span class="token number">72</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token number">67</span><span class="token punctuation">,</span> <span class="token number">66</span><span class="token punctuation">,</span> <span class="token number">71</span><span class="token punctuation">,</span> <span class="token number">61</span><span class="token punctuation">,</span> <span class="token number">72</span><span class="token punctuation">,</span> <span class="token number">70</span><span class="token punctuation">]</span>\nlongest<span class="token punctuation">,</span> <span class="token operator">*</span>middle<span class="token punctuation">,</span> shortest <span class="token operator">=</span> get_avg_ratio<span class="token punctuation">(</span>lengths<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Longest:  </span><span class="token interpolation"><span class="token punctuation">{</span>longest<span class="token punctuation">:</span><span class="token format-spec">>4.0%</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Shortest: </span><span class="token interpolation"><span class="token punctuation">{</span>shortest<span class="token punctuation">:</span><span class="token format-spec">>4.0%</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nLongest<span class="token punctuation">:</span>  <span class="token number">108</span><span class="token operator">%</span>\nShortest<span class="token punctuation">:</span>  <span class="token number">89</span><span class="token operator">%</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="99116167272389230000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def get_stats(numbers):\n    minimum = min(numbers)\n    maximum = max(numbers)\n    count = len(numbers)\n    average = sum(numbers)/count\n    sorted_numbers = sorted(numbers)\n    middle = count // 2\n    if count % 2 == 0:\n        lower = sorted_numbers[middle - 1]\n        upper = sorted_numbers[middle]\n        median = (lower + upper)/2\n    else:\n        median = sorted_numbers[middle]\n    return minimum, maximum, average, median, count\n\n\nlengths = [63, 73, 72, 60, 67, 66, 71, 61, 72, 70]\nminimum, maximum, average, median, count = get_stats(lengths)\nprint(f\'Min: {minimum}, Max: {maximum}\')\nprint(f\'Average: {average}, Median: {median}, Count: {count}\')\n\n>>>\nMin: 60, Max: 73\nAverage: 67.5, Median: 68.5, Count: 10`, `99116167272389230000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">get_stats</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    minimum <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span>\n    maximum <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span>\n    count <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span>\n    average <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span><span class="token operator">/</span>count\n    sorted_numbers <span class="token operator">=</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span>\n    middle <span class="token operator">=</span> count <span class="token operator">//</span> <span class="token number">2</span>\n    <span class="token keyword">if</span> count <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>\n        lower <span class="token operator">=</span> sorted_numbers<span class="token punctuation">[</span>middle <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span>\n        upper <span class="token operator">=</span> sorted_numbers<span class="token punctuation">[</span>middle<span class="token punctuation">]</span>\n        median <span class="token operator">=</span> <span class="token punctuation">(</span>lower <span class="token operator">+</span> upper<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span>\n    <span class="token keyword">else</span><span class="token punctuation">:</span>\n        median <span class="token operator">=</span> sorted_numbers<span class="token punctuation">[</span>middle<span class="token punctuation">]</span>\n    <span class="token keyword">return</span> minimum<span class="token punctuation">,</span> maximum<span class="token punctuation">,</span> average<span class="token punctuation">,</span> median<span class="token punctuation">,</span> count\n\n\nlengths <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">63</span><span class="token punctuation">,</span> <span class="token number">73</span><span class="token punctuation">,</span> <span class="token number">72</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token number">67</span><span class="token punctuation">,</span> <span class="token number">66</span><span class="token punctuation">,</span> <span class="token number">71</span><span class="token punctuation">,</span> <span class="token number">61</span><span class="token punctuation">,</span> <span class="token number">72</span><span class="token punctuation">,</span> <span class="token number">70</span><span class="token punctuation">]</span>\nminimum<span class="token punctuation">,</span> maximum<span class="token punctuation">,</span> average<span class="token punctuation">,</span> median<span class="token punctuation">,</span> count <span class="token operator">=</span> get_stats<span class="token punctuation">(</span>lengths<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Min: </span><span class="token interpolation"><span class="token punctuation">{</span>minimum<span class="token punctuation">}</span></span><span class="token string">, Max: </span><span class="token interpolation"><span class="token punctuation">{</span>maximum<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Average: </span><span class="token interpolation"><span class="token punctuation">{</span>average<span class="token punctuation">}</span></span><span class="token string">, Median: </span><span class="token interpolation"><span class="token punctuation">{</span>median<span class="token punctuation">}</span></span><span class="token string">, Count: </span><span class="token interpolation"><span class="token punctuation">{</span>count<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nMin<span class="token punctuation">:</span> <span class="token number">60</span><span class="token punctuation">,</span> Max<span class="token punctuation">:</span> <span class="token number">73</span>\nAverage<span class="token punctuation">:</span> <span class="token number">67.5</span><span class="token punctuation">,</span> Median<span class="token punctuation">:</span> <span class="token number">68.5</span><span class="token punctuation">,</span> Count<span class="token punctuation">:</span> <span class="token number">10</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>上面的写法有 2 个问题：</p>\n<ol>\n<li>函数返回的五个值都是数字，所以很容易就会搞错顺序</li>\n<li>调用函数并拆分返回值的那行代码会写得比较长</li>\n</ol>\n<p>为避免这些问题，我们不应该把函数返回的多个值拆分到三个以上的变量里。一个三元组最多只拆成三个普通变量，或两个普通变量与一个万能变量（带星号的变量）。当然用于接收的变量个数也可以比这更少。假如要拆分的值确实很多，那最好还是定义一个轻便的类或 namedtuple（参见第 37 条），并让函数返回这样的实例。</p>\n<h3 id="总结-15"><a href="#%E6%80%BB%E7%BB%93-15" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>函数可以把多个值合起来通过一个元组返回给调用者，以便利用 Python 的 unpacking 机制去拆分。</li>\n<li>对于函数返回的多个值，可以把普通变量没有捕获到的那些值全都捕获到一个带星号的变量里。</li>\n<li>把返回的值拆分到四个或四个以上的变量是很容易出错的，所以最好不要那么写，而是应该通过小类或 namedtuple 实例完成。</li>\n</ol>\n<h2 id="第-20-条：遇到意外状况时应该抛出异常，不要返回-none"><a href="#%E7%AC%AC-20-%E6%9D%A1%EF%BC%9A%E9%81%87%E5%88%B0%E6%84%8F%E5%A4%96%E7%8A%B6%E5%86%B5%E6%97%B6%E5%BA%94%E8%AF%A5%E6%8A%9B%E5%87%BA%E5%BC%82%E5%B8%B8%EF%BC%8C%E4%B8%8D%E8%A6%81%E8%BF%94%E5%9B%9E-none" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 20 条：遇到意外状况时应该抛出异常，不要返回 None</h2>\n<p>编写工具函数（utility function）时，许多 Python 程序员都爱用 None 这个返回值来表示特殊情况。对于某些函数来说，这或许有几分道理。</p>\n<p>例如，我们要编写一个辅助函数计算两数相除的结果。在除数是 0 的情况下，返回 None 似乎相当合理，因为这种除法的结果是没有意义的。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="76228656086805740000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def careful_divide(a, b):\n    try:\n        return a / b\n    except ZeroDivisionError:\n        return None`, `76228656086805740000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">careful_divide</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">try</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> a <span class="token operator">/</span> b\n    <span class="token keyword">except</span> ZeroDivisionError<span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token boolean">None</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>调用这个函数时，可以按自己的方式处理这样的返回值。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="8795918763120736000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def careful_divide(a, b):\n    try:\n        return a / b\n    except ZeroDivisionError:\n        return None\n\n\nx, y = 1, 0\nresult = careful_divide(x, y)\nif result is None:\n    print(\'Invalid inputs\')\n\n>>>\nInvalid inputs`, `8795918763120736000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">careful_divide</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">try</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> a <span class="token operator">/</span> b\n    <span class="token keyword">except</span> ZeroDivisionError<span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token boolean">None</span>\n\n\nx<span class="token punctuation">,</span> y <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span>\nresult <span class="token operator">=</span> careful_divide<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>\n<span class="token keyword">if</span> result <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Invalid inputs\'</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nInvalid inputs</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果传给 <code class="language-text">careful_divide</code> 函数的被除数为 0，会怎么样呢？在这种情况下，只要除数不为 0，函数返回的结果就应该是 0。</p>\n<p>问题是，这个函数的返回值有时可能会用在 if 条件语句里面，那时可能会根据值本身是否相当于 False 来做判断，而不像刚才那样明确判断这个值是否为 None（第 5 条也列举了类似的例子）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="16741336476987212000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def careful_divide(a, b):\n    try:\n        return a / b\n    except ZeroDivisionError:\n        return None\n\n\nx, y = 0, 5\nresult = careful_divide(x, y)\nif not result:\n    print(\'Invalid inputs\')  # This runs! But shouldn\'t\n\n>>>\nInvalid inputs`, `16741336476987212000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">careful_divide</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">try</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> a <span class="token operator">/</span> b\n    <span class="token keyword">except</span> ZeroDivisionError<span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token boolean">None</span>\n\n\nx<span class="token punctuation">,</span> y <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">5</span>\nresult <span class="token operator">=</span> careful_divide<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>\n<span class="token keyword">if</span> <span class="token keyword">not</span> result<span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Invalid inputs\'</span><span class="token punctuation">)</span>  <span class="token comment"># This runs! But shouldn\'t</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nInvalid inputs</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>上面这种 if 语句，会把函数返回 0 时的情况，也当成函数返回 None 时那样来处理。这种写法经常出现在 Python 代码里，因此像 <code class="language-text">careful_divide</code> 这样，用 None 来表示特殊状况的函数是很容易出错的。有两种办法可以减少这样的错误。</p>\n<ol>\n<li>\n<p>利用二元组把计算结果分成两部分返回（与这种写法有关的基础知识，参见第 19 条）。元组的首个元素表示操作是否成功，第二个元素表示计算的实际值。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="26493664668494676000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def careful_divide(a, b):\ntry:\n    return True, a / b\nexcept ZeroDivisionError:\n    return False, None`, `26493664668494676000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">careful_divide</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">:</span>\n<span class="token keyword">try</span><span class="token punctuation">:</span>\n    <span class="token keyword">return</span> <span class="token boolean">True</span><span class="token punctuation">,</span> a <span class="token operator">/</span> b\n<span class="token keyword">except</span> ZeroDivisionError<span class="token punctuation">:</span>\n    <span class="token keyword">return</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token boolean">None</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样写，会促使调用函数者去拆分返回值，他可以先看看这次运算是否成功，然后再决定怎么处理运算结果。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="91123757263675870000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`success, result = careful_divide(x, y)\nif not success:\n  print(\'Invalid inputs\')`, `91123757263675870000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">success<span class="token punctuation">,</span> result <span class="token operator">=</span> careful_divide<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>\n<span class="token keyword">if</span> <span class="token keyword">not</span> success<span class="token punctuation">:</span>\n  <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Invalid inputs\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>但问题是，有些调用方总喜欢忽略返回元组的第一个部分（在 Python 代码里，习惯用下划线表示用不到的变量）。这样写成的代码，乍一看似乎没问题，但实际上还是无法区分返回 0 与返回 None 这两种情况。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="97843061072185640000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`_, result = careful_divide(x, y)\nif not result:\n  print(\'Invalid inputs\')`, `97843061072185640000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">_<span class="token punctuation">,</span> result <span class="token operator">=</span> careful_divide<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>\n<span class="token keyword">if</span> <span class="token keyword">not</span> result<span class="token punctuation">:</span>\n  <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Invalid inputs\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n</li>\n<li>\n<p>不采用 None 表示特例，而是向调用方抛出异常（Exception），让他自己去处理。下面我们把执行除法时发生的 ZeroDivisionError 转化成 ValueError，告诉调用方输入的值不对（什么时候应该使用 Exception 类的子类，可参见第 87 条）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="26115640865079357000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def careful_divide(a, b):\ntry:\n    return a / b\nexcept ZeroDivisionError:\n    raise ValueError(\'Invalid inputs\')`, `26115640865079357000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">careful_divide</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">:</span>\n<span class="token keyword">try</span><span class="token punctuation">:</span>\n    <span class="token keyword">return</span> a <span class="token operator">/</span> b\n<span class="token keyword">except</span> ZeroDivisionError<span class="token punctuation">:</span>\n    <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">\'Invalid inputs\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在，调用方拿到函数的返回值之后，不用先判断操作是否成功了。因为这次可以假设，只要能拿到返回值，就说明函数肯定顺利执行完了，所以只需要用 try 把函数包起来并在 else 块里处理运算结果就好（这种结构的详细用法，参见第 65 条）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="53628018677424010000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def careful_divide(a, b):\ntry:\n    return a / b\nexcept ZeroDivisionError:\n    raise ValueError(\'Invalid inputs\')\n\nx, y = 5, 2\ntry:\n  result = careful_divide(x, y)\nexcept ValueError:\n  print(\'Invalid inputs\')\nelse:\n  print(\'Result is %.1f\' % result)\n\n>>>\nResult is 2.5`, `53628018677424010000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">careful_divide</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">:</span>\n<span class="token keyword">try</span><span class="token punctuation">:</span>\n    <span class="token keyword">return</span> a <span class="token operator">/</span> b\n<span class="token keyword">except</span> ZeroDivisionError<span class="token punctuation">:</span>\n    <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">\'Invalid inputs\'</span><span class="token punctuation">)</span>\n\nx<span class="token punctuation">,</span> y <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">2</span>\n<span class="token keyword">try</span><span class="token punctuation">:</span>\n  result <span class="token operator">=</span> careful_divide<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>\n<span class="token keyword">except</span> ValueError<span class="token punctuation">:</span>\n  <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Invalid inputs\'</span><span class="token punctuation">)</span>\n<span class="token keyword">else</span><span class="token punctuation">:</span>\n  <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Result is %.1f\'</span> <span class="token operator">%</span> result<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nResult <span class="token keyword">is</span> <span class="token number">2.5</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n</ol>\n<p>这个办法也可以扩展到那些使用类型注解的代码中（参见第 90 条），我们可以把函数的返回值指定为 float 类型，这样它就不可能返回 None 了。然而，Python 采用的是动态类型与静态类型相搭配的 gradual 类型系统，我们不能在函数的接口上指定函数可能抛出哪些异常（有的编程语言支持这样的受检异常（checked exception），调用方必须应对这些异常）。所以，我们只好把有可能抛出的异常写在文档里面，并希望调用方能够根据这份文档适当地捕获相关的异常（参见第 84 条）。</p>\n<p>下面我们给刚才那个函数加类型注解，并为它编写 docstring。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="64415954227671190000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def careful_divide(a: float, b: float) -> float:\n    &quot;&quot;&quot;Divides a by b.\n\n    Raises:\n      ValueError: When the inputs cannot be divided.\n    &quot;&quot;&quot;\n    try:\n        return a / b\n    except ZeroDivisionError as e:\n        raise ValueError(\'Invalid inputs\')`, `64415954227671190000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">careful_divide</span><span class="token punctuation">(</span>a<span class="token punctuation">:</span> <span class="token builtin">float</span><span class="token punctuation">,</span> b<span class="token punctuation">:</span> <span class="token builtin">float</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">float</span><span class="token punctuation">:</span>\n    <span class="token triple-quoted-string string">"""Divides a by b.\n\n    Raises:\n      ValueError: When the inputs cannot be divided.\n    """</span>\n    <span class="token keyword">try</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> a <span class="token operator">/</span> b\n    <span class="token keyword">except</span> ZeroDivisionError <span class="token keyword">as</span> e<span class="token punctuation">:</span>\n        <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">\'Invalid inputs\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样写，输入、输出与异常都显得很清晰，所以调用方出错的概率就变得很小了。</p>\n<h3 id="总结-16"><a href="#%E6%80%BB%E7%BB%93-16" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>用返回值 None 表示特殊情况是很容易出错的，因为这样的值在条件表达式里面，没办法与 0 和空白字符串之类的值区分，这些值都相当于 False。</li>\n<li>用异常表示特殊的情况，而不要返回 None。让调用这个函数的程序根据文档里写的异常情况做出处理。</li>\n<li>通过类型注解可以明确禁止函数返回 None，即便在特殊情况下，它也不能返回这个值。</li>\n</ol>\n<h2 id="第-21-条：了解如何在闭包里面使用外围作用域中的变量"><a href="#%E7%AC%AC-21-%E6%9D%A1%EF%BC%9A%E4%BA%86%E8%A7%A3%E5%A6%82%E4%BD%95%E5%9C%A8%E9%97%AD%E5%8C%85%E9%87%8C%E9%9D%A2%E4%BD%BF%E7%94%A8%E5%A4%96%E5%9B%B4%E4%BD%9C%E7%94%A8%E5%9F%9F%E4%B8%AD%E7%9A%84%E5%8F%98%E9%87%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 21 条：了解如何在闭包里面使用外围作用域中的变量</h2>\n<p>有时，我们要给列表中的元素排序，而且要优先把某个群组之中的元素放在其他元素的前面。例如，渲染用户界面时，可能就需要这样做，因为关键的消息和特殊的事件应该优先显示在其他信息之前。</p>\n<p>实现这种做法的一种常见方案，是把辅助函数通过 key 参数传给列表的 sort 方法（参见第 14 条），让这个方法根据辅助函数所返回的值来决定元素在列表中的先后顺序。辅助函数先判断当前元素是否处在重要群组里，如果在，就把返回值的第一项写成 0，让它能够排在不属于这个组的那些元素之前。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="36945794927046350000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def sort_priority(values, group):\n    def helper(x):\n        if x in group:\n            return (0, x)\n        return (1, x)\n    values.sort(key=helper)`, `36945794927046350000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">sort_priority</span><span class="token punctuation">(</span>values<span class="token punctuation">,</span> group<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">helper</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> x <span class="token keyword">in</span> group<span class="token punctuation">:</span>\n            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span>\n        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span>\n    values<span class="token punctuation">.</span>sort<span class="token punctuation">(</span>key<span class="token operator">=</span>helper<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这个函数可以处理比较简单的输入数据。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="74290763941059870000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def sort_priority(values, group):\n    def helper(x):\n        if x in group:\n            return (0, x)\n        return (1, x)\n    values.sort(key=helper)\n\n\nnumbers = [8, 3, 1, 2, 5, 4, 7, 6]\ngroup = {2, 3, 5, 7}\nsort_priority(numbers, group)\nprint(numbers)\n\n>>>\n[2, 3, 5, 7, 1, 4, 6, 8]`, `74290763941059870000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">sort_priority</span><span class="token punctuation">(</span>values<span class="token punctuation">,</span> group<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">helper</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> x <span class="token keyword">in</span> group<span class="token punctuation">:</span>\n            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span>\n        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span>\n    values<span class="token punctuation">.</span>sort<span class="token punctuation">(</span>key<span class="token operator">=</span>helper<span class="token punctuation">)</span>\n\n\nnumbers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span>\ngroup <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">}</span>\nsort_priority<span class="token punctuation">(</span>numbers<span class="token punctuation">,</span> group<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>它为什么能够实现这个功能呢？这要分三个原因来讲：</p>\n<ol>\n<li>Python 支持闭包（closure），这让定义在大函数里面的小函数也能引用大函数之中的变量。具体到这个例子，<code class="language-text">sort_priority</code> 函数里面的那个 helper 函数也能够引用前者的 group 参数。</li>\n<li>函数在 Python 里是头等对象（first-class object），所以你可以像操作其他对象那样，直接引用它们、把它们赋给变量、将它们当成参数传给其他函数，或是在 in 表达式与 if 语句里面对它做比较，等等。闭包函数也是函数，所以，同样可以传给 sort 方法的 key 参数。</li>\n<li>Python 在判断两个序列（包括元组）的大小时，有自己的一套规则。它首先比较 0 号位置的那两个元素，如果相等，那就比较 1 号位置的那两个元素；如果还相等，那就比较 2 号位置的那两个元素；依此类推，直到得出结论为止。所以，我们可以利用这套规则让 helper 这个闭包函数返回一个元组，并把关键指标写为元组的首个元素以表示当前排序的值是否属于重要群组（0 表示属于，1 表示不属于）。</li>\n</ol>\n<p>如果这个 <code class="language-text">sort_priority</code> 函数还能告诉我们，列表里面有没有位于重要群组之中的元素，那就更好了，因为这样可以让用户界面开发者更方便地做出相应处理。添加这样一个功能似乎相当简单，因为闭包函数本身就需要判断当前值是否处在重要群组之中，既然这样，那么不妨让它在发现这种值时，顺便把标志变量翻转过来。最后，让闭包外的大函数（即 <code class="language-text">sort_priority</code> 函数）返回这个标志变量，如果闭包函数当时遇到过这样的值，那么这个标志肯定是 True。</p>\n<p>下面，试着用最直接的写法来实现。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="84275997048008150000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def sort_priority2(numbers, group):\n    found = False\n\n    def helper(x):\n        if x in group:\n            found = True  # Seems simple\n            return (0, x)\n        return (1, x)\n    numbers.sort(key=helper)\n    return found\n\n\nnumbers = [8, 3, 1, 2, 5, 4, 7, 6]\ngroup = {2, 3, 5, 7}\nfound = sort_priority2(numbers, group)\nprint(\'Found:\', found)\nprint(numbers)\n\n>>>\nFound: False\n[2, 3, 5, 7, 1, 4, 6, 8]`, `84275997048008150000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">sort_priority2</span><span class="token punctuation">(</span>numbers<span class="token punctuation">,</span> group<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    found <span class="token operator">=</span> <span class="token boolean">False</span>\n\n    <span class="token keyword">def</span> <span class="token function">helper</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> x <span class="token keyword">in</span> group<span class="token punctuation">:</span>\n            found <span class="token operator">=</span> <span class="token boolean">True</span>  <span class="token comment"># Seems simple</span>\n            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span>\n        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span>\n    numbers<span class="token punctuation">.</span>sort<span class="token punctuation">(</span>key<span class="token operator">=</span>helper<span class="token punctuation">)</span>\n    <span class="token keyword">return</span> found\n\n\nnumbers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span>\ngroup <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">}</span>\nfound <span class="token operator">=</span> sort_priority2<span class="token punctuation">(</span>numbers<span class="token punctuation">,</span> group<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Found:\'</span><span class="token punctuation">,</span> found<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nFound<span class="token punctuation">:</span> <span class="token boolean">False</span>\n<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>排序结果没有问题，可以看到：在排过序的 numbers 里面，重要群组 group 里的那些元素（2、3、5、7），确实出现在了其他元素前面。既然这样，那表示函数返回值的 found 变量就应该是 True，但我们看到的却是 False，这是为什么？</p>\n<p>在表达式中引用某个变量时，Python 解释器会按照下面的顺序，在各个作用域（scope）里面查找这个变量，以解析（resolve）这次引用</p>\n<ol>\n<li>当前函数的作用域。</li>\n<li>外围作用域（例如包含当前函数的其他函数所对应的作用域）。</li>\n<li>包含当前代码的那个模块所对应的作用域（也叫全局作用域，global scope）。</li>\n<li>内置作用域（built-in scope，也就是包含 len 与 str 等函数的那个作用域）。</li>\n</ol>\n<p>如果这些作用域中都没有定义名称相符的变量，那么程序就抛出 NameError 异常。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="7406222547804609000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`foo = does_not_exist * 5\n\n>>>\nTraceback...\nNameError: name \'does_not_exist\' is not defined`, `7406222547804609000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">foo <span class="token operator">=</span> does_not_exist <span class="token operator">*</span> <span class="token number">5</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nNameError<span class="token punctuation">:</span> name <span class="token string">\'does_not_exist\'</span> <span class="token keyword">is</span> <span class="token keyword">not</span> defined</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>刚才讲的是怎么引用变量，现在我们来讲怎么给变量赋值，这要分两种情况处理。</p>\n<ol>\n<li>如果变量已经定义在当前作用域中，那么直接把新值交给它就行了。</li>\n<li>如果当前作用域中不存在这个变量，那么即便外围作用域里有同名的变量，Python 也还是会把这次的赋值操作当成变量的定义来处理</li>\n</ol>\n<p>这会产生一个重要的效果，也就是说，Python 会把包含赋值操作的这个函数当成新定义的这个变量的作用域。</p>\n<p>这可以解释刚才那种写法错在何处。<code class="language-text">sort_priority2</code> 函数里面的 helper 闭包函数是把 True 赋给了 found 变量。当前作用域里没有这样一个叫作 found 的变量，所以就算外围的 <code class="language-text">sort_priority2</code> 函数里面有 found 变量，系统也还是会把这次赋值当成定义，也就是会在 helper 里面定义一个新的 found 变量，而不是把它当成给 <code class="language-text">sort_priority2</code> 已有的那个 found 变量赋值。</p>\n<p>这种问题有时也称作作用域 bug（scoping bug），Python 新手可能认为这样的赋值规则很奇怪，但实际上 Python 是故意这么设计的。因为这样可以防止函数中的局部变量污染外围模块。假如不这样做，那么函数里的每条赋值语句都有可能影响全局作用域的变量，这样不仅混乱，而且会让全局变量之间彼此交互影响，从而导致很多难以探查的 bug。</p>\n<p>Python 有一种特殊的写法，可以把闭包里面的数据赋给闭包外面的变量。用 nonlocal 语句描述变量，就可以让系统在处理针对这个变量的赋值操作时，去外围作用域查找。然而，nonlocal 有个限制，就是不能侵入模块级别的作用域（以防污染全局作用域）。</p>\n<p>下面，用 nonlocal 改写刚才那个函数。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="27145004079949620000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def sort_priority2(numbers, group):\n    found = False\n\n    def helper(x):\n        nonlocal found\n        if x in group:\n            found = True  # Seems simple\n            return (0, x)\n        return (1, x)\n    numbers.sort(key=helper)\n    return found\n\n\nnumbers = [8, 3, 1, 2, 5, 4, 7, 6]\ngroup = {2, 3, 5, 7}\nfound = sort_priority2(numbers, group)\nprint(\'Found:\', found)\nprint(numbers)\n\n>>>\nFound: True\n[2, 3, 5, 7, 1, 4, 6, 8]`, `27145004079949620000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py{5}"\n              >\n                <span class="gatsby-code-button-language">py{5}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">sort_priority2</span><span class="token punctuation">(</span>numbers<span class="token punctuation">,</span> group<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    found <span class="token operator">=</span> <span class="token boolean">False</span>\n\n    <span class="token keyword">def</span> <span class="token function">helper</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>\n<span class="gatsby-highlight-code-line">        <span class="token keyword">nonlocal</span> found</span>        <span class="token keyword">if</span> x <span class="token keyword">in</span> group<span class="token punctuation">:</span>\n            found <span class="token operator">=</span> <span class="token boolean">True</span>  <span class="token comment"># Seems simple</span>\n            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span>\n        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span>\n    numbers<span class="token punctuation">.</span>sort<span class="token punctuation">(</span>key<span class="token operator">=</span>helper<span class="token punctuation">)</span>\n    <span class="token keyword">return</span> found\n\n\nnumbers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span>\ngroup <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">}</span>\nfound <span class="token operator">=</span> sort_priority2<span class="token punctuation">(</span>numbers<span class="token punctuation">,</span> group<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Found:\'</span><span class="token punctuation">,</span> found<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nFound<span class="token punctuation">:</span> <span class="token boolean">True</span>\n<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>nonlocal 语句清楚地表明，我们要把数据赋给闭包之外的变量。有一种跟它互补的语句，叫作 global，用这种语句描述某个变量后，在给这个变量赋值时，系统会直接把它放到模块作用域（或者说全局作用域）中。</p>\n<p>我们都知道全局变量不应该滥用，其实 nonlocal 也这样。除比较简单的函数外，大家尽量不要用这个语句，因为它造成的副作用有时很难发现。尤其是在那种比较长的函数里，nonlocal 语句与其关联变量的赋值操作之间可能隔得很远。</p>\n<p>如果 nonlocal 的用法比较复杂，那最好是改用辅助类来封装状态。下面就定义了这样一个类，用来实现与刚才那种写法相同的效果。这样虽然稍微长一点，但看起来更清晰易读（<code class="language-text">__call__</code> 这个特殊方法，请参见第 38 条）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="27768598751558394000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Sorter:\n    def __init__(self, group):\n        self.group = group\n        self.found = False\n\n    def __call__(self, x):\n        if x in self.group:\n            self.found = True\n            return (0, x)\n        return (1, x)\n\n\nnumbers = [8, 3, 1, 2, 5, 4, 7, 6]\ngroup = {2, 3, 5, 7}\nsorter = Sorter(group)\nnumbers.sort(key=sorter)\nassert sorter.found is True`, `27768598751558394000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Sorter</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> group<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>group <span class="token operator">=</span> group\n        self<span class="token punctuation">.</span>found <span class="token operator">=</span> <span class="token boolean">False</span>\n\n    <span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> x <span class="token keyword">in</span> self<span class="token punctuation">.</span>group<span class="token punctuation">:</span>\n            self<span class="token punctuation">.</span>found <span class="token operator">=</span> <span class="token boolean">True</span>\n            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span>\n        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span>\n\n\nnumbers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span>\ngroup <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">}</span>\nsorter <span class="token operator">=</span> Sorter<span class="token punctuation">(</span>group<span class="token punctuation">)</span>\nnumbers<span class="token punctuation">.</span>sort<span class="token punctuation">(</span>key<span class="token operator">=</span>sorter<span class="token punctuation">)</span>\n<span class="token keyword">assert</span> sorter<span class="token punctuation">.</span>found <span class="token keyword">is</span> <span class="token boolean">True</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="总结-17"><a href="#%E6%80%BB%E7%BB%93-17" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>闭包函数可以引用定义它们的那个外围作用域之中的变量。</li>\n<li>按照默认的写法，在闭包里面给变量赋值并不会改变外围作用域中的同名变量。</li>\n<li>先用 nonlocal 语句说明，然后赋值，可以修改外围作用域中的变量。</li>\n<li>除特别简单的函数外，尽量少用 nonlocal 语句。</li>\n</ol>\n<h2 id="第-22-条：用数量可变的位置参数给函数设计清晰的参数列表"><a href="#%E7%AC%AC-22-%E6%9D%A1%EF%BC%9A%E7%94%A8%E6%95%B0%E9%87%8F%E5%8F%AF%E5%8F%98%E7%9A%84%E4%BD%8D%E7%BD%AE%E5%8F%82%E6%95%B0%E7%BB%99%E5%87%BD%E6%95%B0%E8%AE%BE%E8%AE%A1%E6%B8%85%E6%99%B0%E7%9A%84%E5%8F%82%E6%95%B0%E5%88%97%E8%A1%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 22 条：用数量可变的位置参数给函数设计清晰的参数列表</h2>\n<p>让函数接受数量可变的位置参数（positional argument），可以把函数设计得更加清晰（这些位置参数通常简称 var args，或者叫作 star args，因为我们习惯用 <code class="language-text">*args</code> 指代）。例如，假设我们要记录调试信息。如果采用参数数量固定的方案来设计，那么函数应该接受一个表示信息的 message 参数和一个 values 列表（这个列表用于存放需要填充到信息里的那些值）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="81186469112731400000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def log(message, values):\n    if not values:\n        print(message)\n    else:\n        values_str = \', \'.join(str(x) for x in values)\n        print(f\'{message}: {values_str}\')\n\n\nlog(\'My numbers are\', [1, 2])\nlog(\'Hi there\', [])\n\n>>>\nMy numbers are: 1, 2\nHi there`, `81186469112731400000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">log</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> values<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">if</span> <span class="token keyword">not</span> values<span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span>\n    <span class="token keyword">else</span><span class="token punctuation">:</span>\n        values_str <span class="token operator">=</span> <span class="token string">\', \'</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> values<span class="token punctuation">)</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>message<span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{</span>values_str<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n\nlog<span class="token punctuation">(</span><span class="token string">\'My numbers are\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\nlog<span class="token punctuation">(</span><span class="token string">\'Hi there\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nMy numbers are<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span>\nHi there</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>即便没有值需要填充到信息里面，也必须专门传一个空白的列表进去，这样显得多余，而且让代码看起来比较乱。最好是能允许调用者把第二个参数留空。在 Python 里，可以给最后一个位置参数加前缀 <code class="language-text">*</code>，这样调用者就只需要提供不带星号的那些参数，然后可以不再指其他参数，也可以继续指定任意数量的位置参数。函数的主体代码不用改，只修改调用代码即可。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="10618201647708326000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def log(message, *values):  # The only difference\n    if not values:\n        print(message)\n    else:\n        values_str = \', \'.join(str(x) for x in values)\n        print(f\'{message}: {values_str}\')\n\n\nlog(\'My numbers are\', 1, 2)\nlog(\'Hi there\')  # Much better\n\n>>>\nMy numbers are: 1, 2\nHi there`, `10618201647708326000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">log</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> <span class="token operator">*</span>values<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># The only difference</span>\n    <span class="token keyword">if</span> <span class="token keyword">not</span> values<span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span>\n    <span class="token keyword">else</span><span class="token punctuation">:</span>\n        values_str <span class="token operator">=</span> <span class="token string">\', \'</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> values<span class="token punctuation">)</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>message<span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{</span>values_str<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n\nlog<span class="token punctuation">(</span><span class="token string">\'My numbers are\'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>\nlog<span class="token punctuation">(</span><span class="token string">\'Hi there\'</span><span class="token punctuation">)</span>  <span class="token comment"># Much better</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nMy numbers are<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span>\nHi there</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这种写法与拆解数据时用在赋值语句左边带星号的 unpacking 操作非常类似（参见第 13 条）。</p>\n<p>如果想把已有序列（例如某列表）里面的元素当成参数传给像 log 这样的参数个数可变的函数（variadic function），那么可以在传递序列的时采用 <code class="language-text">*</code> 操作符。这会让 Python 把序列中的元素都当成位置参数传给这个函数。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="4093185138117316600"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`favorites = [7, 33, 99]\nlog(\'Favorite colors\', *favorites)\n\n>>>\nFavorite colors: 7, 33, 99`, `4093185138117316600`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">favorites <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">33</span><span class="token punctuation">,</span> <span class="token number">99</span><span class="token punctuation">]</span>\nlog<span class="token punctuation">(</span><span class="token string">\'Favorite colors\'</span><span class="token punctuation">,</span> <span class="token operator">*</span>favorites<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nFavorite colors<span class="token punctuation">:</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">33</span><span class="token punctuation">,</span> <span class="token number">99</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>令函数接受数量可变的位置参数，可能导致两个问题。</p>\n<ol>\n<li>\n<p>程序总是必须先把这些参数转化成一个元组，然后才能把它们当成可选的位置参数传给函数。这意味着，如果调用函数时，把带 <code class="language-text">*</code> 操作符的生成器传了过去，那么程序必须先把这个生成器里的所有元素迭代完（以便形成元组），然后才能继续往下执行（相关知识，参见第 30 条）。这个元组包含生成器所给出的每个值，这可能耗费大量内存，甚至会让程序崩溃。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="56296701855383110000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def my_generator():\nfor i in range(10):\n    yield i\n\ndef my_func(*args):\n  print(args)\n\nit = my_generator()\nmy_func(*it)\n\n>>>\n(0, 1, 2, 3, 4, 5, 6, 7, 8, 9)`, `56296701855383110000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">my_generator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">yield</span> i\n\n<span class="token keyword">def</span> <span class="token function">my_func</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">)</span><span class="token punctuation">:</span>\n  <span class="token keyword">print</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span>\n\nit <span class="token operator">=</span> my_generator<span class="token punctuation">(</span><span class="token punctuation">)</span>\nmy_func<span class="token punctuation">(</span><span class="token operator">*</span>it<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>接受 <code class="language-text">*args</code> 参数的函数，适合处理输入值不太多，而且数量可以提前预估的情况。在调用这种函数时，传给 <code class="language-text">*args</code> 这一部分的应该是许多个字面值或变量名才对。这种机制，主要是为了让代码写起来更方便、读起来更清晰。</p>\n</li>\n<li>\n<p>如果用了 <code class="language-text">*args</code> 之后，又要给函数添加新的位置参数，那么原有的调用操作就需要全都更新。例如给参数列表开头添加新的位置参数 sequence，那么没有据此更新的那些调用代码就会出错。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="52729129765398520000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def log(sequence, message, *values):\nif not values:\n    print(f\'{sequence} - {message}\')\nelse:\n    values_str = \', \'.join(str(x) for x in values)\n    print(f\'{sequence} - {message}: {values_str}\')\n\nlog(1, \'Favorites\', 7, 33)  # New with *args OK\nlog(1, \'Hi there\')  # New message only OK\nlog(\'Favorite numbers\', 7, 33)  # old usage breaks\n\n>>>\n1 - Favorites: 7, 33\n1 - Hi there\nFavorite numbers - 7: 33`, `52729129765398520000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">log</span><span class="token punctuation">(</span>sequence<span class="token punctuation">,</span> message<span class="token punctuation">,</span> <span class="token operator">*</span>values<span class="token punctuation">)</span><span class="token punctuation">:</span>\n<span class="token keyword">if</span> <span class="token keyword">not</span> values<span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>sequence<span class="token punctuation">}</span></span><span class="token string"> - </span><span class="token interpolation"><span class="token punctuation">{</span>message<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n<span class="token keyword">else</span><span class="token punctuation">:</span>\n    values_str <span class="token operator">=</span> <span class="token string">\', \'</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> values<span class="token punctuation">)</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>sequence<span class="token punctuation">}</span></span><span class="token string"> - </span><span class="token interpolation"><span class="token punctuation">{</span>message<span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{</span>values_str<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\nlog<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">\'Favorites\'</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">33</span><span class="token punctuation">)</span>  <span class="token comment"># New with *args OK</span>\nlog<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">\'Hi there\'</span><span class="token punctuation">)</span>  <span class="token comment"># New message only OK</span>\nlog<span class="token punctuation">(</span><span class="token string">\'Favorite numbers\'</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">33</span><span class="token punctuation">)</span>  <span class="token comment"># old usage breaks</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token number">1</span> <span class="token operator">-</span> Favorites<span class="token punctuation">:</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">33</span>\n<span class="token number">1</span> <span class="token operator">-</span> Hi there\nFavorite numbers <span class="token operator">-</span> <span class="token number">7</span><span class="token punctuation">:</span> <span class="token number">33</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>问题在于：第三次调用 log 函数的那个地方并没有根据新的参数列表传入 sequence 参数，所以 Favorite numbers 就成了 sequence 参数，7 就成了 message 参数。这样的 bug 很难排查，因为程序不会抛出异常，只会采用错误的数据继续运行下去。为了彻底避免这种漏洞，在给这种 <code class="language-text">*arg</code> 函数添加参数时，应该使用只能通过关键字来指定的参数（keyword-only argument，参见第 25 条）。要是想做得更稳妥一些，可以考虑添加类型注解（参见第 90 条）。</p>\n</li>\n</ol>\n<h3 id="总结-18"><a href="#%E6%80%BB%E7%BB%93-18" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>用 def 定义函数时，可以通过 <code class="language-text">*args</code> 的写法让函数接受数量可变的位置参数。</li>\n<li>调用函数时，可以在序列左边加上 <code class="language-text">*</code> 操作符，把其中的元素当成位置参数传给 <code class="language-text">*args</code> 所表示的这一部分。</li>\n<li>如果 <code class="language-text">*</code> 操作符加在生成器前，那么传递参数时，程序有可能因为耗尽内存而崩溃。</li>\n<li>给接受 <code class="language-text">*args</code> 的函数添加新位置参数，可能导致难以排查的 bug。</li>\n</ol>\n<h2 id="第-23-条：用关键字参数来表示可选的行为"><a href="#%E7%AC%AC-23-%E6%9D%A1%EF%BC%9A%E7%94%A8%E5%85%B3%E9%94%AE%E5%AD%97%E5%8F%82%E6%95%B0%E6%9D%A5%E8%A1%A8%E7%A4%BA%E5%8F%AF%E9%80%89%E7%9A%84%E8%A1%8C%E4%B8%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 23 条：用关键字参数来表示可选的行为</h2>\n<p>与大多数其他编程语言一样，Python 允许在调用函数时，按照位置传递参数</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="3550993697758686000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def remainder(number, divisor):\n    return number % divisor\n\n\nassert remainder(20, 7) == 6`, `3550993697758686000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">remainder</span><span class="token punctuation">(</span>number<span class="token punctuation">,</span> divisor<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">return</span> number <span class="token operator">%</span> divisor\n\n\n<span class="token keyword">assert</span> remainder<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">6</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Python 函数里面的所有普通参数，除了按位置传递外，还可以按关键字传递。调用函数时，在调用括号内可以把关键字的名称写在 = 左边，把参数值写在右边。这种写法不在乎参数的顺序，只要把必须指定的所有位置参数全都传过去即可。另外，关键字形式与位置形式也可以混用。下面这四种写法的效果相同：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="27523199376744722000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`remainder(20, 7)\nremainder(20, divisor=7)\nremainder(number=20, divisor=7)\nremainder(divisor=7, number=20)`, `27523199376744722000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">remainder<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span>\nremainder<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> divisor<span class="token operator">=</span><span class="token number">7</span><span class="token punctuation">)</span>\nremainder<span class="token punctuation">(</span>number<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span> divisor<span class="token operator">=</span><span class="token number">7</span><span class="token punctuation">)</span>\nremainder<span class="token punctuation">(</span>divisor<span class="token operator">=</span><span class="token number">7</span><span class="token punctuation">,</span> number<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果混用，那么位置参数必须出现在关键字参数之前，否则就会出错。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="71424181480576450000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`remainder(number=20, 7)\n\n>>>\nTraceback ...\nSyntaxError: positional argument follows keyword argument`, `71424181480576450000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">remainder<span class="token punctuation">(</span>number<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nSyntaxError<span class="token punctuation">:</span> positional argument follows keyword argument</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>每个参数只能指定一次，不能既通过位置形式指定，又通过关键字形式指定。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="24937305682725320000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`remainder(20, number=7)\n\n>>>\nTraceback ...\nTypeError: remainder() got multiple values for argument number`, `24937305682725320000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">remainder<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> number<span class="token operator">=</span><span class="token number">7</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nTypeError<span class="token punctuation">:</span> remainder<span class="token punctuation">(</span><span class="token punctuation">)</span> got multiple values <span class="token keyword">for</span> argument number</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果有一份字典，而且字典里面的内容能够用来调用 remainder 这样的函数，那么可以把 <code class="language-text">**</code> 运算符加在字典前面，这会让 Python 把字典里面的键值以关键字参数的形式传给函数。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="16746948781207460000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`my_kwargs = {\n    \'number\': 20,\n    \'divisor\': 7,\n}\nassert remainder(**my_kwargs) == 6`, `16746948781207460000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">my_kwargs <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token string">\'number\'</span><span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">,</span>\n    <span class="token string">\'divisor\'</span><span class="token punctuation">:</span> <span class="token number">7</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\n<span class="token keyword">assert</span> remainder<span class="token punctuation">(</span><span class="token operator">**</span>my_kwargs<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">6</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>调用函数时，带 <code class="language-text">**</code> 操作符的参数可以和位置参数或关键字参数混用，只要不重复指定就行。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="49312931943173940000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`my_kwargs = {\n    \'divisor\': 7,\n}\nassert remainder(number=20, **my_kwargs) == 6`, `49312931943173940000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">my_kwargs <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token string">\'divisor\'</span><span class="token punctuation">:</span> <span class="token number">7</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\n<span class="token keyword">assert</span> remainder<span class="token punctuation">(</span>number<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token operator">**</span>my_kwargs<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">6</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>也可以对多个字典分别施加 <code class="language-text">**</code> 操作，只要这些字典所提供的参数不重叠就好。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="13012244434862930000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`my_kwargs = {\n    \'number\': 20,\n}\nother_kwargs = {\n    \'divisor\': 7,\n}\nassert remainder(**my_kwargs, **other_kwargs) == 6`, `13012244434862930000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">my_kwargs <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token string">\'number\'</span><span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\nother_kwargs <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token string">\'divisor\'</span><span class="token punctuation">:</span> <span class="token number">7</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\n<span class="token keyword">assert</span> remainder<span class="token punctuation">(</span><span class="token operator">**</span>my_kwargs<span class="token punctuation">,</span> <span class="token operator">**</span>other_kwargs<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">6</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>定义函数时，如果想让这个函数接受任意数量的关键字参数，那么可以在参数列表里写上万能形参 <code class="language-text">**kwargs</code>，它会把调用者传进来的参数收集合到一个字典里面稍后处理（第 26 条讲了一种特别适合这么做的情况）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="99385242575324970000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def print_parameters(**kwargs):\n    for key, value in kwargs.items():\n        print(f\'{key} = {value}\')\n\n\nprint_parameters(alpha=1.5, beta=9, gamma=4)\n\n>>>\nalpha = 1.5\nbeta = 9\ngamma = 4`, `99385242575324970000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">print_parameters</span><span class="token punctuation">(</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">for</span> key<span class="token punctuation">,</span> value <span class="token keyword">in</span> kwargs<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>key<span class="token punctuation">}</span></span><span class="token string"> = </span><span class="token interpolation"><span class="token punctuation">{</span>value<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n\nprint_parameters<span class="token punctuation">(</span>alpha<span class="token operator">=</span><span class="token number">1.5</span><span class="token punctuation">,</span> beta<span class="token operator">=</span><span class="token number">9</span><span class="token punctuation">,</span> gamma<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nalpha <span class="token operator">=</span> <span class="token number">1.5</span>\nbeta <span class="token operator">=</span> <span class="token number">9</span>\ngamma <span class="token operator">=</span> <span class="token number">4</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>关键字参数的灵活用法可以带来三个好处。</p>\n<ol>\n<li>\n<p>用关键字参数调用函数可以让初次阅读代码的人更容易看懂。例如，读到 remainder(20, 7) 这样的调用代码，就不太容易看出谁是被除数 number，谁是除数 divisor，只有去查看 remainder 的具体实现方法才能明白。但如果改用关键字形式来调用，例如 remainder(number=20, divisor=7)，那么每个参数的含义就相当明了。</p>\n</li>\n<li>\n<p>它可以带有默认值，该值是在定义函数时指定的。在大多数情况下，调用者只需要沿用这个值就好，但有时也可以明确指定自己想要传的值。这样能够减少重复代码，让程序看上去干净一些。</p>\n<p>例如，我们要计算液体流入容器的速率。如果这个容器带刻度，那么可以取前后两个时间点的刻度差（<code class="language-text">weight_diff</code>），并把它跟这两个时间点的时间差（<code class="language-text">time_diff</code>）相除，就可以算出流速了。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="75326670896283200000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def flow_rate(weight_diff, time_diff):\n   return weight_diff / time_diff\n\nweight_diff = 0.5\ntime_diff = 3\nflow = flow_rate(weight_diff, time_diff)\nprint(f\'{flow:.3} kg per second\')`, `75326670896283200000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">flow_rate</span><span class="token punctuation">(</span>weight_diff<span class="token punctuation">,</span> time_diff<span class="token punctuation">)</span><span class="token punctuation">:</span>\n   <span class="token keyword">return</span> weight_diff <span class="token operator">/</span> time_diff\n\nweight_diff <span class="token operator">=</span> <span class="token number">0.5</span>\ntime_diff <span class="token operator">=</span> <span class="token number">3</span>\nflow <span class="token operator">=</span> flow_rate<span class="token punctuation">(</span>weight_diff<span class="token punctuation">,</span> time_diff<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>flow<span class="token punctuation">:</span><span class="token format-spec">.3</span><span class="token punctuation">}</span></span><span class="token string"> kg per second\'</span></span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>一般来说，我们会用每秒的千克数表示流速。但有的时候，我们还想估算更长的时间段（例如几小时或几天）内的流速结果。只需给同一个函数加一个 period 参数来表示那个时间段相当于多少秒即可。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="9628297932593922000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def flow_rate(weight_diff, time_diff, period):\n   return (weight_diff / time_diff) * period`, `9628297932593922000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">flow_rate</span><span class="token punctuation">(</span>weight_diff<span class="token punctuation">,</span> time_diff<span class="token punctuation">,</span> period<span class="token punctuation">)</span><span class="token punctuation">:</span>\n   <span class="token keyword">return</span> <span class="token punctuation">(</span>weight_diff <span class="token operator">/</span> time_diff<span class="token punctuation">)</span> <span class="token operator">*</span> period</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>这样写有个问题，就是每次调用函数时，都得明确指定 period 参数。即便我们想计算每秒钟的流速，也还是得明确指定 period 为 1。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="35262370245588206000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`flow_per_second = flow_rate(weight_diff, time_diff, 1)`, `35262370245588206000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">flow_per_second <span class="token operator">=</span> flow_rate<span class="token punctuation">(</span>weight_diff<span class="token punctuation">,</span> time_diff<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>为了简化这种用法，我们可以给 period 参数设定默认值。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="63367907701632565000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def flow_rate(weight_diff, time_diff, period=1):\n   return (weight_diff / time_diff) * period\n\nflow_per_second = flow_rate(weight_diff, time_diff)\nflow_per_hour = flow_rate(weight_diff, time_diff, 3600)`, `63367907701632565000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">flow_rate</span><span class="token punctuation">(</span>weight_diff<span class="token punctuation">,</span> time_diff<span class="token punctuation">,</span> period<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n   <span class="token keyword">return</span> <span class="token punctuation">(</span>weight_diff <span class="token operator">/</span> time_diff<span class="token punctuation">)</span> <span class="token operator">*</span> period\n\nflow_per_second <span class="token operator">=</span> flow_rate<span class="token punctuation">(</span>weight_diff<span class="token punctuation">,</span> time_diff<span class="token punctuation">)</span>\nflow_per_hour <span class="token operator">=</span> flow_rate<span class="token punctuation">(</span>weight_diff<span class="token punctuation">,</span> time_diff<span class="token punctuation">,</span> <span class="token number">3600</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这个办法适用于默认值比较简单的情况。如果默认值本身要根据比较复杂的逻辑来确定（可参考第 24 条），那就得仔细考虑一下了。</p>\n</li>\n<li>\n<p>我们可以很灵活地扩充函数的参数，而不用担心会影响原有的函数调用代码。这样的话，我们就可以通过这些新参数在函数里面实现许多新的功能，同时又无须修改早前写好的调用代码，这也让程序不容易因此出现 bug。</p>\n<p>例如，我们想继续扩充上述 <code class="language-text">flow_rate</code> 函数的功能，让它可以用千克之外的其他重量单位来计算流速。那只需要再添加一个可选参数，用来表示 1 千克相当于多少个那样的单位即可。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="95228226852966290000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def flow_rate(weight_diff, time_diff, period=1, units_per_kg=1):\n  return ((weight_diff * units_per_kg) / time_diff) * period`, `95228226852966290000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">flow_rate</span><span class="token punctuation">(</span>weight_diff<span class="token punctuation">,</span> time_diff<span class="token punctuation">,</span> period<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> units_per_kg<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>weight_diff <span class="token operator">*</span> units_per_kg<span class="token punctuation">)</span> <span class="token operator">/</span> time_diff<span class="token punctuation">)</span> <span class="token operator">*</span> period</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>新参数 <code class="language-text">units_per_kg</code> 的默认值为 1，这表示默认情况下，依然以千克为重量单位来计算。于是，以前写好的那些调用代码就不用修改了。以后调用 <code class="language-text">flow_rate</code> 时，可以通过关键字形式给这个参数指定值，以表示他们想用的那种单位（例如磅，1 千克约等于 2.2 磅）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="14538112288875448000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`pounds_per_hour = flow_rate(weight_diff, time_diff,\n                        period=3600, units_per_kg=2.2)`, `14538112288875448000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">pounds_per_hour <span class="token operator">=</span> flow_rate<span class="token punctuation">(</span>weight_diff<span class="token punctuation">,</span> time_diff<span class="token punctuation">,</span>\n                        period<span class="token operator">=</span><span class="token number">3600</span><span class="token punctuation">,</span> units_per_kg<span class="token operator">=</span><span class="token number">2.2</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>可选的关键字参数有助于维护向后兼容（backward compatibility）。这是个相当重要的问题，对于接受带 <code class="language-text">*args</code> 参数的函数，也要注意向后兼容（参见第 22 条）。</p>\n<p>像 period 和 <code class="language-text">units_per_kg</code> 这样可选的关键字参数，只有一个缺点，就是调用者仍然能够按照位置来指定。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="19028997299077300000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`pounds_per_hour = flow_rate(weight_diff, time_diff, 3600, 2.2)`, `19028997299077300000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">pounds_per_hour <span class="token operator">=</span> flow_rate<span class="token punctuation">(</span>weight_diff<span class="token punctuation">,</span> time_diff<span class="token punctuation">,</span> <span class="token number">3600</span><span class="token punctuation">,</span> <span class="token number">2.2</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>通过位置来指定可选参数，可能会让读代码的人有点儿糊涂，因为他不太清楚 3600 和 2.2 这两个值分别指哪个量的缩放系数。所以，最好是能以关键字的形式给这些参数传值，而不要按位置去传。从设计函数的角度来说，还可以考虑用更加明确的方案以降低出错概率（参见第 25 条）。</p>\n</li>\n</ol>\n<h3 id="总结-19"><a href="#%E6%80%BB%E7%BB%93-19" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>函数的参数可以按位置指定，也可以用关键字的形式指定。</li>\n<li>关键字可以让每个参数的作用更加明了，因为在调用函数时只按位置指定参数，可能导致这些参数的含义不够明确。</li>\n<li>应该通过带默认值的关键字参数来扩展函数的行为，因为这不会影响原有的函数调用代码。</li>\n<li>可选的关键字参数总是应该通过参数名来传递，而不应按位置传递。</li>\n</ol>\n<h2 id="第-24-条：用-none-和-docstring-来描述默认值会变的参数"><a href="#%E7%AC%AC-24-%E6%9D%A1%EF%BC%9A%E7%94%A8-none-%E5%92%8C-docstring-%E6%9D%A5%E6%8F%8F%E8%BF%B0%E9%BB%98%E8%AE%A4%E5%80%BC%E4%BC%9A%E5%8F%98%E7%9A%84%E5%8F%82%E6%95%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 24 条：用 None 和 docstring 来描述默认值会变的参数</h2>\n<p>有时，我们想把那种不能够提前固定的值，当作关键字参数的默认值。例如，记录日志消息时，默认的时间应该是触发事件的那一刻。所以，如果调用者没有明确指定时间，那么就默认把调用函数的那一刻当成这条日志的记录时间。现在试试下面这种写法，假定它能让 when 参数的默认值随着这个函数每次的执行时间而发生变化。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="36089376088544100000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from time import sleep\nfrom datetime import datetime\n\n\ndef log(message, when=datetime.now()):\n    print(f\'{when}: {message}\')\n\n\nlog(\'Hi there!\')\nsleep(0.1)\nlog(\'Hello again!\')\n\n>>>\n2022-09-16 11:39:58.577119: Hi there!\n2022-09-16 11:39:58.577119: Hello again!`, `36089376088544100000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> time <span class="token keyword">import</span> sleep\n<span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime\n\n\n<span class="token keyword">def</span> <span class="token function">log</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> when<span class="token operator">=</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>when<span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{</span>message<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n\nlog<span class="token punctuation">(</span><span class="token string">\'Hi there!\'</span><span class="token punctuation">)</span>\nsleep<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span>\nlog<span class="token punctuation">(</span><span class="token string">\'Hello again!\'</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token number">2022</span><span class="token operator">-</span><span class="token number">09</span><span class="token operator">-</span><span class="token number">16</span> <span class="token number">11</span><span class="token punctuation">:</span><span class="token number">39</span><span class="token punctuation">:</span><span class="token number">58.577119</span><span class="token punctuation">:</span> Hi there!\n<span class="token number">2022</span><span class="token operator">-</span><span class="token number">09</span><span class="token operator">-</span><span class="token number">16</span> <span class="token number">11</span><span class="token punctuation">:</span><span class="token number">39</span><span class="token punctuation">:</span><span class="token number">58.577119</span><span class="token punctuation">:</span> Hello again!</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样写不行。因为 datetime.now 只执行了一次，所以每条日志的时间戳（timestamp）相同。参数的默认值只会在系统加载这个模块的时候，计算一遍，而不会在每次执行时都重新计算，这通常意味着这些默认值在程序启动后，就已经定下来了。只要包含这段代码的那个模块已经加载进来，那么 when 参数的默认值就是加载时计算的那个 datetime.now()，系统不会重新计算。</p>\n<p>要想在 Python 里实现这种效果，惯用的办法是把参数的默认值设为 None，同时在 docstring 文档里面写清楚，这个参数为 None 时，函数会怎么运作（参见第 84 条）。给函数写实现代码时，要判断该参数是不是 None，如果是，就把它改成相应的默认值。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="4164240972776500700"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from time import sleep\nfrom datetime import datetime\n\n\ndef log(message, when=None):\n    &quot;&quot;&quot;Log a message with a timestamp.\n\n    Args:\n        message: Message to print.\n        when: datetime of when the message occurred.\n            Defaults to the present time.\n    &quot;&quot;&quot;\n    if when is None:\n        when = datetime.now()\n    print(f\'{when}: {message}\')\n\n\nlog(\'Hi there!\')\nsleep(0.1)\nlog(\'Hello again!\')\n\n>>>\n2022-09-16 11:52:02.810552: Hi there!\n2022-09-16 11:52:02.910765: Hello again!`, `4164240972776500700`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> time <span class="token keyword">import</span> sleep\n<span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime\n\n\n<span class="token keyword">def</span> <span class="token function">log</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> when<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token triple-quoted-string string">"""Log a message with a timestamp.\n\n    Args:\n        message: Message to print.\n        when: datetime of when the message occurred.\n            Defaults to the present time.\n    """</span>\n    <span class="token keyword">if</span> when <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>\n        when <span class="token operator">=</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>when<span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{</span>message<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n\nlog<span class="token punctuation">(</span><span class="token string">\'Hi there!\'</span><span class="token punctuation">)</span>\nsleep<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span>\nlog<span class="token punctuation">(</span><span class="token string">\'Hello again!\'</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token number">2022</span><span class="token operator">-</span><span class="token number">09</span><span class="token operator">-</span><span class="token number">16</span> <span class="token number">11</span><span class="token punctuation">:</span><span class="token number">52</span><span class="token punctuation">:</span><span class="token number">02.810552</span><span class="token punctuation">:</span> Hi there!\n<span class="token number">2022</span><span class="token operator">-</span><span class="token number">09</span><span class="token operator">-</span><span class="token number">16</span> <span class="token number">11</span><span class="token punctuation">:</span><span class="token number">52</span><span class="token punctuation">:</span><span class="token number">02.910765</span><span class="token punctuation">:</span> Hello again!</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>把参数的默认值写成 None 还有个重要的意义，就是用来表示那种以后可能由调用者修改内容的默认值（例如某个可变的容器）。例如，我们要写一个函数对采用 JSON 格式编码的数据做解码。如果无法解码，那么就返回调用时所指定的默认结果，假如调用者当时没有明确指定，那就返回空白的字典。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="59810863522342880000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import json\n\n\ndef decode(data, default={}):\n    try:\n        return json.loads(data)\n    except ValueError:\n        return default`, `59810863522342880000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> json\n\n\n<span class="token keyword">def</span> <span class="token function">decode</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">try</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>data<span class="token punctuation">)</span>\n    <span class="token keyword">except</span> ValueError<span class="token punctuation">:</span>\n        <span class="token keyword">return</span> default</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样的写法与前面 datetime.now 的例子有着同样的问题。系统只会计算一次 default 参数（在加载这个模块的时候），所以每次调用这个函数时，给调用者返回的都是一开始分配的那个字典，这就相当于凡是以默认值调用这个函数的代码都共用同一份字典。这会使程序出现很奇怪的效果。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="98715550144488300000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import json\n\n\ndef decode(data, default={}):\n    try:\n        return json.loads(data)\n    except ValueError:\n        return default\n\n\nfoo = decode(\'bad data\')\nfoo[\'stuff\'] = 5\nbar = decode(\'also bad\')\nbar[\'meep\'] = 1\nprint(\'Foo:\', foo)\nprint(\'Bar:\', bar)\n\n>>>\nFoo: {\'stuff\': 5, \'meep\': 1}\nBar: {\'stuff\': 5, \'meep\': 1}`, `98715550144488300000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> json\n\n\n<span class="token keyword">def</span> <span class="token function">decode</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">try</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>data<span class="token punctuation">)</span>\n    <span class="token keyword">except</span> ValueError<span class="token punctuation">:</span>\n        <span class="token keyword">return</span> default\n\n\nfoo <span class="token operator">=</span> decode<span class="token punctuation">(</span><span class="token string">\'bad data\'</span><span class="token punctuation">)</span>\nfoo<span class="token punctuation">[</span><span class="token string">\'stuff\'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">5</span>\nbar <span class="token operator">=</span> decode<span class="token punctuation">(</span><span class="token string">\'also bad\'</span><span class="token punctuation">)</span>\nbar<span class="token punctuation">[</span><span class="token string">\'meep\'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Foo:\'</span><span class="token punctuation">,</span> foo<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Bar:\'</span><span class="token punctuation">,</span> bar<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nFoo<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">\'stuff\'</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">\'meep\'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span>\nBar<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">\'stuff\'</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">\'meep\'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们本意是想让这两次调用操作得到两个不同的空白字典，每个字典都可以分别用来存放不同的键值。但实际上，只要修改其中一个字典，另一个字典的内容就会受到影响。这种错误的根源在于，foo 和 bar 实际上是同一个字典，都等于系统一开始给 default 参数确定默认值时所分配的那个字典。它们表示的是同一个字典对象。</p>\n<p>要解决这个问题，可以把默认值设成 None，并且在 docstring 文档里面说明，函数在这个值为 None 时会怎么做。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="98291675658818270000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import json\n\n\ndef decode(data, default=None):\n    &quot;&quot;&quot;Load JSON data from a string.\n\n    Args:\n        data: JSON data to decode.\n        default: Value to return if decoding fails.\n            Defaults to an empty dictionary.\n    &quot;&quot;&quot;\n    try:\n        return json.loads(data)\n    except ValueError:\n        if default is None:\n            default = {}\n        return default\n\n\nfoo = decode(\'bad data\')\nfoo[\'stuff\'] = 5\nbar = decode(\'also bad\')\nbar[\'meep\'] = 1\nprint(\'Foo:\', foo)\nprint(\'Bar:\', bar)\nassert foo is not bar\n\n>>>\nFoo: {\'stuff\': 5}\nBar: {\'meep\': 1}`, `98291675658818270000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> json\n\n\n<span class="token keyword">def</span> <span class="token function">decode</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token triple-quoted-string string">"""Load JSON data from a string.\n\n    Args:\n        data: JSON data to decode.\n        default: Value to return if decoding fails.\n            Defaults to an empty dictionary.\n    """</span>\n    <span class="token keyword">try</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>data<span class="token punctuation">)</span>\n    <span class="token keyword">except</span> ValueError<span class="token punctuation">:</span>\n        <span class="token keyword">if</span> default <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>\n            default <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n        <span class="token keyword">return</span> default\n\n\nfoo <span class="token operator">=</span> decode<span class="token punctuation">(</span><span class="token string">\'bad data\'</span><span class="token punctuation">)</span>\nfoo<span class="token punctuation">[</span><span class="token string">\'stuff\'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">5</span>\nbar <span class="token operator">=</span> decode<span class="token punctuation">(</span><span class="token string">\'also bad\'</span><span class="token punctuation">)</span>\nbar<span class="token punctuation">[</span><span class="token string">\'meep\'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Foo:\'</span><span class="token punctuation">,</span> foo<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Bar:\'</span><span class="token punctuation">,</span> bar<span class="token punctuation">)</span>\n<span class="token keyword">assert</span> foo <span class="token keyword">is</span> <span class="token keyword">not</span> bar\n\n<span class="token operator">>></span><span class="token operator">></span>\nFoo<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">\'stuff\'</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">}</span>\nBar<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">\'meep\'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这个思路可以跟类型注解搭配起来（参见第 90 条）。下面这种写法把 when 参数标注成可选（Optional）值，并限定其类型为 datetime。于是，它的取值就只有两种可能，要么是 None，要么是 datetime 对象。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="55972640920388700000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from typing import Optional\n\n\ndef log_typed(message: str, when: Optional[datetime] = None) -> None:\n    &quot;&quot;&quot;Log a message with a timestamp.\n\n        Args:\n            message: Message to print.\n            when: datetime of when the message occurred.\n                Defaults to the present time.\n    &quot;&quot;&quot;\n    if when is None:\n        when = datetime.now()\n    print(f\'{when}: {message}\')`, `55972640920388700000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> typing <span class="token keyword">import</span> Optional\n\n\n<span class="token keyword">def</span> <span class="token function">log_typed</span><span class="token punctuation">(</span>message<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> when<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>datetime<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token boolean">None</span><span class="token punctuation">:</span>\n    <span class="token triple-quoted-string string">"""Log a message with a timestamp.\n\n        Args:\n            message: Message to print.\n            when: datetime of when the message occurred.\n                Defaults to the present time.\n    """</span>\n    <span class="token keyword">if</span> when <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>\n        when <span class="token operator">=</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>when<span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{</span>message<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="总结-20"><a href="#%E6%80%BB%E7%BB%93-20" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>参数的默认值只会计算一次，也就是在系统把定义函数的那个模块加载进来的时候。所以，如果默认值将来可能由调用方修改（例如 {}、[]）或者要随着调用时的情况变化（例如 datetime.now()），那么程序就会出现奇怪的效果。</li>\n<li>如果关键字参数的默认值属于这种会发生变化的值，那就应该写成 None，并且要在 docstring 里面描述函数此时的默认行为。</li>\n<li>默认值为 None 的关键字参数，也可以添加类型注解。</li>\n</ol>\n<h2 id="第-25-条：用只能以关键字指定和只能按位置传入的参数来设计清晰的参数列表"><a href="#%E7%AC%AC-25-%E6%9D%A1%EF%BC%9A%E7%94%A8%E5%8F%AA%E8%83%BD%E4%BB%A5%E5%85%B3%E9%94%AE%E5%AD%97%E6%8C%87%E5%AE%9A%E5%92%8C%E5%8F%AA%E8%83%BD%E6%8C%89%E4%BD%8D%E7%BD%AE%E4%BC%A0%E5%85%A5%E7%9A%84%E5%8F%82%E6%95%B0%E6%9D%A5%E8%AE%BE%E8%AE%A1%E6%B8%85%E6%99%B0%E7%9A%84%E5%8F%82%E6%95%B0%E5%88%97%E8%A1%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 25 条：用只能以关键字指定和只能按位置传入的参数来设计清晰的参数列表</h2>\n<p>按关键字传递参数是 Python 函数的一项强大特性（参见第 23 条）。这种关键字参数特别灵活，在很多情况下，都能让我们写出一看就懂的函数代码。例如，计算两数相除的结果时，可能需要仔细考虑各种特殊情况。</p>\n<p>例如，在除数为 0 的情况下，是抛出 ZeroDivisionError 异常，还是返回无穷（infinity）；在结果溢出的情况下，是抛出 OverflowError 异常，还是返回 0。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="72607158103708705000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def safe_division(number, divisor,\n                  ignore_overflow,\n                  ignore_zero_division):\n    try:\n        return number / divisor\n    except OverflowError:\n        if ignore_overflow:\n            return 0\n        else:\n            raise\n    except ZeroDivisionError:\n        if ignore_zero_division:\n            return float(\'inf\')\n        else:\n            raise`, `72607158103708705000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">safe_division</span><span class="token punctuation">(</span>number<span class="token punctuation">,</span> divisor<span class="token punctuation">,</span>\n                  ignore_overflow<span class="token punctuation">,</span>\n                  ignore_zero_division<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">try</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> number <span class="token operator">/</span> divisor\n    <span class="token keyword">except</span> OverflowError<span class="token punctuation">:</span>\n        <span class="token keyword">if</span> ignore_overflow<span class="token punctuation">:</span>\n            <span class="token keyword">return</span> <span class="token number">0</span>\n        <span class="token keyword">else</span><span class="token punctuation">:</span>\n            <span class="token keyword">raise</span>\n    <span class="token keyword">except</span> ZeroDivisionError<span class="token punctuation">:</span>\n        <span class="token keyword">if</span> ignore_zero_division<span class="token punctuation">:</span>\n            <span class="token keyword">return</span> <span class="token builtin">float</span><span class="token punctuation">(</span><span class="token string">\'inf\'</span><span class="token punctuation">)</span>\n        <span class="token keyword">else</span><span class="token punctuation">:</span>\n            <span class="token keyword">raise</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这个函数用起来很直观。如果想在结果溢出的情况下，让它返回 0，那么可以像下面这样调用函数。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="33165569950043607000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`result = safe_division(1.0, 10**500, True, False)\nprint(result)\n\n>>>\n0`, `33165569950043607000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">result <span class="token operator">=</span> safe_division<span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token operator">**</span><span class="token number">500</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token number">0</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果想在除数是 0 的情况下，让函数返回无穷，那么就按下面这样来写。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="58272452852300890000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`result = safe_division(1.0, 0, False, True)\nprint(result)\n\n>>>\ninf`, `58272452852300890000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">result <span class="token operator">=</span> safe_division<span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\ninf</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>表示要不要忽略异常的那两个参数都是 Boolean 值，所以容易弄错位置，这会让程序出现难以查找的 bug。要想让代码看起来更清晰，一种办法是给这两个参数都指定默认值。按照默认值，该函数只要遇到特殊情况，就会抛出异常。</p>\n<p>调用者可以用关键字参数指定覆盖其中某个参数的默认值，以调整函数在遇到那种特殊情况时的处理方式，同时让另一个参数依然取那个参数自己的默认值。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="51470252939417846000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def safe_division_b(number, divisor,\n                    ignore_overflow=False,\n                    ignore_zero_division=False):\n    try:\n        return number / divisor\n    except OverflowError:\n        if ignore_overflow:\n            return 0\n        else:\n            raise\n    except ZeroDivisionError:\n        if ignore_zero_division:\n            return float(\'inf\')\n        else:\n            raise\n\n\nresult = safe_division_b(1.0, 10**500, ignore_overflow=True)\nprint(result)\nresult = safe_division_b(1.0, 0, ignore_zero_division=True)\nprint(result)\n\n>>>\n0\ninf`, `51470252939417846000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py{2-3}"\n              >\n                <span class="gatsby-code-button-language">py{2-3}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">safe_division_b</span><span class="token punctuation">(</span>number<span class="token punctuation">,</span> divisor<span class="token punctuation">,</span>\n<span class="gatsby-highlight-code-line">                    ignore_overflow<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">                    ignore_zero_division<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>    <span class="token keyword">try</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> number <span class="token operator">/</span> divisor\n    <span class="token keyword">except</span> OverflowError<span class="token punctuation">:</span>\n        <span class="token keyword">if</span> ignore_overflow<span class="token punctuation">:</span>\n            <span class="token keyword">return</span> <span class="token number">0</span>\n        <span class="token keyword">else</span><span class="token punctuation">:</span>\n            <span class="token keyword">raise</span>\n    <span class="token keyword">except</span> ZeroDivisionError<span class="token punctuation">:</span>\n        <span class="token keyword">if</span> ignore_zero_division<span class="token punctuation">:</span>\n            <span class="token keyword">return</span> <span class="token builtin">float</span><span class="token punctuation">(</span><span class="token string">\'inf\'</span><span class="token punctuation">)</span>\n        <span class="token keyword">else</span><span class="token punctuation">:</span>\n            <span class="token keyword">raise</span>\n\n\nresult <span class="token operator">=</span> safe_division_b<span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token operator">**</span><span class="token number">500</span><span class="token punctuation">,</span> ignore_overflow<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>\nresult <span class="token operator">=</span> safe_division_b<span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> ignore_zero_division<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token number">0</span>\ninf</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然而，由于这些关键参数是可选的，我们没办法要求调用者必须按照关键字形式来指定这两个参数。他们还是可以用传统的写法，按位置给这个新定义的 <code class="language-text">safe_division_b</code> 函数传递参数。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="24721201465814467000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`assert safe_division_b(1.0, 10**500, True, False) == 0`, `24721201465814467000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">assert</span> safe_division_b<span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token operator">**</span><span class="token number">500</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>对于这种参数比较复杂的函数，我们可以声明只能通过关键字指定的参数（keyword-only argument），这样的话，写出来的代码就能清楚地反映调用者的想法了。这种参数只能用关键字来指定，不能按位置传递。</p>\n<p>下面就重新定义 <code class="language-text">safe_division</code> 函数，让它接受这样的参数。参数列表里的 <code class="language-text">*</code> 符号把参数分成两组，左边是位置参数，右边是只能用关键字指定的参数。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="94527170564040180000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def safe_division_c(number, divisor, *,\n                    ignore_overflow=False,\n                    ignore_zero_division=False):\n    try:\n        return number / divisor\n    except OverflowError:\n        if ignore_overflow:\n            return 0\n        else:\n            raise\n    except ZeroDivisionError:\n        if ignore_zero_division:\n            return float(\'inf\')\n        else:\n            raise\n\n\nassert safe_division_c(1.0, 10**500, True, False) == 0\n\n>>>\nTraceback ...\nTypeError: safe_division_c() takes 2 positional arguments but 4 were given`, `94527170564040180000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py{1}"\n              >\n                <span class="gatsby-code-button-language">py{1}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="gatsby-highlight-code-line"><span class="token keyword">def</span> <span class="token function">safe_division_c</span><span class="token punctuation">(</span>number<span class="token punctuation">,</span> divisor<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">,</span></span>                    ignore_overflow<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>\n                    ignore_zero_division<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">try</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> number <span class="token operator">/</span> divisor\n    <span class="token keyword">except</span> OverflowError<span class="token punctuation">:</span>\n        <span class="token keyword">if</span> ignore_overflow<span class="token punctuation">:</span>\n            <span class="token keyword">return</span> <span class="token number">0</span>\n        <span class="token keyword">else</span><span class="token punctuation">:</span>\n            <span class="token keyword">raise</span>\n    <span class="token keyword">except</span> ZeroDivisionError<span class="token punctuation">:</span>\n        <span class="token keyword">if</span> ignore_zero_division<span class="token punctuation">:</span>\n            <span class="token keyword">return</span> <span class="token builtin">float</span><span class="token punctuation">(</span><span class="token string">\'inf\'</span><span class="token punctuation">)</span>\n        <span class="token keyword">else</span><span class="token punctuation">:</span>\n            <span class="token keyword">raise</span>\n\n\n<span class="token keyword">assert</span> safe_division_c<span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token operator">**</span><span class="token number">500</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nTypeError<span class="token punctuation">:</span> safe_division_c<span class="token punctuation">(</span><span class="token punctuation">)</span> takes <span class="token number">2</span> positional arguments but <span class="token number">4</span> were given</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>当然我们还是可以像前面那样，用关键字参数指定覆盖其中一个参数的默认值（即忽略其中一种特殊情况，并让函数在遇到另一种特殊情况时抛出异常）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="97376338747167950000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`result = safe_division_c(1.0, 0, ignore_zero_division=True)\nassert result == float(\'inf\')\ntry:\n    result = safe_division_c(1.0, 0)\nexcept ZeroDivisionError:\n    pass  # Expected`, `97376338747167950000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">result <span class="token operator">=</span> safe_division_c<span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> ignore_zero_division<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>\n<span class="token keyword">assert</span> result <span class="token operator">==</span> <span class="token builtin">float</span><span class="token punctuation">(</span><span class="token string">\'inf\'</span><span class="token punctuation">)</span>\n<span class="token keyword">try</span><span class="token punctuation">:</span>\n    result <span class="token operator">=</span> safe_division_c<span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>\n<span class="token keyword">except</span> ZeroDivisionError<span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>  <span class="token comment"># Expected</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样改依然有问题，因为在 <code class="language-text">safe_division_c</code> 版本的函数里面，有两个参数（也就是 number 和 divisor）必须由调用者提供。然而，调用者在提供这两个参数时，既可以按位置提供，也可以按关键字提供，还可以把这两种方式混起来用。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="55086678798248130000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`assert safe_division_c(number=2, divisor=5) == 0.4\nassert safe_division_c(divisor=5, number=2) == 0.4\nassert safe_division_c(2, divisor=5) == 0.4`, `55086678798248130000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">assert</span> safe_division_c<span class="token punctuation">(</span>number<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> divisor<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0.4</span>\n<span class="token keyword">assert</span> safe_division_c<span class="token punctuation">(</span>divisor<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> number<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0.4</span>\n<span class="token keyword">assert</span> safe_division_c<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> divisor<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0.4</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>在未来也许因为扩展函数的需要，甚至是因为代码风格的变化，或许要修改这两个参数的名字。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="22061796397379154000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def safe_division_c(numerator, denominator, *,\n                    ignore_overflow=False,\n                    ignore_zero_division=False):`, `22061796397379154000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py{1}"\n              >\n                <span class="gatsby-code-button-language">py{1}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="gatsby-highlight-code-line"><span class="token keyword">def</span> <span class="token function">safe_division_c</span><span class="token punctuation">(</span>numerator<span class="token punctuation">,</span> denominator<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">,</span></span>                    ignore_overflow<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>\n                    ignore_zero_division<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>这看起来只是文字上面的微调，但之前所有通过关键字形式来指定这两个参数的调用代码，都会出错。</p>\n<p>其实最重要的问题在于，我们根本就没打算把 number 和 divisor 这两个名称纳入函数的接口；我们只是在编写函数的实现代码时，随意挑了这两个比较顺口的名称而已。也并不期望调用者也非得采用这种称呼来指定这两个参数。</p>\n<p>Python 3.8 引入了一项新特性，可以解决这个问题，这就是只能按位置传递的参数（positional-only argument）。这种参数与刚才的只能通过关键字指定的参数（keyword-only argument）相反，它们必须按位置指定，绝不能通过关键字形式指定。下面来重新定义 <code class="language-text">safe_division</code> 函数，使其前两个必须由调用者提供的参数只能按位置来提供。参数列表中的 <code class="language-text">/</code> 符号，表示它左边的那些参数只能按位置指定。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="71475604630095480000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def safe_division_d(numerator, denominator, /, *,\n                    ignore_overflow=False,\n                    ignore_zero_division=False):\n    try:\n        return numerator / denominator\n    except OverflowError:\n        if ignore_overflow:\n            return 0\n        else:\n            raise\n    except ZeroDivisionError:\n        if ignore_zero_division:\n            return float(\'inf\')\n        else:\n            raise\n\n\nassert safe_division_d(2, 5) == 0.4 # 正常运行\nassert safe_division_d(numerator=2, denominator=5) == 0.4 # 报错`, `71475604630095480000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py{1}"\n              >\n                <span class="gatsby-code-button-language">py{1}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="gatsby-highlight-code-line"><span class="token keyword">def</span> <span class="token function">safe_division_d</span><span class="token punctuation">(</span>numerator<span class="token punctuation">,</span> denominator<span class="token punctuation">,</span> <span class="token operator">/</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">,</span></span>                    ignore_overflow<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>\n                    ignore_zero_division<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">try</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> numerator <span class="token operator">/</span> denominator\n    <span class="token keyword">except</span> OverflowError<span class="token punctuation">:</span>\n        <span class="token keyword">if</span> ignore_overflow<span class="token punctuation">:</span>\n            <span class="token keyword">return</span> <span class="token number">0</span>\n        <span class="token keyword">else</span><span class="token punctuation">:</span>\n            <span class="token keyword">raise</span>\n    <span class="token keyword">except</span> ZeroDivisionError<span class="token punctuation">:</span>\n        <span class="token keyword">if</span> ignore_zero_division<span class="token punctuation">:</span>\n            <span class="token keyword">return</span> <span class="token builtin">float</span><span class="token punctuation">(</span><span class="token string">\'inf\'</span><span class="token punctuation">)</span>\n        <span class="token keyword">else</span><span class="token punctuation">:</span>\n            <span class="token keyword">raise</span>\n\n\n<span class="token keyword">assert</span> safe_division_d<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0.4</span> <span class="token comment"># 正常运行</span>\n<span class="token keyword">assert</span> safe_division_d<span class="token punctuation">(</span>numerator<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> denominator<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0.4</span> <span class="token comment"># 报错</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在我们可以确信：给 <code class="language-text">safe_division_d</code> 函数的前两个参数（也就是那两个必备的参数）所挑选的名称，已经与调用者的代码解耦了。即便以后再次修改这两个参数的名称，也不会影响已经写好的调用代码。</p>\n<p>在函数的参数列表之中，<code class="language-text">/</code> 符号左侧的参数是只能按位置指定的参数，<code class="language-text">*</code> 符号右侧的参数则是只能按关键字形式指定的参数。那么，这两个符号如果同时出现在参数列表中，会有什么效果呢？这是个值得注意的问题。这意味着，这两个符号之间的参数，既可以按位置提供，又可以用关键字形式指定（其实，如果不特别说明 Python 函数的参数全都属于这种参数）。在设计 API 时，为了体现某编程风格或者实现某些需求，可能会允许某些参数既可以按位置传递，也可以用关键字形式指定，这样可以让代码简单易读。例如，给下面这个 <code class="language-text">safe_division</code> 函数的参数列表添加一个可选的 ndigits 参数，允许调用者指定这次除法应该精确到小数点后第几位。</p>\n<p>下面我们用三种方式来调用这个 <code class="language-text">safe_division_e</code> 函数。ndigits 是个带默认值的普通参数，因此，它既可以按位置传递，也可以用关键字来指定，还可以直接省略。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="69576253991882560000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def safe_division_e(numerator, denominator, /,\n                    ndigits=10, *,\n                    ignore_overflow=False,\n                    ignore_zero_division=False):\n    try:\n        fraction = numerator / denominator\n        return round(fraction, ndigits)\n    except OverflowError:\n        if ignore_overflow:\n            return 0\n        else:\n            raise\n    except ZeroDivisionError:\n        if ignore_zero_division:\n            return float(\'inf\')\n        else:\n            raise\n\n\nresult = safe_division_e(22, 7)\nprint(result)\nresult = safe_division_e(22, 7, 5)\nprint(result)\nresult = safe_division_e(22, 7, ndigits=2)\nprint(result)\n\n>>>\n3.1428571429\n3.14286\n3.14`, `69576253991882560000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">safe_division_e</span><span class="token punctuation">(</span>numerator<span class="token punctuation">,</span> denominator<span class="token punctuation">,</span> <span class="token operator">/</span><span class="token punctuation">,</span>\n                    ndigits<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">,</span>\n                    ignore_overflow<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>\n                    ignore_zero_division<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">try</span><span class="token punctuation">:</span>\n        fraction <span class="token operator">=</span> numerator <span class="token operator">/</span> denominator\n        <span class="token keyword">return</span> <span class="token builtin">round</span><span class="token punctuation">(</span>fraction<span class="token punctuation">,</span> ndigits<span class="token punctuation">)</span>\n    <span class="token keyword">except</span> OverflowError<span class="token punctuation">:</span>\n        <span class="token keyword">if</span> ignore_overflow<span class="token punctuation">:</span>\n            <span class="token keyword">return</span> <span class="token number">0</span>\n        <span class="token keyword">else</span><span class="token punctuation">:</span>\n            <span class="token keyword">raise</span>\n    <span class="token keyword">except</span> ZeroDivisionError<span class="token punctuation">:</span>\n        <span class="token keyword">if</span> ignore_zero_division<span class="token punctuation">:</span>\n            <span class="token keyword">return</span> <span class="token builtin">float</span><span class="token punctuation">(</span><span class="token string">\'inf\'</span><span class="token punctuation">)</span>\n        <span class="token keyword">else</span><span class="token punctuation">:</span>\n            <span class="token keyword">raise</span>\n\n\nresult <span class="token operator">=</span> safe_division_e<span class="token punctuation">(</span><span class="token number">22</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>\nresult <span class="token operator">=</span> safe_division_e<span class="token punctuation">(</span><span class="token number">22</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>\nresult <span class="token operator">=</span> safe_division_e<span class="token punctuation">(</span><span class="token number">22</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> ndigits<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token number">3.1428571429</span>\n<span class="token number">3.14286</span>\n<span class="token number">3.14</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="总结-21"><a href="#%E6%80%BB%E7%BB%93-21" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>Keyword-only argument 是一种只能通过关键字指定而不能通过位置指定的参数。这迫使调用者必须指明，这个值是传给哪一个参数的。在函数的参数列表中，这种参数位于 <code class="language-text">*</code> 符号的右侧。</li>\n<li>Positional-only argument 是这样一种参数，它不允许调用者通过关键字来指定，而是要求必须按位置传递。这可以降低调用代码与参数名称之间的耦合程度。在函数的参数列表中，这些参数位于 <code class="language-text">/</code> 符号的左侧。</li>\n<li>在参数列表中，位于 <code class="language-text">/</code> 与 <code class="language-text">*</code> 之间的参数，可以按位置指定，也可以用关键字来指定。这也是 Python 普通参数的默认指定方式。</li>\n</ol>\n<h2 id="第-26-条：用-functoolswraps-定义函数修饰器"><a href="#%E7%AC%AC-26-%E6%9D%A1%EF%BC%9A%E7%94%A8-functoolswraps-%E5%AE%9A%E4%B9%89%E5%87%BD%E6%95%B0%E4%BF%AE%E9%A5%B0%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 26 条：用 functools.wraps 定义函数修饰器</h2>\n<p>Python 中有一种特殊的写法，可以用修饰器（decorator）来封装某个函数，从而让程序在执行这个函数之前与执行完这个函数之后，分别运行某些代码。这意味着，调用者传给函数的参数值、函数返回给调用者的值，以及函数抛出的异常，都可以由修饰器访问并修改。这是个很有用的机制，能够确保用户以正确的方式使用函数，也能够用来调试程序或实现函数注册功能，此外还有许多用途。</p>\n<p>例如，假设我们要把函数执行时收到的参数与返回的值记录下来。这在调试递归函数时是很有用的，因为我们需要知道，这个函数执行每一层递归时，输入的是什么参数，返回的是什么值。下面我们就定义这样一个修饰器，在实现这个修饰器时，用 <code class="language-text">*args</code> 与 <code class="language-text">**kwargs</code> 表示受修饰的原函数 func 所收到的参数（参见第 22 条与第 23 条）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="88793774219943850000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def trace(func):\n    def wrapper(*args, **kwargs):\n        result = func(*args, **kwargs)\n        print(f\'{func.__name__}({args!r}，{kwargs!r})\'\n              f\'-> {result!r}\')\n        return result\n    return wrapper\n\n\n@trace # 相当于 fibonacci = trace(fibonacci)\ndef fibonacci(n):\n    &quot;&quot;&quot;Return the n-th Fibonacci number&quot;&quot;&quot;\n    if n in (0, 1):\n        return n\n    return fibonacci(n - 2) + fibonacci(n - 1)\n\nfibonacci(4)\n\n>>>\nfibonacci((0,)，{})-> 0\nfibonacci((1,)，{})-> 1\nfibonacci((2,)，{})-> 1\nfibonacci((1,)，{})-> 1\nfibonacci((0,)，{})-> 0\nfibonacci((1,)，{})-> 1\nfibonacci((2,)，{})-> 1\nfibonacci((3,)，{})-> 2\nfibonacci((4,)，{})-> 3`, `88793774219943850000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">trace</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">wrapper</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        result <span class="token operator">=</span> func<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>func<span class="token punctuation">.</span>__name__<span class="token punctuation">}</span></span><span class="token string">(</span><span class="token interpolation"><span class="token punctuation">{</span>args<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">，</span><span class="token interpolation"><span class="token punctuation">{</span>kwargs<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">)\'</span></span>\n              <span class="token string-interpolation"><span class="token string">f\'-> </span><span class="token interpolation"><span class="token punctuation">{</span>result<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n        <span class="token keyword">return</span> result\n    <span class="token keyword">return</span> wrapper\n\n\n@trace <span class="token comment"># 相当于 fibonacci = trace(fibonacci)</span>\n<span class="token keyword">def</span> <span class="token function">fibonacci</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token triple-quoted-string string">"""Return the n-th Fibonacci number"""</span>\n    <span class="token keyword">if</span> n <span class="token keyword">in</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> n\n    <span class="token keyword">return</span> fibonacci<span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> fibonacci<span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>\n\nfibonacci<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nfibonacci<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token punctuation">)</span>，<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span> <span class="token number">0</span>\nfibonacci<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">)</span>，<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span> <span class="token number">1</span>\nfibonacci<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token punctuation">)</span>，<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span> <span class="token number">1</span>\nfibonacci<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">)</span>，<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span> <span class="token number">1</span>\nfibonacci<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token punctuation">)</span>，<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span> <span class="token number">0</span>\nfibonacci<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">)</span>，<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span> <span class="token number">1</span>\nfibonacci<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token punctuation">)</span>，<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span> <span class="token number">1</span>\nfibonacci<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token punctuation">)</span>，<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span> <span class="token number">2</span>\nfibonacci<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token punctuation">)</span>，<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span> <span class="token number">3</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样写确实能满足需求，但是会带来一个我们不愿意看到的副作用。修饰器返回的那个值，也就是刚才调用的 fibonacci，它的名字并不叫 <code class="language-text">fibonacci</code>。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="56884996581163290000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`print(fibonacci)\n\n>>>\n<function trace.<locals>.wrapper at 0x108955dcO>`, `56884996581163290000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">print</span><span class="token punctuation">(</span>fibonacci<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token operator">&lt;</span>function trace<span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token builtin">locals</span><span class="token operator">></span><span class="token punctuation">.</span>wrapper at 0x108955dcO<span class="token operator">></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这种现象解释起来并不困难。trace 函数返回的，是它里面定义的 wrapper 函数，所以，当我们把这个返回值赋给 fibonacci 之后，fibonacci 这个名称所表示的自然就是 wrapper 了。问题在于，这样可能会干扰那些需要利用 introspection 机制来运作的工具，例如调试器（debugger）（参见第 80 条）。</p>\n<p>例如，如果用内置的 help 函数来查看修饰后的 fibonacci，那么打印出来的并不是我们想看的帮助文档，它本来应该打印前面定义时写的那行 <code class="language-text">Return the n-th Fibonacci number</code> 文本才对。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="1093548945298072800"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`help(fibonacci)\n\n>>>\nHelp on function wrapper in module __main__:\n\nwrapper(*args, **kwargs)`, `1093548945298072800`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token builtin">help</span><span class="token punctuation">(</span>fibonacci<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nHelp on function wrapper <span class="token keyword">in</span> module __main__<span class="token punctuation">:</span>\n\nwrapper<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>对象序列化器（object serializer，参见第 68 条）也无法正常运作，因为它不能确定受修饰的那个原始函数的位置。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="13887742295152040000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import pickle\n\npickle.dumps(fibonacci)\n\n>>>\nTraceback ...\nAttributeError: Can\'t pickle local object \'trace.<locals>.wrapper\'`, `13887742295152040000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> pickle\n\npickle<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>fibonacci<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nAttributeError<span class="token punctuation">:</span> Can<span class="token string">\'t pickle local object \'</span>trace<span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token builtin">locals</span><span class="token operator">></span><span class="token punctuation">.</span>wrapper\'</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>要想解决这些问题，可以改用 functools 内置模块之中的 wraps 辅助函数来实现。wraps 本身也是个修饰器，它可以帮助你编写自己的修饰器。把它运用到 wrapper 函数上面，它就会将重要的元数据（metadata）全都从内部函数复制到外部函数。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="75762928819030310000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import pickle\nfrom functools import wraps\n\n\ndef trace(func):\n    @wraps(func)\n    def wrapper(*args, **kwargs):\n        result = func(*args, **kwargs)\n        print(f\'{func.__name__}({args!r}，{kwargs!r})\'\n              f\'-> {result!r}\')\n        return result\n    return wrapper\n\n\n@trace\ndef fibonacci(n):\n    &quot;&quot;&quot;Return the n-th Fibonacci number&quot;&quot;&quot;\n    if n in (0, 1):\n        return n\n    return fibonacci(n - 2) + fibonacci(n - 1)\n\n\npickle.dumps(fibonacci)\nhelp(fibonacci)`, `75762928819030310000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py{2,6}"\n              >\n                <span class="gatsby-code-button-language">py{2,6}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> pickle\n<span class="gatsby-highlight-code-line"><span class="token keyword">from</span> functools <span class="token keyword">import</span> wraps</span>\n\n<span class="token keyword">def</span> <span class="token function">trace</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">:</span>\n<span class="gatsby-highlight-code-line">    @wraps<span class="token punctuation">(</span>func<span class="token punctuation">)</span></span>    <span class="token keyword">def</span> <span class="token function">wrapper</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        result <span class="token operator">=</span> func<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>func<span class="token punctuation">.</span>__name__<span class="token punctuation">}</span></span><span class="token string">(</span><span class="token interpolation"><span class="token punctuation">{</span>args<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">，</span><span class="token interpolation"><span class="token punctuation">{</span>kwargs<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">)\'</span></span>\n              <span class="token string-interpolation"><span class="token string">f\'-> </span><span class="token interpolation"><span class="token punctuation">{</span>result<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n        <span class="token keyword">return</span> result\n    <span class="token keyword">return</span> wrapper\n\n\n@trace\n<span class="token keyword">def</span> <span class="token function">fibonacci</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token triple-quoted-string string">"""Return the n-th Fibonacci number"""</span>\n    <span class="token keyword">if</span> n <span class="token keyword">in</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> n\n    <span class="token keyword">return</span> fibonacci<span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> fibonacci<span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>\n\n\npickle<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>fibonacci<span class="token punctuation">)</span>\n<span class="token builtin">help</span><span class="token punctuation">(</span>fibonacci<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在我们就可以通过 help 函数看到正确的文档了。虽然原来的 fibonacci 函数现在封装在修饰器里面，但我们还是可以看到它的文档。</p>\n<p>除了这里讲到的几个方面之外，Python 函数还有很多标准属性（例如 <code class="language-text">__name__</code>、<code class="language-text">__module__</code>、<code class="language-text">__annotations__</code>）也应该在受到封装时得以保留，这样才能让相关的接口正常运作。wraps 可以帮助保留这些属性，使程序表现出正确的行为。</p>\n<h3 id="总结-22"><a href="#%E6%80%BB%E7%BB%93-22" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>修饰器是 Python 中的一种写法，能够把一个函数封装在另一个函数里面，这样程序在执行原函数之前与执行完毕之后，就有机会执行其他一些逻辑了。</li>\n<li>修饰器可能会让那些利用 introspection 机制运作的工具（例如调试器）产生奇怪的行为。</li>\n<li>Python 内置的 functools 模块里有个叫作 wraps 的修饰器，可以帮助我们正确定义自己的修饰器，从而避开相关的问题。</li>\n</ol>\n<h1 id="推导与生成"><a href="#%E6%8E%A8%E5%AF%BC%E4%B8%8E%E7%94%9F%E6%88%90" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>推导与生成</h1>\n<h2 id="第-27-条：用列表推导取代-map-与-filter"><a href="#%E7%AC%AC-27-%E6%9D%A1%EF%BC%9A%E7%94%A8%E5%88%97%E8%A1%A8%E6%8E%A8%E5%AF%BC%E5%8F%96%E4%BB%A3-map-%E4%B8%8E-filter" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 27 条：用列表推导取代 map 与 filter</h2>\n<p>Python 里面有一种很精简的写法，可以根据某个序列或可迭代对象派生出一份新的列表。用这种写法写成的表达式，叫作列表推导（list comprehension）。假设我们要用列表中每个元素的平方值构建一份新的列表。传统的写法是，采用下面这个简单的 for 循环来实现。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="39233514924116260000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`a = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]\nsquares = []\nfor x in a:\n    squares.append(x**2)\nprint(squares)\n\n>>>\n[1, 4, 9, 16, 25, 36, 49, 64, 81, 100]`, `39233514924116260000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span>\nsquares <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n<span class="token keyword">for</span> x <span class="token keyword">in</span> a<span class="token punctuation">:</span>\n    squares<span class="token punctuation">.</span>append<span class="token punctuation">(</span>x<span class="token operator">**</span><span class="token number">2</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>squares<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">,</span> <span class="token number">36</span><span class="token punctuation">,</span> <span class="token number">49</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">81</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>上面那段代码可以改用列表推导来写，这样可以在迭代列表的过程中，根据表达式算出新列表中的对应元素。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="27581520659350135000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`a = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]\nsquares = [x**2 for x in a]\nprint(squares)`, `27581520659350135000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span>\nsquares <span class="token operator">=</span> <span class="token punctuation">[</span>x<span class="token operator">**</span><span class="token number">2</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> a<span class="token punctuation">]</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>squares<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>这种功能当然也可以用内置函数 map 实现，它能够从多个列表中分别取出当前位置上的元素，并把它们当作参数传给映射函数，以求出新列表在这个位置上的元素值。如果映射关系比较简单（例如只是把一个列表映射到另一个列表），那么用列表推导来写还是比用 map 简单一些，因为用 map 的时候，必须先把映射逻辑定义成 lambda 函数，这看上去稍微有点烦琐。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="77852906460959780000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`a = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]\nsquares = list(map(lambda x: x ** 2, a))\nprint(squares)`, `77852906460959780000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span>\nsquares <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>squares<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>列表推导还有一个地方比 map 好，就是它能够方便地过滤原列表，把某些输入值对应的计算结果从输出结果中排除。例如，假设新列表只需要纳入原列表中那些偶数的平方值，那我们可以在推导的时候，在 for x in a 这一部分的右侧写一个条件表达式：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="13818894206705746000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`a = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]\neven_squares = [x**2 for x in a if x % 2 == 0]\nprint(even_squares)\n\n>>>\n[4, 16, 36, 64, 100]`, `13818894206705746000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span>\neven_squares <span class="token operator">=</span> <span class="token punctuation">[</span>x<span class="token operator">**</span><span class="token number">2</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> a <span class="token keyword">if</span> x <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">]</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>even_squares<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">36</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这种功能也可以通过内置的 filter 与 map 函数来实现，但是这两个函数相结合的写法要比列表推导难懂一些。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="14879104265457177000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`a = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]\neven_squares = [x**2 for x in a if x % 2 == 0]\nalt = map(lambda x: x**2, filter(lambda x: x % 2 == 0, a))\nassert even_squares == list(alt)`, `14879104265457177000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span>\neven_squares <span class="token operator">=</span> <span class="token punctuation">[</span>x<span class="token operator">**</span><span class="token number">2</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> a <span class="token keyword">if</span> x <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">]</span>\nalt <span class="token operator">=</span> <span class="token builtin">map</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token operator">**</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token builtin">filter</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">assert</span> even_squares <span class="token operator">==</span> <span class="token builtin">list</span><span class="token punctuation">(</span>alt<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>字典与集合也有相应的推导机制，分别叫作字典推导（dictionary comprehension）与集合推导（set comprehension）。编写算法时，可以利用这些机制根据原字典与原集合创建新字典与新集合。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="88470874675130860000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`a = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]\neven_squares_dict = {x: x**2 for x in a if x % 2 == 0}\nthrees_cubed_set = {x**3 for x in a if x % 3 == 0}\nprint(even_squares_dict)\nprint(threes_cubed_set)\n\n>>>\n{2: 4, 4: 16, 6: 36, 8: 64, 10: 100}\n{216, 729, 27}`, `88470874675130860000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span>\neven_squares_dict <span class="token operator">=</span> <span class="token punctuation">{</span>x<span class="token punctuation">:</span> x<span class="token operator">**</span><span class="token number">2</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> a <span class="token keyword">if</span> x <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">}</span>\nthrees_cubed_set <span class="token operator">=</span> <span class="token punctuation">{</span>x<span class="token operator">**</span><span class="token number">3</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> a <span class="token keyword">if</span> x <span class="token operator">%</span> <span class="token number">3</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">}</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>even_squares_dict<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>threes_cubed_set<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">{</span><span class="token number">2</span><span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">:</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">:</span> <span class="token number">36</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">:</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">}</span>\n<span class="token punctuation">{</span><span class="token number">216</span><span class="token punctuation">,</span> <span class="token number">729</span><span class="token punctuation">,</span> <span class="token number">27</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果改用 map 与 filter 实现，那么还必须调用相应的构造器（constructor），这会让代码变得很长，需要分成多行才能写得下。这样看起来比较乱，不如使用推导机制的代码清晰。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="90288243726061110000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`a = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]\neven_squares_dict = {x: x**2 for x in a if x % 2 == 0}\nthrees_cubed_set = {x**3 for x in a if x % 3 == 0}\n\nalt_dict = dict(map(lambda x: (x, x**2),\n                    filter(lambda x: x % 2 == 0, a)))\nalt_set = set(map(lambda x: x**3,\n                  filter(lambda x: x % 3 == 0, a)))\n\nassert even_squares_dict == alt_dict\nassert threes_cubed_set == alt_set`, `90288243726061110000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span>\neven_squares_dict <span class="token operator">=</span> <span class="token punctuation">{</span>x<span class="token punctuation">:</span> x<span class="token operator">**</span><span class="token number">2</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> a <span class="token keyword">if</span> x <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">}</span>\nthrees_cubed_set <span class="token operator">=</span> <span class="token punctuation">{</span>x<span class="token operator">**</span><span class="token number">3</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> a <span class="token keyword">if</span> x <span class="token operator">%</span> <span class="token number">3</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">}</span>\n\nalt_dict <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span> x<span class="token operator">**</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n                    <span class="token builtin">filter</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\nalt_set <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token operator">**</span><span class="token number">3</span><span class="token punctuation">,</span>\n                  <span class="token builtin">filter</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x <span class="token operator">%</span> <span class="token number">3</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token keyword">assert</span> even_squares_dict <span class="token operator">==</span> alt_dict\n<span class="token keyword">assert</span> threes_cubed_set <span class="token operator">==</span> alt_set</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="总结-23"><a href="#%E6%80%BB%E7%BB%93-23" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>列表推导要比内置的 map 与 filter 函数清晰，因为它不用另外定义 lambda 表达式。</li>\n<li>列表推导可以很容易地跳过原列表中的某些数据，假如改用 map 实现，那么必须搭配 filter 才能实现。</li>\n<li>字典与集合也可以通过推导来创建。</li>\n</ol>\n<h2 id="第-28-条：控制推导逻辑的子表达式不要超过两个"><a href="#%E7%AC%AC-28-%E6%9D%A1%EF%BC%9A%E6%8E%A7%E5%88%B6%E6%8E%A8%E5%AF%BC%E9%80%BB%E8%BE%91%E7%9A%84%E5%AD%90%E8%A1%A8%E8%BE%BE%E5%BC%8F%E4%B8%8D%E8%A6%81%E8%B6%85%E8%BF%87%E4%B8%A4%E4%B8%AA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 28 条：控制推导逻辑的子表达式不要超过两个</h2>\n<p>除了最基本的用法（参见第 27 条）外，列表推导还支持多层循环。例如，要把矩阵（一种二维列表，它的每个元素本身也是列表）转化成普通的一维列表，那么可以在推导时，使用两条 for 子表达式。这些子表达式会按照从左到右的顺序解读。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="84431127595181280000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`matrix = [[1, 2, 3], [4, 5, 6], [7, 8, 9]]\nflat = [x for row in matrix for x in row]\nprint(flat)\n\n>>>\n[1, 2, 3, 4, 5, 6, 7, 8, 9]`, `84431127595181280000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">matrix <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">]</span>\nflat <span class="token operator">=</span> <span class="token punctuation">[</span>x <span class="token keyword">for</span> row <span class="token keyword">in</span> matrix <span class="token keyword">for</span> x <span class="token keyword">in</span> row<span class="token punctuation">]</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>flat<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样写简单易懂，这也正是多层循环在列表推导之中的合理用法。多层循环还可以用来重制那种两层深的结构。例如，如果要根据二维矩阵里每个元素的平方值构建一个新的二维矩阵，那么可以采用下面这种写法。这看上去有点儿复杂，因为它把小的推导逻辑 <code class="language-text">[x**2 for x in row]</code> 嵌到了大的推导逻辑里面，不过，这行语句总体上不难理解。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="85253942650211780000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`matrix = [[1, 2, 3], [4, 5, 6], [7, 8, 9]]\nsquared = [[x**2 for x in row] for row in matrix]\nprint(squared)\n\n>>>\n[[1, 4, 9], [16, 25, 36], [49, 64, 81]]`, `85253942650211780000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">matrix <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">]</span>\nsquared <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>x<span class="token operator">**</span><span class="token number">2</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> row<span class="token punctuation">]</span> <span class="token keyword">for</span> row <span class="token keyword">in</span> matrix<span class="token punctuation">]</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>squared<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">,</span> <span class="token number">36</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">49</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">81</span><span class="token punctuation">]</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果推导过程中还要再加一层循环，那么语句就会变得很长，必须把它分成多行来写，例如下面是把一个三维矩阵转化成普通一维列表的代码。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="71968755112182750000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`my_lists = [\n    [[1, 2, 3], [4, 5, 6]]\n]\nflat = [x for sublist1 in my_lists\n        for sublist2 in sublist1\n        for x in sublist2]\nprint(flat)\n\n>>>\n[1, 2, 3, 4, 5, 6]`, `71968755112182750000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">my_lists <span class="token operator">=</span> <span class="token punctuation">[</span>\n    <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">]</span>\n<span class="token punctuation">]</span>\nflat <span class="token operator">=</span> <span class="token punctuation">[</span>x <span class="token keyword">for</span> sublist1 <span class="token keyword">in</span> my_lists\n        <span class="token keyword">for</span> sublist2 <span class="token keyword">in</span> sublist1\n        <span class="token keyword">for</span> x <span class="token keyword">in</span> sublist2<span class="token punctuation">]</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>flat<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在这种情况下，采用列表推导来实现，其实并不会比传统的 for 循环节省多少代码。下面用常见的 for 循环改写刚才的例子。这次我们通过级别不同的缩进表示每一层循环的深度，这要比刚才那种三层矩阵的列表推导更加清晰。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="72509081644690030000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`my_lists = [\n    [[1, 2, 3], [4, 5, 6]]\n]\nflat = []\nfor sublistl in my_lists:\n    for sublist2 in sublistl:\n        flat.extend(sublist2)`, `72509081644690030000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">my_lists <span class="token operator">=</span> <span class="token punctuation">[</span>\n    <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">]</span>\n<span class="token punctuation">]</span>\nflat <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n<span class="token keyword">for</span> sublistl <span class="token keyword">in</span> my_lists<span class="token punctuation">:</span>\n    <span class="token keyword">for</span> sublist2 <span class="token keyword">in</span> sublistl<span class="token punctuation">:</span>\n        flat<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>sublist2<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>推导的时候，可以使用多个 if 条件。如果这些 if 条件出现在同一层循环内，那么它们之间默认是 and 关系，也就是必须同时成立。例如，如果要用原列表中大于 4 且是偶数的值来构建新列表，那么既可以连用两个 if，也可以只用一个 if，下面两种写法效果相同。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="39799346328428140000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`a = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]\nb = [x for x in a if x > 4 if x % 2 == 0]\nc = [x for x in a if x > 4 and x % 2 == 0]`, `39799346328428140000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span>\nb <span class="token operator">=</span> <span class="token punctuation">[</span>x <span class="token keyword">for</span> x <span class="token keyword">in</span> a <span class="token keyword">if</span> x <span class="token operator">></span> <span class="token number">4</span> <span class="token keyword">if</span> x <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">]</span>\nc <span class="token operator">=</span> <span class="token punctuation">[</span>x <span class="token keyword">for</span> x <span class="token keyword">in</span> a <span class="token keyword">if</span> x <span class="token operator">></span> <span class="token number">4</span> <span class="token keyword">and</span> x <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>在推导时，每一层的 for 子表达式都可以带有 if 条件。例如，要根据原矩阵构建新的矩阵，把其中各元素之和大于等于 10 的那些行选出来，而且只保留其中能够被 3 整除的那些元素。这个逻辑用列表推导来写，并不需要太多的代码，但是这些代码理解起来会很困难。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="94799271164166030000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`matrix = [[1, 2, 3], [4, 5, 6], [7, 8, 9]]\nfiltered = [[x for x in row if x % 3 == 0]\n            for row in matrix if sum(row) >= 10]\nprint(filtered)\n\n>>>\n[[6], [9]]`, `94799271164166030000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">matrix <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">]</span>\nfiltered <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>x <span class="token keyword">for</span> x <span class="token keyword">in</span> row <span class="token keyword">if</span> x <span class="token operator">%</span> <span class="token number">3</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">]</span>\n            <span class="token keyword">for</span> row <span class="token keyword">in</span> matrix <span class="token keyword">if</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>row<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">10</span><span class="token punctuation">]</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>filtered<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>虽然这个例子是笔者专门构造出来的，但在实际中，我们确实会碰到很多类似的需求。有人可能觉得，这些需求应该通过推导来实现。然而，笔者强烈建议大家不要用刚才的写法来推导新的 list、dict 或 set，因为这样写出来的代码很难让初次阅读这段程序的人看懂。对于 dict 来说，问题尤其严重，因为必须得把键与值的推导逻辑都表达出来才行。</p>\n<p>总之，在表示推导逻辑时，最多只应该写两个子表达式（例如两个 if 条件、两个 for 循环，或者一个 if 条件与一个 for 循环）。只要实现的逻辑比这还复杂，那就应该采用普通的 if 与 for 语句来实现，并且可以考虑编写辅助函数（参见第 30 条）。</p>\n<h3 id="总结-24"><a href="#%E6%80%BB%E7%BB%93-24" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>推导的时候可以使用多层循环，每层循环可以带有多个条件。</li>\n<li>控制推导逻辑的子表达式不要超过两个，否则代码很难读懂。</li>\n</ol>\n<h2 id="第-29-条：用赋值表达式消除推导中的重复代码"><a href="#%E7%AC%AC-29-%E6%9D%A1%EF%BC%9A%E7%94%A8%E8%B5%8B%E5%80%BC%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B6%88%E9%99%A4%E6%8E%A8%E5%AF%BC%E4%B8%AD%E7%9A%84%E9%87%8D%E5%A4%8D%E4%BB%A3%E7%A0%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 29 条：用赋值表达式消除推导中的重复代码</h2>\n<p>推导 list、dict 与 set 等变体结构时，经常要在多个地方用到同一个计算结果。例如，我们要给制作紧固件的公司编写程序以管理订单。顾客下单后，我们要判断当前的库存能否满足这份订单，也就是说，要核查每种产品的数量有没有达到可以发货的最低限制（8 个为一批，至少要有一批，才能发货）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="12866313162679920000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`stock = {\n    \'nails\': 125,\n    \'screws\': 35,\n    \'wingnuts\': 8,\n    \'washers\': 24,\n}\norder = [\'screws\', \'wingnuts\', \'clips\']\n\n\ndef get_batches(count, size):\n    return count // size\n\n\nresult = {}\nfor name in order:\n    count = stock.get(name, 0)\n    batches = get_batches(count, 8)\n    if batches:\n        result[name] = batches\n\nprint(result)\n\n>>>\n{\'screws\': 4, \'wingnuts\': 1}`, `12866313162679920000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">stock <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token string">\'nails\'</span><span class="token punctuation">:</span> <span class="token number">125</span><span class="token punctuation">,</span>\n    <span class="token string">\'screws\'</span><span class="token punctuation">:</span> <span class="token number">35</span><span class="token punctuation">,</span>\n    <span class="token string">\'wingnuts\'</span><span class="token punctuation">:</span> <span class="token number">8</span><span class="token punctuation">,</span>\n    <span class="token string">\'washers\'</span><span class="token punctuation">:</span> <span class="token number">24</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\norder <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'screws\'</span><span class="token punctuation">,</span> <span class="token string">\'wingnuts\'</span><span class="token punctuation">,</span> <span class="token string">\'clips\'</span><span class="token punctuation">]</span>\n\n\n<span class="token keyword">def</span> <span class="token function">get_batches</span><span class="token punctuation">(</span>count<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">return</span> count <span class="token operator">//</span> size\n\n\nresult <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n<span class="token keyword">for</span> name <span class="token keyword">in</span> order<span class="token punctuation">:</span>\n    count <span class="token operator">=</span> stock<span class="token punctuation">.</span>get<span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>\n    batches <span class="token operator">=</span> get_batches<span class="token punctuation">(</span>count<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span>\n    <span class="token keyword">if</span> batches<span class="token punctuation">:</span>\n        result<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> batches\n\n<span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">{</span><span class="token string">\'screws\'</span><span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">\'wingnuts\'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这段循环逻辑，如果改用字典推导来写，会简单一些（参见第 27 条）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="96216323505800630000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`found = {name: get_batches(stock.get(name, 0), 8)\n         for name in order\n         if get_batches(stock.get(name, 0), 8)}\nprint(found)`, `96216323505800630000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">found <span class="token operator">=</span> <span class="token punctuation">{</span>name<span class="token punctuation">:</span> get_batches<span class="token punctuation">(</span>stock<span class="token punctuation">.</span>get<span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span>\n         <span class="token keyword">for</span> name <span class="token keyword">in</span> order\n         <span class="token keyword">if</span> get_batches<span class="token punctuation">(</span>stock<span class="token punctuation">.</span>get<span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">}</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>found<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样写虽然比刚才简短，但问题是，它把 <code class="language-text">get_batches(stock.get(name, 0), 8)</code> 写了两遍。这样会让代码看起来比较乱，而且实际上，程序也没有必要把这个结果计算两遍。另外，如果这两个地方忘了同步更新，那么程序就会出现 bug。例如，我们决定每一批不是 8 个，而是 4 个，那么需要把 <code class="language-text">get_batches</code> 的第二个参数从 8 改成 4，但是，万一我们忘了同步修改另一个地方，那么代码就可能会出问题（它会把大于等于 4 但是小于 8 的情况给漏掉）。</p>\n<p>有个简单的办法可以解决这个问题，那就是在推导的过程中使用 Python 3.8 新引入的 <code class="language-text">:=</code> 操作符进行赋值表达（参见第 10 条）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="45679371032580180000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`found = {name: batches for name in order\n         if (batches := get_batches(stock.get(name, 0), 8))}`, `45679371032580180000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">found <span class="token operator">=</span> <span class="token punctuation">{</span>name<span class="token punctuation">:</span> batches <span class="token keyword">for</span> name <span class="token keyword">in</span> order\n         <span class="token keyword">if</span> <span class="token punctuation">(</span>batches <span class="token punctuation">:</span><span class="token operator">=</span> get_batches<span class="token punctuation">(</span>stock<span class="token punctuation">.</span>get<span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>这条 <code class="language-text">batches := get_batches(...)</code> 赋值表达式，能够从 stock 字典里查到对应产品一共有几批，并把这个批数放在 batches 变量里。这样的话，我们推导这个产品所对应批数时，就不用再通过 <code class="language-text">get_batches</code> 计算了，因为结果已经保存到 batches 里面了。这种写法只需要把 get 与 <code class="language-text">get_batches</code> 调用一次即可，这样能够提升效率，因为我们不需要针对 order 列表中的每件产品都多做一次 get 与 <code class="language-text">get_batches</code>。</p>\n<p>在推导过程中，描述新值的那一部分也可以出现赋值表达式。但如果在其他部分引用了定义在那一部分的变量，那么程序可能就会在运行时出错。例如，如果写成了下面这样，那么程序就必须先考虑 <code class="language-text">for name, count in stock.items() if tenth &gt; 0</code>，而这个时候，其中的 tenth 还没有得到定义。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="43748533098726730000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`result = {name: (tenth := count // 10)\n          for name, count in stock.items() if tenth > 0}\nprint(result)\n\n>>>\nTraceback ...\nNameError: name \'tenth\' is not defined`, `43748533098726730000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">result <span class="token operator">=</span> <span class="token punctuation">{</span>name<span class="token punctuation">:</span> <span class="token punctuation">(</span>tenth <span class="token punctuation">:</span><span class="token operator">=</span> count <span class="token operator">//</span> <span class="token number">10</span><span class="token punctuation">)</span>\n          <span class="token keyword">for</span> name<span class="token punctuation">,</span> count <span class="token keyword">in</span> stock<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> tenth <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">}</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nNameError<span class="token punctuation">:</span> name <span class="token string">\'tenth\'</span> <span class="token keyword">is</span> <span class="token keyword">not</span> defined</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>为了解决这个问题，可以把赋值表达式移动到 if 条件里面，然后在描述新值的这一部分引用已经定义过的 tenth 变量。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="73029592553746640000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`result = {name: tenth for name, count in stock.items()\n          if (tenth := count // 10) > 0}\nprint(result)\n\n>>>\n{\'nails\': 12, \'screws\': 3, \'washers\': 2}`, `73029592553746640000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">result <span class="token operator">=</span> <span class="token punctuation">{</span>name<span class="token punctuation">:</span> tenth <span class="token keyword">for</span> name<span class="token punctuation">,</span> count <span class="token keyword">in</span> stock<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span>\n          <span class="token keyword">if</span> <span class="token punctuation">(</span>tenth <span class="token punctuation">:</span><span class="token operator">=</span> count <span class="token operator">//</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">}</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">{</span><span class="token string">\'nails\'</span><span class="token punctuation">:</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token string">\'screws\'</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">\'washers\'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果推导逻辑不带条件，而表示新值的那一部分又使用了 <code class="language-text">:=</code> 操作符，那么操作符左边的变量就会泄漏到包含这条推导语句的那个作用域里（参见第 21 条）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="31030786419017777000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`half = [(last := count // 2) for count in stock.values()]\nprint(f\'Last item of {half} is {last}\')\n\n>>>\nLast item of [62, 17, 4, 12] is 12`, `31030786419017777000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">half <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span>last <span class="token punctuation">:</span><span class="token operator">=</span> count <span class="token operator">//</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">for</span> count <span class="token keyword">in</span> stock<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Last item of </span><span class="token interpolation"><span class="token punctuation">{</span>half<span class="token punctuation">}</span></span><span class="token string"> is </span><span class="token interpolation"><span class="token punctuation">{</span>last<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nLast item of <span class="token punctuation">[</span><span class="token number">62</span><span class="token punctuation">,</span> <span class="token number">17</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">]</span> <span class="token keyword">is</span> <span class="token number">12</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这与普通的 for 循环所用的那个循环变量类似</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="60317246440552320000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`for count in stock.values():  # Leaks loop variable\n    pass\nprint(f\'Last item of {list(stock.values())} is {count}\')\n\n>>>\nLast item of [125, 35, 8, 24] is 24`, `60317246440552320000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">for</span> count <span class="token keyword">in</span> stock<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># Leaks loop variable</span>\n    <span class="token keyword">pass</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Last item of </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">list</span><span class="token punctuation">(</span>stock<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> is </span><span class="token interpolation"><span class="token punctuation">{</span>count<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nLast item of <span class="token punctuation">[</span><span class="token number">125</span><span class="token punctuation">,</span> <span class="token number">35</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">]</span> <span class="token keyword">is</span> <span class="token number">24</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然而，推导语句中的 for 循环所使用的循环变量，是不会像刚才那样泄漏到外面的。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="83055644820577390000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`half = [count // 2 for count in stock.values()]\nprint(half)\n# Works\nprint(count)  # Exception because loop variable didn\'t leak\n\n>>>\n[62, 17, 4, 12]\nTraceback ...\nNameError: name \'count\' is not defined`, `83055644820577390000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">half <span class="token operator">=</span> <span class="token punctuation">[</span>count <span class="token operator">//</span> <span class="token number">2</span> <span class="token keyword">for</span> count <span class="token keyword">in</span> stock<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>half<span class="token punctuation">)</span>\n<span class="token comment"># Works</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span>  <span class="token comment"># Exception because loop variable didn\'t leak</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">[</span><span class="token number">62</span><span class="token punctuation">,</span> <span class="token number">17</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">]</span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nNameError<span class="token punctuation">:</span> name <span class="token string">\'count\'</span> <span class="token keyword">is</span> <span class="token keyword">not</span> defined</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>最好不要泄漏循环变量，所以，建议赋值表达式只出现在推导逻辑的条件之中。</p>\n<p>赋值表达式不仅可以用在推导过程中，而且可以用来编写生成器表达式（generator expression，参见第 32 条）。下面这种写法创建的是迭代器，而不是字典实例，该迭代器每次会给出一对数值，其中第一个元素为产品的名字，第二个元素为这种产品的库存。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="42233450364751350000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`found = ((name, batches) for name in order\n         if (batches := get_batches(stock.get(name, 0), 8)))\nprint(next(found))\nprint(next(found))\n\n>>>\n(\'screws\', 4)\n(\'wingnuts\', 1)`, `42233450364751350000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">found <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> batches<span class="token punctuation">)</span> <span class="token keyword">for</span> name <span class="token keyword">in</span> order\n         <span class="token keyword">if</span> <span class="token punctuation">(</span>batches <span class="token punctuation">:</span><span class="token operator">=</span> get_batches<span class="token punctuation">(</span>stock<span class="token punctuation">.</span>get<span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">next</span><span class="token punctuation">(</span>found<span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">next</span><span class="token punctuation">(</span>found<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">(</span><span class="token string">\'screws\'</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>\n<span class="token punctuation">(</span><span class="token string">\'wingnuts\'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="总结-25"><a href="#%E6%80%BB%E7%BB%93-25" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>编写推导式与生成器表达式时，可以在描述条件的那一部分通过赋值表达式定义变量，并在其他部分复用该变量，可使程序简单易读。</li>\n<li>对于推导式与生成器表达式来说，虽然赋值表达式也可以出现在描述条件的那一部分之外，但最好别这么写。</li>\n</ol>\n<h2 id="第-30-条：不要让函数直接返回列表，应该让它逐个生成列表里的值"><a href="#%E7%AC%AC-30-%E6%9D%A1%EF%BC%9A%E4%B8%8D%E8%A6%81%E8%AE%A9%E5%87%BD%E6%95%B0%E7%9B%B4%E6%8E%A5%E8%BF%94%E5%9B%9E%E5%88%97%E8%A1%A8%EF%BC%8C%E5%BA%94%E8%AF%A5%E8%AE%A9%E5%AE%83%E9%80%90%E4%B8%AA%E7%94%9F%E6%88%90%E5%88%97%E8%A1%A8%E9%87%8C%E7%9A%84%E5%80%BC" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 30 条：不要让函数直接返回列表，应该让它逐个生成列表里的值</h2>\n<p>如果函数要返回的是个包含许多结果的序列，那么最简单的办法就是把这些结果放到列表中。例如，我们要返回字符串里每个单词的首字母所对应的下标。下面这种写法，会把每次遇到的新单词所在的位置追加（append）到存放结果的 result 列表中，在函数末尾返回这份列表。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="83374437671799210000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def index_words(text):\n    result = []\n    if text:\n        result.append(0)\n    for index, letter in enumerate(text):\n        if letter == \' \':\n            result.append(index + 1)\n    return result`, `83374437671799210000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">index_words</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n    <span class="token keyword">if</span> text<span class="token punctuation">:</span>\n        result<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>\n    <span class="token keyword">for</span> index<span class="token punctuation">,</span> letter <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> letter <span class="token operator">==</span> <span class="token string">\' \'</span><span class="token punctuation">:</span>\n            result<span class="token punctuation">.</span>append<span class="token punctuation">(</span>index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>\n    <span class="token keyword">return</span> result</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们把一段范例文本传给这个函数，它可以返回正确的结果。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="43106675568837210000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`address = \'Four score and seven years ago...\'\nresult = index_words(address)\nprint(result)\n\n>>>\n[0, 5, 11, 15, 21, 27]`, `43106675568837210000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">address <span class="token operator">=</span> <span class="token string">\'Four score and seven years ago...\'</span>\nresult <span class="token operator">=</span> index_words<span class="token punctuation">(</span>address<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">,</span> <span class="token number">27</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>index_words 函数有两个缺点。</p>\n<ol>\n<li>\n<p>它的代码看起来有点杂乱。每找到一个新单词，它都要调用 append 方法，而调用这个方法时，必须写上 result.append 这样一串字符，这就把我们想要强调的重点，也就是这个新单词在字符串中的位置（index + 1）淡化了。另外，函数还必须专门用一行代码创建这个保存结果的 result 列表，并且要用一条 return 语句把它返回给调用者。这样算下来，虽然函数的主体部分大约有 130 个字符（非空白的），但真正重要的只有 75 个左右。</p>\n<p>这种函数改用生成器（generator）来实现会比较好。生成器由包含 yield 表达式的函数创建。下面就定义一个生成器函数，实现与刚才那个函数相同的效果。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="57049428301114950000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def index_words_iter(text):\n  if text:\n     yield 0\n  for index, letter in enumerate(text):\n     if letter == \' \':\n           yield index + 1\n\naddress = \'Four score and seven years ago...\'\nresult = index_words_iter(address)\nprint(list(result))`, `57049428301114950000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">index_words_iter</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">:</span>\n  <span class="token keyword">if</span> text<span class="token punctuation">:</span>\n     <span class="token keyword">yield</span> <span class="token number">0</span>\n  <span class="token keyword">for</span> index<span class="token punctuation">,</span> letter <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">:</span>\n     <span class="token keyword">if</span> letter <span class="token operator">==</span> <span class="token string">\' \'</span><span class="token punctuation">:</span>\n           <span class="token keyword">yield</span> index <span class="token operator">+</span> <span class="token number">1</span>\n\naddress <span class="token operator">=</span> <span class="token string">\'Four score and seven years ago...\'</span>\nresult <span class="token operator">=</span> index_words_iter<span class="token punctuation">(</span>address<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n<li>\n<p>它必须把所有的结果都保存到列表中，然后才能返回列表。如果输入的数据特别多，那么程序可能会因为耗尽内存而崩溃。</p>\n<p>相反，用生成器函数来实现，就不会有这个问题了。它可以接受长度任意的输入信息，并把内存消耗量压得比较低。例如下面这个生成器，只需要把当前这行文字从文件中读进来就行，每次推进的时候，它都只处理一个单词，直到把当前这行文字处理完毕，才读入下一行文字。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="71068520088476615000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import itertools\n\ndef index_file(handle):\n  offset = 0\n  for line in handle:\n     if line:\n           yield offset\n     for letter in line:\n           offset += 1\n           if letter == \' \':\n              yield offset\n\nwith open(\'address.txt\', \'r\') as f:\n  it = index_file(f)\n  results = itertools.islice(it, 0, 10)\n  print(list(results))`, `71068520088476615000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> itertools\n\n<span class="token keyword">def</span> <span class="token function">index_file</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">:</span>\n  offset <span class="token operator">=</span> <span class="token number">0</span>\n  <span class="token keyword">for</span> line <span class="token keyword">in</span> handle<span class="token punctuation">:</span>\n     <span class="token keyword">if</span> line<span class="token punctuation">:</span>\n           <span class="token keyword">yield</span> offset\n     <span class="token keyword">for</span> letter <span class="token keyword">in</span> line<span class="token punctuation">:</span>\n           offset <span class="token operator">+=</span> <span class="token number">1</span>\n           <span class="token keyword">if</span> letter <span class="token operator">==</span> <span class="token string">\' \'</span><span class="token punctuation">:</span>\n              <span class="token keyword">yield</span> offset\n\n<span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'address.txt\'</span><span class="token punctuation">,</span> <span class="token string">\'r\'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>\n  it <span class="token operator">=</span> index_file<span class="token punctuation">(</span>f<span class="token punctuation">)</span>\n  results <span class="token operator">=</span> itertools<span class="token punctuation">.</span>islice<span class="token punctuation">(</span>it<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>\n  <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>该函数运行时所耗的内存，取决于文件中最长的那一行所包含的字符数。把刚才那份输入数据存放到 address.txt 文件，让这个函数去读取并用它所返回的生成器构建一份列表，可以看到跟原来相同的结果（islice 函数的详细用法，参见第 36 条）。</p>\n<p>定义这种生成器函数的时候，只有一个地方需要注意，就是调用者无法重复使用函数所返回的迭代器，因为这些迭代器是有状态的（参见第 31 条）。</p>\n</li>\n</ol>\n<h3 id="总结-26"><a href="#%E6%80%BB%E7%BB%93-26" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>用生成器来实现比让函数把结果收集合到列表里再返回，要更加清晰一些。</li>\n<li>生成器函数所返回的迭代器可以产生一系列值，每次产生的那个值都是由函数体的下一条 yield 表达式所决定的。</li>\n<li>不管输入的数据量有多大，生成器函数每次都只需要根据其中的一小部分来计算当前这次的输出值。它不用把整个输入值全都读取进来，也不用一次就把所有的输出值全都算好。</li>\n</ol>\n<h2 id="第-31-条：谨慎地迭代函数所收到的参数"><a href="#%E7%AC%AC-31-%E6%9D%A1%EF%BC%9A%E8%B0%A8%E6%85%8E%E5%9C%B0%E8%BF%AD%E4%BB%A3%E5%87%BD%E6%95%B0%E6%89%80%E6%94%B6%E5%88%B0%E7%9A%84%E5%8F%82%E6%95%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 31 条：谨慎地迭代函数所收到的参数</h2>\n<p>如果函数接受的参数是个包含许多对象的列表，那么这份列表有可能要迭代多次。例如，我们要分析美国得克萨斯州的游客数量。原始数据保存在一份列表中，其中的每个元素表示每年有多少游客到这个城市旅游（单位是百万）。我们现在要统计每个城市的游客数占游客总数的百分比。</p>\n<p>为了求出这份数据，先把列表里的所有元素加起来求出游客总数，然后，分别用每个城市的游客数除以游客总数计算出该城市在总数据中所占的百分比。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="70993883439105130000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def normalize(numbers):\n    total = sum(numbers)\n    result = []\n    for value in numbers:\n        percent = 100 * value / total\n        result.append(percent)\n    return result`, `70993883439105130000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">normalize</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    total <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span>\n    result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n    <span class="token keyword">for</span> value <span class="token keyword">in</span> numbers<span class="token punctuation">:</span>\n        percent <span class="token operator">=</span> <span class="token number">100</span> <span class="token operator">*</span> value <span class="token operator">/</span> total\n        result<span class="token punctuation">.</span>append<span class="token punctuation">(</span>percent<span class="token punctuation">)</span>\n    <span class="token keyword">return</span> result</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>把一份范例数据放到列表中传给这个函数，可以得到正确的结果。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="95156597626123270000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def normalize(numbers):\n    total = sum(numbers)\n    result = []\n    for value in numbers:\n        percent = 100 * value / total\n        result.append(percent)\n    return result\n\n\nvisits = [15, 35, 80]\npercentages = normalize(visits)\nprint(percentages)\nassert sum(percentages) == 100.0\n\n>>>\n[11.538461538461538, 26.923076923076923, 61.53846153846154]`, `95156597626123270000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">normalize</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    total <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span>\n    result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n    <span class="token keyword">for</span> value <span class="token keyword">in</span> numbers<span class="token punctuation">:</span>\n        percent <span class="token operator">=</span> <span class="token number">100</span> <span class="token operator">*</span> value <span class="token operator">/</span> total\n        result<span class="token punctuation">.</span>append<span class="token punctuation">(</span>percent<span class="token punctuation">)</span>\n    <span class="token keyword">return</span> result\n\n\nvisits <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">35</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">]</span>\npercentages <span class="token operator">=</span> normalize<span class="token punctuation">(</span>visits<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>percentages<span class="token punctuation">)</span>\n<span class="token keyword">assert</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>percentages<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">100.0</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">[</span><span class="token number">11.538461538461538</span><span class="token punctuation">,</span> <span class="token number">26.923076923076923</span><span class="token punctuation">,</span> <span class="token number">61.53846153846154</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>为了应对规模更大的数据，我们现在需要让程序能够从文件中读取信息，并假设得克萨斯州所有城市的游客数都放在这份文件中。笔者决定用生成器实现，因为这样做可以让我们把同样的功能套用在其他数据上面，例如分析全世界（而不仅仅是得克萨斯一州）各城市的游客数。那些场合的数据量与内存用量可能会比现在大得多（参见第 30 条）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="59771697807747424000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def read_visits(data_path):\n    with open(data_path)as f:\n        for line in f:\n            yield int(line)`, `59771697807747424000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">read_visits</span><span class="token punctuation">(</span>data_path<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>data_path<span class="token punctuation">)</span><span class="token keyword">as</span> f<span class="token punctuation">:</span>\n        <span class="token keyword">for</span> line <span class="token keyword">in</span> f<span class="token punctuation">:</span>\n            <span class="token keyword">yield</span> <span class="token builtin">int</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>奇怪的是，对 <code class="language-text">read_visits</code> 所返回的迭代器调用 normalize 函数后，并没有得到结果。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="28473766136044220000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`it = read_visits(\'my_numbers.txt\')\npercentages = normalize(it)\nprint(percentages)\n\n>>>\n[]`, `28473766136044220000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">it <span class="token operator">=</span> read_visits<span class="token punctuation">(</span><span class="token string">\'my_numbers.txt\'</span><span class="token punctuation">)</span>\npercentages <span class="token operator">=</span> normalize<span class="token punctuation">(</span>it<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>percentages<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">[</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>出现这种状况的原因在于，迭代器只能产生一次结果。假如迭代器或生成器已经抛出过 StopIteration 异常，继续用它来构造列表或是像 normalize 那样对它做 for 循环，那它不会给出任何结果。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="32062389056389296000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`it = read_visits(\'my_numbers.txt\')\nprint(list(it))\nprint(list(it))  # Already exhausted\n\n>>>\n[15, 35, 80]\n[]`, `32062389056389296000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">it <span class="token operator">=</span> read_visits<span class="token punctuation">(</span><span class="token string">\'my_numbers.txt\'</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># Already exhausted</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">35</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">]</span>\n<span class="token punctuation">[</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>还有个因素也很令人迷惑，那就是：在已经把数据耗完的迭代器上面继续迭代，程序居然不报错。for 循环、list 构造器以及 Python 标准库的其他许多函数，都认为迭代器在正常的操作过程中抛出 StopIteration 异常是很自然的。它们没办法区分，这个迭代器是本身就没有数据可以提供，还是虽然有数据，但现在已经耗尽了。</p>\n<p>为了解决这个问题，我们可以把外界传入的迭代器特意遍历一整轮，从而将其中的内容复制到一份列表里。这样的话，以后就可以用这份列表来处理数据了，那时想迭代多少遍都可以。下面的函数与原来的 normalize 函数功能相同，但是它会把收到的那个 numbers 迭代器所能提供的数据明确地复制到 <code class="language-text">numbers_copy</code> 列表里。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="89846347594840590000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def normalize_copy(numbers):\n    numbers_copy = list(numbers)  # Copy the iterator\n    total = sum(numbers_copy)\n    result = []\n    for value in numbers_copy:\n        percent = 100 * value / total\n        result.append(percent)\n    return result`, `89846347594840590000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">normalize_copy</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    numbers_copy <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span>  <span class="token comment"># Copy the iterator</span>\n    total <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>numbers_copy<span class="token punctuation">)</span>\n    result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n    <span class="token keyword">for</span> value <span class="token keyword">in</span> numbers_copy<span class="token punctuation">:</span>\n        percent <span class="token operator">=</span> <span class="token number">100</span> <span class="token operator">*</span> value <span class="token operator">/</span> total\n        result<span class="token punctuation">.</span>append<span class="token punctuation">(</span>percent<span class="token punctuation">)</span>\n    <span class="token keyword">return</span> result</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在的这个函数就可以正确处理 <code class="language-text">read_visits</code> 生成器函数所返回的 it 值了。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="51603818883094620000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`it = read_visits(\'my_numbers.txt\')\npercentages = normalize_copy(it)\nprint(percentages)\nassert sum(percentages) == 100.0`, `51603818883094620000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">it <span class="token operator">=</span> read_visits<span class="token punctuation">(</span><span class="token string">\'my_numbers.txt\'</span><span class="token punctuation">)</span>\npercentages <span class="token operator">=</span> normalize_copy<span class="token punctuation">(</span>it<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>percentages<span class="token punctuation">)</span>\n<span class="token keyword">assert</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>percentages<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">100.0</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这个办法虽然能解决问题，但如果输入给它的迭代器所要提供的数据量相当庞大，那么有可能导致程序在复制迭代器时，因耗尽内存而崩溃。所以，把这个方案用在大规模的数据集合上面，会抵消掉 <code class="language-text">read_visits</code> 的好处。编写那样一个函数，就是不想让程序把整套数据全都读取进来，而是可以一条一条地处理。为了应对大规模的数据，其中一个变通方案是让 normalize 函数接受另外一个函数（也就是下面的 <code class="language-text">get_iter</code>），使它每次要使用迭代器时，都去向那个函数索要。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="44140937314472420000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def normalize_func(get_iter):\n    total = sum(get_iter())  # New iterator\n    result = []\n    for value in get_iter():  # New iterator\n        percent = 100 * value / total\n        result.append(percent)\n    return result`, `44140937314472420000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">normalize_func</span><span class="token punctuation">(</span>get_iter<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    total <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>get_iter<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># New iterator</span>\n    result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n    <span class="token keyword">for</span> value <span class="token keyword">in</span> get_iter<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># New iterator</span>\n        percent <span class="token operator">=</span> <span class="token number">100</span> <span class="token operator">*</span> value <span class="token operator">/</span> total\n        result<span class="token punctuation">.</span>append<span class="token punctuation">(</span>percent<span class="token punctuation">)</span>\n    <span class="token keyword">return</span> result</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>使用 <code class="language-text">normalize_func</code> 函数时，需要传入一条 <code class="language-text">lambda</code> 表达式，让这个表达式去调用 <code class="language-text">read_visits</code> 生成器函数。这样 <code class="language-text">normalize_func</code> 每次向 <code class="language-text">get_iter</code> 索要迭代器时，程序都会给出一个新的迭代器。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="2447949595471454700"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`path = \'my_numbers.txt\'\npercentages = normalize_func(lambda: read_visits(path))\nprint(percentages)\nassert sum(percentages) == 100.0`, `2447949595471454700`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">path <span class="token operator">=</span> <span class="token string">\'my_numbers.txt\'</span>\npercentages <span class="token operator">=</span> normalize_func<span class="token punctuation">(</span><span class="token keyword">lambda</span><span class="token punctuation">:</span> read_visits<span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>percentages<span class="token punctuation">)</span>\n<span class="token keyword">assert</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>percentages<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">100.0</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样做虽然可行，但传入这么一个 lambda 表达式显得有点儿生硬。要想用更好的办法解决这个问题，可以新建一种容器类，让它实现迭代器协议（iterator protocol）。</p>\n<p>Python 的 for 循环及相关的表达式，正是按照迭代器协议来遍历容器内容的。Python 执行 <code class="language-text">for x in foo</code> 这样的语句时，实际上会调用 iter(foo)，也就是把 foo 传给内置的 iter 函数。这个函数会触发名为 <code class="language-text">foo.__iter__</code> 的特殊方法，该方法必须返回迭代器对象（这个迭代器对象本身要实现 <code class="language-text">__next__</code> 特殊方法）。最后，Python 会用迭代器对象反复调用内置的 next 函数，直到数据耗尽为止（如果抛出 StopIteration 异常，就表示数据已经迭代完了）。</p>\n<p>这个过程听上去比较复杂，但总结起来，其实只需要让你的类在实现 <code class="language-text">__iter__</code> 方法时，按照生成器的方式来写就好。下面定义这样一种可迭代的容器类，用来读取文件中的游客数据。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="34016594451278737000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class ReadVisits:\n    def __init__(self, data_path):\n        self.data_path = data_path\n\n    def __iter__(self):\n        with open(self.data_path) as f:\n            for line in f:\n                yield int(line)`, `34016594451278737000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">ReadVisits</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> data_path<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>data_path <span class="token operator">=</span> data_path\n\n    <span class="token keyword">def</span> <span class="token function">__iter__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>data_path<span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>\n            <span class="token keyword">for</span> line <span class="token keyword">in</span> f<span class="token punctuation">:</span>\n                <span class="token keyword">yield</span> <span class="token builtin">int</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们只需要把新的容器传给最早的那个 normalize 函数运行即可，函数本身的代码不需要修改。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="62358062614326395000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def normalize(numbers):\n    total = sum(numbers)\n    result = []\n    for value in numbers:\n        percent = 100 * value / total\n        result.append(percent)\n    return result\n\n\nclass ReadVisits:\n    def __init__(self, data_path):\n        self.data_path = data_path\n\n    def __iter__(self):\n        with open(self.data_path) as f:\n            for line in f:\n                yield int(line)\n\n\npath = \'my_numbers.txt\'\nvisits = ReadVisits(path)\npercentages = normalize(visits)\nprint(percentages)\nassert sum(percentages) == 100.0`, `62358062614326395000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">normalize</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    total <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span>\n    result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n    <span class="token keyword">for</span> value <span class="token keyword">in</span> numbers<span class="token punctuation">:</span>\n        percent <span class="token operator">=</span> <span class="token number">100</span> <span class="token operator">*</span> value <span class="token operator">/</span> total\n        result<span class="token punctuation">.</span>append<span class="token punctuation">(</span>percent<span class="token punctuation">)</span>\n    <span class="token keyword">return</span> result\n\n\n<span class="token keyword">class</span> <span class="token class-name">ReadVisits</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> data_path<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>data_path <span class="token operator">=</span> data_path\n\n    <span class="token keyword">def</span> <span class="token function">__iter__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>data_path<span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>\n            <span class="token keyword">for</span> line <span class="token keyword">in</span> f<span class="token punctuation">:</span>\n                <span class="token keyword">yield</span> <span class="token builtin">int</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span>\n\n\npath <span class="token operator">=</span> <span class="token string">\'my_numbers.txt\'</span>\nvisits <span class="token operator">=</span> ReadVisits<span class="token punctuation">(</span>path<span class="token punctuation">)</span>\npercentages <span class="token operator">=</span> normalize<span class="token punctuation">(</span>visits<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>percentages<span class="token punctuation">)</span>\n<span class="token keyword">assert</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>percentages<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">100.0</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样做为什么可行呢？因为 normalize 函数里面的 sum 会触发 <code class="language-text">ReadVisits.__iter__</code>，让系统分配一个新的迭代器对象给它。接下来，normalize 通过 for 循环计算每项数据占总值的百分比时，又会触发 <code class="language-text">__iter__</code>，于是系统会分配另一个迭代器对象。这些迭代器各自推进，其中一个迭代器把数据耗尽，并不会影响其他迭代器。所以，在每一个迭代器上面遍历，都可以分别看到一套完整的数据。这种方案的唯一缺点，就是多次读取输入数据。</p>\n<p>明白了 ReadVisits 这种容器的工作原理后，我们就可以在编写函数和方法时先确认一下，收到的应该是像 ReadVisits 这样的容器，而不是普通的迭代器。按照协议，如果将普通的迭代器传给内置的 iter 函数，那么函数会把迭代器本身返回给调用者。反之，如果传来的是容器类型，那么 iter 函数就会返回一个新的迭代器对象。我们可以借助这条规律，判断输入值是不是这种容器。如果不是，就抛出 TypeError 异常，因为我们没办法在那样的值上面重复遍历。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="21700473758237626000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def normalize_defensive(numbers):\n    if iter(numbers) is numbers:  # An iterator -- bad!\n        raise TypeError(\'Must supply a container\')\n    total = sum(numbers)\n    result = []\n    for value in numbers:\n        percent = 100 * value / total\n        result.append(percent)\n    return result`, `21700473758237626000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">normalize_defensive</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">if</span> <span class="token builtin">iter</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span> <span class="token keyword">is</span> numbers<span class="token punctuation">:</span>  <span class="token comment"># An iterator -- bad!</span>\n        <span class="token keyword">raise</span> TypeError<span class="token punctuation">(</span><span class="token string">\'Must supply a container\'</span><span class="token punctuation">)</span>\n    total <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span>\n    result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n    <span class="token keyword">for</span> value <span class="token keyword">in</span> numbers<span class="token punctuation">:</span>\n        percent <span class="token operator">=</span> <span class="token number">100</span> <span class="token operator">*</span> value <span class="token operator">/</span> total\n        result<span class="token punctuation">.</span>append<span class="token punctuation">(</span>percent<span class="token punctuation">)</span>\n    <span class="token keyword">return</span> result</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>还有一种写法也可以检测出这样的问题。collections.abc 内置模块里定义了名为 Iterator 的类，它用在 isinstance 函数中，可以判断自己收到的参数是不是这种实例。如果是，就抛出异常（参见第 43 条）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="94346711122941200000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def normalize_defensive(numbers):\n    if isinstance(numbers, Iterator):  # Another way to check\n        raise TypeError(\'Must supply a container\')\n    total = sum(numbers)\n    result = []\n    for value in numbers:\n        percent = 100 * value / total\n        result.append(percent)\n    return result`, `94346711122941200000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">normalize_defensive</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>numbers<span class="token punctuation">,</span> Iterator<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># Another way to check</span>\n        <span class="token keyword">raise</span> TypeError<span class="token punctuation">(</span><span class="token string">\'Must supply a container\'</span><span class="token punctuation">)</span>\n    total <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span>\n    result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n    <span class="token keyword">for</span> value <span class="token keyword">in</span> numbers<span class="token punctuation">:</span>\n        percent <span class="token operator">=</span> <span class="token number">100</span> <span class="token operator">*</span> value <span class="token operator">/</span> total\n        result<span class="token punctuation">.</span>append<span class="token punctuation">(</span>percent<span class="token punctuation">)</span>\n    <span class="token keyword">return</span> result</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这种自定义容器的方案，最适合于既不想像 <code class="language-text">normalize_copy</code> 函数一样，把迭代器提供的这套数据全部复制一份，同时又要多次遍历这套数据的情况。该方案不仅支持自定义容器，还支持系统自带的列表类型，因为这些全都属于遵循迭代器协议的可迭代容器。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="32868136537473823000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`visits = [15, 35, 80]\npercentages = normalize_defensive(visits)\nassert sum(percentages) == 100.0\n\npath = \'my_numbers.txt\'\nvisits = ReadVisits(path)\npercentages = normalize_defensive(visits)\nassert sum(percentages) == 100.0`, `32868136537473823000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">visits <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">35</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">]</span>\npercentages <span class="token operator">=</span> normalize_defensive<span class="token punctuation">(</span>visits<span class="token punctuation">)</span>\n<span class="token keyword">assert</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>percentages<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">100.0</span>\n\npath <span class="token operator">=</span> <span class="token string">\'my_numbers.txt\'</span>\nvisits <span class="token operator">=</span> ReadVisits<span class="token punctuation">(</span>path<span class="token punctuation">)</span>\npercentages <span class="token operator">=</span> normalize_defensive<span class="token punctuation">(</span>visits<span class="token punctuation">)</span>\n<span class="token keyword">assert</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>percentages<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">100.0</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果输入的是普通迭代器而不是容器，那么 <code class="language-text">normalize_defensive</code> 就会抛出异常。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="48653709352102625000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`visits = [15, 35, 80]\nit = iter(visits)\nnormalize_defensive(it)\n\n>>>\nTraceback ...\nTypeError: Must supply a container`, `48653709352102625000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">visits <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">35</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">]</span>\nit <span class="token operator">=</span> <span class="token builtin">iter</span><span class="token punctuation">(</span>visits<span class="token punctuation">)</span>\nnormalize_defensive<span class="token punctuation">(</span>it<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nTypeError<span class="token punctuation">:</span> Must supply a container</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这种思路也适用于异步的迭代器（示例参见第 61 条）。</p>\n<h3 id="总结-27"><a href="#%E6%80%BB%E7%BB%93-27" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>函数和方法如果要把收到的参数遍历很多遍，那就必须特别小心。因为如果这些参数为迭代器，那么程序可能得不到预期的值，从而出现奇怪的效果。</li>\n<li>Python 的迭代器协议确定了容器与迭代器应该怎样跟内置的 iter 及 next 函数、for 循环及相关的表达式交互。</li>\n<li>要想让自定义的容器类型可以迭代，只需要把 <code class="language-text">__iter__</code> 方法实现为生成器即可。</li>\n<li>可以把值传给 iter 函数，检测它返回的是不是那个值本身。如果是，就说明这是个普通的迭代器，而不是一个可以迭代的容器。另外，也可以用内置的 isinstance 函数判断该值是不是 collections.abc.Iterator 类的实例。</li>\n</ol>\n<h2 id="第-32-条：考虑用生成器表达式改写数据量较大的列表推导"><a href="#%E7%AC%AC-32-%E6%9D%A1%EF%BC%9A%E8%80%83%E8%99%91%E7%94%A8%E7%94%9F%E6%88%90%E5%99%A8%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%94%B9%E5%86%99%E6%95%B0%E6%8D%AE%E9%87%8F%E8%BE%83%E5%A4%A7%E7%9A%84%E5%88%97%E8%A1%A8%E6%8E%A8%E5%AF%BC" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 32 条：考虑用生成器表达式改写数据量较大的列表推导</h2>\n<p>列表推导可以根据输入序列中的每个元素创建一个包含派生元素的新列表（参见第 27 条）。如果输入的数据量比较小，那么这样做没问题，但如果数据量很大，那么程序就有可能因为内存耗尽而崩溃。</p>\n<p>例如，我们要读取一份文件并返回每行的字符数。假如采用列表推导来实现，那需要把文件中的每行文本都载入内存，并统计长度。对于庞大的文件，或者像 network socket 这样无休止的输入来说，这么写恐怕有问题。下面就是采用列表推导写的代码，它只能处理输入数据量比较少的情况。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="21470760296144474000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`value = [len(x) for x in open(\'my_file.txt\')]\nprint(value)`, `21470760296144474000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">value <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token builtin">len</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'my_file.txt\'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>要想处理大规模的数据，可以使用生成器表达式（generator expression）来做，它扩展了列表推导式与生成器机制。程序在对生成器表达式求值时，并不会让它把包含输出结果的那个序列立刻构建出来，而是会把它当成一个迭代器，该迭代器每次可以根据表达式中的逻辑给出一项结果。</p>\n<p>生成器表达式的写法，与列表推导式语法类似，但它是写在一对圆括号内，而不是方括号里面。下面这种写法的效果与刚才一样，但是程序并不会立刻给出全部结果，而是先将生成器表达式表示成一个迭代器返回。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="78088361768550760000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`it = (len(x) for x in open(\'my_file.txt\'))\nprint(it)\n\n>>>\n<generator object <genexpr> at 0x7f13063e03c0>`, `78088361768550760000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">it <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'my_file.txt\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token operator">&lt;</span>generator <span class="token builtin">object</span> <span class="token operator">&lt;</span>genexpr<span class="token operator">></span> at <span class="token number">0x7f13063e03c0</span><span class="token operator">></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>返回的迭代器每次可以推进一步，这时它会根据生成表达式的逻辑计算出下一项输出结果（这项结果可以通过内置的 next 函数取得）。需要多少项结果，就把迭代器推进多少次，这种采用生成器表达式来实现的写法不会消耗太多内存。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="72211038174854170000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`print(next(it))\nprint(next(it))`, `72211038174854170000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">next</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">next</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>生成器表达式还有个强大的特性，就是可以组合起来。例如，可以用刚才那条生成器表达式所形成的 it 迭代器作为输入，编写一条新的生成器表达式。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="18997064125748240000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`it = (len(x) for x in open(\'my_file.txt\'))\nroots = ((x, x ** 0.5) for x in it)\nprint(roots)`, `18997064125748240000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">it <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'my_file.txt\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\nroots <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> x <span class="token operator">**</span> <span class="token number">0.5</span><span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> it<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>roots<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>这条表达式所形成的 roots 迭代器每次推进时，会引发连锁反应：它也推进内部迭代器 it 以判断当前是否还能在 it 上面继续迭代，如果可以，就把 it 所返回的值代入 <code class="language-text">(x, x ** 0.5)</code> 里面求出结果。这种写法使用的内存同样不会太多。</p>\n<p>多个生成器嵌套而成的代码，执行起来还是相当快的。所以，如果要对数据量很大的输入流做一系列处理，那么生成器表达式应该是个很好的选择。唯一需要注意的是，生成器表达式返回的迭代器是有状态的，跑完一整轮之后，就不能继续使用了（参见第 31 条）。</p>\n<h3 id="总结-28"><a href="#%E6%80%BB%E7%BB%93-28" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>通过列表推导来处理大量的输入数据，可能会占用许多内存。</li>\n<li>改用生成器表达式来做，可以避免内存使用量过大的问题，因为这种表达式所形成的迭代器每次只会计算一项结果。</li>\n<li>生成器表达式所形成的迭代器可以当成 for 语句的子表达式出现在另一个生成器表达式里。</li>\n<li>把生成器表达式组合起来使用，能够写出执行速度快且占用内存少的代码。</li>\n</ol>\n<h2 id="第-33-条：通过-yield-from-把多个生成器连起来用"><a href="#%E7%AC%AC-33-%E6%9D%A1%EF%BC%9A%E9%80%9A%E8%BF%87-yield-from-%E6%8A%8A%E5%A4%9A%E4%B8%AA%E7%94%9F%E6%88%90%E5%99%A8%E8%BF%9E%E8%B5%B7%E6%9D%A5%E7%94%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 33 条：通过 yield from 把多个生成器连起来用</h2>\n<p>生成器有很多好处（参见第 30 条），而且能够解决许多常见的问题（参见第 31 条）。生成器的用途特别广，所以许多程序都会频繁使用它们，而且是一个连着一个地用。</p>\n<p>例如，我们要编写一个图形程序，让它在屏幕上面移动图像，从而形成动画效果。假设要实现这样一段动画：图片先快速移动一段时间，然后暂停，接下来慢速移动一段时间。为了把移动与暂停表示出来，笔者定义了下面两个生成器函数，让它们分别给出图片在当前时间段内应该保持的速度。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="57682791494151770000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def move(period, speed):\n    for _ in range(period):\n        yield speed\n\n\ndef pause(delay):\n    for _ in range(delay):\n        yield 0`, `57682791494151770000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">move</span><span class="token punctuation">(</span>period<span class="token punctuation">,</span> speed<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">yield</span> speed\n\n\n<span class="token keyword">def</span> <span class="token function">pause</span><span class="token punctuation">(</span>delay<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>delay<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">yield</span> <span class="token number">0</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>为了把完整的动画制作出来，需要将 move 与 pause 连起来使用，从而算出这张图片当前的位置与上一个位置之差。下面的函数用三个 for 循环来表示动画的三个环节，在每一个环节里，它都通过 yield 把图片当前的位置与上一次的位置之差 delta 返回给调用者。根据 animate 函数返回的 delta 值，即可把整段动画做好。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="28002283949018090000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def animate():\n    for delta in move(4, 5.0):\n        yield delta\n    for delta in pause(3):\n        yield delta\n    for delta in move(2, 3.0):\n        yield delta`, `28002283949018090000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">animate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">for</span> delta <span class="token keyword">in</span> move<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5.0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">yield</span> delta\n    <span class="token keyword">for</span> delta <span class="token keyword">in</span> pause<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">yield</span> delta\n    <span class="token keyword">for</span> delta <span class="token keyword">in</span> move<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3.0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">yield</span> delta</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>接下来，我们就根据 animate 生成器所给出的 delta 值，把整个动画效果渲染出来。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="19142585767883547000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def render(delta):\n    print(f\'Delta: {delta:.1f}\')\n    # Move the images onscreen\n\n\ndef run(func):\n    for delta in func():\n        render(delta)\n\n\nrun(animate)\n\n>>>\nDelta: 5.0\nDelta: 5.0\nDelta: 5.0\nDelta: 5.0\nDelta: 0.0\nDelta: 0.0\nDelta: 0.0\nDelta: 3.0\nDelta: 3.0`, `19142585767883547000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">render</span><span class="token punctuation">(</span>delta<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Delta: </span><span class="token interpolation"><span class="token punctuation">{</span>delta<span class="token punctuation">:</span><span class="token format-spec">.1f</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n    <span class="token comment"># Move the images onscreen</span>\n\n\n<span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">for</span> delta <span class="token keyword">in</span> func<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        render<span class="token punctuation">(</span>delta<span class="token punctuation">)</span>\n\n\nrun<span class="token punctuation">(</span>animate<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nDelta<span class="token punctuation">:</span> <span class="token number">5.0</span>\nDelta<span class="token punctuation">:</span> <span class="token number">5.0</span>\nDelta<span class="token punctuation">:</span> <span class="token number">5.0</span>\nDelta<span class="token punctuation">:</span> <span class="token number">5.0</span>\nDelta<span class="token punctuation">:</span> <span class="token number">0.0</span>\nDelta<span class="token punctuation">:</span> <span class="token number">0.0</span>\nDelta<span class="token punctuation">:</span> <span class="token number">0.0</span>\nDelta<span class="token punctuation">:</span> <span class="token number">3.0</span>\nDelta<span class="token punctuation">:</span> <span class="token number">3.0</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这种写法的问题在于，animate 函数里有很多重复的地方。比如它反复使用 for 结构来操纵生成器，而且每个 for 结构都使用相同的 yield 表达式，这样看上去很啰唆。这个例子仅仅连用了三个生成器，就让代码变得如此烦琐，若是动画里面有十几或几十个环节，那么代码读起来会更加困难。</p>\n<p>为了解决这个问题，我们可以改用 yield from 形式的表达式来实现。这种形式，会先从嵌套进去的小生成器里面取值，如果该生成器已经用完，那么程序的控制流程就会回到 yield from 所在的这个函数之中，然后它有可能进入下一套 yield from 逻辑。下面这段代码，用 yield from 语句重新实现了 animate 函数。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="94190573809897370000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def animate_composed():\n    yield from move(4, 5.0)\n    yield from pause(3)\n    yield from move(2, 3.0)\n\nrun(animate_composed)\n\n>>>\nDelta: 5.0\nDelta: 5.0\nDelta: 5.0\nDelta: 5.0\nDelta: 0.0\nDelta: 0.0\nDelta: 0.0\nDelta: 3.0\nDelta: 3.0`, `94190573809897370000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">animate_composed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">yield</span> <span class="token keyword">from</span> move<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5.0</span><span class="token punctuation">)</span>\n    <span class="token keyword">yield</span> <span class="token keyword">from</span> pause<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>\n    <span class="token keyword">yield</span> <span class="token keyword">from</span> move<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3.0</span><span class="token punctuation">)</span>\n\nrun<span class="token punctuation">(</span>animate_composed<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nDelta<span class="token punctuation">:</span> <span class="token number">5.0</span>\nDelta<span class="token punctuation">:</span> <span class="token number">5.0</span>\nDelta<span class="token punctuation">:</span> <span class="token number">5.0</span>\nDelta<span class="token punctuation">:</span> <span class="token number">5.0</span>\nDelta<span class="token punctuation">:</span> <span class="token number">0.0</span>\nDelta<span class="token punctuation">:</span> <span class="token number">0.0</span>\nDelta<span class="token punctuation">:</span> <span class="token number">0.0</span>\nDelta<span class="token punctuation">:</span> <span class="token number">3.0</span>\nDelta<span class="token punctuation">:</span> <span class="token number">3.0</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>它的运行结果与刚才一样，但是代码看上去更清晰、更直观了。Python 解释器看到 yield from 形式的表达式后，会自己想办法实现与带有普通 yield 语句的 for 循环相同的效果，而且这种实现方式要更快。下面采用内置的 timeit 模块编写并运行一个 micro-benchmark 试试。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="48685380813849570000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import timeit\n\n\ndef child():\n    for i in range(1_000_000):\n        yield i\n\n\ndef slow():\n    for i in child():\n        yield i\n\n\ndef fast():\n    yield from child()\n\n\nbaseline = timeit.timeit(\n    stmt=\'for _ in slow(): pass\',\n    globals=globals(),\n    number=50)\nprint(f\'Manual nesting {baseline:.2f}s\')\ncomparison = timeit.timeit(\n    stmt=\'for _ in fast(): pass\',\n    globals=globals(),\n    number=50)\nprint(f\'Composed nesting {comparison:2f}s\')\nreduction = -(comparison - baseline)/baseline\nprint(f\'{reduction:.1%} less time\')\n\n>>>\nManual nesting 3.70s\nComposed nesting 3.319963s\n10.2% less time`, `48685380813849570000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> timeit\n\n\n<span class="token keyword">def</span> <span class="token function">child</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>1_000_000<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">yield</span> i\n\n\n<span class="token keyword">def</span> <span class="token function">slow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">for</span> i <span class="token keyword">in</span> child<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">yield</span> i\n\n\n<span class="token keyword">def</span> <span class="token function">fast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">yield</span> <span class="token keyword">from</span> child<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n\nbaseline <span class="token operator">=</span> timeit<span class="token punctuation">.</span>timeit<span class="token punctuation">(</span>\n    stmt<span class="token operator">=</span><span class="token string">\'for _ in slow(): pass\'</span><span class="token punctuation">,</span>\n    <span class="token builtin">globals</span><span class="token operator">=</span><span class="token builtin">globals</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    number<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Manual nesting </span><span class="token interpolation"><span class="token punctuation">{</span>baseline<span class="token punctuation">:</span><span class="token format-spec">.2f</span><span class="token punctuation">}</span></span><span class="token string">s\'</span></span><span class="token punctuation">)</span>\ncomparison <span class="token operator">=</span> timeit<span class="token punctuation">.</span>timeit<span class="token punctuation">(</span>\n    stmt<span class="token operator">=</span><span class="token string">\'for _ in fast(): pass\'</span><span class="token punctuation">,</span>\n    <span class="token builtin">globals</span><span class="token operator">=</span><span class="token builtin">globals</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    number<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Composed nesting </span><span class="token interpolation"><span class="token punctuation">{</span>comparison<span class="token punctuation">:</span><span class="token format-spec">2f</span><span class="token punctuation">}</span></span><span class="token string">s\'</span></span><span class="token punctuation">)</span>\nreduction <span class="token operator">=</span> <span class="token operator">-</span><span class="token punctuation">(</span>comparison <span class="token operator">-</span> baseline<span class="token punctuation">)</span><span class="token operator">/</span>baseline\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>reduction<span class="token punctuation">:</span><span class="token format-spec">.1%</span><span class="token punctuation">}</span></span><span class="token string"> less time\'</span></span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nManual nesting <span class="token number">3.</span>70s\nComposed nesting <span class="token number">3.</span>319963s\n<span class="token number">10.2</span><span class="token operator">%</span> less time</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>所以，如果要把多个生成器连起来用，那么笔者强烈建议优先考虑 yield from 表达式。</p>\n<h3 id="总结-29"><a href="#%E6%80%BB%E7%BB%93-29" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>如果要连续使用多个生成器，那么可以通过 yield from 表达式来分别使用这些生成器，这样做能够免去重复的 for 结构。</li>\n<li>yield from 的性能要胜过那种在 for 循环里手工编写 yield 表达式的方案。</li>\n</ol>\n<h2 id="第-34-条：不要用-send-给生成器注入数据"><a href="#%E7%AC%AC-34-%E6%9D%A1%EF%BC%9A%E4%B8%8D%E8%A6%81%E7%94%A8-send-%E7%BB%99%E7%94%9F%E6%88%90%E5%99%A8%E6%B3%A8%E5%85%A5%E6%95%B0%E6%8D%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 34 条：不要用 send 给生成器注入数据</h2>\n<p>yield 表达式让我们能够轻松地写出生成器函数，使得调用者可以每次只获取输出序列中的一项结果（参见第 30 条）。但问题是，这种通道是单向的，也就是说，无法让生成器在其一端接收数据流，同时在另一端给出计算结果。假如能实现双向通信，那么生成器的适用面会更广。</p>\n<p>例如，我们想用软件实现无线电广播，用它来发送信号。为了编写这个程序，我们必须用一个函数来模拟正弦波，让它能够给出一系列按照正弦方式分布的点。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="3958136015590763000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import math\n\n\ndef wave(amplitude, steps):\n    step_size = 2 * math.pi / steps\n    for step in range(steps):\n        radians = step * step_size\n        fraction = math.sin(radians)\n        output = amplitude * fraction\n        yield output`, `3958136015590763000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> math\n\n\n<span class="token keyword">def</span> <span class="token function">wave</span><span class="token punctuation">(</span>amplitude<span class="token punctuation">,</span> steps<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    step_size <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> math<span class="token punctuation">.</span>pi <span class="token operator">/</span> steps\n    <span class="token keyword">for</span> step <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>steps<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        radians <span class="token operator">=</span> step <span class="token operator">*</span> step_size\n        fraction <span class="token operator">=</span> math<span class="token punctuation">.</span>sin<span class="token punctuation">(</span>radians<span class="token punctuation">)</span>\n        output <span class="token operator">=</span> amplitude <span class="token operator">*</span> fraction\n        <span class="token keyword">yield</span> output</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>有了这个 wave 函数，我们可以让它按照某个固定的振幅生成一系列可供传输的值。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="11140401091719610000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def transmit(output):\n    if output is None:\n        print(f\'Output is None\')\n    else:\n        print(f\'Output: {output:>5.1f}\')\n\n\ndef run(it):\n    for output in it:\n        transmit(output)\n\n\nrun(wave(3.0, 8))\n\n>>>\nOutput:   0.0\nOutput:   2.1\nOutput:   3.0\nOutput:   2.1\nOutput:   0.0\nOutput:  -2.1\nOutput:  -3.0\nOutput:  -2.1`, `11140401091719610000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">transmit</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">if</span> output <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Output is None\'</span></span><span class="token punctuation">)</span>\n    <span class="token keyword">else</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Output: </span><span class="token interpolation"><span class="token punctuation">{</span>output<span class="token punctuation">:</span><span class="token format-spec">>5.1f</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n\n<span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">for</span> output <span class="token keyword">in</span> it<span class="token punctuation">:</span>\n        transmit<span class="token punctuation">(</span>output<span class="token punctuation">)</span>\n\n\nrun<span class="token punctuation">(</span>wave<span class="token punctuation">(</span><span class="token number">3.0</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nOutput<span class="token punctuation">:</span>   <span class="token number">0.0</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">2.1</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">3.0</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">2.1</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">0.0</span>\nOutput<span class="token punctuation">:</span>  <span class="token operator">-</span><span class="token number">2.1</span>\nOutput<span class="token punctuation">:</span>  <span class="token operator">-</span><span class="token number">3.0</span>\nOutput<span class="token punctuation">:</span>  <span class="token operator">-</span><span class="token number">2.1</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样写可以生成基本的波形，但问题是，该函数在产生这些值的时候，只能按照刚开始给定的振幅来计算，而没办法使振幅在整个生成过程中根据某个因素发生变化（例如在发送调幅广播信号时，我们就需要这么做）。现在，我们要让生成器在计算每个值的时候，都能考虑到振幅的变化，从而实现调幅。</p>\n<p>Python 的生成器支持 send 方法，这可以让生成器变为双向通道。send 方法可以把参数发给生成器，让它成为上一条 yield 表达式的求值结果，并将生成器推进到下一条 yield 表达式，然后把 yield 右边的值返回给 send 方法的调用者。然而在一般情况下，我们还是会通过内置的 next 函数来推进生成器，按照这种写法，上一条 yield 表达式的求值结果总是 None。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="82104608346608290000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def my_generator():\n    received = yield 1\n    print(f\'received {received}\')\n\n\nit = iter(my_generator())\noutput = next(it)  # Get first generator output\nprint(f\'output = {output}\')\ntry:\n    next(it)  # Run generator until it exits\nexcept StopIteration:\n    pass\n\n>>>\noutput = 1\nreceived None`, `82104608346608290000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">my_generator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    received <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token number">1</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'received </span><span class="token interpolation"><span class="token punctuation">{</span>received<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n\nit <span class="token operator">=</span> <span class="token builtin">iter</span><span class="token punctuation">(</span>my_generator<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\noutput <span class="token operator">=</span> <span class="token builtin">next</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span>  <span class="token comment"># Get first generator output</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'output = </span><span class="token interpolation"><span class="token punctuation">{</span>output<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n<span class="token keyword">try</span><span class="token punctuation">:</span>\n    <span class="token builtin">next</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span>  <span class="token comment"># Run generator until it exits</span>\n<span class="token keyword">except</span> StopIteration<span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\noutput <span class="token operator">=</span> <span class="token number">1</span>\nreceived <span class="token boolean">None</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果不通过 for 循环或内置的 next 函数推进生成器，而是改用 send 方法，那么调用方法时传入的参数就会成为上一条 yield 表达式的值，生成器拿到这个值后，会继续运行到下一条 yield 表达式那里。可是，刚开始推进生成器的时候，它是从头执行的，而不是从某一条 yield 表达式那里继续的，所以，首次调用 send 方法时，只能传 None，要是传入其他值，程序运行时就会抛出异常。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="80666940141181240000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def my_generator():\n    received = yield 1\n    print(f\'received {received}\')\n\n\nit = iter(my_generator())\noutput = it.send(None)  # Get first generator output\nprint(f\'output {output}\')\ntry:\n    it.send(\'hello!\')  # Send value into the generator\nexcept StopIteration:\n    pass\n\n>>>\noutput 1\nreceived hello!`, `80666940141181240000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">my_generator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    received <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token number">1</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'received </span><span class="token interpolation"><span class="token punctuation">{</span>received<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n\nit <span class="token operator">=</span> <span class="token builtin">iter</span><span class="token punctuation">(</span>my_generator<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\noutput <span class="token operator">=</span> it<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">)</span>  <span class="token comment"># Get first generator output</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'output </span><span class="token interpolation"><span class="token punctuation">{</span>output<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n<span class="token keyword">try</span><span class="token punctuation">:</span>\n    it<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">\'hello!\'</span><span class="token punctuation">)</span>  <span class="token comment"># Send value into the generator</span>\n<span class="token keyword">except</span> StopIteration<span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\noutput <span class="token number">1</span>\nreceived hello!</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们可以利用这种机制让调用者把振幅发送过来，这样函数就能根据这个输入值调整生成的正弦波幅值了。首先修改 wave 函数的代码，让它把 yield 表达式的求值结果（也就是调用者通过 send 发过来的振幅）保存到 amplitude 变量里，这样就能根据该变量计算出下次应该生成的值。</p>\n<p>然后，要修改 run 函数调用 <code class="language-text">wave_modulating</code> 函数的方式。它现在必须把每次所要使用的振幅发给 <code class="language-text">wave_modulating</code> 生成器。首次必须发送 None，因为此时生成器还没有遇到过 yield 表达式，它不需要知道上一条 yield 表达式的求值结果。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="13577417982687523000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import math\n\n\ndef transmit(output):\n    if output is None:\n        print(f\'Output is None\')\n    else:\n        print(f\'Output: {output:>5.1f}\')\n\n\ndef wave_modulating(steps):\n    step_size = 2 * math.pi / steps\n    amplitude = yield  # Receive initial amplitude\n    for step in range(steps):\n        radians = step * step_size\n        fraction = math.sin(radians)\n        output = amplitude * fraction\n        amplitude = yield output  # Receive next amplitude\n\n\ndef run_modulating(it):\n    amplitudes = [None, 7, 7, 7, 2, 2, 2, 2, 10, 10, 10, 10, 10]\n    for amplitude in amplitudes:\n        output = it.send(amplitude)\n        transmit(output)\n\n\nrun_modulating(wave_modulating(12))\n\n>>>\nOutput is None\nOutput:   0.0\nOutput:   3.5\nOutput:   6.1\nOutput:   2.0\nOutput:   1.7\nOutput:   1.0\nOutput:   0.0\nOutput:  -5.0\nOutput:  -8.7\nOutput: -10.0\nOutput:  -8.7\nOutput:  -5.0`, `13577417982687523000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> math\n\n\n<span class="token keyword">def</span> <span class="token function">transmit</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">if</span> output <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Output is None\'</span></span><span class="token punctuation">)</span>\n    <span class="token keyword">else</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Output: </span><span class="token interpolation"><span class="token punctuation">{</span>output<span class="token punctuation">:</span><span class="token format-spec">>5.1f</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n\n<span class="token keyword">def</span> <span class="token function">wave_modulating</span><span class="token punctuation">(</span>steps<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    step_size <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> math<span class="token punctuation">.</span>pi <span class="token operator">/</span> steps\n    amplitude <span class="token operator">=</span> <span class="token keyword">yield</span>  <span class="token comment"># Receive initial amplitude</span>\n    <span class="token keyword">for</span> step <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>steps<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        radians <span class="token operator">=</span> step <span class="token operator">*</span> step_size\n        fraction <span class="token operator">=</span> math<span class="token punctuation">.</span>sin<span class="token punctuation">(</span>radians<span class="token punctuation">)</span>\n        output <span class="token operator">=</span> amplitude <span class="token operator">*</span> fraction\n        amplitude <span class="token operator">=</span> <span class="token keyword">yield</span> output  <span class="token comment"># Receive next amplitude</span>\n\n\n<span class="token keyword">def</span> <span class="token function">run_modulating</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    amplitudes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span>\n    <span class="token keyword">for</span> amplitude <span class="token keyword">in</span> amplitudes<span class="token punctuation">:</span>\n        output <span class="token operator">=</span> it<span class="token punctuation">.</span>send<span class="token punctuation">(</span>amplitude<span class="token punctuation">)</span>\n        transmit<span class="token punctuation">(</span>output<span class="token punctuation">)</span>\n\n\nrun_modulating<span class="token punctuation">(</span>wave_modulating<span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nOutput <span class="token keyword">is</span> <span class="token boolean">None</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">0.0</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">3.5</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">6.1</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">2.0</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">1.7</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">1.0</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">0.0</span>\nOutput<span class="token punctuation">:</span>  <span class="token operator">-</span><span class="token number">5.0</span>\nOutput<span class="token punctuation">:</span>  <span class="token operator">-</span><span class="token number">8.7</span>\nOutput<span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">10.0</span>\nOutput<span class="token punctuation">:</span>  <span class="token operator">-</span><span class="token number">8.7</span>\nOutput<span class="token punctuation">:</span>  <span class="token operator">-</span><span class="token number">5.0</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样写没问题，程序可以按照每次输入的值调整输出信号的振幅。首次输出的肯定是 None，因为此时 <code class="language-text">wave_modulating</code> 函数并不知道 amplitude 是多少，它只有在运行第一条 yield 表达式后，才能把调用者通过 send 发来的值保存到这个变量里。</p>\n<p>这种写法有个缺点，就是它很难让初次阅读这段代码的人立刻理解它的意思。把 yield 放在赋值语句的右侧，本身就不太直观，因为我们必须先了解生成器的这项高级特性，才能明白 yield 与 send 是如何相互配合的。</p>\n<p>现在假设程序的需求变得更复杂了。这次要生成的载波不是简单的正弦波，而是由多个信号序列构成的复合波形（complex waveform）。要实现这个需求，可以连用几条 yield from 语句，把多个生成器串接起来（参见第 33 条）。下面先验证一下，这种写法能否处理振幅固定的简单情况。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="76563934052821140000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def complex_wave():\n    yield from wave(7.0, 3)\n    yield from wave(2.0, 4)\n    yield from wave(10.0, 5)\n\n\nrun(complex_wave())\n\n>>>\nOutput:   0.0\nOutput:   6.1\nOutput:  -6.1\nOutput:   0.0\nOutput:   2.0\nOutput:   0.0\nOutput:  -2.0\nOutput:   0.0\nOutput:   9.5\nOutput:   5.9\nOutput:  -5.9\nOutput:  -9.5`, `76563934052821140000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">complex_wave</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">yield</span> <span class="token keyword">from</span> wave<span class="token punctuation">(</span><span class="token number">7.0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>\n    <span class="token keyword">yield</span> <span class="token keyword">from</span> wave<span class="token punctuation">(</span><span class="token number">2.0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>\n    <span class="token keyword">yield</span> <span class="token keyword">from</span> wave<span class="token punctuation">(</span><span class="token number">10.0</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>\n\n\nrun<span class="token punctuation">(</span>complex_wave<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nOutput<span class="token punctuation">:</span>   <span class="token number">0.0</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">6.1</span>\nOutput<span class="token punctuation">:</span>  <span class="token operator">-</span><span class="token number">6.1</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">0.0</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">2.0</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">0.0</span>\nOutput<span class="token punctuation">:</span>  <span class="token operator">-</span><span class="token number">2.0</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">0.0</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">9.5</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">5.9</span>\nOutput<span class="token punctuation">:</span>  <span class="token operator">-</span><span class="token number">5.9</span>\nOutput<span class="token punctuation">:</span>  <span class="token operator">-</span><span class="token number">9.5</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以看到，利用 yield from 表达式确实可以处理比较简单的情况。那既然这样，我们再试试看，它能否处理那种采用 send 方法写成的函数。下面就用这种写法，接连多次调用 <code class="language-text">wave_modulating</code> 生成器。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="54631699250368090000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def complex_wave_modulating():\n    yield from wave_modulating(3)\n    yield from wave_modulating(4)\n    yield from wave_modulating(5)\n\n\nrun_modulating(complex_wave_modulating())\n\n>>>\nOutput is None\nOutput:   0.0\nOutput:   6.1\nOutput:  -6.1\nOutput is None\nOutput:   0.0\nOutput:   2.0\nOutput:   0.0\nOutput: -10.0\nOutput is None\nOutput:   0.0\nOutput:   9.5\nOutput:   5.9`, `54631699250368090000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">complex_wave_modulating</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">yield</span> <span class="token keyword">from</span> wave_modulating<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>\n    <span class="token keyword">yield</span> <span class="token keyword">from</span> wave_modulating<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>\n    <span class="token keyword">yield</span> <span class="token keyword">from</span> wave_modulating<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>\n\n\nrun_modulating<span class="token punctuation">(</span>complex_wave_modulating<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nOutput <span class="token keyword">is</span> <span class="token boolean">None</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">0.0</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">6.1</span>\nOutput<span class="token punctuation">:</span>  <span class="token operator">-</span><span class="token number">6.1</span>\nOutput <span class="token keyword">is</span> <span class="token boolean">None</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">0.0</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">2.0</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">0.0</span>\nOutput<span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">10.0</span>\nOutput <span class="token keyword">is</span> <span class="token boolean">None</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">0.0</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">9.5</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">5.9</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样写在大方向上是对的，但问题在于：程序竟然输出了那么多 None！这是为什么呢？因为每条 yield from 表达式其实都在遍历一个嵌套进去的生成器，所以每个嵌套生成器都必须分别执行它们各自的第一条 yield 语句（也就是什么值都不带的那条 yield 语句），只有执行过这条语句之后，这些生成器才能通过 send 方法所传来的值决定这条语句的求值结果，并把这个结果放在 amplitude 变量里以计算下一次应该输出的值。所以，<code class="language-text">complex_wave_modulating</code> 函数处理完前一个嵌套的生成器之后，会进入下一个嵌套的生成器，而这时就必须先把该生成器的第一条 yield 语句运行过去，这就导致后面两个嵌套生成器会各自从 amplitudes 列表里浪费掉一个，并使得每个嵌套生成器所拿到的第一个结果必定是 None，还会让最后那个嵌套生成器少执行两次。</p>\n<p>这意味着，虽然 yield from 语句与 send 方法单独用着都没问题，然而结合使用的效果却不太让人满意。当然也可以在 <code class="language-text">run_modulating</code> 函数里添加一些代码，使得计算波形的步调与 amplitudes 列表提供振幅值的步调相一致，但这只能使程序越写越复杂，因为利用 send 方法写成的 <code class="language-text">wave_modulating</code> 函数本身已经不太直观了，而我们又把这个生成器函数通过 yield from 语句套到了 <code class="language-text">complex_wave_modulating</code> 里面，这理解起来就更加困难了。所以，笔者建议彻底抛开 send 方法，改用更简单的方案来做。</p>\n<p>最简单的一种写法，是把迭代器传给 wave 函数，让 wave 每次用到振幅的时候，通过 Python 内置的 next 函数推进这个迭代器并返回一个输入振幅。于是，这就促使多个生成器之间，产生连环反应（其他类似案例参见第 32 条）。</p>\n<p>这样，我们只需要把同一个迭代器分别传给这几条 yield from 语句里的 <code class="language-text">wave_cascading</code> 就行。迭代器是有状态的（参见第 31 条），所以下一个 <code class="language-text">wave_cascading</code> 会从上一个 <code class="language-text">wave_cascading</code> 使用完的地方，继续往下使用 <code class="language-text">amplitude_it</code> 迭代器。</p>\n<p>要想触发这个组合的生成器，只需要把振幅值放在列表中，并把针对列表制作的迭代器传给 <code class="language-text">complex_wave_cascading</code> 就好。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="56499734880209805000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import math\n\n\ndef transmit(output):\n    if output is None:\n        print(f\'Output is None\')\n    else:\n        print(f\'Output: {output:>5.1f}\')\n\n\ndef wave_cascading(amplitude_it, steps):\n    step_size = 2 * math.pi / steps\n    for step in range(steps):\n        radians = step * step_size\n        fraction = math.sin(radians)\n        amplitude = next(amplitude_it)  # Get next input\n        output = amplitude * fraction\n        yield output\n\n\ndef complex_wave_cascading(amplitude_it):\n    yield from wave_cascading(amplitude_it, 3)\n    yield from wave_cascading(amplitude_it, 4)\n    yield from wave_cascading(amplitude_it, 5)\n\n\ndef run_cascading():\n    amplitudes = [7, 7, 7, 2, 2, 2, 2, 10, 10, 10, 10, 10]\n    it = complex_wave_cascading(iter(amplitudes))\n    for amplitude in amplitudes:\n        output = next(it)\n        transmit(output)\n\n\nrun_cascading()\n\n>>>\nOutput:   0.0\nOutput:   6.1\nOutput:  -6.1\nOutput:   0.0\nOutput:   2.0\nOutput:   0.0\nOutput:  -2.0\nOutput:   0.0\nOutput:   9.5\nOutput:   5.9\nOutput:  -5.9\nOutput:  -9.5`, `56499734880209805000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> math\n\n\n<span class="token keyword">def</span> <span class="token function">transmit</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">if</span> output <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Output is None\'</span></span><span class="token punctuation">)</span>\n    <span class="token keyword">else</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Output: </span><span class="token interpolation"><span class="token punctuation">{</span>output<span class="token punctuation">:</span><span class="token format-spec">>5.1f</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n\n<span class="token keyword">def</span> <span class="token function">wave_cascading</span><span class="token punctuation">(</span>amplitude_it<span class="token punctuation">,</span> steps<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    step_size <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> math<span class="token punctuation">.</span>pi <span class="token operator">/</span> steps\n    <span class="token keyword">for</span> step <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>steps<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        radians <span class="token operator">=</span> step <span class="token operator">*</span> step_size\n        fraction <span class="token operator">=</span> math<span class="token punctuation">.</span>sin<span class="token punctuation">(</span>radians<span class="token punctuation">)</span>\n        amplitude <span class="token operator">=</span> <span class="token builtin">next</span><span class="token punctuation">(</span>amplitude_it<span class="token punctuation">)</span>  <span class="token comment"># Get next input</span>\n        output <span class="token operator">=</span> amplitude <span class="token operator">*</span> fraction\n        <span class="token keyword">yield</span> output\n\n\n<span class="token keyword">def</span> <span class="token function">complex_wave_cascading</span><span class="token punctuation">(</span>amplitude_it<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">yield</span> <span class="token keyword">from</span> wave_cascading<span class="token punctuation">(</span>amplitude_it<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>\n    <span class="token keyword">yield</span> <span class="token keyword">from</span> wave_cascading<span class="token punctuation">(</span>amplitude_it<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>\n    <span class="token keyword">yield</span> <span class="token keyword">from</span> wave_cascading<span class="token punctuation">(</span>amplitude_it<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>\n\n\n<span class="token keyword">def</span> <span class="token function">run_cascading</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    amplitudes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span>\n    it <span class="token operator">=</span> complex_wave_cascading<span class="token punctuation">(</span><span class="token builtin">iter</span><span class="token punctuation">(</span>amplitudes<span class="token punctuation">)</span><span class="token punctuation">)</span>\n    <span class="token keyword">for</span> amplitude <span class="token keyword">in</span> amplitudes<span class="token punctuation">:</span>\n        output <span class="token operator">=</span> <span class="token builtin">next</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span>\n        transmit<span class="token punctuation">(</span>output<span class="token punctuation">)</span>\n\n\nrun_cascading<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nOutput<span class="token punctuation">:</span>   <span class="token number">0.0</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">6.1</span>\nOutput<span class="token punctuation">:</span>  <span class="token operator">-</span><span class="token number">6.1</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">0.0</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">2.0</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">0.0</span>\nOutput<span class="token punctuation">:</span>  <span class="token operator">-</span><span class="token number">2.0</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">0.0</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">9.5</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">5.9</span>\nOutput<span class="token punctuation">:</span>  <span class="token operator">-</span><span class="token number">5.9</span>\nOutput<span class="token punctuation">:</span>  <span class="token operator">-</span><span class="token number">9.5</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这种写法最大的优点在于，迭代器可以来自任何地方，而且完全可以是动态的（例如可以用生成器函数来实现迭代器）。此方案只有一个缺陷，就是必须假设负责输入的生成器绝对能保证线程安全，但有时其实保证不了这一点。如果代码要跨越线程边界，那么用 async 函数实现可能更好（参见第 62 条）。</p>\n<h3 id="总结-30"><a href="#%E6%80%BB%E7%BB%93-30" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>send 方法可以把数据注入生成器，让它成为上一条 yield 表达式的求值结果，生成器可以把这个结果赋给变量。</li>\n<li>把 send 方法与 yield from 表达式搭配起来使用，可能导致奇怪的结果，例如会让程序在本该输出有效值的地方输出 None。</li>\n<li>通过迭代器向组合起来的生成器输入数据，要比采用 send 方法的那种方案好，所以尽量避免使用 send 方法。</li>\n</ol>\n<h2 id="第-35-条：不要通过-throw-变换生成器的状态"><a href="#%E7%AC%AC-35-%E6%9D%A1%EF%BC%9A%E4%B8%8D%E8%A6%81%E9%80%9A%E8%BF%87-throw-%E5%8F%98%E6%8D%A2%E7%94%9F%E6%88%90%E5%99%A8%E7%9A%84%E7%8A%B6%E6%80%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 35 条：不要通过 throw 变换生成器的状态</h2>\n<p>除 yield from 表达式（参见第 33 条）与 send 方法（参见第 34 条）外，生成器还有一项高级功能，就是可以把调用者通过 throw 方法传来的 Exception 实例重新抛出。这个 throw 方法用起来很简单：如果调用了这个方法，那么生成器下次推进时，就不会像平常那样，直接走到下一条 yield 表达式那里，而是会把通过 throw 方法传入的异常重新抛出。下面用代码演示这种效果。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="28354713323327930000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class MyError(Exception):\n    pass\n\n\ndef my_generator():\n    yield 1\n    yield 2\n    yield 3\n\n\nit = my_generator()\nprint(next(it))  # Yield 1\nprint(next(it))  # Yield 2\nprint(it.throw(MyError(\'test error\')))\n\n>>>\n1\n2\nTraceback ...\n__main__.MyError: test error`, `28354713323327930000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">MyError</span><span class="token punctuation">(</span>Exception<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n\n<span class="token keyword">def</span> <span class="token function">my_generator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">yield</span> <span class="token number">1</span>\n    <span class="token keyword">yield</span> <span class="token number">2</span>\n    <span class="token keyword">yield</span> <span class="token number">3</span>\n\n\nit <span class="token operator">=</span> my_generator<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">next</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># Yield 1</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">next</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># Yield 2</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>it<span class="token punctuation">.</span>throw<span class="token punctuation">(</span>MyError<span class="token punctuation">(</span><span class="token string">\'test error\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token number">1</span>\n<span class="token number">2</span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\n__main__<span class="token punctuation">.</span>MyError<span class="token punctuation">:</span> test error</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>生成器函数可以用标准的 try/except 复合语句把 yield 表达式包裹起来，如果函数上次执行到了这条表达式这里，而这次即将继续执行时，又发现外界通过 throw 方法给自己注入了异常，那么这个异常就会被 try 结构捕获下来，如果捕获之后不继续抛异常，那么生成器函数会推进到下一条 yield 表达式（更多异常处理，参见第 65 条）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="17087669039805164000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class MyError(Exception):\n    pass\n\n\ndef my_generator():\n    yield 1\n    try:\n        yield 2\n    except MyError:\n        print(\'Got MyError!\')\n    else:\n        yield 3\n    yield 4\n\n\nit = my_generator()\nprint(next(it))  # Yield 1\nprint(next(it))  # Yield 2\nprint(it.throw(MyError(\'test error\')))\n\n>>>\n1\n2\nGot MyError!\n4`, `17087669039805164000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">MyError</span><span class="token punctuation">(</span>Exception<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n\n<span class="token keyword">def</span> <span class="token function">my_generator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">yield</span> <span class="token number">1</span>\n    <span class="token keyword">try</span><span class="token punctuation">:</span>\n        <span class="token keyword">yield</span> <span class="token number">2</span>\n    <span class="token keyword">except</span> MyError<span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Got MyError!\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">else</span><span class="token punctuation">:</span>\n        <span class="token keyword">yield</span> <span class="token number">3</span>\n    <span class="token keyword">yield</span> <span class="token number">4</span>\n\n\nit <span class="token operator">=</span> my_generator<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">next</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># Yield 1</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">next</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># Yield 2</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>it<span class="token punctuation">.</span>throw<span class="token punctuation">(</span>MyError<span class="token punctuation">(</span><span class="token string">\'test error\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token number">1</span>\n<span class="token number">2</span>\nGot MyError!\n<span class="token number">4</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这项机制会在生成器与调用者之间形成双向通信通道（另一种双向通信通道，参见第 34 条），这在某些情况下是有用的。例如，要编写一个偶尔可以重置的计时器程序。笔者定义下面的 Reset 异常与 timer 生成器方法，让调用者可以在 timer 给出的迭代器上通过 throw 方法注入 Reset 异常，令计时器重置。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="85356197860194390000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Reset(Exception):\n    pass\n\n\ndef timer(period):\n    current = period\n    while current:\n        current -= 1\n        try:\n            yield current\n        except Reset:\n            current = period`, `85356197860194390000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Reset</span><span class="token punctuation">(</span>Exception<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n\n<span class="token keyword">def</span> <span class="token function">timer</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    current <span class="token operator">=</span> period\n    <span class="token keyword">while</span> current<span class="token punctuation">:</span>\n        current <span class="token operator">-=</span> <span class="token number">1</span>\n        <span class="token keyword">try</span><span class="token punctuation">:</span>\n            <span class="token keyword">yield</span> current\n        <span class="token keyword">except</span> Reset<span class="token punctuation">:</span>\n            current <span class="token operator">=</span> period</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>按照这种写法，如果 timer 正准备从 yield 表达式往下推进时，发现有人注入了 Reset 异常，那么它就会把这个异常捕获下来，并进入 except 分支，在这里它会把表示倒计时的 current 变量重新调整成最初的 period 值。</p>\n<p>这个计时器可以与外界某个按秒轮询的输入机制对接起来。为此，笔者定义一个 run 函数以驱动 timer 生成器所给出的那个 it 迭代器，并根据外界的情况做处理，如果外界要求重置，那就通过 it 迭代器的 throw 方法给计时器注入 Reset 变量，如果外界没有这样要求，那就调用 announce 函数打印生成器所给的倒计时值。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="59392799873626020000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Reset(Exception):\n    pass\n\n\ndef timer(period):\n    current = period\n    while current:\n        current -= 1\n        try:\n            yield current\n        except Reset:\n            current = period\n\n\ndef check_for_reset():\n    # Poll for external event\n    # ...\n    pass\n\n\ndef announce(remaining):\n    print(f\'{remaining} ticks remaining\')\n\n\ndef run():\n    it = timer(4)\n    while True:\n        try:\n            if check_for_reset():\n                current = it.throw(Reset())\n            else:\n                current = next(it)\n        except StopIteration:\n            break\n        else:\n            announce(current)\n\n\nrun()\n\n>>>\n3 ticks remaining\n2 ticks remaining\n1 ticks remaining\n0 ticks remaining`, `59392799873626020000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Reset</span><span class="token punctuation">(</span>Exception<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n\n<span class="token keyword">def</span> <span class="token function">timer</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    current <span class="token operator">=</span> period\n    <span class="token keyword">while</span> current<span class="token punctuation">:</span>\n        current <span class="token operator">-=</span> <span class="token number">1</span>\n        <span class="token keyword">try</span><span class="token punctuation">:</span>\n            <span class="token keyword">yield</span> current\n        <span class="token keyword">except</span> Reset<span class="token punctuation">:</span>\n            current <span class="token operator">=</span> period\n\n\n<span class="token keyword">def</span> <span class="token function">check_for_reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token comment"># Poll for external event</span>\n    <span class="token comment"># ...</span>\n    <span class="token keyword">pass</span>\n\n\n<span class="token keyword">def</span> <span class="token function">announce</span><span class="token punctuation">(</span>remaining<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>remaining<span class="token punctuation">}</span></span><span class="token string"> ticks remaining\'</span></span><span class="token punctuation">)</span>\n\n\n<span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    it <span class="token operator">=</span> timer<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>\n    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>\n        <span class="token keyword">try</span><span class="token punctuation">:</span>\n            <span class="token keyword">if</span> check_for_reset<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n                current <span class="token operator">=</span> it<span class="token punctuation">.</span>throw<span class="token punctuation">(</span>Reset<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n            <span class="token keyword">else</span><span class="token punctuation">:</span>\n                current <span class="token operator">=</span> <span class="token builtin">next</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span>\n        <span class="token keyword">except</span> StopIteration<span class="token punctuation">:</span>\n            <span class="token keyword">break</span>\n        <span class="token keyword">else</span><span class="token punctuation">:</span>\n            announce<span class="token punctuation">(</span>current<span class="token punctuation">)</span>\n\n\nrun<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token number">3</span> ticks remaining\n<span class="token number">2</span> ticks remaining\n<span class="token number">1</span> ticks remaining\n<span class="token number">0</span> ticks remaining</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样写没错，但是有点儿难懂，因为用了许多层嵌套结构。我们要判断 <code class="language-text">check_for_reset</code> 函数的返回值，以确定是应该通过 it.throw 注入 Reset 异常，还是应该通过 next 推进迭代器。如果是要推进迭代器，那么还得捕获 StopIteration 异常：若是捕获到了这种异常，那说明迭代器已经走到终点，则要执行 break 跳出 while 循环；若没捕获到，则需要调用 announce 函数打印倒计时值。这会让代码变得很乱。</p>\n<p>有个简单的办法，能够改写这段代码，那就是用可迭代的容器对象（参见第 31 条）定义一个有状态的闭包（参见第 38 条）。下面的代码就写了这样一个 Timer 类，并通过它重新实现刚才的 timer 生成器。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="86776898905394540000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Timer:\n    def __init__(self, period):\n        self.current = period\n        self.period = period\n\n    def reset(self):\n        self.current = self.period\n\n    def __iter__(self):\n        while self.current:\n            self.current -= 1\n            yield self.current`, `86776898905394540000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Timer</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> period<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>current <span class="token operator">=</span> period\n        self<span class="token punctuation">.</span>period <span class="token operator">=</span> period\n\n    <span class="token keyword">def</span> <span class="token function">reset</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>current <span class="token operator">=</span> self<span class="token punctuation">.</span>period\n\n    <span class="token keyword">def</span> <span class="token function">__iter__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">while</span> self<span class="token punctuation">.</span>current<span class="token punctuation">:</span>\n            self<span class="token punctuation">.</span>current <span class="token operator">-=</span> <span class="token number">1</span>\n            <span class="token keyword">yield</span> self<span class="token punctuation">.</span>current</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在，run 函数就好写多了，因为它只需要用 for 循环迭代这个 timer 即可。这样写出来的代码，不像刚才那样有那么多层嵌套，所以读起来很容易懂。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="85079758486819340000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Reset(Exception):\n    pass\n\n\ndef check_for_reset():\n    # Poll for external event\n    # ...\n    pass\n\n\ndef announce(remaining):\n    print(f\'{remaining} ticks remaining\')\n\n\nclass Timer:\n    def __init__(self, period):\n        self.current = period\n        self.period = period\n\n    def reset(self):\n        self.current = self.period\n\n    def __iter__(self):\n        while self.current:\n            self.current -= 1\n            yield self.current\n\n\ndef run():\n    timer = Timer(4)\n    for current in timer:\n        if check_for_reset():\n            timer.reset()\n        announce(current)\n\n\nrun()\n\n>>>\n3 ticks remaining\n2 ticks remaining\n1 ticks remaining\n0 ticks remaining`, `85079758486819340000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py{29-37}"\n              >\n                <span class="gatsby-code-button-language">py{29-37}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Reset</span><span class="token punctuation">(</span>Exception<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n\n<span class="token keyword">def</span> <span class="token function">check_for_reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token comment"># Poll for external event</span>\n    <span class="token comment"># ...</span>\n    <span class="token keyword">pass</span>\n\n\n<span class="token keyword">def</span> <span class="token function">announce</span><span class="token punctuation">(</span>remaining<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>remaining<span class="token punctuation">}</span></span><span class="token string"> ticks remaining\'</span></span><span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">Timer</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> period<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>current <span class="token operator">=</span> period\n        self<span class="token punctuation">.</span>period <span class="token operator">=</span> period\n\n    <span class="token keyword">def</span> <span class="token function">reset</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>current <span class="token operator">=</span> self<span class="token punctuation">.</span>period\n\n    <span class="token keyword">def</span> <span class="token function">__iter__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">while</span> self<span class="token punctuation">.</span>current<span class="token punctuation">:</span>\n            self<span class="token punctuation">.</span>current <span class="token operator">-=</span> <span class="token number">1</span>\n            <span class="token keyword">yield</span> self<span class="token punctuation">.</span>current\n\n\n<span class="gatsby-highlight-code-line"><span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">    timer <span class="token operator">=</span> Timer<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line">    <span class="token keyword">for</span> current <span class="token keyword">in</span> timer<span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">        <span class="token keyword">if</span> check_for_reset<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">            timer<span class="token punctuation">.</span>reset<span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line">        announce<span class="token punctuation">(</span>current<span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line">run<span class="token punctuation">(</span><span class="token punctuation">)</span></span>\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token number">3</span> ticks remaining\n<span class="token number">2</span> ticks remaining\n<span class="token number">1</span> ticks remaining\n<span class="token number">0</span> ticks remaining</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样写所输出的结果与前面一样，但是这种实现方案理解起来要容易得多，即便是初次阅读这段代码的人也很容易就能读懂。凡是想用生成器与异常来实现的功能，通常都可以改用异步机制去做（参见第 60 条），那样会更好。如果确实遇到了这里讲到的这种需求，那么应该通过可迭代的类来实现生成器，而不要用 throw 方法注入异常。</p>\n<h3 id="总结-31"><a href="#%E6%80%BB%E7%BB%93-31" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>throw 方法可以把异常发送到生成器刚执行过的那条 yield 表达式那里，让这个异常在生成器下次推进时重新抛出。</li>\n<li>通过 throw 方法注入异常，会让代码变得难懂，因为需要用多层嵌套的模板结构来抛出并捕获这种异常。</li>\n<li>如果确实遇到了这样的特殊情况，那么应该通过类的 <code class="language-text">__iter__</code> 方法实现生成器，并且专门提供一个方法，让调用者通过这个方法来触发这种特殊的状态变换逻辑。</li>\n</ol>\n<h2 id="第-36-条：考虑用-itertools-拼装迭代器与生成器"><a href="#%E7%AC%AC-36-%E6%9D%A1%EF%BC%9A%E8%80%83%E8%99%91%E7%94%A8-itertools-%E6%8B%BC%E8%A3%85%E8%BF%AD%E4%BB%A3%E5%99%A8%E4%B8%8E%E7%94%9F%E6%88%90%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 36 条：考虑用 itertools 拼装迭代器与生成器</h2>\n<p>Python 内置的 itertools 模块里有很多函数，可以用来安排迭代器之间的交互关系（相关的基础知识，参见第 30 条与第 31 条）。</p>\n<p>如果要实现比较难写的迭代逻辑，那么应该先查看 itertools 的文档（在 Python 解释器界面输入 help(itertools)），说不定里面就有你能用到的函数。下面分三大类，列出其中最重要的函数。</p>\n<h3 id="连接多个迭代器"><a href="#%E8%BF%9E%E6%8E%A5%E5%A4%9A%E4%B8%AA%E8%BF%AD%E4%BB%A3%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>连接多个迭代器</h3>\n<p>内置的 itertools 模块有一些函数可以把多个迭代器连成一个使用。</p>\n<h4 id="chain"><a href="#chain" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>chain</h4>\n<p>chain 可以把多个迭代器从头到尾连成一个迭代器。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="41003993838379670000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import itertools\n\nit = itertools.chain([1, 2, 3], [4, 5, 6])\nprint(list(it))\n\n>>>\n[1, 2, 3, 4, 5, 6]`, `41003993838379670000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> itertools\n\nit <span class="token operator">=</span> itertools<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="repeat"><a href="#repeat" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>repeat</h4>\n<p>repeat 可以制作这样一个迭代器，它会不停地输出某个值。调用 repeat 时，也可以通过第二个参数指定迭代器最多能输出几次。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="67149646646750000000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import itertools\n\nit = itertools.repeat(\'hello\', 3)\nprint(list(it))\n\n>>>\n[\'hello\', \'hello\', \'hello\']`, `67149646646750000000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> itertools\n\nit <span class="token operator">=</span> itertools<span class="token punctuation">.</span>repeat<span class="token punctuation">(</span><span class="token string">\'hello\'</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">[</span><span class="token string">\'hello\'</span><span class="token punctuation">,</span> <span class="token string">\'hello\'</span><span class="token punctuation">,</span> <span class="token string">\'hello\'</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="cycle"><a href="#cycle" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>cycle</h4>\n<p>cycle 可以制作这样一个迭代器，它会循环地输出某段内容之中的各项元素。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="95167108595716930000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import itertools\n\nit = itertools.cycle([1, 2])\nresult = [next(it) for _ in range(10)]\nprint(result)\n\n>>>\n[1, 2, 1, 2, 1, 2, 1, 2, 1, 2]`, `95167108595716930000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> itertools\n\nit <span class="token operator">=</span> itertools<span class="token punctuation">.</span>cycle<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\nresult <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token builtin">next</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span> <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">]</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="tee"><a href="#tee" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>tee</h4>\n<p>tee 可以让一个迭代器分裂成多个平行的迭代器，具体个数由第二个参数指定。如果这些迭代器推进的速度不一致，那么程序可能要用大量内存做缓冲，以存放进度落后的迭代器将来会用到的元素。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="38864441245958800000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import itertools\n\nit1, it2, it3 = itertools.tee([\'first\', \'second\'], 3)\nprint(list(it1))\nprint(list(it2))\nprint(list(it3))\n\n>>>\n[\'first\', \'second\']\n[\'first\', \'second\']\n[\'first\', \'second\']`, `38864441245958800000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> itertools\n\nit1<span class="token punctuation">,</span> it2<span class="token punctuation">,</span> it3 <span class="token operator">=</span> itertools<span class="token punctuation">.</span>tee<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'first\'</span><span class="token punctuation">,</span> <span class="token string">\'second\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>it1<span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>it2<span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>it3<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">[</span><span class="token string">\'first\'</span><span class="token punctuation">,</span> <span class="token string">\'second\'</span><span class="token punctuation">]</span>\n<span class="token punctuation">[</span><span class="token string">\'first\'</span><span class="token punctuation">,</span> <span class="token string">\'second\'</span><span class="token punctuation">]</span>\n<span class="token punctuation">[</span><span class="token string">\'first\'</span><span class="token punctuation">,</span> <span class="token string">\'second\'</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="zip_longest"><a href="#zip_longest" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>zip_longest</h4>\n<p>它与 Python 内置的 zip 函数类似（参见第 8 条），但区别在于，如果源迭代器的长度不同，那么它会用 fillvalue 参数的值来填补提前耗尽的那些迭代器所留下的空缺。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="93790966117468360000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import itertools\n\nkeys = [\'one\', \'two\', \'three\']\nvalues = [1, 2]\n\nnormal = list(zip(keys, values))\nprint(\'zip:        \', normal)\n\nit = itertools.zip_longest(keys, values, fillvalue=\'nope\')\nlongest = list(it)\nprint(\'zip_longest:\', longest)\n\n>>>\nzip:         [(\'one\', 1), (\'two\', 2)]\nzip_longest: [(\'one\', 1), (\'two\', 2), (\'three\', \'nope\')]`, `93790966117468360000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> itertools\n\nkeys <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'one\'</span><span class="token punctuation">,</span> <span class="token string">\'two\'</span><span class="token punctuation">,</span> <span class="token string">\'three\'</span><span class="token punctuation">]</span>\nvalues <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span>\n\nnormal <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">zip</span><span class="token punctuation">(</span>keys<span class="token punctuation">,</span> values<span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'zip:        \'</span><span class="token punctuation">,</span> normal<span class="token punctuation">)</span>\n\nit <span class="token operator">=</span> itertools<span class="token punctuation">.</span>zip_longest<span class="token punctuation">(</span>keys<span class="token punctuation">,</span> values<span class="token punctuation">,</span> fillvalue<span class="token operator">=</span><span class="token string">\'nope\'</span><span class="token punctuation">)</span>\nlongest <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'zip_longest:\'</span><span class="token punctuation">,</span> longest<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token builtin">zip</span><span class="token punctuation">:</span>         <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">\'one\'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">\'two\'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">]</span>\nzip_longest<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">\'one\'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">\'two\'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">\'three\'</span><span class="token punctuation">,</span> <span class="token string">\'nope\'</span><span class="token punctuation">)</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="过滤源迭代器中的元素"><a href="#%E8%BF%87%E6%BB%A4%E6%BA%90%E8%BF%AD%E4%BB%A3%E5%99%A8%E4%B8%AD%E7%9A%84%E5%85%83%E7%B4%A0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>过滤源迭代器中的元素</h3>\n<p>Python 内置的 itertools 模块里有一些函数可以过滤源迭代器中的元素。</p>\n<h4 id="islice"><a href="#islice" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>islice</h4>\n<p>islice 可以在不拷贝数据的前提下，按照下标切割源迭代器。可以只给出切割的终点，也可以同时给出起点与终点，还可以指定步进值。这种切割方式与标准的序列切片及步进机制类似（参见第 11 条与第 12 条）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="83384045591383260000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import itertools\n\nvalues = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]\nfirst_five = itertools.islice(values, 5)\nprint(\'First five: \', list(first_five))\nmiddle_odds = itertools.islice(values, 2, 8, 2)\nprint(\'Middle odds:\', list(middle_odds))\n\n>>>\nFirst five:  [1, 2, 3, 4, 5]\nMiddle odds: [3, 5, 7]`, `83384045591383260000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> itertools\n\nvalues <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span>\nfirst_five <span class="token operator">=</span> itertools<span class="token punctuation">.</span>islice<span class="token punctuation">(</span>values<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'First five: \'</span><span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">(</span>first_five<span class="token punctuation">)</span><span class="token punctuation">)</span>\nmiddle_odds <span class="token operator">=</span> itertools<span class="token punctuation">.</span>islice<span class="token punctuation">(</span>values<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Middle odds:\'</span><span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">(</span>middle_odds<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nFirst five<span class="token punctuation">:</span>  <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span>\nMiddle odds<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="takewhile"><a href="#takewhile" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>takewhile</h4>\n<p>takewhile 会一直从源迭代器里获取元素，直到某元素让测试函数返回 False 为止。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="42927844366985980000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import itertools\n\nvalues = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]\n\n\ndef less_than_seven(x):\n    return x < 7\n\n\nit = itertools.takewhile(less_than_seven, values)\nprint(list(it))\n\n>>>\n[1, 2, 3, 4, 5, 6]`, `42927844366985980000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> itertools\n\nvalues <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span>\n\n\n<span class="token keyword">def</span> <span class="token function">less_than_seven</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">return</span> x <span class="token operator">&lt;</span> <span class="token number">7</span>\n\n\nit <span class="token operator">=</span> itertools<span class="token punctuation">.</span>takewhile<span class="token punctuation">(</span>less_than_seven<span class="token punctuation">,</span> values<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="dropwhile"><a href="#dropwhile" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>dropwhile</h4>\n<p>与 takewhile 相反，dropwhile 会一直跳过源序列里的元素，直到某元素让测试函数返回 True 为止，然后它会从这个地方开始逐个取值。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="91282195706760130000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import itertools\n\nvalues = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]\n\n\ndef less_than_seven(x):\n    return x < 7\n\n\nit = itertools.dropwhile(less_than_seven, values)\nprint(list(it))\n\n>>>\n[7, 8, 9, 10]`, `91282195706760130000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> itertools\n\nvalues <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span>\n\n\n<span class="token keyword">def</span> <span class="token function">less_than_seven</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">return</span> x <span class="token operator">&lt;</span> <span class="token number">7</span>\n\n\nit <span class="token operator">=</span> itertools<span class="token punctuation">.</span>dropwhile<span class="token punctuation">(</span>less_than_seven<span class="token punctuation">,</span> values<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="filterfalse"><a href="#filterfalse" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>filterfalse</h4>\n<p>filterfalse 和内置的 filter 函数相反，它会逐个输出源迭代器里使得测试函数返回 False 的那些元素。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="9667209023275180000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import itertools\n\nvalues = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]\n\n\ndef evens(x):\n    return x % 2 == 0\n\n\nfilter_result = filter(evens, values)\nprint(\'Filter:      \', list(filter_result))\nfilter_false_result = itertools.filterfalse(evens, values)\nprint(\'Filter false:\', list(filter_false_result))\n\n>>>\nFilter:       [2, 4, 6, 8, 10]\nFilter false: [1, 3, 5, 7, 9]`, `9667209023275180000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> itertools\n\nvalues <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span>\n\n\n<span class="token keyword">def</span> <span class="token function">evens</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">return</span> x <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span>\n\n\nfilter_result <span class="token operator">=</span> <span class="token builtin">filter</span><span class="token punctuation">(</span>evens<span class="token punctuation">,</span> values<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Filter:      \'</span><span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">(</span>filter_result<span class="token punctuation">)</span><span class="token punctuation">)</span>\nfilter_false_result <span class="token operator">=</span> itertools<span class="token punctuation">.</span>filterfalse<span class="token punctuation">(</span>evens<span class="token punctuation">,</span> values<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Filter false:\'</span><span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">(</span>filter_false_result<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nFilter<span class="token punctuation">:</span>       <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span>\nFilter false<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="用源迭代器中的元素合成新元素"><a href="#%E7%94%A8%E6%BA%90%E8%BF%AD%E4%BB%A3%E5%99%A8%E4%B8%AD%E7%9A%84%E5%85%83%E7%B4%A0%E5%90%88%E6%88%90%E6%96%B0%E5%85%83%E7%B4%A0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>用源迭代器中的元素合成新元素</h3>\n<p>Python 内置的 itertools 模块里，有一些函数可以根据源迭代器中的元素合成新的元素。</p>\n<h4 id="accumulate"><a href="#accumulate" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>accumulate</h4>\n<p>accumulate 会从源迭代器里取出一个元素，并把已经累计的结果与这个元素一起传给表示累加逻辑的函数，然后输出那个函数的计算结果，并把结果当成新的累计值。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="20007080004369326000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import itertools\n\nvalues = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]\nsum_reduce = itertools.accumulate(values)\nprint(\'Sum:   \', list(sum_reduce))\n\n\ndef sum_modulo_20(first, second):\n    output = first + second\n    return output % 20\n\n\nmodulo_reduce = itertools.accumulate(values, sum_modulo_20)\nprint(\'Modulo:\', list(modulo_reduce))\n\n>>>\nSum:    [1, 3, 6, 10, 15, 21, 28, 36, 45, 55]\nModulo: [1, 3, 6, 10, 15, 1, 8, 16, 5, 15]`, `20007080004369326000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> itertools\n\nvalues <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span>\nsum_reduce <span class="token operator">=</span> itertools<span class="token punctuation">.</span>accumulate<span class="token punctuation">(</span>values<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Sum:   \'</span><span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">(</span>sum_reduce<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n\n<span class="token keyword">def</span> <span class="token function">sum_modulo_20</span><span class="token punctuation">(</span>first<span class="token punctuation">,</span> second<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    output <span class="token operator">=</span> first <span class="token operator">+</span> second\n    <span class="token keyword">return</span> output <span class="token operator">%</span> <span class="token number">20</span>\n\n\nmodulo_reduce <span class="token operator">=</span> itertools<span class="token punctuation">.</span>accumulate<span class="token punctuation">(</span>values<span class="token punctuation">,</span> sum_modulo_20<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Modulo:\'</span><span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">(</span>modulo_reduce<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nSum<span class="token punctuation">:</span>    <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">,</span> <span class="token number">28</span><span class="token punctuation">,</span> <span class="token number">36</span><span class="token punctuation">,</span> <span class="token number">45</span><span class="token punctuation">,</span> <span class="token number">55</span><span class="token punctuation">]</span>\nModulo<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这与内置的 functools 模块中 reduce 函数，实际上是一样的，只不过这个函数每次只给出一项累计值。如果调用者没有指定表示累加逻辑的双参数函数（binary function），那么默认的逻辑就是两值相加。</p>\n<h4 id="product"><a href="#product" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>product</h4>\n<p>product 会从一个或多个源迭代器里获取元素，并计算笛卡尔积（Cartesian product），它可以取代那种多层嵌套的列表推导代码（参见第 28 条）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="44462418869420910000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import itertools\n\nsingle = itertools.product([1, 2], repeat=2)\nprint(\'Single:  \', list(single))\n\nmultiple = itertools.product([1, 2], [\'a\', \'b\'])\nprint(\'Multiple:\', list(multiple))\n\n>>>\nSingle:   [(1, 1), (1, 2), (2, 1), (2, 2)]\nMultiple: [(1, \'a\'), (1, \'b\'), (2, \'a\'), (2, \'b\')]`, `44462418869420910000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> itertools\n\nsingle <span class="token operator">=</span> itertools<span class="token punctuation">.</span>product<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> repeat<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Single:  \'</span><span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">(</span>single<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\nmultiple <span class="token operator">=</span> itertools<span class="token punctuation">.</span>product<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Multiple:\'</span><span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">(</span>multiple<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nSingle<span class="token punctuation">:</span>   <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">]</span>\nMultiple<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">\'a\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">\'a\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">)</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="permutations"><a href="#permutations" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>permutations</h4>\n<p>permutations 会考虑源迭代器所能给出的全部元素，并逐个输出由其中 N 个元素形成的每种有序排列（permutation）方式，元素相同但顺序不同，算作两种排列。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="22462807983285703000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import itertools\n\nit = itertools.permutations([1, 2, 3, 4], 2)\nprint(list(it))\n\n>>>\n[(1, 2), (1, 3), (1, 4), (2, 1), (2, 3), (2, 4), (3, 1), (3, 2), (3, 4), (4, 1), (4, 2), (4, 3)]`, `22462807983285703000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> itertools\n\nit <span class="token operator">=</span> itertools<span class="token punctuation">.</span>permutations<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="combinations"><a href="#combinations" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>combinations</h4>\n<p>combinations 会考虑源迭代器所能给出的全部元素，并逐个输出由其中 N 个元素形成的每种无序组合（combination）方式，元素相同但顺序不同，算作同一种组合。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="3827276786936728600"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import itertools\n\nit = itertools.combinations([1, 2, 3, 4], 2)\nprint(list(it))\n\n>>>\n[(1, 2), (1, 3), (1, 4), (2, 3), (2, 4), (3, 4)]`, `3827276786936728600`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> itertools\n\nit <span class="token operator">=</span> itertools<span class="token punctuation">.</span>combinations<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="combinations_with_replacement"><a href="#combinations_with_replacement" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><code class="language-text">combinations_with_replacement</code></h4>\n<p><code class="language-text">combinations_with_replacement</code> 与 combinations 类似，但它允许同一个元素在组合里多次出现。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="71769799762678810000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import itertools\n\nit = itertools.combinations_with_replacement([1, 2, 3, 4], 2)\nprint(list(it))\n\n>>>\n[(1, 1), (1, 2), (1, 3), (1, 4), (2, 2), (2, 3), (2, 4), (3, 3), (3, 4), (4, 4)]`, `71769799762678810000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> itertools\n\nit <span class="token operator">=</span> itertools<span class="token punctuation">.</span>combinations_with_replacement<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="总结-32"><a href="#%E6%80%BB%E7%BB%93-32" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>itertools 包里面有三套函数可以拼装迭代器与生成器，它们分别能够连接多个迭代器，过滤源迭代器中的元素，以及用源迭代器中的元素合成新元素。</li>\n<li>通过 help(itertools) 查看文档，了解这些函数所支持的其他参数，以及许多更为高级的函数和实用的代码范例。</li>\n</ol>\n<h1 id="类与接口"><a href="#%E7%B1%BB%E4%B8%8E%E6%8E%A5%E5%8F%A3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>类与接口</h1>\n<h2 id="第-37-条：用组合起来的类来实现多层结构，不要用嵌套的内置类型"><a href="#%E7%AC%AC-37-%E6%9D%A1%EF%BC%9A%E7%94%A8%E7%BB%84%E5%90%88%E8%B5%B7%E6%9D%A5%E7%9A%84%E7%B1%BB%E6%9D%A5%E5%AE%9E%E7%8E%B0%E5%A4%9A%E5%B1%82%E7%BB%93%E6%9E%84%EF%BC%8C%E4%B8%8D%E8%A6%81%E7%94%A8%E5%B5%8C%E5%A5%97%E7%9A%84%E5%86%85%E7%BD%AE%E7%B1%BB%E5%9E%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 37 条：用组合起来的类来实现多层结构，不要用嵌套的内置类型</h2>\n<p>Python 内置的字典类型，很适合维护对象在生命期内的动态内部状态。所谓动态的（dynamic），是指我们无法获知那套状态会用到哪些标识符。例如，如果要用成绩册（Gradebook）记录学生的分数，而我们又没办法提前确定这些学生的名字，那么受到记录的每位学生与各自的分数，对于 Gradebook 对象来说，就属于动态的内部状态。为了实现这个需求，笔者定义下面这样一个类，让它把学生的名字当作键保存到 <code class="language-text">_grades</code> 字典中，因为我们无法提前确定要记录哪些学生，所以不能将每位学生的名字都设置成这个类的一项属性。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="74670822467790600000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class SimpleGradebook:\n\n    def __init__(self):\n        self._grades = {}\n\n    def add_student(self, name):\n        self._grades[name] = []\n\n    def report_grade(self, name, score):\n        self._grades[name].append(score)\n\n    def average_grade(self, name):\n        grades = self._grades[name]\n        return sum(grades) / len(grades)\n\n\nbook = SimpleGradebook()\nbook.add_student(\'Isaac Newton\')\nbook.report_grade(\'Isaac Newton\', 90)\nbook.report_grade(\'Isaac Newton\', 95)\nbook.report_grade(\'Isaac Newton\', 85)\n\nprint(book.average_grade(\'Isaac Newton\'))\n\n>>>\n90.0`, `74670822467790600000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">SimpleGradebook</span><span class="token punctuation">:</span>\n\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>_grades <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n\n    <span class="token keyword">def</span> <span class="token function">add_student</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>_grades<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n\n    <span class="token keyword">def</span> <span class="token function">report_grade</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> score<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>_grades<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>score<span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">average_grade</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        grades <span class="token operator">=</span> self<span class="token punctuation">.</span>_grades<span class="token punctuation">[</span>name<span class="token punctuation">]</span>\n        <span class="token keyword">return</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>grades<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>grades<span class="token punctuation">)</span>\n\n\nbook <span class="token operator">=</span> SimpleGradebook<span class="token punctuation">(</span><span class="token punctuation">)</span>\nbook<span class="token punctuation">.</span>add_student<span class="token punctuation">(</span><span class="token string">\'Isaac Newton\'</span><span class="token punctuation">)</span>\nbook<span class="token punctuation">.</span>report_grade<span class="token punctuation">(</span><span class="token string">\'Isaac Newton\'</span><span class="token punctuation">,</span> <span class="token number">90</span><span class="token punctuation">)</span>\nbook<span class="token punctuation">.</span>report_grade<span class="token punctuation">(</span><span class="token string">\'Isaac Newton\'</span><span class="token punctuation">,</span> <span class="token number">95</span><span class="token punctuation">)</span>\nbook<span class="token punctuation">.</span>report_grade<span class="token punctuation">(</span><span class="token string">\'Isaac Newton\'</span><span class="token punctuation">,</span> <span class="token number">85</span><span class="token punctuation">)</span>\n\n<span class="token keyword">print</span><span class="token punctuation">(</span>book<span class="token punctuation">.</span>average_grade<span class="token punctuation">(</span><span class="token string">\'Isaac Newton\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token number">90.0</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>字典与相关的内置类型用起来很方便，但同时也容易遭到滥用导致代码出问题。例如，我们现在要扩展这个 SimpleGradebook 类的功能，让它按照科目保存成绩，而不是把所有科目的成绩存在一起。通过修改 <code class="language-text">_grades</code> 字典的用法，使它必须把键（也就是学生的名字）与另一个小字典相对应，而不是像刚才那样，直接与列表对应起来。那份小字典以各科的名称作键与一份列表对应起来，以保存学生在这一科的全部考试成绩。这次笔者用 defaultdict 来实现这个小字典，这样可以方便地处理科目名称还不存在的那些情况（参见第 17 条）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="12490545598739278000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from collections import defaultdict\n\n\nclass BySubjectGradebook:\n    def __init__(self):\n        self._grades = {}  # Outer dict\n\n    def add_student(self, name):\n        self._grades[name] = defaultdict(list)  # Inner dict`, `12490545598739278000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> collections <span class="token keyword">import</span> defaultdict\n\n\n<span class="token keyword">class</span> <span class="token class-name">BySubjectGradebook</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>_grades <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>  <span class="token comment"># Outer dict</span>\n\n    <span class="token keyword">def</span> <span class="token function">add_student</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>_grades<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> defaultdict<span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">)</span>  <span class="token comment"># Inner dict</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>程序写到现在，还算比较直观。但是接下来，我们要编写 <code class="language-text">report_grade</code> 方法来记录某位学生在某科目上的一次成绩，并且要写 <code class="language-text">average_grade</code> 方法计算某位学生所有科目的平均成绩。这两个方法写起来就稍微有点复杂了，因为必须处理多层嵌套的字典结构，不过，这似乎还在可以把握的范围内。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="15512689448284856000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from collections import defaultdict\n\n\nclass BySubjectGradebook:\n    def __init__(self):\n        self._grades = {}  # Outer dict\n\n    def add_student(self, name):\n        self._grades[name] = defaultdict(list)  # Inner dict\n\n    def report_grade(self, name, subject, grade):\n        by_subject = self._grades[name]\n        grade_list = by_subject[subject]\n        grade_list.append(grade)\n\n    def average_grade(self, name):\n        by_subject = self._grades[name]\n        total, count = 0, 0\n        for grades in by_subject.values():\n            total += sum(grades)\n            count += len(grades)\n        return total / count`, `15512689448284856000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py{11-22}"\n              >\n                <span class="gatsby-code-button-language">py{11-22}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> collections <span class="token keyword">import</span> defaultdict\n\n\n<span class="token keyword">class</span> <span class="token class-name">BySubjectGradebook</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>_grades <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>  <span class="token comment"># Outer dict</span>\n\n    <span class="token keyword">def</span> <span class="token function">add_student</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>_grades<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> defaultdict<span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">)</span>  <span class="token comment"># Inner dict</span>\n\n<span class="gatsby-highlight-code-line">    <span class="token keyword">def</span> <span class="token function">report_grade</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> subject<span class="token punctuation">,</span> grade<span class="token punctuation">)</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">        by_subject <span class="token operator">=</span> self<span class="token punctuation">.</span>_grades<span class="token punctuation">[</span>name<span class="token punctuation">]</span></span><span class="gatsby-highlight-code-line">        grade_list <span class="token operator">=</span> by_subject<span class="token punctuation">[</span>subject<span class="token punctuation">]</span></span><span class="gatsby-highlight-code-line">        grade_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>grade<span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line">    <span class="token keyword">def</span> <span class="token function">average_grade</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">        by_subject <span class="token operator">=</span> self<span class="token punctuation">.</span>_grades<span class="token punctuation">[</span>name<span class="token punctuation">]</span></span><span class="gatsby-highlight-code-line">        total<span class="token punctuation">,</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span></span><span class="gatsby-highlight-code-line">        <span class="token keyword">for</span> grades <span class="token keyword">in</span> by_subject<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">            total <span class="token operator">+=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>grades<span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line">            count <span class="token operator">+=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>grades<span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line">        <span class="token keyword">return</span> total <span class="token operator">/</span> count</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>扩展后的类，用起来依然比较容易。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="70077726818463100000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`book = BySubjectGradebook()\nbook.add_student(\'Albert Einstein\')\nbook.report_grade(\'Albert Einstein\', \'Math\', 75)\nbook.report_grade(\'Albert Einstein\', \'Math\', 65)\nbook.report_grade(\'Albert Einstein\', \'Gym\', 90)\nbook.report_grade(\'Albert Einstein\', \'Gym\', 95)\nprint(book.average_grade(\'Albert Einstein\'))\n\n>>>\n81.25`, `70077726818463100000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">book <span class="token operator">=</span> BySubjectGradebook<span class="token punctuation">(</span><span class="token punctuation">)</span>\nbook<span class="token punctuation">.</span>add_student<span class="token punctuation">(</span><span class="token string">\'Albert Einstein\'</span><span class="token punctuation">)</span>\nbook<span class="token punctuation">.</span>report_grade<span class="token punctuation">(</span><span class="token string">\'Albert Einstein\'</span><span class="token punctuation">,</span> <span class="token string">\'Math\'</span><span class="token punctuation">,</span> <span class="token number">75</span><span class="token punctuation">)</span>\nbook<span class="token punctuation">.</span>report_grade<span class="token punctuation">(</span><span class="token string">\'Albert Einstein\'</span><span class="token punctuation">,</span> <span class="token string">\'Math\'</span><span class="token punctuation">,</span> <span class="token number">65</span><span class="token punctuation">)</span>\nbook<span class="token punctuation">.</span>report_grade<span class="token punctuation">(</span><span class="token string">\'Albert Einstein\'</span><span class="token punctuation">,</span> <span class="token string">\'Gym\'</span><span class="token punctuation">,</span> <span class="token number">90</span><span class="token punctuation">)</span>\nbook<span class="token punctuation">.</span>report_grade<span class="token punctuation">(</span><span class="token string">\'Albert Einstein\'</span><span class="token punctuation">,</span> <span class="token string">\'Gym\'</span><span class="token punctuation">,</span> <span class="token number">95</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>book<span class="token punctuation">.</span>average_grade<span class="token punctuation">(</span><span class="token string">\'Albert Einstein\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token number">81.25</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在假设需求又变了，我们还要记录每次考试在科目里的权重（weight），因为期中考试与期末考试及随堂举行的临时考试（pop quiz）在总成绩里占的比例是不同的。实现这项功能的一种办法是改变里面那个小字典的用法，让它不要把成绩（score）直接添加到与键名（也就科目名称）相对应的那份列表里，而是先用成绩与权重构造元组，然后把（score, weight）形式的元组添加到列表里。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="27206873039697953000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from collections import defaultdict\n\n\nclass WeightedGradebook:\n    def __init__(self):\n        self._grades = {}\n\n    def add_student(self, name):\n        self._grades[name] = defaultdict(list)\n\n    def report_grade(self, name, subject, score, weight):\n        by_subject = self._grades[name]\n        grade_list = by_subject[subject]\n        grade_list.append((score, weight))`, `27206873039697953000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> collections <span class="token keyword">import</span> defaultdict\n\n\n<span class="token keyword">class</span> <span class="token class-name">WeightedGradebook</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>_grades <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n\n    <span class="token keyword">def</span> <span class="token function">add_student</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>_grades<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> defaultdict<span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">report_grade</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> subject<span class="token punctuation">,</span> score<span class="token punctuation">,</span> weight<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        by_subject <span class="token operator">=</span> self<span class="token punctuation">.</span>_grades<span class="token punctuation">[</span>name<span class="token punctuation">]</span>\n        grade_list <span class="token operator">=</span> by_subject<span class="token punctuation">[</span>subject<span class="token punctuation">]</span>\n        grade_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>score<span class="token punctuation">,</span> weight<span class="token punctuation">)</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><code class="language-text">report_grade</code> 方法改起来似乎挺简单的，只需要把原来的成绩变为带权重的元组保存到列表里面即可。但是 <code class="language-text">average_grade</code> 方法就比较难懂了，因为我们必须在循环里面再嵌套一个循环。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="27673540321402100000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from collections import defaultdict\n\n\nclass WeightedGradebook:\n    def __init__(self):\n        self._grades = {}\n\n    def add_student(self, name):\n        self._grades[name] = defaultdict(list)\n\n    def report_grade(self, name, subject, score, weight):\n        by_subject = self._grades[name]\n        grade_list = by_subject[subject]\n        grade_list.append((score, weight))\n\n    def average_grade(self, name):\n        by_subject = self._grades[name]\n        score_sum, score_count = 0, 0\n        for subject, scores in by_subject.items():\n            subject_avg, total_weight = 0, 0\n            for score, weight in scores:\n                subject_avg += score * weight\n                total_weight += weight\n\n            score_sum += subject_avg / total_weight\n            score_count += 1\n        return score_sum / score_count\n\n\nbook = WeightedGradebook()\nbook.add_student(\'Albert Einstein\')\nbook.report_grade(\'Albert Einstein\', \'Math\', 75, 0.05)\nbook.report_grade(\'Albert Einstein\', \'Math\', 65, 0.15)\nbook.report_grade(\'Albert Einstein\', \'Math\', 70, 0.80)\nbook.report_grade(\'Albert Einstein\', \'Gym\', 100, 0.40)\nbook.report_grade(\'Albert Einstein\', \'Gym\', 85, 0.60)\nprint(book.average_grade(\'Albert Einstein\'))\n\n>>>\n80.25`, `27673540321402100000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> collections <span class="token keyword">import</span> defaultdict\n\n\n<span class="token keyword">class</span> <span class="token class-name">WeightedGradebook</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>_grades <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n\n    <span class="token keyword">def</span> <span class="token function">add_student</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>_grades<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> defaultdict<span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">report_grade</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> subject<span class="token punctuation">,</span> score<span class="token punctuation">,</span> weight<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        by_subject <span class="token operator">=</span> self<span class="token punctuation">.</span>_grades<span class="token punctuation">[</span>name<span class="token punctuation">]</span>\n        grade_list <span class="token operator">=</span> by_subject<span class="token punctuation">[</span>subject<span class="token punctuation">]</span>\n        grade_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>score<span class="token punctuation">,</span> weight<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">average_grade</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        by_subject <span class="token operator">=</span> self<span class="token punctuation">.</span>_grades<span class="token punctuation">[</span>name<span class="token punctuation">]</span>\n        score_sum<span class="token punctuation">,</span> score_count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span>\n        <span class="token keyword">for</span> subject<span class="token punctuation">,</span> scores <span class="token keyword">in</span> by_subject<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            subject_avg<span class="token punctuation">,</span> total_weight <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span>\n            <span class="token keyword">for</span> score<span class="token punctuation">,</span> weight <span class="token keyword">in</span> scores<span class="token punctuation">:</span>\n                subject_avg <span class="token operator">+=</span> score <span class="token operator">*</span> weight\n                total_weight <span class="token operator">+=</span> weight\n\n            score_sum <span class="token operator">+=</span> subject_avg <span class="token operator">/</span> total_weight\n            score_count <span class="token operator">+=</span> <span class="token number">1</span>\n        <span class="token keyword">return</span> score_sum <span class="token operator">/</span> score_count\n\n\nbook <span class="token operator">=</span> WeightedGradebook<span class="token punctuation">(</span><span class="token punctuation">)</span>\nbook<span class="token punctuation">.</span>add_student<span class="token punctuation">(</span><span class="token string">\'Albert Einstein\'</span><span class="token punctuation">)</span>\nbook<span class="token punctuation">.</span>report_grade<span class="token punctuation">(</span><span class="token string">\'Albert Einstein\'</span><span class="token punctuation">,</span> <span class="token string">\'Math\'</span><span class="token punctuation">,</span> <span class="token number">75</span><span class="token punctuation">,</span> <span class="token number">0.05</span><span class="token punctuation">)</span>\nbook<span class="token punctuation">.</span>report_grade<span class="token punctuation">(</span><span class="token string">\'Albert Einstein\'</span><span class="token punctuation">,</span> <span class="token string">\'Math\'</span><span class="token punctuation">,</span> <span class="token number">65</span><span class="token punctuation">,</span> <span class="token number">0.15</span><span class="token punctuation">)</span>\nbook<span class="token punctuation">.</span>report_grade<span class="token punctuation">(</span><span class="token string">\'Albert Einstein\'</span><span class="token punctuation">,</span> <span class="token string">\'Math\'</span><span class="token punctuation">,</span> <span class="token number">70</span><span class="token punctuation">,</span> <span class="token number">0.80</span><span class="token punctuation">)</span>\nbook<span class="token punctuation">.</span>report_grade<span class="token punctuation">(</span><span class="token string">\'Albert Einstein\'</span><span class="token punctuation">,</span> <span class="token string">\'Gym\'</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">0.40</span><span class="token punctuation">)</span>\nbook<span class="token punctuation">.</span>report_grade<span class="token punctuation">(</span><span class="token string">\'Albert Einstein\'</span><span class="token punctuation">,</span> <span class="token string">\'Gym\'</span><span class="token punctuation">,</span> <span class="token number">85</span><span class="token punctuation">,</span> <span class="token number">0.60</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>book<span class="token punctuation">.</span>average_grade<span class="token punctuation">(</span><span class="token string">\'Albert Einstein\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token number">80.25</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这个类用起来也变得困难了，因为单看代码很难知道 <code class="language-text">report_grade</code> 里面那些数字形式的位置参数表示什么意思。</p>\n<p>如果遇到的是类似这种比较复杂的需求，那么不要再嵌套字典、元组、集合、列表等内置的类型了，而是应该编写一批新类并让这些类形成一套体系。</p>\n<p>拿这个成绩册的例子来说，一开始我们并不知道后来要考虑成绩权重，所以那个时候似乎没有必要专门创建这样一套类体系。后来，当要纳入权重因素时，有人认为，这可以继续通过 Python 内置的字典与元组来实现，因为只不过是要给保存内部状态的那个结构多添加一层而已。所以，才有了刚才那种复杂的写法。其实，在需要分科目统计成绩时，就不应该继续嵌套下去了，那样会让字典里出现小字典，而小字典里又会出现列表。这种超过两层的嵌套结构，其他开发者很难看懂，而且后面维护起来也很麻烦。</p>\n<p>只要发现记录内部状态的代码开始变得复杂起来，就应该及时把这些代码拆分到多个类里。这样可以定义良好的接口，并且能够合理地封装数据。这种写法可以在接口与具体实现之间创建一层抽象。</p>\n<h3 id="把多层嵌套的内置类型重构为类体系"><a href="#%E6%8A%8A%E5%A4%9A%E5%B1%82%E5%B5%8C%E5%A5%97%E7%9A%84%E5%86%85%E7%BD%AE%E7%B1%BB%E5%9E%8B%E9%87%8D%E6%9E%84%E4%B8%BA%E7%B1%BB%E4%BD%93%E7%B3%BB" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>把多层嵌套的内置类型重构为类体系</h3>\n<p>有很多种办法可以实现重构（除了这里讲的这种，第 89 条还讲了另一种）。笔者这里采用的办法是，先从依赖树的最底层做起，也就是考虑怎么记录某科目的单次考试成绩与权重。这么简单的一条信息，似乎没必要专门写一个类来记录。由于分数不需要修改，因此元组已经足够用了。下面以（score, weight）形式的元组来记录单次考试成绩，并把这种元素添加到列表里面。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="29092886578222510000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`grades = []\ngrades.append((95, 0.45))\ngrades.append((85, 0.55))\ntotal = sum(score * weight for score, weight in grades)\ntotal_weight = sum(weight for _, weight in grades)\naverage_grade = total / total_weight`, `29092886578222510000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">grades <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\ngrades<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">95</span><span class="token punctuation">,</span> <span class="token number">0.45</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\ngrades<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">85</span><span class="token punctuation">,</span> <span class="token number">0.55</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\ntotal <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>score <span class="token operator">*</span> weight <span class="token keyword">for</span> score<span class="token punctuation">,</span> weight <span class="token keyword">in</span> grades<span class="token punctuation">)</span>\ntotal_weight <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>weight <span class="token keyword">for</span> _<span class="token punctuation">,</span> weight <span class="token keyword">in</span> grades<span class="token punctuation">)</span>\naverage_grade <span class="token operator">=</span> total <span class="token operator">/</span> total_weight</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>汇总每次考试的权重之和（<code class="language-text">total * weight</code>）时，不需要关注具体的成绩，所以在 <code class="language-text">for ... in ...</code> 结构中用下划线（<code class="language-text">*</code>）表示元组中的 score 那一部分，表示计算时忽略它。</p>\n<p>这种写法的问题在于，元组里的元素只能通过位置区分。例如，如果还要把老师的评语记在每次考试的成绩旁边，那么早前使用二元组的那些代码就全都需要修改，因为现在必须采用包含三个元素的元组才行。另外，统计成绩之和与权重之和时，还得分别用一个下划线跳过每个三元组里面表示评语的那一部分。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="36762551549616740000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`grades = []\ngrades.append((95, 0.45, \'Great job\'))\ngrades.append((85, 0.55, \'Better next time\'))\ntotal = sum(score * weight for score, weight, _ in grades)\ntotal_weight = sum(weight for _, weight, _ in grades)\naverage_grade = total / total_weight`, `36762551549616740000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">grades <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\ngrades<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">95</span><span class="token punctuation">,</span> <span class="token number">0.45</span><span class="token punctuation">,</span> <span class="token string">\'Great job\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\ngrades<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">85</span><span class="token punctuation">,</span> <span class="token number">0.55</span><span class="token punctuation">,</span> <span class="token string">\'Better next time\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\ntotal <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>score <span class="token operator">*</span> weight <span class="token keyword">for</span> score<span class="token punctuation">,</span> weight<span class="token punctuation">,</span> _ <span class="token keyword">in</span> grades<span class="token punctuation">)</span>\ntotal_weight <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>weight <span class="token keyword">for</span> _<span class="token punctuation">,</span> weight<span class="token punctuation">,</span> _ <span class="token keyword">in</span> grades<span class="token punctuation">)</span>\naverage_grade <span class="token operator">=</span> total <span class="token operator">/</span> total_weight</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>元组拖得太长，就跟字典套得太深一样，都不好维护。所以只要发现元组里的元素超过两个，就应该考虑其他办法了。</p>\n<p>Python 内置的 collections 模块里有个具名元组（namedtuple）类型，恰好可以满足这样的需求，这种类型很容易就能定义出小型的类以表示不可变的数据。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="80294821171227600000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from collections import namedtuple\n\nGrade = namedtuple(\'Grade\', (\'score\', \'weight\'))`, `80294821171227600000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> collections <span class="token keyword">import</span> namedtuple\n\nGrade <span class="token operator">=</span> namedtuple<span class="token punctuation">(</span><span class="token string">\'Grade\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">\'score\'</span><span class="token punctuation">,</span> <span class="token string">\'weight\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>这样的类，既可以通过位置参数构造，也可以用关键字参数来创建。每个属性都有名字，因此可以根据属性名称访问字段，如果将来需求发生变化（例如需要修改数据，或是要转变成一个简单的数据容器），也很容易就能把这种 namedtuple 改写成普通的类。</p>\n<h3 id="namedtuple-的局限"><a href="#namedtuple-%E7%9A%84%E5%B1%80%E9%99%90" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>namedtuple 的局限</h3>\n<p>虽然 namedtuple 可以用于许多场合，但我们一定要知道在哪些情况下不适合用它。</p>\n<ol>\n<li>namedtuple 类无法指定默认的参数值。如果数据的可选属性比较多，那么采用这种类来表示，会很不方便。在属性较多的情况下，应该改用内置的 dataclasses 模块实现。</li>\n<li>namedtuple 实例的属性值仍然可以通过数字下标与迭代来访问，所以可能还是会有人（尤其是那些通过你发布的 API 来编程的人）会采用这种方式访问这些属性，这样的话，将来就不太容易把它转成普通的类了。如果无法完全控制这些 namedtuple 实例的用法，那么最好还是明确定义一个新的类。</li>\n</ol>\n<p>有了叫作 Grade 的具名元组，我们就可以写出表示科目的 Subject 类，让它容纳许多个这样的元组。</p>\n<p>然后，就可以写一个表示学生的 Student 类，用它来记录某位学生各科目（Subject）的考试成绩。</p>\n<p>最后，写这样一个表示成绩册的 Gradebook 容器类，把每位学生的名字与表示这位学生的 Student 对象关联起来，如果成绩册里还没有记录过这位学生，那么在调用 <code class="language-text">get_student</code> 方法时，Gradebook 就会构造一个默认的 Student 对象给调用者使用。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="12648221091324307000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from collections import namedtuple, defaultdict\n\nGrade = namedtuple(\'Grade\', (\'score\', \'weight\'))\n\n\nclass Subject:\n    def __init__(self):\n        self._grades = []\n\n    def report_grade(self, score, weight):\n        self._grades.append(Grade(score, weight))\n\n    def average_grade(self):\n        total, total_weight = 0, 0\n        for grade in self._grades:\n            total += grade.score * grade.weight\n            total_weight += grade.weight\n        return total / total_weight\n\n\nclass Student:\n    def __init__(self):\n        self._subjects = defaultdict(Subject)\n\n    def get_subject(self, name):\n        return self._subjects[name]\n\n    def average_grade(self):\n        total, count = 0, 0\n        for subject in self._subjects.values():\n            total += subject.average_grade()\n            count += 1\n        return total / count\n\n\nclass Gradebook:\n    def __init__(self):\n        self._students = defaultdict(Student)\n\n    def get_student(self, name):\n        return self._students[name]\n\n\nbook = Gradebook()\nalbert = book.get_student(\'Albert Einstein\')\nmath = albert.get_subject(\'Math\')\nmath.report_grade(75, 0.05)\nmath.report_grade(65, 0.15)\nmath.report_grade(70, 0.80)\ngym = albert.get_subject(\'Gym\')\ngym.report_grade(100, 0.40)\ngym.report_grade(85, 0.60)\nprint(albert.average_grade())\n\n>>>\n80.25`, `12648221091324307000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> collections <span class="token keyword">import</span> namedtuple<span class="token punctuation">,</span> defaultdict\n\nGrade <span class="token operator">=</span> namedtuple<span class="token punctuation">(</span><span class="token string">\'Grade\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">\'score\'</span><span class="token punctuation">,</span> <span class="token string">\'weight\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">Subject</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>_grades <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n\n    <span class="token keyword">def</span> <span class="token function">report_grade</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> score<span class="token punctuation">,</span> weight<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>_grades<span class="token punctuation">.</span>append<span class="token punctuation">(</span>Grade<span class="token punctuation">(</span>score<span class="token punctuation">,</span> weight<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">average_grade</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        total<span class="token punctuation">,</span> total_weight <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span>\n        <span class="token keyword">for</span> grade <span class="token keyword">in</span> self<span class="token punctuation">.</span>_grades<span class="token punctuation">:</span>\n            total <span class="token operator">+=</span> grade<span class="token punctuation">.</span>score <span class="token operator">*</span> grade<span class="token punctuation">.</span>weight\n            total_weight <span class="token operator">+=</span> grade<span class="token punctuation">.</span>weight\n        <span class="token keyword">return</span> total <span class="token operator">/</span> total_weight\n\n\n<span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>_subjects <span class="token operator">=</span> defaultdict<span class="token punctuation">(</span>Subject<span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">get_subject</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_subjects<span class="token punctuation">[</span>name<span class="token punctuation">]</span>\n\n    <span class="token keyword">def</span> <span class="token function">average_grade</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        total<span class="token punctuation">,</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span>\n        <span class="token keyword">for</span> subject <span class="token keyword">in</span> self<span class="token punctuation">.</span>_subjects<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            total <span class="token operator">+=</span> subject<span class="token punctuation">.</span>average_grade<span class="token punctuation">(</span><span class="token punctuation">)</span>\n            count <span class="token operator">+=</span> <span class="token number">1</span>\n        <span class="token keyword">return</span> total <span class="token operator">/</span> count\n\n\n<span class="token keyword">class</span> <span class="token class-name">Gradebook</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>_students <span class="token operator">=</span> defaultdict<span class="token punctuation">(</span>Student<span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">get_student</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_students<span class="token punctuation">[</span>name<span class="token punctuation">]</span>\n\n\nbook <span class="token operator">=</span> Gradebook<span class="token punctuation">(</span><span class="token punctuation">)</span>\nalbert <span class="token operator">=</span> book<span class="token punctuation">.</span>get_student<span class="token punctuation">(</span><span class="token string">\'Albert Einstein\'</span><span class="token punctuation">)</span>\nmath <span class="token operator">=</span> albert<span class="token punctuation">.</span>get_subject<span class="token punctuation">(</span><span class="token string">\'Math\'</span><span class="token punctuation">)</span>\nmath<span class="token punctuation">.</span>report_grade<span class="token punctuation">(</span><span class="token number">75</span><span class="token punctuation">,</span> <span class="token number">0.05</span><span class="token punctuation">)</span>\nmath<span class="token punctuation">.</span>report_grade<span class="token punctuation">(</span><span class="token number">65</span><span class="token punctuation">,</span> <span class="token number">0.15</span><span class="token punctuation">)</span>\nmath<span class="token punctuation">.</span>report_grade<span class="token punctuation">(</span><span class="token number">70</span><span class="token punctuation">,</span> <span class="token number">0.80</span><span class="token punctuation">)</span>\ngym <span class="token operator">=</span> albert<span class="token punctuation">.</span>get_subject<span class="token punctuation">(</span><span class="token string">\'Gym\'</span><span class="token punctuation">)</span>\ngym<span class="token punctuation">.</span>report_grade<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">0.40</span><span class="token punctuation">)</span>\ngym<span class="token punctuation">.</span>report_grade<span class="token punctuation">(</span><span class="token number">85</span><span class="token punctuation">,</span> <span class="token number">0.60</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>albert<span class="token punctuation">.</span>average_grade<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token number">80.25</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这些类的代码所占篇幅，虽然比原来那种写法长了一倍，但理解起来却要容易得多。而且用这些类写出来的调用代码，也比原来更清晰、更便于扩展。</p>\n<p>另外，还可以提供一些向后兼容的方法，帮助大家把采用旧式 API 所写的代码迁移到这种通过对象体系所设计的方案之中。</p>\n<h3 id="总结-33"><a href="#%E6%80%BB%E7%BB%93-33" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>不要在字典里嵌套字典、长元组，以及用其他内置类型构造的复杂结构。</li>\n<li>namedtuple 能够实现出轻量级的容器，以存放不可变的数据，而且将来可以灵活地转化成普通的类。</li>\n<li>如果发现用字典来维护内部状态的那些代码已经越写越复杂了，那么就应该考虑改用多个类来实现。</li>\n</ol>\n<h2 id="第-38-条：让简单的接口接受函数，而不是类的实例"><a href="#%E7%AC%AC-38-%E6%9D%A1%EF%BC%9A%E8%AE%A9%E7%AE%80%E5%8D%95%E7%9A%84%E6%8E%A5%E5%8F%A3%E6%8E%A5%E5%8F%97%E5%87%BD%E6%95%B0%EF%BC%8C%E8%80%8C%E4%B8%8D%E6%98%AF%E7%B1%BB%E7%9A%84%E5%AE%9E%E4%BE%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 38 条：让简单的接口接受函数，而不是类的实例</h2>\n<p>Python 有许多内置的 API，都允许我们传入某个函数来定制它的行为。这种函数可以叫作挂钩（hook），API 在执行过程中，会回调（call back）这些挂钩函数。例如，list 类型的 sort 方法就带有可选的 key 参数，如果明确指定了这个参数，那么它就会按照你提供的挂钩函数来决定列表中每个元素的先后顺序（参见第 14 条）。下面的代码把内置的 len 函数当成挂钩传给 key 参数，让 sort 方法根据长度排列这些名字。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="39152883759757980000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`names = [\'Socrates\', \'Archimedes\', \'Plato\', \'Aristotle\']\nnames.sort(key=len)\nprint(names)\n\n>>>\n[\'Plato\', \'Socrates\', \'Aristotle\', \'Archimedes\']`, `39152883759757980000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">names <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'Socrates\'</span><span class="token punctuation">,</span> <span class="token string">\'Archimedes\'</span><span class="token punctuation">,</span> <span class="token string">\'Plato\'</span><span class="token punctuation">,</span> <span class="token string">\'Aristotle\'</span><span class="token punctuation">]</span>\nnames<span class="token punctuation">.</span>sort<span class="token punctuation">(</span>key<span class="token operator">=</span><span class="token builtin">len</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>names<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">[</span><span class="token string">\'Plato\'</span><span class="token punctuation">,</span> <span class="token string">\'Socrates\'</span><span class="token punctuation">,</span> <span class="token string">\'Aristotle\'</span><span class="token punctuation">,</span> <span class="token string">\'Archimedes\'</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在其他编程语言中，挂钩可能会用抽象类（abstract class）来定义。但在 Python 中，许多挂钩都是无状态的函数（stateless function），带有明确的参数与返回值。挂钩用函数来描述，要比定义成类更简单。用作挂钩的函数与别的函数一样，都是 Python 里的头等（first-class）对象，也就是说，这些函数与方法可以像 Python 中其他值那样传递与引用。</p>\n<p>例如，我们要定制 defaultdict 类的行为（相关的知识，参见第 17 条）。这种 defaultdict 数据结构允许调用者提供一个函数，用来在键名缺失的情况下，创建与这个键相对应的值。只要字典发现调用者想要访问的键不存在，就会触发这个函数，以返回应该与键相关联的默认值。下面定义一个 <code class="language-text">log_missing</code> 函数作为键名缺失时的挂钩，该函数总是会把这种键的默认值设为 0。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="37880952730041460000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def log_missing():\n    print(\'Key added\')\n    return 0`, `37880952730041460000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">log_missing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Key added\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">return</span> <span class="token number">0</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>下面这段代码通过定制的 defaultdict 字典，把 increments 列表里面描述的增量添加到 current 这个普通字典所提供的初始量上面，但字典里一开始没有 red 和 orange 这两个键，因此 <code class="language-text">log_missing</code> 这个挂钩函数会触发两次，每次它都会打印 Key added 信息。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="81772434066918470000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from collections import defaultdict\n\n\ndef log_missing():\n    print(\'Key added\')\n    return 0\n\n\ncurrent = {\'green\': 12, \'blue\': 3}\nincrements = [\n    (\'red\', 5),\n    (\'blue\', 17),\n    (\'orange\', 9),\n]\nresult = defaultdict(log_missing, current)\nprint(\'Before:\', dict(result))\nfor key, amount in increments:\n    result[key] += amount\nprint(\'After:\', dict(result))\n\n>>>\nBefore: {\'green\': 12, \'blue\': 3}\nKey added\nKey added\nAfter: {\'green\': 12, \'blue\': 20, \'red\': 5, \'orange\': 9}`, `81772434066918470000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> collections <span class="token keyword">import</span> defaultdict\n\n\n<span class="token keyword">def</span> <span class="token function">log_missing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Key added\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">return</span> <span class="token number">0</span>\n\n\ncurrent <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">\'green\'</span><span class="token punctuation">:</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token string">\'blue\'</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">}</span>\nincrements <span class="token operator">=</span> <span class="token punctuation">[</span>\n    <span class="token punctuation">(</span><span class="token string">\'red\'</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token punctuation">(</span><span class="token string">\'blue\'</span><span class="token punctuation">,</span> <span class="token number">17</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token punctuation">(</span><span class="token string">\'orange\'</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n<span class="token punctuation">]</span>\nresult <span class="token operator">=</span> defaultdict<span class="token punctuation">(</span>log_missing<span class="token punctuation">,</span> current<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Before:\'</span><span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">for</span> key<span class="token punctuation">,</span> amount <span class="token keyword">in</span> increments<span class="token punctuation">:</span>\n    result<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">+=</span> amount\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'After:\'</span><span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nBefore<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">\'green\'</span><span class="token punctuation">:</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token string">\'blue\'</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">}</span>\nKey added\nKey added\nAfter<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">\'green\'</span><span class="token punctuation">:</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token string">\'blue\'</span><span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token string">\'red\'</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">\'orange\'</span><span class="token punctuation">:</span> <span class="token number">9</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>通过 <code class="language-text">log_missing</code> 这样的挂钩函数，我们很容易构建出便于测试的 API，这种 API 可以把挂钩所实现的附加效果（side effect）与数据本身所应具备的确定行为分开。例如，假设我们要在传给 defaultdict 的挂钩里面，统计它总共遇到了多少次键名缺失的情况。要实现这项功能，其中一个办法是采用有状态的闭包（stateful closure，参见第 21 条）。下面就定义一个辅助函数，把 missing 闭包当作挂钩传给 defaultdict 字典，以便为缺失的键提供默认值。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="34810769189768440000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def increment_with_report(current, increments):\n    added_count = 0\n\n    def missing():\n        nonlocal added_count  # Stateful closure\n        added_count += 1\n        return 0\n\n    result = defaultdict(missing, current)\n    for key, amount in increments:\n        result[key] += amount\n\n    return result, added_count`, `34810769189768440000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">increment_with_report</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> increments<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    added_count <span class="token operator">=</span> <span class="token number">0</span>\n\n    <span class="token keyword">def</span> <span class="token function">missing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">nonlocal</span> added_count  <span class="token comment"># Stateful closure</span>\n        added_count <span class="token operator">+=</span> <span class="token number">1</span>\n        <span class="token keyword">return</span> <span class="token number">0</span>\n\n    result <span class="token operator">=</span> defaultdict<span class="token punctuation">(</span>missing<span class="token punctuation">,</span> current<span class="token punctuation">)</span>\n    <span class="token keyword">for</span> key<span class="token punctuation">,</span> amount <span class="token keyword">in</span> increments<span class="token punctuation">:</span>\n        result<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">+=</span> amount\n\n    <span class="token keyword">return</span> result<span class="token punctuation">,</span> added_count</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>运行这个辅助函数处理前面的数据，可以得到预期的结果（可以看到，键名缺失的情况确实出现了两次，函数返回的 count 值也为 2）。统计键名缺失次数所用的 <code class="language-text">added_count</code> 状态是由 missing 挂钩维护的，采用挂钩来运作的 defaultdict 字典并不需要关注这个细节。于是，这就体现了把简单函数传给接口的另一个好处，也就是方便稍后添加新的功能，因为我们可以把实现这项功能所用的状态隐藏在这个简单的闭包里面。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="62940010064219365000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from collections import defaultdict\n\n\ndef increment_with_report(current, increments):\n    added_count = 0\n\n    def missing():\n        nonlocal added_count  # Stateful closure\n        added_count += 1\n        return 0\n\n    result = defaultdict(missing, current)\n    for key, amount in increments:\n        result[key] += amount\n\n    return result, added_count\n\n\ncurrent = {\'green\': 12, \'blue\': 3}\nincrements = [\n    (\'red\', 5),\n    (\'blue\', 17),\n    (\'orange\', 9),\n]\nresult, count = increment_with_report(current, increments)\nassert count == 2`, `62940010064219365000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py{25-26}"\n              >\n                <span class="gatsby-code-button-language">py{25-26}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> collections <span class="token keyword">import</span> defaultdict\n\n\n<span class="token keyword">def</span> <span class="token function">increment_with_report</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> increments<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    added_count <span class="token operator">=</span> <span class="token number">0</span>\n\n    <span class="token keyword">def</span> <span class="token function">missing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">nonlocal</span> added_count  <span class="token comment"># Stateful closure</span>\n        added_count <span class="token operator">+=</span> <span class="token number">1</span>\n        <span class="token keyword">return</span> <span class="token number">0</span>\n\n    result <span class="token operator">=</span> defaultdict<span class="token punctuation">(</span>missing<span class="token punctuation">,</span> current<span class="token punctuation">)</span>\n    <span class="token keyword">for</span> key<span class="token punctuation">,</span> amount <span class="token keyword">in</span> increments<span class="token punctuation">:</span>\n        result<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">+=</span> amount\n\n    <span class="token keyword">return</span> result<span class="token punctuation">,</span> added_count\n\n\ncurrent <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">\'green\'</span><span class="token punctuation">:</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token string">\'blue\'</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">}</span>\nincrements <span class="token operator">=</span> <span class="token punctuation">[</span>\n    <span class="token punctuation">(</span><span class="token string">\'red\'</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token punctuation">(</span><span class="token string">\'blue\'</span><span class="token punctuation">,</span> <span class="token number">17</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token punctuation">(</span><span class="token string">\'orange\'</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n<span class="token punctuation">]</span>\n<span class="gatsby-highlight-code-line">result<span class="token punctuation">,</span> count <span class="token operator">=</span> increment_with_report<span class="token punctuation">(</span>current<span class="token punctuation">,</span> increments<span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">assert</span> count <span class="token operator">==</span> <span class="token number">2</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>与无状态的闭包函数相比，用有状态的闭包作为挂钩写出来的代码会难懂一些。为了让代码更清晰，可以专门定义一个小类，把原本由闭包所维护的状态给封装起来。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="96964833936177680000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class CountMissing:\n    def __init__(self):\n        self.added = 0\n\n    def missing(self):\n        self.added += 1\n        return 0`, `96964833936177680000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">CountMissing</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>added <span class="token operator">=</span> <span class="token number">0</span>\n\n    <span class="token keyword">def</span> <span class="token function">missing</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>added <span class="token operator">+=</span> <span class="token number">1</span>\n        <span class="token keyword">return</span> <span class="token number">0</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在其他编程语言中，可能需要修改 defaultdict 以便与 CountMissing 接口相适应。但在 Python 中，方法与函数都是头等的（first-class）对象，因此可以直接通过对象引用它所属的 CountMissing 类里的 missing 方法，并把这个方法传给 defaultdict 充当挂钩，让字典可以用这个挂钩制作默认值。在 Python 中，这种通过对象实例而引用的方法，很容易就能满足函数的接口</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="45983038647695610000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from collections import defaultdict\n\n\nclass CountMissing:\n    def __init__(self):\n        self.added = 0\n\n    def missing(self):\n        self.added += 1\n        return 0\n\n\ncurrent = {\'green\': 12, \'blue\': 3}\nincrements = [\n    (\'red\', 5),\n    (\'blue\', 17),\n    (\'orange\', 9),\n]\ncounter = CountMissing()\nresult = defaultdict(counter.missing, current)  # Method ref\nfor key, amount in increments:\n    result[key] += amount\nassert counter.added == 2`, `45983038647695610000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py{19-23}"\n              >\n                <span class="gatsby-code-button-language">py{19-23}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> collections <span class="token keyword">import</span> defaultdict\n\n\n<span class="token keyword">class</span> <span class="token class-name">CountMissing</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>added <span class="token operator">=</span> <span class="token number">0</span>\n\n    <span class="token keyword">def</span> <span class="token function">missing</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>added <span class="token operator">+=</span> <span class="token number">1</span>\n        <span class="token keyword">return</span> <span class="token number">0</span>\n\n\ncurrent <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">\'green\'</span><span class="token punctuation">:</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token string">\'blue\'</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">}</span>\nincrements <span class="token operator">=</span> <span class="token punctuation">[</span>\n    <span class="token punctuation">(</span><span class="token string">\'red\'</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token punctuation">(</span><span class="token string">\'blue\'</span><span class="token punctuation">,</span> <span class="token number">17</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token punctuation">(</span><span class="token string">\'orange\'</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n<span class="token punctuation">]</span>\n<span class="gatsby-highlight-code-line">counter <span class="token operator">=</span> CountMissing<span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line">result <span class="token operator">=</span> defaultdict<span class="token punctuation">(</span>counter<span class="token punctuation">.</span>missing<span class="token punctuation">,</span> current<span class="token punctuation">)</span>  <span class="token comment"># Method ref</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">for</span> key<span class="token punctuation">,</span> amount <span class="token keyword">in</span> increments<span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">    result<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">+=</span> amount</span><span class="gatsby-highlight-code-line"><span class="token keyword">assert</span> counter<span class="token punctuation">.</span>added <span class="token operator">==</span> <span class="token number">2</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>把有状态的闭包所具备的行为，改用辅助类来实现，要比前面的 <code class="language-text">increment_with_report</code> 函数更清晰。但如果单看这个类，可能没办法立刻了解它的意图。CountMissing 对象应该由谁构造？missing 方法应该由谁调用？这个类将来还会不会再增加 public 方法？这些疑惑都必须在看到 defaultdict 的用法之后才能解开。</p>\n<p>为了让这个类的意义更加明确，可以给它定义名为 <code class="language-text">__call__</code> 的特殊方法。这会让这个类的对象能够像函数那样得到调用。同时，也让内置的 callable 函数能够针对这种实例返回 True 值，用以表示这个实例与普通的函数或方法类似，都是可调用的。凡是能够像这样（在后面加一对括号来）执行的对象，都叫作 callable。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="98258679747492320000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class BetterCountMissing:\n    def __init__(self):\n        self.added = 0\n\n    def __call__(self):\n        self.added += 1\n        return 0\n\n\ncounter = BetterCountMissing()\nassert counter() == 0\nassert callable(counter)`, `98258679747492320000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">BetterCountMissing</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>added <span class="token operator">=</span> <span class="token number">0</span>\n\n    <span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>added <span class="token operator">+=</span> <span class="token number">1</span>\n        <span class="token keyword">return</span> <span class="token number">0</span>\n\n\ncounter <span class="token operator">=</span> BetterCountMissing<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">assert</span> counter<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span>\n<span class="token keyword">assert</span> <span class="token builtin">callable</span><span class="token punctuation">(</span>counter<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>下面，就用这样的 BetterCountMissing 实例给 defaultdict 当挂钩，让它在字典里没有键名时，创建默认的键值，并把这种情况记入键名缺失的总次数里。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="61288581402685470000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from collections import defaultdict\n\n\nclass BetterCountMissing:\n    def __init__(self):\n        self.added = 0\n\n    def __call__(self):\n        self.added += 1\n        return 0\n\n\ncurrent = {\'green\': 12, \'blue\': 3}\nincrements = [\n    (\'red\', 5),\n    (\'blue\', 17),\n    (\'orange\', 9),\n]\ncounter = BetterCountMissing()\nresult = defaultdict(counter, current)\nfor key, amount in increments:\n    result[key] += amount\nassert counter.added == 2`, `61288581402685470000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py{19-23}"\n              >\n                <span class="gatsby-code-button-language">py{19-23}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> collections <span class="token keyword">import</span> defaultdict\n\n\n<span class="token keyword">class</span> <span class="token class-name">BetterCountMissing</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>added <span class="token operator">=</span> <span class="token number">0</span>\n\n    <span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>added <span class="token operator">+=</span> <span class="token number">1</span>\n        <span class="token keyword">return</span> <span class="token number">0</span>\n\n\ncurrent <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">\'green\'</span><span class="token punctuation">:</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token string">\'blue\'</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">}</span>\nincrements <span class="token operator">=</span> <span class="token punctuation">[</span>\n    <span class="token punctuation">(</span><span class="token string">\'red\'</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token punctuation">(</span><span class="token string">\'blue\'</span><span class="token punctuation">,</span> <span class="token number">17</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token punctuation">(</span><span class="token string">\'orange\'</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n<span class="token punctuation">]</span>\n<span class="gatsby-highlight-code-line">counter <span class="token operator">=</span> BetterCountMissing<span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line">result <span class="token operator">=</span> defaultdict<span class="token punctuation">(</span>counter<span class="token punctuation">,</span> current<span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">for</span> key<span class="token punctuation">,</span> amount <span class="token keyword">in</span> increments<span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">    result<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">+=</span> amount</span><span class="gatsby-highlight-code-line"><span class="token keyword">assert</span> counter<span class="token punctuation">.</span>added <span class="token operator">==</span> <span class="token number">2</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>上面这段代码要比 CountMissing 更清晰，因为它里面有 <code class="language-text">__call__</code> 方法，这说明这个类的实例可像普通的函数那样使用（例如可以传给 API 当挂钩）。即便是初次看到这段代码，也能明白这个类的主要目标。因为你应该会注意到那个比较显眼的 <code class="language-text">__call__</code> 方法。它强烈暗示着这个类可以像有状态的闭包那样使用。</p>\n<p>总之，最大的优势在于，defaultdict 仍然不需要关注 <code class="language-text">__call__</code> 方法触发之后究竟会做什么。它只知道自己可以用这样一个挂钩，来给缺失的键制作默认值。Python 很容易就能设计这种把挂钩函数当参数来用的接口，面对这种接口，调用者可以采用最适合自己的，把符合接口要求的东西传进去。</p>\n<h3 id="总结-34"><a href="#%E6%80%BB%E7%BB%93-34" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>如果想设计简单的 Python 接口，让组件之间能够通过接口交互，那么可以考虑让接口接受挂钩函数，而不一定非得定义新类，并要求使用者传入这种类的实例。</li>\n<li>Python 的函数与方法都是头等对象，这意味着它们可以像其他类型那样，用在表达式里。</li>\n<li>某个类如果定义了 <code class="language-text">__call__</code> 特殊方法，那么它的实例就可以像普通的 Python 函数那样调用。</li>\n<li>如果想用函数来维护状态，那么可以考虑定义一个带有 <code class="language-text">__call__</code> 方法的新类，而不要用有状态的闭包去实现。</li>\n</ol>\n<h2 id="第-39-条：通过-classmethod-多态来构造同一体系中的各类对象"><a href="#%E7%AC%AC-39-%E6%9D%A1%EF%BC%9A%E9%80%9A%E8%BF%87-classmethod-%E5%A4%9A%E6%80%81%E6%9D%A5%E6%9E%84%E9%80%A0%E5%90%8C%E4%B8%80%E4%BD%93%E7%B3%BB%E4%B8%AD%E7%9A%84%E5%90%84%E7%B1%BB%E5%AF%B9%E8%B1%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 39 条：通过 @classmethod 多态来构造同一体系中的各类对象</h2>\n<p>在 Python 中，不仅对象支持多态，类也支持多态。类的多态是什么意思，这样做有什么好处？</p>\n<p>多态机制使同一体系中的多个类可以按照各自独有的方式来实现同一个方法，这意味着这些类都可以满足同一套接口，或者都可以当作某个抽象类来使用，同时，它们又能在这个前提下，实现各自的功能（参见第 43 条）。</p>\n<p>例如，要实现一套 MapReduce（映射-归纳/映射-化简）流程，并且以一个通用的类来表示输入数据。于是，笔者就定义了这样一个 InputData 类，并把 read 方法留给子类去实现。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="82783075452964300000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class InputData:\n    def read(self):\n        raise NotImplementedError`, `82783075452964300000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">InputData</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">read</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">raise</span> NotImplementedError</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>然后，编写一个具体的 InputData 子类，例如，可以从磁盘文件中读取数据的 PathInputData 类。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="56510547356998476000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class PathInputData(InputData):\n    def __init__(self, path):\n        super().__init__()\n        self.path = path\n\n    def read(self):\n        with open(self.path) as f:\n            return f.read()`, `56510547356998476000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">PathInputData</span><span class="token punctuation">(</span>InputData<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>path <span class="token operator">=</span> path\n\n    <span class="token keyword">def</span> <span class="token function">read</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>path<span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>\n            <span class="token keyword">return</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>通用的 InputData 类以后可能会有很多个像 PathInputData 这样的子类，每个子类都会实现标准的 read 接口，并按照各自的方式把需要处理的数据读取进来。例如，有的 InputData 子类可从网上读取数据，有的 InputData 可读取压缩格式的数据并将其解压成普通数据，等等。</p>\n<p>除了输入数据要通用，我们还想让处理 MapReduce 任务的工作节点（Worker）也能有一套通用的抽象接口，这样不同的 Worker 就可以通过这套标准的接口来消耗输入数据。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="5265690974671134000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Worker:\n    def __init__(self, input_data):\n        self.input_data = input_data\n        self.result = None\n\n    def map(self):\n        raise NotImplementedError\n\n    def reduce(self, other):\n        raise NotImplementedError`, `5265690974671134000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Worker</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> input_data<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>input_data <span class="token operator">=</span> input_data\n        self<span class="token punctuation">.</span>result <span class="token operator">=</span> <span class="token boolean">None</span>\n\n    <span class="token keyword">def</span> <span class="token function">map</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">raise</span> NotImplementedError\n\n    <span class="token keyword">def</span> <span class="token function">reduce</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> other<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">raise</span> NotImplementedError</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>下面，我们定义一种具体的 Worker 子类，使它按照特定的方式实现 MapReduce。也就是统计每份数据里的换行符个数，然后把所有的统计值汇总起来。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="62815725567726210000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class LineCountWorker(Worker):\n    def map(self):\n        data = self.input_data.read()\n        self.result = data.count(\'\\n\')\n\n    def reduce(self, other):\n        self.result += other.result`, `62815725567726210000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">LineCountWorker</span><span class="token punctuation">(</span>Worker<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">map</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        data <span class="token operator">=</span> self<span class="token punctuation">.</span>input_data<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>result <span class="token operator">=</span> data<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token string">\'\\n\'</span><span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">reduce</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> other<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>result <span class="token operator">+=</span> other<span class="token punctuation">.</span>result</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样实现似乎不错，但接下来会碰到一个大难题，也就是如何把这些组件拼接起来。输入数据与工作节点都有各自的类体系，而且这两套体系也抽象出了合理的接口，然而，它们都必须落实到具体的对象上面，只有构造出了具体对象，才能写出有用的程序。问题是，这些对象由谁来构造？构造出来之后，怎么编排 MapReduce 流程？</p>\n<p>最简单的办法，是编写几个辅助函数，手动构建这些对象并把它们连接起来。例如，可以采用下面的辅助函数读取目录中的内容，并给目录下每份文件构造一个 PathInputData 实例。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="29384437564245980000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import os\n\n\ndef generate_inputs(data_dir):\n    for name in os.listdir(data_dir):\n        yield PathInputData(os.path.join(data_dir, name))`, `29384437564245980000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> os\n\n\n<span class="token keyword">def</span> <span class="token function">generate_inputs</span><span class="token punctuation">(</span>data_dir<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">for</span> name <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>data_dir<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">yield</span> PathInputData<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>data_dir<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>接下来，再编写一个辅助函数，针对 <code class="language-text">generate_inputs</code> 返回的每个 InputData 实例分别创建相应的 LineCountWorker 对象。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="65387535634944420000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def create_workers(input_list):\n    workers = []\n    for input_data in input_list:\n        workers.append(LineCountWorker(input_data))\n    return workers`, `65387535634944420000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">create_workers</span><span class="token punctuation">(</span>input_list<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    workers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n    <span class="token keyword">for</span> input_data <span class="token keyword">in</span> input_list<span class="token punctuation">:</span>\n        workers<span class="token punctuation">.</span>append<span class="token punctuation">(</span>LineCountWorker<span class="token punctuation">(</span>input_data<span class="token punctuation">)</span><span class="token punctuation">)</span>\n    <span class="token keyword">return</span> workers</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后，将这些 Worker 实例的映射（map）工作分发到多个线程中去执行（参见第 53 条）。反复调用 reduce，把这些 Worker 计算出的结果合并成一个值。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="82541876792595860000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from threading import Thread\n\n\ndef execute(workers):\n    threads = [Thread(target=w.map) for w in workers]\n    for thread in threads:\n        thread.start()\n    for thread in threads:\n        thread.join()\n\n    first, *rest = workers\n    for worker in rest:\n        first.reduce(worker)\n    return first.result`, `82541876792595860000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> threading <span class="token keyword">import</span> Thread\n\n\n<span class="token keyword">def</span> <span class="token function">execute</span><span class="token punctuation">(</span>workers<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    threads <span class="token operator">=</span> <span class="token punctuation">[</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>w<span class="token punctuation">.</span><span class="token builtin">map</span><span class="token punctuation">)</span> <span class="token keyword">for</span> w <span class="token keyword">in</span> workers<span class="token punctuation">]</span>\n    <span class="token keyword">for</span> thread <span class="token keyword">in</span> threads<span class="token punctuation">:</span>\n        thread<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token keyword">for</span> thread <span class="token keyword">in</span> threads<span class="token punctuation">:</span>\n        thread<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n    first<span class="token punctuation">,</span> <span class="token operator">*</span>rest <span class="token operator">=</span> workers\n    <span class="token keyword">for</span> worker <span class="token keyword">in</span> rest<span class="token punctuation">:</span>\n        first<span class="token punctuation">.</span><span class="token builtin">reduce</span><span class="token punctuation">(</span>worker<span class="token punctuation">)</span>\n    <span class="token keyword">return</span> first<span class="token punctuation">.</span>result</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>最后，编写一个函数，将刚才那三个环节串起来。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="36813542805974196000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def mapreduce(data_dir):\n    inputs = generate_inputs(data_dir)\n    workers = create_workers(inputs)\n    return execute(workers)`, `36813542805974196000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">mapreduce</span><span class="token punctuation">(</span>data_dir<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    inputs <span class="token operator">=</span> generate_inputs<span class="token punctuation">(</span>data_dir<span class="token punctuation">)</span>\n    workers <span class="token operator">=</span> create_workers<span class="token punctuation">(</span>inputs<span class="token punctuation">)</span>\n    <span class="token keyword">return</span> execute<span class="token punctuation">(</span>workers<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以看到，该函数可以很好地处理随机制造出的这批输入文件。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="93490414499409500000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import random\nfrom threading import Thread\nimport os\n\n\nclass InputData:\n    def read(self):\n        raise NotImplementedError\n\n\nclass PathInputData(InputData):\n    def __init__(self, path):\n        super().__init__()\n        self.path = path\n\n    def read(self):\n        with open(self.path) as f:\n            return f.read()\n\n\nclass Worker:\n    def __init__(self, input_data):\n        self.input_data = input_data\n        self.result = None\n\n    def map(self):\n        raise NotImplementedError\n\n    def reduce(self, other):\n        raise NotImplementedError\n\n\nclass LineCountWorker(Worker):\n    def map(self):\n        data = self.input_data.read()\n        self.result = data.count(\'\\n\')\n\n    def reduce(self, other):\n        self.result += other.result\n\n\ndef generate_inputs(data_dir):\n    for name in os.listdir(data_dir):\n        yield PathInputData(os.path.join(data_dir, name))\n\n\ndef create_workers(input_list):\n    workers = []\n    for input_data in input_list:\n        workers.append(LineCountWorker(input_data))\n    return workers\n\n\ndef mapreduce(data_dir):\n    inputs = generate_inputs(data_dir)\n    workers = create_workers(inputs)\n    return execute(workers)\n\n\ndef execute(workers):\n    threads = [Thread(target=w.map) for w in workers]\n    for thread in threads:\n        thread.start()\n    for thread in threads:\n        thread.join()\n\n    first, *rest = workers\n    for worker in rest:\n        first.reduce(worker)\n    return first.result\n\n\ndef write_test_files(tmpdir):\n    os.makedirs(tmpdir)\n    print(\'generate dir is:\', os.path.abspath(tmpdir))\n    for i in range(100):\n        with open(os.path.join(tmpdir, str(i)), \'w\') as f:\n            f.write(\'\\n\' * random.randint(0, 100))\n\n\ntmpdir = \'test_inputs\'\nwrite_test_files(tmpdir)\nresult = mapreduce(tmpdir)\nprint(f\'There are {result} lines\')\n\n>>>\ngenerate dir is: /home/123/Desktop/test_inputs\nThere are 4884 lines`, `93490414499409500000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py{73-84}"\n              >\n                <span class="gatsby-code-button-language">py{73-84}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> random\n<span class="token keyword">from</span> threading <span class="token keyword">import</span> Thread\n<span class="token keyword">import</span> os\n\n\n<span class="token keyword">class</span> <span class="token class-name">InputData</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">read</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">raise</span> NotImplementedError\n\n\n<span class="token keyword">class</span> <span class="token class-name">PathInputData</span><span class="token punctuation">(</span>InputData<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>path <span class="token operator">=</span> path\n\n    <span class="token keyword">def</span> <span class="token function">read</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>path<span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>\n            <span class="token keyword">return</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">Worker</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> input_data<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>input_data <span class="token operator">=</span> input_data\n        self<span class="token punctuation">.</span>result <span class="token operator">=</span> <span class="token boolean">None</span>\n\n    <span class="token keyword">def</span> <span class="token function">map</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">raise</span> NotImplementedError\n\n    <span class="token keyword">def</span> <span class="token function">reduce</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> other<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">raise</span> NotImplementedError\n\n\n<span class="token keyword">class</span> <span class="token class-name">LineCountWorker</span><span class="token punctuation">(</span>Worker<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">map</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        data <span class="token operator">=</span> self<span class="token punctuation">.</span>input_data<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>result <span class="token operator">=</span> data<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token string">\'\\n\'</span><span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">reduce</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> other<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>result <span class="token operator">+=</span> other<span class="token punctuation">.</span>result\n\n\n<span class="token keyword">def</span> <span class="token function">generate_inputs</span><span class="token punctuation">(</span>data_dir<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">for</span> name <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>data_dir<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">yield</span> PathInputData<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>data_dir<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n\n<span class="token keyword">def</span> <span class="token function">create_workers</span><span class="token punctuation">(</span>input_list<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    workers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n    <span class="token keyword">for</span> input_data <span class="token keyword">in</span> input_list<span class="token punctuation">:</span>\n        workers<span class="token punctuation">.</span>append<span class="token punctuation">(</span>LineCountWorker<span class="token punctuation">(</span>input_data<span class="token punctuation">)</span><span class="token punctuation">)</span>\n    <span class="token keyword">return</span> workers\n\n\n<span class="token keyword">def</span> <span class="token function">mapreduce</span><span class="token punctuation">(</span>data_dir<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    inputs <span class="token operator">=</span> generate_inputs<span class="token punctuation">(</span>data_dir<span class="token punctuation">)</span>\n    workers <span class="token operator">=</span> create_workers<span class="token punctuation">(</span>inputs<span class="token punctuation">)</span>\n    <span class="token keyword">return</span> execute<span class="token punctuation">(</span>workers<span class="token punctuation">)</span>\n\n\n<span class="token keyword">def</span> <span class="token function">execute</span><span class="token punctuation">(</span>workers<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    threads <span class="token operator">=</span> <span class="token punctuation">[</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>w<span class="token punctuation">.</span><span class="token builtin">map</span><span class="token punctuation">)</span> <span class="token keyword">for</span> w <span class="token keyword">in</span> workers<span class="token punctuation">]</span>\n    <span class="token keyword">for</span> thread <span class="token keyword">in</span> threads<span class="token punctuation">:</span>\n        thread<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token keyword">for</span> thread <span class="token keyword">in</span> threads<span class="token punctuation">:</span>\n        thread<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n    first<span class="token punctuation">,</span> <span class="token operator">*</span>rest <span class="token operator">=</span> workers\n    <span class="token keyword">for</span> worker <span class="token keyword">in</span> rest<span class="token punctuation">:</span>\n        first<span class="token punctuation">.</span><span class="token builtin">reduce</span><span class="token punctuation">(</span>worker<span class="token punctuation">)</span>\n    <span class="token keyword">return</span> first<span class="token punctuation">.</span>result\n\n\n<span class="gatsby-highlight-code-line"><span class="token keyword">def</span> <span class="token function">write_test_files</span><span class="token punctuation">(</span>tmpdir<span class="token punctuation">)</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">    os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>tmpdir<span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line">    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'generate dir is:\'</span><span class="token punctuation">,</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>abspath<span class="token punctuation">(</span>tmpdir<span class="token punctuation">)</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line">    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>tmpdir<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">\'w\'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">            f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">\'\\n\'</span> <span class="token operator">*</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line">tmpdir <span class="token operator">=</span> <span class="token string">\'test_inputs\'</span></span><span class="gatsby-highlight-code-line">write_test_files<span class="token punctuation">(</span>tmpdir<span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line">result <span class="token operator">=</span> mapreduce<span class="token punctuation">(</span>tmpdir<span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'There are </span><span class="token interpolation"><span class="token punctuation">{</span>result<span class="token punctuation">}</span></span><span class="token string"> lines\'</span></span><span class="token punctuation">)</span></span>\n<span class="token operator">>></span><span class="token operator">></span>\ngenerate <span class="token builtin">dir</span> <span class="token keyword">is</span><span class="token punctuation">:</span> <span class="token operator">/</span>home<span class="token operator">/</span><span class="token number">123</span><span class="token operator">/</span>Desktop<span class="token operator">/</span>test_inputs\nThere are <span class="token number">4884</span> lines</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然而这样做有个大问题，就是 mapreduce 函数根本不通用。假如要使用其他的 InputData 或 Worker 子类，那就必须修改 <code class="language-text">generate_inputs</code>、<code class="language-text">create_workers</code> 与 mapreduce 的代码，以匹配新类的用法。</p>\n<p>这个问题的根本原因在于，构造对象的办法不够通用。在其他编程语言中，可以利用构造函数多态（constructor polymorphism）来解决，也就是子类不仅要具备与超类一致的构造函数，而且还必须各自提供一个特殊的构造函数以实现和自身有关的构造逻辑。这样，刚才那些辅助方法在编排 MapReduce 流程时，就可以按照超类的形式统一地构造这些对象，并使其根据所属的子类分别去触发相关的特殊构造函数（类似工厂模式）。但是我们在 Python 里不能这样做，因为 Python 的类只能有一个构造方法（即 <code class="language-text">__init__</code> 方法），没办法要求所有的 InputData 子类都采用同一种写法来定义 <code class="language-text">__init__</code>（因为它们必须用各自不同的数据来完成构造）。</p>\n<p>这个问题，最好是能够通过类方法多态（class method polymorphism）来解决。这种多态与 InputData.read 所体现的实例方法多态（instance method polymorphism）很像，只不过它针对的是类，而不是这些类的对象。</p>\n<p>我们现在运用方法多态来实现 MapReduce 流程所用到的这些类。首先改写 InputData 类，把 <code class="language-text">generate_inputs</code> 方法放到该类里面并声明成通用的 @classmethod，这样它的所有子类都可以通过同一个接口来新建具体的 InputData 实例。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="45216797317030430000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class GenericInputData:\n    def read(self):\n        raise NotImplementedError\n\n    @classmethod\n    def generate_inputs(cls, config):\n        raise NotImplementedError`, `45216797317030430000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">GenericInputData</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">read</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">raise</span> NotImplementedError\n\n    @<span class="token builtin">classmethod</span>\n    <span class="token keyword">def</span> <span class="token function">generate_inputs</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">raise</span> NotImplementedError</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>新的 <code class="language-text">generate_inputs</code> 方法带有一个叫作 config 的字典参数，调用者可以把一系列配置信息放到字典里中，让具体的 GenericInputData 子类去解读。例如 PathInputData 这个子类就会通过 <code class="language-text">data_dir</code> 键从字典里寻找含有输入文件的那个目录。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="23038772149622400000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class PathInputData(GenericInputData):\n    @classmethod\n    def generate_inputs(cls, config):\n        data_dir = config[\'data_dir\']\n        for name in os.listdir(data_dir):\n            yield cls(os.path.join(data_dir, name))`, `23038772149622400000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">PathInputData</span><span class="token punctuation">(</span>GenericInputData<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    @<span class="token builtin">classmethod</span>\n    <span class="token keyword">def</span> <span class="token function">generate_inputs</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        data_dir <span class="token operator">=</span> config<span class="token punctuation">[</span><span class="token string">\'data_dir\'</span><span class="token punctuation">]</span>\n        <span class="token keyword">for</span> name <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>data_dir<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">yield</span> cls<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>data_dir<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后，可以用类似的思路改写前面的 Worker 类。把名叫 <code class="language-text">create_workers</code> 的辅助方法移到这个类里面并且也声明成 @classmethod。新方法的 <code class="language-text">input_class</code> 参数将会是 GenericInputData 的某个子类，我们要通过这个参数触发那个子类的 <code class="language-text">generate_inputs</code> 方法，以创建出 Worker 所需的输入信息。有了输入信息之后，通过 <code class="language-text">cls(input_data)</code> 这个通用的形式来调用构造函数，这样创建的实例，其类型是 cls 所表示的具体 GenericWorker 子类。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="42022632096598245000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class GenericWorker:\n    def __init__(self, input_data):\n        self.input_data = input_data\n        self.result = None\n\n    def map(self):\n        raise NotImplementedError\n\n    def reduce(self, other):\n        raise NotImplementedError\n\n    @classmethod\n    def create_workers(cls, input_class, config):\n        workers = []\n        for input_data in input_class.generate_inputs(config):\n            workers.append(cls(input_data))\n        return workers`, `42022632096598245000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">GenericWorker</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> input_data<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>input_data <span class="token operator">=</span> input_data\n        self<span class="token punctuation">.</span>result <span class="token operator">=</span> <span class="token boolean">None</span>\n\n    <span class="token keyword">def</span> <span class="token function">map</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">raise</span> NotImplementedError\n\n    <span class="token keyword">def</span> <span class="token function">reduce</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> other<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">raise</span> NotImplementedError\n\n    @<span class="token builtin">classmethod</span>\n    <span class="token keyword">def</span> <span class="token function">create_workers</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> input_class<span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        workers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n        <span class="token keyword">for</span> input_data <span class="token keyword">in</span> input_class<span class="token punctuation">.</span>generate_inputs<span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            workers<span class="token punctuation">.</span>append<span class="token punctuation">(</span>cls<span class="token punctuation">(</span>input_data<span class="token punctuation">)</span><span class="token punctuation">)</span>\n        <span class="token keyword">return</span> workers</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>请注意，上面的代码创建输入信息时，用的是 <code class="language-text">input_class.generate_inputs</code> 这样的写法，这么写正是为了触发类多态机制，以便将 <code class="language-text">generate_inputs</code> 派发到 <code class="language-text">input_class</code> 所表示的那个实际子类上面。另外还要注意，在构造 GenericWorker 的子类对象时，用的是 <code class="language-text">cls(...)</code> 这样的通用写法，而没有直接调用 <code class="language-text">__init__</code> 方法。</p>\n<p>接下来要修改具体的 Worker 类，这其实很简单，只需要把超类的名称改为 GenericWorker 就好。</p>\n<p>最后，重新编写 mapreduce 函数，让它通过 <code class="language-text">worker_class.create_workers</code> 来创建工作节点，这样它就变得通用了。</p>\n<p>把原来那套实现方案所处理的随机文件，再采用这套新的工作节点来处理，可以产生相同的结果。区别只在于，这次调用 mapreduce 时，必须多传几个参数，因为它现在是个通用的函数，必须把实际的输入数据与实际的工作节点告诉它。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="93043449034410330000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import random\nfrom threading import Thread\nimport os\n\n\nclass GenericInputData:\n    def read(self):\n        raise NotImplementedError\n\n    @classmethod\n    def generate_inputs(cls, config):\n        raise NotImplementedError\n\n\nclass PathInputData(GenericInputData):\n    def __init__(self, path):\n        super().__init__()\n        self.path = path\n\n    def read(self):\n        with open(self.path) as f:\n            return f.read()\n\n    @classmethod\n    def generate_inputs(cls, config):\n        data_dir = config[\'data_dir\']\n        for name in os.listdir(data_dir):\n            yield cls(os.path.join(data_dir, name))\n\n\nclass GenericWorker:\n    def __init__(self, input_data):\n        self.input_data = input_data\n        self.result = None\n\n    def map(self):\n        raise NotImplementedError\n\n    def reduce(self, other):\n        raise NotImplementedError\n\n    @classmethod\n    def create_workers(cls, input_class, config):\n        workers = []\n        for input_data in input_class.generate_inputs(config):\n            workers.append(cls(input_data))\n        return workers\n\n\nclass LineCountWorker(GenericWorker):\n    def map(self):\n        data = self.input_data.read()\n        self.result = data.count(\'\\n\')\n\n    def reduce(self, other):\n        self.result += other.result\n\n\ndef mapreduce(worker_class, input_class, config):\n    workers = worker_class.create_workers(input_class, config)\n    return execute(workers)\n\n\ndef execute(workers):\n    threads = [Thread(target=w.map) for w in workers]\n    for thread in threads:\n        thread.start()\n    for thread in threads:\n        thread.join()\n\n    first, *rest = workers\n    for worker in rest:\n        first.reduce(worker)\n    return first.result\n\n\ndef write_test_files(tmpdir):\n    os.makedirs(tmpdir)\n    print(\'generate dir is:\', os.path.abspath(tmpdir))\n    for i in range(100):\n        with open(os.path.join(tmpdir, str(i)), \'w\') as f:\n            f.write(\'\\n\' * random.randint(0, 100))\n\n\ntmpdir = \'test_inputs\'\nwrite_test_files(tmpdir)\nconfig = {\n    \'data_dir\': tmpdir\n}\nresult = mapreduce(LineCountWorker, PathInputData, config)\nprint(f\'There are {result} lines\')\n\n>>>\ngenerate dir is: /home/123/Desktop/test_inputs\nThere are 5373 lines`, `93043449034410330000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py{6,10-12,15,24-28,31,42-47,50,59-61,87-90}"\n              >\n                <span class="gatsby-code-button-language">py{6,10-12,15,24-28,31,42-47,50,59-61,87-90}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> random\n<span class="token keyword">from</span> threading <span class="token keyword">import</span> Thread\n<span class="token keyword">import</span> os\n\n\n<span class="gatsby-highlight-code-line"><span class="token keyword">class</span> <span class="token class-name">GenericInputData</span><span class="token punctuation">:</span></span>    <span class="token keyword">def</span> <span class="token function">read</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">raise</span> NotImplementedError\n\n<span class="gatsby-highlight-code-line">    @<span class="token builtin">classmethod</span></span><span class="gatsby-highlight-code-line">    <span class="token keyword">def</span> <span class="token function">generate_inputs</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">        <span class="token keyword">raise</span> NotImplementedError</span>\n\n<span class="gatsby-highlight-code-line"><span class="token keyword">class</span> <span class="token class-name">PathInputData</span><span class="token punctuation">(</span>GenericInputData<span class="token punctuation">)</span><span class="token punctuation">:</span></span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>path <span class="token operator">=</span> path\n\n    <span class="token keyword">def</span> <span class="token function">read</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>path<span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>\n            <span class="token keyword">return</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n<span class="gatsby-highlight-code-line">    @<span class="token builtin">classmethod</span></span><span class="gatsby-highlight-code-line">    <span class="token keyword">def</span> <span class="token function">generate_inputs</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">        data_dir <span class="token operator">=</span> config<span class="token punctuation">[</span><span class="token string">\'data_dir\'</span><span class="token punctuation">]</span></span><span class="gatsby-highlight-code-line">        <span class="token keyword">for</span> name <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>data_dir<span class="token punctuation">)</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">            <span class="token keyword">yield</span> cls<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>data_dir<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span></span>\n\n<span class="gatsby-highlight-code-line"><span class="token keyword">class</span> <span class="token class-name">GenericWorker</span><span class="token punctuation">:</span></span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> input_data<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>input_data <span class="token operator">=</span> input_data\n        self<span class="token punctuation">.</span>result <span class="token operator">=</span> <span class="token boolean">None</span>\n\n    <span class="token keyword">def</span> <span class="token function">map</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">raise</span> NotImplementedError\n\n    <span class="token keyword">def</span> <span class="token function">reduce</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> other<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">raise</span> NotImplementedError\n\n<span class="gatsby-highlight-code-line">    @<span class="token builtin">classmethod</span></span><span class="gatsby-highlight-code-line">    <span class="token keyword">def</span> <span class="token function">create_workers</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> input_class<span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">        workers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="gatsby-highlight-code-line">        <span class="token keyword">for</span> input_data <span class="token keyword">in</span> input_class<span class="token punctuation">.</span>generate_inputs<span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">            workers<span class="token punctuation">.</span>append<span class="token punctuation">(</span>cls<span class="token punctuation">(</span>input_data<span class="token punctuation">)</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line">        <span class="token keyword">return</span> workers</span>\n\n<span class="gatsby-highlight-code-line"><span class="token keyword">class</span> <span class="token class-name">LineCountWorker</span><span class="token punctuation">(</span>GenericWorker<span class="token punctuation">)</span><span class="token punctuation">:</span></span>    <span class="token keyword">def</span> <span class="token function">map</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        data <span class="token operator">=</span> self<span class="token punctuation">.</span>input_data<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>result <span class="token operator">=</span> data<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token string">\'\\n\'</span><span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">reduce</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> other<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>result <span class="token operator">+=</span> other<span class="token punctuation">.</span>result\n\n\n<span class="gatsby-highlight-code-line"><span class="token keyword">def</span> <span class="token function">mapreduce</span><span class="token punctuation">(</span>worker_class<span class="token punctuation">,</span> input_class<span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">    workers <span class="token operator">=</span> worker_class<span class="token punctuation">.</span>create_workers<span class="token punctuation">(</span>input_class<span class="token punctuation">,</span> config<span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line">    <span class="token keyword">return</span> execute<span class="token punctuation">(</span>workers<span class="token punctuation">)</span></span>\n\n<span class="token keyword">def</span> <span class="token function">execute</span><span class="token punctuation">(</span>workers<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    threads <span class="token operator">=</span> <span class="token punctuation">[</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>w<span class="token punctuation">.</span><span class="token builtin">map</span><span class="token punctuation">)</span> <span class="token keyword">for</span> w <span class="token keyword">in</span> workers<span class="token punctuation">]</span>\n    <span class="token keyword">for</span> thread <span class="token keyword">in</span> threads<span class="token punctuation">:</span>\n        thread<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token keyword">for</span> thread <span class="token keyword">in</span> threads<span class="token punctuation">:</span>\n        thread<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n    first<span class="token punctuation">,</span> <span class="token operator">*</span>rest <span class="token operator">=</span> workers\n    <span class="token keyword">for</span> worker <span class="token keyword">in</span> rest<span class="token punctuation">:</span>\n        first<span class="token punctuation">.</span><span class="token builtin">reduce</span><span class="token punctuation">(</span>worker<span class="token punctuation">)</span>\n    <span class="token keyword">return</span> first<span class="token punctuation">.</span>result\n\n\n<span class="token keyword">def</span> <span class="token function">write_test_files</span><span class="token punctuation">(</span>tmpdir<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>tmpdir<span class="token punctuation">)</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'generate dir is:\'</span><span class="token punctuation">,</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>abspath<span class="token punctuation">(</span>tmpdir<span class="token punctuation">)</span><span class="token punctuation">)</span>\n    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>tmpdir<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">\'w\'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>\n            f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">\'\\n\'</span> <span class="token operator">*</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n\ntmpdir <span class="token operator">=</span> <span class="token string">\'test_inputs\'</span>\nwrite_test_files<span class="token punctuation">(</span>tmpdir<span class="token punctuation">)</span>\n<span class="gatsby-highlight-code-line">config <span class="token operator">=</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    <span class="token string">\'data_dir\'</span><span class="token punctuation">:</span> tmpdir</span><span class="gatsby-highlight-code-line"><span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">result <span class="token operator">=</span> mapreduce<span class="token punctuation">(</span>LineCountWorker<span class="token punctuation">,</span> PathInputData<span class="token punctuation">,</span> config<span class="token punctuation">)</span></span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'There are </span><span class="token interpolation"><span class="token punctuation">{</span>result<span class="token punctuation">}</span></span><span class="token string"> lines\'</span></span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\ngenerate <span class="token builtin">dir</span> <span class="token keyword">is</span><span class="token punctuation">:</span> <span class="token operator">/</span>home<span class="token operator">/</span><span class="token number">123</span><span class="token operator">/</span>Desktop<span class="token operator">/</span>test_inputs\nThere are <span class="token number">5373</span> lines</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这套方案让我们能够随意编写其他的 GenericInputData 与 GenericWorker 子类，而不用再花时间去调整它们之间的拼接代码（glue code）。</p>\n<h3 id="总结-35"><a href="#%E6%80%BB%E7%BB%93-35" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>Python 只允许每个类有一个构造方法，也就是 <code class="language-text">__init__</code> 方法。</li>\n<li>如果想在超类中用通用的代码构造子类实例，那么可以考虑定义 @classmethod 方法，并在里面用 <code class="language-text">cls(...)</code> 的形式构造具体的子类对象。</li>\n<li>通过类方法多态机制，我们能够以通用的形式构造并拼接具体的子类对象。</li>\n</ol>\n<h2 id="第-40-条：通过-super-初始化超类"><a href="#%E7%AC%AC-40-%E6%9D%A1%EF%BC%9A%E9%80%9A%E8%BF%87-super-%E5%88%9D%E5%A7%8B%E5%8C%96%E8%B6%85%E7%B1%BB" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 40 条：通过 super 初始化超类</h2>\n<p>以前有种简单的写法，能在子类里面执行超类的初始化逻辑，那就是直接在超类名称上调用 <code class="language-text">__init__</code> 方法并把子类实例传进去。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="73608776598789970000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class MyBaseClass:\n    def __init__(self, value):\n        self.value = value\n\n\nclass MyChildClass(MyBaseClass):\n    def __init__(self):\n        MyBaseClass.__init__(self, 5)`, `73608776598789970000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">MyBaseClass</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>value <span class="token operator">=</span> value\n\n\n<span class="token keyword">class</span> <span class="token class-name">MyChildClass</span><span class="token punctuation">(</span>MyBaseClass<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        MyBaseClass<span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这个办法能够应对比较简单的类体系，但是在其他的情况下容易出现问题。</p>\n<p>假如某个类继承了多个超类（一般来说不应该采用多重继承，笔者这里只是举例而已，参见第 41 条），那么直接调用超类的 <code class="language-text">__init__</code> 方法会让代码产生误会。</p>\n<p>直接调用 <code class="language-text">__init__</code> 方法所产生的第一个问题在于，超类的构造逻辑不一定会按照它们在子类 class 语句中的声明顺序执行。例如，在 MyBaseClass 之外再定义两个类，让它们也分别去操纵本实例的 value 字段。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="66127670906682390000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class TimesTwo:\n    def __init__(self):\n        self.value *= 2\n\n\nclass PlusFive:\n    def __init__(self):\n        self.value += 5`, `66127670906682390000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">TimesTwo</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>value <span class="token operator">*=</span> <span class="token number">2</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">PlusFive</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>value <span class="token operator">+=</span> <span class="token number">5</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>下面这个子类继承了刚才那三个类，而且它在 class 语句里指定的超类顺序与它执行那些超类的 <code class="language-text">__init__</code> 时所用的顺序一致。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="45546323119981370000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class OneWay(MyBaseClass, TimesTwo, PlusFive):\n    def __init__(self, value):\n        MyBaseClass.__init__(self, value)\n        TimesTwo.__init__(self)\n        PlusFive.__init__(self)`, `45546323119981370000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">OneWay</span><span class="token punctuation">(</span>MyBaseClass<span class="token punctuation">,</span> TimesTwo<span class="token punctuation">,</span> PlusFive<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        MyBaseClass<span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n        TimesTwo<span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>self<span class="token punctuation">)</span>\n        PlusFive<span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>self<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样写，程序会按正常顺序初始化那几个超类。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="20687824829335200000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class MyBaseClass:\n    def __init__(self, value):\n        self.value = value\n\n\nclass TimesTwo:\n    def __init__(self):\n        self.value *= 2\n\n\nclass PlusFive:\n    def __init__(self):\n        self.value += 5\n\n\nclass OneWay(MyBaseClass, TimesTwo, PlusFive):\n    def __init__(self, value):\n        MyBaseClass.__init__(self, value)\n        TimesTwo.__init__(self)\n        PlusFive.__init__(self)\n\n\nfoo = OneWay(5)\nprint(\'First ordering value is (5 * 2) + 5 =\', foo.value)\n\n>>>\nFirst ordering value is (5 * 2) + 5 = 15`, `20687824829335200000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py{23-24}"\n              >\n                <span class="gatsby-code-button-language">py{23-24}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">MyBaseClass</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>value <span class="token operator">=</span> value\n\n\n<span class="token keyword">class</span> <span class="token class-name">TimesTwo</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>value <span class="token operator">*=</span> <span class="token number">2</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">PlusFive</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>value <span class="token operator">+=</span> <span class="token number">5</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">OneWay</span><span class="token punctuation">(</span>MyBaseClass<span class="token punctuation">,</span> TimesTwo<span class="token punctuation">,</span> PlusFive<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        MyBaseClass<span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n        TimesTwo<span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>self<span class="token punctuation">)</span>\n        PlusFive<span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>self<span class="token punctuation">)</span>\n\n\n<span class="gatsby-highlight-code-line">foo <span class="token operator">=</span> OneWay<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'First ordering value is (5 * 2) + 5 =\'</span><span class="token punctuation">,</span> foo<span class="token punctuation">.</span>value<span class="token punctuation">)</span></span>\n<span class="token operator">>></span><span class="token operator">></span>\nFirst ordering value <span class="token keyword">is</span> <span class="token punctuation">(</span><span class="token number">5</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">5</span> <span class="token operator">=</span> <span class="token number">15</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>但如果子类在 class 语句里指定的超类顺序，与它执行那些超类的 <code class="language-text">__init__</code> 时的顺序不同，那么运行结果就会让人困惑（例如这次先声明它继承 PlusFive 类，然后才声明它继承 TimesTwo 类，但执行 <code class="language-text">__init__</code> 的顺序却刚好相反）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="59338272771718770000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class AnotherWay(MyBaseClass, PlusFive, TimesTwo):\n    def __init__(self, value):\n        MyBaseClass.__init__(self, value)\n        TimesTwo.__init_(self)\n        PlusFive.__init_(self)`, `59338272771718770000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">AnotherWay</span><span class="token punctuation">(</span>MyBaseClass<span class="token punctuation">,</span> PlusFive<span class="token punctuation">,</span> TimesTwo<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        MyBaseClass<span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n        TimesTwo<span class="token punctuation">.</span>__init_<span class="token punctuation">(</span>self<span class="token punctuation">)</span>\n        PlusFive<span class="token punctuation">.</span>__init_<span class="token punctuation">(</span>self<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>该子类调整了两个超类的声明顺序，但没有相应调整构造逻辑的执行顺序，因此它还是会跟前面那个子类一样，先初始化 TimesTwo，然后初始化 PlusFive。这样写，就让初次看到这段代码的人很难理解程序的运行结果，他们以为程序先加 5，再乘 2，这样算出来是 20；但实际上，程序依照的是 <code class="language-text">__init__</code> 的调用顺序，而不是 class 语句中的声明顺序，这是个很难察觉的问题。</p>\n<p>直接调用 <code class="language-text">__init__</code> 所产生的第二个问题在于，无法正确处理菱形继承（diamond inheritance）。这种继承指的是子类通过类体系里两条不同路径的类继承了同一个超类。如果采用刚才那种常见的写法来调用超类的 <code class="language-text">__init__</code>，那么会让超类的初始化逻辑重复执行，从而引发混乱。例如，下面先从 MyBaseClass 派生出两个子类。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="27991855589242286000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class MyBaseClass:\n    def __init__(self, value):\n        self.value = value\n\n\nclass TimesSeven(MyBaseClass):\n    def __init__(self, value):\n        MyBaseClass.__init__(self, value)\n        self.value *= 7\n\n\nclass PlusNine(MyBaseClass):\n    def __init__(self, value):\n        MyBaseClass.__init__(self, value)\n        self.value += 9`, `27991855589242286000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">MyBaseClass</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>value <span class="token operator">=</span> value\n\n\n<span class="token keyword">class</span> <span class="token class-name">TimesSeven</span><span class="token punctuation">(</span>MyBaseClass<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        MyBaseClass<span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>value <span class="token operator">*=</span> <span class="token number">7</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">PlusNine</span><span class="token punctuation">(</span>MyBaseClass<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        MyBaseClass<span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>value <span class="token operator">+=</span> <span class="token number">9</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后，定义最终的子类，让它分别继承刚才那两个类，这样 MyBaseClass 就会出现在菱形体系的顶端。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="69643628823864345000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class MyBaseClass:\n    def __init__(self, value):\n        self.value = value\n\n\nclass TimesSeven(MyBaseClass):\n    def __init__(self, value):\n        MyBaseClass.__init__(self, value)\n        self.value *= 7\n\n\nclass PlusNine(MyBaseClass):\n    def __init__(self, value):\n        MyBaseClass.__init__(self, value)\n        self.value += 9\n\n\nclass ThisWay(TimesSeven, PlusNine):\n    def __init__(self, value):\n        TimesSeven.__init__(self, value)\n        PlusNine.__init__(self, value)\n\n\nfoo = ThisWay(5)\nprint(\'Should be (5 * 7) + 9 = 44 but is\', foo.value)\n\n>>>\nShould be (5 * 7) + 9 = 44 but is 14`, `69643628823864345000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py{18-25}"\n              >\n                <span class="gatsby-code-button-language">py{18-25}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">MyBaseClass</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>value <span class="token operator">=</span> value\n\n\n<span class="token keyword">class</span> <span class="token class-name">TimesSeven</span><span class="token punctuation">(</span>MyBaseClass<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        MyBaseClass<span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>value <span class="token operator">*=</span> <span class="token number">7</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">PlusNine</span><span class="token punctuation">(</span>MyBaseClass<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        MyBaseClass<span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>value <span class="token operator">+=</span> <span class="token number">9</span>\n\n\n<span class="gatsby-highlight-code-line"><span class="token keyword">class</span> <span class="token class-name">ThisWay</span><span class="token punctuation">(</span>TimesSeven<span class="token punctuation">,</span> PlusNine<span class="token punctuation">)</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">        TimesSeven<span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line">        PlusNine<span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line">foo <span class="token operator">=</span> ThisWay<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Should be (5 * 7) + 9 = 44 but is\'</span><span class="token punctuation">,</span> foo<span class="token punctuation">.</span>value<span class="token punctuation">)</span></span>\n<span class="token operator">>></span><span class="token operator">></span>\nShould be <span class="token punctuation">(</span><span class="token number">5</span> <span class="token operator">*</span> <span class="token number">7</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">9</span> <span class="token operator">=</span> <span class="token number">44</span> but <span class="token keyword">is</span> <span class="token number">14</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>当 ThisWay 调用第二个超类的 <code class="language-text">__init__</code> 时，那个方法会再度触发 MyBaseClass 的 <code class="language-text">__init__</code>，导致 self.value 重新变成 5。所以，最后的结果是 5 + 9 = 14，而不是 <code class="language-text">(5 * 7) + 9 = 44</code>，因为早前由 <code class="language-text">TimesSeven.__init__</code> 所做的初始化效果已经被第二次执行的 <code class="language-text">MyBaseClass.__init__</code> 覆盖了。这是个违背直觉的结果，如果情况更为复杂，那么调试起来会特别困难。</p>\n<p>为了解决这些问题，Python 内置了 super 函数并且规定了标准的方法解析顺序（method resolution order，MRO）。super 能够确保菱形继承体系中的共同超类只初始化一次（其他案例参见第 48 条）。MRO 可以确定超类之间的初始化顺序，它遵循 C3 线性化（C3 linearization）算法。</p>\n<p>下面再创建一套菱形的类体系，但是这次，我们改用 <code class="language-text">super()</code> 来调用超类的初始化逻辑。</p>\n<p>位于菱形结构顶端的 MyBaseClass，会率先初始化，而且只会初始化一次。接下来，程序会参照菱形底端那个子类在 class 语句里声明超类时的顺序，来执行菱形结构中部的那两个超类。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="25077392669122700000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class MyBaseClass:\n    def __init__(self, value):\n        self.value = value\n\n\nclass TimesSevenCorrect(MyBaseClass):\n    def __init__(self, value):\n        super().__init__(value)\n        self.value *= 7\n\n\nclass PlusNineCorrect(MyBaseClass):\n    def __init__(self, value):\n        super().__init__(value)\n        self.value += 9\n\n\nclass GoodWay(TimesSevenCorrect, PlusNineCorrect):\n    def __init__(self, value):\n        super().__init__(value)\n\n\nfoo = GoodWay(5)\nprint(\'Should be 7 * (5 + 9) = 98 but is\', foo.value)\n\n>>>\nShould be 7 * (5 + 9) = 98 but is 98`, `25077392669122700000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">MyBaseClass</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>value <span class="token operator">=</span> value\n\n\n<span class="token keyword">class</span> <span class="token class-name">TimesSevenCorrect</span><span class="token punctuation">(</span>MyBaseClass<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>value<span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>value <span class="token operator">*=</span> <span class="token number">7</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">PlusNineCorrect</span><span class="token punctuation">(</span>MyBaseClass<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>value<span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>value <span class="token operator">+=</span> <span class="token number">9</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">GoodWay</span><span class="token punctuation">(</span>TimesSevenCorrect<span class="token punctuation">,</span> PlusNineCorrect<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>value<span class="token punctuation">)</span>\n\n\nfoo <span class="token operator">=</span> GoodWay<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Should be 7 * (5 + 9) = 98 but is\'</span><span class="token punctuation">,</span> foo<span class="token punctuation">.</span>value<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nShould be <span class="token number">7</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">5</span> <span class="token operator">+</span> <span class="token number">9</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">98</span> but <span class="token keyword">is</span> <span class="token number">98</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这个执行顺序，似乎与看上去的相反。既然 GoodWay 在指定超类时，先写的是 TimesSevenCorrect，那就应该先执行 <code class="language-text">TimesSevenCorrect.__init__</code> 才对，这样结果应该是 <code class="language-text">(5 * 7) + 9 = 44</code>。但实际上并非如此。这两个超类之间的初始化顺序，要由子类的 MRO 确定，它可以通过 mro 方法来查询。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="95929391501008760000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`mro_str = \'\\n\'.join(repr(cls) for cls in GoodWay.mro())\nprint(mro_str)\n\n>>>\n<class \'__main__.GoodWay\'>\n<class \'__main__.TimesSevenCorrect\'>\n<class \'__main__.PlusNineCorrect\'>\n<class \'__main__.MyBaseClass\'>\n<class \'object\'>`, `95929391501008760000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">mro_str <span class="token operator">=</span> <span class="token string">\'\\n\'</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token builtin">repr</span><span class="token punctuation">(</span>cls<span class="token punctuation">)</span> <span class="token keyword">for</span> cls <span class="token keyword">in</span> GoodWay<span class="token punctuation">.</span>mro<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>mro_str<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">\'__main__.GoodWay\'</span><span class="token operator">></span>\n<span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">\'__main__.TimesSevenCorrect\'</span><span class="token operator">></span>\n<span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">\'__main__.PlusNineCorrect\'</span><span class="token operator">></span>\n<span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">\'__main__.MyBaseClass\'</span><span class="token operator">></span>\n<span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">\'object\'</span><span class="token operator">></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>调用 GoodWay(5) 时，会先触发 <code class="language-text">TimesSevenCorrect.__init__</code>，进而触发 <code class="language-text">PlusNineCorrect.__init__</code>，而这又会触发 <code class="language-text">MyBaseClass.__init__</code>。程序到达菱形结构的顶端后，开始执行 MyBaseClass 的初始化逻辑，然后按照与刚才相反的顺序，依次执行 PlusNineCorrect、TimesSevenCorrect 与 GoodWay 的初始化逻辑。所以，程序首先会在 <code class="language-text">MyBaseClass.__init__</code> 中，把 value 设为 5，然后在 <code class="language-text">PlusNineCorrect.__init__</code> 里面给它加 9，这样就成了 14，接着又会在 <code class="language-text">TimesSevenCorrect.__init__</code> 里面将它乘 7，于是等于 98。</p>\n<p>除了可以应对菱形继承结构，通过 super() 调用 <code class="language-text">__init__</code>，与在子类内通过类名直接调用 <code class="language-text">__init__</code> 相比，可使代码更容易维护。现在不用从子类里面指名调用 <code class="language-text">MyBaseClass.__init__</code> 方法了，因此可以把 MyBaseClass 改成其他名字，或者让 TimesSevenCorrect 与 PlusNineCorrect 从另外一个超类里面继承，这些改动都无须调整 super 这一部分的代码。假如像原来那样写，那就必须手工修改 <code class="language-text">__init__</code> 方法前面的类名。</p>\n<p>super 函数也可以用双参数的形式调用。第一个参数表示从这个类型开始（不含该类型本身）按照方法解析顺序（MRO）向上搜索，而解析顺序则要由第二个参数所在类型的 <code class="language-text">__mro__</code> 决定。例如，按照下面这种写法，如果在 super 所返回的内容上调用 <code class="language-text">__init__</code> 方法，那么程序会从 ExplicitTrisect 类型开始（不含该类型本身）按照 MRO 向上搜索，直至找到这样的 <code class="language-text">__init__</code> 方法为止，而解析顺序是由第二个参数（self）所属的类型（ExplicitTrisect）决定的，所以解析顺序是 <code class="language-text">ExplicitTrisect -&gt; MyBaseClass -&gt; object</code>。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="75326765095084740000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class ExplicitTrisect(MyBaseClass):\n    def __init__(self, value):\n        super(ExplicitTrisect, self).__init__(value)\n        self.value /= 3`, `75326765095084740000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">ExplicitTrisect</span><span class="token punctuation">(</span>MyBaseClass<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span>ExplicitTrisect<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>value<span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>value <span class="token operator">/=</span> <span class="token number">3</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>一般来说，在类的 <code class="language-text">__init__</code> 方法里面通过 super 初始化实例时，不需要采用双参数的形式，而是可以直接采用不带参数的写法调用 super，这样 Python 编译器会自动将 <code class="language-text">__class__</code> 和 self 当成参数传递进去。所以，下面这两种写法跟刚才那种写法是同一个意思。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="35373120878192132000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class MyBaseClass:\n    def __init__(self, value):\n        self.value = value\n\n\nclass ExplicitTrisect(MyBaseClass):\n    def __init__(self, value):\n        super(ExplicitTrisect, self).__init__(value)\n        self.value /= 3\n\n\nclass AutomaticTrisect(MyBaseClass):\n    def __init__(self, value):\n        super(__class__, self).__init__(value)\n        self.value /= 3\n\n\nclass ImplicitTrisect(MyBaseClass):\n    def __init__(self, value):\n        super().__init__(value)\n        self.value /= 3\n\n\nassert ExplicitTrisect(9).value == 3\nassert AutomaticTrisect(9).value == 3\nassert ImplicitTrisect(9).value == 3`, `35373120878192132000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">MyBaseClass</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>value <span class="token operator">=</span> value\n\n\n<span class="token keyword">class</span> <span class="token class-name">ExplicitTrisect</span><span class="token punctuation">(</span>MyBaseClass<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span>ExplicitTrisect<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>value<span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>value <span class="token operator">/=</span> <span class="token number">3</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">AutomaticTrisect</span><span class="token punctuation">(</span>MyBaseClass<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span>__class__<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>value<span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>value <span class="token operator">/=</span> <span class="token number">3</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">ImplicitTrisect</span><span class="token punctuation">(</span>MyBaseClass<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>value<span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>value <span class="token operator">/=</span> <span class="token number">3</span>\n\n\n<span class="token keyword">assert</span> ExplicitTrisect<span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value <span class="token operator">==</span> <span class="token number">3</span>\n<span class="token keyword">assert</span> AutomaticTrisect<span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value <span class="token operator">==</span> <span class="token number">3</span>\n<span class="token keyword">assert</span> ImplicitTrisect<span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value <span class="token operator">==</span> <span class="token number">3</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>只有一种情况需要明确给 super 指定参数，这就是：我们想从子类里面访问超类对某项功能所做的实现方案，而那种方案可能已经被子类覆盖掉了（例如，在封装或复用功能时，就会遇到这样的情况）。</p>\n<h3 id="总结-36"><a href="#%E6%80%BB%E7%BB%93-36" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>Python 有标准的方法解析顺序（MRO）规则，可以用来判定超类之间的初始化顺序，并解决菱形继承问题。</li>\n<li>可以通过 Python 内置的 super 函数正确触发超类的 <code class="language-text">__init__</code> 逻辑。一般情况下，不需要给这个函数指定参数。</li>\n</ol>\n<h2 id="第-41-条：考虑用-mix-in-类来表示可组合的功能"><a href="#%E7%AC%AC-41-%E6%9D%A1%EF%BC%9A%E8%80%83%E8%99%91%E7%94%A8-mix-in-%E7%B1%BB%E6%9D%A5%E8%A1%A8%E7%A4%BA%E5%8F%AF%E7%BB%84%E5%90%88%E7%9A%84%E5%8A%9F%E8%83%BD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 41 条：考虑用 mix-in 类来表示可组合的功能</h2>\n<p>Python 是面向对象的编程语言，而且内置了相关的机制，使开发者能够正确处理多重继承（参见第 40 条）。尽管如此，但还是应该尽量少用多重继承。</p>\n<p>如果既要通过多重继承来方便地封装逻辑，又想避开可能出现的问题，那么就应该把有待继承的类写成 mix-in 类。这种类只提供一小套方法给子类去沿用，而不定义自己实例级别的属性，也不需要 <code class="language-text">__init__</code> 构造函数。</p>\n<p>在 Python 里很容易编写 mix-in，因为无论对象是什么类型，我们都可以方便地检视（inspect）它当前的状态。这种动态检测机制，让我们只需要把通用的功能在 mix-in 实现一遍即可，将来也可以把这项功能应用到其他许多类里面。可以把这些 mix-in 类有层次地组合起来，从而用相当少的代码表达出丰富的功能。</p>\n<p>例如，现在要实现这样一个功能，把内存中的 Python 对象表示成字典形式以便做序列化（serialization）处理。不妨将这项功能写为通用代码，以供其他类使用。</p>\n<p>为了演示这种做法，笔者定义下面这个 mix-in，让它提供名为 <code class="language-text">to_dict</code> 的 public 方法。凡是想支持这项功能的类，都可以从 mix-in 继承。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="62658021435172630000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class ToDictMixin:\n    def to_dict(self):\n        return self._traverse_dict(self.__dict__)`, `62658021435172630000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">ToDictMixin</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">to_dict</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_traverse_dict<span class="token punctuation">(</span>self<span class="token punctuation">.</span>__dict__<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>具体的实现代码写得很直观，我们可以通过 isinstance 函数动态地检视值的类型，并利用 hasattr 函数判断值里面有没有叫作 <code class="language-text">__dict__</code> 的字典。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="46549648851567690000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def _traverse_dict(self, instance_dict):\n    output = {}\n    for key, value in instance_dict.items():\n        output[key] = self._traverse(key, value)\n    return output\n\n\ndef _traverse(self, key, value):\n    if isinstance(value, ToDictMixin):\n        return value.to_dict()\n    elif isinstance(value, dict):\n        return self._traverse_dict(value)\n    elif isinstance(value, list):\n        return [self._traverse(key, i) for i in value]\n    elif hasattr(value, \'__dict__\'):\n        return self._traverse_dict(value.__dict__)\n    else:\n        return value`, `46549648851567690000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">_traverse_dict</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> instance_dict<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    output <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n    <span class="token keyword">for</span> key<span class="token punctuation">,</span> value <span class="token keyword">in</span> instance_dict<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        output<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>_traverse<span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n    <span class="token keyword">return</span> output\n\n\n<span class="token keyword">def</span> <span class="token function">_traverse</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> ToDictMixin<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> value<span class="token punctuation">.</span>to_dict<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token keyword">elif</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_traverse_dict<span class="token punctuation">(</span>value<span class="token punctuation">)</span>\n    <span class="token keyword">elif</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token punctuation">[</span>self<span class="token punctuation">.</span>_traverse<span class="token punctuation">(</span>key<span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> value<span class="token punctuation">]</span>\n    <span class="token keyword">elif</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token string">\'__dict__\'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_traverse_dict<span class="token punctuation">(</span>value<span class="token punctuation">.</span>__dict__<span class="token punctuation">)</span>\n    <span class="token keyword">else</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> value</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>下面以二叉树为例，演示如何使表示二叉树的 BinaryTree 类具备刚才那个 mix-in 所提供的功能。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="1583442873859630600"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class BinaryTree(ToDictMixin):\n    def __init__(self, value, left=None, right=None):\n        self.value = value\n        self.left = left\n        self.right = right`, `1583442873859630600`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">BinaryTree</span><span class="token punctuation">(</span>ToDictMixin<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">,</span> left<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> right<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>value <span class="token operator">=</span> value\n        self<span class="token punctuation">.</span>left <span class="token operator">=</span> left\n        self<span class="token punctuation">.</span>right <span class="token operator">=</span> right</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>定义了这样的 BinaryTree 类后，很容易就能把二叉树里面那些相互关联的 Python 对象转换成字典的形式。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="15421573706744440000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class ToDictMixin:\n    def _traverse_dict(self, instance_dict):\n        output = {}\n        for key, value in instance_dict.items():\n            output[key] = self._traverse(key, value)\n        return output\n\n    def _traverse(self, key, value):\n        if isinstance(value, ToDictMixin):\n            return value.to_dict()\n        elif isinstance(value, dict):\n            return self._traverse_dict(value)\n        elif isinstance(value, list):\n            return [self._traverse(key, i) for i in value]\n        elif hasattr(value, \'__dict__\'):\n            return self._traverse_dict(value.__dict__)\n        else:\n            return value\n\n    def to_dict(self):\n        return self._traverse_dict(self.__dict__)\n\n\nclass BinaryTree(ToDictMixin):\n    def __init__(self, value, left=None, right=None):\n        self.value = value\n        self.left = left\n        self.right = right\n\n\ntree = BinaryTree(10,\n                  left=BinaryTree(7, right=BinaryTree(9)),\n                  right=BinaryTree(13, left=BinaryTree(11)))\nprint(tree.to_dict())\n\n>>>\n{\'value\': 10, \'left\': {\'value\': 7, \'left\': None, \'right\': {\'value\': 9, \'left\': None, \'right\': None}}, \'right\': {\'value\': 13, \'left\': {\'value\': 11, \'left\': None, \'right\': None}, \'right\': None}}`, `15421573706744440000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py{31-34}"\n              >\n                <span class="gatsby-code-button-language">py{31-34}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">ToDictMixin</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">_traverse_dict</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> instance_dict<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        output <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n        <span class="token keyword">for</span> key<span class="token punctuation">,</span> value <span class="token keyword">in</span> instance_dict<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            output<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>_traverse<span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n        <span class="token keyword">return</span> output\n\n    <span class="token keyword">def</span> <span class="token function">_traverse</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> ToDictMixin<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> value<span class="token punctuation">.</span>to_dict<span class="token punctuation">(</span><span class="token punctuation">)</span>\n        <span class="token keyword">elif</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> self<span class="token punctuation">.</span>_traverse_dict<span class="token punctuation">(</span>value<span class="token punctuation">)</span>\n        <span class="token keyword">elif</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> <span class="token punctuation">[</span>self<span class="token punctuation">.</span>_traverse<span class="token punctuation">(</span>key<span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> value<span class="token punctuation">]</span>\n        <span class="token keyword">elif</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token string">\'__dict__\'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> self<span class="token punctuation">.</span>_traverse_dict<span class="token punctuation">(</span>value<span class="token punctuation">.</span>__dict__<span class="token punctuation">)</span>\n        <span class="token keyword">else</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> value\n\n    <span class="token keyword">def</span> <span class="token function">to_dict</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_traverse_dict<span class="token punctuation">(</span>self<span class="token punctuation">.</span>__dict__<span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">BinaryTree</span><span class="token punctuation">(</span>ToDictMixin<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">,</span> left<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> right<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>value <span class="token operator">=</span> value\n        self<span class="token punctuation">.</span>left <span class="token operator">=</span> left\n        self<span class="token punctuation">.</span>right <span class="token operator">=</span> right\n\n\n<span class="gatsby-highlight-code-line">tree <span class="token operator">=</span> BinaryTree<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">                  left<span class="token operator">=</span>BinaryTree<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> right<span class="token operator">=</span>BinaryTree<span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">                  right<span class="token operator">=</span>BinaryTree<span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">,</span> left<span class="token operator">=</span>BinaryTree<span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">print</span><span class="token punctuation">(</span>tree<span class="token punctuation">.</span>to_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">{</span><span class="token string">\'value\'</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token string">\'left\'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">\'value\'</span><span class="token punctuation">:</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token string">\'left\'</span><span class="token punctuation">:</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token string">\'right\'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">\'value\'</span><span class="token punctuation">:</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token string">\'left\'</span><span class="token punctuation">:</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token string">\'right\'</span><span class="token punctuation">:</span> <span class="token boolean">None</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">\'right\'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">\'value\'</span><span class="token punctuation">:</span> <span class="token number">13</span><span class="token punctuation">,</span> <span class="token string">\'left\'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">\'value\'</span><span class="token punctuation">:</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token string">\'left\'</span><span class="token punctuation">:</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token string">\'right\'</span><span class="token punctuation">:</span> <span class="token boolean">None</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">\'right\'</span><span class="token punctuation">:</span> <span class="token boolean">None</span><span class="token punctuation">}</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>mix-in 最妙的地方在于，子类既可以沿用它所提供的功能，又可以对其中一些地方做自己的处理。例如，我们从普通的二叉树（BinaryTree）派生了一个子类，让这种特殊的 BinaryTreeWithParent 二叉树能够把指向上级节点的引用保留下来。但问题是，这种二叉树的 <code class="language-text">to_dict</code> 方法是从 ToDictMixin 继承来的，它所触发的 <code class="language-text">_traverse</code> 方法，在面对循环引用时，会无休止地递归下去。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="4997109276540134000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class BinaryTreeWithParent(BinaryTree):\n    def __init__(self, value, left=None,\n                 right=None, parent=None):\n        super().__init__(value, left=left, right=right)\n        self.parent = parent`, `4997109276540134000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">BinaryTreeWithParent</span><span class="token punctuation">(</span>BinaryTree<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">,</span> left<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>\n                 right<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> parent<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>value<span class="token punctuation">,</span> left<span class="token operator">=</span>left<span class="token punctuation">,</span> right<span class="token operator">=</span>right<span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>parent <span class="token operator">=</span> parent</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>为了避免无限循环，我们可以覆盖 <code class="language-text">BinaryTreeWithParent._traverse</code> 方法，让它对指向上级节点的引用做专门处理，而对于其他的值，则继续沿用从 mix-in 继承的 <code class="language-text">_traverse</code> 逻辑。下面这段代码，首先判断当前值是不是指向上级节点的引用。如果是，就直接返回上级节点的 value 值；如果不是，那就通过内置的 super 函数沿用由 mix-in 超类所给出默认实现方案。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="76532794507979340000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def _traverse(self, key, value):\n   if (isinstance(value, BinaryTreeWithParent) and\n            key == \'parent\'):\n      return value.value  # Prevent cycles\n   else:\n      return super()._traverse(key, value)`, `76532794507979340000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">_traverse</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token builtin">isinstance</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> BinaryTreeWithParent<span class="token punctuation">)</span> <span class="token keyword">and</span>\n            key <span class="token operator">==</span> <span class="token string">\'parent\'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n      <span class="token keyword">return</span> value<span class="token punctuation">.</span>value  <span class="token comment"># Prevent cycles</span>\n   <span class="token keyword">else</span><span class="token punctuation">:</span>\n      <span class="token keyword">return</span> <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>_traverse<span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在调用 <code class="language-text">BinaryTreeWithParent.to_dict</code> 就没有问题了，因为它所触发的是 BinaryTreeWithParent 自己的 <code class="language-text">_traverse</code> 方法，该方法不会再递归地处理循环引用。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="49510070246941114000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class ToDictMixin:\n    def _traverse_dict(self, instance_dict):\n        output = {}\n        for key, value in instance_dict.items():\n            output[key] = self._traverse(key, value)\n        return output\n\n    def _traverse(self, key, value):\n        if isinstance(value, ToDictMixin):\n            return value.to_dict()\n        elif isinstance(value, dict):\n            return self._traverse_dict(value)\n        elif isinstance(value, list):\n            return [self._traverse(key, i) for i in value]\n        elif hasattr(value, \'__dict__\'):\n            return self._traverse_dict(value.__dict__)\n        else:\n            return value\n\n    def to_dict(self):\n        return self._traverse_dict(self.__dict__)\n\n\nclass BinaryTree(ToDictMixin):\n    def __init__(self, value, left=None, right=None):\n        self.value = value\n        self.left = left\n        self.right = right\n\n\nclass BinaryTreeWithParent(BinaryTree):\n    def __init__(self, value, left=None,\n                 right=None, parent=None):\n        super().__init__(value, left=left, right=right)\n        self.parent = parent\n\n    def _traverse(self, key, value):\n        if (isinstance(value, BinaryTreeWithParent) and\n                key == \'parent\'):\n            return value.value  # Prevent cycles\n        else:\n            return super()._traverse(key, value)\n\n\nroot = BinaryTreeWithParent(10)\nroot.left = BinaryTreeWithParent(7, parent=root)\nroot.left.right = BinaryTreeWithParent(9, parent=root.left)\nprint(root.to_dict())\n\n>>>\n{\'value\': 10, \'left\': {\'value\': 7, \'left\': None, \'right\': {\'value\': 9, \'left\': None, \'right\': None, \'parent\': 7}, \'parent\': 10}, \'right\': None, \'parent\': None}`, `49510070246941114000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py{37-42}"\n              >\n                <span class="gatsby-code-button-language">py{37-42}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">ToDictMixin</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">_traverse_dict</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> instance_dict<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        output <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n        <span class="token keyword">for</span> key<span class="token punctuation">,</span> value <span class="token keyword">in</span> instance_dict<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            output<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>_traverse<span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n        <span class="token keyword">return</span> output\n\n    <span class="token keyword">def</span> <span class="token function">_traverse</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> ToDictMixin<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> value<span class="token punctuation">.</span>to_dict<span class="token punctuation">(</span><span class="token punctuation">)</span>\n        <span class="token keyword">elif</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> self<span class="token punctuation">.</span>_traverse_dict<span class="token punctuation">(</span>value<span class="token punctuation">)</span>\n        <span class="token keyword">elif</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> <span class="token punctuation">[</span>self<span class="token punctuation">.</span>_traverse<span class="token punctuation">(</span>key<span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> value<span class="token punctuation">]</span>\n        <span class="token keyword">elif</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token string">\'__dict__\'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> self<span class="token punctuation">.</span>_traverse_dict<span class="token punctuation">(</span>value<span class="token punctuation">.</span>__dict__<span class="token punctuation">)</span>\n        <span class="token keyword">else</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> value\n\n    <span class="token keyword">def</span> <span class="token function">to_dict</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_traverse_dict<span class="token punctuation">(</span>self<span class="token punctuation">.</span>__dict__<span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">BinaryTree</span><span class="token punctuation">(</span>ToDictMixin<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">,</span> left<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> right<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>value <span class="token operator">=</span> value\n        self<span class="token punctuation">.</span>left <span class="token operator">=</span> left\n        self<span class="token punctuation">.</span>right <span class="token operator">=</span> right\n\n\n<span class="token keyword">class</span> <span class="token class-name">BinaryTreeWithParent</span><span class="token punctuation">(</span>BinaryTree<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">,</span> left<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>\n                 right<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> parent<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>value<span class="token punctuation">,</span> left<span class="token operator">=</span>left<span class="token punctuation">,</span> right<span class="token operator">=</span>right<span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>parent <span class="token operator">=</span> parent\n\n<span class="gatsby-highlight-code-line">    <span class="token keyword">def</span> <span class="token function">_traverse</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token builtin">isinstance</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> BinaryTreeWithParent<span class="token punctuation">)</span> <span class="token keyword">and</span></span><span class="gatsby-highlight-code-line">                key <span class="token operator">==</span> <span class="token string">\'parent\'</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">            <span class="token keyword">return</span> value<span class="token punctuation">.</span>value  <span class="token comment"># Prevent cycles</span></span><span class="gatsby-highlight-code-line">        <span class="token keyword">else</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">            <span class="token keyword">return</span> <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>_traverse<span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span></span>\n\nroot <span class="token operator">=</span> BinaryTreeWithParent<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>\nroot<span class="token punctuation">.</span>left <span class="token operator">=</span> BinaryTreeWithParent<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> parent<span class="token operator">=</span>root<span class="token punctuation">)</span>\nroot<span class="token punctuation">.</span>left<span class="token punctuation">.</span>right <span class="token operator">=</span> BinaryTreeWithParent<span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">,</span> parent<span class="token operator">=</span>root<span class="token punctuation">.</span>left<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>to_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">{</span><span class="token string">\'value\'</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token string">\'left\'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">\'value\'</span><span class="token punctuation">:</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token string">\'left\'</span><span class="token punctuation">:</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token string">\'right\'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">\'value\'</span><span class="token punctuation">:</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token string">\'left\'</span><span class="token punctuation">:</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token string">\'right\'</span><span class="token punctuation">:</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token string">\'parent\'</span><span class="token punctuation">:</span> <span class="token number">7</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">\'parent\'</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">\'right\'</span><span class="token punctuation">:</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token string">\'parent\'</span><span class="token punctuation">:</span> <span class="token boolean">None</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>只要 <code class="language-text">BinaryTreeWithParent._traverse</code> 没问题，带有 BinaryTreeWithParent 属性的其他类就可以直接继承 ToDictMixin，这样的话，程序在把这种对象转化成字典时，会自动对其中的 BinaryTreeWithParent 属性做出正确处理。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="43103376630259490000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class ToDictMixin:\n    def _traverse_dict(self, instance_dict):\n        output = {}\n        for key, value in instance_dict.items():\n            output[key] = self._traverse(key, value)\n        return output\n\n    def _traverse(self, key, value):\n        if isinstance(value, ToDictMixin):\n            return value.to_dict()\n        elif isinstance(value, dict):\n            return self._traverse_dict(value)\n        elif isinstance(value, list):\n            return [self._traverse(key, i) for i in value]\n        elif hasattr(value, \'__dict__\'):\n            return self._traverse_dict(value.__dict__)\n        else:\n            return value\n\n    def to_dict(self):\n        return self._traverse_dict(self.__dict__)\n\n\nclass BinaryTree(ToDictMixin):\n    def __init__(self, value, left=None, right=None):\n        self.value = value\n        self.left = left\n        self.right = right\n\n\nclass BinaryTreeWithParent(BinaryTree):\n    def __init__(self, value, left=None,\n                 right=None, parent=None):\n        super().__init__(value, left=left, right=right)\n        self.parent = parent\n\n    def _traverse(self, key, value):\n        if (isinstance(value, BinaryTreeWithParent) and\n                key == \'parent\'):\n            return value.value  # Prevent cycles\n        else:\n            return super()._traverse(key, value)\n\n\nclass NamedSubTree(ToDictMixin):\n    def __init__(self, name, tree_with_parent):\n        self.name = name\n        self.tree_with_parent = tree_with_parent\n\n\nroot = BinaryTreeWithParent(10)\nroot.left = BinaryTreeWithParent(7, parent=root)\nroot.left.right = BinaryTreeWithParent(9, parent=root.left)\n\nmy_tree = NamedSubTree(\'foobar\', root.left.right)\nprint(my_tree.to_dict())  # No infinite loop\n\n>>>\n{\'name\': \'foobar\', \'tree_with_parent\': {\'value\': 9, \'left\': None, \'right\': None, \'parent\': 7}}`, `43103376630259490000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py{45-48,55-56}"\n              >\n                <span class="gatsby-code-button-language">py{45-48,55-56}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">ToDictMixin</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">_traverse_dict</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> instance_dict<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        output <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n        <span class="token keyword">for</span> key<span class="token punctuation">,</span> value <span class="token keyword">in</span> instance_dict<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            output<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>_traverse<span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n        <span class="token keyword">return</span> output\n\n    <span class="token keyword">def</span> <span class="token function">_traverse</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> ToDictMixin<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> value<span class="token punctuation">.</span>to_dict<span class="token punctuation">(</span><span class="token punctuation">)</span>\n        <span class="token keyword">elif</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> self<span class="token punctuation">.</span>_traverse_dict<span class="token punctuation">(</span>value<span class="token punctuation">)</span>\n        <span class="token keyword">elif</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> <span class="token punctuation">[</span>self<span class="token punctuation">.</span>_traverse<span class="token punctuation">(</span>key<span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> value<span class="token punctuation">]</span>\n        <span class="token keyword">elif</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token string">\'__dict__\'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> self<span class="token punctuation">.</span>_traverse_dict<span class="token punctuation">(</span>value<span class="token punctuation">.</span>__dict__<span class="token punctuation">)</span>\n        <span class="token keyword">else</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> value\n\n    <span class="token keyword">def</span> <span class="token function">to_dict</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_traverse_dict<span class="token punctuation">(</span>self<span class="token punctuation">.</span>__dict__<span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">BinaryTree</span><span class="token punctuation">(</span>ToDictMixin<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">,</span> left<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> right<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>value <span class="token operator">=</span> value\n        self<span class="token punctuation">.</span>left <span class="token operator">=</span> left\n        self<span class="token punctuation">.</span>right <span class="token operator">=</span> right\n\n\n<span class="token keyword">class</span> <span class="token class-name">BinaryTreeWithParent</span><span class="token punctuation">(</span>BinaryTree<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">,</span> left<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>\n                 right<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> parent<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>value<span class="token punctuation">,</span> left<span class="token operator">=</span>left<span class="token punctuation">,</span> right<span class="token operator">=</span>right<span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>parent <span class="token operator">=</span> parent\n\n    <span class="token keyword">def</span> <span class="token function">_traverse</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token builtin">isinstance</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> BinaryTreeWithParent<span class="token punctuation">)</span> <span class="token keyword">and</span>\n                key <span class="token operator">==</span> <span class="token string">\'parent\'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> value<span class="token punctuation">.</span>value  <span class="token comment"># Prevent cycles</span>\n        <span class="token keyword">else</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>_traverse<span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n\n\n<span class="gatsby-highlight-code-line"><span class="token keyword">class</span> <span class="token class-name">NamedSubTree</span><span class="token punctuation">(</span>ToDictMixin<span class="token punctuation">)</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> tree_with_parent<span class="token punctuation">)</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">        self<span class="token punctuation">.</span>name <span class="token operator">=</span> name</span><span class="gatsby-highlight-code-line">        self<span class="token punctuation">.</span>tree_with_parent <span class="token operator">=</span> tree_with_parent</span>\n\nroot <span class="token operator">=</span> BinaryTreeWithParent<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>\nroot<span class="token punctuation">.</span>left <span class="token operator">=</span> BinaryTreeWithParent<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> parent<span class="token operator">=</span>root<span class="token punctuation">)</span>\nroot<span class="token punctuation">.</span>left<span class="token punctuation">.</span>right <span class="token operator">=</span> BinaryTreeWithParent<span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">,</span> parent<span class="token operator">=</span>root<span class="token punctuation">.</span>left<span class="token punctuation">)</span>\n\n<span class="gatsby-highlight-code-line">my_tree <span class="token operator">=</span> NamedSubTree<span class="token punctuation">(</span><span class="token string">\'foobar\'</span><span class="token punctuation">,</span> root<span class="token punctuation">.</span>left<span class="token punctuation">.</span>right<span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">print</span><span class="token punctuation">(</span>my_tree<span class="token punctuation">.</span>to_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># No infinite loop</span></span>\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">{</span><span class="token string">\'name\'</span><span class="token punctuation">:</span> <span class="token string">\'foobar\'</span><span class="token punctuation">,</span> <span class="token string">\'tree_with_parent\'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">\'value\'</span><span class="token punctuation">:</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token string">\'left\'</span><span class="token punctuation">:</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token string">\'right\'</span><span class="token punctuation">:</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token string">\'parent\'</span><span class="token punctuation">:</span> <span class="token number">7</span><span class="token punctuation">}</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>多个 mix-in 可以组合起来用。例如，我们要再写一个 mix-in，让所有的类都可以通过继承它来实现 JSON 序列化功能。在编写这个 mix-in 时，假设继承了它的那个类肯定有自己的 <code class="language-text">to_dict</code> 方法（这个方法有可能是从另一个 mix-in（如 ToDictMixin）继承的）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="20972666133462600000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import json\n\n\nclass JsonMixin:\n    @classmethod\n    def from_json(cls, data):\n        kwargs = json.loads(data)\n        return cls(**kwargs)\n\n    def to_json(self):\n        return json.dumps(self.to_dict())`, `20972666133462600000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> json\n\n\n<span class="token keyword">class</span> <span class="token class-name">JsonMixin</span><span class="token punctuation">:</span>\n    @<span class="token builtin">classmethod</span>\n    <span class="token keyword">def</span> <span class="token function">from_json</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        kwargs <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>data<span class="token punctuation">)</span>\n        <span class="token keyword">return</span> cls<span class="token punctuation">(</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">to_json</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>self<span class="token punctuation">.</span>to_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>请注意，JsonMixin 既定义了实例方法，也定义了类方法。于是，继承了这个 mix-in 的其他类也会拥有这两种行为。在本例中，继承 JsonMixin 的类只需要提供 <code class="language-text">to_dict</code> 方法以及能够接受关键字参数的 <code class="language-text">__init__</code> 方法即可（参见第 23 条）。</p>\n<p>有了这样两个 mix-in，我们很容易就能创建一套含有工具类的体系，让其中的各种类型都可以把对象序列化成 JSON 格式并且能够根据 JSON 格式的数据创建这样的对象。而这只需要开发者按照固定的样式多写一点点代码即可。例如，可以用这样一套由数据类所构成的体系表示数据中心的各种设备与它们之间的结构关系。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="10093717617055642000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import json\n\n\nclass ToDictMixin:\n    def _traverse_dict(self, instance_dict):\n        output = {}\n        for key, value in instance_dict.items():\n            output[key] = self._traverse(key, value)\n        return output\n\n    def _traverse(self, key, value):\n        if isinstance(value, ToDictMixin):\n            return value.to_dict()\n        elif isinstance(value, dict):\n            return self._traverse_dict(value)\n        elif isinstance(value, list):\n            return [self._traverse(key, i) for i in value]\n        elif hasattr(value, \'__dict__\'):\n            return self._traverse_dict(value.__dict__)\n        else:\n            return value\n\n    def to_dict(self):\n        return self._traverse_dict(self.__dict__)\n\n\nclass JsonMixin:\n    @classmethod\n    def from_json(cls, data):\n        kwargs = json.loads(data)\n        return cls(**kwargs)\n\n    def to_json(self):\n        return json.dumps(self.to_dict())\n\n\nclass Switch(ToDictMixin, JsonMixin):\n    def __init__(self, ports=None, speed=None):\n        self.ports = ports\n        self.speed = speed\n\n\nclass Machine(ToDictMixin, JsonMixin):\n    def __init__(self, cores=None, ram=None, disk=None):\n        self.cores = cores\n        self.ram = ram\n        self.disk = disk\n\n\nclass DatacenterRack(ToDictMixin, JsonMixin):\n    def __init__(self, switch=None, machines=None):\n        self.switch = Switch(**switch)\n        self.machines = [\n            Machine(**kwargs) for kwargs in machines]\n\n\nserialized = &quot;&quot;&quot;{\n    &quot;switch&quot;: {&quot;ports&quot;: 5, &quot;speed&quot;: 1e9},\n    &quot;machines&quot;: [\n        {&quot;cores&quot;: 8, &quot;ram&quot;: 32e9, &quot;disk&quot;: 5e12},\n        {&quot;cores&quot;: 4, &quot;ram&quot;: 16e9, &quot;disk&quot;: 1e12},\n        {&quot;cores&quot;: 2, &quot;ram&quot;: 4e9, &quot;disk&quot;: 500e9}\n    ]\n}\n&quot;&quot;&quot;\n\ndeserialized = DatacenterRack.from_json(serialized)\nroundtrip = deserialized.to_json()\nassert json.loads(serialized) == json.loads(roundtrip)`, `10093717617055642000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> json\n\n\n<span class="token keyword">class</span> <span class="token class-name">ToDictMixin</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">_traverse_dict</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> instance_dict<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        output <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n        <span class="token keyword">for</span> key<span class="token punctuation">,</span> value <span class="token keyword">in</span> instance_dict<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            output<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>_traverse<span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n        <span class="token keyword">return</span> output\n\n    <span class="token keyword">def</span> <span class="token function">_traverse</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> ToDictMixin<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> value<span class="token punctuation">.</span>to_dict<span class="token punctuation">(</span><span class="token punctuation">)</span>\n        <span class="token keyword">elif</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> self<span class="token punctuation">.</span>_traverse_dict<span class="token punctuation">(</span>value<span class="token punctuation">)</span>\n        <span class="token keyword">elif</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> <span class="token punctuation">[</span>self<span class="token punctuation">.</span>_traverse<span class="token punctuation">(</span>key<span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> value<span class="token punctuation">]</span>\n        <span class="token keyword">elif</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token string">\'__dict__\'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> self<span class="token punctuation">.</span>_traverse_dict<span class="token punctuation">(</span>value<span class="token punctuation">.</span>__dict__<span class="token punctuation">)</span>\n        <span class="token keyword">else</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> value\n\n    <span class="token keyword">def</span> <span class="token function">to_dict</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_traverse_dict<span class="token punctuation">(</span>self<span class="token punctuation">.</span>__dict__<span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">JsonMixin</span><span class="token punctuation">:</span>\n    @<span class="token builtin">classmethod</span>\n    <span class="token keyword">def</span> <span class="token function">from_json</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        kwargs <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>data<span class="token punctuation">)</span>\n        <span class="token keyword">return</span> cls<span class="token punctuation">(</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">to_json</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>self<span class="token punctuation">.</span>to_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">Switch</span><span class="token punctuation">(</span>ToDictMixin<span class="token punctuation">,</span> JsonMixin<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> ports<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> speed<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>ports <span class="token operator">=</span> ports\n        self<span class="token punctuation">.</span>speed <span class="token operator">=</span> speed\n\n\n<span class="token keyword">class</span> <span class="token class-name">Machine</span><span class="token punctuation">(</span>ToDictMixin<span class="token punctuation">,</span> JsonMixin<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> cores<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> ram<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> disk<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>cores <span class="token operator">=</span> cores\n        self<span class="token punctuation">.</span>ram <span class="token operator">=</span> ram\n        self<span class="token punctuation">.</span>disk <span class="token operator">=</span> disk\n\n\n<span class="token keyword">class</span> <span class="token class-name">DatacenterRack</span><span class="token punctuation">(</span>ToDictMixin<span class="token punctuation">,</span> JsonMixin<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> switch<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> machines<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>switch <span class="token operator">=</span> Switch<span class="token punctuation">(</span><span class="token operator">**</span>switch<span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>machines <span class="token operator">=</span> <span class="token punctuation">[</span>\n            Machine<span class="token punctuation">(</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span> <span class="token keyword">for</span> kwargs <span class="token keyword">in</span> machines<span class="token punctuation">]</span>\n\n\nserialized <span class="token operator">=</span> <span class="token triple-quoted-string string">"""{\n    "switch": {"ports": 5, "speed": 1e9},\n    "machines": [\n        {"cores": 8, "ram": 32e9, "disk": 5e12},\n        {"cores": 4, "ram": 16e9, "disk": 1e12},\n        {"cores": 2, "ram": 4e9, "disk": 500e9}\n    ]\n}\n"""</span>\n\ndeserialized <span class="token operator">=</span> DatacenterRack<span class="token punctuation">.</span>from_json<span class="token punctuation">(</span>serialized<span class="token punctuation">)</span>\nroundtrip <span class="token operator">=</span> deserialized<span class="token punctuation">.</span>to_json<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">assert</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>serialized<span class="token punctuation">)</span> <span class="token operator">==</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>roundtrip<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样写之后，我们很容易就能根据 JSON 格式的信息把这些对象还原出来，另外，也可以把它们再序列化成 JSON 格式。下面我们就先把 serialized 变量所指的一段 JSON 信息反序列化（也就是还原）成 DatacenterRack 对象，然后再把这个对象序列化成 JSON 信息并保存到 roundtrip 变量，最后通过 json.loads 方法验证这两个变量中的信息是否等效。</p>\n<p>对于 JsonMixin 这样的 mix-in 来说，即便直接继承它的那个类还通过类体系中的其他更高层类型间接地继承了它，程序也依然能够正常运行，因为 Python 可以把相关的方法正确地派发给 JsonMixin 类。</p>\n<h3 id="总结-37"><a href="#%E6%80%BB%E7%BB%93-37" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>超类最好能写成不带实例属性与 <code class="language-text">__init__</code> 方法的 mix-in 类，以避免由多重继承所引发的一些问题。</li>\n<li>如果子类要定制（或者说修改）mix-in 所提供的功能，那么可以在自己的代码里面覆盖相关的实例方法。</li>\n<li>根据需求，mix-in 可以只提供实例方法，也可以只提供类方法，还可以同时提供这两种方法。</li>\n<li>把每个 mix-in 所提供的简单功能组合起来，可以实现比较复杂的功能。</li>\n</ol>\n<h2 id="第-42-条：优先考虑用-public-属性表示应受保护的数据，不要用-private-属性表示"><a href="#%E7%AC%AC-42-%E6%9D%A1%EF%BC%9A%E4%BC%98%E5%85%88%E8%80%83%E8%99%91%E7%94%A8-public-%E5%B1%9E%E6%80%A7%E8%A1%A8%E7%A4%BA%E5%BA%94%E5%8F%97%E4%BF%9D%E6%8A%A4%E7%9A%84%E6%95%B0%E6%8D%AE%EF%BC%8C%E4%B8%8D%E8%A6%81%E7%94%A8-private-%E5%B1%9E%E6%80%A7%E8%A1%A8%E7%A4%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 42 条：优先考虑用 public 属性表示应受保护的数据，不要用 private 属性表示</h2>\n<p>Python 类的属性只有两种访问级别，也就是 public 与 private。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="5240251428712672000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class MyObject:\n    def __init__(self):\n        self.public_field = 5\n        self.__private_field = 10\n\n    def get_private_field(self):\n        return self.__private_field`, `5240251428712672000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">MyObject</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>public_field <span class="token operator">=</span> <span class="token number">5</span>\n        self<span class="token punctuation">.</span>__private_field <span class="token operator">=</span> <span class="token number">10</span>\n\n    <span class="token keyword">def</span> <span class="token function">get_private_field</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>__private_field</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>public 属性能够公开访问，只需要在对象后面加上圆点操作符（dot operator），并写出属性的名称即可。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="49152727102008480000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class MyObject:\n    def __init__(self):\n        self.public_field = 5\n        self.__private_field = 10\n\n    def get_private_field(self):\n        return self.__private_field\n\n\nfoo = MyObject()\nassert foo.public_field == 5`, `49152727102008480000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py{10-11}"\n              >\n                <span class="gatsby-code-button-language">py{10-11}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">MyObject</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>public_field <span class="token operator">=</span> <span class="token number">5</span>\n        self<span class="token punctuation">.</span>__private_field <span class="token operator">=</span> <span class="token number">10</span>\n\n    <span class="token keyword">def</span> <span class="token function">get_private_field</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>__private_field\n\n\n<span class="gatsby-highlight-code-line">foo <span class="token operator">=</span> MyObject<span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">assert</span> foo<span class="token punctuation">.</span>public_field <span class="token operator">==</span> <span class="token number">5</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果属性名以两个下划线开头，那么即为 private 字段。属性所在的类可以通过实例方法访问该属性。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="97898583928457410000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class MyObject:\n    def __init__(self):\n        self.public_field = 5\n        self.__private_field = 10\n\n    def get_private_field(self):\n        return self.__private_field\n\n\nfoo = MyObject()\nassert foo.get_private_field() == 10`, `97898583928457410000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py{11}"\n              >\n                <span class="gatsby-code-button-language">py{11}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">MyObject</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>public_field <span class="token operator">=</span> <span class="token number">5</span>\n        self<span class="token punctuation">.</span>__private_field <span class="token operator">=</span> <span class="token number">10</span>\n\n    <span class="token keyword">def</span> <span class="token function">get_private_field</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>__private_field\n\n\nfoo <span class="token operator">=</span> MyObject<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">assert</span> foo<span class="token punctuation">.</span>get_private_field<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">10</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>但如果在类的外面直接通过对象访问 private 字段，那么程序就会抛出异常。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="24994245162377716000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class MyObject:\n    def __init__(self):\n        self.public_field = 5\n        self.__private_field = 10\n\n    def get_private_field(self):\n        return self.__private_field\n\n\nfoo = MyObject()\nfoo.__private_field\n\n>>>\nTraceback ...\nAttributeError: \'MyObject\' object has no attribute \'__private_field\'`, `24994245162377716000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py{11}"\n              >\n                <span class="gatsby-code-button-language">py{11}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">MyObject</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>public_field <span class="token operator">=</span> <span class="token number">5</span>\n        self<span class="token punctuation">.</span>__private_field <span class="token operator">=</span> <span class="token number">10</span>\n\n    <span class="token keyword">def</span> <span class="token function">get_private_field</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>__private_field\n\n\nfoo <span class="token operator">=</span> MyObject<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="gatsby-highlight-code-line">foo<span class="token punctuation">.</span>__private_field</span>\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nAttributeError<span class="token punctuation">:</span> <span class="token string">\'MyObject\'</span> <span class="token builtin">object</span> has no attribute <span class="token string">\'__private_field\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>类方法（@classmethod）可以访问本类的 private 属性，因为这种方法也是在这个类（class）的范围里面声明的。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="61653520658078120000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class MyOtherObject:\n    def __init__(self):\n        self.__private_field = 71\n\n    @classmethod\n    def get_private_field_of_instance(cls, instance):\n        return instance.__private_field\n\n\nbar = MyOtherObject()\nassert MyOtherObject.get_private_field_of_instance(bar) == 71`, `61653520658078120000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">MyOtherObject</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>__private_field <span class="token operator">=</span> <span class="token number">71</span>\n\n    @<span class="token builtin">classmethod</span>\n    <span class="token keyword">def</span> <span class="token function">get_private_field_of_instance</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> instance<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> instance<span class="token punctuation">.</span>__private_field\n\n\nbar <span class="token operator">=</span> MyOtherObject<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">assert</span> MyOtherObject<span class="token punctuation">.</span>get_private_field_of_instance<span class="token punctuation">(</span>bar<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">71</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>private 字段只给这个类自己使用，子类不能访问超类的 private 字段。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="78796548446863020000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class MyParentObject:\n    def __init__(self):\n        self.__private_field = 71\n\n\nclass MyChildObject(MyParentObject):\n    def get_private_field(self):\n        return self.__private_field\n\n\nbaz = MyChildObject()\nbaz.get_private_field()\n\n>>>\nTraceback ...\nAttributeError: \'MyChildObject\' object has no attribute \'_MyChildObject__private_field\'`, `78796548446863020000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">MyParentObject</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>__private_field <span class="token operator">=</span> <span class="token number">71</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">MyChildObject</span><span class="token punctuation">(</span>MyParentObject<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">get_private_field</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>__private_field\n\n\nbaz <span class="token operator">=</span> MyChildObject<span class="token punctuation">(</span><span class="token punctuation">)</span>\nbaz<span class="token punctuation">.</span>get_private_field<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nAttributeError<span class="token punctuation">:</span> <span class="token string">\'MyChildObject\'</span> <span class="token builtin">object</span> has no attribute <span class="token string">\'_MyChildObject__private_field\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这种防止其他类访问 private 属性的功能，其实仅仅是通过变换属性名称而实现的。当 Python 编译器看到 <code class="language-text">MyChildObject.get_private_field</code> 这样的方法想要访问 <code class="language-text">__private_field</code> 属性时，它会把下划线和类名加在这个属性名称的前面，所以代码实际上访问的是 <code class="language-text">_MyChildObject__private_field</code>。在上面的例子中，<code class="language-text">__private_field</code> 是在 MyParentObject 的 <code class="language-text">__init__</code> 里面定义的，所以，它变换之后的真实名称是 <code class="language-text">_MyParentObject__private_field</code>。子类不能通过 <code class="language-text">__private_field</code> 来访问这个属性，因为这样写实际上是在访问不存在的 <code class="language-text">_MyChildObject__private_field</code>，而不是 <code class="language-text">_MyParentObject__private_field</code>。</p>\n<p>了解名称变换规则后，我们就可以从任何一个类里面访问 private 属性。无论是子类还是外部的类，都可以不经许可就访问到这些属性。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="60102038390916550000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class MyParentObject:\n    def __init__(self):\n        self.__private_field = 71\n\n\nclass MyChildObject(MyParentObject):\n    def get_private_field(self):\n        return self.__private_field\n\n\nbaz = MyChildObject()\nassert baz._MyParentObject__private_field == 71`, `60102038390916550000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py{12}"\n              >\n                <span class="gatsby-code-button-language">py{12}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">MyParentObject</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>__private_field <span class="token operator">=</span> <span class="token number">71</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">MyChildObject</span><span class="token punctuation">(</span>MyParentObject<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">get_private_field</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>__private_field\n\n\nbaz <span class="token operator">=</span> MyChildObject<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">assert</span> baz<span class="token punctuation">.</span>_MyParentObject__private_field <span class="token operator">==</span> <span class="token number">71</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>查看该对象的属性字典，就会发现 private 属性的名称其实是以变换后的名称存储的。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="47425464116808655000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`print(baz.__dict__)\n\n>>>\n{\'_MyParentObject__private_field\': 71}`, `47425464116808655000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">print</span><span class="token punctuation">(</span>baz<span class="token punctuation">.</span>__dict__<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">{</span><span class="token string">\'_MyParentObject__private_field\'</span><span class="token punctuation">:</span> <span class="token number">71</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>为什么 Python 不从语法上严格禁止其他类访问 private 属性呢？这可以用一句常见的 Python 格言来回答：我们都是成年人了（We are all consenting adults here）。意思是说，我们用不着让编程语言把自己给拦住。你可以按照自己的想法扩展某个类的功能，同时也必须考虑到这样做的风险，并为此负责。Python 开发者相信，虽然开放访问权限可能导致别人不按默认方式扩展这个类，但总比封闭起来要好。</p>\n<p>另外，Python 里面还有一些挂钩函数可以访问到这种属性（参见第 47 条），我们可以通过这些机制按需操纵对象的内部数据。既然这样，那即便 Python 阻止我们通过圆点加名称的办法访问 private 属性，我们也还是有其他办法能访问到，那么 Python 阻止 private 属性访问又有何意义？</p>\n<p>为了减少在不知情情况下访问内部数据而造成的损伤，Python 开发者会按照风格指南里面建议的方式来给字段命名（参见第 2 条）。以单下划线开头的字段（例如 <code class="language-text">_protected_field</code>），习惯上叫作受保护的（protected）字段，表示这个类以外的用户在使用这种字段时必须慎重。</p>\n<p>尽管如此，有许多 Python 新手还是喜欢把内部的 API 设计成 private 字段，想通过这种写法防止子类或外部类访问这些字段。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="562130064263866050"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class MyStringClass:\n    def __init__(self, value):\n        self.__value = value\n\n    def get_value(self):\n        return str(self.__value)\n\n\nfoo = MyStringClass(5)\nassert foo.get_value() == \'5\'`, `562130064263866050`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">MyStringClass</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>__value <span class="token operator">=</span> value\n\n    <span class="token keyword">def</span> <span class="token function">get_value</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token builtin">str</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>__value<span class="token punctuation">)</span>\n\n\nfoo <span class="token operator">=</span> MyStringClass<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>\n<span class="token keyword">assert</span> foo<span class="token punctuation">.</span>get_value<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">\'5\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这么写不对。因为总会有开发者（也包括你自己）想要继承这个类，并给里面添加新的行为，或采用更高效的办法来实现已有的行为（例如他可能觉得，<code class="language-text">MyStringClass.get_value</code> 总是返回字符串的方式的效率不高）。如果把属性设为 private，那么子类在覆盖或扩充这个类的时候，就必须采用变换之后的名称来访问那个属性，这会让代码变得很容易出错。例如，在写这样一个子类时，就不得不去访问超类中的 private 字段。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="29611077973859310000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class MyStringClass:\n    def __init__(self, value):\n        self.__value = value\n\n    def get_value(self):\n        return str(self.__value)\n\n\nclass MyIntegerSubclass(MyStringClass):\n    def get_value(self):\n        return int(self._MyStringClass__value)\n\n\nfoo = MyIntegerSubclass(\'5\')\nassert foo.get_value() == 5`, `29611077973859310000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">MyStringClass</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>__value <span class="token operator">=</span> value\n\n    <span class="token keyword">def</span> <span class="token function">get_value</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token builtin">str</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>__value<span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">MyIntegerSubclass</span><span class="token punctuation">(</span>MyStringClass<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">get_value</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token builtin">int</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>_MyStringClass__value<span class="token punctuation">)</span>\n\n\nfoo <span class="token operator">=</span> MyIntegerSubclass<span class="token punctuation">(</span><span class="token string">\'5\'</span><span class="token punctuation">)</span>\n<span class="token keyword">assert</span> foo<span class="token punctuation">.</span>get_value<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">5</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样写的问题是，如果类体系发生变动，那么引用 private 属性的那些代码就失效了。例如，MyIntegerSubclass 类的直接超类（也就是 MyStringClass）本身现在也继承自一个类（叫作 MyBaseClass），而且它把早前的 <code class="language-text">__value</code> 属性移到了那个类里面。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="13395048298321144000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class MyBaseClass:\n    def __init__(self, value):\n        self.__value = value\n\n    def get_value(self):\n        return self.__value\n\n\nclass MyStringClass(MyBaseClass):\n    def get_value(self):\n        return str(super().get_value())  # Updated\n\n\nclass MyIntegerSubclass(MyStringClass):\n    def get_value(self):\n        return int(self._MyStringClass__value)  # Not updated\n\n\nfoo = MyIntegerSubclass(5)\nfoo.get_value()\n\n>>>\nTraceback ...\nAttributeError: \'MyIntegerSubclass\' object has no attribute \'_MyStringClass__value\'`, `13395048298321144000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">MyBaseClass</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>__value <span class="token operator">=</span> value\n\n    <span class="token keyword">def</span> <span class="token function">get_value</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>__value\n\n\n<span class="token keyword">class</span> <span class="token class-name">MyStringClass</span><span class="token punctuation">(</span>MyBaseClass<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">get_value</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get_value<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># Updated</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">MyIntegerSubclass</span><span class="token punctuation">(</span>MyStringClass<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">get_value</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token builtin">int</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>_MyStringClass__value<span class="token punctuation">)</span>  <span class="token comment"># Not updated</span>\n\n\nfoo <span class="token operator">=</span> MyIntegerSubclass<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>\nfoo<span class="token punctuation">.</span>get_value<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nAttributeError<span class="token punctuation">:</span> <span class="token string">\'MyIntegerSubclass\'</span> <span class="token builtin">object</span> has no attribute <span class="token string">\'_MyStringClass__value\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在的 <code class="language-text">__value</code> 属性，是在 MyBaseClass 里面设置的，而不是在 MyStringClass 里面，所以 MyIntegerSubclass 没办法再通过 <code class="language-text">self._MyStringClass__value</code> 访问这个属性。</p>\n<p>一般来说，这种属性应该设置成 protected 字段，这样虽然有可能导致子类误用，但还是要比直接设为 private 好。我们可以在每个 protected 字段的文档里面详细解释，告诉用户这是属于可以由子类来操作的内部 API，还是属于完全不应该触碰的数据。这样的文档，既可以给别人提供建议，也可以指导自己安全地扩充代码。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="94437896050826400000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class MyStringClass:\n    def __init__(self, value):\n        # This stores the user-supplied value for the object.\n        # It should be coercible to a string. Once assigned in\n        # the object it should be treated as immutable.\n        self._value = value`, `94437896050826400000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">MyStringClass</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token comment"># This stores the user-supplied value for the object.</span>\n        <span class="token comment"># It should be coercible to a string. Once assigned in</span>\n        <span class="token comment"># the object it should be treated as immutable.</span>\n        self<span class="token punctuation">.</span>_value <span class="token operator">=</span> value</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>只有一种情况是可以考虑用 private 属性解决的，就是子类属性有可能与超类重名的情况。如果子类定义属性时使用的名称，恰巧与超类相同，那就会出现这个问题。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="29841737798131462000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class ApiClass:\n    def __init__(self):\n        self._value = 5\n\n    def get(self):\n        return self._value\n\n\nclass Child(ApiClass):\n    def __init__(self):\n        super().__init__()\n        self._value = \'hello\'  # Conflicts\n\n\na = Child()\nprint(f\'{a.get()} and {a._value} should be different\')`, `29841737798131462000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">ApiClass</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>_value <span class="token operator">=</span> <span class="token number">5</span>\n\n    <span class="token keyword">def</span> <span class="token function">get</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_value\n\n\n<span class="token keyword">class</span> <span class="token class-name">Child</span><span class="token punctuation">(</span>ApiClass<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>_value <span class="token operator">=</span> <span class="token string">\'hello\'</span>  <span class="token comment"># Conflicts</span>\n\n\na <span class="token operator">=</span> Child<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>a<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> and </span><span class="token interpolation"><span class="token punctuation">{</span>a<span class="token punctuation">.</span>_value<span class="token punctuation">}</span></span><span class="token string"> should be different\'</span></span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果超类属于开放给外界使用的 API，那么你就没办法预料哪些子类会继承它，也不知道那些子类会添加什么属性，此时很有可能出现这个问题，而且你无法通过重构代码来解决。属性名越常见（如本例中的 value），越容易发生冲突。为了减少冲突，我们可以把超类的属性设计成 private 属性，使子类的属性名不太可能与超类重复。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="1469669270446005800"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class ApiClass:\n    def __init__(self):\n        self.__value = 5  # Double underscore\n\n    def get(self):\n        return self.__value  # Double underscore\n\n\nclass Child(ApiClass):\n    def __init__(self):\n        super().__init__()\n        self._value = \'hello\'  # OK!\n\n\na = Child()\nprint(f\'{a.get()} and {a._value} are different\')`, `1469669270446005800`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">ApiClass</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>__value <span class="token operator">=</span> <span class="token number">5</span>  <span class="token comment"># Double underscore</span>\n\n    <span class="token keyword">def</span> <span class="token function">get</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>__value  <span class="token comment"># Double underscore</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">Child</span><span class="token punctuation">(</span>ApiClass<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>_value <span class="token operator">=</span> <span class="token string">\'hello\'</span>  <span class="token comment"># OK!</span>\n\n\na <span class="token operator">=</span> Child<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>a<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> and </span><span class="token interpolation"><span class="token punctuation">{</span>a<span class="token punctuation">.</span>_value<span class="token punctuation">}</span></span><span class="token string"> are different\'</span></span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="总结-38"><a href="#%E6%80%BB%E7%BB%93-38" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>Python 编译器无法绝对禁止外界访问 private 属性。</li>\n<li>从一开始就应该考虑允许其他类能继承这个类，并利用其中的内部 API 与属性去实现更多功能，而不是把它们藏起来。</li>\n<li>把需要保护的数据设计成 protected 字段，并用文档加以解释，而不要通过 private 属性限制访问。</li>\n<li>只有在子类不受控制且名称有可能与超类冲突时，才可以考虑给超类设计 private 属性。</li>\n</ol>\n<h2 id="第-43-条：自定义的容器类型应该从-collectionsabc-继承"><a href="#%E7%AC%AC-43-%E6%9D%A1%EF%BC%9A%E8%87%AA%E5%AE%9A%E4%B9%89%E7%9A%84%E5%AE%B9%E5%99%A8%E7%B1%BB%E5%9E%8B%E5%BA%94%E8%AF%A5%E4%BB%8E-collectionsabc-%E7%BB%A7%E6%89%BF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 43 条：自定义的容器类型应该从 collections.abc 继承</h2>\n<p>编写 Python 程序时，要花很多精力来定义类，以存放数据并描述这种对象与其他对象之间的关系。每个 Python 类其实都是某种容器，可以把属性与功能封装进来。除了自定义的类之外，Python 本身还提供了一些内置的容器类型，例如列表（list）、元组（tuple）、集合（set）、字典（dict）等，也可以用来管理数据。</p>\n<p>如果要定义的是那种用法比较简单的类，那么我们自然就会想到直接从 Python 内置的容器类型里面继承，例如通过继承 list 类型实现某种序列。下面就是笔者自己定制的一种 list 类型，它在 list 的基础上提供了 frequency 方法，用来计算每个元素出现的次数。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="27613359045348962000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class FrequencyList(list):\n    def __init__(self, members):\n        super().__init__(members)\n\n    def frequency(self):\n        counts = {}\n        for item in self:\n            counts[item] = counts.get(item, 0) + 1\n        return counts`, `27613359045348962000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">FrequencyList</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> members<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>members<span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">frequency</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        counts <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n        <span class="token keyword">for</span> item <span class="token keyword">in</span> self<span class="token punctuation">:</span>\n            counts<span class="token punctuation">[</span>item<span class="token punctuation">]</span> <span class="token operator">=</span> counts<span class="token punctuation">.</span>get<span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span>\n        <span class="token keyword">return</span> counts</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>继承 list 类，可以自动获得标准的 Python 列表所具备的各项功能。这样的话，其他开发者就可以像使用普通列表那样使用 FrequencyList 了。此外，我们还可以定义其他一些方法，来提供想要实现的各种行为。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="50368323671341280000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class FrequencyList(list):\n    def __init__(self, members):\n        super().__init__(members)\n\n    def frequency(self):\n        counts = {}\n        for item in self:\n            counts[item] = counts.get(item, 0) + 1\n        return counts\n\n\nfoo = FrequencyList([\'a\', \'b\', \'a\', \'c\', \'b\', \'a\', \'d\'])\nprint(\'Length is\', len(foo))\n\nprint(foo.pop())\nprint(\'After pop:\', repr(foo))\nprint(\'Frequency:\', foo.frequency())\n\n>>>\nLength is 7\nd\nAfter pop: [\'a\', \'b\', \'a\', \'c\', \'b\', \'a\']\nFrequency: {\'a\': 3, \'b\': 2, \'c\': 1}`, `50368323671341280000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py{12-17}"\n              >\n                <span class="gatsby-code-button-language">py{12-17}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">FrequencyList</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> members<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>members<span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">frequency</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        counts <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n        <span class="token keyword">for</span> item <span class="token keyword">in</span> self<span class="token punctuation">:</span>\n            counts<span class="token punctuation">[</span>item<span class="token punctuation">]</span> <span class="token operator">=</span> counts<span class="token punctuation">.</span>get<span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span>\n        <span class="token keyword">return</span> counts\n\n\n<span class="gatsby-highlight-code-line">foo <span class="token operator">=</span> FrequencyList<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">,</span> <span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'c\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">,</span> <span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'d\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Length is\'</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>foo<span class="token punctuation">)</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line"><span class="token keyword">print</span><span class="token punctuation">(</span>foo<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'After pop:\'</span><span class="token punctuation">,</span> <span class="token builtin">repr</span><span class="token punctuation">(</span>foo<span class="token punctuation">)</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Frequency:\'</span><span class="token punctuation">,</span> foo<span class="token punctuation">.</span>frequency<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>\n<span class="token operator">>></span><span class="token operator">></span>\nLength <span class="token keyword">is</span> <span class="token number">7</span>\nd\nAfter pop<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">,</span> <span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'c\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">,</span> <span class="token string">\'a\'</span><span class="token punctuation">]</span>\nFrequency<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">\'a\'</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">\'c\'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>有的时候，某个对象所属的类本身虽然不是 list 的子类，但我们还是想让它能像 list 那样，可以通过下标来访问。例如，下面这个表示二叉树节点的 BinaryNode 类就不是 list 的子类，但我们想让它能够像序列（list 或 tuple 等）那样，通过下标来访问。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="90496818222199460000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class BinaryNode:\n    def __init__(self, value, left=None, right=None):\n        self.value = value\n        self.left = left\n        self.right = right`, `90496818222199460000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">BinaryNode</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">,</span> left<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> right<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>value <span class="token operator">=</span> value\n        self<span class="token punctuation">.</span>left <span class="token operator">=</span> left\n        self<span class="token punctuation">.</span>right <span class="token operator">=</span> right</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们需要怎么做，才能让这个类可以像序列一样访问呢？答案是，需要实现一些名称特殊的实例方法。当通过下标访问序列中的元素时：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="67300136897988305000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`bar = [1, 2, 3]\nbar[0]`, `67300136897988305000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">bar <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span>\nbar<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>Python 会把访问操作解读为：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="24857978780826540000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`bar.__getitem__(0)`, `24857978780826540000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">bar<span class="token punctuation">.</span>__getitem__<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>所以，为了让 BinaryNode 类能像序列那样使用，我们可以定义 <code class="language-text">__getitem__</code> 方法（一般叫作 dunder getitem，其中的 dunder 为 double underscore（双下划线）的简称）。这个方法可以按照深度优先的方式遍历 BinaryNode 对象所表示的二叉树。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="2592128637237367300"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class BinaryNode:\n    def __init__(self, value, left=None, right=None):\n        self.value = value\n        self.left = left\n        self.right = right\n\n\nclass IndexableNode(BinaryNode):\n    def _traverse(self):\n        if self.left is not None:\n            yield from self.left._traverse()\n        yield self\n        if self.right is not None:\n            yield from self.right._traverse()\n\n    def __getitem__(self, index):\n        for i, item in enumerate(self._traverse()):\n            if i == index:\n                return item.value\n        raise IndexError(f\'Index {index} is out of range\')\n\n\ntree = IndexableNode(\n    10,\n    left=IndexableNode(\n        5,\n        left=IndexableNode(2),\n        right=IndexableNode(\n            6,\n            right=IndexableNode(7))),\n    right=IndexableNode(\n        15,\n        left=IndexableNode(11)))\n\nprint(\'LRR is\', tree.left.right.right.value)\nprint(\'Index 0 is\', tree[0])\nprint(\'Index 1 is\', tree[1])\nprint(\'11 in the tree?\', 11 in tree)\nprint(\'17 in the tree?\', 17 in tree)\nprint(\'Tree is\', list(tree))\n\n>>>\nLRR is 7\nIndex 0 is 2\nIndex 1 is 5\n11 in the tree? True\n17 in the tree? False\nTree is [2, 5, 6, 7, 10, 11, 15]`, `2592128637237367300`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">BinaryNode</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">,</span> left<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> right<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>value <span class="token operator">=</span> value\n        self<span class="token punctuation">.</span>left <span class="token operator">=</span> left\n        self<span class="token punctuation">.</span>right <span class="token operator">=</span> right\n\n\n<span class="token keyword">class</span> <span class="token class-name">IndexableNode</span><span class="token punctuation">(</span>BinaryNode<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">_traverse</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> self<span class="token punctuation">.</span>left <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>\n            <span class="token keyword">yield</span> <span class="token keyword">from</span> self<span class="token punctuation">.</span>left<span class="token punctuation">.</span>_traverse<span class="token punctuation">(</span><span class="token punctuation">)</span>\n        <span class="token keyword">yield</span> self\n        <span class="token keyword">if</span> self<span class="token punctuation">.</span>right <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>\n            <span class="token keyword">yield</span> <span class="token keyword">from</span> self<span class="token punctuation">.</span>right<span class="token punctuation">.</span>_traverse<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">__getitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">for</span> i<span class="token punctuation">,</span> item <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>_traverse<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">if</span> i <span class="token operator">==</span> index<span class="token punctuation">:</span>\n                <span class="token keyword">return</span> item<span class="token punctuation">.</span>value\n        <span class="token keyword">raise</span> IndexError<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Index </span><span class="token interpolation"><span class="token punctuation">{</span>index<span class="token punctuation">}</span></span><span class="token string"> is out of range\'</span></span><span class="token punctuation">)</span>\n\n\ntree <span class="token operator">=</span> IndexableNode<span class="token punctuation">(</span>\n    <span class="token number">10</span><span class="token punctuation">,</span>\n    left<span class="token operator">=</span>IndexableNode<span class="token punctuation">(</span>\n        <span class="token number">5</span><span class="token punctuation">,</span>\n        left<span class="token operator">=</span>IndexableNode<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n        right<span class="token operator">=</span>IndexableNode<span class="token punctuation">(</span>\n            <span class="token number">6</span><span class="token punctuation">,</span>\n            right<span class="token operator">=</span>IndexableNode<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    right<span class="token operator">=</span>IndexableNode<span class="token punctuation">(</span>\n        <span class="token number">15</span><span class="token punctuation">,</span>\n        left<span class="token operator">=</span>IndexableNode<span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'LRR is\'</span><span class="token punctuation">,</span> tree<span class="token punctuation">.</span>left<span class="token punctuation">.</span>right<span class="token punctuation">.</span>right<span class="token punctuation">.</span>value<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Index 0 is\'</span><span class="token punctuation">,</span> tree<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Index 1 is\'</span><span class="token punctuation">,</span> tree<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'11 in the tree?\'</span><span class="token punctuation">,</span> <span class="token number">11</span> <span class="token keyword">in</span> tree<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'17 in the tree?\'</span><span class="token punctuation">,</span> <span class="token number">17</span> <span class="token keyword">in</span> tree<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Tree is\'</span><span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">(</span>tree<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nLRR <span class="token keyword">is</span> <span class="token number">7</span>\nIndex <span class="token number">0</span> <span class="token keyword">is</span> <span class="token number">2</span>\nIndex <span class="token number">1</span> <span class="token keyword">is</span> <span class="token number">5</span>\n<span class="token number">11</span> <span class="token keyword">in</span> the tree? <span class="token boolean">True</span>\n<span class="token number">17</span> <span class="token keyword">in</span> the tree? <span class="token boolean">False</span>\nTree <span class="token keyword">is</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们可以像使用 BinaryNode 那样，用这种定制过的 IndexableNode 对象来构造二叉树。</p>\n<p>我们既可以像访问列表那样来访问二叉树中的节点，也可以明确通过 left 与 right 属性来访问。</p>\n<p>但问题是，除了下标索引，list 实例还支持其他一些功能，所以只实现 <code class="language-text">__getitem__</code> 这样一个特殊方法是不够的。例如，我们现在还是没办法像查询 list 长度那样查询这种二叉树的长度（元素总数）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="76771998222335670000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`len(tree)\n\n>>>\nTraceback ...\nTypeError: object of type \'IndexableNode\' has no len()`, `76771998222335670000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token builtin">len</span><span class="token punctuation">(</span>tree<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nTypeError<span class="token punctuation">:</span> <span class="token builtin">object</span> of <span class="token builtin">type</span> <span class="token string">\'IndexableNode\'</span> has no <span class="token builtin">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>要想让定制的二叉树支持内置的 len 函数，必须再实现一个特殊方法，也就是 <code class="language-text">__len__</code> 方法。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="13426055342654685000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class BinaryNode:\n    def __init__(self, value, left=None, right=None):\n        self.value = value\n        self.left = left\n        self.right = right\n\n\nclass SequenceNode(BinaryNode):\n    def _traverse(self):\n        if self.left is not None:\n            yield from self.left._traverse()\n        yield self\n        if self.right is not None:\n            yield from self.right._traverse()\n\n    def __getitem__(self, index):\n        for i, item in enumerate(self._traverse()):\n            if i == index:\n                return item.value\n        raise IndexError(f\'Index {index} is out of range\')\n\n    def __len__(self):\n        for count, _ in enumerate(self._traverse(), 1):\n            pass\n        return count\n\n\ntree = SequenceNode(\n    10,\n    left=SequenceNode(\n        5,\n        left=SequenceNode(2),\n        right=SequenceNode(\n            6,\n            right=SequenceNode(7))),\n    right=SequenceNode(\n        15,\n        left=SequenceNode(11)))\n\nprint(\'Tree length is\', len(tree))\n\n>>>\nTree length is 7`, `13426055342654685000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py{22-25}"\n              >\n                <span class="gatsby-code-button-language">py{22-25}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">BinaryNode</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">,</span> left<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> right<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>value <span class="token operator">=</span> value\n        self<span class="token punctuation">.</span>left <span class="token operator">=</span> left\n        self<span class="token punctuation">.</span>right <span class="token operator">=</span> right\n\n\n<span class="token keyword">class</span> <span class="token class-name">SequenceNode</span><span class="token punctuation">(</span>BinaryNode<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">_traverse</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> self<span class="token punctuation">.</span>left <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>\n            <span class="token keyword">yield</span> <span class="token keyword">from</span> self<span class="token punctuation">.</span>left<span class="token punctuation">.</span>_traverse<span class="token punctuation">(</span><span class="token punctuation">)</span>\n        <span class="token keyword">yield</span> self\n        <span class="token keyword">if</span> self<span class="token punctuation">.</span>right <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>\n            <span class="token keyword">yield</span> <span class="token keyword">from</span> self<span class="token punctuation">.</span>right<span class="token punctuation">.</span>_traverse<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">__getitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">for</span> i<span class="token punctuation">,</span> item <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>_traverse<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">if</span> i <span class="token operator">==</span> index<span class="token punctuation">:</span>\n                <span class="token keyword">return</span> item<span class="token punctuation">.</span>value\n        <span class="token keyword">raise</span> IndexError<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Index </span><span class="token interpolation"><span class="token punctuation">{</span>index<span class="token punctuation">}</span></span><span class="token string"> is out of range\'</span></span><span class="token punctuation">)</span>\n\n<span class="gatsby-highlight-code-line">    <span class="token keyword">def</span> <span class="token function">__len__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">        <span class="token keyword">for</span> count<span class="token punctuation">,</span> _ <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>_traverse<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">            <span class="token keyword">pass</span></span><span class="gatsby-highlight-code-line">        <span class="token keyword">return</span> count</span>\n\ntree <span class="token operator">=</span> SequenceNode<span class="token punctuation">(</span>\n    <span class="token number">10</span><span class="token punctuation">,</span>\n    left<span class="token operator">=</span>SequenceNode<span class="token punctuation">(</span>\n        <span class="token number">5</span><span class="token punctuation">,</span>\n        left<span class="token operator">=</span>SequenceNode<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n        right<span class="token operator">=</span>SequenceNode<span class="token punctuation">(</span>\n            <span class="token number">6</span><span class="token punctuation">,</span>\n            right<span class="token operator">=</span>SequenceNode<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    right<span class="token operator">=</span>SequenceNode<span class="token punctuation">(</span>\n        <span class="token number">15</span><span class="token punctuation">,</span>\n        left<span class="token operator">=</span>SequenceNode<span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Tree length is\'</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>tree<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTree length <span class="token keyword">is</span> <span class="token number">7</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>实现完这样两个方法之后，我们仍然没办法让这种二叉树具备列表所应支持的全套功能。因为，有些 Python 开发者可能还想在二叉树上面调用 count 与 index 等方法，他们觉得，既然 list 或 tuple 这样的序列支持这些方法，那二叉树也应该支持才对。这样看来，要定制一个与标准容器兼容的类，似乎比想象中麻烦。</p>\n<p>为了方便大家定制容器，Python 内置的 collections.abc 模块定义了一系列抽象基类（abstract base class），把每种容器类型应该提供的所有常用方法都写了出来。我们只需要从这样的抽象基类里面继承就好。同时，如果忘了实现某些必备的方法，那么程序会报错，提醒我们这些方法必须实现。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="10143211292331889000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from collections.abc import Sequence\n\n\nclass BadType(Sequence):\n    pass\n\n\nfoo = BadType()\n\n>>>\nTraceback ...\nTypeError: Can\'t instantiate abstract class BadType with abstract methods __getitem__, __len__`, `10143211292331889000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> collections<span class="token punctuation">.</span>abc <span class="token keyword">import</span> Sequence\n\n\n<span class="token keyword">class</span> <span class="token class-name">BadType</span><span class="token punctuation">(</span>Sequence<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n\nfoo <span class="token operator">=</span> BadType<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nTypeError<span class="token punctuation">:</span> Can\'t instantiate abstract <span class="token keyword">class</span> <span class="token class-name">BadType</span> <span class="token keyword">with</span> abstract methods __getitem__<span class="token punctuation">,</span> __len__</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果这些必备的方法都已经实现好了，那我们就可以从 collections.abc 模块的抽象基类里面继承了。例如，下面这个 BetterNode 二叉树类就是正确的，因为它已经通过继承前面的 SequenceNode 类实现了序列容器所应支持的全部必备方法，至于其他一些方法（例如 index 与 count）则会由 Sequence 这个抽象基类自动帮我们实现（它在实现的时候，会借助 BetterNode 从 SequenceNode 继承的那些必备方法）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="86939040813018070000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from collections.abc import Sequence\n\n\nclass BinaryNode:\n    def __init__(self, value, left=None, right=None):\n        self.value = value\n        self.left = left\n        self.right = right\n\n\nclass SequenceNode(BinaryNode):\n    def _traverse(self):\n        if self.left is not None:\n            yield from self.left._traverse()\n        yield self\n        if self.right is not None:\n            yield from self.right._traverse()\n\n    def __getitem__(self, index):\n        for i, item in enumerate(self._traverse()):\n            if i == index:\n                return item.value\n        raise IndexError(f\'Index {index} is out of range\')\n\n    def __len__(self):\n        for count, _ in enumerate(self._traverse(), 1):\n            pass\n        return count\n\n\nclass BetterNode(SequenceNode, Sequence):\n    pass\n\n\ntree = BetterNode(\n    10,\n    left=BetterNode(\n        5,\n        left=BetterNode(2),\n        right=BetterNode(\n            6,\n            right=BetterNode(7))),\n    right=BetterNode(\n        15,\n        left=BetterNode(11))\n)\n\nprint(\'Index of 7 is\', tree.index(7))\nprint(\'Count of 10 is\', tree.count(10))\n\n>>>\nIndex of 7 is 3\nCount of 10 is 1`, `86939040813018070000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> collections<span class="token punctuation">.</span>abc <span class="token keyword">import</span> Sequence\n\n\n<span class="token keyword">class</span> <span class="token class-name">BinaryNode</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">,</span> left<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> right<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>value <span class="token operator">=</span> value\n        self<span class="token punctuation">.</span>left <span class="token operator">=</span> left\n        self<span class="token punctuation">.</span>right <span class="token operator">=</span> right\n\n\n<span class="token keyword">class</span> <span class="token class-name">SequenceNode</span><span class="token punctuation">(</span>BinaryNode<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">_traverse</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> self<span class="token punctuation">.</span>left <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>\n            <span class="token keyword">yield</span> <span class="token keyword">from</span> self<span class="token punctuation">.</span>left<span class="token punctuation">.</span>_traverse<span class="token punctuation">(</span><span class="token punctuation">)</span>\n        <span class="token keyword">yield</span> self\n        <span class="token keyword">if</span> self<span class="token punctuation">.</span>right <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>\n            <span class="token keyword">yield</span> <span class="token keyword">from</span> self<span class="token punctuation">.</span>right<span class="token punctuation">.</span>_traverse<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">__getitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">for</span> i<span class="token punctuation">,</span> item <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>_traverse<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">if</span> i <span class="token operator">==</span> index<span class="token punctuation">:</span>\n                <span class="token keyword">return</span> item<span class="token punctuation">.</span>value\n        <span class="token keyword">raise</span> IndexError<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Index </span><span class="token interpolation"><span class="token punctuation">{</span>index<span class="token punctuation">}</span></span><span class="token string"> is out of range\'</span></span><span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">__len__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">for</span> count<span class="token punctuation">,</span> _ <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>_traverse<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">pass</span>\n        <span class="token keyword">return</span> count\n\n\n<span class="token keyword">class</span> <span class="token class-name">BetterNode</span><span class="token punctuation">(</span>SequenceNode<span class="token punctuation">,</span> Sequence<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n\ntree <span class="token operator">=</span> BetterNode<span class="token punctuation">(</span>\n    <span class="token number">10</span><span class="token punctuation">,</span>\n    left<span class="token operator">=</span>BetterNode<span class="token punctuation">(</span>\n        <span class="token number">5</span><span class="token punctuation">,</span>\n        left<span class="token operator">=</span>BetterNode<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n        right<span class="token operator">=</span>BetterNode<span class="token punctuation">(</span>\n            <span class="token number">6</span><span class="token punctuation">,</span>\n            right<span class="token operator">=</span>BetterNode<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    right<span class="token operator">=</span>BetterNode<span class="token punctuation">(</span>\n        <span class="token number">15</span><span class="token punctuation">,</span>\n        left<span class="token operator">=</span>BetterNode<span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token punctuation">)</span>\n\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Index of 7 is\'</span><span class="token punctuation">,</span> tree<span class="token punctuation">.</span>index<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Count of 10 is\'</span><span class="token punctuation">,</span> tree<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nIndex of <span class="token number">7</span> <span class="token keyword">is</span> <span class="token number">3</span>\nCount of <span class="token number">10</span> <span class="token keyword">is</span> <span class="token number">1</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>对于定制集合或可变映射等复杂的容器类型来说，继承 collections.abc 模块里的 Set 或 MutableMapping 等抽象基类所带来的好处会更加明显。假如自己从头开始实现，那必须编写大量的特殊方法才能让这些容器类的对象也能像标准的 Python 容器那样使用。</p>\n<p>collections.abc 模块要求子类必须实现某些特殊方法，另外，Python 在比较或排列对象时，还会用到其他一些特殊方法，无论定制的是不是容器类，有时为了支持某些功能，你都必须定义相关的特殊方法才行（案例参见第 73 条）。</p>\n<h3 id="总结-39"><a href="#%E6%80%BB%E7%BB%93-39" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>如果要编写的新类比较简单，那么可以直接从 Python 的容器类型（例如 list 或 dict）里面继承。</li>\n<li>如果想让定制的容器类型能像标准的 Python 容器那样使用，那么有可能要编写许多特殊方法。</li>\n<li>可以从 collections.abc 模块里的抽象基类之中派生自己的容器类型，这样可以让容器自动具备相关的功能，同时又可以保证没有把实现这些功能所必备的方法给漏掉。</li>\n</ol>\n<h1 id="元类与属性"><a href="#%E5%85%83%E7%B1%BB%E4%B8%8E%E5%B1%9E%E6%80%A7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>元类与属性</h1>\n<h2 id="第-44-条：用纯属性与修饰器取代旧式的-setter-与-getter-方法"><a href="#%E7%AC%AC-44-%E6%9D%A1%EF%BC%9A%E7%94%A8%E7%BA%AF%E5%B1%9E%E6%80%A7%E4%B8%8E%E4%BF%AE%E9%A5%B0%E5%99%A8%E5%8F%96%E4%BB%A3%E6%97%A7%E5%BC%8F%E7%9A%84-setter-%E4%B8%8E-getter-%E6%96%B9%E6%B3%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 44 条：用纯属性与修饰器取代旧式的 setter 与 getter 方法</h2>\n<p>从其他编程语言转入 Python 的开发者，可能想在类里面明确地实现 getter 与 setter 方法。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="43979568208803400000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class OldResistor:\n    def __init__(self, ohms):\n        self._ohms = ohms\n\n    def get_ohms(self):\n        return self._ohms\n\n    def set_ohms(self, ohms):\n        self._ohms = ohms`, `43979568208803400000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">OldResistor</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> ohms<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>_ohms <span class="token operator">=</span> ohms\n\n    <span class="token keyword">def</span> <span class="token function">get_ohms</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_ohms\n\n    <span class="token keyword">def</span> <span class="token function">set_ohms</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> ohms<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>_ohms <span class="token operator">=</span> ohms</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>虽然这些 setter 与 getter 用起来很简单，但这并不符合 Python 的风格。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="15543635551398083000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`r0 = OldResistor(50e3)\nprint(\'Before:\', r0.get_ohms())\nr0.set_ohms(10e3)\nprint(\'After: \', r0.get_ohms())\n\n>>>\nBefore: 50000.0\nAfter:  10000.0`, `15543635551398083000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">r0 <span class="token operator">=</span> OldResistor<span class="token punctuation">(</span><span class="token number">50e3</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Before:\'</span><span class="token punctuation">,</span> r0<span class="token punctuation">.</span>get_ohms<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\nr0<span class="token punctuation">.</span>set_ohms<span class="token punctuation">(</span><span class="token number">10e3</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'After: \'</span><span class="token punctuation">,</span> r0<span class="token punctuation">.</span>get_ohms<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nBefore<span class="token punctuation">:</span> <span class="token number">50000.0</span>\nAfter<span class="token punctuation">:</span>  <span class="token number">10000.0</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>例如，想让属性值变大或者变小，采用这些方法来写会特别麻烦。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="12160824630373112000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`r0.set_ohms(r0.get_ohms() - 4e3)\nassert r0.get_ohms() == 6e3`, `12160824630373112000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">r0<span class="token punctuation">.</span>set_ohms<span class="token punctuation">(</span>r0<span class="token punctuation">.</span>get_ohms<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">4e3</span><span class="token punctuation">)</span>\n<span class="token keyword">assert</span> r0<span class="token punctuation">.</span>get_ohms<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">6e3</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>这种工具方法确实有助于将类的接口定义得更加清晰，并方便开发者封装功能、验证用法、划定界限。这些都是在设计类时应该考虑的目标，实现这些目标可以确保我们在完善这个类的过程中不影响已经写好的调用代码。</p>\n<p>可是，在 Python 中实现这些目标时，没必要明确定义 setter 与 getter 方法。而是应该从最简单的 public 属性开始写起，例如像下面这样：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="88113133283186820000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Resistor:\n    def __init__(self, ohms):\n        self.ohms = ohms\n        self.voltage = 0\n        self.current = 0\n\n\nr1 = Resistor(50e3)\nr1.ohms = 10e3`, `88113133283186820000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Resistor</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> ohms<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>ohms <span class="token operator">=</span> ohms\n        self<span class="token punctuation">.</span>voltage <span class="token operator">=</span> <span class="token number">0</span>\n        self<span class="token punctuation">.</span>current <span class="token operator">=</span> <span class="token number">0</span>\n\n\nr1 <span class="token operator">=</span> Resistor<span class="token punctuation">(</span><span class="token number">50e3</span><span class="token punctuation">)</span>\nr1<span class="token punctuation">.</span>ohms <span class="token operator">=</span> <span class="token number">10e3</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>按照这种写法，很容易就能实现原地增减属性值。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="12433127941307976000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`r1.ohms += 5e3`, `12433127941307976000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">r1<span class="token punctuation">.</span>ohms <span class="token operator">+=</span> <span class="token number">5e3</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>将来如果想在设置属性时，实现特别的功能，那么可以先通过 @property 修饰器来封装获取属性的那个方法，并在封装出来的修饰器上面通过 setter 属性来封装设置属性的那个方法（参见第 26 条）。下面这个新类继承自刚才的 Resistor 类，它允许我们通过设置 voltage（电压）属性来改变 current（电流）。为了正确实现这项功能，必须保证设置属性与获取属性所用的那两个方法都跟属性同名。</p>\n<p>按照这种写法，给 voltage 属性赋值会触发同名的 setter 方法，该方法会根据新的 voltage 计算本对象的 current 属性。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="966420365927445100"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Resistor:\n    def __init__(self, ohms):\n        self.ohms = ohms\n        self.voltage = 0\n        self.current = 0\n\n\nclass VoltageResistance(Resistor):\n    def __init__(self, ohms):\n        super().__init__(ohms)\n        self._voltage = 0\n\n    @property\n    def voltage(self):\n        return self._voltage\n\n    @voltage.setter\n    def voltage(self, voltage):\n        self._voltage = voltage\n        self.current = self._voltage / self.ohms\n\n\nr2 = VoltageResistance(1e3)\nprint(f\'Before: {r2.current: .2f} amps\')\nr2.voltage = 10\nprint(f\'After:  {r2.current: .2f} amps\')\n\n>>>\nBefore:  0.00 amps\nAfter:   0.01 amps`, `966420365927445100`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Resistor</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> ohms<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>ohms <span class="token operator">=</span> ohms\n        self<span class="token punctuation">.</span>voltage <span class="token operator">=</span> <span class="token number">0</span>\n        self<span class="token punctuation">.</span>current <span class="token operator">=</span> <span class="token number">0</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">VoltageResistance</span><span class="token punctuation">(</span>Resistor<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> ohms<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>ohms<span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>_voltage <span class="token operator">=</span> <span class="token number">0</span>\n\n    @<span class="token builtin">property</span>\n    <span class="token keyword">def</span> <span class="token function">voltage</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_voltage\n\n    @voltage<span class="token punctuation">.</span>setter\n    <span class="token keyword">def</span> <span class="token function">voltage</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> voltage<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>_voltage <span class="token operator">=</span> voltage\n        self<span class="token punctuation">.</span>current <span class="token operator">=</span> self<span class="token punctuation">.</span>_voltage <span class="token operator">/</span> self<span class="token punctuation">.</span>ohms\n\n\nr2 <span class="token operator">=</span> VoltageResistance<span class="token punctuation">(</span><span class="token number">1e3</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Before: </span><span class="token interpolation"><span class="token punctuation">{</span>r2<span class="token punctuation">.</span>current<span class="token punctuation">:</span><span class="token format-spec"> .2f</span><span class="token punctuation">}</span></span><span class="token string"> amps\'</span></span><span class="token punctuation">)</span>\nr2<span class="token punctuation">.</span>voltage <span class="token operator">=</span> <span class="token number">10</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'After:  </span><span class="token interpolation"><span class="token punctuation">{</span>r2<span class="token punctuation">.</span>current<span class="token punctuation">:</span><span class="token format-spec"> .2f</span><span class="token punctuation">}</span></span><span class="token string"> amps\'</span></span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nBefore<span class="token punctuation">:</span>  <span class="token number">0.00</span> amps\nAfter<span class="token punctuation">:</span>   <span class="token number">0.01</span> amps</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>为属性指定 setter 方法还可以用来检查调用方所传入的值在类型与范围上是否符合要求。例如，下面这个 Resistor 子类可以确保用户设置的电阻值总是大于 0 的。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="15106071628401652000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Resistor:\n    def __init__(self, ohms):\n        self.ohms = ohms\n        self.voltage = 0\n        self.current = 0\n\n\nclass BoundedResistance(Resistor):\n    def __init__(self, ohms):\n        super().__init__(ohms)\n\n    @property\n    def ohms(self):\n        return self._ohms\n\n    @ohms.setter\n    def ohms(self, ohms):\n        if ohms <= 0:\n            raise ValueError(f\'ohms must be > 0; got {ohms}\')\n        self._ohms = ohms\n\n\nr3 = BoundedResistance(1e3)\nr3.ohms = 0\n\n>>>\nTraceback ...\nValueError: ohms must be > 0; got 0`, `15106071628401652000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Resistor</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> ohms<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>ohms <span class="token operator">=</span> ohms\n        self<span class="token punctuation">.</span>voltage <span class="token operator">=</span> <span class="token number">0</span>\n        self<span class="token punctuation">.</span>current <span class="token operator">=</span> <span class="token number">0</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">BoundedResistance</span><span class="token punctuation">(</span>Resistor<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> ohms<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>ohms<span class="token punctuation">)</span>\n\n    @<span class="token builtin">property</span>\n    <span class="token keyword">def</span> <span class="token function">ohms</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_ohms\n\n    @ohms<span class="token punctuation">.</span>setter\n    <span class="token keyword">def</span> <span class="token function">ohms</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> ohms<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> ohms <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">:</span>\n            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'ohms must be > 0; got </span><span class="token interpolation"><span class="token punctuation">{</span>ohms<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>_ohms <span class="token operator">=</span> ohms\n\n\nr3 <span class="token operator">=</span> BoundedResistance<span class="token punctuation">(</span><span class="token number">1e3</span><span class="token punctuation">)</span>\nr3<span class="token punctuation">.</span>ohms <span class="token operator">=</span> <span class="token number">0</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nValueError<span class="token punctuation">:</span> ohms must be <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">;</span> got <span class="token number">0</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果构造时所用的值无效，那么同样会触发异常。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="58776475558560710000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`BoundedResistance(-5)\n\n>>>\nValueError: ohms must be > 0; got -5`, `58776475558560710000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">BoundedResistance<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nValueError<span class="token punctuation">:</span> ohms must be <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">;</span> got <span class="token operator">-</span><span class="token number">5</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>之所以会出现这种效果，是因为子类的构造器（<code class="language-text">BoundedResistance.__init__</code>）会调用超类的构造器（<code class="language-text">Resistor.__init__</code>），而超类的构造器会把 self.ohms 设置成 -5。于是，就会触发 BoundedResistance 里面的 <code class="language-text">@ohms.setter</code> 方法，该方法立刻发现属性值无效，所以程序在对象还没有构造完之前，就会抛出异常。</p>\n<p>我们还可以利用 @property 阻止用户修改超类中的属性。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="61803945107006190000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Resistor:\n    def __init__(self, ohms):\n        self.ohms = ohms\n        self.voltage = 0\n        self.current = 0\n\n\nclass FixedResistance(Resistor):\n    def __init__(self, ohms):\n        super().__init__(ohms)\n\n    @property\n    def ohms(self):\n        return self._ohms\n\n    @ohms.setter\n    def ohms(self, ohms):\n        if hasattr(self, \'_ohms\'):\n            raise AttributeError(&quot;Ohms is immutable&quot;)\n        self._ohms = ohms\n\n\nr4 = FixedResistance(1e3)\nr4.ohms = 2e3\n\n>>>\nTraceback ...\nAttributeError: Ohms is immutable`, `61803945107006190000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Resistor</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> ohms<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>ohms <span class="token operator">=</span> ohms\n        self<span class="token punctuation">.</span>voltage <span class="token operator">=</span> <span class="token number">0</span>\n        self<span class="token punctuation">.</span>current <span class="token operator">=</span> <span class="token number">0</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">FixedResistance</span><span class="token punctuation">(</span>Resistor<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> ohms<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>ohms<span class="token punctuation">)</span>\n\n    @<span class="token builtin">property</span>\n    <span class="token keyword">def</span> <span class="token function">ohms</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_ohms\n\n    @ohms<span class="token punctuation">.</span>setter\n    <span class="token keyword">def</span> <span class="token function">ohms</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> ohms<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token string">\'_ohms\'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">raise</span> AttributeError<span class="token punctuation">(</span><span class="token string">"Ohms is immutable"</span><span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>_ohms <span class="token operator">=</span> ohms\n\n\nr4 <span class="token operator">=</span> FixedResistance<span class="token punctuation">(</span><span class="token number">1e3</span><span class="token punctuation">)</span>\nr4<span class="token punctuation">.</span>ohms <span class="token operator">=</span> <span class="token number">2e3</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nAttributeError<span class="token punctuation">:</span> Ohms <span class="token keyword">is</span> immutable</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>构造好对象之后，如果试图给属性赋值，那么程序就会抛出异常。</p>\n<p>用 @property 实现 setter 与 getter 时，还应该注意不要让对象产生反常的行为。例如，不要在某属性的 getter 方法里面设置其他属性的值。</p>\n<p>假如在获取属性的 getter 方法里面修改了其他属性的值，那么用户查询这个属性时，就会觉得相当奇怪，他可能不理解为什么另外一个属性会在我查询这个属性时发生变化。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="61919658257897230000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Resistor:\n    def __init__(self, ohms):\n        self.ohms = ohms\n        self.voltage = 0\n        self.current = 0\n\n\nclass MysteriousResistor(Resistor):\n    @property\n    def ohms(self):\n        self.voltage = self._ohms * self.current\n        return self._ohms\n\n    @ohms.setter\n    def ohms(self, ohms):\n        self._ohms = ohms\n\n\nr7 = MysteriousResistor(10)\nr7.current = 0.01\nprint(f\'Before: {r7.voltage:.2f}\')\nr7.ohms\nprint(f\'After: {r7.voltage: .2f}\')\n\n>>>\nBefore: 0.00\nAfter:  0.10`, `61919658257897230000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Resistor</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> ohms<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>ohms <span class="token operator">=</span> ohms\n        self<span class="token punctuation">.</span>voltage <span class="token operator">=</span> <span class="token number">0</span>\n        self<span class="token punctuation">.</span>current <span class="token operator">=</span> <span class="token number">0</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">MysteriousResistor</span><span class="token punctuation">(</span>Resistor<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    @<span class="token builtin">property</span>\n    <span class="token keyword">def</span> <span class="token function">ohms</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>voltage <span class="token operator">=</span> self<span class="token punctuation">.</span>_ohms <span class="token operator">*</span> self<span class="token punctuation">.</span>current\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_ohms\n\n    @ohms<span class="token punctuation">.</span>setter\n    <span class="token keyword">def</span> <span class="token function">ohms</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> ohms<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>_ohms <span class="token operator">=</span> ohms\n\n\nr7 <span class="token operator">=</span> MysteriousResistor<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>\nr7<span class="token punctuation">.</span>current <span class="token operator">=</span> <span class="token number">0.01</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Before: </span><span class="token interpolation"><span class="token punctuation">{</span>r7<span class="token punctuation">.</span>voltage<span class="token punctuation">:</span><span class="token format-spec">.2f</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\nr7<span class="token punctuation">.</span>ohms\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'After: </span><span class="token interpolation"><span class="token punctuation">{</span>r7<span class="token punctuation">.</span>voltage<span class="token punctuation">:</span><span class="token format-spec"> .2f</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nBefore<span class="token punctuation">:</span> <span class="token number">0.00</span>\nAfter<span class="token punctuation">:</span>  <span class="token number">0.10</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>最好的办法是，只在 @property.setter 方法里面修改状态，而且只应该修改对象之中与当前属性有关的状态。同时还得注意不要产生让调用者感到意外的其他一些副作用，例如，不要动态地引入模块，不要运行速度较慢的辅助函数，不要做 I/O，不要执行开销较大的数据库查询操作等。类的属性用起来应该跟其他的 Python 对象一样方便而快捷。如果确实要执行比较复杂或比较缓慢的操作，那么应该用普通的方法来做，而不应该把这些操作放在获取及设置属性的这两个方法里面。</p>\n<p>@property 最大的缺点是，通过它而编写的属性获取及属性设置方法只能由子类共享。与此无关的类不能共用这份逻辑。但是没关系，Python 还支持描述符（descriptor，参见第 46 条），我们可以利用这种机制把早前编写的属性获取与属性设置逻辑复用到其他许多地方。</p>\n<h3 id="总结-40"><a href="#%E6%80%BB%E7%BB%93-40" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>给新类定义接口时，应该先从简单的 public 属性写起，避免定义 setter 与 getter 方法。</li>\n<li>如果在访问属性时确实有必要做特殊的处理，那就通过 @property 来定义获取属性与设置属性的方法。</li>\n<li>实现 @property 方法时，应该遵循最小惊讶原则，不要引发奇怪的副作用。</li>\n<li>@property 方法必须执行得很快。复杂或缓慢的任务，尤其是涉及 I/O 或者会引发副作用的那些任务，还是用普通的方法来实现比较好。</li>\n</ol>\n<h2 id="第-45-条：考虑用-property-实现新的属性访问逻辑，不要急着重构原有的代码"><a href="#%E7%AC%AC-45-%E6%9D%A1%EF%BC%9A%E8%80%83%E8%99%91%E7%94%A8-property-%E5%AE%9E%E7%8E%B0%E6%96%B0%E7%9A%84%E5%B1%9E%E6%80%A7%E8%AE%BF%E9%97%AE%E9%80%BB%E8%BE%91%EF%BC%8C%E4%B8%8D%E8%A6%81%E6%80%A5%E7%9D%80%E9%87%8D%E6%9E%84%E5%8E%9F%E6%9C%89%E7%9A%84%E4%BB%A3%E7%A0%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 45 条：考虑用 @property 实现新的属性访问逻辑，不要急着重构原有的代码</h2>\n<p>Python 内置的 @property 修饰器使开发者很容易就能实现出灵活的逻辑，使得程序在获取或设置相关属性时，触发这些逻辑（参见第 44 条）。@property 还有一种更为高级的用法，其实也很常见，这就是把简单的数值属性迁移成那种实时计算的属性。这个用法的意义特别大，因为它可以确保，按照旧写法来访问属性的那些代码依然有效，而且会自动按照新逻辑执行，也不需要重写原来那些访问代码（这一点相当关键，因为那些代码未必都在你控制之下）。@property 可以说是一种重要的缓冲机制，使开发者能够逐渐改善接口而不影响已经写好的代码。</p>\n<p>例如，下面我们用普通的 Python 对象实现带有配额（quota）的漏桶（leaky bucket）。这个类可以记录当前的配额以及这份配额在多长时间内有效。</p>\n<p>漏桶算法要求在添加配额时，不能把已有的额度带到下一个时段。如果想使用额度，那么首先必须确保漏桶当前所剩的配额足够使用。</p>\n<p>现在我们来使用这个类。首先填充额度，然后根据自己的需要使用额度，这样用下去，最终会遇到额度不够的情况。从这时开始，额度就不会再变了。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="10045276830111894000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from datetime import datetime, timedelta\n\n\nclass Bucket:\n    def __init__(self, period):\n        self.period_delta = timedelta(seconds=period)\n        self.reset_time = datetime.now()\n        self.quota = 0\n\n    def __repr__(self):\n        return f\'Bucket (quota={self.quota})\'\n\n\ndef fill(bucket, amount):\n    now = datetime.now()\n    if (now - bucket.reset_time) > bucket.period_delta:\n        bucket.quota = 0\n        bucket.reset_time = now\n    bucket.quota += amount\n\n\ndef deduct(bucket, amount):\n    now = datetime.now()\n    if (now - bucket.reset_time) > bucket.period_delta:\n        return False  # Bucket hasn\'t been filled this period\n    if bucket.quota - amount < 0:\n        return False  # Bucket was filled, but not enough\n    bucket.quota -= amount\n    return True  # Bucket had enough, quota consumed\n\n\nbucket = Bucket(60)\nfill(bucket, 100)\nprint(bucket)\n\nif deduct(bucket, 99):\n    print(\'Had 99 quota\')\nelse:\n    print(\'Not enough for 99 quota\')\nprint(bucket)\n\nif deduct(bucket, 3):\n    print(\'Had 3 quota\')\nelse:\n    print(\'Not enough for 3 quota\')\nprint(bucket)\n\n>>>\nBucket (quota=100)\nHad 99 quota\nBucket (quota=1)\nNot enough for 3 quota\nBucket (quota=1)`, `10045276830111894000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime<span class="token punctuation">,</span> timedelta\n\n\n<span class="token keyword">class</span> <span class="token class-name">Bucket</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> period<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>period_delta <span class="token operator">=</span> timedelta<span class="token punctuation">(</span>seconds<span class="token operator">=</span>period<span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>reset_time <span class="token operator">=</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>quota <span class="token operator">=</span> <span class="token number">0</span>\n\n    <span class="token keyword">def</span> <span class="token function">__repr__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f\'Bucket (quota=</span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>quota<span class="token punctuation">}</span></span><span class="token string">)\'</span></span>\n\n\n<span class="token keyword">def</span> <span class="token function">fill</span><span class="token punctuation">(</span>bucket<span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    now <span class="token operator">=</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>now <span class="token operator">-</span> bucket<span class="token punctuation">.</span>reset_time<span class="token punctuation">)</span> <span class="token operator">></span> bucket<span class="token punctuation">.</span>period_delta<span class="token punctuation">:</span>\n        bucket<span class="token punctuation">.</span>quota <span class="token operator">=</span> <span class="token number">0</span>\n        bucket<span class="token punctuation">.</span>reset_time <span class="token operator">=</span> now\n    bucket<span class="token punctuation">.</span>quota <span class="token operator">+=</span> amount\n\n\n<span class="token keyword">def</span> <span class="token function">deduct</span><span class="token punctuation">(</span>bucket<span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    now <span class="token operator">=</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>now <span class="token operator">-</span> bucket<span class="token punctuation">.</span>reset_time<span class="token punctuation">)</span> <span class="token operator">></span> bucket<span class="token punctuation">.</span>period_delta<span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token boolean">False</span>  <span class="token comment"># Bucket hasn\'t been filled this period</span>\n    <span class="token keyword">if</span> bucket<span class="token punctuation">.</span>quota <span class="token operator">-</span> amount <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token boolean">False</span>  <span class="token comment"># Bucket was filled, but not enough</span>\n    bucket<span class="token punctuation">.</span>quota <span class="token operator">-=</span> amount\n    <span class="token keyword">return</span> <span class="token boolean">True</span>  <span class="token comment"># Bucket had enough, quota consumed</span>\n\n\nbucket <span class="token operator">=</span> Bucket<span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span>\nfill<span class="token punctuation">(</span>bucket<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>bucket<span class="token punctuation">)</span>\n\n<span class="token keyword">if</span> deduct<span class="token punctuation">(</span>bucket<span class="token punctuation">,</span> <span class="token number">99</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Had 99 quota\'</span><span class="token punctuation">)</span>\n<span class="token keyword">else</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Not enough for 99 quota\'</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>bucket<span class="token punctuation">)</span>\n\n<span class="token keyword">if</span> deduct<span class="token punctuation">(</span>bucket<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Had 3 quota\'</span><span class="token punctuation">)</span>\n<span class="token keyword">else</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Not enough for 3 quota\'</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>bucket<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nBucket <span class="token punctuation">(</span>quota<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">)</span>\nHad <span class="token number">99</span> quota\nBucket <span class="token punctuation">(</span>quota<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>\nNot enough <span class="token keyword">for</span> <span class="token number">3</span> quota\nBucket <span class="token punctuation">(</span>quota<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这种实现方式有个问题，就是没办法知道第一次填充漏桶时，给它分配的额度。我们只知道额度会越用越少直到不够用为止。如果当前这段时间内的额度已经降到 0，那么不管你想使用多少额度，deduct 函数都会返回 False，除非通过 fill 函数再往里面补充额度。所以，当 deduct 函数返回 False 时，了解这究竟是因为 Bucket 没有足够的额度可以扣减，还是说它一开始根本就没分配到任何额度，这一点很重要。</p>\n<p>为了解决这个问题，可以修改这个类，把当前时间段内的初始额度（max<em>quota）与已经使用的额度（quota</em>consumed）明确记录下来。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="83464808685788140000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from datetime import datetime, timedelta\n\n\nclass NewBucket:\n    def __init__(self, period):\n        self.period_delta = timedelta(seconds=period)\n        self.reset_time = datetime.now()\n        self.max_quota = 0\n        self.quota_consumed = 0\n\n    def __repr__(self):\n        return f\'NewBucket (max_quota={self.max_quota}, quota_consumed={self.quota_consumed})\'\n\n    @property\n    def quota(self):\n        return self.max_quota - self.quota_consumed\n\n    @quota.setter\n    def quota(self, amount):\n        delta = self.max_quota - amount\n        if amount == 0:\n            # Quota being reset for a new period\n            self.quota_consumed = 0\n            self.max_quota = 0\n        elif delta < 0:\n            # Quota being filled for the new period\n            assert self.quota_consumed == 0\n            self.max_quota = amount\n        else:\n            # Quota being consumed during the period\n            assert amount > 0\n            self.quota_consumed = delta\n\n\ndef fill(bucket, amount):\n    now = datetime.now()\n    if (now - bucket.reset_time) > bucket.period_delta:\n        bucket.quota = 0\n        bucket.reset_time = now\n    bucket.quota += amount\n\n\ndef deduct(bucket, amount):\n    now = datetime.now()\n    if (now - bucket.reset_time) > bucket.period_delta:\n        return False  # Bucket hasn\'t been filled this period\n    if bucket.quota - amount < 0:\n        return False  # Bucket was filled, but not enough\n    bucket.quota -= amount\n    return True  # Bucket had enough, quota consumed\n\n\nbucket = NewBucket(60)\nfill(bucket, 100)\nprint(bucket)\n\nif deduct(bucket, 99):\n    print(\'Had 99 quota\')\nelse:\n    print(\'Not enough for 99 quota\')\nprint(bucket)\n\nif deduct(bucket, 3):\n    print(\'Had 3 quota\')\nelse:\n    print(\'Not enough for 3 quota\')\nprint(bucket)\n\n>>>\nNewBucket (max_quota=100, quota_consumed=0)\nHad 99 quota\nNewBucket (max_quota=100, quota_consumed=99)\nNot enough for 3 quota\nNewBucket (max_quota=100, quota_consumed=99)`, `83464808685788140000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime<span class="token punctuation">,</span> timedelta\n\n\n<span class="token keyword">class</span> <span class="token class-name">NewBucket</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> period<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>period_delta <span class="token operator">=</span> timedelta<span class="token punctuation">(</span>seconds<span class="token operator">=</span>period<span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>reset_time <span class="token operator">=</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>max_quota <span class="token operator">=</span> <span class="token number">0</span>\n        self<span class="token punctuation">.</span>quota_consumed <span class="token operator">=</span> <span class="token number">0</span>\n\n    <span class="token keyword">def</span> <span class="token function">__repr__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f\'NewBucket (max_quota=</span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>max_quota<span class="token punctuation">}</span></span><span class="token string">, quota_consumed=</span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>quota_consumed<span class="token punctuation">}</span></span><span class="token string">)\'</span></span>\n\n    <span class="token decorator annotation punctuation">@property</span>\n    <span class="token keyword">def</span> <span class="token function">quota</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>max_quota <span class="token operator">-</span> self<span class="token punctuation">.</span>quota_consumed\n\n    @quota<span class="token punctuation">.</span>setter\n    <span class="token keyword">def</span> <span class="token function">quota</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        delta <span class="token operator">=</span> self<span class="token punctuation">.</span>max_quota <span class="token operator">-</span> amount\n        <span class="token keyword">if</span> amount <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>\n            <span class="token comment"># Quota being reset for a new period</span>\n            self<span class="token punctuation">.</span>quota_consumed <span class="token operator">=</span> <span class="token number">0</span>\n            self<span class="token punctuation">.</span>max_quota <span class="token operator">=</span> <span class="token number">0</span>\n        <span class="token keyword">elif</span> delta <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">:</span>\n            <span class="token comment"># Quota being filled for the new period</span>\n            <span class="token keyword">assert</span> self<span class="token punctuation">.</span>quota_consumed <span class="token operator">==</span> <span class="token number">0</span>\n            self<span class="token punctuation">.</span>max_quota <span class="token operator">=</span> amount\n        <span class="token keyword">else</span><span class="token punctuation">:</span>\n            <span class="token comment"># Quota being consumed during the period</span>\n            <span class="token keyword">assert</span> amount <span class="token operator">></span> <span class="token number">0</span>\n            self<span class="token punctuation">.</span>quota_consumed <span class="token operator">=</span> delta\n\n\n<span class="token keyword">def</span> <span class="token function">fill</span><span class="token punctuation">(</span>bucket<span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    now <span class="token operator">=</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>now <span class="token operator">-</span> bucket<span class="token punctuation">.</span>reset_time<span class="token punctuation">)</span> <span class="token operator">></span> bucket<span class="token punctuation">.</span>period_delta<span class="token punctuation">:</span>\n        bucket<span class="token punctuation">.</span>quota <span class="token operator">=</span> <span class="token number">0</span>\n        bucket<span class="token punctuation">.</span>reset_time <span class="token operator">=</span> now\n    bucket<span class="token punctuation">.</span>quota <span class="token operator">+=</span> amount\n\n\n<span class="token keyword">def</span> <span class="token function">deduct</span><span class="token punctuation">(</span>bucket<span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    now <span class="token operator">=</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>now <span class="token operator">-</span> bucket<span class="token punctuation">.</span>reset_time<span class="token punctuation">)</span> <span class="token operator">></span> bucket<span class="token punctuation">.</span>period_delta<span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token boolean">False</span>  <span class="token comment"># Bucket hasn\'t been filled this period</span>\n    <span class="token keyword">if</span> bucket<span class="token punctuation">.</span>quota <span class="token operator">-</span> amount <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token boolean">False</span>  <span class="token comment"># Bucket was filled, but not enough</span>\n    bucket<span class="token punctuation">.</span>quota <span class="token operator">-=</span> amount\n    <span class="token keyword">return</span> <span class="token boolean">True</span>  <span class="token comment"># Bucket had enough, quota consumed</span>\n\n\nbucket <span class="token operator">=</span> NewBucket<span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span>\nfill<span class="token punctuation">(</span>bucket<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>bucket<span class="token punctuation">)</span>\n\n<span class="token keyword">if</span> deduct<span class="token punctuation">(</span>bucket<span class="token punctuation">,</span> <span class="token number">99</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Had 99 quota\'</span><span class="token punctuation">)</span>\n<span class="token keyword">else</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Not enough for 99 quota\'</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>bucket<span class="token punctuation">)</span>\n\n<span class="token keyword">if</span> deduct<span class="token punctuation">(</span>bucket<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Had 3 quota\'</span><span class="token punctuation">)</span>\n<span class="token keyword">else</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Not enough for 3 quota\'</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>bucket<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nNewBucket <span class="token punctuation">(</span>max_quota<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">,</span> quota_consumed<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>\nHad <span class="token number">99</span> quota\nNewBucket <span class="token punctuation">(</span>max_quota<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">,</span> quota_consumed<span class="token operator">=</span><span class="token number">99</span><span class="token punctuation">)</span>\nNot enough <span class="token keyword">for</span> <span class="token number">3</span> quota\nNewBucket <span class="token punctuation">(</span>max_quota<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">,</span> quota_consumed<span class="token operator">=</span><span class="token number">99</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这个方案最大的好处是，原来根据 Bucket.quota 所写的那些代码可以继续沿用，而且无须考虑 Bucket 现在已经换成了新的 NewBucket。至于以后的代码，则可以直接操纵漏桶的额度（quota），因为可以通过访问 <code class="language-text">max_quota</code> 与 <code class="language-text">quota_consumed</code> 字段正确地获取及设置该额度。</p>\n<p>笔者特别喜欢 @property 属性的地方在于，它让我们能够逐渐完善数据模型而不影响已经写好的代码。观看刚才那个 Bucket 范例时，有人可能会想，为什么不把 fill 与 deduct 直接设计成实例方法呢？嗯，这样想确实有道理（参见第 37 条），但实际上，我们不可能每次都想得这么周到，还是会遇到很多相当糟糕的接口，或者遇到那种纯粹当成数据容器来写的类。之所以出现那样的情况，可能有许多原因，例如代码不断膨胀，项目的范围也越来越广，而给同一个项目提交程序的开发者又全都没有考虑到以后的维护工作。</p>\n<p>@property 可以帮助解决实际工作中的许多问题，但不应该遭到滥用。如果你发现自己总是在扩充 @property 方法，那可能说明这个类确实应该重构了。在这种情况下，就不要再沿着糟糕的方案继续往下写了。</p>\n<h3 id="总结-41"><a href="#%E6%80%BB%E7%BB%93-41" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>可以利用 @property 给已有的实例属性增加新的功能。</li>\n<li>可以利用 @property 逐渐改善数据模型而不影响已经写好的代码。</li>\n<li>如果发现 @property 使用太过频繁，那可能就该考虑重构这个类了，同时按照旧办法使用这个类的那些代码可能也要重构。</li>\n</ol>\n<h2 id="第-46-条：用描述符来改写需要复用的-property-方法"><a href="#%E7%AC%AC-46-%E6%9D%A1%EF%BC%9A%E7%94%A8%E6%8F%8F%E8%BF%B0%E7%AC%A6%E6%9D%A5%E6%94%B9%E5%86%99%E9%9C%80%E8%A6%81%E5%A4%8D%E7%94%A8%E7%9A%84-property-%E6%96%B9%E6%B3%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 46 条：用描述符来改写需要复用的 @property 方法</h2>\n<p>Python 内置的 @property 机制的最大的缺点就是不方便复用（参见第 44 条与第 45 条）。我们不能把它修饰的方法所使用的逻辑，套用在同一个类的其他属性上面，也不能在无关的类里面复用。</p>\n<p>例如，我们要编写一个类来记录学生的家庭作业成绩，而且要确保设置的成绩位于 0 到 100 之间，受 @property 修饰的属性用起来很简单。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="22184702540380740000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Homework:\n    def __init__(self):\n        self._grade = 0\n\n    @property\n    def grade(self):\n        return self._grade\n\n    @grade.setter\n    def grade(self, value):\n        if not (0 <= value <= 100):\n            raise ValueError(\'Grade must be between 0 and 100\')\n        self._grade = value\n\n\ngalileo = Homework()\ngalileo.grade = 95`, `22184702540380740000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Homework</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>_grade <span class="token operator">=</span> <span class="token number">0</span>\n\n    @<span class="token builtin">property</span>\n    <span class="token keyword">def</span> <span class="token function">grade</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_grade\n\n    @grade<span class="token punctuation">.</span>setter\n    <span class="token keyword">def</span> <span class="token function">grade</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">&lt;=</span> value <span class="token operator">&lt;=</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">\'Grade must be between 0 and 100\'</span><span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>_grade <span class="token operator">=</span> value\n\n\ngalileo <span class="token operator">=</span> Homework<span class="token punctuation">(</span><span class="token punctuation">)</span>\ngalileo<span class="token punctuation">.</span>grade <span class="token operator">=</span> <span class="token number">95</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>假设，我们还需要写一个类记录学生的考试成绩，而且要把每科的成绩分别记录下来。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="90143376801668660000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Exam:\n    def __init__(self):\n        self._writing_grade = 0\n        self._math_grade = 0\n\n    @staticmethod\n    def _check_grade(value):\n        if not (0 <= value <= 100):\n            raise ValueError(\'Grade must be between 0 and 100\')`, `90143376801668660000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Exam</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>_writing_grade <span class="token operator">=</span> <span class="token number">0</span>\n        self<span class="token punctuation">.</span>_math_grade <span class="token operator">=</span> <span class="token number">0</span>\n\n    @<span class="token builtin">staticmethod</span>\n    <span class="token keyword">def</span> <span class="token function">_check_grade</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">&lt;=</span> value <span class="token operator">&lt;=</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">\'Grade must be between 0 and 100\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样写很费事，因为每科的成绩都需要一套 @property 方法，而且其中设置属性值的那个方法还必须调用 <code class="language-text">_check_grade</code> 验证新值是否位于合理的范围内。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="85073000916132360000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`@property\ndef writing_grade(self):\n    return self._writing_grade\n\n\n@writing_grade.setter\ndef writing_grade(self, value):\n    self._check_grade(value)\n    self._writing_grade = value\n\n\n@property\ndef math_grade(self):\n    return self._math_grade\n\n\n@math_grade.setter\ndef math_grade(self, value):\n    self._check_grade(value)\n    self._math_grade = value`, `85073000916132360000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token decorator annotation punctuation">@property</span>\n<span class="token keyword">def</span> <span class="token function">writing_grade</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">return</span> self<span class="token punctuation">.</span>_writing_grade\n\n\n@writing_grade<span class="token punctuation">.</span>setter\n<span class="token keyword">def</span> <span class="token function">writing_grade</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    self<span class="token punctuation">.</span>_check_grade<span class="token punctuation">(</span>value<span class="token punctuation">)</span>\n    self<span class="token punctuation">.</span>_writing_grade <span class="token operator">=</span> value\n\n\n@<span class="token builtin">property</span>\n<span class="token keyword">def</span> <span class="token function">math_grade</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">return</span> self<span class="token punctuation">.</span>_math_grade\n\n\n@math_grade<span class="token punctuation">.</span>setter\n<span class="token keyword">def</span> <span class="token function">math_grade</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    self<span class="token punctuation">.</span>_check_grade<span class="token punctuation">(</span>value<span class="token punctuation">)</span>\n    self<span class="token punctuation">.</span>_math_grade <span class="token operator">=</span> value</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这种写法不仅烦琐，而且无法复用。如果想把这个百分制验证逻辑运用到 Homework 与 Exam 以外的类，那么必须反复编写例行的 @property 方法与 <code class="language-text">_check_grade</code> 逻辑。</p>\n<p>在 Python 里，这样的功能最好通过描述符（descriptor）实现。描述符协议（descriptor protocol）规定了程序应该如何处理属性访问操作。充当描述符的那个类能够实现 <code class="language-text">__get__</code> 与 <code class="language-text">__set__</code> 方法，这样其他类就可以共用这个描述符所实现的逻辑而无须把这套逻辑分别重写一遍。在这一点上，描述符要比 <code class="language-text">mix-in</code> 好（参见第 41 条），因为即便在同一个类里，我们也可以反复使用这个描述符来设计不同的属性。</p>\n<p>下面重新定义 Exam 类，这次我们采用类级别的属性来实现每科成绩的访问功能，这些属性指向下面这个 Grade 类的实例，而这个 Grade 类则实现刚才提到的描述符协议。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="9000618759413559000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Grade:\n    def __get__(self, instance, instance_type):\n        return ()\n\n    def __set__(self, instance, value):\n        return ()\n\n\nclass Exam:\n    # Class attributes\n    math_grade = Grade()\n    writing_grade = Grade()\n    science_grade = Grade()`, `9000618759413559000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Grade</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__get__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> instance_type<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">__set__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">Exam</span><span class="token punctuation">:</span>\n    <span class="token comment"># Class attributes</span>\n    math_grade <span class="token operator">=</span> Grade<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    writing_grade <span class="token operator">=</span> Grade<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    science_grade <span class="token operator">=</span> Grade<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在解释 Grade 类的工作原理之前，我们首先要知道，当程序访问 Exam 实例的某个属性时，Python 如何将访问操作派发到 Exam 类的描述符属性上面。例如，如果要给 Exam 实例的 <code class="language-text">writing_grade</code> 属性赋值：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="92516658350468330000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`exam = Exam()\nexam.writing_grade = 40`, `92516658350468330000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">exam <span class="token operator">=</span> Exam<span class="token punctuation">(</span><span class="token punctuation">)</span>\nexam<span class="token punctuation">.</span>writing_grade <span class="token operator">=</span> <span class="token number">40</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>那么 Python 会把这次赋值操作转译为：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="84679341746721830000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`Exam.__dict__[\'writing_grade\'].__set__(exam, 40)`, `84679341746721830000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">Exam<span class="token punctuation">.</span>__dict__<span class="token punctuation">[</span><span class="token string">\'writing_grade\'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>__set__<span class="token punctuation">(</span>exam<span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>获取这个属性时也一样：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="15600409614166954000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`exam.writing_grade`, `15600409614166954000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">exam<span class="token punctuation">.</span>writing_grade</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>Python 会把它相应地转译为：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="36284888078836850000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`Exam.__dict__[\'writing_grade\'].__get__(exam, Exam)`, `36284888078836850000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">Exam<span class="token punctuation">.</span>__dict__<span class="token punctuation">[</span><span class="token string">\'writing_grade\'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>__get__<span class="token punctuation">(</span>exam<span class="token punctuation">,</span> Exam<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>这样的转译效果是由 object 的 <code class="language-text">__getattribute__</code> 方法促成的（参见第 47 条）。简单地说，就是当 Exam 实例里面没有名为 <code class="language-text">writing_grade</code> 的属性时，Python 会转而在类的层面查找，查询 Exam 类里面有没有这样一个属性。如果有，而且还是个实现了 <code class="language-text">__get__</code> 与 <code class="language-text">__set__</code> 方法的对象，那么系统就认定你想通过描述符协议定义这个属性的访问行为。</p>\n<p>知道了这条规则之后，我们来尝试把 Homework 类早前用 <code class="language-text">@property</code> 实现的成绩验证逻辑搬到 Grade 描述符里面。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="91022166301404700000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Grade:\n    def __init__(self):\n        self._value = 0\n\n    def __get__(self, instance, instance_type):\n        return self._value\n\n    def __set__(self, instance, value):\n        if not (0 <= value <= 100):\n            raise ValueError(\'Grade must be between 0 and 100\')\n        self._value = value`, `91022166301404700000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Grade</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>_value <span class="token operator">=</span> <span class="token number">0</span>\n\n    <span class="token keyword">def</span> <span class="token function">__get__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> instance_type<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_value\n\n    <span class="token keyword">def</span> <span class="token function">__set__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">&lt;=</span> value <span class="token operator">&lt;=</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">\'Grade must be between 0 and 100\'</span><span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>_value <span class="token operator">=</span> value</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样写其实不对，而且会让程序出现混乱。但在同一个 Exam 实例上面访问不同的属性是没有问题的。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="63127983397779680000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Exam:\n    math_grade = Grade()\n    writing_grade = Grade()\n    science_grade = Grade()\n\n\nfirst_exam = Exam()\nfirst_exam.writing_grade = 82\nfirst_exam.science_grade = 99\nprint(\'Writing\', first_exam.writing_grade)\nprint(\'Science\', first_exam.science_grade)\n\n>>>\nWriting 82\nScience 99`, `63127983397779680000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Exam</span><span class="token punctuation">:</span>\n    math_grade <span class="token operator">=</span> Grade<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    writing_grade <span class="token operator">=</span> Grade<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    science_grade <span class="token operator">=</span> Grade<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n\nfirst_exam <span class="token operator">=</span> Exam<span class="token punctuation">(</span><span class="token punctuation">)</span>\nfirst_exam<span class="token punctuation">.</span>writing_grade <span class="token operator">=</span> <span class="token number">82</span>\nfirst_exam<span class="token punctuation">.</span>science_grade <span class="token operator">=</span> <span class="token number">99</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Writing\'</span><span class="token punctuation">,</span> first_exam<span class="token punctuation">.</span>writing_grade<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Science\'</span><span class="token punctuation">,</span> first_exam<span class="token punctuation">.</span>science_grade<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nWriting <span class="token number">82</span>\nScience <span class="token number">99</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>但是，在不同的 Exam 实例上分别访问同一个属性却会看到奇怪的结果。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="96167805936347530000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`second_exam = Exam()\nsecond_exam.writing_grade = 75\nprint(f\'Second {second_exam.writing_grade} is right\')\nprint(f\'First {first_exam.writing_grade} is wrong; should be 82\')\n\n>>>\nSecond 75 is right\nFirst 75 is wrong; should be 82`, `96167805936347530000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">second_exam <span class="token operator">=</span> Exam<span class="token punctuation">(</span><span class="token punctuation">)</span>\nsecond_exam<span class="token punctuation">.</span>writing_grade <span class="token operator">=</span> <span class="token number">75</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Second </span><span class="token interpolation"><span class="token punctuation">{</span>second_exam<span class="token punctuation">.</span>writing_grade<span class="token punctuation">}</span></span><span class="token string"> is right\'</span></span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'First </span><span class="token interpolation"><span class="token punctuation">{</span>first_exam<span class="token punctuation">.</span>writing_grade<span class="token punctuation">}</span></span><span class="token string"> is wrong; should be 82\'</span></span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nSecond <span class="token number">75</span> <span class="token keyword">is</span> right\nFirst <span class="token number">75</span> <span class="token keyword">is</span> wrong<span class="token punctuation">;</span> should be <span class="token number">82</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>出现这种问题的原因在于，这些 Exam 实例之中的 <code class="language-text">writing_grade</code> 属性实际上是在共享同一个 Grade 实例。在整个程序的运行过程中，这个 Grade 只会于定义 Exam 类时构造一次，而不是每创建一个 Exam 实例都有一个新的 Grade 来与 <code class="language-text">writing_grade</code> 属性相搭配。</p>\n<p>为解决此问题，我们必须把每个 Exam 实例在这个属性上面的取值都记录下来。可以通过字典实现每个实例的状态保存。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="76381652457911860000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Grade:\n    def __init__(self):\n        self._values = {}\n\n    def __get__(self, instance, instance_type):\n        if instance is None:\n            return self\n        return self._values.get(instance, 0)\n\n    def __set__(self, instance, value):\n        if not (0 <= value <= 100):\n            raise ValueError(\'Grade must be between 0 and 100\')\n        self._values[instance] = value`, `76381652457911860000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Grade</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>_values <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n\n    <span class="token keyword">def</span> <span class="token function">__get__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> instance_type<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> instance <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> self\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_values<span class="token punctuation">.</span>get<span class="token punctuation">(</span>instance<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">__set__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">&lt;=</span> value <span class="token operator">&lt;=</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">\'Grade must be between 0 and 100\'</span><span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>_values<span class="token punctuation">[</span>instance<span class="token punctuation">]</span> <span class="token operator">=</span> value</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这种实现方案很简单，而且能得到正确结果，但仍然有一个缺陷，就是会泄漏内存。在程序运行过程中，传给 <code class="language-text">__set__</code> 方法的那些 Exam 实例全都会被 Grade 之中的 <code class="language-text">_values</code> 字典所引用。于是，指向那些实例的引用数量就永远不会降到 0，这导致垃圾回收器没办法把那些实例清理掉（第 81 条会介绍怎样才能发现这种问题）。</p>\n<p>为了解决这个问题，我们可以求助于 Python 内置的 weakref 模块。该模块里有一种特殊的字典，名为 WeakKeyDictionary，它可以取代刚才实现 <code class="language-text">_values</code> 时所用的普通字典。这个字典的特殊之处在于：如果运行时系统发现，指向 Exam 实例的引用只剩一个，而这个引用又是由 WeakKeyDictionary 的键所发起的，那么系统会将该引用从这个特殊的字典里删掉，于是指向那个 Exam 实例的引用数量就会降为 0。总之，改用这种字典来实现 <code class="language-text">_values</code> 会让 Python 系统自动把内存泄漏问题处理好，如果所有的 Exam 实例都不再使用了，那么 <code class="language-text">_values</code> 字典肯定是空的。</p>\n<p>用这种字典改写 Grade 描述符之后，Exam 就能够正常运作了。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="676742805682950500"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from weakref import WeakKeyDictionary\n\n\nclass Grade:\n    def __init__(self):\n        self._values = WeakKeyDictionary()\n\n    def __get__(self, instance, instance_type):\n        if instance is None:\n            return self\n        return self._values.get(instance, 0)\n\n    def __set__(self, instance, value):\n        if not (0 <= value <= 100):\n            raise ValueError(\'Grade must be between 0 and 100\')\n        self._values[instance] = value\n\n\nclass Exam:\n    math_grade = Grade()\n    writing_grade = Grade()\n    science_grade = Grade()\n\n\nfirst_exam = Exam()\nfirst_exam.writing_grade = 82\nsecond_exam = Exam()\nsecond_exam.writing_grade = 75\nprint(f\'First {first_exam.writing_grade} is right\')\nprint(f\'Second {second_exam.writing_grade} is right\')\n\n>>>\nFirst 82 is right\nSecond 75 is right`, `676742805682950500`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> weakref <span class="token keyword">import</span> WeakKeyDictionary\n\n\n<span class="token keyword">class</span> <span class="token class-name">Grade</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>_values <span class="token operator">=</span> WeakKeyDictionary<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">__get__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> instance_type<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> instance <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> self\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_values<span class="token punctuation">.</span>get<span class="token punctuation">(</span>instance<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">__set__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">&lt;=</span> value <span class="token operator">&lt;=</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">\'Grade must be between 0 and 100\'</span><span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>_values<span class="token punctuation">[</span>instance<span class="token punctuation">]</span> <span class="token operator">=</span> value\n\n\n<span class="token keyword">class</span> <span class="token class-name">Exam</span><span class="token punctuation">:</span>\n    math_grade <span class="token operator">=</span> Grade<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    writing_grade <span class="token operator">=</span> Grade<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    science_grade <span class="token operator">=</span> Grade<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n\nfirst_exam <span class="token operator">=</span> Exam<span class="token punctuation">(</span><span class="token punctuation">)</span>\nfirst_exam<span class="token punctuation">.</span>writing_grade <span class="token operator">=</span> <span class="token number">82</span>\nsecond_exam <span class="token operator">=</span> Exam<span class="token punctuation">(</span><span class="token punctuation">)</span>\nsecond_exam<span class="token punctuation">.</span>writing_grade <span class="token operator">=</span> <span class="token number">75</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'First </span><span class="token interpolation"><span class="token punctuation">{</span>first_exam<span class="token punctuation">.</span>writing_grade<span class="token punctuation">}</span></span><span class="token string"> is right\'</span></span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Second </span><span class="token interpolation"><span class="token punctuation">{</span>second_exam<span class="token punctuation">.</span>writing_grade<span class="token punctuation">}</span></span><span class="token string"> is right\'</span></span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nFirst <span class="token number">82</span> <span class="token keyword">is</span> right\nSecond <span class="token number">75</span> <span class="token keyword">is</span> right</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="总结-42"><a href="#%E6%80%BB%E7%BB%93-42" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>如果想复用 @property 方法所实现的行为与验证逻辑，则可以考虑自己定义描述符类。</li>\n<li>为了防止内存泄漏，可以在描述符类中用 WeakKeyDictionary 取代普通的字典。</li>\n<li>不要太纠结于 <code class="language-text">__getattribute__</code> 是怎么通过描述符协议来获取并设置属性的。</li>\n</ol>\n<h2 id="第-47-条：针对惰性属性使用-__getattr__、__getattribute__-及-__setattr__"><a href="#%E7%AC%AC-47-%E6%9D%A1%EF%BC%9A%E9%92%88%E5%AF%B9%E6%83%B0%E6%80%A7%E5%B1%9E%E6%80%A7%E4%BD%BF%E7%94%A8-__getattr__%E3%80%81__getattribute__-%E5%8F%8A-__setattr__" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 47 条：针对惰性属性使用 <code class="language-text">__getattr__</code>、<code class="language-text">__getattribute__</code> 及 <code class="language-text">__setattr__</code></h2>\n<p>Python 的 object 提供了一套挂钩，使开发者很容易就能写出通用的代码，将不同的系统粘合到一起。例如，我们想把数据库中的记录表示为 Python 对象。数据库当然有它自己的模式（schema），而程序在把记录表示成对象时，必须知道数据库是按照什么样的 schema 来组织这些记录的。同时，我们又要注意，连接 Python 对象与数据库的代码应该写得通用一些，而不应该明确限定这些记录必须使用哪种 schema。</p>\n<p>这个功能如何实现才好呢？普通的实例属性、经过 <code class="language-text">@property</code> 修饰的方法以及上一条里提到的描述符，都做不到这一点，因为它们都必须得提前定义好。在 Python 中，这种动态的行为可以通过名为 <code class="language-text">__getattr__</code> 的特殊方法来实现。如果类中定义了 <code class="language-text">__getattr__</code>，那么每当访问该类对象的属性，而且实例字典里又找不到这个属性时，系统就会触发 <code class="language-text">__getattr__</code> 方法。</p>\n<p>下面我们试着访问 foo 属性。data 实例中并没有这样一个属性，因此 Python 会触发上面定义的 <code class="language-text">__getattr__</code> 方法，而该方法又会通过 setattr 修改本实例的 <code class="language-text">__dict__</code> 字典。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="23759186823150457000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class LazyRecord:\n    def __init__(self):\n        self.exists = 5\n\n    def __getattr__(self, name):\n        value = f\'Value for {name}\'\n        setattr(self, name, value)\n        return value\n\n\ndata = LazyRecord()\nprint(\'Before:\', data.__dict__)\nprint(\'foo:   \', data.foo)\nprint(\'After: \', data.__dict__)\n\n>>>\nBefore: {\'exists\': 5}\nfoo:    Value for foo\nAfter:  {\'exists\': 5, \'foo\': \'Value for foo\'}`, `23759186823150457000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">LazyRecord</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>exists <span class="token operator">=</span> <span class="token number">5</span>\n\n    <span class="token keyword">def</span> <span class="token function">__getattr__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        value <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f\'Value for </span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token punctuation">}</span></span><span class="token string">\'</span></span>\n        <span class="token builtin">setattr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n        <span class="token keyword">return</span> value\n\n\ndata <span class="token operator">=</span> LazyRecord<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Before:\'</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>__dict__<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'foo:   \'</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>foo<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'After: \'</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>__dict__<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nBefore<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">\'exists\'</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">}</span>\nfoo<span class="token punctuation">:</span>    Value <span class="token keyword">for</span> foo\nAfter<span class="token punctuation">:</span>  <span class="token punctuation">{</span><span class="token string">\'exists\'</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">\'foo\'</span><span class="token punctuation">:</span> <span class="token string">\'Value for foo\'</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>下面，我们通过子类给 LazyRecord 增加日志功能，用来观察程序在什么样的情况下才会调用 <code class="language-text">__getattr__</code> 方法。我们先写入第一条日志，然后通过 super() 调用超类所实现的 <code class="language-text">__getattr__</code> 方法，并把那个方法返回的结果记录到第二条日志里面。假如不加 super()，那么程序就会无限递归，因为那样调用的是本类所写的 <code class="language-text">__getattr__</code> 方法（参见第 40 条）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="76084787008168770000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class LazyRecord:\n    def __init__(self):\n        self.exists = 5\n\n    def __getattr__(self, name):\n        value = f\'Value for {name}\'\n        setattr(self, name, value)\n        return value\n\n\nclass LoggingLazyRecord(LazyRecord):\n    def __getattr__(self, name):\n        print(\n            f\'* Called __getattr__({name!r}), populating instance dictionary\')\n        result = super() .__getattr__(name)\n        print(f\'* Returning {result!r}\')\n        return result\n\n\ndata = LoggingLazyRecord()\nprint(\'exists:    \', data.exists)\nprint(\'First foo: \', data.foo)\nprint(\'Second foo:\', data.foo)\n\n>>>\nexists:     5\n* Called __getattr__(\'foo\'), populating instance dictionary\n* Returning \'Value for foo\'\nFirst foo:  Value for foo\nSecond foo: Value for foo`, `76084787008168770000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">LazyRecord</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>exists <span class="token operator">=</span> <span class="token number">5</span>\n\n    <span class="token keyword">def</span> <span class="token function">__getattr__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        value <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f\'Value for </span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token punctuation">}</span></span><span class="token string">\'</span></span>\n        <span class="token builtin">setattr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n        <span class="token keyword">return</span> value\n\n\n<span class="token keyword">class</span> <span class="token class-name">LoggingLazyRecord</span><span class="token punctuation">(</span>LazyRecord<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__getattr__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span>\n            <span class="token string-interpolation"><span class="token string">f\'* Called __getattr__(</span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">), populating instance dictionary\'</span></span><span class="token punctuation">)</span>\n        result <span class="token operator">=</span> <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">.</span>__getattr__<span class="token punctuation">(</span>name<span class="token punctuation">)</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'* Returning </span><span class="token interpolation"><span class="token punctuation">{</span>result<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n        <span class="token keyword">return</span> result\n\n\ndata <span class="token operator">=</span> LoggingLazyRecord<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'exists:    \'</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>exists<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'First foo: \'</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>foo<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Second foo:\'</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>foo<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nexists<span class="token punctuation">:</span>     <span class="token number">5</span>\n<span class="token operator">*</span> Called __getattr__<span class="token punctuation">(</span><span class="token string">\'foo\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> populating instance dictionary\n<span class="token operator">*</span> Returning <span class="token string">\'Value for foo\'</span>\nFirst foo<span class="token punctuation">:</span>  Value <span class="token keyword">for</span> foo\nSecond foo<span class="token punctuation">:</span> Value <span class="token keyword">for</span> foo</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>exists 属性本来就在实例字典里，所以访问 data.exists 时不会触发 <code class="language-text">__getattr__</code>。接下来，开始访问 data.foo。foo 属性不在实例字典中，因此系统会触发 <code class="language-text">__getattr__</code> 方法，这个方法会通过 setattr 把 foo 属性添加到实例字典。然后，我们第二次访问 data.foo，这次 data 实例的 <code class="language-text">__dict__</code> 字典已经包含这个属性，所以不会触发 <code class="language-text">__getattr__</code>。</p>\n<p>如果要实现惰性的（lazy，也指按需的）数据访问机制，而这份数据又没有 schema，那么通过 <code class="language-text">__getattr__</code> 来做就相当合适。它只需要把属性加载一次即可，以后再访问这个属性时，系统会直接从实例字典中获取。</p>\n<p>假设我们现在还需要验证数据库系统的事务状态。也就是说，用户每次访问某属性时，我们都要确保数据库里面的那条记录依然有效，而且相应的事务也处在开启状态。这个需求没办法通过 <code class="language-text">__getattr__</code> 实现，因为一旦对象的实例字典里包含了这个属性，那么程序就会直接从字典获取，而不会再触发 <code class="language-text">__getattr__</code>。</p>\n<p>为了应对这种比较高级的用法，Python 的 object 还提供了另一个挂钩，叫作 <code class="language-text">__getattribute__</code>。只要访问对象中的属性，就会触发这个特殊方法，即便这项属性已经在 <code class="language-text">__dict__</code> 字典里，系统也还是会执行 <code class="language-text">__getattribute__</code> 方法。于是，我们可以在这个方法里面检测全局的事务状态，这样就能对每一次属性访问操作都进行验证了。同时，我们必须注意这种写法开销很大，而且会降低程序的效率，但有的时候确实值得这么做。下面就定义 ValidatingRecord 类，让它实现 <code class="language-text">__getattribute__</code> 方法，并在系统每次调用这个方法时，打印相关的日志消息。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="40602244407503860000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class ValidatingRecord:\n    def __init__(self):\n        self.exists = 5\n\n    def __getattribute__(self, name):\n        print(f\'* Called __getattribute__({name!r})\')\n        try:\n            value = super().__getattribute__(name)\n            print(f\'* Found {name!r}, returning {value!r}\')\n            return value\n        except AttributeError:\n            value = f\'Value for {name}\'\n            print(f\'* Setting {name!r} to {value!r}\')\n            setattr(self, name, value)\n            return value\n\n\ndata = ValidatingRecord()\nprint(\'exists:    \', data.exists)\nprint(\'First foo: \', data.foo)\nprint(\'Second foo:\', data.foo)\n\n>>>\n* Called __getattribute__(\'exists\')\n* Found \'exists\', returning 5\nexists:     5\n* Called __getattribute__(\'foo\')\n* Setting \'foo\' to \'Value for foo\'\nFirst foo:  Value for foo\n* Called __getattribute__(\'foo\')\n* Found \'foo\', returning \'Value for foo\'\nSecond foo: Value for foo`, `40602244407503860000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">ValidatingRecord</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>exists <span class="token operator">=</span> <span class="token number">5</span>\n\n    <span class="token keyword">def</span> <span class="token function">__getattribute__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'* Called __getattribute__(</span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">)\'</span></span><span class="token punctuation">)</span>\n        <span class="token keyword">try</span><span class="token punctuation">:</span>\n            value <span class="token operator">=</span> <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__getattribute__<span class="token punctuation">(</span>name<span class="token punctuation">)</span>\n            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'* Found </span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">, returning </span><span class="token interpolation"><span class="token punctuation">{</span>value<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n            <span class="token keyword">return</span> value\n        <span class="token keyword">except</span> AttributeError<span class="token punctuation">:</span>\n            value <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f\'Value for </span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token punctuation">}</span></span><span class="token string">\'</span></span>\n            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'* Setting </span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string"> to </span><span class="token interpolation"><span class="token punctuation">{</span>value<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n            <span class="token builtin">setattr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n            <span class="token keyword">return</span> value\n\n\ndata <span class="token operator">=</span> ValidatingRecord<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'exists:    \'</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>exists<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'First foo: \'</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>foo<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Second foo:\'</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>foo<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token operator">*</span> Called __getattribute__<span class="token punctuation">(</span><span class="token string">\'exists\'</span><span class="token punctuation">)</span>\n<span class="token operator">*</span> Found <span class="token string">\'exists\'</span><span class="token punctuation">,</span> returning <span class="token number">5</span>\nexists<span class="token punctuation">:</span>     <span class="token number">5</span>\n<span class="token operator">*</span> Called __getattribute__<span class="token punctuation">(</span><span class="token string">\'foo\'</span><span class="token punctuation">)</span>\n<span class="token operator">*</span> Setting <span class="token string">\'foo\'</span> to <span class="token string">\'Value for foo\'</span>\nFirst foo<span class="token punctuation">:</span>  Value <span class="token keyword">for</span> foo\n<span class="token operator">*</span> Called __getattribute__<span class="token punctuation">(</span><span class="token string">\'foo\'</span><span class="token punctuation">)</span>\n<span class="token operator">*</span> Found <span class="token string">\'foo\'</span><span class="token punctuation">,</span> returning <span class="token string">\'Value for foo\'</span>\nSecond foo<span class="token punctuation">:</span> Value <span class="token keyword">for</span> foo</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果要访问的属性根本就不应该存在，那么可以在 <code class="language-text">__getattr__</code> 方法里面拦截。无论是 <code class="language-text">__getattr__</code> 还是 <code class="language-text">__getattribute__</code>，都应该抛出标准的 AttributeError 来表示属性不存在或不适合存在的情况。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="75086237396408680000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class MissingPropertyRecord:\n    def __getattr__(self, name):\n        if name == \'bad_name\':\n            raise AttributeError(f\'{name} is missing\')\n        return ()\n\n\ndata = MissingPropertyRecord()\ndata.bad_name\n\n>>>\nTraceback ...\nAttributeError: bad_name is missing`, `75086237396408680000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">MissingPropertyRecord</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__getattr__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> name <span class="token operator">==</span> <span class="token string">\'bad_name\'</span><span class="token punctuation">:</span>\n            <span class="token keyword">raise</span> AttributeError<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token punctuation">}</span></span><span class="token string"> is missing\'</span></span><span class="token punctuation">)</span>\n        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n\ndata <span class="token operator">=</span> MissingPropertyRecord<span class="token punctuation">(</span><span class="token punctuation">)</span>\ndata<span class="token punctuation">.</span>bad_name\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nAttributeError<span class="token punctuation">:</span> bad_name <span class="token keyword">is</span> missing</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在编写通用的 Python 代码时，我们经常要依靠内置的 hasattr 函数判断属性是否存在，并且通过内置的 getattr 函数获取属性值。这些函数也会先在实例的 <code class="language-text">__dict__</code> 字典里面查找，如果找不到，则会触发 <code class="language-text">__getattr__</code>。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="32367754505224356000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class LazyRecord:\n    def __init__(self):\n        self.exists = 5\n\n    def __getattr__(self, name):\n        value = f\'Value for {name}\'\n        setattr(self, name, value)\n        return value\n\n\nclass LoggingLazyRecord(LazyRecord):\n    def __getattr__(self, name):\n        print(\n            f\'* Called __getattr__({name!r}), populating instance dictionary\')\n        result = super().__getattr__(name)\n        print(f\'* Returning {result!r}\')\n        return result\n\n\ndata = LoggingLazyRecord()  # Implements __getattr__\nprint(\'Before:        \', data.__dict__)\nprint(\'Has first foo: \', hasattr(data, \'foo\'))\nprint(\'After:         \', data.__dict__)\nprint(\'Has second foo:\', hasattr(data, \'foo\'))\n\n>>>\nBefore:         {\'exists\': 5}\n* Called __getattr__(\'foo\'), populating instance dictionary\n* Returning \'Value for foo\'\nHas first foo:  True\nAfter:          {\'exists\': 5, \'foo\': \'Value for foo\'}\nHas second foo: True`, `32367754505224356000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">LazyRecord</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>exists <span class="token operator">=</span> <span class="token number">5</span>\n\n    <span class="token keyword">def</span> <span class="token function">__getattr__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        value <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f\'Value for </span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token punctuation">}</span></span><span class="token string">\'</span></span>\n        <span class="token builtin">setattr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n        <span class="token keyword">return</span> value\n\n\n<span class="token keyword">class</span> <span class="token class-name">LoggingLazyRecord</span><span class="token punctuation">(</span>LazyRecord<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__getattr__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span>\n            <span class="token string-interpolation"><span class="token string">f\'* Called __getattr__(</span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">), populating instance dictionary\'</span></span><span class="token punctuation">)</span>\n        result <span class="token operator">=</span> <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__getattr__<span class="token punctuation">(</span>name<span class="token punctuation">)</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'* Returning </span><span class="token interpolation"><span class="token punctuation">{</span>result<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n        <span class="token keyword">return</span> result\n\n\ndata <span class="token operator">=</span> LoggingLazyRecord<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># Implements __getattr__</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Before:        \'</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>__dict__<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Has first foo: \'</span><span class="token punctuation">,</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token string">\'foo\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'After:         \'</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>__dict__<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Has second foo:\'</span><span class="token punctuation">,</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token string">\'foo\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nBefore<span class="token punctuation">:</span>         <span class="token punctuation">{</span><span class="token string">\'exists\'</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">}</span>\n<span class="token operator">*</span> Called __getattr__<span class="token punctuation">(</span><span class="token string">\'foo\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> populating instance dictionary\n<span class="token operator">*</span> Returning <span class="token string">\'Value for foo\'</span>\nHas first foo<span class="token punctuation">:</span>  <span class="token boolean">True</span>\nAfter<span class="token punctuation">:</span>          <span class="token punctuation">{</span><span class="token string">\'exists\'</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">\'foo\'</span><span class="token punctuation">:</span> <span class="token string">\'Value for foo\'</span><span class="token punctuation">}</span>\nHas second foo<span class="token punctuation">:</span> <span class="token boolean">True</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在运行上面那段代码的过程中，<code class="language-text">__getattr__</code> 只触发了一次。假如 data 所属的类实现的不是 <code class="language-text">__getattr__</code>，而是 <code class="language-text">__getattribute__</code> 方法，那么效果就不一样了，程序每次对实例做 hasattr 与 getattr 操作时，都会触发这个方法。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="78933276470530670000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class ValidatingRecord:\n    def __init__(self):\n        self.exists = 5\n\n    def __getattribute__(self, name):\n        print(f\'* Called __getattribute__({name!r})\')\n        try:\n            value = super().__getattribute__(name)\n            print(f\'* Found {name!r}, returning {value!r}\')\n            return value\n        except AttributeError:\n            value = f\'Value for {name}\'\n            print(f\'* Setting {name!r} to {value!r}\')\n            setattr(self, name, value)\n            return value\n\n\ndata = ValidatingRecord()  # Implements __getattribute__\nprint(\'Has first foo: \', hasattr(data, \'foo\'))\nprint(\'Has second foo:\', hasattr(data, \'foo\'))\n\n>>>\n* Called __getattribute__(\'foo\')\n* Setting \'foo\' to \'Value for foo\'\nHas first foo:  True\n* Called __getattribute__(\'foo\')\n* Found \'foo\', returning \'Value for foo\'\nHas second foo: True`, `78933276470530670000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">ValidatingRecord</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>exists <span class="token operator">=</span> <span class="token number">5</span>\n\n    <span class="token keyword">def</span> <span class="token function">__getattribute__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'* Called __getattribute__(</span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">)\'</span></span><span class="token punctuation">)</span>\n        <span class="token keyword">try</span><span class="token punctuation">:</span>\n            value <span class="token operator">=</span> <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__getattribute__<span class="token punctuation">(</span>name<span class="token punctuation">)</span>\n            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'* Found </span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">, returning </span><span class="token interpolation"><span class="token punctuation">{</span>value<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n            <span class="token keyword">return</span> value\n        <span class="token keyword">except</span> AttributeError<span class="token punctuation">:</span>\n            value <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f\'Value for </span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token punctuation">}</span></span><span class="token string">\'</span></span>\n            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'* Setting </span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string"> to </span><span class="token interpolation"><span class="token punctuation">{</span>value<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n            <span class="token builtin">setattr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n            <span class="token keyword">return</span> value\n\n\ndata <span class="token operator">=</span> ValidatingRecord<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># Implements __getattribute__</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Has first foo: \'</span><span class="token punctuation">,</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token string">\'foo\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Has second foo:\'</span><span class="token punctuation">,</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token string">\'foo\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token operator">*</span> Called __getattribute__<span class="token punctuation">(</span><span class="token string">\'foo\'</span><span class="token punctuation">)</span>\n<span class="token operator">*</span> Setting <span class="token string">\'foo\'</span> to <span class="token string">\'Value for foo\'</span>\nHas first foo<span class="token punctuation">:</span>  <span class="token boolean">True</span>\n<span class="token operator">*</span> Called __getattribute__<span class="token punctuation">(</span><span class="token string">\'foo\'</span><span class="token punctuation">)</span>\n<span class="token operator">*</span> Found <span class="token string">\'foo\'</span><span class="token punctuation">,</span> returning <span class="token string">\'Value for foo\'</span>\nHas second foo<span class="token punctuation">:</span> <span class="token boolean">True</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>假设程序给 Python 对象赋值时，我们不想立刻更新数据库，而是打算稍后再推送回去。这个功能可以通过 <code class="language-text">__setattr__</code> 实现，而它也是 object 提供的挂钩，可以拦截所有的属性赋值操作。属性的获取操作分别通过 <code class="language-text">__getattr__</code> 与 <code class="language-text">__getattribute__</code> 挂钩拦截，但设置操作只需要这一个挂钩就行。只要给实例中的属性赋值（不论是直接赋值，还是通过内置的 setattr 函数赋值），系统就触发 <code class="language-text">__setattr__</code> 方法。</p>\n<p>下面我们从 SavingRecord 中派生一个子类，让它的 <code class="language-text">__setattr__</code> 方法把每一次属性赋值操作都记录下来。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="54959843528169250000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class SavingRecord:\n    def __setattr__(self, name, value):\n        # Save some data for the record\n        super().__setattr__(name, value)\n\n\nclass LoggingSavingRecord(SavingRecord):\n    def __setattr__(self, name, value):\n        print(f\'* Called setattr__({name!r}, {value!r})\')\n        super().__setattr__(name, value)\n\n\ndata = LoggingSavingRecord()\nprint(\'Before: \', data.__dict__)\ndata.foo = 5\nprint(\'After:  \', data.__dict__)\ndata.foo = 7\nprint(\'Finally:\', data.__dict__)\n\n>>>\nBefore:  {}\n* Called setattr__(\'foo\', 5)\nAfter:   {\'foo\': 5}\n* Called setattr__(\'foo\', 7)\nFinally: {\'foo\': 7}`, `54959843528169250000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">SavingRecord</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__setattr__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token comment"># Save some data for the record</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__setattr__<span class="token punctuation">(</span>name<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">LoggingSavingRecord</span><span class="token punctuation">(</span>SavingRecord<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__setattr__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'* Called setattr__(</span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">, </span><span class="token interpolation"><span class="token punctuation">{</span>value<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">)\'</span></span><span class="token punctuation">)</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__setattr__<span class="token punctuation">(</span>name<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n\n\ndata <span class="token operator">=</span> LoggingSavingRecord<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Before: \'</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>__dict__<span class="token punctuation">)</span>\ndata<span class="token punctuation">.</span>foo <span class="token operator">=</span> <span class="token number">5</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'After:  \'</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>__dict__<span class="token punctuation">)</span>\ndata<span class="token punctuation">.</span>foo <span class="token operator">=</span> <span class="token number">7</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Finally:\'</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>__dict__<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nBefore<span class="token punctuation">:</span>  <span class="token punctuation">{</span><span class="token punctuation">}</span>\n<span class="token operator">*</span> Called setattr__<span class="token punctuation">(</span><span class="token string">\'foo\'</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>\nAfter<span class="token punctuation">:</span>   <span class="token punctuation">{</span><span class="token string">\'foo\'</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">}</span>\n<span class="token operator">*</span> Called setattr__<span class="token punctuation">(</span><span class="token string">\'foo\'</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span>\nFinally<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">\'foo\'</span><span class="token punctuation">:</span> <span class="token number">7</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><code class="language-text">__getattribute__</code> 与 <code class="language-text">__setattr__</code> 这样的方法有个问题，就是只要访问对象的属性，系统就会触发该方法。但有时候，我们其实并不希望出现这种效果。例如，我们想实现这样一个类，让它通过自制的字典而不是标准的 <code class="language-text">__dict__</code> 来保存属性，当在这个类的实例上面访问属性时，那么该实例会从自己的 <code class="language-text">_data</code> 字典里面查找。</p>\n<p>可是，这样就导致 <code class="language-text">__getattribute__</code> 方法必须访问 <code class="language-text">self._data</code> 才行。如果直接访问，那么程序就会一直递归下去，直到因为超过最大的递归层数而崩溃为止。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="7549509994364412000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class BrokenDictionaryRecord:\n    def __init__(self, data):\n        self._data = data\n\n    def __getattribute__(self, name):\n        print(f\'* Called __getattribute__({name!r})\')\n        return self._data[name]\n\n\ndata = BrokenDictionaryRecord({\'foo\': 3})\ndata.foo\n\n>>>\n* Called __getattribute__(\'foo\')\n* Called __getattribute__(\'_data\')\n...\nRecursionError: maximum recursion depth exceeded while calling a Python object`, `7549509994364412000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">BrokenDictionaryRecord</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>_data <span class="token operator">=</span> data\n\n    <span class="token keyword">def</span> <span class="token function">__getattribute__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'* Called __getattribute__(</span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">)\'</span></span><span class="token punctuation">)</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_data<span class="token punctuation">[</span>name<span class="token punctuation">]</span>\n\n\ndata <span class="token operator">=</span> BrokenDictionaryRecord<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">\'foo\'</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">}</span><span class="token punctuation">)</span>\ndata<span class="token punctuation">.</span>foo\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token operator">*</span> Called __getattribute__<span class="token punctuation">(</span><span class="token string">\'foo\'</span><span class="token punctuation">)</span>\n<span class="token operator">*</span> Called __getattribute__<span class="token punctuation">(</span><span class="token string">\'_data\'</span><span class="token punctuation">)</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nRecursionError<span class="token punctuation">:</span> maximum recursion depth exceeded <span class="token keyword">while</span> calling a Python <span class="token builtin">object</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>为什么会这样呢？因为在 <code class="language-text">__getattribute__</code> 访问 <code class="language-text">self._data</code> 时，由于 <code class="language-text">_data</code> 是自身的一项属性，程序会触发 <code class="language-text">__getattribute__</code> 来获取这项属性，这又会访问到 <code class="language-text">self._data</code>，于是程序就一直递归下去。为解决这个问题，我们可以改用 <code class="language-text">super().__getattribute__</code> 方法获取 <code class="language-text">_data</code> 属性，由于超类的 <code class="language-text">__getattribute__</code> 是直接从实例的属性字典获取的，不会继续触发 <code class="language-text">__getattribute__</code>，这样就避开了递归。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="60214056938127400000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class DictionaryRecord:\n    def __init__(self, data):\n        self._data = data\n\n    def __getattribute__(self, name):\n        print(f\'* Called __getattribute__({name!r})\')\n        return super().__getattribute__(\'_data\')[name]\n\n\ndata = DictionaryRecord({\'foo\': 3})\nprint(\'foo\', data.foo)\n\n>>>\n* Called __getattribute__(\'foo\')\nfoo 3`, `60214056938127400000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">DictionaryRecord</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>_data <span class="token operator">=</span> data\n\n    <span class="token keyword">def</span> <span class="token function">__getattribute__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'* Called __getattribute__(</span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">)\'</span></span><span class="token punctuation">)</span>\n        <span class="token keyword">return</span> <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__getattribute__<span class="token punctuation">(</span><span class="token string">\'_data\'</span><span class="token punctuation">)</span><span class="token punctuation">[</span>name<span class="token punctuation">]</span>\n\n\ndata <span class="token operator">=</span> DictionaryRecord<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">\'foo\'</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">}</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'foo\'</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>foo<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token operator">*</span> Called __getattribute__<span class="token punctuation">(</span><span class="token string">\'foo\'</span><span class="token punctuation">)</span>\nfoo <span class="token number">3</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在 <code class="language-text">__setattr__</code> 里面为这种对象实现属性修改逻辑时，也需要通过 <code class="language-text">super().__setattr__</code> 来获取 <code class="language-text">_data</code> 字典。</p>\n<h3 id="总结-43"><a href="#%E6%80%BB%E7%BB%93-43" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>如果想用自己的方式（例如惰性地或者按需地）加载并保存对象属性，那么可以在该对象所属的类里实现 <code class="language-text">__getattr__</code> 与 <code class="language-text">__setattr__</code> 特殊方法。</li>\n<li><code class="language-text">__getattr__</code> 只会在属性缺失时触发，而 <code class="language-text">__getattribute__</code> 则在每次访问属性时都要触发。</li>\n<li>在实现 <code class="language-text">__getattribute__</code> 与 <code class="language-text">__setattr__</code> 的过程中，如果要使用本对象的普通属性，那么应该通过 <code class="language-text">super()</code>（也就是 object 类）来使用，而不要直接使用，以避免无限递归。</li>\n</ol>\n<h2 id="第-48-条：用-__init_subclass__-验证子类写得是否正确"><a href="#%E7%AC%AC-48-%E6%9D%A1%EF%BC%9A%E7%94%A8-__init_subclass__-%E9%AA%8C%E8%AF%81%E5%AD%90%E7%B1%BB%E5%86%99%E5%BE%97%E6%98%AF%E5%90%A6%E6%AD%A3%E7%A1%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 48 条：用 <code class="language-text">__init_subclass__</code> 验证子类写得是否正确</h2>\n<p>元类最简单的一种用法是验证某个类定义得是否正确。如果要构建一套比较复杂的类体系，那我们可能得确保这套体系中的类采用的都是同一种风格，为此我们可能需要判断这些类有没有重写必要的方法，或者判断类属性之间的关系是否合理。元类提供了一种可靠的手段，只要根据这个元类来定义新类，就能用元类中的验证逻辑核查新类的代码写得是否正确。</p>\n<p>一般来说，我们会在类的 <code class="language-text">__init__</code> 方法里面检查新对象构造得是否正确（参见第 44 条）。但有的时候，整个类的写法可能都是错的，而不单单是该类的某个对象构造得有问题，所以我们想尽早拦住这种错误。例如，当程序刚刚启动并把包含这个类的模块加载进来时，我们就想验证这个类写得对不对，此时便可利用元类来实现。</p>\n<p>在讲解如何用自定义的元类验证子类之前，我们首先必须明白元类的标准用法。元类应该从 type 之中继承。在默认情况下，系统会把通过这个元类所定义的其他类发送给元类的 <code class="language-text">__new__</code> 方法，让该方法知道那个类的 class 语句是怎么写的。下面就定义这样一个元类，如果用户通过这个元类来定义其他类，那么在那个类真正构造出来之前，我们可以先在 <code class="language-text">__new__</code> 里面观察到它的写法并做出修改。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="10224016302166272000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Meta(type):\n    def __new__(meta, name, bases, class_dict):\n        print(f\'* Running {meta}.__new__ for {name}\')\n        print(\'Bases:\', bases)\n        print(class_dict)\n        return type.__new__(meta, name, bases, class_dict)\n\n\nclass MyClass(metaclass=Meta):\n    stuff = 123\n\n    def foo(self):\n        pass\n\n\nclass MySubclass(MyClass):\n    other = 567\n\n    def bar(self):\n        pass\n\n>>>\n* Running <class \'__main__.Meta\'>.__new__ for MyClass\nBases: ()\n{\'__module__\': \'__main__\', \'__qualname__\': \'MyClass\', \'stuff\': 123, \'foo\': <function MyClass.foo at 0x7f7b6c15b9d0>}\n* Running <class \'__main__.Meta\'>.__new__ for MySubclass\nBases: (<class \'__main__.MyClass\'>,)\n{\'__module__\': \'__main__\', \'__qualname__\': \'MySubclass\', \'other\': 567, \'bar\': <function MySubclass.bar at 0x7f7b6c15ba60>}`, `10224016302166272000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__new__</span><span class="token punctuation">(</span>meta<span class="token punctuation">,</span> name<span class="token punctuation">,</span> bases<span class="token punctuation">,</span> class_dict<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'* Running </span><span class="token interpolation"><span class="token punctuation">{</span>meta<span class="token punctuation">}</span></span><span class="token string">.__new__ for </span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Bases:\'</span><span class="token punctuation">,</span> bases<span class="token punctuation">)</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span>class_dict<span class="token punctuation">)</span>\n        <span class="token keyword">return</span> <span class="token builtin">type</span><span class="token punctuation">.</span>__new__<span class="token punctuation">(</span>meta<span class="token punctuation">,</span> name<span class="token punctuation">,</span> bases<span class="token punctuation">,</span> class_dict<span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">MyClass</span><span class="token punctuation">(</span>metaclass<span class="token operator">=</span>Meta<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    stuff <span class="token operator">=</span> <span class="token number">123</span>\n\n    <span class="token keyword">def</span> <span class="token function">foo</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">pass</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">MySubclass</span><span class="token punctuation">(</span>MyClass<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    other <span class="token operator">=</span> <span class="token number">567</span>\n\n    <span class="token keyword">def</span> <span class="token function">bar</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">pass</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token operator">*</span> Running <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">\'__main__.Meta\'</span><span class="token operator">></span><span class="token punctuation">.</span>__new__ <span class="token keyword">for</span> MyClass\nBases<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token punctuation">{</span><span class="token string">\'__module__\'</span><span class="token punctuation">:</span> <span class="token string">\'__main__\'</span><span class="token punctuation">,</span> <span class="token string">\'__qualname__\'</span><span class="token punctuation">:</span> <span class="token string">\'MyClass\'</span><span class="token punctuation">,</span> <span class="token string">\'stuff\'</span><span class="token punctuation">:</span> <span class="token number">123</span><span class="token punctuation">,</span> <span class="token string">\'foo\'</span><span class="token punctuation">:</span> <span class="token operator">&lt;</span>function MyClass<span class="token punctuation">.</span>foo at <span class="token number">0x7f7b6c15b9d0</span><span class="token operator">></span><span class="token punctuation">}</span>\n<span class="token operator">*</span> Running <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">\'__main__.Meta\'</span><span class="token operator">></span><span class="token punctuation">.</span>__new__ <span class="token keyword">for</span> MySubclass\nBases<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">\'__main__.MyClass\'</span><span class="token operator">></span><span class="token punctuation">,</span><span class="token punctuation">)</span>\n<span class="token punctuation">{</span><span class="token string">\'__module__\'</span><span class="token punctuation">:</span> <span class="token string">\'__main__\'</span><span class="token punctuation">,</span> <span class="token string">\'__qualname__\'</span><span class="token punctuation">:</span> <span class="token string">\'MySubclass\'</span><span class="token punctuation">,</span> <span class="token string">\'other\'</span><span class="token punctuation">:</span> <span class="token number">567</span><span class="token punctuation">,</span> <span class="token string">\'bar\'</span><span class="token punctuation">:</span> <span class="token operator">&lt;</span>function MySubclass<span class="token punctuation">.</span>bar at <span class="token number">0x7f7b6c15ba60</span><span class="token operator">></span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>元类可以获知那个类的名称（name）、那个类的所有超类（bases）以及 class 语句体中定义的所有类属性（<code class="language-text">class_dict</code>）。因为每个类最终都要继承 object，所以这个 object 名字不会体现在罗列超类名称的 bases 元组之中。</p>\n<p>我们可以在元类的 <code class="language-text">__new__</code> 方法里面添加一些代码，用来判断根据这个元类所定义的类的各项参数是否合理。例如，要用不同的类来表示边数不同的多边形（polygon）。如果把这些类都纳入同一套体系，那么可以定义这样一个元类，让该体系内的所有类都受它约束。我们在这个元类的 <code class="language-text">__new__</code> 里面检查那些类的边数（sides）是否有效。注意，不要把检查逻辑运用到类体系的顶端，也就是基类 Polygon 上面。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="14990455886595178000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class ValidatePolygon(type):\n    def __new__(meta, name, bases, class_dict):\n        # Only validate subclasses of the Polygon class\n        if bases:\n            if class_dict[\'sides\'] < 3:\n                raise ValueError(\'Polygons need 3+ sides\')\n        return type.__new__(meta, name, bases, class_dict)\n\n\nclass Polygon(metaclass=ValidatePolygon):\n    sides = None  # Must be specified by subclasses\n\n    @classmethod\n    def interior_angles(cls):\n        return (cls.sides - 2) * 180\n\n\nclass Triangle(Polygon):\n    sides = 3\n\n\nclass Rectangle(Polygon):\n    sides = 4\n\n\nclass Nonagon(Polygon):\n    sides = 9\n\n\nassert Triangle.interior_angles() == 180\nassert Rectangle.interior_angles() == 360\nassert Nonagon.interior_angles() == 1260`, `14990455886595178000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">ValidatePolygon</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__new__</span><span class="token punctuation">(</span>meta<span class="token punctuation">,</span> name<span class="token punctuation">,</span> bases<span class="token punctuation">,</span> class_dict<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token comment"># Only validate subclasses of the Polygon class</span>\n        <span class="token keyword">if</span> bases<span class="token punctuation">:</span>\n            <span class="token keyword">if</span> class_dict<span class="token punctuation">[</span><span class="token string">\'sides\'</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">:</span>\n                <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">\'Polygons need 3+ sides\'</span><span class="token punctuation">)</span>\n        <span class="token keyword">return</span> <span class="token builtin">type</span><span class="token punctuation">.</span>__new__<span class="token punctuation">(</span>meta<span class="token punctuation">,</span> name<span class="token punctuation">,</span> bases<span class="token punctuation">,</span> class_dict<span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">Polygon</span><span class="token punctuation">(</span>metaclass<span class="token operator">=</span>ValidatePolygon<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    sides <span class="token operator">=</span> <span class="token boolean">None</span>  <span class="token comment"># Must be specified by subclasses</span>\n\n    <span class="token decorator annotation punctuation">@classmethod</span>\n    <span class="token keyword">def</span> <span class="token function">interior_angles</span><span class="token punctuation">(</span>cls<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token punctuation">(</span>cls<span class="token punctuation">.</span>sides <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">180</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">Triangle</span><span class="token punctuation">(</span>Polygon<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    sides <span class="token operator">=</span> <span class="token number">3</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">Rectangle</span><span class="token punctuation">(</span>Polygon<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    sides <span class="token operator">=</span> <span class="token number">4</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">Nonagon</span><span class="token punctuation">(</span>Polygon<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    sides <span class="token operator">=</span> <span class="token number">9</span>\n\n\n<span class="token keyword">assert</span> Triangle<span class="token punctuation">.</span>interior_angles<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">180</span>\n<span class="token keyword">assert</span> Rectangle<span class="token punctuation">.</span>interior_angles<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">360</span>\n<span class="token keyword">assert</span> Nonagon<span class="token punctuation">.</span>interior_angles<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1260</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果我们试着定义边数小于 3 的多边形子类，那么刚把那个子类的 class 语句体写完，元类就会通过 <code class="language-text">__new__</code> 方法察觉到这个问题。这意味着，只要定义了无效的多边形子类，程序就无法正常启动，除非那个类是在动态引入的模块里面定义的（参见第 88 条）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="22857817185746110000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Line(Polygon):\n    sides = 2\n\n>>>\nTraceback ...\nValueError: Polygons need 3+ sides`, `22857817185746110000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Line</span><span class="token punctuation">(</span>Polygon<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    sides <span class="token operator">=</span> <span class="token number">2</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nValueError<span class="token punctuation">:</span> Polygons need <span class="token number">3</span><span class="token operator">+</span> sides</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样一项基本的任务竟然要写这么多代码才能实现。好在 Python 3.6 引入了一种简化的写法，能够直接通过 <code class="language-text">__init_subclass__</code> 这个特殊的类方法实现相同的功能，这样就不用专门定义元类了。下面我们改用这个机制来实现与刚才相同的验证逻辑。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="58442121759268620000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class BetterPolygon:\n    sides = None  # Must be specified by subclasses\n\n    def __init_subclass__(cls):\n        super().__init_subclass__()\n        if cls.sides < 3:\n            raise ValueError(\'Polygons need 3+ sides\')\n\n    @classmethod\n    def interior_angles(cls):\n        return (cls.sides - 2) * 180\n\n\nclass Hexagon(BetterPolygon):\n    sides = 6\n\n\nassert Hexagon.interior_angles() == 720`, `58442121759268620000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">BetterPolygon</span><span class="token punctuation">:</span>\n    sides <span class="token operator">=</span> <span class="token boolean">None</span>  <span class="token comment"># Must be specified by subclasses</span>\n\n    <span class="token keyword">def</span> <span class="token function">__init_subclass__</span><span class="token punctuation">(</span>cls<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init_subclass__<span class="token punctuation">(</span><span class="token punctuation">)</span>\n        <span class="token keyword">if</span> cls<span class="token punctuation">.</span>sides <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">:</span>\n            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">\'Polygons need 3+ sides\'</span><span class="token punctuation">)</span>\n\n    @<span class="token builtin">classmethod</span>\n    <span class="token keyword">def</span> <span class="token function">interior_angles</span><span class="token punctuation">(</span>cls<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token punctuation">(</span>cls<span class="token punctuation">.</span>sides <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">180</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">Hexagon</span><span class="token punctuation">(</span>BetterPolygon<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    sides <span class="token operator">=</span> <span class="token number">6</span>\n\n\n<span class="token keyword">assert</span> Hexagon<span class="token punctuation">.</span>interior_angles<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">720</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在的代码简短多了，完全不需要定义 ValidatePolygon 这样一个元类。在 <code class="language-text">__init_subclass__</code> 方法里面，我们可以直接通过 cls 实例来访问类级别的 sides 属性，而不用像原来那样，在存放类属性的 <code class="language-text">class_dict</code> 里面查询 sides 键。现在的多边形子类应该继承刚写的 BetterPolygon 基类。如果子类定义的边数无效，那么程序会抛出同样的异常。</p>\n<p>用标准的 Python 元类机制来实现验证还有个缺点，就是每个类只能定义一个元类。例如，这里还有一个元类，可以验证某个区域的填充色是否有效（这个区域有可能是多边形区域，也有可能不是）。</p>\n<p>如果想同时利用 Filled 的元类与 Polygon 的元类做验证，那么程序就会给出奇怪的错误消息。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="32753885043747700000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class ValidatePolygon(type):\n    def __new__(meta, name, bases, class_dict):\n        # Only validate subclasses of the Polygon class\n        if bases:\n            if class_dict[\'sides\'] < 3:\n                raise ValueError(\'Polygons need 3+ sides\')\n        return type.__new__(meta, name, bases, class_dict)\n\n\nclass Polygon(metaclass=ValidatePolygon):\n    sides = None  # Must be specified by subclasses\n\n    @classmethod\n    def interior_angles(cls):\n        return (cls.sides - 2) * 180\n\n\nclass ValidateFilled(type):\n    def __new__(meta, name, bases, class_dict):\n        # Only validate subclasses of the Filled class\n        if bases:\n            if class_dict[\'color\'] not in (\'red\', \'green\'):\n                raise ValueError(\'Fill color must be supported\')\n        return type.__new__(meta, name, bases, class_dict)\n\n\nclass Filled (metaclass=ValidateFilled):\n    color = None  # Must be specified by subclasses\n\n\nclass RedPentagon(Filled, Polygon):\n    color = \'red\'\n    sides = 5\n\n>>>\nTraceback ...\nTypeError: metaclass conflict: the metaclass of a derived class must be a (non-strict) subclass of the metaclasses of all its bases`, `32753885043747700000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">ValidatePolygon</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__new__</span><span class="token punctuation">(</span>meta<span class="token punctuation">,</span> name<span class="token punctuation">,</span> bases<span class="token punctuation">,</span> class_dict<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token comment"># Only validate subclasses of the Polygon class</span>\n        <span class="token keyword">if</span> bases<span class="token punctuation">:</span>\n            <span class="token keyword">if</span> class_dict<span class="token punctuation">[</span><span class="token string">\'sides\'</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">:</span>\n                <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">\'Polygons need 3+ sides\'</span><span class="token punctuation">)</span>\n        <span class="token keyword">return</span> <span class="token builtin">type</span><span class="token punctuation">.</span>__new__<span class="token punctuation">(</span>meta<span class="token punctuation">,</span> name<span class="token punctuation">,</span> bases<span class="token punctuation">,</span> class_dict<span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">Polygon</span><span class="token punctuation">(</span>metaclass<span class="token operator">=</span>ValidatePolygon<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    sides <span class="token operator">=</span> <span class="token boolean">None</span>  <span class="token comment"># Must be specified by subclasses</span>\n\n    <span class="token decorator annotation punctuation">@classmethod</span>\n    <span class="token keyword">def</span> <span class="token function">interior_angles</span><span class="token punctuation">(</span>cls<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token punctuation">(</span>cls<span class="token punctuation">.</span>sides <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">180</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">ValidateFilled</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__new__</span><span class="token punctuation">(</span>meta<span class="token punctuation">,</span> name<span class="token punctuation">,</span> bases<span class="token punctuation">,</span> class_dict<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token comment"># Only validate subclasses of the Filled class</span>\n        <span class="token keyword">if</span> bases<span class="token punctuation">:</span>\n            <span class="token keyword">if</span> class_dict<span class="token punctuation">[</span><span class="token string">\'color\'</span><span class="token punctuation">]</span> <span class="token keyword">not</span> <span class="token keyword">in</span> <span class="token punctuation">(</span><span class="token string">\'red\'</span><span class="token punctuation">,</span> <span class="token string">\'green\'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n                <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">\'Fill color must be supported\'</span><span class="token punctuation">)</span>\n        <span class="token keyword">return</span> <span class="token builtin">type</span><span class="token punctuation">.</span>__new__<span class="token punctuation">(</span>meta<span class="token punctuation">,</span> name<span class="token punctuation">,</span> bases<span class="token punctuation">,</span> class_dict<span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">Filled</span> <span class="token punctuation">(</span>metaclass<span class="token operator">=</span>ValidateFilled<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    color <span class="token operator">=</span> <span class="token boolean">None</span>  <span class="token comment"># Must be specified by subclasses</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">RedPentagon</span><span class="token punctuation">(</span>Filled<span class="token punctuation">,</span> Polygon<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    color <span class="token operator">=</span> <span class="token string">\'red\'</span>\n    sides <span class="token operator">=</span> <span class="token number">5</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nTypeError<span class="token punctuation">:</span> metaclass conflict<span class="token punctuation">:</span> the metaclass of a derived <span class="token keyword">class</span> <span class="token class-name">must</span> be a <span class="token punctuation">(</span>non<span class="token operator">-</span>strict<span class="token punctuation">)</span> subclass of the metaclasses of <span class="token builtin">all</span> its bases</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>要解决这个问题，我们可以创建一套元类体系，让不同层面上的元类分别完成各自的验证逻辑（也就是先在下层元类里面验证填充色，如果验证无误，那么再去上层元类里面验证边数）。</p>\n<p>同时，这也要求我们必须设计一个支持填充色的多边形类（FilledPolygon），让它在多边形类（Polygon）的基础上增加填充色逻辑，而不能像刚才那样，把填充色与边数分别放在 Filled 与 Polygon 两个类中。现在，带有具体填充色与边数的多边形需要从这个 FilledPolygon 里面继承。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="23615902734263860000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class ValidatePolygon(type):\n    def __new__(meta, name, bases, class_dict):\n        # Only validate non-root classes\n        if not class_dict.get(\'is_root\'):\n            if class_dict[\'sides\'] < 3:\n                raise ValueError(\'Polygons need 3+ sides\')\n        return type.__new__(meta, name, bases, class_dict)\n\n\nclass Polygon(metaclass=ValidatePolygon):\n    is_root = True\n    sides = None  # Must be specified by subclasses\n\n\nclass ValidateFilledPolygon(ValidatePolygon):\n    def __new__(meta, name, bases, class_dict):\n        # Only validate non-root classes\n        if not class_dict.get(\'is_root\'):\n            if class_dict[\'color\'] not in (\'red\', \'green\'):\n                raise ValueError(\'Fill color must be supported\')\n        return super().__new__(meta, name, bases, class_dict)\n\n\nclass FilledPolygon(Polygon, metaclass=ValidateFilledPolygon):\n    is_root = True\n    color = None  # Must be specified by subclasses\n\n\nclass GreenPentagon(FilledPolygon):\n    color = \'green\'\n    sides = 5\n\n\ngreenie = GreenPentagon()\nassert isinstance(greenie, Polygon)`, `23615902734263860000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">ValidatePolygon</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__new__</span><span class="token punctuation">(</span>meta<span class="token punctuation">,</span> name<span class="token punctuation">,</span> bases<span class="token punctuation">,</span> class_dict<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token comment"># Only validate non-root classes</span>\n        <span class="token keyword">if</span> <span class="token keyword">not</span> class_dict<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">\'is_root\'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">if</span> class_dict<span class="token punctuation">[</span><span class="token string">\'sides\'</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">:</span>\n                <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">\'Polygons need 3+ sides\'</span><span class="token punctuation">)</span>\n        <span class="token keyword">return</span> <span class="token builtin">type</span><span class="token punctuation">.</span>__new__<span class="token punctuation">(</span>meta<span class="token punctuation">,</span> name<span class="token punctuation">,</span> bases<span class="token punctuation">,</span> class_dict<span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">Polygon</span><span class="token punctuation">(</span>metaclass<span class="token operator">=</span>ValidatePolygon<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    is_root <span class="token operator">=</span> <span class="token boolean">True</span>\n    sides <span class="token operator">=</span> <span class="token boolean">None</span>  <span class="token comment"># Must be specified by subclasses</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">ValidateFilledPolygon</span><span class="token punctuation">(</span>ValidatePolygon<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__new__</span><span class="token punctuation">(</span>meta<span class="token punctuation">,</span> name<span class="token punctuation">,</span> bases<span class="token punctuation">,</span> class_dict<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token comment"># Only validate non-root classes</span>\n        <span class="token keyword">if</span> <span class="token keyword">not</span> class_dict<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">\'is_root\'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">if</span> class_dict<span class="token punctuation">[</span><span class="token string">\'color\'</span><span class="token punctuation">]</span> <span class="token keyword">not</span> <span class="token keyword">in</span> <span class="token punctuation">(</span><span class="token string">\'red\'</span><span class="token punctuation">,</span> <span class="token string">\'green\'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n                <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">\'Fill color must be supported\'</span><span class="token punctuation">)</span>\n        <span class="token keyword">return</span> <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__new__<span class="token punctuation">(</span>meta<span class="token punctuation">,</span> name<span class="token punctuation">,</span> bases<span class="token punctuation">,</span> class_dict<span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">FilledPolygon</span><span class="token punctuation">(</span>Polygon<span class="token punctuation">,</span> metaclass<span class="token operator">=</span>ValidateFilledPolygon<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    is_root <span class="token operator">=</span> <span class="token boolean">True</span>\n    color <span class="token operator">=</span> <span class="token boolean">None</span>  <span class="token comment"># Must be specified by subclasses</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">GreenPentagon</span><span class="token punctuation">(</span>FilledPolygon<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    color <span class="token operator">=</span> <span class="token string">\'green\'</span>\n    sides <span class="token operator">=</span> <span class="token number">5</span>\n\n\ngreenie <span class="token operator">=</span> GreenPentagon<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">assert</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>greenie<span class="token punctuation">,</span> Polygon<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样写虽然能实现验证，但却没办法组合。我们当时之所以把验证逻辑分别写在 ValidatePolygon 与 ValidateFilled 里面，就是想要让这些逻辑可以自由组合（类似 mix-in，参见第 41 条）。但是按照现在这种写法，如果想把颜色的验证逻辑施加在多边形之外的另一套类体系中，那么必须按照刚才的样板重复编写许多代码才行，而没办法很方便地复用已有的代码。</p>\n<p>这个问题，同样可以通过 <code class="language-text">__init_subclass__</code> 这个特殊的类方法来解决。在多层的类体系中，只要通过内置的 super() 函数来调用 <code class="language-text">__init_subclass__</code> 方法，系统就会按照适当的解析顺序触发超类或平级类的 <code class="language-text">__init_subclass__</code> 方法，以保证那些类在各自的 <code class="language-text">__init_subclass__</code> 里面所实现的验证逻辑也能够正确地执行（类似案例参见第 40 条）。这种写法可以正确应对多重继承。例如，下面这个 Filled 类就通过 <code class="language-text">__init_subclass__</code> 来验证填充色，这样的话，子类可以同时继承该类以及刚才的 BetterPolygon 类，从而把这两个类所实现的验证逻辑组合起来。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="27333946894104310000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Filled:\n    color = None  # Must be specified by subclasses\n\n    def __init_subclass__(cls):\n        super().__init_subclass__() # 调用下一个超类的方法\n        if cls.color not in (\'red\', \'green\', \'blue\'):\n            raise ValueError(\'Fills need a valid color\')\n\n\nclass BetterPolygon:\n    sides = None  # Must be specified by subclasses\n\n    def __init_subclass__(cls):\n        super().__init_subclass__() # 调用下一个超类的方法\n        if cls.sides < 3:\n            raise ValueError(\'Polygons need 3+ sides\')\n\n    @classmethod\n    def interior_angles(cls):\n        return (cls.sides - 2) * 180\n\n\nclass RedTriangle(Filled, BetterPolygon):\n    color = \'red\'\n    sides = 3\n\n\nruddy = RedTriangle()\nassert isinstance(ruddy, Filled)\nassert isinstance(ruddy, BetterPolygon)`, `27333946894104310000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Filled</span><span class="token punctuation">:</span>\n    color <span class="token operator">=</span> <span class="token boolean">None</span>  <span class="token comment"># Must be specified by subclasses</span>\n\n    <span class="token keyword">def</span> <span class="token function">__init_subclass__</span><span class="token punctuation">(</span>cls<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init_subclass__<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 调用下一个超类的方法</span>\n        <span class="token keyword">if</span> cls<span class="token punctuation">.</span>color <span class="token keyword">not</span> <span class="token keyword">in</span> <span class="token punctuation">(</span><span class="token string">\'red\'</span><span class="token punctuation">,</span> <span class="token string">\'green\'</span><span class="token punctuation">,</span> <span class="token string">\'blue\'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">\'Fills need a valid color\'</span><span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">BetterPolygon</span><span class="token punctuation">:</span>\n    sides <span class="token operator">=</span> <span class="token boolean">None</span>  <span class="token comment"># Must be specified by subclasses</span>\n\n    <span class="token keyword">def</span> <span class="token function">__init_subclass__</span><span class="token punctuation">(</span>cls<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init_subclass__<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 调用下一个超类的方法</span>\n        <span class="token keyword">if</span> cls<span class="token punctuation">.</span>sides <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">:</span>\n            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">\'Polygons need 3+ sides\'</span><span class="token punctuation">)</span>\n\n    @<span class="token builtin">classmethod</span>\n    <span class="token keyword">def</span> <span class="token function">interior_angles</span><span class="token punctuation">(</span>cls<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token punctuation">(</span>cls<span class="token punctuation">.</span>sides <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">180</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">RedTriangle</span><span class="token punctuation">(</span>Filled<span class="token punctuation">,</span> BetterPolygon<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    color <span class="token operator">=</span> <span class="token string">\'red\'</span>\n    sides <span class="token operator">=</span> <span class="token number">3</span>\n\n\nruddy <span class="token operator">=</span> RedTriangle<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">assert</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>ruddy<span class="token punctuation">,</span> Filled<span class="token punctuation">)</span>\n<span class="token keyword">assert</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>ruddy<span class="token punctuation">,</span> BetterPolygon<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="15508667822833000000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Top:\n    def __init_subclass__(cls):\n        super().__init_subclass__()\n        print(f\'Top for {cls}\')\n\n\nclass Left(Top):\n    def __init_subclass__(cls):\n        super().__init_subclass__()\n        print(f\'Left for {cls}\')\n\n\nclass Right(Top):\n    def __init_subclass__(cls):\n        super().__init_subclass__()\n        print(f\'Right for {cls}\')\n\n\nclass Bottom(Left, Right):\n    def __init_subclass__(cls):\n        super().__init_subclass__()\n        print(f\'Bottom for {cls}\')\n\n>>>\nTop for <class \'__main__.Left\'>\nTop for <class \'__main__.Right\'>\nTop for <class \'__main__.Bottom\'>\nRight for <class \'__main__.Bottom\'>\nLeft for <class \'__main__.Bottom\'>`, `15508667822833000000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Top</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init_subclass__</span><span class="token punctuation">(</span>cls<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init_subclass__<span class="token punctuation">(</span><span class="token punctuation">)</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Top for </span><span class="token interpolation"><span class="token punctuation">{</span>cls<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">Left</span><span class="token punctuation">(</span>Top<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init_subclass__</span><span class="token punctuation">(</span>cls<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init_subclass__<span class="token punctuation">(</span><span class="token punctuation">)</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Left for </span><span class="token interpolation"><span class="token punctuation">{</span>cls<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">Right</span><span class="token punctuation">(</span>Top<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init_subclass__</span><span class="token punctuation">(</span>cls<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init_subclass__<span class="token punctuation">(</span><span class="token punctuation">)</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Right for </span><span class="token interpolation"><span class="token punctuation">{</span>cls<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">Bottom</span><span class="token punctuation">(</span>Left<span class="token punctuation">,</span> Right<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init_subclass__</span><span class="token punctuation">(</span>cls<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init_subclass__<span class="token punctuation">(</span><span class="token punctuation">)</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Bottom for </span><span class="token interpolation"><span class="token punctuation">{</span>cls<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTop <span class="token keyword">for</span> <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">\'__main__.Left\'</span><span class="token operator">></span>\nTop <span class="token keyword">for</span> <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">\'__main__.Right\'</span><span class="token operator">></span>\nTop <span class="token keyword">for</span> <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">\'__main__.Bottom\'</span><span class="token operator">></span>\nRight <span class="token keyword">for</span> <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">\'__main__.Bottom\'</span><span class="token operator">></span>\nLeft <span class="token keyword">for</span> <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">\'__main__.Bottom\'</span><span class="token operator">></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以看到，解决了菱形继承问题，体系底部的 Bottom 类通过 Left 与 Right 两条路径重复继承了体系顶端的 Top 类。然而，由于是通过 super() 触发 <code class="language-text">__init_subclass__</code>，系统在处理 Bottom 类的定义时，只会把 Top 类的 <code class="language-text">__init_subclass__</code> 执行一遍。</p>\n<h3 id="总结-44"><a href="#%E6%80%BB%E7%BB%93-44" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>如果某个类是根据元类所定义的，那么当系统把该类的 class 语句体全部处理完之后，就会将这个类的写法告诉元类的 <code class="language-text">__new__</code> 方法。</li>\n<li>可以利用元类在类创建完成前检视或修改开发者根据这个元类所定义的其他类，但这种机制通常显得有点笨重。</li>\n<li><code class="language-text">__init_subclass__</code> 能够用来检查子类定义得是否合理，如果不合理，那么可以提前报错，让程序无法创建出这种子类的对象。</li>\n<li>在分层的或者涉及多重继承的类体系里面，一定别忘了在你写的这些类的<code class="language-text">__init_subclass__</code> 内通过 super() 来调用超类的 <code class="language-text">__init_subclass__</code> 方法，以便按照正确的顺序触发各类的验证逻辑。</li>\n</ol>\n<h2 id="第-49-条：用-__init_subclass__-记录现有的子类"><a href="#%E7%AC%AC-49-%E6%9D%A1%EF%BC%9A%E7%94%A8-__init_subclass__-%E8%AE%B0%E5%BD%95%E7%8E%B0%E6%9C%89%E7%9A%84%E5%AD%90%E7%B1%BB" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 49 条：用 <code class="language-text">__init_subclass__</code> 记录现有的子类</h2>\n<p>元类还有个常见的用途，是可以自动记录（或者说注册）程序之中的类型。利用这项功能，我们就能根据某个标识符反向查出它所对应的类。</p>\n<p>例如，笔者想按照自己的办法给 Python 对象做序列化处理，并将其表示成 JSON 格式的数据。要实现这个功能，首先得想办法把对象转换成 JSON 字符串。笔者在这里设计一套通用的方案，让那些想要支持这种序列化功能的类都来继承下面这个 Serializable 基类，并把构造时所用的参数上报给它，这样的话，它就可以把这些参数转换成一份 JSON 字典。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="11191096674510991000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import json\n\n\nclass Serializable:\n    def __init__(self, *args):\n        self.args = args\n\n    def serialize(self):\n        return json.dumps({\'args\': self.args})`, `11191096674510991000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> json\n\n\n<span class="token keyword">class</span> <span class="token class-name">Serializable</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>args <span class="token operator">=</span> args\n\n    <span class="token keyword">def</span> <span class="token function">serialize</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">\'args\'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>args<span class="token punctuation">}</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>有了这个类，我们很容易就能把 Point2D 这样简单而不可变的数据转化成 JSON 字符串。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="81855224221422620000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import json\n\n\nclass Serializable:\n    def __init__(self, *args):\n        self.args = args\n\n    def serialize(self):\n        return json.dumps({\'args\': self.args})\n\n\nclass Point2D(Serializable):\n    def __init__(self, x, y):\n        super().__init__(x, y)\n        self.x = x\n        self.y = y\n\n    def __repr__(self):\n        return f\'Point2D({self.x}, {self.y})\'\n\n\npoint = Point2D(5, 3)\nprint(\'Object:    \', point)\nprint(\'Serialized:\', point.serialize())\n\n>>>\nObject:     Point2D(5, 3)\nSerialized: {&quot;args&quot;: [5, 3]}`, `81855224221422620000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> json\n\n\n<span class="token keyword">class</span> <span class="token class-name">Serializable</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>args <span class="token operator">=</span> args\n\n    <span class="token keyword">def</span> <span class="token function">serialize</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">\'args\'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>args<span class="token punctuation">}</span><span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">Point2D</span><span class="token punctuation">(</span>Serializable<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>x <span class="token operator">=</span> x\n        self<span class="token punctuation">.</span>y <span class="token operator">=</span> y\n\n    <span class="token keyword">def</span> <span class="token function">__repr__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f\'Point2D(</span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>x<span class="token punctuation">}</span></span><span class="token string">, </span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>y<span class="token punctuation">}</span></span><span class="token string">)\'</span></span>\n\n\npoint <span class="token operator">=</span> Point2D<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Object:    \'</span><span class="token punctuation">,</span> point<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Serialized:\'</span><span class="token punctuation">,</span> point<span class="token punctuation">.</span>serialize<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nObject<span class="token punctuation">:</span>     Point2D<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>\nSerialized<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"args"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>假设还需要实现反序列化的功能，也就是把 JSON 格式的字符串还原成它所表示的那个 Point2D 对象。下面，我们定义这样一个类，让它继承自 Serializable，从而获得序列化的功能，并把反序列化的功能留给自己或自己的子类去实现，这样它就成了一个既支持序列化又支持反序列化的类。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="96709569622507850000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Deserializable(Serializable):\n    @classmethod\n    def deserialize(cls, json_data):\n        params = json.loads(json_data)\n        return cls(*params[\'args\'])`, `96709569622507850000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Deserializable</span><span class="token punctuation">(</span>Serializable<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    @<span class="token builtin">classmethod</span>\n    <span class="token keyword">def</span> <span class="token function">deserialize</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> json_data<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        params <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>json_data<span class="token punctuation">)</span>\n        <span class="token keyword">return</span> cls<span class="token punctuation">(</span><span class="token operator">*</span>params<span class="token punctuation">[</span><span class="token string">\'args\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们可以通过这样一套通用的方式，让比较简单的不可变数据同时具备序列化与反序列化的功能。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="4901777599575241000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import json\n\n\nclass Serializable:\n    def __init__(self, *args):\n        self.args = args\n\n    def serialize(self):\n        return json.dumps({\'args\': self.args})\n\n\nclass Deserializable(Serializable):\n    @classmethod\n    def deserialize(cls, json_data):\n        params = json.loads(json_data)\n        return cls(*params[\'args\'])\n\n\nclass BetterPoint2D(Deserializable):\n    def __init__(self, x, y):\n        super().__init__(x, y)\n        self.x = x\n        self.y = y\n\n    def __repr__(self):\n        return f\'Point2D({self.x}, {self.y})\'\n\n\nbefore = BetterPoint2D(5, 3)\nprint(\'Before:    \',  before)\ndata = before.serialize()\nprint(\'Serialized:\', data)\nafter = BetterPoint2D.deserialize(data)\nprint(\'After:     \', after)\n\n>>>\nBefore:     Point2D(5, 3)\nSerialized: {&quot;args&quot;: [5, 3]}\nAfter:      Point2D(5, 3)`, `4901777599575241000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> json\n\n\n<span class="token keyword">class</span> <span class="token class-name">Serializable</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>args <span class="token operator">=</span> args\n\n    <span class="token keyword">def</span> <span class="token function">serialize</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">\'args\'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>args<span class="token punctuation">}</span><span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">Deserializable</span><span class="token punctuation">(</span>Serializable<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    @<span class="token builtin">classmethod</span>\n    <span class="token keyword">def</span> <span class="token function">deserialize</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> json_data<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        params <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>json_data<span class="token punctuation">)</span>\n        <span class="token keyword">return</span> cls<span class="token punctuation">(</span><span class="token operator">*</span>params<span class="token punctuation">[</span><span class="token string">\'args\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">BetterPoint2D</span><span class="token punctuation">(</span>Deserializable<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>x <span class="token operator">=</span> x\n        self<span class="token punctuation">.</span>y <span class="token operator">=</span> y\n\n    <span class="token keyword">def</span> <span class="token function">__repr__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f\'Point2D(</span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>x<span class="token punctuation">}</span></span><span class="token string">, </span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>y<span class="token punctuation">}</span></span><span class="token string">)\'</span></span>\n\n\nbefore <span class="token operator">=</span> BetterPoint2D<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Before:    \'</span><span class="token punctuation">,</span>  before<span class="token punctuation">)</span>\ndata <span class="token operator">=</span> before<span class="token punctuation">.</span>serialize<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Serialized:\'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>\nafter <span class="token operator">=</span> BetterPoint2D<span class="token punctuation">.</span>deserialize<span class="token punctuation">(</span>data<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'After:     \'</span><span class="token punctuation">,</span> after<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nBefore<span class="token punctuation">:</span>     Point2D<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>\nSerialized<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"args"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">}</span>\nAfter<span class="token punctuation">:</span>      Point2D<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这个方案的缺点是，我们必须提前知道 JSON 字符串所表示的类型（例如 Point2D 或 BetterPoint2D），然后才能把它还原成对象。如果只用一个函数就能把各种 JSON 字符串分别还原成对应类型的 Python 对象，那就更好了。</p>\n<p>为了实现这项功能，我们把对象所属的类名也添加到序列化之后的 JSON 数据里面。</p>\n<p>然后，我们用一份字典把支持序列化与反序列化的类记录下来，字典的键为类的名称，与还原这种对象时所要用到的构造函数相对应。这样的话，凡是经由 <code class="language-text">register_class</code> 注册的类，其 JSON 数据都可以通过 deserialize 函数还原成相应的对象。</p>\n<p>为确保 deserialize 函数能够正确还原 JSON 数据，我们必须把想要支持反序列化功能的类通过 <code class="language-text">register_class</code> 注册进去。</p>\n<p>这样就可以把任意的 JSON 字符串都还原为相应的对象，而不需要明确指出类名，因为 deserialize 函数会从注册字典里面查询。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="67011559853119150000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import json\n\n\nclass BetterSerializable:\n    def __init__(self, *args):\n        self.args = args\n\n    def serialize(self):\n        return json.dumps({\n            \'class\': self.__class__.__name__,\n            \'args\': self.args,\n        })\n\n    def __repr__(self):\n        name = self.__class__.__name__\n        args_str = \', \'.join(str(x) for x in self.args)\n        return f\'{name}({args_str})\'\n\n\nregistry = {}\n\n\ndef register_class(target_class):\n    registry[target_class.__name__] = target_class\n\n\ndef deserialize(data):\n    params = json.loads(data)\n    name = params[\'class\']\n    target_class = registry[name]\n    return target_class(*params[\'args\'])\n\n\nclass EvenBetterPoint2D(BetterSerializable):\n    def __init__(self, x, y):\n        super().__init__(x, y)\n        self.x = x\n        self.y = y\n\n\nregister_class(EvenBetterPoint2D)\n\n\nbefore = EvenBetterPoint2D(5, 3)\nprint(\'Before:    \', before)\ndata = before.serialize()\nprint(\'Serialized:\', data)\nafter = deserialize(data)\nprint(\'After:     \', after)\n\n>>>\nBefore:     EvenBetterPoint2D(5, 3)\nSerialized: {&quot;class&quot;: &quot;EvenBetterPoint2D&quot;, &quot;args&quot;: [5, 3]}\nAfter:      EvenBetterPoint2D(5, 3)`, `67011559853119150000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> json\n\n\n<span class="token keyword">class</span> <span class="token class-name">BetterSerializable</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>args <span class="token operator">=</span> args\n\n    <span class="token keyword">def</span> <span class="token function">serialize</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token punctuation">{</span>\n            <span class="token string">\'class\'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__name__<span class="token punctuation">,</span>\n            <span class="token string">\'args\'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>args<span class="token punctuation">,</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">__repr__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        name <span class="token operator">=</span> self<span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__name__\n        args_str <span class="token operator">=</span> <span class="token string">\', \'</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> self<span class="token punctuation">.</span>args<span class="token punctuation">)</span>\n        <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token punctuation">}</span></span><span class="token string">(</span><span class="token interpolation"><span class="token punctuation">{</span>args_str<span class="token punctuation">}</span></span><span class="token string">)\'</span></span>\n\n\nregistry <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n\n\n<span class="token keyword">def</span> <span class="token function">register_class</span><span class="token punctuation">(</span>target_class<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    registry<span class="token punctuation">[</span>target_class<span class="token punctuation">.</span>__name__<span class="token punctuation">]</span> <span class="token operator">=</span> target_class\n\n\n<span class="token keyword">def</span> <span class="token function">deserialize</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    params <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>data<span class="token punctuation">)</span>\n    name <span class="token operator">=</span> params<span class="token punctuation">[</span><span class="token string">\'class\'</span><span class="token punctuation">]</span>\n    target_class <span class="token operator">=</span> registry<span class="token punctuation">[</span>name<span class="token punctuation">]</span>\n    <span class="token keyword">return</span> target_class<span class="token punctuation">(</span><span class="token operator">*</span>params<span class="token punctuation">[</span><span class="token string">\'args\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">EvenBetterPoint2D</span><span class="token punctuation">(</span>BetterSerializable<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>x <span class="token operator">=</span> x\n        self<span class="token punctuation">.</span>y <span class="token operator">=</span> y\n\n\nregister_class<span class="token punctuation">(</span>EvenBetterPoint2D<span class="token punctuation">)</span>\n\n\nbefore <span class="token operator">=</span> EvenBetterPoint2D<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Before:    \'</span><span class="token punctuation">,</span> before<span class="token punctuation">)</span>\ndata <span class="token operator">=</span> before<span class="token punctuation">.</span>serialize<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Serialized:\'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>\nafter <span class="token operator">=</span> deserialize<span class="token punctuation">(</span>data<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'After:     \'</span><span class="token punctuation">,</span> after<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nBefore<span class="token punctuation">:</span>     EvenBetterPoint2D<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>\nSerialized<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"class"</span><span class="token punctuation">:</span> <span class="token string">"EvenBetterPoint2D"</span><span class="token punctuation">,</span> <span class="token string">"args"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">}</span>\nAfter<span class="token punctuation">:</span>      EvenBetterPoint2D<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>当然这个方案也有不好的地方，那就是开发者可能会忘记调用 <code class="language-text">register_class</code>。</p>\n<p>如果没有注册就想还原数据，那么程序会在通过 deserialize 函数反序列化这份数据时出错。</p>\n<p>可以看到，尽管 Point3D 已经继承了 BetterSerializable，但这只能让它享有序列化的功能，至于反序列化，则必须得在定义完 class 语句体之后，手工调用 <code class="language-text">register_class</code> 函数进行注册后才能享有。所以，这个方案很容易出错，编程新手用起来尤其困难。类修饰器（class decorator）也会有这种问题（适用场合参见第 51 条）。</p>\n<p>那么，怎样才能让子类只需继承 BetterSerializable，就能同时获得序列化与反序列化功能，而不用专门手动通过 <code class="language-text">register_class</code> 注册呢？这可以利用元类实现，也就是让元类把子类的 class 定义拦截下来，然后自动调用 <code class="language-text">register_class</code> 去注册（参见第 48 条）。下面，我们就写这样一个元类，让它在得知开发者定义了 RegisteredSerializable 的某个子类之后，立刻通过 <code class="language-text">register_class</code> 注册。</p>\n<p>用户只要把 RegisteredSerializable 的子类定义完，就可以确信程序已经通过 <code class="language-text">register_class</code> 将这个子类注册过了，所以它肯定支持反序列化。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="6076663040560027000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import json\n\n\nclass BetterSerializable:\n    def __init__(self, *args):\n        self.args = args\n\n    def serialize(self):\n        return json.dumps({\n            \'class\': self.__class__.__name__,\n            \'args\': self.args,\n        })\n\n    def __repr__(self):\n        name = self.__class__.__name__\n        args_str = \', \'.join(str(x) for x in self.args)\n        return f\'{name}({args_str})\'\n\n\nregistry = {}\n\n\ndef register_class(target_class):\n    registry[target_class.__name__] = target_class\n\n\ndef deserialize(data):\n    params = json.loads(data)\n    name = params[\'class\']\n    target_class = registry[name]\n    return target_class(*params[\'args\'])\n\n\nclass Meta(type):\n    def __new__(meta, name, bases, class_dict):\n        cls = type.__new__(meta, name, bases, class_dict)\n        register_class(cls)\n        return cls\n\n\nclass RegisteredSerializable(BetterSerializable,\n                             metaclass=Meta):\n    pass\n\n\nclass Vector3D(RegisteredSerializable):\n    def __init__(self, x, y, z):\n        super().__init__(x, y, z)\n        self.x, self.y, self.z = x, y, z\n\n\nbefore = Vector3D(10, -7, 3)\nprint(\'Before:    \', before)\ndata = before.serialize()\nprint(\'Serialized:\', data)\nprint(\'After:     \', deserialize(data))\n\n>>>\nBefore:     Vector3D(10, -7, 3)\nSerialized: {&quot;class&quot;: &quot;Vector3D&quot;, &quot;args&quot;: [10, -7, 3]}\nAfter:      Vector3D(10, -7, 3)`, `6076663040560027000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> json\n\n\n<span class="token keyword">class</span> <span class="token class-name">BetterSerializable</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>args <span class="token operator">=</span> args\n\n    <span class="token keyword">def</span> <span class="token function">serialize</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token punctuation">{</span>\n            <span class="token string">\'class\'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__name__<span class="token punctuation">,</span>\n            <span class="token string">\'args\'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>args<span class="token punctuation">,</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">__repr__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        name <span class="token operator">=</span> self<span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__name__\n        args_str <span class="token operator">=</span> <span class="token string">\', \'</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> self<span class="token punctuation">.</span>args<span class="token punctuation">)</span>\n        <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token punctuation">}</span></span><span class="token string">(</span><span class="token interpolation"><span class="token punctuation">{</span>args_str<span class="token punctuation">}</span></span><span class="token string">)\'</span></span>\n\n\nregistry <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n\n\n<span class="token keyword">def</span> <span class="token function">register_class</span><span class="token punctuation">(</span>target_class<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    registry<span class="token punctuation">[</span>target_class<span class="token punctuation">.</span>__name__<span class="token punctuation">]</span> <span class="token operator">=</span> target_class\n\n\n<span class="token keyword">def</span> <span class="token function">deserialize</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    params <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>data<span class="token punctuation">)</span>\n    name <span class="token operator">=</span> params<span class="token punctuation">[</span><span class="token string">\'class\'</span><span class="token punctuation">]</span>\n    target_class <span class="token operator">=</span> registry<span class="token punctuation">[</span>name<span class="token punctuation">]</span>\n    <span class="token keyword">return</span> target_class<span class="token punctuation">(</span><span class="token operator">*</span>params<span class="token punctuation">[</span><span class="token string">\'args\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__new__</span><span class="token punctuation">(</span>meta<span class="token punctuation">,</span> name<span class="token punctuation">,</span> bases<span class="token punctuation">,</span> class_dict<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        cls <span class="token operator">=</span> <span class="token builtin">type</span><span class="token punctuation">.</span>__new__<span class="token punctuation">(</span>meta<span class="token punctuation">,</span> name<span class="token punctuation">,</span> bases<span class="token punctuation">,</span> class_dict<span class="token punctuation">)</span>\n        register_class<span class="token punctuation">(</span>cls<span class="token punctuation">)</span>\n        <span class="token keyword">return</span> cls\n\n\n<span class="token keyword">class</span> <span class="token class-name">RegisteredSerializable</span><span class="token punctuation">(</span>BetterSerializable<span class="token punctuation">,</span>\n                             metaclass<span class="token operator">=</span>Meta<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">Vector3D</span><span class="token punctuation">(</span>RegisteredSerializable<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z<span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>x<span class="token punctuation">,</span> self<span class="token punctuation">.</span>y<span class="token punctuation">,</span> self<span class="token punctuation">.</span>z <span class="token operator">=</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z\n\n\nbefore <span class="token operator">=</span> Vector3D<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Before:    \'</span><span class="token punctuation">,</span> before<span class="token punctuation">)</span>\ndata <span class="token operator">=</span> before<span class="token punctuation">.</span>serialize<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Serialized:\'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'After:     \'</span><span class="token punctuation">,</span> deserialize<span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nBefore<span class="token punctuation">:</span>     Vector3D<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>\nSerialized<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"class"</span><span class="token punctuation">:</span> <span class="token string">"Vector3D"</span><span class="token punctuation">,</span> <span class="token string">"args"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">}</span>\nAfter<span class="token punctuation">:</span>      Vector3D<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>还有一种办法比上面的实现方式更简单，那就是通过名为 <code class="language-text">__init_subclass__</code> 的特殊类方法来实现。这是 Python 3.6 引入的新写法，我们只需要编很少的代码，就可以把自己的逻辑运用到子类上面。有些编程新手可能不太熟悉元类那种比较复杂的写法，但如果改用下面这种方案，他们应该很容易就能看懂。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="37983298247898415000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import json\n\n\nclass BetterSerializable:\n    def __init__(self, *args):\n        self.args = args\n\n    def serialize(self):\n        return json.dumps({\n            \'class\': self.__class__.__name__,\n            \'args\': self.args,\n        })\n\n    def __repr__(self):\n        name = self.__class__.__name__\n        args_str = \', \'.join(str(x) for x in self.args)\n        return f\'{name}({args_str})\'\n\n\nregistry = {}\n\n\ndef register_class(target_class):\n    registry[target_class.__name__] = target_class\n\n\ndef deserialize(data):\n    params = json.loads(data)\n    name = params[\'class\']\n    target_class = registry[name]\n    return target_class(*params[\'args\'])\n\n\nclass BetterRegisteredSerializable(BetterSerializable):\n    def __init_subclass__(cls):\n        super().__init_subclass__()\n        register_class(cls)\n\n\nclass Vector1D(BetterRegisteredSerializable):\n    def __init__(self, magnitude):\n        super().__init__(magnitude)\n        self.magnitude = magnitude\n\n\nbefore = Vector1D(6)\nprint(\'Before:    \', before)\ndata = before.serialize()\nprint(\'Serialized:\', data)\nprint(\'After:     \', deserialize(data))\n\n>>>\nBefore:     Vector1D(6)\nSerialized: {&quot;class&quot;: &quot;Vector1D&quot;, &quot;args&quot;: [6]}\nAfter:      Vector1D(6)`, `37983298247898415000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> json\n\n\n<span class="token keyword">class</span> <span class="token class-name">BetterSerializable</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>args <span class="token operator">=</span> args\n\n    <span class="token keyword">def</span> <span class="token function">serialize</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token punctuation">{</span>\n            <span class="token string">\'class\'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__name__<span class="token punctuation">,</span>\n            <span class="token string">\'args\'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>args<span class="token punctuation">,</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">__repr__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        name <span class="token operator">=</span> self<span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__name__\n        args_str <span class="token operator">=</span> <span class="token string">\', \'</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> self<span class="token punctuation">.</span>args<span class="token punctuation">)</span>\n        <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token punctuation">}</span></span><span class="token string">(</span><span class="token interpolation"><span class="token punctuation">{</span>args_str<span class="token punctuation">}</span></span><span class="token string">)\'</span></span>\n\n\nregistry <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n\n\n<span class="token keyword">def</span> <span class="token function">register_class</span><span class="token punctuation">(</span>target_class<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    registry<span class="token punctuation">[</span>target_class<span class="token punctuation">.</span>__name__<span class="token punctuation">]</span> <span class="token operator">=</span> target_class\n\n\n<span class="token keyword">def</span> <span class="token function">deserialize</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    params <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>data<span class="token punctuation">)</span>\n    name <span class="token operator">=</span> params<span class="token punctuation">[</span><span class="token string">\'class\'</span><span class="token punctuation">]</span>\n    target_class <span class="token operator">=</span> registry<span class="token punctuation">[</span>name<span class="token punctuation">]</span>\n    <span class="token keyword">return</span> target_class<span class="token punctuation">(</span><span class="token operator">*</span>params<span class="token punctuation">[</span><span class="token string">\'args\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">BetterRegisteredSerializable</span><span class="token punctuation">(</span>BetterSerializable<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init_subclass__</span><span class="token punctuation">(</span>cls<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init_subclass__<span class="token punctuation">(</span><span class="token punctuation">)</span>\n        register_class<span class="token punctuation">(</span>cls<span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">Vector1D</span><span class="token punctuation">(</span>BetterRegisteredSerializable<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> magnitude<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>magnitude<span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>magnitude <span class="token operator">=</span> magnitude\n\n\nbefore <span class="token operator">=</span> Vector1D<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Before:    \'</span><span class="token punctuation">,</span> before<span class="token punctuation">)</span>\ndata <span class="token operator">=</span> before<span class="token punctuation">.</span>serialize<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Serialized:\'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'After:     \'</span><span class="token punctuation">,</span> deserialize<span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nBefore<span class="token punctuation">:</span>     Vector1D<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>\nSerialized<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"class"</span><span class="token punctuation">:</span> <span class="token string">"Vector1D"</span><span class="token punctuation">,</span> <span class="token string">"args"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">}</span>\nAfter<span class="token punctuation">:</span>      Vector1D<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在类体系正确无误的前提下，通过 <code class="language-text">__init_subclass__</code>（或元类）自动注册子类可以避免程序由于用户忘记注册而引发问题。这不仅适用于上述序列化与反序列化功能的实现，而且还可以用在数据库的对象关系映射（object-relational mapping，ORM）、可扩展的插件系统以及回调挂钩上面。</p>\n<h3 id="总结-45"><a href="#%E6%80%BB%E7%BB%93-45" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>类注册（Class registration）是个相当有用的模式，可以用来构建模块式的 Python 程序。</li>\n<li>我们可以通过基类的元类把用户从这个基类派生出来的子类自动注册给系统。</li>\n<li>利用元类实现类注册可以防止由于用户忘记注册而导致程序出现问题。</li>\n<li>优先考虑通过 <code class="language-text">__init_subclass__</code> 实现自动注册，而不要用标准的元类机制来实现，因为 <code class="language-text">__init_subclass__</code> 更清晰，更便于初学者理解。</li>\n</ol>\n<h2 id="第-50-条：用-__set_name__-给类属性加注解"><a href="#%E7%AC%AC-50-%E6%9D%A1%EF%BC%9A%E7%94%A8-__set_name__-%E7%BB%99%E7%B1%BB%E5%B1%9E%E6%80%A7%E5%8A%A0%E6%B3%A8%E8%A7%A3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 50 条：用 <code class="language-text">__set_name__</code> 给类属性加注解</h2>\n<p>元类还有一个更有用的功能，那就是可以在某个类真正投入使用之前，率先修改或注解这个类所定义的属性。这通常需要与描述符（descriptor）搭配使用（参见第 46 条），这样可以让我们更详细地了解这些属性在定义它们的那个类里是如何使用的。</p>\n<p>例如，我们要定义一个新的类，来表示客户数据库中的每一行数据。这个类需要定义一些属性，与数据表中的各列相对应，每个属性都分别表示这行数据在这一列的取值。下面用描述符类来实现这些属性，把它们和数据表中同名的列联系起来。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="8654132173487294000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Field:\n    def __init__(self, name):\n        self.name = name\n        self.internal_name = \'_\' + self.name\n\n    def __get__(self, instance, instance_type):\n        if instance is None:\n            return self\n        return getattr(instance, self.internal_name, \'\')\n\n    def __set__(self, instance, value):\n        setattr(instance, self.internal_name, value)`, `8654132173487294000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Field</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>name <span class="token operator">=</span> name\n        self<span class="token punctuation">.</span>internal_name <span class="token operator">=</span> <span class="token string">\'_\'</span> <span class="token operator">+</span> self<span class="token punctuation">.</span>name\n\n    <span class="token keyword">def</span> <span class="token function">__get__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> instance_type<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> instance <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> self\n        <span class="token keyword">return</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> self<span class="token punctuation">.</span>internal_name<span class="token punctuation">,</span> <span class="token string">\'\'</span><span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">__set__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">setattr</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> self<span class="token punctuation">.</span>internal_name<span class="token punctuation">,</span> value<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Field 描述符的 name 属性指的就是数据表中那一列的列名，所以，我们可以通过内置的 setattr 函数把每行数据在这个属性上面的取值保存到那行数据自己的状态字典里面去，只不过属性名应该稍加调整，我们给它前面加个下划线表示它是受到保护的属性。另外，我们通过 getattr 函数实现属性加载功能。这种写法，看上去似乎要比把每个实例在这项属性上面的取值都保存到 weakref 字典里面更简单（那种字典是 weakref 模块所提供的特殊字典，用以防止内存泄漏）。</p>\n<p>下面定义 Customer 类，每个 Customer 都表示数据表中的一行数据，其中的四个属性分别对应于这行数据在那四列上面的取值。</p>\n<p>这个类用起来很简单。可以看到，早前定义的 Field 描述符能够正确地修改 cust 实例中的 <code class="language-text">__dict__</code> 字典。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="78717765729277050000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Field:\n    def __init__(self, name):\n        self.name = name\n        self.internal_name = \'_\' + self.name\n\n    def __get__(self, instance, instance_type):\n        if instance is None:\n            return self\n        return getattr(instance, self.internal_name, \'\')\n\n    def __set__(self, instance, value):\n        setattr(instance, self.internal_name, value)\n\n\nclass Customer:\n    # Class attributes\n    first_name = Field(\'first_name\')\n    last_name = Field(\'last_name\')\n    prefix = Field(\'prefix\')\n    suffix = Field(\'suffix\')\n\n\ncust = Customer()\nprint(f\'Before: {cust.first_name!r} {cust.__dict__}\')\ncust.first_name = \'Euclid\'\nprint(f\'After:  {cust.first_name!r} {cust.__dict__}\')\n\n>>>\nBefore: \'\' {}\nAfter:  \'Euclid\' {\'_first_name\': \'Euclid\'}`, `78717765729277050000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Field</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>name <span class="token operator">=</span> name\n        self<span class="token punctuation">.</span>internal_name <span class="token operator">=</span> <span class="token string">\'_\'</span> <span class="token operator">+</span> self<span class="token punctuation">.</span>name\n\n    <span class="token keyword">def</span> <span class="token function">__get__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> instance_type<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> instance <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> self\n        <span class="token keyword">return</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> self<span class="token punctuation">.</span>internal_name<span class="token punctuation">,</span> <span class="token string">\'\'</span><span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">__set__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">setattr</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> self<span class="token punctuation">.</span>internal_name<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">Customer</span><span class="token punctuation">:</span>\n    <span class="token comment"># Class attributes</span>\n    first_name <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token string">\'first_name\'</span><span class="token punctuation">)</span>\n    last_name <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token string">\'last_name\'</span><span class="token punctuation">)</span>\n    prefix <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token string">\'prefix\'</span><span class="token punctuation">)</span>\n    suffix <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token string">\'suffix\'</span><span class="token punctuation">)</span>\n\n\ncust <span class="token operator">=</span> Customer<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Before: </span><span class="token interpolation"><span class="token punctuation">{</span>cust<span class="token punctuation">.</span>first_name<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{</span>cust<span class="token punctuation">.</span>__dict__<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\ncust<span class="token punctuation">.</span>first_name <span class="token operator">=</span> <span class="token string">\'Euclid\'</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'After:  </span><span class="token interpolation"><span class="token punctuation">{</span>cust<span class="token punctuation">.</span>first_name<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{</span>cust<span class="token punctuation">.</span>__dict__<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nBefore<span class="token punctuation">:</span> <span class="token string">\'\'</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\nAfter<span class="token punctuation">:</span>  <span class="token string">\'Euclid\'</span> <span class="token punctuation">{</span><span class="token string">\'_first_name\'</span><span class="token punctuation">:</span> <span class="token string">\'Euclid\'</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样写虽然没错，但是类的定义似乎有点重复。在给 Customer 类定义字段时，既然等号左边已经写出了字段的名称（例如 <code class="language-text">first_name</code>），那为什么等号右边的 Field 构造函数里，还要再写一次呢？</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="1264610237648544500"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Customer:\n    # Left side is redundant with right side\n    first_name = Field(\'first_name\')\n    ...`, `1264610237648544500`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Customer</span><span class="token punctuation">:</span>\n    <span class="token comment"># Left side is redundant with right side</span>\n    first_name <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token string">\'first_name\'</span><span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这是因为，Customer 类在定义字段时，要按照从右到左的顺序解读，而不是像阅读代码时那样，从左到右阅读。所以，程序必须首先处理等号右边的部分，也就是 <code class="language-text">Field(&#39;first_name&#39;)</code>，然后才能把这个 Field 构造函数所返回的值赋给左边的 <code class="language-text">first_name</code>。等号右边的 Field 实例没办法提前知道，它将被赋给类的哪一个属性。</p>\n<p>这样的重复代码，可以利用元类来消除。元类可以当作 class 语句的挂钩，只要 class 语句体定义完毕，元类就会看到它的写法并尽快做出应对（具体原理参见第 48 条）。在本例中，我们可以让元类自动给每个 Field 描述符的 name 与 <code class="language-text">internal_name</code> 赋值，而不用再像原来那样，需要开发者把字段名称重复书写一遍并手动传给 Field 的构造函数。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="81353347663966220000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Meta(type):\n    def __new__(meta, name, bases, class_dict):\n        for key, value in class_dict.items():\n            if isinstance(value, Field):\n                value.name = key\n                value.internal_name = \'_\' + key\n        cls = type.__new__(meta, name, bases, class_dict)\n        return cls`, `81353347663966220000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__new__</span><span class="token punctuation">(</span>meta<span class="token punctuation">,</span> name<span class="token punctuation">,</span> bases<span class="token punctuation">,</span> class_dict<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">for</span> key<span class="token punctuation">,</span> value <span class="token keyword">in</span> class_dict<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> Field<span class="token punctuation">)</span><span class="token punctuation">:</span>\n                value<span class="token punctuation">.</span>name <span class="token operator">=</span> key\n                value<span class="token punctuation">.</span>internal_name <span class="token operator">=</span> <span class="token string">\'_\'</span> <span class="token operator">+</span> key\n        cls <span class="token operator">=</span> <span class="token builtin">type</span><span class="token punctuation">.</span>__new__<span class="token punctuation">(</span>meta<span class="token punctuation">,</span> name<span class="token punctuation">,</span> bases<span class="token punctuation">,</span> class_dict<span class="token punctuation">)</span>\n        <span class="token keyword">return</span> cls</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>下面定义一个基类，让该基类把刚才定义好的 Meta 当成元类。凡是表示数据库某行的类都继承自该基类，以确保它们可以利用元类所提供的功能。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="84830176499692800000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class DatabaseRow(metaclass=Meta):\n    pass`, `84830176499692800000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">DatabaseRow</span><span class="token punctuation">(</span>metaclass<span class="token operator">=</span>Meta<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>为了跟元类配合，Field 描述符需要稍加调整。它的大部分代码都可以沿用，只是现在已经不用再要求调用者把名称传给构造函数了，因为这次元类的 <code class="language-text">__new__</code> 方法会自动设置名称。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="20479451487295484000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Field:\n    def __init__(self):\n        # These will be assigned by the metaclass.\n        self.name = None\n        self.internal_name = None\n\n    def __get__(self, instance, instance_type):\n        if instance is None:\n            return self\n\n        return getattr(instance, self.internal_name, \'\')\n\n    def __set__(self, instance, value):\n        setattr(instance, self.internal_name, value)`, `20479451487295484000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Field</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token comment"># These will be assigned by the metaclass.</span>\n        self<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token boolean">None</span>\n        self<span class="token punctuation">.</span>internal_name <span class="token operator">=</span> <span class="token boolean">None</span>\n\n    <span class="token keyword">def</span> <span class="token function">__get__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> instance_type<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> instance <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> self\n\n        <span class="token keyword">return</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> self<span class="token punctuation">.</span>internal_name<span class="token punctuation">,</span> <span class="token string">\'\'</span><span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">__set__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">setattr</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> self<span class="token punctuation">.</span>internal_name<span class="token punctuation">,</span> value<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>有了元类、DatabaseRow 基类以及修改过的 Field 描述符，我们在给客户类定义字段时，就不用手工传入字段名了，代码也不像之前那样冗余了。</p>\n<p>这个新类的效果与早前那个类一样。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="98872520063611160000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Field:\n    def __init__(self):\n        # These will be assigned by the metaclass.\n        self.name = None\n        self.internal_name = None\n\n    def __get__(self, instance, instance_type):\n        if instance is None:\n            return self\n        return getattr(instance, self.internal_name, \'\')\n\n    def __set__(self, instance, value):\n        setattr(instance, self.internal_name, value)\n\n\nclass Meta(type):\n    def __new__(meta, name, bases, class_dict):\n        for key, value in class_dict.items():\n            if isinstance(value, Field):\n                value.name = key\n                value.internal_name = \'_\' + key\n        cls = type.__new__(meta, name, bases, class_dict)\n        return cls\n\n\nclass DatabaseRow(metaclass=Meta):\n    pass\n\n\nclass BetterCustomer(DatabaseRow):\n    # Class attributes\n    first_name = Field()\n    last_name = Field()\n    prefix = Field()\n    suffix = Field()\n\n\ncust = BetterCustomer()\nprint(f\'Before: {cust.first_name!r} {cust.__dict__}\')\ncust.first_name = \'Euler\'\nprint(f\'After : {cust.first_name!r} {cust.__dict__}\')\n\n>>>\nBefore: \'\' {}\nAfter : \'Euler\' {\'_first_name\': \'Euler\'}`, `98872520063611160000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Field</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token comment"># These will be assigned by the metaclass.</span>\n        self<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token boolean">None</span>\n        self<span class="token punctuation">.</span>internal_name <span class="token operator">=</span> <span class="token boolean">None</span>\n\n    <span class="token keyword">def</span> <span class="token function">__get__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> instance_type<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> instance <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> self\n        <span class="token keyword">return</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> self<span class="token punctuation">.</span>internal_name<span class="token punctuation">,</span> <span class="token string">\'\'</span><span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">__set__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">setattr</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> self<span class="token punctuation">.</span>internal_name<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__new__</span><span class="token punctuation">(</span>meta<span class="token punctuation">,</span> name<span class="token punctuation">,</span> bases<span class="token punctuation">,</span> class_dict<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">for</span> key<span class="token punctuation">,</span> value <span class="token keyword">in</span> class_dict<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> Field<span class="token punctuation">)</span><span class="token punctuation">:</span>\n                value<span class="token punctuation">.</span>name <span class="token operator">=</span> key\n                value<span class="token punctuation">.</span>internal_name <span class="token operator">=</span> <span class="token string">\'_\'</span> <span class="token operator">+</span> key\n        cls <span class="token operator">=</span> <span class="token builtin">type</span><span class="token punctuation">.</span>__new__<span class="token punctuation">(</span>meta<span class="token punctuation">,</span> name<span class="token punctuation">,</span> bases<span class="token punctuation">,</span> class_dict<span class="token punctuation">)</span>\n        <span class="token keyword">return</span> cls\n\n\n<span class="token keyword">class</span> <span class="token class-name">DatabaseRow</span><span class="token punctuation">(</span>metaclass<span class="token operator">=</span>Meta<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">BetterCustomer</span><span class="token punctuation">(</span>DatabaseRow<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token comment"># Class attributes</span>\n    first_name <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    last_name <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    prefix <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    suffix <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n\ncust <span class="token operator">=</span> BetterCustomer<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Before: </span><span class="token interpolation"><span class="token punctuation">{</span>cust<span class="token punctuation">.</span>first_name<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{</span>cust<span class="token punctuation">.</span>__dict__<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\ncust<span class="token punctuation">.</span>first_name <span class="token operator">=</span> <span class="token string">\'Euler\'</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'After : </span><span class="token interpolation"><span class="token punctuation">{</span>cust<span class="token punctuation">.</span>first_name<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{</span>cust<span class="token punctuation">.</span>__dict__<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nBefore<span class="token punctuation">:</span> <span class="token string">\'\'</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\nAfter <span class="token punctuation">:</span> <span class="token string">\'Euler\'</span> <span class="token punctuation">{</span><span class="token string">\'_first_name\'</span><span class="token punctuation">:</span> <span class="token string">\'Euler\'</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这个办法的缺点是，要想在类中声明 Field 字段，这个类必须从 DatabaseRow 继承。假如忘了继承，或者所面对的类体系在结构上不方便这样继承，那么代码就无法正常运行。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="30223756853305983000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class BrokenCustomer:\n    first_name = Field()\n    last_name = Field()\n    prefix = Field()\n    suffix = Field()\n\n\ncust = BrokenCustomer()\ncust.first_name = \'Mersenne\'\n\n>>>\nTraceback ...\nTypeError: attribute name must be string, not \'NoneType\'`, `30223756853305983000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">BrokenCustomer</span><span class="token punctuation">:</span>\n    first_name <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    last_name <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    prefix <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    suffix <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n\ncust <span class="token operator">=</span> BrokenCustomer<span class="token punctuation">(</span><span class="token punctuation">)</span>\ncust<span class="token punctuation">.</span>first_name <span class="token operator">=</span> <span class="token string">\'Mersenne\'</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nTypeError<span class="token punctuation">:</span> attribute name must be string<span class="token punctuation">,</span> <span class="token keyword">not</span> <span class="token string">\'NoneType\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这个问题可以通过给描述符定义 <code class="language-text">__set_name__</code> 特殊方法来解决。这是 Python 3.6 引入的新功能：如果某个类用这种描述符的实例来定义字段，那么系统就会在描述符上面触发这个特殊方法。系统会把采用这个描述符实例作字段的那个类以及字段的名称，当成参数传给 <code class="language-text">__set_name__</code>。下面我们将 <code class="language-text">Meta.__new__</code> 之中的逻辑移动到 Field 描述符的 <code class="language-text">__set_name__</code> 里面，这样一来，就不用定义元类了。</p>\n<p>现在，我们可以直接在类里通过 Field 描述符来定义字段，而不用再让这个类继承某个基类，还能把元类给省掉。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="38693249675787715000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Field:\n    def __init__(self):\n        self.name = None\n        self.internal_name = None\n\n    def __set_name__(self, owner, name):\n        # Called on class creation for each descriptor\n        self.name = name\n        self.internal_name = \'_\' + name\n\n    def __get__(self, instance, instance_type):\n        if instance is None:\n            return self\n        return getattr(instance, self.internal_name, \'\')\n\n    def __set__(self, instance, value):\n        setattr(instance, self.internal_name, value)\n\n\nclass FixedCustomer:\n    first_name = Field()\n    last_name = Field()\n    prefix = Field()\n    suffix = Field()\n\n\ncust = FixedCustomer()\nprint(f\'Before: {cust.first_name!r} {cust.__dict__}\')\ncust.first_name = \'Mersenne\'\nprint(f\'After : {cust.first_name!r} {cust.__dict__}\')\n\n>>>\nBefore: \'\' {}\nAfter : \'Mersenne\' {\'_first_name\': \'Mersenne\'}`, `38693249675787715000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Field</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token boolean">None</span>\n        self<span class="token punctuation">.</span>internal_name <span class="token operator">=</span> <span class="token boolean">None</span>\n\n    <span class="token keyword">def</span> <span class="token function">__set_name__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> owner<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token comment"># Called on class creation for each descriptor</span>\n        self<span class="token punctuation">.</span>name <span class="token operator">=</span> name\n        self<span class="token punctuation">.</span>internal_name <span class="token operator">=</span> <span class="token string">\'_\'</span> <span class="token operator">+</span> name\n\n    <span class="token keyword">def</span> <span class="token function">__get__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> instance_type<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> instance <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> self\n        <span class="token keyword">return</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> self<span class="token punctuation">.</span>internal_name<span class="token punctuation">,</span> <span class="token string">\'\'</span><span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">__set__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">setattr</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> self<span class="token punctuation">.</span>internal_name<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">FixedCustomer</span><span class="token punctuation">:</span>\n    first_name <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    last_name <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    prefix <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    suffix <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n\ncust <span class="token operator">=</span> FixedCustomer<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Before: </span><span class="token interpolation"><span class="token punctuation">{</span>cust<span class="token punctuation">.</span>first_name<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{</span>cust<span class="token punctuation">.</span>__dict__<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\ncust<span class="token punctuation">.</span>first_name <span class="token operator">=</span> <span class="token string">\'Mersenne\'</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'After : </span><span class="token interpolation"><span class="token punctuation">{</span>cust<span class="token punctuation">.</span>first_name<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{</span>cust<span class="token punctuation">.</span>__dict__<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nBefore<span class="token punctuation">:</span> <span class="token string">\'\'</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\nAfter <span class="token punctuation">:</span> <span class="token string">\'Mersenne\'</span> <span class="token punctuation">{</span><span class="token string">\'_first_name\'</span><span class="token punctuation">:</span> <span class="token string">\'Mersenne\'</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="总结-46"><a href="#%E6%80%BB%E7%BB%93-46" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>我们可以通过元类把利用这个元类所定义的其他类拦截下来，从而在程序开始使用那些类之前，先对其中定义的属性做出修改。</li>\n<li>描述符与元类搭配起来，可以形成一套强大的机制，让我们既能采用声明式的写法来定义行为，又能在程序运行时检视这个行为的具体执行情况。</li>\n<li>你可以给描述符定义 <code class="language-text">__set_name__</code> 方法，让系统把使用这个描述符做属性的那个类以及它在类里的属性名通过方法的参数告诉你。</li>\n<li>用描述符直接操纵每个实例的属性字典，要比把所有实例的属性都放到一份字典里更好，因为后者要求我们必须使用 weakref 内置模块之中的特殊字典来记录每个实例的属性值以防止内存泄漏。</li>\n</ol>\n<h2 id="第-51-条：优先考虑通过类修饰器来提供可组合的扩充功能，不要使用元类"><a href="#%E7%AC%AC-51-%E6%9D%A1%EF%BC%9A%E4%BC%98%E5%85%88%E8%80%83%E8%99%91%E9%80%9A%E8%BF%87%E7%B1%BB%E4%BF%AE%E9%A5%B0%E5%99%A8%E6%9D%A5%E6%8F%90%E4%BE%9B%E5%8F%AF%E7%BB%84%E5%90%88%E7%9A%84%E6%89%A9%E5%85%85%E5%8A%9F%E8%83%BD%EF%BC%8C%E4%B8%8D%E8%A6%81%E4%BD%BF%E7%94%A8%E5%85%83%E7%B1%BB" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 51 条：优先考虑通过类修饰器来提供可组合的扩充功能，不要使用元类</h2>\n<p>尽管元类（参见第 48 条与第 49 条）允许我们用各种方式来定制其他类的创建逻辑，但有些情况它未必能够处理得很好。</p>\n<p>例如，要写一个辅助函数来修饰类中的每个方法，把这些方法在执行时所用的参数、所返回的值以及所抛出的异常都打印出来，以便调试。这样的辅助函数可以定义成修饰器（参见第 26 条）。</p>\n<p>如果我们从标准的 dict 里面派生了下面这个子类（参见第 43 条），那就可以把刚才的 <code class="language-text">trace_func</code> 修饰器运用到这个子类所提供的那几个特殊方法上面。</p>\n<p>下面，通过 TraceDict 类的实例来验证刚才写的那几个特殊方法确实受到了修饰。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="19691212795512046000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from functools import wraps\n\n\ndef trace_func(func):\n    if hasattr(func, \'tracing\'):  # Only decorate once\n        return func\n\n    @wraps(func)\n    def wrapper(*args, **kwargs):\n        result = None\n        try:\n            result = func(*args, **kwargs)\n            return result\n        except Exception as e:\n            result = e\n            raise\n        finally:\n            print(f\'{func.__name__}({args!r}, {kwargs!r}) -> \'\n                  f\'{result!r}\')\n\n    wrapper.tracing = True\n    return wrapper\n\n\nclass TraceDict(dict):\n    @trace_func\n    def __init__(self, *args, **kwargs):\n        super().__init__(*args, **kwargs)\n\n    @trace_func\n    def __setitem__(self, *args, **kwargs):\n        return super().__setitem__(*args, **kwargs)\n\n    @trace_func\n    def __getitem__(self, *args, **kwargs):\n        return super().__getitem__(*args, **kwargs)\n\n\ntrace_dict = TraceDict([(\'hi\', 1)])\ntrace_dict[\'there\'] = 2\ntrace_dict[\'hi\']\ntry:\n    trace_dict[\'does not exist\']\nexcept KeyError:\n    pass  # Expected\n\n>>>\n__init__(({\'hi\': 1}, [(\'hi\', 1)]), {}) -> None\n__setitem__(({\'hi\': 1, \'there\': 2}, \'there\', 2), {}) -> None\n__getitem__(({\'hi\': 1, \'there\': 2}, \'hi\'), {}) -> 1\n__getitem__(({\'hi\': 1, \'there\': 2}, \'does not exist\'), {}) -> KeyError(\'does not exist\')`, `19691212795512046000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> functools <span class="token keyword">import</span> wraps\n\n\n<span class="token keyword">def</span> <span class="token function">trace_func</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">if</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>func<span class="token punctuation">,</span> <span class="token string">\'tracing\'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># Only decorate once</span>\n        <span class="token keyword">return</span> func\n\n    @wraps<span class="token punctuation">(</span>func<span class="token punctuation">)</span>\n    <span class="token keyword">def</span> <span class="token function">wrapper</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        result <span class="token operator">=</span> <span class="token boolean">None</span>\n        <span class="token keyword">try</span><span class="token punctuation">:</span>\n            result <span class="token operator">=</span> func<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>\n            <span class="token keyword">return</span> result\n        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>\n            result <span class="token operator">=</span> e\n            <span class="token keyword">raise</span>\n        <span class="token keyword">finally</span><span class="token punctuation">:</span>\n            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>func<span class="token punctuation">.</span>__name__<span class="token punctuation">}</span></span><span class="token string">(</span><span class="token interpolation"><span class="token punctuation">{</span>args<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">, </span><span class="token interpolation"><span class="token punctuation">{</span>kwargs<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">) -> \'</span></span>\n                  <span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>result<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n    wrapper<span class="token punctuation">.</span>tracing <span class="token operator">=</span> <span class="token boolean">True</span>\n    <span class="token keyword">return</span> wrapper\n\n\n<span class="token keyword">class</span> <span class="token class-name">TraceDict</span><span class="token punctuation">(</span><span class="token builtin">dict</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    @trace_func\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>\n\n    @trace_func\n    <span class="token keyword">def</span> <span class="token function">__setitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__setitem__<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>\n\n    @trace_func\n    <span class="token keyword">def</span> <span class="token function">__getitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__getitem__<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>\n\n\ntrace_dict <span class="token operator">=</span> TraceDict<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">\'hi\'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\ntrace_dict<span class="token punctuation">[</span><span class="token string">\'there\'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">2</span>\ntrace_dict<span class="token punctuation">[</span><span class="token string">\'hi\'</span><span class="token punctuation">]</span>\n<span class="token keyword">try</span><span class="token punctuation">:</span>\n    trace_dict<span class="token punctuation">[</span><span class="token string">\'does not exist\'</span><span class="token punctuation">]</span>\n<span class="token keyword">except</span> KeyError<span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>  <span class="token comment"># Expected</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n__init__<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">\'hi\'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">\'hi\'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token boolean">None</span>\n__setitem__<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">\'hi\'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">\'there\'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">\'there\'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token boolean">None</span>\n__getitem__<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">\'hi\'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">\'there\'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">\'hi\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token number">1</span>\n__getitem__<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">\'hi\'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">\'there\'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">\'does not exist\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> KeyError<span class="token punctuation">(</span><span class="token string">\'does not exist\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样写有个缺点，就是必须在子类之中把需要受 <code class="language-text">@trace_func</code> 修饰的方法全都重写一遍，即便子类只想沿用超类的实现方式，也还是得这样做才行。这导致子类里面出现大量的样板代码，让程序变得难以阅读，而且比较容易出错。另外，如果 dict 超类以后添加了新方法，那必须在 TraceDict 子类里面明确重写这个方法，否则它就不会为 <code class="language-text">@trace_func</code> 所修饰。</p>\n<p>要想解决这个问题，其中一个办法是通过元类自动修饰那个类的所有方法。例如，下面的就是这样一个元类，它可以拦截利用本类所写的新类型，并把那个类型里面的每个函数或方法都分别封装到 <code class="language-text">trace_func</code> 修饰器之中。</p>\n<p>现在，我们只需要让子类继承 dict，并把刚写的 TraceMeta 当作子类的 metaclass 就行了。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="62388275105381900000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import types\nfrom functools import wraps\n\n\ndef trace_func(func):\n    if hasattr(func, \'tracing\'):  # Only decorate once\n        return func\n\n    @wraps(func)\n    def wrapper(*args, **kwargs):\n        result = None\n        try:\n            result = func(*args, **kwargs)\n            return result\n        except Exception as e:\n            result = e\n            raise\n        finally:\n            print(f\'{func.__name__}({args!r}, {kwargs!r}) -> \'\n                  f\'{result!r}\')\n\n    wrapper.tracing = True\n    return wrapper\n\n\ntrace_types = (\n    types.MethodType,\n    types.FunctionType,\n    types.BuiltinFunctionType,\n    types.BuiltinMethodType,\n    types.MethodDescriptorType,\n    types.ClassMethodDescriptorType\n)\n\n\nclass TraceMeta(type):\n    def __new__(meta, name, bases, class_dict):\n        klass = super().__new__(meta, name, bases, class_dict)\n        for key in dir(klass):\n            value = getattr(klass, key)\n            if isinstance(value, trace_types):\n                wrapped = trace_func(value)\n                setattr(klass, key, wrapped)\n\n        return klass\n\n\nclass TraceDict(dict, metaclass=TraceMeta):\n    pass\n\n\ntrace_dict = TraceDict([(\'hi\', 1)])\ntrace_dict[\'there\'] = 2\ntrace_dict[\'hi\']\ntry:\n    trace_dict[\'does not exist\']\nexcept KeyError:\n    pass  # Expected\n\n>>>\n__new__((<class \'__main__.TraceDict\'>, [(\'hi\', 1)]), {}) -> {}\n__getitem__(({\'hi\': 1, \'there\': 2}, \'hi\'), {}) -> 1\n__getitem__(({\'hi\': 1, \'there\': 2}, \'does not exist\'), {}) -> KeyError(\'does not exist\')`, `62388275105381900000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> types\n<span class="token keyword">from</span> functools <span class="token keyword">import</span> wraps\n\n\n<span class="token keyword">def</span> <span class="token function">trace_func</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">if</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>func<span class="token punctuation">,</span> <span class="token string">\'tracing\'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># Only decorate once</span>\n        <span class="token keyword">return</span> func\n\n    @wraps<span class="token punctuation">(</span>func<span class="token punctuation">)</span>\n    <span class="token keyword">def</span> <span class="token function">wrapper</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        result <span class="token operator">=</span> <span class="token boolean">None</span>\n        <span class="token keyword">try</span><span class="token punctuation">:</span>\n            result <span class="token operator">=</span> func<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>\n            <span class="token keyword">return</span> result\n        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>\n            result <span class="token operator">=</span> e\n            <span class="token keyword">raise</span>\n        <span class="token keyword">finally</span><span class="token punctuation">:</span>\n            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>func<span class="token punctuation">.</span>__name__<span class="token punctuation">}</span></span><span class="token string">(</span><span class="token interpolation"><span class="token punctuation">{</span>args<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">, </span><span class="token interpolation"><span class="token punctuation">{</span>kwargs<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">) -> \'</span></span>\n                  <span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>result<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n    wrapper<span class="token punctuation">.</span>tracing <span class="token operator">=</span> <span class="token boolean">True</span>\n    <span class="token keyword">return</span> wrapper\n\n\ntrace_types <span class="token operator">=</span> <span class="token punctuation">(</span>\n    types<span class="token punctuation">.</span>MethodType<span class="token punctuation">,</span>\n    types<span class="token punctuation">.</span>FunctionType<span class="token punctuation">,</span>\n    types<span class="token punctuation">.</span>BuiltinFunctionType<span class="token punctuation">,</span>\n    types<span class="token punctuation">.</span>BuiltinMethodType<span class="token punctuation">,</span>\n    types<span class="token punctuation">.</span>MethodDescriptorType<span class="token punctuation">,</span>\n    types<span class="token punctuation">.</span>ClassMethodDescriptorType\n<span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">TraceMeta</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__new__</span><span class="token punctuation">(</span>meta<span class="token punctuation">,</span> name<span class="token punctuation">,</span> bases<span class="token punctuation">,</span> class_dict<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        klass <span class="token operator">=</span> <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__new__<span class="token punctuation">(</span>meta<span class="token punctuation">,</span> name<span class="token punctuation">,</span> bases<span class="token punctuation">,</span> class_dict<span class="token punctuation">)</span>\n        <span class="token keyword">for</span> key <span class="token keyword">in</span> <span class="token builtin">dir</span><span class="token punctuation">(</span>klass<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            value <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>klass<span class="token punctuation">,</span> key<span class="token punctuation">)</span>\n            <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> trace_types<span class="token punctuation">)</span><span class="token punctuation">:</span>\n                wrapped <span class="token operator">=</span> trace_func<span class="token punctuation">(</span>value<span class="token punctuation">)</span>\n                <span class="token builtin">setattr</span><span class="token punctuation">(</span>klass<span class="token punctuation">,</span> key<span class="token punctuation">,</span> wrapped<span class="token punctuation">)</span>\n\n        <span class="token keyword">return</span> klass\n\n\n<span class="token keyword">class</span> <span class="token class-name">TraceDict</span><span class="token punctuation">(</span><span class="token builtin">dict</span><span class="token punctuation">,</span> metaclass<span class="token operator">=</span>TraceMeta<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n\ntrace_dict <span class="token operator">=</span> TraceDict<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">\'hi\'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\ntrace_dict<span class="token punctuation">[</span><span class="token string">\'there\'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">2</span>\ntrace_dict<span class="token punctuation">[</span><span class="token string">\'hi\'</span><span class="token punctuation">]</span>\n<span class="token keyword">try</span><span class="token punctuation">:</span>\n    trace_dict<span class="token punctuation">[</span><span class="token string">\'does not exist\'</span><span class="token punctuation">]</span>\n<span class="token keyword">except</span> KeyError<span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>  <span class="token comment"># Expected</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n__new__<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">\'__main__.TraceDict\'</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">\'hi\'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n__getitem__<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">\'hi\'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">\'there\'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">\'hi\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token number">1</span>\n__getitem__<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">\'hi\'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">\'there\'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">\'does not exist\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> KeyError<span class="token punctuation">(</span><span class="token string">\'does not exist\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这种办法确实有效，而且还把前面的实现方案中忘记修饰的 <code class="language-text">__new__</code> 方法也自动修饰了。但如果子类所继承的那个超类本身已经指定了它自己的 metaclass，那会如何呢？</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="25327035402950470000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class OtherMeta(type):\n    pass\n\n\nclass SimpleDict(dict, metaclass=OtherMeta):\n    pass\n\n\nclass TraceDict(SimpleDict, metaclass=TraceMeta):\n    pass\n\n>>>\nTraceback ...\nTypeError: metaclass conflict: the metaclass of a derived class must be a (non-strict) subclass of the metaclasses of all its bases`, `25327035402950470000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">OtherMeta</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">SimpleDict</span><span class="token punctuation">(</span><span class="token builtin">dict</span><span class="token punctuation">,</span> metaclass<span class="token operator">=</span>OtherMeta<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">TraceDict</span><span class="token punctuation">(</span>SimpleDict<span class="token punctuation">,</span> metaclass<span class="token operator">=</span>TraceMeta<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nTypeError<span class="token punctuation">:</span> metaclass conflict<span class="token punctuation">:</span> the metaclass of a derived <span class="token keyword">class</span> <span class="token class-name">must</span> be a <span class="token punctuation">(</span>non<span class="token operator">-</span>strict<span class="token punctuation">)</span> subclass of the metaclasses of <span class="token builtin">all</span> its bases</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这次程序无法运行，因为子类的 metaclass 是 TraceMeta，而超类的 metaclass 是 OtherMeta，但 TraceMeta 并不是从 OtherMeta 里面继承来的。从理论上讲，我们可以让 TraceMeta 继承 OtherMeta，从而解决这个问题。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="80421738071431700000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import types\nfrom functools import wraps\n\n\ndef trace_func(func):\n    if hasattr(func, \'tracing\'):  # Only decorate once\n        return func\n\n    @wraps(func)\n    def wrapper(*args, **kwargs):\n        result = None\n        try:\n            result = func(*args, **kwargs)\n            return result\n        except Exception as e:\n            result = e\n            raise\n        finally:\n            print(f\'{func.__name__}({args!r}, {kwargs!r}) -> \'\n                  f\'{result!r}\')\n\n    wrapper.tracing = True\n    return wrapper\n\n\ntrace_types = (\n    types.MethodType,\n    types.FunctionType,\n    types.BuiltinFunctionType,\n    types.BuiltinMethodType,\n    types.MethodDescriptorType,\n    types.ClassMethodDescriptorType\n)\n\n\nclass OtherMeta(type):\n    pass\n\n\nclass TraceMeta(OtherMeta):\n    def __new__(meta, name, bases, class_dict):\n        klass = super().__new__(meta, name, bases, class_dict)\n        for key in dir(klass):\n            value = getattr(klass, key)\n            if isinstance(value, trace_types):\n                wrapped = trace_func(value)\n                setattr(klass, key, wrapped)\n\n        return klass\n\n\nclass SimpleDict(dict, metaclass=OtherMeta):\n    pass\n\n\nclass TraceDict(SimpleDict, metaclass=TraceMeta):\n    pass\n\n\ntrace_dict = TraceDict([(\'hi\', 1)])\ntrace_dict[\'there\'] = 2\ntrace_dict[\'hi\']\ntry:\n    trace_dict[\'does not exist\']\nexcept KeyError:\n    pass  # Expected\n\n>>>\n__new__((<class \'__main__.TraceDict\'>, [(\'hi\', 1)]), {}) -> {}\n__getitem__(({\'hi\': 1, \'there\': 2}, \'hi\'), {}) -> 1\n__getitem__(({\'hi\': 1, \'there\': 2}, \'does not exist\'), {}) -> KeyError(\'does not exist\')`, `80421738071431700000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> types\n<span class="token keyword">from</span> functools <span class="token keyword">import</span> wraps\n\n\n<span class="token keyword">def</span> <span class="token function">trace_func</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">if</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>func<span class="token punctuation">,</span> <span class="token string">\'tracing\'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># Only decorate once</span>\n        <span class="token keyword">return</span> func\n\n    @wraps<span class="token punctuation">(</span>func<span class="token punctuation">)</span>\n    <span class="token keyword">def</span> <span class="token function">wrapper</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        result <span class="token operator">=</span> <span class="token boolean">None</span>\n        <span class="token keyword">try</span><span class="token punctuation">:</span>\n            result <span class="token operator">=</span> func<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>\n            <span class="token keyword">return</span> result\n        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>\n            result <span class="token operator">=</span> e\n            <span class="token keyword">raise</span>\n        <span class="token keyword">finally</span><span class="token punctuation">:</span>\n            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>func<span class="token punctuation">.</span>__name__<span class="token punctuation">}</span></span><span class="token string">(</span><span class="token interpolation"><span class="token punctuation">{</span>args<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">, </span><span class="token interpolation"><span class="token punctuation">{</span>kwargs<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">) -> \'</span></span>\n                  <span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>result<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n    wrapper<span class="token punctuation">.</span>tracing <span class="token operator">=</span> <span class="token boolean">True</span>\n    <span class="token keyword">return</span> wrapper\n\n\ntrace_types <span class="token operator">=</span> <span class="token punctuation">(</span>\n    types<span class="token punctuation">.</span>MethodType<span class="token punctuation">,</span>\n    types<span class="token punctuation">.</span>FunctionType<span class="token punctuation">,</span>\n    types<span class="token punctuation">.</span>BuiltinFunctionType<span class="token punctuation">,</span>\n    types<span class="token punctuation">.</span>BuiltinMethodType<span class="token punctuation">,</span>\n    types<span class="token punctuation">.</span>MethodDescriptorType<span class="token punctuation">,</span>\n    types<span class="token punctuation">.</span>ClassMethodDescriptorType\n<span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">OtherMeta</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">TraceMeta</span><span class="token punctuation">(</span>OtherMeta<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__new__</span><span class="token punctuation">(</span>meta<span class="token punctuation">,</span> name<span class="token punctuation">,</span> bases<span class="token punctuation">,</span> class_dict<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        klass <span class="token operator">=</span> <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__new__<span class="token punctuation">(</span>meta<span class="token punctuation">,</span> name<span class="token punctuation">,</span> bases<span class="token punctuation">,</span> class_dict<span class="token punctuation">)</span>\n        <span class="token keyword">for</span> key <span class="token keyword">in</span> <span class="token builtin">dir</span><span class="token punctuation">(</span>klass<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            value <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>klass<span class="token punctuation">,</span> key<span class="token punctuation">)</span>\n            <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> trace_types<span class="token punctuation">)</span><span class="token punctuation">:</span>\n                wrapped <span class="token operator">=</span> trace_func<span class="token punctuation">(</span>value<span class="token punctuation">)</span>\n                <span class="token builtin">setattr</span><span class="token punctuation">(</span>klass<span class="token punctuation">,</span> key<span class="token punctuation">,</span> wrapped<span class="token punctuation">)</span>\n\n        <span class="token keyword">return</span> klass\n\n\n<span class="token keyword">class</span> <span class="token class-name">SimpleDict</span><span class="token punctuation">(</span><span class="token builtin">dict</span><span class="token punctuation">,</span> metaclass<span class="token operator">=</span>OtherMeta<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">TraceDict</span><span class="token punctuation">(</span>SimpleDict<span class="token punctuation">,</span> metaclass<span class="token operator">=</span>TraceMeta<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n\ntrace_dict <span class="token operator">=</span> TraceDict<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">\'hi\'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\ntrace_dict<span class="token punctuation">[</span><span class="token string">\'there\'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">2</span>\ntrace_dict<span class="token punctuation">[</span><span class="token string">\'hi\'</span><span class="token punctuation">]</span>\n<span class="token keyword">try</span><span class="token punctuation">:</span>\n    trace_dict<span class="token punctuation">[</span><span class="token string">\'does not exist\'</span><span class="token punctuation">]</span>\n<span class="token keyword">except</span> KeyError<span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>  <span class="token comment"># Expected</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n__new__<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">\'__main__.TraceDict\'</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">\'hi\'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n__getitem__<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">\'hi\'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">\'there\'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">\'hi\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token number">1</span>\n__getitem__<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">\'hi\'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">\'there\'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">\'does not exist\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> KeyError<span class="token punctuation">(</span><span class="token string">\'does not exist\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然而，如果 TraceMeta 不是我们自己写的，而是来自某个程序库，那就没办法手工修改它了。另外，如果想同时使用多个像 TraceMeta 这样的元类所提供的逻辑，那么这套方案无法满足需求，因为在定义类的时候，metaclass 后面只能写一个元类。总之，这个方案对受元类控制的子类提出了过多的要求。</p>\n<p>为此，我们可以换一种方案，也就是改用类修饰器（class decorator）来实现。这种修饰器与函数修饰器相似，都通过 @ 符号来施加，但它并不施加在函数上面，而是施加在类的上面。编写类修饰器时，我们可以修改或重建它所修饰的类，并通过 return 语句返回处理结果。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="98808496519085080000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def my_class_decorator(klass):\n    klass.extra_param = \'hello\'\n    return klass\n\n\n@my_class_decorator\nclass MyClass:\n    pass\n\n\nprint(MyClass)\nprint(MyClass.extra_param)\n\n>>>\n<class \'__main__.MyClass\'>\nhello`, `98808496519085080000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">my_class_decorator</span><span class="token punctuation">(</span>klass<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    klass<span class="token punctuation">.</span>extra_param <span class="token operator">=</span> <span class="token string">\'hello\'</span>\n    <span class="token keyword">return</span> klass\n\n\n@my_class_decorator\n<span class="token keyword">class</span> <span class="token class-name">MyClass</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n\n<span class="token keyword">print</span><span class="token punctuation">(</span>MyClass<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>MyClass<span class="token punctuation">.</span>extra_param<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">\'__main__.MyClass\'</span><span class="token operator">></span>\nhello</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在就来实现这样一个类修饰器，它可以施加在类上面，让该类的所有方法与函数都能自动封装在 trace_func 之中。这个类修饰器本身是个独立的函数，它的代码基本上可以沿用早前所写的 <code class="language-text">TraceMeta.__new__</code>。这套方案要比采用元类实现的方案简单得多。</p>\n<p>我们把类修饰器运用到自定义的 dict 子类上面，这样它就有了与刚才那套元类方案相同的功能。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="69818872422527510000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import types\nfrom functools import wraps\n\n\ndef trace_func(func):\n    if hasattr(func, \'tracing\'):  # Only decorate once\n        return func\n\n    @wraps(func)\n    def wrapper(*args, **kwargs):\n        result = None\n        try:\n            result = func(*args, **kwargs)\n            return result\n        except Exception as e:\n            result = e\n            raise\n        finally:\n            print(f\'{func.__name__}({args!r}, {kwargs!r}) -> \'\n                  f\'{result!r}\')\n\n    wrapper.tracing = True\n    return wrapper\n\n\ntrace_types = (\n    types.MethodType,\n    types.FunctionType,\n    types.BuiltinFunctionType,\n    types.BuiltinMethodType,\n    types.MethodDescriptorType,\n    types.ClassMethodDescriptorType\n)\n\n\ndef trace(klass):\n    for key in dir(klass):\n        value = getattr(klass, key)\n        if isinstance(value, trace_types):\n            wrapped = trace_func(value)\n            setattr(klass, key, wrapped)\n    return klass\n\n\n@trace\nclass TraceDict(dict):\n    pass\n\n\ntrace_dict = TraceDict([(\'hi\', 1)])\ntrace_dict[\'there\'] = 2\ntrace_dict[\'hi\']\ntry:\n    trace_dict[\'does not exist\']\nexcept KeyError:\n    pass  # Expected\n\n>>>\n__new__((<class \'__main__.TraceDict\'>, [(\'hi\', 1)]), {}) -> {}\n__getitem__(({\'hi\': 1, \'there\': 2}, \'hi\'), {}) -> 1\n__getitem__(({\'hi\': 1, \'there\': 2}, \'does not exist\'), {}) -> KeyError(\'does not exist\')`, `69818872422527510000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> types\n<span class="token keyword">from</span> functools <span class="token keyword">import</span> wraps\n\n\n<span class="token keyword">def</span> <span class="token function">trace_func</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">if</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>func<span class="token punctuation">,</span> <span class="token string">\'tracing\'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># Only decorate once</span>\n        <span class="token keyword">return</span> func\n\n    @wraps<span class="token punctuation">(</span>func<span class="token punctuation">)</span>\n    <span class="token keyword">def</span> <span class="token function">wrapper</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        result <span class="token operator">=</span> <span class="token boolean">None</span>\n        <span class="token keyword">try</span><span class="token punctuation">:</span>\n            result <span class="token operator">=</span> func<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>\n            <span class="token keyword">return</span> result\n        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>\n            result <span class="token operator">=</span> e\n            <span class="token keyword">raise</span>\n        <span class="token keyword">finally</span><span class="token punctuation">:</span>\n            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>func<span class="token punctuation">.</span>__name__<span class="token punctuation">}</span></span><span class="token string">(</span><span class="token interpolation"><span class="token punctuation">{</span>args<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">, </span><span class="token interpolation"><span class="token punctuation">{</span>kwargs<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">) -> \'</span></span>\n                  <span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>result<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n    wrapper<span class="token punctuation">.</span>tracing <span class="token operator">=</span> <span class="token boolean">True</span>\n    <span class="token keyword">return</span> wrapper\n\n\ntrace_types <span class="token operator">=</span> <span class="token punctuation">(</span>\n    types<span class="token punctuation">.</span>MethodType<span class="token punctuation">,</span>\n    types<span class="token punctuation">.</span>FunctionType<span class="token punctuation">,</span>\n    types<span class="token punctuation">.</span>BuiltinFunctionType<span class="token punctuation">,</span>\n    types<span class="token punctuation">.</span>BuiltinMethodType<span class="token punctuation">,</span>\n    types<span class="token punctuation">.</span>MethodDescriptorType<span class="token punctuation">,</span>\n    types<span class="token punctuation">.</span>ClassMethodDescriptorType\n<span class="token punctuation">)</span>\n\n\n<span class="token keyword">def</span> <span class="token function">trace</span><span class="token punctuation">(</span>klass<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">for</span> key <span class="token keyword">in</span> <span class="token builtin">dir</span><span class="token punctuation">(</span>klass<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        value <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>klass<span class="token punctuation">,</span> key<span class="token punctuation">)</span>\n        <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> trace_types<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            wrapped <span class="token operator">=</span> trace_func<span class="token punctuation">(</span>value<span class="token punctuation">)</span>\n            <span class="token builtin">setattr</span><span class="token punctuation">(</span>klass<span class="token punctuation">,</span> key<span class="token punctuation">,</span> wrapped<span class="token punctuation">)</span>\n    <span class="token keyword">return</span> klass\n\n\n@trace\n<span class="token keyword">class</span> <span class="token class-name">TraceDict</span><span class="token punctuation">(</span><span class="token builtin">dict</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n\ntrace_dict <span class="token operator">=</span> TraceDict<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">\'hi\'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\ntrace_dict<span class="token punctuation">[</span><span class="token string">\'there\'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">2</span>\ntrace_dict<span class="token punctuation">[</span><span class="token string">\'hi\'</span><span class="token punctuation">]</span>\n<span class="token keyword">try</span><span class="token punctuation">:</span>\n    trace_dict<span class="token punctuation">[</span><span class="token string">\'does not exist\'</span><span class="token punctuation">]</span>\n<span class="token keyword">except</span> KeyError<span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>  <span class="token comment"># Expected</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n__new__<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">\'__main__.TraceDict\'</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">\'hi\'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n__getitem__<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">\'hi\'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">\'there\'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">\'hi\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token number">1</span>\n__getitem__<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">\'hi\'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">\'there\'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">\'does not exist\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> KeyError<span class="token punctuation">(</span><span class="token string">\'does not exist\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>另外，类修饰器也能施加到那种已经有 metaclass 的类上面。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="14842768908191273000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import types\nfrom functools import wraps\n\n\ndef trace_func(func):\n    if hasattr(func, \'tracing\'):  # Only decorate once\n        return func\n\n    @wraps(func)\n    def wrapper(*args, **kwargs):\n        result = None\n        try:\n            result = func(*args, **kwargs)\n            return result\n        except Exception as e:\n            result = e\n            raise\n        finally:\n            print(f\'{func.__name__}({args!r}, {kwargs!r}) -> \'\n                  f\'{result!r}\')\n\n    wrapper.tracing = True\n    return wrapper\n\n\ntrace_types = (\n    types.MethodType,\n    types.FunctionType,\n    types.BuiltinFunctionType,\n    types.BuiltinMethodType,\n    types.MethodDescriptorType,\n    types.ClassMethodDescriptorType\n)\n\n\ndef trace(klass):\n    for key in dir(klass):\n        value = getattr(klass, key)\n        if isinstance(value, trace_types):\n            wrapped = trace_func(value)\n            setattr(klass, key, wrapped)\n    return klass\n\n\nclass OtherMeta(type):\n    pass\n\n\n@trace\nclass TraceDict(dict, metaclass=OtherMeta):\n    pass\n\n\ntrace_dict = TraceDict([(\'hi\', 1)])\ntrace_dict[\'there\'] = 2\ntrace_dict[\'hi\']\ntry:\n    trace_dict[\'does not exist\']\nexcept KeyError:\n    pass  # Expected\n\n>>>\n__new__((<class \'__main__.TraceDict\'>, [(\'hi\', 1)]), {}) -> {}\n__getitem__(({\'hi\': 1, \'there\': 2}, \'hi\'), {}) -> 1\n__getitem__(({\'hi\': 1, \'there\': 2}, \'does not exist\'), {}) -> KeyError(\'does not exist\')`, `14842768908191273000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> types\n<span class="token keyword">from</span> functools <span class="token keyword">import</span> wraps\n\n\n<span class="token keyword">def</span> <span class="token function">trace_func</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">if</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>func<span class="token punctuation">,</span> <span class="token string">\'tracing\'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># Only decorate once</span>\n        <span class="token keyword">return</span> func\n\n    @wraps<span class="token punctuation">(</span>func<span class="token punctuation">)</span>\n    <span class="token keyword">def</span> <span class="token function">wrapper</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        result <span class="token operator">=</span> <span class="token boolean">None</span>\n        <span class="token keyword">try</span><span class="token punctuation">:</span>\n            result <span class="token operator">=</span> func<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>\n            <span class="token keyword">return</span> result\n        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>\n            result <span class="token operator">=</span> e\n            <span class="token keyword">raise</span>\n        <span class="token keyword">finally</span><span class="token punctuation">:</span>\n            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>func<span class="token punctuation">.</span>__name__<span class="token punctuation">}</span></span><span class="token string">(</span><span class="token interpolation"><span class="token punctuation">{</span>args<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">, </span><span class="token interpolation"><span class="token punctuation">{</span>kwargs<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">) -> \'</span></span>\n                  <span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>result<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n    wrapper<span class="token punctuation">.</span>tracing <span class="token operator">=</span> <span class="token boolean">True</span>\n    <span class="token keyword">return</span> wrapper\n\n\ntrace_types <span class="token operator">=</span> <span class="token punctuation">(</span>\n    types<span class="token punctuation">.</span>MethodType<span class="token punctuation">,</span>\n    types<span class="token punctuation">.</span>FunctionType<span class="token punctuation">,</span>\n    types<span class="token punctuation">.</span>BuiltinFunctionType<span class="token punctuation">,</span>\n    types<span class="token punctuation">.</span>BuiltinMethodType<span class="token punctuation">,</span>\n    types<span class="token punctuation">.</span>MethodDescriptorType<span class="token punctuation">,</span>\n    types<span class="token punctuation">.</span>ClassMethodDescriptorType\n<span class="token punctuation">)</span>\n\n\n<span class="token keyword">def</span> <span class="token function">trace</span><span class="token punctuation">(</span>klass<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">for</span> key <span class="token keyword">in</span> <span class="token builtin">dir</span><span class="token punctuation">(</span>klass<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        value <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>klass<span class="token punctuation">,</span> key<span class="token punctuation">)</span>\n        <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> trace_types<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            wrapped <span class="token operator">=</span> trace_func<span class="token punctuation">(</span>value<span class="token punctuation">)</span>\n            <span class="token builtin">setattr</span><span class="token punctuation">(</span>klass<span class="token punctuation">,</span> key<span class="token punctuation">,</span> wrapped<span class="token punctuation">)</span>\n    <span class="token keyword">return</span> klass\n\n\n<span class="token keyword">class</span> <span class="token class-name">OtherMeta</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n\n@trace\n<span class="token keyword">class</span> <span class="token class-name">TraceDict</span><span class="token punctuation">(</span><span class="token builtin">dict</span><span class="token punctuation">,</span> metaclass<span class="token operator">=</span>OtherMeta<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n\ntrace_dict <span class="token operator">=</span> TraceDict<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">\'hi\'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\ntrace_dict<span class="token punctuation">[</span><span class="token string">\'there\'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">2</span>\ntrace_dict<span class="token punctuation">[</span><span class="token string">\'hi\'</span><span class="token punctuation">]</span>\n<span class="token keyword">try</span><span class="token punctuation">:</span>\n    trace_dict<span class="token punctuation">[</span><span class="token string">\'does not exist\'</span><span class="token punctuation">]</span>\n<span class="token keyword">except</span> KeyError<span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>  <span class="token comment"># Expected</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n__new__<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">\'__main__.TraceDict\'</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">\'hi\'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n__getitem__<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">\'hi\'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">\'there\'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">\'hi\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token number">1</span>\n__getitem__<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">\'hi\'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">\'there\'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">\'does not exist\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> KeyError<span class="token punctuation">(</span><span class="token string">\'does not exist\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>总之，如果想用一套可组合的机制来扩充类的功能，那么最好是通过类修饰器实现（第 73 条会讲到一种很有用的类修饰器，名为 <code class="language-text">functools.total_ordering</code>）。</p>\n<h3 id="总结-47"><a href="#%E6%80%BB%E7%BB%93-47" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>类修饰器其实就是个函数，只不过它可以通过参数获知自己所修饰的类，从而重建或调整这个类并返回修改结果。</li>\n<li>如果要给类中的每个方法或属性都施加一套逻辑，而且还想尽量少写一些例行代码，那么类修饰器是个很值得考虑的方案。</li>\n<li>元类之间很难组合，而类修饰器则比较灵活，它们可以施加在同一个类上，并且不会发生冲突。</li>\n</ol>\n<h1 id="并发与并行"><a href="#%E5%B9%B6%E5%8F%91%E4%B8%8E%E5%B9%B6%E8%A1%8C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>并发与并行</h1>\n<h2 id="第-52-条：用-subprocess-管理子进程"><a href="#%E7%AC%AC-52-%E6%9D%A1%EF%BC%9A%E7%94%A8-subprocess-%E7%AE%A1%E7%90%86%E5%AD%90%E8%BF%9B%E7%A8%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 52 条：用 subprocess 管理子进程</h2>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="6593831055300314000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import subprocess\n\nresult = subprocess.run(\n    [\'echo\', \'Hello from the child!\'],\n    capture_output=True,\n    encoding=\'utf-8\')\n\nresult.check_returncode()\nprint(result.stdout)\n# No exception means clean exit\n\n>>>\nHello from the child!`, `6593831055300314000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> subprocess\n\nresult <span class="token operator">=</span> subprocess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>\n    <span class="token punctuation">[</span><span class="token string">\'echo\'</span><span class="token punctuation">,</span> <span class="token string">\'Hello from the child!\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n    capture_output<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>\n    encoding<span class="token operator">=</span><span class="token string">\'utf-8\'</span><span class="token punctuation">)</span>\n\nresult<span class="token punctuation">.</span>check_returncode<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>stdout<span class="token punctuation">)</span>\n<span class="token comment"># No exception means clean exit</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nHello <span class="token keyword">from</span> the child!</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>子进程可以独立于父进程而运行，这里的父进程指 Python 解释器所在的那条进程。假如刚才那条子进程不是通过 run 函数启动，而是由 Popen 类启动的，那么我们就可以在它启动之后，让 Python 程序去做别的任务，每做一段时间就来查询一次子进程的状态以决定要不要继续执行任务</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="54821185722403510000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import subprocess\n\nproc = subprocess.Popen([\'sleep\', \'1\'])\nwhile proc.poll() is None:\n    print(\'Working...\')\n# Some time-consuming work here\nprint(\'Exit status\', proc.poll())\n\n>>>\nWorking...\nWorking...\nWorking...\nExit status 0`, `54821185722403510000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> subprocess\n\nproc <span class="token operator">=</span> subprocess<span class="token punctuation">.</span>Popen<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'sleep\'</span><span class="token punctuation">,</span> <span class="token string">\'1\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n<span class="token keyword">while</span> proc<span class="token punctuation">.</span>poll<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Working...\'</span><span class="token punctuation">)</span>\n<span class="token comment"># Some time-consuming work here</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Exit status\'</span><span class="token punctuation">,</span> proc<span class="token punctuation">.</span>poll<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nWorking<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nWorking<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nWorking<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nExit status <span class="token number">0</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>把子进程从父进程中剥离，可以让程序平行地运行多条子进程。例如，我们可以像下面这样，先把需要运行的这些子进程用 Popen 启动起来。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="41792275577543950000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import subprocess\nimport time\n\nstart = time.time()\nsleep_procs = []\nfor _ in range(10):\n    proc = subprocess.Popen([\'sleep\', \'1\'])\n    sleep_procs.append(proc)\n\nfor proc in sleep_procs:\n    proc.communicate()\n\nend = time.time()\ndelta = end - start\nprint(f\'Finished in {delta:.3} seconds\')\n\n>>>\nFinished in 1.01 seconds`, `41792275577543950000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> subprocess\n<span class="token keyword">import</span> time\n\nstart <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>\nsleep_procs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n<span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    proc <span class="token operator">=</span> subprocess<span class="token punctuation">.</span>Popen<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'sleep\'</span><span class="token punctuation">,</span> <span class="token string">\'1\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n    sleep_procs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>proc<span class="token punctuation">)</span>\n\n<span class="token keyword">for</span> proc <span class="token keyword">in</span> sleep_procs<span class="token punctuation">:</span>\n    proc<span class="token punctuation">.</span>communicate<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\nend <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>\ndelta <span class="token operator">=</span> end <span class="token operator">-</span> start\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Finished in </span><span class="token interpolation"><span class="token punctuation">{</span>delta<span class="token punctuation">:</span><span class="token format-spec">.3</span><span class="token punctuation">}</span></span><span class="token string"> seconds\'</span></span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nFinished <span class="token keyword">in</span> <span class="token number">1.01</span> seconds</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>从统计结果可以看出，这 10 条子进程确实表现出了平行的效果。假如它们是按顺序执行的，那么程序耗费的总时长至少应该是 10 秒，而不是现在看到的 1 秒左右。</p>\n<p>我们还可以在 Python 程序里面把数据通过管道发送给子进程所运行的外部命令，然后将那条命令的输出结果获取到 Python 程序之中。而且，在执行外部命令的这个环节中，可以平行地运行多条命令。例如，要用 oepnssl 这样的命令行工具来加密数据。首先以适当的命令行参数构建一批子进程，并配置好相应的 I/O 管道，这在 Python 里很容易就能做到。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="13389050898475352000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import subprocess\nimport os\n\n\ndef run_encrypt(data):\n    env = os.environ.copy()\n    env[\'password\'] = \'2f7ShyBhZOraQDdE/FiZpm/m/8f9X+MI\'\n    proc = subprocess.Popen(\n        [\'openssl\', \'enc\', \'-des3\', \'-pass\', \'env:password\'],\n        env=env,\n        stdin=subprocess.PIPE,\n        stdout=subprocess.PIPE\n    ) # 平行运行\n    proc.stdin.write(data)\n    proc.stdin.flush()  # Ensure that the child gets input\n    return proc\n\n\nprocs = []\nfor _ in range(3):\n    data = os.urandom(10)\n    proc = run_encrypt(data)\n    procs.append(proc)\n\nfor proc in procs:\n    out, _ = proc.communicate()\n    print(out[-10:])\n\n>>>\nb\'\\xc4G\\x01\\xf1\\x90Q\\xae\\xff\\x86\\xe1\'\nb\'>T~~R\\xbd\\xc3n\\x87\\xcc\'\nb\'\\xe9\\x02\\x18sE\\xa1W\\xcet\\xae\'`, `13389050898475352000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> subprocess\n<span class="token keyword">import</span> os\n\n\n<span class="token keyword">def</span> <span class="token function">run_encrypt</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    env <span class="token operator">=</span> os<span class="token punctuation">.</span>environ<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    env<span class="token punctuation">[</span><span class="token string">\'password\'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">\'2f7ShyBhZOraQDdE/FiZpm/m/8f9X+MI\'</span>\n    proc <span class="token operator">=</span> subprocess<span class="token punctuation">.</span>Popen<span class="token punctuation">(</span>\n        <span class="token punctuation">[</span><span class="token string">\'openssl\'</span><span class="token punctuation">,</span> <span class="token string">\'enc\'</span><span class="token punctuation">,</span> <span class="token string">\'-des3\'</span><span class="token punctuation">,</span> <span class="token string">\'-pass\'</span><span class="token punctuation">,</span> <span class="token string">\'env:password\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n        env<span class="token operator">=</span>env<span class="token punctuation">,</span>\n        stdin<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE<span class="token punctuation">,</span>\n        stdout<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE\n    <span class="token punctuation">)</span> <span class="token comment"># 平行运行</span>\n    proc<span class="token punctuation">.</span>stdin<span class="token punctuation">.</span>write<span class="token punctuation">(</span>data<span class="token punctuation">)</span>\n    proc<span class="token punctuation">.</span>stdin<span class="token punctuation">.</span>flush<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># Ensure that the child gets input</span>\n    <span class="token keyword">return</span> proc\n\n\nprocs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n<span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    data <span class="token operator">=</span> os<span class="token punctuation">.</span>urandom<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>\n    proc <span class="token operator">=</span> run_encrypt<span class="token punctuation">(</span>data<span class="token punctuation">)</span>\n    procs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>proc<span class="token punctuation">)</span>\n\n<span class="token keyword">for</span> proc <span class="token keyword">in</span> procs<span class="token punctuation">:</span>\n    out<span class="token punctuation">,</span> _ <span class="token operator">=</span> proc<span class="token punctuation">.</span>communicate<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span>out<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token string">b\'\\xc4G\\x01\\xf1\\x90Q\\xae\\xff\\x86\\xe1\'</span>\n<span class="token string">b\'>T~~R\\xbd\\xc3n\\x87\\xcc\'</span>\n<span class="token string">b\'\\xe9\\x02\\x18sE\\xa1W\\xcet\\xae\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这些平行运行的子进程还可以分别与另一套平行的子进程对接，形成许多条平行的管道（pipe）。这种管道与 UNIX 管道类似，能够把一条子进程的输出端同另一条子进程的输入端连接起来。下面，我们写这样一个函数，让它开启一条子进程来运行 openssl 命令，这条命令会根据输入端所发来的数据在输出端生成 Whirlpool 哈希。</p>\n<p>现在，我们可以先启动一批进程来加密数据，然后启动另一批进程根据前面那些进程的加密结果生成哈希码。请注意，前面那批进程（也就是上游进程）的 stdout 实例必须谨慎地处理，用它把相应的哈希进程（也就是下游进程）启动之后，就应该及时关闭（close）并将其设为 None。</p>\n<p>只要上、下游的子进程都启动起来，两者之间的 I/O 管道就会自动打通。我们所要做的仅仅是等待这两批子进程完工并把最终结果打印出来。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="5641348490692511000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import subprocess\nimport os\n\n\ndef run_hash(input_stdin):\n    return subprocess.Popen(\n        [\'openssl\', \'dgst\', \'-whirlpool\', \'-binary\'],\n        stdin=input_stdin,\n        stdout=subprocess.PIPE)\n\n\ndef run_encrypt(data):\n    env = os.environ.copy()\n    env[\'password\'] = \'2f7ShyBhZOraQDdE/FiZpm/m/8f9X+MI\'\n    proc = subprocess.Popen(\n        [\'openssl\', \'enc\', \'-des3\', \'-pass\', \'env:password\'],\n        env=env,\n        stdin=subprocess.PIPE,\n        stdout=subprocess.PIPE\n    )  # 平行运行\n    proc.stdin.write(data)\n    proc.stdin.flush()  # Ensure that the child gets input\n    return proc\n\n\nencrypt_procs = []\nhash_procs = []\nfor _ in range(3):\n    data = os.urandom(100)\n    encrypt_proc = run_encrypt(data)\n    encrypt_procs.append(encrypt_proc)\n    hash_proc = run_hash(encrypt_proc.stdout)\n    hash_procs.append(hash_proc)\n    # Ensure that the child consumes the input stream and\n    # the communicate method doesn\'t inadvertently steal\n    # input from the child. Also lets SIGPIPE propagate to\n    # the upstream process if the downstream process dies.\n    encrypt_proc.stdout.close()\n    encrypt_proc.stdout = None\n\nfor proc in encrypt_procs:\n    proc.communicate()\n    assert proc.returncode == 0\n\nfor proc in hash_procs:\n    out, _ = proc.communicate()\n    print(out[-10:])\n    assert proc.returncode == 0\n\n>>>\nb\'\\xa7{\\xc8q\\xf9n#i\\x0b7\'\nb\'\\xb3\\x9aP\\x7f\\xa6N\\xc9\\x8b-Z\'\nb\'\\xe8F\\x94\\x1fQ\\x83L\\xf7\\xb3p\'`, `5641348490692511000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> subprocess\n<span class="token keyword">import</span> os\n\n\n<span class="token keyword">def</span> <span class="token function">run_hash</span><span class="token punctuation">(</span>input_stdin<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">return</span> subprocess<span class="token punctuation">.</span>Popen<span class="token punctuation">(</span>\n        <span class="token punctuation">[</span><span class="token string">\'openssl\'</span><span class="token punctuation">,</span> <span class="token string">\'dgst\'</span><span class="token punctuation">,</span> <span class="token string">\'-whirlpool\'</span><span class="token punctuation">,</span> <span class="token string">\'-binary\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n        stdin<span class="token operator">=</span>input_stdin<span class="token punctuation">,</span>\n        stdout<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE<span class="token punctuation">)</span>\n\n\n<span class="token keyword">def</span> <span class="token function">run_encrypt</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    env <span class="token operator">=</span> os<span class="token punctuation">.</span>environ<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    env<span class="token punctuation">[</span><span class="token string">\'password\'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">\'2f7ShyBhZOraQDdE/FiZpm/m/8f9X+MI\'</span>\n    proc <span class="token operator">=</span> subprocess<span class="token punctuation">.</span>Popen<span class="token punctuation">(</span>\n        <span class="token punctuation">[</span><span class="token string">\'openssl\'</span><span class="token punctuation">,</span> <span class="token string">\'enc\'</span><span class="token punctuation">,</span> <span class="token string">\'-des3\'</span><span class="token punctuation">,</span> <span class="token string">\'-pass\'</span><span class="token punctuation">,</span> <span class="token string">\'env:password\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n        env<span class="token operator">=</span>env<span class="token punctuation">,</span>\n        stdin<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE<span class="token punctuation">,</span>\n        stdout<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE\n    <span class="token punctuation">)</span>  <span class="token comment"># 平行运行</span>\n    proc<span class="token punctuation">.</span>stdin<span class="token punctuation">.</span>write<span class="token punctuation">(</span>data<span class="token punctuation">)</span>\n    proc<span class="token punctuation">.</span>stdin<span class="token punctuation">.</span>flush<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># Ensure that the child gets input</span>\n    <span class="token keyword">return</span> proc\n\n\nencrypt_procs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\nhash_procs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n<span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    data <span class="token operator">=</span> os<span class="token punctuation">.</span>urandom<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>\n    encrypt_proc <span class="token operator">=</span> run_encrypt<span class="token punctuation">(</span>data<span class="token punctuation">)</span>\n    encrypt_procs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>encrypt_proc<span class="token punctuation">)</span>\n    hash_proc <span class="token operator">=</span> run_hash<span class="token punctuation">(</span>encrypt_proc<span class="token punctuation">.</span>stdout<span class="token punctuation">)</span>\n    hash_procs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>hash_proc<span class="token punctuation">)</span>\n    <span class="token comment"># Ensure that the child consumes the input stream and</span>\n    <span class="token comment"># the communicate method doesn\'t inadvertently steal</span>\n    <span class="token comment"># input from the child. Also lets SIGPIPE propagate to</span>\n    <span class="token comment"># the upstream process if the downstream process dies.</span>\n    encrypt_proc<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    encrypt_proc<span class="token punctuation">.</span>stdout <span class="token operator">=</span> <span class="token boolean">None</span>\n\n<span class="token keyword">for</span> proc <span class="token keyword">in</span> encrypt_procs<span class="token punctuation">:</span>\n    proc<span class="token punctuation">.</span>communicate<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token keyword">assert</span> proc<span class="token punctuation">.</span>returncode <span class="token operator">==</span> <span class="token number">0</span>\n\n<span class="token keyword">for</span> proc <span class="token keyword">in</span> hash_procs<span class="token punctuation">:</span>\n    out<span class="token punctuation">,</span> _ <span class="token operator">=</span> proc<span class="token punctuation">.</span>communicate<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span>out<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n    <span class="token keyword">assert</span> proc<span class="token punctuation">.</span>returncode <span class="token operator">==</span> <span class="token number">0</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token string">b\'\\xa7{\\xc8q\\xf9n#i\\x0b7\'</span>\n<span class="token string">b\'\\xb3\\x9aP\\x7f\\xa6N\\xc9\\x8b-Z\'</span>\n<span class="token string">b\'\\xe8F\\x94\\x1fQ\\x83L\\xf7\\xb3p\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果子进程有可能一直不结束，或者由于某种原因卡在输入端或输出端，那么可以在调用 communicate 方法时指定 timeout 参数。这样的话，子进程若是没能在指定时间内结束，程序就会抛出异常，让我们有机会把这条不正常的子进程停掉。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="60726698280213135000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import subprocess\n\nproc = subprocess.Popen([\'sleep\', \'10\'])\ntry:\n    proc.communicate(timeout=0.1)\nexcept subprocess.TimeoutExpired:\n    proc.terminate()\n    proc.wait()\n\nprint(\'Exit status\', proc.poll())\n\n>>>\nExit status -15`, `60726698280213135000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> subprocess\n\nproc <span class="token operator">=</span> subprocess<span class="token punctuation">.</span>Popen<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'sleep\'</span><span class="token punctuation">,</span> <span class="token string">\'10\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n<span class="token keyword">try</span><span class="token punctuation">:</span>\n    proc<span class="token punctuation">.</span>communicate<span class="token punctuation">(</span>timeout<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">)</span>\n<span class="token keyword">except</span> subprocess<span class="token punctuation">.</span>TimeoutExpired<span class="token punctuation">:</span>\n    proc<span class="token punctuation">.</span>terminate<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    proc<span class="token punctuation">.</span>wait<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Exit status\'</span><span class="token punctuation">,</span> proc<span class="token punctuation">.</span>poll<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nExit status <span class="token operator">-</span><span class="token number">15</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="总结-48"><a href="#%E6%80%BB%E7%BB%93-48" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>subprocess 模块可以运行子进程并管理它们的输入流与输出流。</li>\n<li>子进程能够跟 Python 解释器所在的进程并行，从而充分利用各 CPU 核心。</li>\n<li>要开启子进程，最简单的办法就是调用 run 函数，另外也可以通过 Popen 类实现类似 UNIX 管道的高级用法。</li>\n<li>调用 communicate 方法时可以指定 timeout 参数，让我们有机会把陷入死锁或已经卡住的子进程关掉。</li>\n</ol>\n<h2 id="第-53-条：可以用线程执行阻塞式-io，但不要用它做并行计算"><a href="#%E7%AC%AC-53-%E6%9D%A1%EF%BC%9A%E5%8F%AF%E4%BB%A5%E7%94%A8%E7%BA%BF%E7%A8%8B%E6%89%A7%E8%A1%8C%E9%98%BB%E5%A1%9E%E5%BC%8F-io%EF%BC%8C%E4%BD%86%E4%B8%8D%E8%A6%81%E7%94%A8%E5%AE%83%E5%81%9A%E5%B9%B6%E8%A1%8C%E8%AE%A1%E7%AE%97" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 53 条：可以用线程执行阻塞式 I/O，但不要用它做并行计算</h2>\n<p>Python 语言的标准实现叫作 CPython，，它分两步来运行 Python 程序。首先解析源代码文本，并将其编译成字节码（bytecode）。字节码是一种底层代码，可以把程序表示成 8 位的指令（从 Python 3.6 开始，这种底层代码实际上已经变成 16 位了，所以应该叫作 wordcode 才对，但基本原理依然相同）。然后，CPython 采用基于栈的解释器来运行字节码。这种字节码解释器在执行 Python 程序的过程中，必须确保相关的状态不受干扰，所以 CPython 会用一种叫作全局解释器锁（global interpreter lock，GIL）的机制来保证这一点。</p>\n<p>GIL 实际上就是一种互斥锁（mutual-exclusion lock，mutex），用来防止 CPython 的状态在抢占式的多线程环境（preemptive multithreading）之中受到干扰，因为在这种环境下，一条线程有可能突然打断另一条线程抢占程序的控制权。如果这种抢占行为来得不是时候，那么解释器的状态（例如为垃圾回收工作而设立的引用计数等）就会遭到破坏。所以，CPython 要通过 GIL 阻止这样的动作，以确保它自身以及它的那些 C 扩展模块能够正确地执行每一条字节码指令。</p>\n<p>但是，GIL 会产生一个很不好的影响。在 C++ 与 Java 这样的语言里面，如果程序之中有多个线程能够分头执行任务，那么就可以把 CPU 的各个核心充分地利用起来。尽管 Python 也支持多线程，但这些线程受 GIL 约束，所以每次或许只能有一条线程向前推进，而无法实现多头并进。所以，想通过多线程做并行计算或是给程序提速的开发者，恐怕要失望了。</p>\n<p>例如，我们要用 Python 程序执行一批计算量很大的任务。以最原始的办法实现这样一个因数分解算法，以模拟这种任务。</p>\n<p>我们试着分解几个数。如果必须把上一个数分解完才能开始分解下一个数，那么程序花的时间就比较长。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="2910822634030929400"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import time\n\n\ndef factorize(number):\n    for i in range(1, number + 1):\n        if number % i == 0:\n            yield i\n\n\nnumbers = [2139079, 1214759, 1516637, 1852285]\nstart = time.time()\nfor number in numbers:\n    list(factorize(number))\n\nend = time.time()\ndelta = end - start\nprint(f\'Took {delta:.3f} seconds\')\n\n>>>\nTook 0.428 seconds`, `2910822634030929400`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> time\n\n\n<span class="token keyword">def</span> <span class="token function">factorize</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> number <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> number <span class="token operator">%</span> i <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>\n            <span class="token keyword">yield</span> i\n\n\nnumbers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">2139079</span><span class="token punctuation">,</span> <span class="token number">1214759</span><span class="token punctuation">,</span> <span class="token number">1516637</span><span class="token punctuation">,</span> <span class="token number">1852285</span><span class="token punctuation">]</span>\nstart <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">for</span> number <span class="token keyword">in</span> numbers<span class="token punctuation">:</span>\n    <span class="token builtin">list</span><span class="token punctuation">(</span>factorize<span class="token punctuation">(</span>number<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\nend <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>\ndelta <span class="token operator">=</span> end <span class="token operator">-</span> start\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Took </span><span class="token interpolation"><span class="token punctuation">{</span>delta<span class="token punctuation">:</span><span class="token format-spec">.3f</span><span class="token punctuation">}</span></span><span class="token string"> seconds\'</span></span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTook <span class="token number">0.428</span> seconds</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>让每条线程各自分解一个数或许可以把计算机中的多个 CPU 核心充分利用起来。这种想法对于其他语言来说，可能有些道理，但是在 Python 中效果如何呢？我们试着定义这样一种 Python 线程，让它完成与刚才相同的因数分解任务。</p>\n<p>然后，针对每个待分解的数字都启动这样一条线程，让它们平行地运行下去。</p>\n<p>最后，等待所有线程执行完毕。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="31689058563394810000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import time\n\nfrom threading import Thread\n\n\nclass FactorizeThread(Thread):\n    def __init__(self, number):\n        super().__init__()\n        self.number = number\n\n    def run(self):\n        self.factors = list(factorize(self.number))\n\n\ndef factorize(number):\n    for i in range(1, number + 1):\n        if number % i == 0:\n            yield i\n\n\nnumbers = [2139079, 1214759, 1516637, 1852285]\n\nstart = time.time()\nthreads = []\nfor number in numbers:\n    thread = FactorizeThread(number)\n    thread.start()\n    threads.append(thread)\n\nfor thread in threads:\n    thread.join()\n\nend = time.time()\ndelta = end - start\nprint(f\'Took {delta:.3f} seconds\')\n\n>>>\nTook 0.528 seconds`, `31689058563394810000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> time\n\n<span class="token keyword">from</span> threading <span class="token keyword">import</span> Thread\n\n\n<span class="token keyword">class</span> <span class="token class-name">FactorizeThread</span><span class="token punctuation">(</span>Thread<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> number<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>number <span class="token operator">=</span> number\n\n    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>factors <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>factorize<span class="token punctuation">(</span>self<span class="token punctuation">.</span>number<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n\n<span class="token keyword">def</span> <span class="token function">factorize</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> number <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> number <span class="token operator">%</span> i <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>\n            <span class="token keyword">yield</span> i\n\n\nnumbers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">2139079</span><span class="token punctuation">,</span> <span class="token number">1214759</span><span class="token punctuation">,</span> <span class="token number">1516637</span><span class="token punctuation">,</span> <span class="token number">1852285</span><span class="token punctuation">]</span>\n\nstart <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>\nthreads <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n<span class="token keyword">for</span> number <span class="token keyword">in</span> numbers<span class="token punctuation">:</span>\n    thread <span class="token operator">=</span> FactorizeThread<span class="token punctuation">(</span>number<span class="token punctuation">)</span>\n    thread<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    threads<span class="token punctuation">.</span>append<span class="token punctuation">(</span>thread<span class="token punctuation">)</span>\n\n<span class="token keyword">for</span> thread <span class="token keyword">in</span> threads<span class="token punctuation">:</span>\n    thread<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\nend <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>\ndelta <span class="token operator">=</span> end <span class="token operator">-</span> start\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Took </span><span class="token interpolation"><span class="token punctuation">{</span>delta<span class="token punctuation">:</span><span class="token format-spec">.3f</span><span class="token punctuation">}</span></span><span class="token string"> seconds\'</span></span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTook <span class="token number">0.528</span> seconds</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>奇怪的是，这样做竟然比一个一个去分解还要慢。在其他语言中，像这样令 4 条线程分别执行各自的任务，应该比一条线程连续执行 4 份任务要快得多，考虑到创建线程与协调这些线程的开销，新程序的速度可能会比旧程序的 4 倍稍微低一点。即便 CPU 的核心数量不足 4 个，新程序也还是应该比原来更快才对（例如笔者的电脑是双核的，所以应该接近原来的 2 倍），但为什么它没有把多核心的优势发挥出来？这是因为，这种多线程的程序在标准的 CPython 解释器之中会受 GIL 牵制（例如 CPython 要通过 GIL 防止这些线程争抢全局锁，而且要花一些时间来协调）。</p>\n<p>若要 CPython 把多个核心充分利用起来，还是有一些办法的，但那些办法都不采用标准的 Thread 类（参见第 64 条），而且实现起来也需要大量的精力。既然有这么多限制，那 Python 还支持多线程干什么？这其实有两个原因。</p>\n<p>首先，这种机制让我们很容易就能实现出一种效果，也就是令人感觉程序似乎能在同一时间做许多件事。这样的效果采用手工方式很难编写（案例参见第 56 条），而通过线程来实现，则可以让 Python 自动替我们把这些问题处理好，让多项任务能够并发地执行。由于 GIL 机制，虽然每次还是只能有一个线程向前执行，但 CPython 会确保这些 Python 线程之间能够公平地轮换执行。</p>\n<p>其次，我们可以通过 Python 的多线程机制处理阻塞式的 I/O 任务，因为线程在执行某些系统调用的过程中会发生阻塞，假如只支持一条线程，那么整个程序就会卡在这里不动。Python 程序需要通过系统调用与外部环境交互，其中有一些调用属于阻塞式的 I/O 操作，例如读取文件、写入文件、联网以及与显示器等设备交互。多线程机制可以让程序中的其他线程继续执行各自的工作，只有发起调用请求的那条线程才需要卡在那里等待操作系统给出结果。</p>\n<p>例如，要通过串口（serial port）向遥控直升机发送信号。笔者以 select 这个系统调用来模拟这项操作。通过 select 函数让操作系统阻塞 0.1 秒，然后把控制权返还给本程序，这样就模拟出了使用串口通信的效果。</p>\n<p>通过这种方式依次执行系统调用，程序的执行时间会随着调用次数而上升。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="45697343433757640000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import time\n\n\ndef slow_systemcall():\n    time.sleep(0.1)\n\n\nstart = time.time()\nfor _ in range(5):\n    slow_systemcall()\nend = time.time()\ndelta = end - start\nprint(f\'Took {delta:.3f} seconds\')\n\n>>>\nTook 0.501 seconds`, `45697343433757640000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> time\n\n\n<span class="token keyword">def</span> <span class="token function">slow_systemcall</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span>\n\n\nstart <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    slow_systemcall<span class="token punctuation">(</span><span class="token punctuation">)</span>\nend <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>\ndelta <span class="token operator">=</span> end <span class="token operator">-</span> start\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Took </span><span class="token interpolation"><span class="token punctuation">{</span>delta<span class="token punctuation">:</span><span class="token format-spec">.3f</span><span class="token punctuation">}</span></span><span class="token string"> seconds\'</span></span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTook <span class="token number">0.501</span> seconds</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样写有个问题，就是程序在执行 <code class="language-text">slow_systemcall</code> 函数的过程中会彻底卡住，因为它的主线程会阻塞在 select 这里。在实际的程序里面，这是个相当糟糕的现象，因为我们向直升机发送信号的同时，还需要计算接下来的移动方式，不然直升机就会坠毁。所以，如果在执行阻塞式 I/O 的过程中还需要做计算，那么应该把系统调用放到另一条线程执行。</p>\n<p>下面把 <code class="language-text">slow_systemcall</code> 放在单独的线程里调用，这样能同时触发多项操作，于是我们可以在与多个串口（乃至多个直升机）通信的同时，在主线程里做其他必要的运算。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="92048324994379020000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import time\nfrom threading import Thread\n\n\ndef slow_systemcall():\n    time.sleep(0.1)\n\n\ndef compute_helicopter_location(i):\n    pass\n\n\nstart = time.time()\nthreads = []\nfor _ in range(5):\n    thread = Thread(target=slow_systemcall)\n    thread.start()\n    threads.append(thread)\n\nfor i in range(5):\n    compute_helicopter_location(i)\n\n\nfor thread in threads:\n    thread.join()\nend = time.time()\ndelta = end - start\nprint(f\'Took {delta:.3f} seconds\')\n\n>>>\nTook 0.101 seconds`, `92048324994379020000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> time\n<span class="token keyword">from</span> threading <span class="token keyword">import</span> Thread\n\n\n<span class="token keyword">def</span> <span class="token function">slow_systemcall</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span>\n\n\n<span class="token keyword">def</span> <span class="token function">compute_helicopter_location</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n\nstart <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>\nthreads <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n<span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    thread <span class="token operator">=</span> Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>slow_systemcall<span class="token punctuation">)</span>\n    thread<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    threads<span class="token punctuation">.</span>append<span class="token punctuation">(</span>thread<span class="token punctuation">)</span>\n\n<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    compute_helicopter_location<span class="token punctuation">(</span>i<span class="token punctuation">)</span>\n\n\n<span class="token keyword">for</span> thread <span class="token keyword">in</span> threads<span class="token punctuation">:</span>\n    thread<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>\nend <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>\ndelta <span class="token operator">=</span> end <span class="token operator">-</span> start\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Took </span><span class="token interpolation"><span class="token punctuation">{</span>delta<span class="token punctuation">:</span><span class="token format-spec">.3f</span><span class="token punctuation">}</span></span><span class="token string"> seconds\'</span></span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTook <span class="token number">0.101</span> seconds</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>与依次执行系统调用的那种写法相比，这种写法的速度几乎能达到原来的 5 倍。这说明，尽管那 5 条线程依然受 GIL 制约，但它们所发起的系统调用是可以各自向前执行的。GIL 只不过是让 Python 内部的代码无法平行推进而已，至于系统调用，则不会受到影响，因为 Python 线程在即将执行系统调用时，会释放 GIL，待完成调用之后，才会重新获取它。</p>\n<p>除了线程，还有很多办法也能处理阻塞式的 I/O（例如采用内置的 asyncio 模块等）。那些办法都很好，但你可能得花时间去重构代码适应它们所要求的执行模式（参见第 60 条与第 62 条）。与那些办法相比，用多线程处理阻塞式 I/O 是最简单的，而且只需要稍微调整代码就行。</p>\n<h3 id="总结-49"><a href="#%E6%80%BB%E7%BB%93-49" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>即便计算机具备多核的 CPU，Python 线程也无法真正实现并行，因为它们会受全局解释器锁（GIL）牵制。</li>\n<li>虽然 Python 的多线程机制受 GIL 影响，但还是非常有用的，因为我们很容易就能通过多线程模拟同时执行多项任务的效果。</li>\n<li>多条 Python 线程可以并行地执行多个系统调用，这样就能让程序在执行阻塞式的 I/O 任务时，继续做其他运算。</li>\n</ol>\n<h2 id="第-54-条：利用-lock-防止多个线程争用同一份数据"><a href="#%E7%AC%AC-54-%E6%9D%A1%EF%BC%9A%E5%88%A9%E7%94%A8-lock-%E9%98%B2%E6%AD%A2%E5%A4%9A%E4%B8%AA%E7%BA%BF%E7%A8%8B%E4%BA%89%E7%94%A8%E5%90%8C%E4%B8%80%E4%BB%BD%E6%95%B0%E6%8D%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 54 条：利用 Lock 防止多个线程争用同一份数据</h2>\n<p>了解到全局解释器锁（GIL）的效果之后（参见第 53 条），许多 Python 新手可能觉得没必要继续在代码里使用互斥锁（mutual-exclusion lock，mutex）了。既然 GIL 让 Python 线程没办法平行地运行在多个 CPU 核心上，那是不是就意味着它同时还会自动保护程序里面的数据结构，让我们不需要再加锁了？在列表与字典等结构上面测试过之后，有些人可能真的以为是这样的。</p>\n<p>其实并非如此。GIL 起不到这样的保护作用。虽说同一时刻只能有一条 Python 线程在运行，但这条线程所操纵的数据结构还是有可能遭到破坏，因为它在执行完当前这条字节码指令之后，可能会被 Python 系统切换走，等它稍后切换回来继续执行下一条字节码指令时，当前的数据或许已经与实际值脱节了，因为中途切换进来的其他线程可能更新过这个值。所以，多个线程同时访问同一个对象是很危险的。每条线程在操作这份数据时，都有可能遭到其他线程打扰，因此数据之中的固定关系或许已经被别的线程破坏了，这会令程序陷入混乱状态。</p>\n<p>例如，要编写一个程序，让它平行地采集数据。如果要采集传感器网络中的每个传感器所给出的亮度，那么就需要用到这种程序。我们首先需要定义下面这样一个新类，用来记录采集到的样本总数。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-10-23-21-29-89b3f7dd8487b6f0aa34c17cada36fec-19a4b.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 435px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 40.45977011494253%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAAsSAAALEgHS3X78AAABXElEQVQY02VRC2+CMBj0//+hbcnmG0SGRim0FAUKCAqK41UdIrrPmeyZXK752rvmrm1N43TE1soqmca5YAV90xtZgezHWlrpxZnwBpcN5o2W1/o/tGbbXAkTiYVD0x0ufcEJBiYTTA/tOEqPSpAowU72YpKecH7Sf6OFi5oervMo7+ElTqtJmIqWL1oriUWyv31Wqcw2XWxpW06K+q/5vsCtuDzrWfUwmfcpU4L904w8TtDYjbTkXWJr9HYEmZZVoLnxT7Ne1KS84OxEyrPBL1CVAJcNjLcdqA0C3hiHiwHML/pnipsZDmZxPqA22pWSG0FDYeH3qTP2I9EJx2wjmh7JTpBiQJ0RCwV7hfYH/GWew1Pbvp5WPcPu6KZAWVslfWoDRDuU7LXsRh1EB8SGHxGdQE04/u5c1BAJ5q62GLNwHmVdw2lr5muwQ8lBjSCXKy68F9VECafH6z32Bw2dqGZvro1JAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 10 23 21 29" title="" data-src="/static/2023-10-10-23-21-29-89b3f7dd8487b6f0aa34c17cada36fec-19a4b.png" data-srcset="/static/2023-10-10-23-21-29-89b3f7dd8487b6f0aa34c17cada36fec-5fb9b.png 200w,\n/static/2023-10-10-23-21-29-89b3f7dd8487b6f0aa34c17cada36fec-56ca1.png 400w,\n/static/2023-10-10-23-21-29-89b3f7dd8487b6f0aa34c17cada36fec-19a4b.png 435w" data-sizes="(max-width: 435px) 100vw, 435px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>然后，假设获取传感器读数的操作是一种阻塞式的 I/O 操作，这样的话，我们就需要针对每个传感器都开启一条工作线程专门读取它所负责的这个传感器。每采集到一份样本，线程就会给表示样本总数的那个量加 1，直到采集完应采集样本为止。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-10-23-22-23-a6b7d79ebe89add2070158d705340519-1627b.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 582px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 27.147766323024054%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAIAAADKYVtkAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAA7UlEQVQY02WO626CQBCFef93amIQBJRbAQERuS271F1Y5CIWapMOaX80MTmTnJmcmW8Ei3ATNybmh+KqF3SfX7WscthgV62a4KCbDcRMXIN3aO+yHswh/7BIE/SLYNLOot02SPcFNUijXMrtOVeScuNFb24kXdDGj+WEaCWDpM0GDRikMenN62bBH75ADp/celRTsouRmlXSKZNOuRjm8hmJYSLHyO+XYHxCMrh/r2Z8HoEMBVqbbnbquwW/tZMLt26fbvtYh3yy6QCc3+R//S0fh8VrH1JUSDHScW0QrqRYDDM5LnVE39kIzNflH3VMCPV+XvreAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 10 23 22 23" title="" data-src="/static/2023-10-10-23-22-23-a6b7d79ebe89add2070158d705340519-1627b.png" data-srcset="/static/2023-10-10-23-22-23-a6b7d79ebe89add2070158d705340519-2ccd9.png 200w,\n/static/2023-10-10-23-22-23-a6b7d79ebe89add2070158d705340519-1954a.png 400w,\n/static/2023-10-10-23-22-23-a6b7d79ebe89add2070158d705340519-1627b.png 582w" data-sizes="(max-width: 582px) 100vw, 582px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>现在，给每个传感器建立各自的工作线程，让这些线程平行地采样，最后等待所有线程完成各自采样工作。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-10-23-22-40-012fbb5a07cd60e2205046022604685e-c319d.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 660px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 86.96969696969697%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAIAAABSJhvpAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACQUlEQVQ4y4VT147aUBD1//9QXoJYNphiG1zBNPfeK3XZVc61k0VRyEYaWW4zc9qlxKRm7Yj10vHBHu9tWncXbjLV3aVfTA1/pOpi2q6bt1V9+7soOT8JScMnjZgfleIiJq1SnFf1tf+slJdVdX3aSZoZNxkI6lDesk7Kudl4Y87NQIibVd1t+8fOx2bOy4SoloszH1Wsk3BuKsb1Fz2PZj6u6IM7MTwxaaSkAcjN6UM9vpOdj7o9BU8tw2Km+6wVM1Y80b0fW5PeW4uwlMuzVJzBGYjk4qI2d8hGqr2T6uhQZEZ1XXgZpAZsIa4h8tQI6L0NqWnNfd0Yr6q+8HMQJOrin6iWsuPv5vrGxzXn58uwRLF+zvnZQNoOlT1jx5iIWQAFaQATo+dmuAzyx+bx1vrOr+mdNVprA2k30RwuyGGEkMDk+6pD2/P/E3aF5husBk8hbfm4QQM+QDO1fSc/Qaq+nggWlZyXzq1wpBpgvgyKseYACGOFa4Skvn5l1boLA4IBwCAz1T0MkvKTQla9/cdnpBIiwW0hO8ISIakhHvKMe5nk9KZ0mLtZt/76yYJinfgby9MHZ2aEcGu42o235ouqLYKCMG/vYN4VEYyE59dLohkFJ6AtoILky/ow2dtLLxttNFiCnMKemRkyTjQzfGSWcWIxqsCRsSPOSyjYLeM8VVe5vOBUyd0x6gHLxQk3oAAJiArlBV7gzMEagbw8Ugs/Q4ZIAIJyYgasm+Ik4xGpggvABfyIyhThz9oe9qfVPwFw141k7w/99wAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 10 23 22 40" title="" data-src="/static/2023-10-10-23-22-40-012fbb5a07cd60e2205046022604685e-c319d.png" data-srcset="/static/2023-10-10-23-22-40-012fbb5a07cd60e2205046022604685e-19de3.png 200w,\n/static/2023-10-10-23-22-40-012fbb5a07cd60e2205046022604685e-3e86e.png 400w,\n/static/2023-10-10-23-22-40-012fbb5a07cd60e2205046022604685e-c319d.png 660w" data-sizes="(max-width: 660px) 100vw, 660px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>这个程序似乎相当简单，所以运行结果应该是 500000 才对。但实际上却差得很远，这是为什么呢？这样简单的程序竟然会出错，而且 Python 解释器最多只允许一条线程在运行，那为什么还统计不出正确结果呢？</p>\n<p>其实，Python 解释器需要保证这些线程可以公平地获得执行机会，或者说，保证每条线程所分配到的执行时间大致相等。为了实现这种效果，它会及时暂停某条线程，并且把另一条线程切换过来执行。然而问题是，我们并不清楚它具体会在什么时候暂停线程，万一这条线程正在执行的是一项本来不应该中断的原子操作（atomic operation），那会如何呢？上面的例子遇到的正是这种情况。</p>\n<p>Counter 对象的 increment 方法看上去很简单，工作线程在调用这个方法时，相当于是在执行下面这样一条语句：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-10-23-23-58-93e882b37f106ac1ea21ab41eb883b7d-306e5.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 280px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 14.642857142857144%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAIAAAAcOLh5AAAACXBIWXMAAA7DAAAOwwHHb6hkAAAApElEQVQI1yXKXxNCQBSHYd//2yRN3XSjzCpLmG0qtSwNJUwsJqs/OlMzz8WZ83sl2vTs8Qk7MPwPv33TumfdEP7AExraPP32dawFgPXEBZCMpFDW1hQ7I82QkTlGeO7urLScYVdGeGLYCsJ6lDrXUqNnN29VLyRVR7gAkp3Xy1O08EKgs0Q9MDPO7ayBVN0HkK6CZHPjTlbjuCClMC93Uokt78EXJ1Kd2FfwuYUAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 10 23 23 58" title="" data-src="/static/2023-10-10-23-23-58-93e882b37f106ac1ea21ab41eb883b7d-306e5.png" data-srcset="/static/2023-10-10-23-23-58-93e882b37f106ac1ea21ab41eb883b7d-a6776.png 200w,\n/static/2023-10-10-23-23-58-93e882b37f106ac1ea21ab41eb883b7d-306e5.png 280w" data-sizes="(max-width: 280px) 100vw, 280px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>然而，在对象的属性上面执行+=操作，实际上需要分成三个小的步骤。也就是说，Python 系统会这样看待这次操作：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-10-23-24-18-03180d50b354a43b0767301f57b30f14-2c843.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 446px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 21.524663677130047%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAIAAAABPYjBAAAACXBIWXMAAAsSAAALEgHS3X78AAAA10lEQVQI1xWP23KCMABE+f9vclrEAlZuhQANcgkYEjAEE6gMyFPjzHndPbtaOPzZiJ6uN4+IeFxdzNyWe3jwW35G1K7oMauPEHmdTKf90vRW2Z5r6nY85Ivmd+IE0QfIjayOH6vbMPPa6EnhYOYT/pVj+3a/kCEY5nh++ffJIdxnEoxPIFYtYJMqNjJkIxx0UmnNrD5E0KzIr9x/+gmIDcgtlls67yoQKR5LNC7J9NJCNqsxjqLuvytqQKSn5WdaGvA9BAxPPS0ULuaJ2KyCHkJo5Vj51N9//vXPrMjRvPQAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 10 23 24 18" title="" data-src="/static/2023-10-10-23-24-18-03180d50b354a43b0767301f57b30f14-2c843.png" data-srcset="/static/2023-10-10-23-24-18-03180d50b354a43b0767301f57b30f14-6df82.png 200w,\n/static/2023-10-10-23-24-18-03180d50b354a43b0767301f57b30f14-9f3db.png 400w,\n/static/2023-10-10-23-24-18-03180d50b354a43b0767301f57b30f14-2c843.png 446w" data-sizes="(max-width: 446px) 100vw, 446px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>这三个步骤本来应该一次执行完才对，但是 Python 系统有可能在任意两步之间，把当前这条线程切换走，这就导致这条线程在切换回来后，看到的是个已经过时的 value 值，它把这个过时的值通过 setattr 赋给 Counter 对象的 count 属性，从而使统计出来的样本总数偏小。下面就来模拟线程受到干扰时的样子：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-10-23-24-49-d9c8f34cbe22ea3cefaa20ac1d845582-2fc19.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 454px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 57.268722466960355%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACAElEQVQozyVSiZKiMBTk/z/JqvUEOUcduQQCBBJuBBF1xmNmt62tolLJO7pf90NQk2rp0ZlFNFrIYbbhRy2pFFriLnp0eaDrKNsU3a4enPHx2Yybst+Up1113rdXQSJcDOjUDtZBuiuHXd6jZx0yLSkN3q48OtnaU9MT/cRsLjqrpYBKJNlWw2dzEXTWGu8QQ50c8s9qEP1UjnOVlhprP7LG4LUS58gCXWM1efz1b7/2+YFPwHhzN5yavkTYtjwbRSf6sUy4kdYGaxGfbJw/+wOa7dNDTau57S/cUGfNthwEmeSiT5cuwTBaWtmnuxIXq0O89BI0QMg27/btaPVfzvA4XH+c890e7u7lB08B8HKQQrlCCzFMFZqvfPjn6WmzzXowQD/EO+MLDsk0k+MChqlJCfME6FHjYk2YEmVikK6CZGaTuU0M1uzbC+yZucRIarMe14RPNvbKjeWQSUFqNtc3MyxZOKHkp1ibCXjCwQZEmZYoAorO24+8U5LiHQy5wZt9d3UvL0EKs4UZLNwI9qpg6G4SyaYWXImQwj6xFfN4e6u9vNDgjv/P59ttuK/FmRJxlebY8NyNMPbM9HblCUBixOYOASGM1PlxsnPwO+lJKfn0I+8FLMA63e3uG+5Z/bfZ3qzjl9V9o9odf6z+Dlp7eDqnpzM8cTeRQtnxiuc/twc6Nk9pBdgAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 10 23 24 49" title="" data-src="/static/2023-10-10-23-24-49-d9c8f34cbe22ea3cefaa20ac1d845582-2fc19.png" data-srcset="/static/2023-10-10-23-24-49-d9c8f34cbe22ea3cefaa20ac1d845582-a039b.png 200w,\n/static/2023-10-10-23-24-49-d9c8f34cbe22ea3cefaa20ac1d845582-a38f7.png 400w,\n/static/2023-10-10-23-24-49-d9c8f34cbe22ea3cefaa20ac1d845582-2fc19.png 454w" data-sizes="(max-width: 454px) 100vw, 454px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>线程 A 在执行了第一步之后，还没来得及执行第二步，就被线程 B 打断了。等到线程 B 把它的三个步骤执行完毕后，线程 A 才重新获得执行机会。这时，它并不知道 count 已经被线程 B 更新过了，它仍然以为自己在第一步里读取到的那个 value<em>a 是正确的，于是线程 A 就给 value</em>a 加 1 并将结果（也就是 result_a）赋给 count 属性。这实际上把线程 B 刚刚执行的那一次递增操作覆盖掉了。上面的传感器采样总数之所以出错，也正是这个原因所致。</p>\n<p>除了这个例子，其他形式的数据结构也会遇到类似问题。为了避免数据争用，Python 在内置的 threading 模块里提供了一套健壮的工具。其中最简单也最有用的是一个叫作 Lock 的类，它相当于互斥锁（mutex）。</p>\n<p>通过这样的锁，我们可以确保多条线程有秩序地访问 Counter 类的 count 属性，使得该属性不会遭到破坏，因为线程必须先获取到这把锁，然后才能操纵 count，而每次最多只能有一条线程获得该锁。下面，用 with 语句来实现加锁与解锁，这种写法使读者很容易就能看出受到保护的究竟是哪一段代码（参见第 66 条）。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-10-23-25-21-38100306501fa7fd8cc951bab67edc56-65498.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 409px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 69.19315403422983%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAIAAACgpqunAAAACXBIWXMAAAsSAAALEgHS3X78AAACPUlEQVQoz22S13biMBCG8/6PszdLGiGYZoNc5Ypt3Hu36RB2HLIXyck5Yx1J1if9/8w8EGt7JBtT3YfxTVAHCA8Q98SIxNpduskACYRizkyXdONXrD0yWKj2YnMWmxPEA64OfLHli51Q7rl8y6QNn3d81tFhJdZHOq74fAtn+r9Zy2XdHfuC75hQ7nB1xNUelhxEvhVgv9jBvf28Okjt+TMu32DKCgllQ6g2mzQjrL1wykx3/szRMy8/sxIsx+pmsQnl79h/2fVR6i6UE4+wuvRztfsgnfSRlVZBjosDkCNFH/Iy7WVyd5W3128wfKAHTDJRDYIJzXlXrLFmTw1/KOoT3WPDmrSjydqdmT7lJdIP+M7DrWB+rJiEtiG9iLTjIVYXViQWp6WbvmF1rFpzw/sF7qM9A0xIBtRmbvhz3R2y8ruoC5+i6KBQ9zcwKP728gUsAS/WJ6W9qmAPMlSf5ebSi+ouUnOG7IA64O8j7AN87D2nLfJTNu5fYOMKBTnpJXSY02G/XFgBE5VidZpvQspNVn5GhyUudn224WLkpoRkMnE90eyRpD8z8tMK/13yb6IGyl85BXk5iqpXXl0Y/oDiwdQqKO+yjyBS3d2gk2ZrB7KCwmxhByNZh4It7QSqPTcCaLj14abtb/rpBoeV3ceXZ9wcQUIf5V5uz5STEFBh2UReRmjWC68gv+CyBhppYrgDGk8Mh7TCB7G+/Aipu4KrlRujqOzNm/5Ud7i8ZZKKTVvazyk3pjY+E+T/ACiY4u4wjFGCAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 10 23 25 21" title="" data-src="/static/2023-10-10-23-25-21-38100306501fa7fd8cc951bab67edc56-65498.png" data-srcset="/static/2023-10-10-23-25-21-38100306501fa7fd8cc951bab67edc56-67408.png 200w,\n/static/2023-10-10-23-25-21-38100306501fa7fd8cc951bab67edc56-5cbc3.png 400w,\n/static/2023-10-10-23-25-21-38100306501fa7fd8cc951bab67edc56-65498.png 409w" data-sizes="(max-width: 409px) 100vw, 409px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>现在，就可以确保这些工作线程能够正确地递增 count 属性了。只不过这次的 Counter 对象要改用刚才写的 LockingCounter 类来制作。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-10-23-25-58-7b46c2f91f7c619df2391599a1b5c59f-72de5.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 648px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 72.0679012345679%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAIAAACgpqunAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACA0lEQVQoz31SiY6iQBTk//9oM5s4o3iACijXMKBII8gl2IB44CRTDROT3Z1sUum87n5X1Xuc6Kdj25+TRMsvghtNtwFvkbETTDaBsIvWWWNWD4O2RvkDOCUtlaRU80ant1VaK1mlJJWaX9Z5oxVXvWrN88OoW728/wtuGRzlmC6CTPAikST8hzdzQxnpisv62KyyepWdYZj1w6hao3qY9Wdvs2Dc4YHImXtYpdW8yzJ1g6HhjMztxCFvpjN830phju7gKcUnOT7BYMF62apFg87lhCJYik74Rju/ZX2gW3hfHorZLhpaO3yJfjKyyYS1RsGIM+rHIioG2seLpPGW+2upDjRL8BO4zvcpaMMBMM+frO3O6O2uMr1r9Ap51kXTn2CLP7Pzg4dGbz3+slkwpAJP3iEjy13sM9GLeJsM31mTxk8K/6E2xqBkNdQa2wTcIJUU5Cj+TP+/4FVWyXGpxBRiYiRMuYiqBYhccDInZPnG/dl8f+Vejc2LbKCs6MUjazfQ7FfdGVmekrJh9CJ9o7P15wvUhqRjh8xJPHODN3OD9cSqDHRb8A7L8IiZzXahSGKkVhI63yfyocAiCCSGKNw6rRjD0xVQT1ed4YaG2RXvxQXD1/JGPQJnJWWbixNkYXBTN4ROGLqEJUWpMF9GBUYwcXysLRYGKjAfN0I61nbPpcMXjy/raFIAPjEAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 10 23 25 58" title="" data-src="/static/2023-10-10-23-25-58-7b46c2f91f7c619df2391599a1b5c59f-72de5.png" data-srcset="/static/2023-10-10-23-25-58-7b46c2f91f7c619df2391599a1b5c59f-bb436.png 200w,\n/static/2023-10-10-23-25-58-7b46c2f91f7c619df2391599a1b5c59f-c5634.png 400w,\n/static/2023-10-10-23-25-58-7b46c2f91f7c619df2391599a1b5c59f-72de5.png 648w" data-sizes="(max-width: 648px) 100vw, 648px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>这样的结果才正是我们想要看到的。这说明 Lock 确实能够解决数据争用问题。</p>\n<h3 id="总结-50"><a href="#%E6%80%BB%E7%BB%93-50" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>虽然 Python 有全局解释器锁，但开发者还是得设法避免线程之间发生数据争用。</li>\n<li>把未经互斥锁保护的数据开放给多个线程去同时修改，可能导致这份数据的结构遭到破坏。</li>\n<li>可以利用 threading 内置模块之中的 Lock 类确保程序中的固定关系不会在多线程环境下受到干扰。</li>\n</ol>\n<h2 id="第-55-条：用-queue-来协调各线程之间的工作进度"><a href="#%E7%AC%AC-55-%E6%9D%A1%EF%BC%9A%E7%94%A8-queue-%E6%9D%A5%E5%8D%8F%E8%B0%83%E5%90%84%E7%BA%BF%E7%A8%8B%E4%B9%8B%E9%97%B4%E7%9A%84%E5%B7%A5%E4%BD%9C%E8%BF%9B%E5%BA%A6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 55 条：用 Queue 来协调各线程之间的工作进度</h2>\n<p>Python 程序如果要同时执行多项任务，而这些任务又分别针对同一种产品的不同环节，那么就有可能得在它们之间进行协调。比较有用的一种协调方式是把函数拼接成管道。</p>\n<p>这样的管道与生产线比较像。它可以按先后顺序划分成几个阶段，每个阶段都由相应的函数负责。程序会把未经加工的原料放在生产线（也就是管道）的起点，而那些函数，则分别关注着自己所负责的这一段，只要有产品来到当前环节，它就对这件产品做出相应的加工处理。如果所有函数都不会再收到有待加工的产品，那么整条生产线就可以关停。这套方案，很适合应对与阻塞式 I/O 或子进程有关的需求，因为我们很容易就能在 Python 程序里，平行地开启多个线程来分别负责生产线中的某个环节（参见第 53 条）。</p>\n<p>例如，要构建这样一套系统，让它持续从数码相机里获取照片，然后调整照片尺寸，最后把调整好的照片添加到网络相册之中。如果用管道来实现，那么这个管道就有三个环节。第一个环节是，从数码相机里下载新图像；第二个环节是，调整这些图像的尺寸；第三个环节是，把尺寸已经调整好的图像上传到网络相册里面。</p>\n<p>假如这三个环节所对应的 download、resize 与 upload 函数，现在都已经写好了，那么应该如何拼接成一条管道呢？</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-10-23-29-26-8efd191c48e5e10e199d882687c587e7-d5202.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 258px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 90.69767441860465%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAIAAADUsmlHAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACjUlEQVQ4y21TaW/aQBDl//+LqkrzoWnUKAcQICA3QSHE9x7GJKQi4fSB7wMb07E5E1V6Ws3M7lu/eZ4tKU6KDR/AjkxshLLmybqnOLE0d9mxqZghsSJxZgk5HLwIIIUtWffpIi5RN2mI+Lz5p/wk9pzkZ405uap+v6pePDxVOPGszvwoNy6Ydo0jTVm9vO98u6yctx7u0Iuk+yXsLAXd5cYLbATUS/mJBTE7XYi6K5vB08joDjVxYotTR7ZCbmqx77owMoW5g+w4JxM3UdyE2glylsgIQDwCtU4CdbhOcVPqJAA4Sd0idVPYgjQnYzsGGi6Q96P50BIUIYXrt3Di4uRycxIVuzkZbZMY764g+bql4d1pZEf7dIOcrHhZL8jAdmLFip+pwboXrKm36odrNcyIncCWGq5fIqhn1F2B5u2XoVuGDqrPUuUZgVpGGZS7YlPutXC/wqE6jxnlFdJbFl13+OtH7l79KxkBKSwogcL267gpKZ23EeSdt4+GQBjcbw+GVR61RPrwNuwOZ3WpX+kKtzxpDybgKDnIDjI1WlN/BXE/WA2i9SDIev5KLWTnhkMvEMd5O9AjuI0Phh0ZA/85/9VTG1nRvn7w/LOvpV0UHzv52eT4i8mfyOBePg+F7H28GQMIwHZQTorByAMvPZChJGoOP108vmtoEWIrFjXvcTiD8ZQMv/OhdccGO4F5tGEk2bHBz2xyRE4bHPnVYsrPUs9OfrfaJze1hkRPbxonN/XT2+YdUu9E5Rzql7WzWqsJT2LuFrrizXhGAHheAHgMguYqXgrjDTHYJpk+dZfICpEVgzTZDMlxz+gIoFk2AlH3tzMMq5vsd/Eu3ZIpuHIEpPlY94kefKn/F/8ANlzBVLCqydEAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 10 23 29 26" title="" data-src="/static/2023-10-10-23-29-26-8efd191c48e5e10e199d882687c587e7-d5202.png" data-srcset="/static/2023-10-10-23-29-26-8efd191c48e5e10e199d882687c587e7-e0eda.png 200w,\n/static/2023-10-10-23-29-26-8efd191c48e5e10e199d882687c587e7-d5202.png 258w" data-sizes="(max-width: 258px) 100vw, 258px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>首先，必须想办法表示每个环节所要加工的产品，并让加工好的产品能够为下一个环节所获取。这可以用线程安全的生产-消费队列（producer-consumer queue，也叫生产者-消费队列）来实现（线程安全的重要性参见第 54 条；deque 类的用法参见第 71 条）。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-10-23-30-14-fd0dccb1ec972953a193835cf8530c2b-59c7b.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 375px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 55.46666666666666%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsSAAALEgHS3X78AAAB+0lEQVQoz01SiZKaQBD1/38nW8luvFYF5b4ZQEBAYLlBLnXVaBqztZWqnqnumnlv+s3rEe3GjJ9z0UGMG9KJcdtn/Izap7SXEE7MR7WQNJQbs0HBh6Wc92s7JJ2E3qdyfhxRToRbAeklpBcvNJv0opXubCx/swunokZ5iVz0E1FbaDvajZQhN15p6Y1XuaQeYWaAGQ65CzfWx0zezhXzlRJnIoJciCpgGXMqbnpskHNhNZX1qWQoxWn7+UDtdSQXJz5thKyRsp5PWzau6CAV04YKMi45SHlPhzmf1pBAMFHJxZVcnpT6U20uI9RegEPv7lCgw1lrb8bxofV/jP6htVe1vaLuBjucDhe621A+8wFMOfFcMXDD4z/KN0b6gZEvJDcW5JlqadUFYECkQ3Q34P2GfYGV8iQVJzrIQTnlRmJck/sEM+wFstTyKOTdxhssWGoOE+TaswU0dPQEw9K6m5C17+oWpIIxGztc6A5muMQuIJxoZbgrbUd48dr2UXUGpFT0SnX+Ag8Bso93vb/jpg8OgXl8VK1N7yfBvasmOKTmx9+s/EIwv1hxIiA2KIff/hYg12fUXCk3mSvWauvBqGCmN5G2TFgKWQdWLXVnLKGl6XLxAdWX/17+95ntFQTj1p4Fe5Ia5gT6F7MWhgn8W24dzPLJfQRto6f4v9sGP35vzYvJAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 10 23 30 14" title="" data-src="/static/2023-10-10-23-30-14-fd0dccb1ec972953a193835cf8530c2b-59c7b.png" data-srcset="/static/2023-10-10-23-30-14-fd0dccb1ec972953a193835cf8530c2b-16d5b.png 200w,\n/static/2023-10-10-23-30-14-fd0dccb1ec972953a193835cf8530c2b-59c7b.png 375w" data-sizes="(max-width: 375px) 100vw, 375px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>首先定义 put 方法，让生产者（也就是数码相机）可以通过这个方法把新图像添加到 deque 的尾部。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-10-23-30-31-a2ed633177c7a6f1deff3f08cdf4770d-ae33f.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 391px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 22.25063938618926%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAIAAAABPYjBAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAA10lEQVQI102N206DQBRF+f/P8aXBaDWGEscytjA3oBMslGopQ7FzaWVojRN9MTnZWTs7WceLqjZuNaj2U5TN+CYs6iArQ17CWsx4fbtgQV7FnSFyINJiaYkaHfxVj+krO33DjwN4e38utuig7pY0XJWvWxHy+pHyaNOl5srMhakLlRb1Z5dUjVgO3q9joMoyPbr5iRT3MX2pGiea4nwClqDc+TG9CSMfIn+eON0DziYABvnaS4/2/+FWE3FKPwfafzlOGkWEWTRHuOuRMEho7D5352SvHPwAtmbR8zKdxW8AAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 10 23 30 31" title="" data-src="/static/2023-10-10-23-30-31-a2ed633177c7a6f1deff3f08cdf4770d-ae33f.png" data-srcset="/static/2023-10-10-23-30-31-a2ed633177c7a6f1deff3f08cdf4770d-12493.png 200w,\n/static/2023-10-10-23-30-31-a2ed633177c7a6f1deff3f08cdf4770d-ae33f.png 391w" data-sizes="(max-width: 391px) 100vw, 391px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>然后定义下面这个方法。第一阶段的消费者，也就是需要下载照片的那个函数，可以通过这个方法从 deque 的前端（即左侧）获取元素。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-10-23-30-50-f94780d9aebb7ec761fd68a092bb2b97-5751a.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 447px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 19.686800894854585%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAIAAAABPYjBAAAACXBIWXMAAAsSAAALEgHS3X78AAAAwElEQVQI132O2w6CMBBE+f9P0iDRmAoKYg13pYBQWrlj4UFF4/IDJudhMtnZGUlNOAqzJba3l9v2mioeAccbv4AjJvvx+oNk9U9EMsXytYjtY74JCCJUT8sdyXEhXPF2hw/gzGJyx8/MMDnD/FcC1yx6gzUm6xGB8mSfFGpIFduHLWYh9Lw5sgbXg8HbA60Ag7XHe2f1EH68IQ8jcTmqhEK/FvNDVqMr1RIQlYyDFfbVmC1OjnwO1l6EQgqXdvf6Afxu0pOyVFNQAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 10 23 30 50" title="" data-src="/static/2023-10-10-23-30-50-f94780d9aebb7ec761fd68a092bb2b97-5751a.png" data-srcset="/static/2023-10-10-23-30-50-f94780d9aebb7ec761fd68a092bb2b97-a742c.png 200w,\n/static/2023-10-10-23-30-50-f94780d9aebb7ec761fd68a092bb2b97-4517e.png 400w,\n/static/2023-10-10-23-30-50-f94780d9aebb7ec761fd68a092bb2b97-5751a.png 447w" data-sizes="(max-width: 447px) 100vw, 447px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>我们把管道的每个阶段都表示成一条 Python 线程，它会从刚才那样的队列中取出有待处理的产品，并交给对应的函数去处理，接着再把处理结果放到下一个队列之中。另外，我们再添加两个字段，分别记录这条线程向上游队列查询产品的次数以及完成加工的次数。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-10-23-31-43-6305ccc767a8ed3f7d3622739bfc543d-82fb5.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 638px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 47.02194357366772%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABYElEQVQoz2VRa2+CQBDk//+ifqkaEHkJCspL3hzI8RbBGhWbLmib1iYbssftzOzNEJyfUKY/t8OJYr7LJu0g1tvTu0BKKtpCpO6u0kbrevV4UY/XlyLgjg/xOm+FqBTjyjh9wqh+umvtbcQMQ9vmAqV+1/MIYDnv5KJV8lZMylV6EKJCwpUQ5Zv6/IN/0nU9/NGh73pjZCdAc4kKSnMYN57p7twKFk70tpSlpBaTio9ypfzgUc4EGHhhmEMZj7KFn0i4Jh7cctGBOOvGrBev02YBjY/ZEHMBVpurhA9CXIi4lssTfEfSAiDE+KqL3t35MJ0bHm2FjButcEOaPuPuteMNnjds+3fthykjeLzmw4w0PQAwTjzdWpyP5ayFfqbZ4PmmOg+Gvxj2UNbaXkAZbQXULiQNd7LZgbKUHGg7gl2mmgMWgsBLYL/BOcRLGmAYIg0PwqdtpAxZdOPC/f+cvwCLIt3V2zM2CAAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 10 23 31 43" title="" data-src="/static/2023-10-10-23-31-43-6305ccc767a8ed3f7d3622739bfc543d-82fb5.png" data-srcset="/static/2023-10-10-23-31-43-6305ccc767a8ed3f7d3622739bfc543d-38c7c.png 200w,\n/static/2023-10-10-23-31-43-6305ccc767a8ed3f7d3622739bfc543d-c00bc.png 400w,\n/static/2023-10-10-23-31-43-6305ccc767a8ed3f7d3622739bfc543d-82fb5.png 638w" data-sizes="(max-width: 638px) 100vw, 638px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>最难处理的地方在于，如果上游环节的速度比较慢，导致它不能及时把加工过的产品添加到本环节的输入队列里面，那么输入队列就有可能出现空白，使得当前环节暂时获取不到有待加工的产品。下面我们试着通过捕捉 IndexError 来处理这种上游发生延迟的情况。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-10-23-32-18-86a07fd74d5520d7986b6996ed4baf96-b1c4a.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 562px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 54.98220640569396%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsSAAALEgHS3X78AAABhklEQVQoz21RB2+CQBjl//+kNmktQwEXyBBFNiejgCxBxSb9DjpobPICdxxvfO8IWndWKJ0aLnPAmJlILa5KeVPgOYJa3h5BbLJmHReUZvNOuEAJrbtCXKr1Xak6tbpjFbzo8OIBBBxI+UUpbkuUMbpH711Ks/oUHmN4sBDfq3VUCmn9KEEMr239IYYFZwViUkunVspbKWs2SS0mZxnHxv/05Ks8DDUm47MCj8F7yatmQvIFSknN5P2Y86KJZlJ7GyaCghZe/JcMfVTdOipYE011h3XCiXp42exweMMTwnyTnvsUOJR8apW89y+uv85yfoGorBuSmgXyb1tzIuucE7JWIMDY4Ym1jkuUMAcfep2jZGr4I+e44OxgecxAAuN0wYZpA+i37bCFduUe8GXk3CfhnZhUTVCRswb6A/mll1Bba2YgSMToLtC+KFVHjKuH652a/pticE5AQUk761ncgsRAI3c2VMC70T9t95dxBwfoibWDiarTuv20kuZuJEQl1Cn9eH7jE7FrSR1BGTn9AAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 10 23 32 18" title="" data-src="/static/2023-10-10-23-32-18-86a07fd74d5520d7986b6996ed4baf96-b1c4a.png" data-srcset="/static/2023-10-10-23-32-18-86a07fd74d5520d7986b6996ed4baf96-3ced9.png 200w,\n/static/2023-10-10-23-32-18-86a07fd74d5520d7986b6996ed4baf96-4c4f5.png 400w,\n/static/2023-10-10-23-32-18-86a07fd74d5520d7986b6996ed4baf96-b1c4a.png 562w" data-sizes="(max-width: 562px) 100vw, 562px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>现在，创建四个队列，并在它们之间安排三条工作线程，让每条线程都从上游队列里面获取元素，并把加工过的元素放到下游队列之中。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-10-23-32-58-05ac538274e85e11093fd58845104e5d-dd087.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 637px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 40.031397174254316%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAA7DAAAOwwHHb6hkAAABVUlEQVQY021Q2XKCQBDk/z8piXIoloKBcO3igpyKci2HgBWjSQbNQx6s6ppqpobe7mY4yxWwPyeh6IQC9tZxLsf51CDAF25sFD06faH28hSM6MQTYwM/v2oYVNRD/abZE51MdKwkJTpdrfbTai9Pwcw2vkCC+SYAiVVwlMLsRUWs6Qi2r+UnuDCbzwce3Pr3ybAmmVoOj7bLIDXpWdrlCz8B52rW2sM36q64u9r9DQhcAwcvuLvh4QacUdJ6RkJ4R4rSZXBQkkqOCzVtlEMlRRlUoOypFKbKsTbK4X1fqmkNEzbrhDL28CPvS9YiYBUijIaxJ0fZWKTtccjlTAca4bE3d8KpRTi8hTqXEcg1DJS5ilMwzyNPdCIOEdGN5V3x0II4cKoklL+LwpI1CISCRKPtj6wx24tOz0Z11umg0x7mHy97gFb2RjWMSzpoRQcT+jfv5f0CMVSh+//6uIYAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 10 23 32 58" title="" data-src="/static/2023-10-10-23-32-58-05ac538274e85e11093fd58845104e5d-dd087.png" data-srcset="/static/2023-10-10-23-32-58-05ac538274e85e11093fd58845104e5d-345b3.png 200w,\n/static/2023-10-10-23-32-58-05ac538274e85e11093fd58845104e5d-9cd4a.png 400w,\n/static/2023-10-10-23-32-58-05ac538274e85e11093fd58845104e5d-dd087.png 637w" data-sizes="(max-width: 637px) 100vw, 637px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>启动这些线程，然后给管道第一环节填入一大批原材料。笔者在这里采用普通的 object 实例模拟 download 函数所要下载的真实数据。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-10-23-33-11-302cf6e1738f71c39ea1927e5b3f6039-bed19.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 416px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 36.05769230769231%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABQUlEQVQY02WQyXKCQBRF+f8/SioqURAZVGRqaBBooJEhYACBqKBpXWRhqs7iLO6tW+9R6yAVUKJkDWMHgn/gnGiDi132LScVA30eJQvL4z2slb1RX16g1odCCPNdVs80mwbu+0YTUCbhLzHKaWM/t7ypDjk/VspOry8vUEYzgO62zaqZ5jCmN1GM5T5kYDDVLdYJeIT15mp2t//NRxm0IzgNJAGa0WxHg8hpBO3NJHR3IiSg1RetOuuEv+bTKT48rFxsVGft+0fCpVr2QpiKUcL7MedhFqI58JSiJQOgGYzTk8fAoNdXapdWEi7ktF75CefGIkpZGLCWt7B8IgxEBCnKt8lRTis5r+W8UvNmE5fqsSc3X63+LsXFm6TSYP9puh9bsLSDiQqnClxAxLqYNpw5cFkbkXcs3VAM05kO5az+BdmCcMMaSphsAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 10 23 33 11" title="" data-src="/static/2023-10-10-23-33-11-302cf6e1738f71c39ea1927e5b3f6039-bed19.png" data-srcset="/static/2023-10-10-23-33-11-302cf6e1738f71c39ea1927e5b3f6039-3bbab.png 200w,\n/static/2023-10-10-23-33-11-302cf6e1738f71c39ea1927e5b3f6039-35132.png 400w,\n/static/2023-10-10-23-33-11-302cf6e1738f71c39ea1927e5b3f6039-bed19.png 416w" data-sizes="(max-width: 416px) 100vw, 416px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>反复查询最后那个队列（也就是 done_queue）里的元素数量，如果这个数量与一开始的原材料数量相同，那就说明整条管道已经把所有产品全都加工好了。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-10-23-33-25-8ead32b4d124c67c96c7f777d7396c95-92c75.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 496px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 20.362903225806452%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAIAAAABPYjBAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAA00lEQVQI1yWObWuDMACE/f9/aW8wWI1Zrc5aY7dZE5sXTVQaTYvMRhY3eDju7sNxHiRNyNq0NYkad7yDWGxpG4kLrGTIuqQz72fln0TSGjTMIVUQ80M/Ha9Lbu5eUMkta0HJ/YL5BX36QM9J/pJ+PsTo7YiDkj+6Zv+1ObGASFCw1+wbEhk3QyS1h25LqqeQ9rBSu1pvCgowd3MBruP6ArAAROy7m48beFaRGABZzXqn5N5B/zjSfkJ6RqPNrwsyFo333NhsVReXbJidcfw1Fv0z2l9siNMU6a1CqwAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 10 23 33 25" title="" data-src="/static/2023-10-10-23-33-25-8ead32b4d124c67c96c7f777d7396c95-92c75.png" data-srcset="/static/2023-10-10-23-33-25-8ead32b4d124c67c96c7f777d7396c95-49810.png 200w,\n/static/2023-10-10-23-33-25-8ead32b4d124c67c96c7f777d7396c95-1554f.png 400w,\n/static/2023-10-10-23-33-25-8ead32b4d124c67c96c7f777d7396c95-92c75.png 496w" data-sizes="(max-width: 496px) 100vw, 496px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>这样写是可以正常运行的，然而有一个现象值得注意，就是每条工作线程都要频繁查询上游队列里面有没有来新的产品。为什么必须这样做呢？因为我们要解决刚才提到的那个难点，也就是上游环节的加工速度可能比本环节慢。为此，必须在 run 方法里捕获 IndexError 异常，以便正确处理这种情况。可以看到，查询的总次数很多：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-10-23-34-28-b6334857e33b1c46f3380f8415503630-a8ef3.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 566px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 32.50883392226148%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABTUlEQVQY0yVQ2XKCQBDk/z8pUUQ5BAzKzeICy41YXAGExGgqg6nqhzl7uoficAxgLE/JG6OZxKjgvWhtuGJY7FDIupGSV5y3DMjJ1R4e9vDjjA80/aLbk9o6ZK26h7RS0lrAiRReGMdbGQ5jYe4cv6uOSPI9yQQ/VcvheOk+kor30q0dbCxMyUnJ4xh29n62QwRUsCiQ45I7h7yfsIhskQ83T3lDm3hPin+ZcnTVyp4yuy+tGoFM8FJgYc8hKOdcwuOIsb1jXvM4AVLQpWSN0c56M+n1ZPd3EE9Z/R2ND8j1+ma9iLR61KrBbGe16q3Pb5iGwGxmu1/cOrenPS7OAdSx7IzuC2C+5oxuNl8pkBrdUoFgabUT1AFqPcJ9o52gRYEr+A2tIYkUb4oJCqWoWKnOPixYN9ih4JBUtIWFIN2YWAoyWndFAg9K1yf7D4dma34mlFJjAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 10 23 34 28" title="" data-src="/static/2023-10-10-23-34-28-b6334857e33b1c46f3380f8415503630-a8ef3.png" data-srcset="/static/2023-10-10-23-34-28-b6334857e33b1c46f3380f8415503630-38d6b.png 200w,\n/static/2023-10-10-23-34-28-b6334857e33b1c46f3380f8415503630-f4d06.png 400w,\n/static/2023-10-10-23-34-28-b6334857e33b1c46f3380f8415503630-a8ef3.png 566w" data-sizes="(max-width: 566px) 100vw, 566px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>由于每个环节的加工速度可能不太一样，因此下游环节或许会遇到暂时没有产品可以加工的情况，这会拖延管道的总进度。下游环节必须频繁查询上游队列，才能尽快发现并获取到自己所要加工的产品。这相当于是在浪费 CPU 资源，因为在这种情况下，这些线程只是在触发并捕获 IndexError，而没有做实际的工作。</p>\n<p>这种实现方式的问题远不止这一个，还有另外三个问题也必须重视。</p>\n<p>第一，为了判断全部产品是否加工完毕，必须像 Worker 线程里的 run 方法那样，反复查询最后那个队列，以确认里面的元素个数是否已经变得与刚开始的原料总数相同。</p>\n<p>第二，目前这种方案会使 run 方法陷入无限循环，我们没办法明确通知线程何时应该退出。</p>\n<p>第三，如果下游环节的处理速度过慢，那么程序随时都有可能崩溃，这是最严重的问题。例如，如果第一个环节处理得很快，而第二个环节处理得比较慢，那么连接这两个环节的那个队列就会迅速膨胀，因为它里面堆积了大量的产品等着第二个环节来加工，可是第二个环节又跟不上节奏。时间久了，数据会越积越多，导致程序因为耗尽内存而崩溃。</p>\n<p>总之，这种需求不适合用管道来实现，因为很难构建出良好的生产-消费队列。所以，别再跟这个方案较劲了。改用 Queue 来实现内置的 queue 模块里有个 Queue 类，它提供了解决上述问题所需的所有功能。</p>\n<h3 id="改用-queue-来实现"><a href="#%E6%94%B9%E7%94%A8-queue-%E6%9D%A5%E5%AE%9E%E7%8E%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>改用 Queue 来实现</h3>\n<p>内置的 queue 模块里有个 Queue 类，它提供了解决上述问题所需的所有功能。</p>\n<p>改用 Queue 之后，就不用再频繁查询是否有新产品要加工了，因为它的 get 方法会一直阻塞在那里，直至有新数据返回为止。例如，我们可以启动这样一条消费线程，以等待队列里面出现新的输入数据：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-10-23-36-19-84b45c5d76844e21a292245d683c6124-61246.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 712px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 42.13483146067416%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAAsSAAALEgHS3X78AAABHklEQVQY04VQ226CQBTk//+paWwrREBgAaG2SETut+W2qC2YdJDyZtNkMtnNzsyZPZyaNtu4kmOql70UFgApmdWNu/b7X3BKUolBLkfUqC5wikGh0zPMVjcAk6j5mmGCl6t5ByeH5TaivBu97I8bLyZFhxS0IAUDm/XVYqPNboiz2bjwMDEbOYShNv/pv74f146/shzRS9SkRqgc5np5JmWPdIRuY6plrZI0YFhw4BCgJLVwCN4+fs1SkOMveDarq93ftKKTggIGOSrnBalZgzgcpsnoBp1BLwbttbQhWUeyFmr0xxMEiLDY8KA2fwif9L3k55tT+rxzcAUENxK9dD3VOZG8m/f0YGGin69sF2rB8UUvnqouq54mzAv/Az9qz60CMpo8IwAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 10 23 36 19" title="" data-src="/static/2023-10-10-23-36-19-84b45c5d76844e21a292245d683c6124-61246.png" data-srcset="/static/2023-10-10-23-36-19-84b45c5d76844e21a292245d683c6124-ec172.png 200w,\n/static/2023-10-10-23-36-19-84b45c5d76844e21a292245d683c6124-770e4.png 400w,\n/static/2023-10-10-23-36-19-84b45c5d76844e21a292245d683c6124-61246.png 712w" data-sizes="(max-width: 712px) 100vw, 712px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>即便这个线程先启动，也没有关系，因为只有当生产线程通过 Queue 实例的 put 方法给队列里面填入新数据之后，刚才那个 get 方法才有数据可以返回。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-10-23-36-41-aa9f9dd10f3ddb02bb82c625138e4c31-83c29.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 722px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 36.14958448753463%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAAsSAAALEgHS3X78AAAA90lEQVQY05VP226CQBTc//+kPjRtURCwtOUuCuwFcOmKgrCkiiTuUuNDk6ZpMpmc3ZyZOQMMUpqIGnCrrrEWZ0vC9LRYJLlFD97x7DUne8ftXWdX/IO1TtVP8zdzoMZ4FiFlBZ+DRImgtslmK2gS5jVnIXbrL4vWJvlc5pWOtlax11H5VjaCDcKAlk6ZSfESQgOXzqF/Z0ehEZkyWaAdgu7id5eAj34n5tFvB3/6Aa9F5ex7mVPLbbnRDjfZHdLodLOb2G3kE8w38uwFpOJUNc50RH8qfwcQbR/tUEvy+RqLzsLlP+IwfbBcJUJPXqxEOOSje2/7F65u33aZMN0wOQAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 10 23 36 41" title="" data-src="/static/2023-10-10-23-36-41-aa9f9dd10f3ddb02bb82c625138e4c31-83c29.png" data-srcset="/static/2023-10-10-23-36-41-aa9f9dd10f3ddb02bb82c625138e4c31-5b578.png 200w,\n/static/2023-10-10-23-36-41-aa9f9dd10f3ddb02bb82c625138e4c31-4dff0.png 400w,\n/static/2023-10-10-23-36-41-aa9f9dd10f3ddb02bb82c625138e4c31-83c29.png 722w" data-sizes="(max-width: 722px) 100vw, 722px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>为了解决因下游环节速度过慢而造成的管道拥堵问题，我们可以限定 Queue 最多只能堆积多少个元素。如果通过 put 方法给已经填满的队列添加新元素，那么这个方法就会阻塞，直到队列里有空位为止。下面我们创建最多只能保存一个元素的队列，并且定义这样一条消费线程，让它先等待一段时间，然后再从队列中获取元素，这样就促使生产线程没办法立刻给队列中添加新元素。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-10-23-37-12-706aa20e6f1c4a171fb8b38e319e9df5-0bb1c.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 628px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 51.59235668789809%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAAsSAAALEgHS3X78AAABjUlEQVQoz21Si3KCMBDk/z+qPrBQLfJQXgoCgijEIIaHVqtON9p22k5nbjKZu+zt3l4EnVT6ttJprRKmkWpaHuz63UJU5++wEc3Faa68xE4mO1k1zwujhGjZvmf5orvsTOeyH2v5fkLbn2AAdMLAYbKz016d5vLIC+7hNt0dutZC8hPRjZ5MT3RDdVM67e3BDzY86DtBz/a1zV5ZF68pnZZHVAXUoFZepAMvFufRsxf37YWy3r0mRM8YVHCR7GTQWsuZQRuUxpuduX/jzADrHLwCs+Qh4q41V7PS2NZmcQAnHpnlcbQkozjHgMNlpvxkRj/ZT+QgHcyjwSzE/EpChtFmnBZqtuPM1RlGGkVrlm94PEHHe1LA9Cio60LlUinagx93KVi9hBmc+zT5Pvzn+bULAZ102kCeyS2tJrSBBTqpOQNtcdHyytg2Fjv/8v8BHvhJx+Z7UlZFx/Z6ToCp5GAlBevhMpfDVPRi6Ler/8DDJO/PImCeF4k4C6Ugddubw7/E5fExsFj7a7F/4gPWexT5TiP8AwAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 10 23 37 12" title="" data-src="/static/2023-10-10-23-37-12-706aa20e6f1c4a171fb8b38e319e9df5-0bb1c.png" data-srcset="/static/2023-10-10-23-37-12-706aa20e6f1c4a171fb8b38e319e9df5-17261.png 200w,\n/static/2023-10-10-23-37-12-706aa20e6f1c4a171fb8b38e319e9df5-44202.png 400w,\n/static/2023-10-10-23-37-12-706aa20e6f1c4a171fb8b38e319e9df5-0bb1c.png 628w" data-sizes="(max-width: 628px) 100vw, 628px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>编写 time.sleep(0.1)这条语句，是想故意让消费线程慢下来，以免生产线程在第二次调用 put 方法时，它第一次放进去的那个元素还没来得及被消费线程提取走。Queue 的容量为 1，所以生产线程会阻塞在第二个 put 方法这里，它必须等消费线程通过 get 方法把队列中的那个元素取走，才能继续往里面添加新元素。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-10-23-37-56-b6aa8cd0a6ade3067c6c1a500974fc14-aee79.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 563px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 65.0088809946714%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAAAsSAAALEgHS3X78AAABf0lEQVQoz42RaW+CQBCG+f8/yA+tVkTkVETk0AWWY4EFpKh4tNa26XjEL01akslmMuHZZ5mXkeOcW+KegQaOz3vxwMECiiWcqqTgUaivdvbubG5PcE6LrRjQkUdUsgJKinJGo7Xkp4KfyGEuuAD7ckTVKFdCqpJKo2vArOYDyty8z9dHoz5emzdoGDkueDfqmS6PItFPABZdIuNsTMoRimbV3WxdzVJIQaMmlRSAL2V0GOFUwlSNy+Ey4BxXjjIlLEQvAfOUbh5maC4XQQ+Ty/DMTNJXeK3gEyUuuWXA2p5KynFSCZd/K+Gd8NEN/l3MOKtHXsyhQAwzMUhFnM2qg70/P4R/FKNXe1jp4vht7z6dwxeU3fyP3WGFlH0TsQ6GRiEVhDFbNW1hOS5Zy+vqNr+EbaeDBZ7mW7u9+WW+eNZtyEDA6RCFE1q3NcNi+wbqGQspyAHuGuiWbVsz5wSs40PoSpSDXys2VnNqBUM8T5N5R9FYEw0d3JE1vWxamn8As/yzEzE3Cj0AAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 10 23 37 56" title="" data-src="/static/2023-10-10-23-37-56-b6aa8cd0a6ade3067c6c1a500974fc14-aee79.png" data-srcset="/static/2023-10-10-23-37-56-b6aa8cd0a6ade3067c6c1a500974fc14-b3674.png 200w,\n/static/2023-10-10-23-37-56-b6aa8cd0a6ade3067c6c1a500974fc14-2063d.png 400w,\n/static/2023-10-10-23-37-56-b6aa8cd0a6ade3067c6c1a500974fc14-aee79.png 563w" data-sizes="(max-width: 563px) 100vw, 563px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>Queue 类还可以通过 <code class="language-text">task_done</code> 方法告诉程序它已经把其中一个元素处理完了。这样的话，就不用像早前对待 <code class="language-text">done_queue</code> 那样，反复查询生产线末端的那个队列了，因为我们可以通过配套的 join 方法确认这个队列中的所有元素都已经处理完毕。下面我们定义一个消费线程，令它在处理完一个元素之后，调用 <code class="language-text">task_done</code> 方法。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-10-23-38-52-13cb3fd4af49d5a140ba4983d00d8260-08a78.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 574px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 56.09756097560976%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsSAAALEgHS3X78AAAB20lEQVQoz2VSaZOiMBTk//+jrXXG2fUAUS7BCCIoVzjlEFB0HGcbnG9b1ZV6lbx0d/qF4Y70QzN/idqY7FdeNpK3I9Vgbarml237RepP0jywbs73/8HwXizSnPeSmem8q8Z05ypxpZVXrezWeQsKJavXWYtWUj+2zVfP1aDowYB+U94WR8q7sUBPczuYmu5YNbhjODEOnO3jSKCFVt2UUytGxTqrlayR07MUlwwo1aKbGM7iEApBwR3C6R6Xd/O9N9bMyc6R4krJWq28iWExt4KllwBgZO2A2dSf8LZyI9by5/tgZvoT3WKtQE7OSz8Vggx9Ii021R0+9csTTgEUevvslbWik6Jy4adLL4XDJT2R833bPvuOAaQZAqtuCAL+f1B2zGtXTRtSXtXigsfAiBRVWn4V4xIPk9P6lW0fGGSHqEjTD2JQzi+cFcxN9y+xJsbxz2b/rugoRhKZ7hxwDVIdHs87CVYhLDAgJamZYQCPddbwfsIeQzmppaQChDBf+pmaX43r9+D8ge7XRISoxClCYVY0Z50Iu/r5AcqFG/NOyHsp50S4DAX2QBHywo2g3wf2Y7v/OczMCn7L5G2t43t9EPtN0Tk7wFTgAhQo4AhEK3p65YSAXhGg/geHsEcEz1Oz3wAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 10 23 38 52" title="" data-src="/static/2023-10-10-23-38-52-13cb3fd4af49d5a140ba4983d00d8260-08a78.png" data-srcset="/static/2023-10-10-23-38-52-13cb3fd4af49d5a140ba4983d00d8260-683d3.png 200w,\n/static/2023-10-10-23-38-52-13cb3fd4af49d5a140ba4983d00d8260-6bdc6.png 400w,\n/static/2023-10-10-23-38-52-13cb3fd4af49d5a140ba4983d00d8260-08a78.png 574w" data-sizes="(max-width: 574px) 100vw, 574px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>有了这个方法，就不用反复查询队列中的数据有没有处理完了，而是只需在 Queue 实例上面调用 join 就行。即便队列中的元素已经全部取走，只要 <code class="language-text">task_done</code> 方法的执行次数不足，join 就会卡住，直到早前加入队列的每个元素都调用一次 <code class="language-text">task_done</code> 方法为止。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-10-23-39-24-a64ec154d33758b0c0ae1e7f5beba46d-c347e.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 555px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 67.92792792792793%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAIAAACgpqunAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABqUlEQVQoz5WS6XLiMBCE/f7PtAQWXzgJ4Ev4lG9b2DE2NiZcSVUayP7dkKop1ZQ033RLI27ONnPWvGa16KeiH78k1bxoRJoqMRP9BEer3cXsTlgR1v6T3JPhk/RnjvfikWELbsI7yXjli24sB7kU5IIXq1WPiju5yFvRTVG2KFo5KJRojX1OiYpZXMxCNrWCqU2ViD3HpeBEMk3RZVFtQaIF2Z7M7dFoDqQ7XfP2iH1uFrEJ8WTK0Iy3AwBG8076E4q0t53RIj+jbs5aKchwiosINIUYbsdJAbJMohlvhzfB/CWvRZrNkvJu+Crbn43tUasHrUK7g/q20+sBCSc4MQzD6mTl/yX+suz15rCsOm0zAL6T33F7qquR4ZbAtrrulusOzdDYqPer69mHhfin+Z/glmUHBbgyu7PWvKubPfz8iH3D8DxSLZHmcljwXgTzUphD/CH4j25PiC+HTAyyqRP+Dh7pztj08CskmvNONCYuXFgPwgBGug0YQ8IVMDC4eFR5aodPuiOFheAlY8PTN3vSXx59sCfDxXiVqMS/nZiujmntPm78z/EFRLbpvdUFv+IAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 10 23 39 24" title="" data-src="/static/2023-10-10-23-39-24-a64ec154d33758b0c0ae1e7f5beba46d-c347e.png" data-srcset="/static/2023-10-10-23-39-24-a64ec154d33758b0c0ae1e7f5beba46d-58c7f.png 200w,\n/static/2023-10-10-23-39-24-a64ec154d33758b0c0ae1e7f5beba46d-5d49f.png 400w,\n/static/2023-10-10-23-39-24-a64ec154d33758b0c0ae1e7f5beba46d-c347e.png 555w" data-sizes="(max-width: 555px) 100vw, 555px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>现在，我们把这些特性结合起来，构建这样一个 Queue 子类，这个子类还需要判断工作线程何时应该彻底结束任务。为了实现这项功能，我们定义 close 方法，让它把特殊的标志元素（sentinel item）放入队列，用以表示这个元素之后不会再有新的数据需要加工了。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-10-23-40-18-f3f4effec2ce0d257e2e9b1c7cf4bafe-4e69e.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 401px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 35.910224438902745%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABVElEQVQY01WQaW+CQBRF/f8/pl/bWiJTyyKuDM7CMgi4IEbQICAKCh380KTJS2byZs65ye3Nw7Nk+6q3hceL5AaKswbYAZQJOvmYGoC4ADkisvuQdHvsaP6BZDW+VHx6xrGAUTryIhEzwSADiN8klbsm2/jH9AFmALsqC76WZGh6s22iRyl5kR2Ms4oWT3wqBcP8pq662vYhne3iZVLyf+Ngr3nhPDppm/18f7au7V/sC34dJH+wqrVvrXVtukvZWkVjla1ZNOa14XbOkKzC6R2l938wf4DHXFzaYz9ahKch9STLl+1AttcyCwaIkfON5DXNn9zCdbRoeBinXslZjZKrFkQwLqZhLEBTxI7MNkPMxusDoKvRKoSHTA32I3+neKHi7aZhApO8h9O6m8uD5g13S+5GWFBeoYjcT51oftifI8XZTNbxl44Bsnmv77MlIIz38guqeG00txMVGAAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 10 23 40 18" title="" data-src="/static/2023-10-10-23-40-18-f3f4effec2ce0d257e2e9b1c7cf4bafe-4e69e.png" data-srcset="/static/2023-10-10-23-40-18-f3f4effec2ce0d257e2e9b1c7cf4bafe-c99eb.png 200w,\n/static/2023-10-10-23-40-18-f3f4effec2ce0d257e2e9b1c7cf4bafe-66047.png 400w,\n/static/2023-10-10-23-40-18-f3f4effec2ce0d257e2e9b1c7cf4bafe-4e69e.png 401w" data-sizes="(max-width: 401px) 100vw, 401px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>然后，为这种队列定义迭代器，令这个迭代器在发现标志元素之后，停止迭代。我们还需要在 <code class="language-text">__iter__</code> 方法（参见第 31 条）里面适时地调用 <code class="language-text">task_done</code>，用以追踪队列的工作进度。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-10-23-41-48-137c4b7cb21b356612afdc1a65563bea-0bb1c.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 628px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 40.60509554140127%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAA7DAAAOwwHHb6hkAAABLklEQVQY032QaW+CQBBA+f9/qekXrQKCHMphqxwFFhaWczmKgqaDRtsmbZPJJrO78+bNMLwdKjGVomJpo3VUrFw837kqaYx60Onp/2C2eackFesgzgn594i7sjZ5p5X9tvjQq6N2j1+KoQM8wCn6ZGbam6zlPCwGZP7mCl4C92Yzms3ZbM86Hb5AVxZzY8APBVciyrZZK+MKtIGiEqqmjZLWEi7WOAeXXXcBkNGMxkQcmYfDpFD2UMM60cvegwKYZXkInjevM9N6kjRQE4NUCgslqeWolBPK/BzjqBAqBIS10GLvqRmsg65RBkQ5LtWk4b0YUjmu5DAHQebRFhLOxZyFQB4WJob5feBRr4dJFdL2D2296AHP2oh3o5WfCD5ZHHzWCdW0NuD1tqTvQU+fljCtwKuSusgAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 10 23 41 48" title="" data-src="/static/2023-10-10-23-41-48-137c4b7cb21b356612afdc1a65563bea-0bb1c.png" data-srcset="/static/2023-10-10-23-41-48-137c4b7cb21b356612afdc1a65563bea-17261.png 200w,\n/static/2023-10-10-23-41-48-137c4b7cb21b356612afdc1a65563bea-44202.png 400w,\n/static/2023-10-10-23-41-48-137c4b7cb21b356612afdc1a65563bea-0bb1c.png 628w" data-sizes="(max-width: 628px) 100vw, 628px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>把 ClosableQueue 类写好之后，我们来重新定义工作线程。这次我们通过 for 循环来迭代队列，只要队列里的元素用尽，线程就可以退出。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-10-23-42-25-a86839aa0c6873d13b85e4ebd75713d2-f4a80.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 631px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 48.49445324881142%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABl0lEQVQoz21RaXOCMBD1//+efulMrQcqchQqhAQMhwElWEBQ8D7aVdvO9JjZSTaZvH1HGtIkkdm8Ywctk3Yd1rbcHg2hBIf1HNYlPip3eHlA5d5aHqyvFS6haWi8GHhTLSn7lA39KQzq2r4YxOosaxNXiws5TAXKOk6gzctBEIsBbxO/70av6aphrQ6kPqnTfOBGUhDL7A0AMEiacI0v7PqCq6NZbM1ih5Z7s9wBJxw/meGKrM+iH3eJN2RJG3v6TUvPDY3FWk9Xelrh6mRVR6C5VnXAX/0NXJ9EfybYvhqlIK9pOOAZ5du+Fz4j2jRsdZbjO/Jn3WRvLuBc5yUIVqYZmAQhRl4DRomy4YRLAb/q/As2slqJ5qO0UqJUjXM5fAMSZ/tOqiOpz/b6Ar29uVj/MoOxUVbDbJFGwu1v9KSEzIeMv/AFpNCnIcQJPsHgbzC+MpwgQLzci97sGY3NbAOve2OmhPMn0xHGrGN5Eksg11/4xn27Di62zZHdQi7gO8R/EF9aiD7puIXpo44eNSRH6XfO9/oAa3cPyd1pSlgAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 10 23 42 25" title="" data-src="/static/2023-10-10-23-42-25-a86839aa0c6873d13b85e4ebd75713d2-f4a80.png" data-srcset="/static/2023-10-10-23-42-25-a86839aa0c6873d13b85e4ebd75713d2-0de09.png 200w,\n/static/2023-10-10-23-42-25-a86839aa0c6873d13b85e4ebd75713d2-e7891.png 400w,\n/static/2023-10-10-23-42-25-a86839aa0c6873d13b85e4ebd75713d2-f4a80.png 631w" data-sizes="(max-width: 631px) 100vw, 631px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>现在用刚定义好的这个线程类重新创建一组工作线程。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-10-23-42-43-11fbf14d8c0b7aff1c501ce7f4948df2-eac6d.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 759px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 33.992094861660085%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAAsSAAALEgHS3X78AAABKUlEQVQY031RXXOCMBDk//+kWgUNOKJVCCEYEgwm6AihrQLO+NE+9Ki+tjM3mbubvdvdi4WE9rICCeVmRVh3bqYnaT5eS2ct54WJT1fa3v8Ka5xsJkzaMZ9r46uDTcUQJ6MoHZF0WR6T7vu/YeCBSeB/2314mYIZO+KveO1t9nFzTbqvJ/SRwPuIti8th4pZfsBlg9/PYd3iug1NH+TzQps7OV5gRdzcQH/S3cmvCyihT5ubtdBmRJhNuUMzlG6ncof41hV6piov27npdszkhOVwl4WuXa48UThsM5X7qD5bi8K8LMkgoIMVWOUozR3KAe2rCkQhJoeEIa4ADe7sWAwj5usKRPXMoCcoT0HVhFWvFtdd8EzOITRNuypP8AtgCpvugUza5yF+AAUgbUb/9dk3AAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 10 23 42 43" title="" data-src="/static/2023-10-10-23-42-43-11fbf14d8c0b7aff1c501ce7f4948df2-eac6d.png" data-srcset="/static/2023-10-10-23-42-43-11fbf14d8c0b7aff1c501ce7f4948df2-4bee8.png 200w,\n/static/2023-10-10-23-42-43-11fbf14d8c0b7aff1c501ce7f4948df2-a69ca.png 400w,\n/static/2023-10-10-23-42-43-11fbf14d8c0b7aff1c501ce7f4948df2-eac6d.png 759w" data-sizes="(max-width: 759px) 100vw, 759px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>工作线程启动后，我们依然向第一阶段的输入队列填充原料，只不过这次，在填充完之后还需要调用 close 方法，向队列中加入特殊的终止信号。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-10-23-43-14-b20912fef254173893cd3ea809e65ecb-dd56a.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 412px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 48.30097087378641%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAAsSAAALEgHS3X78AAABqUlEQVQoz22RiZKaQBCGef/nScU9g6ugEkQQGGYE5HJBZFmuAUXBTRq3KlXJpqqrq+fo/r9/hpm7Bz098dtw4exnVgjLVVwpCRWClLN2sJxsAshG1X8NZuFFenZ8Ie7U9H6oZEJ8KcqXYSr4MYvssWGzyJo7kVF1qLr8EwxurrjuWWS+4O3jSmd1S/Tje0njiMtt/OVrsjn9Is3H185bc301aGeUFzzkDhQIvWLak3rIBu1x0yPa/b8Z8LS0MepeOhRyUipvtRilUvQO5HP3lbd3C3+/TilM+dMDYp/jmNl2t06ocihWUbbwYikqeNObYmfuhFPiTLDNWwEc6XmrZSc9P6PirGVDjfKWIcfBz3dBHgnKk4qfFeN+qXGWPxLVB0lnkTM1g9FSnZneWCM8cWZmADhjZIt+wgAwYOC6Q+UZ0wuYR2Wr5Y2aHfWyhU3QHDhL0ATBIyoHcij0omXE8F0+0GWUr+ISvhd25UMlJxSoZPAS5+u3WtoXcPXmE9zenH96/sb9fFLQhLh34podsNGDqN6JiuBFvB08quhZxWPNUuFRB/2/Xvs3a4IPPVzRv1kAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 10 23 43 14" title="" data-src="/static/2023-10-10-23-43-14-b20912fef254173893cd3ea809e65ecb-dd56a.png" data-srcset="/static/2023-10-10-23-43-14-b20912fef254173893cd3ea809e65ecb-5e99c.png 200w,\n/static/2023-10-10-23-43-14-b20912fef254173893cd3ea809e65ecb-5b1e9.png 400w,\n/static/2023-10-10-23-43-14-b20912fef254173893cd3ea809e65ecb-dd56a.png 412w" data-sizes="(max-width: 412px) 100vw, 412px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>然后，在队列上调用 join 方法，等待相应的线程把这个队列中的所有元素都取走。每处理完一个队列，就在下一个队列上调用 close 方法，向它推送停止信号，并等待相应的线程把那个队列里的元素也全部取走。最终，<code class="language-text">done_queue</code> 队列里包含的就是预期的所有输出成品。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-10-23-43-55-5fd5cb587cc41413669c2c6e81c8f866-fee7b.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 547px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 57.40402193784278%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABW0lEQVQoz4WRW3OCMBSE+f8/qReRq9QqopKAJIQ7glIN2o5gfeih2s70ATsTdsJMNvvtiaCswqe5KzlMRFR0/AEiI5ZqNJFdBmrXLTqc+5bwEhaSQzUSKW74bOERTcZRIWEqYWauOT5+okOvXxjHW9kNdBLLgLBY6SyHpXqhCrH7BnXm/mTNTwBVtMkQ08cZ1ggkl5AsYjLtki+on1zQaSzezP6DhTU/GwXrrrCfIt7ACaj929zmzW0PWrfCNNlM060RZMCseJFKo8HSG7HsWkQlkVnW1qZWvQjqTLLKCHKYqLwKXpNKQFCsPi/3pyU/gS6qDwjsfncn+7r5zkc/mVcQu25s3sLAikla6SwDcs2LZ8UerpfdcOgwgAfzvYHBB3fD2MAsO8xguUJCnSaAACz/vPNi94Hq5g8P6KF13i93bDezwTLFDazN0Sz5fNvprORmwSf5G7S6b/4ChnxHHCoXciMAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 10 23 43 55" title="" data-src="/static/2023-10-10-23-43-55-5fd5cb587cc41413669c2c6e81c8f866-fee7b.png" data-srcset="/static/2023-10-10-23-43-55-5fd5cb587cc41413669c2c6e81c8f866-9b56f.png 200w,\n/static/2023-10-10-23-43-55-5fd5cb587cc41413669c2c6e81c8f866-18701.png 400w,\n/static/2023-10-10-23-43-55-5fd5cb587cc41413669c2c6e81c8f866-fee7b.png 547w" data-sizes="(max-width: 547px) 100vw, 547px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>这个方案还可以扩展，也就是用多个线程同时处理某一个环节，以提高 I/O 并行度，从而大幅提升程序效率。为了实现这种效果，定义两个辅助函数分别用来开启和关闭一组线程。其中，负责关闭线程的那个 <code class="language-text">stop_threads</code> 函数要根据线程数量来相应地调用 close 方法，这样才能让每一条使用该队列的线程都能够查询到一个充当退出标志的特殊元素，从而正常地退出。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-10-23-44-41-4c2bc1b0080c9cfc528e681c61d5fbdc-0a3ee.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 747px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 52.34270414993307%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAAsSAAALEgHS3X78AAABWklEQVQoz32R61LCMBCF+/6v5IgwgtIrpTStQhV6v6X3oGCL4ynowA9wZifdJPvt2Zxy5vbAO9GQrB6XtuCm45Uz0Jd3KhkZb6Kbyn7GbyIlLNSk1rLtPGmUIBPdZLoJkHCk/loUn3JQPBBrSKzpOpysXMFN9HJnss5oWoN1pGkRxmllnckOkETC4TOnTPJStOed+OndR6+X7XdP9tgXmFMXyBxjT6q9Xu2Rc1KQz6JK9DMpzEWfSkEmhwWU5agQvXROG5yjKbZ/8Dk4yAp2BEHejgaL13vNHBrWsUvP4FalDFs1ra/ABuunIuUeNoAXPfq8DmZxKTix5FNU/I6Nmitw086SmrdjeCv4VPBSTC55dJF/nOuOL7wCw0CNMjnI1biCZ0pY4q8g0S7hG9Erq2kDqRGxxktHdJKJ5UwsV4nLC4dvwKTqjPqg5TvBz2Ey3gm39bLFIa7+jx8GcBhzVNv3EgAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 10 23 44 41" title="" data-src="/static/2023-10-10-23-44-41-4c2bc1b0080c9cfc528e681c61d5fbdc-0a3ee.png" data-srcset="/static/2023-10-10-23-44-41-4c2bc1b0080c9cfc528e681c61d5fbdc-14d81.png 200w,\n/static/2023-10-10-23-44-41-4c2bc1b0080c9cfc528e681c61d5fbdc-58aa6.png 400w,\n/static/2023-10-10-23-44-41-4c2bc1b0080c9cfc528e681c61d5fbdc-0a3ee.png 747w" data-sizes="(max-width: 747px) 100vw, 747px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>我们还是像原来那样，把队列与线程拼接起来，并向管道顶部填充原材料，然后依次关闭各队列以及使用该队列的那组线程，并打印最终结果。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-10-23-45-13-4b13ae9f66c89cfc22ef600d5dad9557-0e897.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 578px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 107.09342560553632%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAVCAIAAADJt1n/AAAACXBIWXMAAA7DAAAOwwHHb6hkAAADWUlEQVQ4y21U15LiSBDU/3/SHkYgIWAAIdvy3iIJGRBmdmZuL5uYebiLi6iHalNdVZlZzcx1Z2EGC9NfWCFreEszEMthG5WcHc40B6cThSytQAgybfitX/5lzMpJlmbIWxFL3IliHtLzLq5we0ncqWJMZX2impzlK939P5E0mCUOS7yF4bKaPVMtMe+2UbE0PFY156o5EbWpYgl+qvbP/wnmTF9wE86OWN05ZGe5vmLJ6u7KDrGDV1ZOrPXv5PqpD+/UEPbjMFJ1gR2ri9o+lPNdPo9Kc9MHekM539TuITcjHKkZsWOMX2T8NK4fxvgJh0EGwUtoHkLzoPi5bh+LXnCQ3+G9mLOCheawmrPPG+SQ6ovUXMVTD5+Raurtknqm2biNyHVQCn4+0yzOieYUCHuqmvu0Fst+ExVvyWnlZUsrXPkZs88aICR4Ke/E6B+cSSVNy9vhJsgXxF0a/tpNgNmx7KXTBYjCQcOonDmeeuD0FpYrlwbwVihm7drNBCfmHVBtg/lNUPBOhLfWL9v4mdLeKGDrIMOCtyPOCueKNVMsNMyZIfoU3BgQvJQDzCNguU8bMW/V7kmuHzTYev4BDUoz7rLmLanEojtWwy6tdlm9Dou1nx7ys1yNay+h3bnJNswB03fwNqrU8x3ogyqtvYtFD+be4pNcDdbjD8y4fZHbJ3VA0u0Lpr8iafCxHJBtrthLAlXZS82ZSMYvkQAnwc/Q4T6rYXhO65/fNrxrL50w5v1vvLHPW0pgNRxP1OR6hDbEU4cqlPMo1di5GleambwUgigIhtlE5SbM0bAQ5BgdIcx5N6Go+tkurTkv3iQ19MCa/sbPQSeksvKShRWsvJThqYZtFAl4p7LBmd5ctegMOvFMJhA5hACooR+qfzpFDqtaSAZcGc4OID1MJZQ0kc2F7i6I85dEQN6vI6HjDUR0iyqU+KBzJpsQnNo/0AKj9w+1vWvdU+8eAEPvn6R/qi9fae8KPXro9PT5uvagBuc1oYyYNXLRoUjkh3Txq2AGoVboaeXGh6LV2sfWzyFBCPGQ1FtA4yYAEsgxcnWhjw3g4B3FKDQnnVVMP/09BpoBjtrdQY/6Kgr2Pc+gV3BT8AQl0QkrWrFsITXcxsT+fBof5PrzgfwoBPYP4G5FXnnbkq0AAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 10 23 45 13" title="" data-src="/static/2023-10-10-23-45-13-4b13ae9f66c89cfc22ef600d5dad9557-0e897.png" data-srcset="/static/2023-10-10-23-45-13-4b13ae9f66c89cfc22ef600d5dad9557-d60f6.png 200w,\n/static/2023-10-10-23-45-13-4b13ae9f66c89cfc22ef600d5dad9557-6689e.png 400w,\n/static/2023-10-10-23-45-13-4b13ae9f66c89cfc22ef600d5dad9557-0e897.png 578w" data-sizes="(max-width: 578px) 100vw, 578px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>虽然队列可以很好地实现这里所要解决的线性管道（linear pipeline）问题，但如果遇到的是其他情况，那就应该考虑更为合适的工具了（参见第 60 条）。</p>\n<h3 id="总结-51"><a href="#%E6%80%BB%E7%BB%93-51" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>管道非常适合用来安排多阶段的任务，让我们能够把每一阶段都交给各自的线程去执行，这尤其适合用在 I/O 密集型的程序里面。</li>\n<li>构造这种并发的管道时，有很多问题需要注意，例如怎样防止线程频繁地查询队列状态，怎样通知线程尽快结束操作，以及怎样防止管道出现拥堵等。</li>\n<li>我们可以利用 Queue 类所具有的功能来构造健壮的管道系统，因为这个类提供了阻塞式的入队（put）与出队（get）操作，而且可以限定缓冲区的大小，还能够通过 <code class="language-text">task_done</code> 与 join 来确保所有元素都已处理完毕。</li>\n</ol>\n<h2 id="第-56-条：学会判断什么场合必须做并发"><a href="#%E7%AC%AC-56-%E6%9D%A1%EF%BC%9A%E5%AD%A6%E4%BC%9A%E5%88%A4%E6%96%AD%E4%BB%80%E4%B9%88%E5%9C%BA%E5%90%88%E5%BF%85%E9%A1%BB%E5%81%9A%E5%B9%B6%E5%8F%91" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 56 条：学会判断什么场合必须做并发</h2>\n<p>程序要处理的范围变大之后，不可避免地，代码也会越来越复杂。怎样才能在需求持续扩展的过程中，让代码依然像原来那样清晰、高效且易于测试？这是个相当困难的问题。编程工作中最难执行的一项迁移任务，可能就是把单线程的程序改写成那种带有多条执行路径的程序。</p>\n<p>下面举个例子，向大家演示何时会遇到这样的问题。假如，我们要实现康威生命游戏（Conway’s Game of Life），这是个经典的有限状态自动机。它的规则很简单：在任意长宽的二维网格中，每个单元格都必须处于 ALIVE 或 EMPTY 状态，前者表示这个单元格里有生命存在，后者表示这里没有生物（或者原有生物已经死亡）。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-10-23-47-06-829ee418d9b745f7e1cf4209cf1f4ffd-22c13.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 180px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 36.66666666666667%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABXklEQVQY0zWPTU/CQBiE+f8Hj5poQqIexEQSQzDQiIagAYq2tLa725YPUUQKlH7sbmmhS+sikMxhDu8z807OCFPp1xMkAB1aB8OaApvWqFhvacsQYQa9tYGZMsOvw1+xN37p/3BvEgaCNQw2OTPKqpJ2cnEutOVSo1NqNC/LQv62qDmBvqQVUdF5irtWF7TVn8hTD7oxCjYA75TT8Qb6keWH6tTX5hj5sUGYPveBx7O3H04E/MTCST9MTZoOoox76B9hFLL3L7umoGc0qHbBowyeZFgHfdkmJkktkliEqTPS+pyNoqzzvVBsbGKm7+FenAltKX93f3pdOLu6KTffHkS5UKlJEwe4IX8buSvgxXyqOHZkOwBuhHByaDYoU+dBe2SDZcwbeI+23F2bQWIEm+6CQL6LMiPc6nwRZYgySJK9cjzAoKm1yhBNjJBxwMLM+idN7glD+LCQX4Oj3+sPk6Fw/i1DtrMAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 10 23 47 06" title="" data-src="/static/2023-10-10-23-47-06-829ee418d9b745f7e1cf4209cf1f4ffd-22c13.png" data-srcset="/static/2023-10-10-23-47-06-829ee418d9b745f7e1cf4209cf1f4ffd-22c13.png 180w" data-sizes="(max-width: 180px) 100vw, 180px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>时钟每走一格，游戏就要前进一步。这个时候，我们需要考虑每个单元格的周围总共有多少个处于存活状态的单元格，并根据这个数量来决定本单元格的新状态：如果当前有生命体存在（ALIVE），那么该生命体有可能继续存活，也有可能死亡；如果单元格当前是空白的（EMPTY），那么下一步有可能继续保持空白，也有可能诞生新的生命体（具体的判断标准，接下来再讲）。我们先试着画一张 5×5 的网格，然后把这个游戏推进四步，看看每一代的生存情况。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-10-23-47-41-b899ec32dacb7908df3da9c687f49450-9a912.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 481px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 36.17463617463618%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAAsSAAALEgHS3X78AAABFUlEQVQY0y1QSXLCQBDz/39GHJjV5AE42J7NsxtCpSpqKjf1opbUg04/p9lP+SVcv+YXMwUdGQ50zlvS8Sn9oWnauGvTeyRCP6/pq/4OOhyX+z7tD2HKFA62JB06sNoPtkZMqR8f0hRpi94PsRXlu1jzNT4HbgvVOy1J39iaFERMwfnLEtkSQVOBtokcOtuyBtk1UAbp2mXZpa3SVGWBI9+wV4WtwNI2AOk7WzMAXTGVrwmmYHMQrp5uBvEgKF39uNlx9sDM5s/ZCZPf5DZ+e7YlCbIt492P96BApoQ46RpOKlJISEERAmHyjxe+k0MGmbnJKJXreNOgyNj/GBHoECJttArziMdhKnSMIADA8SB4pO8+/gCNTnjENPWsZAAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 10 23 47 41" title="" data-src="/static/2023-10-10-23-47-41-b899ec32dacb7908df3da9c687f49450-9a912.png" data-srcset="/static/2023-10-10-23-47-41-b899ec32dacb7908df3da9c687f49450-06486.png 200w,\n/static/2023-10-10-23-47-41-b899ec32dacb7908df3da9c687f49450-fe61f.png 400w,\n/static/2023-10-10-23-47-41-b899ec32dacb7908df3da9c687f49450-9a912.png 481w" data-sizes="(max-width: 481px) 100vw, 481px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>我们可以定义一个简单的容器类管理这些单元格的状态。这个类必须提供 get 与 set 方法，以获取并设置任何一个坐标点（或者说任何一个单元格）的值。如果坐标越界，那么应该自动绕回，产生一种无限折返的效果。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-10-23-47-59-3c67765c0db7abedac519304aab60aa2-160dc.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 737px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 61.46540027137042%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABw0lEQVQoz21SiW6jMBTM///RSlupXZakEG4C5AbCbW4MhOZQdyBatWorDejZfsd4xrNlkPJuPD94gkeMalhVg5pRvTpreavl3arsFVLrRWc2l++YmfQqhoUUlYtjyO58Zuuwe08I8t+q9Wdjq4RiiVOjuXzHbFW/Wf1dIQ2zsdmt+6RYUlQtDuGzsTPqwerum/O72d5+LsaH4XJSgzl/IotjIMcVd0qUrNWKXsmomrdjTntDGv7Wp0ZTcXNR806KK8HPXp14vveZtf1s7MHll6g9qaY2npYgL4T50k+N5u2jGEC/dXeXSaMWvUyoTGohLOS0GXcyatYX3EtJqYgWSWVO+Qa9zsBEioqFHTJblz14IAwKSzfRix5ygDkAXvjDCOP/jpI2cGSaTC96cQZneWIuBjnnxKCnpi1U4D14GbGHAKZMchAEGKOmFFbdMEoKcaWC9wiUQ2O9HKQxL0ZTCD6q9RCMXq0psNo7CqfJ1YAadudCambjiH7Ou8nf/ellfXxZ2692BPNAgXMTzolgO/Sb2yHnJeMjgRJa1mELTPCexDDXy/NjDq4NfHiL+LGcgqkYkpJGimsoCSyDHMx/fBVf8A9bMIFpQ098yQAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 10 23 47 59" title="" data-src="/static/2023-10-10-23-47-59-3c67765c0db7abedac519304aab60aa2-160dc.png" data-srcset="/static/2023-10-10-23-47-59-3c67765c0db7abedac519304aab60aa2-fc7b9.png 200w,\n/static/2023-10-10-23-47-59-3c67765c0db7abedac519304aab60aa2-cea17.png 400w,\n/static/2023-10-10-23-47-59-3c67765c0db7abedac519304aab60aa2-160dc.png 737w" data-sizes="(max-width: 737px) 100vw, 737px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>为了观察这个类的实际效果，我们创建 Grid 实例，并采用经典的滑翔机（glider）形状来开局：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-10-23-48-43-99420f122320c80ba302f12a62508334-71b03.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 271px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 137.63837638376384%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAcCAIAAADuuAg3AAAACXBIWXMAAA7DAAAOwwHHb6hkAAAD/ElEQVQ4y41UV3PqZhDV//8hmVw7HsfOta8rRYAKqqgLEKihhroQoposzH3IS2zP7HyzMNpyzp5dRMn2UrLmg5LzSyFutPJDyffg8+GKD3IuKNhFJkarcXUahRXjJnK6k/ODnO/BkCdW+uPxZWg4V69d0gyGTky58RM1eqRHXXn856/nNi8NxnM522IT6x+MYhaZvj4p1V6pDggXFryf66sjF+Ri1qjlXi/3QlRBHT4shbTmI2gqF7JGShvaS9mw5KEdv+CjCunIk+s3FB/bV28dzHCfWe36pftA0O+C8kCy/HIlJ/W7MFZXh7Y4vnpDO7L+47X7d598YQUE+sRnrpJtGCfkl9VouWIBapTT3pL1Eimu1XzHh4WUNEJc0YuI81Kof37tCCpPbzt9cmrftAe4FbblyW0Xe6KElqD1NUPNdiMvfeXkaX1qCfpfrT6mmj/euve94SujIJS7JM1QKw/UIr1ABTwZ4KEXKWmFXFypxRb+GaVrOd3QbkqaEePFpOlTZoB0tflNl+hPrOtOj5x7Hdm4R4lHkuvKBqpaUr4RgrKnWvr6oyWOobveeHbVQu8x4l2QEcjR0+dKviVtH7DBJCkrYLwUuAATl7WSNZyfivGaDyvcDDg3op2YXsSk4yODiXOPUwPDuhsMCSdGNfMnTj+zMnDR0wwl3YrLsqVOJqsTKk/veiShWzcd7AFn33kNGRheS5oqeTMwHNrLQCH4zIfEQzvA5x4XnTFTixhmBgPHZgty7hO2j81cwlgg6NS6x5j+xL7tE4TpY5r9k+QfmRGqzXqaI+VboBCyj5tTR5ndDai+Yd2gg4ch25ag8sxpS2NQFbQAbINC+1MTJkw5S8ZJhLBS8w2MA8ADHV3NpOwIn3nEHIp7CO9nhOHSToIbLmWFfd3qK9OWNB6clcx0VVOrT1p9ANmqqyOoWq2O2vpDq4/wE8HnC1Q3Ads5hRsODPsOJdvKbOiEz5xEmAF8LRVbudzBKxUbqdxeHLAdoq2P091Jaz5gkirku6TULr7efICkIez/DIGNxYwzh0K0Ui/p5WL3n1Lbz4JpP+9NbGxqy8lGr49ytbvs6tk+CfsdLMNHxU6rDsAhvUikrBGStZDUIoj5y2DQHbOAFctBmzCYUXhefd4vuKCUvgxWYFFhmZYVTBIzfM4voKwAix2vvtF22sC5EeMaHCFej5a1GFXiJd3XwcCnUuw4P8PmLuhGTOB0bJV0I2ebr4NHaU37cFkS0o2G7pIOMjDYfhjhN9outnA0YelhB+AVM7AGIADtXxMGl40FquHoewWwBfjPVPslF34DMyBUs61yto3y2znb9zAn66Ebw90BhQDyi5MxHviZVILIPrN/AdYNw2+7V3+PAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 10 23 48 43" title="" data-src="/static/2023-10-10-23-48-43-99420f122320c80ba302f12a62508334-71b03.png" data-srcset="/static/2023-10-10-23-48-43-99420f122320c80ba302f12a62508334-f4cf1.png 200w,\n/static/2023-10-10-23-48-43-99420f122320c80ba302f12a62508334-71b03.png 271w" data-sizes="(max-width: 271px) 100vw, 271px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>现在，需要想个办法获取相邻单元格的状态。笔者决定编写一个辅助函数来实现，该辅助函数可以查询本单元格周边的八个单元格，并统计其中有几个处于存活（ALIVE）状态。给函数设计参数时，不应该让它明确接受 Grid 实例，因为那样会导致这个函数与 Grid 类耦合。只需要把一个能根据坐标来查询单元格状态的函数传给 get 参数即可（参见第 38 条）。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-10-23-49-03-84d7ebc664e55787512889be1842677f-ab313.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 677px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 62.33382570162481%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABw0lEQVQoz22SCW+bQBCF/f9/U1XHiQPE5jYssjkM5lrO5XKp41TqWzuVmkMaITG737z3BhbbuFTSWghSOakkP3kknujHclIbRc/7fmyUA+kuzvCKIh9rsetmOWs3p0r0kqV12Ca1mndqxhTeLF/CYu2eBC/Wy8HqftvD6/+1cM5/5JwBEI/Zinh6MRjFqNFOKzrwatau95EYpJu40uvRHq8fYDK+KXmrF70QZCvbUynT8l6jPaQAy0nz7J6kIFMoM5vpszKHAdAOth+Ip+bMKKHcYwqSKyl7OkToI47Znr/AE1dW0laEsuOrtwhq0RvVqCQN+lAGL0VUr0bO9Jc7afUXDmNhetkj88PuAE0oq7Q3m/Pd9ooEODKradfOyEymK08+XrGsd+VneLbdp32IDUt+BnH41PJuE1LpmL1E+eP+qBYMPOIY9WS2sxRSZL7C5A/DEfwEU1Ta4Rjf0Gx/7dgMfTzB6PVkNGdgWjlgl+hjOofR4uNDKrixkjEcr91oSTzuIszFY4qrzvRGbm7Jv+K27+nxgq+Fqz8tFyO3UbG03U1UWGyG4Nff433b972Z9YQb+DGWxMX+uFU23xT43G9J1F8gqn2DJwiqYgAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 10 23 49 03" title="" data-src="/static/2023-10-10-23-49-03-84d7ebc664e55787512889be1842677f-ab313.png" data-srcset="/static/2023-10-10-23-49-03-84d7ebc664e55787512889be1842677f-94813.png 200w,\n/static/2023-10-10-23-49-03-84d7ebc664e55787512889be1842677f-beb37.png 400w,\n/static/2023-10-10-23-49-03-84d7ebc664e55787512889be1842677f-ab313.png 677w" data-sizes="(max-width: 677px) 100vw, 677px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>现在来定义康威生命游戏的逻辑。这套逻辑共有三条规则。第一，如果单元格里有生命体，而且周边的存活单元格少于两个，那么本单元格里的生命体死亡；第二，如果单元格里有生命体，而且周边的存活单元格多于三个，那么本单元格里的生命体死亡；第三，如果单元格为空（或者说，单元格里面的生命体已经死亡），而且周边的存活单元格恰好是三个，那么本单元格里的生命体复活。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-10-23-49-44-803525d3ea83a5f0257da0c91ac775a2-59771.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 548px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 49.27007299270073%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABmUlEQVQoz01RiW6CQBTk//+oTU+5pFYUuYQCC3KqyOW2uj2SzkrTNtm8vH0782YYBHEdzbL6emGL61gMknvTV4J0so7uLH9RNkpUPNjB1dyW/ESNcrM72cP77xGs7oyjJdtpUt2anhoVxm5Qw+zRCZUgs7uz2Z5W7WmEWT0D57cK9vEDnUs/sVXbbOUL7dZwJ160rLp50Rj10aVfzsBhDsA9c+gPRfhn4wNvQEs+UcJMI9XN0pX9xGzegH5Oa/klncaVnh/gSyWl9LL5IYO2qqkWF89ZLXrxg+Vf6xaeV3s6r7rFfuDKHbM6Zvfv8A99XP/Il4Ytq34apKPylW6JHjHbN+4ob+Qgm212cyiTXI2gnPJvxqZpXGpJhcZBEh1D5QotG/vLlfHAWsTGeG15kMKYGzoE87TZIe1Hj9yYnhymxp4aO6qXHRaN7hz6yStsXpz+2R6T1MsWv1RBNqSSvHiyJsua4knPG/icuEQKU+yFUwxBRgbnWVJppECSmN7bgV4csMjYH1cHygEDPJ/QL7Y9qlFT8/CK4Tey5xFYWAA7VQAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 10 23 49 44" title="" data-src="/static/2023-10-10-23-49-44-803525d3ea83a5f0257da0c91ac775a2-59771.png" data-srcset="/static/2023-10-10-23-49-44-803525d3ea83a5f0257da0c91ac775a2-46aad.png 200w,\n/static/2023-10-10-23-49-44-803525d3ea83a5f0257da0c91ac775a2-692ce.png 400w,\n/static/2023-10-10-23-49-44-803525d3ea83a5f0257da0c91ac775a2-59771.png 548w" data-sizes="(max-width: 548px) 100vw, 548px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>接下来编写一个函数，用以更改单元格的状态。它可以把刚写的 count<em>neighbors 与 game</em>logic 利用起来。这个函数根据坐标查出单元格当前的状态，然后统计周边总共有多少个存活的单元格，接下来根据当前状态与存活的邻居数判断本单元格在下一轮的状态，最后，更新单元格的状态。在设计这个接口时，与 count_neighbors 一样，也不允许传入 Grid 实例，而是传入一个能根据坐标来设置新状态的函数，以降低耦合度。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-10-23-50-03-89c2c4eeee910597cd29446376d507d0-a8ef3.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 566px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 23.32155477031802%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAIAAADKYVtkAAAACXBIWXMAAAsSAAALEgHS3X78AAAA+ElEQVQY002P23KCMBCGef83ahUCUUCtTjkEEhKMkUNFilJop4jedLW96MzOnma/3X+1hapmPJsGzN2W80RhJpf7o1d1jnzTQ+Y3X5jubLEn3SXqb1F//W8a6a9zkaOIAxPUvUk4Zrt12biqBJJ8XMDCdgAP0+QPG8NHqUHAiUIhm3ixSeW6aLxjr8OKRLmysGj6/Er0IIHjC3Xw6s/N4WzFW8xVcP7WSDfOuHJEvspqi0k7zaPTgKnUfQYdgzCcSJtnADhp7lcdisXTxjfubxYAXwwiEOHL7P2lOK3yZuozk6YoTiceRZGIQGE3hu1d/yMZSDv8PvID/EAB9d97tg0AAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 10 23 50 03" title="" data-src="/static/2023-10-10-23-50-03-89c2c4eeee910597cd29446376d507d0-a8ef3.png" data-srcset="/static/2023-10-10-23-50-03-89c2c4eeee910597cd29446376d507d0-38d6b.png 200w,\n/static/2023-10-10-23-50-03-89c2c4eeee910597cd29446376d507d0-f4d06.png 400w,\n/static/2023-10-10-23-50-03-89c2c4eeee910597cd29446376d507d0-a8ef3.png 566w" data-sizes="(max-width: 566px) 100vw, 566px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>最后，我们定义一个函数，把整张网格之中的每一个单元格都向前推进一步，并返回一张新的网格，用来表示下一代的状态。在实现这个函数时，要调用刚才写的 step<em>cell 函数，这时必须注意把 get 与 set 参数写对。get 指的是当前这代网格（grid）之中的 get 方法，而 set 指的则是下一代网格（next</em>grid）的 set 方法，只有这样，才能让每一个单元格都按照现在的情况分别演化到下一轮，而不会让先演化的单元格影响其他单元格的迁移结果，这对于游戏正常运行是很重要的。假如设计 step<em>cell 时，让它只接受一个 Grid 实例，而不是分别通过两个参数来接受获取与设置单元格状态所用的那两个方法，那么这里的 simulate 就不好写了，我们若是把当前的 grid 传过去，那么它里面的单元格状态就会被 step</em>cell 函数破坏掉。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-10-23-50-42-84dc8b297f1d1b319bd1572866b513b0-c183b.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 654px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 26.60550458715596%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAIAAADKYVtkAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAA/0lEQVQY0x2P6VKDQBCEef930lIOgYSbAAsJsNzXQoAFtAJRR6u6puZPf93NyEl9TjvWjXgfwxX8lEPYbKk9fFr9Zveb2a2X+xc8FllNspjd4kwPd95BjLccWjUKQSqGhRgVSkFkXLMo5LxYDHPOj18vgd7MkCHhWopK7ort++bS3ZkfjEN3iyxaOSg5MepRL4cTrvgAf4Q5f0vfUcRfE6OZPHqg7RttPyBvfbrLAWIAABjI15tJLQcpLs9JA4EciqCIjKsXE705NzlrDEJPeatWvVL0Sjlo1fCf3C/nrNXbUUpq1g3BKYSZ0c4wFRYCVGv/uEZH1aKHR69H8EOdXxiEBmIeB35pAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 10 23 50 42" title="" data-src="/static/2023-10-10-23-50-42-84dc8b297f1d1b319bd1572866b513b0-c183b.png" data-srcset="/static/2023-10-10-23-50-42-84dc8b297f1d1b319bd1572866b513b0-20b7c.png 200w,\n/static/2023-10-10-23-50-42-84dc8b297f1d1b319bd1572866b513b0-42e10.png 400w,\n/static/2023-10-10-23-50-42-84dc8b297f1d1b319bd1572866b513b0-c183b.png 654w" data-sizes="(max-width: 654px) 100vw, 654px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>现在，通过 for 循环来推进这张网格（或者说棋盘），推进到第四代时，大家就会发现，原来那个滑翔机的形状已经整体向右下方移动了一个位置。当然这个效果，最终还是通过 game_logic 函数里面那三条简单的规则而得以落实的。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-10-23-51-03-74a802f0fca4b804f52bc17d77ffecf7-6f695.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 717px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 62.90097629009763%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABiElEQVQoz41S2XKCQBDk/78pebCseCDCcoiaaFREYNnl3AWvJJVe9SEPKbVqCpqZnp7eWTR9S4dB8rbYdj+CwTruryKvOEzq0zOh+eI8KY9A0+ZbhfzyL/FUc+8zJLS2uYCF/irWt2wY0HGUe9VR6d5vHm6S0TY1QtZ9X3fnn+MoI1xaaW1nDfofNBtR/urOe4uw4y9fiN+ZLkcb2p2tesvQTuv7wzWLVnrAJtXJ2HG4GKyTwSbRA+qpRTyybSbFOOTY8yhkfn2etT/XzT21MCdrCMPCJGHCqw4TnLM63k4r/lD/86+ZtMQLJnE9Xnlw8hadbnGAkM0blNx8j6fNpA9cXHDWuEULOc2MK4c3NhMub9WdpdLJWodLlaS1l+9Rggqhws1acGxFlgiIamZUEFwMU2xgK6muNZJUCAd5fKbCjAtIox9kACspwdGsWDGAvKw14xI8nN9hDVTwiY2oyUwau1xNU82CxCVKwBr2pCZz6cKbsiBuPpGntfKvpC+cVDm/5vELwOkvnRK9xo0tZhIAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 10 23 51 03" title="" data-src="/static/2023-10-10-23-51-03-74a802f0fca4b804f52bc17d77ffecf7-6f695.png" data-srcset="/static/2023-10-10-23-51-03-74a802f0fca4b804f52bc17d77ffecf7-8f412.png 200w,\n/static/2023-10-10-23-51-03-74a802f0fca4b804f52bc17d77ffecf7-576a5.png 400w,\n/static/2023-10-10-23-51-03-74a802f0fca4b804f52bc17d77ffecf7-6f695.png 717w" data-sizes="(max-width: 717px) 100vw, 717px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>这个程序，在单机单线程的环境下，是没有问题的。但如果需求变了呢？正如笔者刚才暗示过的那样，game_logic 函数或许要执行某些 I/O 操作（例如要通过 socket 通信）。例如，如果这是大型多人在线游戏（massively multiplayer online game，MMOG）的一部分，那么这些单元格可能分别对应全球各地的玩家，所以在迁移每个单元格的状态时，都要联网查询其他玩家的状态，这样可能必须要执行 I/O 操作。</p>\n<p>这种需求应该如何实现呢？最简单的办法是，把执行阻塞式的 I/O 操作直接放在 game_logic 函数里面执行。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-10-23-51-44-d44a758ef652179d533bebbee9e1e140-cd472.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 557px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 24.775583482944345%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAIAAADKYVtkAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAA5ElEQVQY00WPx3KDMBRF+f9PyiLE2ECwnTKoOBZCMi0Eh7EQTChik2dYeOYuzn1qR5bHsyCpbBJvTsKXpY2jV/m9PV9eKH8rlRsXNmJP73jHLvv0h3aGtDNpzRrrXrT5rFp067Eew1uP9BCqHjUDBOsJqRE3IywhBZM7LzAAWKSbofiy8EVxyK7OSR7z382X8OLcjdJDVgM7UHnqssQTxUfVgKnLs2N+hZcN3AqSHs9x/eeyLJDlM42cs9wn1S5KvbjYMhEkJe1mEFmFV1gPT2HdYzWBP4HpI8smPdPWLAF4fBjyDwUXCFKg9xOeAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 10 23 51 44" title="" data-src="/static/2023-10-10-23-51-44-d44a758ef652179d533bebbee9e1e140-cd472.png" data-srcset="/static/2023-10-10-23-51-44-d44a758ef652179d533bebbee9e1e140-8e829.png 200w,\n/static/2023-10-10-23-51-44-d44a758ef652179d533bebbee9e1e140-2b773.png 400w,\n/static/2023-10-10-23-51-44-d44a758ef652179d533bebbee9e1e140-cd472.png 557w" data-sizes="(max-width: 557px) 100vw, 557px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>这种写法的问题在于，它会拖慢整个程序的速度。如果 game_logic 函数每次执行的 I/O 操作需要 100 毫秒才能完成（与国外的玩家通信一个来回，确实有可能需要这么长时间），那么把整张网格向前推进一代最少需要 4.5 秒，因为 simulate 函数在推进网格时，是一个一个单元格来计算的，它需要把这 45 个单元格按顺序计算一遍。这对于网络游戏来说，实在太慢，让人没耐心玩下去。另外，这个方案也无法扩展，假如单元格的数量增加到一万，那么计算新一代网格所花的总时间就会超过 15 分钟。</p>\n<p>若想降低延迟时间，应该平行地执行这些 I/O 操作，这样的话，无论网格有多大，都只需要 100 毫秒左右就能推进到下一代。针对每个工作单元开辟一条执行路径，这种模式叫作扇出（fan-out），对于本例来说，工作单元指的是网格中的单元格。然后，要等待这些并发的工作单元全部完工，才能执行下一个环节，这种模式叫作扇入（fan-in），对于本例来说，下一个环节指的是让整张网格进入新的一代。</p>\n<p>Python 提供了许多内置的工具，可以实现 fan-out 与 fan-in 模式，这些工具各有利弊。我们要了解每种方案的优点和缺点，这样才能用最合适的工具来应对具体的需求。下面几条会继续以生命游戏为例，详细讲解这些工具（参见第 57 条、第 58 条、第 59 条与第 60 条）。</p>\n<h3 id="总结-52"><a href="#%E6%80%BB%E7%BB%93-52" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>程序范围变大、需求变复杂之后，经常要用多条路径平行地处理任务。</li>\n<li>fan-out 与 fan-in 是最常见的两种并发协调（concurrency coordination）模式，前者用来生成一批新的并发单元，后者用来等待现有的并发单元全部完工。</li>\n<li>Python 提供了很多种实现 fan-out 与 fan-in 的方案。</li>\n</ol>\n<h2 id="第-57-条：不要在每次-fan-out-时都新建一批-thread-实例"><a href="#%E7%AC%AC-57-%E6%9D%A1%EF%BC%9A%E4%B8%8D%E8%A6%81%E5%9C%A8%E6%AF%8F%E6%AC%A1-fan-out-%E6%97%B6%E9%83%BD%E6%96%B0%E5%BB%BA%E4%B8%80%E6%89%B9-thread-%E5%AE%9E%E4%BE%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 57 条：不要在每次 fan-out 时都新建一批 Thread 实例</h2>\n<p>想在 Python 里平行地做 I/O，首先要考虑的工具当然是线程（参见第 53 条）。但如果真用线程来表示 fan-out 模式中的执行路径，你就会发现，这样其实有很多问题。</p>\n<p>现在就来演示这些问题。这里还是以前一条提到的生命游戏为例（接下来的范例代码会用到一些函数和类，其实现细节参见第 56 条）。我们用线程来解决 game_logic 函数由于执行 I/O 而产生的延迟问题。首先，这些线程之间需要锁定功能对其进行协调，以确保它们所操纵的数据结构不会遭到破坏。下面创建 Grid 子类，并为它添加锁定功能，让多条线程能够正确地访问同一个实例。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-10-23-53-43-9934fdf3f83b3f99e0cb912154c3e9dd-246ce.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 544px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 122.42647058823528%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAYCAIAAAB1KUohAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAC40lEQVQ4y5VUiXKiQBD1/z9pt5IY8QA1KiCHIoeckUMERrxT+wbcjUncrU1VFzYO3f369etp9C2PNX3WClqq2ZQWTWnGmh5neIxsvPgJa3jPsi5t9nJ+/GoNKTuISTlN9+JmN4mJsC7FdAcT1lt6tIFTSvnxrjWYuYWCfSecpgc+KqTNQS5OOPjzrJ37wY+88mMkDd0I9cV4K6X7v316JxilpOwoZ/RF/u+wa/DAjTgrGAVpz/A6uit+qzLlJtkK8Rawwc00O3wjGHwo5IJhKHCKC3y5OEs5eDrLOag60XRVU1/zNoZ2xJm+sCq6utddOC1Z78yX1FEMPLu6q5IzjfzN/4fgabobrzJmZoDwoZu0VKOjLVnr9UFQkW5gh8zMasr6JMyGXoKMbc0WY1InatQ/kIS8OXDWijOgNn/0uumZfltzJmH+NNWeBPVJnA3dGEB+8jLi6xYaNQCZnMHWozgDVMjmWTXGq7yzcB7EOT7lYzIOcwwV3/AJEZJSug0GT0iGMwARUko72BLXEGwhpuVVZ5Xdaq6Bd0yrPV8KERHXJUaNFvrLFaOafTtUwPw/5FnPgE47Ioxq9a2gq9kt1cI+PUoL/KluL1JxpJP7WPYdNo7REpjnIwIUvYU78pNqVA63XAnr3cAJ+/YKRECRN7BrwqrEyvYCnGgVagNaKriKIRCGhYMQJxG53VD0fARmVndfgpjRbKCFDZwIg+XDHAUVcrpCq3XyCTZ6Rm6MtCkv2Go9errLGj7ukHGQqoRqltq17fPnnvEvUqBnqAeSQjD2rD1bQjN9O+rpfntucU6IAnd6rvbhpJZvSMzT3iCJvXB1Drie4NSXlBATKf845w6UGGRY6a7pdQ1/6K0pN/EW7bBmwGhL7DxUVY+KYoTlh/eeeTpnHYDbC7uj2dgKqHrymk2hszBHQXrPXC+2s0KovWu7kkopRAXEjAljzoDTM/yRv6nvGSwGNMOHBZTXmltYwV/fbwb47l8ZWQAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 10 23 53 43" title="" data-src="/static/2023-10-10-23-53-43-9934fdf3f83b3f99e0cb912154c3e9dd-246ce.png" data-srcset="/static/2023-10-10-23-53-43-9934fdf3f83b3f99e0cb912154c3e9dd-745f6.png 200w,\n/static/2023-10-10-23-53-43-9934fdf3f83b3f99e0cb912154c3e9dd-956e0.png 400w,\n/static/2023-10-10-23-53-43-9934fdf3f83b3f99e0cb912154c3e9dd-246ce.png 544w" data-sizes="(max-width: 544px) 100vw, 544px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>接下来，改用 fan-out 模式实现 simulate 函数，为每个 step<em>cell 操作都创建一条线程，这些线程能够平行地运行并各自执行相应的 I/O 任务。这样的话，我们就不需要像原来那样，非得等前一次 step</em>cell 执行完，才能更新下一个单元格。然后，通过 fan-in 模式等待这些线程全部完工，再把网格正式演化到下一代。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-10-23-54-24-3a9627abb044c2b45dd25e62fd5401f5-67965.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 707px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 123.47949080622347%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAZCAIAAAC+dZmEAAAACXBIWXMAAAsSAAALEgHS3X78AAADRUlEQVQ4y3VUB3LiQBDk/2+6s8kZhHIAlFDOiYx91yuQy9zhqi3VsuzMdPf0bGvpJHMnnhj+YGuNVYdykqnhU146NYP+2mSTo1Be+eLycrXoqFyFJRUWVJBTfoZE+NJxxaZHchIWfH7+MXjhJgs3HWrOZBdMTX+w2U12/sJJ6aia29HEDLjs52C+vHL5Wcgv2GAJ5U0g36vQ3OCyEymenzkC4SlRa76LJoY3REEzGKM+im9tyssJZ8WAELRf3jOK1U2obs+ViwsTV5STrYISbAl/L1/5BR3WP4Ni6SbQhYn3Sy+l4/IpWKiuMyvqSdpYd7uiOlybb6zcXxtYbU7uSioQLb0MuXCN8vOnYICBsKuwADA2O0GnVVSBIZMewZZLT+L+A2gJ7P2H+A9syiPYkBKolk4KeFx+gf5IgUP8xTVqvRBsFeRzO/7NyFBruLW6koZWY4NzoEWrH1fLy/9uaQEM+IBtm98ONhbt5T1FH2vudBd0JBWCz0yfDgjhvqwxSfUsWHlDhXdWGas2ri6sqCtq74zyxinQbAQ4qg1GPcUAqInuQhS+gVC3KtnP7IgKCjh56aYLJ0F7YC/8JdS9JZ5pNrWRmmDgWdgxqaBZY92BYTAPNXJ7pDpMcmCzI9qBRTSD/tmJSXF4IsHQFsaApRHf35hMWHUlvStrbX4z2JjY4Hyk2l3FAPiR7mL+emtzbPoP2AStlwIn0jNRJR0/5eMf6fD4Sk2fCYuSgBebnxDsChsO1sZwa2O2MdJAOzJcTFh/Yw1UG62+U+W/t6qeU1IZZNjkgMiFHUEC0O7JGgwL8h1hiwXPEObZiUBLDjDfXbbWPdN9DOGWnqxTbjYzw6kREBUUoy1s5jvyqgxheMWABdAzdB6IWl8wwAcVfjFST9TmVgyHQEVYrSNuEYmez6wAA0eHFUgB3Uh3msrFBVaDWzqiioWr7/wGKsAhqAMucPVXn8VaM6yaM/gke9DGbMFAYEURw0fYsynh+V0kZOGaOSHPEC5BLTwmv1kZLZ3q8Ik+VC02PmDISDqM2quXrEXYVjdp/4lqMzu+zyYb73HCF1cc4oUEHQz2i2DQWEUlvDXbhXhD+9sdIMDqtQ3OwoPe66f7L/seNNvdIfHpAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 10 23 54 24" title="" data-src="/static/2023-10-10-23-54-24-3a9627abb044c2b45dd25e62fd5401f5-67965.png" data-srcset="/static/2023-10-10-23-54-24-3a9627abb044c2b45dd25e62fd5401f5-403a3.png 200w,\n/static/2023-10-10-23-54-24-3a9627abb044c2b45dd25e62fd5401f5-2b9d5.png 400w,\n/static/2023-10-10-23-54-24-3a9627abb044c2b45dd25e62fd5401f5-67965.png 707w" data-sizes="(max-width: 707px) 100vw, 707px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>负责推进单元格状态的 step<em>cell 函数可以保持原样，推动整个游戏流程的那些代码基本上也不用改，只有两个地方必须调整：一个是把网格类的名称改为 LockingGrid，另一个是把 simulate 函数改为多线程版本的 simulate</em>threaded。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-10-23-55-14-8e574cd93c4deaf338f3b3a797453468-1d472.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 732px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 88.93442622950819%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAIAAADUsmlHAAAACXBIWXMAAAsSAAALEgHS3X78AAACRElEQVQ4y4VTiY6bMBDl/7+p23Z3c0NIwECuQiCEy1wBTO5WfYbNKqiVVhpZ47Hfm+eZsSCHhbhPpl42tPyB5Y/scOIm2uGil1e9vD3s+mSfwZugFReSHUl6JNmJ5LAzVr26GtUz5maw+4LdsT4TCQotZ7QERg7yqZdCwiwq1KSe05LjCy5BzY44FXdU8tIOuLdx3je73tqBiU70trK/qcuJSzXkf1zSDmclriQ/laNDBzywvP4v93Vhju2QJGxkBy9kJXnJov6tFZfPe1Bh/Ct7aHLw22oLGOiHW/9FXYoAs/sz+L8mDLfewNy/Lq3RNiAxw8ozB+ny+Odr8DxhcniQaaEkNTJP4Qe5jJpltf51Ztt/X9miG8/CAjX7aZhjN5rsY5QHyvWq2+QunYAMasr61h7I/tr5TlZjO1DTStrHqAKaZPB5uOAJRnXvNv8qoKoQiZrPo2LkhHh8f7MbWt6rYf4g657pjp1ITSrJi1FXXOiA2x5iMGa0kMNcy8+IkAOfM7RazfgKtQiqaY0p7IBFl079FC8E68iJcK99atPYxiC12fLxfMhuHWQ+TcO8DeEYCVF/vbg2c36axYwPf+MrMSPNR0ACDC/igpadZkGBzZxWBN2ipRJVqJMaMxjimHM4CoVfAd9um/lnAB8lN0UUBiJ8jHlY4m0cGRYwfDgOwDj4uZJwMEnrecRJBTVpkjTEuMejtEJtGnAJ44CYfzIcobSciFYoE3yBE1PwMYVTHhVoo4wHG6lKS/ShnMsmnPcj81+pSscY31ZgBAAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 10 23 55 14" title="" data-src="/static/2023-10-10-23-55-14-8e574cd93c4deaf338f3b3a797453468-1d472.png" data-srcset="/static/2023-10-10-23-55-14-8e574cd93c4deaf338f3b3a797453468-e9d85.png 200w,\n/static/2023-10-10-23-55-14-8e574cd93c4deaf338f3b3a797453468-b1edf.png 400w,\n/static/2023-10-10-23-55-14-8e574cd93c4deaf338f3b3a797453468-1d472.png 732w" data-sizes="(max-width: 732px) 100vw, 732px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>这样写没错，而且 I/O 操作确实能够平行地在各线程中执行。但是，这种方案有三个比较大的缺点。</p>\n<ol>\n<li>要专门采用工具来协调这些 Thread 实例，才能保证它们不会破坏程序中的数据（参见第 54 条）。这会让多线程版本的代码理解起来比较困难，因为早前的单线程版是按照先后顺序实现的，不需要有专门的协调机制，所以读起来比现在的版本好懂。这种复杂的多线程代码，随时间的推移更加难以扩展与维护。</li>\n<li>线程占用的内存比较多，每条线程大约占 8MB。当然，现在的许多电脑完全能承担起本例中 45 条线程所占用的内存总量。但如果游戏里有一万个单元格，那就必须创建一万条线程，这个内存量恐怕很多电脑不支持。所以，给每项操作都新开一条线程是不现实的。</li>\n<li>线程的开销比较大。系统频繁地切换线程，会降低程序的运行效率。对于本例来说，每推进一代，就要停止一批旧线程并启动一批新线程，这样开销很大，于是程序除了要花 100 毫秒等待 I/O 操作结束，还会因为停止并启动线程而耽误一些时间。</li>\n</ol>\n<p>如果线程所执行的代码出现了错误，也会很难调试。例如，game_logic 函数有可能会抛出异常，因为它要执行的那种 I/O 操作本来就属于有时成功有时失败的操作。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-10-23-56-14-c13a0802d672d26fa525a7a6a6969f40-8d56d.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 465px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 24.73118279569892%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAIAAADKYVtkAAAACXBIWXMAAAsSAAALEgHS3X78AAABAElEQVQY0w2Oi2qDQBRE/f8fKoVAVTCpxtX1ranWGs2q63NdjaSJtheGYTiXuYxwwAEqOjn8ftddNa3lMBXdLyUuRC/5cOJjnNt0PtgXyY/fNEuOfiQ/0Unn881jT8GoR3dYEekAmc1kNdykzO4WCJgyq+Xe+MDtDBDVAwTcTM5wD+bN508hmF/e9GtRbpAOt/x8604JwXTSSY8rZpLRKIdzTs2aOf2KqxGVI64nVLQGGQVouuwBTfVanbJKvdZSmGpZJcK8W4tIf0xyJc6VpIBpWlZ+pgTe6TmFL4LPniBnWK1+jeY9nLfovofLfln/Ar7BvGjZgYDDCTgo4C/I4P9KJghtENu7lgAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 10 23 56 14" title="" data-src="/static/2023-10-10-23-56-14-c13a0802d672d26fa525a7a6a6969f40-8d56d.png" data-srcset="/static/2023-10-10-23-56-14-c13a0802d672d26fa525a7a6a6969f40-afa68.png 200w,\n/static/2023-10-10-23-56-14-c13a0802d672d26fa525a7a6a6969f40-5df89.png 400w,\n/static/2023-10-10-23-56-14-c13a0802d672d26fa525a7a6a6969f40-8d56d.png 465w" data-sizes="(max-width: 465px) 100vw, 465px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>现在测试一下看看。令 Thread 实例直接指向刚写的这个函数，并把操作系统的标准错误端 sys.stderr 重定向到内存之中的 StringIO 缓冲区，这样可以更清楚地区分，当线程在执行 game_logic 的过程中发生异常时，哪些信息写到了标准输出端，哪些信息写到了标准错误端。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-10-23-56-48-53fcde92d567ba9beaa335ec2a1b919f-07a9a.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 696px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 76.86781609195403%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAIAAABr+ngCAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACOklEQVQoz31TiY6iUBDk/39pJ44jHqAMKHIIyn2DcsihjrrZeug42WyySUNaoepVVzXU3EmmO+8zOEyNYGaGjBkss1pt70pzQ8nHL1LVpW8uz5/fRQE83rpzL+WCg9re1uV5tW9Wh5aPi2V6VOqrUt/wP7mDrr4CI/VcuFMzKxppFr2xB6LGWCFrRx+q+S7pQ0mfENKMCw+Mk/BxOXcTPsqBUZu7cgTplZLKsxCXY80eqSYfFrRuD+XdaGONdfdjYw1EfbJzwcVaMa05tGbPzGC89YT0yHl7CoOBFQCcPLPCd3mLE6TiBOVi3q7yTqrO6+JEdJakEYtulbd931EYRjx0Cy9jnQS2YXgx7zbdb0xI5PWeKd8OkZmJC9enYWLWCHG18DPg+RCDpXxUMHYEFsaO8ej16r9FrbJa7O0VklLIauQEIejhOfp1fpL/A2acCB7M/UxIKhChYb3sMyoWXgo5jymegb8Ev2TDtF9L5W2pTs0AhtOITTE/5N1Ed8Y6iQApQsXDLZRUXtbF+RE1BTNwCM5HyEPFmBkB1gZjA8D5e+S8TCsEg3empj+zo75C1k0JGNecPAgYk4BZN+GiHG/3LlRknLQSDy0XF2Q92vtfsnHhhInhMU48VE3op8mGONjWobydGD7rxJOtB/bxzptawXLf/ICRJ+vGrB1D8JugAgb/IBvNSLOnhg8hg7WOnR2pBugeC/MEYySsFNYY4IGkYzHRAzlUdmBZuMTzhZ8iCKUhH4l8/EnuD2qvF0lnNLcPAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 10 23 56 48" title="" data-src="/static/2023-10-10-23-56-48-53fcde92d567ba9beaa335ec2a1b919f-07a9a.png" data-srcset="/static/2023-10-10-23-56-48-53fcde92d567ba9beaa335ec2a1b919f-fe3b1.png 200w,\n/static/2023-10-10-23-56-48-53fcde92d567ba9beaa335ec2a1b919f-abb86.png 400w,\n/static/2023-10-10-23-56-48-53fcde92d567ba9beaa335ec2a1b919f-07a9a.png 696w" data-sizes="(max-width: 696px) 100vw, 696px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>可以看到，程序确实抛出了 OSError 异常。但问题是，刚才输出的那一大段内容是通过标准错误端看到的，若是不写 <code class="language-text">print(fake_stderr.getvalue())</code>，就观察不到任何错误。这说明，创建线程的那行代码以及启动线程并等待线程结束的那两行代码，似乎根本就没有关注这个错误，假如它们关注了，那为什么不把相关的消息打印到标准输出端呢？这是因为，按照 Thread 类的运行方式，如果它在执行 target 函数时捕获到异常，那么会把回溯信息（traceback）写到标准错误端（也就是 sys.stderr 里面），而不会写到标准输出端。Thread 本身就没打算把这种异常重新抛给启动这条线程的那个人。</p>\n<p>了解到上面这些问题之后，我们可以清楚地看出，如果需要一大批执行路径分头去执行某项任务，而且还要频繁地启动并停止这批执行路径，那么每次都需手工新建一批线程，这肯定不是个好办法。Python 提供了其他几种更合适的方案（参见第 58 条、第 59 条与第 60 条）。</p>\n<h3 id="总结-53"><a href="#%E6%80%BB%E7%BB%93-53" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>每次都手工创建一批线程，是有很多缺点的，例如：创建并运行大量线程时的开销比较大，每条线程的内存占用量比较多，而且还必须采用 Lock 等机制来协调这些线程。</li>\n<li>线程本身并不会把执行过程中遇到的异常抛给启动线程或者等待该线程完工的那个人，所以这种异常很难调试。</li>\n</ol>\n<h2 id="第-58-条：学会正确地重构代码，以便用-queue-做并发"><a href="#%E7%AC%AC-58-%E6%9D%A1%EF%BC%9A%E5%AD%A6%E4%BC%9A%E6%AD%A3%E7%A1%AE%E5%9C%B0%E9%87%8D%E6%9E%84%E4%BB%A3%E7%A0%81%EF%BC%8C%E4%BB%A5%E4%BE%BF%E7%94%A8-queue-%E5%81%9A%E5%B9%B6%E5%8F%91" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 58 条：学会正确地重构代码，以便用 Queue 做并发</h2>\n<p>在前面那一条（也就是第 57 条）里面，大家看到，每次都手工创建一批线程并平行地执行 I/O 任务是有很多缺点的。笔者当时以生命游戏（Game of Life）为例，演示了这些缺点（下面的范例代码会用到早前实现的一些函数和类，相关的信息参见第 56 条）。</p>\n<p>这一条要介绍另一种方案，也就是用内置的 queue 模块里的 Queue 类实现多线程管道（接下来会用到早前范例代码里面的 ClosableQueue 与 StoppableWorker，参见第 55 条）。</p>\n<p>这种方案的总思路是：在推进生命游戏时，不像原来那样，每推进一代，就新建一批线程来推进相应的单元格，而是可以提前创建数量固定的一组工作线程，令这组线程平行地处理当前这批 I/O 任务，并在处理完之后，继续等待下一批任务，这样就不会消耗那么多资源了，程序也不会再因为频繁新建线程而耽误那么多时间。</p>\n<p>现在就来实现这个方案。首先，创建两个 ClosableQueue 实例表示输入队列（in<em>queue）与输出队列（out</em>queue）。每条工作线程都可以从输入队列里面取出有待执行的 game_logic 任务，并把执行结果放到输出队列之中。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-10-23-59-59-84afafacc680167281a058358f1c8476-954b4.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 348px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 58.333333333333336%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACEklEQVQoz11RiXLaQAz1/39LO0kISaADhILB4HO9tteAEyA4+Ijvk4AhrYzb6UxnNBrpSVrpvaUkKxSsAAeF5KWCFfL7AH0kclAAKNqR6ISylyE3nb6Ykhtze1/2c5JVWnoCo5hXs8PJrOn+EJQWw7fn4gAvJTftS/oTJz9rBr/z+Hf/22DUEfAtzc62jp5f1ORYDy+Ki15cSHYm2WlRfunFmeSVnp+XEOdnvfi67qkgqKv5pVnbeAoFhRp/askRvOQkOCwhlsMSrlX9AugQaE1PSlTC8dp1IYk+Ia2Hx8amh8h4sQaSz9qyK6pwbYtmu4LyQM/vRlPg8jAXezK5HTM349kji1oTjjZMHBaUGh9AHlzvPyhRbZKXgSpafARQdFPZL5CfQw/yMyhBXKdhCbSphgDMQB+ODkAYUjD1ipP83KT/xX/U1qAvOZK0WqSV9hcFhaAVfPOEXr9Yp0313zDcBqgCx4elAhYfIMVBXn9pkNcquolgR4IT1+zCAsfAK8Hw22lFDVWjj432VAAl2jORN33sZbOtPSRGV8BdVgbrI/17j35kpXtG6HC4KxNoWBa/KHq1498D0QymhjlfW9zWAYUUr+R2HxNjx7zux6vdkKyZrdVXF5OVya5tAGcbC3kpBduYl90AkbsJB//UEVXkJLKdzt8+xqu3HtI6PO4gbbTa3E/4FiM8CQogP3WDt4Pf80VyMhtvbaEAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 10 23 59 59" title="" data-src="/static/2023-10-10-23-59-59-84afafacc680167281a058358f1c8476-954b4.png" data-srcset="/static/2023-10-10-23-59-59-84afafacc680167281a058358f1c8476-99c83.png 200w,\n/static/2023-10-10-23-59-59-84afafacc680167281a058358f1c8476-954b4.png 348w" data-sizes="(max-width: 348px) 100vw, 348px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>启动多线程从 <code class="language-text">in_queue</code> 里面获取任务，并调用 <code class="language-text">game_logic</code> 来处理各自的任务，然后把结果放到 <code class="language-text">out_queue</code> 里面。这些线程会并发地运行，从而平行地处理这些 I/O 任务，以降低游戏进入下一代时的延迟。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-11-00-00-36-f944a0f168089eead4efe172b29dc2a7-4c847.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 618px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 118.12297734627832%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAYCAIAAAB1KUohAAAACXBIWXMAAA7DAAAOwwHHb6hkAAADPUlEQVQ4y3VUh3LaQBDl//8o8Ti2qEKAJFAF9YZ6B2HAsfNOOJ4UPLNoVuL2bveVGzB2yLjJzA7HujtUzakZMF4yMwMuLOn+I21HcnuVmsv/MRCLbp0fNmXHJQ2ftHzckEiaTXZcpwckfNrerSTFSy9lnHgV5EPVepaNiYbzranh9+HNjIBSLaF8uV8sH16l5ioj2ity5fjzFv/kdzsfcHHNpw0blXiuwpJPauRcUm8KtN0s9/kqLPj+9U4x48ZzL6EUY7nPJrq/8FOAh2CTGsiNdA+YYcE6P8qHj+76ZvtidCXVFyHvxPKEFUL1gkOEsttkB7E+C+VJrM6b/MDFFZ7r7MDGNfr6PXNzQedPorZwcb451T1K1ilZG++cse6NZP1xrUx0FxSyYcmFFdAFtVJ9JsX4gY+x5mJXLm4WXko7MYKNK9qJUIBB0NT29E4g7FFU0ewn2phEPb6R/7qfSvemnhDvZBHy7k3pl4oVYQuD3OKjeO5EyyAb7pxlkE+NAITP3RgKo+09FIZu0deXVAnZkQ0K2txDLUPVfhZ12opGO+fbSnjgpKnmYRYodGrt/68naK+ThnEiAI73TdEBfKk6AwJAjQT6wV+bvFPa1w8ttb2omuug3+Ms15e5E0OYOP9Z1NA8G1UPvDI3Q0o2Z4ZPW8EPcQe3QLbPkgZ2Jro3wDZ81s69GCRNDG+4tb6zEvKFn83tCFtggVi/kABmQKtCvNxgIyffJIHth7IB/MDzwo5RSYSZtnDbJ7x3jAHTLP1sFZXgFoLBqHxUYwqwAOTBuVB94ap1RvZeF0c2bZBgC8ZPV8QbzQKTxxWO/fIyAKVP4o5STZwztQIuLiEymAmV2AUfCf5fFcP9GG9hR5u0nbtkTjYs5Paidu83hREPYeY/xhZ/vw7gFUxIm8FoZy+8ZKr7PwR1vLNnpg/waWvPuClh9UNkf7nyBthJKLqRalOSyXjpAyeDqifR+L6ScA3hhsRzqDnLsICEya1o+DAcoCU8EwGae0rSKNxhuvskbtl9AYTBE/wEhmFg2Jjck/kRUiekJIQUUgwljLc2RDM2vJFiPgpb+AQ5rj6cI0OVh6tya5v0fL15U2ovvwDUrvzJ49hciwAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 11 00 00 36" title="" data-src="/static/2023-10-11-00-00-36-f944a0f168089eead4efe172b29dc2a7-4c847.png" data-srcset="/static/2023-10-11-00-00-36-f944a0f168089eead4efe172b29dc2a7-9882a.png 200w,\n/static/2023-10-11-00-00-36-f944a0f168089eead4efe172b29dc2a7-ecdcc.png 400w,\n/static/2023-10-11-00-00-36-f944a0f168089eead4efe172b29dc2a7-4c847.png 618w" data-sizes="(max-width: 618px) 100vw, 618px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>simulate 函数需要重构。这次，它必须与刚才的两个队列交互，把需要迁移的每一个单元格及其当前状态都封装成一项任务放到输入队列之中，并等待那些线程把输入队列中的所有任务都处理完，接下来，它要根据输出队列所收集到的结果更新每个单元格的状态，从而将游戏推进到下一代。把迁移单元格状态的任务放到输入队列，派发给工作线程去执行，这里用的是 fan-out（扇出）模式；等待这些任务全都处理完毕，然后才开始使用输出队列所收集到的结果，这里用的是 fan-in（扇入）模式。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-11-00-01-08-8cca873ff71046a7d8b7487e73201a3c-56c56.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 784px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 104.20918367346938%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAVCAIAAADJt1n/AAAACXBIWXMAAAsSAAALEgHS3X78AAACt0lEQVQ4y4VTiY6iQBD1/z9qJl6IgMghwngAckNzKniNTvY1sLOZbNZNOpUWq7pevfdqMPqwmZ2rkFrJGq26rei5t/GGn9rx/uIMmL3Pe0Qrb+vTp14/9Oa5RqTniYP7q2IpOYphMT9ErB2yh4gxA85JcGdMH1EIcjz6z2Ktui+CnPfTVXlV84uan9t4UfIG91VxfdV5mVRiXAp+KpFj3wSxP/cXbWmxWlzktJazRi2v+vmrmxk1HQX/IUwiJ5nUy7iSyRH9hSADC4CN72JUauX1D+d/8Q/Yx2VY8S5BKqiaO2QZlWp2FqNK8DIKoQfyoJefWAbIg8JoroAecFZQtjAI7uv6c0mOeB3kUSBJhfizc1TyTjzdOqwdMTtvrFtjwx4Z1nTr4uPM9Dgvw1CcR1gnFvysM1JfDCToJsYF1OK9lHcTPDHSzZFhv6+2UBsQjPNX75zm2frn8a3zrZMHSePNYWhYczuEZ9613WTrMHsPVgE6yKEUF4wAUyyCQmvlGHRvdHrOzOBttZ3s3Pkhnu4czk1mdoD+cB6mmGzcyfYwt6PpzhOjQggzWqyWF6U405g1izCXU8oftVp5BRw5o+RJ6Ql2kvMG+ZgZmVJaD9BTSqrJzsF6sVaIDeP9TG/a8eiE/XrgTienAG/ab+VoMSYZGeZQ3082DufEQ20LnqE8EM6dGAixdhgETwMCHbO8UVHLa9uZnFADbpABtjHSm7pBKmwDkbAbKyo+7HDuREI+NVVYDL7ZEsMcA1PB9/5QNyH7dO+NPw4wDETmXIJ/O10627VStaalxKQ1hWoFM9MfrvfjDbUKImRnTI+1AkiIJ+ATCAlEvVRrunoP6hCPCF4KhVg7kBPsSca2ms+sUG0XW8Gqt/7thh90nwSXSPCgSzgvQT2wdE4yOs6bp9aOtm73vFtY/PwF1lxk+gsu79cAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 11 00 01 08" title="" data-src="/static/2023-10-11-00-01-08-8cca873ff71046a7d8b7487e73201a3c-56c56.png" data-srcset="/static/2023-10-11-00-01-08-8cca873ff71046a7d8b7487e73201a3c-06149.png 200w,\n/static/2023-10-11-00-01-08-8cca873ff71046a7d8b7487e73201a3c-f9654.png 400w,\n/static/2023-10-11-00-01-08-8cca873ff71046a7d8b7487e73201a3c-56c56.png 784w" data-sizes="(max-width: 784px) 100vw, 784px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>新的 simulate_pipeline 函数要用到网格（Grid）类的 get 方法与 set 方法，但它这次是在自身所处的这条线程里面调用这两个方法的，所以不用像上一条那样，专门编写一种支持多线程的网格，并通过 Lock 机制给这两个方法加锁以防网格之中的数据遭到破坏。我们这次可以直接使用普通版的 Grid 类。</p>\n<p>现在的代码要比那种每次都手工新建一批线程的方案更容易调试。如果 game_logic 函数执行 I/O 时出错，那么错误会被捕获并传入输出队列里面，并在主线程之中重新抛出。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-11-00-01-44-4131374a8c20c6e96bd2998624e46f63-83c29.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 722px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 59.418282548476455%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAAsSAAALEgHS3X78AAABsUlEQVQoz3VSiW6jMBTk/79p1W2rjQhQbgJUTUISLoO5r3RT0nZsspFWq5VGlj1+73lmQJDDfB2kq7dQPmETy6dMDBI978QgfX49SAdiFr03zG5/4euHO8yb/mPTXQABZ5MOWlprpFFCqqa1Tlo1LsEYtNdJY2SdnrVmMahJpWcdeNQ77W/ePMx2NaEIr6lpiTqrGDFIJTUYI+/QxkD7l6jAUSO1VU23ZrMcDdxVk928gzWr0QLKkV1z2PV5qQaWGqd5v8mWIyoeiXTKpCNZcywbvKDljZ412K92EewocYGrX9sQ6lxuW4AYqLLKCQf//OVPn94IXBmGGasPMPKKnNzuwjK7B/a42T5Y/qO7k5D2IYUQNa2QDWzrtJNDqsSlElEta+4h3yGglKVSTkbBImFpZ1DbMtCOMQmbhZrFs7OARyCs94m4T579AB9cOmZwqCSlEtOXpOLPFoBKmHOQcpTjd0BA4jGFeUHcxesgwY+BMFjIfKrdnJ32Nh6MzbGE7/wBGEEjLSwppxxF3nB1+3nDU/nL3j9ub56fvO0Py/tpvz55+9U2hMhFP/J3/9NzxzcDT4FnurDptAAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 11 00 01 44" title="" data-src="/static/2023-10-11-00-01-44-4131374a8c20c6e96bd2998624e46f63-83c29.png" data-srcset="/static/2023-10-11-00-01-44-4131374a8c20c6e96bd2998624e46f63-5b578.png 200w,\n/static/2023-10-11-00-01-44-4131374a8c20c6e96bd2998624e46f63-4dff0.png 400w,\n/static/2023-10-11-00-01-44-4131374a8c20c6e96bd2998624e46f63-83c29.png 722w" data-sizes="(max-width: 722px) 100vw, 722px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>把 <code class="language-text">simulate_pipeline</code> 放在循环里面调用，就可以利用这种多线程的管道一代一代地推进游戏了。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-11-00-02-06-d97b6054084e0c8c62d53d675a459c15-212ec.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 731px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 109.43912448700411%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAWCAIAAABPIytRAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACY0lEQVQ4y41T13KjQBDk/3/pyuezLJQRLMkIyUgEkXOUZfvqesHp6VDVFtU1szM73dMwfJCvnYg7JzPjPDfcpemv7UgpXtTyOnoYubyKaSMmDUlbMWuBSdKgWCmvo4cRokoIKzm9bL2MDwoxaZXiqtZvNxVP9xZ7sFjdZPcWhl8Y7kQ7bYP8lnpmdnTZg/3wZCzNQIzquXH+Le02bvxUv48Oz8wMB8UTzVicPBJWkO1O2q1p8dt48eLozZ+dx91xcfLFqIHg94rOeanW/B0vFuJ66+d8WEJkiMcBBzki0H+cMxYLqTZ2zPv5o26C/MoO6ebdTK2+NZOLF/lzkC/MiFhvXGN4Vqea38v6ygykuFlbIVSQ0k6tXnEPEuAA09MDkGLADTODKpa8NL3J7gj9Zgdnoh2ne3N2sDfnBCkWuhoOVri0fIg6fT5LWcdIKaiWWz/jvAw+wSBS3iExzCbllw9A/dcNEWSB6dgkKvmwgEJLO1w5vauHqXp6P8EXVj4xQ58NioXpr5yYgDz060f9vvoftUlccW4Kqr9EDQpNdetO3N1eXG/c5I96eFCpybAt6AH+yi3FMiTJOj4qhRDkS/hEw1aa95v+KrwMe/R7uw6uGFSlTfOLmHaI/8Af9iC9/xglv/BeTvq/WkparJSCtMMfBvMIQQmfAuACDgDuiHGDOJbH0AI3FyKaluJ26+VDF1oZ0o4A+GFIWPNBiS9SZGgaN4yctoJfwI8kqpW04/1CxI20Q4ROhBfQKGmhCCyE4DDUxokAsGdwLjgfPilIjwHQFe9Q/XoWwEJ/kCU0VfC9uv8APwKfsidvHRoAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 11 00 02 06" title="" data-src="/static/2023-10-11-00-02-06-d97b6054084e0c8c62d53d675a459c15-212ec.png" data-srcset="/static/2023-10-11-00-02-06-d97b6054084e0c8c62d53d675a459c15-8e534.png 200w,\n/static/2023-10-11-00-02-06-d97b6054084e0c8c62d53d675a459c15-fd412.png 400w,\n/static/2023-10-11-00-02-06-d97b6054084e0c8c62d53d675a459c15-212ec.png 731w" data-sizes="(max-width: 731px) 100vw, 731px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>这样写的效果和原来一样。与那种每次操作都启动一条线程的做法相比，这种方案使用的内存少，启动线程时的开销也小，而且调试起来较为容易。尽管如此，但它还是有几个问题：</p>\n<ol>\n<li>负责把网格推进到下一代的 simulate<em>pipeline 函数，要比上一条里面的对应函数 simulate</em>threaded 难懂。</li>\n<li>为了让代码更容易理解，必须用 ClosableQueue 与 StoppableWorker 这样的类表示特制的队列与工作线程，这会让程序变得复杂。</li>\n<li>与并行度有关的那个参数（即运行 game<em>logic</em>thread 函数的线程数量），必须依工作负载提前定好，而无法由系统根据工作量自动调整。</li>\n<li>为了便于调试，需要在工作线程里面手动捕获异常，并把它放到队列之中，然后重新抛给主线程。</li>\n</ol>\n<p>但是，这个方案最严重的问题体现在需求发生变化的时候。例如，除了 <code class="language-text">game_logic</code> 函数，现在连 <code class="language-text">count_neighbors</code> 函数也需要做 I/O 了。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-11-00-03-33-f0fd9f00efac4aa9c20ce222ce34818e-cd472.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 557px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 25.673249551166965%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAIAAADKYVtkAAAACXBIWXMAAAsSAAALEgHS3X78AAAA8ElEQVQY0y2P6W6DMBCE/f4v1F9V05CGCgKEw+AmxSAuB8wR4yYEaKUuSaTRanZ3ZH+LlENssE45JitCVcrWhL4YLvjNIdaz2izPesbfvKOWcixGT4y4X7QYMSLvfPP7ya6l292wmGAKE09M+L7G/QSClS/n4OfXB8n56eWMoHe7YZfWu7zWU65GhcVaNWJaUsKfALWlhZE3WlptvzOoJmu1pPoIU+vUIXjAaa/vAVXDzMybDYnBvDpECSKV5spXvA7CFSafcWGVYs8B8Go3l4dBQAWcRtFAD7Q2lyaEnrnBqnoHostRQ3D5ezAvumP/AyOuCOPj6vrKAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 11 00 03 33" title="" data-src="/static/2023-10-11-00-03-33-f0fd9f00efac4aa9c20ce222ce34818e-cd472.png" data-srcset="/static/2023-10-11-00-03-33-f0fd9f00efac4aa9c20ce222ce34818e-8e829.png 200w,\n/static/2023-10-11-00-03-33-f0fd9f00efac4aa9c20ce222ce34818e-2b773.png 400w,\n/static/2023-10-11-00-03-33-f0fd9f00efac4aa9c20ce222ce34818e-cd472.png 557w" data-sizes="(max-width: 557px) 100vw, 557px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>为了实现并行处理，我们要给管道添加一个环节，以便将 count<em>neighbors 也从主线程移到工作线程里面执行。而且，还需要与刚才一样，确保工作线程能够把执行 count</em>neighbors 函数时所发生的异常正确地播报给主线程。另外，这次有多条线程要使用同一张网格（Grid），因此必须给网格加锁，让这些线程有秩序地访问它而不破坏网格中的数据（相关的知识参见第 54 条，如何实现带锁的网格参见第 57 条）。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-11-00-04-02-80840825f8ae222d69d1448a436fd5e9-ac14c.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 674px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 85.7566765578635%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAIAAABSJhvpAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACZElEQVQ4y31TCXOaQBj1//+jdtrENFGUGwRBRUGO5Ua5jCQa81bSJG0zndnZ2YPH945vBxOHcNvkbmGPN8HNbPmdnw311Wjt3Zn2D9kYWd7QWM92j3r1REfZaWX3tq6eBubhIseVSAq1OPAkk5JKjPYYZnNm/UyvOqu7GPVp3pz0+nlePxvt+QNMf7Y/qmnDucnD2p/YoZo1clZjLYTF2CbD+ZpxCOslOMfJw9p9Lz7Az5SsYbfRxA6Gc+unYtybzhTbbcS5MejIWQPaSt7MUKNopbT6AIMY7sBzvPZvtdWvpcP7ObuNpbgEUkpKCFHzRi+vVCnz0wdtA2L2RynaKUmlJLWatxi8nwpBAZ7Mxodngp+p7559GgOe5EK4m7qxQAoOmHDPBSnnZzjHViuOi8eL0Zz/RVIwJOHTkeXzQQ7aIM9sAii/URdYK2kDz8R4D8KfQ/odVXtWslpNKs5LxpY33RDMQ936Jmr3C0cMCsR+v7AZOxCCXP8TT6OCjXJaMzahJm8I44RIHvVvabf4UK7vu1nxiET/rgw+iAExQjmu0QNQaNL5ZLYv5uEF7YHDtxluXxe4xXrwHgDyoCZ5iXj1D+FzQc7YIRdkEyfCDEbIDy7C/4lN0DCDnoBWdSLJ4dAEbLUlumW0cqd2NF55PClgmJTWmOUczUf7DPmDLwWDrZK1s+LAusnIcpEt1KJb0S1K3s4bSrUn3Lc33fa0oVDbHel3aQ1WcF5OKziHgqNNwLpp/5i+zrl/Q7B36qWsG7NeCsFQiGB6V76EvYHRBigohSXc5oEhBSQJ0U6Mynn1PyTGK5+3iiWX3YA/AAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 11 00 04 02" title="" data-src="/static/2023-10-11-00-04-02-80840825f8ae222d69d1448a436fd5e9-ac14c.png" data-srcset="/static/2023-10-11-00-04-02-80840825f8ae222d69d1448a436fd5e9-2d27a.png 200w,\n/static/2023-10-11-00-04-02-80840825f8ae222d69d1448a436fd5e9-cc70c.png 400w,\n/static/2023-10-11-00-04-02-80840825f8ae222d69d1448a436fd5e9-ac14c.png 674w" data-sizes="(max-width: 674px) 100vw, 674px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>我们要建立一个 logic<em>queue 队列，把它放在输入队列与输出队列之间，用来表示半成品（意思就是已经算出了这个单元格周边有多少个生命体，但还没有据此更新该单元格的状态）。另外，还需要再创建一批线程专门负责把输入队列 in</em>queue 里面的任务用 count<em>neighbors</em>thread 函数加以执行，并把执行结果放到半成品队列 logic_queue 之中。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-11-00-04-29-7503d45b0e19dd25ebf1afcea577b9ba-7599e.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 682px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 64.80938416422288%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAAAsSAAALEgHS3X78AAAB8UlEQVQoz31S2ZKaUBTk/38olcQZRQdHWWSTbZQdFLgssqhJ0Ko0jJVKHkxVP5xzL919TnMpNiBz05npNhtkfJjThvuifLyq1kTRV+5BJp3W/HoGamlHM8Omtf10uxOiYuUcwHxRzG+S9l3W+SjXm/4peZPVm7Tm4kIpr2p52SQnIamE4wCRtP+xHchslC2deBWkanER4gJHetcb5/uA7q49tx3IwqEEWD/jA8IFKbMP1n6qFGeJNHJxVk9Xre31tje6G0QfxaO9Uajk8oK03kyXD8nbzv/CihPZeN1+TBVzbrlyDqGWP5RiWkOOj3Mpa/hjuUmqgQwfLs5py5ubHrMPYS7EJbaQkEVIpKyVknrlJVyUy3m3DlLEsXKPyJLSuzuuF6ZL687aS2jDWVje2k+WTsSFGdaGOiYcI/gc+P5oz3dKKc/b6qoWZ5m0GAyqmEqtrnLR4RwLa/VPYDvi72L8VcdqczyxfjI+EsLs/HcnFtMGEmJ6UkgHQ2O0+szpTz2QMfb29AOeM83m/BSBTZCTYX8VlIXlvlkeG2ZsRPA78RzYkKBl9hGkwacwmJR3jB1PtR2zC2jTWToh4hWzGhthHZE0IqZAW12kfDgfry4gUkZ7w6cL05vrDt4m/BEYwny347Wf4VYfMRRN/0/d9L8Bd4SxwJOAvwkAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 11 00 04 29" title="" data-src="/static/2023-10-11-00-04-29-7503d45b0e19dd25ebf1afcea577b9ba-7599e.png" data-srcset="/static/2023-10-11-00-04-29-7503d45b0e19dd25ebf1afcea577b9ba-fc543.png 200w,\n/static/2023-10-11-00-04-29-7503d45b0e19dd25ebf1afcea577b9ba-27a37.png 400w,\n/static/2023-10-11-00-04-29-7503d45b0e19dd25ebf1afcea577b9ba-7599e.png 682w" data-sizes="(max-width: 682px) 100vw, 682px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>最后，要修改 simulate_pipeline 函数，以便正确地分派针对每个单元格的状态更新任务（fan-out），并把处理结果归集起来（fan-in）。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-11-00-04-58-19ca3f7f5cc34a94b69e6d275e8bd7b4-83dd9.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 771px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 71.72503242542153%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAIAAACgpqunAAAACXBIWXMAAAsSAAALEgHS3X78AAACFklEQVQoz01Sh3KqQBT1/38pM0nsIigiVUWBpbMriGCNmffOYokzd6h772m3NSbpJM57S69jrvsr0jY33YXbX/kdy5mEbEb3CqsVVslZKaeFmh/1/Y++v96rZR5+FVpJARPcZBrlvYX7qS5GbvStLb60JYbKSTmNi7GfCV6qbA969daslxdtd5ZTfkLyKWq4Dtqm3eH4ZLgJtd3FOv0DhlHfXm3P5uZmVD8Y8a0tRUJFLxXcqGd74D/2EugaB1ROd2Z1M95g35qbqSAGteAPwJET9m0yz48QLDaiYMEkYGD6qHuzWpy4K7RS2AHk8aruzrhq5QVQvOqbAQwIvH/Ba81ZtMz6d+CEHzP9U7XgUMfaDDcRmh8MGwQ1P00T7tnYp5MoH7qxQBIpYi0cwm3kxgMnEH3+IHjJXYhRc1gTiuBIeVF3J/iil9f59oDM1OLIaU/TEvOkkCq0nmV7xC6FDCXiGuUABCw/kxQ4Ngm3BqJueAH5JpB0sPa71lrys/6StHX7Q9ZFkk3jHLOwHriC0WgTwTY8A/yV8xVjYBjPOWAIWXCi3orM0nKw8ma0mhcnvl5ZqZVnpP0e+CMqeDtntegmCLa/8jrGurtw+MLaRHDigU26loNfjbotFD2jgvv1DXsHA0dOhKixkoIbgwhsBxHsmehnOAZ2jQpef8jwDZvAt59yeXN24Dk9l0nb83j15ssr5Puv/wom52UTub/yAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 11 00 04 58" title="" data-src="/static/2023-10-11-00-04-58-19ca3f7f5cc34a94b69e6d275e8bd7b4-83dd9.png" data-srcset="/static/2023-10-11-00-04-58-19ca3f7f5cc34a94b69e6d275e8bd7b4-b43f7.png 200w,\n/static/2023-10-11-00-04-58-19ca3f7f5cc34a94b69e6d275e8bd7b4-04931.png 400w,\n/static/2023-10-11-00-04-58-19ca3f7f5cc34a94b69e6d275e8bd7b4-83dd9.png 771w" data-sizes="(max-width: 771px) 100vw, 771px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>修改好之后，就可以让管道从头到尾走一遍了。这次，管道包含两个环节。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-11-00-05-29-e30a20e5bd7b539fb6ccc7ba13adbc97-83c29.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 722px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 106.37119113573408%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAVCAIAAADJt1n/AAAACXBIWXMAAAsSAAALEgHS3X78AAACc0lEQVQ4y41TiXLaMBT0//9ShxJszI3vCww2GOP7PiAk0HZl0jTttCUzGmYtad8+7T4oZmUv3GTuJuzmwKx3rLkfm87ST8W41upXtXr5z6KetM3YOtKGNdn5QlCOtu4XUePDQmuuanl5QB7oWxBow57uQyEsR5b7VdL5sCSyD8nvyrN9KEY1cE8yhKgiytUj8nC1Y7cHiM+daHFMAQbqduGlYtY+JrOmw25czs95L2d0i1k7nJ/N3BiG6UQcl/5pG6VmZz4oBoYNt2lj21fWUydc+tnY9qe7QM7PSnnBggXduv5GRvm5GzOmMzvEzGqHnmmdlKB1Cxh9YRPPQRUxaYS4VornX2QU01GvuCyOiZQ06Hm4cYHxkAnEnZDdHrmgmB2iiROwliulrfozf4r3c87LF248tjxMi9HejPN3vb2hSfyirzcM0OGPFlBIRYprPBLlxbgR0xOPnexEjrvXKve0P+J3Mh9WaHKgW0iYO2bMeo/kSc6PZvOuXILckw3wuWNKG7u+Ykpx85BJyDAJrjypJpSH68PY9vrKamQ62mfIGOPpPuiJ+nC1n1ge5pRe2bD6U20jN6ETx0jOkVCQG+03rbn+5Xb9J6ZwG9Fpb3nc7pYqBXFVLjBez0r1QkwuL5gTbOIIn3IXB6WVF94rwMcAyekJf2klPcEIJT9LUS0nrZxhtloAfCrZWUpxrRWDSi2eSc6cTxKGw2LUEBzVpFDSCmElgI+KUd3hSkqg0eLyHVNC3PBBCSmpI4Dc3SBdLLwMNCU9S3ELX5d+jk0cofrSy6TkRHVlaiwyXjFARZSjuiNU4JAWoprvlLs7DTAXlAA/ACzPZSMD4y+VAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 11 00 05 29" title="" data-src="/static/2023-10-11-00-05-29-e30a20e5bd7b539fb6ccc7ba13adbc97-83c29.png" data-srcset="/static/2023-10-11-00-05-29-e30a20e5bd7b539fb6ccc7ba13adbc97-5b578.png 200w,\n/static/2023-10-11-00-05-29-e30a20e5bd7b539fb6ccc7ba13adbc97-4dff0.png 400w,\n/static/2023-10-11-00-05-29-e30a20e5bd7b539fb6ccc7ba13adbc97-83c29.png 722w" data-sizes="(max-width: 722px) 100vw, 722px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>运行结果当然是正确的，但为了在计算存活的单元格数量时也支持并行处理，我们修改了好几个地方。虽然最终还是利用 Queue 把 fan-out 与 fan-in 实现了，但这样做的代价很大。这种通过队列来衔接各个环节的方案，要比每次做 I/O 时都新建 Thread 实例要好，但 Python 里面还有比这更好的做法（参见第 59 条与第 60 条）。</p>\n<h3 id="总结-54"><a href="#%E6%80%BB%E7%BB%93-54" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>把队列（Queue）与一定数量的工作线程搭配起来，可以高效地实现 fan-out（分派）与 fan-in（归集）。</li>\n<li>为了改用队列方案来处理 I/O，我们重构了许多代码，如果管道要分成好几个环节，那么要修改的地方会更多。</li>\n<li>利用队列并行地处理 I/O 任务，其处理 I/O 任务量有限，我们可以考虑用 Python 内置的某些功能与模块打造更好的方案。</li>\n</ol>\n<h2 id="第-59-条：如果必须用线程做并发，那就考虑通过-threadpoolexecutor-实现"><a href="#%E7%AC%AC-59-%E6%9D%A1%EF%BC%9A%E5%A6%82%E6%9E%9C%E5%BF%85%E9%A1%BB%E7%94%A8%E7%BA%BF%E7%A8%8B%E5%81%9A%E5%B9%B6%E5%8F%91%EF%BC%8C%E9%82%A3%E5%B0%B1%E8%80%83%E8%99%91%E9%80%9A%E8%BF%87-threadpoolexecutor-%E5%AE%9E%E7%8E%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 59 条：如果必须用线程做并发，那就考虑通过 ThreadPoolExecutor 实现</h2>\n<p>Python 有个内置模块叫作 concurrent.futures，它提供了 ThreadPoolExecutor 类。这个类结合了线程（Thread）方案与队列（Queue）方案的优势，可以用来平行地处理生命游戏里的那种 I/O 操作（线程方案参见第 57 条，队列方案参见第 58 条，与生命游戏有关的知识以及它用到的函数和类，参见第 56 条）。下面把那个范例用到的代码回顾一遍：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-11-00-06-45-a0791f48f7b2711d3c8aac8427ce5612-ae2b8.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 569px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 113.70826010544815%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAXCAIAAACEf/j0AAAACXBIWXMAAA7DAAAOwwHHb6hkAAACtElEQVQ4y41TiW7aQBT0//9Rq0JIbIfbwfeNL/AB+ATjEJKoswup1DZCSE9ovLujnRlmmZGf8m40iwu56MTtQWvO6t3D/BTUvmxMo620PYCs1m9qc+8wUt6q1Ss42v6s79/vZxLyfJ1Pgmy22nFOOA4yvTkr95Pl8ijtWjFrFtu9lB/V+oRVBb/1SaH4Flk7vOvHT2g2jp96+4HBirbHnAHU/fkWebLajINkut5ydsg70UB3EP7AWPLuCp+z9e4Gn5EgO28XWf2yacRdK2SVuDtQCy2AXBxv6Gd0KtI4fEC80X6YVDyxADvYogPwPfnZDoWk5KyAM4Oxnz4Z3g9BZU2faI6LxWY/CtKBauMM7c8/aRdHqBKSCg2Rik4img9i3iJ5pehQAQDo/1Y5Q4pWvxHZRD/pCcm5OV8Dv+CL7P/KxwydSFgXD5KNkvD2ijeD4XLFmh5kI0LejnqSNVCdiRcLcaH9nTyjkG6ehLhEVYDlsrsO7FQnCl7xZrCllF/NqejUtCQ48exE0yAbezFv+bNwyxoe7n92V9Nw86S7BDshwDza4ZppmLHmUtw2DJTgkr5iIdVFWrGWD05PtlCSSbR5NJaEZrjztFRpZy/lJXpJPakNOT/K5evFCVH4VYzb9WYkeCs7hToEjXw2VwLsEJNVR8F3ZN4NxayGSSgcLWMMYp8n5SKtH3XnJa1HfjJ01+TN/4ma/oVX2dD2oLl9yXxJq5GX9BV77MezMMNTx5aYozww1Sk18UUyAq5OAISMvYHm/BL1nmQMndVi0+C2nmxM/JQ1/J8LtSfpnB1wTjRfF5Nwg5PAiIneXHY92R660cRLOCucrnPc3xNNWIAKzvTHYYLTWJzHBWsFWBwY3ihISD0hA+8Bh/Aw50mFa1ndnYYpb3rIAuXRDtTtngwt7Bv1fP4NlUTPudhIaeMAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 11 00 06 45" title="" data-src="/static/2023-10-11-00-06-45-a0791f48f7b2711d3c8aac8427ce5612-ae2b8.png" data-srcset="/static/2023-10-11-00-06-45-a0791f48f7b2711d3c8aac8427ce5612-a301e.png 200w,\n/static/2023-10-11-00-06-45-a0791f48f7b2711d3c8aac8427ce5612-6d2d4.png 400w,\n/static/2023-10-11-00-06-45-a0791f48f7b2711d3c8aac8427ce5612-ae2b8.png 569w" data-sizes="(max-width: 569px) 100vw, 569px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>这次在把游戏推进到下一代的时候，我们不针对每个单元格启动新的 Thread 实例，而是把推进每个单元格状态的那个函数与必要的参数提交给 ThreadPoolExecutor，让执行器自己安排线程去执行这些状态更新任务，这样就实现了 fan-out（分派）。稍后，可以等待提交过去的所有任务都执行完毕，然后再把整张网格正式推进到下一代，这样就实现了 fan-in（归集）。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-11-00-07-29-67b1471085ed39e84002530886b54cff-d67a7.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 718px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 59.19220055710306%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAB3ElEQVQoz3VSa3eiMBTM//9N29piWUF5CQqoIE8NQQlPsa66Zwdtv23PmZNzA5l7ZyYh6p4rey5FTI4yKcpmaSENBdOySg4zPaukkH6sY2EdiV4qblPRT/W8sdvrsvlDjEMzP7T6odHzen5sdVYDxqG1yrOWV1bZO90N556nn8CXLzI4csJGS+/N9gG0f7XW2Aqr4JfpjteRsivkOJum+TxvUSs7Pgl2OhuGE8iehFSO2Sw5GHnjdnezOAHzY2fyExRBhcYqjdUQaAwCGz2rzaIfJsPYZLtX0uNsfxS9WNwkMP+xjsZuIIXZor7Y3c05/X3gDtjfmvGL2O0NQzTKoU2jpRTswf/tp+CPFhsUVnEyWANRzzgW5SfIYKELGcLobmjztvTkkIIvB1SO2HgVCPZ2vApFLxEcX9zE+PtiuirlyBWrmpXk0eYKsuCGwiCVvlirkeMhtnc3EP0dDsEnwrd4D47J+3nRIQLcJUGFvcXPyGBRnhEPjiKbZXXB9qlrMPmY8bwkp7u7iKC/E4PV0yiHPViVAorh7+4W4u3m62IhagmgHtbLovqEc5WWSJ7Y3RWT8cgwUGWVQrnx/YD+C/RCwOCbx46ANktymMENTYEkfzypy0/kAQ8LWP8BlIZ8qPZ8b2kAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 11 00 07 29" title="" data-src="/static/2023-10-11-00-07-29-67b1471085ed39e84002530886b54cff-d67a7.png" data-srcset="/static/2023-10-11-00-07-29-67b1471085ed39e84002530886b54cff-8a0cc.png 200w,\n/static/2023-10-11-00-07-29-67b1471085ed39e84002530886b54cff-ca50d.png 400w,\n/static/2023-10-11-00-07-29-67b1471085ed39e84002530886b54cff-d67a7.png 718w" data-sizes="(max-width: 718px) 100vw, 718px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>用来推进游戏状态的这些线程可以提前分配，不用每次执行 simulate<em>pool 都分配一遍，这样能够降低启动线程的开销。另外，线程池里的最大线程数可以通过 max</em>workers 参数手工指定，这样能把线程数量限制在一定范围内，而不像最早的那个方案那样，每执行一项 I/O 操作，就启动一条线程，那样会导致内存用量激增。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-11-00-08-05-688d440e014211fd7153fc56278c1517-95b2a.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 724px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 94.06077348066299%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAIAAAAf7rriAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACQklEQVQ4y4VTB5LaQBDU/79kl/HBkYPCColgCYQQyjlwd4DLPaszPocyVVNLzzC9Pdu7EmZ2MDn4Q8t73h4QQ9MZH/xl/obQigchaPWVt76u6tuq+a7XN726LssLRfH2/xCGu9PCyyQ/HxjHvnEcmM5ofxLdVAwK7RFf6KjbgXnqrfdTy5Pc9HljddTN3E1onIfKX3VjYDjd1W56CJSw7G8P2A6zaBg+f31EXn4bcvLEDpSg7G2sL2y98FKtvC6LR2R0j7nVMydWwgoW9NamhANzZRXibfBunn4gy1E5d1M1ObP0LAb53EtFvwBQkga269WNr1eNB9KPLkJ519WN/tZ6WpmfZb3D1r3V/kk3nugg4cjyx3YwPYbzU7Lws9HeE/38zhdUCHrp1A7RNLb8kXmE4TM7lMMSw6MVQElqzMWSRiTc/FJut1Hipqub/a3dN5xPkkb+WV5vu8ddQJOlL1JYou39/dzJbUlNXyaWjxXPY3IIaBDLBxjtXYjPnRgVNfvTfEF0k/kpHu5c+AzCsri0L/Tdrfr206rrP65KdDMcm2XkNlaVX89vQX38zv4ms7hZuCkQyHp5gR84ITC64RBLOCC3zvBFK6gBFbgIswT8QFzyCzms5ICwHACXSHFaycvliOr4chDsjlEPK0GJKtHLWNQAqDQFcM1iRCN6Od4cBJWobjl4S+CgAWQ0CBLUaJuyrS5OKV0sOMBOQgpxTVN4Of5iHEvcf6VVpsFAiGtSCCklTFFRCkJEe2GFGhV5CuIP46v7+1k1KJcAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 11 00 08 05" title="" data-src="/static/2023-10-11-00-08-05-688d440e014211fd7153fc56278c1517-95b2a.png" data-srcset="/static/2023-10-11-00-08-05-688d440e014211fd7153fc56278c1517-9e4f1.png 200w,\n/static/2023-10-11-00-08-05-688d440e014211fd7153fc56278c1517-4a316.png 400w,\n/static/2023-10-11-00-08-05-688d440e014211fd7153fc56278c1517-95b2a.png 724w" data-sizes="(max-width: 724px) 100vw, 724px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>ThreadPoolExecutor 类的最大优点在于：如果调用者通过 submit 方法把某项任务提交给它执行，那么会获得一个与该任务相对应的 Future 实例，当调用者在这个实例上通过 result 方法获取执行结果时，ThreadPoolExecutor 会把它在执行任务的过程中所遇到的异常自动抛给调用者。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-11-00-08-47-ddb368a8f057e2e91fa6a4aaadf97692-a36d1.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 604px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 52.980132450331126%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsSAAALEgHS3X78AAABlUlEQVQoz31Ra4+iQBDk//+lu5y3C4h6cisPR+UlzIDoOYwig+K6JlejftisySaVznRPP6qrNbvgPT8wI2aEqRXnZpS/LtJBtn5b1/p8+WNCzJgNstLdHafNZXp4/wzN33f2SjhcApNt44p2whtnKz1xdPCoEG880fri5O+6p+L6/IduRnQzSFZmmGHOMNvYRaVYxGxc8BHclRil6xHlX4tJc/HQte5I8wFiBFHQA+ozvtEaCeQeUbQfzIlUyRp4Orx1qhacb1a64ujtTrCAvz97uw5xt2oR9PYnNIWdcAlXAzEl0nypz5IXheXvadTzQzOkP93ZC0n0RarciPYjagbpmG3xpQcZhmnkcIbaVrKyC4EkK8r1gBohG9J/vWkEISCBETNIiBP0Y/a3FG+lILellGBmUgwhGN0Ms7WVlWg5a6/kcHmocN8Ze+IhPx773wVzuZwjtbnM5FX9ySv5fM/bhCf3EdRwnl9+iB1c3uK23r4DF6/ukOd/qXyCZixSY5HZedWPmJInoFZaQsJxDiHZ9/X/AWbUSc870mBJAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 11 00 08 47" title="" data-src="/static/2023-10-11-00-08-47-ddb368a8f057e2e91fa6a4aaadf97692-a36d1.png" data-srcset="/static/2023-10-11-00-08-47-ddb368a8f057e2e91fa6a4aaadf97692-765e7.png 200w,\n/static/2023-10-11-00-08-47-ddb368a8f057e2e91fa6a4aaadf97692-c9f48.png 400w,\n/static/2023-10-11-00-08-47-ddb368a8f057e2e91fa6a4aaadf97692-a36d1.png 604w" data-sizes="(max-width: 604px) 100vw, 604px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>如果除了 game<em>logic 之外，count</em>neighbors 函数也必须执行 I/O 操作，那么只需要沿用现在的代码，就可以让那些 I/O 操作得到并发，因为这两个函数都是 step<em>cell 任务的一部分，而 step</em>cell 任务会由 ThreadPoolExecutor 负责执行。即便要做的不是 I/O 操作，而是那种需要放在 CPU 上面计算的任务，也还是可以沿用这套接口（参见第 64 条）。</p>\n<p>ThreadPoolExecutor 方案仍然有个很大的缺点，就是 I/O 并行能力不高，即便把 max_workers 设成 100，也无法高效地应对那种有一万多个单元格，且每个单元格都要同时做 I/O 的情况。如果你面对的需求，没办法用异步方案解决，而是必须执行完才能往后走（例如文件 I/O），那么 ThreadPoolExecutor 是个不错的选择。然而在许多情况下，其实还有并行能力更强的办法可以考虑（参见第 60 条）。</p>\n<h3 id="总结-55"><a href="#%E6%80%BB%E7%BB%93-55" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>利用 ThreadPoolExecutor，我们只需要稍微调整一下代码，就能够并行地执行简单的 I/O 操作，这种方案省去了每次 fan-out（分派）任务时启动线程的那些开销。</li>\n<li>虽然 ThreadPoolExecutor 不像直接启动线程的方案那样，需要消耗大量内存，但它的 I/O 并行能力也是有限的。因为它能够使用的最大线程数需要提前通过 max_workers 参数指定。</li>\n</ol>\n<h2 id="第-60-条：用协程实现高并发的-io"><a href="#%E7%AC%AC-60-%E6%9D%A1%EF%BC%9A%E7%94%A8%E5%8D%8F%E7%A8%8B%E5%AE%9E%E7%8E%B0%E9%AB%98%E5%B9%B6%E5%8F%91%E7%9A%84-io" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 60 条：用协程实现高并发的 I/O</h2>\n<p>在前面几条里，我们以生命游戏为例，试着用各种方案解决 I/O 并行问题，这些方案在某些情况下确实可行（后面的范例代码还要用到这个游戏所需的一些函数和类，参见第 56 条），但如果同时需要执行的 I/O 任务有成千上万个，那么这些方案的效率就不太理想了（参见第 57 条、第 58 条与第 59 条）。</p>\n<p>像这种在并发方面要求比较高的 I/O 需求，可以用 Python 的协程（coroutine）来解决。协程能够制造出一种效果，让我们觉得 Python 程序好像真的可以同时执行大量任务。这种效果需要使用 async 与 await 关键字来实现，它的基本原理与生成器（generator）类似，也就是不立刻给出所有的结果，而是等需要用到的时候再一项一项地获取（参见第 30 条、第 34 条与第 35 条）。</p>\n<p>启动协程是有代价的，就是必须做一次函数调用。协程激活之后，只占用不到 1KB 内存，所以只要内存足够，协程稍微多一些也没关系。与线程类似，协程所要执行的任务也是用一个函数来表示的，在执行这个函数的过程中，协程可以从执行环境里面获取输入值，并把输出结果放到这个执行环境之中。协程与线程的区别在于，它不会把这个函数从头到尾执行完，而是每遇到一个 await 表达式，就暂停一次，下次继续执行的时候，它会先等待 await 所针对的那项 awaitable 操作有了结果（那项操作是用 async 函数表示的），然后再推进到下一个 await 表达式那里（这跟生成器函数的运作方式有点像，那种函数也是一遇到 yield 就暂停）。</p>\n<p>Python 系统可以让数量极多的 async 函数各自向前推进，看起来像很多条 Python 线程那样，能够并发地运行。然而，这些协程并不会像线程那样占用大量内存，启动和切换的开销也比较小，而且不需要用复杂的代码来实现加锁或同步。这种强大的机制是通过事件循环（event loop）打造的，只要把相关的函数写对，这种循环就可以穿插着执行许多个这样的函数，并且执行得相当快，从而高效地完成并发式的 I/O 任务。</p>\n<p>现在就用协程来实现生命游戏。我们的目标是让游戏能够高效地执行 game<em>logic 函数里面的 I/O 操作，同时又不像前面提到的 Thread 方案与 Queue 方案那样，有那么多缺点。首先修改 game</em>logic 函数，这次必须在定义函数所用的那个 def 关键字前面，加上 async，表示该函数是一个协程，这样我们就可以在函数里面用 await 做 I/O 了（例如从套接字（socket）之中异步读取一份数据）。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-11-00-11-55-f52b0fab32f6e0a324d1014449382500-f690e.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 487px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 78.43942505133471%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAIAAACZeshMAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACHklEQVQoz5VT2ZKaUBDl/z/JaMZRFBeWy46iICD7vjkqmKQvTmUmb6aq61YvHvv06YYg99Z8f5rKuphdhLhBQSWXd7l6yYgxUkeMMN9ZfFwLSQsml7dXwWxQAEzMPuTiptYdmFS93JkLy7Xl016yOvnkwV6fAvl1MJ+2bJBzYQHGhgWK6/8Aq+1Du/wGkZTqrl1+Qag2vdo8wFHqXml6/Lsaqh0kP8O/YBTVKKyErIW2fFSLaQuD0H7G+CmwQHEllVcx/5CKK4qA1z+7IJa6QzsxDDwR9gvdWRneTDFHrDQWNMpw33cGKMr5Be0mP5C8PJ6V4msXxJMbVju/Dqw6yDyZ41LdDa3wi8PBkb6BO8DAwFDAL8DwtN0zrz6rzefwQ6bXhhAcYmMHy6OzdRMgTB3cleWPWHFpuAvdnmoGqVtzzZypxsp02bCcKsZU0secutRtcm8TfFKjCAvGJ62UX4X0wvg5JIWs4aIK32zaCEkDL2jGDRKCohgVV5g28GT8bHUKuKSi3ZT1czG5rM8xbJ5xM9rLGG9QPqzhFlk3hWZScVOaBwGXDEpQxnmm6DACZXg/5cPaCsidOd+ZkH8TdhOkbuxwbYWLvT3htZl6QGEJKEIqb6AteTy/awaKSvgvyvRgcuBJHd2tFZK6vTg4m3O8caI35QhL3VoBTASUiafoQAMzqXvYhIrFfEASOyU+LOxg/XsN7g9/PMPOqvsfmmZaLJYA4DIAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 11 00 11 55" title="" data-src="/static/2023-10-11-00-11-55-f52b0fab32f6e0a324d1014449382500-f690e.png" data-srcset="/static/2023-10-11-00-11-55-f52b0fab32f6e0a324d1014449382500-28e07.png 200w,\n/static/2023-10-11-00-11-55-f52b0fab32f6e0a324d1014449382500-e077b.png 400w,\n/static/2023-10-11-00-11-55-f52b0fab32f6e0a324d1014449382500-f690e.png 487w" data-sizes="(max-width: 487px) 100vw, 487px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>同理，给 step<em>cell 函数也添上 async 关键字，把它变为协程，并在调用 game</em>logic 的那个地方使用 await 关键字。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-11-00-12-49-bc1a907508384b1dde5e69195a51a5d9-82fb5.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 638px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 22.100313479623825%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAIAAAABPYjBAAAACXBIWXMAAAsSAAALEgHS3X78AAAA2ElEQVQI1xWPW3OCMBCF+f//qA9VarWGACoMREaQQCQXIbRcwkylOOP2Zfeb2cs5x8KlxOzushoVyinkJqGIii/KffEdNOM+q06qR1SiQsbDTMYl7ueof8T9A6oFzZc/H+S6yyrvpldxCsf4VmOuw3Y6yi7UBiDufskwn7SBF8n0PJuFjH8WmZ4H1a2jy3uQ2OQKOpjVAKBmR+nbIfxMcptk4G53Yet/qHHVuFwf74NFzOKrDjZQIRxwDjOIQMU+55tz7vHWrRpUSldop1SBNhBnmzKnlJ5oX4yL0A75AfUAAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 11 00 12 49" title="" data-src="/static/2023-10-11-00-12-49-bc1a907508384b1dde5e69195a51a5d9-82fb5.png" data-srcset="/static/2023-10-11-00-12-49-bc1a907508384b1dde5e69195a51a5d9-38c7c.png 200w,\n/static/2023-10-11-00-12-49-bc1a907508384b1dde5e69195a51a5d9-c00bc.png 400w,\n/static/2023-10-11-00-12-49-bc1a907508384b1dde5e69195a51a5d9-82fb5.png 638w" data-sizes="(max-width: 638px) 100vw, 638px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>simulate 函数也同样需要变为协程。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-11-00-13-02-a2a779dba28317e8539fa692eac11988-05988.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 764px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 54.45026178010471%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABh0lEQVQoz21Sh26DMBTk//+pqrIHgSxW05QkgAnLBhMyyKh6hrSKUKWT5XXv7p0tyW6kEDohtL8hapiZxd043AAtv2q8xKjzEtAq6Fi+QAJhFh/UkM+iHCWUIAXUIMPZXyGjuFfze5M8C/los+9+up3Vbmj73ZXztjDbpj3cBp3PnewlE8JGTjSwCXaaZPP4mCeF4rMFPWpZaRUPI7/VZ1p2wc5SjJdlel6mlyYZltD2wPamAVdcqu5TGRHs2cSnYy+es6N+uDU4T/BSqhXUiMtuLLvJCG4/7Jaxbhlf7/oaXSzZSTRcoaZVKYggpGcZlOelkIoOU591rW1v7UxIsqAFLExDriJIn0EGl6dRPos4PL6Q8yvSHu/Cvk3a1rZtbTqr7ZwiDgoa8lcI09IzriEjoRFkgizCYCcAZHQue7GYVGqQQqLPp/q1rSE5YaGU0ACqooyIyo3x2hAfOyGYA9vHkVH9Fv3lk6h7uKBqwAUZPeAlYQ+cnk1g0jp9IxKh+V/U9bcBfgBvW05zInudPwAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 11 00 13 02" title="" data-src="/static/2023-10-11-00-13-02-a2a779dba28317e8539fa692eac11988-05988.png" data-srcset="/static/2023-10-11-00-13-02-a2a779dba28317e8539fa692eac11988-dc8ef.png 200w,\n/static/2023-10-11-00-13-02-a2a779dba28317e8539fa692eac11988-69e4e.png 400w,\n/static/2023-10-11-00-13-02-a2a779dba28317e8539fa692eac11988-05988.png 764w" data-sizes="(max-width: 764px) 100vw, 764px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>async 版本的 simulate 函数，有以下几个地方需要解释：</p>\n<ol>\n<li>它在调用 step<em>cell 的时候，系统并不会立刻执行这个函数，而是会返回一个协程实例，稍后会把这个实例写在 await 表达式里面。这里的 step</em>cell，好比那种用 yield 写的生成器函数一样，调用时并不立刻执行它，而是返回一个生成器实例。这样就可以实现任务 fan-out（分派）模式了。</li>\n<li>内置的 asyncio 模块提供了 gather 函数，可以用来实现 fan-in（归集）模式。把 gather 写在 await 表达式里面，可以让系统用事件循环去并发地执行那些 step_cell 协程，并在全部执行完之后，再往下推进 simulate 协程。</li>\n<li>由于这些代码都是在同一条线程里执行的，因此不需要给 Grid（网格）实例加锁，至于怎样让这些 I/O 操作表现出平行的效果，则是由 asyncio 所提供的事件循环来负责的。</li>\n</ol>\n<p>最后，要调整原范例之中用来推动游戏流程的那段代码。我们只需要修改一行代码，也就是把 simulate(grid)这个协程交给 asyncio.run 去运行，从而利用事件循环机制去执行推进单元格状态所需的那些 I/O 操作。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-11-00-15-15-d8feac3b1799048b89542c97f238b7bf-1dace.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 770px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 84.4155844155844%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAIAAABSJhvpAAAACXBIWXMAAAsSAAALEgHS3X78AAAB8klEQVQ4y41TaXPaQAz1//9TTQmBgo1vY0K48e31sb5CgKR98no6nemHMKPRyNp9T9JbWVKCTPGzX4fwZePBTw+hnlZOdXOq67cmLZu7w69ufXebO2K3/aTMA0gCv2xOip8rHptszmpIgZV3j4KflhvARu5OPqWLIP9hv43crVN9PAQerfbTnTd+Pah+roXlT3f7vD48Wnm02k22Z3g0rAUFKj+tHq4s+5kac2husNbMOjlgSphBQod/j5dmeKStp8cVBn5eH2eHQPay+Sm1y8uyvtmg4B8272/38WAVeUnxmeynGHu6DyDeeL3X4kqL+SIsILvbftET1jenvvUBmcjgRaXXy+/5OYFIs2NEA7vb6S6A4E/O23h9BONk7+tJpSXV7JzIPsOAs1OshsX8lEhW0RlpjVIwjI1mrPKCbu2SAjNrzbyz+QVTWMV7b33Qf0qylyyifO6l2E01Kqmf/4wGFsE/GXjJYLWVv2Mr+w39RIVBm+qKIvBCLbu4/NWM8j1esrJu4Wfo3GCNntRaxI20QbdGUushhzdZi7wecZM1QxxyscISrqp00IJF6CxiwMCoExFEaXBkCtIeP4ARqWEJALHGNcYWFbSohKR0jxERbVEyVMYvDBbRdku3sw4H4pgUZn0ypebFp0GMQ2U0Iir/AZixk0cl1MJcAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 11 00 15 15" title="" data-src="/static/2023-10-11-00-15-15-d8feac3b1799048b89542c97f238b7bf-1dace.png" data-srcset="/static/2023-10-11-00-15-15-d8feac3b1799048b89542c97f238b7bf-f7e89.png 200w,\n/static/2023-10-11-00-15-15-d8feac3b1799048b89542c97f238b7bf-20ec6.png 400w,\n/static/2023-10-11-00-15-15-d8feac3b1799048b89542c97f238b7bf-1dace.png 770w" data-sizes="(max-width: 770px) 100vw, 770px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>这样做的结果跟原来相同，但是这次，我们不需要再花费资源去创建线程了。另外，Queue 方案与 ThreadPoolExecutor 方案虽然能够处理异常，但仅仅是把这些异常从工作线程抛到主线程而已。跟那两种方案相比，采用协程所实现的这种方案，调试起来更为容易，因为我们可以在调试器（debugger）的交互界面之中，以单步模式来调试这种程序，也就是一行一行地去执行代码并观察效果（参见第 80 条）。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-11-00-15-48-b97f70b39c1c47d81ca5da1745841564-4f495.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 498px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 53.012048192771076%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABwElEQVQoz21RaZOaQBDl//+fVCXZjdGsEF0BuQdFxIMFXE4ZxwN0K2/QHB9S1dX1pqdfdb/XwsssmGzfx+tkOF9LfvhprA69zdBbPWu2tNj8mAU9ay76GyWuBrNVzyCfZa3vLF7mKz1jgp4zszgCWfXFrM5GwazybO8vRs6QEWZ1sqqzBbDnv0ZxxJMX9xeBHK7om0aFnh2UuJCCaLqr1LhUkZNSjnIlKrSUokeJcpDVXYGiXhwd2goOvaJvtIpeu+UHjj9ex+Jiq8bFJMrEZSgt30arBISfwdt0V76G75Mw1VPKyXbdYDesStjVPdxm7IOwm8tu2Ajhsg+O2c3BE5le74DQFkTBqVt739zDqpq/mOfWqi4IszxDJ7qB+Vd94SNB7tue6G1Ef6tsUtj4bJAvsikttpIXPmkO/IeQPlnAdlg19LZKXGL4gwx7uJldwA89o1paA5jlScsoZuIWwEYBw5tuhcdYTsaRjfIE6/EBD9wDV2VDEm070DgdBuAE2jzAnYxz94zZd3M+cAOcxMyPUEVq7gdcdP4YUf8nhCfNhuY+CabJHvK+yuY3naACkUM3GC2TgevLcU5+6/w3fgEj7El+KGfZDAAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 11 00 15 48" title="" data-src="/static/2023-10-11-00-15-48-b97f70b39c1c47d81ca5da1745841564-4f495.png" data-srcset="/static/2023-10-11-00-15-48-b97f70b39c1c47d81ca5da1745841564-cbe84.png 200w,\n/static/2023-10-11-00-15-48-b97f70b39c1c47d81ca5da1745841564-413cb.png 400w,\n/static/2023-10-11-00-15-48-b97f70b39c1c47d81ca5da1745841564-4f495.png 498w" data-sizes="(max-width: 498px) 100vw, 498px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>如果需求变了，例如 count_neighbors 函数现在也需要做 I/O 了，那么只需要在已有的代码中把这种函数声明成 async，并在调用它的那些地方添上 await 即可。我们不用像早前的 Thread 方案或 Queue 方案那样，重新调整代码结构（其他范例参见第 61 条）。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-11-00-16-03-f931f1eb21420a4f82f4ad9e252cccf4-cdc09.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 721px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 112.89875173370318%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAXCAIAAACEf/j0AAAACXBIWXMAAAsSAAALEgHS3X78AAACyElEQVQ4y41UiXKiQBDl//9pYzQHIhBuMIqogBzDfXlEd2vfQCpxs9lkq7qoppl+87r7Ncx0Gwm7jPcI76d3tsd58f3SHVtr1gkQUUjDbsLpJjKqF6M+fzDGaM5GeYKZcJqz2ZtR4+jL4FxHeju9+YzgJ3JUynH1FBX8LhWCfOYRJWnUfM+5sZq0M59ISXOV/G6MmnW8S260Be8mY2M1sVYzN0a+nh+eolJNO4AqaWtUJ7N+sZqLDqe9vCbP979mLvmhzieWwzo7sGCXnhQUY8t5sP3J8wa4Y3P1uPLFXYbgyLAlUgOCJlvtBXdO5g63jbhNyLmEdXyg4BzvJaCAdqI0MchlUrPrYLqN4evlkSajGXLaSnGJIrXiIFKSjRDlUlKDHqCHJ3Was9X9hL3THllLYAPsfrkV/BTcwMps+lZXJ0rvyvQh8tawW2MJkpP5Gm1T4ubBdkf6QgjSP8fzuTE3ffLdYj3bEjVp0JiR9oyZvXH7KhlHH21vZGJCBHq6X7g36lz4z2Q6Az/F5Shby/eAeLA9OWnQmO+Tpbji/QR91rKOTiXIpahE56CQXs9fJqPJUydEPu+l0MnkeS0GGdQKhSJ5EPa/SmAgOlQI3TyudrfmClJjbY93Y6BAXk9hDv2iikEVH5NRG6rlXMocq8dtY5CnaluHVE90H6kDIn8PjwFDmNivNFAGktarUTENr5/TRoUgJpFKJhWe1wL6vttyUqPh8OiuNRcVbc8PenXE70EvDsBF2/TiqJVHLCZ4oTpEZLrhJwYnpBB72ypJi2lhdfADwCt8CA6y0bJ9H+lQNpYcnyjTuMYBRooq0ce6NUra4YMYFIhgsYAlBRX1k1aGH9f4pPQoOIxX8GWAqgCmz9SzvRxVNJJ2WrqnvST1cDOulcJCozeDUQuyIMVQPinliScgEBoiSO7vp7SVPqEvoev5t0N1vwGt8dARDPqyfAAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 11 00 16 03" title="" data-src="/static/2023-10-11-00-16-03-f931f1eb21420a4f82f4ad9e252cccf4-cdc09.png" data-srcset="/static/2023-10-11-00-16-03-f931f1eb21420a4f82f4ad9e252cccf4-1b809.png 200w,\n/static/2023-10-11-00-16-03-f931f1eb21420a4f82f4ad9e252cccf4-50d02.png 400w,\n/static/2023-10-11-00-16-03-f931f1eb21420a4f82f4ad9e252cccf4-cdc09.png 721w" data-sizes="(max-width: 721px) 100vw, 721px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>协程的优点是，能够把那些与外部环境交互的代码（例如 I/O 调用）与那些实现自身需求的代码（例如事件循环）解耦。这让我们可以把重点放在实现需求所用的逻辑上面，而不用专门花时间去写一些代码来确保这些需求能够并发地执行。</p>\n<h3 id="总结-56"><a href="#%E6%80%BB%E7%BB%93-56" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>协程是采用 async 关键字所定义的函数。如果你想执行这个协程，但并不要求立刻就获得执行结果，而是稍后再来获取，那么可以通过 await 关键字表达这个意思。</li>\n<li>协程能够制造出这样一种效果，让人以为程序里有成千上万个函数都在同一时刻高效地运行着。</li>\n<li>协程可以用 fan-out（分派）与 fan-in（归集）模式实现并行的 I/O 操作，而且能够克服用线程做 I/O 时的缺陷。</li>\n</ol>\n<h2 id="第-61-条：学会用-asyncio-改写那些通过线程实现的-io"><a href="#%E7%AC%AC-61-%E6%9D%A1%EF%BC%9A%E5%AD%A6%E4%BC%9A%E7%94%A8-asyncio-%E6%94%B9%E5%86%99%E9%82%A3%E4%BA%9B%E9%80%9A%E8%BF%87%E7%BA%BF%E7%A8%8B%E5%AE%9E%E7%8E%B0%E7%9A%84-io" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 61 条：学会用 asyncio 改写那些通过线程实现的 I/O</h2>\n<p>知道了协程的好处（参见第 60 条）之后，我们可能就想把现有项目之中的代码全都改用协程来写，于是有人就担心，这样修改起来，工作量会不会比较大呢？所幸 Python 已经将异步执行功能很好地集成到语言里面了，所以我们很容易就能把采用线程实现的阻塞式 I/O 操作转化为采用协程实现的异步 I/O 操作。</p>\n<p>例如，我们要写一个基于 TCP 的服务器程序，让它跟用户玩猜数字的游戏。用户（也就是客户端）通过 lower 与 upper 参数把取值范围告诉服务器，让服务器在这个范围里面猜测用户心中的那个整数值。服务器把自己猜的数告诉用户，如果没猜对，用户会告诉服务器这次所猜的值跟上次相比，是离正确答案更近（warmer）还是更远（colder）。</p>\n<p>这样的客户端/服务器（client/server，C/S）系统，通常会利用线程与阻塞式的 I/O 来实现（参见第 53 条）。这种方案要求我们先编写一个辅助类来管理发送信息与接收信息这两项操作。为了便于演示，我们采用文本信息的形式来表达所要发送和接收的命令数据：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-11-00-18-37-95020239ba0a207b5cb4f9ceddadb9d8-8157d.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 541px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 92.97597042513863%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAIAAAAf7rriAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACyUlEQVQ4y22Ui5KaUAyGff83ardd74qiCMLhIldBUBC5o6K72/4Hd2anXWeiE6M/Sb4kdhhrJxzznqz3iTExvInhDhRroDk91Rzq24npyXkjF7en1llFxWjjTMzdOq74YwkT4pILc8T5uIJPioYUt6fWUep3ISqVrNHOH2pr2uUPTK0/5PKNlHcpb1p98/0pnbkbimk9dfYD3Z27EXU0e2S4y32iVG+tvcvVm/xwyvs/Yu6QTnSXcQ4L/zRQbNQ/dYJfvNJXLZJcZ/ZhavqsG9LnmsH6WMnFl76DviFgvYj147Hpj6jYn5qgWHFB1pfNYUtktHFZ/0Ty26MK0pbQEbNrjxhj3R3p7guvTEwfSRBBnrG+fZU244071OxXUZttD1yQcEG6DBIxvVAxKe4LPxbiWkquqzAH83VcowU0vwpTdnfk9ikyz71osU8BaHXIEJGSVsxHJR9ViyABoeUhF9OrGNesj48pgmpNmWEEGAp16k94D3IdPsz7RP/Nk7HhDTUHRb6Kmx9LERSHqsOHBckbKb+2A7s93r+A4cXY/sTYkbSZe8efHAEkxgrwUHZ7WB9LmhaEni4JWv8tqhgSf8gYMxjINmP5PdlA8IUn813EockwA9cnYprZDZd+DDaofObsF7sIYBEZmV5fc4ab7dh0hVP934ZQMdiK6VlIauFUCclZTM5Yb/wOu4mValFRWt+VVAz0I83pysbUDnBPXUnvEp3dRVJ65Y8FCqYXEhXrU/2s7LxhTB+ccR7gNFDtpZ/M3Ij1aBd92cJuAvvCTz6Tl63yMSqMYRXlWJqZHXD7rEvM2TZEUC5vUoYJXdXiruC24GcXKWvWyRm+EFcYGwUm5zeSXOjAdA9bTa9CttACMjN2gEZQDr4dGltcEQ6ur1lTKxBPF1o2cuIPZOHFuIRXiTYMBzPvySZ2uysZaEQpP4+hZdlafvsLcLbtv7OKb6cAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 11 00 18 37" title="" data-src="/static/2023-10-11-00-18-37-95020239ba0a207b5cb4f9ceddadb9d8-8157d.png" data-srcset="/static/2023-10-11-00-18-37-95020239ba0a207b5cb4f9ceddadb9d8-696af.png 200w,\n/static/2023-10-11-00-18-37-95020239ba0a207b5cb4f9ceddadb9d8-4fa96.png 400w,\n/static/2023-10-11-00-18-37-95020239ba0a207b5cb4f9ceddadb9d8-8157d.png 541w" data-sizes="(max-width: 541px) 100vw, 541px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>我们用下面这样的 ConnectionBase 子类来实现服务器端的逻辑。每处理一条连接，就创建这样一个 Session 实例，并通过实例之中的字段维护跟客户端会话时所要用到的相关状态。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-11-00-19-10-e0a1c1f189c670bf79399d756462b26a-91452.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 521px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 107.10172744721689%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAVCAIAAADJt1n/AAAACXBIWXMAAA7DAAAOwwHHb6hkAAAC0klEQVQ4y41U2XLaQBDk/z8nL0kMsYEgIS7dF+gWOgEJHYAMxiYtwHaouGJXTW2tRtO7PT0z26DsoKuYQzceh+mDpDUZkXJjZfMs5nupOPzfGmK255OtsK7wIWaP4roCrEZmXwA/iPodI92xMr/aCMstMXP75hx0xLT6HNxVrSYr/WQkZlEIqy2hz7uq2Td8cf34FbCJPFuMxCe7Gqw5pD6nTF/IH+Xy6RNwR9K+9UYtVhl7S+ApJ/g9s3szZ+ythHR3CRKLc/4XCfO/wEyUT4J0HKRQS9k+gy2/2oICVmgOz3l9qTev9saoQUc5HaaQZ+DGpOWTVkjaAWH4pB12ZzblhMOzf+DEhOlT87hvh3SUSWd8g47z0Xw5MHxi5iCCskLKDknD71tB3/QnQTKCeUvE9M1gHCRDd8HGxfXmCzEcz0Zrdfui7k7T6my7k1qd4JlWsJO6w68XZXNE8DttLi64OJfzPRMXbJyzi2ISrsf+ilsU2GOFcnSQ4te/xWtM/BSFIQ2vLeuk7nVkvS3NOorZpMWWoPZ0t8Wp6KIHYVqLf1u8Rs2kPAIsLEt+USJPUnfZRU45UVs2kB63LO8lraMYTJzJ5RGc32nXZcz3yFwqnvq6S9YVXkAzMCJ0D1wGdoyGa3IqobnofHZV8un2HXy1fE8a874VIlVCdzuyMfFXAHRkE589zUVHQIue5qBaN2BhvUOTgA9Y8OtKLmsnn8K5F2p/fTR/bjikiUhMIdYz7WyPDqejdOItH4RZZ2pRln8vIk+zrRgdRUc50PBQDu0x8ZM7Wvw9tcHienM9wPkBrwK8Aztq0hKihWQ3sALMHKqFy0HhEilk1eWpuMm5O7UgO+T5PuRwhJhU3an9Y8zRYSZvjtew8nCj9iv4gGuh2cAK25JGah4TFSNvdS8oI3eBIn0wkm87MMEb1tMdHIGH5ReHDplzy01P94RkK300238ARVJanuaye04AAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 11 00 19 10" title="" data-src="/static/2023-10-11-00-19-10-e0a1c1f189c670bf79399d756462b26a-91452.png" data-srcset="/static/2023-10-11-00-19-10-e0a1c1f189c670bf79399d756462b26a-e8fc4.png 200w,\n/static/2023-10-11-00-19-10-e0a1c1f189c670bf79399d756462b26a-c0ace.png 400w,\n/static/2023-10-11-00-19-10-e0a1c1f189c670bf79399d756462b26a-91452.png 521w" data-sizes="(max-width: 521px) 100vw, 521px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>服务器类的主方法叫作 loop，它会循环地解析客户端所传来的命令，并根据具体内容把这条命令派发给相关的方法去处理。请注意，为了让代码简单一些，这里用到了 Python 3.8 引入的新功能，也就是赋值表达式（参见第 10 条）。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-11-00-19-36-c8a1e626616195cf3418d0544af6af21-ff6e4.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 479px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 64.09185803757829%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACNElEQVQoz1WRiY6iQBCGef8H2ozHqoMKyCVnN4e0DYiACCKCozNqttxJnExSqaS78v91fAxr+2KYimHWV+0pJnM/ZNFKinO3e6Dmah+v+PTldnfUfDrtzW1vkJ3uhtsbVBmzOqPmaxFlA90RSCrHexYHE+Rz60TbnezqIkY71l1recMFW9aLFmHOky1k8GX4MJOSAt5QFuPdOyJ92fgjKGAhkEyk2btLwFrZlFJcCFGmppWU7NVt/RQPNYcjG54kclJyq2hkODMv4kkqkGRsr95RwJPYbe9G2aETDPxA7Q13dxjbbj4ZrWiV9DBz6V/TnbpEpPly1+jFSY4LFpOJ7XN+vExr2M46XiFAY39nEFv1Bzzmq5h11jD2yPLgZn3FHlv+xPQmOBgsEbhINLOPn9+aVzCsQ+RNISfFyPSmLgUX/nmqBtVXGbw09CbprEOt6vxq+CPG/3eY+/HI8MWoGFk+NGc92lOsoYrgkGK8BzxmffkZ+yWe+SF0lsIMxp75EaDmgkjZVsv0yMEumAyW9iLa4SOwvePu8Uts7FuYR1hve7LJA0mHTj0KLkq8h4NPLA/WAV9utRFoytP0lxiawIZimKtZbZRnAKY8SRZqArkU6Bb+AeyCZmr2JAyoXsFAWYxzgGEdLs+oLvq+g2xUZ71szcMFIGm7o3n4sA5Xs/zQixboQlbzmoFrgQe0mnuhuE65IBmauKfZAw0DrTfZGKhWXzVYl3JBDAca235PMYc6GlnuP6uapMGR5ViLAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 11 00 19 36" title="" data-src="/static/2023-10-11-00-19-36-c8a1e626616195cf3418d0544af6af21-ff6e4.png" data-srcset="/static/2023-10-11-00-19-36-c8a1e626616195cf3418d0544af6af21-d5807.png 200w,\n/static/2023-10-11-00-19-36-c8a1e626616195cf3418d0544af6af21-dba8d.png 400w,\n/static/2023-10-11-00-19-36-c8a1e626616195cf3418d0544af6af21-ff6e4.png 479w" data-sizes="(max-width: 479px) 100vw, 479px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>第一种命令叫作 PARAMS 命令，客户端在新游戏开局时，会通过该命令把下边界（lower）与上边界（upper）告诉服务器，让它能够在这个范围里面去猜测自己心中预想的那个值。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-11-00-20-22-6f7cef4917aa2d187f7807b3a9138ac3-5032e.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 438px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 34.70319634703196%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAAsSAAALEgHS3X78AAABW0lEQVQY00WQaXOCMABE/f8/SduqyCGoFMQkHIEAIQhBtFxOPdt02pnO7Ne383ZHyzAz4uI9P+pxscnqZZRrUa7ibEO5iqkR73fV2YhLLWQ62Zushqcram6/GakkN4uTnpSSF08BnsFo4SWvjj93o7ENNZKL6kWQqCFTQrrKatBcQfuXERoe7vlLT4slYUpA7bJ1DsOa8jkKJxYSOhLCzqHf5Eebd+DjArrbP7xrLrC7rbPqZeu9OsGWd1s+rGgthCfvQPLjN4g1wiQvEoKwu/9gzUVQoL38wKi/67ScWLsZxNuqB8dPa38ySDE2dzJO5yjSIiZ7xK56d3iC9iZM3fPT7R+/8EMlbLyxZwBbh14LM8VPjISLCxQ/njrBApMpFC8Qi7dOPchBqmAqpo3gxxW1dzFplXJzfzSLxki57KdrVutpZSSlHNAVqxTM5ohYZWsVzZvjSSgWS78Bmv5rwL3mA8wAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 11 00 20 22" title="" data-src="/static/2023-10-11-00-20-22-6f7cef4917aa2d187f7807b3a9138ac3-5032e.png" data-srcset="/static/2023-10-11-00-20-22-6f7cef4917aa2d187f7807b3a9138ac3-86481.png 200w,\n/static/2023-10-11-00-20-22-6f7cef4917aa2d187f7807b3a9138ac3-1ca59.png 400w,\n/static/2023-10-11-00-20-22-6f7cef4917aa2d187f7807b3a9138ac3-5032e.png 438w" data-sizes="(max-width: 438px) 100vw, 438px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>第二种命令叫作 NUMBER，表示客户端要求服务器做一次猜测。这时，我们先在 next_guess 函数里判断上次的猜测结果。如果上次已经猜对了，那就把保存在 self.secret 里的值告诉客户端。如果上次没有猜对，那么就在取值范围内随机选一个值。请注意，我们会专门用一个 while 循环来判断随机选出的这个值以前是否已经选过，要是选过，那就再选，直到选出以前没猜过的值为止。现在，我们将这次选中的值加入 guesses 列表以免将来重复猜测。最后，通过 send 方法把值发送给客户端。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-11-00-20-36-d1473d94b39c413b481d803548c91abb-4ddc2.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 679px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 52.8718703976436%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABm0lEQVQoz31R2W6jQBDk/z9o87BaGYNjMBiMzTFjbnMfxtz4TtLESZ7ilUqtHqm7uqqGWOzSmeFNsT3VbFrfkcjmvEQuBqU8rfcdNFpzfQZiU3RCdKCxMzf9ueFR2BGigrVDzo1ZOxKCAobU5vIrCK29bft3KWuEsACihZeKyYF1Y2jU+qJ1N6U+w9xY6/Oj/3rCspS3vJdu9p2YVmJW4+EdD28PoPaqfQLmUHdD3z1U1N+hEnJ12hQ9hW3AKq74YE9qFgQxtwKIYO6ErBMtg3ymewsvA4OMGzFODNEwbkyoQFZfRtv6jkI268SMFS79/avpM3ZEb10KOUAkHwa5OsIlpTrJ5RHuKYcj8RCG+7tcDpyfrdKK97KZ6UPUoBDmPneOP/ofGHuQvc5bsCokJR8Wq7wR01pMSsgG9W+Q1qiruart74ET7C75K2mvhk9pzkQxwDCtu6ybcEEGdEp1fvZP47KQVBS2wOfCjoGCcxOgmMj6vzUiVVOIS619/s9ckJPInKjmH1YklS2NralqvCylF16ChCHL/1z+APg2SItdOBBCAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 11 00 20 36" title="" data-src="/static/2023-10-11-00-20-36-d1473d94b39c413b481d803548c91abb-4ddc2.png" data-srcset="/static/2023-10-11-00-20-36-d1473d94b39c413b481d803548c91abb-05daf.png 200w,\n/static/2023-10-11-00-20-36-d1473d94b39c413b481d803548c91abb-38f98.png 400w,\n/static/2023-10-11-00-20-36-d1473d94b39c413b481d803548c91abb-4ddc2.png 679w" data-sizes="(max-width: 679px) 100vw, 679px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>第三种命令叫作 REPORT，表示客户端接到了我们在响应 NUMBER 命令时所发过去的那个猜测值并且发来了报告。看到这份报告之后，服务器端就知道自己刚才猜的数值（也就是 guesses 列表末尾的那个值），与前一次相比，是离正确答案更近了，还是离正确答案更远了。如果恰好猜对，那就把 last 变量所表示的值赋给 self.secret，以便在客户端下次发来 NUMBER 请求的时候，作为正确答案回传给它。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-11-00-21-01-23b4e920a42f6c8656bf0bffb87a44bd-f1587.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 535px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 50.46728971962617%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAAsSAAALEgHS3X78AAABfElEQVQoz32SCW+CMBTH/f5fadnMpnKMSyjiBLkKrRQohyAeuGTPZMncli35t+nxfvm/99qJ5KcG4a8xkwIih0SnfOHFgp8ocSZssRRRlHdzNxKCVEuL9f5yr4mRtxY/iCGduVjBhZrk05X7iDazTbTYJiqtVFwoSaHnrVF0q/3lXpN1/46a49TegI8YECnMdFpNbfd5HczeQjUtEB9W7WXdX51u/AnDsNuztqvNstNYAw6r/aix1ix7nTVm0Tn9CPqBfYNVwtVdBVks806OM4WUMmZwolJuZI2+q3/bfsFiQOWAGKyVMBOj3SvOF37y4sZT25OhkP/g5mQWezliT8iFPj9vQgXnUPnCSx6WzoPpGHnzJwxy+ivM4HlLNS0FP4X+W3ywysPcw1Y13AKA70bnTp8wqgaIgDcz+QHWkAvUYtfHJe9RPaD6iOoT3N5UfcqseoBHuzmDG/RMjqhGuRgSeDPYWmU/9zFkAb0wWAO3wjbRSAk/R8KZRqsPlzMTqkbp9cEAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 11 00 21 01" title="" data-src="/static/2023-10-11-00-21-01-23b4e920a42f6c8656bf0bffb87a44bd-f1587.png" data-srcset="/static/2023-10-11-00-21-01-23b4e920a42f6c8656bf0bffb87a44bd-221e5.png 200w,\n/static/2023-10-11-00-21-01-23b4e920a42f6c8656bf0bffb87a44bd-807fe.png 400w,\n/static/2023-10-11-00-21-01-23b4e920a42f6c8656bf0bffb87a44bd-f1587.png 535w" data-sizes="(max-width: 535px) 100vw, 535px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>客户端的逻辑也用 ConnectionBase 的子类来实现，这种实例同样会保存会话时所用到的相关状态。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-11-00-21-31-7c601792cb15928bd9bfc6714ae5f137-bed19.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 416px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 75%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAIAAABr+ngCAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACWElEQVQoz21Ti3KqMBD1///o3rZX5SWKWBEJgRCe4a1YBGpr1XbRdno705mdzJLs5pycswyUoJj1ketFq8aV4LBpkEuEzcNSsILVpjObE9q//RoDiURj5EoO0/K95Mb3msVbPk+CRVoJJNS2LWrejP3x14BmxiNn4kSLrB4jerc0FFZah3ejeTO7c19Uv67/ix/NuDub7dnqLkDPbE/W4YK7C2pO+BmSM6ywCQlcBwGfqD19N8/CchYWSrR5zPaiywQayUEq0D65rgyIwM7IpCPsSS5Tk52x+8QfLJLdnG1EwpQgV6NSdGIO09GaiE44NN07zRQdf2Q6nOXdr9CDZk5oDOoYVyEGqKf6PvUzwfbXmw7wZS8WbG+RbEF8AIRbJl5KDu+yy4Y65kwHjj6RjS8Zenmqg+xGshNA3dRL1tUBVJRpDI5omwYI85Y3QvYfVV/me0Ad3O6AfrBELzsQfGwQJSrVZPtPt4cre5XXguUPDcIhKtjhsmjUtDaeXq/IX9JBM4yE5CWPeb3IdvNsOw1zASxMq4kbT4IMpmDGChAf3PmifWsG5ruXq7cXs5+e481nqz2j+ojbM25ORn2Eo8/iWzMQhiKYMN5wtKKZhdkYkb9LtMi2PHYflljA3v0SSSR40G0AN3udX38gr6pn4+lFL1vwCeQVaQKzKTkRWKUXe/BGtAORhGq6A84Q+DpU32+Gx4AYw6vDvB0NEeWxD7lEGUwRhz0wfx5tUHOcRSWMBhT/FKxsgaQSFmq8lT0mWsHUS0Un4Cyfw+4YU/gFjepFpIwziRLmHyX7Fm7vsntOAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 11 00 21 31" title="" data-src="/static/2023-10-11-00-21-31-7c601792cb15928bd9bfc6714ae5f137-bed19.png" data-srcset="/static/2023-10-11-00-21-31-7c601792cb15928bd9bfc6714ae5f137-3bbab.png 200w,\n/static/2023-10-11-00-21-31-7c601792cb15928bd9bfc6714ae5f137-35132.png 400w,\n/static/2023-10-11-00-21-31-7c601792cb15928bd9bfc6714ae5f137-bed19.png 416w" data-sizes="(max-width: 416px) 100vw, 416px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>session 方法负责开局，我们在启动猜数字游戏时，会通过这个方法把这局游戏的正确答案记录到 self.secret 字段里面，并把服务器端在猜测这个答案时所要遵守的下边界（lower）与上边界（upper）通过 PARAMS 命令发过去。为了让服务器端在这局游戏结束后，能够正确地清理状态，我们用@contextlib.contextmanager 修饰 session 方法，这样就可以把它用在 with 结构里面了，这种结构会适时地触发 finally 块里的清理语句（参见第 66 条；类似范例参见第 63 条）。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-11-00-22-20-667df081ce8ddc8c10811eec5bc6b2d2-65726.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 708px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 43.07909604519774%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAAsSAAALEgHS3X78AAABX0lEQVQoz32RCW+CQBSE+f+/qUlVVFAQQRfwXJZbDrnVijbpoE2btInJshnYN+w373GDFRvvPX7niCzkN2y4dXsG7Rt06sTL7KxXLfYFRNka9c2o79jN5m40dxxxUycabhi/tvjVfrBmsyAbrOhwYwt7f2BS2TuOdy4KJla4OJ7VpNLSRolKCFJcODxaUitBJvspfjHa2vOoRLVkR8Le6xk7wfIlJxatEAbJT5RDDo3iZX7m1LSR3Vj2EpEGAg2m8FBfZAeSXbS0fl5F8g8TzA9akJunT/OJPQtzfk0R+51sEfspkEWwAsmNQTGm3tQ+qFFJyqteXsljQXRmNGMe5ovjaZE2y+IDX42qRXu647IlxVUvvj2o/rM4NHMWZl0MN8E7kMD2A6bX7X/Pr5nkF7CNdp7kJkpUIC2aIbJg4kSIqle3V+ZuetUN88DlfZNiPKON/aYZIvPVuFL84wvzF2/J3h1/Q3tuAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 11 00 22 20" title="" data-src="/static/2023-10-11-00-22-20-667df081ce8ddc8c10811eec5bc6b2d2-65726.png" data-srcset="/static/2023-10-11-00-22-20-667df081ce8ddc8c10811eec5bc6b2d2-1be14.png 200w,\n/static/2023-10-11-00-22-20-667df081ce8ddc8c10811eec5bc6b2d2-43e71.png 400w,\n/static/2023-10-11-00-22-20-667df081ce8ddc8c10811eec5bc6b2d2-65726.png 708w" data-sizes="(max-width: 708px) 100vw, 708px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>然后，我们还要写这样一个方法，用来向服务器端发送 NUMBER 命令，要求对方做一次猜测，如果猜得不对，就要求服务器继续猜，直到猜对或者猜测次数超过 count 为止。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-11-00-22-39-bd46a2cb6ef31c752d69cffba8103d1b-d59c4.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 445px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 45.393258426966284%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABl0lEQVQoz1WRCY+bMBCF8/9/UautCoEkSyBcCdhc5jQ3gXDk6C7JdqKtVl3peaSx/M0bPS+ksACpWbf26NqlAsmUtIXKmT7UbZALfir4VEmPZnvdEHiTwKVe9rifFyKt1aIXk4oxHN5LtnG5IfGKUGbvbDzKOxGDCO9GQpjLxWkdpOsg2yal1gzm8LZA02xdHnJxFPwMtTetGVdepJY9OHCYrJzo1x7/2OmM6UlxjacZn+94uqPx/QnDAUFjXx5a0bOmu3ETgeRLk7AAk4jD7m8dsciRaaWV/Sf2qX+w0f8xx3c5a19UAwz1+rxLaha5G59KyZExbN4Nl8h70fC+HL/4xdcYgPVmFMKMt3wtP6l5J0YFh3wO+ys3PhwvZnfbHy/o9FwTTaD5G7xvptcgAbel5cu0lqLs5+7A2wFr2Ereimktp41eT4f2qleDUnT/wcPbobup1SDGz+S14vTcHBOJNhD7NswY02UMF4Zq5aDknZRU32AQ5GlNM/ztyg5eCTW7q3W+g+zzw7l+2NcPa7rjcYadIfO/4zvXzypPlVsAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 11 00 22 39" title="" data-src="/static/2023-10-11-00-22-39-bd46a2cb6ef31c752d69cffba8103d1b-d59c4.png" data-srcset="/static/2023-10-11-00-22-39-bd46a2cb6ef31c752d69cffba8103d1b-25c2a.png 200w,\n/static/2023-10-11-00-22-39-bd46a2cb6ef31c752d69cffba8103d1b-dae19.png 400w,\n/static/2023-10-11-00-22-39-bd46a2cb6ef31c752d69cffba8103d1b-d59c4.png 445w" data-sizes="(max-width: 445px) 100vw, 445px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>最后，还要给客户端类里面写这样一个方法，用来向服务器发送 REPORT 命令，告诉对方，这次猜的数与上次相比，是距离正确答案更近（WARMER）还是更远（COLDER）。如果刚好猜对，就报告 CORRECT，如果是第一次猜或者这两次猜的数字距离正确答案一样近，就报告 UNSURE。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-11-00-23-18-018a895ab9af683efc7f97f44af4923a-faa92.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 625px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 75.04%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAIAAABr+ngCAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACQUlEQVQoz21TiW7aQBTk/z+pSkUxEF8Y4xsDvk98sb4hJGmHhLYorfS0el6Yd8zMThgnWkXF3HRpK0Qs9v7MsGgrWJiuEJWLg/+00VknlvJWb15UclFOo1qfFTIiJlp9EbN6qpj491Tbz7YO8IwVTZUd72fU1p5v3bnpUKar1y+sd+TclPOzpRVy/nGit6+bolvaER/lrH+Ui4FxE2D4qDC6V615Qaj1BT3uCW4IPm/3k9sVOWMqMW82iKwRUrLJOyDlcvgEf432nnyCRznvptphplnU1pkZNuulSH6o+01W6/2b3l7/TPEYN7BcDeuk4v0ceMZJljufD7In2fgub7GClDXruEKiVIPWXr+CQaBc9lyYgSqNnNcpEbMGM2ORj6SXin6dnrCd1nwBt1f8vIpK1k1nugXlaCt6PgSrsBCPhHUTzs85L2WDI+3GUA5y6uTy0JmclWqk7Zgy7MXORQKRvq2VJ8kQUyLlnVx0Ut5IOItOLrtP5u+dccUHBQBTbbfce3PTo0x7eQhY7H8IuSCnnZh2EhSd73worD12RuzGn5Ce8RI+zIWEqNX4bEfU3tObqzm8G/3bdnjf9u+gXX/g7M42SJaylseeGUEVNsiEpAJDXHDL4R/GS7kwh0nU3zP/ZVtITvAZTiy5ikshrsC5droxL8Ql/AvDodw/OoPtamCdVEzrBRzrZauwZOwI1kVbLjiuwhyyiwn5j0nU9rop2oVhMXaI94QXQunWD22PpyOVPerK1fhxDreZYceH+AU/DBoRt7fCJAAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 11 00 23 18" title="" data-src="/static/2023-10-11-00-23-18-018a895ab9af683efc7f97f44af4923a-faa92.png" data-srcset="/static/2023-10-11-00-23-18-018a895ab9af683efc7f97f44af4923a-630d2.png 200w,\n/static/2023-10-11-00-23-18-018a895ab9af683efc7f97f44af4923a-34069.png 400w,\n/static/2023-10-11-00-23-18-018a895ab9af683efc7f97f44af4923a-faa92.png 625w" data-sizes="(max-width: 625px) 100vw, 625px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>现在开始为运行服务器做准备。编写 run_server 方法给服务器线程来调用，这个方法会在 socket 上面监听，并接受连接请求。每连接一个客户，它就启动一条线程处理该连接。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-11-00-24-01-8f1a117b983eecce81622ca032114519-df45e.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 661px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 85.02269288956127%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAIAAABSJhvpAAAACXBIWXMAAAsSAAALEgHS3X78AAACOElEQVQ4y3VTiZKaUBD0/38p0V1ZFRABReSQ5ZDjCSgiqBivJP0g1qYiqRpfTWH1HN09Hc6JODuYhFvGcPq6s8jPSn5W9z/m+XmWnfDqx7t2uC3K62t0OIfwXvxh+ozuMKbLuWvWDserGMmbao3sECWUrGoHS2Q39lNGcziXjOyob7gfyxXnrcVwi+8TsmP9RI73+vHRAtaO93l2ktY558XfZ9rQ8lmHsE4EgLjeTUiGt0kWxQsYP6yklTfWJuMgnW6P+uEukgaw48OUD1JxnQsUfGkBI9TiAryUFKxHPkwPfQZWIIQbsKWfHpgOScvYTT3QOwk3w0+fd8n74hPLI+a7iv7bNHxpS8GNElrdYbo5TKKt9uz2VKjBt4GxnpyWk5oVCSTF+dhPUAIJLUrr3miD1rGluBCjbGB6kPRNXQ6XHqPbPcUcWKtpWsibchwk3IqAvPaxqZ+ySvDTrrpkDI9zo97cRCEsP7QpbZANG/2fsOICnd41G1QLwQYm6Wu2SHKqwuFuVL/o2IdrTcRdfVL4JRU6iNFW8BP4RE4KvbwapweMIacFJKxNepKSvZSWDQWILzAYhrxdxUR/6ERN6hLeXTOGS01uBT3VGsC8pgfbgiaJZJ2/d1B2FZhHeXV/mW4PYu3Z3kyH/ti/OzMGS7c+HgJdpDjv/MNBveQNL8Kofspx8U2eQwvOjQeWP01LJacXhjtpxm4MAMwVPUdOOLIDfpUgEYIU94xVldpq6v5cH8L1j3PKy29UMInUTsr6NwAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 11 00 24 01" title="" data-src="/static/2023-10-11-00-24-01-8f1a117b983eecce81622ca032114519-df45e.png" data-srcset="/static/2023-10-11-00-24-01-8f1a117b983eecce81622ca032114519-db621.png 200w,\n/static/2023-10-11-00-24-01-8f1a117b983eecce81622ca032114519-0d5d5.png 400w,\n/static/2023-10-11-00-24-01-8f1a117b983eecce81622ca032114519-df45e.png 661w" data-sizes="(max-width: 661px) 100vw, 661px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>客户端放在主线程里面执行。让主线程调用下面这个函数，意思是连玩两局游戏，每局最多让服务器猜 5 次，然后把游戏结果收集到 results 里面。请注意，这段代码专门使用了 Python 语言之中的许多特性，例如 for 循环、with 语句、生成器、列表推导等。这样写，是想让我们稍后能够清楚地看到，把这种代码迁移到协程实现方案上面的工作量到底大不大。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-11-00-24-34-cfd603ef1880cb00d2b304e8c05c8b9c-f67c7.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 729px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 54.32098765432099%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsSAAALEgHS3X78AAAB00lEQVQoz0VRh47aQBTk//8o0iUcYFNtjHHvuPduOpwy67so0nj1dr2zb+bNhPHzlR2tnIg2/bnmzLXT0g4OeX+sLkJ9OVZnPuv5YhCqq1BfUXzjWF+l7jHhknbr5XPVninWxk2noj5X7JlsfcrWQj/NZJPSvbWbsFF1yDoUaLNxk33SyP1zIg8vvLFPWy7rxPbOl8M+qbm4ZqKSS9t9XCv9S718KcMLQEHq81vuCWuCDwrxMO5RprcNso2Xrk8J1kPaohsTlhAsNjdcI16aGyjS8I8sNnf83vk5bXi4ygQFKfx8afnwDxcrO1wa3kI7LTSH0l0+77mshUxClvonUXV+a6Mq9fw+5B0ZDyykzTYs2KSmbX8XlruwoEwUBRMWYnubgClUF2zYuKKtAMNYn+K1h8GEbFwf0o5LGhTK8MZtdEIPgv+y2zsiYaNi5cQfR402/H1Y0XoA8Tsvm0rm0gwow5+pzsoOlhYJUmrvP2Spf2Du6vkLhn/z6kyy2LBEVJ+SiQh/sQK0TGXjg1f+CDplkOR+yOLYWRoB/Yj9WA5MXLFRiVFDME7E+oog4R8n6iibtAQZ+60bI3S43boJwpAHWCJAmN+r3D2RtjxCah8AToC/p4lGSnmdLKoAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 11 00 24 34" title="" data-src="/static/2023-10-11-00-24-34-cfd603ef1880cb00d2b304e8c05c8b9c-f67c7.png" data-srcset="/static/2023-10-11-00-24-34-cfd603ef1880cb00d2b304e8c05c8b9c-c5342.png 200w,\n/static/2023-10-11-00-24-34-cfd603ef1880cb00d2b304e8c05c8b9c-4721d.png 400w,\n/static/2023-10-11-00-24-34-cfd603ef1880cb00d2b304e8c05c8b9c-f67c7.png 729w" data-sizes="(max-width: 729px) 100vw, 729px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>全都准备好之后，我们把代码拼接起来，看看能不能实现预想的游戏效果。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-11-00-24-57-7a9b14ec0f7de24b6a27f8510d3227bf-6f695.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 717px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 110.59972105997211%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAWCAIAAABPIytRAAAACXBIWXMAAAsSAAALEgHS3X78AAACyklEQVQ4y41UiZKaQBT0/78pu16rggcCcqggt9yHHOqumq30DBqTqlTKqsfwtKbfvNfdQ4fz86kdDTbWcGtLxVkpv1bZCYmUn5XqImZHMW3k6ovGhUT5zDt4hOz4g1cBnpNCMWsGUyce7/bzfbaMyvk+VZufCKW+yvWVJM1NqW9YCXh1+OSCw8TY92StL+tIJqbfkzTGCGZusthn7T98WPJxNdJc1grQ78xLKbg4M3bIWMFwa33ozmjnjnQXu6XDJ3oWsmYZV3xSo0ExPy2jg5DWgAhpQ8DYtAgKLiqV6opNfHbEysXlPMixCtlJPd57lusL7ZnkWDt4oR6aGW3tse7O3HSoOb218aG5Y93rr83B2gRtd7b+jk77An7mxcOtydoRY/qDjQmeWDsEcurGcz+begkSxvYxAiWcggHj6QykJfRTfimPwmJxWh3OSk3kwTbEqjhJDyQBg7QxmExqubm1k9zX6kL1uMujNkQbhe55ghdBvgwPckn8ACVWaCQh3NKkFpIGsQgyIanF7CSkhPAneGIGb+Iakk52+660HW7sN1Ed7TwowTrRMiwRY8MDBXxc4xjgn2AwMdIciI7aGGGke+BZbZt/DNLaS3kM9SQM5eGqmZNw4YGYfG2BYan4VB5DYmxEK7VCKyqPsTuMFfYIOIaf+5BXd/GToRRCoUVYgAKssCDxT1rD7Ty5Kld6sh31VWPmJYwZoP+J4feVHQVXuBiLMOfjEqROLL81KQFDmjvYjbqKPnUT3IE5mdl9FzdcWKrHb8jTKqQeb+vT9z/aZp0Al4lF2zYiGm4djI1aIAZ+IJag68Mb9DL/JmzhZ++rDWvHkATzD1Sjr+7+tNF/AuC8K+tTwnYJVvBJwFeFuLW6vgAOcpyMM7mgYK1WKoMLC6V+AQxKu5IGnUA7OB9qVl/WMMJLYHyA3il47qRwGExKPOOlr4B/AazKlWOhZ02PAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 11 00 24 57" title="" data-src="/static/2023-10-11-00-24-57-7a9b14ec0f7de24b6a27f8510d3227bf-6f695.png" data-srcset="/static/2023-10-11-00-24-57-7a9b14ec0f7de24b6a27f8510d3227bf-8f412.png 200w,\n/static/2023-10-11-00-24-57-7a9b14ec0f7de24b6a27f8510d3227bf-576a5.png 400w,\n/static/2023-10-11-00-24-57-7a9b14ec0f7de24b6a27f8510d3227bf-6f695.png 717w" data-sizes="(max-width: 717px) 100vw, 717px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>如果用内置的 asyncio 模块搭配 async 与 await 关键字来实现，那么需要修改的地方，究竟有多少呢？</p>\n<p>首先，服务器逻辑与客户端逻辑共用的那个 ConnectionBase 基类必须修改，这次它不能通过 send 与 receive 方法直接执行阻塞式的 I/O 了，而是必须把这两个方法变为协程，也就是在声明的时候加上 async 关键字。另外，笔者还给某些代码后面标注了#Changed 字样，用来强调新版代码与旧版之间的区别。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-11-00-25-30-73e70478b70515cfabf69ae5a3d4ddd6-180cb.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 780px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 58.333333333333336%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAAsSAAALEgHS3X78AAABx0lEQVQoz2VSiXKiQBTk//8pm2gkHiA3CIJy3+eAqKzZo9GE3UqquqZm3nRPv+kZis8axstWbrpyYtryMS4P/tywWb9Q6qtUX8Syl+uL2t4mKM2ACkApZNjGFevn9CGgTY/euwvDZvz8Wdmv7JhPmo2bbMNSJYPa/nyAS5rF3lkYDoXFrv+lNsNMNdd28iRobFhwUXWfVMblj9bdgEkJwGymWiCMYqW5SmWvlGcx74S8w1wsgBOftVhi93/lyCeDVJ2loqfU7gbeNihWdsSG+Vy3n0QdDXNx86rbKOLOX5zvGCujM/Zw/ItqCgkBG7elTZ+2PC6u9fPvb7J/+BDLVT/TLCjhtrR8+L8oxg9ph4f4rkEic/0416xPZzJwSS0WHRtXfEb4tBGydnyFqERTXzJDKKhvvJRCFTkxQY732Eblyk3WbrK0o7dDwKdEIVdkg/ykqp+Sg5NcX+Xmck+bjGm/7mzoadNdO/HaSdggX9oh46dMWODnrN0YHO30Dj7MwHk7BqNYfXRFruhk48X4AFDySS2VHfLHdYS0EfOW8VLc6EHend4BauoEZ2Mbmc30Iw5e7F18g2fFEDIil2cZzecnjBNfbYe/WqZ9Xh7xSgsAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 11 00 25 30" title="" data-src="/static/2023-10-11-00-25-30-73e70478b70515cfabf69ae5a3d4ddd6-180cb.png" data-srcset="/static/2023-10-11-00-25-30-73e70478b70515cfabf69ae5a3d4ddd6-b84dc.png 200w,\n/static/2023-10-11-00-25-30-73e70478b70515cfabf69ae5a3d4ddd6-8d9eb.png 400w,\n/static/2023-10-11-00-25-30-73e70478b70515cfabf69ae5a3d4ddd6-180cb.png 780w" data-sizes="(max-width: 780px) 100vw, 780px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>改完之后，我们可以创建这样一个有状态的子类，用来在服务器这边维护某条连接的会话状态。这个类跟早前表示服务器逻辑的那个 Session 类一样，也从刚才那个基类继承，只不过基类的名字现在已经变成 AsyncConnectionBase，而不是 ConnectionBase。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-11-00-25-58-d47b82fcacf22e3dc71122e9df7ea4fb-1dace.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 770px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 23.246753246753247%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAIAAADKYVtkAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAA10lEQVQY012NDW+CMBRF+///1YbgGDCnEyhIbAe0GpGu0DH5cMuumiVmycnNee/l5hEv37tcOllhp++QWcLsTQ4syp6YdLbCSrhfHsNmiNoRQF5k7fIdKiTYKb+svKJ65nuvrOysCISCWClbHNo33a/UFzJE7Y91M6w+TkvVkfjzHJtzpEfafUdmot0PBFz2t7yC030fIyC+VIFUnjjOmfRFPctKhwlnKxeVedzk2LjF4SHlr5UJzbTG2ztI0o5UD2Hd0WaguqfNeBHQ3gTXPtYnjImZ/vEL7NAMPjvHVHwAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 11 00 25 58" title="" data-src="/static/2023-10-11-00-25-58-d47b82fcacf22e3dc71122e9df7ea4fb-1dace.png" data-srcset="/static/2023-10-11-00-25-58-d47b82fcacf22e3dc71122e9df7ea4fb-f7e89.png 200w,\n/static/2023-10-11-00-25-58-d47b82fcacf22e3dc71122e9df7ea4fb-20ec6.png 400w,\n/static/2023-10-11-00-25-58-d47b82fcacf22e3dc71122e9df7ea4fb-1dace.png 770w" data-sizes="(max-width: 770px) 100vw, 770px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>然后，我们来修改服务器逻辑里面的主要入口点，也就是处理命令所用的 loop 方法。其实只需要稍微改几个地方，就能把它变为协程。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-11-00-26-36-831b13b2ee2d57e8391f1b6f65b10a1e-7599e.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 682px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 45.747800586510266%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAAsSAAALEgHS3X78AAABdUlEQVQoz1VRiY6iQBTk/79pEhVQQNHB4ZBLujkEGhhO12OdbLbAmd2ZpNL90umqV68et45LhbJNXCkhW3qx6McSOa2jwuwfenPVmxvwNhVm/9saPnZZszqmgkNXfsKpab2O2CZiwoGIbqhAK2QrL1aTSibpJirkIJHDDHJGe7OGh5b3m5AJLlVozlnnj3115m0iHU+gzQwPktIxmRvu0qX6+6+3+gIO2n7hMWGsuc+n5gbDokvl4IRBIDQzHN4OlIgZzfUb8wuTHIcL2ru8gQ3BDXmb8g6FZ9GPXjRLcIhWDubwn6a3Ywrj2d7GzmMk5VkhuehFEknRVk3eITQ3PP4QrGNmdveR2d3h/5V1sANpnE/yVcs7mWQLy1/YAWbWslZ0QnRGhNu01ore6O7GU2LCs/4kwzas6vUF/3Z5q5X9NqsRJBazTRutGuzLH+BnchMZO9gXgxpXalLCjOCE8IxNzq0j9ifTTKLZ4kBmpq/Exb+ogb8jjtoiTP+B7wAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 11 00 26 36" title="" data-src="/static/2023-10-11-00-26-36-831b13b2ee2d57e8391f1b6f65b10a1e-7599e.png" data-srcset="/static/2023-10-11-00-26-36-831b13b2ee2d57e8391f1b6f65b10a1e-fc543.png 200w,\n/static/2023-10-11-00-26-36-831b13b2ee2d57e8391f1b6f65b10a1e-27a37.png 400w,\n/static/2023-10-11-00-26-36-831b13b2ee2d57e8391f1b6f65b10a1e-7599e.png 682w" data-sizes="(max-width: 682px) 100vw, 682px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>处理第一种命令（也就是 PARAMS 命令）的那个方法不需要改动。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-11-00-26-54-84c180ba20665be5c458a00fa9f8288f-3e45f.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 371px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 18.059299191374663%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAIAAAABPYjBAAAACXBIWXMAAAsSAAALEgHS3X78AAAAv0lEQVQI12WK2wqCQBRF/f9vCXoIIiHrwQrMy9hcHAnsQTLN1FFHy7xAo70EwWHvzVpH0oMURCVMayNIMWtOD26FuRXlRpCZIQNRYd6ygxfYMadFJ4hQ4M7EQOlTUiC1o2JLvaUONM9f7LWViWSA56q2RlSBjmzAnXs5+jEI2UxRN/isIFco45pItBoc3qG8IcUbZS+St7QenKofk3eEd2K49YDLVjzQsv/aUZWtJJAomFQorghrRjoRPOX//fIPW2DTreAnGf0AAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 11 00 26 54" title="" data-src="/static/2023-10-11-00-26-54-84c180ba20665be5c458a00fa9f8288f-3e45f.png" data-srcset="/static/2023-10-11-00-26-54-84c180ba20665be5c458a00fa9f8288f-84b18.png 200w,\n/static/2023-10-11-00-26-54-84c180ba20665be5c458a00fa9f8288f-3e45f.png 371w" data-sizes="(max-width: 371px) 100vw, 371px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>处理第二种命令（也就是 NUMBER 命令）的 send_number 方法，需要加上 async 关键字，这样它才能变为协程。在实现代码里面，只有一个地方要改，也就是必须用异步 I/O 向客户端发送所猜的数值。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-11-00-28-10-002304fac1753b7bb739d798e048dbcd-212ec.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 731px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 27.359781121751027%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAIAAADKYVtkAAAACXBIWXMAAAsSAAALEgHS3X78AAAAxklEQVQY021O7QqCQBC893+nKPvAuBRNOy9RMzU1FT2/KzVo9VdksAy7szuzg0Q/xV68v9552+ftgB+bQEkbUnan4gU4r5EfVy+kVb1W9iSfZujr4dy8ASlg1f8RTzd0ukFiwAQ/k+5MDDPsQoRwazqHW4KdSI6KuV5Oaki6Mz0hSBEpOuxGS1WfKHej2yvNXGvWQqEwquxB6+Ens8qeStae8ieC71KUgwbMOGrxFx+MOGIuicFRA3vJMa2/xQprpbiQ4hL4D+g2CsrLYyAVAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 11 00 28 10" title="" data-src="/static/2023-10-11-00-28-10-002304fac1753b7bb739d798e048dbcd-212ec.png" data-srcset="/static/2023-10-11-00-28-10-002304fac1753b7bb739d798e048dbcd-8e534.png 200w,\n/static/2023-10-11-00-28-10-002304fac1753b7bb739d798e048dbcd-fd412.png 400w,\n/static/2023-10-11-00-28-10-002304fac1753b7bb739d798e048dbcd-212ec.png 731w" data-sizes="(max-width: 731px) 100vw, 731px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>处理第三种命令（也就是 REPORT 命令）的那个方法保持不变。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-11-00-28-53-e840de9a35b62f277f68c84ba33d8666-cb87a.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 424px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 12.264150943396228%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAIAAADXZGvcAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAfElEQVQI1yWLUQuCMBRG/f+/pwcxqGkIRaDB7t1oTTKDeojcppTbfPGCLx/nHPgShrfi2p6fnx2otIJStbnUh6bbnOrtBUv9yCrMhWZC129LZQ+KyeZ4f8lxTsB6HCK4wPuJmwmc598/WtofN164CKQu4BjR+JUFdRvotQAeG2gc2eXjxwAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 11 00 28 53" title="" data-src="/static/2023-10-11-00-28-53-e840de9a35b62f277f68c84ba33d8666-cb87a.png" data-srcset="/static/2023-10-11-00-28-53-e840de9a35b62f277f68c84ba33d8666-24421.png 200w,\n/static/2023-10-11-00-28-53-e840de9a35b62f277f68c84ba33d8666-e4320.png 400w,\n/static/2023-10-11-00-28-53-e840de9a35b62f277f68c84ba33d8666-cb87a.png 424w" data-sizes="(max-width: 424px) 100vw, 424px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>跟服务器端的逻辑类相似，客户端的逻辑类也需要继承 AsyncConnectionBase。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-11-00-29-12-b7e9e9fb8e433581821d8fdb219adf4f-05988.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 764px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 23.16753926701571%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAIAAADKYVtkAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAwklEQVQY032ObQuCMBSF9/9/VR8yXfZm1pTKdKucmm6m02plNDHCDxE8HB4OnMsFJokMP9T3p5F/UjncBIbKLda2BGKq7YjyecydUqLi3lLKOWUwoIZ3BObxbJIE4gQGESTJcIPHh7OSgePNKF+yepEKO7+tC/llld+WvO0BEk9XNOginappvX65VeNWLyQeqPzQX3Z0PVDnZ5RNKRuTeBJmuh+ql3SfWqn4OesDbF7brJpG3MpES6oolazy67q4/+cNJGsMe65rMBAAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 11 00 29 12" title="" data-src="/static/2023-10-11-00-29-12-b7e9e9fb8e433581821d8fdb219adf4f-05988.png" data-srcset="/static/2023-10-11-00-29-12-b7e9e9fb8e433581821d8fdb219adf4f-dc8ef.png 200w,\n/static/2023-10-11-00-29-12-b7e9e9fb8e433581821d8fdb219adf4f-69e4e.png 400w,\n/static/2023-10-11-00-29-12-b7e9e9fb8e433581821d8fdb219adf4f-05988.png 764w" data-sizes="(max-width: 764px) 100vw, 764px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>客户端中负责向服务器发送 PARAMS 命令的那个方法，现在必须声明成 async 方法，实现代码里面有几个地方需要加上 await 关键字。此外，要改用 contextlib 这个内置模块之中的另一个辅助函数（也就是 asynccontextmanager）来修饰该方法，而不能像原来那样，用 contextmanager 修饰。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-11-00-29-33-cdd566a056b544afc3006c57454eac8f-7f5ac.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 743px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 42.799461641991925%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAAsSAAALEgHS3X78AAABgklEQVQoz0VR2ZKiQBDk//9pY1dgQEFAQRQYruZsuQ8dRX2YhDk2oqIiq7urMrOa4eyQtwPRS97cmLX81dFbnTzOCf8Y1urka+d+X1/MftrX1311MYfHNm04h/w1HDHIGDkqNn4m+ilrBdw7ARDcWCIUneuQclbA29GGUM4OWIfIcSWRMzA4lKxmDt3daG5aMaD4ZzprQpWsFfxEoy3/TtCspI0UFbtiAPmuHNW8UfP20N5PlxcDYWDbLCQbcpZIAdmQpDcfEKy3H3pzNfvHcXyawwTZC3iYw/PQT8w2reFZpe06zGCBtUMAMUh5l2hFjylyUqq0g08pKXbVRaGtSPK5jEtGr66425UDnmKk0d2/ZmPwnLv7DPoZLITf8XXO6PUVrgQvUbMGNubO8Xlc4ufpAv6XS4xzxsJusM1jk0kpxYUQ5Mi8G8lxYXQ3c6Zd4pezn2baOSbGHF84EtxUikoB/+Sl7Cl8w56dEN++TSuM1ugA5ZBwHF9K3oh+xltEJuUnX+DZ6ENU1pAAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 11 00 29 33" title="" data-src="/static/2023-10-11-00-29-33-cdd566a056b544afc3006c57454eac8f-7f5ac.png" data-srcset="/static/2023-10-11-00-29-33-cdd566a056b544afc3006c57454eac8f-b6c8a.png 200w,\n/static/2023-10-11-00-29-33-cdd566a056b544afc3006c57454eac8f-d2300.png 400w,\n/static/2023-10-11-00-29-33-cdd566a056b544afc3006c57454eac8f-7f5ac.png 743w" data-sizes="(max-width: 743px) 100vw, 743px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>负责向服务器发送 NUMBER 命令的那个方法必须加 async 关键字，这样才能变为协程。另外就是必须在执行 send 与 receive 操作的那两个地方分别加上 await 关键字。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-11-00-30-02-0443a51836b751885b75a82fa2c2a4d8-f67c7.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 729px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 27.572016460905353%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAIAAABM9SnKAAAACXBIWXMAAAsSAAALEgHS3X78AAABB0lEQVQY001Q2XKCQBDk///JJCWCXB4LLJcIC65AuM8koKYyBsuyqh9mdrqne5aRw1QKPrdRybuUtQm0S9NnLSKSmD/SXVJLYbqyyT5tcHfF7QUg00zwI9YOGJApp1RNW9GP1kfKWt4HPiyQKZDzNqnUYtDKL1QMev2D22kGKnqUdTBlcDcZ3bRyiEQS+ZSBuUiSd/3AOWSBDCgUmj9lM9Z+tLR8mDLQ6M3IHQLBoyhpOPdeQIQ97I4rhWYQUi0H3F2e4l1cwSNwHuLNueDdEJJzbvimORAEDCWa4WaEhFr9/eps9FdzuFnD710MDNyOSpSLHoV/As/5pE1caeWg5v3rwQ/+P/4AImQ8YoqNyyQAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 11 00 30 02" title="" data-src="/static/2023-10-11-00-30-02-0443a51836b751885b75a82fa2c2a4d8-f67c7.png" data-srcset="/static/2023-10-11-00-30-02-0443a51836b751885b75a82fa2c2a4d8-c5342.png 200w,\n/static/2023-10-11-00-30-02-0443a51836b751885b75a82fa2c2a4d8-4721d.png 400w,\n/static/2023-10-11-00-30-02-0443a51836b751885b75a82fa2c2a4d8-f67c7.png 729w" data-sizes="(max-width: 729px) 100vw, 729px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>负责向服务器发送 REPORT 命令的那个方法要加上 async 关键字，它里面的 send 操作要用 await 来执行。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-11-00-30-18-338d772a3330ce92a0e3c3f79f6b443a-c865f.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 719px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 16.55076495132128%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAIAAAAcOLh5AAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAmElEQVQI1x2NVw+CQBCE+f+/y6DC3VFsL2IBrnOFEjXy4sRk8mVnMzub5K2m3OW9pcKnDSe9zTqd3vi24fuHKs20uXZQ7ZbzvF7mtRoW0g+7u0AgOU1feCYDSGXAkPOBSo86Il1hxkLHElTxEN64B7Ek0hPuEvjKzlQgNzEViXBZZ/EQFUwHpiD/ZzzGD8K1fxV6zFqTPc0PZRyejjsn4CYAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 11 00 30 18" title="" data-src="/static/2023-10-11-00-30-18-338d772a3330ce92a0e3c3f79f6b443a-c865f.png" data-srcset="/static/2023-10-11-00-30-18-338d772a3330ce92a0e3c3f79f6b443a-d82b3.png 200w,\n/static/2023-10-11-00-30-18-338d772a3330ce92a0e3c3f79f6b443a-d61d8.png 400w,\n/static/2023-10-11-00-30-18-338d772a3330ce92a0e3c3f79f6b443a-c865f.png 719w" data-sizes="(max-width: 719px) 100vw, 719px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>用来运行服务器的那个 <code class="language-text">run_server</code> 方法，现在必须重新实现。这次通过内置的 asyncio 模块里面的 <code class="language-text">start_server</code> 函数启动服务器。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-11-00-30-50-759771e649e2f52756f410b433afbfa9-a0ad8.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 629px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 64.06995230524643%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAAAsSAAALEgHS3X78AAAB8UlEQVQoz21SibKaQBD0//8pLyhyCBi5WQRWlgU5RRTEs3wZ9MX4KqnqopqFnuntmZEYZnwQq8V+6kVA5KS02qv9wIu8w9pfXl9H2qbTNwezOYFeqzqtaoF/YXfW697YHs3m+CT6tgcxcFDB60iKshnJJZLzHp26ZOIEEwcztj9BAe9HP3SXRSs4ZD0yQfhDR/O0FknG+VRJyhEYUNKaRYG4StSsgf6gEcM1F0RD3TCFu7Du6lfWKHEFXFylL/+jpw21aLRir5at1ZzVHEi3KPaLvJmnW/DvdLfh/t0NiN3eQPLES7wTgphbhmPL+9Ds6TKUaQGdwZ5WHaxHn38x2FarVqIF70XgXIoLuNWi2EETdLg7/f3x3/mB/4hv4Af19yHtfOcePwfNAbz9mcpg9eq0XyffxHKUK7ScJxXkIccbieZgVY5LKcrFMJ+RjEVYwAmPE7PuodA3McxWpuXUDVk3XKRbwadj25/T8qexnKAV50eM6XI+YZyADyiPY6M5vtnubs9lgAkx1hKe7DKEbeP8mHHwGGF2CK9U4g1jIMYOBLx+T/sKUxEgKpIJOAYCywBbweO1uT3pmx6sGXWv1wdYL3N3MZrTX7HTXgBud1WiQiapnjWCHykkk0kuBnSGkxlU9AjvhXq5RxBtd31KAL8B1O6wyx11YhEAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 11 00 30 50" title="" data-src="/static/2023-10-11-00-30-50-759771e649e2f52756f410b433afbfa9-a0ad8.png" data-srcset="/static/2023-10-11-00-30-50-759771e649e2f52756f410b433afbfa9-bf596.png 200w,\n/static/2023-10-11-00-30-50-759771e649e2f52756f410b433afbfa9-d90f6.png 400w,\n/static/2023-10-11-00-30-50-759771e649e2f52756f410b433afbfa9-a0ad8.png 629w" data-sizes="(max-width: 629px) 100vw, 629px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>用来运行客户端并启动游戏的 run_client 函数，几乎每行都要改，因为它现在不能再通过阻塞式的 I/O 去跟 socket 实例交互了，而是必须改用 asyncio 里面提供的类似功能来实现（笔者用# New 标出了这些地方）。另外，凡是与协程交互的那些代码行都必须适当地添加 async 或 await 关键字。如果某个地方忘了写，那么程序在运行时就会出现异常。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-11-00-31-41-df0b9b515d447593fa823197f51a5714-56c56.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 784px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 65.05102040816327%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACBklEQVQoz21SaZOaQBTk//+hVKWSja6yIoegHCIqh9w3OKAibpIGzZfUVr16zAzz+nX3PEoIcsHLl07MnhLGihZWwHsZbfofR3+qWx9Hj/fzTd5u8maTtVJKsNbqu1xelepGqfWdc5M3ecdYIWK2M+eGM9EOtOG8ycb71sTh8pRwbgp0IAJaKa8z3WKdmNLIQy4uYlIDTErOq6gU4xohpVhXUtrggt5+IrbIlz/I6Ie/67xFcY8a3s8YOwQFwIM566KJx9iREBa8l3Jeuiku66wZQYlSd4BAIaWe71rzkMsbtAlRqZS3hRks7ZC1I1BlTJ/ee2/qfmY4P9b6RD0g44IAI4oLpZIeH9ig1h08kLJGSgi4iPEZGVhycYWuIeoO3eTqOrDI28Ew7NcpATfWDofsJDPDZsyAdaLF0YUreA764K3CEryEcHDkSRZ5pE169dxB3rtuwue5cZrtLFhA791x63zj5enW/C4qPzf6L/Uw37torj41j/UDBHzi/JQP8oXpY/10Dg4913LRbpsHbg4C6+7VWa26VVQzpxiTsIor9IRy/fL7ye0fej8U1OO27uA/XpcCGIRNtSN9cCdwdWdzfi5GFR8WeBt1UHT/L2DVRDEWR39855SIwzwQ+IHBGOekWp5ieKN9VQyDxvkhr2LOz3AVzPkg05oeh6O8x1eV95fbpP8LpECw6Wq1Yg4AAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 11 00 31 41" title="" data-src="/static/2023-10-11-00-31-41-df0b9b515d447593fa823197f51a5714-56c56.png" data-srcset="/static/2023-10-11-00-31-41-df0b9b515d447593fa823197f51a5714-06149.png 200w,\n/static/2023-10-11-00-31-41-df0b9b515d447593fa823197f51a5714-f9654.png 400w,\n/static/2023-10-11-00-31-41-df0b9b515d447593fa823197f51a5714-56c56.png 784w" data-sizes="(max-width: 784px) 100vw, 784px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>把 <code class="language-text">run_client</code> 改写为 <code class="language-text">run_async_client</code> 的过程中，最妙的地方在于，原函数操作客户端的这套流程基本上不用调整，只要在适当的位置写上 await 或 async 关键字，就能够使用这个新的 AsyncClient 客户端，并调用其中的相关协程了。笔者原来说过，这个函数故意运用了 Python 之中的许多特性，在这里我们看到，这些特性都有对应的异步版本，所以很容易就能实现迁移。</p>\n<p>当然，并不是所有代码都能这么容易地迁移到协程方案上面。例如，目前还没有异步版本的 next 与 iter 内置函数（参见第 31 条），所以我们必须直接在 <code class="language-text">__anext__</code> 与 <code class="language-text">__aiter__</code> 方法上面做 await。另外，yield from 也没有异步版本，所以要想把生成器组合起来（参见第 33 条），必须多写一些代码。不过没关系，Python 目前正在迅速添加与普通版本相对应的 async（异步）功能，所以用不了多久，这些问题都会解决。</p>\n<p>最后，负责把整个程序拼合起来的那个 main 函数也需要改成异步版本，这样我们才能从头到尾看到完整的游戏效果。笔者在这里通过 <code class="language-text">asyncio.create_task</code> 函数把运行服务器的那项操作（也就是 <code class="language-text">run_async_server(address)</code>）安排到事件循环里面，这样的话，等函数推进到 await 语句时，系统就可以让该操作与另一项操作（也就是运行客户端的那项 <code class="language-text">run_async_client(address)</code> 操作）平行地执行了。这当然也是一种实现 fan-out 模式的方法，但它跟我们在第 60 条里所讲的那种办法有个区别，那种办法分派的是同一种任务（也就是更新单元格的状态）并且要通过 <code class="language-text">asyncio.gather</code> 来收集运行结果，而这里要分派的，则是两种不同的任务（一种是运行服务器，另一种是运行客户端）。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-11-00-34-10-8633fae48854eccef07ffafc9e3b77d7-a2490.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 630px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 139.2063492063492%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAcCAIAAADuuAg3AAAACXBIWXMAAA7DAAAOwwHHb6hkAAADfUlEQVQ4y41UiZKaQBD1/39pLxUPUFGQU5FzuBEEEV33St7A1tYmqcRU9VYNO77p169fd29OUhpeytkRa4WcE01Mn9m4rB2K+5NSv8rls1RelePrn9GTyouQ1UN1N9raMzcW0op1QyDnJFuQTC4ufFSwTigVZ615U44v36On1njjBUnW+0Yur208S8VFOjwj6P/zk5Ael3GJHLj6HSzmp4e13ldN3s+mTni/1vqK2Zd3j9J2qFmP0ga8xjsysXxp31BYdf0E4w/vzf0M9JZxwccFR9JFWID2zM+WSTkP9tLhvL3+0M+ID+30pp7evoGr6yLM+TAX8wavAr8uGtDh48MiyFdJKSQl58aclyD5FHIEmXS4QEtKe503Q92amOReUCEVDqON05cNZmNzTjhQdszWHhnOMioWwR6k8FxX/KdgiFV8YE3C2QGt3CSsFQhROXMTlM25EW47MPLPvWQVHZTqpbcgKbLNUCfJxgYZ7cjMi1t6wdTy1/sTZVhd5QriX9bFGT2DBPhUkRmlrtIjutKa4Vmkd/hRgzMOevOuNx9gB6kgmNa8a6d3CNbx7SEV60TAg9JAt/noALVpWjsUsiPrxFzrHMbwhhtrGR+6pqySqgVv3JFuz5yYD/KR4U0N0leMseEBCZJ4FAdQBQwBaRFi0eCKgvE7RnemdiS2LYXOT2sdacEQ12pNGaI8tWtv/WXsts/M1kWfplYkJNXMS8aGeydqEzNQa9r/LjpLfZ6P+GxNVl174503ov2MxazmoxzVwo+sHehUG5pN6w6fmn0guXp67Yj0hrrDaBaEWfgQzEK3Bpo9UIy5v4cq8MO8dQWmgo4tSdEIqAAtVmkFwah75n6K5E/ShrpCt+AqiAwz8XAFtXqOqZpYwdgKxH2Nt2BhaI5WuRAJGGRGz7AYoDaj2zKafH6/QZvZOkPNhNpIgh0Ctk+ygamU2mbcEsxwmY0FnZdhwbWZYWaMBNz7Zfu/RY/OjWayNqxfzQha5T3KW7j9a+L/BUaHITK2H4yJ8WBgEgqOqCVu4ZE56qNmDGCKzCnWDVYSPrX67XZm5HxSzYkZwmHo5Nj0QRsmp6rcBGPd9pUda0VQqFvdkACaYQBuC4adPFAhWMyTDGyhNmr+XzAAsBTsBdjUChd+NtBN+ET5dUX/BeyEd4KC2cIymOwI9LsX1QdRw666KfhPiUvMDu6LeCUAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 11 00 34 10" title="" data-src="/static/2023-10-11-00-34-10-8633fae48854eccef07ffafc9e3b77d7-a2490.png" data-srcset="/static/2023-10-11-00-34-10-8633fae48854eccef07ffafc9e3b77d7-fa40d.png 200w,\n/static/2023-10-11-00-34-10-8633fae48854eccef07ffafc9e3b77d7-a75ed.png 400w,\n/static/2023-10-11-00-34-10-8633fae48854eccef07ffafc9e3b77d7-a2490.png 630w" data-sizes="(max-width: 630px) 100vw, 630px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>这样写，能够实现出正确的运行效果，而且协程版本的代码要比原来更容易理解，因为我们不用再跟线程交互了，那些操作全都可以删掉。内置的 asyncio 模块提供了许多辅助函数，让我们能够用比较少的代码实现跟早前一样的服务器逻辑，而不用再像原来那样，必须编写许多例行代码来操纵 socket。</p>\n<p>你所面对的项目，或许不像我们在这一条里演示的这样简单，所以移植过程可能会因为各种各样的原因而变得比较复杂，但你还是应该设法利用 asyncio 模块把项目迁移到协程方案上面，因为这个模块提供了大量的 I/O、同步与任务管理特性（参见第 62 条与第 63 条）。大家一定记得查看 asyncio 库的文档（<a href="https://docs.python.org/3/library/asyncio.html%EF%BC%89%EF%BC%8C%E4%BB%A5%E4%BA%86%E8%A7%A3%E6%80%8E%E6%A0%B7%E6%8A%8A%E8%BF%99%E4%BA%9B%E7%89%B9%E6%80%A7%E5%85%85%E5%88%86%E5%8F%91%E6%8C%A5%E5%87%BA%E6%9D%A5%E3%80%82" target="_blank" rel="nofollow noreferrer noopener">https://docs.python.org/3/library/asyncio.html），以了解怎样把这些特性充分发挥出来。</a></p>\n<h3 id="总结-57"><a href="#%E6%80%BB%E7%BB%93-57" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>Python 提供了异步版本的 for 循环、with 语句、生成器与推导机制，而且还有很多辅助的库函数，让我们能够顺利地迁移到协程方案。</li>\n<li>我们很容易就能利用内置的 asyncio 模块来改写代码，让程序不要再通过线程执行阻塞式的 I/O，而是改用协程来执行异步 I/O。</li>\n</ol>\n<h2 id="第-62-条：结合线程与协程，将代码顺利迁移到-asyncio"><a href="#%E7%AC%AC-62-%E6%9D%A1%EF%BC%9A%E7%BB%93%E5%90%88%E7%BA%BF%E7%A8%8B%E4%B8%8E%E5%8D%8F%E7%A8%8B%EF%BC%8C%E5%B0%86%E4%BB%A3%E7%A0%81%E9%A1%BA%E5%88%A9%E8%BF%81%E7%A7%BB%E5%88%B0-asyncio" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 62 条：结合线程与协程，将代码顺利迁移到 asyncio</h2>\n<p>在前一条（也就是第 61 条）之中，我们用 asyncio 模块把通过线程来执行阻塞式 I/O 的 TCP 服务器迁移到了协程方案上面。当时我们一下子就完成了迁移，而没有分成多个步骤，这对于大型的项目来说，并不常见。如果项目比较大，那通常需要一点一点地迁移，也就是要边改边测，确保迁移过去的这一部分代码的效果跟原来相同。</p>\n<p>为了能够分步骤地迁移，必须让采用线程做阻塞式 I/O 的那些代码（参见第 53 条）能够与采用协程做异步 I/O 的代码（参见第 60 条）相互兼容。具体来说，这要求我们既能够在线程里面执行协程，又能够在协程里面启动线程并等待运行结果。好在 asyncio 模块已经内置了相关的机制，让线程与协程可以顺利地操作对方。</p>\n<p>例如，现在要写一个程序，把许多份日志文件合并成一条输出流，以便我们调试程序。给定日志文件的句柄之后，我们得想办法判断有没有新数据到来，如果有，就返回下一行输入内容。为了实现这项功能，可以调用文件句柄的 tell 方法，并判断当前读取到的这个位置是否为文件中的最后一个位置。若是，就说明没有新数据，这时应该抛出异常（参见第 20 条）。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-11-00-36-30-944534a7797a081f9db5ad16727eb299-0ab45.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 356px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 98.59550561797752%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAIAAAAC64paAAAACXBIWXMAAA7DAAAOwwHHb6hkAAADRUlEQVQ4y1VUh3LiSBDl/z/mrsrr9RkWg5EBRSQURgFFlEFZ5GSutbCsXdXSaHrU02+635sWtyjEpJayFRdmlB2Qdsh4C3gLi4qPC2oecUEmLmsuTGHKRQUbpNO4UKuDUh1aI8PtoxnjL4h5/IRTzzj9NMT/o7gOhzoTscvLXU7uCvI/gyGmGj1p9sLwmG7z+VZenVrwoPr0oZjvSCftSNt8KptPeXVW1mdYauz3h7K+gKexZhVCjmAtmEvlgQkTNsz5uEblHjzq5gJryuaibj5ha/DAVAKrDje7B/cElQ1y0oneJf2Z4D50503SOizqCsqvqfxC8W0WAVrSj5vt1pcbkHswF+SoPFDzuE3zfaRP/JSeL0krGhn+UJsPZBOTDdwK2aiYBDkTpJMwF5Zr+QEbhnfVGpv+h+Z0eJldlNrqTLnLrqB2WKknKKQVUG7yyvCE4/eRSdiRXDfJWzcAfUnHFPsnxQ+QQYfp0Jh3p+qbOMMUQ1jWKNsONBvVB213bZA/YN8GTHWGmjOauSPdo4OEcGOIHM083PRxw0PZjnIW/HLFLgpuAaTYyo9g2Ambed0J+neAP5MsEyTw99gKXqnp04hu000VAeoLzo2NeU/UCTP8BhtVJ6nYc8tayLcIOlEdoWd8toapXO6lai8WeynfAWb4TSr36GuwVB7B2zR51TRZqqGZDSK5eR/FdI2KJhL9dt7zPWAP9Tn0ALfcJ4LuTIQfOE06MRuVQrKmrOjnmOkjtc2KY92V/zDkS+aiQSLmW9z2MdUcGh5ogIDmqTammEPN7cs6plm0n0ImwPUtGN3AVEfCCoBtY9Njw+wdzZ4J+nXC/2IlaPKboOFOCJz9S8/bAC44krq9aPursjmru09oqX68Gqercbzb7HAFbqqgmdX5WzAdpEAs0o6BWGKx45YV6SWUnzBxDlLFzYAJMjYu1fV54jcfXwpWn96mSpsRf5AcCJOwAyAWSKI7lUESfWQMkAlSgcMr5QEKAecCtcmPalNOPAB6687YcGk/A7b2eOWF5uFKAKmOzABuBbghBjL4VVgazjyo8R02v6hYABZk06iU0i3rZ4QVgrwmXgoePq7GZgAJpGTNuAl0ERSmVsf/AcNTFXkUReXNAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 11 00 36 30" title="" data-src="/static/2023-10-11-00-36-30-944534a7797a081f9db5ad16727eb299-0ab45.png" data-srcset="/static/2023-10-11-00-36-30-944534a7797a081f9db5ad16727eb299-8eb8a.png 200w,\n/static/2023-10-11-00-36-30-944534a7797a081f9db5ad16727eb299-0ab45.png 356w" data-sizes="(max-width: 356px) 100vw, 356px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>这个函数可以封装在 while 循环里，这样就能够打造一条工作线程。如果出现了新的数据行，那就通过用户传来的 write_func 回调函数把这行数据写到输出日志里面（至于为什么让用户传入函数而不是类接口，请参见第 38 条）。如果没有新数据，那么线程就先睡眠一段时间，然后再执行下一轮 while 循环，而不是频繁地在这里查询是否有新数据出现。要是输入文件的句柄关闭了，那么工作线程就退出 while 循环。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-11-00-36-57-d69c4d2b47e545a7b25247da800ad41c-a76b9.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 559px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 50.44722719141323%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAAsSAAALEgHS3X78AAABgElEQVQoz31RaY+CMBDl//+kzR4CCoo3hQoItMglgnKtIuqHnaJrdpPNJi/NTDuvb+YNNw1SwbDhnIUZr9tqVq/qCy5bXLXs/AdVy6GyXaQ1ys8ob1hQnHF9xfUNV1e9ZsCfN0j16vJIu6fu5soNSTT2U8kNR14C+jIJ+pbXWzm84cx3lUxjce311x7UTMP9wN7IJJRsnzfcSZRxWsE0B2tPdoOpn41oPKLJ+9KAERRvBx99IBNuQAcqAerhqB5OAK1oOL2+sJaKFu1PYxLPk0IvLwje8gYAgbo/at0sUNY1fG+epRxjdtCqFr5YpFXXZIbSo2AQUO7bvmAS3iA8doc0vtPu+CbXV1BQvK3kBApNPpD1MsdvS7OHnVlcaHvmJWshb57M38plq+Xn2bboGa5EItHyXpcGOCRYVCKhaNF5UoLzOjT4l/Jp6EYTP2XGlMwbVDQqTN4FsELtB+1BxswGBhgY/IB9yI4/dIOB7YsmVTZbYeUqdLti622fxXd8AYEvFOR3gIy2AAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 11 00 36 57" title="" data-src="/static/2023-10-11-00-36-57-d69c4d2b47e545a7b25247da800ad41c-a76b9.png" data-srcset="/static/2023-10-11-00-36-57-d69c4d2b47e545a7b25247da800ad41c-8c77e.png 200w,\n/static/2023-10-11-00-36-57-d69c4d2b47e545a7b25247da800ad41c-f1700.png 400w,\n/static/2023-10-11-00-36-57-d69c4d2b47e545a7b25247da800ad41c-a76b9.png 559w" data-sizes="(max-width: 559px) 100vw, 559px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>现在，我们给每一份输入文件都启动一条工作线程，并把这些线程所输出的内容合起来放到一份输出文件里面。为此，要定义 write 这个辅助函数，并让它在给输出流写入数据之前，先使用 lock 实例加锁，这样才能使这些工作线程有秩序地输出，而不会出现某条线程写了一半就被另一条线程打断的情况。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-11-00-37-50-c3e4c6682451acf11e3564db1e52056a-65726.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 708px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 68.36158192090396%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAIAAACgpqunAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAB9UlEQVQoz3VSh27iQBTM///R6dIIEDBuuGKKcS94Xdam2oHohpiDEN1JT6v1yjNvZt574IJsYMd903tf+nyQDu1oTKq+6fNRwfppd+aIq9LYnrSq0dcf+uaIy7UepGwrpRs+psKqFP6eSrEfkzVKJCXuIqmkbDNOKjCqtL6BR17S0c3BMnxW5y/a4kmZ4rM7tVmPdLTFuxmwbvIoGb+lycAMGDdRisMNrNKDnO66hsV5ZGiFz7IxdCI+LjRaK/kObeVsCwnCimplM9mc7mTDCZQwdghMf+G96ubb1JLT7WR7akuD1avbsr4Dt0+glNONEGS9mdObu7AnrigXZjCJ5gB/x9yDq2acIp4KyQ2W0dCC7JyPcsZJhnYM2fhBLWv1vu0FjFeEAcGdyXLkJHxEJbJGYOgP2RfBX+K1qm5ZWqKLbI0ehKgAmPdTED1KE0TYn7tIG1lgeJg/FgHp6uujXoHoCNQFDHoxpq/qrD/3xIienc8cxoq6ho0RgGLkrADmogKhMlYIXiHMb2BkgyE/yUZv5mLmvbnDh0UrXqvawD5UyKYHlEL3t8DgR853WFU+IDgZJ2YDwn5dxKQ8i7zmdDbftPlfAuPDHLJHfjLyiZrtsc8QyfrE2H3+2Od/pK1XDednvwQV9WZYL8qUC3O52EPh/5CoPy886RIDOl2+AAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 11 00 37 50" title="" data-src="/static/2023-10-11-00-37-50-c3e4c6682451acf11e3564db1e52056a-65726.png" data-srcset="/static/2023-10-11-00-37-50-c3e4c6682451acf11e3564db1e52056a-1be14.png 200w,\n/static/2023-10-11-00-37-50-c3e4c6682451acf11e3564db1e52056a-43e71.png 400w,\n/static/2023-10-11-00-37-50-c3e4c6682451acf11e3564db1e52056a-65726.png 708w" data-sizes="(max-width: 708px) 100vw, 708px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>只要输入文件的句柄处于开启状态，相应的工作线程就不会退出。反过来说，这条线程要是退出了，那就意味着有人把那份文件的句柄关了。于是，只需要等待所有的线程都完工，就可以确定这些文件的句柄已经全部关闭。</p>\n<p>我们可以定义这样一个 <code class="language-text">confirm_merge</code> 函数，让它判断刚才那个 <code class="language-text">run_threads</code> 函数能不能把许多份输入文件（<code class="language-text">input_paths</code>）正确地合并到同一份输出文件（<code class="language-text">output_path</code>）里面。至于每一份输入文件所对应的句柄应该怎样创建并关闭，则不是这里讨论的重点，而且这个用来验证输出结果的 <code class="language-text">confirm_merge</code> 函数，笔者也打算省略它的实现代码。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-11-00-39-31-d74738386e61dfac0a2b8112a71531ef-0d2ef.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 561px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 45.811051693404636%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABVElEQVQoz41Q2W6DMBDk/3+K+1BbJcFgTmOuAE05AuEIJH3oQtS0b600Wo1nd8ZrMxpJd3mtklRyI41mCjmKdsCZRCGp6FCN5oIdyG5kVIPsxZzpa7QQ3RiUt6xhUHM122X/3hnVaDRXvRr0sj+UA3CoqJ70aoRqtjOQp2KsrpmxLjerv+P+hrvFBD58PoD7u/UN4Hgb+w1QGFiDt6hMj7wTyl6CqhGfrxAMvT/BiG7EIo+36Wta6h+9WU/rJf9wrmbJi3gcCHYIft4KDqfOqCdUDtAzuwVflpW0MwC40c7G+WcpRqaZGuYS/KRFWOyLfgJBHCYvyelwandFsy/OvBtyTqhEOedQiSR4Dd3MEImaCfIAejMaLdQJwbGFGxZoPQb0ekTbzKo8zWqQyn6shpnghoKzbq7QlMVEpUdxU96ySqEZaxGJxPBGDvu7oraHu3VZvgBxytzsYlJcdwAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 11 00 39 31" title="" data-src="/static/2023-10-11-00-39-31-d74738386e61dfac0a2b8112a71531ef-0d2ef.png" data-srcset="/static/2023-10-11-00-39-31-d74738386e61dfac0a2b8112a71531ef-77ffd.png 200w,\n/static/2023-10-11-00-39-31-d74738386e61dfac0a2b8112a71531ef-5ea91.png 400w,\n/static/2023-10-11-00-39-31-d74738386e61dfac0a2b8112a71531ef-0d2ef.png 561w" data-sizes="(max-width: 561px) 100vw, 561px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>这是一套用线程制作出来的方案，我们现在要从这里开始，把它逐渐转换为一套采用 asyncio 与协程实现的方案。转换思路有两个，要么从上往下转，要么从下往上转。</p>\n<p>从上往下转，必须由整个项目的最高点（例如 main 入口点）开始。把这一部分改掉之后，再沿着调用体系向下，去转换它所调用的那些函数与类。如果项目维护的是一批常用模块，而且有许多程序都会用到这些模块，那么就比较适合从上往下转换。首先要把入口点转换过来，至于那些模块，可以等其他地方全都迁移到协程之后，再去移植。</p>\n<p>具体步骤为：</p>\n<ol>\n<li>修改当前的顶层函数，把声明方式从 def 改成 async def。</li>\n<li>把这个函数所要执行的 I/O 调用（也就是有可能阻塞事件循环的那些调用）全都用 <code class="language-text">asyncio.run_in_executor</code> 封装起来。</li>\n<li>确保 <code class="language-text">run_in_executor</code> 所使用的资源以及它所触发的回调函数都经过适当的同步处理（这需要通过 Lock 或 <code class="language-text">asyncio.run_coroutine_threadsafe</code> 函数来实现）。</li>\n<li>沿着调用体系向下走，按照刚才那三个步骤将当前函数所调用到的其他函数与方法迁移到协程方案上面，看看这样迁移能不能把 <code class="language-text">get_event_loop</code> 与 <code class="language-text">run_in_executor</code> 从目前这一层里面拿掉。</li>\n</ol>\n<p>下面，我们按照上面提到的第 1 至 3 步来修改 <code class="language-text">run_threads</code> 函数。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-11-00-41-47-b25455151ac1aa0de94ef761820c21d3-7ab71.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 716px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 85.89385474860335%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAIAAABSJhvpAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACUUlEQVQ4y3VTiZKaUBDk/78pya6uqKiA4AIiIvd9g2gWdSv9wD2TVHVR43tvZnp6WoqxItZNWS+bHrylm0pVpzRXubkqb5DrTq4v97i5KMf+vP9S67gS81ZIGj6uhPTIRRWf1Ou04cKSDQtgU5xxjmAd1ySICjxgA1yVFBvkczMYb42Vmz1I2kjWR/IB+LVRH561n6I63h64oFi4CfKRNrfCpZeC78rPKKW9bfIT+oDeOqrFlLBYJw2aPPc9SVC9DCC025sMzu0NzCmSE9crN53p7vzgTXbW084cq8asl4DeOySw44lm441UdyghvYHCb3JU/ga3ueE9qSammGgW+D9KGq07CycRsxY9Idvw+B3Ue4RrqLX0Mj6uCaKSjyoU3Z5epeYy0B4akqB+uScjTchaooSbMGZAazZIYgW4ghyYHyXIbo7X+7T92F864wijApxf0poz2upjRX9U9tAc5aAtwPoZ48SMHWFHX5LBhGzCDKe6v3SSH4ICwYTshBEwDheVHFYVVSs/RxWY4ntnDDwzfMaO4TZas/CUUIVUPWH5f7ShAcpDVSFtxfxEapG06wcvIlL3D7WJYGk7kvdkyaoJVtj83AhgI3hT7qvgjdR0EvlehhTgozPWOD340JkPq9HWQJWJas0Mb7J3xjssPxSLM4ByYCEWJwSf9lx3QlwzZkjvLBhrpB5QiDF9yDbt7cX6cJEPt/FhubAj4JNgxysLJb0cr7EMiAdvwdhEnp7qwFn+ThsGys9LOxLiZuUkfZMcsq+8DP9zGB6tyMB/CfYH9NOLKmIo/A8AAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 11 00 41 47" title="" data-src="/static/2023-10-11-00-41-47-b25455151ac1aa0de94ef761820c21d3-7ab71.png" data-srcset="/static/2023-10-11-00-41-47-b25455151ac1aa0de94ef761820c21d3-a8f09.png 200w,\n/static/2023-10-11-00-41-47-b25455151ac1aa0de94ef761820c21d3-924e7.png 400w,\n/static/2023-10-11-00-41-47-b25455151ac1aa0de94ef761820c21d3-7ab71.png 716w" data-sizes="(max-width: 716px) 100vw, 716px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>这段代码通过 run<em>in</em>executor 方法命令事件循环采用特定的 ThreadPoolExecutor（参见第 59 条）来执行特定的函数，在本例中，这个函数指 tail<em>file。ThreadPoolExecutor 要通过方法的第一个参数来指定，如果第一个参数为 None，就采用默认的 executor 实例。run</em>tasks<em>mixed 协程针对每一份输入文件都调用一次 run</em>in<em>executor 方法以执行相应的任务，而且 run</em>in<em>executor 前面不加 await，这样能够形成许多条并发的执行路径，从而实现任务 fan-out（分派）。然后，该方法通过 asyncio.gather 函数收集这些任务的执行结果，这个函数会等待所有的 tail</em>file 线程都完工，从而实现成果 fan-in（归集），这次函数前面要加上 await（fan-out 与 fan-in 详见第 56 条）。</p>\n<p>这段代码在实现辅助函数 write 时，不需要再通过 Lock 实例加锁了，因为它是用 asyncio.run<em>coroutine</em>threadsafe 函数来提交写入操作的。这个负责执行写入操作的 write_async 协程，无论由哪一条工作线程提交，最终都会安排到事件循环（即 loop）里面执行（这个事件循环一般位于主线程之中，如果有必要，也可以放在其他某条线程里面）。这些协程全都是放在同一条线程里面执行的，因此，这实际上意味着，它们对输出文件所做的写入操作本身就会有秩序地执行，而不会出现相互重叠的情况。只要 asyncio.gather 有了执行结果，我们就可以认定，对输出文件所做的那些写入操作全都已经执行完毕了，于是，我们可以放心地让 with 结构把表示输出文件的那个 output 句柄关掉，而不用担心其中是不是有写入操作还没执行完。</p>\n<p>现在看看修改之后的代码，能不能实现预期的效果。我们通过 asyncio.run 启动 run<em>tasks</em>mixed 协程，把事件循环放在主线程之中运行。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-11-00-42-41-207a26a5b133cf6be41cfc7ac2a9f93a-a2e9a.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 687px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 25.036390101892287%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAIAAADKYVtkAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAA50lEQVQY00WP626DMAyF8/4P1a1dacbGpdAAYyxAKSTcCqEBVWWtVIf9mPTJ8vFx7BhtwuM6TLbRSYtz9zy5/ZUMN2+YAbJExeUf8ieXiF5ItCIRpoVRnL3+5l/mQN798R4oHsGk8OUv4MkZ6l8jyMUaH+jV/9mE6fY7W3tUj0sjb/W0/Mybj6zGCccJ29Hc5sKppNtOJut2cWGzDiz9WCG7FIDTjvtG2tVgAVCphMV7qxIm70A6jdzX6rHTSoN34JqlgE4Es9/VmPItyjR6wjGsYjhlakMtNVpAA6DR/NBf4dsKuGJJnpypCSz2yMtJAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 11 00 42 41" title="" data-src="/static/2023-10-11-00-42-41-207a26a5b133cf6be41cfc7ac2a9f93a-a2e9a.png" data-srcset="/static/2023-10-11-00-42-41-207a26a5b133cf6be41cfc7ac2a9f93a-b5b37.png 200w,\n/static/2023-10-11-00-42-41-207a26a5b133cf6be41cfc7ac2a9f93a-68786.png 400w,\n/static/2023-10-11-00-42-41-207a26a5b133cf6be41cfc7ac2a9f93a-a2e9a.png 687w" data-sizes="(max-width: 687px) 100vw, 687px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>按照前面三步修改之后，我们遵循第 4 步继续修改。这一步要求我们沿着调用栈向下走，把本函数所调用的其他函数，也按照前面三步来改写。于是，我们就针对 run<em>tasks</em>mixed 所依赖的 tail_file，运用第 1 至第 3 步，把它由一个执行阻塞式 I/O 的普通函数变成一个异步的协程。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-11-00-43-07-094647b113d172d2167d66e1d95c079a-ba470.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 649px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 48.9984591679507%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABo0lEQVQoz12RCW/iMBCF+f//qe1qUyD3fQABEsc4duLcB1COqhO6bKVKT9bEmjff5HmmHQoVFzqpdFIqiMMpxlSKmRhRYY3gxmSdjDJxnyqYG7SR9qmK+TzEcpLPnPpkFsObG6qklDEX1vF8i4UNAr1v0DxMpIj98UIo7OroNGe7Gu36aJUjfM78/uq1Fz1rYYpTnYy8M/MeTrsYzanu4B4MXnP2u6vXXb4FLtBktspBxplGOKxnZu18mywjavH+fYclRP3uEoz37+5guK+Guz/cvH4aNHtOukG3Sgqd1kB2m7NKS7c+GVljsFZnrVOO0KCQQoGMaAXr/Ji99uMx/gZk4MsxU3C+2B1endVfbyvG7NUNX+wA4gCzRkqnOnr9D/lqsEZG1C56YRW/WMEixFBYRW8VAyyi0drIWvjz1fj5e22QXY4Q+GKTLPepsE4ABWSD1UADsoxzKclERE3eec/knuTuamTTe5qsAQ7QHoEPkDYwddaYvAfBC7nt+T8PzB+T2kkAF6NUSyv5wEXExD1ZRkRCbBERLa2D8eb3l3/9D30B84ISuh02sUwAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 11 00 43 07" title="" data-src="/static/2023-10-11-00-43-07-094647b113d172d2167d66e1d95c079a-ba470.png" data-srcset="/static/2023-10-11-00-43-07-094647b113d172d2167d66e1d95c079a-47540.png 200w,\n/static/2023-10-11-00-43-07-094647b113d172d2167d66e1d95c079a-ee316.png 400w,\n/static/2023-10-11-00-43-07-094647b113d172d2167d66e1d95c079a-ba470.png 649w" data-sizes="(max-width: 649px) 100vw, 649px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>将 tail<em>file 函数改为 tail</em>async 协程之后，就可以把原来为了执行该操作而使用的 get<em>event</em>loop 与 run<em>in</em>executor 从顶层函数 run<em>tasks 里面往下推，把它们放到调用栈的下一层。在这个例子之中，它们下沉到了 tail</em>async 里面，于是我们可以把顶层函数中的那两条对应语句删掉。现在的顶层函数，变得好懂多了。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-11-00-43-28-a0b46d3fb040ce775c6b6393c6111fd8-0a3ee.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 747px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 40.696117804551534%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAA7DAAAOwwHHb6hkAAABTUlEQVQY02WQ63KCMBSEff93UkflIqCISABBkEBCEKJYQNuKzPSA9U87s2QS5mzy7Y40ki8jJodUiTLBx1PLn6LDxNwLXqzTM6xSQOQwHZuedEiUiAmHZFd+orpF1WPk3Drr+rXJrnJAl2EquEfBw3M3kAMieljwYwWzFbus2cWpWxh27h2qH+DszfDZw8E83xScSSFZEa7FJ6CQAmoUtXm5283Trlur+rY+eqGX3ubW5M3cjTScy8fUyKtt0ejZFX72T92618yvmqczCPa9GQJADD0rRT8GWo1w0U9mdgBHJcnVJAcolfBVejZ5DSukUEkBQUYvejTcOnePalxAPRO0X+yjhReNd95iaGHmhlAqRDB4vSmqdVZuefM2D1Lj/p0lZmJA4RYlPkEdQAgJ7X6gRW9y+w828BhFpVIOPLBXkpPOSo1yILSGev7rBy2kp7BZyz40AAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 11 00 43 28" title="" data-src="/static/2023-10-11-00-43-28-a0b46d3fb040ce775c6b6393c6111fd8-0a3ee.png" data-srcset="/static/2023-10-11-00-43-28-a0b46d3fb040ce775c6b6393c6111fd8-14d81.png 200w,\n/static/2023-10-11-00-43-28-a0b46d3fb040ce775c6b6393c6111fd8-58aa6.png 400w,\n/static/2023-10-11-00-43-28-a0b46d3fb040ce775c6b6393c6111fd8-0a3ee.png 747w" data-sizes="(max-width: 747px) 100vw, 747px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>我们看看这次的 run_tasks 改得对不对。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-11-00-44-19-9de459439c4494c864283e6cabff0753-58f3c.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 627px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 29.1866028708134%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAIAAABM9SnKAAAACXBIWXMAAAsSAAALEgHS3X78AAAA+0lEQVQY042QWY+CMBSF+f//yRik4DIZpVAERJZiJ1CRraAsOslcRh7mcZIvNz23vT09lTSf7ShHXryl3Mw7UnRWNRzF+B+kBXZk29+xTOfCKB5WPRBAjDP1YInxDZm3Jt4daeWEYK56l4/4OtnWYPu0m9ex/aV5AnAOqnP/tlvgBczD6Ey1gG2jFJ1jBFdQrrghNCHIyg7WPtsnJU7rz7RSfSY7wSbish0qJ2qVvaRnAmetUXT6rcVZg28tLEAersLIHzi/QyVlb5bdgQuQZtlDOpBTZg2+KvhCHgUf5IaaRxU3UgO2JO4+KTZRsiQn1b8oTggvIlX3N8sPpkE+8hPH+L4AAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 11 00 44 19" title="" data-src="/static/2023-10-11-00-44-19-9de459439c4494c864283e6cabff0753-58f3c.png" data-srcset="/static/2023-10-11-00-44-19-9de459439c4494c864283e6cabff0753-a8bea.png 200w,\n/static/2023-10-11-00-44-19-9de459439c4494c864283e6cabff0753-f4947.png 400w,\n/static/2023-10-11-00-44-19-9de459439c4494c864283e6cabff0753-58f3c.png 627w" data-sizes="(max-width: 627px) 100vw, 627px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>大家还可以继续重构，也就是在 tail_async 里面继续往下探查，把它所依赖的 readline 函数也按照早前讲的那三步转换为协程。但是，那个函数的任务本身就是执行许多项阻塞式的文件 I/O 操作，所以好像没必要移植，因为我们在判断是否需要移植时，应该考虑到，这样做会不会让代码变得难懂，会不会降低程序的效率。有的时候，所有代码都应该迁移到 asyncio，但另一些场合则没必要这么做。</p>\n<p>上面讲的是从上往下迁移，我们现在反过来，看看如何从下往上迁移。这也可以分成四步，但方向相反。原来是从顶层函数入手，沿着调用栈向下走，现在是从末端函数（也就是叶节点）入手，沿着调用栈向上走，一直走到整个调用体系的顶层，也就是入口点所在的那一层。</p>\n<p>具体步骤为：</p>\n<ol>\n<li>为要移植的每个末端函数（leaf function）都创建一个对应的异步协程版本。</li>\n<li>修改现有的同步版本函数，把它原来执行的那些实际操作全都拿掉，让它只通过事件循环去调用刚写的那个异步版本函数。</li>\n<li>沿着调用栈向上移动一层，针对这一层里的相关函数制作对应的异步版本，并让那些异步版本函数去调用第 1 步里创建的相应协程。</li>\n<li>把第 2 步里纯粹为了封装协程而设的同步版本删掉，因为上一层现在调用的是下一层里的异步版本函数，这些同步版本现在已经用不到了。</li>\n</ol>\n<p>还以刚才那套代码为例，我们前面已经决定让最底层的 readline 函数依然执行阻塞式的 I/O，因此，现在的末端函数实际上是 tail<em>file。先按照第 1 步，给它编写配套的协程版本，也就是 tail</em>async（这个版本的代码，我们在上面已经展示过了）。然后，执行第 2 步，也就是把 tail<em>file 的实际功能去掉，让它只负责将 tail</em>async 封装起来。为了做到这一点，我们必须想办法确保 tail<em>async 协程能够运行完毕。笔者给每一条 tail</em>file 工作线程都创建一套事件循环，并在事件循环上面调用 run<em>until</em>complete 方法。这个方法会阻塞当前线程，并推进事件循环去执行 coro 所表示的 tail_async 协程，直到该协程退出为止。改编后的效果跟原来那种通过线程执行阻塞式 I/O 的效果是一样的。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-11-00-45-22-b8174b515c103f54e3575cdbdeaf5b20-ad33d.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 652px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 38.49693251533742%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAA7DAAAOwwHHb6hkAAABTUlEQVQY011R2Y6CQBDk//9piSggIiiHICD3MNzHCjruaqLbSNwrqYdOp2qquoaSccO5aJM2Sy/h3ZjZ+wsnVMte8FPYLD2s5B3nxlJcTAStGszhZvZXAKW15E21xSgXo5Ix3IUdzgFWMN/7M8NbWNEMlg4y2oveXYBsHD+N/jqB0jrC+1iI8nVSrqJMRCUfYClt2OcSnIUwM4bbyAbDafgW794/NsVR74hSn/SWKFWvNme1HmCQskbCtdacjb+aHzGEATcxLCAq+NA7hzFdWrOYvSfGBeclStn/l72SU/CqTe5qNchpBzw567bFcY1r8LcvD4vczSntC+YvPG/2MIi3Zb9OKimpV3EuooJ1EXtAcNHYgofEOB8fRdBLPnYRYKgGYhNat4Ug458/MTddIUhpzaZ1i3VC1g65QySn7a4lekOgFKgAAoKZVp++AKSkpTEhtQedAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 11 00 45 22" title="" data-src="/static/2023-10-11-00-45-22-b8174b515c103f54e3575cdbdeaf5b20-ad33d.png" data-srcset="/static/2023-10-11-00-45-22-b8174b515c103f54e3575cdbdeaf5b20-6a23f.png 200w,\n/static/2023-10-11-00-45-22-b8174b515c103f54e3575cdbdeaf5b20-cad54.png 400w,\n/static/2023-10-11-00-45-22-b8174b515c103f54e3575cdbdeaf5b20-ad33d.png 652w" data-sizes="(max-width: 652px) 100vw, 652px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>改编后的 tail<em>file 函数，跟改编前一样，也可以直接由上一层的 run</em>threads 来调用，而且效果相同。我们现在就来验证一下：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-11-00-46-19-e229782864f6223267eadd7984911103-daebf.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 502px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 34.26294820717132%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAAsSAAALEgHS3X78AAABPElEQVQY04VR23KCMBDl/7+odmoRL1UpkgpJALmJCgYId0HxNt3p9KVPndnZ2T0552yyEV51Ora8yWY7QHhs+jjrNN7i4kzq678hDFQ8xJZkOFra4eyipS0te1JeSNX/pfY/COTrbwFiiTgSdeVdMrWDuR/pvKP1zWgfxulBmhtt7hTy6Q6t0T2hMNuH2T4BB70gYluk7lCzXhTtXd/Mnf10E4jEXgZszRsUZeu0RqxY+NHE3smHBAaMLX8V5WAkqKxc8xNKauWQKVGuHgv5wOWQQwG4lnda1qK4UkK+DGI1LhYB+ww5gHAjQQmzVZiBGKUNGEEAVY0ryHregZHKClz1X0AAPKlxeV4dC5gMoCAarhywmbOXDE8yvTfdWm6PI+JOrC1sYUQdOEKs/PBCEbZj+vAv8KiZvYOlfgOX+nB8HQk9dgAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 11 00 46 19" title="" data-src="/static/2023-10-11-00-46-19-e229782864f6223267eadd7984911103-daebf.png" data-srcset="/static/2023-10-11-00-46-19-e229782864f6223267eadd7984911103-d8b35.png 200w,\n/static/2023-10-11-00-46-19-e229782864f6223267eadd7984911103-df7a1.png 400w,\n/static/2023-10-11-00-46-19-e229782864f6223267eadd7984911103-daebf.png 502w" data-sizes="(max-width: 502px) 100vw, 502px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>用 tail<em>file 把 tail</em>async 封装起来之后，我们该进行下一步改写了，也就是按照第 3 步改写。这时，我们上移到 run_threads 这一层，把这个函数改写为对应的协程版本。这样做出来的效果，跟从上往下迁移时的第 4 步所达成的效果，其实是一样的，所以我们看到，这两种迁移思路在这里汇合了起来。</p>\n<p>要想发挥出 asyncio 的优势，我们在这一条里面所演示的项目迁移工作是个很好的切入点。然而除此之外，还有其他一些技巧，可以继续提升程序的响应能力（参见第 63 条）。</p>\n<h3 id="总结-58"><a href="#%E6%80%BB%E7%BB%93-58" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>asyncio 模块的事件循环提供了一个返回 awaitable 对象的 <code class="language-text">run_in_executor</code> 方法，它能够使协程把同步函数放在线程池执行器（ThreadPoolExecutor）里面执行，让我们可以顺利地将采用线程方案所实现的项目，从上至下地迁移到 asyncio 方案。</li>\n<li>asyncio 模块的事件循环还提供了一个可以在同步代码里面调用的 <code class="language-text">run_until_complete</code> 方法，用来运行协程并等待其结束。它的功能跟 <code class="language-text">asyncio.run_coroutine_threadsafe</code> 类似，只是后者面对的是跨线程的场合，而前者是为同一个线程设计的。这些都有助于将采用线程方案所实现的项目从下至上地迁移到 asyncio 方案。</li>\n</ol>\n<h2 id="第-63-条：让-asyncio-的事件循环保持畅通，以便进一步提升程序的响应能力"><a href="#%E7%AC%AC-63-%E6%9D%A1%EF%BC%9A%E8%AE%A9-asyncio-%E7%9A%84%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF%E4%BF%9D%E6%8C%81%E7%95%85%E9%80%9A%EF%BC%8C%E4%BB%A5%E4%BE%BF%E8%BF%9B%E4%B8%80%E6%AD%A5%E6%8F%90%E5%8D%87%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%93%8D%E5%BA%94%E8%83%BD%E5%8A%9B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 63 条：让 asyncio 的事件循环保持畅通，以便进一步提升程序的响应能力</h2>\n<p>前一条演示了怎样把采用线程所实现的项目逐步迁移到 asyncio 方案上面（参见第 62 条）。迁移后的 <code class="language-text">run_tasks</code> 协程，可以将多份输入文件通过 <code class="language-text">tail_async</code> 协程正确地合并成一份输出文件。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-11-00-48-10-1cd188ff48e5eba96a218214cfeeb8c0-72cb8.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 751px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 51.53129161118509%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAAsSAAALEgHS3X78AAABjUlEQVQoz1VSi26qQBT0/7+pTW9LtfLWsLKiqDxW3rKwaAvWJh3A3t6bnGxOlpmdOXOYmGm9yMUib9CYuTDS2kgrPeF6zC3+jt7Maou3ONEbSaVHJanalbiiJotMqEEm74/KIZKcw8OSPpHtw3I930eKn75u/KkbSpvg0XJUlmvR6T+y3dxWzad1uqh+AoK09mZAO96zvXuh+7cd01kBZVJ1tLnRc18jsyf/7VbiUzsWSpjrSaUeT29erISZBZG6w1ciOlLfawB3d7LdK79Pt8ESw6c1qVt6+epFxvP8BWvA2Ofb/RyruQ3KIJcfWphLjv9CDxCf7tgTcV/dQItLJEd4ayQ10loWF31MNOZmKn5tE3FFNhorZD/FzDM3mG3DP3QnbTxkgeTmhxhkcPS4RHLYzi8ZlmYum3vJdBsiLUTVD1KcLf5hZtilQDPapj/O72QYw3uYXI9ORsKBVlkx7hb3IxTTDTkN+Q2xTdbV1amupGy1uOfIYYY/RPYThWUwJrMcNzZvKVZVdQD/W982vxStMnewmgAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 11 00 48 10" title="" data-src="/static/2023-10-11-00-48-10-1cd188ff48e5eba96a218214cfeeb8c0-72cb8.png" data-srcset="/static/2023-10-11-00-48-10-1cd188ff48e5eba96a218214cfeeb8c0-51fba.png 200w,\n/static/2023-10-11-00-48-10-1cd188ff48e5eba96a218214cfeeb8c0-d1c50.png 400w,\n/static/2023-10-11-00-48-10-1cd188ff48e5eba96a218214cfeeb8c0-72cb8.png 751w" data-sizes="(max-width: 751px) 100vw, 751px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>但这样写有个大问题，就是针对输出文件所做的 open、close 以及 write 操作，全都要放在主线程中执行，而这些操作又需要在程序所处的操作系统执行系统调用，这些调用可能会让事件循环阻塞很长一段时间，导致其他协程没办法推进。这会降低程序的总体响应能力，而且会增加延迟，对于高并发服务器来说，这个问题尤其严重。</p>\n<p>调用 asyncio.run 函数时，把 debug 参数设为 True，可以帮助我们发现这种问题。例如，下面这种写法就能显示出，slow_coroutine 协程所执行的系统调用耗时比较长，这可以提醒我们注意，要读取的文件是否已经损坏，或者其中某一行是否读不出来。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-11-00-48-38-50eb5c4459dd1cb21f35e446cec2cbc7-2a196.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 762px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 42.38845144356955%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAA7DAAAOwwHHb6hkAAABRklEQVQY022R626CQBCF9/0fySa1rRRRLgtWRAXlUthluclFklpt0gP+aWKTk8lkk5nznVmixrnGKoOf1KRw+p/N+XaX3V3t9jLq227G+iBi8MrMWyoamg3S05PGSiyyis7Blu561//Dq7Jfxrl8iOd+8rJxFZ9pSYkqe7EaF+jBpScVFfX6wZ9YZW+I2sxaI611XlnF2cw7KloEAQhCoTFFvSr6P/yXsbkQJeA6q8ysQ9UZmCs1BnaJGQwooUAKmtYAdO6HQIrzzemGu5C5z5BTT4fdGIDzgJDWhmj00Rx71/UXsDV+0nhFsxYXQVKEIhNqS/tQcsOp7U7XnuwhuTcx7TfnMNv60i6a7QPo+WMnudHr1n8ybSXk8KB5Q/BkDSGb90OshKl8TMAiH3E/tvzMUOEjB2wepItQLKJs5kZ433TDR/wC7HGnI3Wn99YAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 11 00 48 38" title="" data-src="/static/2023-10-11-00-48-38-50eb5c4459dd1cb21f35e446cec2cbc7-2a196.png" data-srcset="/static/2023-10-11-00-48-38-50eb5c4459dd1cb21f35e446cec2cbc7-ac3c7.png 200w,\n/static/2023-10-11-00-48-38-50eb5c4459dd1cb21f35e446cec2cbc7-daea7.png 400w,\n/static/2023-10-11-00-48-38-50eb5c4459dd1cb21f35e446cec2cbc7-2a196.png 762w" data-sizes="(max-width: 762px) 100vw, 762px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>为了进一步提升程序的响应能力，我们可以想办法把那些有可能会执行系统调用的操作从程序本身的事件循环里面拿走。例如，新建这样一个 Thread 子类（参见第 53 条），让它把那种给输出文件写入数据的操作封装到自己的事件循环里面，这样就不会阻塞程序本身的事件循环了。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-11-00-49-07-f1ac880488e6c2a991697ecdd0b84d5b-9f160.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 734px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 65.53133514986375%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAB30lEQVQoz3VSa4+iQBD0//8oIwoLKIoggvKG4T0gCLi6p5tcjV7uw56XFJ3JQNFV1T1REqpkjRQVgpfKcblO6nV22uSt4BIlbfb9L+P8hfoWk03Zac24LlolO72wzhm29WCN3088/kveVv2Hl8hhIQb5/BAuXMJZ3odHZpa3jCs5KqWoNPv7e7I1PPbnL70ZRT+Vg2xJKtFPJByicp1BTrMpOjR4K36CxxwfKu3nhwASpoYthzlvR8x83spxpaT1ilBzuJv/6GdkuFKrM2/HIM8MR827hR0tjpGSNMhMjgvkJwbZKil/9Gdk/fSpNxetHjXab2kPh7v2Ci+ou9MnQ3vFN9rp8rMz9MDVJm0ENxacSPJz8De01+qLSgco0qp+W+HQM+UvjI+XBXT+Mi/fICBk0UuFY8TtHc50ub07NZzpzoYXYG75iA3mV6R8TqGAnMlfDdZwxxVeC26CKgUpOLxLloRiIoDR3Yz2arQ3eAT+eGZr1N3UsteqQaMDRKKJXo9q0en1RacjfOEM87jE8qCy+3p8koc7OIJDuIPPmsfV4hjyDkFnGMH+IHwMT4oyyc8EjyyeQ9VeZGSwpQOWRGT2Uka2Q9HPsOoz08PXvIMs42Vc4tfcIeDtUC3OyOw3ljmwlPMfQDQAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 11 00 49 07" title="" data-src="/static/2023-10-11-00-49-07-f1ac880488e6c2a991697ecdd0b84d5b-9f160.png" data-srcset="/static/2023-10-11-00-49-07-f1ac880488e6c2a991697ecdd0b84d5b-6716a.png 200w,\n/static/2023-10-11-00-49-07-f1ac880488e6c2a991697ecdd0b84d5b-f6bb6.png 400w,\n/static/2023-10-11-00-49-07-f1ac880488e6c2a991697ecdd0b84d5b-9f160.png 734w" data-sizes="(max-width: 734px) 100vw, 734px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>其他线程中的协程，可以直接调用这个线程类的 write 方法，并对该方法做 await。其实这个 write 方法，只不过是把真正负责执行写入操作的那个 real_write 封装了起来。这种封装方式能够确保线程安全，因此不需要再通过 Lock 加锁（参见第 54 条）。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-11-00-49-41-8c2605cc2772df73558f88d88ddbac25-1627b.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 582px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 34.192439862542955%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAAsSAAALEgHS3X78AAABMklEQVQY02WQa2+CMBSG+f//yQyhgBh1IrTcWlrKxSm6Ikrwsi07uC/Llpxe0ubJec6rzXi9KI8oyZflwYi5wysrlSgRNi2MWCyqwzQS8LvateT8wN39d2m4vVq0sFkFpWPqZLWTVUCimE8Js2m5UYOvBny6/SFH2BXb161yee3KvcNrMxE6yYD3mvMEp0bEsbqG/dd/coQ3x96MhMNKb39BqbRZiRJpxrmb7ywqJ36qE2YmuXfs8fkRnG7kuQdPEQ0WzAbCc7lf7zorySd+AoPMBFjkoA0wohJeoAFiBUTwQhik4zX9CJPLx2qrDMKWtXLF2zSi86IxwgxESHcP2quvoIbgffDb4ScCeCSnuwYHZAt9RoxQFAuHFmYsXoIU7no4NgF/UAOFddOF/ecz9jH5byo0bHZ7wFpzAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 11 00 49 41" title="" data-src="/static/2023-10-11-00-49-41-8c2605cc2772df73558f88d88ddbac25-1627b.png" data-srcset="/static/2023-10-11-00-49-41-8c2605cc2772df73558f88d88ddbac25-2ccd9.png 200w,\n/static/2023-10-11-00-49-41-8c2605cc2772df73558f88d88ddbac25-1954a.png 400w,\n/static/2023-10-11-00-49-41-8c2605cc2772df73558f88d88ddbac25-1627b.png 582w" data-sizes="(max-width: 582px) 100vw, 582px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>然后，我们按照相似的思路，编写真正负责停止本线程的 real_stop 方法，并把它封装到 stop 里面，这样的话，其他协程就可以通过 stop 方法告知本线程应该结束工作。这项操作同样是线程安全的。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-11-00-49-59-2092ca1459fa214fcc82c0b3d68f4bcf-01084.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 583px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 36.02058319039451%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABJ0lEQVQY03WQbW+CMBSF+f+/aJ82eSmgbE4FCwIttLwIEkAEdQpbdus+bktObu5NenKeU8ni5Tzer8pOD5K3vEEEZq0GTPUinaQ6zez6gvsRn+6/JdnH67oeNJ8ZJEE+U1y6YMXT0kFhYjeXTXN2uo/t6f6npLlILl7TyqS5xSsZEyE3Mtneu3x550/8j1OY7fa6qSA5NuNifeiB1oxyAEYhBwTZJVZW4WGCp2IC/zC5/QRFhBlup7spHoXAZV6vik7z4pdtaEaZEeUzl6CAy9CfZlrAEU1lj0K1GQ4RSaUfANxPy30L/veyM0im7hjEPm92i+TgDqPdXEFQ3mkfguUIugkzbMBpJQeLldqOwT7nheqzRxQEMj3kkK/4MQpT8c8AD9j9+A2qnm/4LXykDAAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 11 00 49 59" title="" data-src="/static/2023-10-11-00-49-59-2092ca1459fa214fcc82c0b3d68f4bcf-01084.png" data-srcset="/static/2023-10-11-00-49-59-2092ca1459fa214fcc82c0b3d68f4bcf-6d88c.png 200w,\n/static/2023-10-11-00-49-59-2092ca1459fa214fcc82c0b3d68f4bcf-8e47e.png 400w,\n/static/2023-10-11-00-49-59-2092ca1459fa214fcc82c0b3d68f4bcf-01084.png 583w" data-sizes="(max-width: 583px) 100vw, 583px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>另外，还可以定义 <code class="language-text">__aenter__</code> 与 <code class="language-text">__aexit__</code> 方法，让我们的线程能够用在异步版本的 with 语句之中（参见第 66 条），以确保该线程的启动与关闭会安排在适当的时机执行，而不拖慢主事件循环所在的那条线程。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-11-00-50-39-e83bdfa6baba822c8005329dba73792b-73362.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 609px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 32.34811165845649%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAIAAABM9SnKAAAACXBIWXMAAAsSAAALEgHS3X78AAABGklEQVQY011Qa3OCQAzk//+kdlq1FuQhKsgbRI73IXAgIBSpbeiMXzqzs5PsbXJJKD7IeJRyXro5hXLWrozzUndA4X28Mty1eVZIr1TDsbyp1aA19ycmYEq9jvD2Lps8yoQgXxxtxgk+oIVq07a/UKy15UPHN1kXwotMbntcS5fmcGmkoqPUZlTK/lN3tz7mfPxy0FgvZRGGiWg3ZNyIdgLmLxBjso0K9hyDjXFnprR2HkMI811KREygRqkHo//Ru29reBi3h9nPDCnY9HaCADAr7UTtcQVlUt6JCdGuo4grMSmlvN1hwqIE9H1Ww4RqPar1F0B5Aval5g/jgrYQ5yUcwq8HfeNGS+1E20iICzgHbCjBtZo7uP/hF+KuPRucfmiqAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 11 00 50 39" title="" data-src="/static/2023-10-11-00-50-39-e83bdfa6baba822c8005329dba73792b-73362.png" data-srcset="/static/2023-10-11-00-50-39-e83bdfa6baba822c8005329dba73792b-06e0b.png 200w,\n/static/2023-10-11-00-50-39-e83bdfa6baba822c8005329dba73792b-70531.png 400w,\n/static/2023-10-11-00-50-39-e83bdfa6baba822c8005329dba73792b-73362.png 609w" data-sizes="(max-width: 609px) 100vw, 609px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>写好了新的线程类之后，我们可以重构 run_tasks，把它变成纯粹的异步版本。这个版本更易读懂，而且完全避免了那些耗时较长的系统调用把主事件循环所在的线程拖慢。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-11-00-50-55-6ccbdadc4d853360bde69e11a8443b27-930ed.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 769px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 53.18595578673602%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABpklEQVQoz1WS63KCQAyFef936kwLVVChKDfRUlllQWG5CYJYtdOzYJ3pzPmRbEjyJUFQAyauiEL2717wviayH9nHzq4uDx0v/+zedarvQYJTXyG3uS9PN7f9WTb34cVGuL4u/4yn4D4laDTVwmxG2TRIZLJX/Eje0JG3m8fHyS6Bq0a5GqaT7UHx99NdYhVd379PNvOzBXGkb7PozPJilRez7NCEG8UZ74haJUJIA8XNOd0eyR+HUu+lheksYHCBMA1imfeJjbQBFxrOk0qPS7zgGyAY6cmur4IW5RM/gj/2AkCKayKtiLQmb64vuv74KxRdgmSFHF4dT96EC1bNWWWBaFiYmbWS6yM88qgeH42sUcMMCE6/Kr6wE0d1eoOvFksFOTojhpEWaT3+ouij0kzZRKK7EftyMon0pAbqZBujLjAxjhrmGE3bF8IwOirxa2PObfxirCQkr3j+CMf/3EnrLUqbebvIGp3VRtYaOXT+S66vMywMogzdeKsgBpHb/Nj1484wgMr5h2s/sItOpWzBgJeoNP2ICvxwIIQNwyxa+/+/8dQv0mlKFrxUBdsAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 11 00 50 55" title="" data-src="/static/2023-10-11-00-50-55-6ccbdadc4d853360bde69e11a8443b27-930ed.png" data-srcset="/static/2023-10-11-00-50-55-6ccbdadc4d853360bde69e11a8443b27-b7322.png 200w,\n/static/2023-10-11-00-50-55-6ccbdadc4d853360bde69e11a8443b27-8fc56.png 400w,\n/static/2023-10-11-00-50-55-6ccbdadc4d853360bde69e11a8443b27-930ed.png 769w" data-sizes="(max-width: 769px) 100vw, 769px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>现在验证这样写是否正确。我们把一批输入文件所对应的句柄放在 handles 里面，交给 run<em>fully</em>async 去合并，然后调用 confirm_merge 函数，以确认这些文件之中的内容，已经合并到了输出文件里面。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-11-00-51-44-9c94feacdf4c997886f7d72a6f802d61-76b75.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 699px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 33.33333333333333%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAAsSAAALEgHS3X78AAABFUlEQVQY03WQD2+CMBDF+/0/1DYDiEMCigKbFKylYKEwKQXnxCUemiz7kyW/XO5eX9p7RXZWGTEzk8xMcm2z0yNiRBTGaZJpG+JyqUVUj+iM7Cdh4vBDqIagPd9B3tvRq48LoVaHd1+e/RYY1vIDgP7efI2/QE8+1jHVcLoUan04rZvTX9N/oIfV6xQzO6s90YdyCGCr7hJ+A8ZRVIOvhpvyGdyruqDHIDYwmwRYj9I5FTPC50zYTFiEQ05Ibm5zp5Beobyqe97x0QC2JLdZjZZVB2kBaCD5su7B5BaNW7aLSrmlhDjeKPbgWZQtXAQinIITzUgOL+gxgy81yd7AqbUrJi9bhzdWKuD/rbTQodLytvyPLFcUdHS788TBjwAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 11 00 51 44" title="" data-src="/static/2023-10-11-00-51-44-9c94feacdf4c997886f7d72a6f802d61-76b75.png" data-srcset="/static/2023-10-11-00-51-44-9c94feacdf4c997886f7d72a6f802d61-83eb3.png 200w,\n/static/2023-10-11-00-51-44-9c94feacdf4c997886f7d72a6f802d61-7600b.png 400w,\n/static/2023-10-11-00-51-44-9c94feacdf4c997886f7d72a6f802d61-76b75.png 699w" data-sizes="(max-width: 699px) 100vw, 699px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h3 id="总结-59"><a href="#%E6%80%BB%E7%BB%93-59" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>把系统调用（包括阻塞式的 I/O 以及启动线程等操作）放在协程里面执行，会降低程序的响应能力，增加延迟感。</li>\n<li>调用 asyncio.run 时，可以把 debug 参数设为 True，这样能够知道哪些协程降低了事件循环的反应速度。</li>\n</ol>\n<h2 id="第-64-条：考虑用-concurrentfutures-实现真正的并行计算"><a href="#%E7%AC%AC-64-%E6%9D%A1%EF%BC%9A%E8%80%83%E8%99%91%E7%94%A8-concurrentfutures-%E5%AE%9E%E7%8E%B0%E7%9C%9F%E6%AD%A3%E7%9A%84%E5%B9%B6%E8%A1%8C%E8%AE%A1%E7%AE%97" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 64 条：考虑用 concurrent.futures 实现真正的并行计算</h2>\n<p>有些 Python 程序写到一定阶段，性能就再也上不去了。即便优化了代码（参见第 70 条），程序的执行速度可能还是达不到要求。考虑到现在的计算机所装配的 CPU 核心数量越来越多，所以我们很自然地就想到用并行方式来解决这个问题。那么接下来就必须思考，如何将代码所要执行的计算任务划分成多个独立的部分并在各自的核心上面平行地运行。</p>\n<p>Python 的全局解释器锁（global interpreter lock，GIL）导致我们没办法用线程来实现真正的并行（参见第 53 条），所以先把这种方案排除掉。另一种常见的方案，是把那些对性能要求比较高的（performance-critical）代码用 C 语言重写成扩展模块。C 语言比 Python 更接近底层硬件，因此运行速度要比 Python 快，这样的话，有些任务可能根本就不需要做并行，而是单单用 C 语言重写一遍就好。另外，C 扩展还可以启动原生线程（native thread），这种线程不受 Python 解释器制约，也不必考虑 GIL 的问题，它们能够平行地运行，从而发挥出多核 CPU 的优势。Python 里面针对 C 扩展而设计的那些 API，有详细的文档可以参考，所以这是个很好的备选方案。大家在开发扩展模块的时候，还可以借助 SWIG（<a href="https://github.com/swig/swig%EF%BC%89%E4%B8%8ECLIF%EF%BC%88https://github.com/google/clif%EF%BC%89%E7%AD%89%E5%B7%A5%E5%85%B7%E3%80%82" target="_blank" rel="nofollow noreferrer noopener">https://github.com/swig/swig）与CLIF（https://github.com/google/clif）等工具。</a></p>\n<p>然而，用 C 语言重写 Python 代码，代价是比较高的。因为有些代码在 Python 之中很简洁，但是改写成 C 代码之后，就变得特别难懂、特别复杂了。在移植过程中，我们还必须做大量的测试，以确保移植过去的那些代码跟原来的 Python 代码效果相同，并且不会引入 bug。有的时候，这些工作确实很有意义，所以 Python 行业里面出现了大量的 C 扩展模块，用来迅速执行各种任务，例如文本解析、图像合成、矩阵运算等。另外还有 Cython（<a href="https://cython.org/%EF%BC%89%E4%B8%8ENumba%EF%BC%88https://numba.pydata.org/%EF%BC%89%E8%BF%99%E6%A0%B7%E7%9A%84%E5%BC%80%E6%BA%90%E5%B7%A5%E5%85%B7%E5%B8%AE%E6%88%91%E4%BB%AC%E9%A1%BA%E5%88%A9%E5%9C%B0%E5%90%91C%E8%AF%AD%E8%A8%80%E7%A7%BB%E6%A4%8D%E3%80%82" target="_blank" rel="nofollow noreferrer noopener">https://cython.org/）与Numba（https://numba.pydata.org/）这样的开源工具帮我们顺利地向C语言移植。</a></p>\n<p>问题是，在大多数情况下，我们不能只把整个程序里的一小段代码移植到 C 语言，因为程序的性能之所以缓慢，通常是由多个因素造成的，而不是说只要消除了其中某一个主要因素，整个程序的性能就会大幅提升。要想把 C 语言在底层硬件与线程方面的优势发挥出来，必须把程序里的许多代码都迁移过去，这会让测试量激增，而且容易引入新的 bug。所以，还是得想想有没有什么好办法，能够在 Python 语言自身的范围内，解决这种复杂的并行计算问题。</p>\n<p>Python 内置的 multiprocessing 模块提供了多进程机制，这种机制很容易通过内置的 concurrent.futures 模块来使用，这可能就是我们要找的理想方案（相关范例参见第 59 条）。这种方案可以启动许多条子进程（child process），这些进程是独立于主解释器的，它们有各自的解释器与相应的全局解释器锁，因此这些子进程可以平行地运行在 CPU 的各个核心上面。每条子进程都能够充分利用它所在的这个核心来执行运算。这些子进程都有指向主进程的链接，用来接收所要执行的计算任务并返回结果。</p>\n<p>例如，现在要用 Python 来执行某种计算量很大的工作，而且想把 CPU 里的各个核心充分利用起来。笔者写了下面这个计算最大公约数的函数，来模拟刚才讲的那种工作。在实际程序中，我们要写的可能是一种运算量更大的算法（例如用纳维-斯托克斯方程（Navier-Stokes equation）研究流体动力学）。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-11-00-54-10-624ed58bd4de6aa0403bb1c85b035122-69f72.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 464px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 49.35344827586207%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAAsSAAALEgHS3X78AAABfElEQVQoz32SyZKCQBBE+f8/mjnMoiiICMMmLiBNg83SDdKACy4RUy4xhzkQURci8mVmVSNMwkxGqUqK7wUS15EcJtOYyjidt1envvSPIK7ujLgO3zT7a+6PVuFwGU4xddurzTunPveMICOiUy4HZLhG364vbQgUAdjh3SO8F3b3N3d/vbfFVCc7k7afjjdwA7s4GMXeqk59sM1P0FDGyYe5tIujti20iA0WoZ5wyScKzhftzam75wr/FgG4A3gSJpIfG2mtp5VGSjVm4jIYr5Hsxe/63CzaKc5dfobrKhGcA+wu8+YiPD0g3+GnWcy0mKqYqYSBC8yMlBOUSh6+G22IEmbTiBl5o6dcwdkLBhtY3qk6t+qMrJY2WyXKIR9EZnk0aGMVB6s8ggCUcIj7Jzu8YIu1errTssoo9xA4WGweW3DoqSaltTv+5FyDIkmpxNRgjdP+1W4uapSPlkhBCYjUmCpBCm3dBm6Ry/4WusD7j73o8RcgLdkBCeAvBhsUVVY2ZsgAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 11 00 54 10" title="" data-src="/static/2023-10-11-00-54-10-624ed58bd4de6aa0403bb1c85b035122-69f72.png" data-srcset="/static/2023-10-11-00-54-10-624ed58bd4de6aa0403bb1c85b035122-c0897.png 200w,\n/static/2023-10-11-00-54-10-624ed58bd4de6aa0403bb1c85b035122-d12a6.png 400w,\n/static/2023-10-11-00-54-10-624ed58bd4de6aa0403bb1c85b035122-69f72.png 464w" data-sizes="(max-width: 464px) 100vw, 464px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>如果把有待求解最大公约数的那些元组按照先后顺序交给这个函数去执行，那么程序花费的总时间就会随着元组的数量呈正比例上升，因为我们根本就没有做平行计算。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-11-00-54-36-a3691d063773c9073d92e77ddd3def19-50e58.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 593px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 107.5885328836425%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAWCAIAAABPIytRAAAACXBIWXMAAA7DAAAOwwHHb6hkAAADAklEQVQ4y41UaXOiQBDl//+i/bIbURRUIoJcciMKDqLcijHHvsFsKrVVm2xVM9XUTHe/ea97GHGbzTdECBLe203DRIwOQkj0+qZVT98aM/X2nOnPQsKtQ9b0B7o7ssLV6az9Rzwj7o68t5VJNQ3JwHRX+WVVdGp5/XTo+vEL5/MWg2o/ROWXZi2SXCK1Xt30+u8KOtaPmPqmVletP8Mo+Vk5NiPLG5oeq9uLOJ9H6cj0xnb4GCNdNTQ8/IIXJW1Yw5n4kRDEC1KCFwYfkPDBjrOCgW4vSSUiWHcHqo0s0r5gdWeoO7y7XZJyZLg4M7ZCKclpML1J0fHOhlv7EyvA5echGeKQas4jQgN0Z2IHEzeS0nq49ljDGzuBRIo+GJWLbuJuABvwpKSgsG2fNd15dADsB9VGDO/vpH2Ju3BOwFk+ENFg0KuW3TSIeSfCieWheYyP1He24i6TD83EiQR3Owv3MqlnQSK4OzHcS6REVUZOa71+Nppno33BSomlhN8o7RWV2qhvsHvb6H98/S6VnDVy2ihZK6WVnLU64mHY7td3bStq1O81p1L3yjFoSeB80JyB6iyTUj42C1Iss1pKS6y0VPMCUPekRp/RPL8aLeyFwT9ycDYIC6Q4l9MKzsTfjQwfFIrxEddD/2MFScgLh/diPoixRaXSyifW8BEv+Mlsc1Agz9qHmOI2hf4YGJA8j7IJaItStDPIH9kB4mmTgPCfijn1E+XQsoYrOOCWQE+UAmarezMvr+b5bd29rS8ULWBTA2ytDx47EdDi/rwHx0efDTSbt0NoMduky7RCwWlEoPwqa+8sgjMGNMBTjq1yOi+zSjm1j0kuHyhhclaj7Rf7AorghvM4W+zz1emiVe/TymCY1LwDE2Nvt6JDctbyDsrNIgJusKUW17tyRk/45zmnHYajnBU+rGwxPtF5zi+ofK8POAj+52Ng9LCFDcGtUEfvlfuQ9Ov3iMHrtSQF2EMK1AQNKKXAqa7fP0OQa2SHi7Tk/e1sS7Binjg7vPf21/Ybn82TfgzY0IcAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 11 00 54 36" title="" data-src="/static/2023-10-11-00-54-36-a3691d063773c9073d92e77ddd3def19-50e58.png" data-srcset="/static/2023-10-11-00-54-36-a3691d063773c9073d92e77ddd3def19-d1b16.png 200w,\n/static/2023-10-11-00-54-36-a3691d063773c9073d92e77ddd3def19-aef18.png 400w,\n/static/2023-10-11-00-54-36-a3691d063773c9073d92e77ddd3def19-50e58.png 593w" data-sizes="(max-width: 593px) 100vw, 593px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>直接把这种代码分给多条 Python 线程去执行，是不会让程序提速的，因为它们全都受制于同一个 Python 全局解释器锁（GIL），无法真正平行地运行在各自的 CPU 核心上面。现在就来演示这一点。笔者使用 concurrent.futures 模块里面的 ThreadPoolExecutor 类，并允许它最多可以启用两条工作线程（因为笔者的电脑里 CPU 是双核的）。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-11-00-55-06-2401e24b02718536c3dba948aef8f36c-b03fa.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 650px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 87.38461538461539%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAIAAABSJhvpAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACNUlEQVQ4y41TiZKaQBDl/79pjfG+AB11AEUR5UbkGnA9cJMHuNlNqlK7VV1dXT3TPf36veEGG3OkWUPN7m2M5kJtUpU3g5mfzgI2D3IE8IIXi27MW6HgRIIbT3F6ZJTduJ56QBl8Y7EaaBaOeSvoa9bEOgp2ONjZ5MjGht9Vjd7WHO/d3tZCcmIGErtzOJv6ySK6iF4yD89yVkhZIecPeBzLeUFL/1DytzoJXwc0vXEtZduU1gPdXoRnEmRI0eS6TK60tvT6J1MnPzyKScBQMw+yZXypbt++b9w8zJXzm8QwZDlJ1fL9nS+LARjbm3qJ6MV4uQYDtFLd6BOEzwM/i7HS4d59IfJg54AY3jiKbjQ6uLwdlstjVaPKaB2k9+ciUKy8/hKdqCVrxGfjvf9jvmoQpUnXP+l6tHfQF7Sh11C3EYwNj7dONbpleuXQbOrGbUWDTiADxIOt2ZI0MD/UrLa0bSt6g6xadNNd6x1VBy8vM7lJN5ODz2E2NIO25j7rqoe+ZkIDndWOeEzOHhiyHBX0lruoMOPZ6LKMy5gD4yjuKDt0goBa8pZ4KYr7GxOawRagItGOpk60DF9pCfhW4695zhanM4Q53nu4JJgnwTp1VzpvHokbi3YIIhBDs+SU/0vVLMgEKwSqrrqn6B1dyowdkmOG8WRWvEuyqF/7q1hmd3wgkEzCXMqLSsZP6X7YfzTDgST8JHwxIBeceATkhv9dhfF2MPMS7BZQEQAbb5/kar1f2m9kb46pk9/KPgAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 11 00 55 06" title="" data-src="/static/2023-10-11-00-55-06-2401e24b02718536c3dba948aef8f36c-b03fa.png" data-srcset="/static/2023-10-11-00-55-06-2401e24b02718536c3dba948aef8f36c-6fb5f.png 200w,\n/static/2023-10-11-00-55-06-2401e24b02718536c3dba948aef8f36c-d11a1.png 400w,\n/static/2023-10-11-00-55-06-2401e24b02718536c3dba948aef8f36c-b03fa.png 650w" data-sizes="(max-width: 650px) 100vw, 650px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>由于要启动线程池并和它通信，这种写法比单线程版本还慢。</p>\n<p>但是请注意，只需要变动一行代码就能让程序出现奇效，也就是把 ThreadPoolExecutor 改成 concurrent.futures 模块里的 ProcessPoolExecutor。这样一改，程序立刻就快了起来。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-11-00-55-52-a2cabd2c72ad47ad11ad88cc8e06311a-b4e45.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 74.3142144638404%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAIAAABr+ngCAAAACXBIWXMAAAsSAAALEgHS3X78AAAB1UlEQVQoz41SiW6qQBTl//+paYtaWdwAEVQKyCb74oCtFfveGeizNnkxTU4mc+/M3c65zMTPeDvk7P3Y9IFZVOnNZUXOq7pVyVmrW1y05qLVQAuoh48rmLHlvxjuYGM/qdtH1eB3kein86ic0LMSvATgnEhwY1wmQaZWN8FTPwN4Nxlb+2X5LmXNIiFK0UhpreRHmPOEAHDO4wOcPyqLXjIyPCkhctbApg2TtjvPqy+TjnDFj+DpvuCdWIoPy+L99uE3YJTiTT9+dhW+XMvbH9Xd4HlYCl7Ku9EiJho5086rj++G/0HtntSrp6azMHBxu5DVzVlQsGt7uHVZzeSdqGPuIGU10FMFOpX8TerIw9MsLBloKLjJcLMT3URw4tHWgWA4B2vrWTMflTXysprFmQGrvbK6JdhhHyl6KQP1OTt8MTwYvLXnrGC4dVABXMh5I+WNXFDB4EH9RUpQ/8o8s6ovEy8ZG47oxM+6CeUGuiXu4nlczSKkT6ZhqVanq2Ydi6cejFLSIv14kFpKCdZLxqhpLWNJUupc4ut/2UYMVu9BXk+DnGaJCfpHCpq75/mOVGp5QgVsIgz9+IdqXrf3Y76DMefI9AZbZ/TqsmuL3dig5Jcb9heJwibPZ9QGXwAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 11 00 55 52" title="" data-src="/static/2023-10-11-00-55-52-a2cabd2c72ad47ad11ad88cc8e06311a-fee1c.png" data-srcset="/static/2023-10-11-00-55-52-a2cabd2c72ad47ad11ad88cc8e06311a-a67b7.png 200w,\n/static/2023-10-11-00-55-52-a2cabd2c72ad47ad11ad88cc8e06311a-0b187.png 400w,\n/static/2023-10-11-00-55-52-a2cabd2c72ad47ad11ad88cc8e06311a-fee1c.png 800w,\n/static/2023-10-11-00-55-52-a2cabd2c72ad47ad11ad88cc8e06311a-b4e45.png 802w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>在笔者的双核电脑上，程序变得比原来快多了。这是为什么呢？因为 ProcessPool-Executor 类会执行下面这一系列的步骤（当然，这实际上是由 multiprocessing 模块里的底层机制所推动的）。</p>\n<ol>\n<li>从包含输入数据的 NUMBERS 列表里把每个元素取出来，以便交给 map。</li>\n<li>用 pickle 模块对每个元素做序列化处理，把它转成二进制形式（参见第 68 条）。</li>\n<li>将序列化之后的数据，从主解释器所在的进程经由本地 socket 复制到子解释器所在的进程。</li>\n<li>在子进程里面，用 pickle 模块对数据做反序列化处理，把它还原成 Python 对象。</li>\n<li>引入包含 gcd 函数的那个 Python 模块。</li>\n<li>把刚才还原出来的那个对象交给 gcd 函数去处理，此时，其他子进程也可以把它们各自的那份数据交给它们各自的 gcd 函数执行。</li>\n<li>对执行结果做序列化处理，把它转化成二进制形式。</li>\n<li>将二进制数据通过 socket 复制到上级进程。</li>\n<li>在上级进程里面对二进制数据做反序列化处理，把它还原成 Python 对象。</li>\n<li>把每条子进程所给出的结果都还原好，最后合并到一个 list 里面返回。</li>\n</ol>\n<p>从开发者这边来看，这个过程似乎很简单，但实际上，multiprocessing 模块与 Proce-ssPoolExecutor 类要做大量的工作才能实现出这样的并行效果。同样的效果，假如改用其他语言来做，那基本上只需要用一把锁或一项原子操作（参见第 54 条）就能很好地协调多个线程，从而实现并行。但这在 Python 里面不行，所以我们才考虑通过 ProcessPoolExecutor 来实现。然而这样做的开销很大，因为它必须在上级进程与子进程之间做全套的序列化与反序列化处理。</p>\n<p>这个方案对那种孤立的而且数据利用度较高的任务来说，比较合适。所谓孤立（isolated），这里指每一部分任务都不需要跟程序里的其他部分共用状态信息。所谓数据利用度较高（high-leverage），这里指任务所使用的原始材料以及最终所给出的结果数据量都很小，因此上级进程与子进程之间只需要互传很少的信息就行，然而在把原始材料加工成最终产品的过程中，却需要做大量运算。刚才那个求最大公约数的任务就属于这样的例子，当然还有很多涉及其他数学算法的任务，也是如此。</p>\n<p>如果你面对的计算任务不具备刚才那两项特征，那么使用 ProcessPoolExecutor 所引发的开销可能就会盖过因为并行而带来的好处。在这种情况下，我们可以考虑直接使用 multiprocessing 所提供的一些其他高级功能，例如共享内存（shared memory）、跨进程的锁（cross-process lock）、队列（queue）以及代理（proxy）等。但是，这些功能都相当复杂，即便两个 Python 线程之间所要共享的进程只有一条，也是要花很大工夫才能在内存空间里面将这些工具安排到位。假如需要共享的进程有很多条，而且还涉及 socket，那么这种代码理解起来会更加困难。</p>\n<p>总之，不要刚一上来，就立刻使用跟 multiprocessing 这个内置模块有关的机制，而是可以先试着用 ThreadPoolExecutor 来运行这种孤立且数据利用度较高的任务。把这套方案实现出来之后，再考虑向 ProcessPoolExecutor 方案迁移。如果 ProcessPoolExecutor 方案也无法满足要求，而且其他办法也全都试遍了，那么最后可以考虑直接使用 multiprocessing 模块里的高级功能来编写代码。</p>\n<h3 id="总结-60"><a href="#%E6%80%BB%E7%BB%93-60" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>把需要耗费大量 CPU 资源的计算任务改用 C 扩展模块来写，或许能够有效提高程序的运行速度，同时又让程序里的其他代码依然能够利用 Python 语言自身的特性。但是，这样做的开销比较大，而且容易引入 bug。</li>\n<li>Python 自带的 multiprocessing 模块提供了许多强大的工具，让我们只需要耗费很少的精力，就可以把某些类型的任务平行地放在多个 CPU 核心上面处理。</li>\n<li>要想发挥出 multiprocessing 模块的优势，最好是通过 concurrent.futures 模块及其 ProcessPoolExecutor 类来编写代码，因为这样做比较简单。</li>\n<li>只有在其他方案全都无效的情况下，才可以考虑直接使用 multiprocessing 里面的高级功能（那些功能用起来相当复杂）。</li>\n</ol>\n<h1 id="稳定与性能"><a href="#%E7%A8%B3%E5%AE%9A%E4%B8%8E%E6%80%A7%E8%83%BD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>稳定与性能</h1>\n<p>写了一个有用的 Python 程序之后，接下来就该考虑怎样让代码变得健壮（robust）起来，只有这样，才能将这个程序变为正式的产品（productionize）。把程序的功能写对，当然是很重要的，然而我们还得考虑怎样让程序在面对意外情况时，依然能够可靠地运作。Python 有很多内置的特性与模块，可以帮我们加固程序代码，让它应付各种各样的状况。</p>\n<p>说到健壮，其中一项指标在于能不能高效地应对大规模的数据。我们经常发现自己写的 Python 程序在处理少量数据时没有问题，但数据量一多，速度就下降，这可能是因为自己的算法过于复杂，或者计算的时候还有其他一些开销。不过没关系，Python 提供了很多算法和数据结构，可以让我们轻松地写出高性能的程序。</p>\n<h2 id="第-65-条：合理利用-tryexceptelsefinally-结构中的每个代码块"><a href="#%E7%AC%AC-65-%E6%9D%A1%EF%BC%9A%E5%90%88%E7%90%86%E5%88%A9%E7%94%A8-tryexceptelsefinally-%E7%BB%93%E6%9E%84%E4%B8%AD%E7%9A%84%E6%AF%8F%E4%B8%AA%E4%BB%A3%E7%A0%81%E5%9D%97" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 65 条：合理利用 try/except/else/finally 结构中的每个代码块</h2>\n<p>在 Python 代码中处理异常，需要考虑四个情况，这正好对应 try/except/else/finally 这个结构中的四个代码块。这种复合语句的每块代码都有各自的用途，你可以全写，也可以只写其中几个，总之，各种组合方式都很有用（参见第 87 条）。</p>\n<h3 id="tryfinally-形式"><a href="#tryfinally-%E5%BD%A2%E5%BC%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>try/finally 形式</h3>\n<p>如果我们想确保，无论某段代码有没有出现异常，与它配套的清理代码都必须得到执行，同时还想在出现异常的时候，把这个异常向上传播，那么可以将这两段代码分别放在 try/finally 结构的两个代码块里面。最常见的例子是确保文件句柄能够关闭（另一种可能更好的方法参见第 66 条）。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-12-10-59-32-3bc3421e413e1f61fd0f26014a72fd5d-fee7b.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 547px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 33.27239488117002%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsSAAALEgHS3X78AAABWElEQVQoz01RaW+CUBDk//+mJlVbBVE51B62KgXxQEQQr1o109k1Nv2wmX17zs4z7MkS9dEET58Rqh8BasMQD70BqoMxYyHfEo/gLEv0txf0yh/0tuc/7It/t/IMw00KmMEMXrpDZ76GOY713Z6u0IpT+Os9usURTlrCXe3gZTsd7mV7jaktxTbwWGuYX3NU3kZa7KZbtDjIZUGTzM0wgZOUqHNBg3U2F3QWOa241c7WGheUnM1eo7s5wc8O6MwyDbbJsj6KdaAVLtAI59rs59/Q2oJI89cHxV5xumF5VkkMPz9ySI4GdZQTG2RTo3b2JEXlfQyL6JHxM/NWlHBRAjNaqObCvB5M0WSfwwtFV0M0aLJQPselDsLWZ/J+ljAWv0uGL7sr7XLD/RV9+v9NB4rjrLaqY20Q6Ic8vg71VE8Gc0lTGYWql1xjCUvmhVmbmtrxSvscEvgFE2L7+UUMJ2EAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 12 10 59 32" title="" data-src="/static/2023-10-12-10-59-32-3bc3421e413e1f61fd0f26014a72fd5d-fee7b.png" data-srcset="/static/2023-10-12-10-59-32-3bc3421e413e1f61fd0f26014a72fd5d-9b56f.png 200w,\n/static/2023-10-12-10-59-32-3bc3421e413e1f61fd0f26014a72fd5d-18701.png 400w,\n/static/2023-10-12-10-59-32-3bc3421e413e1f61fd0f26014a72fd5d-fee7b.png 547w" data-sizes="(max-width: 547px) 100vw, 547px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>如果 read 方法抛出异常，那么这个异常肯定会向上传播给调用 try<em>finally</em>example 函数的那段代码，然而在传播之前，系统会记得运行 finally 块中的代码，使文件句柄（handle）能够关闭（close）。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-12-11-00-07-d2503cb8c7f0ca6742d949e01a8bdf08-ab2ac.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 531px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 50.65913370998116%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAAsSAAALEgHS3X78AAABdklEQVQoz3VSh26DUAzk//+oUqtsCCuDkGZQZnjvMQOEjGZJPSBK1UqRLOsQtu98fpxEk5656Zv+LD8rLOMdKrhUIrFE0kl60MvrbHd5FZwaZKNoN4p3IklEEgsOm6YHJcgmSamG+Tg91HVnvbxUg5r8bNbybxmEFhl8eYLLBqYvuoHosaEXDF0mbaJRNWivsi0+ZZJIfqzQZJqdMIgbxztQVb/DQgkzNSpGUQE5Ct2qLGsASrX8PNkewVTjb62omXmTNPKwsERTmaTYlrfp0A3RLG6igUWm+Qlqa9nXP7IxGBUgrDjjcn64z/f3JlcN+xvwS8PA86ZqLX3d/jRbc0PLIOncxOwJHtX/ASf6cWdl99YOfOIdBs8bhY/Y335BpeVWgyqwAsdb/oe+etcWgk0FJ5DZdpIem/3HSYmNcEhcDr4MvRBuo0DGpn48jgquvbTA3F3a3ZU9sGh35cChvuF1DRe4pRvAnYWFW+CiyPU58C5KPKEfL5cTIgVWIo0AAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 12 11 00 07" title="" data-src="/static/2023-10-12-11-00-07-d2503cb8c7f0ca6742d949e01a8bdf08-ab2ac.png" data-srcset="/static/2023-10-12-11-00-07-d2503cb8c7f0ca6742d949e01a8bdf08-a8ddc.png 200w,\n/static/2023-10-12-11-00-07-d2503cb8c7f0ca6742d949e01a8bdf08-0d4eb.png 400w,\n/static/2023-10-12-11-00-07-d2503cb8c7f0ca6742d949e01a8bdf08-ab2ac.png 531w" data-sizes="(max-width: 531px) 100vw, 531px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>但是要注意，开启（open）文件所用的那行代码必须写在 try 块之前，而不能跟 read 写在同一个 try 块里面，因为那行代码也有可能出错（例如，会因为文件不存在而发生 OSError 错误）。假如把它跟 read 写在同一个 try 块里面，那万一出错，handle 变量就根本来不及得到赋值，从而导致系统在执行 finally 块时，会因为对无效的文件句柄调用 close()方法而再度出错。把它写在 try 块之前，系统在开启文件出错时，会直接向上抛出异常，而不进入接下来的 try/finally 结构。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-12-11-00-26-7654437560db2241e6e829419f8bfe05-0208c.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 493px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 26.774847870182555%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAIAAADKYVtkAAAACXBIWXMAAAsSAAALEgHS3X78AAAA30lEQVQY022Q226DMAyG8/6vtFVbRSdOhXLIVDQadSGcQoAQ0m0UejGjStsuJn2y7N+2fEB2LmwmdoRZtDJpvU3OxolajJvn0mWQ4sC+7N1ceLWMhyse5x+Qk7fxMGE9R2oK+89omCJ1/Zd4BOa/IIvypyMxTpmTC5gQyglfblgvq72jb6+/yrI6+q4vaJdmD2HyGCc2raE5aHQov7xGHYT2G2AM2ovPFTh+o4LuY9Uh5Ap09EKKDX4z0vfnI9nCCimFXQzCnKJ1K+mUnVt2Zsaher286L1KWhmH7+yr/htfrgjvPtTMmQAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 12 11 00 26" title="" data-src="/static/2023-10-12-11-00-26-7654437560db2241e6e829419f8bfe05-0208c.png" data-srcset="/static/2023-10-12-11-00-26-7654437560db2241e6e829419f8bfe05-1777c.png 200w,\n/static/2023-10-12-11-00-26-7654437560db2241e6e829419f8bfe05-1db89.png 400w,\n/static/2023-10-12-11-00-26-7654437560db2241e6e829419f8bfe05-0208c.png 493w" data-sizes="(max-width: 493px) 100vw, 493px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h3 id="tryexceptelse-形式"><a href="#tryexceptelse-%E5%BD%A2%E5%BC%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>try/except/else 形式</h3>\n<p>如果你想在某段代码发生特定类型的异常时，把这种异常向上传播，同时又要在代码没有发生异常的情况下，执行另一段代码，那么可以使用 try/except/else 结构表达这个意思。如果 try 块代码没有发生异常，那么 else 块就会运行。try 里面应该尽量少写一些代码，这样阅读起来比较清晰，而且即便出现异常，我们也能很快找到它是由哪一行代码引发的。例如，我们实现这样一个 load<em>json</em>key 函数，让它把 data 参数所表示的字符串加载成 JSON 字典，然后把 key 参数所对应的键值返回给调用方。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-12-11-01-02-f158ea4c91488528df7a54d5b8bb409c-c347e.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 555px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 43.6036036036036%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsSAAALEgHS3X78AAABeElEQVQoz41SyW7CUBDL/39Uq1IUsgcIHNhKSCALWYAEqrJUrueh9tIDHKw3mWj8bM/TnKSEvSlhbQqMjzeM2yvPK0bNRdVBc0Zw+CLOT0Fz8gOspLojrWGuCxhxAa9oYW4q9OsTSS8YHgTnh9DMKIe+2MDJdrCTGjZJDZK620bVftkiaC+KNGiomKpH7f/zt9akGJRHmFEGK96StILBWg8T9JYJ3qcrvE2W6M4j+EWDfnWCx8v6nPH4LU5culQ9/tOkYVBldxahM13idTyHtS5VT/+gcnVBjt4qg5vt1bDN/16+h8NIHLoQIRb34G4P0Pr1532IirqLmPbXJJ2RPIRBhTphCBkHRdWIixMoq1K3t7+euNV8ynTTHVySSoa9Vaps6yEjkCypyqQCIXtqKZKDPBuPgw7hMwKxJFZcLkqUebQ5kKfTPNg0n5g2On7z9pPKy4pLhh+rRXQk00mIF2YqucmGh/sLs6pVBOLmni2zDlOVYcCn9QMU6JHSQNDiUgAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 12 11 01 02" title="" data-src="/static/2023-10-12-11-01-02-f158ea4c91488528df7a54d5b8bb409c-c347e.png" data-srcset="/static/2023-10-12-11-01-02-f158ea4c91488528df7a54d5b8bb409c-58c7f.png 200w,\n/static/2023-10-12-11-01-02-f158ea4c91488528df7a54d5b8bb409c-5d49f.png 400w,\n/static/2023-10-12-11-01-02-f158ea4c91488528df7a54d5b8bb409c-c347e.png 555w" data-sizes="(max-width: 555px) 100vw, 555px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>如果 try 块能够顺利执行，那么 data 参数中的数据就会解析成一份 JSON 字典，然后程序进入 else 块，并根据 key 参数从字典中查出相应的键值。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-12-11-01-48-a7bf5b814a51aa8990223d9f59587a56-cf31b.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 480px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 18.958333333333332%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAIAAAABPYjBAAAACXBIWXMAAAsSAAALEgHS3X78AAAAnElEQVQI133NbQuCMBSG4f3/31Rg5aaFWZ0Z+JJOnM5UFJ0kmQSJYfSl4P5wweHhII0JM2tWbqT6fONxwoRiM0OUW55hlkLVkVDs4sIs5KnqsM+NtDrk7f5a4yBBx7I7354ge6jvVPZUPqDpaTOjHWDyu9EwYr4i9cLXXqRHOWEJ8WM1iHVeWO3wGfxuQAuwpxzFYUvL1cL0+9X/Xt1N1Q2ZBp/fAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 12 11 01 48" title="" data-src="/static/2023-10-12-11-01-48-a7bf5b814a51aa8990223d9f59587a56-cf31b.png" data-srcset="/static/2023-10-12-11-01-48-a7bf5b814a51aa8990223d9f59587a56-ad6a6.png 200w,\n/static/2023-10-12-11-01-48-a7bf5b814a51aa8990223d9f59587a56-552c4.png 400w,\n/static/2023-10-12-11-01-48-a7bf5b814a51aa8990223d9f59587a56-cf31b.png 480w" data-sizes="(max-width: 480px) 100vw, 480px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>如果 data 不是有效的 JSON 数据，那么 json.loads 会抛出 ValueError。这个异常会由 except 块捕获并处理。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-12-11-02-00-f317b895953af5eec50da57052f601c9-45fc4.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 522px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 47.89272030651341%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAABb0lEQVQoz4VS2XKCQBDc//+hPOTUGEQ5FCVVankQ8EABDzQxiVZ1eteAJFWJD10zTA+zO90rtMEYTxLDCaqjKYxpgqo3gzVbwpjE0F9C6P4cGjkrXMNepOSnaMRbuOkB7c0H8ZlDNJOdKjrrPZzkDe72oNBOP1l7h7Pa52ixT4H1PJdIz7l47Pt46IygeyHjEKWuh1LPQ0MexKGyScYsz75/DCxA3Lpd3LS6p5W5nlxfridXc3fH7xsf81uf41Hx7SJPiCvTwXWrg3LPV5o14x3M2Qq1YIE6vw2Zq7iEtdhQ4yXsOFU1CZO6Kp512SOyxjqjGa6U2AZjbRzBmq/zRpN5M3lVnJRD1uo00I5S1k68HW0hKlzx7rmfr1umpnJYlc7qQQSN9Qy1SUQ+4O3nHBarnipzja5XBoE6QMgnoPunp6Gc/Efw3JRiXuyn+0KeovHd2Vz1koMXwX/pcg/3nYHSQLlLTfKhaQG/390f3Bdlo9smqDaYNAAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 12 11 02 00" title="" data-src="/static/2023-10-12-11-02-00-f317b895953af5eec50da57052f601c9-45fc4.png" data-srcset="/static/2023-10-12-11-02-00-f317b895953af5eec50da57052f601c9-31b3a.png 200w,\n/static/2023-10-12-11-02-00-f317b895953af5eec50da57052f601c9-60bb2.png 400w,\n/static/2023-10-12-11-02-00-f317b895953af5eec50da57052f601c9-45fc4.png 522w" data-sizes="(max-width: 522px) 100vw, 522px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>程序在 else 块里面查询键值的时候，如果出现异常，那么这种异常会直接向上传播。else 块的好处是可以用来强调它里面的这段代码只会在 try 块不出错的时候执行，另外，即便这段代码抛出异常，也会直接向上传播，而不会为 except 块所处理，这使得传播异常的路径更加清晰。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-12-11-02-43-8234426f68a6e6436c970de1d46f8ad4-124ef.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 440px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 26.81818181818182%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsSAAALEgHS3X78AAAAyklEQVQY04WQ1w6CQBBF+f9vskRipAmW1SAaBQsgLTRNLA/XYdUEW3w4md2d7N2zI2i7GKqbQI8KDOIDx6jWyRFGXGKcn8GKy2vN77UOe/SFYXRAZ2ajwSyIloMO0WQztM0leraHUXb6uPwMf1I/Fwwv5Zdb0zlECla2ITQy1vwU5gmYlFfOu+UvBHFeGVkcae1D8xLImwD6PoNajYP2qhvDCIu/YTxQdnxIKxd9shrS/Cq77sIh0wAK9ZRNCHVNDwQ5GJnWv/st8AZcdG39ZjF8CgAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 12 11 02 43" title="" data-src="/static/2023-10-12-11-02-43-8234426f68a6e6436c970de1d46f8ad4-124ef.png" data-srcset="/static/2023-10-12-11-02-43-8234426f68a6e6436c970de1d46f8ad4-add0a.png 200w,\n/static/2023-10-12-11-02-43-8234426f68a6e6436c970de1d46f8ad4-7a35e.png 400w,\n/static/2023-10-12-11-02-43-8234426f68a6e6436c970de1d46f8ad4-124ef.png 440w" data-sizes="(max-width: 440px) 100vw, 440px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h3 id="完整的-tryexceptelsefinally-形式"><a href="#%E5%AE%8C%E6%95%B4%E7%9A%84-tryexceptelsefinally-%E5%BD%A2%E5%BC%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>完整的 try/except/else/finally 形式</h3>\n<p>如果这四个代码块的功能全都要用到，那么可以编写完整的 try/except/else/finally 结构。例如，我们要把待处理的数据从文件里读出来，然后加以处理，最后把结果写回文件之中。在实现这个功能时，可以把读取文件并处理数据的那段代码写在 try 块里面，并用 except 块来捕获 try 块有可能抛出的某些异常。如果 try 块正常结束，那就在 else 块中把处理结果写回原来的文件（这个过程中抛出的异常会直接向上传播）。最后，程序无论是进入了 except 块，还是进入了 else 块，它都会在即将返回之前，先执行 finally 块以清理文件句柄。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-12-11-03-24-1adb9ae948dba2ca50964da1442dfaf3-eca56.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 554px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 95.30685920577616%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAIAAAAf7rriAAAACXBIWXMAAAsSAAALEgHS3X78AAACq0lEQVQ4y21TaZOiMBT0//+l/TCCB6CcCuOBcooc4T50XJmq7aBz7W7VIxWSdN7rfp0Re/CYncOarpo24jlbBEQitd706/r3R9y+zX/ESIpLJa2X52wZEMGLeT8WgnRVvj229eautz0dm55O2n7d3L/AWnkV/ITZWEBO9vb41RxvrOWJLINUK9/U/CKTRs06JW1lUiO04vIFNrp3wSdT08c5hdTAcG6spq2SNhpWKJdciisxKhZBigLVvPtMPsK3Kt4U0khhpiSVHBWcc8YVvBuC0bq6rZsfPLXiuiqvGLE1wme0vRSVk50jBuns6IPC1PRQP/LwbsQ5IXZxHUoQvARX417eCaHuaFAF4AI8BTee2wGzPY43x5fXA44CPLfPYliIYSaGOe8lGEHHaN+h4gN8B6uZdQJ+4ROkmtnBzAqkMF/4NBVW5LgCW6pZ2tKahxY+wfjnvAiCi0Emx6VKGi3rVsVVb2mrjCFQoNH1+nN+f2YGkkZ+QbXs1mI2B2ZrzY/BUG2xOBFIDf7CicydCJrzSOMnWBzhAnQShQlONDEdFMzsHXZnTw8+ZwW8A8I5AsrLabOqbvCPNgQmz7KVpObsQAzIeGu/GCa7d+WkhhBK1qL5QEpJRak+OoxxmAyZ40rwYQzKkzYc3U7qNbVXh0V4S68p8/94G33GhhhXc+sEwRBQGB0C+cUpgXhyVFGrP7J9M/bTYRQclWM01oXgycT0oBaztXkvhvnQEgouruqgP/XcX5mXUfFL205MF1K9vJqAQWccxYTdO/AJdd7uONnZaP4nBZoZeBwFEgU/ilfgh7RZ1yjypmYtctKHlTXQD8b+lhlSp63gRUCqaQfNoJaaXdSPyeeTNpr+X860bCmqQJKzYfqYxQs5Z/QZhvnSJ4MfSlgCXdB/gv8AWinxfKgZnPIAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 12 11 03 24" title="" data-src="/static/2023-10-12-11-03-24-1adb9ae948dba2ca50964da1442dfaf3-eca56.png" data-srcset="/static/2023-10-12-11-03-24-1adb9ae948dba2ca50964da1442dfaf3-77254.png 200w,\n/static/2023-10-12-11-03-24-1adb9ae948dba2ca50964da1442dfaf3-789d0.png 400w,\n/static/2023-10-12-11-03-24-1adb9ae948dba2ca50964da1442dfaf3-eca56.png 554w" data-sizes="(max-width: 554px) 100vw, 554px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>如果 try 块顺利执行，那么接下来运行的就是 else 与 finally 块。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-12-11-04-18-88b055ba5de1df41e988603250efbf45-09bf7.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 452px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 58.62831858407079%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsSAAALEgHS3X78AAAB2klEQVQoz41T23KiQBTk/39oXywx3gKiIiBrQowKIhpQVDRRk+z29plcNqkylTx0HWg4PT19ZrT6bYSLYIzaMERjkqC/OaKzWKNKzggTNEYxzOkdDOIynMPdHOAVJ7jbI7zt6ROE0+zlHt1shy6rnd/DXt2r5zc46yN6+QP5vaoOF+zvnuHtnv6jeHx/1sxpCiNa4HI8Q/V6DL0foOQNUPYDvo9gzZYw6NwMF7DiDGacoptuFewljWQFFz2o2iGn+Q9/afWE9nwNM0phJTk8uhAhM7qjQKa+eZuT4m021W9jNMcJI6CRCWOgc2u2Yu8KWmexQWuWocdtCyGO2/McJjkRb4ozVoPiLYo7+QGORMHa3z/D3/9RW5YYBJoVL9Fmg8PsxEk7Wb0KpIoXFyKq3rlQj//ZaQGbBlw1iM/QJBdLfqTtj3gLXhz4dCJuFCcDKJ4UzgqKq19tFzqHUB4MUbuJ0GBGL9tgE3NTONN8VlCmVfZvlGDteoLK7yF0osXtivP+q7sfC9ocd8l9OSY6hatXY9SHEcoUrXABg/nJUVENdP2tYIdbvhiMeBSmFJqqGyKClasRdPLVIPxyAF8IbtRhlqtX8gI0mV/JGSjBHm+O3AwZznvTNy7/AW5Uax7pdDm1AAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 12 11 04 18" title="" data-src="/static/2023-10-12-11-04-18-88b055ba5de1df41e988603250efbf45-09bf7.png" data-srcset="/static/2023-10-12-11-04-18-88b055ba5de1df41e988603250efbf45-eb2f6.png 200w,\n/static/2023-10-12-11-04-18-88b055ba5de1df41e988603250efbf45-ffac0.png 400w,\n/static/2023-10-12-11-04-18-88b055ba5de1df41e988603250efbf45-09bf7.png 452w" data-sizes="(max-width: 452px) 100vw, 452px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>如果处理数据的过程中发生错误（例如，在做除法运算的时候，出现了除数为 0 的情况），那么程序会提前跳出 try 块，并进入 except 块，最后执行 finally 块。在这种情况下，else 块不会得到执行。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-12-11-04-42-277301bcd2d3f95038ec8ea5122e5165-927fb.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 439px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 51.252847380410024%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAAsSAAALEgHS3X78AAABhklEQVQoz3VRa4+iQBDk//+kzbnKrqKoDAgKKPIQkJHhPYCbW3cvV5y3X0xMOp2eTldVd40gh1Q+0XlAp8eTaB9Hu/3YOoq2t8naxYkuwsvqnK+TUq+um7LbDPmq1x8Io/4QDH7Tm9+ST6UgmYepQivJP8+8eBlli4hpebcpeoXVMzcCkRxdkLWiByMmBTXv1KzFmzCusAbT6lDUa1qRrFXShrAGOigWUbZKCjnOIWa0nwb/FFZxtj4X5NIsIyaHqRyyuZ/gCsk7T11EvAyZnnfoi/sA/bfDSauuRnu7g0s17w2Q8YEMxa77HqJH/kKx7b7QR21e/6Bp9t+49D4sKEk5Mmw4BErJi8EN/LYdjBjWu8e/0YfnANYYH1suTAZ4evAnlovjSd5BBJr/KX6mH0JQL1x0ghfdGpvDD01s73XnjExHgW0px7bb9vYUTGg1Md2x6Yh7H+IzN341j+9OgOZI38sRI3n7DC+QtMaqou2KlgeHf+k2VlAzTjK+piU+TCs64wn4L7EtEL3Pp554AAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 12 11 04 42" title="" data-src="/static/2023-10-12-11-04-42-277301bcd2d3f95038ec8ea5122e5165-927fb.png" data-srcset="/static/2023-10-12-11-04-42-277301bcd2d3f95038ec8ea5122e5165-8b407.png 200w,\n/static/2023-10-12-11-04-42-277301bcd2d3f95038ec8ea5122e5165-c4ab1.png 400w,\n/static/2023-10-12-11-04-42-277301bcd2d3f95038ec8ea5122e5165-927fb.png 439w" data-sizes="(max-width: 439px) 100vw, 439px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>如果文件里的数据不是有效的 JSON 格式，那么程序也会提前跳出 try 块，但这种 JSONDecodeError 异常并没有相应的 except 块来捕获，因此会直接向上传播给调用方，然而在传播之前，程序会先执行 finally 块里的代码。在这种情况下，except 块与 else 块都不会执行。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-12-11-05-10-57987832a1f1cb5308422c0df0ee7800-91452.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 521px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 46.83301343570057%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsSAAALEgHS3X78AAABX0lEQVQoz51S2XKCQBDk/78oDxo1KnjhAagQFQ8ERRHEM5pUOjMLxlSlzEMeunZm2G16ekaqOj4qMx+l4Qx5c4SsbuG5N0CR8tp8lUDcWaIV7NFcx+hEZ+i7C7Q4xe5+St3jJzrhGepyiwahE56g+hHqXoCau0F7c4RGtapDxFSruwHalOu7a0p4TZGQSnxRmS6FSlZRtl3I0wXKYw+NRQRj/y4eGIcPihPcyX5Dqs5W1MYeLVLSCg4ibgYJuLVHDx8S1pw1cr0hSvZcKGV1XVLD+EvJY8J5gIzWR9awkO/bYigNn/xcxf8jrLshXqwJCqYNeewKtfn+CCoRsm86ecjEDPbzZ36LuW6ksSTTEDKaSQpfwe3zINhL4Sf5yKe2fROTvXnLk29HJ/Htu75O6lLBHONJ1Wn3hsh1B2I9mn6M4siBMvGg0LT5Iv9IppjB66SSLZWpL9ZNId9F3QvxBYAxkXfwuksDAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 12 11 05 10" title="" data-src="/static/2023-10-12-11-05-10-57987832a1f1cb5308422c0df0ee7800-91452.png" data-srcset="/static/2023-10-12-11-05-10-57987832a1f1cb5308422c0df0ee7800-e8fc4.png 200w,\n/static/2023-10-12-11-05-10-57987832a1f1cb5308422c0df0ee7800-c0ace.png 400w,\n/static/2023-10-12-11-05-10-57987832a1f1cb5308422c0df0ee7800-91452.png 521w" data-sizes="(max-width: 521px) 100vw, 521px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>这种结构很实用，因为它里面的四个代码块有着清晰的分工，可以直观地表达出整段代码的意思。我们设想一下，假如运行 divide_json 函数的时候，硬盘已经满了，那么该函数在写入运算结果的那个地方就会出错。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-12-11-05-41-ba560014dcc17427820091c5409b9744-a64ad.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 450px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 58.88888888888889%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsSAAALEgHS3X78AAABvElEQVQoz5VTf2/aUAzM9/9Gm6AJhEApNFASaEj4kUAgQBgqCZ220ul2NhqaVFWif1hO/J7vne2z8bDcor3YojlbwZksUPHGsIYRqn4E63mKh3SPe57LvU660383L9Hbn9DLT+oHL7/QP/xE/8crDP/1D7ziDe0018vNeQZ3dyTIhg/RkozxnMkl+jR3c4QdJWjFGe+u1Auo5EuO8bg9opsdIF5e7m5e0OG/uyvgMibffnmGJ8aHveKMIUn4p/erSVzuiBntZY5WsrmaE6/hsPwGy3emKRwylpIGx983mSEMHlmiBpjoFZcD/3RhMaQfkMHNgC5L/N4fcQghhzBDPVrAni71UMr8CrsL4LbQaVYGAWrjOUxOuOIF2lNhrn0q328H7O1KBawSxAqmCtogw7vhBLVgBulxZ334CmChifWQQGECk2W3KAeLMfN5AnM01UnfDkip2NK3MEaNYPYkVVGbZCiy6VGs/5d8kc7nQzJa3AJhWPVCFawI92l/2QBPAc5XnSmQDEnV8PbBFNBiWXccRC2Yo7s6aA8d9rBBDQrz5nzNbVjh29NIN8mOYtwnmW5UfRyzVbFuyT/Av/eBaVLlxCeGAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 12 11 05 41" title="" data-src="/static/2023-10-12-11-05-41-ba560014dcc17427820091c5409b9744-a64ad.png" data-srcset="/static/2023-10-12-11-05-41-ba560014dcc17427820091c5409b9744-a484f.png 200w,\n/static/2023-10-12-11-05-41-ba560014dcc17427820091c5409b9744-d7c5d.png 400w,\n/static/2023-10-12-11-05-41-ba560014dcc17427820091c5409b9744-a64ad.png 450w" data-sizes="(max-width: 450px) 100vw, 450px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>这个异常，是程序在 else 块里试图把结果写回原文件时抛出的，因此不会为 except 所捕获，但 finally 块中的代码依然会运行以确保文件句柄能够关闭。</p>\n<h3 id="总结-61"><a href="#%E6%80%BB%E7%BB%93-61" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>try/finally 形式的复合语句可以确保，无论 try 块是否抛出异常，finally 块都会得到运行。</li>\n<li>如果某段代码应该在前一段代码顺利执行之后加以运行，那么可以把它放到 else 块里面，而不要把这两段代码全都写在 try 块之中。这样可以让 try 块更加专注，同时也能够跟 except 块形成明确对照：except 块写的是 try 块没有顺利执行时所要运行的代码。</li>\n<li>如果你要在某段代码顺利执行之后多做一些处理，然后再清理资源，那么通常可以考虑把这三段代码分别放在 try、else 与 finally 块里。</li>\n</ol>\n<h2 id="第-66-条：考虑用-contextlib-和-with-语句来改写可复用的-tryfinally-代码"><a href="#%E7%AC%AC-66-%E6%9D%A1%EF%BC%9A%E8%80%83%E8%99%91%E7%94%A8-contextlib-%E5%92%8C-with-%E8%AF%AD%E5%8F%A5%E6%9D%A5%E6%94%B9%E5%86%99%E5%8F%AF%E5%A4%8D%E7%94%A8%E7%9A%84-tryfinally-%E4%BB%A3%E7%A0%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 66 条：考虑用 contextlib 和 with 语句来改写可复用的 try/finally 代码</h2>\n<p>Python 里的 with 语句可以用来强调某段代码需要在特殊情境之中执行。例如，如果必须先持有互斥锁，然后才能运行某段代码（参见第 54 条），那么就可以用 with 语句来表达这个意思（此时，所谓在特殊情境之中执行，指的就是在持有互斥锁的情况下执行）。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-12-11-12-49-cf5dda8e3f8f925acea3ba5459a98bd3-66417.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 441px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 28.798185941043087%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsSAAALEgHS3X78AAAA7klEQVQY032QWW/CMBCE/f9/FdAcUFSR2g9AIU6cBMKRhHAUAjxMfRBhCdGHT7vetUfjIf1kDS9aojPh6P3E8MIUfZGjN43xtSgwSLfoTiLQ6gJ2uIHtr/9CRuUvaN1gVJwM5QnfuwsCNd83pq/Osr+CSkFdbdRMY87EjXMEUsgTK+lQ4DOvwI5348biRegNZJBu4EvRzphrN+1jW4gdWtSXb8/enj8gQXGEOxPw+RLOLEF3HOJjLuCGmcaX+fpRrvN15yk8voAj96oOs0KbccIEDs/0jKggaXkGq02oKk/VU+W2Dbu2eNx52eva4A+Ek7gjK6YJWgAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 12 11 12 49" title="" data-src="/static/2023-10-12-11-12-49-cf5dda8e3f8f925acea3ba5459a98bd3-66417.png" data-srcset="/static/2023-10-12-11-12-49-cf5dda8e3f8f925acea3ba5459a98bd3-d16fa.png 200w,\n/static/2023-10-12-11-12-49-cf5dda8e3f8f925acea3ba5459a98bd3-9fd5a.png 400w,\n/static/2023-10-12-11-12-49-cf5dda8e3f8f925acea3ba5459a98bd3-66417.png 441w" data-sizes="(max-width: 441px) 100vw, 441px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>这样写，其实跟相应的 try/finally 结构是一个意思（参见第 65 条），这是因为 Lock 类做了专门的设计，它结合 with 结构使用，表达的也是这个意思。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-12-11-13-23-e51c425ae094005a48229cfbf15b6873-66417.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 441px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 26.53061224489796%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsSAAALEgHS3X78AAAA0UlEQVQY042QWQ+CMBCE+/9/lgqIV/FAE09QDsErWIjxHHerRhMf9OHLTme66XZFeeSjRJhejNKQa4hakKKnzuj+Yn968OGJRrRFnWile8h1DodopRkknZ1NoX32dLZSkE/Yc7aFviN1rjTCLW5o7w6w5wmqQYLKJEB5PIcxDWF5S1j+ErVwDcOLtDZn5PsxTNJ2sAIPZHFGP2REM96hTg0yyeCqC/oHYEBw7eWXL9z8+tDqxZm8dy549Cq9xru0FwmRwphFNEEMucn1jjrZ8W/ujUdu/m5nRgoAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 12 11 13 23" title="" data-src="/static/2023-10-12-11-13-23-e51c425ae094005a48229cfbf15b6873-66417.png" data-srcset="/static/2023-10-12-11-13-23-e51c425ae094005a48229cfbf15b6873-d16fa.png 200w,\n/static/2023-10-12-11-13-23-e51c425ae094005a48229cfbf15b6873-9fd5a.png 400w,\n/static/2023-10-12-11-13-23-e51c425ae094005a48229cfbf15b6873-66417.png 441w" data-sizes="(max-width: 441px) 100vw, 441px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>跟 try/finally 结构相比，with 语句的好处在于，写起来比较方便，我们不用在每次执行这段代码前，都通过 lock.acquire()加锁，而且也不用总是提醒自己要在 finally 块里通过 lock.release()解锁。</p>\n<p>如果想让其他的对象跟函数，也能像 Lock 这样用在 with 语句里面，那么可以通过内置的 contextlib 模块来实现。这个模块提供了 contextmanager 修饰器（参见第 26 条），它可以使没有经过特别处理的普通函数也能受到 with 语句支持。这要比标准做法简单得多，因为那种做法必须定义新类并实现名为 <code class="language-text">__enter__</code> 与 <code class="language-text">__exit__</code> 的特殊方法。</p>\n<p>例如，有些情况下，我们想在执行某个函数的时候，看到更为详细的调试信息。下面这个函数会打印出两种级别的日志信息，一种是 DEBUG 级别，一种是 ERROR 级别。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-12-11-14-29-aa405c1578b7550c6b552b9d9ee72e0f-d9a6c.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 323px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 36.84210526315789%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsSAAALEgHS3X78AAABZUlEQVQoz4VRWXuCQAzk//+ffmrFq+KBAiKIJyIIKOIFUmqrbadha6+nPuTbZDaZzcxywtRGWZ+iufChbGIUtTHyXQ1Vw0RtsoAev0DL4nT5G7/x+PKdc/3jGXIYIzsHyQXqPoXohFB3j5CDCEZyJfz6Q/BPcG03JMITZNpOCRO03C2kTQTR37OHRH9HdxF0ImVBW+i3R1h+q79yrjq2IAVHVIwZGqYHfjABTxYI5hIF1UCdZIv2GtrhCb3tCeohZSqUTNXhTMoIJzVZnuGckb7DSN/QdtbISX2UyMPayCJPPeQVDbw2BN8foWX5KKo6OwXTQUHuozqcs7nycEaYS+GD06JntmrLXqEgaUQ4okYT9ZnDPqoxX7Lm1mKFDg03LQ96dKYPsyAuAwjUl812vBA9sozLjBwkr2hQY66r4p5k8saYSGzcUV0hCx5IdoNIS5SL7oaR5xX90w4nILumtOmKiAN8AAZj9pCzoY8rAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 12 11 14 29" title="" data-src="/static/2023-10-12-11-14-29-aa405c1578b7550c6b552b9d9ee72e0f-d9a6c.png" data-srcset="/static/2023-10-12-11-14-29-aa405c1578b7550c6b552b9d9ee72e0f-82faf.png 200w,\n/static/2023-10-12-11-14-29-aa405c1578b7550c6b552b9d9ee72e0f-d9a6c.png 323w" data-sizes="(max-width: 323px) 100vw, 323px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>这个程序默认的日志级别（log level）是 WARNING，所以，它只会把级别大于或等于 WARNING 的消息打印到屏幕上。DEBUG 的级别低于 WARNING，因此这种级别的消息是看不到的。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-12-11-15-06-1b5cd960ee36dc7106aa4a56af7ceae3-14cd0.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 133px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 53.383458646616546%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsSAAALEgHS3X78AAACCklEQVQoz31SaW/aMBjOz9/XTZq0aZe0SiAVbVq1LFAoJU1FGhIgh50LKCxtaCBQAonJRY6ZVp20L5Mev/Jz2H6l14Tupb35Eri+6ifjsKjzIju1VS/i7bXkBsL9cmgvsCK5vuh4w5XfndqMOpZdD6KMEOerNx8+v/5y0pRA72Fdu7iqtTonv87fVk5rLfrsmvvJChTXr9Rb7yq10zZNsnxzADv6rR6VBPDjwcO6LRnsyGJMS/einu2yljN0t+zdouds+IWnbMOb+yVnu7KHbqxF17DAKoDBgcALBpnuH0yUmSjXdwcN5eo+V1GmPVUMnNH2hYpynMSugaufKn5KqD7mxTPwFaoXg12i/Iu/CsBndon8sifkDeqaFntrM6M79vfC8A/gyfgPlJcAIa13LQE0JY3sK3XFVP1U9qJnG3erbGNMpSdFDVK4jZVNJGPxiIgA6AAf40mUzZJinBZGfIQWFhpuzw10lJtxaUQFxLFdMgmLCabHTGkkJSHY669UmwZGQ1SpIaAGCtUHHXM2i8o6D8ie2JQ1UpBwI2QfnjEcxYkNEZKCSAkiwTuP1c7VpQwZY0Ib40rj8gfDD5wNfpCbOd/obrXZefX+k+Bsu9N5jb7++J3EH6kxlKrnFwTcpzqKjCDFA9D3mRlkI1TAIJfxPILUDA5YZ2dz4MUayvQwH0flCE8UJ8P8D2RgO9rAePAQAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 12 11 15 06" title="" data-src="/static/2023-10-12-11-15-06-1b5cd960ee36dc7106aa4a56af7ceae3-14cd0.png" data-srcset="/static/2023-10-12-11-15-06-1b5cd960ee36dc7106aa4a56af7ceae3-14cd0.png 133w" data-sizes="(max-width: 133px) 100vw, 133px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>要想临时改变日志级别，可以定义情境管理器（context manager）。用@contextmanager 来修饰下面这个辅助函数，就能定义出这样一种管理器。这种管理器可以用在 with 语句里面，让日志记录器（Logger）在进入这个范围之后，临时改变自己的日志级别，这样的话，原来那些低级别的消息，现在就可以显示出来了，待 with 语句块执行完毕后，再恢复原有日志级别。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-12-11-19-21-f07400654c495bad7178d6bb18ef989a-8c2fd.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 381px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 58.53018372703412%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAAsSAAALEgHS3X78AAACAklEQVQoz1WSWXOiUBCF+f8/Zp4yNUkmAVFZXABZBVkFZBGRXRE1mVZ4yFSdovpyOZevT1+EdgLS9OltjCoGKhu4ak/07cI/EKaPazYTHgkrwBRjpNojxfwUNn95bap7cnmVyg4Ri5bPTkLertKGSxs+O4vlhc9b9lAxScnnZ+5Qs0nBJiWI2RfzMGWTSiw7EDLz9qQTEnYAxdQKoJ5avpCdldO33HzJ9V2ub2J1BUmg+gZLKAYzBqia8yGsP0QNwN448feSo5yIcmPaS6httAxSMMjN/WEuO6G49BKLC7IIjgA2Vs03hh/r9jI8forqOyehojY1XFTSCcMDKNqLmSDlD/WT6P6EuiFQiVU3Vq1XhsdVa+7Gq30BCaEisKiY6ow3zgu9+IUTqKyRzm7mJ5QXzbx47icIoENIkPBk40w0Z6QYtBOyUY5Kmz8zDgbxLqwBgQ0zaAEMlB0Q1o6ydoveDA3A9uuSp92YifOptQORbrwIUgqyhLP2lQKo9VPNl/IUhPcwQ+tMmDJRLmQtB2PIW/hIqod4QeKPnP4LrN/g02aV1KTh0pbP7vNhGFXXj0Tq5/RU/2YY1cOct3MvgbahQyY4SnBwdl4dT/0TLs/qUA/L4Rb9MD/OBrzyOta3LzQ70V3C3GGKia9tXDUnxhZTdNIORmsTUy0uKh7/B+yy+wcdZHVfln0QMAAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 12 11 19 21" title="" data-src="/static/2023-10-12-11-19-21-f07400654c495bad7178d6bb18ef989a-8c2fd.png" data-srcset="/static/2023-10-12-11-19-21-f07400654c495bad7178d6bb18ef989a-65055.png 200w,\n/static/2023-10-12-11-19-21-f07400654c495bad7178d6bb18ef989a-8c2fd.png 381w" data-sizes="(max-width: 381px) 100vw, 381px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>系统开始执行 with 语句时，会先把@contextmanager 所修饰的 debug_logging 辅助函数推进到 yield 表达式所在的地方（参见第 30 条），然后开始执行 with 结构的主体部分。如果执行 with 语句块（也就是主体部分）的过程中发生异常，那么这个异常会重新抛出到 yield 表达式所在的那一行里，从而为辅助函数中的 try 结构所捕获（参见第 35 条）。</p>\n<p>现在，我们就可以把记录日志消息的 my<em>function()函数放在 debug</em>logging 情境下执行了。可以看到，三条消息全都会显示在屏幕上，因为在这个情境里面，记录器的日志级别会临时降低为 logging.DEBUG，使得那三条消息本身的级别全都大于或等于这个日志级别。离开 with 结构之后再调用 my<em>function()，则不会显示出 DEBUG 级别的消息，因为程序在即将离开 with 结构时，会先把 debug</em>logging 继续往下推进，从而触发 logger.setLevel(old_level)语句，使得记录器的日志级别恢复到进入 with 块之前的水平。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-12-11-19-46-f0cda244fbd67d58456cafad59ea81a7-61dae.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 310px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 88.06451612903227%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAYAAABb0P4QAAAACXBIWXMAAAsSAAALEgHS3X78AAAChklEQVQ4y41UaVPiQBDN//85W7VroVGuGIgQjiSEK4RwhUMQPPDWt6+nhFIrsvuhayaTmdf9uvu1VghHyLX6KI0WSHsdpGwXp24X9mSJk5qPU6eNTLOHjBcg1+5Dd1pIVTyc8m6+E0GvN/DLtPC7WEaO31plcQP78gaVxTWM7hCF3hjH9RYKgxiFKEaq6uE8GOKYqxlOCDJE2g9Rnq1RHMxQmW9gxUuUplewiaG5ty/w795gMUJrOKfNYBC0PF2rCyZBje6AZ0PemcNd3cNZP6CxfUPj7hUe33uyfuw1Z/PIzStMguhOB9lghBSpnvkBsq0edK+NNCnXCORv3+FcP8G9eVZrkmk7dPEmF8WLeG8+AP79+97zHuQAmAK0yb08XakcWCxE9fKW+zXOSbVI+uXFRtGvLu8I+nIQTJxqRjdCaXIJWfOkW2eRzHCsKpprhbCZdHu2QYWOJN+fH+/sS4RSfilCthlCd9swWHrJ3RnPzTBWUQntHdhP+duda97VIxwm3L1+VuYJwIe5cvEAxaRoNamuUEym8PhhyY+TotVqyy2swZTNGiDNnJ3Um6hd3bPqb6pNZN09PNQue8qFaEoZdVGMZkg3AhzXGjCCsVJAvjNgY8/oYHsQ9PM/TcBEVhJllpU9oTZ1RilgIrsMo66uvgIepGz2RtRkzMpGSlLpZgcStdEdcyhQs9PNfylkT/nIdpS8LsYrNW3+lKqQMxH+UZn/fE6eTz34HfR7pFTKBmfMnRRF9CvUS/EKdbaSDAdRSo2RJ1FOlN4F5ZajSrJs6Ew7QrEfE2yLEseTSFCGgvePpv5COdsOYfYnlFoEaXIZoPlWXw1dncPVGszV4Pj+8CcJ/gU59B3byky79gAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 12 11 19 46" title="" data-src="/static/2023-10-12-11-19-46-f0cda244fbd67d58456cafad59ea81a7-61dae.png" data-srcset="/static/2023-10-12-11-19-46-f0cda244fbd67d58456cafad59ea81a7-44482.png 200w,\n/static/2023-10-12-11-19-46-f0cda244fbd67d58456cafad59ea81a7-61dae.png 310w" data-sizes="(max-width: 310px) 100vw, 310px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h3 id="带目标的-with-语句"><a href="#%E5%B8%A6%E7%9B%AE%E6%A0%87%E7%9A%84-with-%E8%AF%AD%E5%8F%A5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>带目标的 with 语句</h3>\n<p>with 语句还有一种写法，叫作 with…as…，它可以把情境管理器所返回的对象赋给 as 右侧的局部变量，这样的话，with 结构的主体部分代码就可以通过这个局部变量与情境管理器所针对的那套情境交互了。</p>\n<p>例如，我们要给文件写入数据，而且要保证这份文件总是能够正确地关闭。这种需求可以通过带目标的 with 语句来实现，也就是把打开文件所用的 open 函数放在 with 后面，并把一个变量写在 as 的右侧，这样的话，系统就会将 open 所返回的文件句柄赋给那个变量。在 with 结构的主体部分里面，可以通过那个变量执行写入操作，等程序离开 with 结构时，会自动关闭文件。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-12-11-20-09-46adda0c684eb723a2f76a2703b7d7bd-58792.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 385px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 9.870129870129869%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAIAAADXZGvcAAAACXBIWXMAAAsSAAALEgHS3X78AAAAf0lEQVQI1w3J3QqCMBQAYN//fboqKVsbOhf9aC5tO+XpOJOJRRAFEeTdB1+gXC8sSvICiAMltRNwHT0vzMrUaeM5NNnwXt/uCbbKeUndWNOtjioI9o/P4fVjFidyE+40q3BRwizT3CI7XeKzS6lX5MP8yA0uS4gKE2On2iF/fv86WmWSLhPizwAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 12 11 20 09" title="" data-src="/static/2023-10-12-11-20-09-46adda0c684eb723a2f76a2703b7d7bd-58792.png" data-srcset="/static/2023-10-12-11-20-09-46adda0c684eb723a2f76a2703b7d7bd-f436a.png 200w,\n/static/2023-10-12-11-20-09-46adda0c684eb723a2f76a2703b7d7bd-58792.png 385w" data-sizes="(max-width: 385px) 100vw, 385px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>与手动打开并关闭文件句柄的写法相比，这种写法更符合 Python 的风格。这样写，可以保证程序在离开 with 结构的时候总是会把文件关掉，而且这种结构可以提醒我们把主体部分代码写得简短一些，也就是在打开文件句柄之后，尽快把自己要执行的操作给做完，这是个值得提倡的做法。</p>\n<p>如果你想让自己的函数也支持 with…as…结构，那么只需要像刚才那样，用@context-manager 修饰它，并记得在 yield 语句中返回一个值以赋给 as 右侧的那个变量。例如，我们实现这样一个情境管理器，让它根据用户指定的名称（name）获取相应的 Logger 实例，并把日志级别临时调整成用户指定的级别（level），然后通过 yield 将这个实例交给 with…as…语句。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-12-11-27-05-8f041c7f8c43e8e90353a3483bf1c57e-4c7f3.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 384px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 47.13541666666667%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAAsSAAALEgHS3X78AAABiklEQVQoz1WQCW+CQBCF+f//p40tRpGC98Gyy7Gci6AWL1BAUWrTQRvTJsPwQpg3bz5OsueC7rQNVzC9lu62iM2rBk5KcqzUw0XLKi3/wocL6LqndSfHKz5eoXOi6fXYSrQDkbIOZTymIvUkNxRogJOzSP3GjMzWR/30jbMrGJGswvdhKE5NSyjJDl4GU0ihbPIeWzZGSlt3ZG/xjkzI1VSNJjHhexNRwfQfFvVmeKmH8sNiHdOTLSZaDK3zwTwWCH0doS77bGl2Y6LyyIAfJIu1NAuidUx3EMUcziqUnCVn/jYlH3YAgSG/7EW8SmEnePHYgNg4vSi7Qk1K6Mo2R7sC7U8cRAcYXZixGE5LlJym20zZnx6JZrUuAFJNqL62qgODuBf3ez3gPVyHi+0ojMfRDvbzxJrEKclvD/dnPWnVwOBB6Xm42MhOKDnBLE5gz3iV9MM1CK24AR4tv2nZl158a3evf8PgBwdMVgnQBjyjaDeMtv35uu8vZTfq+suuv+oHseyGoMmf4R9SYddsiDZVyAAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 12 11 27 05" title="" data-src="/static/2023-10-12-11-27-05-8f041c7f8c43e8e90353a3483bf1c57e-4c7f3.png" data-srcset="/static/2023-10-12-11-27-05-8f041c7f8c43e8e90353a3483bf1c57e-370ca.png 200w,\n/static/2023-10-12-11-27-05-8f041c7f8c43e8e90353a3483bf1c57e-4c7f3.png 384w" data-sizes="(max-width: 384px) 100vw, 384px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>获得 as 右侧的 logger 实例后，可以调用它的 debug 方法来记录日志消息，这条消息是可以显示到屏幕上面的，因为 logger 实例此时处在 logging.DEBUG 级别，这个级别相当低，凡是级别大于或等于它的那些日志消息，全都可以显示出来。相反，如果直接通过 logging 模块中的 logging.debug 函数来记录消息，那么就不会出现在屏幕上，因为那个函数用的是默认的 Logger 实例，而那个实例的日志级别是 WARNING，它高于 logging.debug 函数所记录的日志消息。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-12-11-27-26-40af3a3cc07edc54f179b52cfcf4ea5d-79545.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 520px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 21.346153846153847%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAAsSAAALEgHS3X78AAAA1UlEQVQY021Py46CQBDk///Gy56MMVF8jCLDoNFdiUZ84QA+GHAfuim75+SBQ6WmqzNV1c60fMLTNzRcgdbsC021wIfw0VnGcKMtRKzRW+3RjWK05xE6n2uad5joAi7pw62G2KUYxAl8beCE1x8owii5wEsLyLyyAcysy/PdckDskybPld2FxR9m1T+40NQ8LYfmAYebcIqflhD7HP1NgsHmRO+MkjOMjxersSF/YCOGuv3WwgkoLchLqOwbMivplCtGh5zYIEgNJMGjWXHTN6M605DwAt60I++lTRmMAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 12 11 27 26" title="" data-src="/static/2023-10-12-11-27-26-40af3a3cc07edc54f179b52cfcf4ea5d-79545.png" data-srcset="/static/2023-10-12-11-27-26-40af3a3cc07edc54f179b52cfcf4ea5d-679cb.png 200w,\n/static/2023-10-12-11-27-26-40af3a3cc07edc54f179b52cfcf4ea5d-c2508.png 400w,\n/static/2023-10-12-11-27-26-40af3a3cc07edc54f179b52cfcf4ea5d-79545.png 520w" data-sizes="(max-width: 520px) 100vw, 520px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>退出 with 结构后，如果再通过名叫 my-log 的这个 Logger 调用 debug 方法来记录 DEBUG 级别的消息，那么这些消息就显示不出来了，因为这个 Logger 的日志级别这时已经恢复到了早前默认的水平，也就是 WARNING。当然了，如果记录的是 ERROR 级别的消息，那总会显示出来，因为这种消息的级别比 WARNING 高。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-12-11-27-59-ac53f56170961cf999de0eb231cab327-329e2.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 332px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 33.433734939759034%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsSAAALEgHS3X78AAABU0lEQVQoz41R2VLCQBDM//+OJXKUEi6TEHJIDhASyJ0QQEQipXi0s4nXIw9TO7Pb290zw7V0E9fjCaQgh7l7gRjmZd3UbXTuPfTdCDe2C36yQHe6RE2+Az9dQAxW6M19qNkjujMfA8IN/ATcxVBFTdEh+hmEZYq2NUNdM9AyZuhMXDSYIN0JXoK2PUdTMyF6KQaLCFK8xjBkxB6RBrhdEuGlpKIu60SWlEpXioEGfeo7Id1F4G2HHDmQo5xIYijJFmq6Q5scS2Si5wSlgJY90dsOXFOrCFirgr8qVVibQpCWJBKdw3ANhUiY6CjeQo43hCUcCTJyPT/ALN5hHE7gtE1VsLCKD1jHz7+cogK+wXg6VbifnE7r39t4/1oGN3BD6NtnjGkh6rrAaLUvc41ybVNAfzj+gs8Jjm2yM/Vo6Blt06HZxWVr/PdmRzQz5uwcMub0Cyoe9kA7E4nTAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 12 11 27 59" title="" data-src="/static/2023-10-12-11-27-59-ac53f56170961cf999de0eb231cab327-329e2.png" data-srcset="/static/2023-10-12-11-27-59-ac53f56170961cf999de0eb231cab327-1c534.png 200w,\n/static/2023-10-12-11-27-59-ac53f56170961cf999de0eb231cab327-329e2.png 332w" data-sizes="(max-width: 332px) 100vw, 332px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>如果想给自己的 logger 改名，那么只需要调整 with 语句中 log_level()的第二个参数就可以了，这样的话，as 右侧的变量所指向的 Logger 自然就会改用新名字。以后通过 logger 记录的日志消息，用的都是这个名字，因此也不需要更改任何其他代码。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-12-11-28-45-3d3f7434d30add6e67a8e9c531e6dcd7-79545.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 520px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 21.538461538461537%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAAsSAAALEgHS3X78AAAA20lEQVQY03VPX0/CMBzc9/88PBBfjBDEjZF2fzBBIwyBMbpug3WFCOp51vimD5drr9e738+b2U/42xK98QS3jy+4ESn6ocRoscHweYVgrTDOCgyfVhjMF+Ql7pc5xL6lZ43JVuPhtYBPn1AGXnJ8Q9ScEBYNpqqFrCzPB0T1CXFz5tsPYvokNVl1ZIukvWBmP5CaK9Lu3SExF3h38wz+poTUHdsqjLIdGxWCXBO1uwd5RW3PkjM/XV3Yd8Ff8CJtIbRhIFkdEe60KxClcXpY1IjIU64Wc8L/wn71L8jpI5TxWxWFAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 12 11 28 45" title="" data-src="/static/2023-10-12-11-28-45-3d3f7434d30add6e67a8e9c531e6dcd7-79545.png" data-srcset="/static/2023-10-12-11-28-45-3d3f7434d30add6e67a8e9c531e6dcd7-679cb.png 200w,\n/static/2023-10-12-11-28-45-3d3f7434d30add6e67a8e9c531e6dcd7-c2508.png 400w,\n/static/2023-10-12-11-28-45-3d3f7434d30add6e67a8e9c531e6dcd7-79545.png 520w" data-sizes="(max-width: 520px) 100vw, 520px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>以上所讲的是 with 结构的另一项好处，也就是允许我们创造一个特殊的情境，并与这个情境交互时，保持情境与在情境中所执行操作之间是去耦的、状态独立的。</p>\n<h3 id="总结-62"><a href="#%E6%80%BB%E7%BB%93-62" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>可以把 try/finally 逻辑封装到情境管理器里面，这样就能通过 with 结构反复运用这套逻辑，而不需要每次用到的时候，都手工打一遍代码。</li>\n<li>Python 内置的 contextlib 模块提供了 contextmanager 修饰器，让我们可以很方便地修饰某个函数，从而制作出相对应的情境管理器，使得这个函数能够运用在 with 语句里面。</li>\n<li>情境管理器通过 yield 语句所产生的值，可以由 with 语句之中位于 as 右侧的那个变量所接收，这样的话，我们就可以通过该变量与当前情境相交互了。</li>\n</ol>\n<h2 id="第-67-条：用-datetime-模块处理本地时间，不要用-time-模块"><a href="#%E7%AC%AC-67-%E6%9D%A1%EF%BC%9A%E7%94%A8-datetime-%E6%A8%A1%E5%9D%97%E5%A4%84%E7%90%86%E6%9C%AC%E5%9C%B0%E6%97%B6%E9%97%B4%EF%BC%8C%E4%B8%8D%E8%A6%81%E7%94%A8-time-%E6%A8%A1%E5%9D%97" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 67 条：用 datetime 模块处理本地时间，不要用 time 模块</h2>\n<p>协调世界时（Coordinated Universal Time，UTC）是标准的时间表示方法，它不依赖特定时区。有些计算机采用与 UNIX 时间原点（UNIX epoch）之间的秒数来表达时间，在这种场合，UTC 用起来是很方便的，然而对于人类来说，UTC 却不太直观，因为我们平常所说的时间，总是默认针对自己所在的地方而言的。例如我们习惯说“早上 8 点”，而不习惯说“比 UTC 的 15 点整早 7 个小时”。所以，在涉及时间的程序里，我们很有可能要在 UTC 与当地时区之间互相转换，这样才能给出用户容易理解的格式。</p>\n<p>Python 里面有两种办法可以转换时区，一种是老办法，也就是通过内置的 time 模块来做，这种办法很容易出错。还有一种是新办法，也就是通过内置的 datetime 模块来做，这种办法可以跟第三方的 Python 开发者所构造的 pytz 软件包搭配起来，形成很好的转换效果。</p>\n<p>我们必须先熟悉 time 与 datetime 这两种办法本身，然后才能彻底明白后一种办法为什么比前一种好。</p>\n<h3 id="time-模块"><a href="#time-%E6%A8%A1%E5%9D%97" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>time 模块</h3>\n<p>内置 time 模块的 localtime 函数可以把 UNIX 时间戳（UNIX timestamp）转换为与宿主计算机的时区相符的本地时间（UNIX 时间戳是个 UTC 时间，表示某时刻与 UNIX 时间原点之间的秒数；笔者这台计算机使用的时区为太平洋夏令时（Pacific Daylight Time，PDT），它比 UTC 慢 7 个小时）。转换之后的本地时间，可以用 strftime 函数调整成用户习惯的格式。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-12-11-37-04-28ac4f1a376a325fdc407310cc56ba09-0f2f0.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 455px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 42.417582417582416%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsSAAALEgHS3X78AAABV0lEQVQoz3VSaW+CQBTk//+l1sQDj7ZWkIVYj3qhKIqIgLfJdHaxVpv4YTLs5r3HzLzVjCCFGe5hRQfI78YyIWI013uI5AybyPiSIb1AxCdYmyNxuuJ4g1b46qPa9/DuLlHujqD3XNSGc1QGU5hBgs95hLofkdeoX2GG27uhj9BkY55DC+0hXpotDprBXh+QczrQ+YN86xslck608Wq1FBur7VXpWbF0oZjgQA85u5spG/t4o1J5VyX03ggFDpQuiu0BSp0hXbiqVip+91bsmaue6nCGcn8KrT7hgSqLHTawsNyfqMYPL4QV7mAumau/gSGzXcQq5/qMtsnyW0bS8GN1J+s0WWRxAdbmwGx2tJOqBf1aEMnpthhxtyDxsKw/1opUo/fGqLkLpao2CRh8hMrIV+dn4T+DZgYxTJ8WOMSSz4WyBW0aPAtactLs6ThX2Hdw/kHe/QAWWEgpy5IopQAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 12 11 37 04" title="" data-src="/static/2023-10-12-11-37-04-28ac4f1a376a325fdc407310cc56ba09-0f2f0.png" data-srcset="/static/2023-10-12-11-37-04-28ac4f1a376a325fdc407310cc56ba09-f5c73.png 200w,\n/static/2023-10-12-11-37-04-28ac4f1a376a325fdc407310cc56ba09-799a4.png 400w,\n/static/2023-10-12-11-37-04-28ac4f1a376a325fdc407310cc56ba09-0f2f0.png 455w" data-sizes="(max-width: 455px) 100vw, 455px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>另外，我们也经常需要反向操作，就是要把用户按照习惯所输入的本地时间转换成 UTC 时间。我们可以先用 strptime 函数来解析用户所给的字符串，然后把解析出来的值交给 mktime 函数，这样就能把本地时间转换成 UNIX 时间戳了。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-12-11-41-29-9fc0730d94801082cd50b9542a4e5329-9e231.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 444px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 25%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsSAAALEgHS3X78AAAA10lEQVQY05WQWw+CMAyF9/9/lDLBW9QYFcTLABEURIOCD4o+HNvhg4mJiQ9f1q49PVuFXAUw1RbGMkBrucE4K9EJ9pALH5YXoeEqSNeHMfdgrkMYrkf1HUaHAt1NAkka7pOk51i0KDBXIZqOwjDJ9VDpBrBU3cS1Ngk473gxmnOFUXrGrHxiWtwxOd/orDC51LEY7nMMdid0ybUXpuQWox9lsK9P2OVDM2MKptL3nE+Z4l37QPTjo56sG98Chl2/0EOqn4iGs6b9+fV+6Lu96KAN6ldVf/MCqkRrQtYZVQgAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 12 11 41 29" title="" data-src="/static/2023-10-12-11-41-29-9fc0730d94801082cd50b9542a4e5329-9e231.png" data-srcset="/static/2023-10-12-11-41-29-9fc0730d94801082cd50b9542a4e5329-f72be.png 200w,\n/static/2023-10-12-11-41-29-9fc0730d94801082cd50b9542a4e5329-0eb67.png 400w,\n/static/2023-10-12-11-41-29-9fc0730d94801082cd50b9542a4e5329-9e231.png 444w" data-sizes="(max-width: 444px) 100vw, 444px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>还有个问题：怎样把某一时区的本地时间转换成另一时区的本地时间？例如，我要从旧金山坐飞机到纽约，我想知道，抵达纽约的那一刻相当于旧金山的几点几分。</p>\n<p>一开始，我以为自己能直接操纵 time.localtime 与 strptime 所返回的值，从而完成时区转换。但是后来发现，这样很不好做，因为每个时区的计时细节可能都会根据当地的规则经常发生变化，所以自己手工管理起来，实在太过复杂，在处理全球各个城市航班起降问题时，显得尤其困难。</p>\n<p>许多操作系统会通过相关的配置文件自动反映时区方面的变化，在这样的操作系统上，time 模块是可以支持某些时区的。但另外一些操作系统（例如 Windows）则不行，所以在那些操作系统上，不要想着用 time 去做转换。下面，我们试着把飞机起飞的时间用 PDT 时区（也就是旧金山所在的时区）来表示。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-12-11-41-59-ac2cf8b7cd38dbc1e66d71c69d741e7a-352a0.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 511px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 49.31506849315069%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAABqklEQVQoz41S13LCQAz0/39SZkLvBtNsCKaaZkwzGELiwGSzuguZTHjJw/rOkk5arWRU5hsUJ0tUl3tY6wj26Yp29KFxjInf51/EDz6jvjmhvj3BImrrI1o0NvYXNMM32Ocb2ixwP/9C7MrH4q0o5tsYRmP3CnO+RfpliKTjojT2UZr4KI4XKE0D1FYHlGdrVP09asGRnexoC1Fd7ZW9NAtUZ5KsxcSGBJps2z68o000WaC5u6ggkUHY1/wQdf5LNxaT6nukipmMEVItvlUMRYPybINUd4jcaIFMz0N2MGOiM+2BZuqtFPLDOQrUu+j5SneH7TqXT+p++2nfkI8weGp01INn22U7IczFFqnOQCXMsUB2SPSnyLoeypQi1/dUUZOxwrzKHBXKYYig0oYwTPdGyDGp/GfcCfKSiGfC6SPJ5AmbpzNAmrEFFsoTSRJIdUf0uWTva4YW9SiQQX6kWUigJJSpW6wuw9D3SP0Lk/rurDdDfIH2iXyGxUBZk/v+NcMLGlwZuYtN4/aN68Ma/fapKWephaA4XqJM4SsckF6bpZqe2rFj/G98AUCw2HL0VvKxAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 12 11 41 59" title="" data-src="/static/2023-10-12-11-41-59-ac2cf8b7cd38dbc1e66d71c69d741e7a-352a0.png" data-srcset="/static/2023-10-12-11-41-59-ac2cf8b7cd38dbc1e66d71c69d741e7a-1fc3e.png 200w,\n/static/2023-10-12-11-41-59-ac2cf8b7cd38dbc1e66d71c69d741e7a-43cce.png 400w,\n/static/2023-10-12-11-41-59-ac2cf8b7cd38dbc1e66d71c69d741e7a-352a0.png 511w" data-sizes="(max-width: 511px) 100vw, 511px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>带有 PDT 时区的时间字符串可以为 strptime 函数正确地解析，于是我们就想试试看，当前计算机支持的其他时区是不是也能解析出来。很遗憾，不行。如果字符串里的时区是美国东部夏令时（Eastern Daylight Time，EDT），也就是纽约所在的那个时区，那么函数会抛出异常。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-12-11-42-12-5d4135126d07a7b6cf0d7976a3f1a95f-b4044.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 478px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 24.267782426778243%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsSAAALEgHS3X78AAAA+ElEQVQY01VQf0+DMBTs9/9MZlFKByyoGxAjY/wsUBFlYy5uU5PztdkM/nF519fXu+tjTqEwz1vMixZ2KuGrLZZvB/CNhMgbuKWCSzNu1cGrXuDQ3EK+gqcVwvGMYEeguhw+sdoewZxcwYoL8HWJ2+cMD90IT/bgSWVMdOVJibs4J8EOdiKh3+i7ezWYvjGgAHqWPfZ7cjkhOvwg+vhGuP8y0K7BlI+nCT//9Va7o+HXOyYyCXtDKQhe0xvxq+g/kFkwOWseXRBMAjCbot6EMWbRGhaJ+s27EddcZDUsWoWgHVv0bb8dMHtKade12bOguqh787vwkvIXnnNqRm7KPuAAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 12 11 42 12" title="" data-src="/static/2023-10-12-11-42-12-5d4135126d07a7b6cf0d7976a3f1a95f-b4044.png" data-srcset="/static/2023-10-12-11-42-12-5d4135126d07a7b6cf0d7976a3f1a95f-061d7.png 200w,\n/static/2023-10-12-11-42-12-5d4135126d07a7b6cf0d7976a3f1a95f-51120.png 400w,\n/static/2023-10-12-11-42-12-5d4135126d07a7b6cf0d7976a3f1a95f-b4044.png 478w" data-sizes="(max-width: 478px) 100vw, 478px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>之所以出现这个问题，是因为 time 模块本质上仍然要依赖具体的平台而运作。它的行为取决于底层的 C 函数与宿主操作系统之间的协作方式，这导致该模块的功能在 Python 里面显得不太可靠。time 模块没办法稳定地处理多个时区，所以不要用这个模块来编写这方面的代码。假如一定要用，那最多也就是在 UTC 时间和宿主计算机的当地时区之间用它来转换，涉及其他时区的转换操作，最好还是通过 datetime 模块来做。</p>\n<h3 id="datetime-模块"><a href="#datetime-%E6%A8%A1%E5%9D%97" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>datetime 模块</h3>\n<p>Python 里面还有一种表示时间的办法，是用内置的 datetime 模块里面的 datetime 类来表示。跟 time 模块一样，它也能把 UTC 时间转换成本地时间。</p>\n<p>我们可以像下面这样，把当前的 UTC 时间转换成本机所使用的本地时间，也就是 PDT 时间。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-12-11-42-44-d895ca61bf98c6b92bce548ce8823bd3-6db8f.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 383px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 44.64751958224543%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsSAAALEgHS3X78AAABs0lEQVQoz21SaXeaUBDl//+i9jQKxTWKaFhiwyKyaCQqimiMjentfY8ce3raD/fMm2G2ewelN8vQmS3QClJ8czy0/BjqY4jhYgv9aS5947lAgzF1OkPLm0ObRhivK+g/IjSdAHeuj36Sw62uUKzyDePtqUZxwmR3hrk9wj5cMNkcZfxh/wZzUxG1b7KZva/rRi+l9Ce7V1isUVp+CmNZyI/fuVE7zNCLV9D47qe5fIvGdvEKM9/DFA1oH0Sz1Q7W/ozBYsP4Ae7pF5SG7UnK7YCN5s9y9Sapd8MFrQ+NVNt+QkkSdMKUNGfoSokyNElVfQzk9zYl68c5lKYbyM00JvaiJSxuM0hfZJLQUJ2G0L3oVnzHYQ2+NerZT1YYUt8RNzYIQV/RKXCXNPWnGF/HLrdccpMMXwwLHU4drQ8y0SC9wXJLGdboEUP6zuEdzvEKp3q/QTHzUmo0or3P1rwoC3nhIa1VnOEeP5h4rQsJ9/RRx/i2yss/UARvsYGcwCS7+jNVJIgL1zhL/K/JDeLKTWsK1fVIOSJFIW5C0TNqGMt/ThxCUBeaCh0tNrfLn8Tl0/6N3xDgiPKc4z3IAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 12 11 42 44" title="" data-src="/static/2023-10-12-11-42-44-d895ca61bf98c6b92bce548ce8823bd3-6db8f.png" data-srcset="/static/2023-10-12-11-42-44-d895ca61bf98c6b92bce548ce8823bd3-89fca.png 200w,\n/static/2023-10-12-11-42-44-d895ca61bf98c6b92bce548ce8823bd3-6db8f.png 383w" data-sizes="(max-width: 383px) 100vw, 383px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>反过来也很容易。我们同样可以用 datetime 模块把本地时间转换成 UTC 格式的 UNIX 时间戳。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-12-11-42-59-526070f2bde1d0f3728602178059d51a-1e4d6.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 420px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 35.714285714285715%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsSAAALEgHS3X78AAABMUlEQVQoz3VQW1eCYBDk//+lPClgqKklQokYiCheEPOSt9RzpvkW8yV7mDN7n93VKsMZzI8hqtEEtdEc7eURlXiKcsBYPEMlGuN5lDKXop7MUR1MxXa+znA2Z7jCJ7jbi7Bm+BEHxniZLFFwPOj0jW4fNTYa/gAlL0CpE1Aghk5bZ06J2NkWT1xE1SgussYKE2jlMHfUhgWnK8F6skDxPYTVT/BgdwiPvhoWoj5ewP7co706kg9oLfawlwe8ZjvxNTXACkYovvXkxAYbDK8PsxfD5DaPjCtWl1hBQjuSfHO+vp0puJ6uNZKMqplso7PY4jkF10eLii5/5Ky/iZNwe5Ujj9G+A62ZrrnqTtTkwVclBSlSfMUt/pu7N9D0Yz4+lB+qMy1yM93cBv63SS72N/YDBev6z/Uh1X4AAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 12 11 42 59" title="" data-src="/static/2023-10-12-11-42-59-526070f2bde1d0f3728602178059d51a-1e4d6.png" data-srcset="/static/2023-10-12-11-42-59-526070f2bde1d0f3728602178059d51a-5f5a6.png 200w,\n/static/2023-10-12-11-42-59-526070f2bde1d0f3728602178059d51a-fe3d6.png 400w,\n/static/2023-10-12-11-42-59-526070f2bde1d0f3728602178059d51a-1e4d6.png 420w" data-sizes="(max-width: 420px) 100vw, 420px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>跟 time 模块不同，datetime 模块里面有相应的机制，可以把一个时区的本地时间可靠地转化成另一个时区的本地时间。但问题是，datetime 的这套时区操纵机制必须通过 tzinfo 类与相关的方法来运作，而系统在安装 Python 的时候，并不会默认安装 UTC 之外的时区定义信息</p>\n<p>好在其他 Python 开发者提供了 pytz 模块，能够把这些缺失的时区定义信息给补上，这个模块可以从 Python Package Index 下载（安装方式参见第 82 条）。pytz 包含一整套数据库，你可能会用到的每个时区它应该都有。</p>\n<p>为了顺利使用 pytz 模块，应该先把本地时间转换成 UTC 时间，然后在这样的时间值上通过 datetime 所提供的各种方法执行自己想要的操作（例如通过下面提到的 astimezone 方法来调整时区属性），最后把操作好的时间转回当地时间。</p>\n<p>例如，先通过下面这段代码把飞机到达纽约的时间转化成 UTC 时间。这样写看起来有点啰唆，但每个步骤都是必要的，只有这样，才能正确地使用 pytz。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-12-11-43-25-70350b191bdcc3b8924d24b3c726cd93-33f4c.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 528px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 40.151515151515156%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsSAAALEgHS3X78AAABaUlEQVQoz4VSa1eCUBDk//+m8gEkikipJCqIDxAVTQFN83Gc5l7rZF/qw5y9u2fZnZ1BqYVLmNEStWgFYzxDOz+hvT3/xnctP6OVHf+E0likqM83ENEiWukHLObWbC1r9iKDvcxv7ySDw+EOhzvbi1zk7C63/Csquh9CH4QodwNo/RGeOUDEcncA3ZugMoig9ocouT40byyvqU4WMAg7yVEZxjBGM86IUJskUFQ2Fd0A4nQjiOXgChseHI/1IfQggu5PIBZrhJDlZb2Xl7SzE5qbww/WBygam1UysuI1nril5A5QCaYo90YodnwUmBcJwa7cI1NCJytrnsKkLHVGe7WVMjW5RDFGMQdEkIPZLOg3kpTIUI/fYPFtisgPhIaibk5XqIYJjaSZfEsf2CNYKq3VTgrdSo/yDCFsZ3+VcA9A5/0qDXDuXJcG3OPOJKXg9FB49SSzariAKvQSJpHtI0/WKMN/v8o9PgEyoUSJ0wLglgAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 12 11 43 25" title="" data-src="/static/2023-10-12-11-43-25-70350b191bdcc3b8924d24b3c726cd93-33f4c.png" data-srcset="/static/2023-10-12-11-43-25-70350b191bdcc3b8924d24b3c726cd93-cd792.png 200w,\n/static/2023-10-12-11-43-25-70350b191bdcc3b8924d24b3c726cd93-b74d4.png 400w,\n/static/2023-10-12-11-43-25-70350b191bdcc3b8924d24b3c726cd93-33f4c.png 528w" data-sizes="(max-width: 528px) 100vw, 528px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>获得 UTC 形式的 datetime 时间（即 utc_dt）之后，就可以把它转换为当地时间了。例如，可以像下面这样，转换为旧金山的当地时间。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-12-11-43-38-5795440951801d502bf3db044679d72a-eb572.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 486px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 22.633744855967077%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsSAAALEgHS3X78AAAA50lEQVQY031Qa2+CQBC8//+XagwnT60fELHaXoUTBCVGDT4rtRmXJTUmbfywmd25udm5E6ZKYMcZ/PUR8kPD/EzQnRVohwqtkYIxieHoHPKdMJrDJa2rl3hdbDHYnPmevzlRf+JeyEmEfr6GO53jxX+DlyzRTQp0yNygs069kJbYZOZEZBbnsElrES/HEaMxnvJZzYtetoJTi3TG6Ya7CkF5YRzuvxvcXZh7rEddUH7d9aKOOzr8IKQh3F8bUVnd63cO2Lh6YtpwQlJcU83g0b9YKoXL0VNYVJ5e8LN6aYHwcP2T8r+6AT8/arqBuMykAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 12 11 43 38" title="" data-src="/static/2023-10-12-11-43-38-5795440951801d502bf3db044679d72a-eb572.png" data-srcset="/static/2023-10-12-11-43-38-5795440951801d502bf3db044679d72a-9bfa0.png 200w,\n/static/2023-10-12-11-43-38-5795440951801d502bf3db044679d72a-a8932.png 400w,\n/static/2023-10-12-11-43-38-5795440951801d502bf3db044679d72a-eb572.png 486w" data-sizes="(max-width: 486px) 100vw, 486px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>转换成尼泊尔当地时间，也很容易。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-12-11-43-51-0641be593ae27bf7b698af225eba0881-1c0b9.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 472px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 23.093220338983052%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAIAAADKYVtkAAAACXBIWXMAAAsSAAALEgHS3X78AAAA2UlEQVQY022PbWuDMBSF8/9/09D5GtqyDWJsq4kaY9S2dKvRMbX2w25KKQwGD4dz3w5c5Oyzj9OARe2xctOcX7fc3mX2PltVB5yrgEvoO0nhc7lWR3L5of0c6YnqKepGZMfMScowbzbq/EK2Xlr6XFkxD4vG5xWkwCjgCkpIgdJN84BX1o55TKD39svj0opTfB+/nTQdbpGeo/5q0HftF2P0lXSTQc+kG2EHkctIv290WGDD6GC8uTd+eUT8YXkqchMRFi0Wh5U8BvCkoXaZxKJd15+Q+9/9g19lIgbymay0sAAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 12 11 43 51" title="" data-src="/static/2023-10-12-11-43-51-0641be593ae27bf7b698af225eba0881-1c0b9.png" data-srcset="/static/2023-10-12-11-43-51-0641be593ae27bf7b698af225eba0881-689e7.png 200w,\n/static/2023-10-12-11-43-51-0641be593ae27bf7b698af225eba0881-d007c.png 400w,\n/static/2023-10-12-11-43-51-0641be593ae27bf7b698af225eba0881-1c0b9.png 472w" data-sizes="(max-width: 472px) 100vw, 472px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>把 datetime 与 pytz 搭配起来使用，可以确保程序在各种环境下，都能够给出一致的转换结果，而不依赖于具体的操作系统与宿主计算机。</p>\n<h3 id="总结-63"><a href="#%E6%80%BB%E7%BB%93-63" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>不要用 time 模块在不同时区之间转换。</li>\n<li>把 Python 内置的 datetime 模块与开发者社群提供的 pytz 模块结合起来，可以在不同时区之间可靠地转换。</li>\n<li>在操纵时间数据的过程中，总是应该使用 UTC 时间，只有到了最后一步，才需要把它转回当地时间以便显示出来。</li>\n</ol>\n<h2 id="第-68-条：用-copyreg-实现可靠的-pickle-操作"><a href="#%E7%AC%AC-68-%E6%9D%A1%EF%BC%9A%E7%94%A8-copyreg-%E5%AE%9E%E7%8E%B0%E5%8F%AF%E9%9D%A0%E7%9A%84-pickle-%E6%93%8D%E4%BD%9C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 68 条：用 copyreg 实现可靠的 pickle 操作</h2>\n<p>Python 内置的 pickle 模块可以将对象序列化成字节流，也可以把字节流反序列化（还原）成对象。经过 pickle 处理的字节流，只应该在彼此信任的双方之间传输，而不应该随意传给别人，或者随意接受别人发来的这种数据，因为 pickle 的本意只是提供一种数据传输手段，让你在自己可以控制的程序之间传递二进制形式的 Python 对象。</p>\n<blockquote>\n<p>pickle 模块所使用的这种序列化格式本身就没有考虑过安全问题。这种格式会把原有的 Python 对象记录下来，让系统可以在稍后予以重建。这意味着，假如记录的这个对象本身含有恶意行为，那么通过反序列化还原出来之后，就有可能破坏整个程序。</p>\n<p>跟 pickle 不同，json 模块考虑到了安全问题。序列化之后的 JSON 数据表示的只不过是一套对象体系而已，把这样的数据反序列化不会给程序带来风险。如果要在彼此不信任的两个人或两个程序之间传递数据，那么应该使用 JSON 这样的格式。</p>\n</blockquote>\n<p>例如，下面这种 Python 对象表示玩家在游戏里的进度状态，其中记录了玩家当前级别（level）、还剩几条命（lives）。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-12-20-51-26-83ee1c9aa9c2f2fa39150881eac0ba02-092d7.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 211px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 38.388625592417064%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsSAAALEgHS3X78AAABuUlEQVQoz0VRaZOaQBTk//+bVLKHWhqP6CoIDJeggAfsggdKQHTLI+m8GWsrH7re1Js3Pf26pZ63wE97ipbjYbRK0fUj1MYGvvVlge8DBS8Kw7Oso66aaBgujOwEq7zCyD9hFldx5jCLCyQ9OaA3W6IfRtDXBdjuiIY1RZ25aFkzDBYf+OXHaNg+BuE7utMVTCL0qj/wPwHn9wV2fhHVpZ5kH+9wz3RBP9V1BzU2gRLv4J3+0tANbSJouwHVEL0ggl1dIEdrvKo2KTdQ03nV0ZwEkD8ySFymRWRGVqHjzdFfpmIlbVNinOZ4WySC6I1IusEK6iYj7MmaJVpklZbkUJMMwyjB6H0H6Wt3XidnUlXd4ZC6/jzB00hD03TxymyxZtOe4Qf16swRYNuCbCqhrXO0iXxyvBFh8d/QL9h0wYd6FJBMv47iLRgpHi4T8nBOqlNo6QHm4Qx1V0HfnyDTjM1DMUsiKbnCBzihU90ojBgvMkPDdPCsMUFYs1wiDNGkpJ+GmlCobHiQFa0fiPcPhcVVxP8AV3iHkmbouCHG64MA2x7Ju5yM35KnMTr+inp83RLW/kyKC/H+H0ZXPScBqMZIAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 12 20 51 26" title="" data-src="/static/2023-10-12-20-51-26-83ee1c9aa9c2f2fa39150881eac0ba02-092d7.png" data-srcset="/static/2023-10-12-20-51-26-83ee1c9aa9c2f2fa39150881eac0ba02-6cb69.png 200w,\n/static/2023-10-12-20-51-26-83ee1c9aa9c2f2fa39150881eac0ba02-092d7.png 211w" data-sizes="(max-width: 211px) 100vw, 211px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>在运行游戏的过程中，程序会修改这个对象里的各个属性。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-12-20-51-42-4c40c53a9cec06aa123fd64ff5147cb4-088ba.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 390px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 38.71794871794872%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAAsSAAALEgHS3X78AAABQ0lEQVQY03WQaW+CQBCG9///I22tB97oyrGAnIIilxSWowpimg5W+6UxeTLZnePNO4N6orZ0T1xUdDi5s5H6itkjOqPafHIWsyvJm0fMr/AQs1rKG4HWQtaCBltr4QRDzRkqFvZT7FMc5is/ndkBozsT44CDtO2xw02Uzd2Q0ex1SOXzNylvqMvLY/MwNvZvvIwDioNsHWWsn0wtb6CYH6LKunGXk6fWcbbzZztvbnvDrdVXjJFqIYFWYtFI5Q0sgTfQk4oGMqQAexWfgvm67YEqrYSWmvv8Avj0glgvnjv+2HRHurOO6PIYjzSb9ZJVkEAZtFrFu9wf5BmRkIJMiU85TPLwiDIcF5t75jEGp3oBgj1JfuXSC3yEu0MhrX5XgIO3tvOX84gx9u9EvfukABeXE/3QE1UuyhfuaenF5HmO//wANzio9ppF81oAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 12 20 51 42" title="" data-src="/static/2023-10-12-20-51-42-4c40c53a9cec06aa123fd64ff5147cb4-088ba.png" data-srcset="/static/2023-10-12-20-51-42-4c40c53a9cec06aa123fd64ff5147cb4-265d0.png 200w,\n/static/2023-10-12-20-51-42-4c40c53a9cec06aa123fd64ff5147cb4-088ba.png 390w" data-sizes="(max-width: 390px) 100vw, 390px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>玩家退出游戏时，程序应该把当前进度保存到文件里，这样就能在下次启动时，把进度读回来，让玩家接着上次的玩。这项操作通过 pickle 模块很容易就能实现。下面，我们用该模块的 dump 函数把 GameState 对象写到文件里面。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-12-21-26-24-44bfb1d7fde28c013a980fbb065390bb-d82ed.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 303px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 33.33333333333333%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsSAAALEgHS3X78AAABb0lEQVQoz4VSyXaCQBDk//8l16gxbtGgElEYcBcEUXHJU3HXJK9Sgxxyy6He9NR091T1jPKi2ygPPKjuDLXJCjm7j7w9QNbsQAtWaB+/IXY3WNF/uMerUmORvtyh+XlAYxnhY7GFvooYS+4I6/AFa3+HIKw/ELJJwotkL/ZsGAfJoYSxvcDcXdE+/ZC/Ut0VJjmZ8zi7wNicY16uZpIvokdT5Vkz8Sq6KPXHyBgdpBoCqjeH2DBxc0LO6iGtm6iOZ3gbBSh1RyjYQ9SCJQqdIerMtbcUQCc2oRR7I9QnIee15ixdqCxSnSkLXRS6DuMAFc44Z/eQ7zho00XVD1HsO6h5C44rgurPoM83eHdDKDJoLnZUEKI89Nh0woIFSr0xFThMmqJIJZWBT86HoBpttsYbLzFWhxh1ipH2W8s9lO4ZqLhzpFsW7fXj15WKMrqFp0IZKa2JLG1nDJuxwd8Qoj5lQ8fjzG+xTfkT4jdg/AvnKvdq3p9qwgAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 12 21 26 24" title="" data-src="/static/2023-10-12-21-26-24-44bfb1d7fde28c013a980fbb065390bb-d82ed.png" data-srcset="/static/2023-10-12-21-26-24-44bfb1d7fde28c013a980fbb065390bb-828c4.png 200w,\n/static/2023-10-12-21-26-24-44bfb1d7fde28c013a980fbb065390bb-d82ed.png 303w" data-sizes="(max-width: 303px) 100vw, 303px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>稍后，我们可以调用 load 函数把文件里的数据还原成 GameState 对象，这个对象跟序列化之前相比，看不出太大的区别。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-12-21-26-44-8542be14b0338f4190d3d069f845779a-6dde6.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 304px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 40.460526315789465%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAAsSAAALEgHS3X78AAABfklEQVQY001QiY6iQBTk/39oszOu4g0qNw0DyGHL3WCDHF6jM4/ZZLNJpZNXnXr1qpi1F7LI4g7JNiJz21+6eGp5I90aIXvqBO+y8SajXUrVqmctd+WFatEsvFDKqqnlMwrt9fom5jX74f5B+7mNlw5+V9DM8rhDJsZ0bOznzmGC9tuQcG7IGu5vUVvavphVjHa+o/ZTKjv+SDicr3HOYcLjfBMWCr2oZb/0km1crg6pkFS7mM5dvPCOQkzVogPxQ61vevNA7dPoXmb3gtfov7T6rjeAh3n9gu2Age+eRv80+xeM8MVsjjkfpLwfQeCJ4cBJrOnObDxSzF+CtotPEHii2WPFXAcJhzMhq7Rm8IOTGSGhQlTq4FPfVXqRy145XeSihSJUegVSLjogteoKvERa7Uf2FwwfkpmDpaIVyVk+9frADimghYEsG1DCKJctrNbbz3/KH+fotPJT9sN7U81dVMLudZCKpJWy89QKxshaOFirbqzlbyICvfwv/gZzL6QenK5EYAAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 12 21 26 44" title="" data-src="/static/2023-10-12-21-26-44-8542be14b0338f4190d3d069f845779a-6dde6.png" data-srcset="/static/2023-10-12-21-26-44-8542be14b0338f4190d3d069f845779a-868be.png 200w,\n/static/2023-10-12-21-26-44-8542be14b0338f4190d3d069f845779a-6dde6.png 304w" data-sizes="(max-width: 304px) 100vw, 304px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>这种办法有个问题，就是不能够很好地应对将来的游戏功能扩展。例如，我们还想记录玩家得过的最高分数。于是，要给 GameState 类里添加一个字段。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-12-21-27-28-53afa20c84fa39865b256f8b89bf5c84-fb41b.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 334px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 30.239520958083833%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsSAAALEgHS3X78AAABLElEQVQY01WRW2+CQBCF+f8/yIfaeokRtYjorqhQxAsVKqgVtKmXmNPDlqb6cDKzk93vzMxqRrRF1X5Dyw/RDmKUDAulrsDTYIzK0EVrFmGYXTE63iDTM/OLiv+6PEgT6Qlyf0J7HqFGsLVOYVLV0RQ6TezdN+NKwRteADPOIAgVhKn4lxci8ILh4Qprc1SwQXIgzEPN8dEkqOHOUbFdvAYJFcOIdpDs+B7yAJTZbyLpZH/d0EsyPIsxRw0VoDb20PSWNDrCWG1hJqlqIL8vi6jOhbR7el6w4gNepIO6M4MZ7qBPA5SFo9bQZ/fmxyfE/ox+PhEluK78TZ+GeU1TTsUecmAv3hM4gT5boe4uqDnqEx/6IlSPuu8b9NaZ+qwyP67F3XeWnMTmJH6AH2ogs28amt6iAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 12 21 27 28" title="" data-src="/static/2023-10-12-21-27-28-53afa20c84fa39865b256f8b89bf5c84-fb41b.png" data-srcset="/static/2023-10-12-21-27-28-53afa20c84fa39865b256f8b89bf5c84-7193b.png 200w,\n/static/2023-10-12-21-27-28-53afa20c84fa39865b256f8b89bf5c84-fb41b.png 334w" data-sizes="(max-width: 334px) 100vw, 334px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>用 pickle 对新版的 GameState 对象做序列化是没有问题的。下面，我们用字节流代替文件模拟一下双向的操作效果。先用 dumps 函数把对象序列化成字节流，然后用 loads 函数把字节流反序列化（也就是还原）成对象。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-12-21-27-53-cbfcb91c2833b0296764d83d31d259ad-32a72.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 350px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 37.714285714285715%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsSAAALEgHS3X78AAABpklEQVQoz0WSa1uqQBSF+f//53ypgyJSaB2SuyCoIF6OQlYommWt1kw+9WE/M8OsWXvvd6O0/QTtMIW3PaA/L3HtRvhzb6MznKATTdGJM/RmawwPQNh8ItifGR8ILxHszvBeTj+hdGjW8kcwJ0vcjguofgxrUUEfZWgNE2jxGN3xHLezJdQwgZlTl62gU2tMCtwVG2kaNB8ymWLEOSvJYFKkehG6NPIejxRWMNKCFU7RClJooymubR+qE0ENEnYSQxumUt8vyu/I11BUVtdi2zpb0+TjBHeLLQ1LokhkpTesxMwWMLhXad5NZ9CiCVFsWPFK3v1lAqFVButn9KZLZspxk8zIbkyxMB5B5yOL5oNNDY2JBJJ/KyYja68+yTZ9yfSM8PApz4pT7uDX7xe4b3IvVsmF0MXZfT7J1d+9w3l6lfde/RuuGMhlrxhpjodqB6usYXPSg8dGrva2wQO/ifOg2tPoKL+5L6/U76Xekvffdxa7sKlVzGyJKydEm/wc8euQnZiiMOlzomIAgo27PaKX/5ePdKIRv5ee5OQ5h101ElO/WOML8G4+Uu/6DQEAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 12 21 27 53" title="" data-src="/static/2023-10-12-21-27-53-cbfcb91c2833b0296764d83d31d259ad-32a72.png" data-srcset="/static/2023-10-12-21-27-53-cbfcb91c2833b0296764d83d31d259ad-47adc.png 200w,\n/static/2023-10-12-21-27-53-cbfcb91c2833b0296764d83d31d259ad-32a72.png 350w" data-sizes="(max-width: 350px) 100vw, 350px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>但是，如果想把旧版的存档还原成新版的 GameState 对象，也就是要让玩家接着上次的进度来玩更新之后的游戏，那会如何呢？下面这段代码是按照新版的 GameState 类来运行的，但它想通过 load 函数对旧版的数据做 unpickle。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-12-21-28-19-05d1992c86966c79af561583acadb752-cedc2.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 305px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 43.278688524590166%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsSAAALEgHS3X78AAAByklEQVQoz01SaXOiQBDl//+grYqJiRcRPBDkUIwHIBEvZEVFc+3bN2NM5UNXH9P9ul/3KOpLAHUcwkhS1EcB9CBBZTBGdThB2R2h6s9Q96f407ZQHc3gHt7R2+7xxDdjkaKb7KBFS2jzFZrRAoqZHmEs/6I+jlB2Rmi8hGhOX1HquSh7V0A9WOKZsQoB6+J9FkMNEzxPYtn80fFR8SawiKU4h0+YuwK18ZwThKhRGuNYNqixuDXfwMkuUtcnzPED2VSn3yBgqe/JJiprnPQMxT58wD19YXgB/DcK9eB81TfbPX5KkXHmiNxBQX2+2qLePX7B3r9B0aMVO83RmEZ4GnJ3pHDvDKFxlw/9IR4sjxNH3NsRIrdkOlCnMZrzNfR4g+4qh52/o08wIYpDumKHRpKRxlqKFq4kpVa8Jcga3cUO5uaA9msqfWOZocP8Luus7PwDKCdsRdxR/gGvuNLzTv+k7VILKreYpCU1pbj6Yv8/YN9aUXkMjVTa7KpxIkGtx2nE9c3dSU7cWWVo83sYm5zxQto9vv+mat8mNLc57qwBSja/zDTh6Qt0BDUC9fcX0k9Q5RXveh4pZjC3BSr8Si2COjyUBBTA3/If9USL2h3l8LkAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 12 21 28 19" title="" data-src="/static/2023-10-12-21-28-19-05d1992c86966c79af561583acadb752-cedc2.png" data-srcset="/static/2023-10-12-21-28-19-05d1992c86966c79af561583acadb752-33c45.png 200w,\n/static/2023-10-12-21-28-19-05d1992c86966c79af561583acadb752-cedc2.png 305w" data-sizes="(max-width: 305px) 100vw, 305px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>这样还原出来的 GameState 对象，竟然没有 points 属性。这真的很奇怪，这个对象明明是新版 GameState 类的实例，但为什么没有 points 属性呢？</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-12-21-28-40-306a1551ec27b01e1c31e61efc294dce-59c7b.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 375px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 6.666666666666667%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAABCAIAAABR8BlyAAAACXBIWXMAAAsSAAALEgHS3X78AAAASElEQVQI1wE9AML/AMbf5sTd48nj6c7p8crj6snh6Mjg58ng58Tb4sDY3sLa4MXe5b/W3MTd48/r8r7T273S2MDX3b7W3Mfh6A09Mng8osYZAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 12 21 28 40" title="" data-src="/static/2023-10-12-21-28-40-306a1551ec27b01e1c31e61efc294dce-59c7b.png" data-srcset="/static/2023-10-12-21-28-40-306a1551ec27b01e1c31e61efc294dce-16d5b.png 200w,\n/static/2023-10-12-21-28-40-306a1551ec27b01e1c31e61efc294dce-59c7b.png 375w" data-sizes="(max-width: 375px) 100vw, 375px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>其实，pickle 模块就是这样运作的，因为它的主要用途仅仅是让我们能够把对象轻松地序列化成二进制数据。如果想直接使用这个模块来实现比这更为复杂的需求，那么可能就会看到奇怪的结果。</p>\n<p>解决这样的问题，也非常简单，即可以用内置的 copyreg 模块解决。这个模块允许我们向系统注册相关的函数，把 Python 对象的序列化与反序列化操作交给那些函数去处理，这样的话，pickle 模块就运作得更加稳定了。</p>\n<h3 id="给新属性设定默认值"><a href="#%E7%BB%99%E6%96%B0%E5%B1%9E%E6%80%A7%E8%AE%BE%E5%AE%9A%E9%BB%98%E8%AE%A4%E5%80%BC" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>给新属性设定默认值</h3>\n<p>最简的办法是定义带有默认参数的构造函数（参见第 23 条），以确保 unpickle 操作所还原的 GameState 对象总是具备应有的属性。下面，我们就定义这样的构造函数：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-12-21-29-12-9b5072ea6dedc1bef8758d711ea2f48c-93695.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 460px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 21.956521739130437%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAIAAAABPYjBAAAACXBIWXMAAAsSAAALEgHS3X78AAAAu0lEQVQI122N2w6CMBBE/f+P8oIC4g0tIFGpabFCiVRaEbRijIv6aDIPM5tzsp3pMR9TbuFDP8DGhgx38ep8W4naVxoVGgpMVNzbIipPaphLUUHQ+dbxLs08kzZJHZaDae6ZiZmxo5OjGEWHYRTPErHgCh4AM+fSIolNU5skM5aD/AB/Xb3ABBqu3WCLRG2R1NgS91QG1ycwftlAPvCv+5emlZHSQIwwA9mhWS+MFly6XA3C/TjOvsLfvAE7/dN2AIsarwAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 12 21 29 12" title="" data-src="/static/2023-10-12-21-29-12-9b5072ea6dedc1bef8758d711ea2f48c-93695.png" data-srcset="/static/2023-10-12-21-29-12-9b5072ea6dedc1bef8758d711ea2f48c-ae711.png 200w,\n/static/2023-10-12-21-29-12-9b5072ea6dedc1bef8758d711ea2f48c-f4267.png 400w,\n/static/2023-10-12-21-29-12-9b5072ea6dedc1bef8758d711ea2f48c-93695.png 460w" data-sizes="(max-width: 460px) 100vw, 460px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>要想用这个构造函数做 pickle，应该定义下面这样的辅助函数，让它接受 GameState 对象，并把这个对象转化成元组，该元组的第一个元素是负责处理 unpickle 操作的函数（即 unpickle<em>game</em>state），第二个元素本身也是个元组（即(kwargs,)）用来表示那个函数所接受的参数。在本例中，由于 unpickle<em>game</em>state 只打算接受一个参数，因此那个元组也只能有一个元素，就是 kwargs。只有符合这种标准的函数，才能够注册给 copyreg 模块。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-12-21-29-35-39410a18f91058cf01334dc05a16ff09-78d20.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 373px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 16.353887399463808%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAAAsSAAALEgHS3X78AAAAyUlEQVQI1x2O226CUBBF+f8faktTBPSgTYoW5FKBw0WlYnjQEptgU7M69mFNJrNn9mxD6R1e1aIEN6tw8wZ3U2EuI7z6wFR0K9U4G425WuN8lMz0lonM7LRg1Q+shyvh1yhcMYLTSHAescXEigs5qFh2Z1T5yaMfMpUHTlZjJZrXXc+86aTPmdcd/nEguvwSf9+ILzcx/sG4lzuqbJkkBbN8y6I58vSe8BymvESZaHse3gLsWOPJnhmkKN3iH06i5/9BbEm+2Pf8AYYq0+K4zgJWAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 12 21 29 35" title="" data-src="/static/2023-10-12-21-29-35-39410a18f91058cf01334dc05a16ff09-78d20.png" data-srcset="/static/2023-10-12-21-29-35-39410a18f91058cf01334dc05a16ff09-08c4a.png 200w,\n/static/2023-10-12-21-29-35-39410a18f91058cf01334dc05a16ff09-78d20.png 373w" data-sizes="(max-width: 373px) 100vw, 373px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>然后，定义另一个辅助函数，也就是上面提到的 unpickle<em>game</em>state。这个函数接受刚才那个 pickle<em>game</em>state 函数所返回的 kwargs 参数，并用这些参数里面的序列化数据来构造 GameState 对象。这样看来，它仅仅是把 GameState 的构造函数简单地封装了起来。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-12-21-29-51-4602df53f31da1b70cb9f5d642b443f0-a07a0.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 293px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 15.01706484641638%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAIAAAAcOLh5AAAACXBIWXMAAAsSAAALEgHS3X78AAAAqklEQVQI1xXO2wqCMACAYd//hYrSqa1QSk1zc+6kc+CpkxlFNwUp/Lcf/AbkCuZl0A42KTZc23kBEA+b607qZYR91Qb1zc1Ll2lAhEOkgyUUGmAe9oMRtPewH6Pz00RsKzRklac6G7HF4bgMEhvzSVopgbwyT8TNpIXYHBbx/W2g1xe/f/HtNUlfdV7ZRO3DzeUqSkEmIC1ARk1M0/Ezf6XUyug6wfv6Mqk/qAOWelGtGUcAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 12 21 29 51" title="" data-src="/static/2023-10-12-21-29-51-4602df53f31da1b70cb9f5d642b443f0-a07a0.png" data-srcset="/static/2023-10-12-21-29-51-4602df53f31da1b70cb9f5d642b443f0-7eae0.png 200w,\n/static/2023-10-12-21-29-51-4602df53f31da1b70cb9f5d642b443f0-a07a0.png 293w" data-sizes="(max-width: 293px) 100vw, 293px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>现在，我们用内置的 copyreg 模块来注册这两个函数。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-12-21-30-08-b385dd0e498462f5ea52f24ad280c253-acb24.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 399px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 15.288220551378446%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAAAsSAAALEgHS3X78AAAAnklEQVQI112P6wqCQBCFff9nCkOxJIKw3dXyfkMz6GItUllwGhdC6cc3w5y5a8uohOHFWFcnLJIaM+5D9yLY+RGu/IC1T/DbC4zgE9gfP10bzPb6AJe9SjjnDs6lAyNNyDfpE+79CMWCFgrlxxrNDDIY+4RI6cIKVlzCDHOYUQHdDaHzAMYuhUWfbJoWqt7PsCoazCk/9NrZgfRczfgCEQbZnaZtNXEAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 12 21 30 08" title="" data-src="/static/2023-10-12-21-30-08-b385dd0e498462f5ea52f24ad280c253-acb24.png" data-srcset="/static/2023-10-12-21-30-08-b385dd0e498462f5ea52f24ad280c253-ff279.png 200w,\n/static/2023-10-12-21-30-08-b385dd0e498462f5ea52f24ad280c253-acb24.png 399w" data-sizes="(max-width: 399px) 100vw, 399px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>注册之后，pickle 模块就可以正确地序列化与反序列化 GameState 对象了。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-12-21-30-27-edcc8bc6d1a86f2a645b447dba77260d-36502.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 363px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 41.8732782369146%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsSAAALEgHS3X78AAABnElEQVQoz1WRaXuaUBCF+f+/p19arbJYcamQyKICAiqK4hKJS0xicnLu9WmSfphnBubO9h5FD1PUvBCd2Qruw5OMK3cufnsBan4Ild/Wcgf38QX9/ROc8kJ/+Yyd8vk/U/Rggqo7QiPKoA0T2bDuR7DyB/RWJfTBGNoghnd8g39+h3t4ZXyFd3qTcZ9NvuwFisrH6iiBKgqHY/y6H8pmrXQFNUihjWKY44zbRqhyazNZwIhmqHO4meZykGguhoimihFObkXTHI3xFHVueFc8orcsYfBb5IQ30wV+Wi5qbiC3FiiEb01yaEGCZrwgllcojXAKgxvqNHGqKGilt+aVe1/G7VkBeQmtGc9hTpYcekAv35PvHu1pge5iB4ecFXt9QH93ZnKH7nzL4jU62RptWme+gb05clsiyAoy3eMvY3t7JL8rHDK8MSXPfyeb6RJ2UWJwgXwggR9vwIVJIeS/q/TijX96/8x/F0Wq3ExyGFRanNokD4v8BC97c8AfClDzIsnJItN2tmG+RNUZQSc3jXX97YlC5fjRsSlqjA/6FT9/XHE+WAAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 12 21 30 27" title="" data-src="/static/2023-10-12-21-30-27-edcc8bc6d1a86f2a645b447dba77260d-36502.png" data-srcset="/static/2023-10-12-21-30-27-edcc8bc6d1a86f2a645b447dba77260d-5548b.png 200w,\n/static/2023-10-12-21-30-27-edcc8bc6d1a86f2a645b447dba77260d-36502.png 363w" data-sizes="(max-width: 363px) 100vw, 363px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>假设注册之后，我们又修改了 GameState 类，给里面添加了一个表示魔法卷轴数量的字段（magic）。这种修改，与早前向 GameState 里面添加表示最高得分的那个 points 字段类似。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-12-21-30-50-47c4fc864d758e5f98cd2a677e8512a2-8157d.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 541px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 22.73567467652495%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsSAAALEgHS3X78AAAA/klEQVQY021QwVKDMBTk/z9IL2otMghk6gBFHURbsCAUpFCxtto66ybpjJceNtkkL7v7nuFkJayXHOM4gxmn8PIWYbeD320Rrr/ht1/wV+T9kROKryTfIOBbIOt5H/CP4eYNxKJWolaSwU4LmNzd1xq3aUmTOU0a+M2gzg4xqXo4WQV7XkDk73CLFuZTSp0GRjTslePlNKbIEqOHBB4NJtUaV1EC8dYi+jywZofpx48Gk2u+/787wgi5hIx6/TiDmy1hzwpYzwvc1YNKfcO0Qb/F/eZXfxq0iBzHKRjyUc7hggnlHM9FoFuj+Jnnq3Zttjdi644cDc1E2SnhU4J/xt9q7jVM5nwAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 12 21 30 50" title="" data-src="/static/2023-10-12-21-30-50-47c4fc864d758e5f98cd2a677e8512a2-8157d.png" data-srcset="/static/2023-10-12-21-30-50-47c4fc864d758e5f98cd2a677e8512a2-696af.png 200w,\n/static/2023-10-12-21-30-50-47c4fc864d758e5f98cd2a677e8512a2-4fa96.png 400w,\n/static/2023-10-12-21-30-50-47c4fc864d758e5f98cd2a677e8512a2-8157d.png 541w" data-sizes="(max-width: 541px) 100vw, 541px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>我们已经注册了负责 pickle 与 unpickle 操作的函数，因此，如果把不带 magic 字段的存档文件加载回来，那么得到的 GameState 对象是具有 magic 属性的，该属性会取默认值 5，这与没有注册的时候不同，那时得到的 GameState 对象缺少了刚刚添加的 points 属性。为什么这次不会把新添加的字段漏掉呢？因为这次，系统会通过 unpickle<em>game</em>state 函数来还原对象，而这个函数会触发 GameState 构造函数，使得缺失的字段能够自动获得同名的关键字参数所指定的默认值，而不像没有注册时那样，只把数据里面已有的字段恢复到还原出来的对象之中。所以把旧版的存档文件加载进来的时候，GameState 的构造函数会自动给缺失的 magic 参数提供默认值。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-12-21-31-16-6d7cc7277547b3206957899a1e5b1971-cee50.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 542px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 24.723247232472325%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsSAAALEgHS3X78AAABEElEQVQY03VQ226CUBDk//+nD21NKggNF7lKFKuAXCoIiFxarabpdM9Jm/SlD5M9c3Z3ZncFLa2gJSWUMIeyzWDuW5jFCdJLAi09QN0VkLcp5vsjnOYNzvEdi/76LwQ5zCCtY4irEGIQwSp7yCT+tGQ8xr3tY7ZJMCOD6Srixl73AW+4wut/8OctOPUIrz3DIVjNyF384Yb5oYNVDbDqgU9l03R2w2ovJHDDguCPnzxyg19Bab2DSquxJrPsoOcNbBJymQFFg07AVnUpzzjPkwmrUaJXuKcLlucvLswgTBYBpkEIpxpprRSPXgA9q6FmFYy8xoS4RpzdUNykeKATsLs+xwXudJv+W96jUa1RtPgGhDBpmGNtEfUAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 12 21 31 16" title="" data-src="/static/2023-10-12-21-31-16-6d7cc7277547b3206957899a1e5b1971-cee50.png" data-srcset="/static/2023-10-12-21-31-16-6d7cc7277547b3206957899a1e5b1971-6f8b2.png 200w,\n/static/2023-10-12-21-31-16-6d7cc7277547b3206957899a1e5b1971-fa663.png 400w,\n/static/2023-10-12-21-31-16-6d7cc7277547b3206957899a1e5b1971-cee50.png 542w" data-sizes="(max-width: 542px) 100vw, 542px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h3 id="用版本号标注同一个类的不同定义"><a href="#%E7%94%A8%E7%89%88%E6%9C%AC%E5%8F%B7%E6%A0%87%E6%B3%A8%E5%90%8C%E4%B8%80%E4%B8%AA%E7%B1%BB%E7%9A%84%E4%B8%8D%E5%90%8C%E5%AE%9A%E4%B9%89" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>用版本号标注同一个类的不同定义</h3>\n<p>有时我们要做的改动，是无法向后兼容的。例如，要把现有的 Python 对象之中的某些字段给删掉。这样一来，刚才那种给构造函数的参数指定默认值的做法就失效了。</p>\n<p>例如，我们现在觉得不应该限制玩家的游戏次数，而是应该允许他一直玩下去，于是我们想把 lives 字段删掉。这样的话，GameState 类里就没有 lives 字段了，而且构造函数也不需要对应的参数了。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-12-21-31-41-dd1ab0da70985dab9985665b2f5043cc-17038.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 463px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 21.598272138228943%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAIAAAABPYjBAAAACXBIWXMAAAsSAAALEgHS3X78AAAAvklEQVQI12WPfQuCMBjE/f5fKlLTZmTa7MV8d9NmU9OJSo2graB/guPhfnAP3CmbogYpWUV4cYxUP1HD3G0npx1h/3C7edeM7n3ed7PTjB8/CZSmlUaBA7dJZ2bXNa7VIFvFWA+RFuYAUz3MtSDfkhagm5mUelJuygYgurykVkGtolYge0LGD9NLfOoRkhVOgUMZQJXmJxam3sBh/5RXiPFPXqLHuPIDIy6MCKmXbHmO7Up0IWIIyIjo/8386w0K99L8n3PzJAAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 12 21 31 41" title="" data-src="/static/2023-10-12-21-31-41-dd1ab0da70985dab9985665b2f5043cc-17038.png" data-srcset="/static/2023-10-12-21-31-41-dd1ab0da70985dab9985665b2f5043cc-ebf63.png 200w,\n/static/2023-10-12-21-31-41-dd1ab0da70985dab9985665b2f5043cc-37c59.png 400w,\n/static/2023-10-12-21-31-41-dd1ab0da70985dab9985665b2f5043cc-17038.png 463w" data-sizes="(max-width: 463px) 100vw, 463px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>这样修改，会让注册之后所生成的旧版存档文件无法正确地反序列化。因为存档文件里面保存的数据是按照 lives 字段没有删除的那个 GameState 类生成的。把它还原回来的时候，会触发 unpickle<em>game</em>state 函数，进而触发现在这个 GameState 类的构造函数，可是这个构造函数已经没有用来接收 lives 字段的相应参数了。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-12-21-32-02-a0e8a04b6a882ceacc1e8b37d72f4e82-a3fce.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 515px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 19.611650485436893%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAIAAAABPYjBAAAACXBIWXMAAAsSAAALEgHS3X78AAAAuElEQVQI132OWQuCUBSE/f8/KcqH6qKmuStRWXld72IuVykyoWO9Bx/DMMM5jISidBMlJmnXZ7yNEnTJlLiEBN1yr3v9R1JjoueVXtZ2NbjN0xPjDHRi9IH+HcxMoD8PCnkwTGAkFdOFEy69g4aZUw1aSk3awRAtZUbZGEWN4gK2qJhoKVcwUROqF3d0zZSESHIYyeFp5R9tLtz6YbLO4r3Ne7i0mDCZMMoa2NMWnurF17Bul/E9aT9DftPgb3shkQAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 12 21 32 02" title="" data-src="/static/2023-10-12-21-32-02-a0e8a04b6a882ceacc1e8b37d72f4e82-a3fce.png" data-srcset="/static/2023-10-12-21-32-02-a0e8a04b6a882ceacc1e8b37d72f4e82-96d1c.png 200w,\n/static/2023-10-12-21-32-02-a0e8a04b6a882ceacc1e8b37d72f4e82-2b9d0.png 400w,\n/static/2023-10-12-21-32-02-a0e8a04b6a882ceacc1e8b37d72f4e82-a3fce.png 515w" data-sizes="(max-width: 515px) 100vw, 515px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>这个问题可以通过添加版本号（version）来解决。早前通过 copyreg 模块注册了负责对 GameState 对象做序列化处理的 pickle<em>game</em>state 函数。现在，修改这个函数的代码，让它把根据目前这种 GameState 类所定义的对象标注为第 2 版。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-12-21-32-16-5e8aca9f0dc27687e5d42fc868a6d50d-3e45f.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 371px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 22.371967654986523%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAAsSAAALEgHS3X78AAAA8klEQVQY0y2P626CQBSEef8nalNpFEEh0brcWpAVWMQq1ABW6UVtpmdXf0xO9uzJzDfa8G0FZ/0BK91gtBSwViXkbuBGsIsaRiLUfhRneGKvMJMCE3kbZRhGKdj+BP/zDO/wC4+mxpovsKbHwIvwHCYYL3PMty30kONh5mOSbVTAIwspuIaZlupWAkgzr/u5md2lBccL3PYbuhdDD0h+BFZ1MIjK5DnNHHb2jpdtg/muxYz+/MMZi30Pl2DC/g/B6YrgKHWBpnApRVWLBcZUyRY7ouKw+BoGVXWKisgzTInWKWtYNKX5gggNXqj3VFS06/APrHYdXbQul3AAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 12 21 32 16" title="" data-src="/static/2023-10-12-21-32-16-5e8aca9f0dc27687e5d42fc868a6d50d-3e45f.png" data-srcset="/static/2023-10-12-21-32-16-5e8aca9f0dc27687e5d42fc868a6d50d-84b18.png 200w,\n/static/2023-10-12-21-32-16-5e8aca9f0dc27687e5d42fc868a6d50d-3e45f.png 371w" data-sizes="(max-width: 371px) 100vw, 371px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>由于旧版的数据没有 version 参数，因此可以把那种版本视为第 1 版，并做相应的处理（也就是从 kwargs 里面删去’lives’），然后再将 kwargs 里面的键值对交给现在的 GameState 构造函数。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-12-21-32-32-3a885ad1693d013659cc6f9a298b5483-07522.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 346px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 29.190751445086704%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAIAAABM9SnKAAAACXBIWXMAAAsSAAALEgHS3X78AAABLklEQVQY0z2QCW+CQBCF+f+/SKwXiHKouMBuwQVWllMOoYBSq6bpGpMmL5OZZL6Zl8fNIF6RWA6ykY6Wh0B0yNINeR3xwFbDXHLDiYnnyJuYjuAQfo9Ej9r9w+rusH9wRjOg7i4HpynEkh9JmIKiW5F0tINz5K69aGEf+Z21PmYyiZcOYTsySczzsM1qjt1Al6dCM9GlIqaSS9ckVaNSjSstKld+sslb1pvNDdRXvWj1stOrno2svmAmo/m22pvkRQpJJC8UDsGGwXG1Tep90RnlxSh7cL6i6y+8POG/7TcMmgHUgxKc1CDRaD7ammPwOTYcLamYSZaLTFOF5nrRmV+3N8LEme0P7J9aWrE8lPCkZ7Vgv4JZOERw6cz21eQsHdMPiBe2P7UwM//+zPQH7ic1812H9ecAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 12 21 32 32" title="" data-src="/static/2023-10-12-21-32-32-3a885ad1693d013659cc6f9a298b5483-07522.png" data-srcset="/static/2023-10-12-21-32-32-3a885ad1693d013659cc6f9a298b5483-36166.png 200w,\n/static/2023-10-12-21-32-32-3a885ad1693d013659cc6f9a298b5483-07522.png 346w" data-sizes="(max-width: 346px) 100vw, 346px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>这样就可以正确地还原旧版数据了。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-12-21-32-43-92d4fcc47be3937eb8640e6844818bae-66417.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 441px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 35.147392290249435%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsSAAALEgHS3X78AAABa0lEQVQoz02R6U7CUBCF+/5PZKKEUiiLQoG2bKW1LC07CC0SEeLxzKiJPyZzc2f75oxRm61QCqawxjNUX1NUxlPY4Rxl+mI/Qjmc0ebobHP9q8Yp7ChhLERtskQlmtMStBn38huMOj+rUaoNTSaVhpEmNpdvfMco9MeoxUvaAsVeiPp0jedkh+bqiNY2g7PLaWd0jx/wsk8YNqlKo4mSyFSbzbvbs1KYbCjUxV6EJz+AyTwZZgUxyiSr8u2TSsikmXu6wmgtDnhJtkpQn67oU12vu39HfbJChYNkSDmYaLy9OREgRmO2RpO1Lsnc7KrNfhpyte7+gsHlC35204m98x0eg152U5PEvsQZk9X8/K5v/5fsvxkivDmIYBPf2WSwSVoijWjYILnQihfxRTtnTe0Yq/BQFo/UmG/QoYYFb6R1hsULyzH+iuVij+4QDot0xfVJ9dWhYaL6PrkDWNSzke7w4PjMW6KVHlT3by+k9cuWQfSCAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 12 21 32 43" title="" data-src="/static/2023-10-12-21-32-43-92d4fcc47be3937eb8640e6844818bae-66417.png" data-srcset="/static/2023-10-12-21-32-43-92d4fcc47be3937eb8640e6844818bae-d16fa.png 200w,\n/static/2023-10-12-21-32-43-92d4fcc47be3937eb8640e6844818bae-9fd5a.png 400w,\n/static/2023-10-12-21-32-43-92d4fcc47be3937eb8640e6844818bae-66417.png 441w" data-sizes="(max-width: 441px) 100vw, 441px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>以后如果要继续修改类的定义，那么依然可以套用这个方案。在 unpickle<em>game</em>state 函数里面，对旧版数据做出必要的修改，让这些数据符合新版的类所提出的要求，这样就可以把旧版数据还原成新版的对象了。</p>\n<h3 id="正确处理类名变化"><a href="#%E6%AD%A3%E7%A1%AE%E5%A4%84%E7%90%86%E7%B1%BB%E5%90%8D%E5%8F%98%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>正确处理类名变化</h3>\n<p>使用 pickle 模块的时候，还会碰到一个问题，就是类名会发生变化。在开发程序的过程中，我们需要重构代码，这时我们可能会把类的名称改掉，或者把它放到别的模块里面。这种情况需要谨慎处理，不然，利用 pickle 模块所编写的那些代码就有可能出现错误。</p>\n<p>例如，把 GameState 类的名称改为 BetterGameState，并把原来那个 GameState 的代码从程序里面彻底删掉。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-12-21-33-11-ea4f20e19f6bc3da96ba06dafec6ef71-93695.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 460px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 21.73913043478261%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAIAAAABPYjBAAAACXBIWXMAAAsSAAALEgHS3X78AAAAx0lEQVQI1yWPiwqCQBRE/f9/KsxXaVo+trC1Ldf1Ua5p5lZoBV0UhsswnGG4kpWWyzhXIiqHZzVK5ihSDnTuH9b5LWj7bSW8+uU17w0X7u0Jxq1fbiXcMZSQ+DplayalXdRqxIxzphOm4dhiXMVUJ6lTNFZWQbiiBTBmclVwbKYcvBQ8BtD++dMAPaUayRYh8XhnMr4IT3Zx33UfAHbii7oPKBgvTIKZyj3qBu3IFEyhIIfEzhv4ZYawEV/8tgfGf/TTzMSPGv59MdJNxgXnnwAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 12 21 33 11" title="" data-src="/static/2023-10-12-21-33-11-ea4f20e19f6bc3da96ba06dafec6ef71-93695.png" data-srcset="/static/2023-10-12-21-33-11-ea4f20e19f6bc3da96ba06dafec6ef71-ae711.png 200w,\n/static/2023-10-12-21-33-11-ea4f20e19f6bc3da96ba06dafec6ef71-f4267.png 400w,\n/static/2023-10-12-21-33-11-ea4f20e19f6bc3da96ba06dafec6ef71-93695.png 460w" data-sizes="(max-width: 460px) 100vw, 460px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>这个时候，如果想对原来的 GameState 数据做反序列化处理，而那份数据又是在没有经过 copyreg 注册的时候生成的，那么程序就会出错，因为它找不到 GameState 类。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-12-21-33-24-356518a52ad241e8b51487f4a8d5e2d3-ab2ac.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 531px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 21.092278719397363%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAAsSAAALEgHS3X78AAAAyUlEQVQY041Qyw6CQBDj/7/JGJFHMIoIaIJBBUERUJCXGpWkzs7BePTQtDud7cyuZMQ5jDjD5FhgvImgB0do4QlGlEHZxDCzGm77hlM//4I0paD5uYV9fXDBbV5fOD96SaECrLuedM+D2GevZ1/SgwSyF2Dk7SC2tS8d7PIO69IyL4ob8Y2GNjDzBlbRYZZVDLGIRb7oEWczryHJ6xAidOB40Hf0XD+G4kcMlTBc+cza9gB9n/IlbUt91Ds5nDFLK0yTEirVxDd9AGg1I0I6Z4IyAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 12 21 33 24" title="" data-src="/static/2023-10-12-21-33-24-356518a52ad241e8b51487f4a8d5e2d3-ab2ac.png" data-srcset="/static/2023-10-12-21-33-24-356518a52ad241e8b51487f4a8d5e2d3-a8ddc.png 200w,\n/static/2023-10-12-21-33-24-356518a52ad241e8b51487f4a8d5e2d3-0d4eb.png 400w,\n/static/2023-10-12-21-33-24-356518a52ad241e8b51487f4a8d5e2d3-ab2ac.png 531w" data-sizes="(max-width: 531px) 100vw, 531px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>之所以出现这个错误，是因为那种数据直接把类的名称（也就是 GameState）作为引入路径写在了里面。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-12-21-33-42-ec039245da93911b329205d184e74ced-1093f.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 553px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 19.710669077757686%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAIAAAABPYjBAAAACXBIWXMAAAsSAAALEgHS3X78AAAAxUlEQVQI1y2OawuCMBiF/f//p7QbOotu5jbdbFqmWYHWLKJZH8qg1woOD+cceC+am1/GWTHbn6ZZMdnmXNW8evOqbqTqnwn+8RWoFxA8uz1B2uJ4pWVFz3cCLCt8uhGpSKnAYNmoiVI15lvSywNLBZOwRUNhisTGXmfmMrbEBoWJHSZASyTQ2KsUfaMpEjtKUZSO4gPE+UHCMc1wme6yHuEdwgzs647X90MzWLccamBo2IBHwNbcs5axjv2uJ9oOHa528MIHgWHNWJHHQaQAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 12 21 33 42" title="" data-src="/static/2023-10-12-21-33-42-ec039245da93911b329205d184e74ced-1093f.png" data-srcset="/static/2023-10-12-21-33-42-ec039245da93911b329205d184e74ced-7baba.png 200w,\n/static/2023-10-12-21-33-42-ec039245da93911b329205d184e74ced-2a76e.png 400w,\n/static/2023-10-12-21-33-42-ec039245da93911b329205d184e74ced-1093f.png 553w" data-sizes="(max-width: 553px) 100vw, 553px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>这个问题还是可以用 copyreg 解决。如果我们先通过 copyreg.pickle 注册了负责执行 pickle 操作的函数，那么系统在把对象转换成序列化数据的时候，就不会将当前的类名作为引入路径写到数据里面了，而是会把那个函数所指定的 unpickle 函数（即 unpickle<em>game</em>state）作为引入路径写进去。所以，不管这个类将来改成什么名字，这份数据都可以通过 unpickle<em>game</em>state 还原，只要那个函数在还原的时候，使用的是正确的类名就行。这样相当于多了一个步骤，以前是直接根据类名还原，现在是先把还原任务交给 unpickle 函数，然后由那个函数去决定应该还原成哪个类的对象。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-12-21-34-06-6ac06555b5e8091cc69dba2020c7665d-6dd13.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 459px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 5.228758169934641%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAABCAYAAADeko4lAAAACXBIWXMAAAsSAAALEgHS3X78AAAAT0lEQVQI1x2LQQ6AIBAD/f+XTIiy6NELHmRFQCTEoz+oC6dmOu2wxIrpCNCcQFfG7CLIZ4zWgc4bWljt3DfNbe8HI73xj3CCsow1lP5v+QP+lUW6TSjEDgAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 12 21 34 06" title="" data-src="/static/2023-10-12-21-34-06-6ac06555b5e8091cc69dba2020c7665d-6dd13.png" data-srcset="/static/2023-10-12-21-34-06-6ac06555b5e8091cc69dba2020c7665d-fad05.png 200w,\n/static/2023-10-12-21-34-06-6ac06555b5e8091cc69dba2020c7665d-a671c.png 400w,\n/static/2023-10-12-21-34-06-6ac06555b5e8091cc69dba2020c7665d-6dd13.png 459w" data-sizes="(max-width: 459px) 100vw, 459px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>可以看到，如果先用 copyreg 注册，然后做序列化，那么写到数据里面的引入路径就不是 BetterGameState 这样的类名了，而是 unpickle<em>game</em>state 这样的 unpickle 函数名。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-12-21-34-25-28b4f49ca36d13aa7c8fc3c0d76b5002-c347e.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 555px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 30.99099099099099%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsSAAALEgHS3X78AAABGUlEQVQY032RWXOCQBCE+f8/KXJFAa+UKPchcogQApoySqpydmZXXuNDV+1szXzT2ytoSQltd8CibKGGKXSqVS+BGuyg+gmW1RFme8H62MN++4R1vi/BIMAkyiG7MbRtgXGYcdBi/4JJXGBWPGOa1XiqXwfgx10JZnvG5tRj1V1hkovV4MZ7B5fb/5B+4Vy/YV++/tewTDCyCnpaYZqTk7yBQW646I5FoacH7pDV+iAjvfWwmdm+wbzsKLIODoEFlptkh5CdiLLbYmQFVAeQ6Sw5IR7WHo9A9mLeI9kRj2e08TCyfYiWD4lmGHBZn25AhQbY0CN9hELNY7pjtUJQkcEJPI6oj6AiLZfciOfLPmxWNPxl7Dzft/gDOHatEFSs37QAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 12 21 34 25" title="" data-src="/static/2023-10-12-21-34-25-28b4f49ca36d13aa7c8fc3c0d76b5002-c347e.png" data-srcset="/static/2023-10-12-21-34-25-28b4f49ca36d13aa7c8fc3c0d76b5002-58c7f.png 200w,\n/static/2023-10-12-21-34-25-28b4f49ca36d13aa7c8fc3c0d76b5002-5d49f.png 400w,\n/static/2023-10-12-21-34-25-28b4f49ca36d13aa7c8fc3c0d76b5002-c347e.png 555w" data-sizes="(max-width: 555px) 100vw, 555px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>只有一个地方要注意，就是负责 unpickle 的 unpickle<em>game</em>state 函数所在模块的路径不能变，因为这个函数名已经写到了序列化之后的数据里面，将来反序列化的时候，系统要先找到这个函数，然后才能通过它正确地还原对象。</p>\n<h3 id="总结-64"><a href="#%E6%80%BB%E7%BB%93-64" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>Python 内置的 pickle 模块，只适合用来在彼此信任的程序之间传递数据，以实现对象的序列化与反序列化功能。</li>\n<li>如果对象所在的这个类发生了变化（例如增加或删除了某些属性），那么程序在还原旧版数据的时候，可能会出现错误。</li>\n<li>把内置的 copyreg 模块与 pickle 模块搭配起来使用，可以让新版的程序兼容旧版的序列化数据。</li>\n</ol>\n<h2 id="第-69-条：在需要准确计算的场合，用-decimal-表示相应的数值"><a href="#%E7%AC%AC-69-%E6%9D%A1%EF%BC%9A%E5%9C%A8%E9%9C%80%E8%A6%81%E5%87%86%E7%A1%AE%E8%AE%A1%E7%AE%97%E7%9A%84%E5%9C%BA%E5%90%88%EF%BC%8C%E7%94%A8-decimal-%E8%A1%A8%E7%A4%BA%E7%9B%B8%E5%BA%94%E7%9A%84%E6%95%B0%E5%80%BC" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 69 条：在需要准确计算的场合，用 decimal 表示相应的数值</h2>\n<p>Python 语言很擅长操纵各种数值。它的整数类型实际上可以表示任意尺寸的整型数据，它的双精度浮点数类型遵循 IEEE 754 规范。另外，Python 还提供了标准的复数类型，用来表示虚数。尽管有这么多类型，但还是没办法把每种情况都覆盖到。</p>\n<p>例如，我们要给国际长途电话计费。通话时间用分和秒来表示，这项数据是已知的（例如 3 分 42 秒）。通话费率也是固定的，例如从美国打给南极洲的电话，每分钟 1.45 美元。现在要计算这次通话的具体费用。</p>\n<p>有人可能觉得应该用浮点数来计算。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-15-17-48-01-dcbd1cc6de0e4e9f55783e0ba938149f-4493b.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 320px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 53.75%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABxUlEQVQoz21SiW6bQBTk/7+lqpKqcaOkVcrhAwjXwi5HbbAJ5gYbvNiNr/TZTtsorTRazdt9844B5htye4qppo2Rd0q6kKOUxe7AnzvdEbc7q90C8GpPVnsI34Hpj58EL0QFRWmr542W1kZSK1GBqrVRtlbzk7R7o6JGBfwZQ6EzLpy5U62vOrlXrQ8PwmAcmTk1y9VwHLKme/eI9HiBio73Qs71YRay2pF2S9odcBs6Dycx/yPU00aLF1qyVKJSDFIja1FJUU7VuFaTWo1qaZqJQWzWnVlvrIIOJ3Or7Bjo+R17uOpQRo10+WB5XyR94AW42pjl+lZGt7LRk40bUfvUF6UwhzQ9qa/7kpEsGTHMh5NI9OdwsnbAuVOW+FJYOPSAG1jv+TKqTff4MnOzhRsIgTNa1shPmTIvhHHIu1MQA5HmFTyfXGleHcK/3bLeGgaru/RA6N6mB7s7QOh0B6gNPSHjnPTX5HdgWOyjvHPXR8BZeXTWLwD3DzYvUPr/Yi1Z8N7sMSxYEnB2IHgzjviccyJgAUBwpnqyhJ/k7Xd+FYuz/EqQ7jX8kRteC1JPVE+kL92M1Ct+BDefB/IoiGGXf8W/AHgbQ8B8CA14AAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 15 17 48 01" title="" data-src="/static/2023-10-15-17-48-01-dcbd1cc6de0e4e9f55783e0ba938149f-4493b.png" data-srcset="/static/2023-10-15-17-48-01-dcbd1cc6de0e4e9f55783e0ba938149f-102e5.png 200w,\n/static/2023-10-15-17-48-01-dcbd1cc6de0e4e9f55783e0ba938149f-4493b.png 320w" data-sizes="(max-width: 320px) 100vw, 320px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>这个答案比正确答案（5.365）少了 0.000000000000001，这是因为浮点数必须表示成 IEEE 754 格式，所以采用浮点数算出的结果可能跟实际结果稍有偏差。另外，如果计费结果需要四舍五入到分位（也就是精确到 0.01 元，或者说精确到小数点后第二位），那么按照正确答案 5.365 来算，应该向上化成 5.37 美元。但如果按照刚才给出的值做四舍五入，那么小数点后第三位是 4，因此向下化成了 5.36 美元。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-15-17-48-34-1aa9922323969b808deec49cc3341e04-1cf20.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 274px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 29.197080291970806%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAIAAABM9SnKAAAACXBIWXMAAAsSAAALEgHS3X78AAAA2klEQVQY05WPWWvCUBCF7///MX3oWwsudctqpc1dvOLNNhqbxKZkK8Qk4FSLj6XCx+HMcmCG2JAgZhDbkGpeZEFihckqyixIZ1vQ3MjwP1CnMmCftSw7M0wWaofKi5ZoG5+l+Vx6pgtDKg0FQ2f9wjZToZ5XdPDGn5bvjwsb1XB367ydCDWiciJdmp/IXO11BU72zeuOl62oel6h6UT1y6X5Y2jesOKEXEs0BE/VvYh+NaLsWYHj5rb0B/SiBP+x4fgwmFkQi7r/T/IG0YNYh+PYka+HDA9m94TPCrk/a6GD5IcAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 15 17 48 34" title="" data-src="/static/2023-10-15-17-48-34-1aa9922323969b808deec49cc3341e04-1cf20.png" data-srcset="/static/2023-10-15-17-48-34-1aa9922323969b808deec49cc3341e04-85d14.png 200w,\n/static/2023-10-15-17-48-34-1aa9922323969b808deec49cc3341e04-1cf20.png 274w" data-sizes="(max-width: 274px) 100vw, 274px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>这样的计算应该用 Python 内置的 decimal 模块所提供的 Decimal 类来做。这个类默认支持 28 位小数，如果有必要，还可以调得更高。改用这个类之后，就不会出现由于 IEEE 754 浮点数而造成的偏差了。另外，这种数值所支持的舍入方式，也比浮点数丰富可控。</p>\n<p>下面，用 Decimal 来重新计算通话费用，这次的结果是准确的，没有误差。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-15-17-49-11-5d9f437a9b62b4957bf28fc6f80f30e2-5b0c5.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 433px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 54.04157043879907%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABsUlEQVQoz41R2Y6iUBDl//9mnjrpsV0QVFxYLnDZBEQ2EUS5gBmQnkyBnU7PS6eTk0otnEudU9TccGm859zoVcBvSP/Nq1N1vwmyKTJnsrU6BIztv3Aiaxxe1vzKDfX6r1I0KmkBFK4eKoGiQfkdl61y+6MWjV6/y/kdgEkLgBH0pazqpwPtg8wnt02YiWmpFi3jhHx83YSXhRujhEhpJSTFLrz00/KBqw7wH5m1jiOEF3tfOpEJdubG4U02XkV1G6ZrL1060cqJOO+ESQf/F84F7KyQVnmSaWzPTXck4jEy5KwWTgUon5uHqWLSmsMdTpwTMoar5vdtkNGarVwbrexwAXIeFGMdZ5qzjXKddMzen8jmLsxRWi/tYIrtiWKNJF1KCB9dx6JO6+5Ms/vXNXuKLYoPLrsg3YHshKy9ZOXEoBCXD4iwpHAm/LmQB8NAP3gmpkQ8E3SpIac4NxbjG2t7C/s4QQZr+VLSkwFa1T0BOSjEQ9J36nc8+EehrER5/ayH+OFnf0zwZohfO58lJNTC9jk/gR3g1MrwtUKar/f4BtTSC8aq8Ytda2X3Q84n/gHhP0cssTcbnQAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 15 17 49 11" title="" data-src="/static/2023-10-15-17-49-11-5d9f437a9b62b4957bf28fc6f80f30e2-5b0c5.png" data-srcset="/static/2023-10-15-17-49-11-5d9f437a9b62b4957bf28fc6f80f30e2-59b76.png 200w,\n/static/2023-10-15-17-49-11-5d9f437a9b62b4957bf28fc6f80f30e2-4330a.png 400w,\n/static/2023-10-15-17-49-11-5d9f437a9b62b4957bf28fc6f80f30e2-5b0c5.png 433w" data-sizes="(max-width: 433px) 100vw, 433px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>Decimal 的初始值可以用两种办法来指定。第一种，是把含有数值的 str 字符串传给 Decimal 的构造函数，这样做不会让字符串里面的数值由于 Python 本身的浮点数机制而出现偏差。第二种，是直接把 float 或 int 实例传给构造函数。通过下面这段代码，我们可以看到，这两种办法在某些小数上会产生不同的效果。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-15-17-49-38-519b1e235cafda00bd155df707c5d501-3ab7f.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 667px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 23.088455772113942%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAIAAADKYVtkAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAuUlEQVQY032N2w6CMBBE+/+fpEBAeBAQTGhpKQoW72JULkZuPtiiIT6RnEx2Z2azwN6eZ3itk1gPYpMdncPV2hzsXUrKDhftOGCxvxmUGWGiU2YmZ2ub2uzi3V9+2flFOw7gPfx841+VK38oforj3vyPeobjDszZCT2qnhpyzSqY1ShroBgqlDfc5M4XNJCLFSgekVwoLZHsIq5TB2okUhBV8Vr2iOpTCRItiCaup+FQxdGMxiL1V5wPsIYI35pCSWQAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 15 17 49 38" title="" data-src="/static/2023-10-15-17-49-38-519b1e235cafda00bd155df707c5d501-3ab7f.png" data-srcset="/static/2023-10-15-17-49-38-519b1e235cafda00bd155df707c5d501-a55cc.png 200w,\n/static/2023-10-15-17-49-38-519b1e235cafda00bd155df707c5d501-b842a.png 400w,\n/static/2023-10-15-17-49-38-519b1e235cafda00bd155df707c5d501-3ab7f.png 667w" data-sizes="(max-width: 667px) 100vw, 667px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>当然，对于整数来说，无论是放在字符串里面传，还是直接传给 Decimal 的构造函数，都不会有偏差。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-15-17-50-24-c8d6145e90092be8940a7f504577aa27-e9b6c.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 155px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 96.12903225806451%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAIAAAAf7rriAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACf0lEQVQ4y42TWW/aQBSF+f9S1Yc89iWtmrRqiZKGJaRAEIvx7hjjsWdYbTD75gWDwQsdJ0qfLR2Nrsb+5HPPvU4BJ4CHSHVD5F3ea3SMOm4EnbC981rbo+wE6iFqm2dgnqHtA9OPL82j4gSp9tKleiNKM0jNqKMBp03Ijk6oPXY0K4tqrWuw43WGoJ946ZmXck2K0Rb1/rjEia/TXYpG2q9cIUMxwnRRVVBJkLIEWxbaFYDytKidLuJ0d5N9qsjoZ6ny/THDDGdGeMkRdLM3SQmzLa3PgOVDN8JOsCvFDrBhaedR+kp2/MHx0tn78uogb73W+oBfAKbX6I8V85RC+xC5ATRPytrljQ0usNqrPdydGr0JP9ky+oLs6i1jSfTG5HCOnEC2ztANgX1OCf3ZXan5h+SJrl4UlQLXuq+TeVp4kZSCIP0uVh8aVJ5irx+yBVa8r5HcZInTlS0vhpnBJM9I1HiJLB9/mdVmrD6nh1NGmxZFlRstOH3e7I5rcFgB3WcBgK0LHB+TMayaAbRDbAb7RHaAJ4SlWiG+xEEgB88sQns8vAu0A8WKE5HfyBgGti/jJk0PWCc51vldb4/9j9p/Pz+K/7Djd70LPITKPojPD0tJlBKm62IbVkCngQYFUW2t3XiNrGQwpy8fqdZfvl2VlAwpSMs9Ti4prDih5kd9DyscehGyzqqZ2DZY758I9r5Jl2V0VyWklaXEOSeDyZ5xdX2ba7I/8uVPX742hxPkXnDsCW2fwe7Azy1hbjOjFdgcYPKeu3YAtkf83+F9fl3YSrzbiXtmtPnVt3S6XEu/VD9f376ONsgJk9rmZpvHOluXYJ7hb7IlfrCEblL4H/c07tlAXRZzAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 15 17 50 24" title="" data-src="/static/2023-10-15-17-50-24-c8d6145e90092be8940a7f504577aa27-e9b6c.png" data-srcset="/static/2023-10-15-17-50-24-c8d6145e90092be8940a7f504577aa27-e9b6c.png 155w" data-sizes="(max-width: 155px) 100vw, 155px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>所以，如果你想要的是准确答案，那么应该使用 str 字符串来构造 Decimal，这种 decimal 的精确度可能比你需要的更高，但无论如何，都比刚一开始就出现偏差要好。</p>\n<p>回到计算话费的那个例子，假如我们这次的费率比较低（例如托莱多与底特律这种距离较近的情况），而且通话时间很短，那我们看看，在每分钟 0.05 美元的情况下，通话 5 秒钟总费用是多少。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-15-17-50-43-d38892a42155dd401cfbc9a49371e033-5a8c3.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 506px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 35.17786561264822%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABM0lEQVQY00WQCW+CQBCF+f+/qGpVghZ7sIDLcgvSVVhQ5NC14pV0wKYmX17ezCabN0+Y+nTqUau+vPlUJL7sUcmJUJLPlrEcrpVkR+ozYO4vQGs6HkthbAaSHYywg9a5Ghd9lcAoOeHsO0Fxoae1zW/Oz906XC1+s4/3Fn5/GGFMfNH0vmgqB8kHzebZXqFb0fJRUqqsEp0Qok3cCG/552ojueFkQScQFtSLBHiQF2s5oK+6PcKuykrJjYaGizec1I2SFgorESuN4oRzrrACpRVKSy2r1LQUYEXK03zLlXinpRXOj0qSa1kNh1mHZ07wj9it8tYDwmzJ4Jt2hqsO0Mq5M9eukoZUzVM7uub++hOm/mqInZHhD3Srh3AfGT0V91TjpVOgrwFkoJtg3iMGKf7L/wW5I26aDmfNUAAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 15 17 50 43" title="" data-src="/static/2023-10-15-17-50-43-d38892a42155dd401cfbc9a49371e033-5a8c3.png" data-srcset="/static/2023-10-15-17-50-43-d38892a42155dd401cfbc9a49371e033-67543.png 200w,\n/static/2023-10-15-17-50-43-d38892a42155dd401cfbc9a49371e033-c323a.png 400w,\n/static/2023-10-15-17-50-43-d38892a42155dd401cfbc9a49371e033-5a8c3.png 506w" data-sizes="(max-width: 506px) 100vw, 506px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>这个结果很接近 0。如果四舍五入到小数点后第二位，那么结果就是 0.00 美元。这显然不是我们想要的效果。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-15-17-51-00-046727d0fdfa73989a6e1488558ace62-43b87.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 330px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 27.878787878787882%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAIAAABM9SnKAAAACXBIWXMAAAsSAAALEgHS3X78AAAA50lEQVQY05WM4U6DMBRG+/5v4huYmLDJ3GAMooSNtpQOKJ2AyMxWyhQpiBrN9k+Tk5vv3Nz7AZvlS7qztrtFlBoxt+LMIKnu0zuSTLxg6pGJ61usdHh1C+kURUZcwFqZIZvhCDzke4sVNivMOFvx0gz5nKbj/5wwzcU393Bc2ux5EfKZT3UYGUnuVY2TPJkkBUgOUPaoVlB0YyWue9T0WPZYqPA0kFOPpPKP70iooBmCT+3gocVf90BH1C0FrLv14e2CY/ubN+f5R8cJVrwyttn65XUj2tH/BdBgeHWtOY97KNV339/5AKMDQJbcXlpHAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 15 17 51 00" title="" data-src="/static/2023-10-15-17-51-00-046727d0fdfa73989a6e1488558ace62-43b87.png" data-srcset="/static/2023-10-15-17-51-00-046727d0fdfa73989a6e1488558ace62-12832.png 200w,\n/static/2023-10-15-17-51-00-046727d0fdfa73989a6e1488558ace62-43b87.png 330w" data-sizes="(max-width: 330px) 100vw, 330px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>Decimal 类提供了 quantize 函数，可以根据指定的舍入方式把数值调整到某一位。首先用前面那个数值比较大的例子试试看，我们把计费结果向上调整（round up）到小数点后第二位。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-15-17-51-36-6941d1b1f7ff2668552d14ffa7cb1965-3769f.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 727px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 22.833562585969737%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAIAAADKYVtkAAAACXBIWXMAAAsSAAALEgHS3X78AAAA7ElEQVQY0z2OjU6DMBRGef+HUjcFBboON+iwExb+yiiFQgcqMBYvWTQ5ufl6c7/0aHYq9CBZ02iTy7cTw3n9GqYP7ocexJirQz97l+kO6SZ4ku4K0/+6QdAQq53yQtQI8110KJeO6HDR4rPERbM9N06ptrzdVT0srZSjrLJibgSZnQltRT7XfmjQ+GlPn/3To0uNY/RCIwN0SLDyjjqNUCZ2NZQbKCBWWUlpxtxmQiNqIu24l98u0AxeM7jyx/sL8CEAmSza10MH2vOi3c+QNSPMzITjXJpRAWKgvWE1nHpqXIDOf77TDgsKGH8BX3AKHaR4PpsAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 15 17 51 36" title="" data-src="/static/2023-10-15-17-51-36-6941d1b1f7ff2668552d14ffa7cb1965-3769f.png" data-srcset="/static/2023-10-15-17-51-36-6941d1b1f7ff2668552d14ffa7cb1965-0d072.png 200w,\n/static/2023-10-15-17-51-36-6941d1b1f7ff2668552d14ffa7cb1965-99b2f.png 400w,\n/static/2023-10-15-17-51-36-6941d1b1f7ff2668552d14ffa7cb1965-3769f.png 727w" data-sizes="(max-width: 727px) 100vw, 727px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>对于刚才那种数值很小的情况来说，quantize 方法同样可以正确地调整。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-15-17-52-02-3fa2fb4db6792e2bf96d606f34de48dd-0f51d.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 586px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 24.91467576791809%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAIAAADKYVtkAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABBElEQVQY00WQ3W6CQBCFef+XqdU0jekFILAIu6JFEIFltSw/RUBrQUqbVjr2psnJyXdmzsVkBJVy2Yskj25OvRpyLeKYV2oYm7yQPaYEsc5S0QlmHpMcOt/lc5apwY7wg122gl1fnqv25nW7qppV2djHDgAiAKycc0+SSt5Q0aWSG4pr/2np6pQjmggkLTEvzOSgv+SIpUq4X+QnjXKDFySv4RDr9WjlNU5LfZ+pNEYsgYJz/nTfv4Rl8eY130E/bC8//sfg9wM4xAC4uwL43f/kL16huW1vEsYKnmL70bQRyx4Ma0rWYw2PFH2CCOhupkOcoMVIMe5VA0B0mBYm8BTRjX4BK60BGiF47fkAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 15 17 52 02" title="" data-src="/static/2023-10-15-17-52-02-3fa2fb4db6792e2bf96d606f34de48dd-0f51d.png" data-srcset="/static/2023-10-15-17-52-02-3fa2fb4db6792e2bf96d606f34de48dd-e7e34.png 200w,\n/static/2023-10-15-17-52-02-3fa2fb4db6792e2bf96d606f34de48dd-15827.png 400w,\n/static/2023-10-15-17-52-02-3fa2fb4db6792e2bf96d606f34de48dd-0f51d.png 586w" data-sizes="(max-width: 586px) 100vw, 586px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>Decimal 可以很好地应对小数点后面数位有限的值（也就是定点数，fixed point number）。但对于小数位无限的值（例如 1/3）来说，依然会有误差。如果想表示精度不受限的有理数，那么可以考虑使用内置的 fractions 模块里面的 Fraction 类。</p>\n<h3 id="总结-65"><a href="#%E6%80%BB%E7%BB%93-65" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>每一种数值几乎都可以用 Python 内置的某个类型，或者内置模块之中的某个类表示出来。</li>\n<li>在精度要求较高且需要控制舍入方式的场合（例如在计算费用的时候），可以考虑使用 Decimal 类。</li>\n<li>用小数构造 Decimal 时，如果想保证取值准确，那么一定要把这个数放在 str 字符串里面传递，而不要直接传过去，那样可能有误差。</li>\n</ol>\n<h2 id="第-70-条：先分析性能，然后再优化"><a href="#%E7%AC%AC-70-%E6%9D%A1%EF%BC%9A%E5%85%88%E5%88%86%E6%9E%90%E6%80%A7%E8%83%BD%EF%BC%8C%E7%84%B6%E5%90%8E%E5%86%8D%E4%BC%98%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 70 条：先分析性能，然后再优化</h2>\n<p>Python 的动态机制，让我们很难预判程序在运行时的性能。有些操作，看上去似乎比较慢，但实际执行起来却很快（例如操纵字符串，使用生成器等）；还有一些操作，看上去似乎比较快，但实际执行起来却很慢（例如访问属性，调用函数等）。让 Python 程序速度变慢的原因，有时很难观察出来。</p>\n<p>所以，最好不要凭感觉去判断，而是应该先获得具体的测评数据，然后再决定怎么优化。Python 内置了 profiler 模块，可以找到程序里面占总执行时间比例最高的一部分，这样的话，我们就可以专心优化这部分代码，而不用执着于对程序性能影响不大的那些地方（因为你把同样的精力投入到那些地方，产生的提速效果不会太好）。</p>\n<p>例如，我们要查明下面这个算法为什么运行得比较慢。首先把算法所在的函数定义出来。这个函数采用插入排序法（insertion sort）对 data 列表之中的元素排序。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-16-10-24-10-d89df0d12018d93b8107851e7de4ac2a-97a6d.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 316px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 31.962025316455694%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsSAAALEgHS3X78AAABP0lEQVQY02WRbVeCQBCF/f//qCRfCIsQBQQRFZQQUsF30KNl3e5ystM5fRh2mZ159s7dylMQQwkiGFmBpjeFOk3QCmZQ/AhqOMdLuIAyCplLULW9slYZR7C3Z9iHd/T2F/RuK6PSjlfoLHYw0wOk3hDyMMTj6BXaLINMaJMwUaO/baBMEqjRkpGWwL+gX6BTXOEUn2gnK9QIfBaKCbKyA/T5huAl+vkHzO0JDgF9UZ9fCbv8g5VA8bHZIJpljmxlOWqOz/2E4JjK1mhTrWQOcGf00eU07umrHLcM9ooLxKUiKjcfxIFLpWIvOWM03KAc11xs8WAP0RgEtMSDzJzkjNDkf4sWGBRwbw1Y76NqeT8KCe1wROGRFqc0fgaNXtXdMR/KR53N5rqAnu7R5dplrbU5MneERS+NVQ6D+c5yh2/rxrEepQQMZAAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 16 10 24 10" title="" data-src="/static/2023-10-16-10-24-10-d89df0d12018d93b8107851e7de4ac2a-97a6d.png" data-srcset="/static/2023-10-16-10-24-10-d89df0d12018d93b8107851e7de4ac2a-c65dc.png 200w,\n/static/2023-10-16-10-24-10-d89df0d12018d93b8107851e7de4ac2a-97a6d.png 316w" data-sizes="(max-width: 316px) 100vw, 316px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>插入排序的关键之处在于，找到每个元素应该插到什么位置，而这需要由 insertion<em>sort 所调用的 insert</em>value 函数负责。下面，我们先用一种效率极低的办法来实现这个函数，也就是对已经排好的这一部分数据（即 array）做线性扫描，直至找到应该插入 value 的地方为止。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-16-10-24-20-9daffc316ad089a4a7317e199e6abb18-238a9.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 364px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 32.69230769230769%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsSAAALEgHS3X78AAABX0lEQVQoz3VR2XKCQBDk//8nb9EgiihqVBYPxItLRbxFy8Qknd4tzVseuoatmenpbjTTD/G+2MPw5iiPAjSjDOYkRsUPYI4jlFklKpMIzu4Ka7aAPpgoiO0F/fyb+PqrWmeToxamKHHADtew4w2HpzBGcyLAq/BQIbFEa7mDNU3U4dJwyvkV6vMlezGPx6gFK2guWdvZGe31EV2S16M1dA5LhTUuFF2PgykE1VW5bHg8xl43O6GdHmAnGeoUYbJXi9fQnOMHxOkOSdyhhWa6R3kcKhXSuuHNlJoWYykxFr03of0E3e2VQnJ0NhcIcvSvP4pDET4hTp+q0VjsHjmNYQULlaHeHytL1jylupwOQh6a4a3no7k6qF3ncIOmPiQhHxLyLS8bXDCpVGYm9je4nHHZc893NS+rVCTx5JBVZWjOEmVHXqzSzovdRkEMUeQP0fs+bfooOAM0mJV4EP6HX6Oq+BdNhV5bAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 16 10 24 20" title="" data-src="/static/2023-10-16-10-24-20-9daffc316ad089a4a7317e199e6abb18-238a9.png" data-srcset="/static/2023-10-16-10-24-20-9daffc316ad089a4a7317e199e6abb18-e532a.png 200w,\n/static/2023-10-16-10-24-20-9daffc316ad089a4a7317e199e6abb18-238a9.png 364w" data-sizes="(max-width: 364px) 100vw, 364px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>为了测评 insertion<em>sort 与 insert</em>value，我们创建一套随机的数据，并把这套数据放在 data 里面。然后，定义一个负责测试的 test 函数，并把它传给 profiler。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-16-10-24-35-d848b28c1b02df7b5281932899a30047-d80b6.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 492px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 19.715447154471548%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAAsSAAALEgHS3X78AAAAz0lEQVQY04VP2RLBQBDM//8TQbmthByOEEeJiEWIVcpV1XpThUcPXT29sz0zbYj4gPZ6j/oygTkM0YwkavM12tEOLaI0nlPHcM8PONn9Lwxrp2DtFboyg8uHfnqFTe2cbvAury/0QFc9c9On9tSv72lNNszBFJVggfoiRnUWocKLqtTd5AQRpxCbI5FSZxDJET6NtlR5X6do0NdcSXSYssGURlkPmK7Q46VFP0DBGeUfi1xk+hOUhmTW5UGIghewDmFvMzhMolMJvZiw5DnnN3xfIehLaKLPAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 16 10 24 35" title="" data-src="/static/2023-10-16-10-24-35-d848b28c1b02df7b5281932899a30047-d80b6.png" data-srcset="/static/2023-10-16-10-24-35-d848b28c1b02df7b5281932899a30047-3e95a.png 200w,\n/static/2023-10-16-10-24-35-d848b28c1b02df7b5281932899a30047-11c87.png 400w,\n/static/2023-10-16-10-24-35-d848b28c1b02df7b5281932899a30047-d80b6.png 492w" data-sizes="(max-width: 492px) 100vw, 492px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>Python 内置了两种 profiler，一种是由 profile 模块提供的纯 Python 版本，还有一种是由 cProfile 模块提供的 C 扩展版本。这个版本比纯 Python 版要好，因为它在执行测评的过程中，对受测程序的影响比较小，测评结果更加准确。相反，纯 Python 版本的开销比较大，会令测评结果有所偏差。</p>\n<blockquote>\n<p>分析 Python 程序的性能之前，一定要提醒自己注意，别把访问外部系统的那些代码，与核心代码混在一起测。例如，访问网络或磁盘资源的那些函数就有可能需要调用某些底层机制，而那些机制的运作速度比较慢，从而对程序的执行时间造成很大影响。另外，如果程序把这些访问速度较慢的资源缓存了起来，那么在开始分析性能之前，一定要先将缓存预热（也就是要把里面的内容提前配置好）。</p>\n</blockquote>\n<p>下面，从 cProfile 模块里构造一个 Profile 对象，并通过 runcall 方法运行刚才定义的 test 函数。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-16-10-25-05-e59ca4907d499c4759715eb45babd9e1-34a30.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 256px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 32.8125%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsSAAALEgHS3X78AAABeElEQVQoz1VR2XaCUAzk/7/IVqtFwKWWquwqyKIgbnVfatXpgL70YU5I7pBMJoI4CCA6Hr7SNUp6H+Wug4o5QNngt+5AtIfQFntGFxW+S26IWhCjTX5B1SD1AryoOqR+iELXhFAfTaEMInySoHgx1PECUpYnSzTjBRp+Am19gjKMOWQAxY/RYl1bHNAkt8Z/auEE3fkOsjuCYJ0A5wzYx0e0DnfYhLm/wjre85p5uKHHmMF+co3t5cHhm7m/5bnNKLTGc8icLg3HUIKEyr7R5ora6szJKRWN8RFOIXLVepSikYG87uoEbfNDnJ/xASH3y+yj6o1QYhSdgPL30JdHrjRnPkSxY+G9H0Am57Vt0ccIxuYCY3fNm+hU9wAbVns+G9F8x0fFcFHthehMt5Dpo2gyt30o9OYt88+LULZcFDXyLQ91f5Kv/U9hdrFamORXbnLFBtGebXnJlMcJIfN6dVqi0opmPKPKiIcYsVmCFmvG7jdfW8+UEn+8W/bJJDuu1AAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 16 10 25 05" title="" data-src="/static/2023-10-16-10-25-05-e59ca4907d499c4759715eb45babd9e1-34a30.png" data-srcset="/static/2023-10-16-10-25-05-e59ca4907d499c4759715eb45babd9e1-b25ce.png 200w,\n/static/2023-10-16-10-25-05-e59ca4907d499c4759715eb45babd9e1-34a30.png 256w" data-sizes="(max-width: 256px) 100vw, 256px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>运行完 test 函数后，用内置的 pstats 模块与里面的 Stats 类来统计结果。Stats 对象提供了各种方法，通过这些方法我们可以只把自己关注的那部分测评信息打印出来。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-16-10-25-29-9acdec3c7bb71114368f1c5b790f4022-1cf20.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 274px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 45.25547445255475%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsSAAALEgHS3X78AAABxUlEQVQoz1VSaVfiQBDM//9HvgWCgQSCHEIg931wZlFEEVx3a2sm7/n0w7ye7k6qq6pHMcst+lEOIyowWT+h60boBynuvZT5EWPWNDfGIClhZGvMdif0mOt+Cs3PMX96h/XygcXpJo8y254wzLbQoxIPRQ3ViaEFeQNY/pYAXSeEHpcYFXvM6ldoIftuwljg8Xj5AhRRcS7/4F0B7wbYvDvvgHNpcvcqaoy3Jhe95fmPvPsfzXffwSTDYb6X0+6dCGZ5wGP9hmFxQNsOWI+lHYJhj4xVOyT7hHlEBTHGmyMHfH7JlYAm5XZWIdqrACOCT/cnDFhT7agZ5CX4ZdnN3c8wYd/MdxD/TevzD/+kZGG0AGtbHkbZBr0g41Iy6PRJMFLJxkgqWVPJevF8beyg/NXbX2nB8vVTHkswNLIK7aWPDgFNgg9ikQfoUep4fUBn6cm+xmWZ+Zpng7uZjS5JdCm7w96AL0QPMxh5BWVM33QW+tzstKrJcsdmAYNbFdsfphvZMzhISB2y/8BtC//EC5jsnjE9vMg45wtQ9LRCa+GiNXfkW2uRqRig8j1qnCo8bFnsU26HrIx0C1tIFTKF3PO3SA//A1j5hdzayGrVAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 16 10 25 29" title="" data-src="/static/2023-10-16-10-25-29-9acdec3c7bb71114368f1c5b790f4022-1cf20.png" data-srcset="/static/2023-10-16-10-25-29-9acdec3c7bb71114368f1c5b790f4022-85d14.png 200w,\n/static/2023-10-16-10-25-29-9acdec3c7bb71114368f1c5b790f4022-1cf20.png 274w" data-sizes="(max-width: 274px) 100vw, 274px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>print_stats 方法输出了一张表格，其中每一行都表示一个函数的执行情况。这些样本，都是在 profiler 激活之后才开始采集的，或者说是在执行 profiler.runcall(test)的过程中采集的。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-16-10-25-48-6abd6315b0937332791c8169de052d5e-ae2b8.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 569px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 28.646748681898064%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsSAAALEgHS3X78AAABKklEQVQY03WQWXOCQBCE+f+/Jy9WUho0XqgIEdTglXAYAcGIRypXdXoHk5dUHrpmB2a/6W3NPX2h97xDJ0zRW2fob3asOQbJHiZlRFt0w4RKcb9/+1ejizSDkE6QEJrLRSMiOMrYZzJo787UK6z8jFHxjtHh46/4/QesdQkrXdEdoQqseuVwEO9hZScM00KqmRSlc/bqbMorCln4CzQvw81lAN1bCbTqPBByQN17RHMVoePHaPBcm8xFDc7dWC7npjAYhclZ9/gpbrXaZCH5tP0Nqu5c4FddE3Z2hj5bMY4Y7acNKkMHFQUZe7Lw2h5D3a05HmPKSsc0p6kNg/gFxjqlywh2fsItXVjbI3tfojCY7d3MR326RHMRoLUIpfaj8l8v3EInvMVXfgN4rrDXn4RotwAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 16 10 25 48" title="" data-src="/static/2023-10-16-10-25-48-6abd6315b0937332791c8169de052d5e-ae2b8.png" data-srcset="/static/2023-10-16-10-25-48-6abd6315b0937332791c8169de052d5e-a301e.png 200w,\n/static/2023-10-16-10-25-48-6abd6315b0937332791c8169de052d5e-6d2d4.png 400w,\n/static/2023-10-16-10-25-48-6abd6315b0937332791c8169de052d5e-ae2b8.png 569w" data-sizes="(max-width: 569px) 100vw, 569px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>下面简单介绍 profiler 测评结果中的每一列的含义：</p>\n<ul>\n<li>ncalls：函数在测评期间的调用次数。</li>\n<li>tottime：程序执行这个函数本身所花时间（不包括该函数调用其他函数所花时间）。- tottime percall：程序每次执行这个函数所花的平均时间（不统计该函数调用其他函数所花时间）。这相当于 tottime 除以 ncalls。</li>\n<li>cumtime：程序执行这个函数以及它所调用的其他函数所花时间。</li>\n<li>cumtime percall：程序每次执行这个函数以及它所调用的其他函数平均花费时间。这相当于 cumtime 除以 ncalls。</li>\n</ul>\n<p>根据刚才的统计结果，可以从 cumtime 这一列看到，在执行 <code class="language-text">insertion_sort</code> 所花费的总时间之中，有相当大的一部分都耗在了 <code class="language-text">insert_value</code> 上面，所以这就是我们要优化的重点。现在我们改用内置的 bisect 模块重新实现 <code class="language-text">insert_value</code> 函数（参见第 72 条）。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-16-10-26-17-8cd9942704196e40d05035e46645aa4b-239f1.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 301px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 32.89036544850499%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAAsSAAALEgHS3X78AAABXUlEQVQY0x1QiXKCMBTk/z+oFrzAUqtVjoQQbgZQCyoQ5fRobZ+dyWR2Xnb3ZZfjNVMONkPijA1b0MirZqK8nRKXV8mEekrGeJ1OTOdFwSPDUb6OvGoMNLJKS7P54fSi0YsWsQ6VrXqstbwh1U3P63XGUNk9cdmiolUP1T+zUfMas944X43qxsEbIL3o8PmKWA83HJ11GGTgeLo88flK6juwcdkZz0mPT5eneIhtzLoRtnlkiXYwj3bv4VZAdEo9QaOi6ct+PEQWOlRqxgSIQDxgrneF3f9yYAl/VtITLrqZG0lOIFq+5ETavgLfMfFEK4D5mxtLVghBFpuDSD1oQXRDzqjvkGG9zbXstAjTebidueHMiVebHGSfSfYRpbKfzNx4ZLjKrlynbJkc5GC3iPccab6hGwFbEg1G2FlujrBnoJA3LxoTqLeEtiQ7nJge1C57idk8aPug3cNsH3+Ws2jVKxh9WwAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 16 10 26 17" title="" data-src="/static/2023-10-16-10-26-17-8cd9942704196e40d05035e46645aa4b-239f1.png" data-srcset="/static/2023-10-16-10-26-17-8cd9942704196e40d05035e46645aa4b-6ee72.png 200w,\n/static/2023-10-16-10-26-17-8cd9942704196e40d05035e46645aa4b-239f1.png 301w" data-sizes="(max-width: 301px) 100vw, 301px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>然后重新测评，生成一张新的统计表。可以发现，新版的 insert_value 函数比原来的函数快多了，它的总累计执行时间（cumtime）差不多是原来的百分之一。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-16-10-26-40-063f3dca3d10cf8ad47c2f92b61df383-350f8.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 576px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 27.083333333333332%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsSAAALEgHS3X78AAAA/UlEQVQY031P2VLCQBDM//+RBwKlCbmREDDFEYPkIpAQMKgoVtu7KX30obdn5+jpUYbFEZPmAjspYcZb2GkFJ9vDzWsJOy1lzXjZYFS9YXw4/wvFqz9gUEjngJPvoa83sLMKZrLDcNu0jfV7K3b8hN98w3/9Il8kRM5jzy+Ux/KEQZRJZ1oYw6SwHiXSrb7KJVt0aaU7GFymPSfkAip7B6tMLhem/gTF4xQHic50LgXUcI3+LJID92Q7K3HnB+iy3iGL+Nr1yDOoyxge3U9OrXNFnHTFoji1F4RSUKPDPmORE+wWNW5GU9yOA/6X6D0tiDkeuFjEOi8Uwhbd/gAU+GihEX/RpwAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 16 10 26 40" title="" data-src="/static/2023-10-16-10-26-40-063f3dca3d10cf8ad47c2f92b61df383-350f8.png" data-srcset="/static/2023-10-16-10-26-40-063f3dca3d10cf8ad47c2f92b61df383-5fb14.png 200w,\n/static/2023-10-16-10-26-40-063f3dca3d10cf8ad47c2f92b61df383-77222.png 400w,\n/static/2023-10-16-10-26-40-063f3dca3d10cf8ad47c2f92b61df383-350f8.png 576w" data-sizes="(max-width: 576px) 100vw, 576px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>有的时候，在测评完整个程序后，可能会发现大部分时间都耗在了某个常见的工具函数（utility function）上面。在这种情况下，单凭默认的统计结果，很难看出性能瓶颈到底在哪里，因为程序之中有很多地方都调用了这个工具函数。</p>\n<p>例如，下面这个 <code class="language-text">my_utility</code> 工具函数，程序里面有两个函数（即 <code class="language-text">first_func</code> 与 <code class="language-text">second_func</code>）都会频繁调用它。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-16-10-26-58-bc7fa5f5932952e36422dc6baa9777f1-7daa6.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 227px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 150.66079295154185%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAeCAIAAACjcKk8AAAACXBIWXMAAAsSAAALEgHS3X78AAAEpUlEQVQ4y11ViZKiSBD1/39ld2NiZ2anbW1vFBDlvkRuBBVU5PTWzdKZtrsjMoiqijoy8x1U+lOnp1pDNxpYQd+Yydt9e2JiuoNN7a5qkpaP6R6mOWp6wk2/JU35KJHS4yMqLdVoyBq7yjHDq40l3F40eHXgLnBviZmzhqi1pWmNlZhVPrCDGquwy0RIj4+oyOUVQiouQ2/FrXM6TEZBzISpsrtJ5QXW1eKq5hchOUjFWYXN6UnMTkJ6Qof55AAB86EfMmHChNl4HnNhKmx3PIoDv91DwFY+3nGbgotL+Ar3lQpaTQ5yeelb/k+SZoI16UXMKsOmTlexhHXeFNSmMIFvW9LqnPwvPnqlha5mQi6V9wIgmHUhJUc+KthNKW5KYQOP7CCLcbDB7TnphtyqYNcFs87Rhuz44XBygK9cXEg7HAUbwl5Q/hrTZwNrLiYHwll0FGtS3vj0eK/5+Kz5Mfk9ht5AF6AxyVFMYXoUshNM5ez3A8Kf/RW5uCrlVdwe4HopO0F70TQ/i+kRBkp5k/KLiA4/zzyheuPVtzFHeREw5JUWu6pdZYXxcvvGSP9RXI1T24rZlm16kcDVKIU/IUDNpBPiZgC3jsNk6EUjf407C8CccMOegQomnCXhhOJmB/lz8Q4AY+OS3RRQIEobUgWeDCy/SrG0H6nZBVjR113CCpT00FHNjqJ3RKUlqnVe+T4YVUnmB8nAvR8bdgAOAmOH/orylnK8o/zVOIiGznxgBgN7NvZX0HNuU7JRhts+ty4qX3ogldf+xP2r0cUt/xtONTiZMP2GOK0y4isrNzl1NI+BQtURB4A/X74P9vwdJ+DGOMykFCEEXyU/8/EeQs7QADaL2+O9ZsBjd+MfvN/fHlMYwFTIzjBW9jeEOWgjO/Gf0aq8ieobK4GeoZ4XWuhMjBot/iDGwPA6I0EAll3NbU8cIO87tx6YVwhrjusepDpw5k15StgB9LmjWr2pO56FIA/wAERVLwKfAC4J8V7aHp56lgqULTSwOuahpWp+m+5vmG73TVfJACqrLetdUW9I0zorvZJ0VzaEeAdZPBsGt4Ke5eRAzpAq4XoaoPLXA3PW1+H9YDhbDBwfCX4RU374VZJIVeW1p3t/NzHSCr4DVMIEd+YNBUFV45WWYozmCfjBy/AB1RYhBAxBKWz3D1XxINplKt6vg/Sk/CxsdsBQGRQW72EdlQ0vI24W1ztUQNIb6OmO1hWhlV8AKgTSu4a/QNWUtBonk96qpzktSWcXSZWVQUwvoDDNfqH4Oqt0NItebO8HTp8OI7s2Z2BohBl0JL0H1jWxwGVBj6QfNmV9YHiEuxSBXukZNTmBtE8frBcZwI1wACpuOIu04qofYLrALF/J9p2J01GMnjwFA69z4i+KbisG+PwnqMBrwQPk5IQ7S0xz6Xk88iLwQBAmbrh9a4aEbQf0Ika0v/PkE1RidpaK63C2aooT4NkviiXdeVezvvWpOqfC+21lCq4Grf2d9hecoR4uypGBuCHuhC1xis/mmOHi1hwWe4aDe4tnwz6eRO6fn8GD/sGIGitUWf4nRTflSU+zXmgO/ljw6+sZ3vv+/wEmuCvoYot0xQAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 16 10 26 58" title="" data-src="/static/2023-10-16-10-26-58-bc7fa5f5932952e36422dc6baa9777f1-7daa6.png" data-srcset="/static/2023-10-16-10-26-58-bc7fa5f5932952e36422dc6baa9777f1-c49fc.png 200w,\n/static/2023-10-16-10-26-58-bc7fa5f5932952e36422dc6baa9777f1-7daa6.png 227w" data-sizes="(max-width: 227px) 100vw, 227px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>对这段代码做性能测评之后，如果用 print_stats 打印默认的统计信息，那我们很难看出问题所在。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-16-10-27-11-23dabbe92b03e7625f0da7e3a6e4d8d9-5a8c3.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 506px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 29.44664031620553%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAIAAABM9SnKAAAACXBIWXMAAAsSAAALEgHS3X78AAABHElEQVQY011Pa3OCMBDk//8kq9MKhfoIEMKrCgpRJDwTAha0funZb+3Mzs3Ozu3tnmKV0h8ehI/o0lhMmEzYlbRLiesBV72Vc5S3m3Pt8snrv/9B8YaH3X6hskOsNYtundVmIVAhrEo6fLLqwW4Gs5JE3mDT/QuFdDcjyT8o2zK+zdvVqdxkFXDEuCNG0t2d7gY7jpggAxTMR/xLAIor7xBo1wNMdXeECkaaryiDfHWfbrJmTQsjyUDRYqon2XtEtfikxyfjmD1rW3VvJIyIcYZ9s+x1yuYkdJqrFqXwMNSZYe/Vj97CeOHt5jhYfh7mbggnnmZ0abWIOt30QgJUSnhh4e5we13uD+AE/8x2waDFKUw1iNTwAEQ/nn8Af1U5k7GeO4QAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 16 10 27 11" title="" data-src="/static/2023-10-16-10-27-11-23dabbe92b03e7625f0da7e3a6e4d8d9-5a8c3.png" data-srcset="/static/2023-10-16-10-27-11-23dabbe92b03e7625f0da7e3a6e4d8d9-67543.png 200w,\n/static/2023-10-16-10-27-11-23dabbe92b03e7625f0da7e3a6e4d8d9-c323a.png 400w,\n/static/2023-10-16-10-27-11-23dabbe92b03e7625f0da7e3a6e4d8d9-5a8c3.png 506w" data-sizes="(max-width: 506px) 100vw, 506px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>在总执行时间里面占比例最高的，显然是 <code class="language-text">my_utility</code> 函数，但通过这张表格，我们没办法明确地观察出这个函数为什么调用了这么多次。即便查看源代码，也不一定能立刻找到关键所在，因为代码里或许有好多地方都调用了这个函数。</p>\n<p>为了解决这个问题，可以改用 profiler 的 <code class="language-text">print_callers</code> 方法来打印统计结果，它可以显示出程序里面有哪几个函数调用了我们关心的这个函数。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-16-10-27-24-6d281a08a24c2c293a2beb47e26d887b-e6d69.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 193px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 14.507772020725387%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAIAAAAcOLh5AAAACXBIWXMAAAsSAAALEgHS3X78AAAAsklEQVQI1w3K2xKBQAAA0P7/VzwwmJ5yS3ZXKCOXai+RZN3TlLaWGT2fo1AhifjS8odL6RcVFpJVPy8XpJC4kN5HECFp+d0mmZvmNeGiqvP2nfm5UNoGUk27MTBUODejm7baNXXYc9y2Me0iy+KPvuN2wFyFtrbctPRpb+11wWzo0g6yFMAig0UjHMIgtvlr7B8mNFrdU3TgZngB7ISCeIKPC/5cXpMxOdrXBAQxDDncn/8e8JoNMp4z7wAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 16 10 27 24" title="" data-src="/static/2023-10-16-10-27-24-6d281a08a24c2c293a2beb47e26d887b-e6d69.png" data-srcset="/static/2023-10-16-10-27-24-6d281a08a24c2c293a2beb47e26d887b-e6d69.png 193w" data-sizes="(max-width: 193px) 100vw, 193px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>下面这张表格把受调用的函数写在左边，把调用这个函数的其他函数写在右边，这样我们就可以看到，左边的 <code class="language-text">my_utility</code> 函数总共被两个函数所调用，其中调用次数较多的是 <code class="language-text">first_func</code> 函数，它调用了 20000 次。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-16-10-27-40-a96a66c5ae0561fa744b1a4a89b9166b-c18f8.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 572px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 25.699300699300696%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAIAAADKYVtkAAAACXBIWXMAAAsSAAALEgHS3X78AAAA2klEQVQY001O226DMBTL/3/Whkq5BAjZw6R2A3ELSQm5QAelfegJvEyyLMvJsY1SYWM2xr3CvY6ZBE6HmdqNTs+v+eUAwm7A4Dj/HxDm7iY3D2oeuV6JWohe4V8m72E7BLVIhAUnG/+IXqh9HrlHEAqbAZqjFlhFnYSII5WMy56r4NWJXiW3iVrX4Wp2IL9kftl9fBenoj39Nm7Cnpqrlch71ErMDWZjIgzoc8X9ovN+Kq9ozjVHSa8xUwdSrrPblJvVlZstk3NQcRgV1gIGwhnUeNf681ICoOwNIYgKmrqe4m4AAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 16 10 27 40" title="" data-src="/static/2023-10-16-10-27-40-a96a66c5ae0561fa744b1a4a89b9166b-c18f8.png" data-srcset="/static/2023-10-16-10-27-40-a96a66c5ae0561fa744b1a4a89b9166b-620de.png 200w,\n/static/2023-10-16-10-27-40-a96a66c5ae0561fa744b1a4a89b9166b-b38ee.png 400w,\n/static/2023-10-16-10-27-40-a96a66c5ae0561fa744b1a4a89b9166b-c18f8.png 572w" data-sizes="(max-width: 572px) 100vw, 572px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h3 id="总结-66"><a href="#%E6%80%BB%E7%BB%93-66" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>优化 Python 程序之前，一定要先分析它的性能，因为导致程序速度缓慢的真正原因未必与我们想的一样。</li>\n<li>应该优先考虑用 cProfile 模块来分析性能，而不要用 profile 模块，因为前者得到的分析结果更加准确。</li>\n<li>把需要接受性能测试的主函数传给 Profile 对象的 runcall 方法，就可以专门分析出这个体系下面所有函数的调用情况了。</li>\n<li>可以通过 Stats 对象筛选出我们关心的那些分析结果，从而更为专注地思考如何优化程序性能。</li>\n</ol>\n<h2 id="第-71-条：优先考虑用-deque-实现生产者-消费者队列"><a href="#%E7%AC%AC-71-%E6%9D%A1%EF%BC%9A%E4%BC%98%E5%85%88%E8%80%83%E8%99%91%E7%94%A8-deque-%E5%AE%9E%E7%8E%B0%E7%94%9F%E4%BA%A7%E8%80%85-%E6%B6%88%E8%B4%B9%E8%80%85%E9%98%9F%E5%88%97" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 71 条：优先考虑用 deque 实现生产者-消费者队列</h2>\n<h2 id="第-72-条：考虑用-bisect-搜索已排序的序列"><a href="#%E7%AC%AC-72-%E6%9D%A1%EF%BC%9A%E8%80%83%E8%99%91%E7%94%A8-bisect-%E6%90%9C%E7%B4%A2%E5%B7%B2%E6%8E%92%E5%BA%8F%E7%9A%84%E5%BA%8F%E5%88%97" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 72 条：考虑用 bisect 搜索已排序的序列</h2>\n<h2 id="第-73-条：学会使用-heapq-制作优先级队列"><a href="#%E7%AC%AC-73-%E6%9D%A1%EF%BC%9A%E5%AD%A6%E4%BC%9A%E4%BD%BF%E7%94%A8-heapq-%E5%88%B6%E4%BD%9C%E4%BC%98%E5%85%88%E7%BA%A7%E9%98%9F%E5%88%97" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 73 条：学会使用 heapq 制作优先级队列</h2>\n<h2 id="第-74-条：考虑用-memoryview-与-bytearray-来实现无须拷贝的-bytes-操作"><a href="#%E7%AC%AC-74-%E6%9D%A1%EF%BC%9A%E8%80%83%E8%99%91%E7%94%A8-memoryview-%E4%B8%8E-bytearray-%E6%9D%A5%E5%AE%9E%E7%8E%B0%E6%97%A0%E9%A1%BB%E6%8B%B7%E8%B4%9D%E7%9A%84-bytes-%E6%93%8D%E4%BD%9C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 74 条：考虑用 memoryview 与 bytearray 来实现无须拷贝的 bytes 操作</h2>\n<p>针对 CPU 密集型的计算任务，要想用 Python 程序平行地处理，可能得多花一点功夫（参见第 64 条），但针对 I/O 密集型的任务，却很容易就能用各种方式写出吞吐量较大（也就是处理能力较强）的平行代码（参见第 53 条与第 60 条）。然而，由于这种代码写起来很简单，特别容易遭到误用，让人以为 Python 好像慢得连 I/O 密集型任务都处理不好。</p>\n<p>我们来举个例子。假如现在要构建媒体服务器，通过网络把电视或电影以数据流的形式发送给用户，这样他们就不用先把整个视频文件全都下载下来才开始观看。这种系统必须实现一项重要的功能，就是允许用户直接跳到后面或前面的某个时间点，并从那里开始观看，这样的话，他们就可以跳过或者回看视频之中的某些部分了。在客户端程序里面，必须针对该功能编写 request<em>chunk 函数，让它根据用户所选择的时间点在整部视频中的字节位置（byte</em>offset），向服务器发送请求以获取相应的数据块。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-18-09-57-28-89dbad16a0944521cfbae5585bdf282f-f1587.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 535px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 48.5981308411215%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAAsSAAALEgHS3X78AAABnUlEQVQoz01SiY7aMBDN//9TtdsFcuAcQIBWC+HI4fiIYyeBvVpWfQ6tutKTZU9m5r15E2dO1fRQTY/VvJAhbSdZ7ufMPdXemUe8m1fN7FDOsjKWw/Z6S/uPdf+R/oOTyD4oZch0LPuwbiNuYtGRWhHaLppLaJ99yBBHsF22L+nw63/xQl0JVWE9FjONjEgYtCBML9QlYgZAHIAKJK+/FpNaTw4VoQ343TMjVeOeGHqFzHiFxFCzI7X8svdybmVffoMcJ+DEvEOUWOYOSeBEwV08LmgRiR7PO3koungEhiLcOKl+g1QgaS6IQqRVzjsMjOI5bRM5xKNzSTMQq0jboagKqHImu9wvxap9XaqXpXlbde/A2gq7ba+fG4sb7jhHjM/Bat5A9sN6922zg8+kbGb7YlxMEXMDIeBPRA9acC7VFWNjhIUc0u79r2FBzoMz8051RLV7rNys/P4ji5kOqgZeYPMe/OMGPvu5QBoiUHTftvP0fH78ecAM+EketnswPz2fpvsiKIR7pH4h4I1fcCwCn6wdzEyzcqVf4fkfZYoQ3KQeyM8AAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 18 09 57 28" title="" data-src="/static/2023-10-18-09-57-28-89dbad16a0944521cfbae5585bdf282f-f1587.png" data-srcset="/static/2023-10-18-09-57-28-89dbad16a0944521cfbae5585bdf282f-221e5.png 200w,\n/static/2023-10-18-09-57-28-89dbad16a0944521cfbae5585bdf282f-807fe.png 400w,\n/static/2023-10-18-09-57-28-89dbad16a0944521cfbae5585bdf282f-f1587.png 535w" data-sizes="(max-width: 535px) 100vw, 535px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>接下来就要考虑，服务器端应该怎么处理客户端通过 request_chunk 发来的请求，并返回相应的那 20 MB 视频数据？为了突出重点，这里假设客户端与服务器之间的请求与响应机制，已经实现好了（必要环节参见第 61 条），这样就可以聚焦最关键的一步，也就是怎么把客户所需要的那块视频数据，从缓存在内存之中的千兆字节提取出来，并通过 socket 发回客户端。下面描述大致的流程：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-18-09-57-45-1baad68c97fcce23d491f5d92b1e8c9f-eca56.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 554px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 25.451263537906136%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsSAAALEgHS3X78AAABFElEQVQY0z1Q2XKCQBDk/z8pDxIUTyAohkRFBCECyqUR0ZhKdXq3LB+mZqp3+phVdC+CtgxhJTWcsoVzvGF++mHd4dQ3mMT1dYxhkGIUZtC9GIPNTs7GV0E8wTg6wM4bzMoLlM6Hh9dPHy+2i2GYwqmuFLri/fwLh8ITLqvuCn0/RncZUDxCd7VBz9tCX4XoCzPyRlEGK62h9JjQ2BUYxweZRvRp0cDMarlg7080XEMjWRCHW1aYYMDEEyac1S1sJnObP8wZQjFJskgSyYy0YtWYJCWXczkbYqaheBMGAhdmU4oIbFa1z2tEKdoi4AlbeVqHp6kLHyq/YBTtYT7EjV0pu/kQtLIjptVFGr3lZ8y/70/BfwVGaCVa0idHAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 18 09 57 45" title="" data-src="/static/2023-10-18-09-57-45-1baad68c97fcce23d491f5d92b1e8c9f-eca56.png" data-srcset="/static/2023-10-18-09-57-45-1baad68c97fcce23d491f5d92b1e8c9f-77254.png 200w,\n/static/2023-10-18-09-57-45-1baad68c97fcce23d491f5d92b1e8c9f-789d0.png 400w,\n/static/2023-10-18-09-57-45-1baad68c97fcce23d491f5d92b1e8c9f-eca56.png 554w" data-sizes="(max-width: 554px) 100vw, 554px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>这段代码的延迟与吞吐量，取决于两个因素：一个是从 video_data 里面切出 20 MB 视频数据需要多久；另一个是把这些数据通过 socket 发给客户端需要多久。现在假设 socket 的速度无限快，这样就可以专心考虑前一个因素了。我们通过内置的 timeit 模块做这样一个 micro-benchmark，以测评刚才那段代码的效率，看看它采用的这种方式（参见第 11 条），要花多长时间才能从 bytes 实例里面切割出制作数据块所必需的信息。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-18-09-58-36-692674b9abc33f26e2f4e32853d028af-a3fce.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 515px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 55.33980582524271%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsSAAALEgHS3X78AAABfElEQVQoz51T2XKCQBDk//8oeUiZgAKKSNRYiQleeAEqeObQVKdnRSpPwcpD1+wuW73dPYNWG8ewhnO44RrGWwBnukJ7e0Rz/YnWP6DVoxSNeANvsUM9TBXkQ3t7+oWjQkvVU1azs82X2rcyEZoTJjCDELdeBzoVGv4YD69DWKMQlcEUlf4E9ngBg9UahjDppkpX5cEMJuHFO9QmS9hBjGZKws4BcKnQ6J3tyof7bh9lEpSee4Svqj2KeGcMnQ/K3vADBTnXu0PcdXz1ABWmqM0SJd2Nt1yv8JgcIOcOc1VZXqwVILOcQu9NaG+GakAVfK3SO6uwGIWXvOeXC8F72tP+W2V047YVWdkfoUIrJq0502Ue9rXQpGuisvTSV4EL3GgNh9ZrJJQHLx2+RqnmxmvOYKpI1djMEzhElWR1NkvWNrtajyTPj0JSTQgabIa3OqDBWZSOe6u9WguESEi95S7P6U9CazBHmU0wWWX2RKnN5lz+mFY+wJJlseUfJg0mCSUWnAUAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 18 09 58 36" title="" data-src="/static/2023-10-18-09-58-36-692674b9abc33f26e2f4e32853d028af-a3fce.png" data-srcset="/static/2023-10-18-09-58-36-692674b9abc33f26e2f4e32853d028af-96d1c.png 200w,\n/static/2023-10-18-09-58-36-692674b9abc33f26e2f4e32853d028af-2b9d0.png 400w,\n/static/2023-10-18-09-58-36-692674b9abc33f26e2f4e32853d028af-a3fce.png 515w" data-sizes="(max-width: 515px) 100vw, 515px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>可以看到，从 bytes 里面提取 20 MB 数据并传给客户端，大概需要 5 毫秒。也就是说，服务器的总吞吐量是每 5 毫秒 20 MB，相当于每秒 4 GB，这就是它从内存中提取视频数据所能达到的最大速度。如果多个客户端同时请求获取各自的新数据块，那么服务器这边的 CPU 在每秒内最多只能服务 200 个客户（因为每响应一次请求，都需要耗费 5 毫秒，或者 0.005 秒的时间），这个数量与内置的 asyncio 模块所能支持的数量相比实在太小，asyncio 应该可以同时处理成千上万条连接才对。问题的关键在于，对 bytes 实例做切片需要拷贝底层数据，这会浪费 CPU 的时间。</p>\n<p>这段代码可以通过 Python 内置的 memoryview 类型来改进，这个类型让程序能够利用 CPython 的缓冲协议（buffer protocol）高效地操纵字节数据。这套协议属于底层的 C API，允许 Python 运行时系统与 C 扩展访问底层的数据缓冲，而 bytes 等实例正是由这种数据缓冲对象所支持的。memoryview 最大的优点，是能够在不复制底层数据的前提下，制作出另一个 memoryview。下面这段代码，就先把 bytes 实例封装在 memoryview 里面，然后再切割，这样不用拷贝底层数据。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-18-09-59-00-782461540fdeef7e86dce333d9b7a663-d59c4.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 445px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 56.17977528089888%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsSAAALEgHS3X78AAABx0lEQVQoz11Sh5KbQAz1//9RcjF3caP3EmPAwC51qQZjn0tmIiDJXTLzRrOj1ZP0JC1Wtk/7sUI6Jkg2LuJwvvMwi1I6SJgJMmmEuGBRxoQJn1Rmfze624wFECjLU4vzzo9Xh4ANs42Lv//wKMsRs0bv7mr7rp1u2mm2N/D8xWLnRm+WJyY1E6RLbc+EGYMIgzK9G+OM/mGefxrnpzkBHv+QeUx4lG88TBn2xkFzkDmMQerpXakvIjlJRT/ZTi578xN/waEchPFRSR9jDhdKNcjFWcxbs3/q7Y3BxYu+f9v7S9N5UaxXwxazWm2uej9XBrIfQ4pXy10fApgT1IcHqNCrCx+XlH5Y2QFlOGv7yMWlkHwiS3mr1IPWXqWyl8uz2l5H21wl0mnNFb6EvBVJx6eNXA3mMOqfmSOZRTkbEaUcQB6oEtKGjQohaxhM1Ppi/JnTSOsf+n/Thg6/yCakENKai8qdn6ydcHeEtaF5PB9LGnGftnD7IG+PkUx6aJKLK2uqIIC2rJXIiU9ro3uAx/i9p8e0vOfo6Z8LynS+GfbWRVsHLXV768dwRlsPf1X3cD/rQ8hiAknhwugwG8UnNR2mHNwCzn8BvcFEVEZ+sB8AAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 18 09 59 00" title="" data-src="/static/2023-10-18-09-59-00-782461540fdeef7e86dce333d9b7a663-d59c4.png" data-srcset="/static/2023-10-18-09-59-00-782461540fdeef7e86dce333d9b7a663-25c2a.png 200w,\n/static/2023-10-18-09-59-00-782461540fdeef7e86dce333d9b7a663-dae19.png 400w,\n/static/2023-10-18-09-59-00-782461540fdeef7e86dce333d9b7a663-d59c4.png 445w" data-sizes="(max-width: 445px) 100vw, 445px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>由于它执行的是零拷贝操作（zero-copy operation）[1]，因此对于需要高速处理大量内存数据的代码来说用处很大（比如 NumPy 这种处理数值的 C 扩展，或者像本例这样的 I/O 密集型代码）。下面，我们用 memoryview 封装早前的 video<em>data，然后在封装出来的 video</em>view 上面做切片，而不是直接切割 video_data。用同一个 micro-benchmark 来测评这种做法的效率：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-18-09-59-26-5e81b5e5af9c58c79ce0afe581fc6d14-561f5.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 519px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 51.83044315992292%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAAsSAAALEgHS3X78AAABYElEQVQoz31R2W6DMBDk/3+pVVVycAZoONIkhMOAAYOhnJGSNFHX8FYpkVartb0zOzvmZFwuT0hOCiHKzWoUw1TFpZIUIsoWbiD4CX8M9bKz+6vVXf4FpxetXnR62WukVbPa7m/OeHfGh3N+7M4Pe66HX3u42Sz/Wv0NeljRXTlgVTF92+4EH0tBunIjNa2XXiwEWIoIXIphJqFcjglkwUu21aimVES5CZOBRiPNpJYqEVkcQynAn7vT8hjyh0BJSgDDK9RQAJeS0NUp4vf+2secDAAXKbiSEYEOKSb83pMQMZsL0zmLnGIWbHXzcZINKwHy3fxmE3y8dtHKi3TSTH3X1wHgu5JWH9ZBDDB4q2W1EhdyQplb0+RX4K96BMM3Wa0VDSxvlL1OWoMOs/9bOlrtc7DBANNXwZ/lP2A+DAc6Na3ALSAy28tTsIxyKS5UBuiMatyQRqcDCHZY3F/L/gODRxSyS2rQ1AAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 18 09 59 26" title="" data-src="/static/2023-10-18-09-59-26-5e81b5e5af9c58c79ce0afe581fc6d14-561f5.png" data-srcset="/static/2023-10-18-09-59-26-5e81b5e5af9c58c79ce0afe581fc6d14-214e0.png 200w,\n/static/2023-10-18-09-59-26-5e81b5e5af9c58c79ce0afe581fc6d14-ef58c.png 400w,\n/static/2023-10-18-09-59-26-5e81b5e5af9c58c79ce0afe581fc6d14-561f5.png 519w" data-sizes="(max-width: 519px) 100vw, 519px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>这次只需要 250 纳秒。所以，服务器理论上的最大吞吐量是每 250 纳秒 20 MB，相当于每秒 80 TB。服务器的 CPU 每秒钟可以处理的请求数是四百万。好处还不止这一个：由于处理时间很短，这意味着这个程序几乎不受制于 CPU 的计算能力，它的速度现在只取决于 socket 与客户端之间的底层连接速度。</p>\n<p>假设现在需要实现双向流动，也就是允许某些客户端做视频直播并把视频数据发送给服务器，以便传送到其他用户那里。为了实现这项功能，我们可以把用户最近发来的那段视频放在缓存里面，以便其他用户读取。下面这段代码演示了怎样把客户端发来的 1 MB 新数据放置在缓存的适当位置。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-18-09-59-39-33a0dbde8b06ccb6d15674be80f26764-7ace1.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 483px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 42.44306418219462%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsSAAALEgHS3X78AAABjklEQVQoz02R6XaiUBCEef9HmkyCIkHRMKi4BRdQATdASXRiZpJTqe6cM+OPhrv1d+tWGY/zNczRHP72hO7hjF5xQVC9I3j5A297RHu9hxXGcPlvxhvYszUc9rSWW+4d0FxkeqbFvUa4hGHxcx+EnMR4GE3RSUsExzcMKgGe2JzCmizwSJC72sHm+dqY80UKh1UbzxXYjFK90JAFe7pEg2UKMCngZSXBOZ42RzYmMIdTPLBsjuuEiypRIxA32cPPXzE4f2Dw+heGf3hBNz+rKn9fqTI54O1O6J+u6BZngku0s0LXnrYlfu0qVS99w8un2tOnTVKGQy/k5l5+QYtPatCfTlroWHxyooygShtFRV+aWQHVfIOu/2AKrD9H+NEdUn6m5osfdriiZyu4Mde4L0GYwxkkwBrnHSoW4C3oP5AeShjehs9Jctz1xmxcqfF1qUmkF933J6jRvza99WhTr/x9o/IGKCnbVNNODpqSFUZoLjdq/s9gokGZoxnqPOfSR4dBWM+xhiVKffH/BvoF+so+NnTBZ9oAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 18 09 59 39" title="" data-src="/static/2023-10-18-09-59-39-33a0dbde8b06ccb6d15674be80f26764-7ace1.png" data-srcset="/static/2023-10-18-09-59-39-33a0dbde8b06ccb6d15674be80f26764-7e8e5.png 200w,\n/static/2023-10-18-09-59-39-33a0dbde8b06ccb6d15674be80f26764-0f3db.png 400w,\n/static/2023-10-18-09-59-39-33a0dbde8b06ccb6d15674be80f26764-7ace1.png 483w" data-sizes="(max-width: 483px) 100vw, 483px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>socket.recv 方法返回的是 bytes 实例，我们现在要把这个 bytes 所包含的字节数据（也就是 chunk）安插到缓存之中。为此，先把 video<em>cache 缓存封装成 video</em>view，这样很容易就能切割出 byte_offset 之前的那一段（before）以及新数据之后的那一段（after），最后用 bytes.join 方法把这三段拼接起来。为了观察这种写法的性能，我们再做一次 micro-benchmark，这次用一个空的 socket 来测试，这样可以免去 I/O 操作，让测试结果完全反映出内存操作的性能。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-18-09-59-59-988adc781055c76b76ffee374dc22e1c-5032e.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 438px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 62.55707762557078%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsSAAALEgHS3X78AAACAElEQVQ4y41T21biQBDM/3+PZx9cJGCQq0Du4SoQbuEiIQiCy3pqqwc5iz6ID32mJzPTVV1d0SqjJfLdIR46QxjNHnJc6/MNnM0b7OQUTnKRb/78j4vv59Ds9QF3bgspRi1KUBxE0P0ODBbO9yMY7QHyvTH0RhclglvxHubqVcUZwL4A1+RCymki7bRQna5QmyVIe21kvA4KTyzEXNjrfhdGq48M1/tmn2cTmMsdTL4Xpu7LURXXLCKlhVE7RHUSoxDOkQm6ilmuE+LObhCgpVinCawTqMQ7j+MVAQa4J0gxnMF83qH+vD0x1AWR7emiIVmJhtUoRmWy4n7Es+mJIUEf+hPUly9IEzTXHal7BmeQ5zuRS8sSocDEZBHRLdPooUytskQXbYthBJetSEvntpyP/WXubo7qnuYkB9w6gUIvhwuUWDxPVlmyFQfY7OBS9GuhSe+/rQC3dR850e0jCmxNZ1vmcnua5E8Lim0ywZNq9XG8VJOtTGNlDykq9nC3fz+1bH/x5aeCFhmanI4ILet5X1tsUKOuVvyq8uo8QZWWstb7bxlr4j3RrTRe0MATDmiK4nBOPWdqarVoraYpf1CRdhGbfVtQNPS372pKPlsL9kDjcApv987HR3g8l9zj+TU9tRSNmzJ9/KqYysBi1BvmN2WTWq6UbqLztWGcgf4BbKCwekxGMdQAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 18 09 59 59" title="" data-src="/static/2023-10-18-09-59-59-988adc781055c76b76ffee374dc22e1c-5032e.png" data-srcset="/static/2023-10-18-09-59-59-988adc781055c76b76ffee374dc22e1c-86481.png 200w,\n/static/2023-10-18-09-59-59-988adc781055c76b76ffee374dc22e1c-1ca59.png 400w,\n/static/2023-10-18-09-59-59-988adc781055c76b76ffee374dc22e1c-5032e.png 438w" data-sizes="(max-width: 438px) 100vw, 438px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>这次需要 33 毫秒（0.033 秒）才能接收 1 MB 新数据并把它更新到视频缓存里面。这意味着最大吞吐量大约是每秒钟 31 MB，处理一次更新请求要花 0.033 秒，所以每秒钟大约只能给 31 个客户端同时提供这种视频流服务。这个方案没办法大规模运用。</p>\n<p>如果能把 bytes 改成 Python 内置的 bytearray，那么与 memoryview 相搭配，效果会比较好。bytes 有个限制，就是只能读取不能修改，我们不能单独更新其中某个位置上的字节。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-18-10-00-21-5eb3b60fa577f1e46567cc9718ca24ea-72b6c.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 527px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 20.49335863377609%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAAsSAAALEgHS3X78AAAAvklEQVQY021Q2QqCUBT0/z+olwhst6xI02y7Waamhqam0mbT9Qph4MMwM2fncJ21jpa6QZvy2PAg6DZ6Gx0zN4Jye0GOHgyLGsg1nhsczhBMDyPzgqkTQvJTTJwr5kH2GyZH94qu8xRhGeNGhkuviTH1YijRE2qSQ80+UJI31PSfS52Xnl7PdCVW9HL8kqAhztGUNEzsAN2tgf7egmj74LU9BLqQX+mMh0eX5Yv3iJaPLjFpLX3R7kRrCXrEwhe8WCQpAKGdJgAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 18 10 00 21" title="" data-src="/static/2023-10-18-10-00-21-5eb3b60fa577f1e46567cc9718ca24ea-72b6c.png" data-srcset="/static/2023-10-18-10-00-21-5eb3b60fa577f1e46567cc9718ca24ea-96efc.png 200w,\n/static/2023-10-18-10-00-21-5eb3b60fa577f1e46567cc9718ca24ea-b717e.png 400w,\n/static/2023-10-18-10-00-21-5eb3b60fa577f1e46567cc9718ca24ea-72b6c.png 527w" data-sizes="(max-width: 527px) 100vw, 527px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>而 bytearray 则相当于可修改的 bytes，它允许我们修改任意位置上面的内容。bytearray 采用整数表示其中的内容，而不像 bytes 那样，采用 b 开头的字面值。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-18-10-00-38-9adf026cdfaf1e14d3d087b5dde571b2-99660.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 277px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 39.711191335740075%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsSAAALEgHS3X78AAABeUlEQVQoz31Se2+CcAzk+3+dZYvZsg1QEEQgAoKooDx8oBPFB2a6eSs4F7cl/nFp09K7a38wXGcI0R9DDmaodkOwjg8lmsNeHaGMUgi9kHpTSMMJmvEcDcqr3QCc60PwAtTcAaodD5I/gkQ9hnU81PohhEGMWncItt0ngQhyOIVMBHI4g0xkQj+goRhKmJR1ZbyANstIdA4tWaE5SaHPN2Be7T54Iqp5URm5jl+6fDZdSERmZ+Q0XoCjGu8MyiE7B6zNESbB2n6c4+YcmUZA6oMQ9eGodFbRLHITQ/RisCT2YnVLATPN4exOMLL3m2DU6RLGag/9bQOVbIu0nhQl5C5B0asX94tmaNE3lyFzffjBP0KNVigGjOUe7d0n4QTrO15g56fzauvzmjcdFi8o0rGLwxrLHPpiW5JrhWM6eotylXpKkpa9ov7X2bVj5kkzUVENPDR03EtN8PQ73IkK5Sp4u4enlo1H3aRH8eieLur+BGZ2+EV0Tf4FT4FCWHZ2ypQAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 18 10 00 38" title="" data-src="/static/2023-10-18-10-00-38-9adf026cdfaf1e14d3d087b5dde571b2-99660.png" data-srcset="/static/2023-10-18-10-00-38-9adf026cdfaf1e14d3d087b5dde571b2-e2e94.png 200w,\n/static/2023-10-18-10-00-38-9adf026cdfaf1e14d3d087b5dde571b2-99660.png 277w" data-sizes="(max-width: 277px) 100vw, 277px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>bytearray 与 bytes 一样，也可以用 memoryview 封装，在这种 memoryview 上面切割出来的对象，其内容可以用另一份数据替换，这样做，替换的实际上是 memoryview 背后那个底层缓冲区里面的相应部分。这使得我们可以通过 memoryview 来修改它所封装的 bytearray，而不像刚才那样，必须先将 bytes 拆散，然后再拼起来。</p>\n<p><a href="res/2023-10-18-10-00-52.png"></a></p>\n<p>Python 里面很多库之中的方法，例如 socket.recv<em>into 与 RawIOBase.readinto，都使用缓冲协议来迅速接收或读取数据。这种方法的好处是不用分配内存，也不用给原数据制作复本，它们会把收到的内容直接写入现有的缓冲区。我们可以把通过 memoryview 所制作的切片传给 socket.recv</em>into，这样就能直接用该方法接收到的数据来替换底层的 bytearray 里面与切片相对应的那一部分内容。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-18-10-43-47-efc1a02b2c759659bceb37e2822d5cb4-21746.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 449px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 17.37193763919822%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAAAsSAAALEgHS3X78AAAAuklEQVQI1y2O2wqCUBRE/f9vMrVSU5EevJSl5i1Ni8iUiG5Mc6KHw96HvVgzkpHuMQm2MHd7aOsUdnWE25yx4N/OD7CLFkZaQQnj313wMnmHTHj7wB9f8IYnAs5gfEPS4wpalGFRdJhtcjgUWnkDPS4YUlNccy8h+xHUcEsmwzRKYTLMbXssTwP8/sE5wu16SPOkhMLEZXeFxTZCIBoJiWilrhKYWcPAFlbZUdT83wG6YLl7l/vvPmf7Lwbs1QN7Flk+AAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 18 10 43 47" title="" data-src="/static/2023-10-18-10-43-47-efc1a02b2c759659bceb37e2822d5cb4-21746.png" data-srcset="/static/2023-10-18-10-43-47-efc1a02b2c759659bceb37e2822d5cb4-17e1d.png 200w,\n/static/2023-10-18-10-43-47-efc1a02b2c759659bceb37e2822d5cb4-f4f9f.png 400w,\n/static/2023-10-18-10-43-47-efc1a02b2c759659bceb37e2822d5cb4-21746.png 449w" data-sizes="(max-width: 449px) 100vw, 449px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>然后，我们再做一次 micro-benchmark，看看这种写法的效率，跟原来那种采用 socket.recv 所实现的写法相比，会不会快一些。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-18-10-44-05-5de364b05059c62474a405f9965cdd46-ced8c.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 491px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 47.04684317718941%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsSAAALEgHS3X78AAABYElEQVQoz41S2XKCQBDk/78oqVSsRFFQQI4VKx4RUQEv5FITY5LO7FB51oepGdje7umZVfTFGt3FBs1xgNZ0AXUSohel8A5nuOkJ/W3J2d5VsNY57H1FdQmHsrXJ+VzkF9iEsbYFFP/0A5OAD5ZAO4jRCRK8vAV4Hc3xLEZ4tH3OnXlCZzH0cA2Nag6q5T83PaO32kGju4p//IZL3RjJgRW4AwpnfyT1gsQyFhTlFVJ8QHh55z/LEOUXBlVdK3qYsNU+2bA2BZrUmRHtuVP1fcUiEuwVl7tC8fJPdKndhhhDJxtyhup0SZYDtudmH3eTMaF/+oURZ3jyhrSYEG0i02YrmCTSonog7UiL1ZWt3SR0aDs9stgYTqASkRZE6C63MGmm7VnE2zV4jhkk1rtBqkggP43szHM0+WnU86y/M2j0rORTcmibNzuU3Rhxipq4gEMbt0hAhiBAvc16u/dY/gMd9ZIF7kZNDAAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 18 10 44 05" title="" data-src="/static/2023-10-18-10-44-05-5de364b05059c62474a405f9965cdd46-ced8c.png" data-srcset="/static/2023-10-18-10-44-05-5de364b05059c62474a405f9965cdd46-680fb.png 200w,\n/static/2023-10-18-10-44-05-5de364b05059c62474a405f9965cdd46-eda79.png 400w,\n/static/2023-10-18-10-44-05-5de364b05059c62474a405f9965cdd46-ced8c.png 491w" data-sizes="(max-width: 491px) 100vw, 491px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>这次可以看到，传输 1 MB 视频数据只需要 33 微秒（也就是 0.000033 秒）。这意味着服务器的最大吞吐量可以达到每秒钟 31 GB。服务器每秒钟能够处理的客户请求大约是 31000 次。这才是能够大规模运用的方案。</p>\n<h3 id="总结-67"><a href="#%E6%80%BB%E7%BB%93-67" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>Python 内置的 memoryview 类型提供了一套无须执行拷贝的（也就是零拷贝的）操作接口，让我们可以对支持缓冲协议的 Python 对象制作切片，并通过这种切片高速地完成读取与写入。</li>\n<li>Python 内置的 bytearray 类型是一种与 bytes 相似但内容能够改变的类型，我们可以通过 socket.recv_from 这样的函数，以无需拷贝的方式（也就是零拷贝的方式）读取数据。</li>\n<li>我们可以用 memoryview 来封装 bytearray，从而用收到的数据覆盖底层缓冲里面的任意区段，同时又无需执行拷贝操作。</li>\n</ol>\n<h1 id="测试与调试"><a href="#%E6%B5%8B%E8%AF%95%E4%B8%8E%E8%B0%83%E8%AF%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>测试与调试</h1>\n<h2 id="第-75-条：通过-repr-字符串输出调试信息"><a href="#%E7%AC%AC-75-%E6%9D%A1%EF%BC%9A%E9%80%9A%E8%BF%87-repr-%E5%AD%97%E7%AC%A6%E4%B8%B2%E8%BE%93%E5%87%BA%E8%B0%83%E8%AF%95%E4%BF%A1%E6%81%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 75 条：通过 repr 字符串输出调试信息</h2>\n<p>调试 Python 程序时，我们可以通过 print 函数与格式字符串（参见第 4 条），或者利用内置的 logging 模块，相当深入地观察程序的运行情况。Python 的内部状态一般都可以通过普通的属性访问到（参见第 42 条）。所以，我们需要做的就是适当地安插 print，并观察程序在运行过程中发生了哪些变化，其中有没有什么不对的地方。</p>\n<p>print 函数可以把开发者传给它的值显示成便于认读的那种字符串。例如，最简单的用法是直接把字符串传给它，这样就可以打印出不带引号的内容。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-17-11-45-14-8e7625843ed1244445651f22829652e7-1613e.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 151px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 48.34437086092716%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAABxUlEQVQoz41S227aQBD1//9E1efm1lZUSWgIBBs7hRTfdm2CwyWGokQFg7GNbSCn44tUKqqqD0c7MztndubsCFa4Bw+3MNcJeLBD7keZH0NbBGB+DHMZwY7ojqD7WV4MO0xzHov20LwIphfCDlIIdXsEafAMeeii6bio8wHE4Rg13seDO8dVl+OyraJhOaiaFpH2uOxauNYZao9PEJ8mkEcz3LAB2tMFhJNbEXfOGOpsjluzh68ag9hzUHnQqJsU0miKJuvhpC7itCHCWaWodsmvNXFGsRY10dvsUaOCymAGwVxQ++sd+DKB5dNYmb3awvBiqN4GnPwsnp2cumNU0PK35JOdgWQy6GF9HhGPRraDt/yS02lQokZBnZDZeeIqKfwS+qqIGSX0Enku6Su0hjO03Rcoox/4/jOgz/hNKBIL5MTSPix0iCwuVDoMVZWj8k2F8vyai55dasv47yQ/Pej8GKRhhH4CDHdAP6SxF5t8fR5j0Fq85R+jH41WjHf0CEF4f/4Z5w0ZH67rkJwprYGLdxcX+CLK+NRUcD95JRl2f+j2Lwj34wmuOgY+NhRIpGfnxcOZJOP0roUbWiO2TsqO/g+/APTy2JZF98YSAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 17 11 45 14" title="" data-src="/static/2023-10-17-11-45-14-8e7625843ed1244445651f22829652e7-1613e.png" data-srcset="/static/2023-10-17-11-45-14-8e7625843ed1244445651f22829652e7-1613e.png 151w" data-sizes="(max-width: 151px) 100vw, 151px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>这种写法跟下面几种写法是等效的：</p>\n<ul>\n<li>先把字符串传给 str 函数，然后把 str 函数返回的内容传给 print；</li>\n<li>把字符串写在 <code class="language-text">%</code> 操作符的右侧，让它替换操作符左侧那个格式字符串里的 <code class="language-text">%s</code>；</li>\n<li>把表示字符串值的那个变量，按照默认格式写在 f-string 中，交给 print 去打印；</li>\n<li>调用内置的 format 函数；</li>\n<li>明确调用 <code class="language-text">__format__</code> 特殊方法；</li>\n<li>明确调用 <code class="language-text">__str__</code> 特殊方法。</li>\n</ul>\n<p>我们来验证刚才提到的这六种写法：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-17-11-45-23-daa5d1c0286764827b97cf15cbcf7d98-43e4d.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 286px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 97.9020979020979%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsSAAALEgHS3X78AAACzUlEQVQ4y6VU13baQBTU/39OzslJTInoTTJFogmMkECAaKEZN5xMZlcKMbZsP+ThnlWdnbkze5WMZaPszpBsWviq15HtOzBWRzS397weImF2oU3XiBkdlD0f5uYO5v4Rxu5Blilq/yCfiVXJ9FzkbjwUnBnyXEuuj/JoiaI7R32xR9pyURjOoLZtFB1fbmbuTwQTAE+yjN2/UqrTn2Q458czFO0pKqMF1wm+FHX5XG31kR+MEW+0yXiMqr8LQR7flGCp6N6SrKZkQbDJCqmWhcbqFrX5FnluoLZuoPtrJAic7gxwpRnIDEZoHX9FAD4JwDlKZFdwJsjZY0r1KN2Fxo2uyV41Lckw1b6BNl6gMl6ef76UHYAq+mQppQnQ/GACfbJGtuugQHDBOmM5fO/L/mreiptsYKyPaGwfImUr195CSi46U5SGk7DYArLK9BzEqi26vESMbud4Hze6yFB6bblH8/AcsjxJlq3bZyiaAKSLBdtDkh8LVkUySlCqiE2278Igm5Q1gMpoCXPitRaM5QHXsw0qZF0ezRmpOVIdhwxpRGUUSE4IQDosWpBo9hinkWxDfXkr45RlxEqMTrY/Qs4ayp43+K7mb2nijkQWAWCJcnN07nu1yZ4NCeIhTomZri3vG6s7pHmt0hh9tiWrNdI9GyUa1KbbQm7zcAokC7pVxqR9/B30JGy2eTid3asJEzb38qc61/rPu/CkRJiSZaOrPBGav+G6u4jEy3y9jsnruJxzeMUG59m/pGGx6X3G4f7dk/BZScBY1ZTHLkkTVMZBSH7JJuqnKPZ/nysJsweNwyDdoWs99wLwPRYfS2auxGRR2wPpZJTkj0DeACYaHZQ4YdSOzSg4/y85TsAKA5kiQ5G5TyWHYyoAiRhfcR6nMieLysmdC4+ZcR6aj8G6f1W7qA2Dd8o3vSHPrzh2PwhuyB6GTC4qHPdvri/rD4mBrfJIvOfCAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 17 11 45 23" title="" data-src="/static/2023-10-17-11-45-23-daa5d1c0286764827b97cf15cbcf7d98-43e4d.png" data-srcset="/static/2023-10-17-11-45-23-daa5d1c0286764827b97cf15cbcf7d98-1e8ff.png 200w,\n/static/2023-10-17-11-45-23-daa5d1c0286764827b97cf15cbcf7d98-43e4d.png 286w" data-sizes="(max-width: 286px) 100vw, 286px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>然而问题在于，用这种方式来打印，不太容易看清这个值究竟是什么类型以及它具体是由哪些部分组成的。例如，如果按照默认方式调用 print 函数，那么我们无法区分打印出来的这个 5，到底是数字 5，还是字符串 5。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-17-11-45-41-08063e047ba6aa46d703c5160008f408-954b4.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 348px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 60.05747126436781%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAAsSAAALEgHS3X78AAABNElEQVQoz5WS626DMAyF8/5PtcHaAeNWkk1rEawEKJdwS6AthU2aaVGn/aPSUZRY/myfJMhMajMuVZorQWLl7Uf3Q/hAxLhESNknGs2et/7KoypNjUzgdsBikZBddLg6mRl3+GVTnuziSLrvpbBVHs1cbIDPuV12RAyb6rgUhlFll8q74InspO2XlQs1KizWknZcAO+TlRfJXiR9+pIbAGyzTj9U7wDfbq6dXIApLP7KOU0PEWSETI+Z7AavfmQkxcoN1CCFihB5cUM9aYy00aJi7YdayCAH4ms/1g+NGjJk58JkAjc9uAVh3uO6d+oz1MawcujQk+YCgpyrznMydFZoqmc1OHRuI01WR1gnz3fb0+Ndj//j6C0uyMwMj2qC5wO/TKM+BINvLa5UymAD3/OhEX4BvEmIzsM+nkYAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 17 11 45 41" title="" data-src="/static/2023-10-17-11-45-41-08063e047ba6aa46d703c5160008f408-954b4.png" data-srcset="/static/2023-10-17-11-45-41-08063e047ba6aa46d703c5160008f408-99c83.png 200w,\n/static/2023-10-17-11-45-41-08063e047ba6aa46d703c5160008f408-954b4.png 348w" data-sizes="(max-width: 348px) 100vw, 348px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>如果要用 print 调试程序，那么类型的区别就很重要。所以，我们需要打印的应该是对象的 repr 版本。这个版本可以通过内置的 repr 函数获得，该函数会返回对象的可打印表示形式（printable representation），这也是对象最为清晰且易于理解的表示形式。对于大多数内置类型来说，repr 返回的字符串是个有效的 Python 表达式。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-17-11-45-50-37fe56dc404659870b8d2fc43b178db1-13dee.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 136px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 70.58823529411764%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsSAAALEgHS3X78AAACX0lEQVQ4y3VTa1PaUBDN//8VnfZTpzMdqzLaqTysYNKAgTwJYUADOAiCPBMFgqfnXqRSSj/ssNnH2T1nL4o7foY/W9JW8OjX6FcnL9IX5k+Zm69kjYj70wWq45dNjax7rxVYihcl0O7uoYcPqEVrGJ0hnKcYLu2yWmeug5vOAFmnju9GGT8ME1d+iHJ3BI+DbILumhIsgC/pLI7zOuoxkNJdlLpjTl/AmUa4bIY4yhXw7ec1UtovZEyXmyxgC5uuYLLOIgubJn4V4biTJZwxqRGwFoGTX+HN1tK32WCPYlTnCWMJavEm70avmx7WuNOEQ5ZyCcWjdjftHrRmB9rtPXK1JrRGG4V6iHxwh7QdMNeF2ujyO8Q1c+ptR+YvbJ+yNJBxAmRYl/dbUKrUMKWXcKrqKLUfUCRo2qwi6wYE83GiGdSshQJ1O8ld4fgyj4zlQyfguVbCp5MzHKsl6usiXQ6gCN6VxwnpkDppuhNemxSE+aRWfpzD4oF8HszhFSuDGemTMunfdJ/kpY3+HEZvBnsYE5C8XeojBLaluCtY1FQavx022jMRW7x9v+dFnzwIY7JuexSLb0mYOLs1et5cTBxDgLzZrr/7vR9XvHiNLAU9LVZwVjTwNa9B740lqCkG7TX8Bbod/PZs5IaCQuUxhjmIYfUnMB74YKmXNA5zo+RP4yEg658NhbgUNMdL2oM5tVjQD5Hhc8jyyplaCHNXhr2tdodsNhTBQQS91cd52cRHPoMPRyl8vshSgjKvNyHgy8HmQ8DKNuiTntrpQ+V/Wm31UOwO5XPx5snB7f5H+TdKFv4mHUjFEQAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 17 11 45 50" title="" data-src="/static/2023-10-17-11-45-50-37fe56dc404659870b8d2fc43b178db1-13dee.png" data-srcset="/static/2023-10-17-11-45-50-37fe56dc404659870b8d2fc43b178db1-13dee.png 136w" data-sizes="(max-width: 136px) 100vw, 136px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>把 repr 返回的值传给内置的 eval 函数，应该会得到一个跟原来相同的 Python 对象（当然，实际中 eval 函数的使用必须相当谨慎）。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-17-11-46-06-3de8b6be4e0001899dd5cfcd9232be30-eb2d0.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 160px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 26.875%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsSAAALEgHS3X78AAABK0lEQVQY0y2Oa3PBUBiE8/9/TWtqlOkEMxghQk7kCE3cq6UIcb8+PaEfdt7L7uyulm5IXooG7vpETvaRq3j66LZEFx55t4PuerxbgnzHJ2lYpE2bQtAjY9mkDJuEYfJWq5MRLTRzsqDYHdHa3qlO1nhbMCch1a855f6E6niGM99S8MdYi4hSMCLn+jjLI+b3El2FZ2VAoTumNJyiucsDtfGCyvDngdjEUiHZdh+hWlvKrDyY4e3vWL8bxHxPa3Mh2/zEmq6QB1SJG150wd1e0SqDKYmSScZskCxXeS0ZFDtdUnWHujLQveDBy+jMh9Mma/uI8ECiaCquh7u7Ya+Oj/AYmrM60wxPyHD/QHOtZpwWXRH/wmasWV+Qu2cbV5k74fMnohOOukX8U/sfXZxl/GCvjUUAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 17 11 46 06" title="" data-src="/static/2023-10-17-11-46-06-3de8b6be4e0001899dd5cfcd9232be30-eb2d0.png" data-srcset="/static/2023-10-17-11-46-06-3de8b6be4e0001899dd5cfcd9232be30-eb2d0.png 160w" data-sizes="(max-width: 160px) 100vw, 160px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>用 print 调试程序的时候，应该先把要打印的值传给 repr，然后将 repr 返回的内容传给 print 去打印，以明确体现出类型之间的差别。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-17-11-46-13-e3bc44175d94a7623f70d4aa727f4d63-52b36.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 152px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 65.78947368421053%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAAAsSAAALEgHS3X78AAAB5UlEQVQoz41SiW7aQBT0//9L1aoVoVXMHROwAR972YDNbUNwfN/GpptQpKpSlUijp3m7844dLYP8i5pc1aSCfk6CUosrHFfAS5Qw1ZJKTWsSVyS+AC+W7FD2Muim2M+hX1AwMCi7eNnBBqebfbxgZdTRFo+QDJarFiCsCLvqsqfpHQmxImjKkFUwZ5g4vip+ztA2rRkZGRZ6TcZra6jv+d2pr61ne3u8Mh8F0CWGeHT7mjHamj3VeNI2guloyZUEb5MLFBQkyKWXEDgJ8nLgpFPTke0IhSUOS0I3dLPx/ji2bGFnj0yHP7yONqep5TIoyL73ucZoxi237Aw0hnxbgj8FsUfmD+Ppl1av+TxpAfyDF2mLXxOlt9jze/vbcNqUVQb5xdS0YZCpSY29FFBXzoFg2rIby07MbY6i5eIgmxxsFFbSOQReSZ0Tdi/SyWdgVA70Q1fTu3Nd2J6pt9RCRO0NindSUQHlKLrcIgxLCkpQVFLDysHi0FGNNtGf1yd6pPgZdZJKabwBBLdYUPIei1vK0GWE/RlHBUlr2u8u+hQYLb9+bXPDlYWT+vOVfybjsJ5ajuwmMLyAj4r/6f7mNm85jRmgH4A/OCQs/1bc3/yftaGXzaOaVdQnVdeiiqb3u/zDV/wG+Viz0YokeHYAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 17 11 46 13" title="" data-src="/static/2023-10-17-11-46-13-e3bc44175d94a7623f70d4aa727f4d63-52b36.png" data-srcset="/static/2023-10-17-11-46-13-e3bc44175d94a7623f70d4aa727f4d63-52b36.png 152w" data-sizes="(max-width: 152px) 100vw, 152px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>还有两种写法也能实现相同的效果，一种是把要打印的值放在%操作符的右边，让它替换左边的 <code class="language-text">%r</code> 格式化字符串，另一种是在 f-string 中使用 <code class="language-text">!r</code> 转换类型。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-17-11-46-23-03306163885a725278768fe3712de7ea-ba04d.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 365px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 58.356164383561634%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAAsSAAALEgHS3X78AAABQUlEQVQoz51S246CMBDl/7/KqCgiAi2QrMGVO1aglBYRwX3YgagPJBvNJifT6UxPO3OmkkbKTZKrSbFNSzOvwaoptS8/lugtcR/ty7lPIKnReb73lodo7Sf6iW3CTPZinVRWdXsy/4SEaGvkwiwbg9aY3ayyxeyqFzWuuvdkLRcGbfRMINo4vMfl1a7vgLfMgSwfEyh75riLvY/yWosLxAa+VfevK17XPSLPrbTyTnM3nH258iEyMq4TpqWFLXrEWoDFO0f0mLVDRxCsWsy7MXUFR9oldOGGoNYupSCbEhD5O1ocfMVLlfCsZxzlQj7Gq2OihtnSDeCw4p/WATHPXELFBd5xoBKoCsDHfvjoPyYEyg1ZqGKY0CM19rwlDBbMu08UmgqGx3l+KO+UrMY5LCZt/vG4pKV0R9gmIPYHX2qCX/8diR7PsvmtAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 17 11 46 23" title="" data-src="/static/2023-10-17-11-46-23-03306163885a725278768fe3712de7ea-ba04d.png" data-srcset="/static/2023-10-17-11-46-23-03306163885a725278768fe3712de7ea-d01b2.png 200w,\n/static/2023-10-17-11-46-23-03306163885a725278768fe3712de7ea-ba04d.png 365w" data-sizes="(max-width: 365px) 100vw, 365px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>对内置类型以外的类来说，print 函数所打印的默认就是实例的 repr 值，所以无须专门调用 repr，而是可以直接把实例传给 print。但问题在于，object 子类的 repr 默认实现不是特别有用。例如，我们定义这样一个简单的类，然后把它的实例传给 print。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-17-11-46-43-cbdd10b184b692117e89b90364323f7e-4e69e.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 401px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 44.13965087281796%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAAsSAAALEgHS3X78AAABTUlEQVQoz3WSaW+CQBCG/f9/qInVxqKUsAriwmo5BAW577Me2HRAP1VNJpvJ7Dyz77zZwUwz5044JspIlCcbndIsSjZw0pCylYozKS9SF2fIH2OwjCpK1hnTRXY0Waus6TN7j1IMWrf5sOD9HFkhH5YwQizO/2IgFZdV0qzihlL2U22HrBjZCbJjeBynUK+FqMLZ8ZHs4aoldQvZVN3RmsV7+Spq+KDs6tWV1L9wPiU7eOGlQvrD7Lypas5UkzUcEIzsUMyOcydGh2AZlS9hWjNhzzcOv2OZ3nvIiRjLZ50IduH8DKYIcfUShq0Wbgz8wk1Jfb2r7aVCLlXXp1bdYS7IgVl3u7VifoJWsKdzqOw7oHJrzbscZ6fbLc6PvWzD/iAqawVzJxnibxA/2WwpME+36a09FuXZ9oBM/8twPxUD/sIIfw8FabgknJ//AemO3ybO5Ks5AAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 17 11 46 43" title="" data-src="/static/2023-10-17-11-46-43-cbdd10b184b692117e89b90364323f7e-4e69e.png" data-srcset="/static/2023-10-17-11-46-43-cbdd10b184b692117e89b90364323f7e-c99eb.png 200w,\n/static/2023-10-17-11-46-43-cbdd10b184b692117e89b90364323f7e-66047.png 400w,\n/static/2023-10-17-11-46-43-cbdd10b184b692117e89b90364323f7e-4e69e.png 401w" data-sizes="(max-width: 401px) 100vw, 401px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>这种输出信息不能传给 eval 函数，因为其中没有包含 OpaqueClass 实例的具体字段。</p>\n<p>有两个办法可以解决这个问题。如果这个类受你控制，那么就自己定义 <code class="language-text">__repr__</code> 特殊方法，并返回一个包含 Python 表达式的字符串，让这个字符串能够用来重建该对象。下面就来给刚才的 OpaqueClass 定义这样一个特殊的函数。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-17-11-46-57-f567ab8788b4322e2209d6e93c84005c-9a912.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 481px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 25.987525987525988%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsSAAALEgHS3X78AAAA4UlEQVQY042Q226CQBRF+f+f0lhF5Fatg2lFFIEZRAREoY23bM+MMfGp8WFNcuay9pmjjZIc+oqjN1/jw4+INXo/IYwow2fRYFL9PSh/MT2c8VWf/kVjxwvsTQUz2UHKpdjiO/SDmIIE3O1BnduiBHtHKBfWXOG1N3Q8H/qSwxEV3KzGlMLY8aouvtOdEspH7raGJQo42Z6EQsnMOIcRZ/TVFh4Fsicq5AXaewbLWpPJ46LFOG8wCBJ0vwMYYYruzEeHzdFfRKoeEnooMKLZWjyHk5aw0wpDmr9sxqRxWbzEHbCibd/hrSq5AAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 17 11 46 57" title="" data-src="/static/2023-10-17-11-46-57-f567ab8788b4322e2209d6e93c84005c-9a912.png" data-srcset="/static/2023-10-17-11-46-57-f567ab8788b4322e2209d6e93c84005c-06486.png 200w,\n/static/2023-10-17-11-46-57-f567ab8788b4322e2209d6e93c84005c-fe61f.png 400w,\n/static/2023-10-17-11-46-57-f567ab8788b4322e2209d6e93c84005c-9a912.png 481w" data-sizes="(max-width: 481px) 100vw, 481px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>现在打印出来的 repr 值就有用多了。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-17-11-47-08-ad1d0c3a7b67acd25e6ad0322f232e65-bd67d.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 250px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 37.2%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsSAAALEgHS3X78AAABYElEQVQoz2VR2XKCQBDk/z8mD3kwSWkq3hoB2QUiEo13QBQRxDNqOrNblqWVh6nu7d2Z2ZlW1O8QGZWhPgrAghSaFyGjmSh9DlBweii1+yh3x6h0R8gyB0V3gCLdNfwI9uoH1b6HrNkGmyd4n8yhGNMI1a8xar0J6v0xCm4Pj1UNOdOlxwHcHeCszzLc7YWnJyp2hJkc0KJzm3Q7PeKDNIWFKXi0gR3vwRb0wyCWnUTos5VM4nTHk/0VhSbCuuCtprBoS8kh9CCRXS3RafMLe32CRSOZFBJFgTt+vPLbUFTaWaUzhE47cWSRA/T5SnZ3NmeJTExAjXi0k+cW6ULj8e5fUaXcHeLhrYy808GTxvHStCR/5S08Nxjytouc5cBYrGHMUjzWdDKNozH2URn6cqLb3ytWuIbqheRwjOZ0SW6tYM8pmbhKhumzGIa/BCdNuKr5CZpeDGdJ+1xs79Yh8A/dw/3IE4Ko7wAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 17 11 47 08" title="" data-src="/static/2023-10-17-11-47-08-ad1d0c3a7b67acd25e6ad0322f232e65-bd67d.png" data-srcset="/static/2023-10-17-11-47-08-ad1d0c3a7b67acd25e6ad0322f232e65-30978.png 200w,\n/static/2023-10-17-11-47-08-ad1d0c3a7b67acd25e6ad0322f232e65-bd67d.png 250w" data-sizes="(max-width: 250px) 100vw, 250px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>如果这个类不受你控制，那么可以用另一种办法，也就是把对象的实例字典传给 print 函数，这个字典指实例的 <code class="language-text">__dict__</code> 属性。下面这种写法可以把 OpaqueClass 实例的内容打印出来。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-17-11-47-18-9b489d25aab3e80cdd6d39ca6006dfb0-bd67d.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 250px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 36.4%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsSAAALEgHS3X78AAABcElEQVQoz22R607CQBSE+/6vo9GoQcWWgmDpnSIVWqGIbbn0wl1wHFZjYuKPyemePfvtdFZSgjFu7R60yRxOtkczmuLG8lDthUIPzwE1gOwPob6MoPYjagRzsYE+LdgPURuM8RjFVAJJ4ea16aIxjGEmJYEpLpoGbto2rqiK2YVM0H13gIrTg8xLFP8VepzDyrYCWO34aE9mBKaQ6gS2RjHUIILMQ/eOj7OGhjuvD684wJwucalZwmWNoE6+Ry14h02HTrFHZ/UJbw245QFu8QFJTwvYHLLzHYxpiXac4WmyQPNtDo0u1GGCdpLDSEvRr49StFgtzlsEippvf+oOkpYUwqrOA87yALv8gHMSv0/VXR7/6XHuF/ZXUiN8F7lovNWlUyvbfG9mO5GRudjyV/Yw52vYXHurI4zZiv31v1CpMUxRD2Mo/TfmtYIajnHHl+0yG9mPUA8mIkeDD3bObC9bOpSXCCcjDjM7QURkP/AvOUP61sRlsQ8AAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 17 11 47 18" title="" data-src="/static/2023-10-17-11-47-18-9b489d25aab3e80cdd6d39ca6006dfb0-bd67d.png" data-srcset="/static/2023-10-17-11-47-18-9b489d25aab3e80cdd6d39ca6006dfb0-30978.png 200w,\n/static/2023-10-17-11-47-18-9b489d25aab3e80cdd6d39ca6006dfb0-bd67d.png 250w" data-sizes="(max-width: 250px) 100vw, 250px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h3 id="总结-68"><a href="#%E6%80%BB%E7%BB%93-68" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>把内置类型的值传给 print，会打印出便于认读的那种字符串，但是其中不会包含类型信息。</li>\n<li>把内置类型的值传给 repr，会得到一个能够表示该值的可打印字符串，将这个 repr 字符串传给内置的 eval 函数能够得到原值。</li>\n<li>在格式化字符串里用 <code class="language-text">%s</code> 处理相关的值，就跟把这个值传给 str 函数一样，都能得到一个便于认读的那种字符串。如果用%r 来处理，那么得到的就是 repr 字符串。在 <code class="language-text">f-string</code> 中，也可以用值来取代其中有待替换的那一部分，并产生便于认读的那种字符串，但如果待替换的部分加了 <code class="language-text">!r</code> 后缀，那么替换出来的就是 repr 字符串。</li>\n<li>给类定义 <code class="language-text">__repr__</code> 特殊方法，可以让 print 函数把该类实例的可打印表现形式展现出来，在实现这个方法时，还可以提供更为详尽的调试信息。</li>\n</ol>\n<h2 id="第-76-条：在-testcase-子类里验证相关的行为"><a href="#%E7%AC%AC-76-%E6%9D%A1%EF%BC%9A%E5%9C%A8-testcase-%E5%AD%90%E7%B1%BB%E9%87%8C%E9%AA%8C%E8%AF%81%E7%9B%B8%E5%85%B3%E7%9A%84%E8%A1%8C%E4%B8%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 76 条：在 TestCase 子类里验证相关的行为</h2>\n<h2 id="第-77-条：把测试前、后的准备与清理逻辑写在-setup、teardown、setup-module-与-teardownmodule-中，以防用例之间互相干扰"><a href="#%E7%AC%AC-77-%E6%9D%A1%EF%BC%9A%E6%8A%8A%E6%B5%8B%E8%AF%95%E5%89%8D%E3%80%81%E5%90%8E%E7%9A%84%E5%87%86%E5%A4%87%E4%B8%8E%E6%B8%85%E7%90%86%E9%80%BB%E8%BE%91%E5%86%99%E5%9C%A8-setup%E3%80%81teardown%E3%80%81setup-module-%E4%B8%8E-teardownmodule-%E4%B8%AD%EF%BC%8C%E4%BB%A5%E9%98%B2%E7%94%A8%E4%BE%8B%E4%B9%8B%E9%97%B4%E4%BA%92%E7%9B%B8%E5%B9%B2%E6%89%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 77 条：把测试前、后的准备与清理逻辑写在 setUp、tearDown、setUp-Module 与 tearDownModule 中，以防用例之间互相干扰</h2>\n<h2 id="第-78-条：用-mock-来模拟受测代码所依赖的复杂函数"><a href="#%E7%AC%AC-78-%E6%9D%A1%EF%BC%9A%E7%94%A8-mock-%E6%9D%A5%E6%A8%A1%E6%8B%9F%E5%8F%97%E6%B5%8B%E4%BB%A3%E7%A0%81%E6%89%80%E4%BE%9D%E8%B5%96%E7%9A%84%E5%A4%8D%E6%9D%82%E5%87%BD%E6%95%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 78 条：用 Mock 来模拟受测代码所依赖的复杂函数</h2>\n<h2 id="第-79-条：把受测代码所依赖的系统封装起来，以便于模拟和测试"><a href="#%E7%AC%AC-79-%E6%9D%A1%EF%BC%9A%E6%8A%8A%E5%8F%97%E6%B5%8B%E4%BB%A3%E7%A0%81%E6%89%80%E4%BE%9D%E8%B5%96%E7%9A%84%E7%B3%BB%E7%BB%9F%E5%B0%81%E8%A3%85%E8%B5%B7%E6%9D%A5%EF%BC%8C%E4%BB%A5%E4%BE%BF%E4%BA%8E%E6%A8%A1%E6%8B%9F%E5%92%8C%E6%B5%8B%E8%AF%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 79 条：把受测代码所依赖的系统封装起来，以便于模拟和测试</h2>\n<h2 id="第-80-条：考虑用-pdb-做交互调试"><a href="#%E7%AC%AC-80-%E6%9D%A1%EF%BC%9A%E8%80%83%E8%99%91%E7%94%A8-pdb-%E5%81%9A%E4%BA%A4%E4%BA%92%E8%B0%83%E8%AF%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 80 条：考虑用 pdb 做交互调试</h2>\n<h2 id="第-81-条：用-tracemalloc-来掌握内存的使用与泄漏情况"><a href="#%E7%AC%AC-81-%E6%9D%A1%EF%BC%9A%E7%94%A8-tracemalloc-%E6%9D%A5%E6%8E%8C%E6%8F%A1%E5%86%85%E5%AD%98%E7%9A%84%E4%BD%BF%E7%94%A8%E4%B8%8E%E6%B3%84%E6%BC%8F%E6%83%85%E5%86%B5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 81 条：用 tracemalloc 来掌握内存的使用与泄漏情况</h2>\n<p>在 Python 的默认实现方式（也就是 CPython）中，内存管理是通过引用计数（reference counting）执行的。如果指向某个对象的引用已经全部过期，那么受引用的对象就可以从内存中清除，从而给其他数据腾出空间。另外，CPython 还内置了循环检测器（cycle detector），确保那些自我引用的对象也能够得到清除。</p>\n<p>从理论上讲，这意味着 Python 开发者不用担心程序如何分配并释放内存的问题，因为 Python 系统本身以及 CPython 运行时环境会自动处理这些问题。但实际上，还是会有程序因为没有及时释放不再需要引用的数据而耗尽内存。想了解 Python 程序使用内存的情况，或找到泄漏内存的原因，是比较困难的。</p>\n<p>第一种调试内存使用状况的办法，是用 Python 内置的 gc 模块把垃圾回收器目前知道的每个对象都列出来。虽然这样有点儿笨，但毕竟可以让我们迅速得知程序的内存使用状况。</p>\n<p>下面先定义这样一个准备接受测试的模块，让它生成一些对象并加以引用，从而令这些对象能够占据一定空间。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-18-10-47-11-eb9a4332ec38ff11b3728c605ccde784-954b4.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 348px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 109.48275862068965%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAWCAIAAABPIytRAAAACXBIWXMAAAsSAAALEgHS3X78AAAC6UlEQVQ4y31Uh5KiQBT0/z9ob2vPhGBAVMKQJSdRQaKYd++Bbl3d1WpVM0rV9Ey/fv1oja3V2A57ok5ozlBzO4w8UMyJvcaXDkqOfH5+gdbI8DFJG2o2aa/6irHY5ExU0lG5iAqUn1B+foEWbJ2vUzbeo+TAxJVYfQKE/Y0vLvWO7PSavKc3ORtX1CoZ2atpEAMW2wLIAKG88uX1KXnuxWPDnxh+T9B/sxIm6m1WntghSo9MVEyDHb2pD0LNWXeg4nFcC/5J1ddI90hng9ITmIcpBpBH5qov65ikE7rLZycmqehdxewqFqrb7VF2rMlcdgKANqhzqPsDxRiaQYeRCMUCI6ggGunu2PA6vPqxEN4XPL60+rw6C2KgtOqqQEyzCvlF3N+Ee5HpqXYL1uRY3wMXwGt25hs8ZOOaM3HCgeoQULkT9mSzr5pksG3cPnENnhu2TrnsiKk2CGsjZWj6U3c7WFqNlqtQ3sT951NyvWP/CXUShketdotNtlhnUyeko3y+zSk/mrhrNj3+TIYHFAJtFmYQGMrdghbIbJsWMVkfSEabk+fr5Mdut+4/wIdgYYrV41VIKAj5oIUuUtqs1JcN8IJLD8/J+VkobrMwJTS7g1SQiikmkGuIyw6SYARQfvmfzKVHvrxAKjDJAOZilfQlvYPkDiezuwp21CnI/7bnHzKYWRubn0UIXdNJNqm45AAravLzajCGhjd117MwGejgdgy7pcMX1I++B+MVmfQiGABMNX9R7Nj0KG87skPS3YBOOirAhfqgp30ur2L1BQPQ45eQ2JEZDCQdV0wmTEh33RWWlB/zTfjvEf7Ocg0w7FT3OYhnwY6JS9Lb0DVt05e0ZiT8LvQ5iOvPy7aAeQIXQREdlzA2j1YJxUXa33DVhvYSmoUvbZjEgWpN7OA3I3QFtSfrbzMWUy1ctSDIXVHDNbsFloIrpBNCnqCZcP/7HH0w/MQMMNl4m3GE7sOo3bPwqPb+hSoufwCX/JBWIowkOQAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 18 10 47 11" title="" data-src="/static/2023-10-18-10-47-11-eb9a4332ec38ff11b3728c605ccde784-954b4.png" data-srcset="/static/2023-10-18-10-47-11-eb9a4332ec38ff11b3728c605ccde784-99c83.png 200w,\n/static/2023-10-18-10-47-11-eb9a4332ec38ff11b3728c605ccde784-954b4.png 348w" data-sizes="(max-width: 348px) 100vw, 348px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>现在我们运行下面这个程序，通过内置的 gc 模块把刚才那个模块执行之前，与执行之后所追踪到的对象数量分别打印出来，并选取其中几个对象展示一下。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-18-11-48-57-4b1099c65756e55c84fa2f1d976d017a-bed19.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 416px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 104.08653846153845%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAVCAYAAABG1c6oAAAACXBIWXMAAAsSAAALEgHS3X78AAADG0lEQVQ4y3VVaXfaQAz0//9B7WsMBnOGw8YXZzCYw9yUK0lJkz51JJvUQPNBb9fetTQajWSlHMypNJhQ/mlMmY5PxWFIJZizP5N7eCMH5n5h/ztTqpMl5bpDMuc7OB1RfXUg9/ibnOObrNf2fvXsiNPLGplibV+osXkWRDb21s9XsrHnQ3v3S/b27iwr35V3MEGHABdHlwAKo0q7HbqsqtOmQn9M9upEZT+kXNsnrflE2faAUjgr4iyLd9XphpzYsXP8h1KpzbZUCzewNbib4oMJPY7mZG9eyAXaR3DMAbSWLzzzPt3qY51QwZ/AyfnaoYV0OWVOlc3cnGQ11kcxTs89vSc4e7viMPleHFana4lsLHZAtiS9M8S6oAwQ5boj4gw8dgjzTh+fzr2bIJ8OzdWR2Gygqi/2ETJ+lsKcyVyfqAHjtYZzkzNCcYzlQYp0h7A0nAkvzKHeC6g4CElHgWqQUQOOM52BvBOdtgb0OF5RFZzz3epsI0ivHDZiBCIZ5hLGexapyIRltI34je69yrkH/TVf/tzxqLAMUk6HikCVstv0o+GhW6byURnoWS5pt0vpZo9Uq0V5IGN5cYcxNXccloOQ6iKZkKrjtcihgrTM+Z4sfFBAqrneCLLpYw1IRwAdz6VghpYNo5ZLImQ+zOVexFoJFlRBpfPdAGhbpHk9EbrW7FMG+xJQ1cFt8/mDPDZU/Q7hhQd2ytKpQEYsFZZTwZ9KAWogvwgRG7EzEfONowTCNSRxkIiR1t6jIYBVkMTv5DzuXfcLZ+JQRUG4VyWdcEsanhmleyOHT4snUbRPdE1sSg58sUNudpbMd8OB3voRingmJmffHUJugMQ9hUXLDvI8RdB2qtUWvnhGPmCfdnvSkjwIsigOS6mM4rFssmjPLL5VIbcHGLerIh3gPZEOBymnS6rZwtiaSpBvhg1duuiUmZyrqDxPIwbBloI+NWjyu2FFmSGgwhd0SIbbjyOwiIvQJmuNI6fctkiJEWaE6xlGGhBixGXafQwTX+5orZ5kpTTiwSATOh4ITpKrxL/F2d+cXf1PInH/BZ1E8UjpCH7TAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 18 11 48 57" title="" data-src="/static/2023-10-18-11-48-57-4b1099c65756e55c84fa2f1d976d017a-bed19.png" data-srcset="/static/2023-10-18-11-48-57-4b1099c65756e55c84fa2f1d976d017a-3bbab.png 200w,\n/static/2023-10-18-11-48-57-4b1099c65756e55c84fa2f1d976d017a-35132.png 400w,\n/static/2023-10-18-11-48-57-4b1099c65756e55c84fa2f1d976d017a-bed19.png 416w" data-sizes="(max-width: 416px) 100vw, 416px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>gc.get_objects 函数的缺点在于，它并没有指出这些对象究竟要如何分配。在比较复杂的程序中，同一个类的对象可能是因为好几种不同的原因而为系统所分配的。知道对象的总数固然有意义，但更为重要的是找到分配这些对象的具体代码，这样才能查清内存泄漏的原因。</p>\n<p>Python 3.4 版本推出了一个新的内置模块，名为 tracemalloc，它可以解决刚才讲的那个问题。tracemalloc 能够追溯对象到分配它的位置，因此我们可以在执行受测模块之前与执行完毕之后，分别给内存使用情况做快照，并对比两份快照，以了解它们之间的区别。下面我们就用这个方法把受测程序中分配内存最多的那三处找出来。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-18-11-49-20-270d5077fe00d1bdc38f8a0a9587ba96-b1c4a.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 562px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 77.75800711743773%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAIAAACZeshMAAAACXBIWXMAAAsSAAALEgHS3X78AAACY0lEQVQoz3VS23KbMBTk/7+oD21TX8CADdjEbo0v3AUIJO527DjpdAVNJy+dOcMcCe1qd48kxUvm51jxUz0uzLwx8tZu7s/t63+rudvtqzjT3CUjqwxaAaOGOWqZlnZz23YPca57/G2GQr/r31DboXaXd0kN6fToL7xEDejCTxWP4GsW3aZ6sfjF4v2mvo1ISFsEqRpmqp/Oj6HsEQFW/GzN+kWQzd1YDTKNFLKfaFGBJRqD1iN4lZbg1eICLLNTqEW5tEorKF9ltU6YHrFFQDfl9ZPaT7L7xygYf8dGsli/Zp2R1ausWhKGxio6hLEdDAuWDyIYAe+6vNo1HPV29SKZaaWFueZnypnMDoEe5fAPhcJz0Qnz5fW5FVwGKWEVf42EzxwfKGmZlCi7ui0Jh/9lwi0kH+VwoXgpTFp5J0S2DzQgBd0q4VpE17yX4FsjbMMuQK4Il88ibVBoMcOOXd8Qio6jRS9IQ6qF1KJDg8DUOMc7UVwCPRPHm+w9GbKzes0vuARgmLS4aGDEHIxgxyxaDEiCGQgw83aJGwj/lyTeAGpcjs3uYxP18/p7271JEIlJGrQB3mS9CJ9fjbzRE47XJqZAazRwiwYRjkPR4hz5S0/787ed88WwlXP849f5aXea7r3pIUBmcC6OpiUU6aIXRAhIxBQXAjxxfFj9+rxX/GR2jICX3Xh+ivBbXJhV+nAnlhbrgASLPIgVj2R2CGcH//vugABlN8KdMAK8GlGkgssHCwy+MFGYEnYSBlKkIOH0xHExfQQ+ddzpwZddorgIvAIYUgVFWiER4XkEIwvaAPwHDixMtIQlPMgAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 18 11 49 20" title="" data-src="/static/2023-10-18-11-49-20-270d5077fe00d1bdc38f8a0a9587ba96-b1c4a.png" data-srcset="/static/2023-10-18-11-49-20-270d5077fe00d1bdc38f8a0a9587ba96-3ced9.png 200w,\n/static/2023-10-18-11-49-20-270d5077fe00d1bdc38f8a0a9587ba96-4c4f5.png 400w,\n/static/2023-10-18-11-49-20-270d5077fe00d1bdc38f8a0a9587ba96-b1c4a.png 562w" data-sizes="(max-width: 562px) 100vw, 562px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>每一条记录都有 size 与 count 指标，用来表示这行代码所分配的对象总共占用多少内存以及这些对象的数量。通过这两项指标，我们很快就能发现占用内存较多的对象是由哪几行代码所分配的。</p>\n<p>tracemalloc 模块还可以打印完整的栈追踪信息（当然了，这最多只能达到调用 tracemalloc.start 函数时设置的帧数）。下面我们把程序中分配内存最多的那行代码所对应的栈追踪信息打印出来，看程序是沿着哪条路径触发这行代码的。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-18-11-49-45-ccda6be33cb3b3967cd60f952b1a2ead-4fab5.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 402px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 126.3681592039801%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAZCAIAAAC+dZmEAAAACXBIWXMAAAsSAAALEgHS3X78AAADW0lEQVQ4y4VUCY7iSBD0/z+02u3msA3YxjD4AIzxfdv4AgPNMb3SRhUaTcOO1FLJKorKjMjIyGLEsBCDfGLH+PJWiJ9jN9EOV727f7sYyc9505OTWgx33MbraSZrurwdLurj8vjzm2B1f1XbC3bYaO1FbT60/Q0n5Ofh9k3wxEt5Jx6u7ZEVcttQjquRHU38dGh6YlwsT5+Pe0iEpC/pGNzrLS0x2s2zlreCgeEMNy5reWMvAXnO9IUwf19aw4032LhikD0Fa/ur0nyApH64a7QEypnSfvzVXpTm/DjEyVOwEOUgPEsbwcsGhiuGOQuQtTONS8IZmh1/UuXIhnyfkA83pMSOgpC1qM8U5KJ/xaFZ9Gf9mWlSKeWRNX3WCjg7fNfMkROJUc5ZIbv1ddpwolZ7/RNtsF1Z03A3z/ec5Q+gjeGwW2/iJrwV8aYvBUVP37I43LhSmH3lwixBu/1Y0h7QVhOdCAJdSv2h1GelOsMCj6Xj5uFGi70yIMlZwbzYL4qOMz3ATpPyjfjMF/x85MSCl7CGO/EyrblIcTFxItb0Jl4iRQUzNAhDpewGhgWrgN48a9TmotQn9RfUw3APt2oUFocgy0zDXI4KwU/GTtRfbmlwO3ISVItc82wvJ5Wc1hCVFnLD0qgpiGCzpJyntRTmkF2KK4gEb8FkHOGW8paPjL2VLccl7oh+hlrGdqLWZyLYojqCxur0CVbke/pcnf6lrO5ad6fi/R4SSvj+gCXI/bU1ssNpWstFC58LQQ4zQ15IuKJ+eqT743gyUlr9PddQnuClaDhnusO1A3pjO5bCctnd5aSUgnyWt1r3OqEMsqIHctrMYBLTh/LI8qZuSM1+KgbF2A5nWYPZ0P8HDm9f8Zjg9ZGi8l01+K2Ph+UvWR07MQDRbaXo8M6gBXLWvgaTkdgd+ysbfkDk0HDxGEDtwcrprWBVF+OFOcMFvHCL+vS1eAbCSuEObwBHG4thAOY/itFDz03vXTOksMAeWaCIUp30p2Agl8eh6c7Slt8Gb8pyqJt93RzbEYYc/Vx1nz/K46LsfhSd/vIMaRSZN0Gv4p1osLYhVU83RraPUuW8QVdhHjmr1er80jBCe7Hrxm4Mtm/aBgohC6rAJPQNG1QFP8OQ97QN4fws2H/2RiRiit28twAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 18 11 49 45" title="" data-src="/static/2023-10-18-11-49-45-ccda6be33cb3b3967cd60f952b1a2ead-4fab5.png" data-srcset="/static/2023-10-18-11-49-45-ccda6be33cb3b3967cd60f952b1a2ead-6bdb3.png 200w,\n/static/2023-10-18-11-49-45-ccda6be33cb3b3967cd60f952b1a2ead-9ead5.png 400w,\n/static/2023-10-18-11-49-45-ccda6be33cb3b3967cd60f952b1a2ead-4fab5.png 402w" data-sizes="(max-width: 402px) 100vw, 402px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>这样的栈追踪信息很有用处，因为它能帮我们找到程序中累计分配内存最多的函数或类。</p>\n<h3 id="总结-69"><a href="#%E6%80%BB%E7%BB%93-69" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>不借助相关的工具，我们可能很难了解 Python 程序是怎样使用内存的，以及其中有些内存又是如何泄漏的。</li>\n<li>gc 模块可以帮助我们了解垃圾回收器追踪到了哪些对象，但它并不能告诉我们那些对象是如何分配的。</li>\n<li>Python 内置的 tracemalloc 模块提供了一套强大的工具，可以帮助我们更好地了解内存的使用情况，并找到这些内存分别由哪一行代码所分配。</li>\n</ol>\n<h1 id="协作开发"><a href="#%E5%8D%8F%E4%BD%9C%E5%BC%80%E5%8F%91" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>协作开发</h1>\n<h2 id="第-82-条：学会寻找由其他-python-开发者所构建的模块"><a href="#%E7%AC%AC-82-%E6%9D%A1%EF%BC%9A%E5%AD%A6%E4%BC%9A%E5%AF%BB%E6%89%BE%E7%94%B1%E5%85%B6%E4%BB%96-python-%E5%BC%80%E5%8F%91%E8%80%85%E6%89%80%E6%9E%84%E5%BB%BA%E7%9A%84%E6%A8%A1%E5%9D%97" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 82 条：学会寻找由其他 Python 开发者所构建的模块</h2>\n<p>Python 有个集中存放模块的地方，叫作 Python Package Index（PyPI，网址为 <code class="language-text">https://pypi.org</code>），你可以从中安装模块，并在自己的程序里面使用。这些模块都是由 Python 开发者所构建并维护的，这些开发者合称 Python 社群。如果你面对一项自己不太熟悉的需求，那么可以去 PyPI 搜索一下，看看有没有哪个软件包能够帮你更快地实现目标。</p>\n<p>要从 PyPI 安装软件包，可以在命令行界面执行 pip 命令（这是个递归的首字母缩略词，指 pip installs packages）。有时候，为了确保 pip 命令针对的是 Python 3 而不是 Python 2，可以用 <code class="language-text">python3 -m pip</code> 的形式来执行（参见第 1 条）。用 pip 工具安装模块的过程很简单，例如，本书里提过一个叫作 pytz 的模块（参见第 67 条），如果想安装这个模块，那就执行下面的命令：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-20-10-25-01-bac87ac8cf3e3835d9435e27588d99ba-32714.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 321px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 31.15264797507788%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAIAAABM9SnKAAAACXBIWXMAAAsSAAALEgHS3X78AAABMklEQVQY0xVQ2XKCQBDk/38nD6kQkUMhXiXXsrss7EJxxAieLBqVWJXxpatnanp6ehQ7+3ZEZVGuutgiwmu7RbG1eT2O2LLeWSwzcKJ60bJs7aTQEJ0XbdQ/w/M97B6KxQojFlqUGJhPWO7km1m+GSM2FTVMuK10G+m1Ep1uq5/juumCwxXJByhf4mW9t3mlU2EQ7vAS/HWcWEnhtX0kB9T/gQ9gKAcg0eWJ5ACyF8pBweeHzcv3VWjQVMepSWCLMGge7C5u03m7Hqz806+3v4SHK5T+6Rac7/7xCn1lwgqLCtDMsuorq0ySLqp2FDI7LR1RfqzRFGITriGmB/TNWUGoedHoKAYnxYozuFP1McTWImZQblKxKBsgY5wYJP30iUmzCXwrjCHOyCOqi8xYOMX2H+zFMsr7ZA/bAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 20 10 25 01" title="" data-src="/static/2023-10-20-10-25-01-bac87ac8cf3e3835d9435e27588d99ba-32714.png" data-srcset="/static/2023-10-20-10-25-01-bac87ac8cf3e3835d9435e27588d99ba-809d6.png 200w,\n/static/2023-10-20-10-25-01-bac87ac8cf3e3835d9435e27588d99ba-32714.png 321w" data-sizes="(max-width: 321px) 100vw, 321px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>pip 最好与内置的 venv 模块搭配使用，这样可以给不同的项目分别安装不同版本的软件包，以适应每个项目自身的要求（参见第 83 条）。你可以自己创建软件包并发布到 PyPI 与其他开发者共享，或搭建私人的软件包仓库，让 pip 从这里安装模块。</p>\n<p>PyPI 中的每个模块都有软件许可协议。很多软件包（尤其是经常用到的那些）采用的是自由或开源协议（详情参见<a href="https://opensource.org/%EF%BC%89%EF%BC%8C%E8%BF%99%E6%84%8F%E5%91%B3%E7%9D%80%E5%9C%A8%E5%A4%A7%E5%A4%9A%E6%95%B0%E6%83%85%E5%86%B5%E4%B8%8B%EF%BC%8C%E6%88%91%E4%BB%AC%E9%83%BD%E5%8F%AF%E4%BB%A5%E7%BB%99%E8%87%AA%E5%B7%B1%E7%9A%84%E7%A8%8B%E5%BA%8F%E7%BA%B3%E5%85%A5%E8%BF%99%E7%A7%8D%E8%BD%AF%E4%BB%B6%E5%8C%85%E7%9A%84%E4%B8%80%E4%BB%BD%E5%A4%8D%E6%9C%AC%E3%80%82" target="_blank" rel="nofollow noreferrer noopener">https://opensource.org/），这意味着在大多数情况下，我们都可以给自己的程序纳入这种软件包的一份复本。</a></p>\n<h3 id="总结-70"><a href="#%E6%80%BB%E7%BB%93-70" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>Python Package Index（PyPI）含有许多常用的软件包，这些都是由广大 Python 开发者构建并维护的。</li>\n<li>可以用 pip 命令行工具从 PyPI 里面安装软件包。</li>\n<li>大多数 PyPI 模块都是自由及开源软件。</li>\n</ol>\n<h2 id="第-83-条：用虚拟环境隔离项目，并重建依赖关系"><a href="#%E7%AC%AC-83-%E6%9D%A1%EF%BC%9A%E7%94%A8%E8%99%9A%E6%8B%9F%E7%8E%AF%E5%A2%83%E9%9A%94%E7%A6%BB%E9%A1%B9%E7%9B%AE%EF%BC%8C%E5%B9%B6%E9%87%8D%E5%BB%BA%E4%BE%9D%E8%B5%96%E5%85%B3%E7%B3%BB" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 83 条：用虚拟环境隔离项目，并重建依赖关系</h2>\n<p>程序变得比较大、比较复杂后，可能需要依赖更多的第三方 Python 包（参见第 82 条），那时我们可以通过 python3 -m pip 命令安装 pytz、numpy 以及其他许多模块。</p>\n<p>问题在于，pip 会把新的软件包默认安装到全局路径之中，这样会让涉及该模块的每一个 Python 程序都受到影响。有些人可能觉得这不会有什么问题：如果只安装模块，而不在 Python 程序里面直接引入它，那这个程序就不会受模块的影响了吧？</p>\n<p>其实问题出现在间接的依赖关系上面，也就是说，直接引入的虽然不是这个模块，但你引入的其他模块却必须依赖这个模块才能运作。例如，如果你打算直接引入 Sphinx 模块，那就用 pip install 命令安装该模块，安装好之后，可以通过 pip show 查看它的依赖关系。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-20-10-38-34-5d8b7b14035d8b5e51b54698fd77df53-79545.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 520px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 45.19230769230769%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsSAAALEgHS3X78AAABpElEQVQoz31S2VbiUBDM//+ROJgVCOKMQkKAEAJZgBA9IjO4O1NWdzzq0zzUuUvfW11Vp41uWsKd53BmK/SLa/SyCn6+Qyddw19VcOIM5+sbBIdnjO6edP0fjNYwgpfk+rGbbvBrd0B4fMX4/h/xVxEe35r9sTkHf14R/H75xEiafcCwpynawRR+VsNLC1izlMq2qtpN2GS1IbZUXLJOLEr8rA8YUu3V/qFR/Y3UsCcJzChBj5/6xQ72dAGbpE68UkJpZo7ncKZLvTMnC5IWGo3L9aK6Q0jFn4Sty7ESOvMMneUGZ+GMnxKS5SRfQhxIvl3WzGiBdhSjQ6J+XqNX1E123+wb1iSFxa4uM/SSQvcWG3i0LBBVFkmVOM71nbzp0NFgu8fw9kGVSQSq8Ix2xIZ0d6nSJYFNRU2DHFI/oQtRJXety0iVD8prmDM6IMTNjyBmxmsYp8MJc4ppi5350KUKWbvZFr2cI8SP3nKtcQw4Pn62Y63i3Ubv/LKGSyIhk3EzpGM7jNWuZHlR7THaPzLoNx0XHRkZF9kz/LGev/BVb968A4XBg7fTUaomAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 20 10 38 34" title="" data-src="/static/2023-10-20-10-38-34-5d8b7b14035d8b5e51b54698fd77df53-79545.png" data-srcset="/static/2023-10-20-10-38-34-5d8b7b14035d8b5e51b54698fd77df53-679cb.png 200w,\n/static/2023-10-20-10-38-34-5d8b7b14035d8b5e51b54698fd77df53-c2508.png 400w,\n/static/2023-10-20-10-38-34-5d8b7b14035d8b5e51b54698fd77df53-79545.png 520w" data-sizes="(max-width: 520px) 100vw, 520px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>假设你又安装了一个模块，比如 flask，那么就会发现，这个模块与刚才安装的 Sphinx 模块一样，都要依赖 Jinja2 软件包。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-20-10-38-49-8893dbdfa94b69d03f940d4dbe41d4f9-ab538.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 564px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 25%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsSAAALEgHS3X78AAAA/ElEQVQY02WQ607CQBCF9/1fyBgVQuktYqm9qC2F3iiVBhppizdKcpwdEo3w48vu7J6cMzNCT0qoiyXGUYbJqsZ9sYG5rGDmFYy0xKSs4XUHuM03POL8ZNq/u7hxXjAKU2iLAuNZBrt+h9/1ZNLD3x9JfPiP/Gv7k0bWzSmMA6gWCpkMn+d4oO70eAVllnJ38l2d55ATGOkaGv1pccH1KIhZa6SvjJlVrDFpOjF8ijAgQy0hQb7GnRcQIYVEUKMcAz/iCaROGkmuLA/Xto/ppoWz+4Lz9vmLuHUDKGHCnemUZlU7Zrrt4EoxrUAK7e2e6PBYf7CRVTWX6yB+ANDmaLearsjDAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 20 10 38 49" title="" data-src="/static/2023-10-20-10-38-49-8893dbdfa94b69d03f940d4dbe41d4f9-ab538.png" data-srcset="/static/2023-10-20-10-38-49-8893dbdfa94b69d03f940d4dbe41d4f9-4fcfe.png 200w,\n/static/2023-10-20-10-38-49-8893dbdfa94b69d03f940d4dbe41d4f9-9c055.png 400w,\n/static/2023-10-20-10-38-49-8893dbdfa94b69d03f940d4dbe41d4f9-ab538.png 564w" data-sizes="(max-width: 564px) 100vw, 564px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>这正是有可能出现冲突的地方，因为 Sphinx 与 flask 这两个模块刚开始可能依赖的是同一个版本的 Jinja2 包，但是半年或一年之后，Jinja2 有可能推出新版，而这个新的版本，可能会让依赖旧版 Jinja2 的那些代码无法运作。如果我们通过 python3 -m pip install —upgrade Jinja2 命令，把全局环境之中的 Jinja2 升级到新版，那么使用旧版 Jinja2 所编写的那个软件包，就会出现问题。例如，如果 flask 也随着 Jinja2 升级到了新版，而 Sphinx 包依然采用旧版编写，那么更新 Jinja2 之后，Sphinx 就不能用了。</p>\n<p>之所以会有这个问题，是因为同一个模块在 Python 的全局环境中只能存在一个版本。如果某个软件包需要使用新版模块，而另一个软件包需要使用旧版模块，那么就会遇到两难的局面：不论这个模块是否升级，这两个软件包都会有一个无法运作。这种情况通常称为 dependency hell。</p>\n<p>有些软件包的开发者，在推出新版的时候，可能想要兼顾那些采用旧版所编写的代码，让它们依然能够运作（参见第 85 条），如果你使用这种软件包所提供的 API 来编写模块，而这些 API 的行为在新版和旧版之间却发生了微妙的变化，那么还是有可能出现依赖问题。例如，程序依赖了多个这样的软件包，如果有的软件包升级到了新版，有的还在使用旧版，那么程序的行为可能就会错乱。所以，这种情况下必须特别小心。</p>\n<p>这些问题，在与别人合作开发同一个项目的时候，会变得更加严重。不妨设想一下：如果他们的电脑所使用的 Python 版本以及全局环境下的软件包版本，与你所使用的有一些区别，那会出现什么结果？在这种情况下，同一套代码有可能在其中一个人的电脑中能够正常运行，但是换到另外一个人的电脑上，就出现错误。</p>\n<p>上面提到的种种问题都可以通过 venv 工具解决。这个工具能够创建虚拟环境（virtual environment）。从 Python 3.4 开始，pip 与 venv 模块会在安装 Python 时一起默认安装（可以通过 python3 -m venv 命令来使用 venv 工具）。</p>\n<p>venv 可以创建彼此隔绝的 Python 环境，我们能够把同一个软件包的不同版本分别安装到不同的环境里面，这样就不会产生冲突了。这意味着能够在同一台电脑上面给不同的项目创建各自的环境，并在里面安装它们所需要的软件包版本。为了达到这样的效果，venv 工具会把这些软件包以及它们所依赖的其他软件包都专门安装到单独的目录结构里面，使得多个环境之间不会发生冲突。这种机制，也让我们可以把项目所要求的环境在其他电脑上面重新建立起来，令程序能够可靠地运行，而不会出现意外的问题。</p>\n<h3 id="在命令行界面中使用-venv-工具"><a href="#%E5%9C%A8%E5%91%BD%E4%BB%A4%E8%A1%8C%E7%95%8C%E9%9D%A2%E4%B8%AD%E4%BD%BF%E7%94%A8-venv-%E5%B7%A5%E5%85%B7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>在命令行界面中使用 venv 工具</h3>\n<p>下面简单地介绍 venv 工具的用法。使用这个工具之前，一定要先查清当前操作系统里面的 python3 命令究竟指向哪里，而且要知道它的版本。在笔者这台电脑中，python3 命令位于/usr/local/bin 目录之中，它的版本是 3.8.0（参见第 1 条）。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-20-10-39-16-f30a744c7bce54e8f221d8052c9e5e88-b5114.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 212px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 38.679245283018865%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsSAAALEgHS3X78AAAByUlEQVQoz02R6XLaUAyF/f5P0mm6DE0mQEhwwYABg3dDwA37GoJZAkmapV9lN5npD42kueceHR0pXnSk1pvibST3ZzQnK8zZmvpoibs+4Ky22IuISm+MtdzQnEfogzmtzQPB7hF/+x7vtWKvj1y6HfTRik9ZlWIrJGv7pJsepf6cE7VEpuHyrWRwVjX5oTfIWC1a+1eC+zf8wxvB4Y/Ev1oJ9s+Y8y3WbCN5gy8Dit2xqBJlyx3V4ZKqqC3JFuYsojG9oxln2eRDbYyJ69pggeJtn6iNbjktG6RkeuVmSrW/IGf6nEmfNj20sC/vddR2yLnhkHfafP1ZltpCddt8vizwXdPJe10URxRp3SG2+KUP50K+oNDtUxbiys1YyMVfGereHWSDNcb4VhQtMARbFXX1wQxrtaN9lJXFBsWJHoRwgC7Ak7xG3u+S8675opY5rduibpQA7dWecjgkJZtknRb5ICTnd5Je603Ev1fc3W85ilz5wgkSL3ICrMhjMRRA9Jh405CLq50h2q8J5jTi+onk80cEsbL7l4TMk3sorii8cjqcNxzS4k/GdEnVDOqTNYV2L1GVsQKu/DDxOpDPTmyBEPwfMVmc/wJSDjfQoBq1nAAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 20 10 39 16" title="" data-src="/static/2023-10-20-10-39-16-f30a744c7bce54e8f221d8052c9e5e88-b5114.png" data-srcset="/static/2023-10-20-10-39-16-f30a744c7bce54e8f221d8052c9e5e88-c65ea.png 200w,\n/static/2023-10-20-10-39-16-f30a744c7bce54e8f221d8052c9e5e88-b5114.png 212w" data-sizes="(max-width: 212px) 100vw, 212px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>为了讲解如何设置虚拟环境，先来执行下面这条命令，以确认 pytz 模块在全局环境之中是可以正常引入的。pytz 包已经安装到了全局路径，因此这条命令不会出错。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-20-10-39-24-60c99cf63260fae2b4df403ee2d52ae8-1ea54.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 233px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 18.025751072961373%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAAsSAAALEgHS3X78AAAA20lEQVQY032Ny06DUBRF+f9PMeqgA5saB7bEx+UW2gKXoIlaLZQCFfqgjVjN8kLqUAcnZ2fts/cxRtkaJy0YxjmD8AU5zxFRyu10jl/uGaUlblHhZCViGiNeE+woR8YZ1izBK3bYyTtWlCFnCwzxtuTUFHTlhM6N5MIa07mz6U1CXfhBP3xCxEuC6oD58MxJ75qzK5Ou43OpHrEXK8779zozbLOGk29R2wPB5hO1+8avvlB6PM08zfx2160ONA+P/PfWW9eoVd12uJobUn9oClxt/DVNwb/e0W/0D/ipIbC66Va5AAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 20 10 39 24" title="" data-src="/static/2023-10-20-10-39-24-60c99cf63260fae2b4df403ee2d52ae8-1ea54.png" data-srcset="/static/2023-10-20-10-39-24-60c99cf63260fae2b4df403ee2d52ae8-2c218.png 200w,\n/static/2023-10-20-10-39-24-60c99cf63260fae2b4df403ee2d52ae8-1ea54.png 233w" data-sizes="(max-width: 233px) 100vw, 233px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>现在，用 venv 新建名为 myproject 的虚拟环境。每个虚拟环境都有自己独立的目录结构。执行完下面这条命令后，我们就得到了 myproject 目录，该目录之中有一些子目录及文件，用来管理虚拟环境。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-20-10-39-42-2a4a14ad8c75951eb1ceafbe52befc4d-07522.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 346px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 25.43352601156069%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsSAAALEgHS3X78AAABD0lEQVQY01WQ626CQBCFef8XaprUUqhCgRhaWCEKCAiIFqwKGK2Xns6uNW1/TGZ2cvabOSMZeQUzq6FFOR79EFZRw65b2OUaz0GKwbSAkSygBjH60wxPpNHjOZzNAW5zhLv9/BeSGsygTBLIXoS7IYM64ZAcypgAYQ6LwNb8A1pawqRhg5jnFRwOICDPf0MysneYsyUs2lQhmE51P8qgJQWc9R6j3QWsPcHbfYlavLszfT5eN+TQ5reW9HRBwArD5Rb+AaLJAUJItm6TXwlurzqqrz33tpXQUGz2eCONJPsRbVOC/dxDI0sq2e2xCe5tJnqsOcGuWjy4Y7pvB6+74IWcyV5IGo/uT47oTL1RgG8vTGq5mFqYAwAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 20 10 39 42" title="" data-src="/static/2023-10-20-10-39-42-2a4a14ad8c75951eb1ceafbe52befc4d-07522.png" data-srcset="/static/2023-10-20-10-39-42-2a4a14ad8c75951eb1ceafbe52befc4d-36166.png 200w,\n/static/2023-10-20-10-39-42-2a4a14ad8c75951eb1ceafbe52befc4d-07522.png 346w" data-sizes="(max-width: 346px) 100vw, 346px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>要想使用这套虚拟环境，首先通过 source 命令执行 bin/activate 脚本。这个脚本会修改各种环境变量，以匹配这套虚拟环境，另外，它还会更改命令提示符，把虚拟环境的名称（例如这里的 myproject）写进去，以提醒我们当前是在这个环境里面工作的。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-20-10-39-54-18122e66088a215488512af7d6ecdb62-0d225.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 189px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 23.809523809523807%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsSAAALEgHS3X78AAABJUlEQVQY03WQX1OCQBTF+f5fo6dmdGoyE63UcFIhFkGWDWfCGnGEkglBTHTE08Wp3nr4zbl/dveeu5Kz2sNJiLSAuzmCU14iylq8xTjOYK9yiPQAHu8g1gfYpNbnljSHuy6o/3OHzkh2tMZ1n+Gi00OFaOgm6qqOK9WENo9wJjdR1wzUhgwdPsF5W6GcQdYttEYcN9oIlXsF1W4PMrMgCXJmhDHUWYCet4C5zDD0Q5jh6uSsT3WDYtWPoIcJFM+HOv8Ao9h4TzGcLTF4W5AGeAoiSNWHAW6tZ9T6Opqmg5bB0aTJvw7a5KrsXw4YxNcRgr7FyQpwWr3E2RR/8IxWbgsPjZFDD3CaFKDrvuLOnqDjTsmxf5r+OJ1DeZnBTvcYJzmx+5dvHZJja7ZIGr8AAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 20 10 39 54" title="" data-src="/static/2023-10-20-10-39-54-18122e66088a215488512af7d6ecdb62-0d225.png" data-srcset="/static/2023-10-20-10-39-54-18122e66088a215488512af7d6ecdb62-0d225.png 189w" data-sizes="(max-width: 189px) 100vw, 189px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>在 Windows 操作系统上，我们可以这样运行 activate 脚本：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-20-10-40-02-dcacbf784305065168b74f9f24692612-32714.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 321px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 14.953271028037381%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAIAAAAcOLh5AAAACXBIWXMAAAsSAAALEgHS3X78AAAAoklEQVQI1yVN6Q6CMBjj/d/IeGIExggEIyMcwtzGtU0SReWXqJ8haZo2TVvDV/dADWE/IqEd1uJa26wF7XKJhAR7yIUnFBYKVQpX2iprr7m6vENcGYhJ6ywwl5soXR6JlfPVKTNTilnr0CZoejOhkNpF5UOHyX16+Q+VtUM7AzYWAVmTfJfRbVJahfC7GzyHeojHT/R4A5PnRF4zT/H4nQXgBxsnm6oRVL54AAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 20 10 40 02" title="" data-src="/static/2023-10-20-10-40-02-dcacbf784305065168b74f9f24692612-32714.png" data-srcset="/static/2023-10-20-10-40-02-dcacbf784305065168b74f9f24692612-809d6.png 200w,\n/static/2023-10-20-10-40-02-dcacbf784305065168b74f9f24692612-32714.png 321w" data-sizes="(max-width: 321px) 100vw, 321px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>也可以先进入 Windows 系统的 PowerShell 界面，然后运行：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-20-10-40-13-7a14f6143d388a3151730c7613de7fed-19c9a.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 343px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 14.577259475218657%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAIAAAAcOLh5AAAACXBIWXMAAAsSAAALEgHS3X78AAAApUlEQVQI1y3L0QqCMACFYd//mRQycZupGJmmZs5NNzenFqJFlJBCcC6+i/NrvhyDdgzU5PHByimqJCINpC0sGSQNogJtEDZmkAq3bkHJnLq3rvR0f2ngxhDmoOD7FOthYmbYiBIzLUGxnpTLOkQEItLG3GP9oVKwFA5trbw6rrEeXgCujSjbJYXPld8MHu982QfqEc9LNH3i+fvf6mlDtPq5nMf3DyWSnAs1uEOkAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 20 10 40 13" title="" data-src="/static/2023-10-20-10-40-13-7a14f6143d388a3151730c7613de7fed-19c9a.png" data-srcset="/static/2023-10-20-10-40-13-7a14f6143d388a3151730c7613de7fed-11dc8.png 200w,\n/static/2023-10-20-10-40-13-7a14f6143d388a3151730c7613de7fed-19c9a.png 343w" data-sizes="(max-width: 343px) 100vw, 343px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>激活这个脚本后，python3 命令就不再直接指向原来的地方了，而是会先指向虚拟环境之中的 bin/python3，然后再链接到我们早前看到的那个地方。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-20-10-40-24-9f9fcae04b1fc7a72c8b7ab9a8deabdf-65498.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 409px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 25.183374083129586%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsSAAALEgHS3X78AAABBUlEQVQY03VQa1OCUBDl//+eZppMeQoyU/IGAXlJiUMTKWok1cxpuWqf6sOZc3f37tk9y2nZMyZuBDUtIYYZ5CjDLKughAXkuICarcEHCQSCXmzg7T/htv2/4PRVjZEVMLExCUvEwiLFNCmhxDnEIMXEi8ETZnkFlwSd9kTo/wQ3TPQOX78TnN0J1lt3btp9wN52TMTd9+yfd/yGT2A9Q3w4x9ccp5EN3k+g0nSJttLyNfSyhlG3sJsO880WyrKkjZ+gUH1KJxKinP2TiIeaGOaX9wrc/KXFIzU9VA1kStzbPtlOMXYWdLclBLJ6a7oYmR5udAN3xCLd02remROT2Hg9Mh7iH2k4Zt4FnP5IAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 20 10 40 24" title="" data-src="/static/2023-10-20-10-40-24-9f9fcae04b1fc7a72c8b7ab9a8deabdf-65498.png" data-srcset="/static/2023-10-20-10-40-24-9f9fcae04b1fc7a72c8b7ab9a8deabdf-67408.png 200w,\n/static/2023-10-20-10-40-24-9f9fcae04b1fc7a72c8b7ab9a8deabdf-5cbc3.png 400w,\n/static/2023-10-20-10-40-24-9f9fcae04b1fc7a72c8b7ab9a8deabdf-65498.png 409w" data-sizes="(max-width: 409px) 100vw, 409px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>这样做，可以确保外部系统所发生的变化不会影响这套虚拟环境。即便外部系统默认的 python3 升级到了 3.9 版，这套虚拟环境也还是会明确使用 3.8 版的 Python。</p>\n<p>用 venv 工具创建出的虚拟环境，初始只装有 pip 与 setuptools 模块，除此之外，没有预装其他的软件包。假如我们像在外部系统时那样，直接引入 pytz 模块，那么程序就会出错，因为 pytz 模块是安装到全局路径之下的，而当前这套虚拟环境里面并没有安装这个模块。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-20-10-40-39-8fdeda77540637ee2d307653f34e0652-c18ed.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 388px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 22.422680412371133%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAIAAAABPYjBAAAACXBIWXMAAAsSAAALEgHS3X78AAAA3UlEQVQI1w2LyVaDMAAA+f//0YPSytbKvgsEgkAS4CUB2Sr22YNynHkzgpRWYgxe/fTFjy8VkZLinBTXphfDVAGV200aRCpsZFApea3XfTB+x9sjXO7R+iuE012GSCuxTfi16tSiOR4TM4fOR30Yk7BguBmEKaBWQaMj6tAl3f+i7SGoEIlx/paVUgZPUSbn9bMVSFlpYGZhJiVQy5tTCC6fRIX4SffOH/k7omqBzHYQ3H522sHpZ7PlLl3sbrT70WM3l67R1+7y5UADc4+v/rBZhHtsDaYfqx38cf8HvBfMujiyalkAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 20 10 40 39" title="" data-src="/static/2023-10-20-10-40-39-8fdeda77540637ee2d307653f34e0652-c18ed.png" data-srcset="/static/2023-10-20-10-40-39-8fdeda77540637ee2d307653f34e0652-a2138.png 200w,\n/static/2023-10-20-10-40-39-8fdeda77540637ee2d307653f34e0652-c18ed.png 388w" data-sizes="(max-width: 388px) 100vw, 388px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>为此，我们需要先通过 pip 命令把 pytz 模块装到这套虚拟环境里，然后才能引入它。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-20-10-40-49-7cfcd9e8b694effffa3a2818ad78d5bc-238a9.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 364px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 28.57142857142857%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsSAAALEgHS3X78AAABSklEQVQY0z1RaXeCQAzk//+htj4KCuLJ4cEtoIJaBarF87VWp9m17Ye8ZJPNzCQRJGeCznQJLUqhxQtoyQLddIMW5RpehLqfoDNfo7/cok1eCWcwVluo5FusZ0r/sxxKMEU7WUF4MoaQvRgNapSdCGowRyOcQ7R99LICvWUJK99j8H6C/rZDd1H+x31WKw4wywPa6Ro6EQlaTEoInSlrEmPdjzmBvv6AffyGe76Tv/HYOd3gnu48/nvz+HCF8/tHkL0EL5YNiUDEsc9HEu2AlBSwNhUMAmYqrPIInZSaTFGxx3B3wWB7hpFXPB5Vn9wE0Q45SIf2JtHIyiQlpRkUImhS/tUJURt5YLuW3QjiyMWzafMRJfeRM4lovL8+ACVKMEA2NvNqMKOj5PwwdQJlq2CHUScZ7Tbl9R7Va0OPehL0aW9O9QWbwJj9AAKqq8nx5yqIAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 20 10 40 49" title="" data-src="/static/2023-10-20-10-40-49-7cfcd9e8b694effffa3a2818ad78d5bc-238a9.png" data-srcset="/static/2023-10-20-10-40-49-7cfcd9e8b694effffa3a2818ad78d5bc-e532a.png 200w,\n/static/2023-10-20-10-40-49-7cfcd9e8b694effffa3a2818ad78d5bc-238a9.png 364w" data-sizes="(max-width: 364px) 100vw, 364px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>安装好之后，再来执行一遍刚才的 import 操作，这次就可以正确引入 pytz 模块了。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-20-10-40-57-6d01253d42a379146b0cf2cabe2c4edf-8fbbb.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 340px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 15.88235294117647%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAAAsSAAALEgHS3X78AAAAu0lEQVQI1z2M226CUBBF+f8fakwk3lpj9QTUcEBREeIFLFRRwD5UuzrYxoedvWbWZIzxxxkrPj1jH3LpnFF8FD6jthlql2HtT0w+K+ysxE7+9vX9NC1kzh88ETZeVxte1JSG5dAcu7T0gp4f0vUjWl5Ab77GdHzeowMqOaLSCyN51rA1nUXIULjtruguQyxxxiBKMLVPe7amI+kHO8mWtzDGu4Jb3fG+pMs7urjhFN/o8vbvfh6sxdVcu18Y+9hKKd6UxQAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 20 10 40 57" title="" data-src="/static/2023-10-20-10-40-57-6d01253d42a379146b0cf2cabe2c4edf-8fbbb.png" data-srcset="/static/2023-10-20-10-40-57-6d01253d42a379146b0cf2cabe2c4edf-fb7d0.png 200w,\n/static/2023-10-20-10-40-57-6d01253d42a379146b0cf2cabe2c4edf-8fbbb.png 340w" data-sizes="(max-width: 340px) 100vw, 340px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>用完虚拟环境后，可以通过 deactivate 操作回到默认环境。这个命令会把相关的环境变量复原成系统默认的值，也包括 python3 命令所指向的位置。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-20-10-41-08-6fcd1e86d8fc72e5d5b4bc304eb4bac1-010a0.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 238px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 45.378151260504204%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAAsSAAALEgHS3X78AAABw0lEQVQozy2Q6bKaQBCFef+nyWLiigiIoCAyDMsMzAzrqKjc63YXjRUzSaWqf5zq/rr69JHA4cN7efOP71578doraIV4X+2vq+0pePkAh4vbnL3Dm7s/B8cbfP1c7k6r/Rm0V8FLSkQ6lv1j4fRBOA6Tju3JQaIh1nXAgrffZks1poJRMNNx0XN9OcRfLae78rWYSVbZyBCPgmTGuBJTPS0mca6TyqB8RrnBNqKp4tzMmwliepprSSFHTE1Kk22kebE2kuKn4+ukGHiRDJCC6ERc89EkIiarVEQNxnVSDiFWwtRgdV9gEBm0krQkG7hQDtAwRHqaDWCsYKqlbAgid3vs2kAO4nFMJijT0kyOcB9gp27x7RlcH9KUcuGn58EpKQWhIGJkayvfqCizeStG44ia2dbhrcMP4hcj29h1G5zv/ukmjSF21vvv5lKJycAL59VWeOssPCUkX2ZObwnnvEkeT/T5G92e+C7EM7w+4PkuSnK2B5OU87JZVDs9YQYtdREsy/8ml2RW3UxZNS82cphqaS7cCV/w8uv/spnVIxCLbOx6p6G870Jx2aKVGhHRNESKK7/vAsGMvFDx8Yzw4N+mqD8pXcWNipfrAwAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 20 10 41 08" title="" data-src="/static/2023-10-20-10-41-08-6fcd1e86d8fc72e5d5b4bc304eb4bac1-010a0.png" data-srcset="/static/2023-10-20-10-41-08-6fcd1e86d8fc72e5d5b4bc304eb4bac1-279da.png 200w,\n/static/2023-10-20-10-41-08-6fcd1e86d8fc72e5d5b4bc304eb4bac1-010a0.png 238w" data-sizes="(max-width: 238px) 100vw, 238px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>假如我们又需要进入 myproject 环境，那就再执行一遍 source bin/activate 命令，重新激活这个环境。</p>\n<h3 id="重建依赖关系"><a href="#%E9%87%8D%E5%BB%BA%E4%BE%9D%E8%B5%96%E5%85%B3%E7%B3%BB" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>重建依赖关系</h3>\n<p>进入虚拟环境后，可以在这个环境里面用 pip 安装需要的软件包。最终你可能还想把这套环境复制到别的地方。例如可能需要把自己工作站之中的开发环境，在数据中心里的某台服务器上面重建。或者要把其他人的开发环境拷贝到自己的电脑上，以帮助对方调试代码。</p>\n<p>利用 venv 工具很容易就能重新建立开发环境。用 python3 -m pip freeze 命令把当前环境所依赖的包明确地保存到一份文件之中（按照惯例，这个文件命名为 requirements.txt）。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-20-10-41-28-2e79359c735bd07c3be607a985a16c5d-40e14.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 482px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 37.344398340248965%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsSAAALEgHS3X78AAABAklEQVQoz51Ra0/CQBC8//+XjLT0CRpjWwot7fVdKaL4At8m49zx0RgjHyazt9mdndsVTtnDTEpYyxp23sBvBthZg3FawasHvtew0hoTxtayglt0CG73sGUHl3DyVtefdRtdK1RiNM9gJAUhYbLJZs6vBozJbnUFY1Fg0l7Dp+j5aovZ0wfCuxeE96+ICM0PbxpCNY8WEg4nW7KBMc8xbTe4uNkh3n9htvs8MEVUrDhS8S8Qjmy1MyurteVw+4yA02M2R4/v/4ZQexvFGaYUc4ue31ofXBwhpgWNtMQpBU2yEvYoGNBlyH38FP57kPCrFU7CRF9QLd2RPTzmLnnJY5x+A64S/NzRfPKwAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 20 10 41 28" title="" data-src="/static/2023-10-20-10-41-28-2e79359c735bd07c3be607a985a16c5d-40e14.png" data-srcset="/static/2023-10-20-10-41-28-2e79359c735bd07c3be607a985a16c5d-b9334.png 200w,\n/static/2023-10-20-10-41-28-2e79359c735bd07c3be607a985a16c5d-91486.png 400w,\n/static/2023-10-20-10-41-28-2e79359c735bd07c3be607a985a16c5d-40e14.png 482w" data-sizes="(max-width: 482px) 100vw, 482px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>现在，假设要用 myproject 环境之中的配置来构建另外一套相似虚拟环境。我们先用 venv 工具把那套环境创建出来，然后用 activate 激活它。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-20-10-42-01-76cfdf6043b1625466418e6a9bd0191c-b30db.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 276px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 31.884057971014496%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAIAAABM9SnKAAAACXBIWXMAAAsSAAALEgHS3X78AAABFElEQVQY021Pa2+CQBDk//+jigiCorZV4fDu4HgcUBBbFYFaHhrFbfrNNJlMZmd3drOCzjPVCYeISpYzWG2GFkN5PfWTefw1shwwl+kRWFzjoUlfTDLCTDQJlLN4J+jh9jU9am70nuUj7A1WWMLu2OGgVZtP3AjlDbv0TteTnzs534Ax8PmGv6+CzpO39KAQX/MixQlmYTamgWIHkFeor7IYHFg94SkqO1R1wFb1C9DCIvpcxHsR2XBnGiTzaDfj24kXq4zLG7ZMDrqfaDSY+h9WdXmCsEj2A4OK8I9BYFrGTEK2TFyNhTL10Kmxm57WPanv/4RR0ZlFa5WdUbTmqUVlu85ro2yNooEWqq5mefkD6Cc8ANaBN11TMdmsAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 20 10 42 01" title="" data-src="/static/2023-10-20-10-42-01-76cfdf6043b1625466418e6a9bd0191c-b30db.png" data-srcset="/static/2023-10-20-10-42-01-76cfdf6043b1625466418e6a9bd0191c-06501.png 200w,\n/static/2023-10-20-10-42-01-76cfdf6043b1625466418e6a9bd0191c-b30db.png 276w" data-sizes="(max-width: 276px) 100vw, 276px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>刚建立好的这套新环境里面，除了 pip 与 setuptools 外，没有安装其他软件包。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-20-10-42-12-e079c5026dd15b884408cbe9dda69222-24151.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 313px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 31.309904153354633%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAIAAABM9SnKAAAACXBIWXMAAAsSAAALEgHS3X78AAABCElEQVQY032P206DQBRF+f9f0oJQQEFRGQrDAMN1IJSLgHRKqRKcamLUB5OVk5Wd7J0c7jYpRS/iIVYiooSp4GLRS7W4UDHR0kqA/gb6vB2AalRxoWW1AMOHarhxIyXMOd5CvO1dW2izQxqp9aLZOL6EIrYo2oEa5izRSGN1J6McjLLXssrsjsZ+0IsX7i7MJZSIEF+ZLuhnd1rv81rBhKEG2VND4bTadLHG8+7wbjMu/vbpC2e21KzHy23p475/rkerOQKW1AfQUNBN1uv5B/O3g2HmeMdnDzh0+Vp1plUOyNaLZUx0UoH+T/kXnIRiAWLJS2Qv3qJYJ60SEBGFapQbpAH96Z/yB1UbOx/9U56/AAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 20 10 42 12" title="" data-src="/static/2023-10-20-10-42-12-e079c5026dd15b884408cbe9dda69222-24151.png" data-srcset="/static/2023-10-20-10-42-12-e079c5026dd15b884408cbe9dda69222-8a062.png 200w,\n/static/2023-10-20-10-42-12-e079c5026dd15b884408cbe9dda69222-24151.png 313w" data-sizes="(max-width: 313px) 100vw, 313px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>然后，我们可以执行 python3 -m pip install 命令，把刚才用 python3 -m pip freeze 所保存的 requirements.txt 文件通过-r 选项传给它，这样就能够将那份文件所记录的软件包安装到这套环境里面了。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-20-10-42-30-eb2dc22afea3d5f0c2d3ae8bd00963f2-352a0.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 511px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 8.02348336594912%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAIAAADXZGvcAAAACXBIWXMAAAsSAAALEgHS3X78AAAAfUlEQVQI1xXI2w6CIAAAUP//f3pry1B0rgWoNQfKRealSUrNEfaWvZyHEySNhqJLRZ/wPq41qHjM2utgU/WAXF86E1EZMYVGi82aqTG814CKU9UAKoPjjR4ycqYSiiFkiiyezK602y6eXW49fjqyfMr3N39thfXIrPug6e8PPExnSGyOWn8AAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 20 10 42 30" title="" data-src="/static/2023-10-20-10-42-30-eb2dc22afea3d5f0c2d3ae8bd00963f2-352a0.png" data-srcset="/static/2023-10-20-10-42-30-eb2dc22afea3d5f0c2d3ae8bd00963f2-1fc3e.png 200w,\n/static/2023-10-20-10-42-30-eb2dc22afea3d5f0c2d3ae8bd00963f2-43cce.png 400w,\n/static/2023-10-20-10-42-30-eb2dc22afea3d5f0c2d3ae8bd00963f2-352a0.png 511w" data-sizes="(max-width: 511px) 100vw, 511px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>这个命令要运行好一会儿，因为它必须把文件里的每个包都获取并安装一遍，才能将前一套环境所依赖的那些模块重新建立起来。待命令运行完之后，用 python3 -m pip list 列出这套虚拟环境之中安装的软件包，可以看到，这些软件包与前一套环境所安装的相同。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-20-10-42-57-6e1951c49da6aa867c38a57fff3459e0-d9a6c.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 323px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 74.30340557275541%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsSAAALEgHS3X78AAACSUlEQVQ4y4VUaVPiQBTM//8/i8WKrIJAIIkhB2dAIOGGhNNjRau33+hasiXsh6nJkLyePt5Dq4wSZLwmsrU2blo95Nr997PXQr49wG0nRKE/5vsWUpbLPYA5iqH3psgFITJ+E5Xhgt9FrO9DK3SHSN/V8KvWQcp0oUcLVONH5DoDXPktFLoh0paPYn8Ce/kAe7GDt3qCI8/LPaz5Bs76GU7yiCp/0+zZBsX7EcrhTLGz51vUdwdUuZejOazJCjrBHBbX9m/w+M7dvnB/Uc8+lyfn7ftZq8YPMCYJrOkKd+MV9zVv3hFwB+MDUC4xh0s4ZCaF7ub3yaWVohl+ug3ckl2BTC1h+AiyWyBt+8onnd/kggHkcsWQhaeANT2cI11tIE/zLyxPeSLSytFSXZCnh+XREv7+Fd4JVp+SuTSDif0wHOWhS2Pd9RN9eYU5ThhIhMokVmDnQI4YCuCFXUO20VVpieFidGUcK4alwZSs15/+eWfkKkBhduk0cdPswaFH7uYDkCHk6V8+iFCSlM8EciS52BvhslqHl7wXCEuRaDCUbCNQDEtsYic5BjwpWQCv/DY9i9Fguv72oDzUCZSyHDU9MgVOwoS3h7MtowArZHJhepyUANeUXbofo/bwBoMjKVILTP82GMFdPX8r+V+mCvCSoVzXO8j6AXIE1fuUGU45y32UybRCn796+J3ULwznyLotFUyGDS4NbFB+cTBRoyj9KWnLrP5vSlQoMhEyy4Y0Mv8opLHrT4A93cBg0jrZmcOYDM9L/nv+A9FZQobvQthLAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 20 10 42 57" title="" data-src="/static/2023-10-20-10-42-57-6e1951c49da6aa867c38a57fff3459e0-d9a6c.png" data-srcset="/static/2023-10-20-10-42-57-6e1951c49da6aa867c38a57fff3459e0-82faf.png 200w,\n/static/2023-10-20-10-42-57-6e1951c49da6aa867c38a57fff3459e0-d9a6c.png 323w" data-sizes="(max-width: 323px) 100vw, 323px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>用版本控制系统（revision control system）与他人协作时，这样一份 requirements.txt 文件是很有用处的，因为你在提交代码的同时，可以把新版代码所依赖的软件包通过该文件一起提交上去，这样能够确保代码与代码所依赖的软件包总是可以同步更新。然而，有一个问题必须注意，那就是 Python 本身的版本并不包含在 requirements.txt 之中，所以必须单独管理。</p>\n<p>虚拟环境有个很容易出错的地方，就是不能直接把它移动到其他路径下面，因为它里面的一些命令（例如 python3）所指向的位置都是固定写好的，其中用到了这套环境的安装路径，假如移动到别处，那么这些路径就会失效。然而，这其实并不算大问题，因为我们创建虚拟环境，不是想要移动它，而是想把它的配置记录下来，以便在其他环境里面重建。所以我们要做的，仅仅是用 python3 -m pip freeze 命令把旧环境依赖的软件包保存到 requirements.txt 文件之中，然后在新环境里面，根据这份文件重新安装这些软件包。</p>\n<h3 id="总结-71"><a href="#%E6%80%BB%E7%BB%93-71" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>我们可以在每个虚拟环境里面，分别用 pip 命令安装它所需要的软件包，这样的话，同一台电脑中就可以存在许多互不冲突的环境了。</li>\n<li>python3 -m venv 命令可以创建虚拟环境，source bin/activate 与 deactivate 命令分别可以启用与禁用该环境。</li>\n<li>python3 -m pip freeze > requirements.txt 命令可以把当前环境所依赖的软件包保存到文件之中，之后可以通过 python3 -m pip install -r requirements.txt 在另一套环境里面重新安装这些包。</li>\n</ol>\n<h2 id="第-84-条：每一个函数、类与模块都要写-docstring"><a href="#%E7%AC%AC-84-%E6%9D%A1%EF%BC%9A%E6%AF%8F%E4%B8%80%E4%B8%AA%E5%87%BD%E6%95%B0%E3%80%81%E7%B1%BB%E4%B8%8E%E6%A8%A1%E5%9D%97%E9%83%BD%E8%A6%81%E5%86%99-docstring" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 84 条：每一个函数、类与模块都要写 docstring</h2>\n<p>Python 是动态语言，因此文档特别重要。Python 内建了相关的机制，支持给代码块编写文档，而且与其他一些编程语言不同，Python 允许我们在程序运行的过程中，直接访问这些文档。</p>\n<p>例如，我们可以紧跟着函数的定义（def）语句，书写一条 docstring 作为这个函数的文档。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-23-13-39-39-b7bfb69e9d09b59dbfa352b5e444debb-9c82e.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 495px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 23.232323232323235%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAIAAADKYVtkAAAACXBIWXMAAAsSAAALEgHS3X78AAAA80lEQVQY022M207CQBRF+//fQ+KDimKQTi+00xuiBZzS6YV2ZnqbtlIh8Uh8NFk52ftkZynqZ7oMyVMQPm/Cxdv+BfggXv2FxQDYoseit7l0qgFXo80kYLEOc+mKUcG816J8uTsikqIoQ8fcoCVUkL4eKCKZmXIUF1bRmlmt0xJYkUyLT1bZKo4YDMow6/SE65Q59WikXCUZSHHZudUY9NdAXvwO+PYhyMvtc4WqmKnATGq0MBKmxoWWcLvs1nll5hV4YeE1Z7c5e+30e2/8hXZS5v52dUgWm/3c3810+850Zur6wd3e2/6j+46ik9dMsPuXH2J7BzulWE64AAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 23 13 39 39" title="" data-src="/static/2023-10-23-13-39-39-b7bfb69e9d09b59dbfa352b5e444debb-9c82e.png" data-srcset="/static/2023-10-23-13-39-39-b7bfb69e9d09b59dbfa352b5e444debb-84a0c.png 200w,\n/static/2023-10-23-13-39-39-b7bfb69e9d09b59dbfa352b5e444debb-afbfd.png 400w,\n/static/2023-10-23-13-39-39-b7bfb69e9d09b59dbfa352b5e444debb-9c82e.png 495w" data-sizes="(max-width: 495px) 100vw, 495px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>函数的 docstring 可以在运行 Python 程序的过程中通过 <code class="language-text">__doc__</code> 这个特殊的属性访问。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-23-13-39-52-105d967d5c072c8ff34509dfbd450d17-d897f.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 429px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 16.55011655011655%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAAAsSAAALEgHS3X78AAAApUlEQVQI12WOSQ6CQBBFuf+hjBGUBhSVYWEERSahcQAkUcHkW93BlYuXX6kpT7GyCmbKwaICepRD3Z8kM2LiB1B3ETa8xdQPYSYVjJhje3/CbXs4zfsPxS5queC1A5x6HNQvma5Icdz0sidSQs/cxwDvR/eRiL6ihSnUIAZLyTS/giUcNhkZZKNTbZ1v0ONSzhZjrkhiWdZkW4IR82MG7ZBhfenwBY7G2ndzt1pUAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 23 13 39 52" title="" data-src="/static/2023-10-23-13-39-52-105d967d5c072c8ff34509dfbd450d17-d897f.png" data-srcset="/static/2023-10-23-13-39-52-105d967d5c072c8ff34509dfbd450d17-b0eaf.png 200w,\n/static/2023-10-23-13-39-52-105d967d5c072c8ff34509dfbd450d17-3e28a.png 400w,\n/static/2023-10-23-13-39-52-105d967d5c072c8ff34509dfbd450d17-d897f.png 429w" data-sizes="(max-width: 429px) 100vw, 429px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>另外，还可以在命令行界面中，利用内置的 pydoc 模块在本机上启动 web 服务器，这台服务器能够提供当前 Python 解释器所能访问到的全部文档，也包括你自己编写的那些模块。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-23-13-40-05-34fdaff6984c45b746adb35f1e155a39-cd600.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 338px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 23.668639053254438%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsSAAALEgHS3X78AAABHklEQVQY0y1QaVPCUBDr//9BzlgKlukFcvakF/SiQKmiiDCoaNx9+mHnzcsku0kkM9+iH2Z4WCyhJSVmzRGjdQurbCDbIfTVGvbLBeP6GZPtAWqQYlg9YXEB/Pcb/NMNHk1w/qH/N6Sel6DDwnQNPamgxyWMZQ0jr6G4EbpuDHNVw8p3MLMNYSE04lhkZEDYeHMQw1rGJC3K0Cd30+YVg2KHu5ED1UuhkuthuYfFS+YBHamE636UizR6WkKe+5SqgJEWdCQXB6Wun6JDLljMke8nHhQnguyEMLItpu0JPa4jLsBchRI9kqMZ4WqwEouNfAOP458pMrvjXqysxqhqYe9PWFwhOmGSc/ygjr5EXwEJWOS+ff7h9HKH/j+P5xdJu2SWa3ZJpwAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 23 13 40 05" title="" data-src="/static/2023-10-23-13-40-05-34fdaff6984c45b746adb35f1e155a39-cd600.png" data-srcset="/static/2023-10-23-13-40-05-34fdaff6984c45b746adb35f1e155a39-6eb99.png 200w,\n/static/2023-10-23-13-40-05-34fdaff6984c45b746adb35f1e155a39-cd600.png 338w" data-sizes="(max-width: 338px) 100vw, 338px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>docstring 可以关联到函数、类与模块上面，系统在编译并运行 Python 程序的过程中，会把确定这种关联的关系也当成工作的一部分。由于 Python 支持 docstring 并允许程序通过 <code class="language-text">__doc__</code> 属性来访问 docstring，我们会享受到以下三个好处：</p>\n<ol>\n<li>开发者能够在程序中访问文档信息，这会让交互式开发工作变得更加轻松。可以用内置的 help 函数查看与某个函数、类及模块相对应的文档。无论是基本的 Python 解释器界面（也就是默认的 Python shell），还是 IPython Notebook（<code class="language-text">https://ipython.org</code>）这样的高级工具，都可以相当方便地查询文档，这让我们能够愉快地研究算法、测试 API 并编写代码片段。</li>\n<li>这些文档是按照标准的方式定义的，因此很容易就能转换成表现力更强的格式（例如 HTML）。这也促使 Python 开发者推出 Sphinx（<code class="language-text">https://www.sphinx-doc.org/</code>）等优秀的文档生成工具，另外还有像 Read the Docs（<code class="language-text">https://readthedocs.org</code>）这样由开发者社群所赞助的网站可以为开源的 Python 项目免费存放美观的文档。</li>\n<li>Python 文档不仅可以做得很漂亮，而且与其他普通的头等 Python 实体一样，也能够在程序里面正常地访问，这会让开发者更乐意编写这样的文档。许多 Python 开发者都坚信，文档是很重要的。有人认为，如果一段代码能称得上好代码，那么其中的文档肯定也写得不错。所以，很多优秀的开源 Python 项目里面，应该都有比较好的文档。</li>\n</ol>\n<p>如果你也想像大家一样把文档写好，那就需要遵循一些与 docstring 有关的约定。完整的规范，可以查看 PEP 257（<code class="language-text">https://www.python.org/dev/peps/pep-0257/</code>），接下来我们重点讲述其中必须注意的几个方面。</p>\n<h3 id="为模块编写文档"><a href="#%E4%B8%BA%E6%A8%A1%E5%9D%97%E7%BC%96%E5%86%99%E6%96%87%E6%A1%A3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>为模块编写文档</h3>\n<p>每个模块都要有顶级的 docstring，即写在源文件开头的那个字符串。字符串的首尾都要带三重引号，这样的字符串的目的主要是介绍本模块与其中的内容。</p>\n<p>在 docstring 里面，第一行应是一个单句，描述本模块的用途。接下来应该另起一段，详解讲述使用这个模块的用户所要知道的一些事项。另外，凡是模块里面比较重要的类与函数，都应该在 docstring 中予以强调，这样的话，查看这份文档的用户就可以从这些类及函数出发来熟悉模块。</p>\n<p>下面举个例子，讲解如何为模块编写 docstring。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-23-13-40-49-a17246ec1773a6757ce273ba490b40ed-0d2ef.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 561px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 48.30659536541889%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAABb0lEQVQoz6VS23KCUAzk/z+qM1VBLhVF6UwrVVFABRQVL73YzjYJR0btYx92OCQ5SXb3aK1ghsYwRHu6gLc+opuV6KQ7eJsT/MM3/P0ZA4X6XH7V//3d5w00kxq13mYwwzn0UQR9HOPheQgnWcGKMlhxjqflBs6igBmlsOdruHkJi/I2gZv7V8M0Trr5vsJqj+7qIHCzHaHalms69N+VulLVVedecby5q7UnCVpEWact27RlU21rUNyOctnYmqWUj4QB1xvjRGr5rI8jYch5Jym44VyCJl0yuChckJ5LNGmIQQ041t9+qK1pI9ZZMeopNhzz1iehr3XSLVyixQmmx9SYhgh/p4+YVONHGXSua8WURhCSyxOw27zt4+uEKMViRKXhVoyRoYSLWcyIN7s0ql1mXdjpZjCVhlzMZ47bcUbIZYBJMugj0pO+Jg9+GYm+XnG6aaqxPjWtK4r+3Xtjate5S2xw/w69zfufx/kf/AIiDdpjFNjUqwAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 23 13 40 49" title="" data-src="/static/2023-10-23-13-40-49-a17246ec1773a6757ce273ba490b40ed-0d2ef.png" data-srcset="/static/2023-10-23-13-40-49-a17246ec1773a6757ce273ba490b40ed-77ffd.png 200w,\n/static/2023-10-23-13-40-49-a17246ec1773a6757ce273ba490b40ed-5ea91.png 400w,\n/static/2023-10-23-13-40-49-a17246ec1773a6757ce273ba490b40ed-0d2ef.png 561w" data-sizes="(max-width: 561px) 100vw, 561px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>如果这个模块表示的是一个可以在命令行界面使用的工具，那么模块的 docstring 里面，还应该写出相关的信息并介绍该工具的用法。</p>\n<h3 id="为类编写文档"><a href="#%E4%B8%BA%E7%B1%BB%E7%BC%96%E5%86%99%E6%96%87%E6%A1%A3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>为类编写文档</h3>\n<p>每个类都应该有类级别的 docstring，这种文档的写法，与模块级别的 docstring 差不多。它的第一段，也需要用一句话来概述整个类的用途。后面的各段，可以详细讲解本类中的每一种操作。</p>\n<p>类中比较重要的 public 属性与方法，同样应该在类级别的 docstring 里面加以强调。另外还需要说明，如果想编写子类，子类应该怎样与受保护的属性（参见第 42 条）以及超类中的方法相交互。</p>\n<p>下面演示类的 docstring 应该如何编写。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-23-13-41-10-a0113de01b80a32100c212be6aa8edd1-bf3e7.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 504px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 42.46031746031746%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsSAAALEgHS3X78AAABa0lEQVQoz11S2XKCQBDk/78qCigqeKfKaEDEA1QEBI1Rk+r0DkoqeRjn2Dm6W7RRfsPweIW9zWAtQnRWe7SWO/TjEzrrWOLeLocdJrA3BzT9EM72iNfTN0b5HWp+VNwxLu6Sa6rQiwu0Vjs2ZjLY5YATprAjlaeME6n3D2c4rHX3OZqLiDN7vmU8fIAVbNFhj6a2O7sMtTdPzHwP8DJxoc8WEpvzNUxvBdOleWs05hu0iVyf+qhP52QVcc6Hzl41Iws7UYqmt0EriNDmpTqb1UWV94hGIe7HZ6H2tHHxVdFVNnxIJ5T7yRkGEVjUp00apruEMQtEL7WsSw1Fx00ilB0CaFPP55sdJSKb2qWprWMGFtHopGCzWZ/51CgUCQyiNd2gpO2VtA1SM3i0wbw2oUzeEgP+ibJQ/QzSCy+cCPkTw+xhPKT8ILuUPr38qcvXQa/YVfmTsjQnH2Uxv5baVP7Xyrfrv75btUzZD1ZrRui3X+VpAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 23 13 41 10" title="" data-src="/static/2023-10-23-13-41-10-a0113de01b80a32100c212be6aa8edd1-bf3e7.png" data-srcset="/static/2023-10-23-13-41-10-a0113de01b80a32100c212be6aa8edd1-3e0a5.png 200w,\n/static/2023-10-23-13-41-10-a0113de01b80a32100c212be6aa8edd1-4bca5.png 400w,\n/static/2023-10-23-13-41-10-a0113de01b80a32100c212be6aa8edd1-bf3e7.png 504w" data-sizes="(max-width: 504px) 100vw, 504px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h3 id="为函数编写文档"><a href="#%E4%B8%BA%E5%87%BD%E6%95%B0%E7%BC%96%E5%86%99%E6%96%87%E6%A1%A3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>为函数编写文档</h3>\n<p>每个 public 函数与方法都应该有 docstring。它的写法与模块和类的相同，第一段也是一个句子，描述这个函数是做什么的。接下来的那段应该描述函数的行为。然后，可以各用一段来描述函数的参数与返回值。另外，如果调用者在使用这个函数接口的时候，需要处理该函数所抛出的一些异常，那么这些异常也要解释（参见第 20 条）。</p>\n<p>下面举例说明如何为函数编写 docstring。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-23-13-41-24-b0f218fdf80d41ae88b9a3c6f5c536a8-1ae11.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 485px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 66.18556701030927%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsSAAALEgHS3X78AAACCElEQVQ4y41T23aiQBD0/z9qEyVyi4YBOdloXMV4QQ0iEU3M5ZzeqgY82X3KQ9Mz00x3V3VNy59vxZ9vxHqciTWaytXvsbSHE+kMp2rubC0347nYk4Xuu+MnCZ5LiQ8fMng5/2fv0gr3bxIVZ7ldZeIma3GSVPxlpt7CZQdn/uJZeulePBR3kpUE2Uni8ksGTFp+XixiQi5MfhKzO0qYv6H6QYLtQcLsKAadhLuTrqP8VQwSsbtI/ys1HmxepL+FbQotoAm5+RU/KOzr+0eF56HDzigR7wl0gAJrmMBIQSrdP3OlxULcRzzISrlDE1VCfAibVQy6CIuKguacMHjGNW2g+7Ou+T/jCvnQQMZFA1g2KvfWuUT1xYBQeYFQQUl1dtQk/J/7+Fjz+M1aWoHdoOoNh0C4s43Y0xWGQL+ULs4c7Bl3sbfrvfKIYoTMBljwkpCeA/EXW/ADeYBP8teBlOzJUpN1lMspkqUqIWs0k/bDRJsgpw6KtapkZ+1QR1+8K2yDqoTc2ADxIKuUQPuHGsRIA+M6ZU7Ihr6ovf660G4Nk+5fK09YuGBqPglNk9e8XgaGXBVkGDvzMBjKxYWx/fb9WCXiL3cq7lv43monHtYu6OhDg+SasrsDXVEjG7ZPgntprsbLFDd9Hy8krl/Cd6/r5qXU/iIb1RXg8DlRCioHXuK6/vGn9heP07XLfvLR6QAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 23 13 41 24" title="" data-src="/static/2023-10-23-13-41-24-b0f218fdf80d41ae88b9a3c6f5c536a8-1ae11.png" data-srcset="/static/2023-10-23-13-41-24-b0f218fdf80d41ae88b9a3c6f5c536a8-c8342.png 200w,\n/static/2023-10-23-13-41-24-b0f218fdf80d41ae88b9a3c6f5c536a8-f73ef.png 400w,\n/static/2023-10-23-13-41-24-b0f218fdf80d41ae88b9a3c6f5c536a8-1ae11.png 485w" data-sizes="(max-width: 485px) 100vw, 485px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>编写 docstring 的时候，需要注意下面几种特殊的情况：</p>\n<ol>\n<li>如果函数没有参数，而且返回的是个比较简单的值，那么就不用按照上面讲的那种格式分段书写了。直接用一句话来描述整个函数可能会更好。</li>\n<li>如果函数没有返回值，那么最好是把描述返回值的那段完全省去，而不要专门写出返回 None。</li>\n<li>如果函数所抛出的异常也是接口的一部分（参见第 20 条），那么应该在 docstring 里面详细解释每一种异常的含义，并说明函数在什么场合会抛出这样的异常。</li>\n<li>如果函数在正常使用的过程中，不会抛出异常，那么无须专门指出这一点。</li>\n<li>如果函数可以接受数量可变的位置参数（参见第 22 条）或关键字参数（参见第 23 条），那么应该在解释参数的那一部分用*args 与**kwargs 来说明这两种参数的用途。</li>\n<li>如果参数有默认值，那么文档里应该提到这些默认值（参见第 24 条）。</li>\n<li>如果函数是个生成器（参见第 30 条），那么应该在 docstring 里面写明这个生成器在迭代过程中会产生什么样的值。</li>\n<li>如果函数是异步协程（参见第 60 条），那么应该在 docstring 里面解释这个协程执行到何时会暂停。</li>\n</ol>\n<p>用类型注解来简化 docstring</p>\n<p>Python 现在已经支持类型注解了，这种注解有许多用途（参见第 90 条），其中一项就是简化 docstring，因为原本写在 docstring 里面的某些含义，现在可以直接通过类型注解体现出来。下面，我们给 find_anagrams 函数的签名加上类型注解，以指出参数与返回值的类型。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-23-13-41-37-f4b86612335039b4b8327109bc257b7e-6a7be.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 524px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 20.801526717557252%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAIAAAABPYjBAAAACXBIWXMAAAsSAAALEgHS3X78AAAAuklEQVQI1y2O4Q6CIBRGff+naqvMFExT+1HNaVMBRVFA59K2LtZ2xg4X9t3PwlSgqnVezM4qr+q8osZEnHJip6VXtuBApN6R3Bg25B8r7Ea/kZhJvwYGOC9cB+0Yifnaz7FcYrXGeo2VEZOilgQmZrhYiAhEBWx2cnpICzsju9tjf8+Oz8IrOWL9uWhcENIhJkwu1y5pMROY9Vai11+TZPwk2hB004UrRHv4CqUgGm+NwEMxwSsG5wquX6JZ1ZHPFmjSAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 23 13 41 37" title="" data-src="/static/2023-10-23-13-41-37-f4b86612335039b4b8327109bc257b7e-6a7be.png" data-srcset="/static/2023-10-23-13-41-37-f4b86612335039b4b8327109bc257b7e-88dc0.png 200w,\n/static/2023-10-23-13-41-37-f4b86612335039b4b8327109bc257b7e-98f22.png 400w,\n/static/2023-10-23-13-41-37-f4b86612335039b4b8327109bc257b7e-6a7be.png 524w" data-sizes="(max-width: 524px) 100vw, 524px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>有了这样的注解，我们就不用专门在 docstring 里面说明 word 参数是字符串了，因为现在的 word 参数后面有个冒号，冒号右侧标出了它的类型，即 str。dictionary 参数也一样，它的类型现在明确地标注成了 collections.abc.Container。另外，返回值同样不用专门在 docstring 里面解释，因为声明函数时，已经在->符号右侧明确说明该函数会返回一份列表。这也意味着即便找不到与 word 参数的组成字母相同但排列顺序不同的词（或者说，找不到 word 参数的同字母异序词（anagram）），函数也依然要返回列表，当然这种情况下返回的列表是一份空白的列表，所以不用在 docstring 里面专门说明。下面，我们针对加过类型注解的 find_anagrams 函数来书写 docstring，并把类型注解已经表达过的相应内容从原有的 docstring 里面去掉。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-23-13-41-49-ac25d5e105a2a3536124d6ee0adadc46-6a7be.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 524px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 54.19847328244275%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsSAAALEgHS3X78AAABlklEQVQoz3WRCW+CQBCF/f//qikFQRE5THqoCCznwi63ArbpW2xNY9LkARuyb+bNNwstzFVC1SBTTrF0JLIbSQey9BI9ZkZW2dVglReT9ZDFz1YJDT9nflmY82dDaz3helpusvr5w396dZ/fXOUYan769HpE3TWhohytLXbWglwLMj3mC6eZtqxbxYXiJRrJ1DCXDgFuL/0UoVYRQy0jbwzWGUWLHvBvi85uJrseF057XcVMej8pbviyD1QvhVMLqeJGSy+Wj0Tzqeqn0t6TD8GK5JusMvL2x2w345b1elLOg53tUgw5z3ZBB4M2t4NQ3jr1iGbO7LyZJyQRhLIKGIyi0xGM4Wqz6z4hcbu97vovp/u06+Fm+zXXw669mvzysvdBSHr3ZDeUTxFCouI64apAxbEO4Lz3vJtHk/eAITDwM+TUk1UNWJKJP9hT0YmJ8tZi/V/nDKyZEFj1M/lA1jFHCWwL421pize6oYrAI3pOj2Y8NyTriCEbcgK+2HnCN2mlEQoQD55HM+IJKr947toJSON/+gad8Uz4Nb0eRAAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 23 13 41 49" title="" data-src="/static/2023-10-23-13-41-49-ac25d5e105a2a3536124d6ee0adadc46-6a7be.png" data-srcset="/static/2023-10-23-13-41-49-ac25d5e105a2a3536124d6ee0adadc46-88dc0.png 200w,\n/static/2023-10-23-13-41-49-ac25d5e105a2a3536124d6ee0adadc46-98f22.png 400w,\n/static/2023-10-23-13-41-49-ac25d5e105a2a3536124d6ee0adadc46-6a7be.png 524w" data-sizes="(max-width: 524px) 100vw, 524px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>类型注解与 docstring 之间的这种重复现象，也会出现在实例字段、类属性与方法中。这样的类型信息最好是只写在一个地方，而不要同时写在类型注解与 docstring 中，因为在修改实现代码时，可能会忘记更新其中的某一处。</p>\n<h3 id="总结-72"><a href="#%E6%80%BB%E7%BB%93-72" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>每个模块、类、方法与函数都应该编写 docstring 文档，并且要与实现代码保持同步。</li>\n<li>模块的 docstring 要介绍本模块的内容，还要指出用户必须了解的关键类与重要函数。</li>\n<li>类的 docstring 要写在 class 语句的正下方，描述本类的行为与重要的属性，还要指出子类应该如何正确地继承这个类。</li>\n<li>函数与方法的 docstring 要写在 def 语句的正下方，描述本函数的每个参数、函数的返回值，可能抛出的异常以及其他相关的行为。</li>\n<li>如果某些信息已经通过类型注解表达过了，那就不要在 docstring 里面重复。</li>\n</ol>\n<h2 id="第-85-条：用包来安排模块，以提供稳固的-api"><a href="#%E7%AC%AC-85-%E6%9D%A1%EF%BC%9A%E7%94%A8%E5%8C%85%E6%9D%A5%E5%AE%89%E6%8E%92%E6%A8%A1%E5%9D%97%EF%BC%8C%E4%BB%A5%E6%8F%90%E4%BE%9B%E7%A8%B3%E5%9B%BA%E7%9A%84-api" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 85 条：用包来安排模块，以提供稳固的 API</h2>\n<p>项目代码变多之后，我们自然需要重新调整它的结构。可能要把大函数拆成许多个小的函数，或者通过辅助类改写某个数据结构（参见第 37 条），还有可能要把各项功能分散到多个相互依赖的模块里面。</p>\n<p>到了一定阶段，你就会发现模块也变得多了起来，所以还得再构建一层机制以便于管理。在 Python 中，这可以通过包（package）来实现，包本身也是一种模块，只不过它里面还含有其他模块。</p>\n<p>大多数情况下，把名为 <code class="language-text">__init__.py</code> 的空白文件放在某个目录中，即可令该目录成为一个包。一旦有了 <code class="language-text">__init__.py</code> 文件，我们就可以使用相对于该目录的路径引入包中的其他 py 文件了。例如，现在目录结构是这样的：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-26-18-20-50-8fe729de293e9ae40cea45c7fe6c1a48-25f19.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 196px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 41.326530612244895%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAAsSAAALEgHS3X78AAABl0lEQVQY01WR23LaMBCG/f5PkZnetOmBpBzSBBIXgWxJPsQxtgsEbBlZtjCEhEMyISFplzK96Mw/mt3Z2dX+32pOucSxNLnCY+nfbexsbotZsNz2Vi+9w/tP/v8pSDO4PNZR0x+cexGd5DXm1pnXf/4dPb2Hmx00BJvdPn58i57eDj3B+vVQ1a5nK0vO3OKBiTmdTM04Y/LOTAszzW21CDfvtnowEkl4bsSyt3oO1jt/8cjE1C6XmjnOKlf4tMM+ttpnlnfphhVsHVUbNWIRoZiYUV5ceGFnEOvBEI+Eq5ZmLD+32pe/Rtp1CUlmcWWkORWKJpJmUzRKbVmCo+4tR8ME3fIuz1hWhvdbHOducQ+bgzQzyU8RqWN6rHcalte86Z0Q+qF29oO6ejSume43vfPlCqFh2vQi2PYrIi1/EK1fAYfmgKWxpKkyeEFShbmkooTfLKGcfAExgIAq4UV/vevGuTWZR2B7T24LnuUJeEbkU+tnnboXTlDpsqPv9SomeJhUTbvdT2Ao4HBEWWnjhn2zv8Jf7H8AhOOVj0JqCl8AAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 26 18 20 50" title="" data-src="/static/2023-10-26-18-20-50-8fe729de293e9ae40cea45c7fe6c1a48-25f19.png" data-srcset="/static/2023-10-26-18-20-50-8fe729de293e9ae40cea45c7fe6c1a48-25f19.png 196w" data-sizes="(max-width: 196px) 100vw, 196px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>如果想在 main.py 里面引入 utils 模块，那么可以把包名（也就是 mypackage）写在 from 后面，并把其中的模块名写在 import 后面。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-26-18-20-58-e77ff8beb80b17ef7888e2c3be81d4df-4fbd0.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 255px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 19.215686274509807%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAAsSAAALEgHS3X78AAAA7UlEQVQY002PW2+CQBSE+f//xjStSX0hFkNYlNsutFqltHJpRUDwLprpcfXBh5OZ72R2clYx5gvoYQp9lkgdZSsMyPNiD16f4K2O4DSCPL/7617yfcQDKyzOoX3OoU0i6FEGMy3R4x/g5R7+pkWwvZBe4NVH0rP0ojlLFuuWfAuvOhBTYUOFajCDGkxh/PyhH3zhmdnoDh10LYEXZqHzZuDV9sGXW2IXPceH+j6FFiYwfys8Ub4/+aYjxmDEikfBUVbCzRtYWQUjSmX59esW7QdhDBYv4dcthmkBM8nhUNYtdnDK21tO3l6siXf4B3e/IMl1E8xNAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 26 18 20 58" title="" data-src="/static/2023-10-26-18-20-58-e77ff8beb80b17ef7888e2c3be81d4df-4fbd0.png" data-srcset="/static/2023-10-26-18-20-58-e77ff8beb80b17ef7888e2c3be81d4df-9c75c.png 200w,\n/static/2023-10-26-18-20-58-e77ff8beb80b17ef7888e2c3be81d4df-4fbd0.png 255w" data-sizes="(max-width: 255px) 100vw, 255px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>如果有些包本身位于更大的包之中，那么就把从大包到这个包之间的各层都用圆点连起来。例如，要引入 bar 包中的某个模块，而 bar 包又位于 mypackage 包的 foo 目录之下，那么就写为 <code class="language-text">from mypackage.foo.bar import ...</code>。</p>\n<p>包在 Python 程序里主要有两种用途。</p>\n<h3 id="用包划分名称空间"><a href="#%E7%94%A8%E5%8C%85%E5%88%92%E5%88%86%E5%90%8D%E7%A7%B0%E7%A9%BA%E9%97%B4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>用包划分名称空间</h3>\n<p>包的一个用途是帮助把模块安排到不同的名称空间（namespace）里面，这样的话，即便两个模块所在的文件同名，也依然能够加以区分，因为它们所在的名称空间不同。例如，下面这个程序要从两个模块里面分别引入一个属性（本例实际引入一个函数），虽然这两个模块所在的文件都叫 utils.py，但我们还是可以通过模块所属的包来区分它们。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-26-18-21-15-93bf703e68db0eab2c6662be4ef96d16-c9ba6.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 393px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 25.44529262086514%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsSAAALEgHS3X78AAABCElEQVQY00WQ2XKCQBBF+f9virKqKDFVgFGQxSHIZhJAUxWNebi5LFYeuub2Mt2nW1qlJ+j7BEb4hlmUYi5yuJc77PMP7PYGu7lS3wbdXuHQd9rBd1jz0A+T1mUDI0iwSCpMX0NoewGDjU1RYB4fe23ln1B3Ecy0wrpoMNn40LwD6wPo/Kv6Bzx1Ok7Z8NTCYGBJUo2vwsTE8TDriY9smsHKPjB1fSyTEqv0HQaH6l7c15mi7EkHYhK6I3ZnbjuuMK41xP5z7uhvznfGeIr6e8ixR3emziSTU5VtCHkb4aW64LmooZNO9iLIXFMPUii7GCqJurUVP2ZMQGW9Qn8hsp7Yymu4X7/4A5ivZ0wNMjqoAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 26 18 21 15" title="" data-src="/static/2023-10-26-18-21-15-93bf703e68db0eab2c6662be4ef96d16-c9ba6.png" data-srcset="/static/2023-10-26-18-21-15-93bf703e68db0eab2c6662be4ef96d16-8813b.png 200w,\n/static/2023-10-26-18-21-15-93bf703e68db0eab2c6662be4ef96d16-c9ba6.png 393w" data-sizes="(max-width: 393px) 100vw, 393px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>这种写法有个问题，如果两个包里有同名的模块，或者两个模块里有同名的函数或类，那么后引入的那个会把先引入的覆盖掉。例如，假设 analysis.utils 与 frontend.utils 模块里都有函数叫作 inspect，那么就没办法通过刚才那种写法来同时使用这两个函数了，因为第二条 import 语句会把第一条所引入的那个 inspect 覆盖掉，导致当前范围内只存在一个 inspect。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-26-18-21-27-b38484e1b1e043ccf57d1dbf304f0ba8-1857e.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 448px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 14.285714285714285%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAAAsSAAALEgHS3X78AAAArUlEQVQI112Oyw6CUAxE/f8vMhGSG0VAgQUXEeQR3qBGwMcC1MVYkZjoYtJ20p7pRPJTKHEJKSygVy2s2xP8cgc/9586yvybrevjR3zU5A2UwhzCxgNzQ6j5EXJckZdhXZww9xMo6R4a9aIdgO0iaFUDawjpCN7DbLvvAwNQpQOBOxAtF8z2sSSYHGRYJQcwClKjCjoBpwbHzNxCLxsYRY0FPSB5Ee3nYE5Ifo0XOl/XjA4Gta8AAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 26 18 21 27" title="" data-src="/static/2023-10-26-18-21-27-b38484e1b1e043ccf57d1dbf304f0ba8-1857e.png" data-srcset="/static/2023-10-26-18-21-27-b38484e1b1e043ccf57d1dbf304f0ba8-15195.png 200w,\n/static/2023-10-26-18-21-27-b38484e1b1e043ccf57d1dbf304f0ba8-82e6d.png 400w,\n/static/2023-10-26-18-21-27-b38484e1b1e043ccf57d1dbf304f0ba8-1857e.png 448w" data-sizes="(max-width: 448px) 100vw, 448px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>解决办法是给 import 语句加上 as 子句，这样就能把两个 inspect 函数分别用不同的名称引入到当前的范围里面。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-26-18-21-38-16b8afb43ed6ef99868662dcc14499f7-0208c.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 493px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 29.61460446247465%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsSAAALEgHS3X78AAABLElEQVQY021R23KCUAzk//+ptoqIgLYqXlq8AAqiVcGxgs50dLtJnT71IbNJzuac3RzDS/dozpZoRxlshl9cMDheMSD6R+ZF9dsrHvlR+td/6opzFxh2tIE5jfEymaM2DGDx8uY8ZSRwV5+ov4dwiBbrJz+AHa7RoQgziPA8nlHMCtYi1TPJjdfdCZ1NAXd9QIsK5dBeblnv0WXfYs8jOnIJB5x0h+62UDQXifLbqy0a4pJzhpvlcEkW2b1DiVF5w+QCjCtorni+aYyru8aovP/xlMt68uAbXsKXp5FaFuttWUEQa1i0J6pkt2+7L1XenCXkLWHHGzTIkdWIM5MKZTXG8PRN8kmHXA44cYaa7ibWfbVoq/4RopsVyuvlFZ2c0eenCIqrvvTyUj/qB2++sZyOUzF/AAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 26 18 21 38" title="" data-src="/static/2023-10-26-18-21-38-16b8afb43ed6ef99868662dcc14499f7-0208c.png" data-srcset="/static/2023-10-26-18-21-38-16b8afb43ed6ef99868662dcc14499f7-1777c.png 200w,\n/static/2023-10-26-18-21-38-16b8afb43ed6ef99868662dcc14499f7-1db89.png 400w,\n/static/2023-10-26-18-21-38-16b8afb43ed6ef99868662dcc14499f7-0208c.png 493w" data-sizes="(max-width: 493px) 100vw, 493px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>as 子句不仅可以给函数起别名，而且能把整个模块都换个名称，这让我们可以清晰地区分各种命名空间里面的同名实体。</p>\n<p>另外一种办法是从能够区分它们的那一层开始书写访问名称。例如，可以把 <code class="language-text">from ... import ...</code> 形式的引入语句改成 <code class="language-text">import ...</code> 形式，并且用 <code class="language-text">analysis.utils.inspect</code> 与 <code class="language-text">frontend.utils.inspect</code> 来区分这两个函数。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-26-18-21-50-55689df04e98e06397aa7658ab446773-cd600.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 338px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 47.0414201183432%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsSAAALEgHS3X78AAABnElEQVQoz21S13LCMBD0/39QJpPQIVRjsLHpYCAuNNNLQpnNSgZmyPCwI510Wu3tnVJ05sgNfKQ7QyQbfWT6Lr56DqztBeb2LGHtLqitTzA3Zxjr3yfUNiHusaJN1kg1bWTaA5S8OVLtISK1FnK2y4885L+n/GyELD9R/YCPT/9In2NJGCNBqtVH0ZkiQZURs0nSJqI8TzT7iFodrj2ST14Q3pWeJBR9eaSyAOXpGvrigGqwhzpZoeAGKDgzlPwFin54r822L8meFOqrH2jzLR9sYJBcxILU2l9h7q5yDffC08tDyQP0+L43hMIi1cXrPVliiQ0SqoR/+o28QvLKfMf9MTy7oRocHhXpizBXKlTHK1SI/GCMt7KBaL0jfcvaPjvuIFbvItEaoMDmxHj3zpzIzdsUG/lhNHhvQ/UW0GiVIseBsqvBDknZgK4cnwSJckNfjlGm56LsL5HujhA3W8h0h5JMdF80K94Icy3yKNJM1l6ZbZC3PaSZmKOyrO0wsUM1DSQ5AWJOhRViGj51E2mqVl1aREgLlgdZ8h9M9Iq5YvR9VAAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 26 18 21 50" title="" data-src="/static/2023-10-26-18-21-50-55689df04e98e06397aa7658ab446773-cd600.png" data-srcset="/static/2023-10-26-18-21-50-55689df04e98e06397aa7658ab446773-6eb99.png 200w,\n/static/2023-10-26-18-21-50-55689df04e98e06397aa7658ab446773-cd600.png 338w" data-sizes="(max-width: 338px) 100vw, 338px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>这种写法完全不需要使用 as 子句，而且由于它采用的名字比较全，初次读到这段代码的读者也可以清楚地了解到这两个 inspect 函数分别是在哪个包的哪个模块里面定义的。</p>\n<h3 id="通过包来构建稳固的-api"><a href="#%E9%80%9A%E8%BF%87%E5%8C%85%E6%9D%A5%E6%9E%84%E5%BB%BA%E7%A8%B3%E5%9B%BA%E7%9A%84-api" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>通过包来构建稳固的 API</h3>\n<p>包的第二个用途是构建严谨而稳固的 API，以便给外部的开发者使用。</p>\n<p>如果这套 API 要提供给很多人使用，例如要做成开源的软件包（参见第 82 条），那么你可能想把它的功能稳定下来，以免新旧版本之间差得太大。为了做到这一点，必须隐藏软件包内部的代码结构，不要让外部的开发者依赖这套结构，只有这样，你才能重构并改善这些内部模块，而不必担心自己所做的修改会影响外部用户已经写好的那些代码。</p>\n<p>Python 允许我们通过 <code class="language-text">__all__</code> 这个特殊的属性，决定模块或包里面有哪些内容应该当作 API 公布给外界。<code class="language-text">__all__</code> 的值是一份列表，用来描述可作为 public API 导出的所有内容名称。如果执行 <code class="language-text">from foo import *</code> 这样的语句，那么只有 <code class="language-text">__all__</code> 所列出名称的属性才会引入进来。若是 foo 里面没有 <code class="language-text">__all__</code>，那么就只会引入 public 属性（也就是只会引入不以下划线开头的那些属性。详细的命名原则参见第 42 条）。</p>\n<p>例如，我们想设计一个包，用来计算抛射物（抛体）之间碰撞。我们可以把表示抛射物的 Projectile 类定义在名为 models 的模块里，并把这个模块放在 mypackage 包中。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-26-18-22-01-555051dd36c5e95d4b8954dd24395daf-238a9.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 364px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 39.285714285714285%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAAsSAAALEgHS3X78AAABUElEQVQY021R2W6DMBDk/z+pUlvSCAMhEM4cJcXhMtgJl4FcJGqXpm+NNFqt156d2bWghlRcbcWlr8UM4cwqj15397qbC2iHEXxw+PUphHlEX93NLGEm42hHlDBFQTL1QznM5glTIOYVtHhOXuxbqzqZ5REUPBBpLiBusNaAetmbhw6u/tEuf2Q9rRZZZTAu7zKATkolYlparE7fXn932gHimPArDDLm3Xh8eBH0vEaYTDY7OcrB7fvSRwE4J2rElITZ5VFN9krM7OqsZaUaUTVmSkx11oxkaGMWPVxbRY9wMt2G0lcEYyOcypjIARHXAQpzIM9IASsAMtQN2oAp4eEeTGrJAXYuBeTN+3yxPJ3W8Giy9EHZOLQGa4w9t+vzYwq3+7Xt8MFurk570ymXMJmlpRzRDz+aBikkTn2BbYtrDB8h4VRNCre92Q0sDMjDDx/LqFqT3AvvAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 26 18 22 01" title="" data-src="/static/2023-10-26-18-22-01-555051dd36c5e95d4b8954dd24395daf-238a9.png" data-srcset="/static/2023-10-26-18-22-01-555051dd36c5e95d4b8954dd24395daf-e532a.png 200w,\n/static/2023-10-26-18-22-01-555051dd36c5e95d4b8954dd24395daf-238a9.png 364w" data-sizes="(max-width: 364px) 100vw, 364px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>然后，还可以在同一个 mypackage 包中定义名为 utils 的模块，用来提供一些能够施加在 Projectile 实例上面的操作。例如，其中的 simulate_collision 函数能模拟两个抛射物之间的碰撞情况。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-26-18-22-09-f3c035fcd550d61f8126f2fe2f1bfb67-4a888.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 287px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 70.73170731707317%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsSAAALEgHS3X78AAACaklEQVQ4y21Ta3PaQAz0//89bWfamQRCwBhDwAEbSHg/bGwDDhgb8iLb1TmmTacfNLqT7va0K53WcCM0vR1qizWq0xVafozGcov7TQrn8I7O/hX2/g12/GlcO/H7n338NacZsxXKIxf62EVtHqA683FlP6LGePvphPvdCRa9FR3pj2rf3BxoCVpRmsW3KQtIVE4z3QCF7gC3gzn6yQeMWYgfRgs/m46KG3xEHvtuWigNpzDdDYq9MR99wLe6hUJviBtasTuEPvWgdeJXiNni9y9o757R3j8ji5PGgRSTT+pcd2SfntFN3rM7NMk7SSaDJoda6wMpBrDo1Z40muEerTCG6W1R9yM06O9WEemRKuk13C0lCmGRvult0Az2qDOmNYNYUdMnLioTH3f+DlZ4YHJNAKE3QrE/Rmkw47khKqM55ZlR9wWMqQ9jEagz+sRT8mgOy+ylH6rkLqkof/zIjPGHF6B7Ano0iUm+R28LRZFCSXLO1qSv1Yh80x2jE51wzZcKNGMR4uZxqsT/1e6jQrGvnIGq3lyuVUUddr4tmv9jmhyoEcBhM/ThQs2iSRrl8RI6R6hI4AY1LFOSuveEu3DHuAdbNS8DyRurAC+lcyPDLD7r2jnrJuldaOVdZv5/1V0A5bAanTQDUbE0A8oB8oedv86oO5/xvFJN6N6yYxZHQWjKWvnBgl1+QoMmEyCaSucr1Lw8WqI6WeGeP6Q69ylZoGZSVahTswoBBLA0nKPQnyjAaxkR/hCJVQgo4yFf85Z7AS/JA15EwEDpa3Pw21JhTkPKlT8p055rd6GZnC+085y6Qzm+UKb9BooT/r0mBd3LAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 26 18 22 09" title="" data-src="/static/2023-10-26-18-22-09-f3c035fcd550d61f8126f2fe2f1bfb67-4a888.png" data-srcset="/static/2023-10-26-18-22-09-f3c035fcd550d61f8126f2fe2f1bfb67-09aba.png 200w,\n/static/2023-10-26-18-22-09-f3c035fcd550d61f8126f2fe2f1bfb67-4a888.png 287w" data-sizes="(max-width: 287px) 100vw, 287px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>现在我们想让 mypackage 包把这套 API 中所有的 public 部分都开放给外界使用，这样的话，下游开发者就可以直接引入整个包，而不用再分别引入其中的 mypackage.models 与 mypackage.utils 了。另外，这样还有个好处，就是即便 mypackage 的内部结构发生变化（例如把 models.py 删掉了），API 用户的那些代码也依然能够正常运作，因为它们只要知道 mypackage 之中有这样一个 Projectile 类能够使用即可，而无须关心这个类到底是不是定义在 models 里面。</p>\n<p>为了实现这种效果，我们要修改 mypackage 目录下面的 <code class="language-text">__init__.py</code> 文件。这个文件里面引入哪些内容，外界引入 mypackage 模块时，就能看到哪些内容。因此，我们可以把想要开放给外界使用的 API 都明确地引到这里来。由于包中的那两个模块已经各自指定好了 <code class="language-text">__all__</code> 属性，我们可以直接用 <code class="language-text">from ... import *</code> 引入那两个模块，并把它们的 <code class="language-text">__all__</code> 添加到自己的 <code class="language-text">__all__</code> 里面。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-26-18-22-20-b5528b347f754aadb1f06bea3bc253f2-f3838.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 253px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 53.359683794466406%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsSAAALEgHS3X78AAACIklEQVQoz4VTaW/aQBTk//+XqlJVqWkoBEo4bPB9cMQGzGHAEGMbCEcSTWdNRJUPVT+svd7lzZuZNxS0dQYzPsLdv8PY7KHzW5zZu1c4u/f8zuCyswus9P+rUO36UBYxtOUWzeEM1Z6PsvsEKVhAW6UoOwOUrD7s/RvM9AwzO1/f/1gF8WivElQJUu2NoW4OsLZH6MsU7XCNotOHkwigy6dCSzD+WPl3et0XlEWCR3+Ghj9Fe7aBNF1Dj2gDgVWyLrsDuNkrjOR0lc29RQAjOeZnZnq6geYMG+MZ6oMRiqoDZR6jRy8rjoevtRa+PNRxpxh49CbQKf+7rOFONmhBD03WaWysPx8+A1rZOe+orXdQucSlEb9AWWVQWGBQvhiQSw87BFU5MJ33Ds8EY7G3d2858yvg9oQ2mT30RyhRXocyxVln/gyDDcqujx+Shm8NGb/sAVqjECabtGdr3Bsuak9jyLRJJCH3UJpEqPRGqNNDMWk53EBZJiyIILGo7s/p7xy/2VAKQrTGIX2OUPemkEYLWGTYmqxu6nJAKViiymho4Tb3sEEWP3UnL651A9hk3BjOUVRMAg8hByvY8Qnd5HKVzpqbZJfj1qMdKl0PJQ7DpMkiJhpZmgy6kHOnOah5zKjrMfyHvEGtH+DeEhalf+PEeRQEmDSOOLUlcxfTzw2920NdbBmbhF7GaFKaykKJ0jqMmUzJQoXM3wqvhUX2xz/lD0UeHcPMN171AAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 26 18 22 20" title="" data-src="/static/2023-10-26-18-22-20-b5528b347f754aadb1f06bea3bc253f2-f3838.png" data-srcset="/static/2023-10-26-18-22-20-b5528b347f754aadb1f06bea3bc253f2-72de9.png 200w,\n/static/2023-10-26-18-22-20-b5528b347f754aadb1f06bea3bc253f2-f3838.png 253w" data-sizes="(max-width: 253px) 100vw, 253px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>下面这个文件可以直接通过 <code class="language-text">from mypackage import *</code> 来引入给 mypackage 包设计的所有 public API，这样它就能访问包里面的各个模块所提供的 public 类与函数了。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-10-26-18-22-26-1ba780517857f96f84e25a3ec35eca3f-f1634.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 395px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 31.139240506329113%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsSAAALEgHS3X78AAABGklEQVQY032ReU/CQBTE+/0/kdFoa4FeHKUHhBbsll70QKAUEdE4vq2aGK8/ppO+zf7yZlYYpPdQ2QpGXEGLSvSCFLLP0E8q6FEBZ3+G2zy3btdPP8TnX88Egy6Jkzk68xiX5hRX9gwXQxu3XkizJSSPQU/XsDbHX4HfJTj0sbaPsEnm+oAxXTSrpnVnd8KYZja5U5//BTmfwEG+xahsoFLUbpCgs4jBt5ZpO16HRUAjrTBaNx/RTu+Q/R8bassc44IDE0gU/cb1oIUZRNcncIlhvqNuc0pxxPThFe7hpRXfmPuE/zck3jVJUAl47fjo3cXg8C65OF3Qw4TQlwXMvIZMfUoz1s6UcEUpIihBhh5L244VlqGfbcBZby2rtA3YIrZWAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 10 26 18 22 26" title="" data-src="/static/2023-10-26-18-22-26-1ba780517857f96f84e25a3ec35eca3f-f1634.png" data-srcset="/static/2023-10-26-18-22-26-1ba780517857f96f84e25a3ec35eca3f-44417.png 200w,\n/static/2023-10-26-18-22-26-1ba780517857f96f84e25a3ec35eca3f-f1634.png 395w" data-sizes="(max-width: 395px) 100vw, 395px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>请注意，只供内部使用的函数（例如 <code class="language-text">mypackage.utils._dot_product</code>）不会随着 mypac-kage 包提供给外部的 API 用户，因为那些函数根本就没有写在 <code class="language-text">__all__</code> 里面。换句话说，凡是没有出现在 <code class="language-text">__all__</code> 之中的，都不会随着 <code class="language-text">from mypackage import *</code> 语句引入，这相当于对外部使用者有效地隐藏了那些名字。</p>\n<p>这套做法，可以很好地帮助我们打造明确而稳固的 API。但这主要是针对外界而言的，假如这套 API 只在你们团队自己的模块之间使用，那就没有必要像刚才那样，专门通过 <code class="language-text">__all__</code> 来指明外界所能看到的内容了。因为在这种情况下，由各个包所代表的那些命名空间，本身就能够让接口与接口之间形成较为合理的边界，从而令团队之中的每位开发者可以清晰地控制自己所负责的这部分代码，并与其他开发者合作。</p>\n<h3 id="谨慎地使用-import形式的引入语句"><a href="#%E8%B0%A8%E6%85%8E%E5%9C%B0%E4%BD%BF%E7%94%A8-import%E5%BD%A2%E5%BC%8F%E7%9A%84%E5%BC%95%E5%85%A5%E8%AF%AD%E5%8F%A5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>谨慎地使用 import*形式的引入语句</h3>\n<p><code class="language-text">from x import y</code> 这种形式的引入语句，是很清晰的，因为它明确指出了 y 来自 x 包或 x 模块。引入语句还有一种写法，就是带有通配符的 from foo import *形式，这种引入语句也很有用，尤其是在交互式的 Python 界面之中。然而大家必须注意，这样写会造成两方面的困难：</p>\n<ol>\n<li>用 <code class="language-text">from ... import *</code> 的形式引入，会让初次读到这段代码的读者弄不清某些名称究竟来自哪里。如果模块里有许多条这样的 <code class="language-text">import *</code> 语句，那我们可能必须把受引用的模块全都查找一遍，才能确定某个名字到底是从哪个模块引入的。</li>\n<li><code class="language-text">import *</code> 形式的引入语句，会把已经引入本模块的同名实体覆盖掉，从而导致奇怪的 bug，因为同一个名称，在执行这条语句之前，与执行这条语句之后，可能指向两个不同的地方。</li>\n</ol>\n<p>最稳妥的做法是不要采用 <code class="language-text">import *</code> 的形式引入，而是通过 <code class="language-text">from x import y</code> 明确指出名称 y 来自模块 x。</p>\n<h3 id="总结-73"><a href="#%E6%80%BB%E7%BB%93-73" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>Python 的包是一种包含其他模块的模块。这种结构让我们可以把代码划分成多个互不冲突的名称空间，即便两个实体同名，也能用它们所属的模块加以区分。</li>\n<li>如果要构建的包比较简单，那就把其中每个模块所对应的源文件都直接放在本包的目录下，并给目录里面创建一份 <code class="language-text">__init__.py</code> 文件。这样的话，这些源文件所表示的模块就会成为本包的子模块。这个目录里还可以创建子目录，以构建其他包。</li>\n<li>如果想限制外界通过引入该模块能够访问到哪些 API，那么可以把这些 API 的名称写在 <code class="language-text">__all__</code> 这个特殊的属性里面。</li>\n<li>如果不想让外界看到某些内容，那么可以在包目录中的 <code class="language-text">__init__.py</code> 文件里面故意不引入这些内容，或者给这些只供本包内部使用的内容名称前面添加下划线。</li>\n<li>假如这个包只在某个团队或某个项目内部使用，那恐怕就没必要专门通过 <code class="language-text">__all__</code> 来指定外界能够访问到的 API 了。</li>\n</ol>\n<h2 id="第-86-条：考虑用模块级别的代码配置不同的部署环境"><a href="#%E7%AC%AC-86-%E6%9D%A1%EF%BC%9A%E8%80%83%E8%99%91%E7%94%A8%E6%A8%A1%E5%9D%97%E7%BA%A7%E5%88%AB%E7%9A%84%E4%BB%A3%E7%A0%81%E9%85%8D%E7%BD%AE%E4%B8%8D%E5%90%8C%E7%9A%84%E9%83%A8%E7%BD%B2%E7%8E%AF%E5%A2%83" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 86 条：考虑用模块级别的代码配置不同的部署环境</h2>\n<h2 id="第-87-条：为自编的模块定义根异常，让调用者能够专门处理与此-api-有关的异常"><a href="#%E7%AC%AC-87-%E6%9D%A1%EF%BC%9A%E4%B8%BA%E8%87%AA%E7%BC%96%E7%9A%84%E6%A8%A1%E5%9D%97%E5%AE%9A%E4%B9%89%E6%A0%B9%E5%BC%82%E5%B8%B8%EF%BC%8C%E8%AE%A9%E8%B0%83%E7%94%A8%E8%80%85%E8%83%BD%E5%A4%9F%E4%B8%93%E9%97%A8%E5%A4%84%E7%90%86%E4%B8%8E%E6%AD%A4-api-%E6%9C%89%E5%85%B3%E7%9A%84%E5%BC%82%E5%B8%B8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 87 条：为自编的模块定义根异常，让调用者能够专门处理与此 API 有关的异常</h2>\n<h2 id="第-88-条：用适当的方式打破循环依赖关系"><a href="#%E7%AC%AC-88-%E6%9D%A1%EF%BC%9A%E7%94%A8%E9%80%82%E5%BD%93%E7%9A%84%E6%96%B9%E5%BC%8F%E6%89%93%E7%A0%B4%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96%E5%85%B3%E7%B3%BB" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 88 条：用适当的方式打破循环依赖关系</h2>\n<h2 id="第-89-条：重构时考虑通过-warnings-提醒开发者-api-已经发生变化"><a href="#%E7%AC%AC-89-%E6%9D%A1%EF%BC%9A%E9%87%8D%E6%9E%84%E6%97%B6%E8%80%83%E8%99%91%E9%80%9A%E8%BF%87-warnings-%E6%8F%90%E9%86%92%E5%BC%80%E5%8F%91%E8%80%85-api-%E5%B7%B2%E7%BB%8F%E5%8F%91%E7%94%9F%E5%8F%98%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 89 条：重构时考虑通过 warnings 提醒开发者 API 已经发生变化</h2>\n<h2 id="第-90-条：考虑通过-typing-做静态分析，以消除-bug"><a href="#%E7%AC%AC-90-%E6%9D%A1%EF%BC%9A%E8%80%83%E8%99%91%E9%80%9A%E8%BF%87-typing-%E5%81%9A%E9%9D%99%E6%80%81%E5%88%86%E6%9E%90%EF%BC%8C%E4%BB%A5%E6%B6%88%E9%99%A4-bug" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 90 条：考虑通过 typing 做静态分析，以消除 bug</h2>\n<p>// TODO 编写高质量 Python 待完成</p>',
excerpt:"培养 Pythonic 思维 第 1 条：查询自己使用的 Python 版本 Python 2 于 2020 年 1 月 1 日退场，到这一刻，所有的 bug 修复、安全补丁，以及特性向后移植都会停止。此后，如果你还坚持使用 Python…",frontmatter:{date:"2023-06-13 12:00:28",path:"/writing-high-quality-python/",tags:"后端, python, 读书笔记",title:"编写高质量Python",draft:null}},prePost:{html:'<h1 id="入门"><a href="#%E5%85%A5%E9%97%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>入门</h1>\n<h2 id="hello-world"><a href="#hello-world" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Hello, World</h2>\n<p>我们以现已成为传统的 <code class="language-text">hello world</code> 案例来开始吧</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="81575892286770450000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`package main\n\nimport &quot;fmt&quot;\n\nfunc main() {\n    fmt.Println(&quot;Hello, 世界&quot;)\n}`, `81575892286770450000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="go"\n              >\n                <span class="gatsby-code-button-language">go</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="go"><pre style="counter-reset: linenumber NaN" class="language-go line-numbers"><code class="language-go"><span class="token keyword">package</span> main\n\n<span class="token keyword">import</span> <span class="token string">"fmt"</span>\n\n<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Hello, 世界"</span><span class="token punctuation">)</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Go 是一门编译型语言，Go 语言的工具链将源代码及其依赖转换成计算机的机器指令（译注：静态编译）。Go 语言提供的工具都通过一个单独的命令 go 调用，go 命令有一系列子命令。最简单的一个子命令就是 run。这个命令编译一个或多个以 .go 结尾的源文件，链接库文件，并运行最终生成的可执行文件（本书使用 <code class="language-text">$</code> 表示命令行提示符。）</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="78702370899771640000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ go run helloworld.go`, `78702370899771640000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ go run helloworld.go</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>毫无意外，这个命令会输出：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="30350000643592610000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`Hello, 世界`, `30350000643592610000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">Hello, 世界</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>Go 语言原生支持 Unicode，它可以处理全世界任何语言的文本。</p>\n<p>如果不只是一次性实验，你肯定希望能够编译这个程序，保存编译结果以备将来之用，可以用 build 子命令：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="73531426662970320000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ go build helloworld.go`, `73531426662970320000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ go build helloworld.go</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>这个命令生成一个名为 helloworld 的可执行的二进制文件（译注：Windows 系统下生成的可执行文件是 helloworld.exe，增加了 .exe 后缀名），之后你可以随时运行它（译注：在 Windows 系统下在命令行直接输入 helloworld.exe 命令运行），不需任何处理（译注：因为静态编译，所以不用担心在系统库更新的时候冲突，幸福感满满）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="37661857180024996000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ ./helloworld\nHello, 世界`, `37661857180024996000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ ./helloworld\nHello, 世界</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>执行 <code class="language-text">go get gopl.io/ch1/helloworld</code> 命令，就会从网上获取代码，并放到对应目录中（需要先安装 Git 或 Hg 之类的版本管理工具，并将对应的命令添加到 PATH 环境变量中。</p>\n<p>来讨论下程序本身。Go 语言的代码通过包（package）组织，包类似于其它语言里的库（libraries）或者模块（modules）。一个包由位于单个目录下的一个或多个 .go 源代码文件组成，目录定义包的作用。每个源文件都以一条 package 声明语句开始，这个例子里就是 package main，表示该文件属于哪个包，紧跟着一系列导入（import）的包，之后是存储在这个文件里的程序语句。</p>\n<p>Go 的标准库提供了 100 多个包，以支持常见功能，如输入、输出、排序以及文本处理。比如 fmt 包，就含有格式化输出、接收输入的函数。Println 是其中一个基础函数，可以打印以空格间隔的一个或多个值，并在最后添加一个换行符，从而输出一整行。</p>\n<p>main 包比较特殊。它定义了一个独立可执行的程序，而不是一个库。在 main 里的 main 函数也很特殊，它是整个程序执行时的入口（译注：C 系语言差不多都这样）。main 函数所做的事情就是程序做的。当然了，main 函数一般调用其它包里的函数完成很多工作（如：fmt.Println）。</p>\n<p>必须告诉编译器源文件需要哪些包，这就是跟随在 package 声明后面的 import 声明扮演的角色。hello world 例子只用到了一个包，大多数程序需要导入多个包。</p>\n<p>必须恰当导入需要的包，缺少了必要的包或者导入了不需要的包，程序都无法编译通过。这项严格要求避免了程序开发过程中引入未使用的包（译注：Go 语言编译过程没有警告信息，争议特性之一）。</p>\n<p>import 声明必须跟在文件的 package 声明之后。随后，则是组成程序的函数、变量、常量、类型的声明语句（分别由关键字 func、var、const、type 定义）。这些内容的声明顺序并不重要（译注：最好还是定一下规范）。这个例子的程序已经尽可能短了，只声明了一个函数，其中只调用了一个其他函数。为了节省篇幅，有些时候示例程序会省略 package 和 import 声明，但是，这些声明在源代码里有，并且必须得有才能编译。</p>\n<p>一个函数的声明由 func 关键字、函数名、参数列表、返回值列表（这个例子里的 main 函数参数列表和返回值都是空的）以及包含在大括号里的函数体组成。第五章进一步考察函数。</p>\n<p>Go 语言不需要在语句或者声明的末尾添加分号，除非一行上有多条语句。实际上，编译器会主动把特定符号后的换行符转换为分号，因此换行符添加的位置会影响 Go 代码的正确解析（译注：比如行末是标识符、整数、浮点数、虚数、字符或字符串文字、关键字 break、continue、fallthrough 或 return 中的一个、运算符和分隔符 <code class="language-text">++</code>、<code class="language-text">--</code>、<code class="language-text">)</code>、<code class="language-text">]</code> 或 <code class="language-text">}</code> 中的一个）。举个例子，函数的左括号 <code class="language-text">{</code> 必须和 func 函数声明在同一行上，且位于末尾，不能独占一行，而在表达式 <code class="language-text">x + y</code> 中，可在 + 后换行，不能在 + 前换行（译注：以 + 结尾的话不会被插入分号分隔符，但是以 x 结尾的话则会被分号分隔符，从而导致编译错误）。</p>\n<p>Go 语言在代码格式上采取了很强硬的态度。gofmt 工具把代码格式化为标准格式（译注：这个格式化工具没有任何可以调整代码格式的参数，Go 语言就是这么任性），并且 go 工具中的 fmt 子命令会对指定包，否则默认为当前目录中所有 go 源文件应用 gofmt 命令。本书中的所有代码都被 gofmt 过。你也应该养成格式化自己的代码的习惯。以固定方式规定标准的代码格式可以避免无尽的无意义的琐碎争执（译注：也导致了 Go 语言的 TIOBE 排名较低，因为缺少撕逼的话题）。更重要的是，这样可以做多种自动源码转换，如果放任 Go 语言代码格式，这些转换就不大可能了。</p>\n<p>很多文本编辑器都可以配置为保存文件时自动执行 gofmt，这样你的源代码总会被恰当地格式化。还有个相关的工具：goimports，可以根据代码需要，自动地添加或删除 import 声明。这个工具并没有包含在标准的分发包中，可以用下面的命令安装：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="97328691677089920000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ go get golang.org/x/tools/cmd/goimports`, `97328691677089920000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ go get golang.org/x/tools/cmd/goimports</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>对于大多数用户来说，下载、编译包、运行测试用例、察看 Go 语言的文档等等常用功能都可以用 go 的工具完成。10.7 节详细介绍这些知识。</p>\n<h2 id="命令行参数"><a href="#%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%8F%82%E6%95%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>命令行参数</h2>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="18621187885030510000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// Echo1 prints its command-line arguments.\npackage main\n\nimport (\n    &quot;fmt&quot;\n    &quot;os&quot;\n)\n\nfunc main() {\n    var s, sep string\n    for i := 1; i < len(os.Args); i++ {\n        s += sep + os.Args[i]\n        sep = &quot; &quot;\n    }\n    fmt.Println(s)\n}`, `18621187885030510000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="go"\n              >\n                <span class="gatsby-code-button-language">go</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="go"><pre style="counter-reset: linenumber NaN" class="language-go line-numbers"><code class="language-go"><span class="token comment">// Echo1 prints its command-line arguments.</span>\n<span class="token keyword">package</span> main\n\n<span class="token keyword">import</span> <span class="token punctuation">(</span>\n    <span class="token string">"fmt"</span>\n    <span class="token string">"os"</span>\n<span class="token punctuation">)</span>\n\n<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">var</span> s<span class="token punctuation">,</span> sep <span class="token builtin">string</span>\n    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Args<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>\n        s <span class="token operator">+=</span> sep <span class="token operator">+</span> os<span class="token punctuation">.</span>Args<span class="token punctuation">[</span>i<span class="token punctuation">]</span>\n        sep <span class="token operator">=</span> <span class="token string">" "</span>\n    <span class="token punctuation">}</span>\n    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="20679914918469722000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// Echo2 prints its command-line arguments.\npackage main\n\nimport (\n    &quot;fmt&quot;\n    &quot;os&quot;\n)\n\nfunc main() {\n    s, sep := &quot;&quot;, &quot;&quot;\n    for _, arg := range os.Args[1:] {\n        s += sep + arg\n        sep = &quot; &quot;\n    }\n    fmt.Println(s)\n}`, `20679914918469722000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="go"\n              >\n                <span class="gatsby-code-button-language">go</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="go"><pre style="counter-reset: linenumber NaN" class="language-go line-numbers"><code class="language-go"><span class="token comment">// Echo2 prints its command-line arguments.</span>\n<span class="token keyword">package</span> main\n\n<span class="token keyword">import</span> <span class="token punctuation">(</span>\n    <span class="token string">"fmt"</span>\n    <span class="token string">"os"</span>\n<span class="token punctuation">)</span>\n\n<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    s<span class="token punctuation">,</span> sep <span class="token operator">:=</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">""</span>\n    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> arg <span class="token operator">:=</span> <span class="token keyword">range</span> os<span class="token punctuation">.</span>Args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>\n        s <span class="token operator">+=</span> sep <span class="token operator">+</span> arg\n        sep <span class="token operator">=</span> <span class="token string">" "</span>\n    <span class="token punctuation">}</span>\n    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="61015652022613760000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`s := &quot;&quot; // 一条短变量声明，最简洁，但只能用在函数内部，而不能用于包变量\nvar s string // 依赖于字符串的默认初始化零值机制，被初始化为 &quot;&quot;\nvar s = &quot;&quot; // 用得很少，除非同时声明多个变量\nvar s string = &quot;&quot; // 显式地标明变量的类型，当变量类型与初值类型相同时，类型冗余，但如果两者类型不同，变量类型就必须了`, `61015652022613760000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="go"\n              >\n                <span class="gatsby-code-button-language">go</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="go"><pre style="counter-reset: linenumber NaN" class="language-go line-numbers"><code class="language-go">s <span class="token operator">:=</span> <span class="token string">""</span> <span class="token comment">// 一条短变量声明，最简洁，但只能用在函数内部，而不能用于包变量</span>\n<span class="token keyword">var</span> s <span class="token builtin">string</span> <span class="token comment">// 依赖于字符串的默认初始化零值机制，被初始化为 ""</span>\n<span class="token keyword">var</span> s <span class="token operator">=</span> <span class="token string">""</span> <span class="token comment">// 用得很少，除非同时声明多个变量</span>\n<span class="token keyword">var</span> s <span class="token builtin">string</span> <span class="token operator">=</span> <span class="token string">""</span> <span class="token comment">// 显式地标明变量的类型，当变量类型与初值类型相同时，类型冗余，但如果两者类型不同，变量类型就必须了</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>实践中一般使用前两种形式中的某个，初始值重要的话就显式地指定变量的类型，否则使用隐式初始化。</p>\n<p>每次循环迭代字符串 s 的内容都会更新。+= 连接原字符串、空格和下个参数，产生新字符串，并把它赋值给 s。s 原来的内容已经不再使用，将在适当时机对它进行垃圾回收。</p>\n<p>如果连接涉及的数据量很大，这种方式代价高昂。一种简单且高效的解决方案是使用 strings 包的 Join 函数：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="27284966524021436000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`func main() {\n    fmt.Println(strings.Join(os.Args[1:], &quot; &quot;))\n}`, `27284966524021436000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="go"\n              >\n                <span class="gatsby-code-button-language">go</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="go"><pre style="counter-reset: linenumber NaN" class="language-go line-numbers"><code class="language-go"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>strings<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>最后，如果不关心输出格式，只想看看输出值，或许只是为了调试，可以用 Println 为我们格式化输出。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="40346726864762840000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`fmt.Println(os.Args[1:])`, `40346726864762840000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="go"\n              >\n                <span class="gatsby-code-button-language">go</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="go"><pre style="counter-reset: linenumber NaN" class="language-go line-numbers"><code class="language-go">fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>这条语句的输出结果跟 strings.Join 得到的结果很像，只是被放到了一对方括号里。切片都会被打印成这种格式。</p>\n<p>// TODO <a href="https://golang-china.github.io/gopl-zh/preface-zh.html" target="_blank" rel="nofollow noreferrer noopener">https://golang-china.github.io/gopl-zh/preface-zh.html</a></p>',excerpt:"入门 Hello, World 我们以现已成为传统的   案例来开始吧 Go 是一门编译型语言，Go 语言的工具链将源代码及其依赖转换成计算机的机器指令（译注：静态编译）。Go 语言提供的工具都通过一个单独的命令 go 调用，go…",frontmatter:{date:"2023-10-02 17:58:46",path:"/go-introduce-learn/",tags:"后端, go, 读书笔记",title:"Go 入门学习",draft:null}}},pathContext:{mainPostPath:"/system-design-deep-learn/",nextPostPath:"/writing-high-quality-python/",prePostPath:"/go-introduce-learn/"}}}});