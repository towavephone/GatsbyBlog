webpackJsonp([0xfa62ee07cab9],{1527:function(n,a){n.exports={data:{site:{siteMetadata:{title:"女王控的博客",description:'前端工程师，黑猫女王控，欢迎勾搭，技术相关<a href="https://github.com/towavephone" target="_blank">@towavephone</a>，QQ闲聊<a href="tencent://AddContact/?fromId=45&fromSubId=1&subcmd=all&uin=634407147&website=www.oicqzone.com">@towave</a>，bili关注<a href="https://space.bilibili.com/11507708#/" target="_blank">@towave</a>',siteUrl:"https://blog.towavephone.com"}}},pathContext:{posts:[{excerpt:"首先了解一下 webpack 的打包原理 webpack 的打包原理 chunk 和 module webpack 里面有两个很核心的概念，叫 chunk 和 module，这里为了简单，只看 js 相关的，用笔者自己的理解去解释一下他们直接的区别： module：每一个源码 js 文件其实都可以看成一个 module chunk：每一个打包落地的 js 文件其实都是一个 chunk，每个 chunk 都包含很多 module 默认的 chunk 数量实际上是由你的入口文件的 js…",html:'<p>首先了解一下 webpack 的打包原理</p>\n<h1 id="webpack-的打包原理"><a href="#webpack-%E7%9A%84%E6%89%93%E5%8C%85%E5%8E%9F%E7%90%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>webpack 的打包原理</h1>\n<h2 id="chunk-和-module"><a href="#chunk-%E5%92%8C-module" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>chunk 和 module</h2>\n<p>webpack 里面有两个很核心的概念，叫 chunk 和 module，这里为了简单，只看 js 相关的，用笔者自己的理解去解释一下他们直接的区别：</p>\n<blockquote>\n<p>module：每一个源码 js 文件其实都可以看成一个 module<br>\nchunk：每一个打包落地的 js 文件其实都是一个 chunk，每个 chunk 都包含很多 module</p>\n</blockquote>\n<p>默认的 chunk 数量实际上是由你的入口文件的 js 数量决定的，但是如果你配置动态加载或者提取公共包的话，也会生成新的 chunk。</p>\n<h2 id="打包代码解读"><a href="#%E6%89%93%E5%8C%85%E4%BB%A3%E7%A0%81%E8%A7%A3%E8%AF%BB" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>打包代码解读</h2>\n<p>有了基本理解后，我们需要去理解 webpack 打包后的代码在浏览器端是如何加载执行的。为此我们准备一个非常简单的 demo，来看一下它的生成文件。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="68411793380129820000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// src\n// ---main.js\n// ---moduleA.js\n// ---moduleB.js\n\n/**\n * moduleA.js\n */\nexport default function testA() {\n  console.log(\'this is A\');\n}\n\n/**\n * main.js\n */\nimport testA from \'./moduleA\';\n\ntestA();\n\nimport(\'./moduleB\').then((module) => {});`, `68411793380129820000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// src</span>\n<span class="token comment">// ---main.js</span>\n<span class="token comment">// ---moduleA.js</span>\n<span class="token comment">// ---moduleB.js</span>\n\n<span class="token comment">/**\n * moduleA.js\n */</span>\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">testA</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'this is A\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">/**\n * main.js\n */</span>\n<span class="token keyword">import</span> testA <span class="token keyword">from</span> <span class="token string">\'./moduleA\'</span><span class="token punctuation">;</span>\n\n<span class="token function">testA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">\'./moduleB\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">module</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>非常简单，入口 js 是 main.js，里面就是直接引入 moduleA.js，然后动态引入 moduleB.js，那么最终生成的文件就是两个 chunk，分别是:</p>\n<ol>\n<li>main.js 和 moduleA.js 组成的 bundle.js</li>\n<li>moduleB.js 组成的 0.bundle.js</li>\n</ol>\n<p>如果你了解 webpack 底层原理的话，那你会知道这里是用 mainTemplate 和 chunkTemplate 分别渲染出来的，不了解也没关系，我们继续解读生成的代码</p>\n<h3 id="import-变成了什么样"><a href="#import-%E5%8F%98%E6%88%90%E4%BA%86%E4%BB%80%E4%B9%88%E6%A0%B7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>import 变成了什么样</h3>\n<p>整个 main.js 的代码打包后是下面这样的</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="54619242061956784000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(function(module, __webpack_exports__, __webpack_require__) {\n  \'use strict\';\n  __webpack_require__.r(__webpack_exports__);\n  /* harmony import */\n  var _moduleA__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*!        ./moduleA */ \'./src/moduleA.js\');\n\n  Object(_moduleA__WEBPACK_IMPORTED_MODULE_0__[\'default\'])();\n\n  __webpack_require__\n    .e(/*! import() */ 0)\n    .then(__webpack_require__.bind(null, /*! ./moduleB             */ \'./src/moduleB.js\'))\n    .then((module) => {});\n});`, `54619242061956784000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> __webpack_exports__<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token string">\'use strict\'</span><span class="token punctuation">;</span>\n  __webpack_require__<span class="token punctuation">.</span><span class="token function">r</span><span class="token punctuation">(</span>__webpack_exports__<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">/* harmony import */</span>\n  <span class="token keyword">var</span> _moduleA__WEBPACK_IMPORTED_MODULE_0__ <span class="token operator">=</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token comment">/*!        ./moduleA */</span> <span class="token string">\'./src/moduleA.js\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token function">Object</span><span class="token punctuation">(</span>_moduleA__WEBPACK_IMPORTED_MODULE_0__<span class="token punctuation">[</span><span class="token string">\'default\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  __webpack_require__\n    <span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token comment">/*! import() */</span> <span class="token number">0</span><span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token function">__webpack_require__</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment">/*! ./moduleB             */</span> <span class="token string">\'./src/moduleB.js\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">module</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以看到，我们的直接 import moduleA 最后会变成 webpack_require，而这个函数是 webpack 打包后的一个核心函数，就是解决依赖引入的。</p>\n<h3 id="webpack_require-是怎么实现的"><a href="#webpack_require-%E6%98%AF%E6%80%8E%E4%B9%88%E5%AE%9E%E7%8E%B0%E7%9A%84" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>webpack_require 是怎么实现的</h3>\n<p>那我们看一下 webpack_require 它是怎么实现的：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="90836549646995340000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function __webpack_require__(moduleId) {\n  // Check if module is in cache\n  // 先检查模块是否已经加载过了，如果加载过了直接返回\n  if (installedModules[moduleId]) {\n    return installedModules[moduleId].exports;\n  }\n  // Create a new module (and put it into the cache)\n  // 如果一个import的模块是第一次加载，那之前必然没有加载过，就会去执行加载过程\n  var module = (installedModules[moduleId] = {\n    i: moduleId,\n    l: false,\n    exports: {}\n  });\n  // Execute the module function\n  modules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n  // Flag the module as loaded\n  module.l = true;\n  // Return the exports of the module\n  return module.exports;\n}`, `90836549646995340000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token parameter">moduleId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// Check if module is in cache</span>\n  <span class="token comment">// 先检查模块是否已经加载过了，如果加载过了直接返回</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">.</span>exports<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token comment">// Create a new module (and put it into the cache)</span>\n  <span class="token comment">// 如果一个import的模块是第一次加载，那之前必然没有加载过，就会去执行加载过程</span>\n  <span class="token keyword">var</span> module <span class="token operator">=</span> <span class="token punctuation">(</span>installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>\n    i<span class="token punctuation">:</span> moduleId<span class="token punctuation">,</span>\n    l<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n    exports<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// Execute the module function</span>\n  modules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> module<span class="token punctuation">,</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> __webpack_require__<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// Flag the module as loaded</span>\n  module<span class="token punctuation">.</span>l <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n  <span class="token comment">// Return the exports of the module</span>\n  <span class="token keyword">return</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果简化一下它的实现，其实很简单，就是每次 require，先去缓存的 installedModules 这个缓存 map 里面看是否加载过了，如果没有加载过，那就从 modules 这个所有模块的 map 里去加载。</p>\n<h3 id="modules-从哪里来的"><a href="#modules-%E4%BB%8E%E5%93%AA%E9%87%8C%E6%9D%A5%E7%9A%84" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>modules 从哪里来的</h3>\n<p>那相信很多人都有疑问了，modules 这么个至关重要的 map 是从哪里来的呢，我们把 bundle.js 生成的 js 再简化一下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="62047252001863790000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(function(modules) {})({\n  \'./src/main.js\': function(module, __webpack_exports__, __webpack_require__) {},\n  \'./src/moduleA.js\': function(module, __webpack_exports__, __webpack_require__) {}\n});`, `62047252001863790000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">modules</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n  <span class="token string">\'./src/main.js\'</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> __webpack_exports__<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token string">\'./src/moduleA.js\'</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> __webpack_exports__<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>所以可以看到，这其实是个立即执行函数，modules 就是函数的入参，具体值就是我们包含的所有 module，到此一个 chunk 是如何加载的，以及 chunk 如何包含 module，相信大家一定会有自己的理解了。</p>\n<h3 id="动态引入如何操作呢"><a href="#%E5%8A%A8%E6%80%81%E5%BC%95%E5%85%A5%E5%A6%82%E4%BD%95%E6%93%8D%E4%BD%9C%E5%91%A2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>动态引入如何操作呢</h3>\n<p>上面的 chunk 就是一个 js 文件，所以维护了自己的局部 modules，然后自己使用没啥问题，但是动态引入我们知道是会生成一个新的 js 文件的，那这个新的 js 文件 0.bundle.js 里面是不是也有自己的 modules 呢？那 bundle.js 如何知道 0.bundle.js 里面的 modules 呢？</p>\n<p>先看动态 import 的代码变成了什么样：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="44337806312834790000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`__webpack_require__\n  .e(/*! import() */ 0)\n  .then(__webpack_require__.bind(null, /*! ./moduleB             */ \'./src/moduleB.js\'))\n  .then((module) => {});`, `44337806312834790000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">__webpack_require__\n  <span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token comment">/*! import() */</span> <span class="token number">0</span><span class="token punctuation">)</span>\n  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token function">__webpack_require__</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment">/*! ./moduleB             */</span> <span class="token string">\'./src/moduleB.js\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">module</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>从代码看，实际上就是外面套了一层 webpck<em>require.e，然后这是一个 promise，在 then 里面再去执行 webpack</em>require。</p>\n<p>实际上 webpck_require.e 就是去加载 chunk 的 js 文件 0.bundle.js，具体代码就不贴了，没啥特别的。</p>\n<p>等到加载回来后它认为 bundle.js 里面的 modules 就一定会有了 0.bundle.js 包含的那些 modules，这是如何做到的呢？</p>\n<p>我们看 0.bundle.js 到底是什么内容，让它拥有这样的魔力：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="32226306433919594000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(window[\'webpackJsonp\'] = window[\'webpackJsonp\'] || []).push([\n  [0],\n  {\n    \'./src/moduleB.js\': function(module, __webpack_exports__, __webpack_require__) {}\n  }\n]);`, `32226306433919594000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token punctuation">(</span>window<span class="token punctuation">[</span><span class="token string">\'webpackJsonp\'</span><span class="token punctuation">]</span> <span class="token operator">=</span> window<span class="token punctuation">[</span><span class="token string">\'webpackJsonp\'</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">[</span>\n  <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n  <span class="token punctuation">{</span>\n    <span class="token string">\'./src/moduleB.js\'</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> __webpack_exports__<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>拿简化后的代码一看，大家第一眼想到的是 jsonp，但是很遗憾的是它不是一个函数，却只是向一个全局数组里面 push 了自己的模块 id 以及对应的 modules。那看起来魔法的核心应该是在 bundle.js 里面了，事实的确也是如此。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="68403122900300040000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var jsonpArray = (window[\'webpackJsonp\'] = window[\'webpackJsonp\'] || []);\nvar oldJsonpFunction = jsonpArray.push.bind(jsonpArray);\njsonpArray.push = webpackJsonpCallback;\njsonpArray = jsonpArray.slice();\nfor (var i = 0; i < jsonpArray.length; i++) webpackJsonpCallback(jsonpArray[i]);\nvar parentJsonpFunction = oldJsonpFunction;`, `68403122900300040000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> jsonpArray <span class="token operator">=</span> <span class="token punctuation">(</span>window<span class="token punctuation">[</span><span class="token string">\'webpackJsonp\'</span><span class="token punctuation">]</span> <span class="token operator">=</span> window<span class="token punctuation">[</span><span class="token string">\'webpackJsonp\'</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> oldJsonpFunction <span class="token operator">=</span> jsonpArray<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>jsonpArray<span class="token punctuation">)</span><span class="token punctuation">;</span>\njsonpArray<span class="token punctuation">.</span>push <span class="token operator">=</span> webpackJsonpCallback<span class="token punctuation">;</span>\njsonpArray <span class="token operator">=</span> jsonpArray<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> jsonpArray<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token function">webpackJsonpCallback</span><span class="token punctuation">(</span>jsonpArray<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> parentJsonpFunction <span class="token operator">=</span> oldJsonpFunction<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在 bundle.js 的里面，我们看到这么一段代码，其实就是说我们劫持了 push 函数，那 0.bundle.js 一旦加载完成，我们岂不是就会执行这里，那不就能拿到所有的参数，然后把 0.bundle.js 里面的所有 module 加到自己的 modules 里面去！</p>\n<h2 id="总结一下"><a href="#%E6%80%BB%E7%BB%93%E4%B8%80%E4%B8%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结一下</h2>\n<p>如果你没有很理解，可以配合下面的图片，再把上面的代码读几遍。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2020-06-30-20-18-37-541336a0f78dedb6cf7d1cd22b00704e-79633.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 58.590308370044056%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAAsSAAALEgHS3X78AAACkUlEQVQoz02SXUxSYRjHuey6u2676qab2loXtdbWzJptfkxgFLbV1tb8IFfrpma1bHMDkwLl8JGBKAQHiWwIHBADQS80KN3MWWYGRmluyMf54Jz3fTrHvPDdf3uf9+K35/m//0eGMLA80DVJbA04HnPCnnjgERw8nABVDiqiWKkQn7LlAu4exw+D0BOE+wHUQeJ2Ejp9cMuN3AtYZDAGJN1gm0Uqu9DlwxofVo8IljSSZXKgtjMaz67GU2pz4uvD25325XbH2hWCJ1ISJJLC3gjGJG4woy5v7Q7JNZr5F9NINpcDg8eZDx9fDNYrX/NWv6uYOvclplJYdozTHOKq1SpdrtAgVPujrGIoPxdq/xqX97kndNMgm82B1Uuw0cO58Im2EU7rmZwNqCh/R4vhlzFeFeFSqVylGdGyfqqmMBUSwe4lStU7NrkPm8lXdPzoj/CZ5v7VJ4OGBe9Z6s21xoH156EdplKkGUbsLDBFHcUoifwn6uZmokHrIrUS/BMspJ1NndyI1bcacn0OV3aiIfK2q8X4+2W0zNGl4q4kQPRAjJObNhOTd5ei6t6xoNRZ9Ex4bSXqyPfQabWT1/vDK/G2dOSewloyzYgfhRiGlTzzFV2EVpo2P1M3Ch8u69zj2v9jD5NGiB/aihy7amet/tFS8tTqlFJpK5rTUlJoPyqkjwutQ7lU8PYK1fxs7L3UeSEPPa65d4FHLr9e7ag9cC86A1azn5TbGGv6YFTYkASFtRgLPf0Y0zwejUlwNofrTaiOgIsENFqESwQ6b4I6M1wwImMCHcyZmEFNFkHpALkdmmx4MIlkhV3wZgRflhflzSAyIxbceLY2No/mN/Y3bG/BYKsM37Zh/S8WtbaN/5TgH4cyKr0uve2BAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2020 06 30 20 18 37" title="" data-src="/static/2020-06-30-20-18-37-541336a0f78dedb6cf7d1cd22b00704e-fee1c.png" data-srcset="/static/2020-06-30-20-18-37-541336a0f78dedb6cf7d1cd22b00704e-a67b7.png 200w,\n/static/2020-06-30-20-18-37-541336a0f78dedb6cf7d1cd22b00704e-0b187.png 400w,\n/static/2020-06-30-20-18-37-541336a0f78dedb6cf7d1cd22b00704e-fee1c.png 800w,\n/static/2020-06-30-20-18-37-541336a0f78dedb6cf7d1cd22b00704e-b1a91.png 1200w,\n/static/2020-06-30-20-18-37-541336a0f78dedb6cf7d1cd22b00704e-95179.png 1600w,\n/static/2020-06-30-20-18-37-541336a0f78dedb6cf7d1cd22b00704e-79633.png 1816w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>其实简单来说就是，对于 mainChunk 文件，我们维护一个 modules 这样的所有模块 map，并且提供类似 webpack_require 这样的函数。对于 chunkA 文件（可能是因为提取公共代码生成的、或者是动态加载）我们就用类似 jsonp 的方式，让它把自己的所有 modules 添加到主 chunk 的 modules 里面去。</p>\n<h1 id="module-federation"><a href="#module-federation" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Module federation</h1>\n<h2 id="module-federation-的介绍"><a href="#module-federation-%E7%9A%84%E4%BB%8B%E7%BB%8D" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Module federation 的介绍</h2>\n<p>允许运行时动态决定代码的引入和加载。</p>\n<h2 id="module-federation-的-demo"><a href="#module-federation-%E7%9A%84-demo" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Module federation 的 demo</h2>\n<p>我们最关心的还是 Module federation 的实现方式：</p>\n<p><a href="https://github.com/module-federation/module-federation-examples/tree/master/basic-host-remote" target="_blank" rel="nofollow noreferrer noopener">module-federation-examples/basic-host-remote</a></p>\n<p>在此之前，还是需要向大家介绍一下这个 demo 做的事情</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="32494437072805950000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`app1\n---index.js 入口文件\n---bootstrap.js 启动文件\n---App.js react组件\n\napp2\n---index.js 入口文件\n---bootstrap.js 启动文件\n---App.js react组件\n---Button.js react组件`, `32494437072805950000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">app1\n---index.js 入口文件\n---bootstrap.js 启动文件\n---App.js react组件\n\napp2\n---index.js 入口文件\n---bootstrap.js 启动文件\n---App.js react组件\n---Button.js react组件</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这是文件结构，其实你可以看成是两个独立应用 app1 和 app2，那他们之前有什么爱恨情仇呢？</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="87318250762345860000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`/** app1 **/\n/**\n * index.js\n **/\nimport(\'./bootstrap\');\n\n/**\n * bootstrap.js\n **/\nimport(\'./bootstrap\');\nimport App from \'./App\';\nimport React from \'react\';\nimport ReactDOM from \'react-dom\';\n\nReactDOM.render(<App />, document.getElementById(\'root\'));\n\n/**\n * App.js\n **/\nimport(\'./bootstrap\');\nimport React from \'react\';\n\nimport RemoteButton from \'app2/Button\';\n\nconst App = () => (\n  <div>\n    <h1>Basic Host-Remote</h1>\n    <h2>App 1</h2>\n    <React.Suspense fallback=\'Loading Button\'>\n      <RemoteButton />\n    </React.Suspense>\n  </div>\n);\n\nexport default App;`, `87318250762345860000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">/** app1 **/</span>\n<span class="token comment">/**\n * index.js\n **/</span>\n<span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">\'./bootstrap\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">/**\n * bootstrap.js\n **/</span>\n<span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">\'./bootstrap\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> App <span class="token keyword">from</span> <span class="token string">\'./App\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> ReactDOM <span class="token keyword">from</span> <span class="token string">\'react-dom\'</span><span class="token punctuation">;</span>\n\nReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>App <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">\'root\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">/**\n * App.js\n **/</span>\n<span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">\'./bootstrap\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> RemoteButton <span class="token keyword">from</span> <span class="token string">\'app2/Button\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">App</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span>\n  <span class="token operator">&lt;</span>div<span class="token operator">></span>\n    <span class="token operator">&lt;</span>h1<span class="token operator">></span>Basic Host<span class="token operator">-</span>Remote<span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">></span>\n    <span class="token operator">&lt;</span>h2<span class="token operator">></span>App <span class="token number">1</span><span class="token operator">&lt;</span><span class="token operator">/</span>h2<span class="token operator">></span>\n    <span class="token operator">&lt;</span>React<span class="token punctuation">.</span>Suspense fallback<span class="token operator">=</span><span class="token string">\'Loading Button\'</span><span class="token operator">></span>\n      <span class="token operator">&lt;</span>RemoteButton <span class="token operator">/</span><span class="token operator">></span>\n    <span class="token operator">&lt;</span><span class="token operator">/</span>React<span class="token punctuation">.</span>Suspense<span class="token operator">></span>\n  <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> App<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我这里只贴了 app1 的 js 代码，app2 的代码你不需要关心。代码没有什么特殊的，只有一点，app1 的 App.js 里面：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="51369429313564670000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import RemoteButton from \'app2/Button\';`, `51369429313564670000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> RemoteButton <span class="token keyword">from</span> <span class="token string">\'app2/Button\'</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>也就是关键来了，跨应用复用代码来了！app1 的代码用了 app2 的代码，但是这个代码最终长什么样？是如何引入 app2 的代码的？</p>\n<h2 id="module-federation-的配置"><a href="#module-federation-%E7%9A%84%E9%85%8D%E7%BD%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Module federation 的配置</h2>\n<p>先看我们的 webpack 需要如何配置：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="29035202837855855000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`/**\n * app1/webpack.js\n */\n{\n  plugins: [\n    new ModuleFederationPlugin({\n      name: \'app1\',\n      library: {\n        type: \'var\',\n        name: \'app1\'\n      },\n      remotes: {\n        app2: \'app2\'\n      },\n      shared: [\'react\', \'react-dom\']\n    })\n  ];\n}`, `29035202837855855000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">/**\n * app1/webpack.js\n */</span>\n<span class="token punctuation">{</span>\n  plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n    <span class="token keyword">new</span> <span class="token class-name">ModuleFederationPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n      name<span class="token punctuation">:</span> <span class="token string">\'app1\'</span><span class="token punctuation">,</span>\n      library<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n        type<span class="token punctuation">:</span> <span class="token string">\'var\'</span><span class="token punctuation">,</span>\n        name<span class="token punctuation">:</span> <span class="token string">\'app1\'</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      remotes<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n        app2<span class="token punctuation">:</span> <span class="token string">\'app2\'</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      shared<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'react\'</span><span class="token punctuation">,</span> <span class="token string">\'react-dom\'</span><span class="token punctuation">]</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  <span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这个其实就是 Module federation 的配置了，大概能看到想表达的意思：</p>\n<ol>\n<li>用了远程模块 app2，它叫 app2</li>\n<li>用了共享模块，它叫 shared</li>\n</ol>\n<p>remotes 和 shared 还是有一点区别的，我们先来看效果。</p>\n<p>生成的 html 文件：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="67680621814867600000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<html>\n  <head>\n    <script src=&quot;app2/remoteEntry.js&quot;></script>\n  </head>\n  <body>\n    <div id=&quot;root&quot;></div>\n    <script src=&quot;app1/app1.js&quot;></script>\n    <script src=&quot;app1/main.js&quot;></script>\n  </body>\n</html>`, `67680621814867600000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="html"\n              >\n                <span class="gatsby-code-button-language">html</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="html"><pre style="counter-reset: linenumber NaN" class="language-html line-numbers"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span>\n  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>app2/remoteEntry.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>\n  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>\n  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>root<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>app1/app1.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>app1/main.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>\n  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>ps：这里的 js 路径有修改，这个是可以配置的，这里只是表明从哪里加载了哪些 js 文件</p>\n<p>app1 打包生成的文件：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="5481667570517801000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`app1/index.html\napp1/app1.js\napp1/main.js\napp1/react.js\napp1/react-dom.js\napp1/src_bootstrap.js`, `5481667570517801000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">app1/index.html\napp1/app1.js\napp1/main.js\napp1/react.js\napp1/react-dom.js\napp1/src_bootstrap.js</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>ps: app2 你也需要打包，只是我没有贴 app2 的代码以及配置文件，后面需要的时候会再贴出来的</p>\n<p>最终页面表现以及加载的 js：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2020-06-30-20-52-54-74cb5a4206669b82272c42ae97e959fe-6cb4b.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 43.17386231038506%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAAsSAAALEgHS3X78AAABBUlEQVQoz4VRXWuEMBD0//83QZ8Ozqt6JkYrpyZePjabqF1pKfTBOgxLQpjd2UmS53lRFFRvt1uWZWmaMsb2fd+2jSpo3dzvPeeibYUQ9PRkXVU3H2XDOU+GYTDGSCm11kqpaZqstb9iZ8z8OehlcdaoRVesbxi14KLry7JO+r7fz4EYfEDwnnqBR7ksykwvNdKTdS6R8xxCOBMHRA+wrWsIGOmC3nvAgCSJMSRnsm/b2piqZqIbyPNbu4MGFu0Ovm2y/wsa1LB2nCR5tg4dED2dMUTitZhx/mwo5qNy3lJUxlqyTTtciAGAZI+yeo3jsS5QdjT3BxdimkD/5wBijOtKwf3BF19KBzppj0CVAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2020 06 30 20 52 54" title="" data-src="/static/2020-06-30-20-52-54-74cb5a4206669b82272c42ae97e959fe-fee1c.png" data-srcset="/static/2020-06-30-20-52-54-74cb5a4206669b82272c42ae97e959fe-a67b7.png 200w,\n/static/2020-06-30-20-52-54-74cb5a4206669b82272c42ae97e959fe-0b187.png 400w,\n/static/2020-06-30-20-52-54-74cb5a4206669b82272c42ae97e959fe-fee1c.png 800w,\n/static/2020-06-30-20-52-54-74cb5a4206669b82272c42ae97e959fe-b1a91.png 1200w,\n/static/2020-06-30-20-52-54-74cb5a4206669b82272c42ae97e959fe-95179.png 1600w,\n/static/2020-06-30-20-52-54-74cb5a4206669b82272c42ae97e959fe-6cb4b.png 1714w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>从上往下加载的 js 时序其实是很有讲究的，后面将会是解密的关键：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="25108410380870906000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`app2/remoteEntry.js\napp1/app1.js\napp1/main.js\napp1/react.js\napp1/react-dom.js\napp2/src_button_js.js\napp1/src_bootstrap.js`, `25108410380870906000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">app2/remoteEntry.js\napp1/app1.js\napp1/main.js\napp1/react.js\napp1/react-dom.js\napp2/src_button_js.js\napp1/src_bootstrap.js</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这里最需要关注的其实还是每个文件从哪里加载，在不去分析原理之前，看文件加载我们至少有这些结论：</p>\n<ol>\n<li>remotes 的代码自己不打包，类似 external，例如 app2/button 就是加载 app2 打包的代码</li>\n<li>shared 的代码自己是有打包的</li>\n</ol>\n<h2 id="module-federation-的原理"><a href="#module-federation-%E7%9A%84%E5%8E%9F%E7%90%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Module federation 的原理</h2>\n<p>在讲解原理之前，我还是放出之前的一张图，因为这是 webpack 的文件模块核心，即使升级 5，也没有发生变化</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2020-07-10-14-59-24-f7b65ff3c10656a019bdd58ed416eac2-6a653.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 54.5755237045204%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsSAAALEgHS3X78AAACPUlEQVQoz12QS28SYRSGZ+VGl13rT9B/0GhMadQYYi0wVSC4Mca4ME2kCRZiwyWgrZdioQoy5eIgzIVhZhAol2LSumkq0JRNk6q7aqKNRqTY7+JHwaTxLM7qefK+51Dvd3B6A8ibB9kmEOpIbIBM40CoA6mJOn8wmZVtxH0AyuaBdAQQ6yDbRJS7AIefITqGdQy+FASaID4XwOcX8HgYfPvVk60ZeHYeX09gXaQHjBwCIwvYEAGUr4IfJAp5eSrCv7y2BJ9wiqo6/RxvicO9NnGRI4d9rECAAMcSICikVMX5KJ2/8RpTzhJmU3ZcPdbKaegI5OWnu7VRWfaYYn0Z2lT8VrhFgDXZaGDwcs6xW9MkpYAxjilXCTNvPJ3S0Lp8hWZQkvd+Lo8KwrQphvbaqC+L3OTv5aGKdNPAIDVjJUCMmzUlDuVoehasnq4XLXQERPnnW4UxlveZBzKyKVgSbWD1TC03Se7kRddWfiycXhzISylvt3pyI6cnclJ8/Kmq5TNO86A2IskSf69bPbWi3DZEoJJ1fKxoo/y8qV87npqB5RMN5SLNwKiw2CroWWHOfKS2zN2B5ePvshZSm8+4W0VdiHvRS/aUsZ8N7eSHi9JdcrMo+79WLqhZl/nft6dVUu0hAURxhmZASbV9IQ8T58xE9pbg5WB34lVHH96/Ggb6cJsO/xgPtSeWwPeejG0y1C7+D+hC+8YYoNh1aJWgPYfsKnKokGwSdV9Bzjz8ud+TQ2twKtsH4FHAXYR/AVrIz1X6SB9CAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2020 07 10 14 59 24" title="" data-src="/static/2020-07-10-14-59-24-f7b65ff3c10656a019bdd58ed416eac2-fee1c.png" data-srcset="/static/2020-07-10-14-59-24-f7b65ff3c10656a019bdd58ed416eac2-a67b7.png 200w,\n/static/2020-07-10-14-59-24-f7b65ff3c10656a019bdd58ed416eac2-0b187.png 400w,\n/static/2020-07-10-14-59-24-f7b65ff3c10656a019bdd58ed416eac2-fee1c.png 800w,\n/static/2020-07-10-14-59-24-f7b65ff3c10656a019bdd58ed416eac2-b1a91.png 1200w,\n/static/2020-07-10-14-59-24-f7b65ff3c10656a019bdd58ed416eac2-95179.png 1600w,\n/static/2020-07-10-14-59-24-f7b65ff3c10656a019bdd58ed416eac2-6a653.png 1814w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>app1 和 app2 还是有自己的 modules，所以实现的关键就是两个 modules 如何同步，或者说如何注入，那我们就来看看 Module federation 如何实现的。</p>\n<h3 id="import-变成了什么"><a href="#import-%E5%8F%98%E6%88%90%E4%BA%86%E4%BB%80%E4%B9%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>import 变成了什么</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="14776778716685769000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// import源码\nimport RemoteButton from \'app2/Button\';\n\n// import打包代码 在app1/src_bootstrap.js里面\n/* harmony import */\nvar app2_Button__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! app2/Button */ \'?ad8d\');\n/* harmony import */\nvar app2_Button__WEBPACK_IMPORTED_MODULE_1___default = /*#__PURE__*/ __webpack_require__.n(\n  app2_Button__WEBPACK_IMPORTED_MODULE_1__\n);`, `14776778716685769000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// import源码</span>\n<span class="token keyword">import</span> RemoteButton <span class="token keyword">from</span> <span class="token string">\'app2/Button\'</span><span class="token punctuation">;</span>\n\n<span class="token comment">// import打包代码 在app1/src_bootstrap.js里面</span>\n<span class="token comment">/* harmony import */</span>\n<span class="token keyword">var</span> app2_Button__WEBPACK_IMPORTED_MODULE_1__ <span class="token operator">=</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token comment">/*! app2/Button */</span> <span class="token string">\'?ad8d\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">/* harmony import */</span>\n<span class="token keyword">var</span> app2_Button__WEBPACK_IMPORTED_MODULE_1___default <span class="token operator">=</span> <span class="token comment">/*#__PURE__*/</span> __webpack_require__<span class="token punctuation">.</span><span class="token function">n</span><span class="token punctuation">(</span>\n  app2_Button__WEBPACK_IMPORTED_MODULE_1__\n<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>从这里来看，我们好像看不出什么，因为还是正常的 webpack<em>require，难道说它真的像我们之前所设想的那样，重写了 webpack</em>require 吗？</p>\n<p>遗憾的是，从源码看这个函数是没有什么变化的，所以核心点不是这里。</p>\n<p>但是你注意看加载的 js 顺序：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="10417699458111906000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`app2/remoteEntry.js\napp1/app1.js\napp1/main.js\napp1/react.js\napp1/react-dom.js\napp2/src_button_js.js // app2的button竟然先加载了，比我们的自己启动文件还前面\napp1/src_bootstrap.js`, `10417699458111906000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">app2/remoteEntry.js\napp1/app1.js\napp1/main.js\napp1/react.js\napp1/react-dom.js\napp2/src_button_js.js // app2的button竟然先加载了，比我们的自己启动文件还前面\napp1/src_bootstrap.js</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>那么是不是我们需要将依赖前置，也就是说在加载远程模块时，它知道自己依赖哪些共享模块，然后去检测是否存在，不存在依次去加载，所以依赖就位后才开始执行自己。</p>\n<p>所以它是不是通过依赖前置来解决的呢？</p>\n<h3 id="mainjs-文件内容"><a href="#mainjs-%E6%96%87%E4%BB%B6%E5%86%85%E5%AE%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>main.js 文件内容</h3>\n<p>因为 html 里面和 app1 相关的只有两个文件：app1/app1.js 以及 app1/main.js</p>\n<p>那我们看看 main.js 到底写了啥</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="69017806762199700000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(() => {\n  // webpackBootstrap\n  var __webpack_modules__ = {};\n\n  var __webpack_module_cache__ = {};\n\n  function __webpack_require__(moduleId) {\n    if (__webpack_module_cache__[moduleId]) {\n      return __webpack_module_cache__[moduleId].exports;\n    }\n    var module = (__webpack_module_cache__[moduleId] = {\n      exports: {}\n    });\n    __webpack_modules__[moduleId](module, module.exports, __webpack_require__);\n    return module.exports;\n  }\n  __webpack_require__.m = __webpack_modules__;\n\n  __webpack_require__(\'./src/index.js\');\n})();`, `69017806762199700000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token comment">// webpackBootstrap</span>\n  <span class="token keyword">var</span> __webpack_modules__ <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">var</span> __webpack_module_cache__ <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">function</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token parameter">moduleId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>__webpack_module_cache__<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span> __webpack_module_cache__<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">.</span>exports<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">var</span> module <span class="token operator">=</span> <span class="token punctuation">(</span>__webpack_module_cache__<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>\n      exports<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    __webpack_modules__<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> __webpack_require__<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">return</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  __webpack_require__<span class="token punctuation">.</span>m <span class="token operator">=</span> __webpack_modules__<span class="token punctuation">;</span>\n\n  <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token string">\'./src/index.js\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以看到区别不大，只是把之前的 modules 换成了 webpack_modules，然后把这个 modules 的初始化由参数改成了内部声明变量。</p>\n<p>那我们来看看 webpack_modules 内部的实现:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="87759826276095560000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var __webpack_modules__ = {\n  \'./src/index.js\': (__unused_webpack_module, __unused_webpack_exports, __webpack_require__) => {\n    __webpack_require__\n      .e(/*! import() */ \'src_bootstrap_js\')\n      .then(__webpack_require__.bind(__webpack_require__, /*! ./bootstrap */ \'./src/bootstrap.js\'));\n  },\n\n  \'container-reference/app2\': (module) => {\n    \'use strict\';\n    module.exports = app2;\n  },\n\n  \'?8bfd\': (module, __unused_webpack_exports, __webpack_require__) => {\n    \'use strict\';\n    var external = __webpack_require__(\'container-reference/app2\');\n    module.exports = external;\n  }\n};`, `87759826276095560000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> __webpack_modules__ <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token string">\'./src/index.js\'</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">__unused_webpack_module<span class="token punctuation">,</span> __unused_webpack_exports<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    __webpack_require__\n      <span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token comment">/*! import() */</span> <span class="token string">\'src_bootstrap_js\'</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token function">__webpack_require__</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>__webpack_require__<span class="token punctuation">,</span> <span class="token comment">/*! ./bootstrap */</span> <span class="token string">\'./src/bootstrap.js\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n\n  <span class="token string">\'container-reference/app2\'</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">module</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token string">\'use strict\'</span><span class="token punctuation">;</span>\n    module<span class="token punctuation">.</span>exports <span class="token operator">=</span> app2<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n\n  <span class="token string">\'?8bfd\'</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> __unused_webpack_exports<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token string">\'use strict\'</span><span class="token punctuation">;</span>\n    <span class="token keyword">var</span> external <span class="token operator">=</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token string">\'container-reference/app2\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    module<span class="token punctuation">.</span>exports <span class="token operator">=</span> external<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>从代码看起来就三个 module：</p>\n<ol>\n<li><code class="language-text">./src/index.js</code> 这个看起来就是我们的 <code class="language-text">app1/index.js</code>，里面去动态加载 <code class="language-text">bootstrap.js</code> 对应的 <code class="language-text">chunk src_bootstrap_js</code></li>\n<li><code class="language-text">container-reference/app2</code> 直接返回一个全局的 <code class="language-text">app2</code>，这里感觉和我们的 <code class="language-text">app2</code> 有关系</li>\n<li><code class="language-text">?8bfd</code> 这个字符串是我们上面提到的 <code class="language-text">app2/button</code> 对应的文件引用 <code class="language-text">id</code></li>\n</ol>\n<p>那在加载 src<em>bootstrap.js 之前加载的那些 react 文件还有 app2/button 文件都是谁做的呢？通过 debug，我们发现秘密就在 webpack</em>require__.e(“src<em>bootstrap</em>js”) 这句话</p>\n<blockquote>\n<p>实际上 webpck_require.e 就是去加载 chunk 的 js 文件 0.bundle.js，等到加载回来后它认为 bundle.js 里面的 modules 就一定会有了 0.bundle.js 包含的那些 modules</p>\n</blockquote>\n<p>也就是说原来的 webpack<em>require\\</em>_.e 平淡无奇，就是加载一个 script，以致于我们都不想去贴出它的代码，但是这次升级后一切变的不一样了，它成了关键中的关键！</p>\n<h3 id="webpackrequire_e-做了什么"><a href="#webpackrequire_e-%E5%81%9A%E4%BA%86%E4%BB%80%E4%B9%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>webpack<em>require\\</em>_.e 做了什么</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="64869301912838130000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`__webpack_require__.e = (chunkId) => {\n  return Promise.all(\n    Object.keys(__webpack_require__.f).reduce((promises, key) => {\n      __webpack_require__.f[key](chunkId, promises);\n      return promises;\n    }, [])\n  );\n};`, `64869301912838130000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">__webpack_require__<span class="token punctuation">.</span><span class="token function-variable function">e</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">chunkId</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>\n    Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>__webpack_require__<span class="token punctuation">.</span>f<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">promises<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      __webpack_require__<span class="token punctuation">.</span>f<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">(</span>chunkId<span class="token punctuation">,</span> promises<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">return</span> promises<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>看代码，的确发生了变化，现在底层是去调用 webpack_require.f 上面的函数了，等到所有函数都执行完了，才执行 promise 的 then</p>\n<p>那问题的核心又变成了 webpack_require.f 上面有哪些函数了，最后发现有三个函数：</p>\n<h4 id="overridables"><a href="#overridables" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>overridables</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="28742630812685242000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`/* webpack/runtime/overridables */\n__webpack_require__.O = {};\nvar chunkMapping = {\n  src_bootstrap_js: [\'?a75e\', \'?6365\']\n};\nvar idToNameMapping = {\n  \'?a75e\': \'react-dom\',\n  \'?6365\': \'react\'\n};\nvar fallbackMapping = {\n  \'?a75e\': () => {\n    return __webpack_require__\n      .e(\'vendors-node_modules_react-dom_index_js\')\n      .then(() => () => __webpack_require__(\'./node_modules/react-dom/index.js\'));\n  },\n  \'?6365\': () => {\n    return __webpack_require__\n      .e(\'vendors-node_modules_react_index_js\')\n      .then(() => () => __webpack_require__(\'./node_modules/react/index.js\'));\n  }\n};\n__webpack_require__.f.overridables = (chunkId, promises) => {};`, `28742630812685242000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">/* webpack/runtime/overridables */</span>\n__webpack_require__<span class="token punctuation">.</span><span class="token constant">O</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> chunkMapping <span class="token operator">=</span> <span class="token punctuation">{</span>\n  src_bootstrap_js<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'?a75e\'</span><span class="token punctuation">,</span> <span class="token string">\'?6365\'</span><span class="token punctuation">]</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> idToNameMapping <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token string">\'?a75e\'</span><span class="token punctuation">:</span> <span class="token string">\'react-dom\'</span><span class="token punctuation">,</span>\n  <span class="token string">\'?6365\'</span><span class="token punctuation">:</span> <span class="token string">\'react\'</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> fallbackMapping <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token string">\'?a75e\'</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> __webpack_require__\n      <span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token string">\'vendors-node_modules_react-dom_index_js\'</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token string">\'./node_modules/react-dom/index.js\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token string">\'?6365\'</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> __webpack_require__\n      <span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token string">\'vendors-node_modules_react_index_js\'</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token string">\'./node_modules/react/index.js\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n__webpack_require__<span class="token punctuation">.</span>f<span class="token punctuation">.</span><span class="token function-variable function">overridables</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">chunkId<span class="token punctuation">,</span> promises</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="remotes"><a href="#remotes" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>remotes</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="97185548757404990000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`/* webpack/runtime/remotes loading */\nvar chunkMapping = {\n  src_bootstrap_js: [\'?ad8d\']\n};\nvar idToExternalAndNameMapping = {\n  \'?ad8d\': [\'?8bfd\', \'Button\']\n};\n__webpack_require__.f.remotes = (chunkId, promises) => {};`, `97185548757404990000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">/* webpack/runtime/remotes loading */</span>\n<span class="token keyword">var</span> chunkMapping <span class="token operator">=</span> <span class="token punctuation">{</span>\n  src_bootstrap_js<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'?ad8d\'</span><span class="token punctuation">]</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> idToExternalAndNameMapping <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token string">\'?ad8d\'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'?8bfd\'</span><span class="token punctuation">,</span> <span class="token string">\'Button\'</span><span class="token punctuation">]</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n__webpack_require__<span class="token punctuation">.</span>f<span class="token punctuation">.</span><span class="token function-variable function">remotes</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">chunkId<span class="token punctuation">,</span> promises</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="jsonp"><a href="#jsonp" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>jsonp</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="3753266600619876000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`/* webpack/runtime/jsonp chunk loading */\nvar installedChunks = {\n  main: 0\n};\n\n__webpack_require__.f.j = (chunkId, promises) => {};`, `3753266600619876000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">/* webpack/runtime/jsonp chunk loading */</span>\n<span class="token keyword">var</span> installedChunks <span class="token operator">=</span> <span class="token punctuation">{</span>\n  main<span class="token punctuation">:</span> <span class="token number">0</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n__webpack_require__<span class="token punctuation">.</span>f<span class="token punctuation">.</span><span class="token function-variable function">j</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">chunkId<span class="token punctuation">,</span> promises</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这三个函数我把核心部分节选出来了，其实注释也写得比较清楚了，我还是解释一下：</p>\n<ol>\n<li>overridables 可覆盖的，看代码你应该已经知道和 shared 配置有关</li>\n<li>remotes 远程的，看代码非常明显是和 remotes 配置相关</li>\n<li>jsonp 这个就是原有的加载 chunk 函数，对应的是以前的懒加载或者公共代码提取</li>\n</ol>\n<h3 id="加载流程"><a href="#%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>加载流程</h3>\n<p>知道了核心在 webpack_require.e 以及内部实现后，不知道你脑子里是不是对整个加载流程有了一定的思路，如果没有，容我来给你解析一下</p>\n<ol>\n<li>先加载 src_main.js，这个没什么好说的，注入在 html 里面的</li>\n<li>src<em>main.js 里面执行 webpack</em>require(“./src/index.js”)</li>\n<li>src/index.js 这个 module 的逻辑很简单，就是动态加载 src<em>bootstrap</em>js 这个 chunk</li>\n<li>动态加载 src<em>bootstrap</em>js 这个 chunk 时，经过 overridables，发现这个 chunk 依赖了 react、react-dom，那就看是否已经加载，没有加载就去加载对应的 js 文件，地址也告诉你了</li>\n<li>动态加载 src<em>bootstrap</em>js 这个 chunk 时，经过 remotes，发现这个 chunk 依赖了?ad8d，那就去加载这个 js</li>\n<li>动态加载 src<em>bootstrap</em>js 这个 chunk 时，经过 jsonp，就正常加载就好了</li>\n<li>所有依赖以及 chunk 都加载完成了，就去执行 then 逻辑：webpack<em>require src</em>bootstrap_js 里面的 module：./src/bootstrap.js</li>\n</ol>\n<p>到此就一切都正常启动了，其实就是我们之前提到的依赖前置，先去分析，然后生成配置文件，再去加载。</p>\n<p>看起来一切都很美好，但其实还是有一个关键信息没有解决！</p>\n<h3 id="如何知道-app2-的存在"><a href="#%E5%A6%82%E4%BD%95%E7%9F%A5%E9%81%93-app2-%E7%9A%84%E5%AD%98%E5%9C%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>如何知道 app2 的存在</h3>\n<p>上面的第 4 步加载 react 的时候，因为我们自己实际上也打包了 react 文件，所以当没有加载的时候，我们可以去加载一份，也知道地址</p>\n<p>但是第五步的时候，当页面从来没有加载过 app2/Button 的时候，我们去什么地址加载什么文件呢？</p>\n<p>这个时候就要用到前面我们提到的 main.js 里面的 webpack_modules 了</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="46950812733073690000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var __webpack_modules__ = {\n  \'container-reference/app2\': (module) => {\n    \'use strict\';\n    module.exports = app2;\n  },\n\n  \'?8bfd\': (module, __unused_webpack_exports, __webpack_require__) => {\n    \'use strict\';\n    var external = __webpack_require__(\'container-reference/app2\');\n    module.exports = external;\n  }\n};`, `46950812733073690000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> __webpack_modules__ <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token string">\'container-reference/app2\'</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">module</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token string">\'use strict\'</span><span class="token punctuation">;</span>\n    module<span class="token punctuation">.</span>exports <span class="token operator">=</span> app2<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n\n  <span class="token string">\'?8bfd\'</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> __unused_webpack_exports<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token string">\'use strict\'</span><span class="token punctuation">;</span>\n    <span class="token keyword">var</span> external <span class="token operator">=</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token string">\'container-reference/app2\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    module<span class="token punctuation">.</span>exports <span class="token operator">=</span> external<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这里面有三个 module，我们还有 ?8bfd、container-reference/app2 没有用到，我们再看一下 remotes 的实现</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="10863014023449690000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`/* webpack/runtime/remotes loading */\nvar chunkMapping = {\n  src_bootstrap_js: [\'?ad8d\']\n};\nvar idToExternalAndNameMapping = {\n  \'?ad8d\': [\'?8bfd\', \'Button\']\n};\n__webpack_require__.f.remotes = (chunkId, promises) => {\n  if (__webpack_require__.o(chunkMapping, chunkId)) {\n    chunkMapping[chunkId].forEach((id) => {\n      if (__webpack_modules__[id]) return;\n      var data = idToExternalAndNameMapping[id];\n      promises.push(\n        Promise.resolve(__webpack_require__(data[0]).get(data[1])).then((factory) => {\n          __webpack_modules__[id] = (module) => {\n            module.exports = factory();\n          };\n        })\n      );\n    });\n  }\n};`, `10863014023449690000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">/* webpack/runtime/remotes loading */</span>\n<span class="token keyword">var</span> chunkMapping <span class="token operator">=</span> <span class="token punctuation">{</span>\n  src_bootstrap_js<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'?ad8d\'</span><span class="token punctuation">]</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> idToExternalAndNameMapping <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token string">\'?ad8d\'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'?8bfd\'</span><span class="token punctuation">,</span> <span class="token string">\'Button\'</span><span class="token punctuation">]</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n__webpack_require__<span class="token punctuation">.</span>f<span class="token punctuation">.</span><span class="token function-variable function">remotes</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">chunkId<span class="token punctuation">,</span> promises</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>__webpack_require__<span class="token punctuation">.</span><span class="token function">o</span><span class="token punctuation">(</span>chunkMapping<span class="token punctuation">,</span> chunkId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    chunkMapping<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>__webpack_modules__<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>\n      <span class="token keyword">var</span> data <span class="token operator">=</span> idToExternalAndNameMapping<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">;</span>\n      promises<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>\n        Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token function">__webpack_require__</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">factory</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n          __webpack_modules__<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">module</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">factory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token punctuation">}</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span>\n      <span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>当我们加载 src<em>bootstrap</em>js 这个 chunk 时，经过 remotes，发现这个 chunk 依赖了?ad8d，那在运行时的时候：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="84012473016553100000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`id = \'?8bfd\';\ndata = [\'?8bfd\', \'Button\'];\n// 源码\n__webpack_require__(data[0]).get(data[1]);\n// 运行时\n__webpack_require__(\'?8bfd\').get(\'Button\');`, `84012473016553100000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">id <span class="token operator">=</span> <span class="token string">\'?8bfd\'</span><span class="token punctuation">;</span>\ndata <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'?8bfd\'</span><span class="token punctuation">,</span> <span class="token string">\'Button\'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token comment">// 源码</span>\n<span class="token function">__webpack_require__</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// 运行时</span>\n<span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token string">\'?8bfd\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">\'Button\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>结合 main.js 的 module ?8bfd 的代码，那最终就是 app2.get(“Button”)</p>\n<p>这不就是个全局变量吗？看起来有些蹊跷啊！</p>\n<h3 id="再看-app2remoteentryjs"><a href="#%E5%86%8D%E7%9C%8B-app2remoteentryjs" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>再看 app2/remoteEntry.js</h3>\n<p>我们好像一直忽略了这个文件，它是第一个加载的，必然有它的作用，带着对全局 app2 有什么蹊跷的疑问，我们去看了这个文件，果然发现了玄机！</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="93181027032680920000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var app2;\napp2 = (() => {\n  \'use strict\';\n  var __webpack_modules__ = {\n    \'?8619\': (__unused_webpack_module, exports, __webpack_require__) => {\n      var moduleMap = {\n        Button: () => {\n          return __webpack_require__\n            .e(\'src_Button_js\')\n            .then(() => () => __webpack_require__(/*! ./src/Button */ \'./src/Button.js\'));\n        }\n      };\n      var get = (module) => {\n        return __webpack_require__.o(moduleMap, module)\n          ? moduleMap[module]()\n          : Promise.resolve().then(() => {\n              throw new Error(\'Module \' + module + \' does not exist in container.\');\n            });\n      };\n      var override = (override) => {\n        Object.assign(__webpack_require__.O, override);\n      };\n\n      __webpack_require__.d(exports, {\n        get: () => get,\n        override: () => override\n      });\n    }\n  };\n  return __webpack_require__(\'?8619\');\n})();`, `93181027032680920000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> app2<span class="token punctuation">;</span>\napp2 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token string">\'use strict\'</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> __webpack_modules__ <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token string">\'?8619\'</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">__unused_webpack_module<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">var</span> moduleMap <span class="token operator">=</span> <span class="token punctuation">{</span>\n        <span class="token function-variable function">Button</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n          <span class="token keyword">return</span> __webpack_require__\n            <span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token string">\'src_Button_js\'</span><span class="token punctuation">)</span>\n            <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token comment">/*! ./src/Button */</span> <span class="token string">\'./src/Button.js\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span><span class="token punctuation">;</span>\n      <span class="token keyword">var</span> <span class="token function-variable function">get</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">module</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token keyword">return</span> __webpack_require__<span class="token punctuation">.</span><span class="token function">o</span><span class="token punctuation">(</span>moduleMap<span class="token punctuation">,</span> module<span class="token punctuation">)</span>\n          <span class="token operator">?</span> moduleMap<span class="token punctuation">[</span>module<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n          <span class="token punctuation">:</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n              <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">\'Module \'</span> <span class="token operator">+</span> module <span class="token operator">+</span> <span class="token string">\' does not exist in container.\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">;</span>\n      <span class="token keyword">var</span> <span class="token function-variable function">override</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">override</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>__webpack_require__<span class="token punctuation">.</span><span class="token constant">O</span><span class="token punctuation">,</span> override<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n      __webpack_require__<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>exports<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n        <span class="token function-variable function">get</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">get</span><span class="token punctuation">,</span>\n        <span class="token function-variable function">override</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> override\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token string">\'?8619\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果你细心看，就会发现，这个文件定义了全局的 app2 变量，然后提供了一个 get 函数，里面实际上就是去加载具体的模块</p>\n<p>所以 app2.get(“Button”) 在这里就变成了 app2 内部定义的 get 函数，随后执行自己的 webpack_require</p>\n<p>是不是有种焕然大悟的感觉！</p>\n<p>原来它是这样在两个独立打包的应用之间，通过全局变量去建立了一座彩虹桥！</p>\n<p>当然，app2/remoteEntry.js 是由 app2 根据配置打包出来的，里面实际上就是根据配置文件的导出模块，生成对应的内部 modules</p>\n<h3 id="你可能忽略的-bootstrapjs"><a href="#%E4%BD%A0%E5%8F%AF%E8%83%BD%E5%BF%BD%E7%95%A5%E7%9A%84-bootstrapjs" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>你可能忽略的 bootstrap.js</h3>\n<p>在入口文件 index.js 和真正的文件 app.js 之间多了一个 bootstrap.js，而且里面内容就是异步加载 app.js</p>\n<p>那这个文件是不是多余的，笔者试了一下，直接把入口换成 app.js 或者这里换成同步加载，整个应用就跑不起来了</p>\n<p>其实从原理上分析后也是可以理解的：</p>\n<p>因为依赖需要前置，并且等依赖加载完成后才能执行自己的入口文件，如果不把入口变成一个异步的 chunk，那如何去实现这样的依赖前置呢？毕竟实现依赖前置加载的核心是 webpack_require.e</p>\n<h2 id="总结"><a href="#%E6%80%BB%E7%BB%93" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h2>\n<p>这里解决的主要是 2 个问题：</p>\n<ol>\n<li>如何解决依赖问题，这里的实现方式是重写了加载 chunk 的 webpack_require.e，从而前置加载依赖</li>\n<li>如何解决 modules 的共享问题，这里是使用全局变量来 hook</li>\n</ol>\n<p>这种实现方式的优缺点其实也明显：</p>\n<p>优点：做到代码的运行时加载，而且 shared 代码无需自己手动打包缺点：对于其他应用的依赖，实际上是强依赖的，也就是说 app2 有没有按照接口实现，你是不知道的</p>',
id:"/home/runner/work/GatsbyBlog/GatsbyBlog/blog/Module federation 原理研究/index.md absPath of file >>> MarkdownRemark",timeToRead:12,frontmatter:{date:"2020-07-10 15:29:05",path:"/module-federation-principle-research/",tags:"前端, 前端构建工具, webpack",title:"Module federation 原理研究",draft:null}},{excerpt:"需求背景 由于客服聊天组件需要支持以新窗口的形式打开，也就是以 window.open 的新窗口打开，同时需要支持嵌入公司自己的产品端，在技术攻关的过程中遇到很多问题，特此记录 问题及解决方案 标记为横线的为完成需求后发现现阶段不需要做的 跨域窗口间的通信： 编写底层通信库 、通过 url 传递 嵌入公司产品端：独立客服聊天组件的运行环境 设置新窗口位置：需要注意兼容分屏情况 监听新窗口打开情况： 通过底层库发消息 、获取 window.open 的 closed…",html:'<h1 id="需求背景"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h1>\n<p>由于客服聊天组件需要支持以新窗口的形式打开，也就是以 window.open 的新窗口打开，同时需要支持嵌入公司自己的产品端，在技术攻关的过程中遇到很多问题，特此记录</p>\n<h1 id="问题及解决方案"><a href="#%E9%97%AE%E9%A2%98%E5%8F%8A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>问题及解决方案</h1>\n<p>标记为横线的为完成需求后发现现阶段不需要做的</p>\n<ol>\n<li>跨域窗口间的通信：<s>编写底层通信库</s>、通过 url 传递</li>\n<li>嵌入公司产品端：独立客服聊天组件的运行环境</li>\n<li>设置新窗口位置：需要注意兼容分屏情况</li>\n<li>监听新窗口打开情况：<s>通过底层库发消息</s>、获取 window.open 的 closed 属性</li>\n<li><s>监听新窗口是否加载完成</s>：<s>通过底层库发消息</s></li>\n<li>聊天消息输入类 html 字符：匹配特定字符进行 html 渲染，其他字符按文本渲染</li>\n</ol>\n<h1 id="具体解决"><a href="#%E5%85%B7%E4%BD%93%E8%A7%A3%E5%86%B3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>具体解决</h1>\n<h2 id="跨域窗口间通信"><a href="#%E8%B7%A8%E5%9F%9F%E7%AA%97%E5%8F%A3%E9%97%B4%E9%80%9A%E4%BF%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>跨域窗口间通信</h2>\n<h3 id="底层库编写"><a href="#%E5%BA%95%E5%B1%82%E5%BA%93%E7%BC%96%E5%86%99" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>底层库编写</h3>\n<p>因为需要知道打开的是哪个技能组（相当于群），需要传递技能组的相关信息，首先需要编写底层库，核心代码如下</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="38846117337024455000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`export default class Bus {\n    private syncFns: Array<SyncFn> = []\n\n    constructor(public origin: string, syncFn: SyncFn | Array<SyncFn>) {\n        this.init()\n        this.syncFns = Array.isArray(syncFn) ? syncFn : [syncFn]\n    }\n\n    private init(): void {\n        window.addEventListener(&quot;message&quot;, this.receiveMsg.bind(this), false)\n    }\n\n    // 获取跨域消息\n    private receiveMsg(e) {\n        const { origin } = e\n        if (this.origin !== \'*\' && origin !== this.origin) return\n        const { name, data } = e.data\n        this.syncFns.forEach(item => {\n            if (item.name === name) {\n                item.fn(data, e)\n            }\n        })\n    }\n\n    // 发送跨域消息\n    postMessage(windowInstance: object, swMessage: SWMessage, targetOrigin: string) {\n        windowInstance && windowInstance.postMessage(swMessage, targetOrigin)\n    }\n}`, `38846117337024455000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Bus</span> <span class="token punctuation">{</span>\n    <span class="token keyword">private</span> syncFns<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>SyncFn<span class="token operator">></span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n\n    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">public</span> origin<span class="token punctuation">:</span> string<span class="token punctuation">,</span> syncFn<span class="token punctuation">:</span> SyncFn <span class="token operator">|</span> Array<span class="token operator">&lt;</span>SyncFn<span class="token operator">></span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n        <span class="token keyword">this</span><span class="token punctuation">.</span>syncFns <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>syncFn<span class="token punctuation">)</span> <span class="token operator">?</span> syncFn <span class="token punctuation">:</span> <span class="token punctuation">[</span>syncFn<span class="token punctuation">]</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">private</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>\n        window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">"message"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">receiveMsg</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token comment">// 获取跨域消息</span>\n    <span class="token keyword">private</span> <span class="token function">receiveMsg</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">const</span> <span class="token punctuation">{</span> origin <span class="token punctuation">}</span> <span class="token operator">=</span> e\n        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>origin <span class="token operator">!==</span> <span class="token string">\'*\'</span> <span class="token operator">&amp;&amp;</span> origin <span class="token operator">!==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>origin<span class="token punctuation">)</span> <span class="token keyword">return</span>\n        <span class="token keyword">const</span> <span class="token punctuation">{</span> name<span class="token punctuation">,</span> data <span class="token punctuation">}</span> <span class="token operator">=</span> e<span class="token punctuation">.</span>data\n        <span class="token keyword">this</span><span class="token punctuation">.</span>syncFns<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span>name <span class="token operator">===</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                item<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> e<span class="token punctuation">)</span>\n            <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token comment">// 发送跨域消息</span>\n    <span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token parameter">windowInstance<span class="token punctuation">:</span> object<span class="token punctuation">,</span> swMessage<span class="token punctuation">:</span> SWMessage<span class="token punctuation">,</span> targetOrigin<span class="token punctuation">:</span> string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        windowInstance <span class="token operator">&amp;&amp;</span> windowInstance<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span>swMessage<span class="token punctuation">,</span> targetOrigin<span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="传递数据"><a href="#%E4%BC%A0%E9%80%92%E6%95%B0%E6%8D%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>传递数据</h3>\n<p>注意加重部分，由于以上代码不知道什么时候新窗口加载完毕，提前发送消息会没效果，所以设置了延时</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="89498872028962590000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 主页面 index.html，访问域名为 http://localhost:10001\nvar caller = new Bus(\'http://127.0.0.1:10001\', [\n  {\n    name: \'message\',\n    fn: (data) => {\n      console.log(\'收到新窗口的消息\', data);\n    }\n  }\n]);\n\ndocument.querySelector(\'#button\').addEventListener(\'click\', function() {\n  var popup = window.open(\'http://127.0.0.1:10001/popup.html\', \'\', \'width=300,height=300,top=100,left=200\');\n  setTimeout(() => {\n    caller.postMessage(\n      popup,\n      {\n        name: \'nickname\',\n        data: {\n          name: \'towavephone\'\n        }\n      },\n      \'http://127.0.0.1:10001\'\n    );\n  }, 2000);\n});`, `89498872028962590000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{13-24}"\n              >\n                <span class="gatsby-code-button-language">js{13-24}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 主页面 index.html，访问域名为 http://localhost:10001</span>\n<span class="token keyword">var</span> caller <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Bus</span><span class="token punctuation">(</span><span class="token string">\'http://127.0.0.1:10001\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>\n  <span class="token punctuation">{</span>\n    name<span class="token punctuation">:</span> <span class="token string">\'message\'</span><span class="token punctuation">,</span>\n    <span class="token function-variable function">fn</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'收到新窗口的消息\'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\ndocument<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">\'#button\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">\'click\'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> popup <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">\'http://127.0.0.1:10001/popup.html\'</span><span class="token punctuation">,</span> <span class="token string">\'\'</span><span class="token punctuation">,</span> <span class="token string">\'width=300,height=300,top=100,left=200\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line">  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    caller<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span></span><span class="gatsby-highlight-code-line">      popup<span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">      <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">        name<span class="token punctuation">:</span> <span class="token string">\'nickname\'</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">        data<span class="token punctuation">:</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">          name<span class="token punctuation">:</span> <span class="token string">\'towavephone\'</span></span><span class="gatsby-highlight-code-line">        <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">      <span class="token punctuation">}</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">      <span class="token string">\'http://127.0.0.1:10001\'</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="25395068480151670000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 新窗口页面 popup.html，访问域名为 http://127.0.0.1:10001/popup.html\nvar caller = new Bus(\'http://localhost:10001\', [\n  {\n    name: \'nickname\',\n    fn: (data, e) => {\n      console.log(\'收到主页面的消息\', data);\n      caller.postMessage(\n        e.source,\n        {\n          name: \'message\',\n          data: {\n            name: \\`hello \\${data.name}\\`\n          }\n        },\n        \'http://localhost:10001\'\n      );\n    }\n  }\n]);`, `25395068480151670000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 新窗口页面 popup.html，访问域名为 http://127.0.0.1:10001/popup.html</span>\n<span class="token keyword">var</span> caller <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Bus</span><span class="token punctuation">(</span><span class="token string">\'http://localhost:10001\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>\n  <span class="token punctuation">{</span>\n    name<span class="token punctuation">:</span> <span class="token string">\'nickname\'</span><span class="token punctuation">,</span>\n    <span class="token function-variable function">fn</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> e</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'收到主页面的消息\'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      caller<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span>\n        e<span class="token punctuation">.</span>source<span class="token punctuation">,</span>\n        <span class="token punctuation">{</span>\n          name<span class="token punctuation">:</span> <span class="token string">\'message\'</span><span class="token punctuation">,</span>\n          data<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n            name<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">hello </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>data<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>\n          <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span><span class="token punctuation">,</span>\n        <span class="token string">\'http://localhost:10001\'</span>\n      <span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>执行效果：</p>\n<p><img src="/static/cross-origin-1-12fef4bc58b79e2c34b6982487f764b8.gif" alt="跨域传输"></p>\n<h3 id="监听新窗口是否加载完成"><a href="#%E7%9B%91%E5%90%AC%E6%96%B0%E7%AA%97%E5%8F%A3%E6%98%AF%E5%90%A6%E5%8A%A0%E8%BD%BD%E5%AE%8C%E6%88%90" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>监听新窗口是否加载完成</h3>\n<p>setTimeout 设置的延时不够准确，需要采用以下方案</p>\n<h4 id="监听-windowopen-的-onload-事件（跨域下失效）"><a href="#%E7%9B%91%E5%90%AC-windowopen-%E7%9A%84-onload-%E4%BA%8B%E4%BB%B6%EF%BC%88%E8%B7%A8%E5%9F%9F%E4%B8%8B%E5%A4%B1%E6%95%88%EF%BC%89" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>监听 window.open 的 onload 事件（跨域下失效）</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="16686817359709006000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 主页面 index.html，访问域名为 http://localhost:10001\nvar caller = new Bus(\'http://127.0.0.1:10001\', [\n  {\n    name: \'message\',\n    fn: (data) => {\n      console.log(\'收到新窗口的消息\', data);\n    }\n  }\n]);\n\ndocument.querySelector(\'#button\').addEventListener(\'click\', function() {\n  var popup = window.open(\'http://127.0.0.1:10001/popup.html\', \'\', \'width=300,height=300,top=100,left=200\');\n  popup.onload = function() {\n    caller.postMessage(\n      popup,\n      {\n        name: \'nickname\',\n        data: {\n          name: \'towavephone\'\n        }\n      },\n      \'http://127.0.0.1:10001\'\n    );\n  };\n});`, `16686817359709006000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{13-24}"\n              >\n                <span class="gatsby-code-button-language">js{13-24}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 主页面 index.html，访问域名为 http://localhost:10001</span>\n<span class="token keyword">var</span> caller <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Bus</span><span class="token punctuation">(</span><span class="token string">\'http://127.0.0.1:10001\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>\n  <span class="token punctuation">{</span>\n    name<span class="token punctuation">:</span> <span class="token string">\'message\'</span><span class="token punctuation">,</span>\n    <span class="token function-variable function">fn</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'收到新窗口的消息\'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\ndocument<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">\'#button\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">\'click\'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> popup <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">\'http://127.0.0.1:10001/popup.html\'</span><span class="token punctuation">,</span> <span class="token string">\'\'</span><span class="token punctuation">,</span> <span class="token string">\'width=300,height=300,top=100,left=200\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line">  popup<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    caller<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span></span><span class="gatsby-highlight-code-line">      popup<span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">      <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">        name<span class="token punctuation">:</span> <span class="token string">\'nickname\'</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">        data<span class="token punctuation">:</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">          name<span class="token punctuation">:</span> <span class="token string">\'towavephone\'</span></span><span class="gatsby-highlight-code-line">        <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">      <span class="token punctuation">}</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">      <span class="token string">\'http://127.0.0.1:10001\'</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span><span class="token punctuation">;</span></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>刚开始打算监听 window.open 的 onload 事件，但是在不同域名下会报错</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2020-07-01-21-58-38-f11fc49b7805e0841c4e04dd7be37162-63438.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 13.785790031813361%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAIAAAAcOLh5AAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAlklEQVQI1zXGyw6CMBBAUf7/43zgwhhoQUqhVWFmaC0dkFRcmJzc3MzachgbIg2gEFvCFkERKEeayNRaWSONrbpePJ53wB6wg1EjdLtsljmLU5R5kPlcX3yVU3kYxNHI86u5or6xrRZdLL3gnS7YSB7bOCjQRZZ8SDglcmnyO/YhTj6Q8+Sie2+8JF7Tr/9ZPmnddhuvX7vrptWmlNHPAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2020 07 01 21 58 38" title="" data-src="/static/2020-07-01-21-58-38-f11fc49b7805e0841c4e04dd7be37162-fee1c.png" data-srcset="/static/2020-07-01-21-58-38-f11fc49b7805e0841c4e04dd7be37162-a67b7.png 200w,\n/static/2020-07-01-21-58-38-f11fc49b7805e0841c4e04dd7be37162-0b187.png 400w,\n/static/2020-07-01-21-58-38-f11fc49b7805e0841c4e04dd7be37162-fee1c.png 800w,\n/static/2020-07-01-21-58-38-f11fc49b7805e0841c4e04dd7be37162-63438.png 943w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h4 id="跨域发送消息检测加载完成"><a href="#%E8%B7%A8%E5%9F%9F%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF%E6%A3%80%E6%B5%8B%E5%8A%A0%E8%BD%BD%E5%AE%8C%E6%88%90" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>跨域发送消息检测加载完成</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="98175049649654380000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 主页面 index.html，访问域名为 http://localhost:10001\nvar isLoaded = false;\nvar caller = new Bus(\'http://127.0.0.1:10001\', [\n  {\n    name: \'message\',\n    fn: (data) => {\n      console.log(\'收到新窗口的消息\', data);\n    }\n  },\n  {\n    name: \'newWindowLoad\',\n    fn: () => {\n      isLoaded = true;\n      console.log(\'新窗口加载完成\');\n    }\n  }\n]);\n\ndocument.querySelector(\'#button\').addEventListener(\'click\', function() {\n  var popup = window.open(\'http://127.0.0.1:10001/popup.html\', \'\', \'width=300,height=300,top=100,left=200\');\n  isLoaded = false;\n  var timer = setInterval(() => {\n    if (!isLoaded) {\n      return;\n    }\n    timer && clearInterval(timer);\n    caller.postMessage(\n      popup,\n      {\n        name: \'nickname\',\n        data: {\n          name: \'towavephone\'\n        }\n      },\n      \'http://127.0.0.1:10001\'\n    );\n  }, 0);\n});`, `98175049649654380000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{2,10-16,21-37}"\n              >\n                <span class="gatsby-code-button-language">js{2,10-16,21-37}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 主页面 index.html，访问域名为 http://localhost:10001</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">var</span> isLoaded <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></span><span class="token keyword">var</span> caller <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Bus</span><span class="token punctuation">(</span><span class="token string">\'http://127.0.0.1:10001\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>\n  <span class="token punctuation">{</span>\n    name<span class="token punctuation">:</span> <span class="token string">\'message\'</span><span class="token punctuation">,</span>\n    <span class="token function-variable function">fn</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'收到新窗口的消息\'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n<span class="gatsby-highlight-code-line">  <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    name<span class="token punctuation">:</span> <span class="token string">\'newWindowLoad\'</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token function-variable function">fn</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      isLoaded <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'新窗口加载完成\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span></span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\ndocument<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">\'#button\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">\'click\'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> popup <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">\'http://127.0.0.1:10001/popup.html\'</span><span class="token punctuation">,</span> <span class="token string">\'\'</span><span class="token punctuation">,</span> <span class="token string">\'width=300,height=300,top=100,left=200\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line">  isLoaded <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">var</span> timer <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isLoaded<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      <span class="token keyword">return</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">    timer <span class="token operator">&amp;&amp;</span> <span class="token function">clearInterval</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    caller<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span></span><span class="gatsby-highlight-code-line">      popup<span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">      <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">        name<span class="token punctuation">:</span> <span class="token string">\'nickname\'</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">        data<span class="token punctuation">:</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">          name<span class="token punctuation">:</span> <span class="token string">\'towavephone\'</span></span><span class="gatsby-highlight-code-line">        <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">      <span class="token punctuation">}</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">      <span class="token string">\'http://127.0.0.1:10001\'</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="3447791557295110000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 新窗口页面 popup.html，访问域名为 http://127.0.0.1:10001/popup.html\nvar caller = new Bus(\'http://localhost:10001\', [\n  {\n    name: \'nickname\',\n    fn: (data, e) => {\n      console.log(\'收到主页面的消息\', data);\n      caller.postMessage(\n        e.source,\n        {\n          name: \'message\',\n          data: {\n            name: \\`hello \\${data.name}\\`\n          }\n        },\n        \'http://localhost:10001\'\n      );\n    }\n  }\n]);\n\ncaller.postMessage(\n  window.opener,\n  {\n    name: \'newWindowLoad\'\n  },\n  \'http://localhost:10001\'\n);`, `3447791557295110000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{21-27}"\n              >\n                <span class="gatsby-code-button-language">js{21-27}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 新窗口页面 popup.html，访问域名为 http://127.0.0.1:10001/popup.html</span>\n<span class="token keyword">var</span> caller <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Bus</span><span class="token punctuation">(</span><span class="token string">\'http://localhost:10001\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>\n  <span class="token punctuation">{</span>\n    name<span class="token punctuation">:</span> <span class="token string">\'nickname\'</span><span class="token punctuation">,</span>\n    <span class="token function-variable function">fn</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> e</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'收到主页面的消息\'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      caller<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span>\n        e<span class="token punctuation">.</span>source<span class="token punctuation">,</span>\n        <span class="token punctuation">{</span>\n          name<span class="token punctuation">:</span> <span class="token string">\'message\'</span><span class="token punctuation">,</span>\n          data<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n            name<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">hello </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>data<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>\n          <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span><span class="token punctuation">,</span>\n        <span class="token string">\'http://localhost:10001\'</span>\n      <span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line">caller<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span></span><span class="gatsby-highlight-code-line">  window<span class="token punctuation">.</span>opener<span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    name<span class="token punctuation">:</span> <span class="token string">\'newWindowLoad\'</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">  <span class="token string">\'http://localhost:10001\'</span></span><span class="gatsby-highlight-code-line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>当新窗口的页面加载完毕时会发出 <code class="language-text">newWindowLoad</code> 消息，主页面接收后，标志变量 <code class="language-text">isLoaded</code> 置为 <code class="language-text">true</code>，此时尚在轮询的消息就可以发出。</p>\n<p><img src="/static/cross-origin-2-4340a95c494c85d0372f941fff11e3c5.gif" alt="跨域传输"></p>\n<h3 id="通过-url-传递数据"><a href="#%E9%80%9A%E8%BF%87-url-%E4%BC%A0%E9%80%92%E6%95%B0%E6%8D%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>通过 url 传递数据</h3>\n<p>之后由于新窗口需要刷新后也要保持当前技能组的打开，以上方案在刷新新窗口后数据会丢失，所以通过 url 来传递数据</p>\n<h2 id="独立客服组件运行环境"><a href="#%E7%8B%AC%E7%AB%8B%E5%AE%A2%E6%9C%8D%E7%BB%84%E4%BB%B6%E8%BF%90%E8%A1%8C%E7%8E%AF%E5%A2%83" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>独立客服组件运行环境</h2>\n<p>由于客服组件需要嵌入公司产品端，因为采用的技术栈和公司产品端的技术栈一致，这时会遇到很多问题：</p>\n<ol>\n<li>react 和 react-lite 的冲突，react 16 与 react 15 不能同时引入到一个页面，具体见 <a href="https://github.com/facebook/react/issues/16029" target="_blank" rel="nofollow noreferrer noopener">https://github.com/facebook/react/issues/16029</a> <html><head></head><body><a class="gatsby-resp-image-link" href="/static/2020-07-01-22-25-58-a3e4eb3adf3faf8ea62ecb0296ad950e-50858.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 6.893106893106893%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAABCAIAAABR8BlyAAAACXBIWXMAAAsSAAALEgHS3X78AAAAOElEQVQI1x2K2wkAIAwD3X9GH622I6jph2AUjsAdSWG+c0W3GMSflkZFU1ThskP600/o4A1qZ64LhWw20TUfTUwAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2020 07 01 22 25 58" title="" data-src="/static/2020-07-01-22-25-58-a3e4eb3adf3faf8ea62ecb0296ad950e-fee1c.png" data-srcset="/static/2020-07-01-22-25-58-a3e4eb3adf3faf8ea62ecb0296ad950e-a67b7.png 200w,\n/static/2020-07-01-22-25-58-a3e4eb3adf3faf8ea62ecb0296ad950e-0b187.png 400w,\n/static/2020-07-01-22-25-58-a3e4eb3adf3faf8ea62ecb0296ad950e-fee1c.png 800w,\n/static/2020-07-01-22-25-58-a3e4eb3adf3faf8ea62ecb0296ad950e-50858.png 1001w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></li>\n<li>babel-polyfill 引入 2 次导致不能正常加载 <html><head></head><body><a class="gatsby-resp-image-link" href="/static/2020-07-01-22-30-23-ebb5dabc1657307efd7b0eca866b3a61-8f59e.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 6.003937007874017%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAABCAIAAABR8BlyAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAASElEQVQI1wE9AML/AObk5OrMxOrJwenIwOrLw+rLw+vKwurGv/ji2v/x5v3s4v7w5v727P727PDo3+nh2eni2ebe1u/n3tbPxzB/NIUC3lvwAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2020 07 01 22 30 23" title="" data-src="/static/2020-07-01-22-30-23-ebb5dabc1657307efd7b0eca866b3a61-fee1c.png" data-srcset="/static/2020-07-01-22-30-23-ebb5dabc1657307efd7b0eca866b3a61-a67b7.png 200w,\n/static/2020-07-01-22-30-23-ebb5dabc1657307efd7b0eca866b3a61-0b187.png 400w,\n/static/2020-07-01-22-30-23-ebb5dabc1657307efd7b0eca866b3a61-fee1c.png 800w,\n/static/2020-07-01-22-30-23-ebb5dabc1657307efd7b0eca866b3a61-8f59e.png 1016w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></li>\n</ol>\n<h3 id="独立运行环境"><a href="#%E7%8B%AC%E7%AB%8B%E8%BF%90%E8%A1%8C%E7%8E%AF%E5%A2%83" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>独立运行环境</h3>\n<p>由于在开发服本地是正常的，编译为生产版本后冲突，首先想到了是不是生成文件 js 编号的冲突，于是做出以下修改</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="13602815083021880000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`optimization: {\n  // 以模块文件路径作为要加载模块的 key，不设置时默认以递增数字为 key\n  namedModules: true,\n  // 分包文件同理\n  namedChunks: true,\n}`, `13602815083021880000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">optimization<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 以模块文件路径作为要加载模块的 key，不设置时默认以递增数字为 key</span>\n  namedModules<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n  <span class="token comment">// 分包文件同理</span>\n  namedChunks<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后发现 react 和 react-lite 的共存时还是会报错，除非能保证客服组件的脚本能先于公司产品端去加载，这样的话就需要动到各个产品端的 index.html 文件，然而这样的话改动影响面会比较大，也不好在 index.html 中去读取到环境变量</p>\n<p>最后理了下思路，发现应该是产品端所有加载文件默认都在 webpackJsonp 变量下，需要将客服组件项目加载到不同的变量下才能做到环境上的隔绝</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="20808513991689370000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`output: {\n  filename: \'[name].js\',\n  chunkFilename: \'[name].[chunkhash].chunk.js\',\n  // 关键的一步，使同一网页上的多个 webpack 运行，互不影响\n  jsonpFunction: \'ponyWebpackJsonp\',\n},`, `20808513991689370000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{5}"\n              >\n                <span class="gatsby-code-button-language">js{5}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">output<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n  filename<span class="token punctuation">:</span> <span class="token string">\'[name].js\'</span><span class="token punctuation">,</span>\n  chunkFilename<span class="token punctuation">:</span> <span class="token string">\'[name].[chunkhash].chunk.js\'</span><span class="token punctuation">,</span>\n  <span class="token comment">// 关键的一步，使同一网页上的多个 webpack 运行，互不影响</span>\n<span class="gatsby-highlight-code-line">  jsonpFunction<span class="token punctuation">:</span> <span class="token string">\'ponyWebpackJsonp\'</span><span class="token punctuation">,</span></span><span class="token punctuation">}</span><span class="token punctuation">,</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>具体的原理可参考：<a href="/module-federation-principle-research/">Module federation 原理研究</a></p>\n<h3 id="babel-polyfill-引入-2-次"><a href="#babel-polyfill-%E5%BC%95%E5%85%A5-2-%E6%AC%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>babel-polyfill 引入 2 次</h3>\n<p>这里的话因为引入了 babel-polyfil，所以需要将客服组件项目中的 <code class="language-text">global._babelPolyfill = true;</code> 这一行屏蔽掉，防止公司产品端报错，暂时未想到更好的办法</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="97524389391658500000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// global._babelPolyfill = true;`, `97524389391658500000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// global._babelPolyfill = true;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h2 id="设置新窗口位置"><a href="#%E8%AE%BE%E7%BD%AE%E6%96%B0%E7%AA%97%E5%8F%A3%E4%BD%8D%E7%BD%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>设置新窗口位置</h2>\n<p>需要注意下分屏的情况，新窗口在副屏的定位是错的，需要做特殊处理，主屏上没问题</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="70297195582835160000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 兼容左右分屏情况\nconst { availTop, availLeft } = window.screen;\nif (availLeft) {\n  left += availLeft;\n}\nif (availTop) {\n  top += availTop;\n}`, `70297195582835160000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 兼容左右分屏情况</span>\n<span class="token keyword">const</span> <span class="token punctuation">{</span> availTop<span class="token punctuation">,</span> availLeft <span class="token punctuation">}</span> <span class="token operator">=</span> window<span class="token punctuation">.</span>screen<span class="token punctuation">;</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span>availLeft<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  left <span class="token operator">+=</span> availLeft<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span>availTop<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  top <span class="token operator">+=</span> availTop<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><a href="https://segmentfault.com/a/1190000017989734" target="_blank" rel="nofollow noreferrer noopener">chrome 弹窗在双屏情况下 left 居中定位异常分析</a></p>\n<h2 id="监听新窗口打开情况"><a href="#%E7%9B%91%E5%90%AC%E6%96%B0%E7%AA%97%E5%8F%A3%E6%89%93%E5%BC%80%E6%83%85%E5%86%B5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>监听新窗口打开情况</h2>\n<p>通过监听 window.open 的 closed 属性，因为有多个新窗口打开，需要遍历 window.open 数组</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="86232025771913270000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`this.popups = [];\nconst popup = window.open(url, \'\');\nthis.popups.push(popup);\n\n// 得到打开的新窗口\nthis.popups.filter((item) => !item.closed);`, `86232025771913270000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">this</span><span class="token punctuation">.</span>popups <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> popup <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token string">\'\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">this</span><span class="token punctuation">.</span>popups<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>popup<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 得到打开的新窗口</span>\n<span class="token keyword">this</span><span class="token punctuation">.</span>popups<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token operator">!</span>item<span class="token punctuation">.</span>closed<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="解决聊天框代码注入"><a href="#%E8%A7%A3%E5%86%B3%E8%81%8A%E5%A4%A9%E6%A1%86%E4%BB%A3%E7%A0%81%E6%B3%A8%E5%85%A5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>解决聊天框代码注入</h2>\n<p>由于聊天表情是由有限的几个字符组成的，格式为 <code class="language-text">[高兴]</code>, 所以只要匹配这几个字符，然后以 dangerouslySetInnerHTML 渲染，其他字符以普通文本字符渲染就可以</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="88654717254656950000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// EmojiList：表情字符列表，symbolToHTML：特定字符转为 html 方法\nrenderText = (text) => {\n  const renderContent = [];\n  text.replace(/\\[([^[\\]]+?)\\]|./g, (symbol) => {\n    if (/\\[([^[\\]]+?)\\]/.test(symbol) && EmojiList.find((item) => item.symbol === symbol)) {\n      renderContent.push(<span dangerouslySetInnerHTML={{ __html: symbolToHTML(symbol) }} />);\n    } else {\n      renderContent.push(symbol);\n    }\n  });\n  return <div>{renderContent}</div>;\n};`, `88654717254656950000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// EmojiList：表情字符列表，symbolToHTML：特定字符转为 html 方法</span>\n<span class="token function-variable function">renderText</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> renderContent <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  text<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\\[([^[\\]]+?)\\]|./g</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">symbol</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex">/\\[([^[\\]]+?)\\]/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>symbol<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> EmojiList<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> item<span class="token punctuation">.</span>symbol <span class="token operator">===</span> symbol<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      renderContent<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>span dangerouslySetInnerHTML<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> __html<span class="token punctuation">:</span> <span class="token function">symbolToHTML</span><span class="token punctuation">(</span>symbol<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n      renderContent<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>symbol<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> <span class="token operator">&lt;</span>div<span class="token operator">></span><span class="token punctuation">{</span>renderContent<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="效果截图"><a href="#%E6%95%88%E6%9E%9C%E6%88%AA%E5%9B%BE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>效果截图</h1>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2020-07-01-23-11-11-b4db819bc8afb7c48299e354bdb8de77-83c29.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 722px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 89.75069252077562%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAIAAADUsmlHAAAACXBIWXMAAAsSAAALEgHS3X78AAACDElEQVQ4y5VTTWvUQBjO3/NQ/QVitx4EoQexemhRPPiBvXj25LF+rKIogvQgStW1Cv3YunRpNxHdNmnYZpPJzOx8j+8k7Lo1QfHJwzAJ88z7PO9MvIywTzv+2sa3j5udz+1ua7vbajuu7+y9Xd9a+7LJGLPWGgODFVLGcZxlWfHFeO1ef/7u/cU7y1duLc9fv9lYWJpdWJq7eu3C4g2YX759D6G8XAqjFCI+ihFCY3E/u/Qiuvg8Of8kPrdyOPf4aPZh2HgUwWujefxqI9ScKG2U0kCpFBRXuphL7X39Qc++VGee2ZmmPf3UzowJ81NN++BdwEnGleFSVelRSrVkVgO5NRxyuVEzYzR4+x74GBNbB2c7J0RIBYnAmwYaRzc3FlL2/ACT32KwjDFWSrnmCeERQjnnZT/MSdiKGKKC01IMANsjlKaE0lqxH5wQT0Nr7WFCGXeA/f5ZeRqFbUoxQoPBoFa83/PzHNeKYb0TszHASaUydLte7DKDqzTNyqVV/CWzE0O34RGciyK5noKz7fvJMBNSMy7/IBfKNWxwnLg7Z6zU7oQnnM5sKhBKuspiRKwR0PyqsTCKaHGKk1tVHLK7QAlPXeZWgF530OpuvtrFE77ZxR98chBG5S85Ph6ZJGBTGqu3kvceZDtMSC/KD4ajfkIn/JnQcAhVaW0v4fruZx2vNAOb2f8EZfYX0Ub034bAPIMAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2020 07 01 23 11 11" title="" data-src="/static/2020-07-01-23-11-11-b4db819bc8afb7c48299e354bdb8de77-83c29.png" data-srcset="/static/2020-07-01-23-11-11-b4db819bc8afb7c48299e354bdb8de77-5b578.png 200w,\n/static/2020-07-01-23-11-11-b4db819bc8afb7c48299e354bdb8de77-4dff0.png 400w,\n/static/2020-07-01-23-11-11-b4db819bc8afb7c48299e354bdb8de77-83c29.png 722w" data-sizes="(max-width: 722px) 100vw, 722px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2020-07-01-23-14-38-bddade5a03e1b0993bfb530b93119978-a2194.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 750px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 84.39999999999999%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAIAAABSJhvpAAAACXBIWXMAAAsSAAALEgHS3X78AAACMUlEQVQ4y31STWsUQRBtvfh3/A3eJQcPnlQEUUGQiEtEUBMXExD06kfOoh70pEtQTwY8KyQXzW52N9mdzM5Md093T3/OlzWbzbC7iT5qimGmX9WrfoUuN9cvNR5caTy8uvTo4u2l89cXF27euXCrsXBj8e7ac855eYSiKOoMyPMcvfw+fLXpPf3mrbT6zdbe8qfe8ud+c2N/ZcNb3xyI/5PPvbHXvpRnnpWnVkv0pESrVZxeK9Dj8uwLwRmVUhJCrLXlLNIsRx+3ktaf9P2WezcT9u12/uFn5HkeKGcszrKs7g/veYUMWcnL3BZOidDno4EIhhIHRaqgdEyjdqczHA4ojWvB1jlGyRCz1x2DQsqFsjzRIZW/PbnryyiWLNGJdn5Idto77XYnjHBRTz7O1JX3f2WIxFxpK5VJlA2YjTi8Wym1Ni6ISISx1hoGBpVHsqtMTHnvxxQZAhgQVSGpjU0PRuHe/kBrNfJ9pfR0Z5OVX7uz5DomZD/o9vpJklBKrTXThk2swrVsOR0V2fPD3W4vCEZCiPIYKqso4yAJhjTG1TEeM8UkZpynYxwng1+IcZEkQspk5keaQjDGCaFznBnZUqmqcpbVa1CfgKrs3+sJ5xEMN7c60PPQGGDGjIlE4Ag75+YkRIagCJOIwArFkMBVTCpvq4+YHPgjMgasdzHGdGeXOWSti4WE+4Ha8NgKkwzTwNHDfPKF5UVh0xyOQzsg1JdhjIEMJhd5ceLMXGV/AVIJsfFk9b2VAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2020 07 01 23 14 38" title="" data-src="/static/2020-07-01-23-14-38-bddade5a03e1b0993bfb530b93119978-a2194.png" data-srcset="/static/2020-07-01-23-14-38-bddade5a03e1b0993bfb530b93119978-2e341.png 200w,\n/static/2020-07-01-23-14-38-bddade5a03e1b0993bfb530b93119978-e3a06.png 400w,\n/static/2020-07-01-23-14-38-bddade5a03e1b0993bfb530b93119978-a2194.png 750w" data-sizes="(max-width: 750px) 100vw, 750px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h1 id="总结"><a href="#%E6%80%BB%E7%BB%93" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h1>\n<ol>\n<li>传递到新窗口的 url 过长需要编码</li>\n<li>独立运行环境部分的 react 冲突可能是作用域提升导致的冲突，待具体研究</li>\n<li>babel-polyfill 引入 2 次，如何复用 ployfill 的代码待研究</li>\n</ol>',
id:"/home/runner/work/GatsbyBlog/GatsbyBlog/blog/客服新窗口技术探索/index.md absPath of file >>> MarkdownRemark",timeToRead:7,frontmatter:{date:"2020-07-01 20:15:50",path:"/new-window-technology-research/",tags:"前端, 跨域通信, webpack, 预研, 前端构建工具",title:"客服新窗口技术探索",draft:null}},{excerpt:"从 2017 年发出关于 v5 的投票开始，到 2019 年 10 月发布第一个 beta 版本，目前是 5.0.0-beta.16。现在在收集使用反馈、生态升级的过程中，相信不久后就可以正式发布了。这次升级重点：性能改进、Tree Shacking、Code Generation、Module Federation。 下面我们跟着 Changelog 来动手，测测重点内容~ 优化持久缓存 首先简单说 Webpack 中 graph 的概念： Webpack 在执行的时候，以配置的 entry…",html:'<p>从 2017 年发出关于 v5 的投票开始，到 2019 年 10 月发布第一个 beta 版本，目前是 5.0.0-beta.16。现在在收集使用反馈、生态升级的过程中，相信不久后就可以正式发布了。这次升级重点：性能改进、Tree Shacking、Code Generation、Module Federation。</p>\n<p>下面我们跟着 Changelog 来动手，测测重点内容~</p>\n<h1 id="优化持久缓存"><a href="#%E4%BC%98%E5%8C%96%E6%8C%81%E4%B9%85%E7%BC%93%E5%AD%98" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>优化持久缓存</h1>\n<p>首先简单说 Webpack 中 graph 的概念：</p>\n<p>Webpack 在执行的时候，以配置的 entry 为入口，递归解析文件依赖，构建一个 graph，记录代码中各个 module 之间的关系。每当有文件更新的时候，递归过程会重来，graph 发生改变。</p>\n<p>如果简单粗暴地重建 graph 再编译，会有很大的性能开销，Webpack 利用缓存实现增量编译，从而提升构建性能。</p>\n<p>缓存（内存 / 磁盘两种形式）中的主要内容是 module objects，在编译的时候会将 graph 以二进制或者 json 文件存储在硬盘上。每当代码变化、模块之间依赖关系改变导致 graph 改变时，Webpack 会读取记录做增量编译。</p>\n<h2 id="之前持久缓存的方式"><a href="#%E4%B9%8B%E5%89%8D%E6%8C%81%E4%B9%85%E7%BC%93%E5%AD%98%E7%9A%84%E6%96%B9%E5%BC%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>之前持久缓存的方式</h2>\n<p>之前可以使用 loader 设置缓存：</p>\n<ol>\n<li>使用 cache-loader 可以将编译结果写入硬盘缓存，Webpack 再次构建时如果文件没有发生变化则会直接拉取缓存</li>\n<li>还有一部分 loader 自带缓存配置，比如 babel-loader，可以配置参数 cacheDirectory 使用缓存，将每次的编译结果写进磁盘（默认在 node_modules/.cache/babel-loader 目录），UglifyJsPlugin 插件中的 cache 选项</li>\n<li>terser-webpack-plugin 开启缓存</li>\n<li>hard-source-webpack-plugin 插件</li>\n<li>webpack.DllPlugin 插件</li>\n</ol>\n<h2 id="现在的方案"><a href="#%E7%8E%B0%E5%9C%A8%E7%9A%84%E6%96%B9%E6%A1%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>现在的方案</h2>\n<p>v5 中缓存默认是 memory，你可以修改设置写入硬盘：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="94777163456860030000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`module.exports = {\n  cache: {\n    type: \'filesystem\',\n    // cacheDirectory 默认路径是 node_modules/.cache/webpack\n    cacheDirectory: path.resolve(__dirname, \'.temp_cache\')\n  }\n};`, `94777163456860030000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>\n  cache<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    type<span class="token punctuation">:</span> <span class="token string">\'filesystem\'</span><span class="token punctuation">,</span>\n    <span class="token comment">// cacheDirectory 默认路径是 node_modules/.cache/webpack</span>\n    cacheDirectory<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">\'.temp_cache\'</span><span class="token punctuation">)</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>注：对大部分 <code class="language-text">node_modules</code> 哈希处理以构建依赖项，代价昂贵，还降低 Webpack 执行速度。为避免这种情况出现，Webpack 加入了一些优化，默认会跳过 <code class="language-text">node_modules</code>，并使用 package.json 中的 version 和 name 作为数据源，有点类似于 webpack.DllPlugin</p>\n<h1 id="优化长期缓存"><a href="#%E4%BC%98%E5%8C%96%E9%95%BF%E6%9C%9F%E7%BC%93%E5%AD%98" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>优化长期缓存</h1>\n<p>Webpack 5 针对 moduleId 和 chunkId 的计算方式进行了优化，增加确定性的 moduleId 和 chunkId 的生成策略。moduleId 根据上下文模块路径，chunkId 根据 chunk 内容计算，最后为 moduleId 和 chunkId 生成 3 - 4 位的数字 id，实现长期缓存，生产环境下默认开启。</p>\n<h2 id="对比原来的-moduleid"><a href="#%E5%AF%B9%E6%AF%94%E5%8E%9F%E6%9D%A5%E7%9A%84-moduleid" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>对比原来的 moduleId</h2>\n<p>原来的 moduleId 默认值是自增 id，容易导致文件缓存失效。在 v4 之前，可以安装 HashedModuleIdsPlugin 插件覆盖默认的 moduleId 规则， 它会使用模块路径生成的 hash 作为 moduleId。在 v4 中，可以配置 optimization.moduleIds = ‘hashed’</p>\n<h2 id="对比原来的-chunkid"><a href="#%E5%AF%B9%E6%AF%94%E5%8E%9F%E6%9D%A5%E7%9A%84-chunkid" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>对比原来的 chunkId</h2>\n<p>原来的 chunkId 默认值自增 id。比如这样的配置下，如果有新的 entry 增加，chunk 数量也会跟着增加，chunkId 也会递增。之前可以安装 NamedChunksPlugin 插件来稳定 chunkId；或者配置 optimization.chunkIds = ‘named’</p>\n<h1 id="nodejs-的-polyfill-脚本被移除"><a href="#nodejs-%E7%9A%84-polyfill-%E8%84%9A%E6%9C%AC%E8%A2%AB%E7%A7%BB%E9%99%A4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>NodeJS 的 polyfill 脚本被移除</h1>\n<p>最开始，Webpack 目标是允许在浏览器中运行 Node 模块。但是现在在 Webpack 看来，大多模块就是专门为前端开发的。在 v4 及以前的版本中，对于大多数的 Node 模块会自动添加 polyfill 脚本，polyfill 会加到最终的 bundle 中，其实通常情况下是没有必要的。在 v5 中将停止这一行为。</p>\n<p>比如以下一段代码：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="98505474034487750000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// index.js\nimport sha256 from \'crypto-js/sha256\';\n\nconst hashDigest = sha256(\'hello world\');\nconsole.log(hashDigest);`, `98505474034487750000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// index.js</span>\n<span class="token keyword">import</span> sha256 <span class="token keyword">from</span> <span class="token string">\'crypto-js/sha256\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> hashDigest <span class="token operator">=</span> <span class="token function">sha256</span><span class="token punctuation">(</span><span class="token string">\'hello world\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>hashDigest<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在 v4 中，会主动添加 crypto 的 polyfill，也就是 crypto-browserify。我们运行的代码是不需要的，反而最后的包变大，编译结果 <code class="language-text">417 kb</code>：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2020-06-23-12-15-19-eac7a3ddffc761bbe2ca52d1ab39962f-6e10a.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 40.8%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAAsSAAALEgHS3X78AAABAUlEQVQY04VQ2W6DMBDkUm2CwazBxpeCUCAUaP//9zoNaqSoD5kne3dmd2aTghXDvPTj2F3HLsS6roUQbduWZZm8RVVVvVKKqCMyWvda4wdx13Vaa+fcMAz6AbyNMSEEay2+ICSMswaQEppT0PeYoMHrH4AGLVDOovcetLOVoCGlXP6wbdu6rkQEU2mavrEdfuEhGxFbqWma4LMoilP8xJP/UoRH74NzHqaIFA4WY0QqO9g8z09BlmWMMZyQc/6yWZHY94WoMab9XCcc7tgPpGpULdrLRTApORFy3WENc1/E8y0sc/TebNt8HHG5Kc4/xi9//bbkmkowO9Si4tj8P/IPVYcbetNP2eYAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2020 06 23 12 15 19" title="" data-src="/static/2020-06-23-12-15-19-eac7a3ddffc761bbe2ca52d1ab39962f-fee1c.png" data-srcset="/static/2020-06-23-12-15-19-eac7a3ddffc761bbe2ca52d1ab39962f-a67b7.png 200w,\n/static/2020-06-23-12-15-19-eac7a3ddffc761bbe2ca52d1ab39962f-0b187.png 400w,\n/static/2020-06-23-12-15-19-eac7a3ddffc761bbe2ca52d1ab39962f-fee1c.png 800w,\n/static/2020-06-23-12-15-19-eac7a3ddffc761bbe2ca52d1ab39962f-6e10a.png 1000w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>在 v5 中，如果遇到了这样的情况，会提示你进行确认。如果确认不需要 node polyfill，按照提示 alias 设置为 false 即可。最后的编译结果仅有 <code class="language-text">5.69 kb</code>：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2020-06-23-12-15-57-27ebe6ab69dc3e353da69fed7258a207-34bc5.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 61.01851851851852%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAAsSAAALEgHS3X78AAABoklEQVQoz41S2Y6cMBAEhvswNjY2PmC4z51ho92H/P+XpVklSp4mW2q1mpabqmrb0lpLKZXSeZ4bY+DT8zzrm5BaKi0JJvCLJEl4xWHYvbm3282yrStewPRK1gK4hRRVT7FKwyiMosj3/f8z923/+fF5Ps9pmuZl3s617kwUxjnOqM690H01TAjpum4Yhvv9DsqLokAIATcq0pwntvNS9zwrStMM5aY2VSVKXgJYWWJCcobSPPH9IAhDiH9xdYLA+nh/vO3rsW3LOHJGOaVScM5YxXlBEEYZp0xyfmUhoAkhSiaAgDHr575vw/C+rWvXTk2jCjIY3Qg+aL2096mpe616raE51mZt27lp4BhPYgdkQ5eWpYL7NQZyJWWlJGNl23VQE9gBY5DpV768YBynKYkj13EsnmUZQuM4zjPsezqOY993eC2glAsRJ0n5BUrpZfLPxaee69q2VdMCPJ6Px9u2zeP4OI4f53NbFiUEKwoYAntawiZZCSowBkLHtnPfv4YlxoMxz2UGh1vfbX0PhWbUMIYCHxh+h+v+rT038VyQ8AtdDi8pCXs36QAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2020 06 23 12 15 57" title="" data-src="/static/2020-06-23-12-15-57-27ebe6ab69dc3e353da69fed7258a207-fee1c.png" data-srcset="/static/2020-06-23-12-15-57-27ebe6ab69dc3e353da69fed7258a207-a67b7.png 200w,\n/static/2020-06-23-12-15-57-27ebe6ab69dc3e353da69fed7258a207-0b187.png 400w,\n/static/2020-06-23-12-15-57-27ebe6ab69dc3e353da69fed7258a207-fee1c.png 800w,\n/static/2020-06-23-12-15-57-27ebe6ab69dc3e353da69fed7258a207-34bc5.png 1080w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>配置 <code class="language-text">resolve.alias: { crypto: false }：</code></p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2020-06-23-12-16-18-06df485174228cb856240a31ee662eb8-34bc5.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 51.2962962962963%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAAsSAAALEgHS3X78AAABL0lEQVQoz42R227CMAxAgV5IaW5tkl7ShARxKUMaTBqMTQiJ//+quYU9TAON8xC5ahwf2wOcpiLPGKVKiKIopJRCCDiVUnVdl2UJMZxVVXWfVRfAheFwOAAQQmma5nku+mQgy7K0B2PMOR+Px0mSQMwYS38IgqBL1k1jjNm+drRtezqdNpvNZDIZPAMUhKogA2/HcUwJlUISQv/evKn+Si7Ear1kjDrnoCtCcWM1JhjEwjC86T2i9oVvbS4y72aqlvpFiSlLMKKUQm//+IOkd36xXEDnFYyzKcupKl0RoQj+jkajMAoiFN5xBmBI5/P5crkcDoeP43G3e9vv3z+/9vO5N6aZrZzfauXyB9q6tlO77rHWwB6l5NZkuuZKc2E4wvH9sldgKoSQ61afXVLPNzXXHtOXErE8AAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2020 06 23 12 16 18" title="" data-src="/static/2020-06-23-12-16-18-06df485174228cb856240a31ee662eb8-fee1c.png" data-srcset="/static/2020-06-23-12-16-18-06df485174228cb856240a31ee662eb8-a67b7.png 200w,\n/static/2020-06-23-12-16-18-06df485174228cb856240a31ee662eb8-0b187.png 400w,\n/static/2020-06-23-12-16-18-06df485174228cb856240a31ee662eb8-fee1c.png 800w,\n/static/2020-06-23-12-16-18-06df485174228cb856240a31ee662eb8-34bc5.png 1080w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>浏览器执行结果：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2020-06-23-12-16-40-2df5a065620c20479ba9379045f83488-34bc5.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 37.77777777777778%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAAsSAAALEgHS3X78AAAAyklEQVQY06VR0W7DIAzk/z9ymioCTcHGNpC0gzV1wkOrPU3tyTqdTraRD9Naq3UBwEuI1k7T5JSOctY65/wwE9F6vS7r+lpm+wD78P0f0K6j//53+P2XmQURiTgCppRESJmZAYCFE+mxpDrt2Bv0WMVg471HgBDQuqAhzRfMZal11RQHa2eMqOHpBtJ9nEUyUVYY/zXPLn6fwnmWCNmdFymNWL+gszTJTUrPpauj/hCldsCf3n9Nu/V2a7r+SGUb+b2GuOvt6Qwx+AHzWs+AWuhsrwAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2020 06 23 12 16 40" title="" data-src="/static/2020-06-23-12-16-40-2df5a065620c20479ba9379045f83488-fee1c.png" data-srcset="/static/2020-06-23-12-16-40-2df5a065620c20479ba9379045f83488-a67b7.png 200w,\n/static/2020-06-23-12-16-40-2df5a065620c20479ba9379045f83488-0b187.png 400w,\n/static/2020-06-23-12-16-40-2df5a065620c20479ba9379045f83488-fee1c.png 800w,\n/static/2020-06-23-12-16-40-2df5a065620c20479ba9379045f83488-34bc5.png 1080w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h1 id="更好的-treeshaking"><a href="#%E6%9B%B4%E5%A5%BD%E7%9A%84-treeshaking" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>更好的 TreeShaking</h1>\n<p>现在有这样一段代码：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="49575727574103515000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// inner.js\nexport const a = \'aaaaaaaaaa\';\nexport const b = \'bbbbbbbbbb\';\n\n// module.js\nimport * as inner from \'./inner\';\nexport { inner };\n\n// index.js\nimport * as module from \'./module\';\nconsole.log(module.inner.a);`, `49575727574103515000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// inner.js</span>\n<span class="token keyword">export</span> <span class="token keyword">const</span> a <span class="token operator">=</span> <span class="token string">\'aaaaaaaaaa\'</span><span class="token punctuation">;</span>\n<span class="token keyword">export</span> <span class="token keyword">const</span> b <span class="token operator">=</span> <span class="token string">\'bbbbbbbbbb\'</span><span class="token punctuation">;</span>\n\n<span class="token comment">// module.js</span>\n<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> inner <span class="token keyword">from</span> <span class="token string">\'./inner\'</span><span class="token punctuation">;</span>\n<span class="token keyword">export</span> <span class="token punctuation">{</span> inner <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token comment">// index.js</span>\n<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> module <span class="token keyword">from</span> <span class="token string">\'./module\'</span><span class="token punctuation">;</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>inner<span class="token punctuation">.</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在 v4 中毫无疑问，以上代码 a、b 变量是被全部打包的：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2020-06-23-12-17-10-2dd149e437e005398dd1cd8f388aa35b-34bc5.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 35.37037037037037%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAAsSAAALEgHS3X78AAAAb0lEQVQY05WQiw0CMQzFskivyUvTpL2vDpDYfzJgA+IFLJu6h/nU1sys1rpkIECv+7nNIcxLEhKRue3uDjW1LsL1b4iZ1zGPdUcPteCM/2cOH95dARGkqgmqcVyvx/m+zwYpqeaIQPvOVgFKyQ37ACquNJxWfm49AAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2020 06 23 12 17 10" title="" data-src="/static/2020-06-23-12-17-10-2dd149e437e005398dd1cd8f388aa35b-fee1c.png" data-srcset="/static/2020-06-23-12-17-10-2dd149e437e005398dd1cd8f388aa35b-a67b7.png 200w,\n/static/2020-06-23-12-17-10-2dd149e437e005398dd1cd8f388aa35b-0b187.png 400w,\n/static/2020-06-23-12-17-10-2dd149e437e005398dd1cd8f388aa35b-fee1c.png 800w,\n/static/2020-06-23-12-17-10-2dd149e437e005398dd1cd8f388aa35b-34bc5.png 1080w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>但我们只调用了 a 变量，理想情况应该是 b 被识别为 unused，不被打包。这一优化在 v5 中实现了。在 v5 中会分析模块 export 与 import 之间的依赖关系，最终的代码生成非常简洁：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2020-06-23-12-17-33-192a9d2e16cd02b56a94a385ef7c9416-34bc5.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 8.148148148148147%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAIAAADXZGvcAAAACXBIWXMAAAsSAAALEgHS3X78AAAAUUlEQVQI12XMQQ6AMAhEUS9SkQ7QYmOq1fufTWLiwvjW82fqxzn23je/xpBaYNqae9Fq0lYHQETLDz0mhkpMmJE5SphE6qZV46pwziml+YteNzQsEKn6qmO9AAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2020 06 23 12 17 33" title="" data-src="/static/2020-06-23-12-17-33-192a9d2e16cd02b56a94a385ef7c9416-fee1c.png" data-srcset="/static/2020-06-23-12-17-33-192a9d2e16cd02b56a94a385ef7c9416-a67b7.png 200w,\n/static/2020-06-23-12-17-33-192a9d2e16cd02b56a94a385ef7c9416-0b187.png 400w,\n/static/2020-06-23-12-17-33-192a9d2e16cd02b56a94a385ef7c9416-fee1c.png 800w,\n/static/2020-06-23-12-17-33-192a9d2e16cd02b56a94a385ef7c9416-34bc5.png 1080w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h1 id="module-federation"><a href="#module-federation" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Module Federation</h1>\n<p>让 Webpack 达到了线上 runtime 的效果，让代码直接在独立应用间利用 CDN 直接共享，不再需要本地安装 NPM 包、构建再发布了！</p>\n<h2 id="之前共享代码的处理方式"><a href="#%E4%B9%8B%E5%89%8D%E5%85%B1%E4%BA%AB%E4%BB%A3%E7%A0%81%E7%9A%84%E5%A4%84%E7%90%86%E6%96%B9%E5%BC%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>之前共享代码的处理方式</h2>\n<h3 id="npm"><a href="#npm" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>NPM</h3>\n<p>维护一个 CommonComponents 的 NPM 包，在不同项目中安装、使用。如果 NPM 包升级，对应项目都需要安装新版本，本地编译，打包到 bundle 中。</p>\n<h3 id="umd"><a href="#umd" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>UMD</h3>\n<p>UMD 优点在 runtime。缺点也明显，体积优化不方便，容易有版本冲突。</p>\n<h3 id="微前端"><a href="#%E5%BE%AE%E5%89%8D%E7%AB%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>微前端</h3>\n<p>独立应用间的共享也是问题。一般有两种打包方式：</p>\n<ol>\n<li>子应用独立打包，模块解耦了，但公共的依赖不易维护处理</li>\n<li>整体应用一起打包，能解决公共依赖；但庞大的多个项目又使打包变慢，后续也不好扩展</li>\n</ol>\n<h2 id="全新的解决方案"><a href="#%E5%85%A8%E6%96%B0%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>全新的解决方案</h2>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2020-06-23-12-20-30-4de6b8c9323d321ddf1ed32f0cb4a7a7-34bc5.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 38.51851851851852%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAAsSAAALEgHS3X78AAABBUlEQVQY012R226CQBCGef8HqVf2oib1QqO+RNF6UyMmLYKkHPbAskg/dqhpunwhk3/+YXaGqHU+y2/pNasb7bq+dZ2xztgWtGlt64Lob8V3es2zvCCL4joPke+JOsfjfX+/C3IIhmEQJXhG8AMJiIy1NKFBCCzu9+Nx/jzf7nYvi8VbHKOga2Pw8MYLYwMp5m7aWKV13SisyeXyNJu9LpdQFAU+UhhAvoJ/KibiSwifX2mW5x+nU7yPV+sVbLab/eFwThKKy6oMncclwFQsozOwUqqqq7KqaMBUKECfRim5qijA5NPMD59sQpb094jh19YH/FT8WCOM/8X7ISQEjuj/bHLtHx04yxpNAH0sAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2020 06 23 12 20 30" title="" data-src="/static/2020-06-23-12-20-30-4de6b8c9323d321ddf1ed32f0cb4a7a7-fee1c.png" data-srcset="/static/2020-06-23-12-20-30-4de6b8c9323d321ddf1ed32f0cb4a7a7-a67b7.png 200w,\n/static/2020-06-23-12-20-30-4de6b8c9323d321ddf1ed32f0cb4a7a7-0b187.png 400w,\n/static/2020-06-23-12-20-30-4de6b8c9323d321ddf1ed32f0cb4a7a7-fee1c.png 800w,\n/static/2020-06-23-12-20-30-4de6b8c9323d321ddf1ed32f0cb4a7a7-34bc5.png 1080w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>从图中可以看到，这个方案是直接将一个应用的 bundle，应用于另一个应用。</p>\n<p>应用可以模块化输出，就是说它本身可以自我消费，也可以动态分发 runtime 子模块给其他应用。</p>\n<p>理论比较抽象，我们动手试一下。</p>\n<h2 id="实践测试"><a href="#%E5%AE%9E%E8%B7%B5%E6%B5%8B%E8%AF%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>实践测试</h2>\n<p>现在有两个应用 app1 (localhost:3001)、app2 (localhost:3002)：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2020-06-23-12-20-56-903d60334fe837e1ca96c5dc05a5ae7f-0e897.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 578px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 152.59515570934258%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAfCAIAAABoLHqZAAAACXBIWXMAAAsSAAALEgHS3X78AAAClUlEQVQ4y5WUzW6bQBSF/RitnTQGm98ZbAMDM2AGDLbB4CbOwlJW7a7rSm0WXfUBuuoiD9wTO5XbSgEqXSE00sc5c+89DK73j9PDt/TTj/uvT83nn4fHJ+fh+9vqC86vmo4aqGGtx7ducUzvPia3H/juwUrulKBWwwbP9hroqkJNg5hGs6tkLK6Gb8bXI+XdFZ5T5UZXxy010A3TNG3TsoOAV9VumchsVWy3u6qqZ/PFZKppuvFaDXTdsCwb5Xn+apUHQci5WC6TOF4SQqeANf21eoZtmxiGxXkchnw0ur65GSuKOh4r7eQLDNuUmpzPkiRL04yxABjO28kL7FCLMZpleVGs4bwTu8CGYVPHEoJCebsts2yFFnR6vtyZWrrveZCNovgkHvSFiU3mtuF7PmQBQzkMw8lk2nntgaYZlFLGtCiKoIlR4xN4wdjQ8Mlp0K3KhLqx5CLK8wLdBsk5x6gx8Nls3nlnupAlC3hZVpBN0zRJZFEUh8M9Xlou/wJTFgM+K4M3TQt7oqqTLtuaDtvUDU6tyhYL13U9jMowzO6GvYyK0KbZbzYbRVHQJ2hCued6WpDCVqLVUqZo2G5Xo9Ct7m6fgmEiVSDx9H12zhbOe6UK4kLEYIbDEVL1X7ZtxzEFd6TM8jzHegGDl76pQiR/p6rA5fvk8U9lK4rmaZqXZQlx7EZ7q/6CCbHC8Nk2UtHnB/TPzwC2nSRJIQsecF/biKSja4yFzf59FC2x4RDHqnTDiCQhxHNN5jMsNkpKKUR0/pP1yrPPbOz2er3ebLbYLYQZkQTcuSQ6UuVv7kMR13WNSIFEt6uqOh6PMNIZSUJ94Xoslak8lePMcDifL9o7B9s6WIdLEcXwDBLZwraew9w+7V9UUUg4msx2WwAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2020 06 23 12 20 56" title="" data-src="/static/2020-06-23-12-20-56-903d60334fe837e1ca96c5dc05a5ae7f-0e897.png" data-srcset="/static/2020-06-23-12-20-56-903d60334fe837e1ca96c5dc05a5ae7f-d60f6.png 200w,\n/static/2020-06-23-12-20-56-903d60334fe837e1ca96c5dc05a5ae7f-6689e.png 400w,\n/static/2020-06-23-12-20-56-903d60334fe837e1ca96c5dc05a5ae7f-0e897.png 578w" data-sizes="(max-width: 578px) 100vw, 578px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>入口文件：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="46156943401552520000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// app1 & app2: index.js\nimport App from \'./App\';\nimport React from \'react\';\nimport ReactDOM from \'react-dom\';\n\nReactDOM.render(<App />, document.getElementById(\'root\'));`, `46156943401552520000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// app1 &amp; app2: index.js</span>\n<span class="token keyword">import</span> App <span class="token keyword">from</span> <span class="token string">\'./App\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> ReactDOM <span class="token keyword">from</span> <span class="token string">\'react-dom\'</span><span class="token punctuation">;</span>\n\nReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>App <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">\'root\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>app2 生产了 Button 组件：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="43491477693842160000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// app2: Button.js\nimport React from \'react\';\n\nconst Button = () => <button>App 2 Button</button>;\n\nexport default Button;`, `43491477693842160000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// app2: Button.js</span>\n<span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">Button</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token operator">&lt;</span>button<span class="token operator">></span>App <span class="token number">2</span> Button<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">></span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> Button<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>app2 自身消费 Button 组件：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="46840137152246776000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// app2: App.js\nimport LocalButton from \'./Button\';\nimport React from \'react\';\n\nconst App = () => (\n  <div>\n    <h1>Basic Host-Remote</h1>\n    <h2>App 2</h2>\n    <LocalButton />\n  </div>\n);\n\nexport default App;`, `46840137152246776000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// app2: App.js</span>\n<span class="token keyword">import</span> LocalButton <span class="token keyword">from</span> <span class="token string">\'./Button\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">App</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span>\n  <span class="token operator">&lt;</span>div<span class="token operator">></span>\n    <span class="token operator">&lt;</span>h1<span class="token operator">></span>Basic Host<span class="token operator">-</span>Remote<span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">></span>\n    <span class="token operator">&lt;</span>h2<span class="token operator">></span>App <span class="token number">2</span><span class="token operator">&lt;</span><span class="token operator">/</span>h2<span class="token operator">></span>\n    <span class="token operator">&lt;</span>LocalButton <span class="token operator">/</span><span class="token operator">></span>\n  <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> App<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>app1 引用 app2 的 Button 组件：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="34570450309425160000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// app1: App.js\nimport React from \'react\';\nconst RemoteButton = React.lazy(() => import(\'app2/Button\'));\n\nconst App = () => (\n  <div>\n    <h1>Basic Host-Remote</h1>\n    <h2>App 1</h2>\n    <React.Suspense fallback=\'Loading Button\'>\n      <RemoteButton />\n    </React.Suspense>\n  </div>\n);\n\nexport default App;`, `34570450309425160000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// app1: App.js</span>\n<span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> RemoteButton <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">lazy</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">\'app2/Button\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">App</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span>\n  <span class="token operator">&lt;</span>div<span class="token operator">></span>\n    <span class="token operator">&lt;</span>h1<span class="token operator">></span>Basic Host<span class="token operator">-</span>Remote<span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">></span>\n    <span class="token operator">&lt;</span>h2<span class="token operator">></span>App <span class="token number">1</span><span class="token operator">&lt;</span><span class="token operator">/</span>h2<span class="token operator">></span>\n    <span class="token operator">&lt;</span>React<span class="token punctuation">.</span>Suspense fallback<span class="token operator">=</span><span class="token string">\'Loading Button\'</span><span class="token operator">></span>\n      <span class="token operator">&lt;</span>RemoteButton <span class="token operator">/</span><span class="token operator">></span>\n    <span class="token operator">&lt;</span><span class="token operator">/</span>React<span class="token punctuation">.</span>Suspense<span class="token operator">></span>\n  <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> App<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>先看生产了 Button 组件的 app2，其配置文件：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="53194804847510490000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// app2：webpack.config.js\nconst HtmlWebpackPlugin = require(\'html-webpack-plugin\');\nconst { ModuleFederationPlugin } = require(\'webpack\').container;\nconst path = require(\'path\');\n\nmodule.exports = {\n  entry: \'./src/index\',\n  mode: \'development\',\n  devServer: {\n    contentBase: path.join(__dirname, \'dist\'),\n    port: 3002\n  },\n  output: {\n    publicPath: \'http://localhost:3002/\'\n  },\n  module: {\n    rules: [\n      // ...\n    ]\n  },\n  plugins: [\n    new ModuleFederationPlugin({\n      name: \'app2Lib\',\n      library: { type: \'var\', name: \'app2Lib\' },\n      filename: \'app2-remote-entry.js\',\n      exposes: {\n        Button: \'./src/Button\'\n      },\n      shared: [\'react\', \'react-dom\']\n    }),\n    new HtmlWebpackPlugin({\n      template: \'./index.html\'\n    })\n  ]\n};`, `53194804847510490000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// app2：webpack.config.js</span>\n<span class="token keyword">const</span> HtmlWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'html-webpack-plugin\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> <span class="token punctuation">{</span> ModuleFederationPlugin <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'webpack\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>container<span class="token punctuation">;</span>\n<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'path\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nmodule<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>\n  entry<span class="token punctuation">:</span> <span class="token string">\'./src/index\'</span><span class="token punctuation">,</span>\n  mode<span class="token punctuation">:</span> <span class="token string">\'development\'</span><span class="token punctuation">,</span>\n  devServer<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    contentBase<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">\'dist\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    port<span class="token punctuation">:</span> <span class="token number">3002</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  output<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    publicPath<span class="token punctuation">:</span> <span class="token string">\'http://localhost:3002/\'</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  module<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    rules<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n      <span class="token comment">// ...</span>\n    <span class="token punctuation">]</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n    <span class="token keyword">new</span> <span class="token class-name">ModuleFederationPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n      name<span class="token punctuation">:</span> <span class="token string">\'app2Lib\'</span><span class="token punctuation">,</span>\n      library<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">\'var\'</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string">\'app2Lib\'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      filename<span class="token punctuation">:</span> <span class="token string">\'app2-remote-entry.js\'</span><span class="token punctuation">,</span>\n      exposes<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n        Button<span class="token punctuation">:</span> <span class="token string">\'./src/Button\'</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      shared<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'react\'</span><span class="token punctuation">,</span> <span class="token string">\'react-dom\'</span><span class="token punctuation">]</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token keyword">new</span> <span class="token class-name">HtmlWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n      template<span class="token punctuation">:</span> <span class="token string">\'./index.html\'</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  <span class="token punctuation">]</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这段配置描述了，需要暴露出 Button 组件、需要依赖 react、react-dom。管理 exposes 和 shared 的模块为 app2Lib，生成入口文件名为 app-remote-entry.js。</p>\n<p>app1 的配置文件：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="91838351983744700000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const HtmlWebpackPlugin = require(\'html-webpack-plugin\');\nconst { ModuleFederationPlugin } = require(\'webpack\').container;\nconst path = require(\'path\');\n\nmodule.exports = {\n  entry: \'./src/index\',\n  mode: \'development\',\n  devServer: {\n    contentBase: path.join(__dirname, \'dist\'),\n    port: 3001\n  },\n  output: {\n    publicPath: \'http://localhost:3001/\'\n  },\n  module: {\n    rules: [\n      // ...\n    ]\n  },\n  plugins: [\n    new ModuleFederationPlugin({\n      name: \'app1\',\n      library: { type: \'var\', name: \'app1\' },\n      remotes: {\n        app2: \'app2Lib\'\n      },\n      shared: [\'react\', \'react-dom\']\n    }),\n    new HtmlWebpackPlugin({\n      template: \'./index.html\'\n    })\n  ]\n};`, `91838351983744700000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> HtmlWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'html-webpack-plugin\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> <span class="token punctuation">{</span> ModuleFederationPlugin <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'webpack\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>container<span class="token punctuation">;</span>\n<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'path\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nmodule<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>\n  entry<span class="token punctuation">:</span> <span class="token string">\'./src/index\'</span><span class="token punctuation">,</span>\n  mode<span class="token punctuation">:</span> <span class="token string">\'development\'</span><span class="token punctuation">,</span>\n  devServer<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    contentBase<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">\'dist\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    port<span class="token punctuation">:</span> <span class="token number">3001</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  output<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    publicPath<span class="token punctuation">:</span> <span class="token string">\'http://localhost:3001/\'</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  module<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    rules<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n      <span class="token comment">// ...</span>\n    <span class="token punctuation">]</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n    <span class="token keyword">new</span> <span class="token class-name">ModuleFederationPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n      name<span class="token punctuation">:</span> <span class="token string">\'app1\'</span><span class="token punctuation">,</span>\n      library<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">\'var\'</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string">\'app1\'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      remotes<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n        app2<span class="token punctuation">:</span> <span class="token string">\'app2Lib\'</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      shared<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'react\'</span><span class="token punctuation">,</span> <span class="token string">\'react-dom\'</span><span class="token punctuation">]</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token keyword">new</span> <span class="token class-name">HtmlWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n      template<span class="token punctuation">:</span> <span class="token string">\'./index.html\'</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  <span class="token punctuation">]</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这段配置描述了，使用远端模块 app2Lib，依赖 react、react-dom。</p>\n<p>最后一步：在 app1 html 中加载 app2-remote-entry.js：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="51375664828159360000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<!-- app1: index.html -->\n<html>\n  <head>\n    <script src=&quot;http://localhost:3002/app2-remote-entry.js&quot;></script>\n  </head>\n  <body>\n    <div id=&quot;root&quot;></div>\n  </body>\n</html>`, `51375664828159360000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="html"\n              >\n                <span class="gatsby-code-button-language">html</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="html"><pre style="counter-reset: linenumber NaN" class="language-html line-numbers"><code class="language-html"><span class="token comment">&lt;!-- app1: index.html --></span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span>\n  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://localhost:3002/app2-remote-entry.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>\n  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>\n  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>root<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>\n  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>运行结果：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2020-06-23-12-24-41-856891c55c995e59032f617e37287c81-34bc5.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 25.555555555555554%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAIAAADKYVtkAAAACXBIWXMAAAsSAAALEgHS3X78AAAA2ElEQVQY012O226DMAyGee+q2gjQtbC7nbs+WtUbmDQIDcrJDiQpM0i72D5b1m8nv+Vkvy8p82K32WwPZVUeKpYVefGQpvn2jt2nGWM5Y8WS2a6sHp+e315f3o+fp9PHMWmb+jZN8zzf5pUYSRIGnLEwrcQYA8VSI7XjOJL2ISSK84BI/1djNADoRnQIiBbA/uLQUTW0zxitFKwk81/E9Vqfz1pK55wQYhiGvu/bttOaLLrjXEn53QsDqKX6b6a35nJBALrc2mU92ermq+u49540TSygD5HED/5IByn7VsDFAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2020 06 23 12 24 41" title="" data-src="/static/2020-06-23-12-24-41-856891c55c995e59032f617e37287c81-fee1c.png" data-srcset="/static/2020-06-23-12-24-41-856891c55c995e59032f617e37287c81-a67b7.png 200w,\n/static/2020-06-23-12-24-41-856891c55c995e59032f617e37287c81-0b187.png 400w,\n/static/2020-06-23-12-24-41-856891c55c995e59032f617e37287c81-fee1c.png 800w,\n/static/2020-06-23-12-24-41-856891c55c995e59032f617e37287c81-34bc5.png 1080w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2020-06-23-12-24-46-64217ff70f06585648f35321b3503af8-34bc5.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 21.759259259259256%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAIAAAABPYjBAAAACXBIWXMAAAsSAAALEgHS3X78AAAAlElEQVQI11VPyw7DIAzj/z+zpw6mQktDwivM0F1qIXCcRDZm37Ze8hhDx4J21aGqLIUolVJba733th6cAqnWRzGnszUljGMREqUJZs5ZQFASUYwR/AbDHW+UGOCUzHL7uwLee2utyOyGEHwI1rl9/1xXxO5x+EdkkXBGM94QEee+sADPOSMi4mGHWeZfmJEZyWdX6g8Aoeht6QIuRgAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2020 06 23 12 24 46" title="" data-src="/static/2020-06-23-12-24-46-64217ff70f06585648f35321b3503af8-fee1c.png" data-srcset="/static/2020-06-23-12-24-46-64217ff70f06585648f35321b3503af8-a67b7.png 200w,\n/static/2020-06-23-12-24-46-64217ff70f06585648f35321b3503af8-0b187.png 400w,\n/static/2020-06-23-12-24-46-64217ff70f06585648f35321b3503af8-fee1c.png 800w,\n/static/2020-06-23-12-24-46-64217ff70f06585648f35321b3503af8-34bc5.png 1080w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h2 id="引用的-app2button-是如何找到的呢？"><a href="#%E5%BC%95%E7%94%A8%E7%9A%84-app2button-%E6%98%AF%E5%A6%82%E4%BD%95%E6%89%BE%E5%88%B0%E7%9A%84%E5%91%A2%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>引用的 app2/Button 是如何找到的呢？</h2>\n<p>通过 app1 的配置文件，知道了 app2 是远端加载。在生成的 app1 main.js 描述为：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2020-06-23-12-25-08-bf1bc821f6fc2c4a550b83a941710684-34bc5.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 60.64814814814814%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAAsSAAALEgHS3X78AAABj0lEQVQoz4VQyZLbIBT0//9XDlOpLE4mninL1gpCRiAWsYlNoexU5uZp3qGroF93c1iWGcCxHm4tQGSZ+bqE6Pdczuc47Glfqez/tKQe3HzzZDYI6hvyWu2fbTgkYySaaQdJC8Zzj6+DgsDim+csaZWDfybOzsZto9V5uVQCjgJCNQKDkVdr3lx27pk4aENHigfCsJB0WQlhN8Yw53TVTGT/VFx6ObN1l/nHl8uvr/Xrt8vx5fTz5Xz63jZvndU2uFDCyTWI1RvjjPGr8lobpcNhf3xLDNN1ej/21bHt3kFXgfqtJsPoGDPaCaEZE1YZJ6UVwmkjpFXKHf5nsMoRJOG4TthwYf0jcCrIMcYU435nZfacY8rl4p+40IXqtpcQiQFwSjjndtt8zulp5ztSTKUepWahUopVCieF8c7HEO6uqTyIIaYQgw9litmHOOes0dz+7nE99KeueW1gBXAzkm5EV4iuA24m3CDcDMsABJyi1h/igs060C0IsTKcK1tab8Ukbq6QguIZvY8Pzwf+Au2LsFmLZO6aAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2020 06 23 12 25 08" title="" data-src="/static/2020-06-23-12-25-08-bf1bc821f6fc2c4a550b83a941710684-fee1c.png" data-srcset="/static/2020-06-23-12-25-08-bf1bc821f6fc2c4a550b83a941710684-a67b7.png 200w,\n/static/2020-06-23-12-25-08-bf1bc821f6fc2c4a550b83a941710684-0b187.png 400w,\n/static/2020-06-23-12-25-08-bf1bc821f6fc2c4a550b83a941710684-fee1c.png 800w,\n/static/2020-06-23-12-25-08-bf1bc821f6fc2c4a550b83a941710684-34bc5.png 1080w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>看这里的 data 数组：</p>\n<p>data[1] 即 webpack/container/reference/app2，这里是返回 app2Lib 对象：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="11539298498558058000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`module.exports = app2Lib;`, `11539298498558058000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> app2Lib<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>data[0] 即 webpack/container/remote-overrides/a46c3e，这里提供了 app2 需要的 react、react-dom 依赖，并返回 app2Lib：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="51226257211129260000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`module.exports = (external) => {\n  if (external.override) {\n    external.override(\n      Object.assign(\n        {\n          react: () => {\n            return Promise.resolve().then(() => {\n              return () => __webpack_require__(/*! react */ \'./node_modules/react/index.js\');\n            });\n          },\n          \'react-dom\': () => {\n            return Promise.resolve().then(() => {\n              return () => __webpack_require__(/*! react-dom */ \'./node_modules/react-dom/index.js\');\n            });\n          }\n        },\n        __webpack_require__.O\n      )\n    );\n  }\n  return external;\n};`, `51226257211129260000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">external</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>external<span class="token punctuation">.</span>override<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    external<span class="token punctuation">.</span><span class="token function">override</span><span class="token punctuation">(</span>\n      Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>\n        <span class="token punctuation">{</span>\n          <span class="token function-variable function">react</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n              <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token comment">/*! react */</span> <span class="token string">\'./node_modules/react/index.js\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token punctuation">}</span><span class="token punctuation">,</span>\n          <span class="token string">\'react-dom\'</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n              <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token comment">/*! react-dom */</span> <span class="token string">\'./node_modules/react-dom/index.js\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span><span class="token punctuation">,</span>\n        __webpack_require__<span class="token punctuation">.</span><span class="token constant">O</span>\n      <span class="token punctuation">)</span>\n    <span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">return</span> external<span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>所以最后 promise 的赋值变成了：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="70948799493330200000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var promise = app2Lib.get(\'Button\');`, `70948799493330200000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> promise <span class="token operator">=</span> app2Lib<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">\'Button\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>这么一看，app2Lib 是全局变量呀。</p>\n<p>继续看 app1 加载的 app2-remote-entry.js 内容。果然，生成了一个全局变量 app2Lib：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2020-06-23-12-27-39-c7848d196ba8beb9e25f74efa9a72359-34bc5.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 40.648148148148145%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAA7DAAAOwwHHb6hkAAABQ0lEQVQY04VR2XLkIAz0//9dkkoyEx9rj8GAQJwGO/Ex0czT7tO2KJVKapVaoiolGw8SOQYI2WHQJoCNhgLtlXbSRQQvKUk0cNLPdj+2+xNVKUVZXrP3brq206Xhl8/hrWYfl+Htc3ilYJBtL5s/ou7Fw3N9o/6Yfci+muckQfac9dM4wuhnA24iFS6hT0ikeYnzkvIyky9rTiWSQKqmEirvXXOrudJGGMmV0tp4YufjOO7/Q+WcE8gCiggCGFNcWolOwvdSqHyS/YuTcH++83xMZvp27V8v/UvHP1r2HhPmHH5+1vN+HOf+5JOOfd+3R+PfkxEN3aCTbcO761i3U99O3RdrBjWAMwymEUiM0PQFic6uaPNlW7djiyVWaFGBSNbrUWkOTgcrwCqcY3bgUBojTTQmo/6OYU1hiaF4uwa/pPALK7jA10rqxbYAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2020 06 23 12 27 39" title="" data-src="/static/2020-06-23-12-27-39-c7848d196ba8beb9e25f74efa9a72359-fee1c.png" data-srcset="/static/2020-06-23-12-27-39-c7848d196ba8beb9e25f74efa9a72359-a67b7.png 200w,\n/static/2020-06-23-12-27-39-c7848d196ba8beb9e25f74efa9a72359-0b187.png 400w,\n/static/2020-06-23-12-27-39-c7848d196ba8beb9e25f74efa9a72359-fee1c.png 800w,\n/static/2020-06-23-12-27-39-c7848d196ba8beb9e25f74efa9a72359-34bc5.png 1080w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>app2Lib 对象拥有两个方法，具体为：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2020-06-23-12-27-48-17d1e42bcf19dd65622a4ca3483557ae-34bc5.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 12.037037037037036%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAIAAADXZGvcAAAACXBIWXMAAAsSAAALEgHS3X78AAAAMUlEQVQI12P4+ePnuxcfXz5/+fLli8+fP//79+8/0YDh169fP77+evvm3ZcvIJ0kAQDxbnXluupwVgAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2020 06 23 12 27 48" title="" data-src="/static/2020-06-23-12-27-48-17d1e42bcf19dd65622a4ca3483557ae-fee1c.png" data-srcset="/static/2020-06-23-12-27-48-17d1e42bcf19dd65622a4ca3483557ae-a67b7.png 200w,\n/static/2020-06-23-12-27-48-17d1e42bcf19dd65622a4ca3483557ae-0b187.png 400w,\n/static/2020-06-23-12-27-48-17d1e42bcf19dd65622a4ca3483557ae-fee1c.png 800w,\n/static/2020-06-23-12-27-48-17d1e42bcf19dd65622a4ca3483557ae-34bc5.png 1080w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="39281888836773440000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var get = (module) => {\n  return __webpack_require__.o(moduleMap, module)\n    ? moduleMap[module]()\n    : Promise.resolve().then(() => {\n        throw new Error(\'Module &quot;\' + module + \'&quot; does not exist in container.\');\n      });\n};\n\nvar override = (override) => {\n  Object.assign(__webpack_require__.O, override);\n};`, `39281888836773440000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> <span class="token function-variable function">get</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">module</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> __webpack_require__<span class="token punctuation">.</span><span class="token function">o</span><span class="token punctuation">(</span>moduleMap<span class="token punctuation">,</span> module<span class="token punctuation">)</span>\n    <span class="token operator">?</span> moduleMap<span class="token punctuation">[</span>module<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token punctuation">:</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">\'Module "\'</span> <span class="token operator">+</span> module <span class="token operator">+</span> <span class="token string">\'" does not exist in container.\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">var</span> <span class="token function-variable function">override</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">override</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>__webpack_require__<span class="token punctuation">.</span><span class="token constant">O</span><span class="token punctuation">,</span> override<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>所以，app2/Button 实际就是 app2Lib.get(‘Button’)，然后根据映射找到模块，随后 <code class="language-text">__webpack_require__</code>：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="84583474885095100000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var moduleMap = {\n  Button: () => {\n    return __webpack_require__\n      .e(\'src_Button_js\')\n      .then(() => () => __webpack_require__(/*! ./src/Button */ \'./src/Button.js\'));\n  }\n};`, `84583474885095100000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> moduleMap <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token function-variable function">Button</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> __webpack_require__\n      <span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token string">\'src_Button_js\'</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token comment">/*! ./src/Button */</span> <span class="token string">\'./src/Button.js\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>最后再说 shared: [‘react’, ‘react-dom’]：</p>\n<p>app2 中指明了需要依赖 react、react-dom，并期望消费的应用提供。如果 app1 没有提供，或没有提供指定版本，如下把代码注释：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="24583409005774094000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`plugins: [\n  new ModuleFederationPlugin({\n    name: \'app1\',\n    library: { type: \'var\', name: \'app1\' },\n    remotes: {\n      app2: \'app2Lib\'\n    }\n    // shared: [&quot;react&quot;, &quot;react-dom&quot;],\n    // 版本不一致同理\n    // shared: {\n    //   &quot;react-15&quot;: &quot;react&quot;,\n    //   &quot;react-dom&quot;: &quot;react-dom&quot;,\n    // },\n  }),\n  new HtmlWebpackPlugin({\n    template: \'./index.html\'\n  })\n];`, `24583409005774094000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n  <span class="token keyword">new</span> <span class="token class-name">ModuleFederationPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n    name<span class="token punctuation">:</span> <span class="token string">\'app1\'</span><span class="token punctuation">,</span>\n    library<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">\'var\'</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string">\'app1\'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    remotes<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n      app2<span class="token punctuation">:</span> <span class="token string">\'app2Lib\'</span>\n    <span class="token punctuation">}</span>\n    <span class="token comment">// shared: ["react", "react-dom"],</span>\n    <span class="token comment">// 版本不一致同理</span>\n    <span class="token comment">// shared: {</span>\n    <span class="token comment">//   "react-15": "react",</span>\n    <span class="token comment">//   "react-dom": "react-dom",</span>\n    <span class="token comment">// },</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n  <span class="token keyword">new</span> <span class="token class-name">HtmlWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n    template<span class="token punctuation">:</span> <span class="token string">\'./index.html\'</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span>\n<span class="token punctuation">]</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>那么，刚才 app1 main.js 中的 data[0] 即 webpack/container/remote-overrides/a46c3e 会变为：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="40305352406187114000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`module.exports = (external) => {\n  if (external.override) {\n    external.override(__webpack_require__.O);\n    // external.override(Object.assign({\n    //   &quot;react&quot;: () => {\n    //     return Promise.resolve().then(() => {\n    //       return () => __webpack_require__(/*! react */ &quot;./node_modules/react/index.js&quot;)\n    //     })\n    //   },\n    //   &quot;react-dom&quot;: () => {\n    //     return Promise.resolve().then(() => {\n    //       return () => __webpack_require__(/*! react-dom */ &quot;./node_modules/react-dom/index.js&quot;)\n    //     })\n    //   }\n    // }, __webpack_require__.O))\n  }\n  return external;\n};`, `40305352406187114000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">external</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>external<span class="token punctuation">.</span>override<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    external<span class="token punctuation">.</span><span class="token function">override</span><span class="token punctuation">(</span>__webpack_require__<span class="token punctuation">.</span><span class="token constant">O</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// external.override(Object.assign({</span>\n    <span class="token comment">//   "react": () => {</span>\n    <span class="token comment">//     return Promise.resolve().then(() => {</span>\n    <span class="token comment">//       return () => __webpack_require__(/*! react */ "./node_modules/react/index.js")</span>\n    <span class="token comment">//     })</span>\n    <span class="token comment">//   },</span>\n    <span class="token comment">//   "react-dom": () => {</span>\n    <span class="token comment">//     return Promise.resolve().then(() => {</span>\n    <span class="token comment">//       return () => __webpack_require__(/*! react-dom */ "./node_modules/react-dom/index.js")</span>\n    <span class="token comment">//     })</span>\n    <span class="token comment">//   }</span>\n    <span class="token comment">// }, __webpack_require__.O))</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">return</span> external<span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>app1 则从 app2 加载 react 依赖：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2020-06-23-12-30-00-34869dff6f594dbefff8b138d6b419b9-34bc5.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 39.907407407407405%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAA7DAAAOwwHHb6hkAAABL0lEQVQY032Qy3aEIAyGff+najdd9XTTRc9csKOOowgBuQgI6DROb3O66H9CyCLfT0hBKW2aZrfbE1JqrY3WjIOUcmDs0lGKF+NbcM4BhBBSKuACBADtC0IIAs45JFNKzlqlDQdVt3176fhNW++NwwMAaGOMHZUqEFuW5fqtMKOCtm6O0YdgrXV+8sFNbvLex5TjPKebQgjFD7auK+ayEQ/P7dMrPL7ww6kaBI4u3is6DGz2PseUYswp5ZzxyXt4yzjzsawHJpX2TVcLw6xyZF8rAd6qFPwS56/W6/UX/lTerGe0wrrta9BDtF5U54lDHMc0ijiKxTuMdUl/4fv/t30DhgXj6yN937fk7XQ+XmjVOSED7ngK/8FNVw2yw2LU/kCAlLTrlZ1wYWvOa4zrB3hGx7iWEIl5AAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2020 06 23 12 30 00" title="" data-src="/static/2020-06-23-12-30-00-34869dff6f594dbefff8b138d6b419b9-fee1c.png" data-srcset="/static/2020-06-23-12-30-00-34869dff6f594dbefff8b138d6b419b9-a67b7.png 200w,\n/static/2020-06-23-12-30-00-34869dff6f594dbefff8b138d6b419b9-0b187.png 400w,\n/static/2020-06-23-12-30-00-34869dff6f594dbefff8b138d6b419b9-fee1c.png 800w,\n/static/2020-06-23-12-30-00-34869dff6f594dbefff8b138d6b419b9-34bc5.png 1080w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2020-06-23-12-30-06-3cacfeb19131d70ca3c2f969194fb14a-34bc5.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 27.22222222222222%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAIAAADKYVtkAAAACXBIWXMAAAsSAAALEgHS3X78AAAA20lEQVQY011Qa2uEMBD0//+t9sN5BY+DVu5Or+fbVPMgkajJmthNS1voMAzDsrMMG+V5rpSa5xkVABatpVRSyqYjTduPCEo558OIKrgQjDLGuZomqVSktXbO7T8w1sBmAczmNoBgAq0xFiyqWcEsZp0d7tg1+o15H5QQermUfcc/iHg8SFGQe96+31vSs6phWTmUrbgWQ0EmNP/DdcefDll6G9OMx0kdn+pDUj3HWXKuzld2fKMvKT+mLLlN8Sv9C3/jq+q67y5c89Y5rId/UNgZJ7sH7wLRW7N8AiH+Gfn4UHzzAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2020 06 23 12 30 06" title="" data-src="/static/2020-06-23-12-30-06-3cacfeb19131d70ca3c2f969194fb14a-fee1c.png" data-srcset="/static/2020-06-23-12-30-06-3cacfeb19131d70ca3c2f969194fb14a-a67b7.png 200w,\n/static/2020-06-23-12-30-06-3cacfeb19131d70ca3c2f969194fb14a-0b187.png 400w,\n/static/2020-06-23-12-30-06-3cacfeb19131d70ca3c2f969194fb14a-fee1c.png 800w,\n/static/2020-06-23-12-30-06-3cacfeb19131d70ca3c2f969194fb14a-34bc5.png 1080w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>总结，根据 app2 配置的 exposes &#x26; shared 内容，产生对应的模块文件，以及模块映射关系，通过全局变量 app2Lib 进行访问；app1 通过全局变量 get 能知道应该去如何加载 button.js，override 能知道共享依赖的模块。</p>\n<p>以上，Federation 初看很像 DLL + External，但好处是你无需手动维护、打包依赖，代码运行时加载。这种模式下，调试也变得容易，不再需要复制粘贴代码或者 npm link，只需要启动应用即可。这里仅以 Button 组件为例，Button 可以是一个组件，也可以是一个页面、一个应用。Module Federation 的落地，结合自动化流程等系列工作，还需要大家在各自场景中实践。</p>\n<h1 id="其他特性"><a href="#%E5%85%B6%E4%BB%96%E7%89%B9%E6%80%A7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>其他特性</h1>\n<ul>\n<li>Top Level Await</li>\n<li>SplitChunks 支持更灵活的资源拆分</li>\n<li>不包含 JS 代码的 Chunk 将不再生成 JS 文件</li>\n<li>Output 默认生成 ES6 规范代码，也支持配置为 5 - 11</li>\n</ul>',
id:"/home/runner/work/GatsbyBlog/GatsbyBlog/blog/Webpack5新特性/index.md absPath of file >>> MarkdownRemark",timeToRead:10,frontmatter:{date:"2020-06-23 12:03:29",path:"/webpack-v5-new-feature/",tags:"前端, 前端构建工具, webpack",title:"Webpack5新特性",draft:null}},{excerpt:"需求背景 需求背景接上文  记一次组件打包为链接的实践 框架搭建接上文  Webpack 脚手架搭建笔记——记一次新项目搭建 组件轻量化 在将客服组件上线后，由于未考虑到加载的组件包的大小，尤其是初始加载的包比较大，即使是压缩过初始加载也有 600 多 k…",html:'<h1 id="需求背景"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h1>\n<p>需求背景接上文 <a href="/components-pack-as-library/">记一次组件打包为链接的实践</a></p>\n<p>框架搭建接上文 <a href="/webpack-template-new-project/">Webpack 脚手架搭建笔记——记一次新项目搭建</a></p>\n<h2 id="组件轻量化"><a href="#%E7%BB%84%E4%BB%B6%E8%BD%BB%E9%87%8F%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>组件轻量化</h2>\n<p>在将客服组件上线后，由于未考虑到加载的组件包的大小，尤其是初始加载的包比较大，即使是压缩过初始加载也有 600 多 k，严重影响首页加载，导致加载此脚本的网站需要很长时间才能响应，所以有了这次的优化任务</p>\n<h2 id="移动端适配"><a href="#%E7%A7%BB%E5%8A%A8%E7%AB%AF%E9%80%82%E9%85%8D" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>移动端适配</h2>\n<p>根据产品要求，此客服组件还需要兼容到移动端，微信端（微信网页、小程序）</p>\n<h1 id="方案调研"><a href="#%E6%96%B9%E6%A1%88%E8%B0%83%E7%A0%94" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>方案调研</h1>\n<ol>\n<li>组件异步加载，减少首屏加载大小，非首屏且较大的组件预加载，这里需要 nginx 的配合</li>\n<li>去除较大的库，改用轻量级的替代库或者不用</li>\n<li>所有用到的组件最好都由自己编写，有利于定制化功能、减小组件大小</li>\n<li>移动端可以和桌面端项目写在一起分开打包</li>\n<li>代码的分层尤其是 IM 层要分离出来，便于切换不同的 IM 提供商</li>\n<li>小程序端用 webview 加载的网页，需要注意在第三方小程序上配置 nginx</li>\n</ol>\n<h1 id="具体实施"><a href="#%E5%85%B7%E4%BD%93%E5%AE%9E%E6%96%BD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>具体实施</h1>\n<h2 id="组件异步加载"><a href="#%E7%BB%84%E4%BB%B6%E5%BC%82%E6%AD%A5%E5%8A%A0%E8%BD%BD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>组件异步加载</h2>\n<p>需要修改 webpack 配置，由于之前是在 webpack2 上开发，不能很完美的做到异步加载。此时将框架升级到和本文 <a href="/webpack-template-new-project/">Webpack 脚手架搭建笔记——记一次新项目搭建</a> 的同一版本，具体修改如下：</p>\n<ol>\n<li>\n<p>去除 mini-css-extract-plugin，防止 css 单独抽离</p>\n</li>\n<li>\n<p>聚合初始加载脚本到一个文件，异步加载的在其他文件，且对异步加载的做 hash 处理</p>\n<p>boot\\internals\\webpack\\webpack.prod.babel.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="1779659039252057300"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`entry: {\n bundle: [\'runtime/polyfill\', path.join(process.cwd(), buildMap.indexEntry)],\n},\n\noutput: {\n filename: \'[name].js\',\n chunkFilename: \'[name].[chunkhash].chunk.js\',\n},\n\n// 关闭代码切割，防止首页产生除 bundle.js 外的其他文件\n// runtimeChunk: \'single\',\nsplitChunks: false,`, `1779659039252057300`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">entry<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n bundle<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'runtime/polyfill\'</span><span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> buildMap<span class="token punctuation">.</span>indexEntry<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span>\n\noutput<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n filename<span class="token punctuation">:</span> <span class="token string">\'[name].js\'</span><span class="token punctuation">,</span>\n chunkFilename<span class="token punctuation">:</span> <span class="token string">\'[name].[chunkhash].chunk.js\'</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span>\n\n<span class="token comment">// 关闭代码切割，防止首页产生除 bundle.js 外的其他文件</span>\n<span class="token comment">// runtimeChunk: \'single\',</span>\nsplitChunks<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n</ol>\n<p>生成构建文件如下：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2019-10-29-11-25-49-bc4044d99bc392a402c1d0e3ce7063b2-b043c.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 539px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 34.137291280148425%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAA60lEQVQY011Q7U7DMAzso3Rja9o0dhLnoy385AcSA4QQ4/0fhXNbTTDpZDk+3zl2Ux6fXz8+pTy5uIx+HrgqqO7JDXRft1yb9uSuF5NLIog5Hzv3ABj6D1T4rng4j82h4+ublRSNS14mipVl8ml2vnCsJBOeIc2xLIg7FQqiGYOKvy82ZekpQwl4AZ03IwolpAWtQMyq96sF9GBV/PNuJcfeZQrVhTp6TbaB6rVG5Nt8/AjsQNKebHPs+OtlwLdxAFQtJ6di7eB1BXSrXay4COK5Z8iw8Lqz4bm3gROL7omDtSuBjh1/8k1zwy+Vb0zfFkV37AAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2019 10 29 11 25 49" title="" data-src="/static/2019-10-29-11-25-49-bc4044d99bc392a402c1d0e3ce7063b2-b043c.png" data-srcset="/static/2019-10-29-11-25-49-bc4044d99bc392a402c1d0e3ce7063b2-e7723.png 200w,\n/static/2019-10-29-11-25-49-bc4044d99bc392a402c1d0e3ce7063b2-61f03.png 400w,\n/static/2019-10-29-11-25-49-bc4044d99bc392a402c1d0e3ce7063b2-b043c.png 539w" data-sizes="(max-width: 539px) 100vw, 539px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2019-10-29-11-26-45-0dd51dca711978fc9eedd98affc6fa2b-b1a91.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 38.416666666666664%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAAsSAAALEgHS3X78AAAA80lEQVQY033QW3LDIAwFUK+lbfwAJBAgIbCdJvvfVLHTTNuPZuaMRnzAFRp0vSOV0cbL7C+Lf5/wtbcRF0gY9WPGIVG9lqvU3QUF0gV4dvm1yebRpN4M7FWoAMkMebRpMmmy32abD/+/MmRf99S4NdpbZA2i/oSiLpXOIP+NPTKn08ChKlVMBbJiJzUkDVFdVANsgReQ/pcFxZwslqMCm345hNr42qhpu6d607xLvfF272S97bJp+/S8UWwhrUD1wfsCKMfCxKsL4uLBenYkkItN0vWxgYshQRBzzvyzkZ5M1LyvM5TlAc/qnkf37PFgUH/7AoQQWlIoJmRsAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2019 10 29 11 26 45" title="" data-src="/static/2019-10-29-11-26-45-0dd51dca711978fc9eedd98affc6fa2b-fee1c.png" data-srcset="/static/2019-10-29-11-26-45-0dd51dca711978fc9eedd98affc6fa2b-a67b7.png 200w,\n/static/2019-10-29-11-26-45-0dd51dca711978fc9eedd98affc6fa2b-0b187.png 400w,\n/static/2019-10-29-11-26-45-0dd51dca711978fc9eedd98affc6fa2b-fee1c.png 800w,\n/static/2019-10-29-11-26-45-0dd51dca711978fc9eedd98affc6fa2b-b1a91.png 1200w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>首页只会引入 bundle.js 文件，且异步组件在其他文件</p>\n<h2 id="较大组件预加载"><a href="#%E8%BE%83%E5%A4%A7%E7%BB%84%E4%BB%B6%E9%A2%84%E5%8A%A0%E8%BD%BD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>较大组件预加载</h2>\n<p>这里为了打开聊天组件时不会卡顿，使用了预加载，一定要注意要在主入口加载完成，也就是请求加载完成后在进行预加载，否则同样会造成首页加载时间过长</p>\n<p>这里采取的方案是请求完成后要提前知道加载哪个组件就立即预加载此组件（需要后端配合，不适用于点击后才知道加载哪个组件的情况。当然也可以全部预加载所有较大组件，不过为了省流就没这么做），不用等到点击后加载</p>\n<h2 id="精简依赖库"><a href="#%E7%B2%BE%E7%AE%80%E4%BE%9D%E8%B5%96%E5%BA%93" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>精简依赖库</h2>\n<h3 id="打包前依赖"><a href="#%E6%89%93%E5%8C%85%E5%89%8D%E4%BE%9D%E8%B5%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>打包前依赖</h3>\n<p>package.json</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="85116743931209780000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`&quot;dependencies&quot;: {\n &quot;antd&quot;: &quot;^3.11.0&quot;,\n &quot;babel-polyfill&quot;: &quot;6.26.0&quot;,\n &quot;classnames&quot;: &quot;^2.2.5&quot;,\n &quot;element-resize-event&quot;: &quot;^2.0.9&quot;,\n &quot;immutable&quot;: &quot;3.8.1&quot;,\n &quot;invariant&quot;: &quot;2.2.2&quot;,\n &quot;lodash&quot;: &quot;4.17.2&quot;,\n &quot;md5&quot;: &quot;^2.2.1&quot;,\n &quot;moment&quot;: &quot;^2.18.1&quot;,\n &quot;prop-types&quot;: &quot;^15.6.2&quot;,\n &quot;raf&quot;: &quot;^3.4.1&quot;,\n &quot;react&quot;: &quot;16.6.0&quot;,\n &quot;react-dom&quot;: &quot;16.6.0&quot;,\n &quot;react-helmet&quot;: &quot;5.2.0&quot;,\n &quot;react-player&quot;: &quot;^1.6.4&quot;,\n &quot;react-redux&quot;: &quot;5.1.0&quot;,\n &quot;react-router&quot;: &quot;3.2.1&quot;,\n &quot;react-router-redux&quot;: &quot;4.0.6&quot;,\n &quot;react-router-scroll&quot;: &quot;0.4.4&quot;,\n &quot;redux&quot;: &quot;3.6.0&quot;,\n &quot;redux-immutable&quot;: &quot;3.0.8&quot;,\n &quot;redux-saga&quot;: &quot;0.16.2&quot;,\n &quot;reselect&quot;: &quot;2.5.4&quot;,\n &quot;rxjs&quot;: &quot;5.5.3&quot;,\n &quot;smoothscroll-polyfill&quot;: &quot;^0.3.6&quot;,\n &quot;warning&quot;: &quot;3.0.0&quot;,\n &quot;whatwg-fetch&quot;: &quot;2.0.1&quot;\n},`, `85116743931209780000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token string">"dependencies"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>\n <span class="token string">"antd"</span><span class="token punctuation">:</span> <span class="token string">"^3.11.0"</span><span class="token punctuation">,</span>\n <span class="token string">"babel-polyfill"</span><span class="token punctuation">:</span> <span class="token string">"6.26.0"</span><span class="token punctuation">,</span>\n <span class="token string">"classnames"</span><span class="token punctuation">:</span> <span class="token string">"^2.2.5"</span><span class="token punctuation">,</span>\n <span class="token string">"element-resize-event"</span><span class="token punctuation">:</span> <span class="token string">"^2.0.9"</span><span class="token punctuation">,</span>\n <span class="token string">"immutable"</span><span class="token punctuation">:</span> <span class="token string">"3.8.1"</span><span class="token punctuation">,</span>\n <span class="token string">"invariant"</span><span class="token punctuation">:</span> <span class="token string">"2.2.2"</span><span class="token punctuation">,</span>\n <span class="token string">"lodash"</span><span class="token punctuation">:</span> <span class="token string">"4.17.2"</span><span class="token punctuation">,</span>\n <span class="token string">"md5"</span><span class="token punctuation">:</span> <span class="token string">"^2.2.1"</span><span class="token punctuation">,</span>\n <span class="token string">"moment"</span><span class="token punctuation">:</span> <span class="token string">"^2.18.1"</span><span class="token punctuation">,</span>\n <span class="token string">"prop-types"</span><span class="token punctuation">:</span> <span class="token string">"^15.6.2"</span><span class="token punctuation">,</span>\n <span class="token string">"raf"</span><span class="token punctuation">:</span> <span class="token string">"^3.4.1"</span><span class="token punctuation">,</span>\n <span class="token string">"react"</span><span class="token punctuation">:</span> <span class="token string">"16.6.0"</span><span class="token punctuation">,</span>\n <span class="token string">"react-dom"</span><span class="token punctuation">:</span> <span class="token string">"16.6.0"</span><span class="token punctuation">,</span>\n <span class="token string">"react-helmet"</span><span class="token punctuation">:</span> <span class="token string">"5.2.0"</span><span class="token punctuation">,</span>\n <span class="token string">"react-player"</span><span class="token punctuation">:</span> <span class="token string">"^1.6.4"</span><span class="token punctuation">,</span>\n <span class="token string">"react-redux"</span><span class="token punctuation">:</span> <span class="token string">"5.1.0"</span><span class="token punctuation">,</span>\n <span class="token string">"react-router"</span><span class="token punctuation">:</span> <span class="token string">"3.2.1"</span><span class="token punctuation">,</span>\n <span class="token string">"react-router-redux"</span><span class="token punctuation">:</span> <span class="token string">"4.0.6"</span><span class="token punctuation">,</span>\n <span class="token string">"react-router-scroll"</span><span class="token punctuation">:</span> <span class="token string">"0.4.4"</span><span class="token punctuation">,</span>\n <span class="token string">"redux"</span><span class="token punctuation">:</span> <span class="token string">"3.6.0"</span><span class="token punctuation">,</span>\n <span class="token string">"redux-immutable"</span><span class="token punctuation">:</span> <span class="token string">"3.0.8"</span><span class="token punctuation">,</span>\n <span class="token string">"redux-saga"</span><span class="token punctuation">:</span> <span class="token string">"0.16.2"</span><span class="token punctuation">,</span>\n <span class="token string">"reselect"</span><span class="token punctuation">:</span> <span class="token string">"2.5.4"</span><span class="token punctuation">,</span>\n <span class="token string">"rxjs"</span><span class="token punctuation">:</span> <span class="token string">"5.5.3"</span><span class="token punctuation">,</span>\n <span class="token string">"smoothscroll-polyfill"</span><span class="token punctuation">:</span> <span class="token string">"^0.3.6"</span><span class="token punctuation">,</span>\n <span class="token string">"warning"</span><span class="token punctuation">:</span> <span class="token string">"3.0.0"</span><span class="token punctuation">,</span>\n <span class="token string">"whatwg-fetch"</span><span class="token punctuation">:</span> <span class="token string">"2.0.1"</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="打包后依赖"><a href="#%E6%89%93%E5%8C%85%E5%90%8E%E4%BE%9D%E8%B5%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>打包后依赖</h3>\n<p>package.json</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="10335019054741146000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`&quot;dependencies&quot;: {\n &quot;array-tree-filter&quot;: &quot;^2.1.0&quot;,\n &quot;babel-polyfill&quot;: &quot;6.26.0&quot;,\n &quot;classnames&quot;: &quot;2.2.5&quot;,\n &quot;immutable&quot;: &quot;3.8.2&quot;,\n &quot;lodash&quot;: &quot;4.17.2&quot;,\n &quot;prop-types&quot;: &quot;15.6.2&quot;,\n &quot;rc-dialog&quot;: &quot;^7.5.7&quot;,\n &quot;rc-notification&quot;: &quot;^3.3.1&quot;,\n &quot;rc-select&quot;: &quot;^9.2.0&quot;,\n &quot;rc-tooltip&quot;: &quot;^3.7.3&quot;,\n &quot;rc-upload&quot;: &quot;^2.8.1&quot;,\n &quot;react-lite&quot;: &quot;^0.15.40&quot;,\n &quot;react-loadable&quot;: &quot;5.5.0&quot;,\n &quot;rmc-cascader&quot;: &quot;^5.0.3&quot;,\n &quot;rmc-feedback&quot;: &quot;^2.0.0&quot;,\n &quot;rmc-picker&quot;: &quot;^5.0.10&quot;,\n &quot;whatwg-fetch&quot;: &quot;3.0.0&quot;\n},`, `10335019054741146000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token string">"dependencies"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>\n <span class="token string">"array-tree-filter"</span><span class="token punctuation">:</span> <span class="token string">"^2.1.0"</span><span class="token punctuation">,</span>\n <span class="token string">"babel-polyfill"</span><span class="token punctuation">:</span> <span class="token string">"6.26.0"</span><span class="token punctuation">,</span>\n <span class="token string">"classnames"</span><span class="token punctuation">:</span> <span class="token string">"2.2.5"</span><span class="token punctuation">,</span>\n <span class="token string">"immutable"</span><span class="token punctuation">:</span> <span class="token string">"3.8.2"</span><span class="token punctuation">,</span>\n <span class="token string">"lodash"</span><span class="token punctuation">:</span> <span class="token string">"4.17.2"</span><span class="token punctuation">,</span>\n <span class="token string">"prop-types"</span><span class="token punctuation">:</span> <span class="token string">"15.6.2"</span><span class="token punctuation">,</span>\n <span class="token string">"rc-dialog"</span><span class="token punctuation">:</span> <span class="token string">"^7.5.7"</span><span class="token punctuation">,</span>\n <span class="token string">"rc-notification"</span><span class="token punctuation">:</span> <span class="token string">"^3.3.1"</span><span class="token punctuation">,</span>\n <span class="token string">"rc-select"</span><span class="token punctuation">:</span> <span class="token string">"^9.2.0"</span><span class="token punctuation">,</span>\n <span class="token string">"rc-tooltip"</span><span class="token punctuation">:</span> <span class="token string">"^3.7.3"</span><span class="token punctuation">,</span>\n <span class="token string">"rc-upload"</span><span class="token punctuation">:</span> <span class="token string">"^2.8.1"</span><span class="token punctuation">,</span>\n <span class="token string">"react-lite"</span><span class="token punctuation">:</span> <span class="token string">"^0.15.40"</span><span class="token punctuation">,</span>\n <span class="token string">"react-loadable"</span><span class="token punctuation">:</span> <span class="token string">"5.5.0"</span><span class="token punctuation">,</span>\n <span class="token string">"rmc-cascader"</span><span class="token punctuation">:</span> <span class="token string">"^5.0.3"</span><span class="token punctuation">,</span>\n <span class="token string">"rmc-feedback"</span><span class="token punctuation">:</span> <span class="token string">"^2.0.0"</span><span class="token punctuation">,</span>\n <span class="token string">"rmc-picker"</span><span class="token punctuation">:</span> <span class="token string">"^5.0.10"</span><span class="token punctuation">,</span>\n <span class="token string">"whatwg-fetch"</span><span class="token punctuation">:</span> <span class="token string">"3.0.0"</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="主要变化"><a href="#%E4%B8%BB%E8%A6%81%E5%8F%98%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>主要变化</h3>\n<ol>\n<li>\n<p>去除比较大的依赖库 antd、moment、rxjs</p>\n</li>\n<li>\n<p>替换 react 为 react-lite</p>\n<p>其中需要对 react-lite 做下兼容处理，不影响之前依赖 react 的代码</p>\n<p>boot\\internals\\webpack\\webpack.base.babel.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="42031535578089540000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\'react\': path.resolve(process.cwd(), \'node_modules/react-lite\'),\n\'react-dom\': path.resolve(process.cwd(), \'node_modules/react-lite\'),`, `42031535578089540000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token string">\'react\'</span><span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">\'node_modules/react-lite\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n<span class="token string">\'react-dom\'</span><span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">\'node_modules/react-lite\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n</li>\n</ol>\n<h2 id="组件自编写"><a href="#%E7%BB%84%E4%BB%B6%E8%87%AA%E7%BC%96%E5%86%99" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>组件自编写</h2>\n<p>此项目的所有组件使用 antd、antd-mobile 的底层组件，以便优化包大小、自定义功能，组件接口尽量保持一致</p>\n<h3 id="antd-引入方式兼容"><a href="#antd-%E5%BC%95%E5%85%A5%E6%96%B9%E5%BC%8F%E5%85%BC%E5%AE%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>antd 引入方式兼容</h3>\n<p>之前的项目用到 antd，这里采用了和 antd 一样的引用方式。</p>\n<p>作用：有利于代码分割，不会将 antd 的组件代码分割到主入口，antd-mobile 同理。</p>\n<p>.babelrc</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="23748590772504040000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`[\n   &quot;import&quot;,\n   {\n     &quot;libraryName&quot;: &quot;antd&quot;,\n     &quot;libraryDirectory&quot;: &quot;components&quot;,\n     &quot;camel2DashComponentName&quot;: false\n   },\n   &quot;antd&quot;\n],\n[\n   &quot;import&quot;,\n   {\n     &quot;libraryName&quot;: &quot;antd-mobile&quot;,\n     &quot;libraryDirectory&quot;: &quot;components&quot;,\n     &quot;camel2DashComponentName&quot;: false\n   },\n   &quot;antd-mobile&quot;\n],`, `23748590772504040000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token punctuation">[</span>\n   <span class="token string">"import"</span><span class="token punctuation">,</span>\n   <span class="token punctuation">{</span>\n     <span class="token string">"libraryName"</span><span class="token punctuation">:</span> <span class="token string">"antd"</span><span class="token punctuation">,</span>\n     <span class="token string">"libraryDirectory"</span><span class="token punctuation">:</span> <span class="token string">"components"</span><span class="token punctuation">,</span>\n     <span class="token string">"camel2DashComponentName"</span><span class="token punctuation">:</span> <span class="token boolean">false</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span>\n   <span class="token string">"antd"</span>\n<span class="token punctuation">]</span><span class="token punctuation">,</span>\n<span class="token punctuation">[</span>\n   <span class="token string">"import"</span><span class="token punctuation">,</span>\n   <span class="token punctuation">{</span>\n     <span class="token string">"libraryName"</span><span class="token punctuation">:</span> <span class="token string">"antd-mobile"</span><span class="token punctuation">,</span>\n     <span class="token string">"libraryDirectory"</span><span class="token punctuation">:</span> <span class="token string">"components"</span><span class="token punctuation">,</span>\n     <span class="token string">"camel2DashComponentName"</span><span class="token punctuation">:</span> <span class="token boolean">false</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span>\n   <span class="token string">"antd-mobile"</span>\n<span class="token punctuation">]</span><span class="token punctuation">,</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>文件目录如下</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2019-10-29-14-30-51-8a391e3492c87bc37285696d664ee742-d9a6c.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 323px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 169.3498452012384%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAiCAIAAADQyG7qAAAACXBIWXMAAAsSAAALEgHS3X78AAAC9UlEQVRIx5VV2W7TUBTMbwBq0tRJHO/7vlzbiZc4cbaStgpRoaJCCPHCG6/8Al/MOC0gHrBd6byOz8zcOeOeqNn7+0+aHZJZPi9WSVqqpte/ml5N+OGYa54eL5suyaPFzrBJEOWy7tGcxgg6ZsprzQOwZQVpXO5NNw7jghGM4USgaAkzYVV8qGF6E1bGPH5xl5tINcP0zDxOy7RYM7w6GLFNtEdTacxISUbyqoIEyyPQzEsGK+oULbRopmiRZmVecZe3H9xwFiVFPF9MefViSLcbNpqKE0aSdLd8e5I1B3hRtS8b2f4DpjmZV+35+lDTdomgmF2Qf8Gq5W9Pj5YXwTDdDl4ABm1BtZPlnpcNL5zB/JeAWRmalzf3kmYn6QImvx6Mu8g+02ZlBKvYHw0njNOF7cckyWF4K/4ZDNrp5lbSHOAR1yBOx4zYDqbOhikw7N1Hy4Vh1SxbIjZdbuOPYQ6eSjFc3fIVw+v4Ws+GiZqb7+4U3cVaP8r8KO10kk+aJcNfPLmdlbYX94fTF2yWFWNbVrxSJ0w1PGjuBqaFsaBZnPKzCg07QJnM81W9vItheJLBiH9/zWaJKuuhGyY4SdDptBl56lPsw/UkIaLhzOJ54QazAcUOKKYdjLpwYG9xpxiBFyaaFSBhZbWDeWCOnDRMD0WnWGFW5V6UOGFq+zOXpEFcaDaZcFrz9FSTKAb59j27PVVeVK2vj/nqMC/3q+1RdxJWslEy/5u6ABlBk4xgebgHZ5+kCEkQZaJiwQ6UVMPgnQWaU86HcYN4BnFmexGuGgk9H0bT1CGBZ2iB6u5B1h0nSF5djN4Mxp3cfoonJ5uk2GAz1kqqTXcrk9+bTX9zfIDmpK77quPvqgajNOoaOpwU00OHaJZ/OeLOqrrRFlUr2xygGVYBDMGXFNMquwazvMqqZHP6DLb4XcDwYrldrHZg0cy8d74BYZ3xETF52cFJYj8j4P+oTNoOswZfUNyPr9PrUg6SarXZ4/8Iwf0r0G6R/QvJd2/gEfEU5wAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2019 10 29 14 30 51" title="" data-src="/static/2019-10-29-14-30-51-8a391e3492c87bc37285696d664ee742-d9a6c.png" data-srcset="/static/2019-10-29-14-30-51-8a391e3492c87bc37285696d664ee742-82faf.png 200w,\n/static/2019-10-29-14-30-51-8a391e3492c87bc37285696d664ee742-d9a6c.png 323w" data-sizes="(max-width: 323px) 100vw, 323px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h2 id="桌面移动端分离打包"><a href="#%E6%A1%8C%E9%9D%A2%E7%A7%BB%E5%8A%A8%E7%AB%AF%E5%88%86%E7%A6%BB%E6%89%93%E5%8C%85" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>桌面移动端分离打包</h2>\n<p>考虑到桌面移动端的复用逻辑较多，所以将桌面移动端写在一个项目中，这里就涉及到了多平台分离打包</p>\n<h3 id="文件目录"><a href="#%E6%96%87%E4%BB%B6%E7%9B%AE%E5%BD%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>文件目录</h3>\n<p>总体上来说分为 3 个文件夹，分别是公用组件、移动端组件、桌面端组件</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2019-10-29-14-31-53-c4aeb4255948ae5e797400ba0e98a535-32723.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 355px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 147.88732394366195%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAeCAIAAACjcKk8AAAACXBIWXMAAAsSAAALEgHS3X78AAACmklEQVQ4y42UW0/bQBCF8y+qAk3ixHfv2uv1fe3d9T0hFAIIQosQQmolVKH2tf35nbQ8JyvN67HPOfPNTmyb0muW3ogsq3Xb/6RZs6WjGZ7KTEDg0bjoRxIzP8wCmqMgWVpYUYxdP+4u7mjG87LmzVjw1nTJXEW8MJFh40z0w3YXxkUpuk+aeTY3pwtrrruHZ+L6qU8ZazfD5Y6JoR2vaCqyskuKxkbJ4ZmAMky5XF2vbp5kdzFe3LWr7eXt4/nlPaYlCosDM1laYDtuR/zynRV85QXRyVSHzqcL+3hmKNawg1zw7e46jMukEIgkhu0rtQ1i2yNpNYrVLRQmmlG2q33buqsiRpYTxa2//VbnrE+ZgKqVIbGwg6Jq6Pkg44xnZW04AewPRokwRGK5vnNwJZoBPFteeKaZKpDubWtGOG7wj5/S9Zlox7xqIHkle/ju4eT7wiwnoLIZvzwEJOP1kLG9fxymR50Dnthx8Tz+rDWvUZSUcgC8S9lD8qPOJwtYlYNQ/1A9/0nTQnZrkJ3MDMVVYc1EhGQd7xImGW8DmgEnRwO/i6cmJrpV60vK6pK3jHftsHEwPW4b7vnjDK1b69eL48e1bAe4aqhKcVVYt0nJi5qTICppwmhSGo6vCglspb96pPng+vTD6eJ0ZsBVwahkRguA5By/vnGARLZjxmomuqJqlCCBk4xkvf66IzQHtkAGhJO4UILE9bCWbJfdWxwnVQ1gDvCSQWwVSJDrkLms/IcblgvZr+G34FapsH+E+UY1hrfPhCSiXcEDriko38WW7fnNvXz6XRQV4Ak9Kb4H/wlDQFhnmgnvQA1XUXdrB6kQBmId5dTbCs9PqqKqo6yCxwwKO75nwPNkjjeDC3hG+dCN53DSinj+BeEUOu5irNURAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2019 10 29 14 31 53" title="" data-src="/static/2019-10-29-14-31-53-c4aeb4255948ae5e797400ba0e98a535-32723.png" data-srcset="/static/2019-10-29-14-31-53-c4aeb4255948ae5e797400ba0e98a535-d1052.png 200w,\n/static/2019-10-29-14-31-53-c4aeb4255948ae5e797400ba0e98a535-32723.png 355w" data-sizes="(max-width: 355px) 100vw, 355px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h3 id="优化环境变量配置"><a href="#%E4%BC%98%E5%8C%96%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E9%85%8D%E7%BD%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>优化环境变量配置</h3>\n<p>将所有的环境变量整合到一个文件</p>\n<p>boot\\internals\\scripts\\get-build-map.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="90902007995337330000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const path = require(\'path\');\nconst prodEnv = process.env.PROD_ENV || \'pc\';\nconst globalJSON = require(path.resolve(process.cwd(), \'global.json\'));\n\nconst varsEnv = process.env.SERVER || \'master\';\nconst globalVars = globalJSON.runtime[varsEnv];\n\nconst RESOLVE_MODULES_MAP = {\n  pc: [\'src/common\', \'src/pc\', \'node_modules\'],\n  mobile: [\'src/common\', \'src/mobile\', \'node_modules\']\n};\n\nconst OUTPUT_PATH_MAP = {\n  pc: \'build/pc\',\n  mobile: \'build/mobile\'\n};\n\nconst resolveModules = RESOLVE_MODULES_MAP[prodEnv];\nconst outputPath = OUTPUT_PATH_MAP[prodEnv];\n\nconst INDEX_ENTRY_MAP = {\n  pc: \'src/pc/index.js\',\n  mobile: \'src/mobile/index.js\'\n};\n\nconst INDEX_HTML_MAP = {\n  pc: \'src/pc/index.html\',\n  mobile: \'src/mobile/index.html\'\n};\n\nconst indexEntry = INDEX_ENTRY_MAP[prodEnv];\nconst indexHtml = INDEX_HTML_MAP[prodEnv];\n\nmodule.exports = {\n  resolveModules,\n  outputPath,\n  indexEntry,\n  indexHtml,\n  globalVars\n};`, `90902007995337330000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'path\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> prodEnv <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PROD_ENV</span> <span class="token operator">||</span> <span class="token string">\'pc\'</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> globalJSON <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">\'global.json\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> varsEnv <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">SERVER</span> <span class="token operator">||</span> <span class="token string">\'master\'</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> globalVars <span class="token operator">=</span> globalJSON<span class="token punctuation">.</span>runtime<span class="token punctuation">[</span>varsEnv<span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token constant">RESOLVE_MODULES_MAP</span> <span class="token operator">=</span> <span class="token punctuation">{</span>\n  pc<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'src/common\'</span><span class="token punctuation">,</span> <span class="token string">\'src/pc\'</span><span class="token punctuation">,</span> <span class="token string">\'node_modules\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n  mobile<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'src/common\'</span><span class="token punctuation">,</span> <span class="token string">\'src/mobile\'</span><span class="token punctuation">,</span> <span class="token string">\'node_modules\'</span><span class="token punctuation">]</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token constant">OUTPUT_PATH_MAP</span> <span class="token operator">=</span> <span class="token punctuation">{</span>\n  pc<span class="token punctuation">:</span> <span class="token string">\'build/pc\'</span><span class="token punctuation">,</span>\n  mobile<span class="token punctuation">:</span> <span class="token string">\'build/mobile\'</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> resolveModules <span class="token operator">=</span> <span class="token constant">RESOLVE_MODULES_MAP</span><span class="token punctuation">[</span>prodEnv<span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> outputPath <span class="token operator">=</span> <span class="token constant">OUTPUT_PATH_MAP</span><span class="token punctuation">[</span>prodEnv<span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token constant">INDEX_ENTRY_MAP</span> <span class="token operator">=</span> <span class="token punctuation">{</span>\n  pc<span class="token punctuation">:</span> <span class="token string">\'src/pc/index.js\'</span><span class="token punctuation">,</span>\n  mobile<span class="token punctuation">:</span> <span class="token string">\'src/mobile/index.js\'</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token constant">INDEX_HTML_MAP</span> <span class="token operator">=</span> <span class="token punctuation">{</span>\n  pc<span class="token punctuation">:</span> <span class="token string">\'src/pc/index.html\'</span><span class="token punctuation">,</span>\n  mobile<span class="token punctuation">:</span> <span class="token string">\'src/mobile/index.html\'</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> indexEntry <span class="token operator">=</span> <span class="token constant">INDEX_ENTRY_MAP</span><span class="token punctuation">[</span>prodEnv<span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> indexHtml <span class="token operator">=</span> <span class="token constant">INDEX_HTML_MAP</span><span class="token punctuation">[</span>prodEnv<span class="token punctuation">]</span><span class="token punctuation">;</span>\n\nmodule<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>\n  resolveModules<span class="token punctuation">,</span>\n  outputPath<span class="token punctuation">,</span>\n  indexEntry<span class="token punctuation">,</span>\n  indexHtml<span class="token punctuation">,</span>\n  globalVars\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="使用环境变量进行分离打包"><a href="#%E4%BD%BF%E7%94%A8%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E8%BF%9B%E8%A1%8C%E5%88%86%E7%A6%BB%E6%89%93%E5%8C%85" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用环境变量进行分离打包</h3>\n<p>boot\\internals\\webpack\\webpack.base.babel.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="28029662132565414000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const buildMap = require(\'../scripts/get-build-map\');\n\noutput: Object.assign({ // Compile into js/build.js\n // 根据环境变量输出到不同平台\n path: path.resolve(process.cwd(), buildMap.outputPath),\n publicPath: \\`\\${buildMap.globalVars.customerServiceOrigin}/im/\\`,\n}, options.output), // Merge with env dependent settings\n\nresolve: {\n  // 根据环境变量决定相对路径的查找方式\n  modules: buildMap.resolveModules,\n},`, `28029662132565414000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> buildMap <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'../scripts/get-build-map\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\noutput<span class="token punctuation">:</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token comment">// Compile into js/build.js</span>\n <span class="token comment">// 根据环境变量输出到不同平台</span>\n path<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> buildMap<span class="token punctuation">.</span>outputPath<span class="token punctuation">)</span><span class="token punctuation">,</span>\n publicPath<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>buildMap<span class="token punctuation">.</span>globalVars<span class="token punctuation">.</span>customerServiceOrigin<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/im/</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span> options<span class="token punctuation">.</span>output<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// Merge with env dependent settings</span>\n\nresolve<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 根据环境变量决定相对路径的查找方式</span>\n  modules<span class="token punctuation">:</span> buildMap<span class="token punctuation">.</span>resolveModules<span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>以下都是根据环境变量输出到不同平台的文件夹下</p>\n<p>boot\\internals\\webpack\\webpack.dev.babel.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="46200370207116026000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const buildMap = require(\'../scripts/get-build-map\');\n\n// Add hot reloading in development\nentry: [\n  \'eventsource-polyfill\', // Necessary for hot reloading with IE\n  \'webpack-hot-middleware/client?reload=true\',\n  path.join(process.cwd(), buildMap.indexEntry), // Start with src/index.js\n],\n\nnew HtmlWebpackPlugin({\n   inject: true, // Inject all files that are generated by webpack, e.g. bundle.js\n   template: buildMap.indexHtml,\n}),`, `46200370207116026000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> buildMap <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'../scripts/get-build-map\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// Add hot reloading in development</span>\nentry<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n  <span class="token string">\'eventsource-polyfill\'</span><span class="token punctuation">,</span> <span class="token comment">// Necessary for hot reloading with IE</span>\n  <span class="token string">\'webpack-hot-middleware/client?reload=true\'</span><span class="token punctuation">,</span>\n  path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> buildMap<span class="token punctuation">.</span>indexEntry<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// Start with src/index.js</span>\n<span class="token punctuation">]</span><span class="token punctuation">,</span>\n\n<span class="token keyword">new</span> <span class="token class-name">HtmlWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n   inject<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// Inject all files that are generated by webpack, e.g. bundle.js</span>\n   template<span class="token punctuation">:</span> buildMap<span class="token punctuation">.</span>indexHtml<span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>boot\\internals\\webpack\\webpack.prod.babel.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="71893067131568620000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const buildMap = require(\'../scripts/get-build-map\');\n\nentry: {\n   bundle: [\'runtime/polyfill\', path.join(process.cwd(), buildMap.indexEntry)],\n},\n\nnew HtmlWebpackPlugin({\n  template: buildMap.indexHtml,\n  minify: {\n    removeComments: true,\n    collapseWhitespace: true,\n    removeRedundantAttributes: true,\n    useShortDoctype: true,\n    removeEmptyAttributes: true,\n    removeStyleLinkTypeAttributes: true,\n    keepClosingSlash: true,\n    minifyJS: true,\n    minifyCSS: true,\n    minifyURLs: true,\n  },\n  inject: true,\n}),`, `71893067131568620000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> buildMap <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'../scripts/get-build-map\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nentry<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n   bundle<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'runtime/polyfill\'</span><span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> buildMap<span class="token punctuation">.</span>indexEntry<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span>\n\n<span class="token keyword">new</span> <span class="token class-name">HtmlWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n  template<span class="token punctuation">:</span> buildMap<span class="token punctuation">.</span>indexHtml<span class="token punctuation">,</span>\n  minify<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    removeComments<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n    collapseWhitespace<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n    removeRedundantAttributes<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n    useShortDoctype<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n    removeEmptyAttributes<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n    removeStyleLinkTypeAttributes<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n    keepClosingSlash<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n    minifyJS<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n    minifyCSS<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n    minifyURLs<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  inject<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="优化打包脚本"><a href="#%E4%BC%98%E5%8C%96%E6%89%93%E5%8C%85%E8%84%9A%E6%9C%AC" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>优化打包脚本</h3>\n<h4 id="优化编译脚本"><a href="#%E4%BC%98%E5%8C%96%E7%BC%96%E8%AF%91%E8%84%9A%E6%9C%AC" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>优化编译脚本</h4>\n<p>以下是其中一个脚本，主要是根据参数传递来进行打包</p>\n<p>boot/scripts/build.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="95802483910955630000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const shelljs = require(\'shelljs\');\nconst argv = require(\'yargs\').argv;\nconst \\$_SERVER = argv.server || \'master\';\nconst \\$_NODE_ENV = argv.env || \'production\';\nconst \\$_PROD_ENV = argv.prod || \'pc\';\n\nshelljs.exec(\n  \\`rimraf ./build/\\${\\$_PROD_ENV}/* && cross-env NODE_ENV=\\${\\$_NODE_ENV} SERVER=\\${\\$_SERVER} PROD_ENV=\\${\\$_PROD_ENV} webpack --config boot/internals/webpack/webpack.prod.babel.js --color --progress\\`,\n  { stdio: \'inherit\' }\n);`, `95802483910955630000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> shelljs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'shelljs\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> argv <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'yargs\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>argv<span class="token punctuation">;</span>\n<span class="token keyword">const</span> $_SERVER <span class="token operator">=</span> argv<span class="token punctuation">.</span>server <span class="token operator">||</span> <span class="token string">\'master\'</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> $_NODE_ENV <span class="token operator">=</span> argv<span class="token punctuation">.</span>env <span class="token operator">||</span> <span class="token string">\'production\'</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> $_PROD_ENV <span class="token operator">=</span> argv<span class="token punctuation">.</span>prod <span class="token operator">||</span> <span class="token string">\'pc\'</span><span class="token punctuation">;</span>\n\nshelljs<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>\n  <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">rimraf ./build/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>$_PROD_ENV<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/* &amp;&amp; cross-env NODE_ENV=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>$_NODE_ENV<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> SERVER=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>$_SERVER<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> PROD_ENV=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>$_PROD_ENV<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> webpack --config boot/internals/webpack/webpack.prod.babel.js --color --progress</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n  <span class="token punctuation">{</span> stdio<span class="token punctuation">:</span> <span class="token string">\'inherit\'</span> <span class="token punctuation">}</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="多平台并行编译"><a href="#%E5%A4%9A%E5%B9%B3%E5%8F%B0%E5%B9%B6%E8%A1%8C%E7%BC%96%E8%AF%91" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>多平台并行编译</h4>\n<p>采用 concurrently 三方库进行多平台的编译，唯一的缺点就是进度会刷屏，暂时未找到解决方案</p>\n<p>global.json</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="31690406251392900000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`&quot;APPS&quot;: {\n &quot;dev&quot;: [\n   &quot;pc&quot;, &quot;mobile&quot;\n ],\n}`, `31690406251392900000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token string">"APPS"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>\n <span class="token string">"dev"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>\n   <span class="token string">"pc"</span><span class="token punctuation">,</span> <span class="token string">"mobile"</span>\n <span class="token punctuation">]</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>boot\\scripts\\pre-build.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="26515805271342297000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const shelljs = require(\'shelljs\');\nconst argv = require(\'yargs\').argv;\nconst path = require(\'path\');\nconst \\$_SERVER = argv.server || \'master\';\nconst APPS = require(path.resolve(process.cwd(), \'global.json\')).APPS[\\$_SERVER];\n\nconsole.log(\\`build environment: \\${\\$_SERVER}\\`, \\`build apps: \\${APPS}\\`);\n\nconst cmd = APPS.map((APP) => \\`&quot;node boot/scripts/build --server=\\${\\$_SERVER} --prod=\\${APP}&quot;\\`);\n\n// 进度输出刷屏，待优化\n// https://github.com/kimmobrunfeldt/concurrently/issues/188\n// https://github.com/kimmobrunfeldt/concurrently/issues/85\nshelljs.exec(\\`concurrently \\${cmd.join(\' \')}\\`, { stdio: \'inherit\' });`, `26515805271342297000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> shelljs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'shelljs\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> argv <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'yargs\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>argv<span class="token punctuation">;</span>\n<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'path\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> $_SERVER <span class="token operator">=</span> argv<span class="token punctuation">.</span>server <span class="token operator">||</span> <span class="token string">\'master\'</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> <span class="token constant">APPS</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">\'global.json\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token constant">APPS</span><span class="token punctuation">[</span>$_SERVER<span class="token punctuation">]</span><span class="token punctuation">;</span>\n\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">build environment: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>$_SERVER<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">build apps: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">APPS</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> cmd <span class="token operator">=</span> <span class="token constant">APPS</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token constant">APP</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">"node boot/scripts/build --server=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>$_SERVER<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> --prod=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">APP</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 进度输出刷屏，待优化</span>\n<span class="token comment">// https://github.com/kimmobrunfeldt/concurrently/issues/188</span>\n<span class="token comment">// https://github.com/kimmobrunfeldt/concurrently/issues/85</span>\nshelljs<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">concurrently </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>cmd<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">\' \'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">{</span> stdio<span class="token punctuation">:</span> <span class="token string">\'inherit\'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这里调用会并行编译 pc、mobile 两个平台的代码</p>\n<p>package.json</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="94974148154631000000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`&quot;scripts&quot;: {\n &quot;build:dev&quot;: &quot;node boot/scripts/pre-build --server=dev&quot;,\n}`, `94974148154631000000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="json"\n              >\n                <span class="gatsby-code-button-language">json</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="json"><pre style="counter-reset: linenumber NaN" class="language-json line-numbers"><code class="language-json"><span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n <span class="token property">"build:dev"</span><span class="token operator">:</span> <span class="token string">"node boot/scripts/pre-build --server=dev"</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>编译速度：2 个平台同时编译的情况下第一次 30~40s，第二次 8~10s</p>\n<h2 id="分离打包的-nginx-配置"><a href="#%E5%88%86%E7%A6%BB%E6%89%93%E5%8C%85%E7%9A%84-nginx-%E9%85%8D%E7%BD%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>分离打包的 nginx 配置</h2>\n<h3 id="nginx-配置"><a href="#nginx-%E9%85%8D%E7%BD%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>nginx 配置</h3>\n<p>由于之前第三方平台只用引入一个文件，这里的异步加载需要引入不止一个文件，所以要改下 nginx 配置，这里和主产品在一个域名下，故这里用前缀 /im/ 来代表加载客服组件</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="15914376519188390000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`set \\$root_dir &quot;/home/frontend/pony/pc/&quot;;\n# 根据 \\$http_user_agent 来判断加载哪个目录下的脚本\nif ( \\$http_user_agent ~ &quot;(MIDP)|(WAP)|(UP.Browser)|(Smartphone)|(Obigo)|(Mobile)|(AU.Browser)|(wxd.Mms)|(WxdB.Browser)|(CLDC)|(UP.Link)|(KM.Browser)|(UCWEB)|(SEMC-Browser)|(Mini)|(Symbian)|(Palm)|(Nokia)|(Panasonic)|(MOT-)|(SonyEricsson)|(NEC-)|(Alcatel)|(Ericsson)|(BENQ)|(BenQ)|(Amoisonic)|(Amoi-)|(Capitel)|(PHILIPS)|(SAMSUNG)|(Lenovo)|(Mitsu)|(Motorola)|(SHARP)|(WAPPER)|(LG-)|(LG/)|(EG900)|(CECT)|(Compal)|(kejian)|(Bird)|(BIRD)|(G900/V1.0)|(Arima)|(CTL)|(TDG)|(Daxian)|(DAXIAN)|(DBTEL)|(Eastcom)|(EASTCOM)|(PANTECH)|(Dopod)|(Haier)|(HAIER)|(KONKA)|(KEJIAN)|(LENOVO)|(Soutec)|(SOUTEC)|(SAGEM)|(SEC-)|(SED-)|(EMOL-)|(INNO55)|(ZTE)|(iPhone)|(Android)|(Windows CE)|(Wget)|(Java)|(curl)|(Opera)&quot; )\n{\n   set \\$root_dir &quot;/home/frontend/pony/mobile/&quot;;\n}\n\n# 不缓存 bundle.js 入口文件，防止页面刷新后不是最新代码\nlocation = /im/bundle.js {\n   expires -1;\n   add_header Pragma no-cache;\n   alias &quot;\\${root_dir}/bundle.js&quot;;\n}\n\n# 其他文件照常做缓存处理，并映射到 /im 路径\nlocation ^~ /im {\n alias \\$root_dir;\n}`, `15914376519188390000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token builtin class-name">set</span> <span class="token variable">$root_dir</span> <span class="token string">"/home/frontend/pony/pc/"</span><span class="token punctuation">;</span>\n<span class="token comment"># 根据 $http_user_agent 来判断加载哪个目录下的脚本</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token variable">$http_user_agent</span> ~ <span class="token string">"(MIDP)|(WAP)|(UP.Browser)|(Smartphone)|(Obigo)|(Mobile)|(AU.Browser)|(wxd.Mms)|(WxdB.Browser)|(CLDC)|(UP.Link)|(KM.Browser)|(UCWEB)|(SEMC-Browser)|(Mini)|(Symbian)|(Palm)|(Nokia)|(Panasonic)|(MOT-)|(SonyEricsson)|(NEC-)|(Alcatel)|(Ericsson)|(BENQ)|(BenQ)|(Amoisonic)|(Amoi-)|(Capitel)|(PHILIPS)|(SAMSUNG)|(Lenovo)|(Mitsu)|(Motorola)|(SHARP)|(WAPPER)|(LG-)|(LG/)|(EG900)|(CECT)|(Compal)|(kejian)|(Bird)|(BIRD)|(G900/V1.0)|(Arima)|(CTL)|(TDG)|(Daxian)|(DAXIAN)|(DBTEL)|(Eastcom)|(EASTCOM)|(PANTECH)|(Dopod)|(Haier)|(HAIER)|(KONKA)|(KEJIAN)|(LENOVO)|(Soutec)|(SOUTEC)|(SAGEM)|(SEC-)|(SED-)|(EMOL-)|(INNO55)|(ZTE)|(iPhone)|(Android)|(Windows CE)|(Wget)|(Java)|(curl)|(Opera)"</span> <span class="token punctuation">)</span>\n<span class="token punctuation">{</span>\n   <span class="token builtin class-name">set</span> <span class="token variable">$root_dir</span> <span class="token string">"/home/frontend/pony/mobile/"</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment"># 不缓存 bundle.js 入口文件，防止页面刷新后不是最新代码</span>\nlocation <span class="token operator">=</span> /im/bundle.js <span class="token punctuation">{</span>\n   expires -1<span class="token punctuation">;</span>\n   add_header Pragma no-cache<span class="token punctuation">;</span>\n   <span class="token builtin class-name">alias</span> <span class="token string">"<span class="token variable">${root_dir}</span>/bundle.js"</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment"># 其他文件照常做缓存处理，并映射到 /im 路径</span>\nlocation ^~ /im <span class="token punctuation">{</span>\n <span class="token builtin class-name">alias</span> <span class="token variable">$root_dir</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="webpack-配合修改"><a href="#webpack-%E9%85%8D%E5%90%88%E4%BF%AE%E6%94%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>webpack 配合修改</h3>\n<p>webpack 也需要做下 public 的映射，否则资源访问不到，注意这里的 <code class="language-text">buildMap.globalVars.customerServiceOrigin</code> 代表主产品的域名</p>\n<p>webpack.base.babel.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="36915967431435485000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`output: Object.assign({\n path: path.resolve(process.cwd(), buildMap.outputPath),\n publicPath: \\`\\${buildMap.globalVars.customerServiceOrigin}/im/\\`,\n}, options.output),`, `36915967431435485000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">output<span class="token punctuation">:</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n path<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> buildMap<span class="token punctuation">.</span>outputPath<span class="token punctuation">)</span><span class="token punctuation">,</span>\n publicPath<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>buildMap<span class="token punctuation">.</span>globalVars<span class="token punctuation">.</span>customerServiceOrigin<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/im/</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span> options<span class="token punctuation">.</span>output<span class="token punctuation">)</span><span class="token punctuation">,</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="代码分层"><a href="#%E4%BB%A3%E7%A0%81%E5%88%86%E5%B1%82" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>代码分层</h2>\n<p>这里主要对 IM 层、消息提醒功能做了分层。其他的桌面与移动端复用率不高，没有分层</p>\n<h3 id="im-层"><a href="#im-%E5%B1%82" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>IM 层</h3>\n<p>主要把所有与第三方提供商、调用后台的接口整合到一个类中，各种消息的回调采用消息订阅的方式进行分发调用</p>\n<h3 id="消息提醒类"><a href="#%E6%B6%88%E6%81%AF%E6%8F%90%E9%86%92%E7%B1%BB" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>消息提醒类</h3>\n<p>将公共的消息提醒逻辑抽成一个类</p>\n<p>src\\common\\utils\\TitleMessage\\index.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="23781502100802277000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import utils from \'utils\';\nimport { filePrefix } from \'containers/App/constants\';\n\nimport tungeeLogo from \'./images/tungee-logo.jpg\';\n\nclass TitleMessage {\n  constructor() {\n    // 闪烁前标题\n    this.originTitle = document.title;\n    // 计数\n    this.count = 0;\n    // 计时器\n    this.timer = null;\n    // 提示音\n    this.alertPlayer = document.createElement(\'audio\');\n    this.alertPlayer.src = \\`\\${filePrefix}message_alert.wav\\`;\n    this.alertPlayer.style.display = \'none\';\n    document.body.appendChild(this.alertPlayer);\n  }\n\n  start(msg) {\n    // 提示音\n    this.alertPlayer.play();\n    // 网页提示\n    utils.showNotification(msg, {\n      icon: tungeeLogo\n    });\n    this.stop();\n    this.timer = setInterval(() => {\n      if (this.count % 2 === 0) {\n        document.title = msg;\n      } else {\n        document.title = this.originTitle;\n      }\n      this.count += 1;\n    }, 1000);\n  }\n\n  stop() {\n    if (this.timer) {\n      clearInterval(this.timer);\n      this.timer = null;\n      this.count = 0;\n    }\n    document.title = this.originTitle;\n  }\n}\n\nexport default TitleMessage;`, `23781502100802277000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> utils <span class="token keyword">from</span> <span class="token string">\'utils\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> filePrefix <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'containers/App/constants\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> tungeeLogo <span class="token keyword">from</span> <span class="token string">\'./images/tungee-logo.jpg\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">class</span> <span class="token class-name">TitleMessage</span> <span class="token punctuation">{</span>\n  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 闪烁前标题</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>originTitle <span class="token operator">=</span> document<span class="token punctuation">.</span>title<span class="token punctuation">;</span>\n    <span class="token comment">// 计数</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n    <span class="token comment">// 计时器</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>timer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n    <span class="token comment">// 提示音</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>alertPlayer <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">\'audio\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>alertPlayer<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>filePrefix<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">message_alert.wav</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>alertPlayer<span class="token punctuation">.</span>style<span class="token punctuation">.</span>display <span class="token operator">=</span> <span class="token string">\'none\'</span><span class="token punctuation">;</span>\n    document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>alertPlayer<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token function">start</span><span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 提示音</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>alertPlayer<span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// 网页提示</span>\n    utils<span class="token punctuation">.</span><span class="token function">showNotification</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n      icon<span class="token punctuation">:</span> tungeeLogo\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>timer <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>count <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        document<span class="token punctuation">.</span>title <span class="token operator">=</span> msg<span class="token punctuation">;</span>\n      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n        document<span class="token punctuation">.</span>title <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>originTitle<span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>count <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>timer<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token function">clearInterval</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>timer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    document<span class="token punctuation">.</span>title <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>originTitle<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> TitleMessage<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="小程序部署代理配置"><a href="#%E5%B0%8F%E7%A8%8B%E5%BA%8F%E9%83%A8%E7%BD%B2%E4%BB%A3%E7%90%86%E9%85%8D%E7%BD%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>小程序部署代理配置</h2>\n<p>小程序用到 webview 限制了接口调用必须是第三方的域名，需要更改第三方域名指向的服务器配置</p>\n<p>这里以 nginx 为例：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="18440916477842006000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`location ^~ /im {\n  # 反代到组件所在的域名，并把参数传递过去\n  proxy_pass 组件所在的域名/im/\\$1;\n  # 传递 http_user_agent 参数，否则不能判断移动端\n  proxy_set_header User-Agent \\$http_user_agent;\n}`, `18440916477842006000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">location ^~ /im <span class="token punctuation">{</span>\n  <span class="token comment"># 反代到组件所在的域名，并把参数传递过去</span>\n  proxy_pass 组件所在的域名/im/<span class="token variable">$1</span><span class="token punctuation">;</span>\n  <span class="token comment"># 传递 http_user_agent 参数，否则不能判断移动端</span>\n  proxy_set_header User-Agent <span class="token variable">$http_user_agent</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="优化效果"><a href="#%E4%BC%98%E5%8C%96%E6%95%88%E6%9E%9C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>优化效果</h1>\n<h2 id="优化前"><a href="#%E4%BC%98%E5%8C%96%E5%89%8D" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>优化前</h2>\n<p>优化前包大小如下图，首页/全部加载大小都为 644.58kb。</p>\n<p>加载速度（不限速）540ms，3g low（限速 120 kb/s）40.75s。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2019-10-29-10-25-53-8b20855ed72ce2ed6a45384912e5bf50-72d75.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 48.645833333333336%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAAsSAAALEgHS3X78AAAB8ElEQVQoz02Q23OaQBjF/cf7kIe+tclDm5e00TGaaeoUDRhveNcoUVAKKkHRAeWOaLwiotiu6dTkzNnZnZ39zXf2eGZKy1lP7ZW5tTcn752tu3NeppNel223aEWWLGvt2BvbsnaODQzeLBYLj7Wcuntnt3fHuqKKvCoJ4nDQxDGaJBp1rFou8P3nIc/xg54iCl2GrJTSj0W090ya5tjz51UH1zVNVZGFTptkGGo06ivy0DA0XVfns6kiAbbNMo1yPgqHb2DIXynGDF39Dx8OjrN93V3X3YObjbVar5drsBZzQ5M4lmrUCun4XTJ6C5xJ/NRPMJDjODiOEwTR73OCINgbyxwbi/kMRCWJ0tMjmktBCOSPhK4joe9xOKgr4hts23aHYWiapiiKZVnLWk0mY3Os4VgWzCSwXCEdebi/QSAfDHkTyK0ujd7Htv+d3f0xtq6Jrd81ttPkui0cy1WL8WzqF2AeIv4o5ENjP/T3f56/gP5UQ5M1RRxwbUAOOKbH0vVqBph4ytcqaNB3cXX5MXD9Oeg9l+XRKfbB2ljL5bEhXZWq5WQ2FRZ4jmXITCJUKSWwcrKOZepYNgEHEMj75fyDwA/eJm/to0Dn4rBfyiP59H2bqsXhABq7y6FhADfrxWo5FfR+uvp69u3yTJKGfwHhi//sovwClwAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2019 10 29 10 25 53" title="" data-src="/static/2019-10-29-10-25-53-8b20855ed72ce2ed6a45384912e5bf50-fee1c.png" data-srcset="/static/2019-10-29-10-25-53-8b20855ed72ce2ed6a45384912e5bf50-a67b7.png 200w,\n/static/2019-10-29-10-25-53-8b20855ed72ce2ed6a45384912e5bf50-0b187.png 400w,\n/static/2019-10-29-10-25-53-8b20855ed72ce2ed6a45384912e5bf50-fee1c.png 800w,\n/static/2019-10-29-10-25-53-8b20855ed72ce2ed6a45384912e5bf50-b1a91.png 1200w,\n/static/2019-10-29-10-25-53-8b20855ed72ce2ed6a45384912e5bf50-95179.png 1600w,\n/static/2019-10-29-10-25-53-8b20855ed72ce2ed6a45384912e5bf50-72d75.png 1920w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2019-10-29-15-25-47-83d456e42382d76ff5c577d87768438d-ad506.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 38.81278538812785%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAAsSAAALEgHS3X78AAABAElEQVQY06VQyU7FMAzM//8PR36BC0I8Djxx6EaatE1jx1m6MG05gMSNUeTY8ow0Y5VLccbopun7vq7rqqru7x/3p+fm9da2rda66zqsjDHjOM6/ofZ9Z08Q9VobYw/SMAzWDBbfAMFw4vOEc857P/tvqMcH8/YypxKISURSSvtf2LZtXVfUc9ivRvXaeZK4QBUpCaVCMXMqKedlWUopVwVyziUXjuAIhhCCCkLEM/yEExwkiIzTxMxIBS/wPE0Tevgkosm5mQhpArMiZvIeayijyPXAw4gKMa5grUV0sEGD3p2AVbX/A4cYqZDnCB3jz+bqJeUUk/Q2c0DUK/11hS+BXMvDJjxvQAAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2019 10 29 15 25 47" title="" data-src="/static/2019-10-29-15-25-47-83d456e42382d76ff5c577d87768438d-fee1c.png" data-srcset="/static/2019-10-29-15-25-47-83d456e42382d76ff5c577d87768438d-a67b7.png 200w,\n/static/2019-10-29-15-25-47-83d456e42382d76ff5c577d87768438d-0b187.png 400w,\n/static/2019-10-29-15-25-47-83d456e42382d76ff5c577d87768438d-fee1c.png 800w,\n/static/2019-10-29-15-25-47-83d456e42382d76ff5c577d87768438d-ad506.png 1095w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2019-10-29-14-46-52-b9fc2bea404c217c6783fc4d7f8fed5c-74b93.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 31.74366616989568%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAIAAABM9SnKAAAACXBIWXMAAAsSAAALEgHS3X78AAAA5UlEQVQY01WQ627DIAyFef+3m7SpWidt1ZZmNBdCAr5gIJnR8qfmwzqAZR9hjuPYa50fdhqGvv/tuu7z8n6/flhrH7qsHcfRzW59jm1dnVtM/8PdjafBOTfrpUbY2puKGCMR/VczETOdudGkubz6t5fFBwJGoJOAGBEiYhLhlIgTpyZYRLWkVHQzmSRAHLzOA9qQAvISom/AsoVp8XpsbI1ZPQF+z9vdg/XBMCVEHRoTcxZRVGjb1IyRFkeIahIBEEGziNx8unr58mxKrY1SJecnSlGLEjEDasezrNacy76X9sk5/wHYZVboLupfhgAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2019 10 29 14 46 52" title="" data-src="/static/2019-10-29-14-46-52-b9fc2bea404c217c6783fc4d7f8fed5c-fee1c.png" data-srcset="/static/2019-10-29-14-46-52-b9fc2bea404c217c6783fc4d7f8fed5c-a67b7.png 200w,\n/static/2019-10-29-14-46-52-b9fc2bea404c217c6783fc4d7f8fed5c-0b187.png 400w,\n/static/2019-10-29-14-46-52-b9fc2bea404c217c6783fc4d7f8fed5c-fee1c.png 800w,\n/static/2019-10-29-14-46-52-b9fc2bea404c217c6783fc4d7f8fed5c-b1a91.png 1200w,\n/static/2019-10-29-14-46-52-b9fc2bea404c217c6783fc4d7f8fed5c-74b93.png 1342w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h2 id="优化后"><a href="#%E4%BC%98%E5%8C%96%E5%90%8E" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>优化后</h2>\n<h3 id="桌面端"><a href="#%E6%A1%8C%E9%9D%A2%E7%AB%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>桌面端</h3>\n<p>优化后，首页加载 107.08kb，全部加载 356.46kb。</p>\n<p>加载速度（不限速） 246ms，3g low （限速 120 kb/s）7s。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2019-10-29-14-38-30-305c548c31530d4463db6a19592acb90-a0f42.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 48.42271293375394%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAAsSAAALEgHS3X78AAACNklEQVQoz2WP209SARzH+Tt6rZ7aury4HnqqLVdrqd1zri22VsEEq9mgFplT09IWyzZZcXB0IkWkYgQEHRBIhHO4g1yEIFoIR87hcD+icE7EQ7X87rfvvi+f/b5fBkEUarkQ1dyiaJqiG2Tux5pC6ZVKvdI3fhCExQACSFoZAQAPCCJiYBV4LX6R5PDL/KE8I08UyWqhSVGNJt2kabJYTMwvJOfk3+WKCPjWB8y280JqURl4JnQ9nli5x5vguZkD9SvXiwwURTGcqNXIarVGbtbJQmEdMqUNUMvjak1So1uHjD/1hhgo+3rnrm2Q94XVLxMujzzf7OzGGKVSCcMwvK08QZRyORRGMnZHBoYzDjjrQFCnK21acgkeGW+w9NdYEJs1dAs+cqp8+NgGg/4jqrWa3q5UQwaDV6MJ6HR+rTao+xzU60Mqlevh8Lvus+CFyyYO+wEX7jhe2nsw/D+8VangTg+OuHHEk3e2z+VFTVaEL5g70fXxXJ/6Yi+fZTvaU95zwP8XpujfcLVessbfW+NKa0Jpjiug8BwUnLfGFiHPrNYuklueqJCpvpvuXbtD+zq+7YAbZUd+ybihhgkznLU6UDOYnBYlxsSpKWFCMBzhDPjOcF8ae65iJy/B/9Ruw2SjGi36LLlPvpx9Ne0N4R5ZanomOiKJTo55uPddzK6ZQ/1OS2+qEUCcOz5vl6HsB0nyqSmtdqM2N7b8KjY+7r0tWhudjAwyTZ2nxfvZ4ZXzeCPstP8CuQTKZbxKTaYAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2019 10 29 14 38 30" title="" data-src="/static/2019-10-29-14-38-30-305c548c31530d4463db6a19592acb90-fee1c.png" data-srcset="/static/2019-10-29-14-38-30-305c548c31530d4463db6a19592acb90-a67b7.png 200w,\n/static/2019-10-29-14-38-30-305c548c31530d4463db6a19592acb90-0b187.png 400w,\n/static/2019-10-29-14-38-30-305c548c31530d4463db6a19592acb90-fee1c.png 800w,\n/static/2019-10-29-14-38-30-305c548c31530d4463db6a19592acb90-b1a91.png 1200w,\n/static/2019-10-29-14-38-30-305c548c31530d4463db6a19592acb90-95179.png 1600w,\n/static/2019-10-29-14-38-30-305c548c31530d4463db6a19592acb90-a0f42.png 1902w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2019-10-29-15-36-51-76bad9b2f4a3bacf13b387899b58a3c1-e4a38.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 34.08736349453978%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAAsSAAALEgHS3X78AAABA0lEQVQY021QW04DMRDbY3MZzsIR+IQfKhXRaneb50xek2QJTiu+wIqcxPJMPFnGGGTMbV23bbtcvs7nz8vb+3o64brvO1gpZa31/2FBMRPB5Zx1zuFM3oOZOfCEuSPF9AdxCXWwtCyp1FJq7cfRv4/J9zXRj9ZbaVXAHY4GHb7ej+XpZTy/yhiJcilF0NAnphgpZk5lSiI+hdUrxW4LRgfvQwox51yWPY3PzXmrkSveYY2dcQlfYa7Xq9aaiR1EInVTOWUm96G1oTBnjkz4FQwMHwowNd5DYyjQe+/SKnT0haG1JlWSVM08ixGMfxFCeDA2r6y5OVI2G/PI/wDOTQQRfgAJp45HUt77KQAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2019 10 29 15 36 51" title="" data-src="/static/2019-10-29-15-36-51-76bad9b2f4a3bacf13b387899b58a3c1-fee1c.png" data-srcset="/static/2019-10-29-15-36-51-76bad9b2f4a3bacf13b387899b58a3c1-a67b7.png 200w,\n/static/2019-10-29-15-36-51-76bad9b2f4a3bacf13b387899b58a3c1-0b187.png 400w,\n/static/2019-10-29-15-36-51-76bad9b2f4a3bacf13b387899b58a3c1-fee1c.png 800w,\n/static/2019-10-29-15-36-51-76bad9b2f4a3bacf13b387899b58a3c1-b1a91.png 1200w,\n/static/2019-10-29-15-36-51-76bad9b2f4a3bacf13b387899b58a3c1-e4a38.png 1282w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2019-10-29-15-38-36-4eda10460f371165682ad3333d6223ee-166cd.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 37.20728534258456%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAAsSAAALEgHS3X78AAABGElEQVQY001Q7W7DIAzMo+4h97PPME390WnqtC6pugSS8GliTAKZqVStJ2TdYRt8bvZ910KMfT8MQ9d117b9fDv+vB9/21ZI2fe9lHKeZ2OMfYJzVk664WajtRjEf5rJnXvv+ZIfVUqFBwDgQUJtxkgQIG/bXkrOuZTChFkV97htW34CKz5c0by8lsNlKzk5TB4JIsc4OPAxhZhYBlqhkppySAulvKZIlNatOVz2080E75YYMUYPoLQ2zjkAOY7TNGvDttiFU0qDB2Hcl7SZcMWljm31JEX1zN6maeSK6gygu16ts5RoVopXMAyC4mKRPkb/bfDmqcllR0TwFfwfR5bxPoXVBsNCGINzuCy8JEp1ZkI8m3i26x9Z342LPyArdgAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2019 10 29 15 38 36" title="" data-src="/static/2019-10-29-15-38-36-4eda10460f371165682ad3333d6223ee-fee1c.png" data-srcset="/static/2019-10-29-15-38-36-4eda10460f371165682ad3333d6223ee-a67b7.png 200w,\n/static/2019-10-29-15-38-36-4eda10460f371165682ad3333d6223ee-0b187.png 400w,\n/static/2019-10-29-15-38-36-4eda10460f371165682ad3333d6223ee-fee1c.png 800w,\n/static/2019-10-29-15-38-36-4eda10460f371165682ad3333d6223ee-166cd.png 1153w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h3 id="移动端"><a href="#%E7%A7%BB%E5%8A%A8%E7%AB%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>移动端</h3>\n<p>优化后，首页加载 105.89kb，全部加载 306.3kb。</p>\n<p>加载速度（不限速）236ms，3g low（限速 120 kb/s）6.98s。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2019-10-29-15-40-29-6b6ffe8870f8db08fa92e1a991c41bb4-c3264.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 48.454688318491364%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAAsSAAALEgHS3X78AAACLElEQVQoz2WR3U9SARjG+Wf6A7pok3lTa627WtLUlWuGAw1lwNxcGFg6kSA+jthFBRMRQUSPWcSHIIgnioOCgMCBwznEOJRaCK44TtnoEGZX9Ox99179nj3PXtrJjyRVP6OoBkX9rp9WimlbBn6NhfVoSJeGtUhQm4bfYGGD2ZBXKUrPJYhoFJZJMUD53Wk/pp2dklSToxoXU0wtoZ9keEi955fFfFIcVmNBJR6aNuqz0klifCytkKOAEn8mJub1JVqpdESSJ9VqlSTJWq1WiOvRLVHcOwatDu84hGhgAtl8ErGxP3qx+bmjkWF8bfXQbitxH2GSCZxWLpePz1VpbtMiH9UhvpGY+3HgrSADiRC/KGwbCIK9oAV9KjroZiBiYYE/mGM+yJgXDmiNf6IuDr6tiTrY8XVezMVNePhBsGdz4a7PeHvRkFApCNlUjsNG73Ume3vSs9r9Vji3Mx13shJu7t76YNLDC1gYq0CbFbgOLsVNpqJl8SunP9vZkexipGaAb61wAlJ4TfehZRZk7QuA/T7jHRCga8RXzdrUS3lFMrrf14kybkTplz9PjqOtcBZWb79j7to5kQ8DUccQtNgBqq9IBG3L8PZckHixlhW8irI0+akZzL2O/Rc7pIrZmX9jD513Xum2qtp1U9fkua2Hh7s3CxtdqEf5qxFKJ+p5pBUmkpYM1HzPaMzFj7l44fdMp+6WfbZbmvXTI/ZLG4b2Fa2w2vChX34SxB86lbnYVroPKgAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2019 10 29 15 40 29" title="" data-src="/static/2019-10-29-15-40-29-6b6ffe8870f8db08fa92e1a991c41bb4-fee1c.png" data-srcset="/static/2019-10-29-15-40-29-6b6ffe8870f8db08fa92e1a991c41bb4-a67b7.png 200w,\n/static/2019-10-29-15-40-29-6b6ffe8870f8db08fa92e1a991c41bb4-0b187.png 400w,\n/static/2019-10-29-15-40-29-6b6ffe8870f8db08fa92e1a991c41bb4-fee1c.png 800w,\n/static/2019-10-29-15-40-29-6b6ffe8870f8db08fa92e1a991c41bb4-b1a91.png 1200w,\n/static/2019-10-29-15-40-29-6b6ffe8870f8db08fa92e1a991c41bb4-95179.png 1600w,\n/static/2019-10-29-15-40-29-6b6ffe8870f8db08fa92e1a991c41bb4-c3264.png 1909w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2019-10-29-15-43-18-75b859b8c2e7c6163baa46a51125975f-7169a.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 34.113712374581944%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAAsSAAALEgHS3X78AAABCklEQVQY01VQ2Y7EIAzr/3/haHdfVhq2FxDCDQE6oaN5WAuqKsaWnSXnnEI4hTj3fdv35/P5J4R4PLbvn+M4pJTrum7bBgD4H8bgcl1X710bMMaUG5UvUaHKvvwfQ7DWppSoMiZbP3iLWyUW1DEGEbXRqfGsj94LM71Rm8PaiPqkJttHa22KU2nonUuRTWNONgYMKeZcchZwrii1BRUQo0cfXczgwmRLWdjOhDpbae2c4zJaaYvIUTUA1zcaLFp1StCgpMwpSTS/oKMPC0enWgyo+73l5qxn2xgjeyklBwemYiy+rSsRHw74ZdblXkL1nnNPsP7znRO0HnyBE7zUyTteIfvOReaCwb8A0POQo574wEAAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2019 10 29 15 43 18" title="" data-src="/static/2019-10-29-15-43-18-75b859b8c2e7c6163baa46a51125975f-fee1c.png" data-srcset="/static/2019-10-29-15-43-18-75b859b8c2e7c6163baa46a51125975f-a67b7.png 200w,\n/static/2019-10-29-15-43-18-75b859b8c2e7c6163baa46a51125975f-0b187.png 400w,\n/static/2019-10-29-15-43-18-75b859b8c2e7c6163baa46a51125975f-fee1c.png 800w,\n/static/2019-10-29-15-43-18-75b859b8c2e7c6163baa46a51125975f-7169a.png 1196w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2019-10-29-15-44-43-c1d53694445726683314f4116e6d30c9-29961.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 36.02329450915141%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAAsSAAALEgHS3X78AAABA0lEQVQY002Q227DIAxA8//ftodJUx87bavWpCVAYi6+AMlMWk09ssA2vjJEJYAZp9mYaZp+Lpev8+f3x+n3fB6nzjiO1lrn3PoCwGqsH/Z937Zt8V4jACB0IADEQ9PKs2JmVXJOD/6VZ7KUIlVptT2l1EYsxIzECTMJH87a5XhttfZkqS0iBqSAHJEhE+SH2SWR+JR9ihEJEoaEQrgJM9OwtbrkMt3u6+Jz7hN57/r8ALrIeL1659SjWDtrzBLC23V9N7jEPGiFIuKs7jVrlDF6W9SGOes33Y3RAfUD/FFA27PIimIznxwOIqI2MfU5XlC/nrgCQdBTEOVAO7VSahFA+QMRLY/Rs7j+3gAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2019 10 29 15 44 43" title="" data-src="/static/2019-10-29-15-44-43-c1d53694445726683314f4116e6d30c9-fee1c.png" data-srcset="/static/2019-10-29-15-44-43-c1d53694445726683314f4116e6d30c9-a67b7.png 200w,\n/static/2019-10-29-15-44-43-c1d53694445726683314f4116e6d30c9-0b187.png 400w,\n/static/2019-10-29-15-44-43-c1d53694445726683314f4116e6d30c9-fee1c.png 800w,\n/static/2019-10-29-15-44-43-c1d53694445726683314f4116e6d30c9-b1a91.png 1200w,\n/static/2019-10-29-15-44-43-c1d53694445726683314f4116e6d30c9-29961.png 1202w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h1 id="优化总结"><a href="#%E4%BC%98%E5%8C%96%E6%80%BB%E7%BB%93" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>优化总结</h1>\n<p>待优化的点：组件化复用做的不够好、以原生方式写客服组件体积会更小等等</p>',
id:"/home/runner/work/GatsbyBlog/GatsbyBlog/blog/构建多平台轻量化组件的实践/index.md absPath of file >>> MarkdownRemark",timeToRead:12,frontmatter:{date:"2019-10-29 09:51:53",path:"/building-platform-lightweight-components/",tags:"前端, 组件轻量化, webpack, 预研, 前端构建工具",title:"构建多平台轻量化组件的实践",draft:null}},{excerpt:"接上文  Webpack 升级优化——记一次产品端升级 最近需要开发一个新产品，此时需要一个新框架来承载新产品的开发，根据前端主管的建议，建议我在他已经开发出的新框架上进行改造，这里记录一下改造的关键点 babel 编译兼容 IE 在 .babelrc 文件里加上标红代码，防止 ie 某些方法报错 脚本运行颜色 在将 npm script 写成 nodejs 脚本时，脚本颜色是灰色，此时需要加上 参数 webpack 加速构建 在 webpack.base.babel.js 文件中添加 hard…",html:'<p>接上文 <a href="/webpack-upgrade-about-product/">Webpack 升级优化——记一次产品端升级</a></p>\n<p>最近需要开发一个新产品，此时需要一个新框架来承载新产品的开发，根据前端主管的建议，建议我在他已经开发出的新框架上进行改造，这里记录一下改造的关键点</p>\n<h1 id="babel-编译兼容-ie"><a href="#babel-%E7%BC%96%E8%AF%91%E5%85%BC%E5%AE%B9-ie" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>babel 编译兼容 IE</h1>\n<p>在 .babelrc 文件里加上标红代码，防止 ie 某些方法报错</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="2564221224623741400"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`{\n  &quot;env&quot;: {\n    &quot;production&quot;: {\n      &quot;only&quot;: [\n        &quot;src&quot;,\n        &quot;unicorn&quot;\n      ],\n      &quot;plugins&quot;: [\n        &quot;transform-react-remove-prop-types&quot;,\n        &quot;transform-react-constant-elements&quot;,\n        &quot;transform-react-inline-elements&quot;\n      ]\n    },\n  },\n  &quot;plugins&quot;: [\n    [\n      &quot;import&quot;,\n      {\n        &quot;libraryName&quot;: &quot;antd&quot;,\n        &quot;libraryDirectory&quot;: &quot;es&quot;,\n        &quot;style&quot;: true\n      }\n    ],\n    &quot;transform-decorators-legacy&quot;,\n    &quot;lodash&quot;\n  ],\n  &quot;presets&quot;: [\n    [\n      &quot;latest&quot;,\n      {\n        &quot;es2015&quot;: {\n          &quot;modules&quot;: false\n        }\n      }\n    ],\n    &quot;es2015-ie&quot;,\n    &quot;react&quot;,\n    &quot;stage-0&quot;\n  ]\n}`, `2564221224623741400`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{36}"\n              >\n                <span class="gatsby-code-button-language">js{36}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token punctuation">{</span>\n  <span class="token string">"env"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    <span class="token string">"production"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>\n      <span class="token string">"only"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>\n        <span class="token string">"src"</span><span class="token punctuation">,</span>\n        <span class="token string">"unicorn"</span>\n      <span class="token punctuation">]</span><span class="token punctuation">,</span>\n      <span class="token string">"plugins"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>\n        <span class="token string">"transform-react-remove-prop-types"</span><span class="token punctuation">,</span>\n        <span class="token string">"transform-react-constant-elements"</span><span class="token punctuation">,</span>\n        <span class="token string">"transform-react-inline-elements"</span>\n      <span class="token punctuation">]</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token string">"plugins"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>\n    <span class="token punctuation">[</span>\n      <span class="token string">"import"</span><span class="token punctuation">,</span>\n      <span class="token punctuation">{</span>\n        <span class="token string">"libraryName"</span><span class="token punctuation">:</span> <span class="token string">"antd"</span><span class="token punctuation">,</span>\n        <span class="token string">"libraryDirectory"</span><span class="token punctuation">:</span> <span class="token string">"es"</span><span class="token punctuation">,</span>\n        <span class="token string">"style"</span><span class="token punctuation">:</span> <span class="token boolean">true</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">]</span><span class="token punctuation">,</span>\n    <span class="token string">"transform-decorators-legacy"</span><span class="token punctuation">,</span>\n    <span class="token string">"lodash"</span>\n  <span class="token punctuation">]</span><span class="token punctuation">,</span>\n  <span class="token string">"presets"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>\n    <span class="token punctuation">[</span>\n      <span class="token string">"latest"</span><span class="token punctuation">,</span>\n      <span class="token punctuation">{</span>\n        <span class="token string">"es2015"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>\n          <span class="token string">"modules"</span><span class="token punctuation">:</span> <span class="token boolean">false</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">]</span><span class="token punctuation">,</span>\n<span class="gatsby-highlight-code-line">    <span class="token string">"es2015-ie"</span><span class="token punctuation">,</span></span>    <span class="token string">"react"</span><span class="token punctuation">,</span>\n    <span class="token string">"stage-0"</span>\n  <span class="token punctuation">]</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="脚本运行颜色"><a href="#%E8%84%9A%E6%9C%AC%E8%BF%90%E8%A1%8C%E9%A2%9C%E8%89%B2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>脚本运行颜色</h1>\n<p>在将 npm script 写成 nodejs 脚本时，脚本颜色是灰色，此时需要加上<code class="language-text">--color</code>参数</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="38866959455368670000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const shelljs = require(\'shelljs\');\n\nshelljs.exec(\'cross-env NODE_ENV=development node boot/internals/scripts/analyze.js --color\', {\n  stdio: \'inherit\'\n});`, `38866959455368670000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{3}"\n              >\n                <span class="gatsby-code-button-language">js{3}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> shelljs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'shelljs\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line">shelljs<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">\'cross-env NODE_ENV=development node boot/internals/scripts/analyze.js --color\'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>  stdio<span class="token punctuation">:</span> <span class="token string">\'inherit\'</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="webpack-加速构建"><a href="#webpack-%E5%8A%A0%E9%80%9F%E6%9E%84%E5%BB%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>webpack 加速构建</h1>\n<p>在 webpack.base.babel.js 文件中添加 hard-source-webpack-plugin 插件，启用了之后构建速度由第二次的 30~40s 缩短到第二次的 3~5s 左右</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="32011214266263278000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`new HardSourceWebpackPlugin({\n  // Either an absolute path or relative to webpack\'s options.context.\n  cacheDirectory: path.resolve(process.cwd(), \'node_modules/.cache/hard-source/[confighash]\'),\n  // Either a string of object hash function given a webpack config.\n  configHash(webpackConfig) {\n    // node-object-hash on npm can be used to build this.\n    return require(\'node-object-hash\')({ sort: false }).hash({\n      webpackConfig,\n      globalVars,\n    });\n  },\n  // Either false, a string, an object, or a project hashing function.\n  environmentHash: {\n    root: process.cwd(),\n    directories: [],\n    files: [\'package-lock.json\', \'yarn.lock\'],\n  },\n  // An object.\n  info: {\n    // \'none\' or \'test\'.\n    mode: \'none\',\n    // \'debug\', \'log\', \'info\', \'warn\', or \'error\'.\n    level: \'debug\',\n  },\n  // Clean up large, old caches automatically.\n  cachePrune: {\n    // Caches younger than \\`maxAge\\` are not considered for deletion. They must\n    // be at least this (default: 2 days) old in milliseconds.\n    maxAge: 2 * 24 * 60 * 60 * 1000,\n    // All caches together must be larger than \\`sizeThreshold\\` before any\n    // caches will be deleted. Together they must be at least this\n    // (default: 50 MB) big in bytes.\n    sizeThreshold: 50 * 1024 * 1024,\n  },\n}),\n\n// 这里会对 svg 生成造成影响，暂时关闭\n// You can optionally exclude items that may not be working with HardSource\n// or items with custom loaders while you are actively developing the\n// loader.\n// new HardSourceWebpackPlugin.ExcludeModulePlugin([\n//   {\n//     // HardSource works with mini-css-extract-plugin but due to how\n//     // mini-css emits assets, assets are not emitted on repeated builds with\n//     // mini-css and hard-source together. Ignoring the mini-css loader\n//     // modules, but not the other css loader modules, excludes the modules\n//     // that mini-css needs rebuilt to output assets every time.\n//     test: /mini-css-extract-plugin[\\\\/]dist[\\\\/]loader/,\n//   },\n// ]),`, `32011214266263278000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">new</span> <span class="token class-name">HardSourceWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n  <span class="token comment">// Either an absolute path or relative to webpack\'s options.context.</span>\n  cacheDirectory<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">\'node_modules/.cache/hard-source/[confighash]\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n  <span class="token comment">// Either a string of object hash function given a webpack config.</span>\n  <span class="token function">configHash</span><span class="token punctuation">(</span><span class="token parameter">webpackConfig</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// node-object-hash on npm can be used to build this.</span>\n    <span class="token keyword">return</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'node-object-hash\'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">{</span> sort<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n      webpackConfig<span class="token punctuation">,</span>\n      globalVars<span class="token punctuation">,</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token comment">// Either false, a string, an object, or a project hashing function.</span>\n  environmentHash<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    root<span class="token punctuation">:</span> process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    directories<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n    files<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'package-lock.json\'</span><span class="token punctuation">,</span> <span class="token string">\'yarn.lock\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token comment">// An object.</span>\n  info<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    <span class="token comment">// \'none\' or \'test\'.</span>\n    mode<span class="token punctuation">:</span> <span class="token string">\'none\'</span><span class="token punctuation">,</span>\n    <span class="token comment">// \'debug\', \'log\', \'info\', \'warn\', or \'error\'.</span>\n    level<span class="token punctuation">:</span> <span class="token string">\'debug\'</span><span class="token punctuation">,</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token comment">// Clean up large, old caches automatically.</span>\n  cachePrune<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    <span class="token comment">// Caches younger than `maxAge` are not considered for deletion. They must</span>\n    <span class="token comment">// be at least this (default: 2 days) old in milliseconds.</span>\n    maxAge<span class="token punctuation">:</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">,</span>\n    <span class="token comment">// All caches together must be larger than `sizeThreshold` before any</span>\n    <span class="token comment">// caches will be deleted. Together they must be at least this</span>\n    <span class="token comment">// (default: 50 MB) big in bytes.</span>\n    sizeThreshold<span class="token punctuation">:</span> <span class="token number">50</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">,</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n\n<span class="token comment">// 这里会对 svg 生成造成影响，暂时关闭</span>\n<span class="token comment">// You can optionally exclude items that may not be working with HardSource</span>\n<span class="token comment">// or items with custom loaders while you are actively developing the</span>\n<span class="token comment">// loader.</span>\n<span class="token comment">// new HardSourceWebpackPlugin.ExcludeModulePlugin([</span>\n<span class="token comment">//   {</span>\n<span class="token comment">//     // HardSource works with mini-css-extract-plugin but due to how</span>\n<span class="token comment">//     // mini-css emits assets, assets are not emitted on repeated builds with</span>\n<span class="token comment">//     // mini-css and hard-source together. Ignoring the mini-css loader</span>\n<span class="token comment">//     // modules, but not the other css loader modules, excludes the modules</span>\n<span class="token comment">//     // that mini-css needs rebuilt to output assets every time.</span>\n<span class="token comment">//     test: /mini-css-extract-plugin[\\\\/]dist[\\\\/]loader/,</span>\n<span class="token comment">//   },</span>\n<span class="token comment">// ]),</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="webpack-进度显示异常"><a href="#webpack-%E8%BF%9B%E5%BA%A6%E6%98%BE%E7%A4%BA%E5%BC%82%E5%B8%B8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>webpack 进度显示异常</h1>\n<p>在 npm run build 执行时 simple-progress-webpack-plugin 插件会不停的刷屏显示，造成不好的体验，所以暂时只把它写在 webpack.dev.babel.js 中</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="40841655892639040000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`new SimpleProgressWebpackPlugin({\n  format: \'minimal\',\n}),`, `40841655892639040000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">new</span> <span class="token class-name">SimpleProgressWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n  format<span class="token punctuation">:</span> <span class="token string">\'minimal\'</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<h1 id="lodash-插件优化异常"><a href="#lodash-%E6%8F%92%E4%BB%B6%E4%BC%98%E5%8C%96%E5%BC%82%E5%B8%B8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>lodash 插件优化异常</h1>\n<p>在开启 lodash-webpack-plugin 插件后，lodash.get 不能正常执行，加入 <code class="language-text">paths: true</code> 即可</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="98858450394389560000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// Deep property path support for methods like _.get, _.has, & _.set.\n// lodash优化由592.53k到240k\nnew LodashModuleReplacementPlugin({\n  paths: true,\n}),`, `98858450394389560000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// Deep property path support for methods like _.get, _.has, &amp; _.set.</span>\n<span class="token comment">// lodash优化由592.53k到240k</span>\n<span class="token keyword">new</span> <span class="token class-name">LodashModuleReplacementPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n  paths<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>以上更新于<code class="language-text">2019-9-17 20:43:04</code></p>\n<hr>\n<h1 id="react-loadable-优化"><a href="#react-loadable-%E4%BC%98%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>react-loadable 优化</h1>\n<h2 id="withref-方法报错"><a href="#withref-%E6%96%B9%E6%B3%95%E6%8A%A5%E9%94%99" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>withRef 方法报错</h2>\n<p>当 react-loadable 应用到组件为 function 类型，此时 withRef 方法会报错，因为 function 组件是没有 ref 的，此时要做下兼容处理</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="38676229792049365000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import React from \'react\';\nimport Loadable from \'react-loadable\';\n\nconst LoaderCache = new Map();\nexport default function loadComponent(loader, options) {\n  let component = LoaderCache.get(loader);\n  if (!component) {\n    component = Loadable({\n      loader,\n      loading: (props) => {\n        if (props.error) {\n          // eslint-disable-line\n          if (window.location.host.indexOf(\'-dev\') >= 0 && window.TURKEY && window.TURKEY.getProperty(\'serverUpdate\')) {\n            window.TURKEY.run(\'serverUpdate\');\n          }\n          console.error(\'[chunk loader]\', props.error); // eslint-disable-line\n        }\n        return <div />;\n      },\n      render: (loaded, props) => {\n        const Component = loaded.default;\n        const { withRef, ...rest } = props; // eslint-disable-line\n        const { isPureReactComponent, isReactComponent } = Component.prototype;\n        let refProps = null;\n        if (isPureReactComponent || isReactComponent) {\n          refProps = {\n            ref: (r) => {\n              withRef && withRef(r);\n            }\n          };\n        }\n        return <Component {...refProps} {...rest} />;\n      },\n      ...options\n    });\n    LoaderCache.set(loader, component);\n    // component.preload();\n  }\n  return component;\n}`, `38676229792049365000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{21-32}"\n              >\n                <span class="gatsby-code-button-language">js{21-32}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> Loadable <span class="token keyword">from</span> <span class="token string">\'react-loadable\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> LoaderCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">loadComponent</span><span class="token punctuation">(</span><span class="token parameter">loader<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">let</span> component <span class="token operator">=</span> LoaderCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>loader<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>component<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    component <span class="token operator">=</span> <span class="token function">Loadable</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n      loader<span class="token punctuation">,</span>\n      <span class="token function-variable function">loading</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>props<span class="token punctuation">.</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          <span class="token comment">// eslint-disable-line</span>\n          <span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>host<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">\'-dev\'</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> window<span class="token punctuation">.</span><span class="token constant">TURKEY</span> <span class="token operator">&amp;&amp;</span> window<span class="token punctuation">.</span><span class="token constant">TURKEY</span><span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">\'serverUpdate\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            window<span class="token punctuation">.</span><span class="token constant">TURKEY</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token string">\'serverUpdate\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token punctuation">}</span>\n          console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">\'[chunk loader]\'</span><span class="token punctuation">,</span> props<span class="token punctuation">.</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// eslint-disable-line</span>\n        <span class="token punctuation">}</span>\n        <span class="token keyword">return</span> <span class="token operator">&lt;</span>div <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      <span class="token function-variable function">render</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">loaded<span class="token punctuation">,</span> props</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n<span class="gatsby-highlight-code-line">        <span class="token keyword">const</span> Component <span class="token operator">=</span> loaded<span class="token punctuation">.</span>default<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">        <span class="token keyword">const</span> <span class="token punctuation">{</span> withRef<span class="token punctuation">,</span> <span class="token operator">...</span>rest <span class="token punctuation">}</span> <span class="token operator">=</span> props<span class="token punctuation">;</span> <span class="token comment">// eslint-disable-line</span></span><span class="gatsby-highlight-code-line">        <span class="token keyword">const</span> <span class="token punctuation">{</span> isPureReactComponent<span class="token punctuation">,</span> isReactComponent <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token class-name">Component</span><span class="token punctuation">.</span>prototype<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">        <span class="token keyword">let</span> refProps <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>isPureReactComponent <span class="token operator">||</span> isReactComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">          refProps <span class="token operator">=</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">            <span class="token function-variable function">ref</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">r</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">              withRef <span class="token operator">&amp;&amp;</span> <span class="token function">withRef</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">            <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">          <span class="token punctuation">}</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">        <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">        <span class="token keyword">return</span> <span class="token operator">&lt;</span>Component <span class="token punctuation">{</span><span class="token operator">...</span>refProps<span class="token punctuation">}</span> <span class="token punctuation">{</span><span class="token operator">...</span>rest<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">;</span></span>      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      <span class="token operator">...</span>options\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    LoaderCache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>loader<span class="token punctuation">,</span> component<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// component.preload();</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">return</span> component<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="阻止-setstate"><a href="#%E9%98%BB%E6%AD%A2-setstate" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>阻止 setState</h2>\n<p>因为组件卸载时继续网络请求会导致 setState 报错，因为采用的是 promise 方法，不能取消请求，所以需要在卸载时将 setState 置空，以下分别针对页面、组件级别将其置空</p>\n<h3 id="页面级别"><a href="#%E9%A1%B5%E9%9D%A2%E7%BA%A7%E5%88%AB" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>页面级别</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="3086133319740636000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`/* eslint-disable no-param-reassign */\nimport React from \'react\';\nimport Loadable from \'react-loadable\';\n\nconst LoaderCache = new Map();\nexport default function loadComponent(loader, options) {\n  let component = LoaderCache.get(loader);\n  if (!component) {\n    component = Loadable({\n      loader,\n      loading: (props) => {\n        if (props.error) {\n          // eslint-disable-line\n          if (window.location.host.indexOf(\'-dev\') >= 0 && window.TURKEY && window.TURKEY.getProperty(\'serverUpdate\')) {\n            window.TURKEY.run(\'serverUpdate\');\n          }\n          console.error(\'[chunk loader]\', props.error); // eslint-disable-line\n        }\n        return <div />;\n      },\n      render: (loaded, props) => {\n        const Component = loaded.default;\n        const { withRef, ...rest } = props; // eslint-disable-line\n        let refProps = null;\n        // 只有 PureReactComponent 和 ReactComponent 才有生命周期，注意在 react-hook 的情况下 Component.prototype 为空\n        if (Component.prototype && (Component.prototype.isPureReactComponent || Component.prototype.isReactComponent)) {\n          refProps = {\n            ref: (r) => {\n              withRef && withRef(r);\n              if (!r) {\n                return;\n              }\n              const cb = r.componentWillUnmount;\n              r.componentWillUnmount = () => {\n                r.setState = () => {\n                  // eslint-disable-next-line no-useless-return\n                  return;\n                };\n                cb && cb.call(r);\n              };\n            }\n          };\n        }\n        return <Component {...refProps} {...rest} />;\n      },\n      ...options\n    });\n    LoaderCache.set(loader, component);\n    // component.preload();\n  }\n  return component;\n}`, `3086133319740636000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{29-40}"\n              >\n                <span class="gatsby-code-button-language">js{29-40}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">/* eslint-disable no-param-reassign */</span>\n<span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> Loadable <span class="token keyword">from</span> <span class="token string">\'react-loadable\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> LoaderCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">loadComponent</span><span class="token punctuation">(</span><span class="token parameter">loader<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">let</span> component <span class="token operator">=</span> LoaderCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>loader<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>component<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    component <span class="token operator">=</span> <span class="token function">Loadable</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n      loader<span class="token punctuation">,</span>\n      <span class="token function-variable function">loading</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>props<span class="token punctuation">.</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          <span class="token comment">// eslint-disable-line</span>\n          <span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>host<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">\'-dev\'</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> window<span class="token punctuation">.</span><span class="token constant">TURKEY</span> <span class="token operator">&amp;&amp;</span> window<span class="token punctuation">.</span><span class="token constant">TURKEY</span><span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">\'serverUpdate\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            window<span class="token punctuation">.</span><span class="token constant">TURKEY</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token string">\'serverUpdate\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token punctuation">}</span>\n          console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">\'[chunk loader]\'</span><span class="token punctuation">,</span> props<span class="token punctuation">.</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// eslint-disable-line</span>\n        <span class="token punctuation">}</span>\n        <span class="token keyword">return</span> <span class="token operator">&lt;</span>div <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      <span class="token function-variable function">render</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">loaded<span class="token punctuation">,</span> props</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token keyword">const</span> Component <span class="token operator">=</span> loaded<span class="token punctuation">.</span>default<span class="token punctuation">;</span>\n        <span class="token keyword">const</span> <span class="token punctuation">{</span> withRef<span class="token punctuation">,</span> <span class="token operator">...</span>rest <span class="token punctuation">}</span> <span class="token operator">=</span> props<span class="token punctuation">;</span> <span class="token comment">// eslint-disable-line</span>\n        <span class="token keyword">let</span> refProps <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n        <span class="token comment">// 只有 PureReactComponent 和 ReactComponent 才有生命周期，注意在 react-hook 的情况下 Component.prototype 为空</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Component</span><span class="token punctuation">.</span>prototype <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token class-name">Component</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>isPureReactComponent <span class="token operator">||</span> <span class="token class-name">Component</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>isReactComponent<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          refProps <span class="token operator">=</span> <span class="token punctuation">{</span>\n            <span class="token function-variable function">ref</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">r</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n<span class="gatsby-highlight-code-line">              withRef <span class="token operator">&amp;&amp;</span> <span class="token function">withRef</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">              <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>r<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">                <span class="token keyword">return</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">              <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">              <span class="token keyword">const</span> cb <span class="token operator">=</span> r<span class="token punctuation">.</span>componentWillUnmount<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">              r<span class="token punctuation">.</span><span class="token function-variable function">componentWillUnmount</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">                r<span class="token punctuation">.</span><span class="token function-variable function">setState</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">                  <span class="token comment">// eslint-disable-next-line no-useless-return</span></span><span class="gatsby-highlight-code-line">                  <span class="token keyword">return</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">                <span class="token punctuation">}</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">                cb <span class="token operator">&amp;&amp;</span> <span class="token function">cb</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">              <span class="token punctuation">}</span><span class="token punctuation">;</span></span>            <span class="token punctuation">}</span>\n          <span class="token punctuation">}</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n        <span class="token keyword">return</span> <span class="token operator">&lt;</span>Component <span class="token punctuation">{</span><span class="token operator">...</span>refProps<span class="token punctuation">}</span> <span class="token punctuation">{</span><span class="token operator">...</span>rest<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      <span class="token operator">...</span>options\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    LoaderCache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>loader<span class="token punctuation">,</span> component<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// component.preload();</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">return</span> component<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="组件级别"><a href="#%E7%BB%84%E4%BB%B6%E7%BA%A7%E5%88%AB" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>组件级别</h3>\n<p>src\\runtime\\preventSetState.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="75637136002169320000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import React from \'react\';\n\nexport default function preventSetState(WrappedComponent) {\n  return class Hoc extends React.PureComponent {\n    componentWillUnmount = () => {\n      this.wrappedComponent.setState = () => {\n        // eslint-disable-next-line no-useless-return\n        return;\n      };\n    };\n\n    render() {\n      return (\n        <WrappedComponent\n          ref={(r) => {\n            this.wrappedComponent = r;\n          }}\n          {...this.props}\n        />\n      );\n    }\n  };\n}`, `75637136002169320000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="jsx"\n              >\n                <span class="gatsby-code-button-language">jsx</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">preventSetState</span><span class="token punctuation">(</span><span class="token parameter">WrappedComponent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token keyword">class</span> <span class="token class-name">Hoc</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>PureComponent</span> <span class="token punctuation">{</span>\n    <span class="token function-variable function">componentWillUnmount</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>wrappedComponent<span class="token punctuation">.</span><span class="token function-variable function">setState</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token comment">// eslint-disable-next-line no-useless-return</span>\n        <span class="token keyword">return</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span> <span class="token punctuation">(</span>\n        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">WrappedComponent</span></span>\n          <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token parameter">r</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            <span class="token keyword">this</span><span class="token punctuation">.</span>wrappedComponent <span class="token operator">=</span> r<span class="token punctuation">;</span>\n          <span class="token punctuation">}</span><span class="token punctuation">}</span></span>\n          <span class="token spread"><span class="token punctuation">{</span><span class="token punctuation">...</span><span class="token attr-value">this</span><span class="token punctuation">.</span><span class="token attr-value">props</span><span class="token punctuation">}</span></span>\n        <span class="token punctuation">/></span></span>\n      <span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>调用时</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="2180483206423145000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import preventSetState from \'runtime/preventSetState\';\n\n@preventSetState\nexport default class Component extends React.PureComponent {}`, `2180483206423145000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> preventSetState <span class="token keyword">from</span> <span class="token string">\'runtime/preventSetState\'</span><span class="token punctuation">;</span>\n\n@preventSetState\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Component</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>PureComponent</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>或者</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="21203781005229040000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import preventSetState from \'runtime/preventSetState\';\n\nclass Component extends React.PureComponent {}\n\nexport default preventSetState(Component);`, `21203781005229040000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> preventSetState <span class="token keyword">from</span> <span class="token string">\'runtime/preventSetState\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">class</span> <span class="token class-name">Component</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>PureComponent</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">preventSetState</span><span class="token punctuation">(</span>Component<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>待拓展的功能：react-hook 替换 mobx、HTML 内实现 Loading 态或者骨架屏、动态 polyfill、编译到 ES2015+（提高运行效率）、LazyLoad、三方库 external 化</p>\n<h1 id="重置报错状态"><a href="#%E9%87%8D%E7%BD%AE%E6%8A%A5%E9%94%99%E7%8A%B6%E6%80%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>重置报错状态</h1>\n<p>单个组件报错时不影响其他页面的加载</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="9503923717292495000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import React, { Component } from \'react\';\nimport PropTypes from \'prop-types\';\n\nimport styles from \'./styles.css\';\n\nclass ErrorBoundary extends Component {\n  state = {\n    hasError: false\n  };\n\n  componentWillReceiveProps() {\n    // 重置未报错状态\n    this.setState({\n      hasError: false\n    });\n  }\n\n  componentDidCatch(error) {\n    this.setState({\n      hasError: true\n    });\n\n    console.error(error);\n    if (window.__bl) {\n      window.__bl.error(error);\n    }\n  }\n\n  render() {\n    if (this.state.hasError) {\n      return (\n        <div className={styles.error}>\n          <div className={styles.title}>抱歉，页面出错了！</div>\n        </div>\n      );\n    }\n    return this.props.children;\n  }\n}\n\nErrorBoundary.propTypes = {\n  children: PropTypes.node\n};\n\nexport default ErrorBoundary;`, `9503923717292495000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="jsx{11-16}"\n              >\n                <span class="gatsby-code-button-language">jsx{11-16}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> PropTypes <span class="token keyword">from</span> <span class="token string">\'prop-types\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> styles <span class="token keyword">from</span> <span class="token string">\'./styles.css\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">class</span> <span class="token class-name">ErrorBoundary</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>\n  state <span class="token operator">=</span> <span class="token punctuation">{</span>\n    hasError<span class="token punctuation">:</span> <span class="token boolean">false</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line">  <span class="token function">componentWillReceiveProps</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    <span class="token comment">// 重置未报错状态</span></span><span class="gatsby-highlight-code-line">    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      hasError<span class="token punctuation">:</span> <span class="token boolean">false</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span></span>\n  <span class="token function">componentDidCatch</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n      hasError<span class="token punctuation">:</span> <span class="token boolean">true</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>__bl<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      window<span class="token punctuation">.</span>__bl<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>hasError<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span> <span class="token punctuation">(</span>\n        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>error<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text"></span>\n<span class="token plain-text">          </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>title<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">抱歉，页面出错了！</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token plain-text"></span>\n<span class="token plain-text">        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>\n      <span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\nErrorBoundary<span class="token punctuation">.</span>propTypes <span class="token operator">=</span> <span class="token punctuation">{</span>\n  children<span class="token punctuation">:</span> PropTypes<span class="token punctuation">.</span>node\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> ErrorBoundary<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="stylelint-无效"><a href="#stylelint-%E6%97%A0%E6%95%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>stylelint 无效</h1>\n<p>package.json</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="54890768948253040000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`&quot;lint:css&quot;: &quot;stylelint src/**/*.css&quot;`, `54890768948253040000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token string">"lint:css"</span><span class="token builtin class-name">:</span> <span class="token string">"stylelint src/**/*.css"</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>当在苹果电脑上运行以上命令时，没有任何效果，即使 css 格式错误也直接通过，同时提交代码前的报错信息也没有颜色，需要做下特殊处理</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="12181429371478125000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`&quot;lint:css&quot;: &quot;stylelint \\&quot;src/**/*.css\\&quot; --color&quot; # src/**/*.css 双引号转义为了兼容苹果，--color 是为了执行 pre-commit 钩子即提交代码前也能让错误的信息有颜色\n&quot;lint&quot;: &quot;npm run lint:js && npm run lint:css&quot;,\n&quot;pre-commit&quot;: &quot;lint&quot;,`, `12181429371478125000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token string">"lint:css"</span><span class="token builtin class-name">:</span> <span class="token string">"stylelint <span class="token entity" title="\\&quot;">\\"</span>src/**/*.css<span class="token entity" title="\\&quot;">\\"</span> --color"</span> <span class="token comment"># src/**/*.css 双引号转义为了兼容苹果，--color 是为了执行 pre-commit 钩子即提交代码前也能让错误的信息有颜色</span>\n<span class="token string">"lint"</span><span class="token builtin class-name">:</span> <span class="token string">"npm run lint:js &amp;&amp; npm run lint:css"</span>,\n<span class="token string">"pre-commit"</span><span class="token builtin class-name">:</span> <span class="token string">"lint"</span>,</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>',
id:"/home/runner/work/GatsbyBlog/GatsbyBlog/blog/Webpack脚手架搭建笔记——记一次新项目搭建/index.md absPath of file >>> MarkdownRemark",timeToRead:6,frontmatter:{date:"2019-10-10 21:46:40",path:"/webpack-template-new-project/",tags:"前端, 前端构建工具, webpack, 预研",title:"Webpack脚手架搭建笔记——记一次新项目搭建",draft:null}}],length:13,tag:"webpack",pagesSum:3,page:2}}}});