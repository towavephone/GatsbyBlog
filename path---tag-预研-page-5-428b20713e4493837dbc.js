webpackJsonp([73561527382206],{1650:function(n,s){n.exports={data:{site:{siteMetadata:{title:"女王控的博客",description:'前端工程师，黑猫女王控，欢迎勾搭，技术相关<a href="https://github.com/towavephone" target="_blank">@towavephone</a>，QQ闲聊<a href="tencent://AddContact/?fromId=45&fromSubId=1&subcmd=all&uin=634407147&website=www.oicqzone.com">@towave</a>，bili关注<a href="https://space.bilibili.com/11507708#/" target="_blank">@towave</a>',siteUrl:"https://blog.towavephone.com"}}},pathContext:{posts:[{excerpt:"接上文  Webpack 升级优化——记一次产品端升级 最近需要开发一个新产品，此时需要一个新框架来承载新产品的开发，根据前端主管的建议，建议我在他已经开发出的新框架上进行改造，这里记录一下改造的关键点 babel 编译兼容 IE 在 .babelrc 文件里加上标红代码，防止 ie 某些方法报错 脚本运行颜色 在将 npm script 写成 nodejs 脚本时，脚本颜色是灰色，此时需要加上 参数 webpack 加速构建 在 webpack.base.babel.js 文件中添加 hard…",html:'<p>接上文 <a href="/webpack-upgrade-about-product/">Webpack 升级优化——记一次产品端升级</a></p>\n<p>最近需要开发一个新产品，此时需要一个新框架来承载新产品的开发，根据前端主管的建议，建议我在他已经开发出的新框架上进行改造，这里记录一下改造的关键点</p>\n<h1 id="babel-编译兼容-ie"><a href="#babel-%E7%BC%96%E8%AF%91%E5%85%BC%E5%AE%B9-ie" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>babel 编译兼容 IE</h1>\n<p>在 .babelrc 文件里加上标红代码，防止 ie 某些方法报错</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="74250145838391700000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`{\n  &quot;env&quot;: {\n    &quot;production&quot;: {\n      &quot;only&quot;: [\n        &quot;src&quot;,\n        &quot;unicorn&quot;\n      ],\n      &quot;plugins&quot;: [\n        &quot;transform-react-remove-prop-types&quot;,\n        &quot;transform-react-constant-elements&quot;,\n        &quot;transform-react-inline-elements&quot;\n      ]\n    },\n  },\n  &quot;plugins&quot;: [\n    [\n      &quot;import&quot;,\n      {\n        &quot;libraryName&quot;: &quot;antd&quot;,\n        &quot;libraryDirectory&quot;: &quot;es&quot;,\n        &quot;style&quot;: true\n      }\n    ],\n    &quot;transform-decorators-legacy&quot;,\n    &quot;lodash&quot;\n  ],\n  &quot;presets&quot;: [\n    [\n      &quot;latest&quot;,\n      {\n        &quot;es2015&quot;: {\n          &quot;modules&quot;: false\n        }\n      }\n    ],\n    &quot;es2015-ie&quot;,\n    &quot;react&quot;,\n    &quot;stage-0&quot;\n  ]\n}`, `74250145838391700000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{36}"\n              >\n                <span class="gatsby-code-button-language">js{36}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token punctuation">{</span>\n  <span class="token string">"env"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    <span class="token string">"production"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>\n      <span class="token string">"only"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>\n        <span class="token string">"src"</span><span class="token punctuation">,</span>\n        <span class="token string">"unicorn"</span>\n      <span class="token punctuation">]</span><span class="token punctuation">,</span>\n      <span class="token string">"plugins"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>\n        <span class="token string">"transform-react-remove-prop-types"</span><span class="token punctuation">,</span>\n        <span class="token string">"transform-react-constant-elements"</span><span class="token punctuation">,</span>\n        <span class="token string">"transform-react-inline-elements"</span>\n      <span class="token punctuation">]</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token string">"plugins"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>\n    <span class="token punctuation">[</span>\n      <span class="token string">"import"</span><span class="token punctuation">,</span>\n      <span class="token punctuation">{</span>\n        <span class="token string">"libraryName"</span><span class="token punctuation">:</span> <span class="token string">"antd"</span><span class="token punctuation">,</span>\n        <span class="token string">"libraryDirectory"</span><span class="token punctuation">:</span> <span class="token string">"es"</span><span class="token punctuation">,</span>\n        <span class="token string">"style"</span><span class="token punctuation">:</span> <span class="token boolean">true</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">]</span><span class="token punctuation">,</span>\n    <span class="token string">"transform-decorators-legacy"</span><span class="token punctuation">,</span>\n    <span class="token string">"lodash"</span>\n  <span class="token punctuation">]</span><span class="token punctuation">,</span>\n  <span class="token string">"presets"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>\n    <span class="token punctuation">[</span>\n      <span class="token string">"latest"</span><span class="token punctuation">,</span>\n      <span class="token punctuation">{</span>\n        <span class="token string">"es2015"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>\n          <span class="token string">"modules"</span><span class="token punctuation">:</span> <span class="token boolean">false</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">]</span><span class="token punctuation">,</span>\n<span class="gatsby-highlight-code-line">    <span class="token string">"es2015-ie"</span><span class="token punctuation">,</span></span>    <span class="token string">"react"</span><span class="token punctuation">,</span>\n    <span class="token string">"stage-0"</span>\n  <span class="token punctuation">]</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="脚本运行颜色"><a href="#%E8%84%9A%E6%9C%AC%E8%BF%90%E8%A1%8C%E9%A2%9C%E8%89%B2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>脚本运行颜色</h1>\n<p>在将 npm script 写成 nodejs 脚本时，脚本颜色是灰色，此时需要加上<code class="language-text">--color</code>参数</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="41056631645681430000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const shelljs = require(\'shelljs\');\n\nshelljs.exec(\'cross-env NODE_ENV=development node boot/internals/scripts/analyze.js --color\', {\n  stdio: \'inherit\'\n});`, `41056631645681430000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{3}"\n              >\n                <span class="gatsby-code-button-language">js{3}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> shelljs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'shelljs\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line">shelljs<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">\'cross-env NODE_ENV=development node boot/internals/scripts/analyze.js --color\'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>  stdio<span class="token punctuation">:</span> <span class="token string">\'inherit\'</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="webpack-加速构建"><a href="#webpack-%E5%8A%A0%E9%80%9F%E6%9E%84%E5%BB%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>webpack 加速构建</h1>\n<p>在 webpack.base.babel.js 文件中添加 hard-source-webpack-plugin 插件，启用了之后构建速度由第二次的 30~40s 缩短到第二次的 3~5s 左右</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="1528353595877818400"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`new HardSourceWebpackPlugin({\n  // Either an absolute path or relative to webpack\'s options.context.\n  cacheDirectory: path.resolve(process.cwd(), \'node_modules/.cache/hard-source/[confighash]\'),\n  // Either a string of object hash function given a webpack config.\n  configHash(webpackConfig) {\n    // node-object-hash on npm can be used to build this.\n    return require(\'node-object-hash\')({ sort: false }).hash({\n      webpackConfig,\n      globalVars,\n    });\n  },\n  // Either false, a string, an object, or a project hashing function.\n  environmentHash: {\n    root: process.cwd(),\n    directories: [],\n    files: [\'package-lock.json\', \'yarn.lock\'],\n  },\n  // An object.\n  info: {\n    // \'none\' or \'test\'.\n    mode: \'none\',\n    // \'debug\', \'log\', \'info\', \'warn\', or \'error\'.\n    level: \'debug\',\n  },\n  // Clean up large, old caches automatically.\n  cachePrune: {\n    // Caches younger than \\`maxAge\\` are not considered for deletion. They must\n    // be at least this (default: 2 days) old in milliseconds.\n    maxAge: 2 * 24 * 60 * 60 * 1000,\n    // All caches together must be larger than \\`sizeThreshold\\` before any\n    // caches will be deleted. Together they must be at least this\n    // (default: 50 MB) big in bytes.\n    sizeThreshold: 50 * 1024 * 1024,\n  },\n}),\n\n// 这里会对 svg 生成造成影响，暂时关闭\n// You can optionally exclude items that may not be working with HardSource\n// or items with custom loaders while you are actively developing the\n// loader.\n// new HardSourceWebpackPlugin.ExcludeModulePlugin([\n//   {\n//     // HardSource works with mini-css-extract-plugin but due to how\n//     // mini-css emits assets, assets are not emitted on repeated builds with\n//     // mini-css and hard-source together. Ignoring the mini-css loader\n//     // modules, but not the other css loader modules, excludes the modules\n//     // that mini-css needs rebuilt to output assets every time.\n//     test: /mini-css-extract-plugin[\\\\/]dist[\\\\/]loader/,\n//   },\n// ]),`, `1528353595877818400`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">new</span> <span class="token class-name">HardSourceWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n  <span class="token comment">// Either an absolute path or relative to webpack\'s options.context.</span>\n  cacheDirectory<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">\'node_modules/.cache/hard-source/[confighash]\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n  <span class="token comment">// Either a string of object hash function given a webpack config.</span>\n  <span class="token function">configHash</span><span class="token punctuation">(</span><span class="token parameter">webpackConfig</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// node-object-hash on npm can be used to build this.</span>\n    <span class="token keyword">return</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'node-object-hash\'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">{</span> sort<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n      webpackConfig<span class="token punctuation">,</span>\n      globalVars<span class="token punctuation">,</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token comment">// Either false, a string, an object, or a project hashing function.</span>\n  environmentHash<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    root<span class="token punctuation">:</span> process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    directories<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n    files<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'package-lock.json\'</span><span class="token punctuation">,</span> <span class="token string">\'yarn.lock\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token comment">// An object.</span>\n  info<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    <span class="token comment">// \'none\' or \'test\'.</span>\n    mode<span class="token punctuation">:</span> <span class="token string">\'none\'</span><span class="token punctuation">,</span>\n    <span class="token comment">// \'debug\', \'log\', \'info\', \'warn\', or \'error\'.</span>\n    level<span class="token punctuation">:</span> <span class="token string">\'debug\'</span><span class="token punctuation">,</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token comment">// Clean up large, old caches automatically.</span>\n  cachePrune<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    <span class="token comment">// Caches younger than `maxAge` are not considered for deletion. They must</span>\n    <span class="token comment">// be at least this (default: 2 days) old in milliseconds.</span>\n    maxAge<span class="token punctuation">:</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">,</span>\n    <span class="token comment">// All caches together must be larger than `sizeThreshold` before any</span>\n    <span class="token comment">// caches will be deleted. Together they must be at least this</span>\n    <span class="token comment">// (default: 50 MB) big in bytes.</span>\n    sizeThreshold<span class="token punctuation">:</span> <span class="token number">50</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">,</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n\n<span class="token comment">// 这里会对 svg 生成造成影响，暂时关闭</span>\n<span class="token comment">// You can optionally exclude items that may not be working with HardSource</span>\n<span class="token comment">// or items with custom loaders while you are actively developing the</span>\n<span class="token comment">// loader.</span>\n<span class="token comment">// new HardSourceWebpackPlugin.ExcludeModulePlugin([</span>\n<span class="token comment">//   {</span>\n<span class="token comment">//     // HardSource works with mini-css-extract-plugin but due to how</span>\n<span class="token comment">//     // mini-css emits assets, assets are not emitted on repeated builds with</span>\n<span class="token comment">//     // mini-css and hard-source together. Ignoring the mini-css loader</span>\n<span class="token comment">//     // modules, but not the other css loader modules, excludes the modules</span>\n<span class="token comment">//     // that mini-css needs rebuilt to output assets every time.</span>\n<span class="token comment">//     test: /mini-css-extract-plugin[\\\\/]dist[\\\\/]loader/,</span>\n<span class="token comment">//   },</span>\n<span class="token comment">// ]),</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="webpack-进度显示异常"><a href="#webpack-%E8%BF%9B%E5%BA%A6%E6%98%BE%E7%A4%BA%E5%BC%82%E5%B8%B8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>webpack 进度显示异常</h1>\n<p>在 npm run build 执行时 simple-progress-webpack-plugin 插件会不停的刷屏显示，造成不好的体验，所以暂时只把它写在 webpack.dev.babel.js 中</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="4457753096748118000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`new SimpleProgressWebpackPlugin({\n  format: \'minimal\',\n}),`, `4457753096748118000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">new</span> <span class="token class-name">SimpleProgressWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n  format<span class="token punctuation">:</span> <span class="token string">\'minimal\'</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<h1 id="lodash-插件优化异常"><a href="#lodash-%E6%8F%92%E4%BB%B6%E4%BC%98%E5%8C%96%E5%BC%82%E5%B8%B8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>lodash 插件优化异常</h1>\n<p>在开启 lodash-webpack-plugin 插件后，lodash.get 不能正常执行，加入 <code class="language-text">paths: true</code> 即可</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="1640605795204242000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// Deep property path support for methods like _.get, _.has, & _.set.\n// lodash优化由592.53k到240k\nnew LodashModuleReplacementPlugin({\n  paths: true,\n}),`, `1640605795204242000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// Deep property path support for methods like _.get, _.has, &amp; _.set.</span>\n<span class="token comment">// lodash优化由592.53k到240k</span>\n<span class="token keyword">new</span> <span class="token class-name">LodashModuleReplacementPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n  paths<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>以上更新于<code class="language-text">2019-9-17 20:43:04</code></p>\n<hr>\n<h1 id="react-loadable-优化"><a href="#react-loadable-%E4%BC%98%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>react-loadable 优化</h1>\n<h2 id="withref-方法报错"><a href="#withref-%E6%96%B9%E6%B3%95%E6%8A%A5%E9%94%99" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>withRef 方法报错</h2>\n<p>当 react-loadable 应用到组件为 function 类型，此时 withRef 方法会报错，因为 function 组件是没有 ref 的，此时要做下兼容处理</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="25032444508033660000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import React from \'react\';\nimport Loadable from \'react-loadable\';\n\nconst LoaderCache = new Map();\nexport default function loadComponent(loader, options) {\n  let component = LoaderCache.get(loader);\n  if (!component) {\n    component = Loadable({\n      loader,\n      loading: (props) => {\n        if (props.error) {\n          // eslint-disable-line\n          if (window.location.host.indexOf(\'-dev\') >= 0 && window.TURKEY && window.TURKEY.getProperty(\'serverUpdate\')) {\n            window.TURKEY.run(\'serverUpdate\');\n          }\n          console.error(\'[chunk loader]\', props.error); // eslint-disable-line\n        }\n        return <div />;\n      },\n      render: (loaded, props) => {\n        const Component = loaded.default;\n        const { withRef, ...rest } = props; // eslint-disable-line\n        const { isPureReactComponent, isReactComponent } = Component.prototype;\n        let refProps = null;\n        if (isPureReactComponent || isReactComponent) {\n          refProps = {\n            ref: (r) => {\n              withRef && withRef(r);\n            }\n          };\n        }\n        return <Component {...refProps} {...rest} />;\n      },\n      ...options\n    });\n    LoaderCache.set(loader, component);\n    // component.preload();\n  }\n  return component;\n}`, `25032444508033660000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{21-32}"\n              >\n                <span class="gatsby-code-button-language">js{21-32}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> Loadable <span class="token keyword">from</span> <span class="token string">\'react-loadable\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> LoaderCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">loadComponent</span><span class="token punctuation">(</span><span class="token parameter">loader<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">let</span> component <span class="token operator">=</span> LoaderCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>loader<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>component<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    component <span class="token operator">=</span> <span class="token function">Loadable</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n      loader<span class="token punctuation">,</span>\n      <span class="token function-variable function">loading</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>props<span class="token punctuation">.</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          <span class="token comment">// eslint-disable-line</span>\n          <span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>host<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">\'-dev\'</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> window<span class="token punctuation">.</span><span class="token constant">TURKEY</span> <span class="token operator">&amp;&amp;</span> window<span class="token punctuation">.</span><span class="token constant">TURKEY</span><span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">\'serverUpdate\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            window<span class="token punctuation">.</span><span class="token constant">TURKEY</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token string">\'serverUpdate\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token punctuation">}</span>\n          console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">\'[chunk loader]\'</span><span class="token punctuation">,</span> props<span class="token punctuation">.</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// eslint-disable-line</span>\n        <span class="token punctuation">}</span>\n        <span class="token keyword">return</span> <span class="token operator">&lt;</span>div <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      <span class="token function-variable function">render</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">loaded<span class="token punctuation">,</span> props</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n<span class="gatsby-highlight-code-line">        <span class="token keyword">const</span> Component <span class="token operator">=</span> loaded<span class="token punctuation">.</span>default<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">        <span class="token keyword">const</span> <span class="token punctuation">{</span> withRef<span class="token punctuation">,</span> <span class="token operator">...</span>rest <span class="token punctuation">}</span> <span class="token operator">=</span> props<span class="token punctuation">;</span> <span class="token comment">// eslint-disable-line</span></span><span class="gatsby-highlight-code-line">        <span class="token keyword">const</span> <span class="token punctuation">{</span> isPureReactComponent<span class="token punctuation">,</span> isReactComponent <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token class-name">Component</span><span class="token punctuation">.</span>prototype<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">        <span class="token keyword">let</span> refProps <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>isPureReactComponent <span class="token operator">||</span> isReactComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">          refProps <span class="token operator">=</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">            <span class="token function-variable function">ref</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">r</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">              withRef <span class="token operator">&amp;&amp;</span> <span class="token function">withRef</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">            <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">          <span class="token punctuation">}</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">        <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">        <span class="token keyword">return</span> <span class="token operator">&lt;</span>Component <span class="token punctuation">{</span><span class="token operator">...</span>refProps<span class="token punctuation">}</span> <span class="token punctuation">{</span><span class="token operator">...</span>rest<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">;</span></span>      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      <span class="token operator">...</span>options\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    LoaderCache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>loader<span class="token punctuation">,</span> component<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// component.preload();</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">return</span> component<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="阻止-setstate"><a href="#%E9%98%BB%E6%AD%A2-setstate" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>阻止 setState</h2>\n<p>因为组件卸载时继续网络请求会导致 setState 报错，因为采用的是 promise 方法，不能取消请求，所以需要在卸载时将 setState 置空，以下分别针对页面、组件级别将其置空</p>\n<h3 id="页面级别"><a href="#%E9%A1%B5%E9%9D%A2%E7%BA%A7%E5%88%AB" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>页面级别</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="28025286626726140000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`/* eslint-disable no-param-reassign */\nimport React from \'react\';\nimport Loadable from \'react-loadable\';\n\nconst LoaderCache = new Map();\nexport default function loadComponent(loader, options) {\n  let component = LoaderCache.get(loader);\n  if (!component) {\n    component = Loadable({\n      loader,\n      loading: (props) => {\n        if (props.error) {\n          // eslint-disable-line\n          if (window.location.host.indexOf(\'-dev\') >= 0 && window.TURKEY && window.TURKEY.getProperty(\'serverUpdate\')) {\n            window.TURKEY.run(\'serverUpdate\');\n          }\n          console.error(\'[chunk loader]\', props.error); // eslint-disable-line\n        }\n        return <div />;\n      },\n      render: (loaded, props) => {\n        const Component = loaded.default;\n        const { withRef, ...rest } = props; // eslint-disable-line\n        let refProps = null;\n        // 只有 PureReactComponent 和 ReactComponent 才有生命周期，注意在 react-hook 的情况下 Component.prototype 为空\n        if (Component.prototype && (Component.prototype.isPureReactComponent || Component.prototype.isReactComponent)) {\n          refProps = {\n            ref: (r) => {\n              withRef && withRef(r);\n              if (!r) {\n                return;\n              }\n              const cb = r.componentWillUnmount;\n              r.componentWillUnmount = () => {\n                r.setState = () => {\n                  // eslint-disable-next-line no-useless-return\n                  return;\n                };\n                cb && cb.call(r);\n              };\n            }\n          };\n        }\n        return <Component {...refProps} {...rest} />;\n      },\n      ...options\n    });\n    LoaderCache.set(loader, component);\n    // component.preload();\n  }\n  return component;\n}`, `28025286626726140000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{29-40}"\n              >\n                <span class="gatsby-code-button-language">js{29-40}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">/* eslint-disable no-param-reassign */</span>\n<span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> Loadable <span class="token keyword">from</span> <span class="token string">\'react-loadable\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> LoaderCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">loadComponent</span><span class="token punctuation">(</span><span class="token parameter">loader<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">let</span> component <span class="token operator">=</span> LoaderCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>loader<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>component<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    component <span class="token operator">=</span> <span class="token function">Loadable</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n      loader<span class="token punctuation">,</span>\n      <span class="token function-variable function">loading</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>props<span class="token punctuation">.</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          <span class="token comment">// eslint-disable-line</span>\n          <span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>host<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">\'-dev\'</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> window<span class="token punctuation">.</span><span class="token constant">TURKEY</span> <span class="token operator">&amp;&amp;</span> window<span class="token punctuation">.</span><span class="token constant">TURKEY</span><span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">\'serverUpdate\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            window<span class="token punctuation">.</span><span class="token constant">TURKEY</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token string">\'serverUpdate\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token punctuation">}</span>\n          console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">\'[chunk loader]\'</span><span class="token punctuation">,</span> props<span class="token punctuation">.</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// eslint-disable-line</span>\n        <span class="token punctuation">}</span>\n        <span class="token keyword">return</span> <span class="token operator">&lt;</span>div <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      <span class="token function-variable function">render</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">loaded<span class="token punctuation">,</span> props</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token keyword">const</span> Component <span class="token operator">=</span> loaded<span class="token punctuation">.</span>default<span class="token punctuation">;</span>\n        <span class="token keyword">const</span> <span class="token punctuation">{</span> withRef<span class="token punctuation">,</span> <span class="token operator">...</span>rest <span class="token punctuation">}</span> <span class="token operator">=</span> props<span class="token punctuation">;</span> <span class="token comment">// eslint-disable-line</span>\n        <span class="token keyword">let</span> refProps <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n        <span class="token comment">// 只有 PureReactComponent 和 ReactComponent 才有生命周期，注意在 react-hook 的情况下 Component.prototype 为空</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Component</span><span class="token punctuation">.</span>prototype <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token class-name">Component</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>isPureReactComponent <span class="token operator">||</span> <span class="token class-name">Component</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>isReactComponent<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          refProps <span class="token operator">=</span> <span class="token punctuation">{</span>\n            <span class="token function-variable function">ref</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">r</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n<span class="gatsby-highlight-code-line">              withRef <span class="token operator">&amp;&amp;</span> <span class="token function">withRef</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">              <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>r<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">                <span class="token keyword">return</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">              <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">              <span class="token keyword">const</span> cb <span class="token operator">=</span> r<span class="token punctuation">.</span>componentWillUnmount<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">              r<span class="token punctuation">.</span><span class="token function-variable function">componentWillUnmount</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">                r<span class="token punctuation">.</span><span class="token function-variable function">setState</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">                  <span class="token comment">// eslint-disable-next-line no-useless-return</span></span><span class="gatsby-highlight-code-line">                  <span class="token keyword">return</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">                <span class="token punctuation">}</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">                cb <span class="token operator">&amp;&amp;</span> <span class="token function">cb</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">              <span class="token punctuation">}</span><span class="token punctuation">;</span></span>            <span class="token punctuation">}</span>\n          <span class="token punctuation">}</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n        <span class="token keyword">return</span> <span class="token operator">&lt;</span>Component <span class="token punctuation">{</span><span class="token operator">...</span>refProps<span class="token punctuation">}</span> <span class="token punctuation">{</span><span class="token operator">...</span>rest<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      <span class="token operator">...</span>options\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    LoaderCache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>loader<span class="token punctuation">,</span> component<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// component.preload();</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">return</span> component<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="组件级别"><a href="#%E7%BB%84%E4%BB%B6%E7%BA%A7%E5%88%AB" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>组件级别</h3>\n<p>src\\runtime\\preventSetState.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="61032052204585410000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import React from \'react\';\n\nexport default function preventSetState(WrappedComponent) {\n  return class Hoc extends React.PureComponent {\n    componentWillUnmount = () => {\n      this.wrappedComponent.setState = () => {\n        // eslint-disable-next-line no-useless-return\n        return;\n      };\n    };\n\n    render() {\n      return (\n        <WrappedComponent\n          ref={(r) => {\n            this.wrappedComponent = r;\n          }}\n          {...this.props}\n        />\n      );\n    }\n  };\n}`, `61032052204585410000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="jsx"\n              >\n                <span class="gatsby-code-button-language">jsx</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">preventSetState</span><span class="token punctuation">(</span><span class="token parameter">WrappedComponent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token keyword">class</span> <span class="token class-name">Hoc</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>PureComponent</span> <span class="token punctuation">{</span>\n    <span class="token function-variable function">componentWillUnmount</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>wrappedComponent<span class="token punctuation">.</span><span class="token function-variable function">setState</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token comment">// eslint-disable-next-line no-useless-return</span>\n        <span class="token keyword">return</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span> <span class="token punctuation">(</span>\n        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">WrappedComponent</span></span>\n          <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token parameter">r</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            <span class="token keyword">this</span><span class="token punctuation">.</span>wrappedComponent <span class="token operator">=</span> r<span class="token punctuation">;</span>\n          <span class="token punctuation">}</span><span class="token punctuation">}</span></span>\n          <span class="token spread"><span class="token punctuation">{</span><span class="token punctuation">...</span><span class="token attr-value">this</span><span class="token punctuation">.</span><span class="token attr-value">props</span><span class="token punctuation">}</span></span>\n        <span class="token punctuation">/></span></span>\n      <span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>调用时</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="60966068403935945000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import preventSetState from \'runtime/preventSetState\';\n\n@preventSetState\nexport default class Component extends React.PureComponent {}`, `60966068403935945000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> preventSetState <span class="token keyword">from</span> <span class="token string">\'runtime/preventSetState\'</span><span class="token punctuation">;</span>\n\n@preventSetState\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Component</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>PureComponent</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>或者</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="81997012603105430000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import preventSetState from \'runtime/preventSetState\';\n\nclass Component extends React.PureComponent {}\n\nexport default preventSetState(Component);`, `81997012603105430000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> preventSetState <span class="token keyword">from</span> <span class="token string">\'runtime/preventSetState\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">class</span> <span class="token class-name">Component</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>PureComponent</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">preventSetState</span><span class="token punctuation">(</span>Component<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>待拓展的功能：react-hook 替换 mobx、HTML 内实现 Loading 态或者骨架屏、动态 polyfill、编译到 ES2015+（提高运行效率）、LazyLoad、三方库 external 化</p>\n<h1 id="重置报错状态"><a href="#%E9%87%8D%E7%BD%AE%E6%8A%A5%E9%94%99%E7%8A%B6%E6%80%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>重置报错状态</h1>\n<p>单个组件报错时不影响其他页面的加载</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="80776352253251570000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import React, { Component } from \'react\';\nimport PropTypes from \'prop-types\';\n\nimport styles from \'./styles.css\';\n\nclass ErrorBoundary extends Component {\n  state = {\n    hasError: false\n  };\n\n  componentWillReceiveProps() {\n    // 重置未报错状态\n    this.setState({\n      hasError: false\n    });\n  }\n\n  componentDidCatch(error) {\n    this.setState({\n      hasError: true\n    });\n\n    console.error(error);\n    if (window.__bl) {\n      window.__bl.error(error);\n    }\n  }\n\n  render() {\n    if (this.state.hasError) {\n      return (\n        <div className={styles.error}>\n          <div className={styles.title}>抱歉，页面出错了！</div>\n        </div>\n      );\n    }\n    return this.props.children;\n  }\n}\n\nErrorBoundary.propTypes = {\n  children: PropTypes.node\n};\n\nexport default ErrorBoundary;`, `80776352253251570000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="jsx{11-16}"\n              >\n                <span class="gatsby-code-button-language">jsx{11-16}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> PropTypes <span class="token keyword">from</span> <span class="token string">\'prop-types\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> styles <span class="token keyword">from</span> <span class="token string">\'./styles.css\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">class</span> <span class="token class-name">ErrorBoundary</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>\n  state <span class="token operator">=</span> <span class="token punctuation">{</span>\n    hasError<span class="token punctuation">:</span> <span class="token boolean">false</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line">  <span class="token function">componentWillReceiveProps</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    <span class="token comment">// 重置未报错状态</span></span><span class="gatsby-highlight-code-line">    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      hasError<span class="token punctuation">:</span> <span class="token boolean">false</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span></span>\n  <span class="token function">componentDidCatch</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n      hasError<span class="token punctuation">:</span> <span class="token boolean">true</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>__bl<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      window<span class="token punctuation">.</span>__bl<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>hasError<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span> <span class="token punctuation">(</span>\n        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>error<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text"></span>\n<span class="token plain-text">          </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>title<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">抱歉，页面出错了！</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token plain-text"></span>\n<span class="token plain-text">        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>\n      <span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\nErrorBoundary<span class="token punctuation">.</span>propTypes <span class="token operator">=</span> <span class="token punctuation">{</span>\n  children<span class="token punctuation">:</span> PropTypes<span class="token punctuation">.</span>node\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> ErrorBoundary<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="stylelint-无效"><a href="#stylelint-%E6%97%A0%E6%95%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>stylelint 无效</h1>\n<p>package.json</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="17702523662522806000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`&quot;lint:css&quot;: &quot;stylelint src/**/*.css&quot;`, `17702523662522806000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token string">"lint:css"</span><span class="token builtin class-name">:</span> <span class="token string">"stylelint src/**/*.css"</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>当在苹果电脑上运行以上命令时，没有任何效果，即使 css 格式错误也直接通过，同时提交代码前的报错信息也没有颜色，需要做下特殊处理</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="7579675976685274000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`&quot;lint:css&quot;: &quot;stylelint \\&quot;src/**/*.css\\&quot; --color&quot; # src/**/*.css 双引号转义为了兼容苹果，--color 是为了执行 pre-commit 钩子即提交代码前也能让错误的信息有颜色\n&quot;lint&quot;: &quot;npm run lint:js && npm run lint:css&quot;,\n&quot;pre-commit&quot;: &quot;lint&quot;,`, `7579675976685274000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token string">"lint:css"</span><span class="token builtin class-name">:</span> <span class="token string">"stylelint <span class="token entity" title="\\&quot;">\\"</span>src/**/*.css<span class="token entity" title="\\&quot;">\\"</span> --color"</span> <span class="token comment"># src/**/*.css 双引号转义为了兼容苹果，--color 是为了执行 pre-commit 钩子即提交代码前也能让错误的信息有颜色</span>\n<span class="token string">"lint"</span><span class="token builtin class-name">:</span> <span class="token string">"npm run lint:js &amp;&amp; npm run lint:css"</span>,\n<span class="token string">"pre-commit"</span><span class="token builtin class-name">:</span> <span class="token string">"lint"</span>,</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>',
id:"/home/runner/work/GatsbyBlog/GatsbyBlog/blog/Webpack脚手架搭建笔记——记一次新项目搭建/index.md absPath of file >>> MarkdownRemark",timeToRead:6,frontmatter:{date:"2019-10-10 21:46:40",path:"/webpack-template-new-project/",tags:"前端, 前端构建工具, webpack, 预研",title:"Webpack脚手架搭建笔记——记一次新项目搭建",draft:null}},{excerpt:"接上文  Webpack 配置笔记 分包策略 在分支   上启动   脚本，得到分包策略如下： 首屏加载对比 原始首屏加载 升级后加载 分包优化步骤 echarts 只提取需要的包 immutable 指向同一份，避免 draft 与 antd 重复打包 分大模块改写法 根据路由来分 这里原来的路由引用模块已经是   形式的了，所以我在   里的   加了如下策略 经实验，可以看到各个页面只加载所需的包 根据组件来分 对其中比较大的组件进行了懒加载处理，react-player/draft…",html:'<p>接上文 <a href="/webpack-config-note/">Webpack 配置笔记</a></p>\n<h1 id="分包策略"><a href="#%E5%88%86%E5%8C%85%E7%AD%96%E7%95%A5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>分包策略</h1>\n<p>在分支 <code class="language-text">feature/optimize_webpack</code> 上启动 <code class="language-text">yarn analyze</code> 脚本，得到分包策略如下：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2019-08-20-14-39-37-7859d5fffe6130839ec4ea995f4afe9a-de767.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 48.45840605002909%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACbUlEQVQozwFiAp39AO/kz/n28fv8/vr58eqrkuGBXtqBYeKDYeR5T+mZlNyfwN2WsdqV1sp728du1qhr6JBQ5IxU4YBW/25A+wD29vT7/P77/f/5/f/tvKnvkG7rgFnqd07iWCTtm43ptNTehKfWgs7FYt23UsifXOZ/NONxOMhrP+9VJ9oA8/T0+Pj4+Pj4+/397b+v7IZf7HZL6nBE3lkl5JCF46bH24Gl1aTPzavcwqberJThnYjqi3zpaGH5UkvqAN/f3+Hh4eXj4/j+/+6rl+trQuxwSPJwR9pPI9eWg97V1djFwOTW4tC13sW15LWq5p6W7IyH8klK+S802wDj4+Pk5OTo6Of7/P/q2KnkvnLguHPkvHTetmfm0a7q3N/cw77Gvc2lpcmssNuRmtmImOR3i+ZffPNNad4A5eXl5ubm6Ojo9vb49PbJ9vq25+yy5eq/+P3K8vPWz9HDzMu1wczOprnMssbfn7fgmLToh6jsbJn4RXvtAOLi4uPj4+jo6fz8+ff16fb06/Xzy+bkyuXixeTpyKvPoY/AeqrTup3QzKrU3arU6KHO7pLH9Xm0+Vyj/QDi4uLh4eHm5ub4+Pfz99vu89Lp6qrq6p/y8KXb6qmm0qCUwoGw2b604dWX3Nyb3ued3PGP1PeX2f6Mz/4A5eXl5ubm5+fm9PL32/qowPJstupite5bpN4+od92iN6MdNZwnN+wrejSjuXVkujljOjzru373sDA39bYAOTk5Obm5unp6Pz5/9f5or34YLLzSafxMn3CB4HBWG3gcEzFRXDVk2XapYbozIvy43329a/3/em+uuTa2O+lwnzOuk/fAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="分包策略" title="" data-src="/static/2019-08-20-14-39-37-7859d5fffe6130839ec4ea995f4afe9a-fee1c.png" data-srcset="/static/2019-08-20-14-39-37-7859d5fffe6130839ec4ea995f4afe9a-a67b7.png 200w,\n/static/2019-08-20-14-39-37-7859d5fffe6130839ec4ea995f4afe9a-0b187.png 400w,\n/static/2019-08-20-14-39-37-7859d5fffe6130839ec4ea995f4afe9a-fee1c.png 800w,\n/static/2019-08-20-14-39-37-7859d5fffe6130839ec4ea995f4afe9a-b1a91.png 1200w,\n/static/2019-08-20-14-39-37-7859d5fffe6130839ec4ea995f4afe9a-95179.png 1600w,\n/static/2019-08-20-14-39-37-7859d5fffe6130839ec4ea995f4afe9a-de767.png 1719w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h1 id="首屏加载对比"><a href="#%E9%A6%96%E5%B1%8F%E5%8A%A0%E8%BD%BD%E5%AF%B9%E6%AF%94" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>首屏加载对比</h1>\n<h2 id="原始首屏加载"><a href="#%E5%8E%9F%E5%A7%8B%E9%A6%96%E5%B1%8F%E5%8A%A0%E8%BD%BD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>原始首屏加载</h2>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2019-08-20-14-42-05-dc236b5b1d36b576b60c6fb6a0f521ad-ed146.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 21.993127147766323%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAIAAAABPYjBAAAACXBIWXMAAAsSAAALEgHS3X78AAAAkklEQVQI102O2w4DIQhE/f8P3VXxUl0RpW3aWe1DTwxOAjNgTkc+5OA9xYx3nPbwlgLFGFNKtdbrj9barvhqKQbdukZEnyLSmKmXJjwWIoO7TNVbjx9zTlRVNTsppRyIEILG5/W+TQtmds7pAmNIx4zO2bl3kWW+Wnpk510IodQKAw6BH0Bba/ce6G3GgikDN34BXWbkUgx7EmcAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="原始首屏加载大小" title="" data-src="/static/2019-08-20-14-42-05-dc236b5b1d36b576b60c6fb6a0f521ad-fee1c.png" data-srcset="/static/2019-08-20-14-42-05-dc236b5b1d36b576b60c6fb6a0f521ad-a67b7.png 200w,\n/static/2019-08-20-14-42-05-dc236b5b1d36b576b60c6fb6a0f521ad-0b187.png 400w,\n/static/2019-08-20-14-42-05-dc236b5b1d36b576b60c6fb6a0f521ad-fee1c.png 800w,\n/static/2019-08-20-14-42-05-dc236b5b1d36b576b60c6fb6a0f521ad-b1a91.png 1200w,\n/static/2019-08-20-14-42-05-dc236b5b1d36b576b60c6fb6a0f521ad-95179.png 1600w,\n/static/2019-08-20-14-42-05-dc236b5b1d36b576b60c6fb6a0f521ad-ed146.png 1746w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h2 id="升级后加载"><a href="#%E5%8D%87%E7%BA%A7%E5%90%8E%E5%8A%A0%E8%BD%BD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>升级后加载</h2>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2019-08-20-14-42-42-2cbb79c4a1d62b7c41439f4a77864389-009aa.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 26.851851851851855%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAIAAADKYVtkAAAACXBIWXMAAAsSAAALEgHS3X78AAAAoElEQVQY03VPyw7DIAzr/38obWgpGRAS6GUGNmmXWQjysmO23V9niJ48nYGu4PadiPw5EEJI//Fi3lLKOJxeUqVYNTM1q4BWVR2pau/dvlhFvL23LedcSonxBhCj/DwPuDYl0IKFxUeMADshIDIGPuQQb/Ie021CRKYFRcs5hxtkTC5yswZfrfdFzpGZJpgZEsuC1gqV4ziQ/m5uMKXjV29jTh1MtgkaKAAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="升级后加载大小" title="" data-src="/static/2019-08-20-14-42-42-2cbb79c4a1d62b7c41439f4a77864389-fee1c.png" data-srcset="/static/2019-08-20-14-42-42-2cbb79c4a1d62b7c41439f4a77864389-a67b7.png 200w,\n/static/2019-08-20-14-42-42-2cbb79c4a1d62b7c41439f4a77864389-0b187.png 400w,\n/static/2019-08-20-14-42-42-2cbb79c4a1d62b7c41439f4a77864389-fee1c.png 800w,\n/static/2019-08-20-14-42-42-2cbb79c4a1d62b7c41439f4a77864389-b1a91.png 1200w,\n/static/2019-08-20-14-42-42-2cbb79c4a1d62b7c41439f4a77864389-95179.png 1600w,\n/static/2019-08-20-14-42-42-2cbb79c4a1d62b7c41439f4a77864389-009aa.png 1728w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h1 id="分包优化步骤"><a href="#%E5%88%86%E5%8C%85%E4%BC%98%E5%8C%96%E6%AD%A5%E9%AA%A4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>分包优化步骤</h1>\n<h2 id="echarts-只提取需要的包"><a href="#echarts-%E5%8F%AA%E6%8F%90%E5%8F%96%E9%9C%80%E8%A6%81%E7%9A%84%E5%8C%85" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>echarts 只提取需要的包</h2>\n<p><code class="language-text">app\\components\\ECharts\\component.js</code></p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="16189500126815638000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import echarts from \'echarts/lib/echarts\';\nimport \'echarts/lib/chart/bar\';\nimport \'echarts/lib/chart/line\';\nimport \'echarts/lib/chart/pie\';\n\nimport \'echarts/lib/component/tooltip\';\nimport \'echarts/lib/component/legendScroll\';`, `16189500126815638000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> echarts <span class="token keyword">from</span> <span class="token string">\'echarts/lib/echarts\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token string">\'echarts/lib/chart/bar\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token string">\'echarts/lib/chart/line\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token string">\'echarts/lib/chart/pie\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> <span class="token string">\'echarts/lib/component/tooltip\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token string">\'echarts/lib/component/legendScroll\'</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="immutable-指向同一份，避免-draft-与-antd-重复打包"><a href="#immutable-%E6%8C%87%E5%90%91%E5%90%8C%E4%B8%80%E4%BB%BD%EF%BC%8C%E9%81%BF%E5%85%8D-draft-%E4%B8%8E-antd-%E9%87%8D%E5%A4%8D%E6%89%93%E5%8C%85" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>immutable 指向同一份，避免 draft 与 antd 重复打包</h2>\n<p><code class="language-text">internals/webpack/webpack.base.babel.js</code></p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="77859865728725320000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\'immutable\': path.resolve(process.cwd(), \'node_modules/immutable\'),`, `77859865728725320000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token string">\'immutable\'</span><span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">\'node_modules/immutable\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h2 id="分大模块改写法"><a href="#%E5%88%86%E5%A4%A7%E6%A8%A1%E5%9D%97%E6%94%B9%E5%86%99%E6%B3%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>分大模块改写法</h2>\n<h3 id="根据路由来分"><a href="#%E6%A0%B9%E6%8D%AE%E8%B7%AF%E7%94%B1%E6%9D%A5%E5%88%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>根据路由来分</h3>\n<p>这里原来的路由引用模块已经是 <code class="language-text">import().then()</code> 形式的了，所以我在 <code class="language-text">webpack</code> 里的 <code class="language-text">splitChunks</code> 加了如下策略</p>\n<p><code class="language-text">internals/webpack/webpack.prod.babel.js</code></p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="75837515485768710000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`splitChunks: {\n  chunks: \'all\', // 不管文件是动态还是非动态载入，统一将文件分离。当页面首次载入会引入所有的包\n  maxInitialRequests: 10, // 最大初始化请求数\n  minSize: 0, // 默认30000，为了不合并 chunk\n  cacheGroups: {\n    vendor: {\n      test: /[\\\\/]node_modules[\\\\/]/,\n      name(module) {\n        const packageName = module.context.match(\n          /[\\\\/]node_modules[\\\\/](.*?)([\\\\/]|\\$)/,\n        )[1];\n        return \\`npm.\\${packageName.replace(\'@\', \'\')}\\`; // 提取各个第三方组件，只在需要时提取\n      },\n    },\n  },\n},`, `75837515485768710000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">splitChunks<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n  chunks<span class="token punctuation">:</span> <span class="token string">\'all\'</span><span class="token punctuation">,</span> <span class="token comment">// 不管文件是动态还是非动态载入，统一将文件分离。当页面首次载入会引入所有的包</span>\n  maxInitialRequests<span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token comment">// 最大初始化请求数</span>\n  minSize<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// 默认30000，为了不合并 chunk</span>\n  cacheGroups<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    vendor<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n      test<span class="token punctuation">:</span> <span class="token regex">/[\\\\/]node_modules[\\\\/]/</span><span class="token punctuation">,</span>\n      <span class="token function">name</span><span class="token punctuation">(</span><span class="token parameter">module</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">const</span> packageName <span class="token operator">=</span> module<span class="token punctuation">.</span>context<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>\n          <span class="token regex">/[\\\\/]node_modules[\\\\/](.*?)([\\\\/]|$)/</span><span class="token punctuation">,</span>\n        <span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n        <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">npm.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>packageName<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">\'@\'</span><span class="token punctuation">,</span> <span class="token string">\'\'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span> <span class="token comment">// 提取各个第三方组件，只在需要时提取</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>经实验，可以看到各个页面只加载所需的包</p>\n<h3 id="根据组件来分"><a href="#%E6%A0%B9%E6%8D%AE%E7%BB%84%E4%BB%B6%E6%9D%A5%E5%88%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>根据组件来分</h3>\n<p>对其中比较大的组件进行了懒加载处理，react-player/draft/echarts</p>\n<p>其中有一个比较大的问题就是懒加载组件引用不到 ref 的问题，经多次实验，更改写法如下</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="74515542263751020000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import React from \'react\';\nimport Loadable from \'react-loadable\';\n\nconst LoaderCache = new Map();\nexport default function loadComponent(loader, options) {\n  let component = LoaderCache.get(loader);\n  if (!component) {\n    component = Loadable({\n      loader,\n      loading: (props) => {\n        if (props.error) {\n          // eslint-disable-line\n          console.error(\'[chunk loader]\', props.error); // eslint-disable-line\n        }\n        return <div />;\n      },\n      render: (loaded, props) => {\n        const Component = loaded.default;\n        const { withRef, ...rest } = props; // eslint-disable-line\n        return (\n          <Component\n            ref={(r) => {\n              withRef && withRef(r);\n            }}\n            {...rest}\n          />\n        );\n      },\n      ...options\n    });\n    LoaderCache.set(loader, component);\n    // component.preload();\n  }\n  return component;\n}`, `74515542263751020000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{16-23}"\n              >\n                <span class="gatsby-code-button-language">js{16-23}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> Loadable <span class="token keyword">from</span> <span class="token string">\'react-loadable\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> LoaderCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">loadComponent</span><span class="token punctuation">(</span><span class="token parameter">loader<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">let</span> component <span class="token operator">=</span> LoaderCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>loader<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>component<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    component <span class="token operator">=</span> <span class="token function">Loadable</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n      loader<span class="token punctuation">,</span>\n      <span class="token function-variable function">loading</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>props<span class="token punctuation">.</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          <span class="token comment">// eslint-disable-line</span>\n          console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">\'[chunk loader]\'</span><span class="token punctuation">,</span> props<span class="token punctuation">.</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// eslint-disable-line</span>\n        <span class="token punctuation">}</span>\n        <span class="token keyword">return</span> <span class="token operator">&lt;</span>div <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line">      <span class="token punctuation">}</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">      <span class="token function-variable function">render</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">loaded<span class="token punctuation">,</span> props</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">        <span class="token keyword">const</span> Component <span class="token operator">=</span> loaded<span class="token punctuation">.</span>default<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">        <span class="token keyword">const</span> <span class="token punctuation">{</span> withRef<span class="token punctuation">,</span> <span class="token operator">...</span>rest <span class="token punctuation">}</span> <span class="token operator">=</span> props<span class="token punctuation">;</span> <span class="token comment">// eslint-disable-line</span></span><span class="gatsby-highlight-code-line">        <span class="token keyword">return</span> <span class="token punctuation">(</span></span><span class="gatsby-highlight-code-line">          <span class="token operator">&lt;</span>Component</span><span class="gatsby-highlight-code-line">            ref<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token parameter">r</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">              withRef <span class="token operator">&amp;&amp;</span> <span class="token function">withRef</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span></span>            <span class="token punctuation">}</span><span class="token punctuation">}</span>\n            <span class="token punctuation">{</span><span class="token operator">...</span>rest<span class="token punctuation">}</span>\n          <span class="token operator">/</span><span class="token operator">></span>\n        <span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      <span class="token operator">...</span>options\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    LoaderCache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>loader<span class="token punctuation">,</span> component<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// component.preload();</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">return</span> component<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>用法：</p>\n<p><code class="language-text">app\\components\\GraphHintTextArea\\index.js</code></p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="19299772683749626000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import loadComponent from \'utils/loader\';\n\nexport default loadComponent(() => import(/* webpackChunkName: &quot;c-graph-hint-text-area&quot; */ \'./component\'), null);`, `19299772683749626000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> loadComponent <span class="token keyword">from</span> <span class="token string">\'utils/loader\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">loadComponent</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token comment">/* webpackChunkName: "c-graph-hint-text-area" */</span> <span class="token string">\'./component\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="62790166629474670000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<GraphHintTextArea\n  withRef={(r) => {\n    this.graphHintTextArea = r;\n  }}\n/>`, `62790166629474670000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="jsx"\n              >\n                <span class="gatsby-code-button-language">jsx</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">GraphHintTextArea</span></span>\n  <span class="token attr-name">withRef</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token parameter">r</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>graphHintTextArea <span class="token operator">=</span> r<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">}</span></span>\n<span class="token punctuation">/></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="antd-只加载需要的-icon"><a href="#antd-%E5%8F%AA%E5%8A%A0%E8%BD%BD%E9%9C%80%E8%A6%81%E7%9A%84-icon" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>antd 只加载需要的 icon</h2>\n<p><code class="language-text">internals/webpack/webpack.base.babel.js</code></p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="90998047886163770000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\'@ant-design/icons/lib/dist\\$\': path.resolve(\'app/icons\'),`, `90998047886163770000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token string">\'@ant-design/icons/lib/dist$\'</span><span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">\'app/icons\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p><code class="language-text">app/icons/index.js</code></p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="2529451225120360400"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// fill\nexport { default as ExclamationCircleFill } from \'@ant-design/icons/lib/fill/ExclamationCircleFill\';\n// outline\nexport { default as QuestionCircleOutline } from \'@ant-design/icons/lib/outline/QuestionCircleOutline\';\n// twotone\nexport { default as ProfileTwoTone } from \'@ant-design/icons/lib/twotone/ProfileTwoTone\';`, `2529451225120360400`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// fill</span>\n<span class="token keyword">export</span> <span class="token punctuation">{</span> <span class="token keyword">default</span> <span class="token keyword">as</span> ExclamationCircleFill <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@ant-design/icons/lib/fill/ExclamationCircleFill\'</span><span class="token punctuation">;</span>\n<span class="token comment">// outline</span>\n<span class="token keyword">export</span> <span class="token punctuation">{</span> <span class="token keyword">default</span> <span class="token keyword">as</span> QuestionCircleOutline <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@ant-design/icons/lib/outline/QuestionCircleOutline\'</span><span class="token punctuation">;</span>\n<span class="token comment">// twotone</span>\n<span class="token keyword">export</span> <span class="token punctuation">{</span> <span class="token keyword">default</span> <span class="token keyword">as</span> ProfileTwoTone <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@ant-design/icons/lib/twotone/ProfileTwoTone\'</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>',
id:"/home/runner/work/GatsbyBlog/GatsbyBlog/blog/Webpack升级优化——记一次产品端升级/index.md absPath of file >>> MarkdownRemark",timeToRead:4,frontmatter:{date:"2019-08-20 14:33:00",path:"/webpack-upgrade-about-product/",tags:"前端, 前端构建工具, webpack, 预研",title:"Webpack升级优化——记一次产品端升级",draft:null}},{excerpt:"需求背景 在做侧边抽屉时遇到了需要强行撑满剩余高度的情况，左边的外呼结果要强行撑满剩余高度，这考察了等高布局的应用 解决方案 首先明确侧边栏左边 html 的结构，其中 html 采用 react 写法，css 采用 less 写法 table 布局 比较 hack 的方法 margin 与 padding absolute 此方法需要对 html…",html:'<h1 id="需求背景"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h1>\n<p>在做侧边抽屉时遇到了需要强行撑满剩余高度的情况，左边的外呼结果要强行撑满剩余高度，这考察了等高布局的应用</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2019-06-20-15-48-45-745076aea56d31fb7147ea5b63040ac7-055ed.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 105.87570621468927%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAVCAIAAADJt1n/AAAACXBIWXMAAAsSAAALEgHS3X78AAACiElEQVQ4y31TyWoVURDtn/IT/AAndKd+g2sXrgRx485tEMSNIYEYFEzAIOGBuNCgKBmMCSZv6n59b9+pqu5g3e6XkBjTh2q4PZyuqlOninpWCyF8CBz/IIY+IFJRi6YWEtEDB9BpGIuNJQvkzoexYC04QOugqKrZ0dEx8OdE6QyYNlQRQ+yQH8XId9owCzkz+VAopSfj8aRFPEMG5L+RpzmQARAjJ6AUuUbO7wqtTVWVdV03TZPOk53j8logaq2tUYNDfLlF30akZD0ty0IIOR6Pmkbya+ZzPu8918nkTML2AnDOeXSr2/7xZtg88EbOpmVVeB84AQuulGKyMcZam+skzwfn8oVtZm4weEgBYiApm7KqCiAfc5H8k+hD4jukkJkO2x8ZsCoFTORiDgg5UEqZyTxmVruVZh6dvDbXy/PAY0F/ajqYmsNSDwUe1SgMNlJksmxUWZZcsJqjUZwmJh5p8rA7xRuL6d5Kur+a7r5Jt5bS1Vdp4YuHpppwz66dCZ4CQLiEIavN5R0LeDKIzz7FpwP/aIMefggP3of1XwGNnHSCpf+ByVkqsIlsJItWUW6+E+yk54vkOCd7w8PTZjTTlVCsQGfJ7C+8nNyBe+aPlMWRIG0xBc5vcubYjUqyUn1kQhAGPv6mjX2/tmPXdgyf1/dor2SHiWpWX0q2rdrbU7y+mO4sp5tL6fZyuvY6XVlIzz9TAsXr1ZfZE1YK3+6Ed7th8Tuu/ISlH/7FV781ZBux9aBPbTYYL0/yOgUXUUfHmwMcbNJsWtdLZm9L7fbHUmqTlwzQODDtqjnXT+7UNjCWxMOxhgen4QR5Z3ifs8F8uBjGIdu7G692KI2TyvJBt885Off0F9oTs4fxp+6FAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2019 06 20 15 48 45" title="" data-src="/static/2019-06-20-15-48-45-745076aea56d31fb7147ea5b63040ac7-fee1c.png" data-srcset="/static/2019-06-20-15-48-45-745076aea56d31fb7147ea5b63040ac7-a67b7.png 200w,\n/static/2019-06-20-15-48-45-745076aea56d31fb7147ea5b63040ac7-0b187.png 400w,\n/static/2019-06-20-15-48-45-745076aea56d31fb7147ea5b63040ac7-fee1c.png 800w,\n/static/2019-06-20-15-48-45-745076aea56d31fb7147ea5b63040ac7-055ed.png 885w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h1 id="解决方案"><a href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>解决方案</h1>\n<p>首先明确侧边栏左边 html 的结构，其中 html 采用 react 写法，css 采用 less 写法</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="36802633580846320000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<div className=&quot;{styles.leftBody}&quot;>\n  <div className=&quot;{styles.leftBodyTop}&quot;></div>\n  <div className=&quot;{styles.leftBodyBottom}&quot;></div>\n</div>`, `36802633580846320000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="html"\n              >\n                <span class="gatsby-code-button-language">html</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="html"><pre style="counter-reset: linenumber NaN" class="language-html line-numbers"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>{styles.leftBody}<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>\n  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>{styles.leftBodyTop}<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>\n  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>{styles.leftBodyBottom}<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="table-布局"><a href="#table-%E5%B8%83%E5%B1%80" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>table 布局</h2>\n<p>比较 hack 的方法</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="50692996574966374000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`.leftBody {\n  display: table;\n\n  .leftBodyTop {\n    background: #fff;\n    display: table-row;\n    height: 0; /* 尽可能的减小高度，即自适应内容 */\n  }\n\n  .leftBodyBottom {\n    background: #fff;\n    display: table-row; /* 占满剩余空间，自适应父类剩余高度 */\n    vertical-align: top; /* 将内容放在顶部 */\n\n    &::before {\n      /* 设置 display：table-row; 时，margin 和 padding 设置会失效，故这里用伪元素代替显示 */\n      content: \'\';\n      display: block;\n      width: 100%;\n      height: 16px;\n      background: #edf0f4;\n    }\n  }\n}`, `50692996574966374000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="css"\n              >\n                <span class="gatsby-code-button-language">css</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="css"><pre style="counter-reset: linenumber NaN" class="language-css line-numbers"><code class="language-css"><span class="token selector">.leftBody</span> <span class="token punctuation">{</span>\n  <span class="token property">display</span><span class="token punctuation">:</span> table<span class="token selector">;\n\n  .leftBodyTop</span> <span class="token punctuation">{</span>\n    <span class="token property">background</span><span class="token punctuation">:</span> #fff<span class="token punctuation">;</span>\n    <span class="token property">display</span><span class="token punctuation">:</span> table-row<span class="token punctuation">;</span>\n    <span class="token property">height</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span> <span class="token comment">/* 尽可能的减小高度，即自适应内容 */</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token selector">.leftBodyBottom</span> <span class="token punctuation">{</span>\n    <span class="token property">background</span><span class="token punctuation">:</span> #fff<span class="token punctuation">;</span>\n    <span class="token property">display</span><span class="token punctuation">:</span> table-row<span class="token punctuation">;</span> <span class="token comment">/* 占满剩余空间，自适应父类剩余高度 */</span>\n    <span class="token property">vertical-align</span><span class="token punctuation">:</span> top<span class="token punctuation">;</span> <span class="token comment">/* 将内容放在顶部 */</span>\n\n    <span class="token selector">&amp;::before</span> <span class="token punctuation">{</span>\n      <span class="token comment">/* 设置 display：table-row; 时，margin 和 padding 设置会失效，故这里用伪元素代替显示 */</span>\n      <span class="token property">content</span><span class="token punctuation">:</span> <span class="token string">\'\'</span><span class="token punctuation">;</span>\n      <span class="token property">display</span><span class="token punctuation">:</span> block<span class="token punctuation">;</span>\n      <span class="token property">width</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>\n      <span class="token property">height</span><span class="token punctuation">:</span> 16px<span class="token punctuation">;</span>\n      <span class="token property">background</span><span class="token punctuation">:</span> #edf0f4<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="margin-与-padding"><a href="#margin-%E4%B8%8E-padding" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>margin 与 padding</h2>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="644900330010900200"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`.leftBody {\n  overflow: hidden; /* 必须设置，否则露底 */\n\n  .leftBodyTop {\n    background: #fff;\n  }\n\n  .leftBodyBottom {\n    background: #fff;\n    margin-top: 16px;\n    margin-bottom: -3000px; /* margin 与 padding 相互抵消来撑满剩余高度 */\n    padding-bottom: 3000px;\n  }\n}`, `644900330010900200`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="css"\n              >\n                <span class="gatsby-code-button-language">css</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="css"><pre style="counter-reset: linenumber NaN" class="language-css line-numbers"><code class="language-css"><span class="token selector">.leftBody</span> <span class="token punctuation">{</span>\n  <span class="token property">overflow</span><span class="token punctuation">:</span> hidden<span class="token punctuation">;</span> <span class="token comment">/* 必须设置，否则露底 */</span>\n\n  <span class="token selector">.leftBodyTop</span> <span class="token punctuation">{</span>\n    <span class="token property">background</span><span class="token punctuation">:</span> #fff<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token selector">.leftBodyBottom</span> <span class="token punctuation">{</span>\n    <span class="token property">background</span><span class="token punctuation">:</span> #fff<span class="token punctuation">;</span>\n    <span class="token property">margin-top</span><span class="token punctuation">:</span> 16px<span class="token punctuation">;</span>\n    <span class="token property">margin-bottom</span><span class="token punctuation">:</span> -3000px<span class="token punctuation">;</span> <span class="token comment">/* margin 与 padding 相互抵消来撑满剩余高度 */</span>\n    <span class="token property">padding-bottom</span><span class="token punctuation">:</span> 3000px<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="absolute"><a href="#absolute" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>absolute</h2>\n<p>此方法需要对 html 做出改动</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="51212728139935605000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<div className=&quot;{styles.leftBody}&quot;>\n  <div className=&quot;{styles.leftBodyTop}&quot;></div>\n  <div className=&quot;{styles.leftBodyBottom}&quot;>\n    <div className=&quot;{styles.equalHeight}&quot; />\n    <div className=&quot;{styles.content}&quot;></div>\n  </div>\n</div>`, `51212728139935605000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="html"\n              >\n                <span class="gatsby-code-button-language">html</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="html"><pre style="counter-reset: linenumber NaN" class="language-html line-numbers"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>{styles.leftBody}<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>\n  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>{styles.leftBodyTop}<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>\n  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>{styles.leftBodyBottom}<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>{styles.equalHeight}<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>{styles.content}<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>\n  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>由于绝对定位元素无高度的特性无宽度的特性，我们可以伪造一个高度足够高的绝对定位层（设置背景色，边框等属性），同时设置父标签溢出隐藏，那么其多出来的高度就不会显示了，也就实现了看上去的等高布局效果了</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="32017972497299540000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`.leftBody {\n  overflow: hidden; /* 必须设置，否则露底 */\n\n  .leftBodyTop {\n    background: #fff;\n  }\n\n  .leftBodyBottom {\n    background: #fff;\n    margin-top: 16px;\n    position: relative;\n\n    .equalHeight {\n      background: #fff;\n      width: 100%;\n      height: 999em;\n      position: absolute;\n      left: 0;\n      top: 0;\n    }\n\n    .content {\n      position: relative;\n      z-index: 1; /* 内容必须在上方，否则被 equalHeight 覆盖 */\n    }\n  }\n}`, `32017972497299540000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="css"\n              >\n                <span class="gatsby-code-button-language">css</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="css"><pre style="counter-reset: linenumber NaN" class="language-css line-numbers"><code class="language-css"><span class="token selector">.leftBody</span> <span class="token punctuation">{</span>\n  <span class="token property">overflow</span><span class="token punctuation">:</span> hidden<span class="token punctuation">;</span> <span class="token comment">/* 必须设置，否则露底 */</span>\n\n  <span class="token selector">.leftBodyTop</span> <span class="token punctuation">{</span>\n    <span class="token property">background</span><span class="token punctuation">:</span> #fff<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token selector">.leftBodyBottom</span> <span class="token punctuation">{</span>\n    <span class="token property">background</span><span class="token punctuation">:</span> #fff<span class="token punctuation">;</span>\n    <span class="token property">margin-top</span><span class="token punctuation">:</span> 16px<span class="token punctuation">;</span>\n    <span class="token property">position</span><span class="token punctuation">:</span> relative<span class="token selector">;\n\n    .equalHeight</span> <span class="token punctuation">{</span>\n      <span class="token property">background</span><span class="token punctuation">:</span> #fff<span class="token punctuation">;</span>\n      <span class="token property">width</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>\n      <span class="token property">height</span><span class="token punctuation">:</span> 999em<span class="token punctuation">;</span>\n      <span class="token property">position</span><span class="token punctuation">:</span> absolute<span class="token punctuation">;</span>\n      <span class="token property">left</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>\n      <span class="token property">top</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token selector">.content</span> <span class="token punctuation">{</span>\n      <span class="token property">position</span><span class="token punctuation">:</span> relative<span class="token punctuation">;</span>\n      <span class="token property">z-index</span><span class="token punctuation">:</span> 1<span class="token punctuation">;</span> <span class="token comment">/* 内容必须在上方，否则被 equalHeight 覆盖 */</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="flex"><a href="#flex" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>flex</h2>\n<p>代码最简洁</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="12776947794630234000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`.leftBody {\n  display: flex;\n  flex-direction: column;\n\n  .leftBodyTop {\n    background: #fff;\n  }\n\n  .leftBodyBottom {\n    background: #fff;\n    margin-top: 16px;\n    flex: 1;\n  }\n}`, `12776947794630234000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="css"\n              >\n                <span class="gatsby-code-button-language">css</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="css"><pre style="counter-reset: linenumber NaN" class="language-css line-numbers"><code class="language-css"><span class="token selector">.leftBody</span> <span class="token punctuation">{</span>\n  <span class="token property">display</span><span class="token punctuation">:</span> flex<span class="token punctuation">;</span>\n  <span class="token property">flex-direction</span><span class="token punctuation">:</span> column<span class="token selector">;\n\n  .leftBodyTop</span> <span class="token punctuation">{</span>\n    <span class="token property">background</span><span class="token punctuation">:</span> #fff<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token selector">.leftBodyBottom</span> <span class="token punctuation">{</span>\n    <span class="token property">background</span><span class="token punctuation">:</span> #fff<span class="token punctuation">;</span>\n    <span class="token property">margin-top</span><span class="token punctuation">:</span> 16px<span class="token punctuation">;</span>\n    <span class="token property">flex</span><span class="token punctuation">:</span> 1<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>以上更新于<code class="language-text">2019-6-20 16:39:27</code></p>\n<hr>',id:"/home/runner/work/GatsbyBlog/GatsbyBlog/blog/CSS等高布局的应用/index.md absPath of file >>> MarkdownRemark",timeToRead:2,frontmatter:{date:"2019-06-20 15:45:59",path:"/css-equal-height/",tags:"前端, CSS, 等高布局, 预研",title:"CSS等高布局的应用",draft:null}},{excerpt:"需求背景 最近由于第三方云端电话私自更改接口导致了线上事故的发生，所以公司决定由前端直接连接 freeswitch ，用它来借助第三方线路打云端电话 知识背景 SIP 协议入门学习 核心思路 首先在网上找到相应前端的 SIP 连接库，发现大概满足的有 2 种，一个是 JsSIP，看了一下支持的列表里面是没有 freeswitch 的，所以选了支持 freeswitch 的 SIP.js…",html:'<h1 id="需求背景"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h1>\n<p>最近由于第三方云端电话私自更改接口导致了线上事故的发生，所以公司决定由前端直接连接 freeswitch ，用它来借助第三方线路打云端电话</p>\n<h1 id="知识背景"><a href="#%E7%9F%A5%E8%AF%86%E8%83%8C%E6%99%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>知识背景</h1>\n<p><a href="/SIP-protocol-introduction-learning/">SIP 协议入门学习</a></p>\n<h1 id="核心思路"><a href="#%E6%A0%B8%E5%BF%83%E6%80%9D%E8%B7%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>核心思路</h1>\n<p>首先在网上找到相应前端的 SIP 连接库，发现大概满足的有 2 种，一个是 JsSIP，看了一下支持的列表里面是没有 freeswitch 的，所以选了支持 freeswitch 的 SIP.js</p>\n<h1 id="代码预览"><a href="#%E4%BB%A3%E7%A0%81%E9%A2%84%E8%A7%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>代码预览</h1>\n<p>在写代码时考虑到要兼容之前第三方云端电话的逻辑，所以需要将所有的方法封装成一个类</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="45818437216440566000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// Call\nimport { UA } from \'./libs/sip-0.14.1\';\n\nclass Call {\n  constructor() {\n    // eslint-disable-next-line constructor-super\n    this.callInfo = null;\n    this.userAgent = null; // 注册 SIP 后实例\n    this.session = null; // 拨打成功后 session 实例\n    this.remoteView = null;\n\n    this.hasSignedIn = false;\n    this.createElements();\n\n    window.onbeforeunload = () => {\n      // eslint-disable-line\n      this.signOut();\n    };\n  }\n\n  createElements() {\n    this.remoteView = document.createElement(\'video\');\n    this.remoteView.style.display = \'none\';\n    document.body.appendChild(this.remoteView);\n  }\n\n  async signIn(callInfo) {\n    const { ws_domain: sipServer, ws_port: sipPort, ws_protocol: wsType } = await getCallInfo();\n    return new Promise((resolve, reject) => {\n      this.signInResolve = resolve;\n      this.signInReject = reject;\n      this.callInfo = {\n        authorizationUser: callInfo.agent_id,\n        password: callInfo.agent_pwd,\n        sipServer,\n        sipPort,\n        wsType\n      };\n      this.registerSip();\n    });\n  }\n\n  // 注册分机（软电话）\n  registerSip() {\n    const { authorizationUser, password, sipServer, sipPort, wsType } = this.callInfo;\n    const config = {\n      // Replace this IP address with your FreeSWITCH IP address\n      uri: \\`\\${authorizationUser}@\\${sipServer}:\\${sipPort}\\`,\n      transportOptions: {\n        wsServers: [\\`\\${wsType}://\\${sipServer}:\\${sipPort}\\`]\n      },\n      // Replace sipjs.com with your domain name\n      // and replace the port with your FreeSWITCH wss port\n      ws_servers: \\`\\${wsType}://\\${sipServer}:\\${sipPort}/\\`,\n      // FreeSWITCH Default Username\n      authorizationUser,\n      // FreeSWITCH Default Password\n      password,\n      // displayName: \'8300211193\',\n      hackIpInContact: true,\n      // register: true,\n      sessionDescriptionHandlerFactoryOptions: {\n        constraints: {\n          audio: true,\n          video: false\n        }\n      }\n    };\n\n    this.userAgent = new UA(config);\n\n    this.userAgent.on(\'connected\', () => {\n      console.log(\'连接成功\');\n    });\n\n    this.userAgent.on(\'disconnected\', () => {\n      console.log(\'连接断开\');\n    });\n\n    this.userAgent.on(\'registered\', () => {\n      console.log(\'注册成功\');\n      this.hasSignedIn = true;\n      this.signInResolve();\n    });\n\n    this.userAgent.on(\'unregistered\', () => {\n      console.log(\'反注册成功\');\n      this.upperSelf.onAgentStateChange && this.upperSelf.onAgentStateChange(\'0\', \'2\');\n      this.hasSignedIn = false;\n      this.signInReject();\n    });\n\n    this.userAgent.on(\'registrationFailed\', () => {\n      console.log(\'注册失败\');\n      this.hasSignedIn = false;\n      this.signInReject();\n    });\n\n    this.userAgent.once(\'transportCreated\', (transport) => {\n      console.log(\'transportCreated\', transport);\n    });\n\n    this.userAgent.on(\'message\', () => {\n      console.log(\'message\');\n    });\n\n    this.userAgent.on(\'invite\', (incomingSession) => {\n      console.log(\'incomingSession\', incomingSession);\n      this.session = incomingSession;\n      this.session.accept();\n      // 播放对方会话\n      this.session.on(\'trackAdded\', () => {\n        console.log(\'trackAdded\');\n        const pc = this.session.sessionDescriptionHandler.peerConnection;\n        // Gets remote tracks\n        const remoteStream = new MediaStream();\n        pc.getReceivers().forEach((receiver) => {\n          remoteStream.addTrack(receiver.track);\n        });\n        this.remoteView.srcObject = remoteStream;\n        this.remoteView.play();\n      });\n      this.session.on(\'progress\', (response) => {\n        console.log(\'progress\', response);\n      });\n      this.session.on(\'failed\', (response, cause) => {\n        console.log(\'failed\', response, cause);\n      });\n      // 响铃动作\n      this.session.on(\'accepted\', (data) => {\n        console.log(\'accepted\', data);\n      });\n      this.session.on(\'rejected\', (response, cause) => {\n        console.log(\'rejected\', response, cause);\n      });\n      // 挂断动作\n      this.session.on(\'terminated\', (message, cause) => {\n        console.log(\'terminated\', message, cause);\n      });\n      this.session.on(\'referRequested\', () => {\n        console.log(\'referRequested\');\n      });\n      this.session.on(\'reinvite\', () => {\n        console.log(\'reinvite\');\n      });\n      this.session.on(\'replaced\', () => {\n        console.log(\'replaced\');\n      });\n      this.session.on(\'cancel\', () => {\n        console.log(\'cancel\');\n      });\n      // 挂断动作\n      this.session.on(\'bye\', (request) => {\n        console.log(\'bye\', request);\n      });\n      this.session.on(\'directionChanged\', () => {\n        console.log(\'directionChanged\');\n      });\n      this.session.on(\'SessionDescriptionHandler-created\', () => {\n        console.log(\'SessionDescriptionHandler-created\');\n      });\n    });\n  }\n\n  // 来电挂断\n  hangup() {\n    console.log(\'挂断\', this.session);\n    if (this.session) {\n      this.session.bye();\n    }\n  }\n\n  signOut() {\n    console.log(\'退出登录成功\');\n    if (this.userAgent) {\n      this.userAgent.stop();\n      this.userAgent = null;\n    }\n    if (this.session) {\n      this.session.terminate();\n      this.session = null;\n    }\n    this.hasSignedIn = false;\n  }\n\n  // 603 Decline\n  // 当成功访问到被叫方的设备，但是用户明确的不想应答。这个应答可以通过增加一个Retry-After头域更明确的告诉呼叫方多久以后可以继续呼叫\n  // 只有当终端知道没有其他任何终端设备能够响应这个呼叫的势能才能给出这个应答。\n  makeIdle() {\n    console.log(\'在忙\');\n    // this.session.reply({\n    //   statusCode: \'486\',\n    // });\n  }\n}\n\nexport default Call;`, `45818437216440566000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// Call</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">UA</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'./libs/sip-0.14.1\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">class</span> <span class="token class-name">Call</span> <span class="token punctuation">{</span>\n  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// eslint-disable-next-line constructor-super</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>callInfo <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>userAgent <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// 注册 SIP 后实例</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>session <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// 拨打成功后 session 实例</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>remoteView <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">this</span><span class="token punctuation">.</span>hasSignedIn <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createElements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    window<span class="token punctuation">.</span><span class="token function-variable function">onbeforeunload</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token comment">// eslint-disable-line</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">signOut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token function">createElements</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>remoteView <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">\'video\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>remoteView<span class="token punctuation">.</span>style<span class="token punctuation">.</span>display <span class="token operator">=</span> <span class="token string">\'none\'</span><span class="token punctuation">;</span>\n    document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>remoteView<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">async</span> <span class="token function">signIn</span><span class="token punctuation">(</span><span class="token parameter">callInfo</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> <span class="token punctuation">{</span> ws_domain<span class="token punctuation">:</span> sipServer<span class="token punctuation">,</span> ws_port<span class="token punctuation">:</span> sipPort<span class="token punctuation">,</span> ws_protocol<span class="token punctuation">:</span> wsType <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getCallInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>signInResolve <span class="token operator">=</span> resolve<span class="token punctuation">;</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>signInReject <span class="token operator">=</span> reject<span class="token punctuation">;</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>callInfo <span class="token operator">=</span> <span class="token punctuation">{</span>\n        authorizationUser<span class="token punctuation">:</span> callInfo<span class="token punctuation">.</span>agent_id<span class="token punctuation">,</span>\n        password<span class="token punctuation">:</span> callInfo<span class="token punctuation">.</span>agent_pwd<span class="token punctuation">,</span>\n        sipServer<span class="token punctuation">,</span>\n        sipPort<span class="token punctuation">,</span>\n        wsType\n      <span class="token punctuation">}</span><span class="token punctuation">;</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">registerSip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token comment">// 注册分机（软电话）</span>\n  <span class="token function">registerSip</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> <span class="token punctuation">{</span> authorizationUser<span class="token punctuation">,</span> password<span class="token punctuation">,</span> sipServer<span class="token punctuation">,</span> sipPort<span class="token punctuation">,</span> wsType <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>callInfo<span class="token punctuation">;</span>\n    <span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token punctuation">{</span>\n      <span class="token comment">// Replace this IP address with your FreeSWITCH IP address</span>\n      uri<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>authorizationUser<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">@</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>sipServer<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>sipPort<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n      transportOptions<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n        wsServers<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>wsType<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>sipServer<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>sipPort<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      <span class="token comment">// Replace sipjs.com with your domain name</span>\n      <span class="token comment">// and replace the port with your FreeSWITCH wss port</span>\n      ws_servers<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>wsType<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>sipServer<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>sipPort<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n      <span class="token comment">// FreeSWITCH Default Username</span>\n      authorizationUser<span class="token punctuation">,</span>\n      <span class="token comment">// FreeSWITCH Default Password</span>\n      password<span class="token punctuation">,</span>\n      <span class="token comment">// displayName: \'8300211193\',</span>\n      hackIpInContact<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n      <span class="token comment">// register: true,</span>\n      sessionDescriptionHandlerFactoryOptions<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n        constraints<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n          audio<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n          video<span class="token punctuation">:</span> <span class="token boolean">false</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">this</span><span class="token punctuation">.</span>userAgent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UA</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">this</span><span class="token punctuation">.</span>userAgent<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'connected\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'连接成功\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">this</span><span class="token punctuation">.</span>userAgent<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'disconnected\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'连接断开\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">this</span><span class="token punctuation">.</span>userAgent<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'registered\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'注册成功\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>hasSignedIn <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">signInResolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">this</span><span class="token punctuation">.</span>userAgent<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'unregistered\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'反注册成功\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>upperSelf<span class="token punctuation">.</span>onAgentStateChange <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>upperSelf<span class="token punctuation">.</span><span class="token function">onAgentStateChange</span><span class="token punctuation">(</span><span class="token string">\'0\'</span><span class="token punctuation">,</span> <span class="token string">\'2\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>hasSignedIn <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">signInReject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">this</span><span class="token punctuation">.</span>userAgent<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'registrationFailed\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'注册失败\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>hasSignedIn <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">signInReject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">this</span><span class="token punctuation">.</span>userAgent<span class="token punctuation">.</span><span class="token function">once</span><span class="token punctuation">(</span><span class="token string">\'transportCreated\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">transport</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'transportCreated\'</span><span class="token punctuation">,</span> transport<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">this</span><span class="token punctuation">.</span>userAgent<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'message\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'message\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">this</span><span class="token punctuation">.</span>userAgent<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'invite\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">incomingSession</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'incomingSession\'</span><span class="token punctuation">,</span> incomingSession<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>session <span class="token operator">=</span> incomingSession<span class="token punctuation">;</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>session<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token comment">// 播放对方会话</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>session<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'trackAdded\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'trackAdded\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">const</span> pc <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>session<span class="token punctuation">.</span>sessionDescriptionHandler<span class="token punctuation">.</span>peerConnection<span class="token punctuation">;</span>\n        <span class="token comment">// Gets remote tracks</span>\n        <span class="token keyword">const</span> remoteStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MediaStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        pc<span class="token punctuation">.</span><span class="token function">getReceivers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">receiver</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n          remoteStream<span class="token punctuation">.</span><span class="token function">addTrack</span><span class="token punctuation">(</span>receiver<span class="token punctuation">.</span>track<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">this</span><span class="token punctuation">.</span>remoteView<span class="token punctuation">.</span>srcObject <span class="token operator">=</span> remoteStream<span class="token punctuation">;</span>\n        <span class="token keyword">this</span><span class="token punctuation">.</span>remoteView<span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>session<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'progress\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'progress\'</span><span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>session<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'failed\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">response<span class="token punctuation">,</span> cause</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'failed\'</span><span class="token punctuation">,</span> response<span class="token punctuation">,</span> cause<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token comment">// 响铃动作</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>session<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'accepted\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'accepted\'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>session<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'rejected\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">response<span class="token punctuation">,</span> cause</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'rejected\'</span><span class="token punctuation">,</span> response<span class="token punctuation">,</span> cause<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token comment">// 挂断动作</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>session<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'terminated\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">message<span class="token punctuation">,</span> cause</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'terminated\'</span><span class="token punctuation">,</span> message<span class="token punctuation">,</span> cause<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>session<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'referRequested\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'referRequested\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>session<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'reinvite\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'reinvite\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>session<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'replaced\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'replaced\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>session<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'cancel\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'cancel\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token comment">// 挂断动作</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>session<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'bye\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">request</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'bye\'</span><span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>session<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'directionChanged\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'directionChanged\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>session<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'SessionDescriptionHandler-created\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'SessionDescriptionHandler-created\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token comment">// 来电挂断</span>\n  <span class="token function">hangup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'挂断\'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>session<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>session<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>session<span class="token punctuation">.</span><span class="token function">bye</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token function">signOut</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'退出登录成功\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>userAgent<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>userAgent<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>userAgent <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>session<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>session<span class="token punctuation">.</span><span class="token function">terminate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>session <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>hasSignedIn <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token comment">// 603 Decline</span>\n  <span class="token comment">// 当成功访问到被叫方的设备，但是用户明确的不想应答。这个应答可以通过增加一个Retry-After头域更明确的告诉呼叫方多久以后可以继续呼叫</span>\n  <span class="token comment">// 只有当终端知道没有其他任何终端设备能够响应这个呼叫的势能才能给出这个应答。</span>\n  <span class="token function">makeIdle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'在忙\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// this.session.reply({</span>\n    <span class="token comment">//   statusCode: \'486\',</span>\n    <span class="token comment">// });</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> Call<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="疑难问题"><a href="#%E7%96%91%E9%9A%BE%E9%97%AE%E9%A2%98" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>疑难问题</h1>\n<p>以上因为 freeswitch 第三方线路的失败回调导致挂断电话不能正常挂断，此时最佳的解决办法就是后端写 websocket 来推送给前端以做到实时更新，否则总是有些不成功的回调导致 UI 显示错误，现阶段主要采用轮询后端的方式来获取最新的状态。</p>\n<p>以上更新于<code class="language-text">2019-6-10 20:20:52</code></p>\n<hr>\n<h1 id="实现效果"><a href="#%E5%AE%9E%E7%8E%B0%E6%95%88%E6%9E%9C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>实现效果</h1>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2019-06-10-20-13-17-6d6b1011cd526e12a624b1c69091f4b8-d42cb.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 407px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 107.37100737100738%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAVCAIAAADJt1n/AAAACXBIWXMAAAsSAAALEgHS3X78AAAC20lEQVQ4y22T21LaUBSGeZw6HSUJIQmCIGoVFeWQhBxIQkBArKjYm/aidXrbTp3p4QH6IJ2+Sqftk/Tb2RQ7Tmf+Sf69sg7/WjsrVzRMt+e5vV7P88qVLUXVtIIuoWqgkBHx1IsGwJ/nVrVmGGautFkGVmnTtEqQzbJE5RGyT0tODUlyMt8qZUEvUof6POGQvKJC/q3MJ2CYVm4lUspDQqvdGQzSOE5oZzyZDEejbte2HVemW9/In7bajcMj8uZkViAJiXd2905OW0fHxweNBn6E7R80gCxOzO7es+36DicRTLeyZ54Aj5VIvkrAVz4UwFI0zRzSPT9AYT+Kg7AP6Xm+5/mQKE4AR98PHLcnLWE/wtLudEXPJKM9PwjPZxejszEkihISkfFyfjWZnmNJkgF5pWV6PoPQi0Flcc/k5Gw7mCCdbDwQx3GdjHBmZl4Qdpc+fvPkBOWisp9Zx5Pp2XgCCYIQnZDp9HyQDvHu9yPyd2334vllmg7J2Ol2CRQ983PZXRvxURRTwXFdQDXE0yEEB3FbtkNkGPYJ5hZEz8yayphwFd5hX/yoni8tBPPiiBHCETs1GJhuGEK2SO/2kI1IpsqR8aDgZnHLwFASZzOHXN8scMMHIUI2AxN34wdA3EoQokqOEC6BN5EQ6UbqVqtdpDLS/eye42QQZoPxsnsmgPklgzTLE5LO+asOC7JNcc+mJcPS4QhX0VEUR0niR9H1YjGdzQLuPU2pBubzK+LxIZFpWTn+Q5azWtvmKUllq1o2yhWjYhasSlEQceTbdl3uI6RcqdBvTu7gA9SCquvVN079c9z8OK7eBztfkuprR1U0RdMIAHlFYT1Ez/KnX8IwEFIsWc3vL05/3t39+jr/8an1+23z261eEDt3eHTMMmqaruvGsvJjFI3aK7v+Idp/l7TfT+r3Ue2lXdDEzpJdrpTYqv8H08hTVV1TlLX8+pMNCEdpf9j8LPgPDhtowU2c6joAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2019 06 10 20 13 17" title="" data-src="/static/2019-06-10-20-13-17-6d6b1011cd526e12a624b1c69091f4b8-d42cb.png" data-srcset="/static/2019-06-10-20-13-17-6d6b1011cd526e12a624b1c69091f4b8-68801.png 200w,\n/static/2019-06-10-20-13-17-6d6b1011cd526e12a624b1c69091f4b8-d3489.png 400w,\n/static/2019-06-10-20-13-17-6d6b1011cd526e12a624b1c69091f4b8-d42cb.png 407w" data-sizes="(max-width: 407px) 100vw, 407px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2019-06-10-20-15-11-7efbc5afdb7a66d757b0c02675f7ffb5-17038.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 463px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 117.27861771058315%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAXCAIAAACEf/j0AAAACXBIWXMAAAsSAAALEgHS3X78AAAC5UlEQVQ4y41USVMaURCenxMDygzrbIws4yxv2EERGDZRQCKaPefcc81PyM38Bo/m5EWxypSmKheteJO7ku/NUBQVg8mrrq5+M+973f1192M4fyCeVE1d8ylEKA78HMdy/qcFEEGUYDDhCJ8rFO1KOaBXtO5Hno8Ew5HQkwKIshqDwfCCKIoSL0qKLPFBjm4l2RXYiyTCC9AMYiitb9j1ht1oIn6Pd9m7vLLk8cLwsf9IgQkEQ4ZJKtVaebOi6UYiqRZLJWwLxZIcVYDH7YuEgomV6vX6ne1tGCaxYBy8fLW9043F4wD7A8GFYPzTDXNN03WTSHJ0ecUHQeTQLrHzYNjzWwq2Umn4zGRzsXjC8RSCgnaPupnP7PlEaNjpTLbf3+32esAjf+S80+1lc3mkQIjV3x00mi1Eh1+9/u5w/8Cu10HHlLB8oVBvNJutFm5B/Ll8oVqzYYM/4Ku12vpGGbam6TW7jrqgOigkBSMYfBoO99+9/7BZqeIQaN/bG4Jt6tlKDQYv6o0GrnE9v37zttXeAjsUHAyFcQh3Q+AW4FQ6U7Nt6Kiy6ibvCtzM29Oc44kkQt0ob6prGvDgD0lCAzyj6rFQMDznC0X4wR5d5dZp6bnHrdYicerogMFWe6sDhnTdoLkZpulowyB/FdO00IgUjNRPTk6urn5Arq+vb29vfz25bm5u7u7ujo6OKBjDNR6PJ5PJw8PD5D/W/f099OnpKdJkMNbHx98uLr6PRqPz83OoEV0z4891dnZ2eXl1ePiVZf0UzAsStGOIgkgn2bVlWQHh84IcBfo9Sg1RYvAgpFNWNpNBbdCYoB2lRm+gSZARCjl7QGBHkyoplWRVBc0QhuUCUtJa1VI4Cg5Rc1QbfKN+uB4lmb5bnN/jY9uq+rnTGRKCatGcA6FwothR0lVVVdFq4HA2lfMDhGl8xnKfYvGfO90vhLDOeDmPASqq6+gtxIzHbdZVj6d/BVezHDTOYLB+A0x1vxBYHZqdAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2019 06 10 20 15 11" title="" data-src="/static/2019-06-10-20-15-11-7efbc5afdb7a66d757b0c02675f7ffb5-17038.png" data-srcset="/static/2019-06-10-20-15-11-7efbc5afdb7a66d757b0c02675f7ffb5-ebf63.png 200w,\n/static/2019-06-10-20-15-11-7efbc5afdb7a66d757b0c02675f7ffb5-37c59.png 400w,\n/static/2019-06-10-20-15-11-7efbc5afdb7a66d757b0c02675f7ffb5-17038.png 463w" data-sizes="(max-width: 463px) 100vw, 463px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2019-06-10-20-16-33-03507c8d6bc624be7f4884dc39009044-cac7f.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 21.52542372881356%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAIAAAABPYjBAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAr0lEQVQI1y2O2Q7CMAwE+//fBoWWoyR2jsamJ4jSgjjEAw5FGo02q5XiRIfC18ZVaCuYQVb2CDO+Ma5Gw1oG1Lt64NO9FeuyECeOwTIYmtdxh6SQtBEYXGzA/J7VmW+fq3C6dRC0ONnRauPTbYjOXRpzucrdUsKeMum3YZ37NLML7Ir2Qe2TwoCZW4gTyxqCMqTkT0GuwKC0LzA2Mf8PYWgux/F1md5DP7a6PPRT8wUfD9IcalHJpQAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2019 06 10 20 16 33" title="" data-src="/static/2019-06-10-20-16-33-03507c8d6bc624be7f4884dc39009044-fee1c.png" data-srcset="/static/2019-06-10-20-16-33-03507c8d6bc624be7f4884dc39009044-a67b7.png 200w,\n/static/2019-06-10-20-16-33-03507c8d6bc624be7f4884dc39009044-0b187.png 400w,\n/static/2019-06-10-20-16-33-03507c8d6bc624be7f4884dc39009044-fee1c.png 800w,\n/static/2019-06-10-20-16-33-03507c8d6bc624be7f4884dc39009044-cac7f.png 1180w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>',
id:"/home/runner/work/GatsbyBlog/GatsbyBlog/blog/基于SIP协议云端电话的实践/index.md absPath of file >>> MarkdownRemark",timeToRead:4,frontmatter:{date:"2019-06-10 11:44:03",path:"/sip-protocol-practice/",tags:"前端, SIP, webrtc, 预研",title:"基于SIP协议云端电话的实践",draft:null}},{excerpt:"需求背景 最近要做一个将第三方聊天库打包为链接，以便于顾客端使用，类似于这个样子  , 以实现将代码嵌入到顾客端网站的 标签之前即可完成部署，开发过程中遇到诸多难点 需求难点 打包工具选型 最容易想到的办法就是沿用公司之前的 webpack 框架，这里升级到了 webpack4（见之前的文章  Webpack 配置笔记 ），考虑到打包后可能会包含一些 webpack 的多余代码，因此不是最优方案。但迫于技术的不成熟以及开发时间的压力，还是把 webpack…",html:'<h1 id="需求背景"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h1>\n<p>最近要做一个将第三方聊天库打包为链接，以便于顾客端使用，类似于这个样子 <code class="language-text">&lt;script src=&quot;打包后库的地址?deployId=部署ID&quot; name=&quot;唯一标识符&quot;&gt;&lt;/script&gt;</code>, 以实现将代码嵌入到顾客端网站的<code class="language-text">&lt;/body&gt;</code>标签之前即可完成部署，开发过程中遇到诸多难点</p>\n<h1 id="需求难点"><a href="#%E9%9C%80%E6%B1%82%E9%9A%BE%E7%82%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求难点</h1>\n<h2 id="打包工具选型"><a href="#%E6%89%93%E5%8C%85%E5%B7%A5%E5%85%B7%E9%80%89%E5%9E%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>打包工具选型</h2>\n<p>最容易想到的办法就是沿用公司之前的 webpack 框架，这里升级到了 webpack4（见之前的文章 <a href="/webpack-config-note/">Webpack 配置笔记</a>），考虑到打包后可能会包含一些 webpack 的多余代码，因此不是最优方案。但迫于技术的不成熟以及开发时间的压力，还是把 webpack 作为此次选型。这里需要后期优化，考虑到的方案有 rollup.js、jQuery、VanillaJS（原生 js）</p>\n<h2 id="打包工具重构"><a href="#%E6%89%93%E5%8C%85%E5%B7%A5%E5%85%B7%E9%87%8D%E6%9E%84" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>打包工具重构</h2>\n<p>这里需要将所有代码打包成一个类似于一个 js 文件，所以这里需要对框架做出调整，以下只列出改动的地方，其中标红的部分是最核心的改动</p>\n<h3 id="webpackbasebabeljs"><a href="#webpackbasebabeljs" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>webpack.base.babel.js</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="66691418412396320000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// const CopyWebpackPlugin = require(\'copy-webpack-plugin\'); 去掉 copy-webpack-plugin\n\n{\n  test: /\\.(jpe?g|png|gif|svg)\\$/,\n  use: [\n    {\n      loader: \'url-loader\',\n      options: {\n        // Inline files smaller than 10 kB，尽可能将所有的图片内联到 js\n        limit: 100 * 1024,\n      },\n    },\n  ],\n},\n\nnew webpack.optimize.MinChunkSizePlugin({\n  minChunkSize: Infinity, // Minimum number of characters，尽可能的打包 js 为一个文件\n}),\n\n// 屏蔽 CopyWebpackPlugin 没用\n// new CopyWebpackPlugin([\n//   \'app/favicon.ico\',\n//   \'app/manifest.json\',\n// ].map((src) => ({ from: src, to: path.resolve(process.cwd(), \'build\') }))),`, `66691418412396320000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{16-18}"\n              >\n                <span class="gatsby-code-button-language">js{16-18}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// const CopyWebpackPlugin = require(\'copy-webpack-plugin\'); 去掉 copy-webpack-plugin</span>\n\n<span class="token punctuation">{</span>\n  test<span class="token punctuation">:</span> <span class="token regex">/\\.(jpe?g|png|gif|svg)$/</span><span class="token punctuation">,</span>\n  use<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n    <span class="token punctuation">{</span>\n      loader<span class="token punctuation">:</span> <span class="token string">\'url-loader\'</span><span class="token punctuation">,</span>\n      options<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n        <span class="token comment">// Inline files smaller than 10 kB，尽可能将所有的图片内联到 js</span>\n        limit<span class="token punctuation">:</span> <span class="token number">100</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">,</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token punctuation">]</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span>\n\n<span class="gatsby-highlight-code-line"><span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>optimize<span class="token punctuation">.</span>MinChunkSizePlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">  minChunkSize<span class="token punctuation">:</span> <span class="token number">Infinity</span><span class="token punctuation">,</span> <span class="token comment">// Minimum number of characters，尽可能的打包 js 为一个文件</span></span><span class="gatsby-highlight-code-line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>\n<span class="token comment">// 屏蔽 CopyWebpackPlugin 没用</span>\n<span class="token comment">// new CopyWebpackPlugin([</span>\n<span class="token comment">//   \'app/favicon.ico\',</span>\n<span class="token comment">//   \'app/manifest.json\',</span>\n<span class="token comment">// ].map((src) => ({ from: src, to: path.resolve(process.cwd(), \'build\') }))),</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="webpackprodbabeljs"><a href="#webpackprodbabeljs" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>webpack.prod.babel.js</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="36114303141872607000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// const LodashModuleReplacementPlugin = require(\'lodash-webpack-plugin\'); 实测对打包成一个 js 时有影响，暂未找到原因\n\ncssDebug: true, // 打开 cssDebug，以避免使用 MiniCssExtractPlugin，会产生多余的 css\nentry: \'./app/app.js\', // 改变入口，不分包\noutput: {\n  filename: \'bundle.js\', // 只输出一个 bundle.js 文件\n},\n\nsplitChunks: false,  // 关闭分包优化，下面同理\nruntimeChunk: false,\n\n// new LodashModuleReplacementPlugin(), // lodash 优化，暂时屏蔽，理由同上\n// new webpack.HashedModuleIdsPlugin(), // 不需要固定 chunkhash，因为只有一个文件`, `36114303141872607000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// const LodashModuleReplacementPlugin = require(\'lodash-webpack-plugin\'); 实测对打包成一个 js 时有影响，暂未找到原因</span>\n\ncssDebug<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 打开 cssDebug，以避免使用 MiniCssExtractPlugin，会产生多余的 css</span>\nentry<span class="token punctuation">:</span> <span class="token string">\'./app/app.js\'</span><span class="token punctuation">,</span> <span class="token comment">// 改变入口，不分包</span>\noutput<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n  filename<span class="token punctuation">:</span> <span class="token string">\'bundle.js\'</span><span class="token punctuation">,</span> <span class="token comment">// 只输出一个 bundle.js 文件</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span>\n\nsplitChunks<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>  <span class="token comment">// 关闭分包优化，下面同理</span>\nruntimeChunk<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n\n<span class="token comment">// new LodashModuleReplacementPlugin(), // lodash 优化，暂时屏蔽，理由同上</span>\n<span class="token comment">// new webpack.HashedModuleIdsPlugin(), // 不需要固定 chunkhash，因为只有一个文件</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>以上就实现了将所有代码都打包到一个 bundle.js 文件</p>\n<h2 id="bundlejs-插入渲染结点"><a href="#bundlejs-%E6%8F%92%E5%85%A5%E6%B8%B2%E6%9F%93%E7%BB%93%E7%82%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>bundle.js 插入渲染结点</h2>\n<p>原来的方式是在 index.html 中写要渲染的 div 标签，由于引入到顾客端时是不可能在别人的 html 中写入 div 标签，所以解决方案如下</p>\n<p>主要是对 app.js 入口文件做出改动，在渲染 app.js 时通过主动创建一个 div 结点加入到 body 标签的最后</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="83666584284719780000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const render = () => {\n  const root = document.createElement(\'div\');\n  document.querySelector(\'body\').appendChild(root);\n  ReactDOM.render(<App />, root);\n};\n\nrender();`, `83666584284719780000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">render</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> root <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">\'div\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">\'body\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>App <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="bundlejs-二次引入-babel-polyfill"><a href="#bundlejs-%E4%BA%8C%E6%AC%A1%E5%BC%95%E5%85%A5-babel-polyfill" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>bundle.js 二次引入 babel-polyfill</h2>\n<p>在顾客端同样引用 babel-polyfill 的情况下，会造成 bundle.js 的报错，此时需要判断</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="88372451404425270000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`if (!global._babelPolyfill) {\n  // 防止二次引入\n  require(\'babel-polyfill\');\n}`, `88372451404425270000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>global<span class="token punctuation">.</span>_babelPolyfill<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 防止二次引入</span>\n  <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'babel-polyfill\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="bundlejs-报错会引起顾客端整个崩溃"><a href="#bundlejs-%E6%8A%A5%E9%94%99%E4%BC%9A%E5%BC%95%E8%B5%B7%E9%A1%BE%E5%AE%A2%E7%AB%AF%E6%95%B4%E4%B8%AA%E5%B4%A9%E6%BA%83" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>bundle.js 报错会引起顾客端整个崩溃</h2>\n<p>需要引入 ErrorBoundary 组件，即使报错也只有引入的 bundle.js 聊天窗口崩溃</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="71914570222230420000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import React from \'react\';\nimport PropTypes from \'prop-types\';\n\nclass ErrorBoundary extends React.Component {\n  static propTypes = {\n    children: PropTypes.node\n  };\n\n  constructor(props) {\n    super(props);\n    this.state = { error: null, errorInfo: null };\n  }\n\n  componentDidCatch(error, errorInfo) {\n    console.log(error, errorInfo);\n    // Display fallback UI\n    this.setState({ error, errorInfo });\n    // You can also log the error to an error reporting service\n  }\n\n  render() {\n    // if (this.state.hasError) {\n    //   // You can render any custom fallback UI\n    //   return <h1>Something went wrong.</h1>;\n    // }\n    return this.props.children;\n  }\n}\n\nexport default ErrorBoundary;`, `71914570222230420000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="jsx"\n              >\n                <span class="gatsby-code-button-language">jsx</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> PropTypes <span class="token keyword">from</span> <span class="token string">\'prop-types\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">class</span> <span class="token class-name">ErrorBoundary</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>\n  <span class="token keyword">static</span> propTypes <span class="token operator">=</span> <span class="token punctuation">{</span>\n    children<span class="token punctuation">:</span> PropTypes<span class="token punctuation">.</span>node\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span> error<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> errorInfo<span class="token punctuation">:</span> <span class="token keyword">null</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token function">componentDidCatch</span><span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> errorInfo</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> errorInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// Display fallback UI</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> error<span class="token punctuation">,</span> errorInfo <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// You can also log the error to an error reporting service</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// if (this.state.hasError) {</span>\n    <span class="token comment">//   // You can render any custom fallback UI</span>\n    <span class="token comment">//   return &lt;h1>Something went wrong.&lt;/h1>;</span>\n    <span class="token comment">// }</span>\n    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> ErrorBoundary<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后在预测可能要报错的结点前包裹 ErrorBoundary</p>\n<h2 id="修改主题色"><a href="#%E4%BF%AE%E6%94%B9%E4%B8%BB%E9%A2%98%E8%89%B2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>修改主题色</h2>\n<p>由于需要实现读取后端给出的样式变量，所以需要实现在 css 样式中读取到 js 变量，找了很多资料，发现最理想的还是 styled-components 可以在内联的 css 中读取到变量</p>\n<p>但是由于 bundle.js 的大小已经达到了 1.6M 左右，再引入 styled-components 只怕会更大，所以暂时只能通过 style 样式在代码里写，当然，这个是不能实现比如说在 hover 状态下改变 css 样式，对于这个问题，暂未想到比较好的解决方案</p>\n<h2 id="nginx-相关设置"><a href="#nginx-%E7%9B%B8%E5%85%B3%E8%AE%BE%E7%BD%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>nginx 相关设置</h2>\n<h3 id="跨域设置-cookie"><a href="#%E8%B7%A8%E5%9F%9F%E8%AE%BE%E7%BD%AE-cookie" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>跨域设置 cookie</h3>\n<p>由于顾客端是未知域名，所以涉及到跨域设置 cookie 的问题，需要前后端同时设置才能做到跨域设置 cookie</p>\n<h3 id="背景知识"><a href="#%E8%83%8C%E6%99%AF%E7%9F%A5%E8%AF%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>背景知识</h3>\n<p>CORS 把 HTTP 请求分成两类，不同类别按不同的策略进行跨域资源共享协商。</p>\n<ol>\n<li>\n<p>简单跨域请求</p>\n<p>当 HTTP 请求出现以下两种情况时，浏览器认为是简单跨域请求：</p>\n<ol>\n<li>请求方法是 GET、HEAD 或者 POST，并且当请求方法是 POST 时，Content-Type 必须是 application/x-www-form-urlencoded, multipart/form-data 或着 text/plain 中的一个值。</li>\n<li>请求中没有自定义 HTTP 头部。</li>\n</ol>\n<p>对于简单跨域请求，浏览器要做的就是在 HTTP 请求中添加 Origin Header，将 JavaScript 脚本所在域填充进去，向其他域的服务器请求资源。服务器端收到一个简单跨域请求后，根据资源权限配置，在响应头中添加 Access-Control-Allow-Origin Header。浏览器收到响应后，查看 Access-Control-Allow-Origin Header，如果当前域已经得到授权，则将结果返回给 JavaScript，否则浏览器忽略此次响应。</p>\n</li>\n<li>\n<p>带预检 (Preflighted) 的跨域请求</p>\n<p>当 HTTP 请求出现以下两种情况时，浏览器认为是带预检 (Preflighted) 的跨域请求：</p>\n<ol>\n<li>除 GET、HEAD 和 POST(only with application/x-www-form-urlencoded, multipart/form-data, text/plain Content-Type) 以外的其他 HTTP 方法。</li>\n<li>请求中出现自定义 HTTP 头部。</li>\n</ol>\n<p>带预检 (Preflighted) 的跨域请求需要浏览器在发送真实 HTTP 请求之前先发送一个 OPTIONS 的预检请求，检测服务器端是否支持真实请求进行跨域资源访问，真实请求的信息在 OPTIONS 请求中通过 Access-Control-Request-Method Header 和 Access-Control-Request-Headers Header 描述，此外与简单跨域请求一样，浏览器也会添加 Origin Header。服务器端接到预检请求后，根据资源权限配置，在响应头中放入 Access-Control-Allow-Origin Header、Access-Control-Allow-Methods 和 Access-Control-Allow-Headers Header，分别表示允许跨域资源请求的域、请求方法和请求头。此外，服务器端还可以加入 Access-Control-Max-Age Header，允许浏览器在指定时间内，无需再发送预检请求进行协商，直接用本次协商结果即可。浏览器根据 OPTIONS 请求返回的结果来决定是否继续发送真实的请求进行跨域资源访问，这个过程对真实请求的调用者来说是透明的。</p>\n</li>\n</ol>\n<p>XMLHttpRequest 支持通过 withCredentials 属性实现在跨域请求携带身份信息 (Credential，例如 Cookie 或者 HTTP 认证信息)。浏览器将携带 Cookie Header 的请求发送到服务器端后，如果服务器没有响应 Access-Control-Allow-Credentials Header，那么浏览器会忽略掉这次响应。</p>\n<p>这里讨论的 HTTP 请求是指由 Ajax XMLHttpRequest 对象发起的，所有的 CORS HTTP 请求头都可由浏览器填充，无需在 XMLHttpRequest 对象中设置。以下是 CORS 协议规定的 HTTP 头，用来进行浏览器发起跨域资源请求时进行协商：</p>\n<ol>\n<li>Origin。HTTP 请求头，任何涉及 CORS 的请求都必需携带。</li>\n<li>Access-Control-Request-Method。HTTP 请求头，在带预检 (Preflighted) 的跨域请求中用来表示真实请求的方法。</li>\n<li>Access-Control-Request-Headers。HTTP 请求头，在带预检 (Preflighted) 的跨域请求中用来表示真实请求的自定义 Header 列表。</li>\n<li>Access-Control-Allow-Origin。HTTP 响应头，指定服务器端允许进行跨域资源访问的来源域。可以用通配符 * 表示允许任何域的 JavaScript 访问资源，但是在响应一个携带身份信息 (Credential) 的 HTTP 请求时，Access-Control-Allow-Origin 必需指定具体的域，不能用通配符。</li>\n<li>Access-Control-Allow-Methods。HTTP 响应头，指定服务器允许进行跨域资源访问的请求方法列表，一般用在响应预检请求上。</li>\n<li>Access-Control-Allow-Headers。HTTP 响应头，指定服务器允许进行跨域资源访问的请求头列表，一般用在响应预检请求上。</li>\n<li>Access-Control-Max-Age。HTTP 响应头，用在响应预检请求上，表示本次预检响应的有效时间。在此时间内，浏览器都可以根据此次协商结果决定是否有必要直接发送真实请求，而无需再次发送预检请求。</li>\n<li>Access-Control-Allow-Credentials。HTTP 响应头，凡是浏览器请求中携带了身份信息，而响应头中没有返回 Access-Control-Allow-Credentials:true 的，浏览器都会忽略此次响应。</li>\n</ol>\n<h4 id="后端"><a href="#%E5%90%8E%E7%AB%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>后端</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="55473276270911500000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# 设置到某个文件下的别名，可以通过 /im 访问到调试端\nlocation ^~ /im {\n  alias /home/frontend/pony/;\n}\n# 设置到某个文件下的别名，可以通过 /bundle.js 直接访问到 bundle.js\nlocation = /bundle.js {\n  alias /home/frontend/pony/bundle.js;\n}\n# 反代设置跨域并允许设置 cookie\nlocation /service-tp-api/ {\n  add_header Access-Control-Allow-Credentials true;  # 是否允许发送 Cookie\n  add_header Access-Control-Allow-Origin \\$http_origin; # 这里 \\$http_origin 代表引用 bundle.js 的网站域名（真实域名），不能设置为 * ，否则不能成功设置 cookie\n  add_header Access-Control-Allow-Methods \'GET, POST, OPTIONS\'; # 用到哪些 HTTP 方法\n  add_header Access-Control-Allow-Headers \'DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization,Cookie,Set-Cookie,x-requested-with,content-type,pragma\'; # 允许使用的 header 字段，可以查看自己的 request 来进行添加\n\n  if (\\$request_method = \'OPTIONS\') {\n    # 跨域预检\n    return 204;\n  }\n\n  # 以下是反代到哪里\n  proxy_pass http://localhost:10602/api/im-service/;\n  proxy_redirect off;\n  proxy_set_header Host \\$host;\n  proxy_set_header X-Real-IP \\$remote_addr;\n  proxy_set_header X-Forward-For \\$proxy_add_x_forwarded_for;\n}`, `55473276270911500000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token comment"># 设置到某个文件下的别名，可以通过 /im 访问到调试端</span>\nlocation ^~ /im <span class="token punctuation">{</span>\n  <span class="token builtin class-name">alias</span> /home/frontend/pony/<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token comment"># 设置到某个文件下的别名，可以通过 /bundle.js 直接访问到 bundle.js</span>\nlocation <span class="token operator">=</span> /bundle.js <span class="token punctuation">{</span>\n  <span class="token builtin class-name">alias</span> /home/frontend/pony/bundle.js<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token comment"># 反代设置跨域并允许设置 cookie</span>\nlocation /service-tp-api/ <span class="token punctuation">{</span>\n  add_header Access-Control-Allow-Credentials <span class="token boolean">true</span><span class="token punctuation">;</span>  <span class="token comment"># 是否允许发送 Cookie</span>\n  add_header Access-Control-Allow-Origin <span class="token variable">$http_origin</span><span class="token punctuation">;</span> <span class="token comment"># 这里 $http_origin 代表引用 bundle.js 的网站域名（真实域名），不能设置为 * ，否则不能成功设置 cookie</span>\n  add_header Access-Control-Allow-Methods <span class="token string">\'GET, POST, OPTIONS\'</span><span class="token punctuation">;</span> <span class="token comment"># 用到哪些 HTTP 方法</span>\n  add_header Access-Control-Allow-Headers <span class="token string">\'DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization,Cookie,Set-Cookie,x-requested-with,content-type,pragma\'</span><span class="token punctuation">;</span> <span class="token comment"># 允许使用的 header 字段，可以查看自己的 request 来进行添加</span>\n\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$request_method</span> <span class="token operator">=</span> <span class="token string">\'OPTIONS\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment"># 跨域预检</span>\n    <span class="token builtin class-name">return</span> <span class="token number">204</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token comment"># 以下是反代到哪里</span>\n  proxy_pass http://localhost:10602/api/im-service/<span class="token punctuation">;</span>\n  proxy_redirect off<span class="token punctuation">;</span>\n  proxy_set_header Host <span class="token variable">$host</span><span class="token punctuation">;</span>\n  proxy_set_header X-Real-IP <span class="token variable">$remote_addr</span><span class="token punctuation">;</span>\n  proxy_set_header X-Forward-For <span class="token variable">$proxy_add_x_forwarded_for</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="前端"><a href="#%E5%89%8D%E7%AB%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>前端</h4>\n<p>主要就是 fetch 方法里面添加 mode 和 credentials 字段，或者如果是 xhr 的话设置 withCredentials</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="25875680661747814000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`export function createDebugUserInfo(data) {\n  return httpFetch(\'/service-tp-api/create-debug-user\', {\n    method: \'POST\',\n    data,\n    mode: \'cors\',\n    credentials: \'include\'\n  });\n}`, `25875680661747814000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createDebugUserInfo</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token function">httpFetch</span><span class="token punctuation">(</span><span class="token string">\'/service-tp-api/create-debug-user\'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>\n    method<span class="token punctuation">:</span> <span class="token string">\'POST\'</span><span class="token punctuation">,</span>\n    data<span class="token punctuation">,</span>\n    mode<span class="token punctuation">:</span> <span class="token string">\'cors\'</span><span class="token punctuation">,</span>\n    credentials<span class="token punctuation">:</span> <span class="token string">\'include\'</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>以上更新于<code class="language-text">2019-5-11 17:52:48</code></p>\n<hr>\n<h2 id="光标位置的读取写入"><a href="#%E5%85%89%E6%A0%87%E4%BD%8D%E7%BD%AE%E7%9A%84%E8%AF%BB%E5%8F%96%E5%86%99%E5%85%A5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>光标位置的读取写入</h2>\n<p>由于要实现中间插入标签或者换行符的效果，光标位置的读取与写入还是非常重要的，否则光标会“乱飘”</p>\n<h3 id="读取光标位置"><a href="#%E8%AF%BB%E5%8F%96%E5%85%89%E6%A0%87%E4%BD%8D%E7%BD%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>读取光标位置</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="3563644741477567500"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function getCursorPosition(textDom) {\n  let cursorPos = 0;\n  if (document.selection) {\n    // IE Support\n    textDom.focus();\n    const selectRange = document.selection.createRange();\n    selectRange.moveStart(\'character\', -textDom.value.length);\n    cursorPos = selectRange.text.length;\n  } else if (textDom.selectionStart || textDom.selectionStart === 0) {\n    // Firefox support\n    cursorPos = textDom.selectionStart;\n  }\n  return cursorPos;\n}`, `3563644741477567500`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">getCursorPosition</span><span class="token punctuation">(</span><span class="token parameter">textDom</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">let</span> cursorPos <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>document<span class="token punctuation">.</span>selection<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// IE Support</span>\n    textDom<span class="token punctuation">.</span><span class="token function">focus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> selectRange <span class="token operator">=</span> document<span class="token punctuation">.</span>selection<span class="token punctuation">.</span><span class="token function">createRange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    selectRange<span class="token punctuation">.</span><span class="token function">moveStart</span><span class="token punctuation">(</span><span class="token string">\'character\'</span><span class="token punctuation">,</span> <span class="token operator">-</span>textDom<span class="token punctuation">.</span>value<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    cursorPos <span class="token operator">=</span> selectRange<span class="token punctuation">.</span>text<span class="token punctuation">.</span>length<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>textDom<span class="token punctuation">.</span>selectionStart <span class="token operator">||</span> textDom<span class="token punctuation">.</span>selectionStart <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// Firefox support</span>\n    cursorPos <span class="token operator">=</span> textDom<span class="token punctuation">.</span>selectionStart<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">return</span> cursorPos<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="写入光标位置"><a href="#%E5%86%99%E5%85%A5%E5%85%89%E6%A0%87%E4%BD%8D%E7%BD%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>写入光标位置</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="88591061135794370000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function setCursorPosition(elem, index) {\n  const val = elem.value;\n  const len = val.length;\n\n  // 超过文本长度直接返回\n  if (len < index) return;\n  // 注意这里的 setTimeout 延迟写入，否则不生效\n  setTimeout(() => {\n    elem.focus();\n    if (elem.setSelectionRange) {\n      // 标准浏览器\n      elem.setSelectionRange(index, index);\n    } else {\n      // IE9-\n      const range = elem.createTextRange();\n      range.moveStart(\'character\', -len);\n      range.moveEnd(\'character\', -len);\n      range.moveStart(\'character\', index);\n      range.moveEnd(\'character\', 0);\n      range.select();\n    }\n  }, 0);\n}`, `88591061135794370000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">setCursorPosition</span><span class="token punctuation">(</span><span class="token parameter">elem<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> val <span class="token operator">=</span> elem<span class="token punctuation">.</span>value<span class="token punctuation">;</span>\n  <span class="token keyword">const</span> len <span class="token operator">=</span> val<span class="token punctuation">.</span>length<span class="token punctuation">;</span>\n\n  <span class="token comment">// 超过文本长度直接返回</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">&lt;</span> index<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>\n  <span class="token comment">// 注意这里的 setTimeout 延迟写入，否则不生效</span>\n  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    elem<span class="token punctuation">.</span><span class="token function">focus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>elem<span class="token punctuation">.</span>setSelectionRange<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 标准浏览器</span>\n      elem<span class="token punctuation">.</span><span class="token function">setSelectionRange</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n      <span class="token comment">// IE9-</span>\n      <span class="token keyword">const</span> range <span class="token operator">=</span> elem<span class="token punctuation">.</span><span class="token function">createTextRange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      range<span class="token punctuation">.</span><span class="token function">moveStart</span><span class="token punctuation">(</span><span class="token string">\'character\'</span><span class="token punctuation">,</span> <span class="token operator">-</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      range<span class="token punctuation">.</span><span class="token function">moveEnd</span><span class="token punctuation">(</span><span class="token string">\'character\'</span><span class="token punctuation">,</span> <span class="token operator">-</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      range<span class="token punctuation">.</span><span class="token function">moveStart</span><span class="token punctuation">(</span><span class="token string">\'character\'</span><span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      range<span class="token punctuation">.</span><span class="token function">moveEnd</span><span class="token punctuation">(</span><span class="token string">\'character\'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      range<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>以上更新于<code class="language-text">2019-5-22 10:01:50</code></p>\n<hr>\n<h1 id="最终实现效果"><a href="#%E6%9C%80%E7%BB%88%E5%AE%9E%E7%8E%B0%E6%95%88%E6%9E%9C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>最终实现效果</h1>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2019-05-11-17-58-09-aaffb4e7585ee5a923cfe6afde592009-db987.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 782px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 26.08695652173913%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAIAAADKYVtkAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAArElEQVQY023NyW7FMAgF0Pz/R1ZqpCappzgDBGyMH4k6LNqrI4QXvgxuWt0c0oqX9JOagWf+7Df+3zCO+f0tjvPpAiWQzD2TZtaN1Zb1W7p+RYO3gbBA2LeUvYMQ+QTOB02pTLFkEDgYUaqoSq1VRZoa1f5kODY8lrTF7FJdAn0GmgNNnj48LZEXT7Onfb/KhYDCJEK1Sfv6DAkKkpU1a3x067Vh7ht3nkf/mxd3kCGAW/E3OwAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2019 05 11 17 58 09" title="" data-src="/static/2019-05-11-17-58-09-aaffb4e7585ee5a923cfe6afde592009-db987.png" data-srcset="/static/2019-05-11-17-58-09-aaffb4e7585ee5a923cfe6afde592009-18266.png 200w,\n/static/2019-05-11-17-58-09-aaffb4e7585ee5a923cfe6afde592009-975aa.png 400w,\n/static/2019-05-11-17-58-09-aaffb4e7585ee5a923cfe6afde592009-db987.png 782w" data-sizes="(max-width: 782px) 100vw, 782px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2019-05-11-17-55-32-eaf72aa81e898deba5783d0723a54319-a484c.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 577px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 139.3414211438475%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAcCAIAAADuuAg3AAAACXBIWXMAAA7DAAAOwwHHb6hkAAAC0klEQVQ4y72TS0/UQBzA93tggvHghYOJBw+ePPMhjCePfg58xFfAiBpBMIBAEFgCshpFAZfHLshjee2Tbru7fW2n7XQ603Zap0gWhAUhUf/5HWY685vOzP8/keuxjjvx5JWJp03jTy6PPWwcvX/xZC5FH1wYuftsfZ6YjqQZkRufultTuasf2q7F2prGHzcMt7Dhk2gcvdcw0tK6Ft+XEyKXkPKLFW6hwiVFflkWlqU95N9YkvglMWRR5NKSXAWWCmCEEo9i6hOGh3QDyCrUdAsYlqabqsbaIUD3bCecSTw2TQWWrJmhDJFdQ9N1RVU1AERVFWSpJEtKVWPdqgZMiGrTJM1UfskWwjWQTRgYO7uamlGlvKYYCNt7Hw9Pqy8frBJCUL2hP8un85fkvXPaCJ2AjdEpsm3jbDbPFSt+EPh+HQhxoGXXl4njUqJSq0gt3oOCZ5U8XfBgibVdJHmea2NyXJY1QwFmxPECxE2Cjdco3YUzr3Cu3d5uR1vP8c4La6eH2ObxM7MKMXQbGjhC3ICUpqvbA0p+AhbelTMxLfceFAZh9g0q9DgYHpdFzVivlBkR1w1kfim3ESvP9ILNbjXbp271s1XMTLSS6mO7ZueqbZs1XOwuCsVb3wdvxgcjjhuYwpS41mGuvlyLTi70fwapt3ah19kdMrPdPqtplx6RkwLfPNXV/LUzlKvFL/pOJ+b7Ut+GEx/HN+cGVlbj6eQYmB0KHOJ43uELY5UnqPo0l58t5tltBz5MO9yKWC6JiTkorCPAI1M0+RlL5sNUOUdTJWvQ0JFp2BFWCRCaAOisWnzqU+r5LKjL8FhnP+hhVN0KU83y7DgEQsuE0GVXd7aoGmj/PVNKga5jTIIzx4Ec7pHS4DxxIAfnj/8uszfGckB9/9//mV0kJphlmdVJ4NIf1dKdRLQtPafolnIW2SGE5Z8tEbh+UuVvzw892pqpyT8B/ZABox2pPncAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2019 05 11 17 55 32" title="" data-src="/static/2019-05-11-17-55-32-eaf72aa81e898deba5783d0723a54319-a484c.png" data-srcset="/static/2019-05-11-17-55-32-eaf72aa81e898deba5783d0723a54319-64be4.png 200w,\n/static/2019-05-11-17-55-32-eaf72aa81e898deba5783d0723a54319-6870d.png 400w,\n/static/2019-05-11-17-55-32-eaf72aa81e898deba5783d0723a54319-a484c.png 577w" data-sizes="(max-width: 577px) 100vw, 577px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>',
id:"/home/runner/work/GatsbyBlog/GatsbyBlog/blog/记一次组件打包为链接的实践/index.md absPath of file >>> MarkdownRemark",timeToRead:7,frontmatter:{date:"2019-05-11 14:47:57",path:"/components-pack-as-library/",tags:"前端, 前端构建工具, webpack, 预研",title:"记一次组件打包为链接的实践",draft:null}}],length:30,tag:"预研",pagesSum:6,page:5}}}});