webpackJsonp([0x7b71d9db271c],{1337:function(n,a){n.exports={data:{site:{siteMetadata:{description:'前端工程师，黑猫女王控，欢迎勾搭，技术相关<a href="https://github.com/towavephone" target="_blank">@towavephone</a>，QQ闲聊<a href="tencent://AddContact/?fromId=45&fromSubId=1&subcmd=all&uin=634407147&website=www.oicqzone.com">@towave</a>，bili关注<a href="https://space.bilibili.com/11507708#/" target="_blank">@towave</a>',siteUrl:"https://blog.towavephone.com"}}},pathContext:{posts:[{excerpt:"背景 在线上部署期间，或者用户长时间没有访问网页等等各种情况，有一定概率会出现以下形式的报错，导致网页白屏 原因与方案 由于现代前端工具链打包出来的，尤其是 webpack 的项目，其主入口默认不缓存，其他文件长期缓存，缓存的文件通过改变文件名（一般是 hash）来更新 所以在部署期间或者用户没有长时间打开网页，可能会请求已被删除的对应的 chunk 或者 chunk…",html:'<h1 id="背景"><a href="#%E8%83%8C%E6%99%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>背景</h1>\n<p>在线上部署期间，或者用户长时间没有访问网页等等各种情况，有一定概率会出现以下形式的报错，导致网页白屏</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="88247296648418820000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`Uncaught ChunkLoadError: Loading chunk <CHUNK_NAME> failed.\n(error: <WEBSITE_PATH>/<CHUNK_NAME>-<CHUNK_HASH>.js)`, `88247296648418820000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">Uncaught ChunkLoadError: Loading chunk <span class="token operator">&lt;</span>CHUNK_NAME<span class="token operator">></span> failed.\n<span class="token punctuation">(</span>error: <span class="token operator">&lt;</span>WEBSITE_PATH<span class="token operator">></span>/<span class="token operator">&lt;</span>CHUNK_NAME<span class="token operator">></span>-<span class="token operator">&lt;</span>CHUNK_HASH<span class="token operator">></span>.js<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<h1 id="原因与方案"><a href="#%E5%8E%9F%E5%9B%A0%E4%B8%8E%E6%96%B9%E6%A1%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>原因与方案</h1>\n<p>由于现代前端工具链打包出来的，尤其是 webpack 的项目，其主入口默认不缓存，其他文件长期缓存，缓存的文件通过改变文件名（一般是 hash）来更新</p>\n<p>所以在部署期间或者用户没有长时间打开网页，可能会请求已被删除的对应的 chunk 或者 chunk 虽然路径，文件名没变，但是内容改变导致有概率的白屏，所以针对此情况，有以下方案</p>\n<ol>\n<li>缓存所有版本的文件，但会造成空间浪费</li>\n<li>对打包出来的文件都不做缓存，但对服务器有很大压力</li>\n<li>可以通过一个 websocket 链接或者轮询来主动告知浏览器更新版本，但此方案过于繁重且需要后端支持</li>\n<li>对报错的文件重试，超过一定次数白屏，或者主动告知用户刷新页面</li>\n</ol>\n<p>综上，采用方案 4</p>\n<h1 id="技术选型"><a href="#%E6%8A%80%E6%9C%AF%E9%80%89%E5%9E%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>技术选型</h1>\n<p>对于方案 4，同样有 2 大类，编译时或运行时，选型对比如下</p>\n<table>\n  <thead>\n    <tr>\n      <th>类型</th>\n      <th>序号</th>\n      <th>选型</th>\n      <th>优点</th>\n      <th>缺点</th>\n   </tr>\n   </thead>\n  <tbody>\n   <tr>\n      <td rowspan="2">运行时</td>\n      <td>1</td>\n      <td>\n         <a href="https://github.com/Nikaple/assets-retry" target="_blank">assets-retry</a> 以及 <a href="https://github.com/Nikaple/assets-retry/blob/master/README-cn.md" target="_blank">原理</a>\n      </td>\n      <td>接入简单</td>\n      <td>重试的元素种类太多，对于白屏问题，只需要保证 js 需要重试</td>\n   </tr>\n   <tr>\n      <td>2</td>\n      <td>\n         重写 react lazy 方法，对报错进行重试\n      </td>\n      <td>实现简单</td>\n      <td>\n         <ol>\n            <li>\n               不能监听到主入口的报错，需要用 window.error 补齐\n            </li>\n            <li>\n               需要改动原始代码\n            </li>\n            <li>\n               由于 webpack 的 chunk 加载机制，失败的 chunk 不能重试，原理见上面\n            </li>\n         </ol>\n      </td>\n    </tr>\n    <tr>\n      <td rowspan="2">编译时</td>\n      <td>3</td>\n      <td>\n         <a href="https://github.com/mattlewis92/webpack-retry-chunk-load-plugin" target="_blank">webpack-retry-chunk-load-plugin</a>\n      </td>\n      <td>\n         接入简单，很方便的实现 chunk 重试\n      </td>\n      <td>\n         不能让主入口报错重试\n      </td>\n    </tr>\n    <tr>\n      <td>4</td>\n      <td>\n         <a href="https://github.com/mattlewis92/webpack-retry-chunk-load-plugin" target="_blank">webpack-retry-chunk-load-plugin</a> 以及\n         <a href="https://gist.github.com/mishani0x0ef/b15a969c016fa01b85f413b712c40fa1" target="_blank">html-tag-attributes-plugin</a>\n      </td>\n      <td>\n         接入简单\n      </td>\n      <td>\n         需要自己实现主入口报错重试逻辑\n      </td>\n    </tr>\n   </tbody>\n</table>\n<p>其他参考链接如下:</p>\n<ol>\n<li><a href="https://dev.to/igor_bykov/handle-loading-errors-fallback-with-htmlwebpackplugin-2d31" target="_blank" rel="nofollow noreferrer noopener">handle-loading-errors-fallback-with-htmlwebpackplugin</a></li>\n<li><a href="https://baijiahao.baidu.com/s?id=1776343703094638001&#x26;wfr=spider&#x26;for=pc" target="_blank" rel="nofollow noreferrer noopener">如何解决 JS 脚本加载失败的问题</a></li>\n<li><a href="https://stackoverflow.com/questions/69047420/webpack-code-splitting-chunkloaderror-loading-chunk-x-failed-but-the-chunk-e" target="_blank" rel="nofollow noreferrer noopener">webpack-code-splitting-chunkloaderror-loading-chunk-x-failed-but-the-chunk-e</a></li>\n</ol>\n<p>最终采用选型 4</p>\n<h1 id="实现过程"><a href="#%E5%AE%9E%E7%8E%B0%E8%BF%87%E7%A8%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>实现过程</h1>\n<p>预研过程包含选型 2 与 4，注意这里的重试需要有间隔时间以及需要带额外的 <code class="language-text">?</code> 参数防止缓存生效</p>\n<h2 id="重写-react-lazy-方法"><a href="#%E9%87%8D%E5%86%99-react-lazy-%E6%96%B9%E6%B3%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>重写 react lazy 方法</h2>\n<p>使用时可以直接替代 react 的 lazy 方法，但由于上面提到的缺点不采用此方案</p>\n<p>importRetry.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="65012580977434050000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import * as React from \'react\';\n\nconst noop = () => {};\nconst strategies = {\n   PARSE_ERROR_MESSAGE: (error, _) => {\n      const url = new URL(error.request);\n      return url.href;\n   }\n};\n\nconst defaultOpts = {\n   strategy: \'PARSE_ERROR_MESSAGE\',\n   importFunction: (path) => import(/* @vite-ignore */ path),\n   logger: noop\n};\n\n/**\n * Future improvements:\n * - cache successful variations to skip unnecessary lag on subsequent reloads\n */\n// https://github.com/fatso83/retry-dynamic-import/blob/main/lib/retry.ts\nfunction createDynamicImportWithRetry(maxRetries, opts = {}) {\n   const resolvedOpts = {\n      ...defaultOpts,\n      ...opts\n   };\n   const { logger, importFunction, strategy } = resolvedOpts;\n\n   return async (importer) => {\n      try {\n         return await importer();\n      } catch (error) {\n         logger(Date.now(), \\`Importing failed: \\`, error);\n\n         const modulePath = strategies[strategy](error, importer);\n         logger(\\`Parsed url using \\${strategy}:\\${modulePath}\\`);\n\n         if (!modulePath) {\n            logger(\'Unable to determine path to module when trying to reload\');\n            // nothing we can do ...\n            throw error;\n         }\n\n         // retry x times with 2 second delay base and backoff factor of 2 (1/2, 1, 2, 4, 8 seconds)\n         //\n         for (let i = -1; i < maxRetries; i++) {\n            // add a timestamp to the url to force a reload the module (and not use the cached version - cache busting)\n            let cacheBustedPath = \\`\\${modulePath}?t=\\${+new Date()}\\`;\n            logger(Date.now(), \\`Trying re-import module using cache busted path: \\${cacheBustedPath}\\`);\n\n            try {\n               return await importFunction(cacheBustedPath);\n            } catch (e) {\n               logger(\\`Import for \\${cacheBustedPath} failed\\`);\n               await new Promise((resolve) => setTimeout(resolve, 1000 * 2 ** i));\n            }\n         }\n         throw error;\n      }\n   };\n}\n\nconst MAX_RETRY_COUNT = 5;\n\nconst defaultDynamicImportWithRetry = createDynamicImportWithRetry(MAX_RETRY_COUNT, {\n   logger: console.log\n});\n\nexport function lazy(importer) {\n   return process.env.NODE_ENV === \'development\'\n      ? React.lazy\n      : React.lazy(() => defaultDynamicImportWithRetry(importer));\n}`, `65012580977434050000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> React <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">noop</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> strategies <span class="token operator">=</span> <span class="token punctuation">{</span>\n   <span class="token function-variable function">PARSE_ERROR_MESSAGE</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> _</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>error<span class="token punctuation">.</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">return</span> url<span class="token punctuation">.</span>href<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> defaultOpts <span class="token operator">=</span> <span class="token punctuation">{</span>\n   strategy<span class="token punctuation">:</span> <span class="token string">\'PARSE_ERROR_MESSAGE\'</span><span class="token punctuation">,</span>\n   <span class="token function-variable function">importFunction</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token comment">/* @vite-ignore */</span> path<span class="token punctuation">)</span><span class="token punctuation">,</span>\n   logger<span class="token punctuation">:</span> noop\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token comment">/**\n * Future improvements:\n * - cache successful variations to skip unnecessary lag on subsequent reloads\n */</span>\n<span class="token comment">// https://github.com/fatso83/retry-dynamic-import/blob/main/lib/retry.ts</span>\n<span class="token keyword">function</span> <span class="token function">createDynamicImportWithRetry</span><span class="token punctuation">(</span><span class="token parameter">maxRetries<span class="token punctuation">,</span> opts <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">const</span> resolvedOpts <span class="token operator">=</span> <span class="token punctuation">{</span>\n      <span class="token operator">...</span>defaultOpts<span class="token punctuation">,</span>\n      <span class="token operator">...</span>opts\n   <span class="token punctuation">}</span><span class="token punctuation">;</span>\n   <span class="token keyword">const</span> <span class="token punctuation">{</span> logger<span class="token punctuation">,</span> importFunction<span class="token punctuation">,</span> strategy <span class="token punctuation">}</span> <span class="token operator">=</span> resolvedOpts<span class="token punctuation">;</span>\n\n   <span class="token keyword">return</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">importer</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">try</span> <span class="token punctuation">{</span>\n         <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">importer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token function">logger</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Importing failed: </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n         <span class="token keyword">const</span> modulePath <span class="token operator">=</span> strategies<span class="token punctuation">[</span>strategy<span class="token punctuation">]</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> importer<span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token function">logger</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Parsed url using </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>strategy<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>modulePath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>modulePath<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token function">logger</span><span class="token punctuation">(</span><span class="token string">\'Unable to determine path to module when trying to reload\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token comment">// nothing we can do ...</span>\n            <span class="token keyword">throw</span> error<span class="token punctuation">;</span>\n         <span class="token punctuation">}</span>\n\n         <span class="token comment">// retry x times with 2 second delay base and backoff factor of 2 (1/2, 1, 2, 4, 8 seconds)</span>\n         <span class="token comment">//</span>\n         <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> maxRetries<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token comment">// add a timestamp to the url to force a reload the module (and not use the cached version - cache busting)</span>\n            <span class="token keyword">let</span> cacheBustedPath <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>modulePath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">?t=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token operator">+</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n            <span class="token function">logger</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Trying re-import module using cache busted path: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>cacheBustedPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n            <span class="token keyword">try</span> <span class="token punctuation">{</span>\n               <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">importFunction</span><span class="token punctuation">(</span>cacheBustedPath<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n               <span class="token function">logger</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Import for </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>cacheBustedPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> failed</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n               <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">**</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span>\n         <span class="token punctuation">}</span>\n         <span class="token keyword">throw</span> error<span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">const</span> <span class="token constant">MAX_RETRY_COUNT</span> <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> defaultDynamicImportWithRetry <span class="token operator">=</span> <span class="token function">createDynamicImportWithRetry</span><span class="token punctuation">(</span><span class="token constant">MAX_RETRY_COUNT</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>\n   logger<span class="token punctuation">:</span> console<span class="token punctuation">.</span>log\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">lazy</span><span class="token punctuation">(</span><span class="token parameter">importer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">return</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">\'development\'</span>\n      <span class="token operator">?</span> React<span class="token punctuation">.</span>lazy\n      <span class="token punctuation">:</span> React<span class="token punctuation">.</span><span class="token function">lazy</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">defaultDynamicImportWithRetry</span><span class="token punctuation">(</span>importer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="webpack-retry-chunk-load-plugin--html-tag-attributes-plugin"><a href="#webpack-retry-chunk-load-plugin--html-tag-attributes-plugin" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>webpack-retry-chunk-load-plugin + html-tag-attributes-plugin</h2>\n<p>plugins/html-tag-attributes-plugin.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="35471255990864270000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const HtmlWebpackPlugin = require(\'html-webpack-plugin\');\n\n// For more information about plugin concepts, see: https://github.com/jantimon/html-webpack-plugin#events\nclass HtmlTagAttributesPlugin {\n   static name = \'HtmlTagAttributesPlugin\';\n\n   constructor(options) {\n      const defaultOptions = {\n         script: {}\n      };\n\n      this.options = { ...defaultOptions, ...options };\n   }\n\n   apply(compiler) {\n      compiler.hooks.compilation.tap(HtmlTagAttributesPlugin.name, (compilation) =>\n         this._hookIntoHtmlAlterAssetTags(compilation)\n      );\n   }\n\n   _hookIntoHtmlAlterAssetTags(compilation) {\n      HtmlWebpackPlugin.getHooks(compilation).alterAssetTags.tapAsync(HtmlTagAttributesPlugin.name, (data, cb) =>\n         cb(null, this._extendScriptTags(data))\n      );\n   }\n\n   _extendScriptTags(data) {\n      data.assetTags.scripts = data.assetTags.scripts.map(({ attributes, ...other }) => ({\n         ...other,\n         attributes: {\n            ...attributes,\n            ...this.options.script\n         }\n      }));\n\n      return data;\n   }\n}\n\nmodule.exports = { HtmlTagAttributesPlugin };`, `35471255990864270000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> HtmlWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'html-webpack-plugin\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// For more information about plugin concepts, see: https://github.com/jantimon/html-webpack-plugin#events</span>\n<span class="token keyword">class</span> <span class="token class-name">HtmlTagAttributesPlugin</span> <span class="token punctuation">{</span>\n   <span class="token keyword">static</span> name <span class="token operator">=</span> <span class="token string">\'HtmlTagAttributesPlugin\'</span><span class="token punctuation">;</span>\n\n   <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> defaultOptions <span class="token operator">=</span> <span class="token punctuation">{</span>\n         script<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n      <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">this</span><span class="token punctuation">.</span>options <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span>defaultOptions<span class="token punctuation">,</span> <span class="token operator">...</span>options <span class="token punctuation">}</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>compilation<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span>HtmlTagAttributesPlugin<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">compilation</span><span class="token punctuation">)</span> <span class="token operator">=></span>\n         <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_hookIntoHtmlAlterAssetTags</span><span class="token punctuation">(</span>compilation<span class="token punctuation">)</span>\n      <span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token function">_hookIntoHtmlAlterAssetTags</span><span class="token punctuation">(</span><span class="token parameter">compilation</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      HtmlWebpackPlugin<span class="token punctuation">.</span><span class="token function">getHooks</span><span class="token punctuation">(</span>compilation<span class="token punctuation">)</span><span class="token punctuation">.</span>alterAssetTags<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span>HtmlTagAttributesPlugin<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span> <span class="token operator">=></span>\n         <span class="token function">cb</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_extendScriptTags</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>\n      <span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token function">_extendScriptTags</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      data<span class="token punctuation">.</span>assetTags<span class="token punctuation">.</span>scripts <span class="token operator">=</span> data<span class="token punctuation">.</span>assetTags<span class="token punctuation">.</span>scripts<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> attributes<span class="token punctuation">,</span> <span class="token operator">...</span>other <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>\n         <span class="token operator">...</span>other<span class="token punctuation">,</span>\n         attributes<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n            <span class="token operator">...</span>attributes<span class="token punctuation">,</span>\n            <span class="token operator">...</span>this<span class="token punctuation">.</span>options<span class="token punctuation">.</span>script\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">return</span> data<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\nmodule<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span> HtmlTagAttributesPlugin <span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>config-overrides.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="81438102257567140000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const { RetryChunkLoadPlugin } = require(\'webpack-retry-chunk-load-plugin\');\nconst { HtmlTagAttributesPlugin } = require(\'./plugins/html-tag-attributes-plugin\');\n\nconst lastResortScript = &quot;window.alert(\'Frontend Is Deploying, Please Wait!\'); window.location.reload(true);&quot;;\nconst retryDelay = 4000;\nconst maxRetries = 5;\n\nconst isProd = env === \'production\';\n\nconst localConfig = override(\n   isProd &&\n      addWebpackPlugin(\n         new RetryChunkLoadPlugin({\n            // optional stringified function to get the cache busting query string appended to the script src\n            // if not set will default to appending the string \\`?cache-bust=true\\`\n            cacheBust: \\`function() {\n              return Date.now();\n            }\\`,\n            // optional value to set the amount of time in milliseconds before trying to load the chunk again. Default is 0\n            // if string, value must be code to generate a delay value. Receives retryCount as argument\n            // e.g. \\`function(retryAttempt) { return retryAttempt * 1000 }\\`\n            retryDelay,\n            // optional value to set the maximum number of retries to load the chunk. Default is 1\n            maxRetries,\n            // // optional list of chunks to which retry script should be injected\n            // // if not set will add retry script to all chunks that have webpack script loading\n            // chunks: [\'chunkName\'],\n            // optional code to be executed in the browser context if after all retries chunk is not loaded.\n            // if not set - nothing will happen and error will be returned to the chunk loader.\n            lastResortScript\n         })\n      ),\n   isProd &&\n      addWebpackPlugin(\n         new HtmlTagAttributesPlugin({\n            script: {\n               onerror: \\`\n                // const isAsyncScript = event.target.defer || event.target.async\n                // 暂时不包含对同步脚本的处理\n                let retryCount = 0\n                const retryFunc = async () => {\n                  retryCount++\n                  let cacheBustedPath = event.target.src + \'?t=\' + (+new Date())\n                    const script = document.createElement(\'script\')\n                    script.src = cacheBustedPath\n                    script.onerror = async () => {\n                      await new Promise(resolve => setTimeout(resolve, \\${retryDelay}))\n                      if (retryCount === \\${maxRetries}) {\n                        \\${lastResortScript}\n                      } else {\n                        retryFunc()\n                      }\n                    }\n                    // webpack nonce for csp\n                    const originalNonce = event.target.getAttribute(\'nonce\')\n                    if (originalNonce) {\n                        script.setAttribute(\'nonce\', originalNonce)\n                    }\n                    document.getElementsByTagName(\'head\')[0].appendChild(script)\n                }\n\n                retryFunc()\n              \\`\n            }\n         })\n      )\n);`, `81438102257567140000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> <span class="token punctuation">{</span> RetryChunkLoadPlugin <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'webpack-retry-chunk-load-plugin\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> <span class="token punctuation">{</span> HtmlTagAttributesPlugin <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./plugins/html-tag-attributes-plugin\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> lastResortScript <span class="token operator">=</span> <span class="token string">"window.alert(\'Frontend Is Deploying, Please Wait!\'); window.location.reload(true);"</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> retryDelay <span class="token operator">=</span> <span class="token number">4000</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> maxRetries <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> isProd <span class="token operator">=</span> env <span class="token operator">===</span> <span class="token string">\'production\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> localConfig <span class="token operator">=</span> <span class="token function">override</span><span class="token punctuation">(</span>\n   isProd <span class="token operator">&amp;&amp;</span>\n      <span class="token function">addWebpackPlugin</span><span class="token punctuation">(</span>\n         <span class="token keyword">new</span> <span class="token class-name">RetryChunkLoadPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n            <span class="token comment">// optional stringified function to get the cache busting query string appended to the script src</span>\n            <span class="token comment">// if not set will default to appending the string `?cache-bust=true`</span>\n            cacheBust<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">function() {\n              return Date.now();\n            }</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n            <span class="token comment">// optional value to set the amount of time in milliseconds before trying to load the chunk again. Default is 0</span>\n            <span class="token comment">// if string, value must be code to generate a delay value. Receives retryCount as argument</span>\n            <span class="token comment">// e.g. `function(retryAttempt) { return retryAttempt * 1000 }`</span>\n            retryDelay<span class="token punctuation">,</span>\n            <span class="token comment">// optional value to set the maximum number of retries to load the chunk. Default is 1</span>\n            maxRetries<span class="token punctuation">,</span>\n            <span class="token comment">// // optional list of chunks to which retry script should be injected</span>\n            <span class="token comment">// // if not set will add retry script to all chunks that have webpack script loading</span>\n            <span class="token comment">// chunks: [\'chunkName\'],</span>\n            <span class="token comment">// optional code to be executed in the browser context if after all retries chunk is not loaded.</span>\n            <span class="token comment">// if not set - nothing will happen and error will be returned to the chunk loader.</span>\n            lastResortScript\n         <span class="token punctuation">}</span><span class="token punctuation">)</span>\n      <span class="token punctuation">)</span><span class="token punctuation">,</span>\n   isProd <span class="token operator">&amp;&amp;</span>\n      <span class="token function">addWebpackPlugin</span><span class="token punctuation">(</span>\n         <span class="token keyword">new</span> <span class="token class-name">HtmlTagAttributesPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n            script<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n               onerror<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">\n                // const isAsyncScript = event.target.defer || event.target.async\n                // 暂时不包含对同步脚本的处理\n                let retryCount = 0\n                const retryFunc = async () => {\n                  retryCount++\n                  let cacheBustedPath = event.target.src + \'?t=\' + (+new Date())\n                    const script = document.createElement(\'script\')\n                    script.src = cacheBustedPath\n                    script.onerror = async () => {\n                      await new Promise(resolve => setTimeout(resolve, </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>retryDelay<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">))\n                      if (retryCount === </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>maxRetries<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">) {\n                        </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>lastResortScript<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\n                      } else {\n                        retryFunc()\n                      }\n                    }\n                    // webpack nonce for csp\n                    const originalNonce = event.target.getAttribute(\'nonce\')\n                    if (originalNonce) {\n                        script.setAttribute(\'nonce\', originalNonce)\n                    }\n                    document.getElementsByTagName(\'head\')[0].appendChild(script)\n                }\n\n                retryFunc()\n              </span><span class="token template-punctuation string">`</span></span>\n            <span class="token punctuation">}</span>\n         <span class="token punctuation">}</span><span class="token punctuation">)</span>\n      <span class="token punctuation">)</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="效果展示"><a href="#%E6%95%88%E6%9E%9C%E5%B1%95%E7%A4%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>效果展示</h1>\n<p>在主入口的 js 以及分包后的 chunk 报错后都会做重试 5 次的操作，超过 5 次弹窗提示用户在部署，点击确定后刷新页面再次重试</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-12-05-11-29-43-f7fbec7ad07fe7e42ef5d3622f3019ab-a01e8.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 64.06810035842294%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsSAAALEgHS3X78AAABUklEQVQ4y6WS3U6EMBCFef/X8Fm89MobY9wNYpbfAi30n4XjdDZrNGrM4iQn0yHk6zltM601xlFCSsldTRNSndQZ97kHtpXnbdsu33uNp5ccefGGsm5wqho0neBeU8/WdeWfrzqvCXDGY+lw96C+AScTIMQAYy0rLgusdYgx8szAn0SID9BVqaxx8D7wxjEuCCHCec/yISDDL7Wy2y0RvwBn1aMoco5bkTrRo+06iH7gdfbZwV9KtTiFuiwI0vOZB3KV7sE6B2PM7cBgJSoGCnLVM2SeZ2ju+nZgdBJlAlI8qRS/jtTThSTw7UAjIU6vkAQMziLQ7Wp6apZiG73DYVASMT9gaWrEcUDUM4IcEWgddgHJYVsc0bcdpnG8iGKb+R8OTX6EJYdOCLhhYPndDieFQMDYNohDz7E5Mm0U9jwbTxB7eIarK7iuJXc0E5wdU/R3tY72ZhqkSJAAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 12 05 11 29 43" title="" data-src="/static/2023-12-05-11-29-43-f7fbec7ad07fe7e42ef5d3622f3019ab-fee1c.png" data-srcset="/static/2023-12-05-11-29-43-f7fbec7ad07fe7e42ef5d3622f3019ab-a67b7.png 200w,\n/static/2023-12-05-11-29-43-f7fbec7ad07fe7e42ef5d3622f3019ab-0b187.png 400w,\n/static/2023-12-05-11-29-43-f7fbec7ad07fe7e42ef5d3622f3019ab-fee1c.png 800w,\n/static/2023-12-05-11-29-43-f7fbec7ad07fe7e42ef5d3622f3019ab-a01e8.png 1116w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>和 <a href="https://rsbuild.dev/plugins/list/plugin-assets-retry" target="_blank" rel="nofollow noreferrer noopener">plugin-assets-retry</a> 插件的效果异曲同工</p>',
id:"/home/runner/work/GatsbyBlog/GatsbyBlog/blog/缓存报错重试机制探究/index.md absPath of file >>> MarkdownRemark",timeToRead:5,frontmatter:{date:"2023-11-30 17:47:38",path:"/cache-error-retry-process/",tags:"前端, 预研, webpack, 前端构建工具",title:"缓存报错重试机制探究",draft:null}},{excerpt:"背景 python 的 django 后端在刚启动时内存占用上升很快，导致对应的 pod 内存溢出，很多接口响应慢 方案 需要找到哪行代码导致的内存泄漏，有以下方案 pympler scalene  (python3.8 以上，不符合) memray  (python3.7 以上，不符合) 使用 python 内置的 tracemalloc 库 由于项目用的是 python 3.6 的版本，所以采用方案 1 和…",html:'<h1 id="背景"><a href="#%E8%83%8C%E6%99%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>背景</h1>\n<p>python 的 django 后端在刚启动时内存占用上升很快，导致对应的 pod 内存溢出，很多接口响应慢</p>\n<h1 id="方案"><a href="#%E6%96%B9%E6%A1%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>方案</h1>\n<p>需要找到哪行代码导致的内存泄漏，有以下方案</p>\n<ol>\n<li><a href="https://zhuanlan.zhihu.com/p/436577356" target="_blank" rel="nofollow noreferrer noopener">pympler</a></li>\n<li><a href="https://github.com/plasma-umass/scalene" target="_blank" rel="nofollow noreferrer noopener">scalene</a> (python3.8 以上，不符合)</li>\n<li><a href="https://github.com/bloomberg/memray" target="_blank" rel="nofollow noreferrer noopener">memray</a> (python3.7 以上，不符合)</li>\n<li>使用 python 内置的 tracemalloc 库</li>\n</ol>\n<p>由于项目用的是 python 3.6 的版本，所以采用方案 1 和 4</p>\n<h1 id="实现"><a href="#%E5%AE%9E%E7%8E%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>实现</h1>\n<h2 id="内存占用检测"><a href="#%E5%86%85%E5%AD%98%E5%8D%A0%E7%94%A8%E6%A3%80%E6%B5%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>内存占用检测</h2>\n<ol>\n<li>通过接口获取当前内存占用最大的排名前几的代码行数</li>\n<li>通过接口获取当前占用内存最大的对象</li>\n</ol>\n<p><code class="language-text">controllers/app_monitor_controller.py</code></p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="47364907180869050000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import tracemalloc\nimport logging\n\nfrom controllers.wrapper import (\n    get_param, get_int_param, request_wrapper)\n\n\n@request_wrapper()\ndef get_tracemalloc(request):\n    key_type = get_param(request, \'key_type\', default=\'traceback\')\n    limit = get_int_param(request, \'limit\', default=\'10\')\n    snapshot = tracemalloc.take_snapshot()\n    snapshot = snapshot.filter_traces((\n        tracemalloc.Filter(False, &quot;<unknown>&quot;),\n        tracemalloc.Filter(\n            False, &quot;<frozen importlib._bootstrap_external>&quot;),\n        tracemalloc.Filter(\n            False, &quot;<frozen importlib._bootstrap>&quot;),\n        tracemalloc.Filter(False, tracemalloc.__file__),\n    ))\n    top_stats = snapshot.statistics(key_type)\n    top_result = []\n    for index, stat in enumerate(top_stats[:limit], 1):\n        frame = stat.traceback[0]\n        desc = &quot;#%s: %s:%s: %.1f KiB&quot; % (\n            index, frame.filename, frame.lineno, stat.size / 1024)\n        top_result.append({\n            \'desc\': desc,\n            \'traceback\': stat.traceback.format()\n        })\n\n    other = top_stats[limit:]\n    if other:\n        size = sum(stat.size for stat in other)\n\n    total = sum(stat.size for stat in top_stats)\n\n    return {\n        \'top_result\': top_result,\n        \'other_result\': &quot;Total %s, other: %.1f KiB&quot; %\n        (len(other), size / 1024),\n        \'total_size\': &quot;%.1f KiB&quot; % (total / 1024)\n    }\n\n\n@request_wrapper()\ndef get_memory(request):\n    limit = get_int_param(request, \'limit\', default=\'1\')\n    from pympler import muppy, summary\n\n    all_objects = muppy.get_objects()\n    sum1 = summary.summarize(all_objects)\n    logging.info(\'Summary -----\')\n    summary.print_(sum1)\n\n    filter_all_objects = muppy.sort(all_objects)\n    dicts = [ao for ao in filter_all_objects if isinstance(ao, dict)]\n    result = []\n    for d in dicts[-limit:]:\n        item = f\'{len(d)}, {str(d).encode(&quot;utf-8&quot;)}\'\n        result.append(item)\n\n    import objgraph\n\n    logging.info(\'Common -----\')\n    objgraph.show_most_common_types()\n\n    logging.info(\'Growth -----\')\n    objgraph.show_growth(limit=5)\n\n    return result`, `47364907180869050000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> tracemalloc\n<span class="token keyword">import</span> logging\n\n<span class="token keyword">from</span> controllers<span class="token punctuation">.</span>wrapper <span class="token keyword">import</span> <span class="token punctuation">(</span>\n    get_param<span class="token punctuation">,</span> get_int_param<span class="token punctuation">,</span> request_wrapper<span class="token punctuation">)</span>\n\n\n@request_wrapper<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">def</span> <span class="token function">get_tracemalloc</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    key_type <span class="token operator">=</span> get_param<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">\'key_type\'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">\'traceback\'</span><span class="token punctuation">)</span>\n    limit <span class="token operator">=</span> get_int_param<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">\'limit\'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">\'10\'</span><span class="token punctuation">)</span>\n    snapshot <span class="token operator">=</span> tracemalloc<span class="token punctuation">.</span>take_snapshot<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    snapshot <span class="token operator">=</span> snapshot<span class="token punctuation">.</span>filter_traces<span class="token punctuation">(</span><span class="token punctuation">(</span>\n        tracemalloc<span class="token punctuation">.</span>Filter<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token string">"&lt;unknown>"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n        tracemalloc<span class="token punctuation">.</span>Filter<span class="token punctuation">(</span>\n            <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token string">"&lt;frozen importlib._bootstrap_external>"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n        tracemalloc<span class="token punctuation">.</span>Filter<span class="token punctuation">(</span>\n            <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token string">"&lt;frozen importlib._bootstrap>"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n        tracemalloc<span class="token punctuation">.</span>Filter<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">,</span> tracemalloc<span class="token punctuation">.</span>__file__<span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token punctuation">)</span><span class="token punctuation">)</span>\n    top_stats <span class="token operator">=</span> snapshot<span class="token punctuation">.</span>statistics<span class="token punctuation">(</span>key_type<span class="token punctuation">)</span>\n    top_result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n    <span class="token keyword">for</span> index<span class="token punctuation">,</span> stat <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>top_stats<span class="token punctuation">[</span><span class="token punctuation">:</span>limit<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        frame <span class="token operator">=</span> stat<span class="token punctuation">.</span>traceback<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>\n        desc <span class="token operator">=</span> <span class="token string">"#%s: %s:%s: %.1f KiB"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>\n            index<span class="token punctuation">,</span> frame<span class="token punctuation">.</span>filename<span class="token punctuation">,</span> frame<span class="token punctuation">.</span>lineno<span class="token punctuation">,</span> stat<span class="token punctuation">.</span>size <span class="token operator">/</span> <span class="token number">1024</span><span class="token punctuation">)</span>\n        top_result<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{</span>\n            <span class="token string">\'desc\'</span><span class="token punctuation">:</span> desc<span class="token punctuation">,</span>\n            <span class="token string">\'traceback\'</span><span class="token punctuation">:</span> stat<span class="token punctuation">.</span>traceback<span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span>\n\n    other <span class="token operator">=</span> top_stats<span class="token punctuation">[</span>limit<span class="token punctuation">:</span><span class="token punctuation">]</span>\n    <span class="token keyword">if</span> other<span class="token punctuation">:</span>\n        size <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>stat<span class="token punctuation">.</span>size <span class="token keyword">for</span> stat <span class="token keyword">in</span> other<span class="token punctuation">)</span>\n\n    total <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>stat<span class="token punctuation">.</span>size <span class="token keyword">for</span> stat <span class="token keyword">in</span> top_stats<span class="token punctuation">)</span>\n\n    <span class="token keyword">return</span> <span class="token punctuation">{</span>\n        <span class="token string">\'top_result\'</span><span class="token punctuation">:</span> top_result<span class="token punctuation">,</span>\n        <span class="token string">\'other_result\'</span><span class="token punctuation">:</span> <span class="token string">"Total %s, other: %.1f KiB"</span> <span class="token operator">%</span>\n        <span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>other<span class="token punctuation">)</span><span class="token punctuation">,</span> size <span class="token operator">/</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n        <span class="token string">\'total_size\'</span><span class="token punctuation">:</span> <span class="token string">"%.1f KiB"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>total <span class="token operator">/</span> <span class="token number">1024</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n\n\n@request_wrapper<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">def</span> <span class="token function">get_memory</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    limit <span class="token operator">=</span> get_int_param<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">\'limit\'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">\'1\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">from</span> pympler <span class="token keyword">import</span> muppy<span class="token punctuation">,</span> summary\n\n    all_objects <span class="token operator">=</span> muppy<span class="token punctuation">.</span>get_objects<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    sum1 <span class="token operator">=</span> summary<span class="token punctuation">.</span>summarize<span class="token punctuation">(</span>all_objects<span class="token punctuation">)</span>\n    logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">\'Summary -----\'</span><span class="token punctuation">)</span>\n    summary<span class="token punctuation">.</span>print_<span class="token punctuation">(</span>sum1<span class="token punctuation">)</span>\n\n    filter_all_objects <span class="token operator">=</span> muppy<span class="token punctuation">.</span>sort<span class="token punctuation">(</span>all_objects<span class="token punctuation">)</span>\n    dicts <span class="token operator">=</span> <span class="token punctuation">[</span>ao <span class="token keyword">for</span> ao <span class="token keyword">in</span> filter_all_objects <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>ao<span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">)</span><span class="token punctuation">]</span>\n    result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n    <span class="token keyword">for</span> d <span class="token keyword">in</span> dicts<span class="token punctuation">[</span><span class="token operator">-</span>limit<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">:</span>\n        item <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">len</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">, </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">str</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span>\n        result<span class="token punctuation">.</span>append<span class="token punctuation">(</span>item<span class="token punctuation">)</span>\n\n    <span class="token keyword">import</span> objgraph\n\n    logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">\'Common -----\'</span><span class="token punctuation">)</span>\n    objgraph<span class="token punctuation">.</span>show_most_common_types<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n    logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">\'Growth -----\'</span><span class="token punctuation">)</span>\n    objgraph<span class="token punctuation">.</span>show_growth<span class="token punctuation">(</span>limit<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>\n\n    <span class="token keyword">return</span> result</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这里需要在项目启动的时候去开启记录内存的功能，否则上面的 <code class="language-text">get_tracemalloc</code> 功能不可用，当然这里的功能需要在使用结束后立即关闭，否则内存占用较大</p>\n<p>apps.py</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="22821336154321340000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from django.apps import AppConfig\nimport tracemalloc\nimport os\n\n# 减少 pypinyin 的内存占用\nos.environ[\'PYPINYIN_NO_PHRASES\'] = \'true\'\nos.environ[\'PYPINYIN_NO_DICT_COPY\'] = \'true\'\n\n\nclass Config(AppConfig):\n    def ready(self):\n        from entry.settings import START_RECORD_MEMORY\n        if not START_RECORD_MEMORY:\n            return\n        tracemalloc.start(25)`, `22821336154321340000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> django<span class="token punctuation">.</span>apps <span class="token keyword">import</span> AppConfig\n<span class="token keyword">import</span> tracemalloc\n<span class="token keyword">import</span> os\n\n<span class="token comment"># 减少 pypinyin 的内存占用</span>\nos<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">\'PYPINYIN_NO_PHRASES\'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">\'true\'</span>\nos<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">\'PYPINYIN_NO_DICT_COPY\'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">\'true\'</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">Config</span><span class="token punctuation">(</span>AppConfig<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">ready</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">from</span> entry<span class="token punctuation">.</span>settings <span class="token keyword">import</span> START_RECORD_MEMORY\n        <span class="token keyword">if</span> <span class="token keyword">not</span> START_RECORD_MEMORY<span class="token punctuation">:</span>\n            <span class="token keyword">return</span>\n        tracemalloc<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="耗时检测"><a href="#%E8%80%97%E6%97%B6%E6%A3%80%E6%B5%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>耗时检测</h2>\n<p>主要用来统计函数执行过程中每行耗时及调用次数</p>\n<p><code class="language-text">tools/performance_tool.py</code></p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="13204948370283299000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from cProfile import Profile\nfrom pstats import Stats\n\n\ndef print_func_cost():\n    def wrapper2(func):\n        def wrapper1(*args, **kwargs):\n            profiler = Profile()\n            # request = args[0]\n\n            result = profiler.runcall(func, *args, **kwargs)\n\n            stats = Stats(profiler)\n            stats.strip_dirs()\n            stats.sort_stats(\'cumulative\')\n            # stats.print_stats()\n            stats.print_callers()\n\n            return result\n        return wrapper1\n    return wrapper2`, `13204948370283299000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> cProfile <span class="token keyword">import</span> Profile\n<span class="token keyword">from</span> pstats <span class="token keyword">import</span> Stats\n\n\n<span class="token keyword">def</span> <span class="token function">print_func_cost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">wrapper2</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">def</span> <span class="token function">wrapper1</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            profiler <span class="token operator">=</span> Profile<span class="token punctuation">(</span><span class="token punctuation">)</span>\n            <span class="token comment"># request = args[0]</span>\n\n            result <span class="token operator">=</span> profiler<span class="token punctuation">.</span>runcall<span class="token punctuation">(</span>func<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>\n\n            stats <span class="token operator">=</span> Stats<span class="token punctuation">(</span>profiler<span class="token punctuation">)</span>\n            stats<span class="token punctuation">.</span>strip_dirs<span class="token punctuation">(</span><span class="token punctuation">)</span>\n            stats<span class="token punctuation">.</span>sort_stats<span class="token punctuation">(</span><span class="token string">\'cumulative\'</span><span class="token punctuation">)</span>\n            <span class="token comment"># stats.print_stats()</span>\n            stats<span class="token punctuation">.</span>print_callers<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n            <span class="token keyword">return</span> result\n        <span class="token keyword">return</span> wrapper1\n    <span class="token keyword">return</span> wrapper2</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="效果展示"><a href="#%E6%95%88%E6%9E%9C%E5%B1%95%E7%A4%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>效果展示</h1>\n<p>由以下日志可看出，内存占用较大的部分主要在 protobuf 解码，大文件读取，pypinyin，之后的优化就可以进行下去</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="18602147236576540000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`07:56:48 apps.py:37 INFO #1: /usr/local/lib/python3.6/site-packages/google/protobuf/text_format.py:682: 114541.4 KiB\n07:56:48 apps.py:43 INFO     b\'  File &quot;文件路径&quot;, line 1580\'\n07:56:48 apps.py:43 INFO     b\'    data = text_format.Parse(data, DataTree())\'\n07:00:05 apps.py:33 INFO #2: 文件路径:1571: 66375.2 KiB\n07:00:05 apps.py:37 INFO     b&quot;data = data + open(file_path, \'r\').read()&quot;\n07:00:05 apps.py:33 INFO #8: 文件路径:1569: 2053.4 KiB\n07:00:05 apps.py:37 INFO     b&quot;data = data + open(file_path, \'r\').read()&quot;\n07:56:52 apps.py:37 INFO #5: /usr/local/lib/python3.6/site-packages/pypinyin/phrases_dict.py:45476: 2560.4 KiB\n  07:56:52 apps.py:43 INFO     b\'  File &quot;文件路径&quot;, line 26\'\n07:56:52 apps.py:43 INFO     b\'    from pypinyin import lazy_pinyin\'`, `18602147236576540000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">07:56:48 apps.py:37 INFO <span class="token comment">#1: /usr/local/lib/python3.6/site-packages/google/protobuf/text_format.py:682: 114541.4 KiB</span>\n07:56:48 apps.py:43 INFO     b<span class="token string">\'  File "文件路径", line 1580\'</span>\n07:56:48 apps.py:43 INFO     b<span class="token string">\'    data = text_format.Parse(data, DataTree())\'</span>\n07:00:05 apps.py:33 INFO <span class="token comment">#2: 文件路径:1571: 66375.2 KiB</span>\n07:00:05 apps.py:37 INFO     b<span class="token string">"data = data + open(file_path, \'r\').read()"</span>\n07:00:05 apps.py:33 INFO <span class="token comment">#8: 文件路径:1569: 2053.4 KiB</span>\n07:00:05 apps.py:37 INFO     b<span class="token string">"data = data + open(file_path, \'r\').read()"</span>\n07:56:52 apps.py:37 INFO <span class="token comment">#5: /usr/local/lib/python3.6/site-packages/pypinyin/phrases_dict.py:45476: 2560.4 KiB</span>\n  07:56:52 apps.py:43 INFO     b<span class="token string">\'  File "文件路径", line 26\'</span>\n07:56:52 apps.py:43 INFO     b<span class="token string">\'    from pypinyin import lazy_pinyin\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>',
id:"/home/runner/work/GatsbyBlog/GatsbyBlog/blog/Python 后端 oom 处理过程/index.md absPath of file >>> MarkdownRemark",timeToRead:3,frontmatter:{date:"2023-11-30 17:46:51",path:"/python-backend-oom-process/",tags:"后端, python, 预研",title:"Python 后端 oom 处理过程",draft:null}},{excerpt:"背景 在 chrome 浏览器上，用高德地图的 CircleMarker, PathSimplifier 分别画点和线时候，需要实现点在线的上面的效果，此时在 windows 系统上不能正常显示红点（左侧），在 ubuntu 系统下却正常显示（右侧），如下图所示 原因 红点是由  CircleMarker  组件实现，而下面的线则是  PathSimplifier  实现，在 chrome 浏览器下不同系统的表现为： window: CircleMarker 由 canvas…",html:'<h1 id="背景"><a href="#%E8%83%8C%E6%99%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>背景</h1>\n<p>在 chrome 浏览器上，用高德地图的 CircleMarker, PathSimplifier 分别画点和线时候，需要实现点在线的上面的效果，此时在 windows 系统上不能正常显示红点（左侧），在 ubuntu 系统下却正常显示（右侧），如下图所示</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-11-28-17-00-49-8eed1f43729ab0534e4ba15a630ed339-16a51.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 324px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 44.1358024691358%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsSAAALEgHS3X78AAACWElEQVQozz2SWU9TARCF77/0RR80MYawxBaUfW2lUiWllKVFKQSoFJTFaqkgmwgCSgCxRaCAQpe7dW8pxWg+ryHx4cuZzGTOyzlCbVMdhkcN2LvMWNtqsD+pZKTjAVNd5czadXwermKr7y6Hcw7S2QyZeJRUXCKhRokrETIphWxaJZtSSSdlBHHeyvG7DvZ9NjZetrHoMuFxGnH3NDLUWceYw4jFUMKEu5/LyxzpXJxUOkYsoaAmZLL5lEaafCFLrpBByL9vhBUDrLfBjg32nXA0BieTcOrR1AvBaXIna6iiSDawQ/IwQOLAr6lf0z2SR37tHiAb/IbwuKkMU0MRlpZi7KZSBs3FvOmtYNFZxdpQLYFJI2FPE/KuR3s+JOQaJNFjIu9oIGer5sKi4+KpnrzpHvmamwjSro/gRzfbvj5WxtvxOpt57WxlpKuBbpMOi1FP08PbjL54RuHnKT+e20m2V3PpqCc/YKQwZKbg7uRqysHVmA3h98kynH8AcR3ULxqb2rwKZwtw7OPq+1uyWy7EvXnCx0HU7Q3kT0soy3PE15cR/XtE9veRAgEiAT+CuUXPgK2R/vYKRq0VeB2VrA7X8/WVgbOZNmJLVn5t2skdLBAJnRFSRM4ViZAqEY7LnMcVQhqSRlgLSjgaKeHIXc6msxRvdxnDFj09WnX+VchqrqO1WU9LbRETY04y6SQxKUxCiV6jilp1oihyhJh8vRM6zLW4LPfZGNAhjxfB9C2YvMGfqTtczFSSnGvldLSEw9leEqk0STVCMib9J66ZKpqZLEWQxBB/AQBvSOSbuQBPAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 11 28 17 00 49" title="" data-src="/static/2023-11-28-17-00-49-8eed1f43729ab0534e4ba15a630ed339-16a51.png" data-srcset="/static/2023-11-28-17-00-49-8eed1f43729ab0534e4ba15a630ed339-6752f.png 200w,\n/static/2023-11-28-17-00-49-8eed1f43729ab0534e4ba15a630ed339-16a51.png 324w" data-sizes="(max-width: 324px) 100vw, 324px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h1 id="原因"><a href="#%E5%8E%9F%E5%9B%A0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>原因</h1>\n<p>红点是由 <a href="https://lbs.amap.com/api/javascript-api-v2/documentation#circlemarker" target="_blank" rel="nofollow noreferrer noopener">CircleMarker</a> 组件实现，而下面的线则是 <a href="https://lbs.amap.com/api/amap-ui/reference-amap-ui/mass-data/pathsimplifier" target="_blank" rel="nofollow noreferrer noopener">PathSimplifier</a> 实现，在 chrome 浏览器下不同系统的表现为：</p>\n<ol>\n<li>window: CircleMarker 由 canvas 渲染，且层级和高德地图图层一致，而 PathSimplifier 的层级比高德地图图层要高</li>\n<li>ubuntu: CircleMarker 由 svg 渲染，层级比 PathSimplifier 要高</li>\n</ol>\n<h1 id="优缺点"><a href="#%E4%BC%98%E7%BC%BA%E7%82%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>优缺点</h1>\n<p>综上所述，需要统一不同系统下的渲染方式，优缺点对比如下</p>\n<table>\n<thead>\n<tr>\n<th align="center">渲染方式</th>\n<th align="center">优点</th>\n<th align="center">缺点</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align="center">canvas</td>\n<td align="center">性能好</td>\n<td align="center">实现成本高，即需要生成比 PathSimplifier 所在层级要高的新图层</td>\n</tr>\n<tr>\n<td align="center">svg</td>\n<td align="center">实现方便，有现成的 \n<a href="https://lbs.amap.com/api/amap-ui/reference-amap-ui/overlay/svgmarker" target="_blank" rel="nofollow noreferrer noopener">SvgMarker</a></td>\n<td align="center">性能差，但对于这个场景来说只需要鼠标悬浮上去才渲染一条路线上的点，即性能要求不高</td>\n</tr>\n</tbody>\n</table>\n<p>最终采用 SvgMarker 渲染</p>\n<h1 id="效果展示"><a href="#%E6%95%88%E6%9E%9C%E5%B1%95%E7%A4%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>效果展示</h1>\n<p>以下都在 chrome 浏览器下测试：</p>\n<h2 id="修复前"><a href="#%E4%BF%AE%E5%A4%8D%E5%89%8D" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>修复前</h2>\n<p>windows 下不能正常显示，ubuntu 正常</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/x86xtf?codemirror=1&amp;hidenavigation=1&amp;module=%2Fsrc%2Fcomponents%2FReactAmap%2Fhooks%2FuseDrawPoints.js&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h2 id="修复后"><a href="#%E4%BF%AE%E5%A4%8D%E5%90%8E" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>修复后</h2>\n<p>windows、ubuntu 都能正常显示</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/9cpd4v?codemirror=1&amp;hidenavigation=1&amp;module=%2Fsrc%2Fcomponents%2FReactAmap%2Fhooks%2FuseDrawPoints.js&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>',id:"/home/runner/work/GatsbyBlog/GatsbyBlog/blog/记一次处理高德地图浏览器兼容性问题/index.md absPath of file >>> MarkdownRemark",timeToRead:1,frontmatter:{date:"2023-11-28 16:55:48",path:"/amap-browser-compatibility/",tags:"前端, 地图, 预研",title:"记一次处理高德地图浏览器兼容性问题",draft:null}},{excerpt:"需求背景 针对本博客现有的 Gatsby 框架实现代码复制、代码实时查看编辑的功能 技术选型 以下都是采用最后一种方案，由于插件功能不满足，所以对其源码做出改动 代码复制 技术选型 语法 优点 缺点 项目代码自实现 未实现 定制化程度高 实现难度大； 拓展较差 gatsby-remark-code-buttons 不需特定语法，只要是代码块默认具有复制功能 已具有代码复制功能 有多复制一行的 bug； UI 不符合博客主题 代码实时查看编辑 技术选型 语法 优点 缺点 样例页面 iframe…",html:'<h1 id="需求背景"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h1>\n<p>针对本博客现有的 Gatsby 框架实现代码复制、代码实时查看编辑的功能</p>\n<h1 id="技术选型"><a href="#%E6%8A%80%E6%9C%AF%E9%80%89%E5%9E%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>技术选型</h1>\n<p>以下都是采用最后一种方案，由于插件功能不满足，所以对其源码做出改动</p>\n<h2 id="代码复制"><a href="#%E4%BB%A3%E7%A0%81%E5%A4%8D%E5%88%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>代码复制</h2>\n<table>\n<thead>\n<tr>\n<th align="left">技术选型</th>\n<th align="left">语法</th>\n<th align="left">优点</th>\n<th align="left">缺点</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align="left">项目代码自实现</td>\n<td align="left">未实现</td>\n<td align="left">定制化程度高</td>\n<td align="left"><ol>\n<li>\n实现难度大；\n</li>\n<li>\n拓展较差\n</li>\n</ol></td>\n</tr>\n<tr>\n<td align="left"><a href="https://github.com/iamskok/gatsby-remark-code-buttons" target="_blank" rel="nofollow noreferrer noopener">gatsby-remark-code-buttons</a></td>\n<td align="left">不需特定语法，只要是代码块默认具有复制功能</td>\n<td align="left">已具有代码复制功能</td>\n<td align="left"><ol>\n<li>\n有多复制一行的 bug；\n</li>\n<li>\nUI 不符合博客主题\n</li>\n</ol></td>\n</tr>\n</tbody>\n</table>\n<h2 id="代码实时查看编辑"><a href="#%E4%BB%A3%E7%A0%81%E5%AE%9E%E6%97%B6%E6%9F%A5%E7%9C%8B%E7%BC%96%E8%BE%91" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>代码实时查看编辑</h2>\n<table>\n<thead>\n<tr>\n<th align="left">技术选型</th>\n<th align="left">语法</th>\n<th align="left">优点</th>\n<th align="left">缺点</th>\n<th>样例页面</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align="left">iframe + \n<a href="https://github.com/gatsbyjs/gatsby/tree/master/packages/gatsby-remark-embed-snippet" target="_blank" rel="nofollow noreferrer noopener">gatsby-remark-embed-snippet</a></td>\n<td align="left"><code class="language-text">&lt;iframe src=&quot;/examples/snow.html&quot; width=&quot;800&quot; height=&quot;400&quot;&gt;&lt;/iframe&gt;</code>\n \n<br />\n \n<code class="language-text">`embed:snow.html`</code></td>\n<td align="left">实现最为简单，容易出效果</td>\n<td align="left"><ol>\n<li>\n没有实时编辑功能；\n<li>\n嵌入的代码往往需要将其写成一个 html 文件且一般情况下只支持静态页面的展示；\n</li>\n<li>\n需要 iframe、embed 标签声明两次\n</li>\n</ol></td>\n<td><a href="/snow-css/">下雪特效</a></td>\n</tr>\n<tr>\n<td align="left">iframe + code-editor.html 传参</td>\n<td align="left"><code class="language-text">&lt;iframe src=&quot;/examples/code-editor.html?html=转义字符串&amp;css=转义字符串&amp;js=转义字符串</code></td>\n<td align="left">基本实现代码的实时查看编辑</td>\n<td align="left"><ol>\n<li>\n嵌入的代码只支持静态的 html 页面；\n</li>\n<li>\n需要明确拆分出 js、css、html 三个结构；\n</li>\n<li>\n嵌入的 js、css、html 分别需要手动 escape 加密\n</li>\n</ol></td>\n<td><a href="/css-world-four-kinds-of-box/#border-%E7%AD%89%E9%AB%98%E5%B8%83%E5%B1%80%E6%8A%80%E6%9C%AF">CSS 世界四大盒尺寸</a></td>\n</tr>\n<tr>\n<td align="left"><a href="https://github.com/elboman/gatsby-remark-embedded-codesandbox" target="_blank" rel="nofollow noreferrer noopener">gatsby-remark-embedded-codesandbox</a></td>\n<td align="left"><code class="language-text">[pms-example](embedded-codesandbox://gantt-component-optimization/pms-example)</code></td>\n<td align="left">借助 codesandbox 实现了较为丰富的代码实时查看编辑功能</td>\n<td align="left"><ol>\n<li>\n借助第三方实现的功能，不够稳定；\n</li>\n<li>\n不支持带目录的文件夹；\n</li>\n<li>\n单次请求过大（即上传代码过多）会报请求体过大错误；\n</li>\n<li>\n会上传 node_modules 等等大文件\n</li>\n</ol></td>\n<td>需实现</td>\n</tr>\n</tbody>\n</table>\n<h1 id="核心逻辑"><a href="#%E6%A0%B8%E5%BF%83%E9%80%BB%E8%BE%91" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>核心逻辑</h1>\n<h2 id="代码复制-1"><a href="#%E4%BB%A3%E7%A0%81%E5%A4%8D%E5%88%B6-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>代码复制</h2>\n<h3 id="修复复制多一行-bug"><a href="#%E4%BF%AE%E5%A4%8D%E5%A4%8D%E5%88%B6%E5%A4%9A%E4%B8%80%E8%A1%8C-bug" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>修复复制多一行 bug</h3>\n<p>代码在<a href="https://github.com/towavephone/gatsby-remark-code-buttons/commit/d95bb194d74182a3c5b8118102b3826695c2ff6d" target="_blank" rel="nofollow noreferrer noopener">这里</a></p>\n<p>src/gatsby-browser.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="35056581613481886000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`@@ -7,19 +7,9 @@ exports.onClientEntry = () => {\n    el.innerHTML = str;\n    document.body.appendChild(el);\n\n-   const range = document.createRange();\n-   range.selectNode(el);\n-   window.getSelection().removeAllRanges();\n-   window.getSelection().addRange(range);\n-   document.execCommand(\\`copy\\`);\n-   document.activeElement.blur();\n-   setTimeout(() => {\n-     document.getSelection().removeAllRanges();\n-     document.body.removeChild(el);\n-   }, 100);\n+   el.select();\n+   document.execCommand(&quot;copy&quot;);\n+   document.body.removeChild(el);\n    if (toasterId) {\n      window.showClipboardToaster(toasterId);\n    }`, `35056581613481886000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="diff"\n              >\n                <span class="gatsby-code-button-language">diff</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="diff"><pre style="counter-reset: linenumber NaN" class="language-diff line-numbers"><code class="language-diff">@@ -7,19 +7,9 @@ exports.onClientEntry = () => {\n<span class="token unchanged"><span class="token prefix unchanged"> </span>   el.innerHTML = str;\n<span class="token prefix unchanged"> </span>   document.body.appendChild(el);\n</span>\n<span class="token deleted-sign deleted"><span class="token prefix deleted">-</span>   const range = document.createRange();\n<span class="token prefix deleted">-</span>   range.selectNode(el);\n<span class="token prefix deleted">-</span>   window.getSelection().removeAllRanges();\n<span class="token prefix deleted">-</span>   window.getSelection().addRange(range);\n<span class="token prefix deleted">-</span>   document.execCommand(`copy`);\n<span class="token prefix deleted">-</span>   document.activeElement.blur();\n<span class="token prefix deleted">-</span>   setTimeout(() => {\n<span class="token prefix deleted">-</span>     document.getSelection().removeAllRanges();\n<span class="token prefix deleted">-</span>     document.body.removeChild(el);\n<span class="token prefix deleted">-</span>   }, 100);\n</span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span>   el.select();\n<span class="token prefix inserted">+</span>   document.execCommand("copy");\n<span class="token prefix inserted">+</span>   document.body.removeChild(el);\n</span><span class="token unchanged"><span class="token prefix unchanged"> </span>   if (toasterId) {\n<span class="token prefix unchanged"> </span>     window.showClipboardToaster(toasterId);\n<span class="token prefix unchanged"> </span>   }</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="增加显示语言类型的功能；改变按钮文本显示逻辑；任何语言都可以显示复制按钮"><a href="#%E5%A2%9E%E5%8A%A0%E6%98%BE%E7%A4%BA%E8%AF%AD%E8%A8%80%E7%B1%BB%E5%9E%8B%E7%9A%84%E5%8A%9F%E8%83%BD%EF%BC%9B%E6%94%B9%E5%8F%98%E6%8C%89%E9%92%AE%E6%96%87%E6%9C%AC%E6%98%BE%E7%A4%BA%E9%80%BB%E8%BE%91%EF%BC%9B%E4%BB%BB%E4%BD%95%E8%AF%AD%E8%A8%80%E9%83%BD%E5%8F%AF%E4%BB%A5%E6%98%BE%E7%A4%BA%E5%A4%8D%E5%88%B6%E6%8C%89%E9%92%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>增加显示语言类型的功能；改变按钮文本显示逻辑；任何语言都可以显示复制按钮</h3>\n<p>主要针对原插件做出的一些 UI、功能上的适配，代码在<a href="https://github.com/towavephone/gatsby-remark-code-buttons/commit/90094cd1c6a4a6fa7253f61e898f8a832173d6a9" target="_blank" rel="nofollow noreferrer noopener">这里</a></p>\n<p>src/index.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="36449935251611464000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`@@ -21,10 +21,6 @@ module.exports = function gatsbyRemarkCodeButtons(\n    const actions = qs.parse(params);\n    const { clipboard } = actions;\n\n-   if (!language) {\n-     return;\n-   }\n-\n    if (clipboard === \'false\') {\n      delete actions[\'clipboard\'];\n    } else {\n@@ -57,12 +53,12 @@ module.exports = function gatsbyRemarkCodeButtons(\n            >\n              <div\n                class=&quot;\\${buttonClass}&quot;\n-               data-tooltip=&quot;\\${tooltipText}&quot;\n+               \\${tooltipText ? \\`data-tooltip=&quot;\\${tooltipText}&quot;\\` : \'\'}\n              >\n-               \\${buttonText}\\${svgIcon}\n+               \\${[language, buttonText || svgIcon].filter((item) => item).join(\' \')}\n              </div>\n            </div>\n-           \\`.trim()\n+         \\`.trim()\n      };\n\n      parent.children.splice(index, 0, buttonNode);`, `36449935251611464000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="diff"\n              >\n                <span class="gatsby-code-button-language">diff</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="diff"><pre style="counter-reset: linenumber NaN" class="language-diff line-numbers"><code class="language-diff">@@ -21,10 +21,6 @@ module.exports = function gatsbyRemarkCodeButtons(\n<span class="token unchanged"><span class="token prefix unchanged"> </span>   const actions = qs.parse(params);\n<span class="token prefix unchanged"> </span>   const { clipboard } = actions;\n</span>\n<span class="token deleted-sign deleted"><span class="token prefix deleted">-</span>   if (!language) {\n<span class="token prefix deleted">-</span>     return;\n<span class="token prefix deleted">-</span>   }\n<span class="token prefix deleted">-</span>\n</span><span class="token unchanged"><span class="token prefix unchanged"> </span>   if (clipboard === \'false\') {\n<span class="token prefix unchanged"> </span>     delete actions[\'clipboard\'];\n<span class="token prefix unchanged"> </span>   } else {\n</span>@@ -57,12 +53,12 @@ module.exports = function gatsbyRemarkCodeButtons(\n<span class="token unchanged"><span class="token prefix unchanged"> </span>           >\n<span class="token prefix unchanged"> </span>             &lt;div\n<span class="token prefix unchanged"> </span>               class="${buttonClass}"\n</span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span>               data-tooltip="${tooltipText}"\n</span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span>               ${tooltipText ? `data-tooltip="${tooltipText}"` : \'\'}\n</span><span class="token unchanged"><span class="token prefix unchanged"> </span>             >\n</span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span>               ${buttonText}${svgIcon}\n</span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span>               ${[language, buttonText || svgIcon].filter((item) => item).join(\' \')}\n</span><span class="token unchanged"><span class="token prefix unchanged"> </span>             &lt;/div>\n<span class="token prefix unchanged"> </span>           &lt;/div>\n</span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span>           `.trim()\n</span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span>         `.trim()\n</span><span class="token unchanged"><span class="token prefix unchanged"> </span>     };\n</span>\n<span class="token unchanged"><span class="token prefix unchanged"> </span>     parent.children.splice(index, 0, buttonNode);</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="实现效果"><a href="#%E5%AE%9E%E7%8E%B0%E6%95%88%E6%9E%9C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>实现效果</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="8556927181173579000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 测试代码复制功能，这个代码块应该具有复制代码功能`, `8556927181173579000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 测试代码复制功能，这个代码块应该具有复制代码功能</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h2 id="代码实时查看编辑-1"><a href="#%E4%BB%A3%E7%A0%81%E5%AE%9E%E6%97%B6%E6%9F%A5%E7%9C%8B%E7%BC%96%E8%BE%91-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>代码实时查看编辑</h2>\n<p>代码在<a href="https://github.com/towavephone/gatsby-remark-embedded-codesandbox/commit/6a1947c22566c6ad5baae33dabf99edd16f4c8eb" target="_blank" rel="nofollow noreferrer noopener">这里</a></p>\n<h3 id="递归遍历文件夹；增加忽略文件功能"><a href="#%E9%80%92%E5%BD%92%E9%81%8D%E5%8E%86%E6%96%87%E4%BB%B6%E5%A4%B9%EF%BC%9B%E5%A2%9E%E5%8A%A0%E5%BF%BD%E7%95%A5%E6%96%87%E4%BB%B6%E5%8A%9F%E8%83%BD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>递归遍历文件夹；增加忽略文件功能</h3>\n<p>原插件不支持目录的读取，这里拓展了目录下也能递归读取的功能，同时也实现了默认忽略文件的功能</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="57403508330723920000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const DEFAULT_IGNORED_FILES = [\'node_modules\', \'package-lock.json\', \'yarn.lock\'];\n\nconst ignoredFilesSet = new Set(ignoredFiles);\n\nconst getAllFiles = (dirPath) =>\n   fs.readdirSync(dirPath).reduce((acc, file) => {\n      // 过滤文件立即跳出下一个\n      if (ignoredFilesSet.has(file)) return acc;\n      const relativePath = path.join(dirPath, file);\n      const isDirectory = fs.statSync(relativePath).isDirectory();\n      // 判断是目录继续递归遍历\n      const additions = isDirectory ? getAllFiles(relativePath) : [relativePath.replace(\\`\\${directory}/\\`, \'\')];\n      return [...acc, ...additions];\n   }, []);`, `57403508330723920000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> <span class="token constant">DEFAULT_IGNORED_FILES</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'node_modules\'</span><span class="token punctuation">,</span> <span class="token string">\'package-lock.json\'</span><span class="token punctuation">,</span> <span class="token string">\'yarn.lock\'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> ignoredFilesSet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span>ignoredFiles<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">getAllFiles</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">dirPath</span><span class="token punctuation">)</span> <span class="token operator">=></span>\n   fs<span class="token punctuation">.</span><span class="token function">readdirSync</span><span class="token punctuation">(</span>dirPath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">acc<span class="token punctuation">,</span> file</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token comment">// 过滤文件立即跳出下一个</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>ignoredFilesSet<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> acc<span class="token punctuation">;</span>\n      <span class="token keyword">const</span> relativePath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>dirPath<span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> isDirectory <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">statSync</span><span class="token punctuation">(</span>relativePath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token comment">// 判断是目录继续递归遍历</span>\n      <span class="token keyword">const</span> additions <span class="token operator">=</span> isDirectory <span class="token operator">?</span> <span class="token function">getAllFiles</span><span class="token punctuation">(</span>relativePath<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">[</span>relativePath<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>directory<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token string">\'\'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token operator">...</span>acc<span class="token punctuation">,</span> <span class="token operator">...</span>additions<span class="token punctuation">]</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="默认模式为静态服务器"><a href="#%E9%BB%98%E8%AE%A4%E6%A8%A1%E5%BC%8F%E4%B8%BA%E9%9D%99%E6%80%81%E6%9C%8D%E5%8A%A1%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>默认模式为静态服务器</h3>\n<p>因为 codesandbox 需要明确模板类型，这里默认为静态模板，否则静态文件不能正常运行</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="92695134064156520000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const getFileExist = (fileList, filename = \'package.json\') => {\n   const found = fileList.filter((name) => name === filename);\n   return found.length > null;\n};\n\nif (!getFileExist(folderFiles, \'sandbox.config.json\')) {\n   sandboxFiles.push({\n      name: \'sandbox.config.json\',\n      content: \'{ &quot;template&quot;: &quot;static&quot; }\'\n   });\n}`, `92695134064156520000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> getFileExist <span class="token operator">=</span> <span class="token punctuation">(</span>fileList<span class="token punctuation">,</span> filename <span class="token operator">=</span> <span class="token string">\'package.json\'</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   <span class="token keyword">const</span> found <span class="token operator">=</span> fileList<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token operator">=></span> name <span class="token operator">===</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">return</span> found<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">getFileExist</span><span class="token punctuation">(</span>folderFiles<span class="token punctuation">,</span> <span class="token string">\'sandbox.config.json\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   sandboxFiles<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n      name<span class="token punctuation">:</span> <span class="token string">\'sandbox.config.json\'</span><span class="token punctuation">,</span>\n      content<span class="token punctuation">:</span> <span class="token string">\'{ "template": "static" }\'</span>\n   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="codesandbox-请求方式改为-post-异步化"><a href="#codesandbox-%E8%AF%B7%E6%B1%82%E6%96%B9%E5%BC%8F%E6%94%B9%E4%B8%BA-post-%E5%BC%82%E6%AD%A5%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>codesandbox 请求方式改为 post 异步化</h3>\n<p>原插件是基于 get 请求的，一旦上传文件过多就会报错，这里改为 post 请求就不再有请求体大小的限制，同时也要注意 post 的异步</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="22926367592740803000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const convertNodeToEmbedded = async (node, params, options = {}) => {\n   delete node.children;\n   delete node.position;\n   delete node.title;\n   delete node.url;\n\n   // merge the overriding options with the plugin one\n   const mergedOptions = { ...embedOptions, ...options };\n   const encodedEmbedOptions = queryString.stringify(mergedOptions);\n\n   const { sandbox_id } = await fetch(\'https://codesandbox.io/api/v1/sandboxes/define?json=1\', {\n      method: \'POST\',\n      headers: {\n         \'Content-Type\': \'application/json\',\n         Accept: \'application/json\'\n      },\n      body: params\n   }).then((x) => x.json());\n\n   const sandboxUrl = \\`https://codesandbox.io/embed/\\${sandbox_id}?\\${encodedEmbedOptions}\\`;\n   const embedded = getIframe(sandboxUrl);\n   node.type = \'html\';\n   node.value = embedded;\n\n   return node;\n};\n\nconst nodes = [];\nmap(markdownAST, (node, index, parent) => {\n   if (node.type === \'link\' && node.url.startsWith(protocol)) {\n      // split the url in base and query to allow user\n      // to customise embedding options on a per-node basis\n      const url = getUrlParts(node.url);\n      // get all files in the folder and generate\n      // the embeddeing parameters\n      const dir = getDirectoryPath(url.base);\n      const files = getFilesList(dir);\n      const params = createParams(files);\n      convertNodeToEmbedded(node, params, url.query);\n      const currentNode = convertNodeToEmbedded(node, params, url.query);\n      nodes.push(currentNode);\n   }\n\n   return node;\n});\n\n// 注意这里的异步化，必须等所有的请求成功响应才可继续遍历\nawait Promise.all(nodes);`, `22926367592740803000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">convertNodeToEmbedded</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> params<span class="token punctuation">,</span> options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   <span class="token keyword">delete</span> node<span class="token punctuation">.</span>children<span class="token punctuation">;</span>\n   <span class="token keyword">delete</span> node<span class="token punctuation">.</span>position<span class="token punctuation">;</span>\n   <span class="token keyword">delete</span> node<span class="token punctuation">.</span>title<span class="token punctuation">;</span>\n   <span class="token keyword">delete</span> node<span class="token punctuation">.</span>url<span class="token punctuation">;</span>\n\n   <span class="token comment">// merge the overriding options with the plugin one</span>\n   <span class="token keyword">const</span> mergedOptions <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span>embedOptions<span class="token punctuation">,</span> <span class="token operator">...</span>options <span class="token punctuation">}</span><span class="token punctuation">;</span>\n   <span class="token keyword">const</span> encodedEmbedOptions <span class="token operator">=</span> queryString<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>mergedOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token keyword">const</span> <span class="token punctuation">{</span> sandbox_id <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">\'https://codesandbox.io/api/v1/sandboxes/define?json=1\'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>\n      method<span class="token punctuation">:</span> <span class="token string">\'POST\'</span><span class="token punctuation">,</span>\n      headers<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n         <span class="token string">\'Content-Type\'</span><span class="token punctuation">:</span> <span class="token string">\'application/json\'</span><span class="token punctuation">,</span>\n         Accept<span class="token punctuation">:</span> <span class="token string">\'application/json\'</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      body<span class="token punctuation">:</span> params\n   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token operator">=></span> x<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token keyword">const</span> sandboxUrl <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://codesandbox.io/embed/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>sandbox_id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">?</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>encodedEmbedOptions<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n   <span class="token keyword">const</span> embedded <span class="token operator">=</span> <span class="token function">getIframe</span><span class="token punctuation">(</span>sandboxUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   node<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">\'html\'</span><span class="token punctuation">;</span>\n   node<span class="token punctuation">.</span>value <span class="token operator">=</span> embedded<span class="token punctuation">;</span>\n\n   <span class="token keyword">return</span> node<span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> nodes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token function">map</span><span class="token punctuation">(</span>markdownAST<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> index<span class="token punctuation">,</span> parent</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">\'link\'</span> <span class="token operator">&amp;&amp;</span> node<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span>protocol<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// split the url in base and query to allow user</span>\n      <span class="token comment">// to customise embedding options on a per-node basis</span>\n      <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token function">getUrlParts</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token comment">// get all files in the folder and generate</span>\n      <span class="token comment">// the embeddeing parameters</span>\n      <span class="token keyword">const</span> dir <span class="token operator">=</span> <span class="token function">getDirectoryPath</span><span class="token punctuation">(</span>url<span class="token punctuation">.</span>base<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> files <span class="token operator">=</span> <span class="token function">getFilesList</span><span class="token punctuation">(</span>dir<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> params <span class="token operator">=</span> <span class="token function">createParams</span><span class="token punctuation">(</span>files<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token function">convertNodeToEmbedded</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> params<span class="token punctuation">,</span> url<span class="token punctuation">.</span>query<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> currentNode <span class="token operator">=</span> <span class="token function">convertNodeToEmbedded</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> params<span class="token punctuation">,</span> url<span class="token punctuation">.</span>query<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      nodes<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>currentNode<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token keyword">return</span> node<span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 注意这里的异步化，必须等所有的请求成功响应才可继续遍历</span>\n<span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>nodes<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="实现效果-1"><a href="#%E5%AE%9E%E7%8E%B0%E6%95%88%E6%9E%9C-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>实现效果</h3>\n<p><a href="/gantt-component-optimization/#%E5%AE%9E%E7%8E%B0%E6%95%88%E6%9E%9C">甘特图组件源码优化</a></p>\n<h3 id="后续优化"><a href="#%E5%90%8E%E7%BB%AD%E4%BC%98%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>后续优化</h3>\n<p><a href="https://github.com/elboman/gatsby-remark-embedded-codesandbox/compare/master...towavephone:gatsby-remark-embedded-codesandbox:master" target="_blank" rel="nofollow noreferrer noopener">代码地址</a></p>\n<ol>\n<li>增加上传文件忽略功能，支持 post 上传文件</li>\n<li>修复 json 解析报错</li>\n<li>限制请求并发防止 codesandbox 报错</li>\n</ol>\n<h1 id="总结"><a href="#%E6%80%BB%E7%BB%93" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h1>\n<ol>\n<li>复制功能需考虑兼容性、复制性能，可参考<a href="https://www.zhangxinxu.com/wordpress/2021/10/js-copy-paste-clipboard/" target="_blank" rel="nofollow noreferrer noopener">JS 复制文字到剪切板的极简实现及扩展</a></li>\n<li>代码实时查看编辑借助于第三方服务不够稳定，可自行搭建第三方服务或者参照 <a href="https://github.com/gfxfundamentals/live-editor" target="_blank" rel="nofollow noreferrer noopener">live-editor</a> 自建本地编辑器，必要时具有分享功能</li>\n</ol>\n<h1 id="其他优化"><a href="#%E5%85%B6%E4%BB%96%E4%BC%98%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>其他优化</h1>\n<ol>\n<li>把 gatsby-remark-graph 配置化，以支持最新的 mermaid 特性，<a href="https://github.com/konsumer/gatsby-remark-graph/compare/master...towavephone:gatsby-remark-graph-towavephone:master" target="_blank" rel="nofollow noreferrer noopener">代码地址</a></li>\n<li>gatsby-remark-design-system 支持文字转语音（利用百度翻译），<a href="https://github.com/LekoArts/gatsby-remark-design-system/compare/master...towavephone:gatsby-remark-design-system-towavephone:master" target="_blank" rel="nofollow noreferrer noopener">代码地址</a></li>\n<li>img、video、iframe 增加懒加载功能，<a href="https://github.com/1kohei1/gatsby-remark-lazy-load/compare/master...towavephone:gatsby-remark-lazy-load:master" target="_blank" rel="nofollow noreferrer noopener">代码地址</a></li>\n</ol>',
id:"/home/runner/work/GatsbyBlog/GatsbyBlog/blog/博客 Gatsby 插件改造/index.md absPath of file >>> MarkdownRemark",timeToRead:8,frontmatter:{date:"2023-11-28 16:17:27",path:"/gatsby-plugin-transformation/",tags:"前端, 源码优化, 预研",title:"博客 Gatsby 插件改造",draft:null}},{excerpt:"入门 Hello, World 我们以现已成为传统的   案例来开始吧 Go 是一门编译型语言，Go 语言的工具链将源代码及其依赖转换成计算机的机器指令（译注：静态编译）。Go 语言提供的工具都通过一个单独的命令 go 调用，go 命令有一系列子命令。最简单的一个子命令就是 run。这个命令编译一个或多个以 .go 结尾的源文件，链接库文件，并运行最终生成的可执行文件（本书使用   表示命令行提示符。） 毫无意外，这个命令会输出： Go 语言原生支持 Unicode…",html:'<h1 id="入门"><a href="#%E5%85%A5%E9%97%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>入门</h1>\n<h2 id="hello-world"><a href="#hello-world" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Hello, World</h2>\n<p>我们以现已成为传统的 <code class="language-text">hello world</code> 案例来开始吧</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="35989200237663478000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`package main\n\nimport &quot;fmt&quot;\n\nfunc main() {\n    fmt.Println(&quot;Hello, 世界&quot;)\n}`, `35989200237663478000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="go"\n              >\n                <span class="gatsby-code-button-language">go</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="go"><pre style="counter-reset: linenumber NaN" class="language-go line-numbers"><code class="language-go"><span class="token keyword">package</span> main\n\n<span class="token keyword">import</span> <span class="token string">"fmt"</span>\n\n<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Hello, 世界"</span><span class="token punctuation">)</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Go 是一门编译型语言，Go 语言的工具链将源代码及其依赖转换成计算机的机器指令（译注：静态编译）。Go 语言提供的工具都通过一个单独的命令 go 调用，go 命令有一系列子命令。最简单的一个子命令就是 run。这个命令编译一个或多个以 .go 结尾的源文件，链接库文件，并运行最终生成的可执行文件（本书使用 <code class="language-text">$</code> 表示命令行提示符。）</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="48712043620111700000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ go run helloworld.go`, `48712043620111700000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ go run helloworld.go</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>毫无意外，这个命令会输出：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="69108038682247684000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`Hello, 世界`, `69108038682247684000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">Hello, 世界</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>Go 语言原生支持 Unicode，它可以处理全世界任何语言的文本。</p>\n<p>如果不只是一次性实验，你肯定希望能够编译这个程序，保存编译结果以备将来之用，可以用 build 子命令：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="44446813677973740000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ go build helloworld.go`, `44446813677973740000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ go build helloworld.go</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>这个命令生成一个名为 helloworld 的可执行的二进制文件（译注：Windows 系统下生成的可执行文件是 helloworld.exe，增加了 .exe 后缀名），之后你可以随时运行它（译注：在 Windows 系统下在命令行直接输入 helloworld.exe 命令运行），不需任何处理（译注：因为静态编译，所以不用担心在系统库更新的时候冲突，幸福感满满）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="53942095395440120000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ ./helloworld\nHello, 世界`, `53942095395440120000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ ./helloworld\nHello, 世界</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>执行 <code class="language-text">go get gopl.io/ch1/helloworld</code> 命令，就会从网上获取代码，并放到对应目录中（需要先安装 Git 或 Hg 之类的版本管理工具，并将对应的命令添加到 PATH 环境变量中。</p>\n<p>来讨论下程序本身。Go 语言的代码通过包（package）组织，包类似于其它语言里的库（libraries）或者模块（modules）。一个包由位于单个目录下的一个或多个 .go 源代码文件组成，目录定义包的作用。每个源文件都以一条 package 声明语句开始，这个例子里就是 package main，表示该文件属于哪个包，紧跟着一系列导入（import）的包，之后是存储在这个文件里的程序语句。</p>\n<p>Go 的标准库提供了 100 多个包，以支持常见功能，如输入、输出、排序以及文本处理。比如 fmt 包，就含有格式化输出、接收输入的函数。Println 是其中一个基础函数，可以打印以空格间隔的一个或多个值，并在最后添加一个换行符，从而输出一整行。</p>\n<p>main 包比较特殊。它定义了一个独立可执行的程序，而不是一个库。在 main 里的 main 函数也很特殊，它是整个程序执行时的入口（译注：C 系语言差不多都这样）。main 函数所做的事情就是程序做的。当然了，main 函数一般调用其它包里的函数完成很多工作（如：fmt.Println）。</p>\n<p>必须告诉编译器源文件需要哪些包，这就是跟随在 package 声明后面的 import 声明扮演的角色。hello world 例子只用到了一个包，大多数程序需要导入多个包。</p>\n<p>必须恰当导入需要的包，缺少了必要的包或者导入了不需要的包，程序都无法编译通过。这项严格要求避免了程序开发过程中引入未使用的包（译注：Go 语言编译过程没有警告信息，争议特性之一）。</p>\n<p>import 声明必须跟在文件的 package 声明之后。随后，则是组成程序的函数、变量、常量、类型的声明语句（分别由关键字 func、var、const、type 定义）。这些内容的声明顺序并不重要（译注：最好还是定一下规范）。这个例子的程序已经尽可能短了，只声明了一个函数，其中只调用了一个其他函数。为了节省篇幅，有些时候示例程序会省略 package 和 import 声明，但是，这些声明在源代码里有，并且必须得有才能编译。</p>\n<p>一个函数的声明由 func 关键字、函数名、参数列表、返回值列表（这个例子里的 main 函数参数列表和返回值都是空的）以及包含在大括号里的函数体组成。第五章进一步考察函数。</p>\n<p>Go 语言不需要在语句或者声明的末尾添加分号，除非一行上有多条语句。实际上，编译器会主动把特定符号后的换行符转换为分号，因此换行符添加的位置会影响 Go 代码的正确解析（译注：比如行末是标识符、整数、浮点数、虚数、字符或字符串文字、关键字 break、continue、fallthrough 或 return 中的一个、运算符和分隔符 <code class="language-text">++</code>、<code class="language-text">--</code>、<code class="language-text">)</code>、<code class="language-text">]</code> 或 <code class="language-text">}</code> 中的一个）。举个例子，函数的左括号 <code class="language-text">{</code> 必须和 func 函数声明在同一行上，且位于末尾，不能独占一行，而在表达式 <code class="language-text">x + y</code> 中，可在 + 后换行，不能在 + 前换行（译注：以 + 结尾的话不会被插入分号分隔符，但是以 x 结尾的话则会被分号分隔符，从而导致编译错误）。</p>\n<p>Go 语言在代码格式上采取了很强硬的态度。gofmt 工具把代码格式化为标准格式（译注：这个格式化工具没有任何可以调整代码格式的参数，Go 语言就是这么任性），并且 go 工具中的 fmt 子命令会对指定包，否则默认为当前目录中所有 go 源文件应用 gofmt 命令。本书中的所有代码都被 gofmt 过。你也应该养成格式化自己的代码的习惯。以固定方式规定标准的代码格式可以避免无尽的无意义的琐碎争执（译注：也导致了 Go 语言的 TIOBE 排名较低，因为缺少撕逼的话题）。更重要的是，这样可以做多种自动源码转换，如果放任 Go 语言代码格式，这些转换就不大可能了。</p>\n<p>很多文本编辑器都可以配置为保存文件时自动执行 gofmt，这样你的源代码总会被恰当地格式化。还有个相关的工具：goimports，可以根据代码需要，自动地添加或删除 import 声明。这个工具并没有包含在标准的分发包中，可以用下面的命令安装：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="42357965763933650000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ go get golang.org/x/tools/cmd/goimports`, `42357965763933650000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ go get golang.org/x/tools/cmd/goimports</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>对于大多数用户来说，下载、编译包、运行测试用例、察看 Go 语言的文档等等常用功能都可以用 go 的工具完成。10.7 节详细介绍这些知识。</p>\n<h2 id="命令行参数"><a href="#%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%8F%82%E6%95%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>命令行参数</h2>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="31915090262381640000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// Echo1 prints its command-line arguments.\npackage main\n\nimport (\n    &quot;fmt&quot;\n    &quot;os&quot;\n)\n\nfunc main() {\n    var s, sep string\n    for i := 1; i < len(os.Args); i++ {\n        s += sep + os.Args[i]\n        sep = &quot; &quot;\n    }\n    fmt.Println(s)\n}`, `31915090262381640000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="go"\n              >\n                <span class="gatsby-code-button-language">go</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="go"><pre style="counter-reset: linenumber NaN" class="language-go line-numbers"><code class="language-go"><span class="token comment">// Echo1 prints its command-line arguments.</span>\n<span class="token keyword">package</span> main\n\n<span class="token keyword">import</span> <span class="token punctuation">(</span>\n    <span class="token string">"fmt"</span>\n    <span class="token string">"os"</span>\n<span class="token punctuation">)</span>\n\n<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">var</span> s<span class="token punctuation">,</span> sep <span class="token builtin">string</span>\n    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Args<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>\n        s <span class="token operator">+=</span> sep <span class="token operator">+</span> os<span class="token punctuation">.</span>Args<span class="token punctuation">[</span>i<span class="token punctuation">]</span>\n        sep <span class="token operator">=</span> <span class="token string">" "</span>\n    <span class="token punctuation">}</span>\n    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="9254290909938457000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// Echo2 prints its command-line arguments.\npackage main\n\nimport (\n    &quot;fmt&quot;\n    &quot;os&quot;\n)\n\nfunc main() {\n    s, sep := &quot;&quot;, &quot;&quot;\n    for _, arg := range os.Args[1:] {\n        s += sep + arg\n        sep = &quot; &quot;\n    }\n    fmt.Println(s)\n}`, `9254290909938457000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="go"\n              >\n                <span class="gatsby-code-button-language">go</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="go"><pre style="counter-reset: linenumber NaN" class="language-go line-numbers"><code class="language-go"><span class="token comment">// Echo2 prints its command-line arguments.</span>\n<span class="token keyword">package</span> main\n\n<span class="token keyword">import</span> <span class="token punctuation">(</span>\n    <span class="token string">"fmt"</span>\n    <span class="token string">"os"</span>\n<span class="token punctuation">)</span>\n\n<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    s<span class="token punctuation">,</span> sep <span class="token operator">:=</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">""</span>\n    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> arg <span class="token operator">:=</span> <span class="token keyword">range</span> os<span class="token punctuation">.</span>Args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>\n        s <span class="token operator">+=</span> sep <span class="token operator">+</span> arg\n        sep <span class="token operator">=</span> <span class="token string">" "</span>\n    <span class="token punctuation">}</span>\n    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="89193486842647540000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`s := &quot;&quot; // 一条短变量声明，最简洁，但只能用在函数内部，而不能用于包变量\nvar s string // 依赖于字符串的默认初始化零值机制，被初始化为 &quot;&quot;\nvar s = &quot;&quot; // 用得很少，除非同时声明多个变量\nvar s string = &quot;&quot; // 显式地标明变量的类型，当变量类型与初值类型相同时，类型冗余，但如果两者类型不同，变量类型就必须了`, `89193486842647540000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="go"\n              >\n                <span class="gatsby-code-button-language">go</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="go"><pre style="counter-reset: linenumber NaN" class="language-go line-numbers"><code class="language-go">s <span class="token operator">:=</span> <span class="token string">""</span> <span class="token comment">// 一条短变量声明，最简洁，但只能用在函数内部，而不能用于包变量</span>\n<span class="token keyword">var</span> s <span class="token builtin">string</span> <span class="token comment">// 依赖于字符串的默认初始化零值机制，被初始化为 ""</span>\n<span class="token keyword">var</span> s <span class="token operator">=</span> <span class="token string">""</span> <span class="token comment">// 用得很少，除非同时声明多个变量</span>\n<span class="token keyword">var</span> s <span class="token builtin">string</span> <span class="token operator">=</span> <span class="token string">""</span> <span class="token comment">// 显式地标明变量的类型，当变量类型与初值类型相同时，类型冗余，但如果两者类型不同，变量类型就必须了</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>实践中一般使用前两种形式中的某个，初始值重要的话就显式地指定变量的类型，否则使用隐式初始化。</p>\n<p>每次循环迭代字符串 s 的内容都会更新。+= 连接原字符串、空格和下个参数，产生新字符串，并把它赋值给 s。s 原来的内容已经不再使用，将在适当时机对它进行垃圾回收。</p>\n<p>如果连接涉及的数据量很大，这种方式代价高昂。一种简单且高效的解决方案是使用 strings 包的 Join 函数：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="59727486139290200000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`func main() {\n    fmt.Println(strings.Join(os.Args[1:], &quot; &quot;))\n}`, `59727486139290200000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="go"\n              >\n                <span class="gatsby-code-button-language">go</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="go"><pre style="counter-reset: linenumber NaN" class="language-go line-numbers"><code class="language-go"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>strings<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>最后，如果不关心输出格式，只想看看输出值，或许只是为了调试，可以用 Println 为我们格式化输出。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="79265282398810570000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`fmt.Println(os.Args[1:])`, `79265282398810570000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="go"\n              >\n                <span class="gatsby-code-button-language">go</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="go"><pre style="counter-reset: linenumber NaN" class="language-go line-numbers"><code class="language-go">fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>这条语句的输出结果跟 strings.Join 得到的结果很像，只是被放到了一对方括号里。切片都会被打印成这种格式。</p>\n<p>// TODO <a href="https://golang-china.github.io/gopl-zh/preface-zh.html" target="_blank" rel="nofollow noreferrer noopener">https://golang-china.github.io/gopl-zh/preface-zh.html</a></p>',id:"/home/runner/work/GatsbyBlog/GatsbyBlog/blog/Go 入门学习/index.md absPath of file >>> MarkdownRemark",timeToRead:2,frontmatter:{date:"2023-10-02 17:58:46",path:"/go-introduce-learn/",tags:"后端, go, 读书笔记",title:"Go 入门学习",draft:null}}],page:2,pagesSum:47,length:232,prevPath:"/page/1",nextPath:"/page/3"}}}});